{"version":3,"sources":["../../../../lib/assets/javascripts/cartodb/models/like.js","../../../../lib/assets/javascripts/cartodb/public/public_like.js"],"names":["cdb","admin","Like","core","Model","extend","defaults","likeable","url","method","version","config","urlVersion","this","get","initialize","_","bindAll","on","set","liked","likes","_onSaveError","model","response","trigger","status","statusText","toggleLiked","destroy","id","silent","save","error","newByVisData","opts","d","vis_id","omit","m","open","LikeView","View","events","click","_onClick","e","preventDefault","stopPropagation","self","bind","window","top","location","href","_updateCounter","_highlightHeart","_unhighlightHeart","options","auto_fetch","fetch","$counter","$","count","text","$button","$icon","addClass","one","removeClass"],"mappings":";AAAAA,IAAIC,MAAMC,KAAOF,IAAIG,KAAKC,MAAMC,QAE9BC,UACEC,UAAU,GAGZC,IAAK,SAASC,GACZ,GAAIC,GAAUV,IAAIW,OAAOC,WAAW,OAAQH,EAC5C,OAAO,QAAUC,EAAU,QAAUG,KAAKC,IAAI,UAAY,SAG5DC,WAAY,WAEVC,EAAEC,QAAQJ,KAAM,gBAEhBA,KAAKK,GAAG,UAAW,WACjBL,KAAKM,KAAMC,OAAO,EAAOC,MAAOR,KAAKC,IAAI,SAAW,KACnDD,OAILS,aAAc,SAASC,EAAOC,GAC5BX,KAAKY,QAAQ,SACXC,OAAQF,EAASE,OACjBC,WAAYH,EAASG,cAIzBC,YAAa,WAEPf,KAAKC,IAAI,SACXD,KAAKgB,WAELhB,KAAKM,KAAMW,GAAI,OAAUC,QAAQ,IACjClB,KAAKmB,SAAWC,MAAOpB,KAAKS,mBAMhCY,aAAc,SAASC,GACrB,GAAIC,GAAIpB,EAAEV,UACRwB,GAAIK,EAAKf,MAAQe,EAAKE,OAAS,MAC9BrB,EAAEsB,KAAKH,EAAM,QAEZI,EAAI,GAAIvC,KAAIC,MAAMC,KAAKkC,EAM3B,OAJID,GAAK3B,MACP+B,EAAE/B,IAAM2B,EAAK3B,KAGR+B,KCnDXvC,IAAIwC,KAAKC,SAAWzC,IAAIG,KAAKuC,KAAKrC,QAEhCsC,QACEC,MAAS,YAGXC,SAAU,SAASC,GAEjBA,EAAEC,iBACFD,EAAEE,kBAEFnC,KAAKU,MAAMK,aAEX,IAAIqB,GAAOpC,IAEXA,MAAKU,MAAM2B,KAAK,QAAS,SAAS1B,GAER,MAApBA,EAASE,OACXuB,EAAK1B,MAAMJ,KAAMW,GAAImB,EAAK1B,MAAMT,IAAI,UAAWM,OAAO,IACzB,MAApBI,EAASE,SAClByB,OAAOC,IAAIC,SAASC,KAAO,qCAMjCvC,WAAY,WAEVF,KAAKU,MAAM2B,KAAK,6BAA8B,WAE5CrC,KAAK0C,iBAED1C,KAAKU,MAAMT,IAAI,SAEjBD,KAAK2C,kBAIL3C,KAAK4C,qBAGN5C,MAECA,KAAK6C,QAAQC,YAAY9C,KAAKU,MAAMqC,SAI1CL,eAAgB,WAEd,GAAIM,GAAWC,EAAE,qBACbC,EAAQlD,KAAKU,MAAMT,IAAI,QAEvBiD,GAAQ,GAAKlD,KAAKU,MAAMT,IAAI,cAC9B+C,EAASG,KAAKD,GAEdF,EAASG,KAAK,KAKlBP,kBAAmB,WAEjB,GAAIQ,GAAWH,EAAE,YACbI,EAAWJ,EAAE,iBAEjBI,GAAMC,SAAS,4BACfD,EAAME,IAAI,+EAAgF,WACxFN,EAAEjD,MAAMwD,YAAY,4BACpBJ,EAAQI,YAAY,qBAKxBb,gBAAiB,WAEf,GAAIS,GAAWH,EAAE,YACbI,EAAWJ,EAAE,iBAEjBG,GAAQE,SAAS,kBACjBD,EAAMC,SAAS,4BACfD,EAAME,IAAI,+EAAgF,WACxFN,EAAEjD,MAAMwD,YAAY,iCAM1BrE,IAAIwC,KAAKtC,KAAOF,IAAIC,MAAMC,KAAKG","file":"public_like.js","sourcesContent":["cdb.admin.Like = cdb.core.Model.extend({\n\n  defaults: {\n    likeable: true\n  },\n\n  url: function(method) {\n    var version = cdb.config.urlVersion('like', method)\n    return '/api/' + version + '/viz/' + this.get(\"vis_id\") + '/like';\n  },\n\n  initialize: function() {\n\n    _.bindAll(this, \"_onSaveError\");\n\n    this.on(\"destroy\", function() {\n      this.set({ liked: false, likes: this.get(\"likes\") - 1 });\n    }, this);\n\n  },\n\n  _onSaveError: function(model, response) {\n    this.trigger(\"error\", {\n      status: response.status,\n      statusText: response.statusText\n    });\n  },\n\n  toggleLiked: function() {\n\n    if (this.get(\"liked\")) {\n      this.destroy();\n    } else {\n      this.set({ id: null }, { silent: true });\n      this.save({}, { error: this._onSaveError });\n    }\n  }\n\n}, {\n\n  newByVisData: function(opts) {\n    var d = _.defaults({\n      id: opts.liked ? opts.vis_id : null\n    }, _.omit(opts, 'url'));\n\n    var m = new cdb.admin.Like(d);\n\n    if (opts.url) {\n      m.url = opts.url;\n    }\n\n    return m;\n  }\n});\n","cdb.open.LikeView = cdb.core.View.extend({\n\n  events: {\n    \"click\": \"_onClick\"\n  },\n\n  _onClick: function(e) {\n\n    e.preventDefault();\n    e.stopPropagation();\n\n    this.model.toggleLiked();\n\n    var self = this;\n\n    this.model.bind(\"error\", function(response) {\n\n      if (response.status === 400) { // if the item was already liked, we \"fake\" the like\n        self.model.set({ id: self.model.get(\"vis_id\"), liked: true });\n      } else if (response.status === 403) {\n        window.top.location.href = \"https://carto.com/sessions/new\";\n      }\n    });\n\n  },\n\n  initialize: function() {\n\n    this.model.bind(\"change:likes, change:liked\", function() {\n\n      this._updateCounter();\n\n      if (this.model.get(\"liked\")) {\n\n        this._highlightHeart();\n\n      } else {\n\n        this._unhighlightHeart();\n      }\n\n    }, this);\n\n    if (this.options.auto_fetch) this.model.fetch();\n\n  },\n\n  _updateCounter: function() {\n\n    var $counter = $(\".js-like .counter\");\n    var count = this.model.get(\"likes\");\n\n    if (count > 2 || this.model.get(\"show_count\")) {\n      $counter.text(count);\n    } else {\n      $counter.text(\"\");\n    }\n\n  },\n\n  _unhighlightHeart: function() {\n\n    var $button  = $(\".js-like\");\n    var $icon    = $(\".js-like .icon\");\n\n    $icon.addClass(\"is-pulsating is-animated\");\n    $icon.one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function() {\n      $(this).removeClass(\"is-pulsating is-animated\");\n      $button.removeClass(\"is-highlighted\");\n    });\n\n  },\n\n  _highlightHeart: function() {\n\n    var $button  = $(\".js-like\");\n    var $icon    = $(\".js-like .icon\");\n\n    $button.addClass(\"is-highlighted\");\n    $icon.addClass(\"is-pulsating is-animated\");\n    $icon.one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function() {\n      $(this).removeClass(\"is-pulsating is-animated\");\n    });\n  }\n\n});\n\ncdb.open.Like = cdb.admin.Like.extend({\n});\n"]}