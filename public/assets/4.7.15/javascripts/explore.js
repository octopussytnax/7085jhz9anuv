/*! v4.7.15 - 2017-05-30 */
!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("./views/base_dialog/view");b.exports={createDialogByTemplate:function(a,b,c){return this.createDialogByView(this.createByTemplate(a,b),c)},createByTemplate:function(a,b,c){var f=d.isString(a)?e.templates.getTemplate(a):a,g=new e.core.View(c);return g.render=function(){return this.$el.html(f(b)),this},g},createByList:function(a,b){var c=new e.core.View(b);return c.render=function(){return this.clearSubViews(),d.each(a,function(a){this.addView(a),this.$el.append(a.render().$el)},this),this},c},createDialogByView:function(a,b){var c=d.extend({clean_on_hide:!0,enter_to_confirm:!0},b);return new(f.extend({initialize:function(){this.elder("initialize"),this.addView(a)},render_content:function(){return a.render().el}}))(c)}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./views/base_dialog/view":3}],2:[function(a,b,c){b.exports=function(){var a=_.template('<p class="CDB-Text CDB-Size-medium u-altTextColor">"<%= quote %>"</p><% if (author) { %><p class="CDB-Text CDB-Size-medium u-altTextColor u-tSpace"><em>– <%- author %></em></p><% } %>'),b=[{quote:"Geographers never get lost. They just do accidental field work.",author:"Nicholas Chrisman"},{quote:"Geography is just physics slowed down, with a couple of trees stuck in it.",author:"Terry Pratchett"},{quote:"Not all those who wander are lost.",author:"J. R. R. Tolkien"},{quote:"In that Empire, the Art of Cartography attained such Perfection that the map of a single Province occupied the entirety of a City.",author:"Jorge Luis Borges"},{quote:"X marks the spot",author:"Indiana Jones"},{quote:"It's turtles all the way down.",author:null},{quote:"Remember: no matter where you go, there you are.",author:null},{quote:"Without geography, you're nowhere!",author:"Jimmy Buffett"},{quote:"our earth is a globe / whose surface we probe /<br />no map can replace her / but just try to trace her",author:"Steve Waterman"},{quote:"Everything happens somewhere.",author:"Doctor Who"},{quote:"A map is the greatest of all epic poems. Its lines and colors show the realization of great dreams.",author:"Gilbert H. Grosvenor"},{quote:"Everything is related to everything else,<br />but near things are more related than distant things.",author:"Tobler's first law of geography"},{quote:"Hic Sunt Dracones",author:null},{quote:"Here be dragons",author:null},{quote:"Stand in the place where you live / Now face North /<br/>Think about direction / Wonder why you haven't before",author:"R.E.M"},{quote:"The virtue of maps, they show what can be done with limited space, they foresee that everything can happen therein.",author:"José Saramago"}],c=Math.round(Math.random()*(b.length-1));return a(b[c])}},{}],3:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null,f=c.ui.common.Dialog;b.exports=f.extend({className:"Dialog is-opening",overrideDefaults:{template_name:"common/views/base_dialog/template",triggerDialogEvents:!0},initialize:function(){d.defaults(this.options,this.overrideDefaults),this.elder("initialize"),this.bind("show",this._setBodyForDialogMode.bind(this,"add")),this.bind("hide",this._setBodyForDialogMode.bind(this,"remove"))},show:function(){f.prototype.show.apply(this,arguments),this.trigger("show"),this.options.triggerDialogEvents&&c.god.trigger("dialogOpened"),this.$el.removeClass("is-closing"),document.activeElement&&document.activeElement.blur()},render:function(){return f.prototype.render.apply(this,arguments),this.$(".content").addClass("is-newContent"),this._isSticky()&&this.$el.addClass("is-sticky"),this.show(),this},_isSticky:function(){return this.options&&this.options.sticky},close:function(){this._cancel(void 0,!0)},open:function(){f.prototype.open.apply(this,arguments),this.show()},hide:function(){f.prototype.hide.apply(this,arguments),this.trigger("hide")},_cancel:function(a,b){if(a&&this.killEvent(a),!this._isSticky()){this.$el.removeClass("is-opening").addClass("is-closing");var d=this;setTimeout(function(){d.cancel&&!b&&d.cancel(),f.prototype.hide.call(d)},80),this.trigger("hide"),this.options.triggerDialogEvents&&c.god.trigger("dialogClosed")}},_ok:function(a){this.killEvent(a),this.ok?this.ok():this.close()},_setBodyForDialogMode:function(a){e("body")[a+"Class"]("is-inDialog")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],4:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=function(a){var b="leaflet",e="tiled";a.baselayer.url?a.baselayer.urlTemplate=a.baselayer.url:(b="googlemaps",e="GMapsBase");var f=c.createVis(a.el,{version:"0.1.0",title:"default",scrollwheel:void 0!==a.scrollwheel&&a.scrollwheel,zoom:6,map_provider:b,center:[40.7127837,-74.0059413],layers:[d.extend({type:e},a.baselayer)]});return f}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],5:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({tagName:"a",events:{click:"_toggleLike"},initialize:function(){this.template=c.templates.getTemplate("common/views/likes/template"),this.model.bind("change:likeable change:liked change:likes error",this.render,this)},render:function(){return this.$el.html(this.template({likes:this.model.get("likes"),size:this.model.get("size"),show_count:this.model.get("show_count"),show_label:this.model.get("show_label")})).attr({class:this._classNames(),href:this._hrefLocation()}),this},_hrefLocation:function(){var a="#/like";return this.model.get("likeable")||(a=window.login_url),a},_classNames:function(){var a=["LikesIndicator"];return this.model.get("likeable")&&a.push("is-likeable"),this.model.get("liked")&&a.push("is-liked"),this._animate&&(a.push("is-animated"),this.$el.one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){this._animate=!1,this.render()}.bind(this))),a.join(" ")},_toggleLike:function(a){this.model.get("likeable")&&(this.killEvent(a),this._animate=!0,this.model.toggleLiked())}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],6:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=d.core.View.extend({options:{width:300,height:170,privacy:"PUBLIC",username:"",visId:"",mapsApiResource:"",className:"",authTokens:[]},_TEMPLATES:{regular:"<%- protocol %>://<%= mapsApiResource %>/api/v1/map/static/named/<%- tpl %>/<%- width %>/<%- height %>.png<%= authTokens %>",cdn:"<%- protocol %>://<%- cdn %>/<%- username %>/api/v1/map/static/named/<%- tpl %>/<%- width %>/<%- height %>.png<%= authTokens %>"},initialize:function(){e.each(["visId","mapsApiResource","username"],function(a){this.options[a]||console.log(a+" is required for Static Map instantiation")},this)},load:function(){return this._startLoader(),this._loadFromVisId(),this},_generateImageTemplate:function(){return"tpl_"+this.options.visId.replace(/-/g,"_")},_loadFromVisId:function(){var a=this._isHTTPS()?"https":"http",b=d.config.get("cdn_url"),c=e.template(b?this._TEMPLATES.cdn:this._TEMPLATES.regular),f={protocol:a,username:this.options.username,mapsApiResource:this.options.mapsApiResource,tpl:this._generateImageTemplate(),width:this.options.width,height:this.options.height,authTokens:this._generateAuthTokensParams()};b&&(f=e.extend(f,{cdn:b[a]}));var g=c(f);this._loadImage({},g)},_generateAuthTokensParams:function(){var a=this.options.authTokens;return a&&a.length>0?"?"+e.map(a,function(a){return"auth_token="+a}).join("&"):""},_isHTTPS:function(){return 0===location.protocol.indexOf("https")},loadURL:function(a){var b=c('<img class="MapCard-preview" src="'+a+'" />');this.$el.append(b),this.options.className&&b.addClass(this.options.className),b.fadeIn(250)},showError:function(){this._onError()},_startLoader:function(){this.$el.addClass("is-loading")},_stopLoader:function(){this.$el.removeClass("is-loading")},_onSuccess:function(a){this._stopLoader(),this.loadURL(a),this.trigger("loaded",a)},_onError:function(a){this._stopLoader(),this.$el.addClass("has-error");var b=c('<div class="MapCard-error" />');this.$el.append(b),b.fadeIn(250),this.trigger("error")},_loadImage:function(a,b){var c=this,d=new Image;d.onerror=function(){c._onError(a)},d.onload=function(){c._onSuccess(b)};try{d.src=b}catch(a){this._onError(a)}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],7:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({initialize:function(){_.bindAll(this,"_onWindowScroll"),this._bindScroll()},_onWindowScroll:function(){this.$el.toggleClass("is-fixed",$(window).scrollTop()>this.options.anchorPoint)},_unbindScroll:function(){$(window).unbind("scroll",this._onWindowScroll)},_bindScroll:function(){this._unbindScroll(),$(window).bind("scroll",this._onWindowScroll)},clean:function(){this._unbindScroll(),this.elder("clean")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],8:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;c.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof a?a.cdb.admin:null;var d="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null;b.exports=c.admin.DropdownMenu.extend({className:"Dropdown",events:{click:"killEvent","click .js-maps":"_onClickMaps","click .js-datasets":"_onClickDatasets","click .js-both":"_onClickBoth"},initialize:function(){this.elder("initialize"),this.template_base=c.templates.getTemplate("explore/dropdown_template"),c.god.bind("closeDialogs",this.hide,this)},_onClickBoth:function(a){this.model.set("type",null),this.hide()},_onClickDatasets:function(a){this.model.set("type","table"),this.hide()},_onClickMaps:function(a){this.model.set("type","derived"),this.hide()},render:function(){return this.$el.html(this.template_base({})),d("body").append(this.el),this},clean:function(){this.elder("clean")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],9:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,e=a("../public_common/user_settings_view"),f=a("../public_common/user_industries_view"),g=a("../public_dashboard/fav_map_view"),h=a("./view"),i=a("./model");c(function(){d.init(function(){d.templates.namespace="cartodb/",d.config.set(window.config),d.config.set("url_prefix",window.base_url),d.config.set("login_url",window.login_url);new f({el:c(".js-user-industries")});c(".js-login a").attr("href",d.config.get("login_url")),c(document.body).bind("click",function(){d.god.trigger("closeDialogs")}),this.exploreModel=new i;var a=this,b=function(b){if(b){var c="//"+b.get("username")+"."+d.config.get("account_host")+"/api/v2/viz/"+b.get("id")+"/viz.json",e="//"+b.get("username")+"."+d.config.get("account_host")+"/viz/"+b.get("id")+"/public_map";a.$(".js-mapTitle").attr("href",e),a.$(".js-mapTitle").text(b.get("name"));var f=new g({el:"#fav-map-container",createVis:{url:c,opts:{annotation:!0}}});f.render(),a.$(".js-favMapTitle").removeClass("is-hidden")}};this.exploreModel.fetch({success:b});var j=new d.open.AuthenticatedUser({host:d.config.get("explore_user")+"."+d.config.get("account_host")});j.sync=Backbone.withCORS,j.bind("change",function(){if(j.get("username")){var a=new d.admin.User(j.attributes),b=new e({el:c(".js-user-settings"),model:a});b.render();var f=a.viewUrl().dashboard();c(".js-user-info .UserAvatar-img").wrap(c("<a>",{href:f})),c(".js-login").hide(),c(".js-learn").show()}});var k=new h({el:c(".js-explore"),authenticatedUser:j});k.render(),j.fetch()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../public_common/user_industries_view":14,"../public_common/user_settings_view":16,"../public_dashboard/fav_map_view":17,"./model":11,"./view":12}],10:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.Backbone:"undefined"!=typeof a?a.Backbone:null;b.exports=c.Collection.extend({url:function(){return"//"+cdb.config.get("explore_user")+"."+cdb.config.get("account_host")+"/api/v2/sql"},_SORT:{likes:"likes_trend",updated_at:"visualization_updated_at",mapviews:"mapviews_trend"},parse:function(a){return a.rows},fetch:function(a){var b=this._generateQuery(a.type,a.orderBy,a.page,a.limit);a=_.extend({q:b},{reset:a.reset}),c.Collection.prototype.fetch.call(this,{data:a})},_generateQuery:function(a,b,c,d){var e=["user_avatar_url AS avatar_url","user_username AS username","visualization_geometry_types AS geom_types","visualization_id AS id","visualization_likes AS likes","visualization_mapviews AS mapviews","visualization_mapviews::numeric / (1.0 + (now()::date - visualization_created_at::date)::numeric)^2 * 100.0 / m.max_views As mapviews_trend","visualization_likes::numeric / (1.0 + (now()::date - visualization_created_at::date)::numeric)^2 * 100.0 / m.max_likes As likes_trend","visualization_name AS name","visualization_map_datasets AS map_datasets","visualization_table_rows AS rows","visualization_table_size AS table_size","visualization_tags AS tags","visualization_title AS title","visualization_type AS type","visualization_created_at AS created_at","visualization_updated_at AS updated_at"].join(","),f="WITH m As (SELECT max(visualization_likes) As max_likes, max(visualization_mapviews) As max_views FROM <%- table %>) SELECT <%= fields %> FROM <%- table %>, m <%= where %> ORDER BY <%- order_by %> DESC, created_at DESC, visualization_id DESC LIMIT <%- limit %> OFFSET <%- offset %>";return _.template(f,{table:"visualizations",fields:e,order_by:this._SORT[b],limit:d,where:a?"WHERE visualization_type = '"+a+"'":"",offset:d*c})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],11:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.Backbone:"undefined"!=typeof a?a.Backbone:null;b.exports=c.Model.extend({url:function(){return"//"+cdb.config.get("explore_user")+"."+cdb.config.get("account_host")+"/api/v2/sql"},parse:function(a){return a.rows[0]},fetch:function(a){var b=_.extend({data:{q:this._generateQuery()}},a);c.Model.prototype.fetch.call(this,b)},_generateQuery:function(){var a=["visualization_mapviews::numeric/(1.0 + (now()::date - visualization_created_at::date)::numeric)^2 AS mapviews_trend","visualization_name AS name","user_username AS username","visualization_id AS id","visualization_likes AS likes","visualization_title AS title"].join(","),b="SELECT <%= fields %> FROM visualizations ORDER BY mapviews_trend DESC LIMIT 1";return _.template(b,{fields:a})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],12:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f=("undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null),g=a("../common/views/mapcard_preview"),h=a("../common/views/scrollable_header"),i=a("./dropdown"),j=a("./feed_collection"),k=a("../user_feed/view");b.exports=k.extend({tagName:"div",_LIMIT:8,_SMALL_WIDTH:544,_MEDIUM_WIDTH:900,_CARD_HEIGHT:220,_LOADER_TITLE:"Exploring",_DROPDOWN_TEXT:{null:"Maps and datasets",table:"Datasets",derived:"Maps"},events:{"click .js-more":"_onClickMore","click .js-likes":"_onClickLikes","click .js-updated_at":"_onClickUpdatedAt","click .js-mapviews":"_onClickMapViews","click .js-maps-datasets":"_onClickMapsAndDatasets","click .js-maps":"_onClickMaps","click .js-datasets":"_onClickDatasets"},initialize:function(){d.bindAll(this,"_initLike","_fetchLike","_onWindowResize","_renderStaticMaps"),this.maps=[],this._initTemplates(),this._initModels(),this._initBindings(),this._fetchItems()},render:function(){return this.$el.html(this.template()),this._renderLoader(),this._setupVisualizationDropdown(),this._setupScrollableHeader(),this},_setupScrollableHeader:function(){this.scrollableHeader=new h({el:e(".js-explore-context-menu"),anchorPoint:e(".Header").height()+e(".FavMap").height()}),this.addView(this.scrollableHeader)},_setupVisualizationDropdown:function(){this.visualizationDropdown=new i({target:this.$(".js-dropdown"),horizontal_position:"horizontal_left",horizontal_offset:-110,tick:"center",model:this.model,position:"offset",vertical_offset:0}),this.addView(this.visualizationDropdown),f.god.bind("closeDialogs",this.visualizationDropdown.hide,this.visualizationDropdown),this.add_related_model(f.god),e("body").append(this.visualizationDropdown.render().el)},_onWindowResize:function(){var a=e(window).width();a<=this._SMALL_WIDTH?this.model.set("size","small"):a<=this._MEDIUM_WIDTH?this.model.set("size","medium"):this.model.set("size","big"),this._renderStaticMaps()},_initTemplates:function(){this.template=f.templates.getTemplate("explore/template"),this.mapTemplate=f.templates.getTemplate("explore/map_item_template"),this.datasetTemplate=f.templates.getTemplate("explore/dataset_item_template"),this.loaderTemplatePath="explore/loading"},_initModels:function(){var a="big",b=e(window).width();b<=this._SMALL_WIDTH?a="small":b<=this._MEDIUM_WIDTH&&(a="medium"),this.model=new f.core.Model({rendered_big:!1,rendered_medium:!1,rendered_small:!1,type:"",size:a,page:0,order_by:"likes"}),this.collection=new j,this.collection.bind("reset",this._renderVisualizations,this)},_initBindings:function(){this.model.bind("change:show_more",this._onChangeShowMore,this),this.model.bind("change:show_loader",this._onChangeShowLoader,this),this.model.bind("change:show_filters",this._onChangeShowFilters,this),this.model.bind("change:show_mast",this._onChangeShowMast,this),this.model.bind("change:order_by",this._onChangeOrderBy,this),this.model.bind("change:type",this._onChangeType,this),this.add_related_model(this.options.authenticatedUser),e(window).bind("resize",this._onWindowResize)},_getGeometryType:function(a){if(a&&a.length>0){var b=["point","polygon","line","raster"],c=a[0];return d.find(b,function(a){return c.toLowerCase().indexOf(a)!==-1})}return null},_getDatasetSize:function(a){var b=a.get("table_size");return b?f.Utils.readablizeBytes(b,!0).split(" "):0},_renderVisualizations:function(){this.model.set({show_loader:!1,show_more:!0,show_filters:!0,show_mast:!0}),this.collection.each(function(a){var b="derived"===a.get("type")?this.mapTemplate:this.datasetTemplate,c=b({vis:a.attributes,date:"updated_at"===this.model.get("order_by")?a.get("updated_at"):a.get("created_at"),datasetSize:this._getDatasetSize(a),geomType:this._getGeometryType(a.get("geom_types")),account_host:f.config.get("account_host")});this.$(".js-items").append(c);var d=this.$(".js-items").find('[data-vis-id="'+a.get("id")+'"]');"derived"===a.get("type")&&this.maps.push(a),"derived"!==a.get("type")||a.get("rendered_"+this.model.get("size"))||this._renderStaticMap(a,d),this._initLike(a,d.find(".js-like"))},this)},_renderStaticMap:function(a,b){var c=a.get("id"),d=a.get("username"),e=860;"small"===this.model.get("size")?e=288:"medium"===this.model.get("size")&&(e=540);var h="is-"+this.model.get("size");c&&d&&(a.set("rendered_"+this.model.get("size"),!0),new g({el:b.find(".js-header"),width:e,height:this._CARD_HEIGHT,username:d,visId:c,className:h,mapsApiResource:f.config.getMapsResourceName(d)}).load())},_getLikesEndpoint:function(a){return"//"+a.get("username")+"."+f.config.get("account_host")+"/api/v1/viz/"+a.get("id")+"/like"},_selectType:function(a){var b=this;this.model.set({show_more:!1}),e("body").animate({scrollTop:150},{duration:250,complete:function(){b.model.set({type:a})}})},_sort:function(a){var b=this;this.model.set({show_more:!1}),e("body").animate({scrollTop:150},{duration:250,complete:function(){b.model.set({order_by:a})}})},_fetchItems:function(a){a&&(this.model.set({page:0,show_more:!1,show_loader:!0,show_mast:!1}),this.$(".js-items").empty());var b=this.model.get("type"),c=this.model.get("order_by"),d=this.model.get("page"),e=this._LIMIT;this.collection.fetch({type:b,orderBy:c,page:d,limit:e,reset:a})},_onClickMore:function(a){this.killEvent(a),this.model.set({page:this.model.get("page")+1,show_loader:!0,show_more:!1}),this._fetchItems(!1)},_onChangeType:function(){this.$(".js-dropdownLabel").text(this._DROPDOWN_TEXT[this.model.get("type")]),this._fetchItems(!0)},_onChangeOrderBy:function(){e(".js-order-link").removeClass("is-selected"),e(".js-"+this.model.get("order_by")).addClass("is-selected"),this._fetchItems(!0)},_onChangeShowFilters:function(){this.$(".js-filters").toggleClass("is-hidden",!this.model.get("show_filters"))},_onClickLikes:function(a){this.killEvent(a),this._sort("likes")},_onClickUpdatedAt:function(a){this.killEvent(a),this._sort("updated_at")},_onClickMapViews:function(a){this.killEvent(a),this._sort("mapviews")},_onClickMapsAndDatasets:function(a){this.killEvent(a),this._selectType(null)},_onClickMaps:function(a){this.killEvent(a),this._selectType("derived")},_onClickDatasets:function(a){this.killEvent(a),this._selectType("table")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../common/views/mapcard_preview":6,"../common/views/scrollable_header":7,"../user_feed/view":19,"./dropdown":8,"./feed_collection":10}],13:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;c.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof a?a.cdb.admin:null;var d="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null;b.exports=c.admin.DropdownMenu.extend({className:"CDB-Text Dropdown Dropdown--public",initialize:function(){this.elder("initialize"),this.template_base=c.templates.getTemplate("public_common/user_industries/dropdown_template"),c.god.bind("closeDialogs",this.hide,this)},render:function(){return this.$el.html(this.template_base()),d("body").append(this.el),this},clean:function(){d(this.options.target).unbind("click",this._handleClick),this.constructor.__super__.clean.apply(this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],14:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./user_industries/dropdown_view"),f="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null;b.exports=d.core.View.extend({events:{"click .js-dropdown-target":"_createDropdown"},_createDropdown:function(a){this.killEvent(a),d.god.trigger("closeDialogs");var b=new e({target:f(a.target),vertical_offset:-10,horizontal_offset:f(a.target).width()-100,horizontal_position:"left",tick:"center"});b.render(),b.on("onDropdownHidden",function(){b.clean()},this),b.open()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./user_industries/dropdown_view":13}],15:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;c.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof a?a.cdb.admin:null;var d="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null;b.exports=c.admin.DropdownMenu.extend({className:"CDB-Text Dropdown",initialize:function(){this.elder("initialize"),this.template_base=c.templates.getTemplate("public_common/user_settings/dropdown_template"),c.god.bind("closeDialogs",this.hide,this)},render:function(){var a=this.model,b=a.viewUrl();return this.$el.html(this.template_base({name:a.get("name")||a.get("username"),email:a.get("email"),isOrgOwner:a.isOrgOwner(),dashboardUrl:b.dashboard(),publicProfileUrl:b.publicProfile(),accountSettingsUrl:b.accountSettings(),logoutUrl:b.logout()})),d("body").append(this.el),this},clean:function(){d(this.options.target).unbind("click",this._handleClick),this.constructor.__super__.clean.apply(this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],16:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./user_settings/dropdown_view"),f="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null;b.exports=d.core.View.extend({events:{"click .js-dropdown-target":"_createDropdown"},render:function(){var a=this.model.viewUrl().dashboard(),b=a.datasets(),c=a.maps();return this.$el.html(d.templates.getTemplate("public_common/user_settings_template")({avatarUrl:this.model.get("avatar_url"),mapsUrl:c,datasetsUrl:b})),this},_createDropdown:function(a){this.killEvent(a),d.god.trigger("closeDialogs");var b=new e({target:f(a.target),model:this.model,horizontal_offset:18});b.render(),b.on("onDropdownHidden",function(){b.clean()},this),b.open()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./user_settings/dropdown_view":15}],17:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("../common/views/create_default_fallback_map");b.exports=d.core.View.extend({render:function(){this.$el.removeClass("is-pre-loading").addClass("is-loading");var a;a=this.options.createVis?this._createVisMap(this.options.createVis):this._createFallbackMap();var b=this;return a.done(function(){b.$el.removeClass("is-loading"),b.$(".js-spinner").remove()}),this},_createVisMap:function(a){return d.createVis(this.el,a.url,e.defaults(a.opts,{title:!1,header:!1,description:!1,search:!1,layer_selector:!1,text:!1,image:!1,shareable:!1,annotation:!1,zoom:!1,cartodb_logo:!1,scrollwheel:!1,mobile_layout:!0,slides_controller:!1,legends:!1,time_slider:!1,loader:!1,fullscreen:!1,no_cdn:!1}))},_createFallbackMap:function(){return f({el:this.el,baselayer:this.options.fallbackBaselayer}),{done:function(a){a()}}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../common/views/create_default_fallback_map":4}],18:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.Backbone:"undefined"!=typeof a?a.Backbone:null;b.exports=c.Collection.extend({url:"/api/v1/viz",parse:function(a){return this.total_entries=a.total_entries,a.visualizations}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],19:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../common/view_factory"),f=a("../common/view_helpers/random_quote"),g=a("../common/views/likes/view"),h=a("../common/views/mapcard_preview"),i=a("./feed_collection");b.exports=d.core.View.extend({tagName:"div",_PAGE:1,_ITEMS_PER_PAGE:8,_SMALL_WIDTH:544,_CARD_HEIGHT:170,_LOADER_TITLE:"Loading visualizations",events:{"click .js-more":"_onClickMore"},initialize:function(){_.bindAll(this,"_initLike","_fetchLike","_onFetchError","_onWindowResize","_renderStaticMaps"),this.maps=[],this._initTemplates(),this._initModels(),this._initBindings()},render:function(){return this.$el.html(this.template()),this._renderLoader(),this._fetchItems({page:this._PAGE}),this},_onWindowResize:function(){var a=$(window).width();a<=this._SMALL_WIDTH?this.model.set("size","small"):this.model.set("size","big"),this._renderStaticMaps()},_initTemplates:function(){this.template=d.templates.getTemplate("user_feed/template"),this.mapTemplate=d.templates.getTemplate("user_feed/map_item_template"),this.datasetTemplate=d.templates.getTemplate("user_feed/dataset_item_template"),this.loaderTemplatePath="user_feed/loading",this.emptyTemplatePath="user_feed/empty",this.errorTemplatePath="user_feed/error"},_initModels:function(){var a="big",b=$(window).width();b<=this._SMALL_WIDTH&&(a="small"),this.model=new d.core.Model({vis_count:0,type:"",size:a,page:0,order_by:"likes"}),this.collection=new i,this.collection.bind("reset",this._renderVisualizations,this)},_initBindings:function(){this.model.bind("change:show_more",this._onChangeShowMore,this),this.model.bind("change:show_loader",this._onChangeShowLoader,this),this.model.bind("change:show_mast",this._onChangeShowMast,this),this.model.bind("change:vis_count",this._onChangeVisCount,this),$(window).bind("resize",this._onWindowResize)},_onChangeVisCount:function(){this.model.get("vis_count")>=this.collection.total_entries?this.model.set({show_more:!1}):this.model.set({show_more:!0})},_onChangeShowMast:function(){this.model.get("show_mast")?this.$(".js-mast").removeClass("is-hidden"):this.$(".js-mast").addClass("is-hidden")},_onChangeShowLoader:function(){this.model.get("show_loader")?this.loader.show():this.loader.hide()},_onChangeShowMore:function(){this.$(".js-more").toggleClass("is-hidden",!this.model.get("show_more"))},_renderLoader:function(){this.loader=e.createByTemplate(this.loaderTemplatePath,{title:this._LOADER_TITLE,quote:f()}),this.$el.append(this.loader.render().$el)},_renderError:function(){this.error=e.createByTemplate(this.errorTemplatePath,{}),this.$el.append(this.error.render().$el)},_renderEmpty:function(){this.empty=e.createByTemplate(this.emptyTemplatePath,{name:config.user_name}),this.$el.append(this.empty.render().$el)},_getDatasetSize:function(a){var b=a.get("table").size;return b?d.Utils.readablizeBytes(b,!0).split(" "):0},_getGeometryType:function(a){if(a&&a.length>0){var b=["point","polygon","line","raster"],c=a[0];return _.find(b,function(a){return c.toLowerCase().indexOf(a)!==-1})}return null},_renderVisualizations:function(){return 0===this.collection.length?(this.model.set({show_loader:!1}),void this._renderEmpty()):(this.model.set({vis_count:this.model.get("vis_count")+this.collection.length,show_loader:!1,show_more:!0,show_filters:!0,show_mast:!0}),void this.collection.each(function(a){var b="derived"===a.get("type")?this.mapTemplate:this.datasetTemplate,c=a.get("table")&&a.get("table").geometry_types?this._getGeometryType(a.get("table").geometry_types):null,e=a.get("permission").owner,f=b({vis:a.attributes,datasetSize:this._getDatasetSize(a),username:e.username,avatar_url:e.avatar_url,table_count:e.table_count,maps_count:e.maps_count,geomType:c,account_host:config.account_host,base_url:d.config.get("url_prefix")});this.$(".js-items").append(f);var g=this.$(".js-items").find('[data-vis-id="'+a.get("id")+'"]');"derived"===a.get("type")&&this.maps.push(a),"derived"!==a.get("type")||a.get("rendered_"+this.model.get("size"))||this._renderStaticMap(a,g),
this._initLike(a,g.find(".js-like"))},this))},_renderStaticMaps:function(){_.each(this.maps,function(a){if(!a.get("rendered_"+this.model.get("size"))){var b=this.$(".js-items").find('[data-vis-id="'+a.get("id")+'"]');this._renderStaticMap(a,b)}},this)},_renderStaticMap:function(a,b){var c=a.get("id"),e=a.get("permission").owner.username,f=540,g="is-"+this.model.get("size");"small"===this.model.get("size")&&(f=288),c&&e&&(a.set("rendered_"+this.model.get("size"),!0),new h({el:b.find(".js-header"),width:f,height:this._CARD_HEIGHT,mapsApiResource:d.config.getMapsResourceName(e),username:e,visId:c,className:g}).load())},_getLikesEndpoint:function(a){return"/api/v1/viz/"+a.get("id")+"/like"},_initLike:function(a,b){var c=this.options.authenticatedUser&&this.options.authenticatedUser.get("username"),e=d.admin.Like.newByVisData({likeable:!1,show_label:!0,vis_id:a.get("id"),likes:a.get("likes")}),f=this._getLikesEndpoint(a);c?this._fetchLike(e,f):this.options.authenticatedUser.bind("change",function(){this._fetchLike(e,f)},this);var h=new g({el:b,model:e});h.render()},_fetchLike:function(a,b){this.options.authenticatedUser.get("username")&&(a.bind("loadModelCompleted",function(){a.set("likeable",!0)}),a.url=b,a.sync=Backbone.withCORS,a.fetch())},_fetchItems:function(a){var b=_.extend({types:"table,derived",privacy:"public",exclude_shared:"true",per_page:this._ITEMS_PER_PAGE,order:"updated_at"},a);this.collection.fetch({data:b,error:this._onFetchError})},_onFetchError:function(){this.model.set({show_loader:!1}),this._renderError()},_onClickMore:function(a){this.killEvent(a),this.model.set({show_more:!1,show_loader:!0}),this._fetchItems({page:++this._PAGE})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../common/view_factory":1,"../common/view_helpers/random_quote":2,"../common/views/likes/view":5,"../common/views/mapcard_preview":6,"./feed_collection":18}]},{},[9]);
//# sourceMappingURL=explore.js.map