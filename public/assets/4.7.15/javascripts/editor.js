/*! v4.7.15 - 2017-05-30 */
!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./models/imports_collection"),f=a("./models/geocodings_collection"),g=a("./models/analysis_collection"),h=3e3;b.exports=d.core.Model.extend({defaults:{showGeocodingDatasetURLButton:!1,showSuccessDetailsButton:!0,geocodingsPolling:!1,importsPolling:!1},initialize:function(a,b){this.user=b.user,this.vis=b.vis,this.importsCollection=b.importsCollection||new e(null,{user:this.user}),this.geocodingsCollection=b.geocodingsCollection||new f(null,{user:this.user,vis:this.vis}),this.analysisCollection=b.anaylysisCollection||new g(null,{user:this.user}),this._initBinds(),this.startPollings()},_initBinds:function(){this.importsCollection.bind("change:state",function(a){this.trigger("change",a,this),this._onImportsStateChange(a)},this),this.importsCollection.bind("remove",function(a){this.trigger("importRemoved",a,this)},this),this.importsCollection.bind("add",function(a){this.trigger("importAdded",a,this)},this),this.geocodingsCollection.bind("change:state",function(a){this.trigger("change",a,this),this._onGeocodingsStateChange(a)},this),this.geocodingsCollection.bind("remove",function(a){this.trigger("geocodingRemoved",a,this)},this),this.geocodingsCollection.bind("add",function(a){this.trigger("geocodingAdded",a,this)},this),this.analysisCollection.bind("reset",function(){this.analysisCollection.size()>0?this.trigger("analysisAdded",this.analysisCollection,this):this.trigger("analysisRemoved",this.analysisCollection,this)},this),this.analysisCollection.bind("change:state",function(a){this._onAnalysisStateChange(a,this.analysisCollection)},this)},getTotalFailedItems:function(){return this.importsCollection.failedItems().length+this.geocodingsCollection.failedItems().length},removeImportItem:function(a){return!!a&&void this.importsCollection.remove(a)},addImportItem:function(a){return!!a&&void this.importsCollection.add(a)},removeGeocodingItem:function(a){return!(!a||!this.canAddImport())&&void this.geocodingsCollection.remove(a)},addGeocodingItem:function(a){return!(!a||!this.canAddGeocoding())&&void this.geocodingsCollection.add(a)},removeAnalysis:function(){this.analysisCollection.destroyCheck(),this.analysisCollection.reset()},addAnalysis:function(a){return!(!a||!this.canAddAnalysis())&&void this.analysisCollection.reset(a)},canAddImport:function(){return this.importsCollection.canImport()},canAddGeocoding:function(){return this.geocodingsCollection.canGeocode()},canAddAnalysis:function(){return this.analysisCollection.canStartPecan()},getTotalImports:function(){return this.importsCollection.size()},getTotalGeocodings:function(){return this.geocodingsCollection.size()},getTotalAnalysis:function(){return this.analysisCollection.size()>0?1:0},getTotalPollings:function(){return this.importsCollection.size()+this.geocodingsCollection.size()+(this.analysisCollection.isAnalyzing()?1:0)},stopPollings:function(){this.get("geocodingsPolling")&&this.geocodingsCollection.destroyCheck(),this.get("importsPolling")&&this.importsCollection.destroyCheck()},startPollings:function(){var a=this;setTimeout(function(){a.get("geocodingsPolling")&&a.geocodingsCollection.pollCheck(),a.get("importsPolling")&&a.importsCollection.pollCheck()},h)},_onImportsStateChange:function(){},_onGeocodingsStateChange:function(){},_onAnalysisStateChange:function(){},clean:function(){this.importsCollection.unbind(null,null,this),this.geocodingsCollection.unbind(null,null,this),this.analysisCollection.unbind(null,null,this),this.elder("clean")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./models/analysis_collection":3,"./models/geocodings_collection":6,"./models/imports_collection":9}],2:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null),e=a("./views/imports/background_import_item_view"),f=a("./views/analysis/background_analysis_item_view"),g=a("./views/geocodings/background_geocoding_item_view"),h=a("./views/imports/background_import_limit_view"),i=a("./models/imports_model"),j=(a("./models/geocoding_model"),a("./background_polling_model")),k=a("./views/background_polling_header_view");b.exports=d.core.View.extend({className:"BackgroundPolling",initialize:function(){this.user=this.options.user,this.createVis=this.options.createVis,this.vis=this.options.vis,this.model||(this.model=new j({},{user:this.user})),this.template=d.templates.getTemplate("common/background_polling/background_polling"),this._initBinds()},render:function(){return this.$el.html(this.template()),this._initViews(),this},_initBinds:function(){this.model.bind("importAdded",this._addImport,this),this.model.bind("geocodingAdded",this._addGeocoding,this),this.model.bind("analysisAdded",this._addAnalysis,this),this.model.bind("analysisAdded analysisRemoved importAdded importRemoved geocodingAdded geocodingRemoved",this._checkPollingsSize,this),d.god.bind("importByUploadData",this._addDataset,this),d.god.bind("fileDropped",this._onDroppedFile,this),this.add_related_model(d.god)},_initViews:function(){var a=new k({model:this.model});this.$el.prepend(a.render().el),this.addView(a)},_checkPollingsSize:function(){this.model.getTotalPollings()>0?this.show():this.hide()},_addAnalysis:function(a){this._analysisItem&&this._analysisItem.clean(),this._analysisItem=new f({collection:a,vis:this.vis,user:this.user}),this._analysisItem.bind("remove",function(a){this.model.removeAnalysis()},this),this.$(".js-list").prepend(this._analysisItem.render().el),this.addView(this._analysisItem)},_addGeocoding:function(a){var b=new g({showGeocodingDatasetURLButton:this.model.get("showGeocodingDatasetURLButton"),model:a,user:this.user});b.bind("remove",function(a){this.model.removeGeocodingItem(a)},this),this.$(".js-list").prepend(b.render().el),this.addView(b),this.enable()},_addImport:function(a){var b=new e({showSuccessDetailsButton:this.model.get("showSuccessDetailsButton"),model:a,user:this.user});b.bind("remove",function(a){this.model.removeImportItem(a)},this),this.$(".js-list").prepend(b.render().el),this.addView(b),this.enable()},_addDataset:function(a){a&&this._addImportsItem(a)},_onDroppedFile:function(a){a&&this._addImportsItem({type:"file",value:a,create_vis:this.createVis})},_addImportsItem:function(a){if(!this.model.canAddImport())return this._addLimitItem(),!1;this._removeLimitItem();var b=new i({},{upload:a,user:this.user});this.model.addImportItem(b)},_addLimitItem:function(){if(!this._importLimit){var a=new h({user:this.user});this.$(".js-list").prepend(a.render().el),this.addView(a),this._importLimit=a}},_removeLimitItem:function(){var a=this._importLimit;a&&(a.clean(),this.removeView(a),delete this._importLimit)},enable:function(){this.model.startPollings()},disable:function(){this.model.stopPollings()},show:function(){this.$el.addClass("is-visible")},hide:function(){this.$el.removeClass("is-visible")},clean:function(){this.disable(),this.elder("clean")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./background_polling_model":1,"./models/geocoding_model":4,"./models/imports_model":10,"./views/analysis/background_analysis_item_view":16,"./views/background_polling_header_view":18,"./views/geocodings/background_geocoding_item_view":19,"./views/imports/background_import_item_view":21,"./views/imports/background_import_limit_view":22}],3:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("cartodb-pecan"),g=a("./pecan_model"),h=5;b.exports=d.Collection.extend({model:g,initialize:function(a,b){this.user=b.user,this._initBinds()},_initBinds:function(){this.bind("reset",this.pollCheck,this)},canStartPecan:function(){return this.getTotalAnalysis()===this.getCompletedAnalysis()},pollCheck:function(){this._nextAnalysisItems&&e.each(this._nextAnalysisItems,function(a){a.unbind(null,null,this)},this);var a=e.first(this.where({state:"idle"}),h);a.length>0&&(this._nextAnalysisItems=a,e.each(this._nextAnalysisItems,function(a){this.user.featureEnabled("pecan_debugging")&&a.bind("print_stats",function(a){this._printStats(a)},this),a.bind("change:state",function(a,b){if(a.isAnalyzed()){var c=e.find(this._nextAnalysisItems,function(a){return!a.isAnalyzed()});c||this.pollCheck()}},this),a.getData()},this))},_printStats:function(a){var b=a.column,c=a.type,d=a.weight,e=a.skew,g=a.distinct,h=a.count,i=a.null_ratio,j=a.dist_type,k=(d+f.getWeightFromShape(j))/2,l=g/h*100;cdb.log.info("%cAnalyzing %c"+b,"text-decoration:underline; font-weight:bold","text-decoration:underline; font-weight:normal"),cdb.log.info("%c · %ctype%c = "+c,"color:#666;","color: #666; font-weight:bold;","color: #666; font-weight:normal"),cdb.log.info("%c · %cdistinctPercentage%c = "+l,"color:#666;","color: #666; font-weight:bold;","color: #666; font-weight:normal"),cdb.log.info("%c · %ccount%c = "+h,"color:#666;","color: #666; font-weight:bold;","color: #666; font-weight:normal;"),cdb.log.info("%c · %cnull ratio%c = "+i,"color:#666;","color: #666; font-weight:bold;","color: #666; font-weight:normal;"),j&&(cdb.log.info("%c · %cdist_type%c = "+j,"color:#666;","color: #666; font-weight:bold;","color: #666; font-weight:normal;"),cdb.log.info("%c · %ccalc_weight%c = "+k,"color:#666;","color: #666; font-weight:bold;","color: #666; font-weight:normal;")),e&&cdb.log.info("%c · %cskew%c: "+e.toFixed(2),"color:#666;","color: #666; font-weight:bold;","color: #666; font-weight:normal;"),d&&cdb.log.info("%c · %cweight%c: "+d.toFixed(2),"color: #666;","color:#666; font-weight:bold;","color:#666;font-weight:normal"),a.density&&cdb.log.info("%c · %cdensity%c: "+a.density,"color:#666;","color: #666; font-weight:bold;","color: #666; font-weight:normal;")},destroyCheck:function(){var a=this.where({state:"idle"});this.remove(a)},failedItems:function(){},getTotalAnalysis:function(){return this.size()},getSuccessfullyAnalysedColumns:function(){return this.where({success:!0}).length},getCompletedAnalysis:function(){return this.where({state:"analyzed"}).length},isAnalyzing:function(){return this.getCompletedAnalysis()!==this.getTotalAnalysis()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./pecan_model":12,"cartodb-pecan":234}],4:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,"undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null),e=a("./geocoding_model_poller");b.exports=cdb.core.Model.extend({options:{startPollingAutomatically:!0},defaults:{kind:"",formatter:"",table_name:"",state:""},url:function(a){var b=cdb.config.urlVersion("geocoding",a),c="/api/"+b+"/geocodings/";return this.isNew()?c:c+this.id},setUrlRoot:function(a){this.urlRoot=a},initialize:function(a){this._initBinds(),d.extend(this.options,a),this.poller=new e(this),this.options.startPollingAutomatically&&this._checkModel()},_initBinds:function(){this.bind("change:id",this._checkModel,this)},_checkModel:function(){this.get("id")?this.pollCheck():this._saveModel()},_saveModel:function(){var a=this;this.isNew()&&this.save({},{error:function(){a.set({state:"failed",error:{title:"Oops, there was a problem",description:"Unfortunately there was an error starting the geocoder"}})}})},pollCheck:function(){this.poller.start()},destroyCheck:function(){this.poller.stop()},getError:function(){return this.get("error")},hasFailed:function(){var a=this.get("state");return"failed"===a||"reset"===a||"cancelled"===a},hasCompleted:function(){return"finished"===this.get("state")},isOngoing:function(){return!this.hasCompleted()&&!this.hasFailed()},cancelGeocoding:function(){this.save({state:"cancelled"},{wait:!0})},resetGeocoding:function(){this.set("state","reset")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./geocoding_model_poller":5}],5:[function(a,b,c){var d=a("./poller"),e=function(a){var b=2e3,c={interval:b,stopWhen:function(a){return a.hasFailed()||a.hasCompleted()},error:function(a){a.trigger("change")}};d.call(this,a,c)};e.prototype=_.extend({},d.prototype),b.exports=e},{"./poller":13}],6:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=6e4,g=a("./geocoding_model");b.exports=d.Collection.extend({model:g,url:function(a){var b=cdb.config.urlVersion("geocoding",a);return"/api/"+b+"/geocodings"},initialize:function(a,b){this.user=b.user,this.vis=b.vis},parse:function(a){var b=this;return e.each(a.geocodings,function(a){var c=b.filter(function(b){return b.get("id")===a.id});0===c.length&&b._checkOngoingGeocoding(new g(a,{startPollingAutomatically:!1}))}),this.models},_checkOngoingGeocoding:function(a){if(this.vis){var b=this;this.vis.map.layers.each(function(c){c.table&&c.table.id===a.get("table_name")&&(b.add(a),a.pollCheck())})}else this.add(a),a.pollCheck()},canGeocode:function(){return!this.any(function(a){return a.isOngoing()})},fetchGeocodings:function(){var a=this;this.fetch({error:function(b){a.destroyCheck()}})},pollCheck:function(a){if(!this.pollTimer){var b=this;this.pollTimer=setInterval(function(){b.fetchGeocodings()},f),this.fetchGeocodings()}},destroyCheck:function(){clearInterval(this.pollTimer),delete this.pollTimer},failedItems:function(){return this.filter(function(a){return a.hasFailed()})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./geocoding_model":4}],7:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null,f=a("./import_model_poller");b.exports=d.core.Model.extend({url:function(a){var b=d.config.urlVersion("import",a),c="/api/"+b+"/imports";return this.isNew()?c:c+"/"+this.id},idAttribute:"item_queue_id",initialize:function(){this._initBinds(),this.poller=new f(this)},_initBinds:function(){this.bind("change:item_queue_id",this._checkQueueId,this)},createImport:function(a){var b=this._prepareData(a);this[0===b.interval?"_createRegularImport":"_createSyncImport"](b)},_checkQueueId:function(){this.get("item_queue_id")&&this.pollCheck()},_prepareData:function(a){var b={create_vis:a.create_vis,privacy:a.privacy},c=a.type;"remote"!==c&&_.extend(b,{type_guessing:a.type_guessing,content_guessing:a.content_guessing,interval:a.interval});var d=a.service_name;if("url"===c&&_.extend(b,{url:a.value}),"remote"===c&&_.extend(b,{type:"remote",interval:null,remote_visualization_id:a.remote_visualization_id,create_vis:!1,value:a.value}),"sql"===c&&_.extend(b,{table_name:a.table_name,sql:a.value}),"duplication"===c&&_.extend(b,{table_name:a.table_name,table_copy:a.value}),"service"===c){var e="twitter_search"===d?JSON.stringify(a.service_item_id):a.service_item_id;a.user_defined_limits&&(b.user_defined_limits=a.user_defined_limits),_.extend(b,{value:a.value,service_name:a.service_name,service_item_id:e})}return b},_createSyncImport:function(a){var b=this,c=new e.TableSynchronization(a);c.save(null,{success:function(a){b.set("item_queue_id",a.get("data_import").item_queue_id)},error:function(a,c,d){b._setErrorState(c)}})},_createRegularImport:function(a){var b=this;this.save(a,{error:function(a,c,d){b._setErrorState(c)}})},_setErrorState:function(a){var b;try{b=a&&JSON.parse(a.responseText).errors.imports}catch(a){b="Unfortunately there was an error starting the import"}this.set({state:"failure",get_error_text:{title:"There was an error",what_about:b}})},pollCheck:function(){this.poller.start()},destroyCheck:function(){this.poller.stop()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./import_model_poller":8}],8:[function(a,b,c){var d=a("./poller"),e=function(a){var b=2e3,c=2.5,e=30,f={interval:function(a){return a>=e?b*c:b},stopWhen:function(a){var b=a.get("state");return"complete"===b||"failure"===b}};d.call(this,a,f)};e.prototype=_.extend({},d.prototype),b.exports=e},{"./poller":13}],9:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=3e4,g=a("./imports_model");b.exports=d.Collection.extend({model:g,url:function(a){var b=cdb.config.urlVersion("import",a);return"/api/"+b+"/imports"},initialize:function(a,b){this.user=b.user},parse:function(a){var b=this;return 0===a.imports.length?this.destroyCheck():e.each(a.imports,function(a){var c=b.filter(function(b){return b.imp.get("item_queue_id")===a});0===c.length&&b.add(new g({id:a},{user:b.user}))}),this.models},canImport:function(){var a=this.user.getMaxConcurrentImports(),b=this.size(),c=0;return this.each(function(a){(a.hasFailed()||a.hasCompleted())&&++c}),b-c<a},pollCheck:function(a){if(!this.pollTimer){var b=this;this.pollTimer=setInterval(function(){b.fetch()},f||2e3),this.fetch()}},destroyCheck:function(){clearInterval(this.pollTimer),delete this.pollTimer},failedItems:function(){return this.filter(function(a){return a.hasFailed()})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./imports_model":10}],10:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./import_model"),g=a("./upload_model");b.exports=d.core.Model.extend({defaults:{step:"upload",state:""},initialize:function(a,b){e.isEmpty(b)&&(b={}),this.user=b&&b.user,this.upl=new g(b.upload,{user:this.user}),this.imp=new f(b.import),this._initBinds(),this._checkStatus()},_initBinds:function(){this.bind("change:import",this._onImportChange,this),this.bind("change:upload",this._onUploadChange,this),this.bind("change:id",this._onIdChange,this),this.imp.bind("change",function(){this.trigger("change:import"),this.trigger("change")},this),this.upl.bind("change",function(){this.trigger("change:upload"),this.trigger("change")},this)},_destroyBinds:function(){this.upl.unbind(null,null,this),this.imp.unbind(null,null,this)},_onIdChange:function(){var a=this.get("id");a&&this.imp.set("item_queue_id",a),this.set("step","import")},_onUploadChange:function(a,b){if("upload"===this.get("step")){var c=this.upl.get("item_queue_id"),d=this.upl.get("state");c&&this.set("id",c),d&&this.set("state",d)}},_onImportChange:function(){if("import"===this.get("step")){var a=this.imp.get("state");a&&this.set("state",a)}},_checkStatus:function(){return this.get("id")||this.upl.isValid()?void("file"===this.upl.get("type")?this.upl.upload():this.get("id")?(this.set("step","import"),this.imp.set("item_queue_id",this.get("id"))):this.imp.get("item_queue_id")||""===this.upl.get("type")||(this.set("step","import"),this.imp.createImport(this.upl.toJSON()))):void this.trigger("change:upload")},pause:function(){this.stopUpload(),this.stopImport()},hasFailed:function(){var a=this.get("state"),b=this.get("step");return"import"===b&&"failure"===a||"upload"===b&&"error"===a},hasCompleted:function(){return"import"===this.get("step")&&this.imp&&"complete"===this.imp.get("state")},getWarnings:function(){var a=this.get("step");return"import"===a?this.imp.get("warnings"):""},getError:function(){if(this.hasFailed()){var a=this.get("step");return e.extend({error_code:this["upload"===a?"upl":"imp"].get("error_code"),item_queue_id:"import"===a?this.imp.get("id"):"",original_url:"import"===a?this.imp.get("original_url"):"",data_type:"import"===a?this.imp.get("data_type"):"",http_response_code:"import"===a?this.imp.get("http_response_code"):"",http_response_code_message:"import"===a?this.imp.get("http_response_code_message"):""},this["upload"===a?"upl":"imp"].get("get_error_text"))}return{title:"",what_about:"",error_code:""}},importedVis:function(){return this.get("import").derived_visualization_id?this._getMapVis():this._getDatasetVis()},_getMapVis:function(){var a=this.imp.get("derived_visualization_id");return!!a&&this._createVis({type:"derived",id:a})},_getDatasetVis:function(){var a=this.imp.get("table_name");return!!a&&this._createVis({type:"table",table:{name:a}})},_createVis:function(a){var b=new d.admin.Visualization(a);return b.permission.owner=this.user,b},setError:function(a){var b=this.get("step"),c=this["upload"===b?"upl":"imp"];this.stopUpload(),this.stopImport(),c.set(a),this.set("state","error")},stopUpload:function(){this.upl.stopUpload()},stopImport:function(){this.imp.destroyCheck()},get:function(a){return"upload"===a?this.upl.toJSON():"import"===a?this.imp.toJSON():d.core.Model.prototype.get.call(this,a)},toJSON:function(){return{step:this.get("step"),id:this.get("id"),state:this.get("state"),upload:this.upl.toJSON(),import:this.imp.toJSON()}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./import_model":7,"./upload_model":15}],11:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.core.Model.extend({initialize:function(a){if(!a.table)throw new Error("table is required");if(!a.longitude_column)throw new Error("longitude_column is required");if(!a.latitude_column)throw new Error("latitude_column is required");if(!d.isBoolean(a.force_all_rows))throw new Error("force_all_rows is required");this.set("table_name",a.table.get("name")),this._startGeocoding()},_startGeocoding:function(){this._changeState("isOngoing");var a=this,b=this.get("table");b.save({longitude_column:this.get("longitude_column"),latitude_column:this.get("latitude_column"),force_all_rows:this.get("force_all_rows")},{success:function(){b.trigger("geolocated"),b.data().fetch(),a._changeState("hasCompleted")},error:function(b,c){var d;try{d=c&&JSON.parse(c.responseText).errors[0]}catch(a){d="Unknown error"}a.set("error",d),a._changeState("hasFailed")},wait:!0})},isOngoing:function(){return this.get("isOngoing")},hasCompleted:function(){return this.get("hasCompleted")},hasFailed:function(){return this.get("hasFailed")},getError:function(){return this.get("error")},_changeState:function(a){var b=d.reduce(["isOngoing","hasCompleted","hasFailed"],function(b,c){return b[c]=c===a,b},{});this.set(b)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],12:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("cartodb-pecan");b.exports=e.core.Model.extend({_PRINT_STATS:!0,defaults:{table_id:"",column:"",state:"idle"},initialize:function(){d.bindAll(this,"_onDescribe"),this.sql=e.admin.SQL(),this.query="SELECT * FROM "+this.get("table_id")},getData:function(){this.sql.describe(this.query,this.get("column"),{},this._onDescribe)},_onDescribe:function(a){var b={state:"analyzed",success:!1};this._PRINT_STATS&&this.trigger("print_stats",a,this);var c=f.hasEnoughToGuess({stats:a,isPointGeometryType:"point"===this.get("geometry_type")});if(c){var e=f.guessMap({tableName:this.get("table_id"),column:{stats:a,geometryType:this.get("geometry_type"),bbox:this.get("bbox")},dependencies:{underscore:d}});if(e){var g={sql:this.query,success:!0};b=d.extend(b,g,a,e)}}"geom"===a.type&&a.bbox&&(b.bbox=a.bbox),this.set(b)},isAnalyzed:function(){return"analyzed"===this.get("state")},hasFailed:function(){return"failed"===this.get("state")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"cartodb-pecan":234}],13:[function(a,b,c){var d=function(a,b){this.model=a,this.numberOfRequests=0,this.polling=!1,this.interval=b.interval,"function"!=typeof this.interval&&(this.interval=function(){return b.interval}),this.stopWhen=b.stopWhen,this.error=b.error,this.autoStart=b.autoStart,this.autoStart&&this.start()};d.prototype.start=function(){this.timeout||this._scheduleFetch()},d.prototype._scheduleFetch=function(){this.timeout=setTimeout(this._fetch.bind(this),this.interval(this.numberOfRequests))},d.prototype._fetch=function(){var a=this;a.polling||(a.polling=!0,a.model.fetch({success:function(){a.polling=!1,a.numberOfRequests++,a._continuePolling()&&a._scheduleFetch()},error:function(b){_.isFunction(a.error)&&a.error(a.model)}}))},d.prototype._continuePolling=function(){return!this.stopWhen||_.isFunction(this.stopWhen)&&!this.stopWhen(this.model)},d.prototype.stop=function(){this.polling=!1,clearTimeout(this.timeout),delete this.timeout},b.exports=d},{}],14:[function(a,b,c){b.exports={uploadStates:["enqueued","pending","importing","uploading","guessing","unpacking","getting","creating","complete"],fileExtensions:["csv","xls","xlsx","zip","kml","geojson","json","ods","kmz","tsv","gpx","tar","gz","tgz","osm","bz2","tif","tiff","txt","sql","rar","carto","gpkg"],fileTimesBigger:3}},{}],15:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,e=a("./upload_config"),f="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,g="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null,h="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;b.exports=d.Model.extend({url:"/api/v1/imports",fileAttribute:"filename",defaults:{type:"",value:"",interval:0,privacy:"",progress:0,state:"idle",service_item_id:"",service_name:"",option:"",content_guessing:!0,type_guessing:!0,create_vis:!0},initialize:function(a,b){this.user=b&&b.user,this._initBinds(),this._validate(this.attributes,{validate:!0})},isValidToUpload:function(){return this.get("value")&&"error"!==this.get("state")},setFresh:function(a){a&&!h.isEmpty(a)?this.set(h.omit(a,"create_vis")):this.clear()},_initBinds:function(){this.bind("progress",function(a){this.set({progress:100*a,state:"uploading"})},this),this.bind("change:value",function(){"error"===this.get("state")&&(this.set({state:"idle"}),this.unset("get_error_text",{silent:!0}))},this),this.bind("error invalid",function(a,b){this.set({state:"error",error_code:b&&b.error_code||"",get_error_text:{title:"Invalid import",what_about:b&&b.msg||""}},{silent:!0}),this.trigger("change")},this)},validate:function(a){if(a){if("file"===a.type){if(a.value&&a.value.length)return{msg:"Unfortunately only one file is allowed per upload"};var b=a.value.name;if(!b)return{msg:"File name should be defined"};var c=b.substr(b.lastIndexOf(".")+1);if(c&&(c=c.toLowerCase()),!h.contains(e.fileExtensions,c))return{msg:"Unfortunately this file extension is not allowed"};if(this.user&&this.user.get("remaining_byte_quota")*e.fileTimesBigger<a.value.size)return{msg:"Unfortunately the size of the file is bigger than your remaining quota",error_code:8001}}if("remote"===a.type){if(!a.remote_visualization_id)return{msg:"The remote visualization id was not specified"};if(this.user&&a.size&&this.user.get("remaining_byte_quota")*e.fileTimesBigger<a.size)return{msg:"Unfortunately the size of the remote dataset is bigger than your remaining quota",error_code:8001}}if("url"===a.type&&!f.isURL(a.value))return{msg:"Unfortunately the URL provided is not valid"};if("sql"===a.type&&!a.value)return{msg:"Query is not provided"};if("duplication"===a.type&&!a.value)return{msg:"Dataset copy is not defined"};if("service"===a.type&&"twitter_search"===a.service_name){var d=a.service_item_id;if(!d||h.isEmpty(d))return{msg:"Twitter data is empty"};if(h.isEmpty(d.categories))return{msg:"Twitter categories are not valid"};var i=d.dates;if(!i||h.isEmpty(i))return{msg:"Twitter dates are empty"};var j=g(i.fromDate)<=g(new Date);if(!i.fromDate||!i.toDate||!j)return{msg:"Twitter dates are not valid"}}}},isValid:function(){return this.get("value")&&"error"!==this.get("state")},upload:function(){if("file"===this.get("type")){var a=this;this.xhr=this.save({filename:this.get("value")},{success:function(a){a.set("state","uploaded")},error:function(b,c){var d="Unfortunately there was a connection error";if(c&&429===c.status){var e=JSON.parse(c.responseText);d=e.errors.imports}a.set({state:"error",get_error_text:{title:"There was an error",what_about:d}})},complete:function(){delete a.xhr}})}},stopUpload:function(){this.xhr&&this.xhr.abort()},setGuessing:function(a){this.set({type_guessing:a,content_guessing:a})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./upload_config":14}],16:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=(a("../../../view_factory"),a("../../../dialogs/pecan/pecan_dialog_view"));b.exports=d.core.View.extend({className:"ImportItem",tagName:"li",events:{"click .js-abort":"_removeItem","click .js-show_dialog":"_showDialog","click .js-close":"_removeItem"},initialize:function(){this.user=this.options.user,this.vis=this.options.vis,this.template=d.templates.getTemplate("common/background_polling/views/analysis/background_analysis_item"),this._initBinds()},render:function(){var a=this.collection.getTotalAnalysis(),b=this.collection.getCompletedAnalysis(),c=this.collection.getSuccessfullyAnalysedColumns(),d={totalSuccess:c,totalItems:a,totalAnalyzed:b,progress:b/a*100};return this.$el.html(this.template(d)),this},_initBinds:function(){this.collection.bind("change:state",this._onChangeState,this),this.add_related_model(this.collection)},_onChangeState:function(){var a=this.collection.getTotalAnalysis(),b=this.collection.getCompletedAnalysis(),c=this.collection.getSuccessfullyAnalysedColumns();this.render(),b===a&&0===c&&this._removeItem()},_showDialog:function(){var a=new e({clean_on_hide:!0,vis:this.vis,collection:this.collection,user:this.user});a.appendToBody()},_skip:function(){var a,b=this.vis.get("active_layer_id"),c=this.vis.map.layers.where({id:b});c&&(a=c[0].table.get("name"));var d="pecan_"+this.user.get("username")+"_"+a;localStorage[d]=!0},_removeItem:function(){this.trigger("remove",this.collection,this),this._skip(),this.clean()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../dialogs/pecan/pecan_dialog_view":185,"../../../view_factory":209}],17:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({tagName:"h3",className:"CDB-Text CDB-Size-large u-lSpace--xl",initialize:function(){this.template=c.templates.getTemplate("common/background_polling/views/background_polling_header_title"),this._initBinds()},render:function(){return this.$el.html(this.template({imports:this.model.getTotalImports(),geocodings:this.model.getTotalGeocodings(),analysis:this.model.getTotalAnalysis(),totalPollings:this.model.getTotalPollings()})),this},_initBinds:function(){this.model.bind("change analysisAdded analysisRemoved importAdded importRemoved geocodingAdded geocodingRemoved",this.render,this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});
},{}],18:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./background_polling_header_title_view");b.exports=d.core.View.extend({className:"BackgroundPolling-header",initialize:function(){this.template=d.templates.getTemplate("common/background_polling/views/background_polling_header"),this._initBinds()},render:function(){return this.$el.html(this.template()),this._initViews(),this._updateBadges(),this},_initBinds:function(){this.model.bind("change importAdded importRemoved geocodingAdded geocodingRemoved",this._updateBadges,this)},_initViews:function(){var a=new e({model:this.model});this.$el.append(a.render().el),this.addView(a)},_updateBadges:function(){var a=this.model.getTotalFailedItems();if(0===this.$(".BackgroundPolling-headerBadgeCount").length&&a>0){var b=$("<span>").addClass("BackgroundPolling-headerBadgeCount Badge Badge--negative CDB-Text CDB-Size-small").text(a);this.$(".BackgroundPolling-headerBadge").append(b).addClass("has-failures")}else this.$(".BackgroundPolling-headerBadgeCount").length>0&&a>0?this.$(".BackgroundPolling-headerBadgeCount").text(a):0===a&&(this.$(".BackgroundPolling-headerBadgeCount").remove(),this.$(".BackgroundPolling-headerBadge").removeClass("has-failures"));var c=this.model.getTotalGeocodings(),d=c>0&&c===this.model.getTotalPollings();this.$(".js-icon").toggleClass("CDB-IconFont-marker",d),this.$(".js-icon").toggleClass("CDB-IconFont-cloud",!d)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./background_polling_header_title_view":17}],19:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,g=a("../../../view_helpers/pluralize_string"),h=a("./geocoding_result_details_view");b.exports=d.core.View.extend({className:"ImportItem",tagName:"li",events:{"click .js-abort":"_cancelGeocoding","click .js-info":"_showDetails","click .js-close":"_removeGeocoding"},initialize:function(){this.user=this.options.user,this.template=d.templates.getTemplate("common/background_polling/views/geocodings/background_geocoding_item"),this._initBinds()},render:function(){var a=this.model.get("processed_rows")||0,b=this.model.get("processable_rows")||0,c=this.model.get("real_rows")||0,d=this.model.get("latitude_column")&&this.model.get("longitude_column"),h={realRows:c,tableName:this.model.get("table_name"),canCancel:e.isFunction(this.model.cancelGeocoding),hasFailed:this.model.hasFailed(),hasCompleted:this.model.hasCompleted(),processedRows:a,processableRows:b,processableRowsFormatted:f.formatNumber(b),realRowsPluralize:g("row","rows",this.model.get("real_rows")),realRowsFormatted:f.formatNumber(c),processableRowsPluralize:g("row","rows",b),width:c>0?b/c:100,isLatLngType:d};return this.$el.html(this.template(h)),this},_initBinds:function(){this.model.bind("change",this.render,this),this.model.bind("remove",this.clean,this)},_cancelGeocoding:function(){this.model.cancelGeocoding()},_removeGeocoding:function(){this.trigger("remove",this.model,this),this.clean()},_showDetails:function(){new h({clean_on_hide:!0,user:this.user,model:this.model,showGeocodingDatasetURLButton:this.options.showGeocodingDatasetURLButton}).appendToBody()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_helpers/pluralize_string":211,"./geocoding_result_details_view":20}],20:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../../views/base_dialog/view"),f=a("../../../view_helpers/pluralize_string"),g="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null;b.exports=e.extend({className:"Dialog BackgroundPollingDetails is-opening",initialize:function(){this.elder("initialize"),this.user=this.options.user},render_content:function(){var a,b=this.model.get("error")||{},c=this.model.get("processed_rows")||0,e=this.model.get("processable_rows")||0,h=this.model.get("real_rows")||0,i=this.model.get("geometry_type")||"point",j=this.model.get("price"),k=void 0!==j&&null!==j,l=this.user.featureEnabled("google_maps");if(this.user&&this.model.get("table_name")){var m=new d.admin.Visualization({type:"table",table:{name:this.model.get("table_name")}});m.permission.owner=this.user,a=encodeURI(m.viewUrl(this.user).edit())}var n="common/background_polling/views/geocodings/";return n+=this.model.hasCompleted()?0===h?"geocoding_no_result_details":"geocoding_success_details":"geocoding_error_details",d.templates.getTemplate(n)({id:this.model.get("id"),geometryTypePluralize:f(i,i+"s",e),geometryType:i,remainingQuotaFormatted:g.formatNumber(this.model.get("remaining_quota")),googleUser:l,tableName:this.model.get("table_name"),state:this.model.get("state")||"",blockPrice:this.user.get("geocoding").block_price,realRows:h,realRowsFormatted:g.formatNumber(h),processedRows:c,processableRows:e,processableRowsFormatted:g.formatNumber(e),hasPrice:k,price:j,customHosted:d.config.get("cartodb_com_hosted"),errorDescription:b.description,showGeocodingDatasetURLButton:this.options.showGeocodingDatasetURLButton&&a,datasetURL:a})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_helpers/pluralize_string":211,"../../../views/base_dialog/view":213}],21:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../models/upload_config"),f=a("../../../views/error_details_view"),g=a("../../../views/warnings_details_view"),h=a("../../../view_factory"),i=a("./twitter_import_details_view");b.exports=d.core.View.extend({className:"ImportItem",tagName:"li",events:{"click .js-abort":"_removeItem","click .js-show_error":"_showImportError","click .js-show_warnings":"_showImportWarnings","click .js-show_stats":"_showImportStats","click .js-close":"_removeItem"},initialize:function(){this.user=this.options.user,this._showSuccessDetailsButton=this.options.showSuccessDetailsButton,this.template=d.templates.getTemplate("common/background_polling/views/imports/background_import_item"),this._initBinds()},render:function(){var a=this.model.get("upload"),b=this.model.get("import"),c={name:"",state:this.model.get("state"),progress:"",service:"",step:this.model.get("step"),url:"",failed:this.model.hasFailed(),completed:this.model.hasCompleted(),warnings:this.model.getWarnings(),showSuccessDetailsButton:this._showSuccessDetailsButton,tables_created_count:b.tables_created_count};if("complete"===c.state){var d=this.model.importedVis();d&&(c.url=encodeURI(d.viewUrl(this.user).edit()))}return a.type?("file"===a.type&&(a.value.length>1?c.name=a.value.length+" files":c.name=a.value.name),"url"!==a.type&&"remote"!==a.type||(c.name=a.value),"service"===a.type&&(c.name=a.value&&a.value.filename||""),"twitter_search"===a.service_name&&(c.name="Twitter import"),"sql"===a.type&&(c.name="SQL"),"duplication"===a.type&&(c.name=a.table_name||a.value)):c.name=b.display_name||b.item_queue_id||"import",c.service=a.service_name,"upload"===this.model.get("step")?c.progress=this.model.get("upload").progress:c.progress=e.uploadStates.indexOf(c.state)/e.uploadStates.length*100,this.$el.html(this.template(c)),this},_initBinds:function(){this.model.bind("change",this.render,this),this.model.bind("remove",this.clean,this)},_removeItem:function(){this.trigger("remove",this.model,this),this.model.pause(),this.clean()},_showImportStats:function(){new i({clean_on_hide:!0,user:this.user,model:this.model}).appendToBody()},_showImportError:function(){var a=h.createDialogByView(new f({err:this.model.getError(),user:this.user}));a.appendToBody()},_showImportWarnings:function(){var a=h.createDialogByView(new g({warnings:this.model.getWarnings(),user:this.user}));a.appendToBody()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_factory":209,"../../../views/error_details_view":215,"../../../views/warnings_details_view":221,"../../models/upload_config":14,"./twitter_import_details_view":23}],22:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"ImportItem ImportItem--sticky",tagName:"li",initialize:function(){this.user=this.options.user,this.template=c.templates.getTemplate("common/background_polling/views/imports/background_import_limit")},render:function(){var a=this.user.getMaxConcurrentImports(),b=!c.config.get("cartodb_com_hosted")&&1===a;return this.$el.html(this.template({upgradeUrl:window.upgrade_url,isUpgradeable:b,importQuota:a})),this}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],23:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../../views/base_dialog/view"),f="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null;b.exports=e.extend({className:"Dialog TwitterImportDetails is-opening",initialize:function(){this.elder("initialize"),this.user=this.options.user,this.template=d.templates.getTemplate("common/background_polling/views/imports/twitter_import_details")},render_content:function(){var a=this.model.get("import"),b=this.user.get("twitter"),c=b.quota-b.monthly_use,d=this.model.importedVis(),e=d&&encodeURI(d.viewUrl(this.user).edit())||"",g={type:d&&"table"===d.get("type")?"dataset":"map",mapURL:e,datasetTotalRows:a.tweets_georeferenced,datasetTotalRowsFormatted:f.formatNumber(a.tweets_georeferenced),tweetsCost:a.tweets_cost,tweetsCostFormatted:f.formatNumber(a.tweets_cost),availableTweets:c,availableTweetsFormatted:f.formatNumber(c),tweetsOverquota:a.tweets_overquota,tweetsOverquotaFormatted:f.formatNumber(a.tweets_overquota),blockSizeFormatted:f.formatNumber(b.block_size),blockPriceFormatted:f.formatNumber(b.block_price)};return this.template(g)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../views/base_dialog/view":213}],24:[function(a,b,c){(function(c){var d=a("queue-async"),e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;b.exports=function(a){var b=d(a.howManyInParallel);e.each(a.items,function(c){b.defer(function(b){a.processItem(c,b)})}),b.awaitAll(function(b){b?a.fail(b):a.done()})}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"queue-async":235}],25:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f=a("./xyz/xyz_model.js"),g=a("./wms/wms_model.js"),h=a("./nasa/nasa_model.js"),i=a("./mapbox/mapbox_model.js"),j=a("./tile_json/tile_json_view_model.js");b.exports=d.core.Model.extend({defaults:{map:void 0,baseLayers:void 0,tabs:void 0,currentView:"tabs",currentTab:"xyz"},initialize:function(a){if(this.elder("initialize"),!a.map)throw new Error("map is required");if(!a.baseLayers)throw new Error("baseLayers is required");this._initTabs(),this._initBinds()},activeTabModel:function(){return this.get("tabs").where({name:this.get("currentTab")})[0]},canSaveBasemap:function(){return"tabs"===this.get("currentView")&&this._layerToSave()},saveBasemap:function(){if(this.canSaveBasemap()){this.set("currentView","saving");var a=this._layerToSave();if(this.activeTabModel().hasAlreadyAddedLayer(this.get("baseLayers")))this._onLayerSaved(a);else{this.get("baseLayers").add(a);var b=this;a.save().done(function(){b._onLayerSaved(a)}).fail(function(){b.get("baseLayers").remove(a),b.set("currentView","saveFail")})}}},_onLayerSaved:function(a){var b=this.get("map"),c=a.clone();c.unset("id"),b.changeProvider("leaflet",c);var d=a.get("bounding_boxes");d&&4===d.length&&b.setBounds([[d[1],d[0]],[d[3],d[2]]]),this.set("currentView","saveDone")},_initTabs:function(){var a=new e.Collection([new f,new g({baseLayers:this.get("baseLayers")}),new h,new i,new j]);this.set({tabs:a,currentTab:a.first().get("name")})},_initBinds:function(){this.get("tabs").each(function(a){a.bind("saveBasemap",this.saveBasemap,this)},this)},_layerToSave:function(){return this.activeTabModel().get("layer")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./mapbox/mapbox_model.js":27,"./nasa/nasa_model.js":30,"./tile_json/tile_json_view_model.js":34,"./wms/wms_model.js":39,"./xyz/xyz_model.js":41}],26:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=("undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,"undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null),f=a("../../views/base_dialog/view.js"),g=a("../../view_helpers/random_quote.js"),h=a("../../view_factory.js"),i=a("./add_custom_basemap_model.js"),j=a("./tabs_view.js");b.exports=f.extend({initialize:function(){this.elder("initialize"),this.model=new i({map:this.options.map,baseLayers:this.options.baseLayers}),this._initViews(),this._initBinds()},render:function(){return f.prototype.render.apply(this,arguments),this.$(".content").addClass("Dialog-contentWrapper"),this},render_content:function(){var a=this._panes.active(this.model.get("currentView")).render();a.$el.addClass("Dialog-body Dialog-body--expanded Dialog-body--create"),a.delegateEvents();var b=e(d.templates.getTemplate("common/dialogs/add_custom_basemap/add_custom_basemap")({model:this.model}));return b.append(a.el),b},ok:function(){this.model.canSaveBasemap()&&this.model.saveBasemap()},_initViews:function(){this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("tabs",new j({model:this.model})),this._panes.addTab("saving",h.createByTemplate("common/templates/loading",{title:"Setting basemap…",quote:g()}).render()),this._panes.addTab("saveFail",h.createByTemplate("common/templates/fail",{msg:""}).render()),this._panes.active(this.model.get("currentView"))},_initBinds:function(){this.model.bind("change:currentView",this._onCurrentViewChange,this)},_onCurrentViewChange:function(){"saveDone"===this.model.get("currentView")?this.close():this.render()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory.js":209,"../../view_helpers/random_quote.js":212,"../../views/base_dialog/view.js":213,"./add_custom_basemap_model.js":25,"./tabs_view.js":32}],27:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./mapbox_view"),g=a("./mapbox_to_tile_layer_factory");b.exports=d.core.Model.extend({defaults:{name:"mapbox",label:"Mapbox",currentView:"enterURL",lastErrorMsg:"",layer:void 0},createView:function(){return this.set({currentView:"enterURL",layer:void 0}),new f({model:this})},hasAlreadyAddedLayer:function(a){var b=this.get("layer").get("urlTemplate");return e.any(a.custom(),function(a){return a.get("urlTemplate")===b})},save:function(a,b){this.set({currentView:"validatingInputs",url:a,accessToken:b});var c=this,d=new g({url:a,accessToken:b});d.createTileLayer({success:function(a){c.set("layer",a),c.trigger("saveBasemap")},error:function(a){c.set({currentView:"enterURL",lastErrorMsg:a})}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./mapbox_to_tile_layer_factory":28,"./mapbox_view":29}],28:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=e.core.Model.extend({defaults:{url:"",accessToken:""},_MAPBOX:{version:4,https:"https://dnv9my2eseobd.cloudfront.net",base:"https://a.tiles.mapbox.com/"},createTileLayer:function(a){var b,d=this.get("url"),e=this._lowerXYZ(d),f=this.get("accessToken"),g="json",h=["a","b","c"];e.indexOf("{x}")<0&&e.indexOf("tiles.mapbox.com")!==-1?(b=this._getMapBoxMapID(e),b&&(g="mapbox_id",e=b)):e.indexOf("{x}")!==-1?(g="xyz",e=e.replace(/\{s\}/g,function(){return h[Math.floor(3*Math.random())]}).replace(/\{x\}/g,"0").replace(/\{y\}/g,"0").replace(/\{z\}/g,"0")):e&&e.indexOf("http")<0&&null!=e.match(/(.*?)\.(.*)/)&&3===e.match(/(.*?)\.(.*)/).length?(g="mapbox_id",b=d):e=this._fixHTTPS(e);var i,j=this;if("mapbox"===g)a.success(this._newTileLayer({tiles:[e]}));else if("xyz"===g)i=new Image,i.onload=function(){a.success(j._newTileLayer({tiles:[j._lowerXYZ(d)]}))},i.onerror=function(){a.error(j._errorToMsg())},i.src=e;else if("mapbox_id"===g){var k="?access_token="+f,l=this._MAPBOX.base+"v"+this._MAPBOX.version+"/"+b,m=l+"/{z}/{x}/{y}.png"+k,n=l+".json"+k,o=setTimeout(function(){a.error(j._errorToMsg())},5e3);c.ajax({url:n,success:function(b){clearTimeout(o),a.success(j._newTileLayer({tiles:[m],attribution:b.attribution,minzoom:b.minzoom,maxzoom:b.maxzoom,name:b.name}))},error:function(b){clearTimeout(o),a.error(j._errorToMsg(b))}})}else a.error(this._errorToMsg())},_newTileLayer:function(a){return d.isArray(a)&&d.size(a)>0&&(a=d.first(a)),new e.admin.TileLayer({urlTemplate:a.tiles[0],attribution:a.attribution||null,maxZoom:a.maxzoom||21,minZoom:a.minzoom||0,name:a.name||""})},_errorToMsg:function(a){return"object"!=typeof a&&a?a:a&&a.status&&401===a.status?"Error retrieving your basemap. Please, check your access token.":"This value is not valid."},_lowerXYZ:function(a){return a.replace(/\{S\}/g,"{s}").replace(/\{X\}/g,"{x}").replace(/\{Y\}/g,"{y}").replace(/\{Z\}/g,"{z}")},_getMapBoxMapID:function(a){var b=/https?:\/\/[a-z]?\.?tiles\.mapbox.com\/v(\d)\/([^\/.]*)\.([^\/.]*)/,c=/https?:\/\/tiles\.mapbox\.com\/(.*?)\/edit\/(.*?)(\?|#)/,d="";return d=a.match(b),d&&d[1]&&d[2]?d[2]+"."+d[3]:(d=a.match(c),d&&d[1]&&d[2]?d[1]+"."+d[2]:void 0)},_fixHTTPS:function(a,b){if(b=b||location,0!==a.indexOf("https")&&"https:"===b.protocol){var c=a.indexOf("mapbox.com");return c!==-1?this._MAPBOX.https+a.substr(c+"mapbox.com".length):a.replace(/http/,"https")}return a}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],29:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../../view_factory.js"),f=a("../../../view_helpers/random_quote.js");b.exports=d.core.View.extend({events:{"click .js-ok":"_onClickOK",keydown:"_onKeyDown",keyup:"_onKeyUp"},initialize:function(){this.elder("initialize"),this._initBinds()},render:function(){this.clearSubViews();var a;switch(this.model.get("currentView")){case"validatingInputs":a=e.createByTemplate("common/templates/loading",{title:"Validating…",quote:f()});break;case"enterURL":default:a=e.createByTemplate("common/dialogs/add_custom_basemap/mapbox/enter_url",{url:this.model.get("url"),accessToken:this.model.get("accessToken"),lastErrorMsg:this.model.get("lastErrorMsg")})}return this.addView(a),this.$el.append(a.render().el),this},_initBinds:function(){this.model.bind("change",this.render,this)},_hasValues:function(){return this._urlVal()&&this._accessToken()},_urlVal:function(){return this.$(".js-url").val()},_accessToken:function(){return this.$(".js-access-token").val()},_onClickOK:function(a){if(this.killEvent(a),this._hasValues()){var b=this._urlVal(),c=this._accessToken();this.model.save(b,c)}},_onKeyDown:function(a){a.stopPropagation(),this.$(".js-error").removeClass("is-visible")},_onKeyUp:function(a){a.stopPropagation(),this.$(".js-ok").toggleClass("is-disabled",!this._hasValues())}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_factory.js":209,"../../../view_helpers/random_quote.js":212}],30:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./nasa_view"),g="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null,h={day:{url:"http://map1.vis.earthdata.nasa.gov/wmts-webmerc/MODIS_Terra_CorrectedReflectance_TrueColor/default/<%- date %>/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpeg",limit:"2012-05-01",default:"2012-05-01",attribution:'<a href="http://earthdata.nasa.gov/gibs" target="_blank">NASA EOSDIS GIBS</a>',name:"NASA Terra",maxZoom:9,minZoom:1},night:{url:"http://map1.vis.earthdata.nasa.gov/wmts-webmerc/VIIRS_CityLights_2012/default/<%- date %>/GoogleMapsCompatible_Level8/{z}/{y}/{x}.jpeg",limit:"2012-05-01",default:"2012-05-02",attribution:'<a href="http://earthdata.nasa.gov/gibs" target="_blank">NASA EOSDIS GIBS</a>',name:"NASA Earth at night",maxZoom:8,minZoom:1}};b.exports=d.core.Model.extend({defaults:{name:"nasa",label:"NASA",layer:void 0,layerType:"day",date:void 0,current:void 0,format:"Y-m-d"},initialize:function(){this.elder("initialize"),this._initBinds()},createView:function(){var a=(new Date).getTimezoneOffset(),b=g(new Date).utcOffset(a).format("YYYY-MM-DD"),c=g(new Date).utcOffset(a).subtract(1,"days").format("YYYY-MM-DD");return this.set({current:b,date:c}),new f({model:this})},hasAlreadyAddedLayer:function(a){var b=this.get("layer").get("urlTemplate");return e.any(a.custom(),function(a){return a.get("urlTemplate")===b})},_initBinds:function(){this.bind("change:date change:layerType",this._onChange,this)},_onChange:function(){var a=this.get("date"),b=this.get("layerType");this.set("layer",new d.admin.TileLayer({urlTemplate:e.template(h[b].url)({date:a}),attribution:h[b].attribution,maxZoom:h[b].maxZoom,minZoom:h[b].minZoom,name:h[b].name+" "+a}))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./nasa_view":31}],31:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null,f=a("../../../edit_fields/date_field/date_field_view"),g=a("../../../edit_fields/edit_field_model");b.exports=d.core.View.extend({options:{dateFormat:"YYYY-MM-DD"},events:{"click .js-day":"_onChangeToDay","click .js-night":"_onChangeToNight"},initialize:function(){this.elder("initialize"),this.dateModel=new g({value:this.model.get("date"),type:"date"}),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(d.templates.getTemplate("common/dialogs/add_custom_basemap/nasa/nasa")({layerType:this.model.get("layerType"),initialDateStr:e(this.dateModel.get("value")).format(this.options.dateFormat)})),this._renderDatePicker(),this},_initBinds:function(){this.model.bind("change:layerType",function(){this.dateModel.set("readOnly","night"===this.model.get("layerType")),this.render()},this),this.dateModel.bind("change:value",function(){var a=e(this.dateModel.get("value")).format(this.options.dateFormat);this.model.set("date",a)},this),this.add_related_model(this.dateModel)},_renderDatePicker:function(){var a=new f({model:this.dateModel,showTime:!1,showGMT:!1});this.addView(a),this._$datePicker().append(a.render().el),this.dateModel.get("readOnly")&&this.addView(new d.common.TipsyTooltip({el:this._$datePicker(),title:function(a){return $(this).attr("data-title")}}))},_onChangeToNight:function(a){this.model.set("layerType","night")},_onChangeToDay:function(){this.model.set("layerType","day")},_$datePicker:function(){return this.$(".js-datePicker")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../edit_fields/date_field/date_field_view":195,"../../../edit_fields/edit_field_model":199}],32:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null;b.exports=c.core.View.extend({events:{"click .js-tabs button":"_onClickTab"},initialize:function(){this.elder("initialize"),this._initBinds()},render:function(){var a=d(c.templates.getTemplate("common/dialogs/add_custom_basemap/tabs")({model:this.model}));return a.find(".js-tab-content").append(this._createTabContentView().el),this.$el.html(a),this},_initBinds:function(){this.model.bind("change:currentTab",this.render,this)},_createTabContentView:function(){return this._currentTabView&&this._currentTabView.clean(),this._currentTabView=this.model.activeTabModel().createView(),this.addView(this._currentTabView),this._currentTabView.render()},_onClickTab:function(a){this.killEvent(a);var b=d(a.target).closest("button").data("name");b?this.model.set("currentTab",b):c.log.error("tab name was expected but was empty")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],33:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.core.View.extend({events:{"keydown .js-url":"_update","paste .js-url":"_update"},initialize:function(){this.elder("initialize"),this._lastURL=""},render:function(){return this.$el.html(c.templates.getTemplate("common/dialogs/add_custom_basemap/tile_json/tile_json")({})),this},_update:function(a){a.stopPropagation(),this._debouncedUpdate()},_debouncedUpdate:d.debounce(function(){this._disableOkBtn(!0),this._indicateIsValidating(!0);var a=this._urlWithHTTP();if(a===this._lastURL)return this._indicateIsValidating(!1),void this._updateError();this._lastURL=a,this._indicateIsValidating(!0);var b=new c.admin.TileJSON({url:a}),d=this;b.fetch({success:function(){a===d._lastURL&&(d.model.set("layer",b.newTileLayer()),d._disableOkBtn(!1),d._indicateIsValidating(!1),d._updateError())},error:function(){a===d._lastURL&&(d._indicateIsValidating(!1),d._updateError("Invalid URL, please make sure it is correct"))}})},150),_disableOkBtn:function(a){this.$(".ok")[a?"addClass":"removeClass"]("is-disabled")},_updateError:function(a){this.$(".js-error").text(a)[a?"addClass":"removeClass"]("is-visible")},_indicateIsValidating:function(a){a?(this.$(".js-idle").hide(),this.$(".js-validating").show()):(this.$(".js-validating").hide(),this.$(".js-idle").show())},_urlWithHTTP:function(){var a=this.$(".js-url").val();return a.indexOf("http://")===-1?"http://"+a:a}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],34:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./tile_json_view");b.exports=d.core.Model.extend({defaults:{name:"tile_json",label:"TileJSON",layer:void 0},createView:function(){return this.set({layer:void 0}),new f({model:this})},hasAlreadyAddedLayer:function(a){var b=this.get("layer").get("urlTemplate");return e.any(a.custom(),function(a){return a.get("urlTemplate")===b})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./tile_json_view":33}],35:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.core.Model.extend({defaults:{state:"idle",layer:void 0},canSave:function(a){return!d.any(a.custom(),function(a){return a.get("name")===this.get("title")},this)},save:function(){this.set("state","saving"),this._shouldBeProxied()?this._createProxiedLayer():this._newTileLayer()},_shouldBeProxied:function(){if("wmts"===this.get("type")){var a=c.admin.WMSService.supportedMatrixSets(this.get("matrix_sets")||[]);return a.length>0}return!0},_createProxiedLayer:function(){var a=this,b=new c.admin.WMSService({wms_url:this.url(),title:this.get("title"),name:this.get("name"),layer:this.get("name"),srs:this.get("srs"),bounding_boxes:this.get("llbbox"),type:this.get("type"),matrix_sets:this.get("matrix_sets")});c.god.trigger("metrics","select_wms",{email:window.user_data.email});var a=this;return b.save({},{success:function(b){var c;try{c=b.newTileLayer()}catch(a){}c?a._setNewTileLayer(c):a.set("state","saveFail")},error:function(){a.set("state","saveFail")}}),b},_setNewTileLayer:function(a){this.set({state:"saveDone",tileLayer:a})},_newTileLayer:function(){var a=c.admin.TileLayer.byCustomURL(this._xyzURLTemplate(),!1);return a.set({name:this.get("title")||this.get("name"),attribution:this.get("attribution"),bounding_boxes:this.get("llbbox")}),this._setNewTileLayer(a),a},_xyzURLTemplate:function(){var a=this.get("url_template")||"";return a.replace(/%%\((\w)\)s/g,"{$1}")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],36:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({tagName:"li",className:"List-row",events:{"click .js-add":"_onClickAdd"},render:function(){return this.$el.html(c.templates.getTemplate("common/dialogs/add_custom_basemap/wms/layer")({model:this.model,canSave:this.model.canSave(this.options.baseLayers)})),this},_onClickAdd:function(a){this.killEvent(a),this.model.canSave(this.options.baseLayers)&&this.model.save()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],37:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,e=a("./layer_model.js");b.exports=d.Collection.extend({model:e,fetch:function(a,b){this.url=a;var c=new cdb.admin.WMSService({wms_url:a}),d=this;c.fetch().always(function(){d.reset(c.get("layers")),d.each(function(a){a.set("type",c.get("type"))}),b()})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./layer_model.js":35}],38:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f=a("../../../view_helpers/pluralize_string"),g=a("./layer_view.js");b.exports=d.core.View.extend({events:{"click .js-back":"_onClickBack"},render:function(){this.clearSubViews();var a=e(d.templates.getTemplate("common/dialogs/add_custom_basemap/wms/select_layer")({searchQuery:this.model.get("searchQuery"),layersFound:this.model.getLayers(),layersAvailableCount:this.model.layersAvailableCount(),pluralizeStr:f})),b=a.find(".js-layers");return b.append.apply(b,this._renderedLayers()),this.$el.html(a),this},_renderedLayers:function(){return this.model.getLayers().map(function(a){var b=new g({model:a,baseLayers:this.model.get("baseLayers")});return this.addView(b),b.render().el},this)},_onClickBack:function(a){this.killEvent(a),this.model.set("currentView","enterURL")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_helpers/pluralize_string":211,"./layer_view.js":36}],39:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./wms_view.js"),g=a("./layers_collection.js");b.exports=d.core.Model.extend({defaults:{name:"wms",label:"WMS/WMTS",currentView:"enterURL",layersFetched:!1,layers:void 0,baseLayers:void 0},initialize:function(){this.elder("initialize"),this.set("layers",new g),
this._initBinds()},createView:function(){return this.set({currentView:"enterURL",layersFetched:!1}),new f({model:this})},fetchLayers:function(a){this.set("currentView","fetchingLayers");var b=this;this.get("layers").fetch(a,function(){b.set({currentView:b.get("layers").length>0?"selectLayer":"enterURL",layersFetched:!0})})},layersAvailableCount:function(){return e.difference(this.get("layers").pluck("title"),this.get("baseLayers").pluck("name")).length},get:function(a){return"layer"===a?this.get("layers").find(function(a){return"saveDone"===a.get("state")}).get("tileLayer"):d.core.Model.prototype.get.apply(this,arguments)},getLayers:function(){if(this.get("searchQuery")){var a=new RegExp(this.get("searchQuery"),"i");return this.get("layers").filter(function(b){return b.get("name").match(a)},this)}return this.get("layers")},hasAlreadyAddedLayer:function(){return!1},_initBinds:function(){this.get("layers").bind("change:state",this._onLayerStateChange,this)},_onLayerStateChange:function(a,b){switch(b){case"saving":this.set("currentView","savingLayer");break;case"saveDone":this.trigger("saveBasemap");break;case"saveFail":this.set("currentView","saveFail");break;default:this.set("currentView","selectLayer")}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./layers_collection.js":37,"./wms_view.js":40}],40:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("../../../view_helpers/random_quote.js"),g=a("./select_layer_view.js"),h=a("../../../view_factory.js");b.exports=d.core.View.extend({events:{"keydown .js-search-input":"_onKeyDown","submit .js-search-form":"killEvent","keydown .js-url":"_update","paste .js-url":"_update","click .js-fetch-layers":"_onClickFetchLayers","click .js-clean-search":"_onCleanSearchClick","click .js-search-link":"_submitSearch"},initialize:function(){this.elder("initialize"),this._initBinds()},render:function(){this.clearSubViews();var a;switch(this.model.get("currentView")){case"savingLayer":a=h.createByTemplate("common/templates/loading",{title:"Saving layer…",quote:f()});break;case"selectLayer":a=new g({model:this.model});break;case"saveFail":a=h.createByTemplate("common/templates/fail",{msg:""});break;case"fetchingLayers":a=h.createByTemplate("common/templates/loading",{title:"Fetching layers…",quote:f()});break;case"enterURL":default:a=h.createByTemplate("common/dialogs/add_custom_basemap/wms/enter_url",{layersFetched:this.model.get("layersFetched"),layers:this.model.get("layers")})}return this.addView(a),this.$el.append(a.render().el),this.$(".js-search-input").focus(),this},_showCleanSearchButton:function(){this.$(".js-clean-search").show()},_hideCleanSearchButton:function(){this.$(".js-clean-search").hide()},_initBinds:function(){this.model.bind("change",this.render,this),this.model.bind("change",this._onChangeSearchQuery,this),this.model.get("layers").bind("reset",this.render,this)},_update:function(a){a.stopPropagation(),this._debouncedUpdate()},_debouncedUpdate:e.debounce(function(){this._enableFetchLayersButton(!!this.$(".js-url").val()),this.$(".js-error").removeClass("is-visible")},100),_enableFetchLayersButton:function(a){this.$(".js-fetch-layers")[a?"removeClass":"addClass"]("is-disabled")},_onKeyDown:function(a){var b=a.keyCode==$.ui.keyCode.ENTER;b&&(this.killEvent(a),this._submitSearch())},_submitSearch:function(a){this.killEvent(a),this.model.set("searchQuery",this.$(".js-search-input").val())},_onChangeSearchQuery:function(){var a=this.model.get("searchQuery");a||this._hideCleanSearchButton()},_onCleanSearchClick:function(a){this.killEvent(a),this.model.set("searchQuery","")},_onClickFetchLayers:function(a){this.killEvent(a);var b=this.$(".js-url").val();b&&this.model.fetchLayers(b)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_factory.js":209,"../../../view_helpers/random_quote.js":212,"./select_layer_view.js":38}],41:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./xyz_view");b.exports=d.core.Model.extend({defaults:{name:"xyz",label:"XYZ",tms:!1,layer:void 0},createView:function(){return new f({model:this})},hasAlreadyAddedLayer:function(a){var b=this.get("layer").get("urlTemplate");return e.any(a.custom(),function(a){return a.get("urlTemplate")===b})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./xyz_view":42}],42:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.core.View.extend({className:"XYZPanel",events:{"click .js-tms":"_changeTMS","keydown .js-url":"_update","paste .js-url":"_update"},initialize:function(){this.elder("initialize"),this._lastCallSeq=0,this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(c.templates.getTemplate("common/dialogs/add_custom_basemap/xyz/xyz")({})),this._initViews(),this},_initViews:function(){var a=new c.common.TipsyTooltip({el:this.$(".js-tms"),title:function(){return $(this).data("title")}});this.addView(a)},_initBinds:function(){this.model.bind("change:tms",this._setTMSCheckbox,this)},_update:function(a){a.stopPropagation(),this._debouncedUpdate()},_changeTMS:function(a){this.model.set("tms",!this.model.get("tms")),this._update(a)},_setTMSCheckbox:function(a){this.$(".js-tms .Checkbox-input")[this.model.get("tms")?"addClass":"removeClass"]("is-checked")},_debouncedUpdate:d.debounce(function(){this._disableOkBtn(!0),this._indicateIsValidating(!0);var a,b,d=this.$(".js-url").val(),e=this.model.get("tms");if(d)try{a=c.admin.TileLayer.byCustomURL(d,e)}catch(a){b="It does not look like a valid XYZ URL"}if(this.model.set("layer",a),a){var f=this,g=++this._lastCallSeq;a.validateTemplateURL({success:function(){g===f._lastCallSeq&&(f._disableOkBtn(!1),f._indicateIsValidating(!1),f._updateError())},error:function(){g===f._lastCallSeq&&(f._disableOkBtn(!1),f._indicateIsValidating(!1),f._updateError("We couldn't validate this, if you're sure it contains data click \"add basemap\""))}})}else d?(this._indicateIsValidating(!1),this._updateError(b)):(this._indicateIsValidating(!1),this._updateError())},150),_setTMS:function(a){var b=$(a.target).closest(".Checkbox");b.find(".Checkbox-input").toggleClass("is-checked"),this._update(a)},_disableOkBtn:function(a){this.$(".ok")[a?"addClass":"removeClass"]("is-disabled")},_updateError:function(a){this.$(".js-error").text(a)[a?"addClass":"removeClass"]("is-visible")},_indicateIsValidating:function(a){a?this.$(".js-validating").show():this.$(".js-validating").hide()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],43:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;b.exports=e.extend({events:function(){return f.extend({},e.prototype.events,{"click .js-ok":"_continue"})},initialize:function(){this.elder("initialize"),this.template=d.templates.getTemplate("common/dialogs/builder_features_warning/template")},render_content:function(){return this.template({})},_continue:function(){this.close()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../views/base_dialog/view":213}],44:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("../../views/base_dialog/view"),g=a("../../view_helpers/pluralize_string"),h=a("../../view_helpers/random_quote");b.exports=f.extend({events:function(){return e.extend({},f.prototype.events,{"click .js-ok":"_ok"})},initialize:function(){this.elder("initialize"),this.options.template=this.options.template||d.templates.getTemplate("common/dialogs/change_lock/templates/dashboard"),this.model.bind("change",function(){"ProcessItemsDone"===this.model.get("state")?this.close():this.render()},this)},render_content:function(){return this["_render"+this.model.get("state")]()},_renderConfirmChangeLock:function(){var a=this.model.get("items").length,b=this.model.get("initialLockValue");return this.options.template({model:this.model,itemsCount:a,ownerName:this.options.ownerName,isOwner:this.options.isOwner,thisOrTheseStr:1===a?"this":"these",itOrThemStr:1===a?"it":"them",areLocked:b,positiveOrNegativeStr:b?"positive":"alert",lockOrUnlockStr:b?"unlock":"lock",contentTypePluralized:g("datasets"===this.model.get("contentType")?"dataset":"map",this.model.get("contentType"),a)})},_ok:function(a){this.killEvent(a),this.model.inverseLock(),this.render()},_renderProcessingItems:function(){var a=this.model.get("initialLockValue")?"Unlocking":"Locking";return d.templates.getTemplate("common/templates/loading")({title:a+" "+g("datasets"===this.model.get("contentType")?"dataset":"map",this.model.get("items").length)+"…",quote:h()})},_renderProcessItemsFail:function(){var a=this.model.get("initialLockValue")?"unlock":"lock";return d.templates.getTemplate("common/templates/fail")({msg:"Failed to "+a+" all items"})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_helpers/pluralize_string":211,"../../view_helpers/random_quote":212,"../../views/base_dialog/view":213}],45:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f=a("../../batch_process_items");b.exports=d.core.Model.extend({defaults:{state:"ConfirmChangeLock",initialLockValue:!1,contentType:"datasets",items:void 0},initialize:function(a){if(this.elder("initialize"),this.set("items",new e.Collection(a.items)),this.get("items").chain().map(function(a){return a.get("locked")}).uniq().value().length>1){var b="It is assumed that all items have the same locked state, a user should never be able to select a mixed item with current UI. If you get an error with this message something is broken";if(!window.trackJs||!window.trackJs.track)throw new Error(b);window.trackJs.track(b)}this.set("initialLockValue",this.get("items").at(0).get("locked"))},inverseLock:function(){this.set("state","ProcessingItems"),f({howManyInParallel:5,items:this.get("items").toArray(),processItem:this._lockItem.bind(this,!this.get("initialLockValue")),done:this.set.bind(this,"state","ProcessItemsDone"),fail:this.set.bind(this,"state","ProcessItemsFail")})},_lockItem:function(a,b,c){b.save({locked:a}).done(function(){c()}).fail(function(){c("something failed")})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../batch_process_items":24}],46:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./start_view"),f=a("./options_collection"),g=a("../../views/base_dialog/view"),h=a("../../view_helpers/random_quote"),i=a("../../view_factory"),j=a("./share/share_view"),k=g.extend({initialize:function(){this.elder("initialize"),this._privacyOptions=f.byVisAndUser(this.options.vis,this.options.user),this._initViews(),this._initBinds()},render_content:function(){return this._panes.getActivePane().render().el},ok:function(){var a=this._privacyOptions.selectedOption();if(a.canSave()){var b=this;this._panes.active("saving"),a.saveToVis(this.options.vis,{success:function(){b.close()},error:function(){b._panes.active("saveFail")}})}},_initViews:function(){this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("start",new e({privacyOptions:this._privacyOptions,user:this.options.user,vis:this.options.vis})),this._panes.addTab("saving",i.createByTemplate("common/templates/loading",{title:"Saving privacy…",quote:h()}).render()),this._panes.addTab("saveFail",i.createByTemplate("common/templates/fail",{msg:""}).render()),this._panes.active("start")},_initBinds:function(){this._panes.bind("tabEnabled",this.render,this),this._panes.getPane("start").bind("clickedShare",this._openShareDialog,this)},_openShareDialog:function(){var a=new j({clean_on_hide:!0,enter_to_confirm:!0,user:this.options.user,vis:this.options.vis,ChangePrivacyView:k});this.close(),a.appendToBody()}});b.exports=k}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"../../view_helpers/random_quote":212,"../../views/base_dialog/view":213,"./options_collection":48,"./share/share_view":55,"./start_view":57}],47:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.core.Model.extend({defaults:{privacy:"PUBLIC",disabled:!1,selected:!1,password:void 0},validate:function(a){if(a.disabled&&a.selected)return"Option can not be disabled and selected at the same time"},classNames:function(){return d.chain(["disabled","selected"]).map(function(a){return this.attributes[a]?"is-"+a:void 0},this).compact().value().join(" ")},canSave:function(){return!this.get("disabled")},saveToVis:function(a,b){return a.save(this._attrsToSave(),d.extend({wait:!0},b))},_attrsToSave:function(){return d.pick(this.attributes,"privacy","password")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],48:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./option_model"),g=a("./password_option_model"),h=[{privacy:"PUBLIC",illustrationType:"positive",iconFontType:"unlock",title:"Public",desc:"Everyone can view and download it",alwaysEnable:!0},{privacy:"LINK",illustrationType:"alert",iconFontType:"unlock",title:"With link",desc:"Only the people with the link can view it"},{privacy:"PASSWORD",illustrationType:"alert",iconFontType:"unlockWithEllipsis",title:"Password protected",desc:"Only the people with the password can view it"},{privacy:"PRIVATE",illustrationType:"negative",iconFontType:"lock",title:"Private",desc:"Only you can access it"}];b.exports=d.Collection.extend({model:function(a,b){return"PASSWORD"===a.privacy?new g(a,b):new f(a,b)},initialize:function(){this.bind("change:selected",this._deselectLastSelected,this)},selectedOption:function(){return this.find(function(a){return a.get("selected")})},passwordOption:function(){return this.find(function(a){return"PASSWORD"===a.get("privacy")})},_deselectLastSelected:function(a,b){b&&this.each(function(b){b!==a&&b.set({selected:!1},{silent:!0})})}},{byVisAndUser:function(a,b){var c=b.get("actions")[a.isVisualization()?"private_maps":"private_tables"],d=a.get("privacy"),f=a.privacyOptions();return new this(e.chain(h).filter(function(a){return e.contains(f,a.privacy)}).map(function(a){return e.defaults({selected:a.privacy===d,disabled:!(a.alwaysEnable||c)},a)}).value())}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./option_model":47,"./password_option_model":49}],49:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,"undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null),e=a("./option_model"),f=e.extend({initialize:function(){e.prototype.initialize.apply(this,arguments),this.set("password",f.DEFAULT_FAKE_PASSWORD)},_attrsToSave:function(){var a=e.prototype._attrsToSave.call(this);return a.password===f.DEFAULT_FAKE_PASSWORD&&delete a.password,a},canSave:function(){return e.prototype.canSave.call(this)&&!d.isEmpty(this.get("password"))}},{DEFAULT_FAKE_PASSWORD:"!@#!@#"});b.exports=f}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./option_model":47}],50:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e=("undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null),f=a("./permission_view"),g=a("./user_details_view"),h=a("./group_details_view"),i=a("../../../view_factory");b.exports=e.core.View.extend({initialize:function(){d.each(["model","collection","pagedSearchModel"],function(a){if(d.isUndefined(this.options[a]))throw new Error(a+" is required")},this),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.empty(),this.options.pagedSearchModel.get("q")||this._renderOrganizationPermissionView(),this._renderGrantablesViews(),this},_initBinds:function(){this.collection.bind("reset",this.render,this),this.add_related_model(this.collection),this.options.pagedSearchModel.on("change:q",this.render,this),this.add_related_model(this.options.pagedSearchModel)},_renderGrantablesViews:function(){var a=this.model.get("vis").tableMetadata().dependentVisualizations();this.collection.each(function(b){this._appendView(new f({model:b.entity,permission:this.model.get("permission"),isWriteAccessTogglerAvailable:this.model.isWriteAccessTogglerAvailable(),detailsView:this._createDetailsView(this._detailsViewOpts.bind(this,a,b.entity),b)}))},this)},_renderOrganizationPermissionView:function(){this._appendView(new f({model:this.model.get("organization"),permission:this.model.get("permission"),isWriteAccessTogglerAvailable:this.model.isWriteAccessTogglerAvailable(),detailsView:i.createByTemplate("common/dialogs/change_privacy/share/details",{avatarUrl:!1,willRevokeAccess:!1,title:"Default settings for your Organization",desc:"New users will have this permission",roleLabel:!1},{className:"ChangePrivacy-shareListItemInfo"})}))},_appendView:function(a){this.$el.append(a.render().el),this.addView(a)},_createDetailsView:function(a,b){var c=b.get("type");switch(c){case"user":return new g(a([b.id]));case"group":return new h(a(b.entity.users.chain().reject(this._isCurrentUser).pluck("id").value()));default:return e.log.error("No details view for grantable model of type "+c),new e.core.View(a())}},_detailsViewOpts:function(a,b,c){return{className:"ChangePrivacy-shareListItemInfo",model:b,permission:this.model.get("permission"),isUsingVis:d.any(a,function(a){return d.any(c,function(b){return b===a.permission.owner.id})})}},_isCurrentUser:function(a){return a.id===e.config.get("user").id}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_factory":209,"./group_details_view":51,"./permission_view":53,"./user_details_view":56}],51:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("../../../view_helpers/pluralize_string");b.exports=e.core.View.extend({initialize:function(){d.each(["permission","isUsingVis"],function(a){if(d.isUndefined(this.options[a]))throw new Error(a+" is required")},this)},render:function(){return this.$el.html(this.getTemplate("common/dialogs/change_privacy/share/details")({willRevokeAccess:this._willRevokeAccess(),avatarUrl:this.model.get("avatar_url"),title:this.model.get("display_name"),desc:this._desc(),roleLabel:!1})),this},_desc:function(){var a=this.model.users.length,b=f.prefixWithCount("member","members",a);return this._willRevokeAccess()?b+". "+f("Member's","Members'",a)+" maps will be affected":this.options.isUsingVis?b+". "+f("Member is","Members are",a)+" using this dataset":b},_willRevokeAccess:function(){return this.options.isUsingVis&&!this.options.permission.hasReadAccess(this.model)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_helpers/pluralize_string":211}],52:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.core.View.extend({tagName:"span",events:{"mouseover .js-toggler.is-disabled":"_onHoverDisabledToggler","mouseout .js-toggler":"_closeTooltip","mouseleave .js-toggler":"_closeTooltip","change .js-input":"_onChangeInput"},initialize:function(){c.each(["model","permission","hasAccess","canChangeAccess","toggleAccess","label"],function(a){if(c.isUndefined(this.options[a]))throw new Error(a+" is required")},this)},render:function(){return this.clearSubViews(),this.$el.html(d.templates.getTemplate("common/dialogs/change_privacy/share/permission_toggler")({cid:this.cid,hasAccess:this.options.hasAccess(),canChangeAccess:this.options.canChangeAccess(),label:this.options.label})),this},_onChangeInput:function(){this.options.toggleAccess()},_onHoverDisabledToggler:function(a){var b=this.options.permission.findRepresentableAclItem(this.model);b&&!b.isOwn(this.model)&&this._tooltipView().showTipsy()},_closeTooltip:function(){this._tooltipView().hideTipsy()},_tooltipView:function(a){return this._tooltip||(this._tooltip=this._newTooltipView(),this.addView(this._tooltip)),this._tooltip},_newTooltipView:function(a){return new d.common.TipsyTooltip({el:this.$(".js-toggler"),trigger:"manual",title:this._inheritedAccessTooltipText.bind(this)})},_inheritedAccessTooltipText:function(){var a=this.options.permission.findRepresentableAclItem(this.model),b=a.get("type");switch(b){case"group":return"Access is inherited from group "+a.get("entity").get("name");case"org":return"Access is inherited from organization";default:return d.log.error("Trying to display inherited access for an unrecognized type "+b),""}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],53:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("./permission_toggler_view"),g=a("../../../view_factory");b.exports=e.core.View.extend({className:"ChangePrivacy-shareListItem",initialize:function(){d.each(["model","permission","isWriteAccessTogglerAvailable","detailsView"],function(a){if(d.isUndefined(this.options[a]))throw new Error(a+" is required")},this),this._initBinds()},_initBinds:function(){this.options.permission.acl.bind("add remove reset change",this.render,this),this.add_related_model(this.options.permission)},render:function(){return this.clearSubViews(),this._renderDetails(),this._renderAccessTogglers(),this},_renderDetails:function(){this._renderView(this.options.detailsView)},_renderAccessTogglers:function(){var a=[this._newReadToggler()];this.options.isWriteAccessTogglerAvailable&&a.unshift(this._newWriteToggler()),this._renderView(g.createByList(a))},_newWriteToggler:function(){var a=this.options.permission;return new f({className:"ChangePrivacy-shareListItemTogglerContainer",model:this.model,permission:a,label:"Write",hasAccess:a.hasWriteAccess.bind(a,this.model),canChangeAccess:a.canChangeWriteAccess.bind(a,this.model),toggleAccess:this._toggleWrite.bind(this)})},_newReadToggler:function(){var a=this.options.permission;return new f({model:this.model,permission:a,label:"Read",hasAccess:a.hasReadAccess.bind(a,this.model),canChangeAccess:a.canChangeReadAccess.bind(a,this.model),toggleAccess:this._toggleRead.bind(this)})},_renderView:function(a){this.addView(a),this.$el.append(a.render().el)},_toggleWrite:function(){var a=this.options.permission;a.canChangeWriteAccess(this.model)&&(a.hasWriteAccess(this.model)?a.revokeWriteAccess(this.model):a.grantWriteAccess(this.model))},_toggleRead:function(){var a=this.options.permission;a.canChangeReadAccess(this.model)&&(a.hasReadAccess(this.model)?a.revokeAccess(this.model):a.grantReadAccess(this.model))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_factory":209,"./permission_toggler_view":52}],54:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;"undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.core.Model.extend({defaults:{vis:void 0,permission:void 0,organization:void 0},initialize:function(a){if(!a.vis)throw new Error("vis is required");if(!a.organization)throw new Error("organization is required");var b=this.get("vis");if(this.set("permission",b.permission.clone()),!b.isVisualization()){var c=this;b.tableMetadata().fetch({silent:!0,success:function(){c.trigger("all")}})}},name:function(){return this.get("vis").get("name")},isWriteAccessTogglerAvailable:function(){return!this.get("vis").isVisualization()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],55:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f=("undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,a("../../../views/base_dialog/view")),g=a("../../../view_helpers/random_quote"),h=a("../../../view_factory"),i=a("../../../paged_search_model"),j=a("../../../views/paged_search/paged_search_view"),k=a("./share_model"),l=a("./grantables_view");b.exports=f.extend({events:f.extendEvents({"click .js-back":"_openChangePrivacy"}),initialize:function(){if(!this.options.ChangePrivacyView)throw new Error("ChangePrivacyView is required");this.user=this.options.user,this.organization=this.user.organization,this.model=new k({vis:this.options.vis,organization:this.organization}),this.elder("initialize"),this._initViews(),this._initBinds()},render:function(){return f.prototype.render.apply(this,arguments),this.$(".content").addClass("Dialog-content--expanded"),this},render_content:function(){return[this._htmlNode(d.templates.getTemplate("common/dialogs/change_privacy/share/share_header")({name:this.options.vis.get("name")})),this._grantablesView.render().el,this._htmlNode(d.templates.getTemplate("common/dialogs/change_privacy/share/share_footer")())]},ok:function(){var a=h.createDialogByTemplate("common/templates/loading",{title:"Sharing…",quote:g()});a.appendToBody();var b=this.options.vis.permission;b.overwriteAcl(this.model.get("permission")),b.save().always(function(){a.close()}).fail(function(){var a=h.createDialogByTemplate("common/templates/fail",{msg:""});a.appendToBody()}).done(this._openChangePrivacy.bind(this))},_initViews:function(){var a=this.model,b=this.organization.grantables,c=new i({per_page:50,order:"name"});this._grantablesView=new j({isUsedInDialog:!0,pagedSearchModel:c,collection:b,createListView:function(){return new l({model:a,collection:b,pagedSearchModel:c})}})},_initBinds:function(){this.model.on("all",this._grantablesView.render,this._grantablesView)},_htmlNode:function(a){return e(a)[0]},_openChangePrivacy:function(){var a=new this.options.ChangePrivacyView({clean_on_hide:!0,enter_to_confirm:!0,vis:this.options.vis,user:this.user});a.appendToBody(),this.close()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../paged_search_model":206,"../../../view_factory":209,"../../../view_helpers/random_quote":212,"../../../views/base_dialog/view":213,"../../../views/paged_search/paged_search_view":218,"./grantables_view":50,"./share_model":54}],56:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.core.View.extend({initialize:function(){c.each(["permission","isUsingVis"],function(a){if(c.isUndefined(this.options[a]))throw new Error(a+" is required")},this)},render:function(){return this.$el.html(this.getTemplate("common/dialogs/change_privacy/share/details")({willRevokeAccess:this._willRevokeAccess(),avatarUrl:this.model.get("avatar_url"),title:this.model.get("username"),desc:this._desc(),roleLabel:this.model.get("viewer")?"Viewer":"Builder"})),this},_desc:function(){var a=this.model.get("email");return this._willRevokeAccess()?a+". User's maps will be affected":this.options.isUsingVis?a+". User is using this dataset":a},_willRevokeAccess:function(){return this.options.isUsingVis&&!this.options.permission.hasReadAccess(this.model)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],57:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,g=a("../../view_helpers/pluralize_string"),h="is-disabled",i=5;b.exports=d.core.View.extend({events:{"click .js-option":"_onClickOption","click .js-share":"_onClickShare","keyup .js-password-input":"_onKeyUpPasswordInput"},initialize:function(){if(this.elder("initialize"),!this.options.privacyOptions)throw new Error("privacyOptions is required");if(!this.options.user)throw new Error("user is required");if(!this.options.vis)throw new Error("vis is required");this.template=d.templates.getTemplate("common/dialogs/change_privacy/start"),this._initBinds()},render:function(){var a=this.options.privacyOptions.passwordOption(),b=a?a.get("password"):"",c=this.options.privacyOptions.selectedOption(),f=d.config.get("upgrade_url"),j=this.options.vis.permission.getUsersWithAnyPermission();return this.$el.html(this.template({vis:this.options.vis,privacyOptions:this.options.privacyOptions,password:b,saveBtnClassNames:c.canSave()?"":h,showUpgradeBanner:f&&this.options.privacyOptions.any(function(a){return!!a.get("disabled")}),upgradeUrl:f,showTrial:this.options.user.canStartTrial(),showShareBanner:this.options.user.organization,sharedEntitiesCount:j.length,personOrPeopleStr:g("person","people",j.length),sharedEntitiesSampleCount:i,sharedEntitiesSample:e.take(j,i),sharedWithOrganization:this.options.vis.permission.isSharedWithOrganization()})),this.delegateEvents(),this},_initBinds:function(){this.options.privacyOptions.bind("change:selected change:disabled",this.render,this),this.options.privacyOptions.bind("change:password",this._onChangePassword,this),this.add_related_model(this.options.privacyOptions)},_onClickOption:function(a){var b=f(a.target).closest(".js-option").data("index"),c=this.options.privacyOptions.at(b);c.get("disabled")||c.set("selected",!0);var d=this.options.privacyOptions.passwordOption();c===d?this.$(".js-password-input").val("").focus().keyup():d&&this.$(".js-password-input").val(d.get("password"))},_onChangePassword:function(){this.$(".ok").toggleClass(h,!this.options.privacyOptions.selectedOption().canSave())},_onKeyUpPasswordInput:function(a){this.options.privacyOptions.passwordOption().set("password",a.target.value)},_onClickShare:function(a){this.killEvent(a),this.trigger("clickedShare")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_helpers/pluralize_string":211}],58:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./listing/datasets_view"),f=a("./listing/imports_view");b.exports=d.core.View.extend({className:"CreateDialog-listing CreateDialog-listing--noPaddingTop",initialize:function(){this.user=this.options.user,this.createModel=this.options.createModel,
this.template=d.templates.getTemplate("common/views/create/create_listing"),this.createModel.bind("change:listing",this._onChangeListing.bind(this)),this.add_related_model(this.createModel),this._onChangeListing()},render:function(){return this.clearSubViews(),this.$el.html(this.template()),this._initViews(),this},_onChangeListing:function(){this.listingPane&&this.listingPane.active(this.createModel.get("listing"))},_initViews:function(){this.listingPane=new d.ui.common.TabPane({el:this.$(".ListingContent")}),this.addView(this.listingPane);var a=new e({defaultUrl:this.user.viewUrl().dashboard().datasets(),user:this.user,createModel:this.createModel,routerModel:this.createModel.visFetchModel,collection:this.createModel.collection});if(a.render(),this._addListingPane("datasets",a),this.user.canCreateDatasets()){var b=new f({user:this.user,createModel:this.createModel});b.render(),this._addListingPane("import",b)}},_addListingPane:function(a,b){this.listingPane.addTab(a,b,{active:this.createModel.get("listing")===a})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./listing/datasets_view":66,"./listing/imports_view":91}],59:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({events:{"click .js-toggle":"_toggle"},initialize:function(){this.elder("initialize"),this.createModel=this.options.createModel,this.template=c.templates.getTemplate("common/dialogs/create/footer/guessing_toggler"),this._initBinds()},render:function(){var a="";return this.createModel.showGuessingToggler()&&(a=this.template({isGuessingEnabled:this.model.get("guessing"),importState:this.createModel.getImportState(),isUploadValid:this.createModel.upload.isValidToUpload(),customHosted:c.config.get("cartodb_com_hosted")})),this.$el.html(a),this},_initBinds:function(){this.createModel.bind("change",this.render,this),this.model.bind("change",this.render,this),this.add_related_model(this.createModel)},_toggle:function(){var a=!this.model.get("guessing");this.model.set("guessing",a)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],60:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null;b.exports=c.core.View.extend({events:{click:"_onClick"},initialize:function(){this.user=this.options.user,this.createModel=this.options.createModel,this.template=c.templates.getTemplate("common/dialogs/create/footer/privacy_toggler_template"),this._initBinds()},render:function(){if(this.clearSubViews(),this.$el.empty(),this.createModel.showPrivacyToggler()){var a=this.user.canCreatePrivateDatasets(),b=this.model.get("privacy"),d="PUBLIC"===b?"PRIVATE":"PUBLIC",e="PUBLIC"===b?"unlock":"lock",f=c.config.get("upgrade_url")||window.upgrade_url,g=!c.config.get("cartodb_com_hosted")&&!a&&f;this.$el.html(this.template({privacy:b,isDisabled:!a,canUpgrade:g,nextPrivacy:d,upgradeUrl:f,icon:e})),this._initViews()}return this},_initBinds:function(){this.model.bind("change:privacy",this.render,this)},_initViews:function(){this.addView(new c.common.TipsyTooltip({el:this.$(".js-toggler"),html:!0,title:function(){return d(this).attr("data-title")}}))},_onClick:function(){if(this.user.canCreatePrivateDatasets()){var a=this.model.get("privacy");return void this.model.set("privacy","PUBLIC"===a?"PRIVATE":"PUBLIC")}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],61:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("../../../../../common/view_helpers/random_quote");b.exports=d.core.View.extend({events:{"click .js-connect":"_onConnectClick"},initialize:function(){if(!this.options.defaultUrl)throw new Error("defaultUrl is required");this.user=this.options.user,this.routerModel=this.options.routerModel,this.template=d.templates.getTemplate(this.options.template),this._initBinds()},render:function(){var a=this.routerModel.get("content_type");return this.$el.html(this.template({defaultUrl:this.options.defaultUrl,page:this.routerModel.get("page"),tag:this.routerModel.get("tag"),q:this.routerModel.get("q"),shared:this.routerModel.get("shared"),locked:this.routerModel.get("locked"),library:this.routerModel.get("library"),quote:e(),type:a,totalItems:this.collection.size(),totalEntries:this.collection.total_entries})),this},_initBinds:function(){this.routerModel.bind("change",this.render,this),this.collection.bind("reset",this.render,this),this.add_related_model(this.routerModel),this.add_related_model(this.collection)},_onConnectClick:function(){this.trigger("connectDataset",this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../common/view_helpers/random_quote":212}],62:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null,f="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,g=a("../../../../view_helpers/pluralize_string"),h=a("../../../../views/likes/view");b.exports=d.core.View.extend({tagName:"li",className:"DatasetsList-item DatasetsList-item--selectable",events:{"click .js-tag-link":"_onTagClick",click:"_toggleSelected"},initialize:function(){this.user=this.options.user,this.routerModel=this.options.createModel.visFetchModel,this.template=d.templates.getTemplate("common/views/create/listing/dataset_item"),this.table=new d.admin.CartoDBTableMetadata(this.model.get("table")),this.model.on("change",this.render,this)},render:function(){var a=this.model,b=this.table,c=a.get("tags")||[],d=a.get("description")&&f.stripHTML(markdown.toHTML(a.get("description")))||"",h={isRaster:"raster"===a.get("kind"),geometryType:b.geomColumnTypes().length>0?b.geomColumnTypes()[0]:"",title:a.get("name"),isOwner:a.permission.isOwner(this.user),owner:a.permission.owner.renderData(this.user),showPermissionIndicator:!a.permission.hasWriteAccess(this.user),description:d,privacy:a.get("privacy").toLowerCase(),likes:a.get("likes")||0,timeDiff:e(a.get("updated_at")).fromNow(),tags:c,tagsCount:c.length,maxTagsToShow:3,rowCount:void 0,datasetSize:void 0,syncStatus:void 0,syncRanAt:void 0},i=b.get("row_count");i>=0&&(h.rowCount=i<1e4?f.formatNumber(i):f.readizableNumber(i),h.pluralizedRows=g("Row",i));var j=b.get("size");return j>=0&&(h.datasetSize=f.readablizeBytes(j,!0)),_.isEmpty(a.get("synchronization"))||(h.syncRanAt=e(a.get("synchronization").ran_at||new Date).fromNow(),h.syncStatus=a.get("synchronization").state),this.$el.html(this.template(h)),this._renderLikesIndicator(),this._renderTooltips(),this.$el[a.get("selected")?"addClass":"removeClass"]("is--selected"),this},_renderLikesIndicator:function(){var a=new h({model:this.model.like});this.$(".js-likes-indicator").replaceWith(a.render().el),this.addView(a)},_renderTooltips:function(){_.isEmpty(this.model.get("synchronization"))||this.addView(new d.common.TipsyTooltip({el:this.$(".DatasetsList-itemStatus"),title:function(a){return $(this).attr("data-title")}}))},_onTagClick:function(a){var b=$(a.target).val();b&&this.routerModel.set("tag",b)},_toggleSelected:function(a){"A"!==a.target.tagName&&(this.killEvent(a),this.options.createModel.canSelect(this.model)&&this.model.set("selected",!this.model.get("selected")))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../view_helpers/pluralize_string":211,"../../../../views/likes/view":216}],63:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../../../views/pagination/model"),f=a("../../../../views/pagination/view");b.exports=d.core.View.extend({className:"DatasetsPaginator",initialize:function(){this.routerModel=this.options.routerModel,this.collection=this.options.collection,this.model=new e({current_page:this.routerModel.get("page")}),this._initBinds(),this._initViews()},render:function(){return this.clearSubViews(),this.$el.append(this.paginationView.render().el),this},_initBinds:function(){this.model.bind("change",this.render,this),this.model.bind("change:current_page",function(){this.routerModel.set("page",this.model.get("current_page"))},this),this.collection.bind("reset",this._updatePaginationModelByCollection,this),this.routerModel.bind("change:page",this._updatePaginationModelByRouterModel,this),this.add_related_model(this.routerModel),this.add_related_model(this.collection),this.add_related_model(this.model)},_initViews:function(){this.paginationView=new f({model:this.model}),this.addView(this.paginationView)},_updatePaginationModelByCollection:function(){this.model.set({per_page:this.collection.options.get("per_page"),total_count:this.collection.total_entries})},_updatePaginationModelByRouterModel:function(){this.model.set("current_page",this.routerModel.get("page"))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../views/pagination/model":219,"../../../../views/pagination/view":220}],64:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f=a("./dataset_item_view"),g="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,h=a("../../../../background_polling/models/upload_config"),i=a("../../../../view_helpers/pluralize_string");b.exports=f.extend({tagName:"li",className:"DatasetsList-item",events:{"click .js-tag-link":"_onTagClick",click:"_toggleSelected"},initialize:function(){this.elder("initialize"),this.template=d.templates.getTemplate("common/views/create/listing/remote_dataset_item"),this.table=new d.admin.CartoDBTableMetadata(this.model.get("external_source"))},render:function(){var a=this.model,b=this.table,c=a.get("tags")||[],d=a.get("description")&&g.stripHTML(markdown.toHTML(a.get("description")))||"",e=a.get("source")&&markdown.toHTML(a.get("source"))||"",f={isRaster:"raster"===a.get("kind"),geometryType:b.geomColumnTypes().length>0?b.geomColumnTypes()[0]:"",title:a.get("display_name")||a.get("name"),source:e,description:d,timeDiff:moment(a.get("updated_at")).fromNow(),tags:c,tagsCount:c.length,routerModel:this.routerModel,maxTagsToShow:3,canImportDataset:this._canImportDataset(),rowCount:void 0,datasetSize:void 0},h=b.get("row_count");h>=0&&(f.rowCount=h<1e4?g.formatNumber(h):g.readizableNumber(h),f.pluralizedRows=i("Row",h));var j=b.get("size");return j>=0&&(f.datasetSize=g.readablizeBytes(j,!(j.toString().length>9))),this.$el.html(this.template(f)),this._setItemClasses(),this._renderTooltips(),this},_setItemClasses:function(){this.$el[this.model.get("selected")?"addClass":"removeClass"]("is--selected"),this.$el[this._canImportDataset()?"addClass":"removeClass"]("DatasetsList-item--selectable"),this.$el[this._canImportDataset()?"removeClass":"addClass"]("DatasetsList-item--banned")},_renderTooltips:function(){this.addView(new d.common.TipsyTooltip({el:this.$(".DatasetsList-itemStatus"),title:function(a){return e(this).attr("data-title")}}))},_onTagClick:function(a){a&&this.killEvent(a);var b=e(a.target).val();b&&this.routerModel.set({tag:b,library:!0})},_canImportDataset:function(){var a=this.table.get("size")||0;return this.user.get("remaining_byte_quota")*h.fileTimesBigger>=a&&this.user.get("limits").import_file_size>a},_toggleSelected:function(a){"A"!==a.target.tagName&&(this.killEvent(a),this._canImportDataset()&&this.options.createModel.canSelect(this.model)&&this.model.set("selected",!this.model.get("selected")))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../background_polling/models/upload_config":14,"../../../../view_helpers/pluralize_string":211,"./dataset_item_view":62}],65:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./datasets/dataset_item_view"),f=a("./datasets/remote_dataset_item_view");b.exports=d.core.View.extend({tagName:"ul",className:"DatasetsList",events:{},_ITEMS:{remotes:f,datasets:e},initialize:function(){this.user=this.options.user,this.createModel=this.options.createModel,this.collection.bind("reset",this.render,this),this.add_related_model(this.collection)},render:function(){return this.clearSubViews(),this.collection.each(this._addItem,this),this},_addItem:function(a,b){var c="remote"===a.get("type")?"remotes":"datasets",d=new this._ITEMS[c]({model:a,createModel:this.createModel,user:this.user});this.addView(d),this.$el.append(d.render().el)},show:function(){this.$el.removeClass("is-hidden")},hide:function(){this.$el.addClass("is-hidden")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./datasets/dataset_item_view":62,"./datasets/remote_dataset_item_view":64}],66:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./datasets_list_view"),g=a("./datasets/content_result_view"),h=a("./datasets/datasets_paginator_view");b.exports=d.core.View.extend({initialize:function(){this.user=this.options.user,this.createModel=this.options.createModel,this.routerModel=this.options.routerModel,this._initViews(),this._initBindings()},_initBindings:function(){this.routerModel.bind("change",this._onRouterChange,this),this.collection.bind("loading",this._onDataLoading,this),this.collection.bind("reset",this._onDataFetched,this),this.collection.bind("error",function(a){(!a||a&&"abort"!==a.statusText)&&this._onDataError()},this),this.add_related_model(this.routerModel),this.add_related_model(this.createModel),this.add_related_model(this.collection)},_initViews:function(){this.controlledViews={},this.enabledViews=[];var a=new g({className:"ContentResult no-datasets",user:this.user,defaultUrl:this.options.defaultUrl,routerModel:this.routerModel,collection:this.collection,template:"common/views/create/listing/content_no_datasets"});a.bind("connectDataset",function(){this.user.canCreateDatasets()&&this.createModel.set("listing","import")},this),a.render().hide(),this.controlledViews.no_datasets=a,this.$el.append(a.el),this.addView(a);var b=new f({user:this.user,createModel:this.createModel,routerModel:this.routerModel,collection:this.collection});this.controlledViews.list=b,this.$el.append(b.render().el),this.addView(b);var c=new g({defaultUrl:this.options.defaultUrl,routerModel:this.routerModel,collection:this.collection,template:"common/views/create/listing/datasets_no_result"});c.render().hide(),this.controlledViews.no_results=c,this.$el.append(c.el),this.addView(c);var d=new g({defaultUrl:this.options.defaultUrl,routerModel:this.routerModel,collection:this.collection,template:"common/views/create/listing/datasets_error"});d.render().hide(),this.controlledViews.error=d,this.$el.append(d.el),this.addView(d);var e=new g({defaultUrl:this.options.defaultUrl,routerModel:this.routerModel,collection:this.collection,template:"common/views/create/listing/datasets_loader"});this.controlledViews.main_loader=e,this.$el.append(e.render().el),this.addView(e);var i=new h({routerModel:this.routerModel,collection:this.collection});this.controlledViews.content_footer=i,this.$el.append(i.render().el),this.addView(i)},_onRouterChange:function(){this._hideBlocks(),this._showBlocks(["main_loader"])},_onDataFetched:function(){var a=["content_footer"],b=this.routerModel.get("tag"),c=this.routerModel.get("q"),d=this.routerModel.get("shared"),e=this.routerModel.get("locked"),f=this.routerModel.get("library");if(f&&0===this.collection.total_user_entries&&a.push("no_datasets"),0===this.collection.size())if(b||c||"no"!==d||e)a.push("no_results");else{if(!f)return void this._goToLibrary();a.push("no_results")}else a.push("list");this._hideBlocks(),this._showBlocks(a)},_onDataLoading:function(){this._hideBlocks(),this._showBlocks(["main_loader"])},_onDataError:function(a){this._hideBlocks(),this._showBlocks(["error"])},_showBlocks:function(a){var b=this;a?e.each(a,function(a){b.controlledViews[a]&&(b.controlledViews[a].show(),b.enabledViews.push(a))}):(b.enabledViews=[],e.each(this.controlledViews,function(a){a.show(),b.enabledViews.push(a)}))},_goToLibrary:function(){this.routerModel.set({shared:"no",library:!0,page:1})},_hideBlocks:function(a){var b=this;a?e.each(a,function(a){b.controlledViews[a]&&(b.controlledViews[a].hide(),b.enabledViews=e.without(b.enabledViews,a))}):(e.each(this.controlledViews,function(a){a.hide()}),b.enabledViews=[])},_isBlockEnabled:function(a){return!!a&&e.contains(this.enabledViews,a)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./datasets/content_result_view":61,"./datasets/datasets_paginator_view":63,"./datasets_list_view":65}],67:[function(a,b,c){var d=a("./imports/service_import/import_service_view"),e=a("./imports/twitter_import/import_twitter_view"),f=a("./imports/import_data_view"),g=a("./imports/import_arcgis_view");b.exports={File:{className:f,enabled:function(a,b){return!0},name:"file",title:"Data file",options:{type:"url",fileEnabled:!0,acceptSync:!0}},GDrive:{className:d,enabled:function(a,b){return!!a.get("oauth_gdrive")},name:"gdrive",title:"Google Drive",options:{service:"gdrive",fileExtensions:["Google SpreadSheet","CSV"],showAvailableFormats:!1,acceptSync:!0,fileAttrs:{ext:!0,title:"filename",description:{content:[{name:"size",format:"size",key:!0}]}}}},Dropbox:{className:d,enabled:function(a,b){return!!a.get("oauth_dropbox")},name:"dropbox",title:"Dropbox",options:{service:"dropbox",fileExtensions:["CSV","XLS"],showAvailableFormats:!1,acceptSync:!0,fileAttrs:{ext:!0,title:"filename",description:{content:[{name:"id",format:""},{name:"size",format:"size",key:!0}],separator:"-"}}}},Box:{className:d,enabled:function(a,b){return!!a.get("oauth_box")},name:"box",title:"Box",fallback:"common/views/create/listing/import_box_fallback",options:{service:"box",fileExtensions:["CSV","XLS"],showAvailableFormats:!1,acceptSync:!0,fileAttrs:{ext:!0,title:"filename",description:{content:[{name:"size",format:"size",key:!0}],separator:"-"}}}},Twitter:{className:e,enabled:function(a,b){return b.twitter.enabled&&!!a.get("datasource_search_twitter")},fallback:"common/views/create/listing/import_twitter_fallback",name:"twitter",title:"Twitter"},Mailchimp:{className:d,enabled:function(a,b){return b.mailchimp.enabled&&!!a.get("oauth_mailchimp")},fallback:"common/views/create/listing/import_mailchimp_fallback",name:"mailchimp",title:"MailChimp",options:{service:"mailchimp",fileExtensions:[],acceptSync:!0,showAvailableFormats:!1,headerTemplate:"common/views/create/listing/import_types/data_header_mailchimp",fileAttrs:{ext:!0,title:"filename",description:{content:[{name:"member_count",format:"number",key:!0}],itemName:"member",separator:""}}}},Arcgis:{className:g,enabled:function(a,b){return a.get("arcgis_enabled")},fallback:"common/views/create/listing/import_arcgis_fallback",name:"arcgis",title:"ArcGIS Server&trade;"},Salesforce:{className:f,enabled:function(a,b){return a.get("salesforce_enabled")},fallback:"common/views/create/listing/import_salesforce_fallback",name:"salesforce",title:"Salesforce",options:{type:"service",service_name:"salesforce",acceptSync:!0,formTemplate:"common/views/create/listing/import_types/data_form_salesforce",headerTemplate:"common/views/create/listing/import_types/data_header_salesforce"}}}},{"./imports/import_arcgis_view":71,"./imports/import_data_view":72,"./imports/service_import/import_service_view":76,"./imports/twitter_import/import_twitter_view":86}],68:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;c.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof a?a.cdb.admin:null,b.exports=c.core.View.extend({options:{template:"",fileEnabled:!1},events:{"keyup .js-textInput":"_onTextChanged","submit .js-form":"_onSubmitForm"},initialize:function(){this.user=this.options.user,this.template=c.templates.getTemplate(this.options.template||"common/views/create/listing/import_types/data_form"),this._initBinds(),this._checkVisibility()},render:function(){return this.$el.html(this.template(this.options)),this._initViews(),this},_initBinds:function(){this.model.bind("change:state",this._checkVisibility,this)},_initViews:function(){if(this.options.fileEnabled){var a=this;this.$(".js-fileInput").bind("change",function(b){this.files&&this.files.length>0&&a._onFileChanged(this.files),this.value=""}),this._initDropzone()}},_initDropzone:function(){var a=$("html")[0],b=this;this.dragster=new Dragster(a),$(a).bind("dragster:enter",function(a){b._showDropzone()}),$(a).bind("dragster:leave",function(a){b._hideDropzone()}),a.dropzone||(this.dropzone=new Dropzone(a,{url:":)",autoProcessQueue:!1,previewsContainer:!1}),this.dropzone.on("dragover",function(){b._showDropzone()}),this.dropzone.on("drop",function(a){var c=a.dataTransfer.files;b._onFileChanged(c),b._hideDropzone()}))},_destroyDropzone:function(){var a=$("html")[0];this.dragster&&(this.dragster.removeListeners(),this.dragster.reset(),$(a).unbind("dragster:enter dragster:leave")),this.dropzone&&this.dropzone.destroy()},_setValidFileExtensions:function(a){return RegExp("(.|/)("+a.join("|")+")$","i")},_onTextChanged:function(){var a=this.$(".js-textInput").val();a||this._hideTextError()},_onFileChanged:function(a){this.trigger("fileSelected",this),a&&1===a.length&&(a=a[0]),this.model.set({type:"file",value:a}),"error"!==this.model.get("state")?(this._hideFileError(),this.model.set("state","selected")):this._showFileError()},_showTextError:function(){this.$(".Form-inputError").addClass("is-visible")},_hideTextError:function(){this.$(".Form-inputError").removeClass("is-visible")},_showDropzone:function(){this.$(".Form-upload").addClass("is-dropping"),this._hideFileError()},_hideDropzone:function(){this.$(".Form-upload").removeClass("is-dropping")},_showFileError:function(){"error"===this.model.get("state")&&(this.$(".js-fileError").text(this.model.get("get_error_text").what_about).show(),this.$(".js-fileLabel").hide(),this.$(".js-fileButton").addClass("Button--negative"))},_hideFileError:function(){this.$(".js-fileError").hide(),this.$(".js-fileLabel").show(),this.$(".js-fileButton").removeClass("Button--negative")},_onSubmitForm:function(a){a&&this.killEvent(a);var b=this.$(".js-textInput").val();if(!b)return void this._hideTextError();this.trigger("urlSelected",this);var c=this.model.get("service_name")?"service":"url";this.model.set({type:c,value:b,service_item_id:b,state:"idle"}),"error"!==this.model.get("state")?(this._hideFileError(),this._hideTextError(),this.model.set("state","selected")):this._showTextError()},_checkVisibility:function(){var a=this.model.get("state");this["selected"!==a?"show":"hide"]()},clean:function(){this._destroyDropzone(),this.$(".js-fileInput").unbind("change"),this.elder("clean")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],69:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({events:{"click .js-back":"_goToStart"},options:{fileEnabled:!1,acceptSync:!1},initialize:function(){this.user=this.options.user,this.template=c.templates.getTemplate(this.options.template||"common/views/create/listing/import_types/data_header"),this._initBinds(),this._checkVisibility()},render:function(){var a=this.options.acceptSync&&this.user.get("actions")&&this.user.get("actions").sync_tables&&"file"!==this.model.get("type");return this.$el.html(this.template({type:this.model.get("type"),fileEnabled:this.options.fileEnabled,acceptSync:a,state:this.model.get("state")})),this._checkVisibility(),this},_initBinds:function(){this.model.bind("change:state",this.render,this)},_checkVisibility:function(){this.show()},_goToStart:function(){this.model.set("state","idle")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],70:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,f=a("./import_selected_dataset_view");b.exports=f.extend({render:function(){var a=this.options.fileAttrs.title&&this.model.get("value")[this.options.fileAttrs.title]||this.model.get("value"),b=this._genDescription(),c=this.options.fileAttrs.ext?e.getFileExtension(a):"";this.options.fileAttrs.ext&&(a=a&&a.replace("."+c,""));var f=window.upgrade_url,g=this.user.get("actions")&&this.user.get("actions").sync_tables,h=d.config.get("cartodb_com_hosted");return this.$el.html(this.template({title:a,description:b,ext:c,interval:this.model.get("interval"),importCanSync:this.options.acceptSync&&this._isArcGISLayer(a),userCanSync:g,showTrial:this.user.canStartTrial(),showUpgrade:!g&&!h&&f&&!this.user.isInsideOrg(),upgradeUrl:f})),this},_isArcGISLayer:function(a){return a.search(/([0-9]+\/|[0-9]+)/)!==-1}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./import_selected_dataset_view":75}],71:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("./data_import/data_form_view"),f=a("./data_import/data_header_view"),g=a("./import_arcgis_selected_dataset_view"),h=a("./import_data_view");b.exports=h.extend({options:{fileExtensions:[],type:"service",service:"arcgis",acceptSync:!0,fileEnabled:!1,fileAttrs:{ext:!1,title:"",description:""}},_initViews:function(){var a=new f({el:this.$(".ImportPanel-header"),model:this.model,user:this.user,collection:this.collection,fileEnabled:this.options.fileEnabled,acceptSync:this.options.acceptSync,template:"common/views/create/listing/import_types/data_header_arcgis"});a.render(),this.addView(a);var b=new g({el:this.$(".DatasetSelected"),user:this.user,model:this.model,acceptSync:this.options.acceptSync,fileAttrs:this.options.fileAttrs});b.render(),this.addView(b);var c=new e({el:this.$(".ImportPanel-form"),user:this.user,model:this.model,template:"common/views/create/listing/import_types/data_form_arcgis",fileEnabled:this.options.fileEnabled});c.render(),this.addView(c)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./data_import/data_form_view":68,"./data_import/data_header_view":69,"./import_arcgis_selected_dataset_view":70,"./import_data_view":72}],72:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("./import_default_view"),f=a("../../../../background_polling/models/upload_model"),g=a("./data_import/data_form_view"),h=a("./data_import/data_header_view"),i=a("./import_selected_dataset_view");b.exports=e.extend({options:{fileExtensions:[],type:"url",service:"",acceptSync:!1,fileEnabled:!1,formTemplate:"",headerTemplate:"",fileAttrs:{}},className:"ImportPanel ImportDataPanel",initialize:function(){this.user=this.options.user,this.model=new f({type:this.options.type,service_name:this.options.service},{user:this.user}),this.template=d.templates.getTemplate("common/views/create/listing/import_types/import_data"),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this.template()),this._initViews(),this},_initViews:function(){var a=new h({el:this.$(".ImportPanel-header"),model:this.model,user:this.user,fileEnabled:this.options.fileEnabled,acceptSync:this.options.acceptSync,template:this.options.headerTemplate});a.render(),this.addView(a);var b=new i({el:this.$(".DatasetSelected"),user:this.user,model:this.model,acceptSync:this.options.acceptSync,fileAttrs:this.options.fileAttrs});b.render(),this.addView(b);var c=new g({el:this.$(".ImportPanel-form"),user:this.user,model:this.model,template:this.options.formTemplate,fileEnabled:this.options.fileEnabled});c.bind("fileSelected",function(){b.setOptions({acceptSync:!1,fileAttrs:{ext:!0,title:"name",description:{content:[{name:"size",format:"size"}]}}})}),c.bind("urlSelected",function(){b.setOptions({acceptSync:!0,fileAttrs:{ext:!1,title:"",description:""}})}),c.render(),this.addView(c)},_initBinds:function(){this.model.bind("change:state",this._checkState,this),this.model.bind("change",this._triggerChange,this)},_checkState:function(){"selected"===this.model.previous("state")&&this.model.set({type:void 0,value:"",service_name:"",service_item_id:"",interval:0})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../background_polling/models/upload_model":15,"./data_import/data_form_view":68,"./data_import/data_header_view":69,"./import_default_view":74,"./import_selected_dataset_view":75}],73:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"ImportPanel",initialize:function(){this.template=c.templates.getTemplate(this.options.template||"common/views/create/listing/import_default_fallback")},render:function(){this.$el.append(this.template())}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],74:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../../../background_polling/models/upload_model");b.exports=d.core.View.extend({initialize:function(){this.user=this.options.user,this.model=new e(null,{user:this.user}),this._initBinds()},_initBinds:function(){this.model.bind("change",this._triggerChange,this)},_triggerChange:function(){this.trigger("change",this.model.toJSON(),this)},getModelData:function(){return this.model?this.model.toJSON():{}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../background_polling/models/upload_model":15}],75:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,f=a("../../../../view_helpers/pluralize_string");b.exports=d.core.View.extend({className:"DatasetSelected",_FORMATTERS:{size:e.readablizeBytes,number:e.formatNumber},options:{acceptSync:!1,fileAttrs:{ext:!1,title:"",description:{content:[{name:"id",format:""}],itemName:"",separator:""}}},events:{"click .js-interval-0":"_onIntervalZero","click .js-interval-1":"_onIntervalHour","click .js-interval-2":"_onIntervalDay","click .js-interval-3":"_onIntervalWeek","click .js-interval-4":"_onIntervalMonth"},initialize:function(){this.user=this.options.user,this.template=d.templates.getTemplate("common/views/create/listing/import_selected_dataset"),this._initBinds(),this._checkVisibility()},render:function(){var a=this.options.fileAttrs.title&&this.model.get("value")[this.options.fileAttrs.title]||this.model.get("value"),b=this._genDescription(),c=this.options.fileAttrs.ext?e.getFileExtension(a):"";
this.options.fileAttrs.ext&&(a=a&&a.replace("."+c,""));var f=window.upgrade_url,g=this.user.get("actions")&&this.user.get("actions").sync_tables,h=d.config.get("cartodb_com_hosted");return this.$el.html(this.template({title:a,description:b,ext:c,interval:this.model.get("interval"),importCanSync:this.options.acceptSync,userCanSync:g,showTrial:this.user.canStartTrial(),showUpgrade:!g&&!h&&f&&!this.user.isInsideOrg(),upgradeUrl:f})),this},_initBinds:function(){this.model.bind("change:value",this.render,this),this.model.bind("change:interval",this.render,this),this.model.bind("change:state",this._checkVisibility,this)},_genDescription:function(){if(this.options.fileAttrs&&this.options.fileAttrs.description){var a=this.options.fileAttrs.description,b="",c="",d=this;return a.content&&a.content.length>0&&_.each(a.content,function(e,f){f>0&&a.separator&&(c+=" "+a.separator+" ");var g=d.model.get("value")[e.name],h=e.format&&d._FORMATTERS[e.format];c+=h&&h(g)||g,e.key&&(b=e.name)}),a.itemName&&b&&(c+=" "+(a.itemName&&f(a.itemName,b)||"")),c}return""},_onIntervalZero:function(){this.model.set("interval",0)},_onIntervalHour:function(){this.options.acceptSync&&this.user.get("actions").sync_tables&&this.model.set("interval",3600)},_onIntervalDay:function(){this.options.acceptSync&&this.user.get("actions").sync_tables&&this.model.set("interval",86400)},_onIntervalWeek:function(){this.options.acceptSync&&this.user.get("actions").sync_tables&&this.model.set("interval",604800)},_onIntervalMonth:function(){this.options.acceptSync&&this.user.get("actions").sync_tables&&this.model.set("interval",2592e3)},setOptions:function(a){a&&!_.isEmpty(a)&&_.extend(this.options,a)},_checkVisibility:function(){var a=this.model.get("state");"selected"===a?this.show():this.hide()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../view_helpers/pluralize_string":211}],76:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("../import_default_view"),f=a("../../../../../background_polling/models/upload_model"),g=a("./service_header_view"),h=a("./service_loader_view"),i=a("./service_list_view"),j=a("../import_selected_dataset_view"),k=a("../../../../../service_models/service_token_model"),l=a("../../../../../service_models/service_oauth_model"),m=a("./service_items_collection");b.exports=e.extend({_DATASOURCE_NAME:"",_WINDOW_INTERVAL:1e3,className:"ImportPanel ImportPanelService",options:{service:"",showAvailableFormats:!1,fileExtensions:[],acceptSync:!1,fileAttrs:{ext:!1,title:"filename",description:"<%- size %>",formatDescription:"size",headerTemplate:""}},initialize:function(){return this.options.service?(this._DATASOURCE_NAME=this.options.service,this.user=this.options.user,this.model=new f({type:"service",service_name:this._DATASOURCE_NAME},{user:this.user}),this.template=d.templates.getTemplate("common/views/create/listing/import_types/import_service"),this._initModels(),void this._initBinds()):(d.log.info("Service provider not set for import panel!"),!1)},render:function(){return this.clearSubViews(),this.$el.html(this.template(this.options)),this._initViews(),this},_initModels:function(){this.token=new k(null,{datasource_name:this._DATASOURCE_NAME}),this.service=new l(null,{datasource_name:this._DATASOURCE_NAME}),this.collection=new m(null,{datasource_name:this._DATASOURCE_NAME})},_initBinds:function(){this.model.bind("change",this._triggerChange,this),this.model.bind("change:state",this._checkState,this),this.token.bind("change:oauth_valid",this._onOauthChange,this),this.service.bind("change:url",this._openWindow,this),this.add_related_model(this.service),this.add_related_model(this.token)},_initViews:function(){var a=new g({el:this.$(".ImportPanel-header"),user:this.user,model:this.model,collection:this.collection,title:this.options.title,showAvailableFormats:this.options.showAvailableFormats,fileExtensions:this.options.fileExtensions,acceptSync:this.options.acceptSync,template:this.options.headerTemplate});a.render(),this.addView(a);var b=new h({el:this.$(".ServiceLoader"),model:this.model,token:this.token,service:this.service});b.render(),this.addView(b);var c=new i({el:this.$(".ServiceList"),model:this.model,collection:this.collection,title:this.options.title,fileAttrs:this.options.fileAttrs});c.render(),this.addView(c);var d=new j({el:this.$(".ServiceSelected"),user:this.user,model:this.model,acceptSync:this.options.acceptSync,fileAttrs:this.options.fileAttrs});d.render(),this.addView(d)},_onOauthChange:function(){this.token.get("oauth_valid")&&this._getFiles()},_getFiles:function(){var a=this;this.model.set("state","retrieving"),this.collection.fetch({error:function(){a.model.set("state","error")},success:function(){a.model.set("state","list")}})},_checkState:function(){if("list"===this.model.get("state")&&1===this.collection.size()){var a=this.collection.at(0);this.model.set({state:"selected",value:a.toJSON(),service_item_id:a.get("id")})}"selected"!==this.model.get("state")&&this.model.set({value:"",service_item_id:"",interval:0})},_openWindow:function(){var a=this.service.get("url"),b=this,c=window.open(a,null,"menubar=no,toolbar=no,width=600,height=495"),d=window.setInterval(function(){c&&c.closed?(b._getFiles(),clearInterval(d)):c||(b.model.set("state","error"),clearInterval(d))},this._WINDOW_INTERVAL)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../background_polling/models/upload_model":15,"../../../../../service_models/service_oauth_model":207,"../../../../../service_models/service_token_model":208,"../import_default_view":74,"../import_selected_dataset_view":75,"./service_header_view":77,"./service_items_collection":80,"./service_list_view":82,"./service_loader_view":83}],77:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({events:{"click .js-back":"_goToList"},options:{title:"Service",showAvailableFormats:!1,acceptSync:!1,fileExtensions:[],template:""},initialize:function(){this.user=this.options.user,this.template=c.templates.getTemplate(this.options.template||"common/views/create/listing/import_types/service_header"),this._initBinds()},render:function(){return this.$el.html(this.template({items:this.collection.size(),service_name:this.model.get("service_name"),showAvailableFormats:this.options.showAvailableFormats,fileExtensions:this.options.fileExtensions,acceptSync:this.options.acceptSync&&this.user.get("actions").sync_tables,state:this.model.get("state"),title:this.options.title})),this._checkVisibility(),this},_initBinds:function(){this.model.bind("change:state",this.render,this)},_checkVisibility:function(){var a=this.model.get("state");this["list"!==a?"show":"hide"]()},_goToList:function(){this.model.set("state","list")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],78:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof a?a.cdb.Utils:null;b.exports={formatSize:function(a){return a&&a>0?c.readablizeBytes(a):"Unknown"}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],79:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({defaults:{id:"",filename:"",checksum:"",service:"",size:"",title:""}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],80:[function(a,b,c){(function(c){var d=a("./service_item_model.js"),e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null;b.exports=e.Collection.extend({_DATASOURCE_NAME:"dropbox",model:d,initialize:function(a,b){b.datasource_name&&(this._DATASOURCE_NAME=b.datasource_name)},fetch:function(){return this.trigger("fetch",this),e.Collection.prototype.fetch.apply(this,arguments)},parse:function(a){return a.files},url:function(a){var b=cdb.config.urlVersion("imports_service",a);return"/api/"+b+"/imports/service/"+this._DATASOURCE_NAME+"/list_files"}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./service_item_model.js":79}],81:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,f=a("./service_item_description_format"),g=a("../../../../../view_helpers/pluralize_string");b.exports=d.core.View.extend({options:{title:"",fileAttrs:{ext:!1,title:"filename",description:"size",itemName:"file",formatDescription:""}},_FORMATTERS:{size:f.formatSize,number:e.formatNumber},className:"ServiceList-item",tagName:"li",events:{"click .js-choose":"_onSelectItem"},initialize:function(){this.template=d.templates.getTemplate("common/views/create/listing/import_types/service_list_item")},render:function(){var a=this.model.get(this.options.fileAttrs.title),b=this._genDescription(),c=this.options.fileAttrs.ext?e.getFileExtension(a):"";return this.options.fileAttrs.ext&&(a=a&&a.replace("."+c,"")),this.$el.html(this.template({name:this.options.title,ext:c,title:a,description:b})),this},_genDescription:function(){if(this.options.fileAttrs&&this.options.fileAttrs.description){var a=this.options.fileAttrs.description,b="",c="",d=this;return a.content&&a.content.length>0&&_.each(a.content,function(e,f){f>0&&a.separator&&(c+=" "+a.separator+" ");var g=d.model.get(e.name),h=e.format&&d._FORMATTERS[e.format];c+=h&&h(g)||g,e.key&&(b=e.name)}),a.itemName&&b&&(c+=" "+(a.itemName&&g(a.itemName,b)||"")),c}return""},_onSelectItem:function(){this.trigger("selected",this.model,this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../view_helpers/pluralize_string":211,"./service_item_description_format":78}],82:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./service_list_item_view"),f=a("../../../../../view_helpers/pluralize_string");b.exports=d.core.View.extend({_TEXTS:{item:_t("item")},options:{title:"service",fileAttrs:{}},initialize:function(){this.template=d.templates.getTemplate("common/views/create/listing/import_types/service_list"),this._initBinds(),this._checkVisibility()},render:function(){this.clearSubViews();var a=this.collection.size();return this.$el.html(this.template({size:a,title:this.options.title,pluralize:f(this._TEXTS.item,a)})),this.collection.size()>0&&this.collection.each(this._addItem,this),this},_initBinds:function(){this.collection.bind("reset",this.render,this),this.model.bind("change:state",this._checkVisibility,this),this.add_related_model(this.collection)},_addItem:function(a){var b=new e({model:a,title:this.options.title,fileAttrs:this.options.fileAttrs});b.bind("selected",this._onSelectedItem,this),this.$(".ServiceList-items").append(b.render().el),this.addView(b)},_onSelectedItem:function(a){this.model.set({state:"selected",value:a.toJSON(),service_item_id:a.get("id")})},_checkVisibility:function(){var a=this.model.get("state");"list"===a?this.show():this.hide()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../view_helpers/pluralize_string":211,"./service_list_item_view":81}],83:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({events:{"click .js-connect":"_checkToken"},initialize:function(){this.token=this.options.token,this.service=this.options.service,this.template=c.templates.getTemplate("common/views/create/listing/import_types/service_loader"),this._initBinds(),this._checkVisibility()},render:function(){return this.$el.html(this.template({state:this.model.get("state")})),this},_initBinds:function(){this.model.bind("change:state",this.render,this),this.model.bind("change:state",this._checkVisibility,this)},_checkToken:function(){var a=this;this.model.set("state","token");var a=this;this.token.fetch({success:function(b){b.get("oauth_valid")||a._getOauthURL()},error:function(b){a._getOauthURL()}})},_checkVisibility:function(){var a=this.model.get("state");"list"!==a&&"selected"!==a?this.show():this.hide()},_getOauthURL:function(){var a=this;this.model.set("state","oauth"),this.service.set({url:""},{silent:!0}),this.service.fetch({error:function(){a.model.set("state","error")}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],84:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;c.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof a?a.cdb.admin:null;var d="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof a?a.cdb.Utils:null;b.exports=c.core.View.extend({initialize:function(){this.user=this.options.user,this._initBinds(),this.template=c.templates.getTemplate("common/views/create/listing/import_types/credits_info")},render:function(){var a=this.user.get("twitter"),b=a.quota-a.monthly_use,c=Math.min(100,Math.ceil(100*this.model.get("value")/b));return this.$el.html(this.template({value:this.model.get("value"),remaining:b,per:c,hardLimit:a.hard_limit,remainingFormatted:d.formatNumber(b),quota:a.quota,block_price:a.block_price,block_size:d.readizableNumber(a.block_size)})),this},_initBinds:function(){this.model.bind("change",this.render,this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],85:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("./credits_info_view");b.exports=d.core.View.extend({_DEFAULT_PER_VALUE:80,_MIN_PER_VALUE:1,initialize:function(){this.user=this.options.user,this.model=new d.core.Model,this._initBinds(),this._setModel()},render:function(){return this.clearSubViews(),this.$(".js-slider").slider("destroy"),this._initViews(),this},_initBinds:function(){_.bindAll(this,"_onSlideChange"),this.model.bind("change:value",this._onValueChange,this)},_setModel:function(){var a=this.user.get("twitter"),b=a.quota-a.monthly_use,c=this._MIN_PER_VALUE*b/100,d=b*this._DEFAULT_PER_VALUE/100,e=b>0?d:b+1;this.model.set({max:a.hard_limit?b:b+1,min:c,step:c,value:b>0?e:a.quota,disabled:!(b>0)})},_initViews:function(){this.$(".js-slider").slider(_.extend({range:"min",orientation:"horizontal",slide:this._onSlideChange,change:this._onSlideChange},this.model.attributes));var a=new e({el:this.$(".js-info"),user:this.user,model:this.model});a.render(),this.addView(a)},_onSlideChange:function(a,b){this.model.set("value",b.value)},_onValueChange:function(){this.trigger("maxCreditsChange",this.getMaxCredits(),this)},getMaxCredits:function(){var a=this.user.get("twitter"),b=a.quota-a.monthly_use,c=this.model.get("value");return c>b?0:c}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./credits_info_view":84}],86:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("../../../../../dialogs/create/listing/imports/import_default_view"),g=a("../../../../../background_polling/models/upload_model"),h=a("../../../../../views/date_pickers/dates_range_picker"),i=a("../../../../../dialogs/create/listing/imports/twitter_import/twitter_categories/twitter_categories_view"),j=a("./credits_usage_view.js");b.exports=f.extend({options:{acceptSync:!1,type:"service",service:"twitter_search"},className:"ImportPanel ImportTwitterPanel",initialize:function(){this.user=this.options.user,this.model=new g({type:this.options.type,service_name:this.options.service},{user:this.user}),this.template=d.templates.getTemplate("common/views/create/listing/import_types/import_twitter"),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this.template()),this._initViews(),this},_initViews:function(){var a=this.categories=new i;a.bind("changeCategory",this._setModel,this),this.$(".ImportTwitterPanel-cagetories").append(a.render().el),this.addView(a);var b=this.datepicker=new h({className:"DatePicker DatePicker--withBorder"});b.bind("changeDate",this._setModel,this),this.$(".js-picker").append(b.render().el),this.addView(b);var c=this.creditsUsage=new j({el:this.$(".CreditsUsage"),user:this.user});c.bind("maxCreditsChange",this._setModel,this),c.render(),this.addView(c),this._setModel()},_initBinds:function(){this.model.bind("change",this._triggerChange,this)},_getCategories:function(){var a=this.categories.getCategories();return e.filter(a,function(a){return a.category&&a.terms.length>0})},_getDates:function(){return this.datepicker.getDates()},_getMaxCredits:function(){return this.creditsUsage.getMaxCredits()},_setModel:function(){var a=this._getCategories(),b=this._getDates(),c=this._getMaxCredits(),d={categories:a,dates:b};this.model.set({value:d,service_item_id:d,user_defined_limits:{twitter_credits_limit:c}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../background_polling/models/upload_model":15,"../../../../../dialogs/create/listing/imports/import_default_view":74,"../../../../../dialogs/create/listing/imports/twitter_import/twitter_categories/twitter_categories_view":88,"../../../../../views/date_pickers/dates_range_picker":214,"./credits_usage_view.js":85}],87:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,e=a("./twitter_category_model");b.exports=d.Collection.extend({model:e})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./twitter_category_model":89}],88:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("./twitter_categories_collection"),f=a("./twitter_category_model"),g=a("./twitter_category_view");b.exports=d.core.View.extend({_MAX_CATEGORIES:4,_MAX_TERMS:29,initialize:function(){var a=this._generateCategory();this.collection=new e([a]),this._initBinds()},render:function(){return this.clearSubViews(),this.collection.each(this._addCategory,this),this},_initBinds:function(){this.collection.bind("change",this._manageCategories,this),this.collection.bind("change",this._onCategoryChange,this),this.add_related_model(this.collection)},_manageCategories:function(){var a=this.collection.size(),b=this.collection.filter(function(a){return 0===a.get("terms").length});if(0===b.length&&a<this._MAX_CATEGORIES){var c=this._generateCategory();return this.collection.add(c),this._addCategory(c),!1}if(b.length>0){var c=_.first(b),d=_.find(this._subviews,function(a){return c.cid===a.model.cid}),e=d.$el.index();if(1===a)return!1;if(e===a-1)return!1;e!==a-1&&b.length>1&&(c=b[1],d=_.find(this._subviews,function(a){return c.cid===a.model.cid}),this._removeCategory(d)),this._setCategoryIndex()}},_setCategoryIndex:function(){var a=this;this.$(".twitter-category").each(function(b,c){var d=$(c).find(".js-category").text().replace("Category ","");if(d!==b+1){var e=a.collection.find(function(a){return a.get("category")===d});e.set("category",(b+1).toString())}})},_generateCategory:function(){return new f({terms:[],category:(this.collection?this.collection.size()+1:1).toString()})},_addCategory:function(a){var b=new g({model:a});b.bind("submit",this._onCategorySubmit,this),b.bind("limit",this._onCategoryLimit,this),b.bind("nolimit",this._onCategoryNoLimit,this),this.$el.append(b.render().el),this.addView(b),this.trigger("addCategory")},_removeCategory:function(a){a.hide(),a.clean(),a.model.destroy(),this.trigger("removeCategory")},_onCategorySubmit:function(){this.trigger("submitCategory",this.collection.toJSON(),this)},_onCategoryLimit:function(){this.trigger("limitCategory",this.collection.toJSON(),this)},_onCategoryNoLimit:function(){this.trigger("noLimitCategory",this.collection.toJSON(),this)},_onCategoryChange:function(){this.trigger("changeCategory",this.collection.toJSON(),this)},getCategories:function(){return this.collection.toJSON()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./twitter_categories_collection":87,"./twitter_category_model":89,"./twitter_category_view":90}],89:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({_MAX_COUNTER:1014,_CHAR_MAP:{" ":2,"-":2,_:2,".":2},defaults:{terms:[],category:"",counter:1014},initialize:function(){this._initBinds()},_initBinds:function(){this.bind("change:terms",this._setCounter,this)},_setCounter:function(){var a=this._MAX_COUNTER,b=this;this.get("terms").length>1&&(a-=4*(this.get("terms").length-1)),_.each(this.get("terms"),function(c){_.each(c,function(c){void 0!==b._CHAR_MAP[c]?a-=b._CHAR_MAP[c]:a--})}),this.set("counter",Math.max(0,a))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],90:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"TwitterCategory",_MAX_CATEGORIES:4,_MAX_TERMS:29,events:{"keydown .js-terms":"_onInputChange","keypress .js-terms":"_onInputChange","keyup .js-terms":"_onInputChange"},initialize:function(){this.template=c.templates.getTemplate("common/views/create/listing/import_types/twitter_category"),this._initBinds()},render:function(){return this.$el.append(this.template({terms:this.model.get("terms"),category:this.model.get("category"),counter:this.model.get("counter")})),this.show(),this},_initBinds:function(){_.bindAll(this,"_onInputChange"),this.model.bind("change:category",this._onCategoryChange,this)},_onCategoryChange:function(){this.$(".js-category").text("Category "+this.model.get("category"))},_onInputChange:function(a){var b=$(a.target).val();if(13===a.keyCode)return a.preventDefault(),this.trigger("submit",this.model,this),!1;if(this.$(".CDB-IconFont-twitter")[b.length>0?"addClass":"removeClass"]("is-highlighted"),(0===this.model.get("counter")||this.model.get("terms").length>this._MAX_TERMS)&&37!==a.keyCode&&39!==a.keyCode&&8!==a.keyCode&&b.length>0)return this.killEvent(a),this.trigger("limit",this.model,this),!1;this.trigger("nolimit",this.model,this);var c=$(a.target),b=c.val(),d={};b=b?b.split(","):[],d.terms=b,this.model.set(d)},show:function(){this.$el.addClass("enabled")},hide:function(){this.$el.removeClass("enabled")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],91:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("./import_options"),f=a("./imports/import_default_fallback_view"),g="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;b.exports=d.core.View.extend({className:"ImportOptions",_TABS_PER_ROW:5,_DEFAULT_IMPORT:"file",_IMPORT_OPTIONS:e,_TEXTS:{key:_t("<%- name %> key is not specified and panel can't be enabled"),account:_t("<%- name %> data source is not available in your plan. Please upgrade"),limits:_t("You've reached the limits for your account. Please upgrade"),credits:_t("You've reached the available <%- name %> credits for your account this month")},events:{"click .js-goNext":"_moveNextTabs","click .js-goPrev":"_movePrevTabs"},initialize:function(){this.user=this.options.user,this.model=new d.core.Model({page:1,maxPages:0}),this.createModel=this.options.createModel,this.template=d.templates.getTemplate("common/views/create/listing/import_view")},render:function(){return this._destroyBinds(),this.clearSubViews(),this.$el.empty(),this.$el.append(this.template()),this._genTabs(),this._genTabsNavigation(),this._genPanes(),this._initBinds(),this._setOption(),this},_genTabs:function(){var a="",b=d.templates.getTemplate("common/views/create/listing/import_tab");g.each(this._IMPORT_OPTIONS,function(c){!g.isEmpty(c)&&c.enabled(d.config,this.user_data)&&(a+=b(c))}),this.$(".ImportOptions-tabsList").append(a),this.importTabs=new d.admin.Tabs({el:this.$(".ImportOptions-tabsList"),slash:!0}),this.addView(this.importTabs)},_genTabsNavigation:function(){var a=this.$(".ImportOptions-tab").size();a<=1&&this.$(".ImportOptions-tabs").hide(),this.model.set("maxPages",Math.ceil(a/this._TABS_PER_ROW)),this._checkTabsNavigation(),this.model.get("maxPages")<=1&&this.$(".ImportOptions-navigation").hide()},_moveNextTabs:function(){var a=this.model.get("page"),b=this.model.get("maxPages");a<b&&this.model.set("page",a+1)},_movePrevTabs:function(){var a=this.model.get("page");a>1&&this.model.set("page",a-1)},_moveTabsNavigation:function(){var a=this.model.get("page"),b=800;this.$(".ImportOptions-tabsList").css("margin-left","-"+b*(a-1)+"px"),this._checkTabsNavigation()},_checkTabsNavigation:function(){var a=this.model.get("page"),b=this.model.get("maxPages");this.$(".js-goPrev")[a>1?"removeClass":"addClass"]("is-disabled"),this.$(".js-goNext")[a<b?"removeClass":"addClass"]("is-disabled")},_genPanes:function(){var a=this;this.importPanes=new d.ui.common.TabPane({el:this.$(".ImportOptions-panes")}),this.addView(this.importPanes),this.importTabs.linkToPanel(this.importPanes),g.each(this._IMPORT_OPTIONS,function(b,c){var d="",e=a["_check"+c+"Import"],h=e&&e(b,a);!h&&void 0!==h||g.isEmpty(b)?b.fallback&&(d=new f({template:b.fallback})):d=new b.className(g.extend(b.options||{},{user:a.user,title:b.title})),d&&(d.render(),d.bind("change",a._setUploadModel,a),a.importPanes.addTab(b.name,d),a.addView(d))})},_checkGDriveImport:function(a,b){return!!d.config.get("oauth_gdrive")||(b._setFailedTab("gdrive","key"),!1)},_checkDropboxImport:function(a,b){return!!d.config.get("oauth_dropbox")||(b._setFailedTab("dropbox","key"),!1)},_checkBoxImport:function(a,b){return!!d.config.get("oauth_box")||(b._setFailedTab("box","key"),!1)},_checkTwitterImport:function(a,b){return d.config.get("datasource_search_twitter")?!!b.user.get("twitter").enabled&&(!(b.user.get("twitter").quota-b.user.get("twitter").monthly_use<=0&&b.user.get("twitter").hard_limit)||(b._setFailedTab("twitter","credits"),!1)):(b._setFailedTab("twitter","key"),!1)},_checkInstagramImport:function(a,b){return!!b.user.featureEnabled("instagram_import")&&(!!d.config.get("oauth_instagram")||(b._setFailedTab("instagram","key"),!1))},_checkSalesforceImport:function(a,b){return!!b.user.get("salesforce").enabled},_checkMailchimpImport:function(a,b){return d.config.get("oauth_mailchimp")?!!b.user.featureEnabled("mailchimp_import"):(b._setFailedTab("mailchimp","key"),!1)},_setFailedTab:function(a,b){var c=this.importTabs.getTab(a);c.addClass("disabled"),this._createTooltip(a,b)},_createTooltip:function(a,b){var c=this,e=this.importTabs.getTab(a),f=new d.common.TipsyTooltip({el:e,title:function(){return g.template(c._TEXTS[b])({name:a})}});this.addView(f)},_setUploadModel:function(a){this.createModel.upload.setFresh(a)},_initBinds:function(){this.model.bind("change:page",this._moveTabsNavigation,this),this.importPanes&&this.importPanes.bind("tabEnabled",this._onTabChange,this)},_destroyBinds:function(){this.importPanes&&this.importPanes.unbind("tabEnabled",null,this)},_setOption:function(){this.importPanes.active(this._DEFAULT_IMPORT),this._updateImportOption()},_updateImportOption:function(){this.createModel.setActiveImportPane(this.importPanes.activeTab)},_onTabChange:function(a){var b=this.importPanes.getPane(a),c=b.getModelData&&b.getModelData();c?this._setUploadModel(c):this._setUploadModel({}),this._updateImportOption()},clean:function(){this._destroyBinds(),d.core.View.prototype.clean.call(this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./import_options":67,"./imports/import_default_fallback_view":73}],92:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,g=a("../../../view_helpers/pluralize_string");b.exports=d.core.View.extend({events:{"submit .js-search-form":"_submitSearch","keydown .js-search-form":"_onSearchKeyDown","click .js-search-form":"killEvent","click .js-search-link":"_onSearchClick","click .js-clean-search":"_onCleanSearchClick","click .js-shared":"_onSharedClick","click .js-library":"_onLibraryClick","click .js-connect":"_onConnectClick","click .js-datasets":"_onDatasetsClick","click .js-create_empty":"_onCreateEmptyClick"},_TEXTS:{createFromScratchLabel:{map:"Create empty map",dataset:"Create empty dataset",addLayer:"Add an empty layer"}},initialize:function(){this.routerModel=this.options.routerModel,this.createModel=this.options.createModel,this.user=this.options.user,this.template=d.templates.getTemplate("common/views/create/listing/navigation"),this.model=new d.core.Model,this._preRender(),this._initBinds()},_preRender:function(){var a=$("<div>").addClass("u-inner"),b=$("<div>").addClass("Filters-inner");this.$el.append(a.append(b))},render:function(a,b){this.clearSubViews();var c=this._selectedItems().length,d=b&&b.changes&&b.changes.content_type,f=this.createModel.get("type");return this.$(".Filters-inner").html(this.template(e.extend({createModel:this.createModel,canCreateDataset:this.user.canCreateDatasets(),listing:this.createModel.get("listing"),isInsideOrg:this.user.isInsideOrg(),selectedItemsCount:c,maxLayersByMap:this.user.getMaxLayers(),totalShared:d?0:this.collection.total_shared,totalItems:d?0:this.collection.total_user_entries,pageItems:this.collection.size(),routerModel:this.routerModel,pluralizedContentType:g("dataset",d?0:this.collection.total_user_entries),pluralizedContentTypeSelected:g("dataset",c),createFromScratchLabel:this._TEXTS.createFromScratchLabel[f]},this.routerModel.attributes))),this._animate(),this.routerModel.isSearching()&&this._focusSearchInput(),this},_initBinds:function(){this.model.on("change:isSearchEnabled",this._onChangeIsSearchEnabled,this),this.createModel.bind("change:listing",this.render,this),this.routerModel.bind("change",this.render,this),this.collection.bind("reset",this.render,this),d.god.bind("closeDialogs",this._animate,this),this.add_related_model(d.god),this.add_related_model(this.createModel),this.add_related_model(this.collection),this.add_related_model(this.routerModel)},_onChangeIsSearchEnabled:function(a,b){this._enableSearchUI(b),this.routerModel.isSearching()?this._cleanSearch():b&&(this._$searchInput().val(""),this._focusSearchInput())},_$searchInput:function(){return this.$(".js-search-input")},_focusSearchInput:function(){this._$searchInput().select().focus()},_onSearchKeyDown:function(a){27===a.keyCode&&(this.killEvent(a),this._cleanSearch())},_selectedItems:function(){return this.collection.where({selected:!0})},_animate:function(){this._enableSearchUI(!!this.routerModel.isSearching());var a=this.routerModel.get("library"),b="datasets"===this.createModel.get("listing"),c=this.collection.total_user_entries>0;
this.$el.toggleClass("no-shadow",a&&!c&&b)},_enableSearchUI:function(a){this.$(".js-search-field").toggle(a),this.$(".js-links-list").toggleClass("is-hidden",a),this.$(".js-order-list").toggleClass("is-hidden",a)},_onDatasetsClick:function(){this.routerModel.set({shared:"no",library:!1,page:1}),this.createModel.set("listing","datasets")},_onSharedClick:function(){this.routerModel.set({shared:"only",library:!1,page:1}),this.createModel.set("listing","datasets")},_onLibraryClick:function(){this.routerModel.set({shared:"no",library:!0,page:1}),this.createModel.set("listing","datasets"),d.god.trigger("metrics","common_data",{email:window.user_data.email})},_onConnectClick:function(){this.user.canCreateDatasets()&&this.createModel.set("listing","import")},_onCreateEmptyClick:function(){this.user.canCreateDatasets()&&this.createModel.createFromScratch()},_onSearchClick:function(a){a&&this.killEvent(a),this.model.set("isSearchEnabled",!this.model.get("isSearchEnabled"))},_onCleanSearchClick:function(a){a&&a.preventDefault(),this._cleanSearch()},_cleanSearch:function(){this.routerModel.set({q:"",tag:"",shared:"no",library:this.createModel.showLibrary()}),this.model.set("isSearchEnabled",!1)},_submitSearch:function(a){a&&this.killEvent(a);var b=f.stripHTML(this.$(".js-search-input").val().trim(),""),c=0===b.search(":")?b.replace(":",""):"",d=0!==b.search(":")?b:"";this.routerModel.set({page:1,tag:c,q:d,shared:"yes"}),this.createModel.set("listing","datasets")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_helpers/pluralize_string":211}],93:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("../../view_factory"),g=a("../../view_helpers/random_quote");b.exports=e.extend({initialize:function(){if(this.elder("initialize"),!this.model)throw new Error("model is required (cdb.admin.Visualization)");if(!this.options.title)throw new Error("title is required");if(!this.options.explanation)throw new Error("title is required");if(!this.options.router)throw new Error("router callback is required");this._initViews(),this._initBinds()},render_content:function(){return this._panes.getActivePane().render().el},_initViews:function(){this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("confirm",f.createByTemplate("common/dialogs/create_vis_first/template",{title:this.options.title,explanation:this.options.explanation})),this._panes.addTab("loading",f.createByTemplate("common/templates/loading",{title:"Creating map…",quote:g()})),this._panes.addTab("fail",f.createByTemplate("common/templates/fail",{msg:"Could not create map for some reason"})),this._panes.active("confirm")},_initBinds:function(){this._panes.bind("tabEnabled",this.render,this)},ok:function(){this._panes.active("loading");var a=this;this.model.changeToVisualization({success:function(b){a.options.router.changeToVis(b),a.options.success&&a.options.success(b),a.clean()},error:function(){a._panes.active("fail")}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"../../view_helpers/random_quote":212,"../../views/base_dialog/view":213}],94:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("../../view_factory"),g=a("../../view_helpers/random_quote");b.exports=e.extend({initialize:function(){if(this.elder("initialize"),!this.options.table)throw new Error("table is required");if(!this.options.column)throw new Error("column is required");this._initViews(),this._initBinds()},render_content:function(){return this._panes.getActivePane().render().el},_initViews:function(){this.table=this.options.table,this.column=this.options.column,this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("confirm",f.createByTemplate("common/dialogs/delete_column/template",{column:this.column})),this._panes.addTab("loading",f.createByTemplate("common/templates/loading",{title:"Deleting column…",quote:g()})),this._panes.addTab("fail",f.createByTemplate("common/templates/fail",{msg:"Could not delete column for some reason"})),this._panes.active("confirm")},_initBinds:function(){this._panes.bind("tabEnabled",this.render,this)},ok:function(){this._panes.active("loading"),this.table.deleteColumn(this.column),this.close()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"../../view_helpers/random_quote":212,"../../views/base_dialog/view":213}],95:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../views/base_dialog/view"),f=a("../view_helpers/pluralize_string"),g=a("../view_helpers/random_quote"),h=a("../views/mapcard_preview"),i="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,j="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null,k=3,l=3;b.exports=e.extend({initialize:function(){if(this.elder("initialize"),!this.options.viewModel)throw new TypeError("viewModel is required");if(!this.options.user)throw new TypeError("user is required");this._viewModel=this.options.viewModel,this._viewModel.loadPrerequisites(),this._viewModel.bind("change",function(){"DeleteItemsDone"===this._viewModel.state()?this.close():this.render()},this),this.add_related_model(this._viewModel)},render:function(){return e.prototype.render.call(this),this._loadMapPreviews(),this},render_content:function(){return this["_render"+this._viewModel.state()]()},_renderLoadingPrerequisites:function(){return d.templates.getTemplate("common/templates/loading")({title:"Checking what consequences deleting the selected "+this._pluralizedContentType()+" would have...",quote:g()})},_renderLoadPrerequisitesFail:function(){return d.templates.getTemplate("common/templates/fail")({msg:"Failed to check consequences of deleting the selected "+this._pluralizedContentType()})},_renderConfirmDeletion:function(){var a=this._viewModel.affectedEntities(),b=this._viewModel.affectedVisData();return d.templates.getTemplate("common/dialogs/delete_items_view_template")({firstItemName:this._getFirstItemName(),selectedCount:this._viewModel.length,isDatasets:this._viewModel.isDeletingDatasets(),pluralizedContentType:this._pluralizedContentType(),affectedEntitiesCount:a.length,affectedEntitiesSample:a.slice(0,k),affectedEntitiesSampleCount:k,affectedVisCount:b.length,pluralizedMaps:f("map",b.length),affectedVisVisibleCount:l,visibleAffectedVis:this._prepareVisibleAffectedVisForTemplate(b.slice(0,l))})},_prepareVisibleAffectedVisForTemplate:function(a){return a.map(function(a){var b=new d.admin.Visualization(a),c=b.permission.owner;return{visId:b.get("id"),name:b.get("name"),url:b.viewUrl(this.options.user).edit(),owner:c,ownerName:c.get("username"),isOwner:b.permission.isOwner(this.options.user),showPermissionIndicator:!b.permission.hasWriteAccess(this.options.user),timeDiff:j(b.get("updated_at")).fromNow()}},this)},ok:function(){this._viewModel.deleteItems(),this.render()},_loadMapPreviews:function(){var a=this;this.$el.find(".MapCard").each(function(){var b=i(this).data("visOwnerName"),c=new h({el:i(this).find(".js-header"),width:298,height:130,mapsApiResource:d.config.getMapsResourceName(b),visId:i(this).data("visId"),username:b}).load();a.addView(c)})},_renderDeletingItems:function(){return d.templates.getTemplate("common/templates/loading")({title:"Deleting the selected "+this._pluralizedContentType()+"...",quote:g()})},_renderDeleteItemsFail:function(){var a=this._viewModel.errorMessage().replace(/\n/g,"<br>");return"something failed"===a&&(a=""),d.templates.getTemplate("common/templates/fail")({msg:"Failed to delete the selected "+this._pluralizedContentType()+". "+a})},_pluralizedContentType:function(){return f(this._viewModel.isDeletingDatasets()?"dataset":"map",this._viewModel.length)},_getFirstItemName:function(){if(this.options.viewModel){var a=this.options.viewModel.at(0);return a?a.get("name"):void 0}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../view_helpers/pluralize_string":211,"../view_helpers/random_quote":212,"../views/base_dialog/view":213,"../views/mapcard_preview":217}],96:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,e=a("../../common/batch_process_items");b.exports=d.Collection.extend({initialize:function(a,b){if(!b.contentType)throw new TypeError("contentType is required");this._contentType=b.contentType},state:function(){return this._state},errorMessage:function(){return this._errorMessage},setState:function(a){this._state=a,this.trigger("change"),this.trigger(a)},isDeletingDatasets:function(){return"datasets"===this._contentType},loadPrerequisites:function(){var a=this.setState.bind(this,"ConfirmDeletion");this.isDeletingDatasets()?(this.setState("LoadingPrerequisites"),e({howManyInParallel:5,items:this.toArray(),processItem:this._loadPrerequisitesForModel,done:a,fail:this.setState.bind(this,"LoadPrerequisitesFail")})):a()},affectedEntities:function(){return this.chain().map(function(a){return a.sharedWithEntities()}).flatten().compact().value()},affectedVisData:function(){var a=this.chain().map(function(a){var b=a.tableMetadata();return[].concat(b.get("dependent_visualizations")).concat(b.get("non_dependent_visualizations"))}).flatten().compact().value();return _.uniq(a,function(a){return a.id})},deleteItems:function(){this.setState("DeletingItems"),e({howManyInParallel:1,items:this.toArray(),processItem:this._deleteItem,done:this.setState.bind(this,"DeleteItemsDone"),fail:this._deletionFailed.bind(this)})},_deletionFailed:function(a){this._errorMessage=a,this.setState("DeleteItemsFail")},_loadPrerequisitesForModel:function(a,b){var c=a.tableMetadata();c.no_data_fetch=!0,c.fetch({wait:!0,success:function(){b()},error:function(a,c){b(c.responseText)}})},_deleteItem:function(a,b){a.destroy({wait:!0}).done(function(){b()}).fail(function(a){var c;try{c=JSON.parse(a.responseText).errors.join("; ")}catch(a){c="something failed"}b(c)})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/batch_process_items":24}],97:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("../../view_factory"),g=a("../../view_helpers/random_quote");b.exports=e.extend({initialize:function(){if(this.elder("initialize"),_.extend(this.options,{clean_on_hide:!0,enter_to_confirm:!0}),!this.model)throw new Error("model is required (layer)");this._initViews(),this._initBinds()},render_content:function(){return this._panes.getActivePane().render().el},_initViews:function(){this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("confirm",f.createByTemplate("common/dialogs/delete_layer/template",{})),this._panes.addTab("loading",f.createByTemplate("common/templates/loading",{title:"Deleting layer…",quote:g()})),this._panes.addTab("fail",f.createByTemplate("common/templates/fail",{msg:"Could not delete layer for some reason"})),this._panes.active("confirm")},_initBinds:function(){this._panes.bind("tabEnabled",this.render,this)},ok:function(){this._panes.active("loading");var a=this;this.model.destroy({wait:!0,success:function(){a.close()},error:function(){a._panes.active("fail")}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"../../view_helpers/random_quote":212,"../../views/base_dialog/view":213}],98:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("../../view_factory"),g=a("../../view_helpers/random_quote");b.exports=e.extend({initialize:function(){if(this.elder("initialize"),!this.options.table)throw new Error("table is required");if(!this.options.row)throw new Error("row is required");this.options.name=this.options.name||"row",this._initViews(),this._initBinds()},render_content:function(){return this._panes.getActivePane().render().el},_initViews:function(){this.table=this.options.table,this.row=this.options.row,this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("confirm",f.createByTemplate("common/dialogs/delete_row/template",{name:this.options.name})),this._panes.addTab("loading",f.createByTemplate("common/templates/loading",{title:"Deleting "+this.options.name+"…",quote:g()})),this._panes.addTab("fail",f.createByTemplate("common/templates/fail",{msg:"Could not delete "+this.options.name+" for some reason"})),this._panes.active("confirm")},_initBinds:function(){this._panes.bind("tabEnabled",this.render,this)},ok:function(){var a=this;this._panes.active("loading"),this.table.trigger("removing:row"),this.row.destroy({success:function(){a.table.trigger("remove:row",a.row),a.close()},error:function(){a._panes.active("fail")}},{wait:this.options.wait})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"../../view_helpers/random_quote":212,"../../views/base_dialog/view":213}],99:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("../views/base_dialog/view"),g=a("../view_factory"),h=a("../view_helpers/random_quote"),i=a("../views/error_details_view");b.exports=f.extend({initialize:function(){if(this.elder("initialize"),!this.model)throw new Error("model is required (cdb.admin.CartoDBTableMetadata)");if(!this.options.user)throw new Error("user is required");this.elder("initialize"),this._initViews(),this._initBinds(),this._duplicateDataset()},render_content:function(){return this._panes.getActivePane().render().el},_initViews:function(){this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("loading",g.createByTemplate("common/templates/loading",{title:this.model.isInSQLView()?"Creating dataset from your query":"Duplicating your dataset",quote:h()})),this._panes.active("loading")},_initBinds:function(){this._panes.bind("tabEnabled",this.render,this)},_duplicateDataset:function(a){var b=this,a=this.model.get("name")+"_copy";this.model.duplicate(a,{success:function(a){b._redirectTo(a.viewUrl())},error:b._showError.bind(b)})},_showError:function(a){var b;try{var c=e.clone(a.attributes);b=new i({err:e.extend(c,a.attributes.get_error_text),user:this.options.user})}catch(a){b=g.createByTemplate("common/templates/fail",{msg:"Sorry, something went wrong, but we're not sure why."})}this._panes.addTab("fail",b.render()),this._panes.active("fail")},_redirectTo:function(a){window.location=a}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../view_factory":209,"../view_helpers/random_quote":212,"../views/base_dialog/view":213,"../views/error_details_view":215}],100:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("../views/base_dialog/view"),g=a("../view_factory"),h=a("../view_helpers/random_quote"),i=a("../views/error_details_view");b.exports=f.extend({initialize:function(){if(this.elder("initialize"),!this.model)throw new Error("model is required (cdb.admin.Visualization)");if(!this.options.user)throw new Error("user is required");this.elder("initialize"),this._initViews(),this._initBinds(),this._duplicateMap()},render_content:function(){return this._panes.getActivePane().render().el},_initViews:function(){this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("loading",g.createByTemplate("common/templates/loading",{title:"Duplicating your map",quote:h()})),this._panes.active("loading")},_initBinds:function(){this._panes.bind("tabEnabled",this.render,this)},_duplicateMap:function(a){var b=this,a=this.model.get("name")+" copy";this.model.copy({name:a},{success:function(a){b._redirectTo(a.viewUrl(b.options.user).edit().toString())},error:b._showError.bind(b)})},_showError:function(a){var b;try{var c=e.clone(a.attributes);b=new i({err:e.extend(c,a.attributes.get_error_text),user:this.options.user})}catch(a){b=g.createByTemplate("common/templates/fail",{msg:"Sorry, something went wrong, but we're not sure why."})}this._panes.addTab("fail",b.render()),this._panes.active("fail")},_redirectTo:function(a){window.location=a}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../view_factory":209,"../view_helpers/random_quote":212,"../views/base_dialog/view":213,"../views/error_details_view":215}],101:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,f="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof a?a.cdb.Utils:null;b.exports=d.core.View.extend({options:{maxLength:200},events:{"keydown .js-name":"_onNameKeyDown","click .js-privacy":"_showPrivacy",submit:"_onSubmit"},initialize:function(){this.user=this.options.user,this.template=d.templates.getTemplate("common/dialogs/edit_vis_metadata/edit_vis_form"),this._initBinds()},render:function(){return this.clearSubViews(),this._destroyTags(),this.$el.html(this.template({isDataset:this.model.isDataset(),isDataLibraryEnabled:this.user.featureEnabled("data_library"),visValue:this.model.get("name"),visDescription:this.model.get("description"),visPrivacy:this.model.get("privacy").toLowerCase(),visSource:this.model.get("source"),visAttributions:this.model.get("attributions"),visDisplayName:this.model.get("display_name"),isNameEditable:this.model.isNameEditable(),isMetadataEditable:this.model.isMetadataEditable(),maxLength:this.options.maxLength})),this._initViews(),this},_initBinds:function(){this.model.bind("error",this._setFields,this),this.model.bind("valid",this._setFields,this)},_initViews:function(){var a=this;this.addView(new d.common.TipsyTooltip({el:this.$(".js-markdown"),html:!0,title:function(){return c(this).data("title")}})),this.addView(new d.common.TipsyTooltip({el:this.$(".js-name"),title:function(){return a.model.getError()}})),e.each(this.model.get("tags"),function(a){this.$(".js-tagsList").append("<li>"+d.core.sanitize.html(a)+"</li>")},this);var b=this.model.isMetadataEditable()||0!==this.model.get("tags").length?"Add tags":"No tags";this.$(".js-tagsList").tagit({allowSpaces:!0,placeholderText:b,readOnly:!this.model.isMetadataEditable(),onBlur:function(){a.model.isMetadataEditable()&&a.$(".js-tags").removeClass("is-focus")},onFocus:function(){a.model.isMetadataEditable()&&a.$(".js-tags").addClass("is-focus")},onSubmitTags:function(b,c){return b.preventDefault(),a._onSubmit(),!1}}),this.model.isDataset()&&(this._licenseDropdown=new d.forms.Combo({className:"Select",width:"100%",property:"license",model:this.model,disabled:!this.model.isMetadataEditable(),extra:this._getLicensesForFormsCombo()}),this.addView(this._licenseDropdown),this.$(".js-license").append(this._licenseDropdown.render().el))},_getLicensesForFormsCombo:function(){var a=d.config.get("licenses"),b=[{id:"",name:"-"}];return e.chain(b.concat(a)).compact().map(function(a){return[a.name,a.id]}).value()},_setFields:function(){this.$(".js-name").toggleClass("is-invalid",!!this.model.getError())},_showPrivacy:function(a){this.killEvent(a),this.trigger("onPrivacy",this)},_onNameKeyDown:function(a){if(a.keyCode===c.ui.keyCode.ENTER)return a.preventDefault(),this._onSubmit(),!1},_onSubmit:function(a){a&&this.killEvent(a);var b={};this.model.isNameEditable()&&(b.name=f.stripHTML(this.$(".js-name").val())),this.model.isMetadataEditable()&&(b.description=f.removeHTMLEvents(this.$(".js-description").val()),b.tags=this.$(".js-tagsList").tagit("assignedTags"),this.model.isDataset()&&(b.source=this.$(".js-source").val(),b.attributions=this.$(".js-attributions").val(),b.display_name=this.$(".js-displayName").val())),this.model.set(b),this.model.isValid()&&this.trigger("onSubmit",this.model,this)},_destroyTags:function(){this.$(".js-tagsList").tagit("destroy")},clean:function(){this._destroyTags(),this.elder("clean")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],102:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({defaults:{name:"",description:"",tags:"",privacy:""},initialize:function(a,b){if(!(b&&b.vis&&b.user&&b.dataLayer))throw new Error("Visualization, user and dataLayer models are required");this.vis=b.vis,this.user=b.user,this.dataLayer=b.dataLayer;var c={name:this.vis.get("name"),description:this.vis.get("description"),tags:this.vis.get("tags"),privacy:this.vis.get("privacy")};this.vis.isVisualization()||(c.source=this.vis.get("source")||"",c.attributions=this.vis.get("attributions")||"",c.license=this.vis.get("license")||"",c.display_name=this.vis.get("display_name")||""),this.set(c),this.validationError="",this._initBinds()},_initBinds:function(){this.bind("valid",function(){this.validationError=""},this),this.bind("error",function(a,b){this.validationError=b},this)},_validate:function(a){var b=c.core.Model.prototype._validate.apply(this,arguments);return!!b&&(this.trigger("valid"),!0)},validate:function(a){if(a)return a.name?void 0:"Name can't be blank"},getError:function(){return this.validationError},isValid:function(){return!this.validate||!this.validate(this.attributes)&&""===this.validationError},isDataset:function(){return!this.vis.isVisualization()},isVisEditable:function(){return this.vis.permission.isOwner(this.user)},isAttributeEditable:function(a){if(this.vis.isVisualization())return this.isVisEditable();var b="name"===a&&this.dataLayer.isReadOnly();return!!this.dataLayer&&!(this.dataLayer&&(b||!this.dataLayer.permission.isOwner(this.user)))},isNameEditable:function(){return this.isAttributeEditable("name")},isMetadataEditable:function(){return this.isAttributeEditable("rest")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],103:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("../../view_factory"),g=a("./edit_vis_form_view"),h=a("./edit_vis_metadata_dialog_model"),i=a("../../view_helpers/random_quote"),j="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;b.exports=e.extend({events:e.extendEvents({"click .js-back":"_showForm"}),className:"Dialog is-opening EditVisMetadata",initialize:function(){if(this.elder("initialize"),!this.options.vis)throw new TypeError("vis model is required");this.vis=this.options.vis,this.user=this.options.user,this.dataLayer=this.options.dataLayer,this.model=new h({},{vis:this.vis,dataLayer:this.dataLayer,user:this.user}),this.template=d.templates.getTemplate("common/dialogs/edit_vis_metadata/edit_vis_metadata_dialog")},render:function(){return this.clearSubViews(),e.prototype.render.call(this),this.$(".content").addClass("Dialog-content--expanded"),this._initViews(),this},render_content:function(){var a=this.vis.isVisualization()?"map":"dataset";return this.template({visType:a,visTypeCapitalized:a.charAt(0).toUpperCase()+a.slice(1),isNameEditable:this.model.isNameEditable(),isMetadataEditable:this.model.isMetadataEditable()})},_initViews:function(){this._panes=new d.ui.common.TabPane({el:this.$(".js-content")});var a=new g({el:this.$(".js-form"),model:this.model,user:this.user,maxLength:this.options.maxLength});a.bind("onPrivacy",this._showPrivacy,this),a.bind("onSubmit",this._saveAttributes,this),this._panes.addTab("form",a.render()),this._panes.addTab("loading",f.createByTemplate("common/templates/loading",{title:"Saving new data...",quote:i()}).render()),this._panes.addTab("error",f.createByTemplate("common/templates/fail",{msg:'Sorry, something went wrong but you can get <button class="Button--link js-back">back to the form</button>.'}).render()),this._panes.active("form")},_saveAttributes:function(){var a=this,b=j.omit(this.model.toJSON(),"privacy"),c={name:this.vis.get("name"),description:this.vis.get("description"),tags:this.vis.get("tags")};this.model.isDataset()&&(c.source=this.vis.get("source"),c.attributions=this.vis.get("attributions"),c.license=this.vis.get("license")),j.isEmpty(this.vis.changedAttributes(b))?this.hide():(this._panes.active("loading"),this.vis.save(b,{success:function(){a.options.onDone&&a.options.onDone(c.name!==b.name),a.hide()},error:function(){a.vis.set(c),a._panes.active("error")}}))},_showPrivacy:function(){this.options.onShowPrivacy&&this.options.onShowPrivacy(),this.hide()},_showForm:function(){this._panes.active("form")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"../../view_helpers/random_quote":212,"../../views/base_dialog/view":213,"./edit_vis_form_view":101,"./edit_vis_metadata_dialog_model":102}],104:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,g=a("../../views/base_dialog/view");b.exports=g.extend({_CSV_FILTER:"SELECT * FROM (%%sql%%) as subq ",_MAX_SQL_GET_LENGTH:1e3,events:g.extendEvents({"click .js-option:not(.is-disabled)":"_export"}),formats:[{format:"csv",fetcher:"fetchCSV",geomRequired:!1,illustrationIconModifier:"IllustrationIcon--neutral"},{format:"shp",fetcher:"fetch",geomRequired:!0,illustrationIconModifier:"IllustrationIcon--magenta"},{format:"kml",fetcher:"fetch",geomRequired:!0,illustrationIconModifier:"IllustrationIcon--sunrise"},{format:"geojson",label:"geo json",fetcher:"fetch",geomRequired:!0,illustrationIconModifier:"IllustrationIcon--cyan"},{format:"svg",fetcher:"fetchSVG",geomRequired:!0,illustrationIconModifier:"IllustrationIcon--royalDark"}],initialize:function(){d.extend(this.options,{clean_on_hide:!0,table_id:this.model.id}),this.elder("initialize"),d.bindAll(this,"_export"),this.baseUrl=f.config.getSqlApiUrl(),this.model.bind("change:geometry_types",this.refresh,this)},getFormat:function(a){for(var b in this.formats)if(this.formats[b].format===a)return this.formats[b]},_export:function(a){this.killEvent(a);var b=e(a.currentTarget),c=b.data("format"),d=this.getFormat(c);this[d.fetcher](c)},getBaseOptions:function(){var a={};return a.filename=this.model.get("name"),this.options.user_data&&(a.api_key=this.options.user_data.api_key),a},getPlainSql:function(){return this.options.sql?sql=this.options.sql:this.model.sqlView?sql=this.model.sqlView.getSQL():sql="select * from "+this.model.get("name"),sql},getGeomFilteredSql:function(){var a=this.getPlainSql();return this.model.isGeoreferenced()?this._CSV_FILTER.replace(/%%sql%%/g,a):a},_fetch:function(a,b){if(this._showElAndHideRest(".js-preparing-download"),this.$(".format").val(a.format),this.$(".q").val(b),this.$(".filename").val(a.filename),this.$(".api_key").val(a.api_key),"csv"===a.format?this.$(".skipfields").val("the_geom_webmercator"):this.$(".skipfields").val("the_geom,the_geom_webmercator"),window.user_data&&window.user_data.email&&f.god.trigger("metrics","export_table",{email:window.user_data.email}),b.length<this._MAX_SQL_GET_LENGTH){var c=this.$("form").attr("action")+"?"+this.$("form").serialize();this._fetchGET(c)}else this.submit();this.$(".db").attr("disabled","disabled"),this.$(".skipfields").attr("disabled","disabled"),this.options.autoClose&&(this.close(),this.trigger("generating",this.$(".js-preparing-download").html()))},showError:function(a){this.$(".js-error").html(this.getTemplate("common/templates/fail")({msg:a})),this._showElAndHideRest(".js-error")},_fetchGET:function(a){function b(a){var b=null;try{var c=JSON.parse(a);b=c.error[0]}catch(c){a&&a.indexOf("error")!==-1&&(b="an error occurred")}return b}var c,d=this,e=window.open(a);e.onload=function(){clearInterval(c);var a=b(e.document.body.textContent);a?d.showError(a):d.close(),e.close()},window.focus(),c=setInterval(function(){(e.closed||e.document&&0===e.document.body.textContent.length)&&(d.close(),clearInterval(c))},100)},submit:function(){this.$("form").submit()},fetch:function(a){var b=this.getBaseOptions();b.format=a;var c=this.getPlainSql();this._fetch(b,c)},fetchCSV:function(){var a=this.getBaseOptions();a.format="csv";var b=this.getGeomFilteredSql();this.$(".skipfields").removeAttr("disabled"),this._fetch(a,b)},fetchSVG:function(){this.$(".db").removeAttr("disabled"),this.fetch("svg")},render_content:function(){var a=this.model.isGeoreferenced();return d.isBoolean(a)?this.getTemplate("common/dialogs/export/export_template")({preparingDownloadContent:this._renderLoadingContent("We are preparing your download. Depending on the size, it could take some time."),formats:this.formats,url:this.baseUrl,isGeoreferenced:a}):this._renderLoadingContent("Checking georeferences…")},refresh:function(){this.$(".content").html(this.render_content())},_renderLoadingContent:function(a){return this.getTemplate("common/templates/loading")({title:a,quote:f.editor.randomQuote()})},_showElAndHideRest:function(a){[".js-start",".js-preparing-download",".js-error"].forEach(function(b){this.$(b)[b===a?"show":"hide"]()},this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../views/base_dialog/view":213}],105:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("../../view_helpers/random_quote");b.exports=e.extend({events:e.extendEvents({"click .js-ok":"_confirm","click .js-download":"_download","click .js-cancel":"_abortExport"}),initialize:function(a){this.elder("initialize"),this._initBinds()},render_content:function(){var a=this.model.get("state");if("complete"!==a){if("failure"===a)return d.templates.getTemplate("common/templates/fail")({msg:"Export has failed"});if("pending"===a||"exporting"===a||"uploading"===a){var b=a.charAt(0).toUpperCase()+a.slice(1)+" ...";return this.getTemplate("common/templates/loading")({title:b,quote:f()})}return d.templates.getTemplate("common/dialogs/export_map/templates/confirm")}var c=window.open(this.model.get("url"));return void 0===c?d.templates.getTemplate("common/dialogs/export_map/templates/download"):(c.focus(),void this.close())},_confirm:function(){this.model.requestExport()},_download:function(){window.open(this.model.get("url")),window.focus(),this.close()},_abortExport:function(){this.model.cancelExport(),this.close()},_initBinds:function(){this.model.bind("change:state",function(){this.render()},this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_helpers/random_quote":212,"../../views/base_dialog/view":213}],106:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"AddColumn js-addField",events:{"click .js-addColumn":"_addColumn"},initialize:function(){this.model=new c.core.Model({state:"idle"}),this.table=this.options.table,
this.template=c.templates.getTemplate("common/dialogs/feature_data/add_column/add_column"),this._initBinds()},render:function(){return this.$el.html(this.template({state:this.model.get("state")})),this},_initBinds:function(){this.model.bind("change:state",this.render,this)},_addColumn:function(){var a=this;this.model.set("state","loading"),this.table.addColumn("column_"+(new Date).getTime(),"string",{success:function(b,c){a.trigger("newColumn",b,this),a.model.set("state","idle")},error:function(){a.model.set("state","error")}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],107:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("./form_view"),g=a("../../view_factory"),h=a("../../view_helpers/random_quote"),i="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;b.exports=e.extend({events:e.extendEvents({"click .js-back":"_showForm"}),className:"Dialog is-opening FeatureData",initialize:function(){if(this.elder("initialize"),!this.options.table)throw new TypeError("table is required");this.row=this.options.row,this.table=this.options.table,this.baseLayer=this.options.baseLayer,this.dataLayer=this.options.dataLayer,this.provider=this.options.provider,this.currentZoom=this.options.currentZoom,this.user=this.options.user,this._template=d.templates.getTemplate("common/dialogs/feature_data/feature_data_dialog")},render:function(){return this.clearSubViews(),e.prototype.render.call(this),this.$(".content").addClass("Dialog-content--expanded"),this._initViews(),this},render_content:function(){return this._template({featureType:this.row.getFeatureType(),quote:h()})},_initViews:function(){var a=this;this._panes=new d.ui.common.TabPane({el:this.$(".js-content")}),setTimeout(function(){a._createPreviewMap()},200),this.form=new f({el:this.$(".js-form"),table:this.table,row:this.row}),this.form.bind("onSubmit",this._changeAttributes,this),this.form.bind("onError",this._scrollToError,this),this._panes.addTab("form",this.form.render()),this.addView(this.form),this._panes.addTab("loading",g.createByTemplate("common/templates/loading",{title:"Saving new data...",quote:h()}).render()),this._panes.addTab("error",g.createByTemplate("common/templates/fail",{msg:'Sorry, something went wrong but you can get <button class="Button--link js-back">back to the form</button>.'}).render()),this._panes.active("form")},_scrollToError:function(a){this.$(".js-content").animate({scrollTop:this.$(".EditField-label[value='"+a.get("attribute")+"']").position().top-20})},_changeAttributes:function(a){var b=this,c=i.object(i.pluck(a,"attribute"),i.pluck(a,"value")),e={};this._panes.active("loading"),i.each(this.row.attributes,function(a,f){void 0!==c[f]||d.admin.Row.isReservedColumn(f)||"id"===f||b.row.unset(f),e[f]=a}),i.isEmpty(this.row.changedAttributes(c))?b._cancel():this.row.save(c,{success:function(){b._ok()},error:function(){b.row.set(e),b._panes.active("error")}})},_createPreviewMap:function(){var a=this,b=this.$(".js-map"),c=d.admin.LeafletMapView;if("googlemaps"===this.provider)var c=d.admin.GoogleMapsMapView;this.map=new d.admin.Map,this.mapView=new c({el:b,map:this.map,user:this.user}),this.baseLayer.set("attribution",""),this.map.addLayer(this.baseLayer),this.dataLayer.set("query","SELECT * FROM "+this.table.get("name")+" WHERE cartodb_id="+this.row.get("cartodb_id")),this.dataLayer.set("attribution",""),this.map.addLayer(this.dataLayer);var e=new d.admin.SQL({user:this.user.get("username"),api_key:this.user.get("api_key")});e.getBounds("SELECT * FROM "+this.table.get("name")+" WHERE cartodb_id="+this.row.get("cartodb_id")).done(function(b){b&&(b[0][0]===b[1][0]&&b[0][1]===b[1][1]?a.map.setCenter(b[0]):a.map.setBounds(b),a.map.setZoom(a.currentZoom))})},_showForm:function(){this._panes.active("form")},_ok:function(){this.options.onDone&&this.options.onDone(),this.elder("_ok")},_cancel:function(){this.elder("_cancel")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"../../view_helpers/random_quote":212,"../../views/base_dialog/view":213,"./form_view":110}],108:[function(a,b,c){(function(a){var c=("undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,"undefined"!=typeof window?window.Backbone:"undefined"!=typeof a?a.Backbone:null);b.exports=c.Collection.extend({isValid:function(){return!this.getInvalid()},getInvalid:function(){return this.find(function(a){return!a.isValid()})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],109:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("../../../edit_fields/string_field/string_field_view"),g=a("../../../edit_fields/number_field/number_field_view"),h=a("../../../edit_fields/boolean_field/boolean_field_view"),i=a("../../../edit_fields/date_field/date_field_view");b.exports=d.core.View.extend({events:{"keydown .js-columnName":"_onInputChange","focusout .js-columnName":"_onColNameChange"},_FIELD_VIEW:{string:f,number:g,boolean:h,date:i,"timestamp with time zone":i,"timestamp without time zone":i},initialize:function(){this.model=new d.core.Model({columnError:"",typeError:"",fieldError:""}),this.table=this.options.table,this.row=this.options.row,this.fieldModel=this.options.fieldModel,this.template=d.templates.getTemplate("common/dialogs/feature_data/form_field/form_field"),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this.template({type:this.fieldModel.get("type"),value:this.fieldModel.get("value"),attribute:this.fieldModel.get("attribute"),readOnly:this.fieldModel.get("readOnly"),typeError:this.model.get("typeError"),columnError:this.model.get("columnError")})),this._initViews(),this},_initBinds:function(){this.fieldModel.bind("change:readOnly",this.render,this),this.fieldModel.bind("change:type",this._onTypeChanged,this),this.add_related_model(this.fieldModel)},_initViews:function(){var a=this,b=this._FIELD_VIEW[this.fieldModel.get("type")]||this._FIELD_VIEW.string,c=new b({readOnly:this.fieldModel.get("readOnly"),model:this.fieldModel}).bind("onSubmit",function(a){this.trigger("onSubmit")},this);this.$(".js-editField").append(c.render().el),this.addView(c);var e=new d.common.TipsyTooltip({el:this.$(".js-editField"),title:function(){return a.fieldModel.getError()}});this.addView(e);var f=[this.fieldModel.get("type")].concat(_.filter(["string","boolean","number","date"],function(b){return a.table.isTypeChangeAllowed(a.fieldModel.get("attribute"),b)})),g=new d.forms.Combo({el:this.$(".js-fieldType"),model:this.fieldModel,property:"type",disabled:this.fieldModel.get("readOnly"),width:"85px",extra:f});this.$(".js-fieldType").append(g.render()),g.bind("change",function(a){this.fieldModel.set({value:null,type:a})},this),this.addView(g);var h=new d.common.TipsyTooltip({el:this.$(".js-fieldType"),title:function(){return a.model.get("typeError")}});this.addView(h);var h=new d.common.TipsyTooltip({el:this.$(".js-columnName"),title:function(){return a.model.get("columnError")}});this.addView(h)},_onTypeChanged:function(){var a=this,b=this.fieldModel.previous("type"),c=this.fieldModel.previous("value");this.model.set("typeError",""),this.fieldModel.set("readOnly",!0),this.table.changeColumnType(this.fieldModel.get("attribute"),this.fieldModel.get("type"),{success:function(){a._refreshRecordData(function(){a.fieldModel.set("readOnly",!1)})},error:function(){a.fieldModel.attributes.readOnly=!1,a.fieldModel.attributes.value=c,a.fieldModel.attributes.type=b;try{var d=JSON.parse(e.responseText).errors[0];a.model.set("typeError",d)}catch(a){}a.render()}})},_onInputChange:function(a){13===a.keyCode&&($(a.target).blur(),this.killEvent(a))},_onColNameChange:function(a){var b=this,c=$(a.target).val(),d=this.fieldModel.get("attribute");d!==c&&(this.fieldModel.set({attribute:c,readOnly:!0}),this.table.renameColumn(d,c,{success:function(a,c){b.model.set("columnError",""),b.fieldModel.set({attribute:c.name,readOnly:!1})},error:function(a,c){try{var e=JSON.parse(c.responseText).errors[0];b.model.set("columnError",e)}catch(a){}b.fieldModel.set({attribute:d,readOnly:!1})}}))},_refreshRecordData:function(a){var b=this;this.row.fetch({success:function(c){var d=c&&c.rows[0]&&c.rows[0][b.fieldModel.get("attribute")];b.fieldModel.set("value",d),a&&a()},error:function(){a&&a()}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../edit_fields/boolean_field/boolean_field_view":194,"../../../edit_fields/date_field/date_field_view":195,"../../../edit_fields/number_field/number_field_view":201,"../../../edit_fields/string_field/string_field_view":202}],110:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./form_field/form_field_view"),f=a("./add_column/add_column_view"),g=a("../../edit_fields/edit_field_model"),h=a("./form_collection"),i="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;b.exports=d.core.View.extend({events:{"click .js-submit":"_onSubmit",submit:"_onSubmit"},initialize:function(){this.model=new d.core.Model({state:"idle"}),this.table=this.options.table,this.row=this.options.row,this.collection=new h,this._generateCollection()},render:function(){return this.clearSubViews(),this._newColumn(),this.collection.each(this._renderField,this),this},_generateCollection:function(){var a=this,b=this.table.get("schema"),c=this.table.hiddenColumns;i.each(b,function(b){if(!i.contains(c,b[0])){var d=a._generateModel(b[0],b[1],a.row.get(b[0]));a.collection.add(d)}})},_generateModel:function(a,b,c){return new g({attribute:a,value:c,type:b})},_renderField:function(a){var b=new e({fieldModel:a,table:this.table,row:this.row});this.$(".js-addField").before(b.render().el),b.bind("onSubmit",this._onSubmit,this),this.addView(b)},_newColumn:function(){var a=new f({table:this.table});a.bind("newColumn",function(a){var b=this._generateModel(a.get("_name"),a.get("type"),null);this.collection.add(b),this._renderField(b)},this),this.addView(a),this.$el.append(a.render().el)},_onSubmit:function(a){this.killEvent(a);var b=this.collection.getInvalid();if(b)this.trigger("onError",b,this);else{var c=this.collection.toJSON();this.trigger("onSubmit",c,this)}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../edit_fields/edit_field_model":199,"./add_column/add_column_view":106,"./form_collection":108,"./form_field/form_field_view":109}],111:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f=a("./steps_view"),g=a("./row_model"),h=a("./default_footer_view"),i=a("../../view_factory");b.exports=d.core.Model.extend({TAB_LABEL:"Admin. Regions",KIND:"admin1",defaults:{step:0,columns:[]},initialize:function(a){if(!a.geocodeStuff)throw new Error("geocodeStuff is required");if(!a.columnsNames)throw new Error("columnsNames is required");if(!a.columns)throw new Error("columns is required")},createView:function(){return this._initRows(),this._setStateForFirstStep(),i.createByList([new f({title:"Select the column that has Administrative Regions",desc:"Georeference your data by country, state, province or municipality",model:this}),new h({model:this})])},assertIfCanContinue:function(){var a=0===this.get("step")?this._columnNameValue():this.get("geometryType");this.set("canContinue",!!a)},continue:function(){0===this.get("step")?this._setStateForSecondStep():this._geocode()},goBack:function(){this._setStateForFirstStep()},availableGeometriesFetchData:function(){return this.get("geocodeStuff").availableGeometriesFetchData(this.KIND,this._locationValue(),this._isLocationFreeText())},_setStateForFirstStep:function(){this.set({step:0,canGoBack:!1,canContinue:!1,hideFooter:!1}),this.get("rows").invoke("unset","value")},_setStateForSecondStep:function(){this.set({step:1,canGoBack:!0,canContinue:!1,hideFooter:!0,geometryType:""})},_initRows:function(){var a=new e.Collection([new g({comboViewClass:"Combo",label:"Select Your Region Name",placeholder:"Select column",data:this.get("columnsNames")}),new g({label:"Select Your Country Data",data:this.get("columns")})]);this.set("rows",a)},_geocode:function(){var a=this.get("geocodeStuff"),b=this._locationValue(),c=this._isLocationFreeText(),d=a.geocodingChosenData({type:"admin",kind:a.isLocationWorld(b,c,!0)?"admin0":this.KIND,location:b,column_name:this._columnNameValue(),geometry_type:this.get("geometryType")},c,!0);this.set("geocodeData",d)},_columnNameValue:function(){return this.get("rows").first().get("value")},_locationValue:function(){return this._location().get("value")},_isLocationFreeText:function(){return this._location().get("isFreeText")},_location:function(){return this.get("rows").last()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"./default_footer_view":114,"./row_model":122,"./steps_view":125}],112:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,"undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null),e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("./geometry_item_view"),g=a("../../view_factory"),h=a("../../view_helpers/random_quote");b.exports=e.core.View.extend({initialize:function(){this.availableGeometries=new e.admin.Geocodings.AvailableGeometries,this._initBinds(),this._fetchAvailableGeometries()},render:function(){return this.clearSubViews(),this.$el.html(this.getTemplate("common/dialogs/georeference/choose_geometry")()),d.each(this.availableGeometries.get("available_geometries")?this._createItemsViews():[this._createLoadingView()],this._appendView,this),this},_appendView:function(a){this.addView(a),this.$(".js-items").append(a.render().el)},_createItemsViews:function(){return[this._createItemView({type:"point",titles:{available:"Georeference your data with points",unavailable:"No point data available for your selection"}}),this._createItemView({type:"polygon",titles:{available:"Georeference your data with administrative regions",unavailable:"No polygon data available for your selection.",learnMore:"Sorry, we don't have polygons available for the datatype you are trying to geocode. For example, if you are geocoding placenames we can only give you points for where those places exist."}})]},_createItemView:function(a){return new f(d.extend({model:this.model,availableGeometries:this.availableGeometries},a))},_createLoadingView:function(){return g.createByTemplate("common/templates/loading",{title:"Checking for available geometries…",quote:h()})},_initBinds:function(){this.availableGeometries.bind("change:available_geometries",this.render,this),this.add_related_model(this.availableGeometries)},_fetchAvailableGeometries:function(){this.availableGeometries.fetch({data:this.model.availableGeometriesFetchData()})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"../../view_helpers/random_quote":212,"./geometry_item_view":116}],113:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,g=a("./steps_view"),h=a("./row_model"),i=a("./default_footer_view"),j=a("../../view_factory");b.exports=e.core.Model.extend({TAB_LABEL:"City Names",KIND:"namedplace",defaults:{step:0,columns:[]},initialize:function(a){if(!a.geocodeStuff)throw new Error("geocodeStuff is required");if(!a.columnsNames)throw new Error("columnsNames is required");if(!a.columns)throw new Error("columns is required")},createView:function(){return this._initRows(),this._setStateForFirstStep(),j.createByList([new g({title:"Select the column that contains the City's Name",desc:"No matter the type of the columns you select, we will transform them to number for georeferencing.",model:this}),new i({model:this})])},assertIfCanContinue:function(){var a=0===this.get("step")?this._columnNameValue():this.get("geometryType");this.set("canContinue",!!a)},continue:function(){0===this.get("step")?this._setStateForSecondStep():this._geocode()},goBack:function(){this._setStateForFirstStep()},availableGeometriesFetchData:function(){return this.get("geocodeStuff").availableGeometriesFetchData(this.KIND,this._locationValue(),this._isLocationFreeText())},_setStateForFirstStep:function(){this.set({step:0,canGoBack:!1,canContinue:!1,hideFooter:!1})},_setStateForSecondStep:function(){this.set({step:1,canGoBack:!0,canContinue:!1,hideFooter:!0,geometryType:""})},_geocode:function(){var a=this.get("geocodeStuff").geocodingChosenData({type:"city",kind:this.KIND,location:this._locationValue(),column_name:this._columnNameValue(),geometry_type:this.get("geometryType")},this._isLocationFreeText(),!0),b=this._regionValue();d.isEmpty(b)||(a.region=b,a.region_text=this._isRegionFreeText()),this.set("geocodeData",a)},_initRows:function(){var a=new f.Collection([new h({comboViewClass:"Combo",label:"In which column are your city names stored?",placeholder:"Select column",data:this.get("columnsNames")}),new h({label:"Admin. Region where city's located, if known",data:this.get("columns")}),new h({label:"Country where city's located, if known",data:this.get("columns")})]);this.set("rows",a)},_columnNameValue:function(){return this.get("rows").first().get("value")},_regionValue:function(){return this._region().get("value")},_isRegionFreeText:function(){return this._region().get("isFreeText")},_region:function(){return this.get("rows").at(1)},_locationValue:function(){return this._location().get("value")},_isLocationFreeText:function(){return this._location().get("isFreeText")},_location:function(){return this.get("rows").last()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"./default_footer_view":114,"./row_model":122,"./steps_view":125}],114:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({events:{"click .js-force-all-rows":"_onClickForceAllRows"},initialize:function(){this._initBinds()},render:function(){return this.$el.html(this.getTemplate("common/dialogs/georeference/default_footer")()),this},_initBinds:function(){this.model.bind("change:canContinue",this._onChangeCanContinue,this),this.model.bind("change:hideFooter",this._onChangeHideFooter,this);var a=this._geocodeStuff();a.bind("change:forceAllRows",this._onChangeForceAllRows,this),this.add_related_model(a)},_onChangeCanContinue:function(a,b){this.$(".ok").toggleClass("is-disabled",!b)},_onChangeHideFooter:function(a,b){this.$el.toggle(!b)},_onChangeForceAllRows:function(a,b){this.$(".js-force-all-rows button").toggleClass("is-checked",!!b)},_onClickForceAllRows:function(a){this.killEvent(a);var b=this._geocodeStuff();b.set("forceAllRows",!b.get("forceAllRows"))},_geocodeStuff:function(){return this.model.get("geocodeStuff")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],115:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.core.Model.extend({defaults:{tableName:void 0,forceAllRows:!1},initialie:function(a){if(!a.tableName)throw new Error("tableName is required")},availableGeometriesFetchData:function(a,b,d){if(!a)throw new Error("kind is required");var e={kind:a};return c.isEmpty(b)?e.free_text="World":d?e.free_text=b:(e.column_name=b,e.table_name=this.get("tableName")),e},isLocationWorld:function(a,b,c){var d=void 0===a&&c,e=""===a||d;return e||!!b&&a.search("world")!==-1},geocodingChosenData:function(a,b,d){return a.table_name=this.get("tableName"),this.isLocationWorld(a.location,b,d)?(a.location="world",a.text=!0):c.isBoolean(b)&&b&&(a.text=!0),this.get("forceAllRows")&&(a.force_all_rows=!0),a}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],116:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.core.View.extend({className:"OptionCard OptionCard--blocky",events:{click:"_onClick"},initialize:function(){this.options.type||d.log.error("type is required"),this.options.titles||d.log.error("titles is required"),this.options.titles.available||d.log.error("titles.available is required"),this.options.titles.unavailable||d.log.error("titles.unavailable is required"),this.availableGeometries=this.options.availableGeometries,this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this.getTemplate("common/dialogs/georeference/geometry_item_"+this.options.type)({})),this._onChangeAvailableGeometries(),this},_initBinds:function(){this.availableGeometries.bind("change:available_geometries",this._onChangeAvailableGeometries,this),this.add_related_model(this.availableGeometries),this.model.bind("change:geometryType",this._onChangeGeometryType,this)},_onChangeGeometryType:function(a,b){this.$el.toggleClass("is-selected",b===this.options.type)},_onChangeAvailableGeometries:function(){var a=this._isAvailable();this.$el.toggleClass("OptionCard--static",!a),this.$(".js-icon").toggleClass("u-disabled",!a),this.$(".js-warning").toggle(!a),this.$(".js-title").toggleClass("u-disabled",!a).text(this.options.titles[a?"available":"unavailable"])},_onClick:function(a){this.killEvent(a),this._isAvailable()&&(this.model.set("geometryType",this.options.type),this.model.continue())},_isAvailable:function(){return c.contains(this.availableGeometries.get("available_geometries"),this.options.type)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],117:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,g=a("./lon_lat_columns_model"),h=a("./city_names_model"),i=a("./admin_regions_model"),j=a("./postal_codes_model"),k=a("./ip_addresses_model"),l=a("./street_addresses/street_addresses_model"),m=a("./geocode_stuff_model"),n=a("./user_geocoding_model");b.exports=f.core.Model.extend({_EXCLUDED_COLUMN_NAMES:["cartodb_id","the_geom","updated_at","created_at","cartodb_georef_status"],_ALLOWED_COLUMN_TYPES:["string","number","boolean","date"],defaults:{options:void 0},initialize:function(a){if(!a.table)throw new Error("table is required");if(!a.user)throw new Error("user is required");this._initGeocodeStuff(),this._initOptions()},changedSelectedTab:function(a){this.get("options").chain().without(a).each(this._deselect)},createView:function(){return this._selectedTabModel().createView()},canContinue:function(){return this._selectedTabModel().get("canContinue")},continue:function(){this.canContinue()&&this._selectedTabModel().continue()},canGoBack:function(){return this._selectedTabModel().get("canGoBack")},goBack:function(){this.canGoBack()&&this._selectedTabModel().goBack()},_selectedTabModel:function(){return this.get("options").find(this._isSelected)},_columnsNames:function(){return e.chain(this.get("table").get("schema")).filter(this._isAllowedColumnName,this).map(this._columnName).value()},_filteredColumns:function(){var a=this.get("table");return e.chain(a.get("original_schema")||a.get("schema")).filter(this._isAllowedColumnName,this).filter(this._isAllowedColumnType,this).map(this._inverColumnRawValues).value()},_inverColumnRawValues:function(a){var b=a[1],c=a[0];return[b,c]},_isAllowedColumnName:function(a){return!e.contains(this._EXCLUDED_COLUMN_NAMES,this._columnName(a))},_isAllowedColumnType:function(a){return e.contains(this._ALLOWED_COLUMN_TYPES,this._columnType(a))},_columnName:function(a){return a[0]},_columnType:function(a){return a[1]},_isSelected:function(a){return a.get("selected")},_deselect:function(a){a.set("selected",!1)},_initGeocodeStuff:function(){var a=new m({tableName:this.get("table").get("id")});this.set("geocodeStuff",a)},_initOptions:function(){var a=this.get("geocodeStuff"),b=this._columnsNames(),c=this._filteredColumns();this.set("options",new d.Collection([new g({geocodeStuff:a,columnsNames:b,selected:!0}),new h({geocodeStuff:a,columnsNames:b,columns:c}),new i({geocodeStuff:a,columnsNames:b,columns:c}),new j({geocodeStuff:a,columnsNames:b,columns:c}),new k({geocodeStuff:a,columnsNames:b,columns:c}),new l({geocodeStuff:a,columns:c,isGoogleMapsUser:this._isGmeGeocoderEnabled(),userGeocoding:this._userGeocoding(),lastBillingDate:this.get("user").get("billing_period"),estimation:new f.admin.Geocodings.Estimation({id:this.get("table").getUnquotedName()})})])),this.get("user").featureEnabled("georef_disabled")?this._disableGeorefTabs():this._maybeDisabledStreetAddresses()},_disableGeorefTabs:function(){e.each(this._georefTabs(),this._disableTab.bind(this,"You don't have this option available in this version"))},_georefTabs:function(){return this.get("options").rest()},_maybeDisabledStreetAddresses:function(){var a=this._isGmeGeocoderEnabled();this._isGoogleMapsEnabled()?a||this._disableTab("Google Maps geocoder is not configured. Please contact us at sales@carto.com",this._streetAddrTabModel()):a?this._disableTab("Geocoder is not configured properly. Please contact us at sales@carto.com",this._streetAddrTabModel()):this._userGeocoding().hasQuota()||this._disableTab("Your geocoding quota is not defined. Please contact us at sales@carto.com",this._streetAddrTabModel())},_userGeocoding:function(){return new n(this.get("user").get("geocoding"))},_isGoogleMapsEnabled:function(){return this._hasUserActionEnabled("google_maps_enabled")},_isGmeGeocoderEnabled:function(){return this._hasUserActionEnabled("google_maps_geocoder_enabled")},_hasUserActionEnabled:function(a){return!!this.get("user").get("actions")[a]},_streetAddrTabModel:function(){return this.get("options").find(function(a){return a instanceof l})},_disableTab:function(a,b){b.set("disabled",a)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./admin_regions_model":111,"./city_names_model":113,"./geocode_stuff_model":115,"./ip_addresses_model":119,"./lon_lat_columns_model":120,"./postal_codes_model":121,"./street_addresses/street_addresses_model":128,"./user_geocoding_model":133}],118:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,g=a("../../views/base_dialog/view.js"),h=a("./georeference_model"),i=a("./tab_item_view");b.exports=g.extend({events:g.extendEvents({"click .js-back:not(.is-disabled)":"_onGoBack"}),initialize:function(){if(!this.options.user)throw new Error("user is required");this.options.clean_on_hide=!0,this.options.enter_to_confirm=!0,this.elder("initialize"),this.model=new h({table:this.options.table,user:this.options.user}),this._initViews(),this._initBinds()},render:function(){return g.prototype.render.apply(this,arguments),this.$(".content").addClass("Dialog-contentWrapper"),this},render_content:function(){var a=this.model.get("table"),b=d(this.getTemplate("common/dialogs/georeference/georeference")({hasNoGeoferencedData:!a.isGeoreferenced()&&a.data().length>0}));return this._renderTabs(b.find(".js-tabs")),this._renderTabContent(b),b},ok:function(){this.model.continue()},_initViews:function(){this._tabViews=this.model.get("options").map(this._createDefaultTabView,this)},_createDefaultTabView:function(a){var b=new i({model:a});return this.addView(b),b},_renderTabs:function(a){a.append.apply(a,e.map(this._tabViews,this._getRenderedElement))},_getRenderedElement:function(a){return a.render().el},_renderTabContent:function(a){this._tabContentView&&this._tabContentView.clean(),this._tabContentView=this.model.createView(),this.addView(this._tabContentView),a.find(".js-tab-content").html(this._tabContentView.render().el)},_initBinds:function(){var a=this.model.get("options");a.bind("change:selected",this._onChangeSelectedTab,this),a.bind("change:canGoBack",this._onChangeCanGoBack,this),a.bind("change:geocodeData",this._onChangeGeocodeData,this),this.add_related_model(a)},_onChangeSelectedTab:function(a,b){b&&(this.model.changedSelectedTab(a),this._renderTabContent(this.$el))},_onChangeCanGoBack:function(a,b){this.$(".js-back").toggle(!!b)},_onGoBack:function(){this.model.goBack()},_onChangeGeocodeData:function(a,b){f.god.trigger("geocodingChosen",b),this.close()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../views/base_dialog/view.js":213,"./georeference_model":117,"./tab_item_view":132}],119:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f=a("./row_model"),g=a("./rows_view"),h=a("./default_footer_view"),i=a("../../view_factory");b.exports=d.core.Model.extend({TAB_LABEL:"IP Addresses",initialize:function(a){if(!a.geocodeStuff)throw new Error("geocodeStuff is required");if(!a.columnsNames)throw new Error("columnsNames is required")},createView:function(){return this._initRows(),this.set({canContinue:!1,hideFooter:!1}),i.createByList([i.createByTemplate("common/dialogs/georeference/default_content_header",{title:"Select the column that that contains the IP's name",desc:"Convert IP address into geographical locations."}),new g({model:this}),new h({model:this})])},assertIfCanContinue:function(){this.set("canContinue",!!this._columnNameValue())},continue:function(){var a=this.get("geocodeStuff").geocodingChosenData({type:"ip",kind:"ipaddress",column_name:this._columnNameValue(),geometry_type:"point"});this.set("geocodeData",a)},_initRows:function(){var a=new e.Collection([new f({comboViewClass:"Combo",label:"In which column are your IP addresses stored?",placeholder:"Select column",data:this.get("columnsNames")})]);this.set("rows",a)},_columnNameValue:function(){return this.get("rows").first().get("value")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"./default_footer_view":114,"./row_model":122,"./rows_view":124}],120:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f=a("./row_model"),g=a("./rows_view"),h=a("./default_footer_view"),i=a("../../view_factory");b.exports=d.core.Model.extend({TAB_LABEL:"Lon/Lat Columns",defaults:{columnsNames:[]},initialize:function(a){if(!a.geocodeStuff)throw new Error("geocodeStuff is required");if(!a.columnsNames)throw new Error("columnsNames is required")},createView:function(){return this.set({canContinue:!1,hideFooter:!1}),this._initRows(),i.createByList([i.createByTemplate("common/dialogs/georeference/default_content_header",{title:"Select the columns containing your Lon/Lat columns",desc:"The selected columns are transformed into georeference coordinates."
}),new g({model:this}),new h({model:this})])},assertIfCanContinue:function(){var a=this.get("rows").all(function(a){return!!a.get("value")});this.set("canContinue",a)},continue:function(){var a=this.get("geocodeStuff").geocodingChosenData({type:"lonlat",longitude:this.get("rows").first().get("value"),latitude:this.get("rows").last().get("value")});this.set("geocodeData",a)},_initRows:function(){var a=new e.Collection([new f({comboViewClass:"Combo",label:"Select your Longitude",placeholder:"Select column",property:"longitude",data:this.get("columnsNames")}),new f({comboViewClass:"Combo",label:"Select your Latitude",placeholder:"Select column",property:"latitude",data:this.get("columnsNames")})]);this.set("rows",a)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"./default_footer_view":114,"./row_model":122,"./rows_view":124}],121:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f=a("./row_model"),g=a("./steps_view"),h=a("./default_footer_view"),i=a("../../view_factory");b.exports=d.core.Model.extend({TAB_LABEL:"Postal Codes",KIND:"postalcode",defaults:{step:0,columns:[]},initialize:function(a){if(!a.geocodeStuff)throw new Error("geocodeStuff is required");if(!a.columnsNames)throw new Error("columnsNames is required");if(!a.columns)throw new Error("columns is required")},createView:function(){return this._initRows(),this._setStateForFirstStep(),i.createByList([new g({title:"Select the column that has the Postal Codes",desc:"Georeference your data by postal codes.",model:this}),new h({model:this})])},assertIfCanContinue:function(){var a=0===this.get("step")?this._columnNameValue():this.get("geometryType");this.set("canContinue",!!a)},continue:function(){0===this.get("step")?this._setStateForSecondStep():this._geocode()},goBack:function(){this._setStateForFirstStep()},availableGeometriesFetchData:function(){return this.get("geocodeStuff").availableGeometriesFetchData(this.KIND,this._locationValue(),this._isLocationFreeText())},_setStateForFirstStep:function(){this.set({step:0,canGoBack:!1,canContinue:!1,hideFooter:!1})},_setStateForSecondStep:function(){this.set({step:1,canGoBack:!0,canContinue:!1,hideFooter:!0,geometryType:""})},_geocode:function(){var a=this.get("geocodeStuff").geocodingChosenData({type:"postal",kind:this.KIND,location:this._locationValue(),column_name:this._columnNameValue(),geometry_type:this.get("geometryType")},this._isLocationFreeText(),!0);this.set("geocodeData",a)},_initRows:function(){var a=new e.Collection([new f({comboViewClass:"Combo",label:"In which column are your postal codes stored?",placeholder:"Select column",data:this.get("columnsNames")}),new f({label:"Country where postal codes are located, if known",data:this.get("columns")})]);this.set("rows",a)},_columnNameValue:function(){return this.get("rows").first().get("value")},_locationValue:function(){return this._location().get("value")},_isLocationFreeText:function(){return this._location().get("isFreeText")},_location:function(){return this.get("rows").last()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"./default_footer_view":114,"./row_model":122,"./steps_view":125}],122:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./row_view");b.exports=d.core.Model.extend({defaults:{comboViewClass:"CustomTextCombo",label:"",placeholder:"Select column or type it",isFreeText:!1,data:[]},createView:function(){return new e({model:this})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./row_view":123}],123:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"Form-row Form-row--step",initialize:function(){this._initViews(),this._initBinds()},render:function(){return this.$el.html(this.getTemplate("common/dialogs/georeference/row")({label:this.model.get("label")})),this.$(".js-select").append(this._selectView.render().el),this},_initBinds:function(){this.model.bind("change:value",this._onChangeValue,this)},_initViews:function(){this._selectView=new(c.forms[this.model.get("comboViewClass")])({model:this.model,placeholder:this.model.get("placeholder"),disabled:this.model.get("disabled"),extra:this.model.get("data"),className:"Select",width:"100%",property:"value",text:"isFreeText"}),this.addView(this._selectView),this._selectView.render()._changeSelection()},_onChangeValue:function(a,b){this.$el.toggleClass("is-done",!!b)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],124:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({initialize:function(){this._initBinds()},render:function(){return this.clearSubViews(),this._renderRows(),this},_initBinds:function(){var a=this.model.get("rows");a.bind("change",this.model.assertIfCanContinue,this.model),this.add_related_model(a)},_renderRows:function(){this.model.get("rows").chain().map(this._createRowView,this).map(this._appendRowToDOM,this)},_createRowView:function(a){var b=a.createView();return this.addView(b),b},_appendRowToDOM:function(a){this.$el.append(a.render().el)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],125:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./rows_view"),f=a("./choose_geometry_view"),g=a("../../view_factory");b.exports=d.core.View.extend({initialize:function(){this._initBinds()},render:function(){return this.clearSubViews(),1===this.model.get("step")?this._renderChooseGeometry():(this._renderHeader(),this._renderRows()),this},_renderHeader:function(){this._appendView(g.createByTemplate("common/dialogs/georeference/default_content_header",{title:this.options.title,desc:this.options.desc}))},_renderRows:function(){this._appendView(new e({model:this.model}))},_renderChooseGeometry:function(){this._appendView(new f({model:this.model}))},_appendView:function(a){this.addView(a),this.$el.append(a.render().$el)},_initBinds:function(){this.model.bind("change:step",this.render,this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"./choose_geometry_view":112,"./rows_view":124}],126:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.core.View.extend({className:"Georeference-estimation",initialize:function(){if(!c.isBoolean(this.options.hasHardLimit))throw new Error("hasHardLimit is required");if(!this.options.userGeocoding)throw new Error("userGeocoding is required");this._initBinds()},render:function(){var a=this.model.get("estimation"),b=this.model.get("rows");return this.$el.html(this.getTemplate("common/dialogs/georeference/street_addresses/estimation")({hasEstimation:void 0!==a&&void 0!==b,hasHardLimit:this.options.hasHardLimit,costInCredits:this.model.costInCredits(),costInDollars:this.model.costInDollars(),blockPriceInDollars:this.options.userGeocoding.blockPriceInDollars(),hasRows:0!==b})),this},_initBinds:function(){this.model.bind("change error",this.render,this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],127:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"Georeference-quota",render:function(){return this.$el.html(this.getTemplate("common/dialogs/georeference/street_addresses/quota")({quotaLeft:this.model.quotaLeftThisMonth(),quotaUsedInPct:this.model.quotaUsedThisMonthInPct()})),this}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],128:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null,g="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,h=a("./street_addresses_view"),i=a("../row_model"),j=a("./street_row_model");b.exports=g.core.Model.extend({TAB_LABEL:"Street Addresses",MAX_STREET_ROWS:3,defaults:{columnsNames:[],columns:[],estimation:void 0},initialize:function(a){if(!a.geocodeStuff)throw new Error("geocodeStuff is required");if(!d.isBoolean(a.isGoogleMapsUser))throw new Error("isGoogleMapsUser is required");if(!a.userGeocoding)throw new Error("userGeocoding is required");if(!a.columns)throw new Error("columns is required");if(!a.estimation)throw new Error("estimation is required")},createView:function(){return this.set({canContinue:!1,hideFooter:!1,mustAgreeToTOS:!1,confirmTOS:!1,hasAgreedToTOS:!1}),this._initRows(),new h({model:this})},isDisabled:function(){return!this.get("isGoogleMapsUser")&&this.get("userGeocoding").hasReachedMonthlyQuota()},showCostsInfo:function(){return!this.get("isGoogleMapsUser")},getFormatterItemByRow:function(a){var b=a.get("value");if(b)return a.get("isFreeText")?b.trim():"{"+b+"}"},assertIfCanAddMoreRows:function(){var a=this.get("rows").filter(this._isStreetRow);d.invoke(a,"set","canAddRow",!1),d.last(a).set("canAddRow",a.length<this.MAX_STREET_ROWS)},daysLeftToNextBilling:function(){var a=f().startOf("day");return f(this.get("lastBillingDate")).add(30,"days").diff(a,"days")},continue:function(){var a=this.get("mustAgreeToTOS");if(this._hasAgreedToTOS()||!a){var b=this.get("geocodeStuff").geocodingChosenData({type:"address",kind:"high-resolution",formatter:this.get("formatter")});this.set("geocodeData",b)}else a&&this.set("confirmTOS",!0)},hasHardLimit:function(){return!!this.get("userGeocoding").get("hard_limit")},_hasAgreedToTOS:function(){return this.get("mustAgreeToTOS")&&this.get("hasAgreedToTOS")},_isStreetRow:function(a){return a instanceof j},_initRows:function(){var a=this.get("columns"),b=this.isDisabled(),c=new e.Collection([new j({label:"Which column are your street addresses stored in?",data:a,canAddRow:!0,disabled:b}),new i({label:"State/province where address is located, if known",data:a,disabled:b}),new i({label:"Country where street address is located, if known",data:a,disabled:b})]);this.set("rows",c)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../row_model":122,"./street_addresses_view":129,"./street_row_model":130}],129:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("../../../view_factory"),g=a("./estimation_view"),h=a("./quota_view"),i=a("../default_footer_view"),j=a("../../../view_helpers/pluralize_string");b.exports=d.core.View.extend({initialize:function(){this._initBinds(),this._fetchEstimation()},render:function(){this.clearSubViews(),this.$el.html(this.getTemplate("common/dialogs/georeference/street_addresses/street_addresses")({})),this._renderHeader(),this._renderRows();var a=this.model.showCostsInfo();return a&&(this._renderEstimation(),this._renderQuota()),this.$(".js-costs-info").toggle(!!a),this._renderFooter(),this},_renderHeader:function(){var a=f.createByTemplate("common/dialogs/georeference/default_content_header",{title:"Select the column(s) that has your street address",desc:"Use this option if you need high resolution geocoding of your street adresses data."});this.addView(a),this.$el.prepend(a.render().$el)},_renderRows:function(){this._$rows().toggleClass("u-disabled",!!this.model.isDisabled()),this.model.get("rows").chain().map(this._createRowView,this).map(this._appendRowToDOM,this)},_renderEstimation:function(){var a=new g({model:this.model.get("estimation"),userGeocoding:this.model.get("userGeocoding"),hasHardLimit:this.model.hasHardLimit()});this.addView(a),this.$(".js-estimation").append(a.render().el)},_renderQuota:function(){var a=new h({model:this.model.get("userGeocoding")});this.addView(a),this.$(".js-quota").append(a.render().el)},_renderFooter:function(){var a;if(this.model.isDisabled())a=this.getTemplate("common/dialogs/georeference/street_addresses/upgrade_footer")({cartodb_com_hosted:d.config.get("cartodb_com_hosted"),upgradeURL:d.config.get("upgrade_url"),pluralizeString:j,daysLeftToNextBilling:this.model.daysLeftToNextBilling()});else{var b=new i({model:this.model});this.addView(b),a=b.render().$el}this.$el.append(a)},_createRowView:function(a){var b=a.createView();return this.addView(b),b},_appendRowToDOM:function(a){this._$rows().append(a.render().el)},_$rows:function(){return this.$(".js-rows")},_initBinds:function(){var a=this.model.get("rows");a.bind("change",this._onChangeRows,this),a.bind("add",this._onAddRow,this),this.add_related_model(a);var b=this.model.get("estimation");b.bind("change",this._onChangeEstimation,this),b.bind("error",this._onEstimationError,this),this.add_related_model(b);var c=this.model.get("geocodeStuff");c.bind("change:forceAllRows",this._onChangeForceAllRows,this),this.add_related_model(c),this.model.bind("change:confirmTOS",this._onChangeConfirmTOS,this),this.model.bind("change:isGoogleMapsUser",this.render,this)},_onChangeForceAllRows:function(){this.model.get("estimation").reset(),this._fetchEstimation()},_fetchEstimation:function(){this.model.showCostsInfo()&&this.model.get("estimation").fetch({data:{force_all_rows:this.model.get("geocodeStuff").get("forceAllRows")}})},_onChangeRows:function(){var a=this.model.get("rows").chain().map(this.model.getFormatterItemByRow).compact().value().join(", ");this.model.set({formatter:a,canContinue:!e.isEmpty(a)})},_onAddRow:function(a,b,c){var d=this._createRowView(a);this.$(".js-rows").children().eq(c.index).before(d.render().el),this.model.assertIfCanAddMoreRows()},_onChangeEstimation:function(){var a=this.model.get("estimation").mayHaveCost()&&!this.model.hasHardLimit();this.model.set("mustAgreeToTOS",a)},_onEstimationError:function(){this.model.get("estimation").set({estimation:-1,rows:-1})},_onChangeConfirmTOS:function(a,b){if(b){this.model.set("confirmTOS",!1,{silent:!0});var c=f.createDialogByTemplate("common/dialogs/georeference/street_addresses/confirm_tos",{costInDollars:this.model.get("estimation").costInDollars()},{triggerDialogEvents:!1,enter_to_confirm:!0,clean_on_hide:!1});c.ok=this._onAgreeToTOS.bind(this),this.addView(c),c.appendToBody()}},_onAgreeToTOS:function(){this.model.set("hasAgreedToTOS",!0),this.model.continue()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_factory":209,"../../../view_helpers/pluralize_string":211,"../default_footer_view":114,"./estimation_view":126,"./quota_view":127}],130:[function(a,b,c){var d=a("../row_model"),e=a("./street_row_view");b.exports=d.extend({createView:function(){return new e({model:this})},addRow:function(){var a=new this.constructor({label:"Additional information to complete street address",data:this.get("data")});this.collection.add(a,{at:this._indexAfterThisModel()})},_indexAfterThisModel:function(){return this.collection.indexOf(this)+1}})},{"../row_model":122,"./street_row_view":131}],131:[function(a,b,c){var d=a("../row_view");b.exports=d.extend({events:d.extendEvents({"click .js-add-row":"_onClickAddRow"}),initialize:function(){d.prototype.initialize.apply(this,arguments),this._initStreetRowBinds()},render:function(){return d.prototype.render.call(this),this.model.get("disabled")||this.$el.append(this.getTemplate("common/dialogs/georeference/street_addresses/row_add_row")()),this},_initStreetRowBinds:function(){this.model.bind("change:canAddRow",this._onChangeCanAddRow,this)},_onClickAddRow:function(a){this.killEvent(a),this.model.addRow()},_onChangeCanAddRow:function(a,b){this.$(".js-add-row").toggle(!!b)}})},{"../row_view":123}],132:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.core.View.extend({tagName:"li",className:"Filters-typeItem Filters-typeItem--moreMargins",events:{"click .js-btn":"_onClick"},initialize:function(){this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this.getTemplate("common/dialogs/georeference/tab_item")({label:this.model.TAB_LABEL,isDisabled:this.model.get("disabled")})),this._onChangeSelected(this.model,this.model.get("selected")),this._onChangeDisabled(this.model,this.model.get("disabled")),this._createDisabledTooltip(),this},_initBinds:function(){this.model.bind("change:selected",this._onChangeSelected,this),this.model.bind("change:disabled",this._onChangeDisabled,this)},_onChangeSelected:function(a,b){this.$("button").toggleClass("is-selected",!!b)},_onChangeDisabled:function(a,b){b?this.undelegateEvents():this.delegateEvents()},_createDisabledTooltip:function(){var a=this.model.get("disabled");c.isEmpty(a)||this.addView(new d.common.TipsyTooltip({el:this.$(".js-btn"),fallback:a,gravity:"s",offset:-30}))},_onClick:function(a){this.killEvent(a),this.model.set("selected",!0)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],133:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({defaults:{quota:null,block_price:null,monthly_use:0,hard_limit:!1},hasQuota:function(){var a=this.get("quota");return null!==a&&void 0!==a&&""!==a},hasReachedMonthlyQuota:function(){return this.get("hard_limit")&&this._maybe(function(a,b){return b>=a},!1)},quotaLeftThisMonth:function(){return this._maybe(function(a,b){return Math.max(a-b,0)},0)},quotaUsedThisMonthInPct:function(){return this._maybe(function(a,b){return 100*b/a},0)},blockPriceInDollars:function(){return Math.ceil(this.get("block_price")/100)},_maybe:function(a,b){var c=this.get("monthly_use"),d=this.get("quota");return c>=0&&d>=0?a(d,c):b}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],134:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof a?a.cdb.Utils:null;b.exports=c.core.View.extend({events:{"click .js-toggler":"_onLumpSumClick"},initialize:function(){this.user=this.options.user,this.model=new c.core.Model({lumpSum:!1}),this.template=c.templates.getTemplate("common/dialogs/limits_reach/limits_reached_content"),this._initBinds()},render:function(){var a=c.config.get("upgrade_url")&&!c.config.get("cartodb_com_hosted")&&!this.user.isInsideOrg(),b=this.user.get("account_type"),e=_.compact(this.collection.map(function(a,c){var e=a.get("price"),f=a.get("title");return{name:f.toLowerCase(),price:d.formatNumber(e),isUserPlan:f.search(b)!==-1,lumpSumPrice:"0"==e?"0":d.formatNumber(a.get("lump_sum").price),quota:d.readablizeBytes(a.get("bytes_quota")).replace(/\.00/g,"").replace(" ",""),layers:a.get("max_layers"),privateMaps:a.get("private_tables"),removableBrand:a.get("removable_brand")}}));return this.$el.html(this.template({lumpSum:this.model.get("lumpSum"),itemHighlighted:this._getHighlighted(e,this.user.get("account_type")),canUpgrade:a,availablePlans:e,organizationAdmin:this.user.isOrgOwner(),organizationUser:this.user.isInsideOrg()&&!this.user.isOrgOwner(),customHosted:c.config.get("cartodb_com_hosted"),upgradeURL:c.config.get("upgrade_url"),canStartTrial:this.user.canStartTrial()})),this},_initBinds:function(){this.model.bind("change",this.render,this),this.collection.bind("reset",this.render,this),this.add_related_model(this.collection)},_getHighlighted:function(a,b){for(var c=0,d=0,e=a.length;d<e;d++)a[d].name.search(b)!==-1&&(c=d);return c<2?2:3},_onLumpSumClick:function(){this.model.set("lumpSum",!this.model.get("lumpSum"))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],135:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./user_plans_collection"),f=a("./limits_reached_content_view"),g=a("../../views/base_dialog/view"),h=a("../../view_helpers/random_quote"),i=a("../../view_factory");b.exports=g.extend({initialize:function(){this.user=this.options.user,this.userPlans=new e(null,{user:this.user}),this.elder("initialize"),this._initBinds()},render_content:function(){var a=d.config.get("upgrade_url")&&!d.config.get("cartodb_com_hosted")&&!this.user.isInsideOrg(),b=this.user.isInsideOrg()&&this.user.organization.get("owner").email||"",c=$(d.templates.getTemplate("common/dialogs/limits_reach/limits_reached")({canUpgrade:a,organizationAdminEmail:b,organizationAdmin:this.user.isOrgOwner(),organizationUser:this.user.isInsideOrg()&&!this.user.isOrgOwner(),layersCount:this.user.getMaxLayers(),customHosted:d.config.get("cartodb_com_hosted")}));return this._initViews(c),c},_initBinds:function(){this.userPlans.bind("error",function(){this._panes.active("error")},this),this.userPlans.bind("reset",function(){this._panes.active("content")},this),this.add_related_model(this.userPlans)},_initViews:function(a){this._panes=new d.ui.common.TabPane({el:a.find(".js-content")}),this.addView(this._panes),this._panes.addTab("loading",i.createByTemplate("common/templates/loading",{title:"Getting plans info…",quote:h()}).render()),this._panes.addTab("error",i.createByTemplate("common/templates/fail",{msg:"Sorry, something went wrong trying to get your available plans."}).render()),this._panes.addTab("content",new f({user:this.user,collection:this.userPlans}).render());var b=d.config.get("upgrade_url")&&!d.config.get("cartodb_com_hosted")&&!this.user.isInsideOrg();this._panes.active(b?"loading":"content"),b&&this.userPlans.fetch({error:function(){this.trigger("error")}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"../../view_helpers/random_quote":212,"../../views/base_dialog/view":213,"./limits_reached_content_view":134,"./user_plans_collection":137}],136:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;"undefined"!=typeof window?window.Backbone:"undefined"!=typeof a?a.Backbone:null;b.exports=c.core.Model.extend({defaults:{title:"",desc:"",price:0,tables_quota:"",bytes_quota:0,support:"",private_tables:!1,removable_brand:!1,max_layers:4}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],137:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f=a("./user_plan_model");b.exports=e.Collection.extend({model:f,url:function(){return"//"+d.config.get("account_host")+"/account/"+this.user.get("username")+".json"},initialize:function(a,b){if(!b.user)throw new Error("user model is needed");this.user=b.user},sync:function(a,b,c){var d=this,e=_.extend({type:"GET",dataType:"jsonp",url:d.url(),processData:!1},c);return $.ajax(e)},parse:function(a){return a.available_plans}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./user_plan_model":136}],138:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("../../create/footer/guessing_toggler_view"),g=a("../../create/footer/privacy_toggler_view");b.exports=e.core.View.extend({events:{"click .js-ok":"_finish"},initialize:function(){this.elder("initialize"),this.user=this.options.user,this.guessingModel=new e.core.Model({guessing:!0}),this.privacyModel=new e.core.Model({privacy:this.user.canCreatePrivateDatasets()?"PRIVATE":"PUBLIC"}),this._template=e.templates.getTemplate("common/dialogs/map/add_layer/footer"),this._initBinds()},render:function(){this.clearSubViews();var a=d(this._template({canFinish:this.model.canFinish(),listing:this.model.get("listing")}));return this.$el.html(a),this._initViews(),this},_initViews:function(){var a=new f({model:this.guessingModel,createModel:this.model});this.$(".js-footer-info").append(a.render().el),this.addView(a),this.privacyTogglerView=new g({model:this.privacyModel,user:this.user,createModel:this.model}),this.$(".js-footerActions").prepend(this.privacyTogglerView.render().el),this.addView(this.privacyTogglerView)},_initBinds:function(){this.model.upload.bind("change",this.render,this),this.model.selectedDatasets.bind("all",this._update,this),this.model.bind("change",this._update,this),this.add_related_model(this.model.upload),this.add_related_model(this.model.selectedDatasets)},_update:function(){var a=this.model.get("contentPane"),b=this.model.get("listing");"listing"===a&&"scratch"!==b?this.render().show():this.hide()},_finish:function(a){this.killEvent(a),this.model.canFinish()&&("import"===this.model.get("listing")&&(this.model.upload.set("privacy",this.privacyModel.get("privacy")),this.model.upload.setGuessing(this.guessingModel.get("guessing"))),this.model.finish())}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../create/footer/guessing_toggler_view":59,"../../create/footer/privacy_toggler_view":60}],139:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=("undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,a("../../background_polling/models/upload_model")),f=a("../../visualizations_fetch_model");b.exports=d.core.Model.extend({defaults:{type:"addLayer",contentPane:"listing",listing:"datasets",collectionFetched:!1,activeImportPane:"file"},initialize:function(a,b){this.user=b.user,this.vis=b.vis,this.map=b.map,this.upload=new e({create_vis:!1},{user:this.user}),this.selectedDatasets=new Backbone.Collection,this.collection=new d.admin.Visualizations,this.visFetchModel=new f({content_type:"datasets",library:this.showLibrary()}),this._initBinds(),this._maybePrefetchDatasets()},canSelect:function(a){return a.get("selected")||this.selectedDatasets.length<1},showLibrary:function(){return!1},showDatasets:function(){return!0},setActiveImportPane:function(a){this.set("activeImportPane",a)},canFinish:function(){return"import"===this.get("listing")?this.upload.isValidToUpload():"datasets"===this.get("listing")?this.selectedDatasets.length>0:void 0},finish:function(){if("import"===this.get("listing"))d.god.trigger("importByUploadData",this.upload.toJSON(),this);else if("datasets"===this.get("listing")){var a=this.selectedDatasets.at(0);if("remote"===a.get("type")){var b={create_vis:!1,type:"remote",value:a.get("name"),remote_visualization_id:a.get("id"),size:a.get("external_source")?a.get("external_source").size:void 0};d.god.trigger("importByUploadData",b,this)}else this._addNewLayer(a.tableMetadata().get("name"))}},getImportState:function(){return this.get("activeImportPane")},showGuessingToggler:function(){return"import"===this.get("listing")},showPrivacyToggler:function(){return"import"===this.get("listing")},createFromScratch:function(){this.set("contentPane","creatingFromScratch");var a=this,b=new d.admin.CartoDBTableMetadata;b.save({},{success:function(){a._addNewLayer(b.get("name"))},error:function(){this.set("contentPane","addLayerFailed")}})},_initBinds:function(){this.upload.bind("change",function(){this.trigger("change:upload",this)},this),this.visFetchModel.bind("change",this._fetchCollection,this),this.bind("change:listing",this._maybePrefetchDatasets),this.collection.bind("change:selected",function(a,b){this.selectedDatasets[b?"add":"remove"](a)},this),this.collection.bind("reset",function(){this.selectedDatasets.each(function(a){var b=this.collection.get(a.id);b&&b.set("selected",!0)},this)},this)},_maybePrefetchDatasets:function(){"datasets"!==this.get("listing")||this.get("collectionFetched")||this.visFetchModel.isSearching()||(this.set("collectionFetched",!0),this._fetchCollection())},_fetchCollection:function(){var a,b=this.visFetchModel.attributes;a=this.visFetchModel.isSearching()?"table,remote":b.library?"remote":"table",this.collection.options.set({locked:"",q:b.q,page:b.page||1,tags:b.tag,per_page:this.collection._TABLES_PER_PAGE,shared:b.shared,only_liked:b.liked,order:"updated_at",type:"",types:a,exclude_raster:!0}),this.collection.fetch()},_onCollectionChange:function(){this.selectedDatasets.reset(this.collection.where({selected:!0}))},_addNewLayer:function(a){this.set("contentPane","addingNewLayer");var b=this;this.map.addCartodbLayerFromTable(a,this.user.get("username"),{vis:this.vis,success:function(){b.map.layers.saveLayers(),b.trigger("addLayerDone")},error:function(){b.set("contentPane","addLayerFailed")}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../background_polling/models/upload_model":15,"../../visualizations_fetch_model":222}],140:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("../create/create_listing"),g=a("./add_layer/footer_view"),h=a("../../view_factory"),i=a("../../view_helpers/random_quote"),j=a("../create/listing/navigation_view");b.exports=e.extend({initialize:function(){if(this.elder("initialize"),!this.model)throw new TypeError("model is required");if(!this.options.user)throw new TypeError("user is required");this._template=d.templates.getTemplate("common/dialogs/map/add_layer_template"),this._initBinds()},render:function(){return this.clearSubViews(),e.prototype.render.call(this),this.$(".content").addClass("Dialog-content--expanded"),this._initViews(),this.$(".js-footer").append(this._footerView.render().el),this},render_content:function(){return this._template({})},_initBinds:function(){this.model.bind("addLayerDone",this.close,this),this.model.bind("change:contentPane",this._onChangeContentView,this),d.god.bind("importByUploadData",this.close,this),this.add_related_model(d.god)},_initViews:function(){this._contentPane=new d.ui.common.TabPane({el:this.$(".js-content-container")}),this.addView(this._contentPane),this._navigationView=new j({el:this.$(".js-navigation"),user:this.options.user,routerModel:this.model.visFetchModel,createModel:this.model,collection:this.model.collection}),this._navigationView.render(),this.addView(this._navigationView),this._addTab("listing",new f({createModel:this.model,user:this.options.user})),this._addTab("creatingFromScratch",h.createByTemplate("common/templates/loading",{title:"Creating empty dataset…",quote:i()})),this._addTab("addingNewLayer",h.createByTemplate("common/templates/loading",{title:"Adding new layer…",quote:i()})),this._addTab("addLayerFailed",h.createByTemplate("common/templates/fail",{msg:"Could not add layer"})),this._contentPane.active(this.model.get("contentPane")),this._footerView=new g({model:this.model,user:this.options.user}),this.addView(this._footerView)},_addTab:function(a,b){this._contentPane.addTab(a,b.render()),this.addView(b)},_onChangeContentView:function(){var a=this.model.get("contentPane");this._contentPane.active(a),
"loading"===a&&this._footerView.hide(),"listing"!==a&&this._navigationView.hide()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"../../view_helpers/random_quote":212,"../../views/base_dialog/view":213,"../create/create_listing":58,"../create/listing/navigation_view":92,"./add_layer/footer_view":138}],141:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null;b.exports=c.core.View.extend({_SIZE:60,_MIN_SIZE:32,tagName:"li",options:{template:"common/dialogs/map/image_picker/assets_item"},events:{"click a.delete":"_openDropdown",click:"_onClick"},initialize:function(){this.template=c.templates.getTemplate(this.options.template),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.append(this.template(this.model.toJSON())),this._calcBkgImg(this.model.get("public_url")),this},_initBinds:function(){_.bindAll(this,"_onClick","_openDropdown"),this.model.bind("change:state",this._changeState,this),this.model.bind("destroy",this.remove,this)},_calcBkgImg:function(a){var b=new Image,d=this;b.onload=function(){var a=this.width,b=this.height,c=d.$("a.image");d.$el.css("background","none"),"marker"===d.model.get("kind")?b>d._SIZE?c.css({"background-size":"cover","background-origin":"content-box"}):(a||b)<d._MIN_SIZE&&c.css({"background-size":d._MIN_SIZE+"px"}):(a||b)>d._SIZE?c.css({"background-size":"cover","background-origin":"content-box"}):c.css({"background-position":"0 0","background-repeat":"repeat"})},b.onerror=function(a){c.log.info(a)},b.src=a},_onClick:function(a){this.killEvent(a),"selected"!==this.model.get("state")&&"destroying"!=this.model.get("state")&&(this.trigger("selected",this.model),this.model.set("state","selected"))},_changeState:function(){this.$el.removeClass("is-idle is-selected is-destroying").addClass("is-"+this.model.get("state"))},_openDropdown:function(a){var b=this;this.killEvent(a),a.stopImmediatePropagation(),this.dropdown=new c.admin.DropdownMenu({className:"dropdown border tiny",target:d(a.target),width:196,speedIn:150,speedOut:300,template_base:"common/dialogs/map/image_picker/remove_asset",vertical_position:"down",horizontal_position:"left",horizontal_offset:3,tick:"left"}),this.dropdown.bind("optionClicked",function(a){a.preventDefault(),b._deleteAsset()}),d("body").append(this.dropdown.render().el),this.dropdown.open(a),c.god.bind("closeDialogs",this.dropdown.hide,this.dropdown)},_deleteAsset:function(){var a=this;this.model.set("state","destroying"),this.model.destroy({success:function(){},error:function(){a.model.set("state","idle")}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],142:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./static_assets_item_view");b.exports=d.core.View.extend({className:"AssetPane",initialize:function(){this.model=this.options.model,this.template=d.templates.getTemplate("common/dialogs/map/image_picker/assets_template"),this._setupAssets()},render:function(){return this.clearSubViews(),this.$el.html(this.template()),this._renderAssets(),this},_setupAssets:function(){var a={};void 0!==this.options.folder&&(a.folder=this.options.folder),void 0!==this.options.size&&(a.size=this.options.size),void 0!==this.options.host&&(a.host=this.options.host),void 0!==this.options.ext&&(a.ext=this.options.ext),e.isEmpty(a)||(this.options.icons=e.map(this.options.icons,function(b){return e.extend(b,a)})),this.collection=new d.admin.StaticAssets(this.options.icons)},_renderAssets:function(){var a=this,b=this.collection.where({kind:this.options.kind});e(b).each(function(b){var c=new f({className:"AssetItem "+(a.options.folder||""),template:"common/dialogs/map/image_picker/static_assets_item",model:b});c.bind("selected",a._selectItem,a),a.$("ul").append(c.render().el),a.addView(c)})},_selectItem:function(a){this.model.set("value",a.get("public_url")),this.trigger("fileChosen",this),this._unselectItems(a)},_unselectItems:function(a){this.collection.each(function(b){b!==a&&"selected"===b.get("state")&&b.set("state","idle")})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./static_assets_item_view":152}],143:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("./upload_model");b.exports=d.core.View.extend({className:"AssetPane",events:{"click .js-fileButton":"_onBoxClick"},_UPLOADER:{url:"/api/v1/users/<%- id %>/assets",uploads:1,maxFileSize:1048576,acceptFileTypes:["png","svg","jpeg","jpg"],acceptSync:void 0,resolution:"1024x1024"},initialize:function(){_.bindAll(this,"_onDbxChooserSuccess"),this.kind=this.options.kind,this.user=this.options.user,this._setupModel(),this.collection=this.options.collection},render:function(){return this.clearSubViews(),this.template=d.templates.getTemplate("common/dialogs/map/image_picker/box_template"),this.$el.html(this.template()),this},_setupModel:function(){this.model=new e({type:this.options.type,kind:this.options.kind},{userId:this.user.get("id")}),this._initBinds()},_initBinds:function(){this.model.bind("change:state",this._onChangeState,this)},_onStateUploaded:function(){this.collection.fetch(),this.model.setFresh({kind:this.kind})},_onStateError:function(){this._showFileError(),this.trigger("hide_loader",this),this.$(".js-import-panel").show(),this.model.setFresh({kind:this.kind})},_showFileError:function(){"error"===this.model.get("state")&&(this.$(".js-fileError").text(this.model.get("get_error_text").what_about).show(),this.$(".js-fileButton").addClass("Button--negative"))},_hideFileError:function(){this.$(".js-fileError").hide(),this.$(".js-fileLabel").show(),this.$(".js-fileButton").removeClass("Button--negative")},_onChangeState:function(){var a=this.model.get("state");"uploaded"===a?this._onStateUploaded():"error"==a?this._onStateError():"idle"===a||"uploading"===a?(this.$(".js-import-panel").hide(),this.trigger("show_loader",this)):(this.$(".js-import-panel").show(),this.trigger("hide_loader",this))},_onBoxClick:function(a){this.killEvent(a),Box.choose({success:this._onDbxChooserSuccess,multiselect:!1,linkType:"direct",extensions:_.map(this._UPLOADER.acceptFileTypes,function(a){return"."+a})})},_onDbxChooserSuccess:function(a){a&&a[0]&&(this.model.set({type:"url",value:a[0].link,state:"uploading"}),this.model.upload(),"error"!==this.model.get("state")?this._hideFileError():this._showFileError())}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./upload_model":153}],144:[function(a,b,c){b.exports={disclaimer:'<a href="https://github.com/mapbox/maki" target="_blank">Maki Icons</a>, an open source project by <a href="http://mapbox.com" target="_blank">Mapbox</a>',icons:[{name:"Circle stroked",icon:"circle-stroked"},{name:"Circle solid",icon:"circle"},{name:"Square stroked",icon:"square-stroked"},{name:"Square solid",icon:"square"},{name:"Triangle stroked",icon:"triangle-stroked"},{name:"Triangle solid",icon:"triangle"},{name:"Star stroked",icon:"star-stroked"},{name:"Star solid",icon:"star"},{name:"Cross",icon:"cross"},{name:"Marker Stroke",icon:"marker-stroked"},{name:"Marker Solid",icon:"marker"},{name:"Religious Jewish",icon:"religious-jewish"},{name:"Religious Christian",icon:"religious-christian"},{name:"Religious Muslim",icon:"religious-muslim"},{name:"Cemetery",icon:"cemetery"},{name:"Rocket",icon:"rocket"},{name:"Airport",icon:"airport"},{name:"Heliport",icon:"heliport"},{name:"Rail",icon:"rail"},{name:"Rail Metro",icon:"rail-metro"},{name:"Rail Light",icon:"rail-light"},{name:"Bus",icon:"bus"},{name:"Fuel",icon:"fuel"},{name:"Parking",tags:["parking","transportation"],icon:"parking"},{name:"Parking Garage",tags:["parking","transportation","garage"],icon:"parking-garage"},{name:"Airfield",tags:["airfield","airport","plane","landing strip"],icon:"airfield"},{name:"Roadblock",tags:["roadblock","stop","warning","dead end"],icon:"roadblock"},{name:"Ferry",tags:["ship","boat","water","ferry","transportation"],icon:"ferry"},{name:"Harbor",tags:["marine","dock","water","wharf"],icon:"harbor"},{name:"Bicycle",tags:["cycling","cycle","transportation"],icon:"bicycle"},{name:"Park",tags:["recreation","park","forest","tree","green","woods","nature"],icon:"park"},{name:"Park 2",tags:["recreation","park","forest","tree","green","woods","nature"],icon:"park2"},{name:"Museum",tags:["recreation","museum","tourism"],icon:"museum"},{name:"Lodging",tags:["lodging","hotel","recreation","motel","tourism"],icon:"lodging"},{name:"Monument",tags:["recreation","statue","monument","tourism"],icon:"monument"},{name:"Zoo",tags:["recreation","zoo","animal","giraffe"],icon:"zoo"},{name:"Garden",tags:["recreation","garden","park","flower","nature"],icon:"garden"},{name:"Campsite",tags:["recreation","campsite","camp","camping","tent","nature"],icon:"campsite"},{name:"Theatre",tags:["recreation","theatre","theater","entertainment","play","performance"],icon:"theatre"},{name:"Art gallery",tags:["art","center","museum","gallery","creative","recreation","entertainment","studio"],icon:"art-gallery"},{name:"Pitch",tags:["pitch","track","athletic","sports","field"],icon:"pitch"},{name:"Soccer",tags:["soccer","sports"],icon:"soccer"},{name:"American Football",tags:["football","sports"],icon:"america-football"},{name:"Tennis",tags:["tennis","court","ball","sports"],icon:"tennis"},{name:"Basketball",tags:["basketball","ball","sports"],icon:"basketball"},{name:"Baseball",tags:["baseball","softball","ball","sports"],icon:"baseball"},{name:"Golf",tags:["golf","sports","course"],icon:"golf"},{name:"Swimming",tags:["swimming","water","swim","sports"],icon:"swimming"},{name:"Cricket",tags:["cricket","sports"],icon:"cricket"},{name:"Skiing",tags:["winter","skiing","ski","sports"],icon:"skiing"},{name:"School",tags:["school","highschool","elementary","children","amenity","middle"],icon:"school"},{name:"College",tags:["college","school","amenity","university"],icon:"college"},{name:"Library",tags:["library","books","amenity"],icon:"library"},{name:"Post",tags:["post","office","amenity","mail","letter"],icon:"post"},{name:"Fire station",tags:["fire","station","amenity"],icon:"fire-station"},{name:"Town hall",tags:["townhall","mayor","building","amenity","government"],icon:"town-hall"},{name:"Police",tags:["police","jail","arrest","amenity","station"],icon:"police"},{name:"Prison",tags:["prison","jail","amenity"],icon:"prison"},{name:"Embassy",tags:["embassy","diplomacy","consulate","amenity","flag"],icon:"embassy"},{name:"Beer",tags:["bar","beer","drink","commercial","biergarten","pub"],icon:"beer"},{name:"Restaurant",tags:["restaurant","commercial"],icon:"restaurant"},{name:"Cafe",tags:["cafe","coffee","commercial","tea"],icon:"cafe"},{name:"Shop",tags:["shop","mall","commercial","store"],icon:"shop"},{name:"Fast Food",tags:["food","fast","commercial","burger","drive-through"],icon:"fast-food"},{name:"Bar",tags:["bar","drink","commercial","club","martini","lounge"],icon:"bar"},{name:"Bank",tags:["bank","atm","commercial","money"],icon:"bank"},{name:"Grocery",tags:["food","grocery","commercial","store","market"],icon:"grocery"},{name:"Cinema",tags:["cinema","theatre","film","movie","commercial","theater","entertainment"],icon:"cinema"},{name:"Pharmacy",tags:["pharmacy","drugs","medication","social","medicine","prescription"],icon:"pharmacy"},{name:"Hospital",tags:["hospital","health","medication","social","medicine","medical","clinic"],icon:"hospital"},{name:"Danger",tags:["minefield","landmine","disaster","dangerous","hazard"],icon:"danger"},{name:"Industrial",tags:["industrial","factory","property","building"],icon:"industrial"},{name:"Warehouse",tags:["warehouse","property","storage","building"],icon:"warehouse"},{name:"Commercial",tags:["commercial","property","business","building"],icon:"commercial"},{name:"Building",tags:["building","property","structure","business","building"],icon:"building"},{name:"Place of worship",tags:["religion","ceremony","religious","nondenominational","church","temple"],icon:"place-of-worship"},{name:"Alcohol shop",tags:["alcohol","liquor","store","shop","beer","wine","vodka"],icon:"alcohol-shop"},{name:"Logging",tags:["logger","chainsaw","woods","industry"],icon:"logging"},{name:"Oil well",tags:["oil","natural","environment","industry","resources"],icon:"oil-well"},{name:"Slaughterhouse",tags:["cows","cattle","food","meat","industry","resources"],icon:"slaughterhouse"},{name:"Dam",tags:["water","natural","hydro","hydroelectric","energy","environment","industry","resources"],icon:"dam"},{name:"Water",tags:["water","natural","hydro","lake","river","ocean","resources"],icon:"water"},{name:"Wetland",tags:["water","swamp","natural"],icon:"wetland"},{name:"Disability",tags:["handicap","wheelchair","access"],icon:"disability"},{name:"Telephone",tags:["payphone","call"],icon:"telephone"},{name:"Emergency Telephone",tags:["payphone","danger","safety","call"],icon:"emergency-telephone"},{name:"Toilets",tags:["bathroom","men","women","sink","washroom","lavatory"],icon:"toilets"},{name:"Waste Basket",tags:["trash","rubbish","bin","garbage"],icon:"waste-basket"},{name:"Music",tags:["stage","performance","band","concert","venue"],icon:"music"},{name:"Land Use",tags:["zoning","usage","area"],icon:"land-use"},{name:"City",tags:["area","point","place","urban"],icon:"city"},{name:"Town",tags:["area","point","place","small"],icon:"town"},{name:"Village",tags:["area","point","place","small","rural"],icon:"village"},{name:"Farm",tags:["building","farming","crops","plants","agriculture","rural"],icon:"farm"},{name:"Bakery",tags:["bakery","pastry","croissant","food","shop","bread"],icon:"bakery"},{name:"Dog Park",tags:["dog","pet"],icon:"dog-park"},{name:"Lighthouse",tags:["building","navigation","nautical","ocean","logistics"],icon:"lighthouse"},{name:"Clothing Store",tags:["clothing","store","shop"],icon:"clothing-store"},{name:"Polling Place",icon:"polling-place"},{name:"Playground",icon:"playground"},{name:"Entrance",icon:"entrance"},{name:"Heart",icon:"heart"},{name:"London Underground",icon:"london-underground"},{name:"Minefield",icon:"minefield"},{name:"Rail Underground",icon:"rail-underground"},{name:"Rail Above",icon:"rail-above"},{name:"Camera",icon:"camera"},{name:"Laundry",icon:"laundry"},{name:"Car",icon:"car"},{name:"Suitcase",icon:"suitcase"},{name:"Hairdresser",icon:"hairdresser"},{name:"Chemist",icon:"chemist"},{name:"Mobile phone",icon:"mobilephone"},{name:"Scooter",icon:"scooter"}]}},{}],145:[function(a,b,c){b.exports={icons:[{kind:"pattern",ext:"png",name:"diagonal_1px_fast",icon:"diagonal_1px_fast"},{kind:"pattern",ext:"png",name:"diagonal_1px_med",icon:"diagonal_1px_med"},{kind:"pattern",ext:"png",name:"diagonal_1px_slow",icon:"diagonal_1px_slow"},{kind:"pattern",ext:"png",name:"diagonal_2px_fast",icon:"diagonal_2px_fast"},{kind:"pattern",ext:"png",name:"diagonal_2px_med",icon:"diagonal_2px_med"},{kind:"pattern",ext:"png",name:"diagonal_2px_slow",icon:"diagonal_2px_slow"},{kind:"pattern",ext:"png",name:"donuts_4px_med",icon:"donuts_4px_med"},{kind:"pattern",ext:"png",name:"donuts_6px_med",icon:"donuts_6px_med"},{kind:"pattern",ext:"png",name:"dots_2px_fast",icon:"dots_2px_fast"},{kind:"pattern",ext:"png",name:"dots_2px_med",icon:"dots_2px_med"},{kind:"pattern",ext:"png",name:"dots_2px_slow",icon:"dots_2px_slow"},{kind:"pattern",ext:"png",name:"dots_4px_fast",icon:"dots_4px_fast"},{kind:"pattern",ext:"png",name:"dots_4px_med",icon:"dots_4px_med"},{kind:"pattern",ext:"png",name:"dots_6px_fast",icon:"dots_6px_fast"},{kind:"pattern",ext:"png",name:"dots_6px_med",icon:"dots_6px_med"}]}},{}],146:[function(a,b,c){b.exports={disclaimer:'<a href="http://www.flaticon.com/packs/pins-of-maps/" target="_blank">Pin Maps</a>, icons by <a href="http://freepik.com" target="_blank">freepik.com</a>',icons:[{name:"air",icon:"air"},{name:"air2",icon:"air2"},{name:"anchor2",icon:"anchor2"},{name:"anchor3",icon:"anchor3"},{name:"bag1",icon:"bag1"},{name:"bag2",icon:"bag2"},{name:"balloon",icon:"balloon"},{name:"black41",icon:"black41"},{name:"boat1",icon:"boat1"},{name:"book16",icon:"book16"},{name:"building",icon:"building"},{name:"burger",icon:"burger"},{name:"bus6",icon:"bus6"},{name:"caravan2",icon:"caravan2"},{name:"church1",icon:"church1"},{name:"church3",icon:"church3"},{name:"club",icon:"club"},{name:"cocktail3",icon:"cocktail3"},{name:"coffee2",icon:"coffee2"},{name:"dark11",icon:"dark11"},{name:"disabled",icon:"disabled"},{name:"dog2",icon:"dog2"},{name:"favourite1",icon:"favourite1"},{name:"flag5",icon:"flag5"},{name:"flat",icon:"flat"},{name:"hotel",icon:"hotel"},{name:"information3",icon:"information3"},{name:"location10",icon:"location10"},{name:"location11",icon:"location11"},{name:"location5",icon:"location5"},{name:"location6",icon:"location6"},{name:"location7",icon:"location7"},{name:"location8",icon:"location8"},{name:"location9",icon:"location9"},{name:"marker2",icon:"marker2"},{name:"marker3",icon:"marker3"},{name:"marker4",icon:"marker4"},{name:"marker5",icon:"marker5"},{name:"marker6",icon:"marker6"},{name:"marker7",icon:"marker7"},{name:"monument2",icon:"monument2"},{name:"mountains",icon:"mountains"},{name:"p",icon:"p"},{name:"petrol",icon:"petrol"},{name:"petrol2",icon:"petrol2"},{name:"pharmacy",icon:"pharmacy"},{name:"phone13",icon:"phone13"},{name:"pin10",icon:"pin10"},{name:"pins",icon:"pins"},{name:"pins1",icon:"pins1"},{name:"pins10",icon:"pins10"},{name:"pins11",icon:"pins11"},{name:"pins12",icon:"pins12"},{name:"pins13",icon:"pins13"},{name:"pins14",icon:"pins14"},{name:"pins15",icon:"pins15"},{name:"pins16",icon:"pins16"},{name:"pins17",icon:"pins17"},{name:"pins18",icon:"pins18"},{name:"pins19",icon:"pins19"},{name:"pins2",icon:"pins2"},{name:"pins20",icon:"pins20"},{name:"pins21",icon:"pins21"},{name:"pins22",icon:"pins22"},{name:"pins23",icon:"pins23"},{name:"pins24",icon:"pins24"},{name:"pins25",icon:"pins25"},{name:"pins26",icon:"pins26"},{name:"pins27",icon:"pins27"},{name:"pins28",icon:"pins28"},{name:"pins29",icon:"pins29"},{name:"pins3",icon:"pins3"},{name:"pins30",icon:"pins30"},{name:"pins31",icon:"pins31"},{name:"pins32",icon:"pins32"},{name:"pins33",icon:"pins33"},{name:"pins34",icon:"pins34"},{name:"pins35",icon:"pins35"},{name:"pins36",icon:"pins36"},{name:"pins37",icon:"pins37"},{name:"pins38",icon:"pins38"},{name:"pins39",icon:"pins39"},{name:"pins4",icon:"pins4"},{name:"pins40",icon:"pins40"},{name:"pins41",icon:"pins41"},{name:"pins42",icon:"pins42"},{name:"pins43",icon:"pins43"},{name:"pins44",icon:"pins44"},{name:"pins45",icon:"pins45"},{name:"pins46",icon:"pins46"},{name:"pins47",icon:"pins47"},{name:"pins48",icon:"pins48"},{name:"pins49",icon:"pins49"},{name:"pins5",icon:"pins5"},{name:"pins50",icon:"pins50"},{name:"pins51",icon:"pins51"},{name:"pins52",icon:"pins52"},{name:"pins53",icon:"pins53"},{name:"pins54",icon:"pins54"},{name:"pins55",icon:"pins55"},{name:"pins56",icon:"pins56"},{name:"pins57",icon:"pins57"},{name:"pins58",icon:"pins58"},{name:"pins59",icon:"pins59"},{name:"pins6",icon:"pins6"},{name:"pins60",icon:"pins60"},{name:"pins61",icon:"pins61"},{name:"pins62",icon:"pins62"},{name:"pins63",icon:"pins63"},{name:"pins64",icon:"pins64"},{name:"pins65",icon:"pins65"},{name:"pins66",icon:"pins66"},{name:"pins67",icon:"pins67"},{name:"pins68",icon:"pins68"},{name:"pins69",icon:"pins69"},{name:"pins7",icon:"pins7"},{name:"pins70",icon:"pins70"},{name:"pins71",icon:"pins71"},{name:"pins72",icon:"pins72"},{name:"pins73",icon:"pins73"},{name:"pins74",icon:"pins74"},{name:"pins75",icon:"pins75"},{name:"pins76",icon:"pins76"},{name:"pins77",icon:"pins77"},{name:"pins78",icon:"pins78"},{name:"pins79",icon:"pins79"},{name:"pins8",icon:"pins8"},{name:"pins80",icon:"pins80"},{name:"pins81",icon:"pins81"},{name:"pins82",icon:"pins82"},{name:"pins83",icon:"pins83"},{name:"pins84",icon:"pins84"},{name:"pins85",icon:"pins85"},{name:"pins86",icon:"pins86"},{name:"pins87",icon:"pins87"},{name:"pins88",icon:"pins88"},{name:"pins89",icon:"pins89"},{name:"pins9",icon:"pins9"},{name:"pins90",icon:"pins90"},{name:"pins91",icon:"pins91"},{name:"position",icon:"position"},{name:"restaurant2",icon:"restaurant2"},{name:"right14",icon:"right14"},{name:"road3",icon:"road3"},{name:"shop2",icon:"shop2"},{name:"shopping8",icon:"shopping8"},{name:"sit",icon:"sit"},{name:"ski1",icon:"ski1"},{name:"soccer1",icon:"soccer1"},{name:"suitcase1",icon:"suitcase1"},{name:"suitcase2",icon:"suitcase2"},{name:"telephone3",icon:"telephone3"},{name:"tent",icon:"tent"},{name:"tent1",icon:"tent1"},{name:"train3",icon:"train3"},{name:"train4",icon:"train4"},{name:"turn7",icon:"turn7"},{name:"walk",icon:"walk"},{name:"wifi11",icon:"wifi11"}]}},{}],147:[function(a,b,c){b.exports={disclaimer:'<a href="http://www.flaticon.com/packs/simpleicon-places/" target="_blank">SimpleIcons Places</a>, icons by <a href="http://www.simpleicon.com" target="_blank">simpleicon.com</a>',icons:[{name:"beach3",icon:"beach3"},{name:"beach4",icon:"beach4"},{name:"boat12",icon:"boat12"},{name:"building21",icon:"building21"},{name:"building22",icon:"building22"},{name:"building23",icon:"building23"},{name:"building24",icon:"building24"},{name:"buildings5",icon:"buildings5"},{name:"castle7",icon:"castle7"},{name:"church7",icon:"church7"},{name:"coconut5",icon:"coconut5"},{name:"compass44",icon:"compass44"},{name:"compass45",icon:"compass45"},{name:"compass46",icon:"compass46"},{name:"compass47",icon:"compass47"},{name:"compass49",icon:"compass49"},{name:"compass50",icon:"compass50"},{name:"factory7",icon:"factory7"},{name:"factory8",icon:"factory8"},{name:"flag31",icon:"flag31"},{name:"flag32",icon:"flag32"},{name:"heart206",icon:"heart206"},{name:"home84",icon:"home84"},{name:"home85",icon:"home85"},{name:"home86",icon:"home86"},{name:"home87",icon:"home87"},{name:"home88",icon:"home88"},{name:"home89",icon:"home89"},{name:"home90",icon:"home90"},{name:"map35",icon:"map35"},{name:"map36",icon:"map36"},{name:"map37",icon:"map37"},{name:"map38",icon:"map38"},{name:"map39",icon:"map39"},{name:"map40",icon:"map40"},{name:"map41",icon:"map41"},{name:"map42",icon:"map42"},{name:"map43",icon:"map43"},{name:"map44",icon:"map44"},{name:"map45",icon:"map45"},{name:"map46",icon:"map46"},{name:"map47",icon:"map47"},{name:"map48",icon:"map48"},{name:"map49",icon:"map49"},{name:"map50",icon:"map50"},{name:"map51",icon:"map51"},{name:"map52",icon:"map52"},{name:"map53",icon:"map53"},{name:"map54",icon:"map54"},{name:"map55",icon:"map55"},{name:"map56",icon:"map56"},{name:"map57",icon:"map57"},{name:"map58",icon:"map58"},{name:"map59",icon:"map59"},{name:"map60",icon:"map60"},{name:"palm9",icon:"palm9"},{name:"placeholder4",icon:"placeholder4"},{name:"sailboat5",icon:"sailboat5"},{name:"sunbathing",icon:"sunbathing"},{name:"sunbathing1",icon:"sunbathing1"},{name:"tower15",icon:"tower15"},{name:"town",icon:"town"}]}},{}],148:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("./upload_model");b.exports=d.core.View.extend({className:"AssetPane",events:{"click .js-fileButton":"_onDropboxClick"},_UPLOADER:{url:"/api/v1/users/<%- id %>/assets",uploads:1,maxFileSize:1048576,acceptFileTypes:["png","svg","jpeg","jpg"],acceptSync:void 0,resolution:"1024x1024"},initialize:function(){_.bindAll(this,"_onDbxChooserSuccess"),this.kind=this.options.kind,this.user=this.options.user,this._setupModel(),this.collection=this.options.collection},render:function(){return this.clearSubViews(),this.template=d.templates.getTemplate("common/dialogs/map/image_picker/dropbox_template"),this.$el.html(this.template()),this},_setupModel:function(){this.model=new e({type:this.options.type,kind:this.options.kind},{userId:this.user.get("id")}),this._initBinds()},_initBinds:function(){this.model.bind("change:state",this._onChangeState,this)},_onStateUploaded:function(){this.collection.fetch(),this.model.setFresh({kind:this.kind})},_onStateError:function(){this._showFileError(),this.trigger("hide_loader",this),this.$(".js-import-panel").show(),this.model.setFresh({kind:this.kind})},_showFileError:function(){"error"===this.model.get("state")&&(this.$(".js-fileError").text(this.model.get("get_error_text").what_about).show(),this.$(".js-fileButton").addClass("Button--negative"))},_hideFileError:function(){this.$(".js-fileError").hide(),this.$(".js-fileLabel").show(),this.$(".js-fileButton").removeClass("Button--negative")},_onChangeState:function(){var a=this.model.get("state");"uploaded"===a?this._onStateUploaded():"error"==a?this._onStateError():"idle"===a||"uploading"===a?(this.$(".js-import-panel").hide(),this.trigger("show_loader",this)):(this.$(".js-import-panel").show(),this.trigger("hide_loader",this))},_onDropboxClick:function(a){this.killEvent(a),Dropbox.choose({success:this._onDbxChooserSuccess,multiselect:!1,linkType:"direct",extensions:_.map(this._UPLOADER.acceptFileTypes,function(a){return"."+a})})},_onDbxChooserSuccess:function(a){a&&a[0]&&(this.model.set({type:"url",value:a[0].link,state:"uploading"}),this.model.upload(),"error"!==this.model.get("state")?this._hideFileError():this._showFileError())}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./upload_model":153}],149:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("./upload_model");b.exports=d.core.View.extend({className:"AssetPane",options:{type:"url",acceptSync:!1,fileEnabled:!0,formTemplate:"",headerTemplate:"",fileAttrs:{}},events:{"keyup .js-textInput":"_onTextChanged","submit .js-form":"_onSubmitForm"},initialize:function(){this.user=this.options.user,this.kind=this.options.kind,this.collection=this.options.collection,this._setupModel(),this.template=d.templates.getTemplate("common/dialogs/map/image_picker/file_upload_template")},render:function(){return this.$el.html(this.template(_.extend(this.options,this.model.attributes))),this._initViews(),this},_setupModel:function(){this.model=new e({type:this.options.type,kind:this.options.kind},{userId:this.user.get("id")}),this._initBinds()},_initBinds:function(){this.model.bind("change:state",this._onChangeState,this)},_initViews:function(){if(this.options.fileEnabled){var a=this;this.$(".js-fileInput").bind("change",function(b){this.files&&this.files.length>0&&a._onFileChanged(this.files)}),this._initDropzone()}},_onTextChanged:function(){var a=this.$(".js-textInput").val();a||this._hideTextError()},_onSubmitForm:function(a){a&&this.killEvent(a);var b=this.$(".js-textInput").val();return b?(this.trigger("urlSelected",this),this.model.set({type:"url",value:b,state:"idle"}),this.model.upload(),void("error"!==this.model.get("state")?(this._hideFileError(),this._hideTextError()):this._showTextError())):void this._hideTextError()},_initDropzone:function(){var a=$("html")[0],b=this;this.dragster=new Dragster(a),$(a).bind("dragster:enter",function(a){b._showDropzone()}),$(a).bind("dragster:leave",function(a){b._hideDropzone()}),a.dropzone||(this.dropzone=new Dropzone(a,{url:":)",autoProcessQueue:!1,previewsContainer:!1}),this.dropzone.on("dragover",function(){b._showDropzone()}),this.dropzone.on("drop",function(a){var c=a.dataTransfer.files;b._onFileChanged(c),b._hideDropzone()}))},_destroyDropzone:function(){var a=$("html")[0];this.dragster&&(this.dragster.removeListeners(),this.dragster.reset(),$(a).unbind("dragster:enter dragster:leave")),this.dropzone&&this.dropzone.destroy()},_setValidFileExtensions:function(a){return RegExp("(.|/)("+a.join("|")+")$","i")},_onFileChanged:function(a){a&&1===a.length&&(a=a[0]),this.model.set({type:"file",value:a}),"error"!==this.model.get("state")?(this._hideFileError(),this.model.set("state","selected"),this.model.upload()):this._showFileError()},_showTextError:function(){this.$(".Form-inputError").addClass("is-visible")},_hideTextError:function(){this.$(".Form-inputError").removeClass("is-visible")},_showDropzone:function(){this.$(".Form-upload").addClass("is-dropping"),this._hideFileError()},_hideDropzone:function(){this.$(".Form-upload").removeClass("is-dropping")},_showFileError:function(){"error"===this.model.get("state")&&(this.$(".js-fileError").text(this.model.get("get_error_text").what_about).show(),this.$(".js-fileLabel").hide(),this.$(".js-fileButton").addClass("Button--negative"))},_hideFileError:function(){this.$(".js-fileError").hide(),this.$(".js-fileLabel").show(),this.$(".js-fileButton").removeClass("Button--negative")},_onStateUploaded:function(){this.collection.fetch(),this.model.setFresh({kind:this.kind}),this.$(".js-textInput").val("")},_onStateError:function(){this._showFileError(),this.$(".js-form").show(),this.trigger("hide_loader",this),this.model.setFresh({kind:this.kind})},_onChangeState:function(){var a=this.model.get("state");"uploaded"===a?this._onStateUploaded():"error"===a?this._onStateError():"idle"===a||"uploading"===a||"selected"===a?(this.$(".js-form").hide(),this.trigger("show_loader",this)):(this.$(".js-form").show(),this.trigger("hide_loader",this))},clean:function(){this._destroyDropzone(),this.$(".js-fileInput").unbind("change"),this.elder("clean")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./upload_model":153}],150:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.core.View.extend({_TEXTS:{ok:{simple_icons:_t("Set image"),pin_icons:_t("Set image"),maki_icons:_t("Set image"),your_icons:_t("Set image"),upload_file:_t("Upload image"),dropbox:_t("Upload image"),box:_t("Upload image")}},events:{"click .js-ok":"_finish"},initialize:function(){this.elder("initialize"),this._template=d.templates.getTemplate("common/dialogs/map/image_picker/footer_template"),this._initBinds()},render:function(){this.clearSubViews();var a=this._TEXTS.ok[this.model.get("pane")]||"Set image",b=_.extend(this.model.attributes,{action:a}),d=c(this._template(b));return this.$el.html(d),this},_initBinds:function(){this.model.bind("change",this.render,this),this.model.bind("change:disclaimer",this._updateFooterInfo,this)},_updateFooterInfo:function(){this.$el.find(".js-footer-info").html(this.model.get("disclaimer"))},_finish:function(a){this.killEvent(a),this.model.get("submit_enabled")&&this.trigger("finish",this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],151:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;"undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.core.View.extend({events:{"click .js-item":"_onItemClick","click .js-your-icons":"_onYourIconsClick"},initialize:function(){this.model=this.options.model,this.kind=this.options.kind,this.collection=this.options.collection,this.template=c.templates.getTemplate("common/dialogs/map/image_picker/navigation_template"),this._preRender(),this._initBinds()},_preRender:function(){var a=$("<div>").addClass("u-inner"),b=$("<div>").addClass("Filters-inner");this.$el.append(a.append(b))},render:function(a,b){if(this.clearSubViews(),this.$(".Filters-inner").html(this.template({dropbox_enabled:this.model.get("dropbox_enabled"),
box_enabled:this.model.get("box_enabled"),pane:this.model.get("pane"),kind:this.kind})),this.collection.where({kind:this.kind}).length>0){var c="your_icons";this.$el.find('[data-type="'+c+'"]').removeClass("is-disabled")}return this},_initBinds:function(){this.model.bind("change:pane",this.render,this),this.model.bind("change:pane",this._enableFilter,this),this.add_related_model(this.model)},_onYourIconsClick:function(a){if(this.collection.where({kind:this.kind}).length>0){var b=$(a.target).data("type");this.model.set("pane",b)}},_onItemClick:function(a){var b=$(a.target).data("type");this.model.set("pane",b)},_enableFilter:function(a){var b=this.model.get("pane"),c=this.$el.find('[data-type="'+b+'"]');c.removeClass("is-disabled")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],152:[function(a,b,c){var d=a("./assets_item_view");b.exports=d.extend({events:{click:"_onClick"},_deleteAsset:function(){},_openDropdown:function(){}})},{"./assets_item_view":141}],153:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.Backbone:"undefined"!=typeof a?a.Backbone:null,d="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof a?a.cdb.Utils:null,e=("undefined"!=typeof window?window.moment:"undefined"!=typeof a?a.moment:null,"undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null);b.exports=c.Model.extend({url:function(a){var b=cdb.config.urlVersion("asset",a);return"/api/"+b+"/users/"+this.userId+"/assets"},fileAttribute:"filename",defaults:{type:"",value:"",interval:0,progress:0,state:"idle",option:""},initialize:function(a,b){if(this.user=b&&b.user,!b.userId)throw new Error("userId is required");this.userId=b.userId,this._initBinds(),this._validate(this.attributes,{validate:!0})},isValidToUpload:function(){return this.get("value")&&"error"!==this.get("state")},setFresh:function(a){this.clear(),this.set(a)},_initBinds:function(){this.bind("progress",function(a){this.set({progress:100*a,state:"uploading"})},this),this.bind("change:value",function(){"error"===this.get("state")&&(this.set({state:"idle"}),this.unset("get_error_text",{silent:!0}))},this),this.bind("error invalid",function(a,b){this.set({state:"error",error_code:b&&b.error_code||"",get_error_text:{title:"Invalid import",what_about:b&&b.msg||""}},{silent:!0}),this.trigger("change")},this)},validate:function(a){if(a){if("file"===a.type){if(a.value&&a.value.length)return{msg:"Unfortunately only one file is allowed per upload"};var b=a.value.name,c=b.substr(b.lastIndexOf(".")+1);if(c&&(c=c.toLowerCase()),!e.contains(["jpg","png","gif","svg"],c))return{msg:"Unfortunately this file extension is not allowed"}}return"url"!==a.type||d.isURL(a.value)?void 0:{msg:"Unfortunately the URL provided is not valid"}}},isValid:function(){return this.get("value")&&"error"!==this.get("state")},upload:function(){var a=this,b={kind:this.get("kind")};"file"===this.get("type")?b.filename=this.get("value"):"url"===this.get("type")&&(b.url=this.get("value")),this.xhr=this.save(b,{success:function(a){a.set("state","uploaded")},error:function(b,c){var d="Unfortunately there was a connection error";if(c&&429===c.status){var e=JSON.parse(c.responseText);d=e.error}else if(c&&400===c.status){var e=JSON.parse(c.responseText);d=e.error}a.set({state:"error",get_error_text:{title:"There was an error",what_about:d}})},complete:function(){delete a.xhr}})},stopUpload:function(){this.xhr&&this.xhr.abort()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],154:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./assets_view"),g=a("./assets_item_view");b.exports=f.extend({className:"AssetPane AssetPane-userIcons",initialize:function(){this.model=this.options.model,this.template=d.templates.getTemplate("common/dialogs/map/image_picker/assets_template"),this.collection.bind("add remove reset",this.render,this)},_renderAssets:function(){var a=this,b=this.collection.where({kind:this.options.kind});e(b).each(function(b){var c=new g({className:"AssetItem AssetItem-User",model:b});c.bind("selected",a._selectItem,a),a.$("ul").append(c.render().el),a.addView(c)})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./assets_item_view":141,"./assets_view":142}],155:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("./image_picker/navigation_view"),g=a("./image_picker/footer_view"),h=a("./image_picker/assets_view"),i=a("./image_picker/user_icons_view"),j=a("./image_picker/file_upload_view"),k=a("./image_picker/dropbox_view"),l=a("./image_picker/box_view"),m=a("./image_picker/data/maki_icons"),n=a("./image_picker/data/patterns"),o=a("./image_picker/data/pin_maps"),p=a("./image_picker/data/simpleicon"),q=a("../../view_factory"),r=a("../../view_helpers/random_quote");b.exports=e.extend({className:"Dialog ImagePicker",initialize:function(){this.elder("initialize"),this._validate(),this.kind=this.options.kind,this.model=new d.core.Model({disclaimer:"",dropbox_enabled:!!d.config.get("dropbox_api_key"),box_enabled:!!d.config.get("box_api_key"),submit_enabled:!1}),this.collection=new d.admin.Assets([],{user:this.options.user}),this._template=d.templates.getTemplate("common/dialogs/map/image_picker_template"),this._initBinds(),this._onChangePane()},render:function(){return this.clearSubViews(),e.prototype.render.call(this),this.$(".content").addClass("Dialog-content--expanded"),this._initViews(),this._initAssets(),this},_initAssets:function(){this.collection.bind("add remove reset",this._onAssetsFetched,this),this.collection.fetch()},_showLoader:function(){var a=this._contentPane.getPane("loader");a&&a.show()},_hideLoader:function(){var a=this._contentPane.getPane("loader");a&&a.hide()},_showUploadLoader:function(){var a=this._contentPane.getPane("upload_loader");a&&a.show()},_hideUploadLoader:function(){var a=this._contentPane.getPane("upload_loader");a&&a.hide()},_onAssetsFetched:function(){this._hideLoader();var a=this.collection.where({kind:this.kind});0===a.length?"marker"===this.kind?this.model.set("pane","simple_icons"):this.model.set("pane","patterns"):this.model.set("pane","your_icons")},render_content:function(){return this._template({kind:this.kind})},_initViews:function(){this._renderContentPane(),this._renderNavigation(),this._renderTabPane(),this._renderLoader(),this._renderUploadLoader(),"marker"===this.kind?(this._renderSimpleiconPane(),this._renderPinIconsPane(),this._renderMakisPane()):"pattern"===this.kind&&this._renderPatternPane(),this._renderUserIconsPane(),this._renderFilePane(),this._renderDropboxPane(),this._renderBoxPane(),this._renderFooter(),this._contentPane.active("loader")},_renderFooter:function(){this._footerView=new g({model:this.model}),this._footerView.bind("finish",this._ok,this),this.$(".js-footer").append(this._footerView.render().el),this.addView(this._footerView)},_renderTabPane:function(){this.tabPane=new d.ui.common.TabPane({el:this.$(".AssetsContent")}),this.addView(this.tabPane)},_renderContentPane:function(){this._contentPane=new d.ui.common.TabPane({el:this.$(".js-content-container")}),this.addView(this._contentPane),this._contentPane.active(this.model.get("contentPane"))},_renderNavigation:function(){var a=new f({el:this.$(".js-navigation"),kind:this.kind,collection:this.collection,user:this.options.user,model:this.model});a.render(),this.addView(a)},_renderPane:function(a,b){b.bind("fileChosen",this._onFileChosen,this),b.render(),this._addPane(a,b)},_renderUploadLoader:function(){this._addTab("upload_loader",q.createByTemplate("common/templates/loading",{title:"Uploading asset…",quote:r()}))},_renderLoader:function(){this._addTab("loader",q.createByTemplate("common/templates/loading",{title:"Loading assets…",quote:r()}))},_renderPatternPane:function(){var a=new h({model:this.model,collection:this.collection,kind:this.kind,icons:n.icons,folder:"patterns",size:""});this._renderPane("patterns",a)},_renderSimpleiconPane:function(){var a=new h({model:this.model,collection:this.collection,kind:this.kind,icons:p.icons,disclaimer:p.disclaimer,folder:"simpleicon",size:""});this._renderPane("simple_icons",a)},_renderMakisPane:function(){var a=new h({model:this.model,collection:this.collection,kind:this.kind,icons:m.icons,disclaimer:m.disclaimer,folder:"maki-icons",size:"18"});this._renderPane("maki_icons",a)},_renderUserIconsPane:function(){var a=new i({model:this.model,collection:this.collection,kind:this.kind,folder:"your-icons"});this._renderPane("your_icons",a)},_renderPinIconsPane:function(){var a=new h({model:this.model,collection:this.collection,kind:this.kind,icons:o.icons,disclaimer:o.disclaimer,folder:"pin-maps",size:""});this._renderPane("pin_icons",a)},_renderFilePane:function(){var a=new j({collection:this.collection,kind:this.kind,user:this.options.user});a.bind("valueChange",this._onFileChosen,this),a.bind("show_loader",this._showUploadLoader,this),a.bind("hide_loader",this._hideUploadLoader,this),this._renderPane("upload_file",a)},_renderDropboxPane:function(){if(this.model.get("dropbox_enabled")){var a=new k({model:this.model,collection:this.collection,kind:this.kind,user:this.options.user});a.bind("valueChange",this._onFileChosen,this),a.bind("show_loader",this._showUploadLoader,this),a.bind("hide_loader",this._hideUploadLoader,this),this._renderPane("dropbox",a)}},_renderBoxPane:function(){if(this.model.get("box_enabled")){var a=new l({model:this.model,collection:this.collection,kind:this.kind,user:this.options.user});a.bind("valueChange",this._onFileChosen,this),a.bind("show_loader",this._showUploadLoader,this),a.bind("hide_loader",this._hideUploadLoader,this),this._renderPane("box",a)}},_addPane:function(a,b){this.tabPane.addTab(a,b,{active:this.model.get("pane")===a})},_addTab:function(a,b){this._contentPane.addTab(a,b.render()),this.addView(b)},_validate:function(){if(!this.options.user)throw new TypeError("user is required");if(!this.options.kind)throw new Error("kind should be passed")},_initBinds:function(){this.model.bind("change:pane",this._onChangePane.bind(this))},_onChangePane:function(){if(this.tabPane){this.tabPane.active(this.model.get("pane")),this.model.set("submit_enabled",!1);var a=this.tabPane.getActivePane();a&&this.model.set("disclaimer",a.options.disclaimer)}},_ok:function(){this.trigger("fileChosen",this.model.get("value")),this.close()},_onFileChosen:function(){this.model.set("submit_enabled",!0)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"../../view_helpers/random_quote":212,"../../views/base_dialog/view":213,"./image_picker/assets_view":142,"./image_picker/box_view":143,"./image_picker/data/maki_icons":144,"./image_picker/data/patterns":145,"./image_picker/data/pin_maps":146,"./image_picker/data/simpleicon":147,"./image_picker/dropbox_view":148,"./image_picker/file_upload_view":149,"./image_picker/footer_view":150,"./image_picker/navigation_view":151,"./image_picker/user_icons_view":154}],156:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view");b.exports=e.extend({events:d.core.View.extendEvents({"click .js-option":"_onOptionClick","click .js-skip":"_onSkipClick"}),options:{skipDisabled:!1},initialize:function(){if(this.elder("initialize"),!this.options.table)throw new TypeError("table is required");this.table=this.options.table,this._template=d.templates.getTemplate("common/dialogs/map/scratch_view_template")},render:function(){return this.clearSubViews(),e.prototype.render.call(this),this},render_content:function(){return this._template({name:this.table.get("name"),skipDisabled:this.options.skipDisabled})},_onSkipClick:function(a){this.killEvent(a),this.close(),this.trigger("skip",this)},_onOptionClick:function(a){this.killEvent(a),this.close(),this.trigger("newGeometry",$(a.target).closest(".js-option").data("type"))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../views/base_dialog/view":213}],157:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,g="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,h=a("./choose_key_columns_view"),i=a("./select_columns_model");b.exports=g.core.Model.extend({INSTRUCTIONS_SAFE_HTML:"Select the dataset on the right that you want to merge the left with. You can only merge datasets by joining by columns of the same type (e.g. number to a number).",defaults:{user:void 0,isReadyForNextStep:!1,excludeColumns:[],leftTable:void 0,leftColumns:void 0,rightTableData:void 0,rightColumns:void 0},initialize:function(){this._initColumns()},createView:function(){this.set("gotoNextStep",!1);var a=this.get("leftColumns");return a.each(function(a){a.unset("selected")}),this.get("rightColumns").reset(),this._resetSorting(a),this._resetSorting(this.get("rightColumns")),new h({model:this})},changeRightTable:function(a){this.get("rightColumns").reset(),this.set("rightTableData",a),d.ajax({url:g.config.prefixUrl()+"/api/v1/tables/"+a.id,dataType:"jsonp",success:this._onFetchedColumns.bind(this)})},_onFetchedColumns:function(a){var b=this._filterColumns(a.schema);this.get("rightColumns").reset(b);var c=this.selectedItemFor("leftColumns");c&&this.disableRightColumnsNotMatchingType(c.get("type"))},disableRightColumnsNotMatchingType:function(a){this.get("rightColumns").each(function(b){var c=b.get("type")!==a;c&&b.get("selected")&&b.set("selected",!1),b.set("disabled",c)})},assertIfReadyForNextStep:function(){var a=!!(this.selectedItemFor("leftColumns")&&this.selectedItemFor("rightColumns")&&this.get("rightTableData"));this.set("isReadyForNextStep",a)},nextStep:function(){return new this.constructor.nextStep({user:this.get("user"),leftTable:this.get("leftTable"),leftColumns:this.get("leftColumns"),leftKeyColumn:this.selectedItemFor("leftColumns").clone(),rightKeyColumn:this.selectedItemFor("rightColumns").clone(),rightColumns:this.get("rightColumns"),rightTableData:this.get("rightTableData")})},selectedItemFor:function(a){return this.get(a).find(function(a){return a.get("selected")})},_initColumns:function(){var a=this._filterColumns(this.get("leftTable").get("schema"));this.set("leftColumns",new f.Collection(a)),this.set("rightColumns",new f.Collection([]))},_filterColumns:function(a){var b=this.get("excludeColumns");return e.chain(a).map(function(a){return{name:a[0],type:a[1]}}).reject(function(a){return e.contains(b,a.name)}).value()},_resetSorting:function(a){a.comparator=function(a){return a.get("name")},a.sort()}},{header:{icon:"CDB-IconFont-play",title:"Choose merge column"},nextStep:i})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./choose_key_columns_view":158,"./select_columns_model":162}],158:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("../columns_selector_view"),g=a("../tables_selector_view"),h=a("../footer_view"),i=a("./footer_info_view");b.exports=e.core.View.extend({initialize:function(){this._initViews(),this._initBinds()},render:function(){var a=d(this.getTemplate("common/dialogs/merge_datasets/column_merge/choose_key_columns")({leftTableName:this.model.get("leftTable").get("name")}));return a.find(".js-left-table").append(this._leftTableComboView.render().$el),a.find(".js-left-columns").append(this._leftColumnsView.render().$el),a.find(".js-right-tables").append(this._rightTableSelectorView.render().$el),a.find(".js-right-columns").append(this._rightColumnsView.render().$el),a.append(this._footerView.render().$el),this.$el.html(a),this},_initViews:function(){var a=this.model.get("leftTable").get("name");this._leftTableComboView=new e.forms.Combo({className:"Select",width:"100%",disabled:!0,extra:[a]}),this.addView(this._leftTableComboView),this._leftColumnsView=new f({collection:this.model.get("leftColumns"),excludeFilter:this._columnsExcludeFilter,selectorType:"radio"}),this.addView(this._leftColumnsView),this._rightTableSelectorView=new g({excludeFilter:function(b){return b.get("name")===a}}),this.addView(this._rightTableSelectorView),this._rightColumnsView=new f({collection:this.model.get("rightColumns"),excludeFilter:this._columnsExcludeFilter,selectorType:"radio",loading:"datasets"}),this.addView(this._rightColumnsView),this._footerView=new h({model:this.model,infoView:new i({model:this.model})}),this.addView(this._footerView)},_columnsExcludeFilter:function(a){return"the_geom"===a.get("name")},_initBinds:function(){var a=this.model.get("leftColumns");a.bind("change:selected",this._onChangeSelectedLeftColumn,this),this.add_related_model(a);var b=this.model.get("rightColumns");b.bind("change:selected",this._onChangeSelectedRightColumn,this),b.bind("reset",this._assertIfReadyForNextStep,this),this.add_related_model(b);var c=this._rightTableSelectorView.model;c.bind("change:tableData",this._onChangeRightTableData,this),this.add_related_model(c)},_onChangeSelectedLeftColumn:function(a,b){b&&this.model.disableRightColumnsNotMatchingType(a.get("type")),this._assertIfReadyForNextStep()},_onChangeSelectedRightColumn:function(){this._assertIfReadyForNextStep()},_assertIfReadyForNextStep:function(){this.model.assertIfReadyForNextStep()},_onChangeRightTableData:function(a,b){this._rightColumnsView.model.set("loading","columns"),this.model.changeRightTable(b)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../columns_selector_view":165,"../footer_view":166,"../tables_selector_view":183,"./footer_info_view":160}],159:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("./choose_key_columns_model");b.exports=e.core.Model.extend({ILLUSTRATION_ICON_TYPE:"IllustrationIcon--alert",ICON:"CDB-IconFont-mergeColumns",TITLE:"Column join",DESC:"Merge two datasets based on a shared value (ex. ISO codes in both datasets)",defaults:{user:void 0,table:void 0,excludeColumns:[]},initialize:function(a){if(!a.table)throw new Error("table is required");a.excludeColumns&&!d.isEmpty(a.excludeColumns)||e.log.error("excludeColumns was empty")},isAvailable:function(){return d.chain(this.get("table").get("schema")).map(this._columnDataName).difference(this.get("excludeColumns")).any(this._isntTheGeomName).value()},_columnDataName:function(a){return a[0]},_isntTheGeomName:function(a){return"the_geom"!==a},firstStep:function(){return new f({user:this.get("user"),leftTable:this.get("table"),excludeColumns:this.get("excludeColumns")})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./choose_key_columns_model":157}],160:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({initialize:function(){this._initBinds()},render:function(){var a=this.model.get("leftKeyColumn"),b=this.model.get("rightKeyColumn");return this.$el.html(this.getTemplate("common/dialogs/merge_datasets/column_merge/footer_info")({leftKeyColumnName:a?a.get("name"):"",rightKeyColumnName:b?b.get("name"):""})),this},_initBinds:function(){if(this.model.selectedItemFor){var a=this.model.get("leftColumns");a.bind("change:selected",this._onChangeLeftColumn,this),this.add_related_model(a);var b=this.model.get("rightColumns");b.bind("change:selected",this._onChangeRightColumn,this),this.add_related_model(b)}},_onChangeLeftColumn:function(){var a=this.model.selectedItemFor("leftColumns");this.$(".js-left-key-column").text(a?a.get("name"):"")},_onChangeRightColumn:function(){var a=this.model.selectedItemFor("rightColumns");this.$(".js-right-key-column").text(a?a.get("name"):"").toggleClass("is-placeholder",!a)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],161:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d=function(a,b,c){return"the_geom"===c?["CASE WHEN "+a+"."+c+" IS NULL THEN",b+"."+c,"ELSE",a+"."+c,"END AS",c]:[a+"."+c]};b.exports=function(a){var b=a.leftTableName,e=a.leftColumnsNames,f=a.leftKeyColumnName,g=a.leftKeyColumnType,h=a.rightTableName,i=a.rightColumnsNames,j=a.rightKeyColumnName,k=a.rightKeyColumnType,l=["SELECT"],m=c.map(e,function(a){return d(b,h,a).join(" ")});return m.push.apply(m,c.map(i,function(a){var f=d(h,b,a),g=c.any(e,function(b){return a===b});return g&&(f=f.concat("AS "+h+"_"+a)),f.join(" ")})),l.push(c.flatten(m).join(", ")),l.push("FROM "+b+" FULL OUTER JOIN "+h+" ON"),"string"===g&&"string"===k?l.push("LOWER(TRIM("+b+"."+f+"))","=","LOWER(TRIM("+h+"."+j+"))"):l.push(b+"."+f,"=",h+"."+j),l.join(" ")}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],162:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./select_columns_view"),f=a("./generate_column_merge_sql"),g=a("../merge_step_model");b.exports=d.core.Model.extend({INSTRUCTIONS_SAFE_HTML:"Choose other columns you want in your dataset.",defaults:{user:void 0,isReadyForNextStep:!0,leftTable:void 0,leftKeyColumn:void 0,leftColumns:void 0,rightTableData:void 0,rightColumns:void 0,rightKeyColumn:void 0},createView:function(){return this.set("gotoNextStep",!1),this._resetColumns(this.get("leftColumns"),function(a){a.set("selected",!0)}),this._resetColumns(this.get("rightColumns"),function(a){"the_geom"!==a.get("name")&&a.set("selected",!0),a.set("disabled",!1)}),new e({model:this})},onlyAllowOneSelectedTheGeomColumn:function(a,b){if("the_geom"===a.get("name")){var c=this._theGeomColumnFor("leftColumns"),d=this._theGeomColumnFor("rightColumns");a===c?(c.set("selected",b),d.set("selected",!b)):a===d&&(c.set("selected",!b),d.set("selected",b))}},nextStep:function(){var a=this.get("leftKeyColumn"),b=this.get("rightKeyColumn"),c=f({leftTableName:this.get("leftTable").get("name"),leftKeyColumnName:a.get("name"),leftKeyColumnType:a.get("type"),leftColumnsNames:this._selectedColumnsNamesFor("leftColumns"),rightTableName:this.get("rightTableData").name,rightKeyColumnName:b.get("name"),rightKeyColumnType:b.get("type"),rightColumnsNames:this._selectedColumnsNamesFor("rightColumns")});return new this.constructor.nextStep({user:this.get("user"),tableName:this.get("leftTable").get("name"),sql:c})},_selectedColumnsNamesFor:function(a){return this.get(a).chain().filter(function(a){return a.get("selected")}).map(function(a){return a.get("name")}).value()},_theGeomColumnFor:function(a){return this.get(a).find(function(a){return"the_geom"===a.get("name")})},_resetColumns:function(a,b){a.comparator=function(a){var b=a.get("name");return"the_geom"===b?"00000":b},a.each(b,this),a.sort()}},{header:{icon:"CDB-IconFont-wizard",title:"Choose the rest to add"},nextStep:g})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../merge_step_model":170,"./generate_column_merge_sql":161,"./select_columns_view":163}],163:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("../columns_selector_view"),g=a("../sticky_header_view"),h=a("../footer_view"),i=a("./footer_info_view");b.exports=e.core.View.extend({initialize:function(){this._initViews(),this._initBinds()},render:function(){var a=d(this.getTemplate("common/dialogs/merge_datasets/column_merge/select_columns")({leftKeyColumn:this.model.get("leftKeyColumn"),rightKeyColumn:this.model.get("rightKeyColumn")}));return a.find(".js-sticky-header").append(this._stickyHeaderView.render().$el),a.find(".js-left-table").append(this._leftTableComboView.render().$el),a.find(".js-left-columns").append(this._leftColumnsView.render().$el),a.find(".js-right-table").append(this._rightTableComboView.render().$el),a.find(".js-right-columns").append(this._rightColumnsView.render().$el),a.append(this._footerView.render().$el),this.$el.html(a),this},onChangeKeyColumnsVisiblity:function(){this._stickyHeaderView.$el.slideToggle(200)},_initViews:function(){this._stickyHeaderView=new g({leftKeyColumn:this.model.get("leftKeyColumn"),rightKeyColumn:this.model.get("rightKeyColumn")}),this.addView(this._stickyHeaderView),this._leftTableComboView=new e.forms.Combo({className:"Select",width:"100%",disabled:!0,extra:[this.model.get("leftTable").get("name")]}),this.addView(this._leftTableComboView),this._leftColumnsView=new f({collection:this.model.get("leftColumns"),selectorType:"switch"}),this.addView(this._leftColumnsView),this._rightTableComboView=new e.forms.Combo({className:"Select",width:"100%",disabled:!0,extra:[this.model.get("rightTableData").name]}),this.addView(this._rightTableComboView),this._rightColumnsView=new f({collection:this.model.get("rightColumns"),selectorType:"switch"}),this.addView(this._rightColumnsView),this._footerView=new h({model:this.model,nextLabel:"Merge datasets",infoView:new i({model:this.model})}),this.addView(this._footerView)},_initBinds:function(){this.model.get("leftColumns").bind("change:selected",this._onChangeSelectedColumn,this),this.add_related_model(this.model.get("leftColumns")),this.model.get("rightColumns").bind("change:selected",this._onChangeSelectedColumn,this),this.add_related_model(this.model.get("rightColumns"))},_onChangeSelectedColumn:function(a,b){this.model.onlyAllowOneSelectedTheGeomColumn(a,b)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../columns_selector_view":165,"../footer_view":166,"../sticky_header_view":182,"./footer_info_view":160}],164:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"List-row",events:{click:"_onClick",mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave"},initialize:function(){if(!this.options.selectorType)throw new Error("selectorType is required");this.model=new c.core.Model({type:this.options.selectorType}),this.column=this.options.column,this._initBinds()},render:function(){return this.$el.html(this.getTemplate("common/dialogs/merge_datasets/column_selector")({selectorType:this.model.get("type"),columnName:this.column.get("name"),columnType:this.column.get("type")})),this._tooltip||(this._tooltip=new c.common.TipsyTooltip({el:this.el,offset:-20,trigger:"manual",fallback:"Your column type is not compatible with the column you have selected in the left column"}),this.addView(this._tooltip)),this._onChangeSelected(this.column,this.column.get("selected")),this._onChangeDisabled(this.column,this.column.get("disabled")),this},_initBinds:function(){this.column.bind("change:selected",this._onChangeSelected,this),this.column.bind("change:disabled",this._onChangeDisabled,this),this.add_related_model(this.column)},_onChangeSelected:function(a,b){"radio"===this.model.get("type")&&this.$el.toggleClass("is-selected",!!b),this.$(".js-radio").toggleClass("is-checked",!!b),this.$(".js-switch").prop("checked",!!b)},_onChangeDisabled:function(a,b){b=!!b,this.$el.toggleClass("is-disabled",b)},_onClick:function(a){if(this.killEvent(a),!this._isDisabled()){var b=!this.column.get("selected");(b||"radio"!==this.model.get("type"))&&this.column.set("selected",b)}},_onMouseEnter:function(){this._isDisabled()&&this._tooltip.showTipsy()},_onMouseLeave:function(){this._tooltip.hideTipsy()},_isDisabled:function(){return this.column.get("disabled")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],165:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("./column_selector_view"),g=a("../../view_helpers/random_quote");b.exports=e.core.View.extend({className:"List",events:{"click .js-select-all":"_onClickSelectAll",click:"killEvent"},initialize:function(){this.model=new e.core.Model({showSelectAllToggle:"switch"===this.options.selectorType||!1,enforceSingleSelected:"radio"===this.options.selectorType||!1,loading:this.options.loading}),this._initBinds()},render:function(){if(this.clearSubViews(),this.$el.html(""),this.collection.length>0){var a=this.collection.chain();this.options.excludeFilter&&(a=a.reject(this.options.excludeFilter)),a.each(this._addColumnSelectorView,this),this._renderSelectAllToggle()}else this.model.get("loading")&&this._renderLoading();return this},_renderLoading:function(){this.$el.html(this.getTemplate("common/templates/loading")({title:"Fetching "+this.model.get("loading"),quote:g()}))},_addColumnSelectorView:function(a){var b=new f(d.chain({column:a}).extend(this.options).omit(["el","collection"]).value());this.addView(b),this.$el.append(b.render().$el)},_renderSelectAllToggle:function(){this.model.get("showSelectAllToggle")&&this.$el.append(this.getTemplate("common/dialogs/merge_datasets/columns_selector_toggle_all")({areAllSelected:this._areAllSelected()}))},_initBinds:function(){this.collection.bind("reset",this.render,this),this.collection.bind("change:selected",this._onChangeSelected,this),this.add_related_model(this.collection),this.model.bind("change:loading",this.render,this)},_onChangeSelected:function(a,b){b&&this.model.get("enforceSingleSelected")&&(this._unselectAllExcept(a),this.collection.sort(),this.render()),this.$(".js-select-all input").prop("checked",this._areAllSelected())},_unselectAllExcept:function(a){this.collection.each(function(b){b!==a&&b.set("selected",!1)})},_onClickSelectAll:function(){var a=!this._areAllSelected();this.collection.chain().reject(function(a){return a.get("disabled")}).each(function(b){b.set("selected",a)})},_areAllSelected:function(){return this.collection.all(function(a){return a.get("selected")})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_helpers/random_quote":212,"./column_selector_view":164}],166:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({events:{"click .js-next":"_onClickNext"},initialize:function(){this.options.infoView&&this.addView(this.options.infoView),this._initBinds()},render:function(){return this.$el.html(this.getTemplate("common/dialogs/merge_datasets/footer")({nextLabel:this.options.nextLabel||"next step"})),this._onChangeIsReadyForNextStep(this.model,this.model.get("isReadyForNextStep")),this._maybeRenderInfoView(),this},_maybeRenderInfoView:function(){this.options.infoView&&this.$(".js-info").append(this.options.infoView.render().$el)},_initBinds:function(){this.model.bind("change:isReadyForNextStep",this._onChangeIsReadyForNextStep,this)},_onChangeIsReadyForNextStep:function(a,b){this.$(".js-next").toggleClass("is-disabled",!b)},_onClickNext:function(){this.model.get("isReadyForNextStep")&&this.model.set("gotoNextStep",!0)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});
},{}],167:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,g=a("./column_merge/column_merge_model"),h=a("./spatial_merge/spatial_merge_model");b.exports=f.core.Model.extend({excludeColumns:["cartodb_id","created_at","updated_at","the_geom_webmercator","cartodb_georef_status"],defaults:{mergeFlavors:void 0,prevSteps:[],currentStep:void 0,table:void 0,user:void 0},initialize:function(a){if(!a.table)throw new Error("table is required");if(!a.user)throw new Error("user is required");var b={user:this.get("user"),table:this.get("table"),excludeColumns:this.excludeColumns};this.set("mergeFlavors",new e.Collection([new g(b),new h(b)]))},headerSteps:function(){var a=[],b=this.get("currentStep"),c=this.get("prevSteps")[0]||b,e=!0;if(c)for(var f=c.constructor;f;){if(f.header){var g=f===b.constructor;g&&(e=!1),a.push(d.extend({isFinished:e,isCurrent:g},f.header))}f=f===f.nextStep?void 0:f.nextStep}return a},gotoNextStep:function(){var a=this.get("currentStep"),b=a.nextStep();this.set({prevSteps:this.get("prevSteps").concat(a),currentStep:b})},gotoPrevStep:function(){this.set("currentStep",this.get("prevSteps").pop())}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./column_merge/column_merge_model":159,"./spatial_merge/spatial_merge_model":180}],168:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f=a("../../views/base_dialog/view.js"),g=a("./merge_datasets_model.js"),h=a("./merge_flavor_view");b.exports=f.extend({events:f.extendEvents({"click .js-back":"_onBackClick"}),initialize:function(){this.options.clean_on_hide=!0,this.options.enter_to_confirm=!1,this.elder("initialize"),this.model=new g({table:this.options.table,user:this.options.user}),this._initBinds()},render:function(){if(f.prototype.render.apply(this,arguments),this.$(".content").addClass("Dialog-contentWrapper"),this.$(".js-scroll").off("scroll"),this._stepView&&this._stepView.onChangeKeyColumnsVisiblity){this._areKeyColumnsVisible=!0;var a=this;this.$(".js-scroll").on("scroll",function(b){var c=b.target.scrollTop<=175;c!==a._areKeyColumnsVisible&&(a._areKeyColumnsVisible=c,a._stepView.onChangeKeyColumnsVisiblity(c))})}return this},render_content:function(){this.clearSubViews();var a,b=this.getTemplate("common/dialogs/merge_datasets/merge_datasets_content"),c=this.model.get("currentStep");if(c){var d=this._$renderedStep(c);if(c.get("skipDefaultTemplate"))return d;a=e(b({currentStep:c,headerSteps:this.model.headerSteps()})),a.find(".js-details").append(d)}else{a=e(b({currentStep:void 0}));var f=a.find(".js-flavors");f.append.apply(f,this._$renderedMergeFlavors())}return a},_$renderedMergeFlavors:function(){return this.model.get("mergeFlavors").map(function(a){var b=new h({model:a});return this.addView(b),b.render().$el},this)},_onChangeSelectedMergeFlavor:function(a,b){if(b){a.unset("selected");var c=a.firstStep();this.model.set("currentStep",c),cdb.god.trigger("metrics","visual_merge",{email:window.user_data.email})}},_initBinds:function(){var a=this.model.get("mergeFlavors");a.bind("change:selected",this._onChangeSelectedMergeFlavor,this),this.add_related_model(a),this.model.bind("change:currentStep",this.render,this)},_onChangeGotoNextStep:function(a,b){b&&this.model.gotoNextStep()},_$renderedStep:function(a){return this._stepView&&(this._stepView.clean(),this.removeView(this._stepView),this._stepModel.unbind("change:gotoNextStep"),this._models=d.without(this._models,this._stepModel)),this._stepModel=a,this._stepModel.bind("change:gotoNextStep",this._onChangeGotoNextStep,this),this.add_related_model(this._stepModel),this._stepView=a.createView(),this._stepView.bind("clickedNext",this._onClickNext,this),this.addView(this._stepView),this._stepView.render().$el},_onClickNext:function(a){this.killEvent(a),this.model.gotoNextStep()},_onBackClick:function(a){this.killEvent(a),this.model.gotoPrevStep()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../views/base_dialog/view.js":213,"./merge_datasets_model.js":167,"./merge_flavor_view":169}],169:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"OptionCard OptionCard--blocky",events:{click:"_onClick"},render:function(){return this.$el.html(this.getTemplate("common/dialogs/merge_datasets/merge_flavor")({illustrationIconType:this.model.ILLUSTRATION_ICON_TYPE,icon:this.model.ICON,title:this.model.TITLE,desc:this.model.DESC})),this.model.isAvailable()||this.$el.addClass("is-disabled"),this},_onClick:function(a){this.killEvent(a),this.model.isAvailable()&&this.model.set("selected",!0)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],170:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./merge_step_view");b.exports=d.core.Model.extend({defaults:{skipDefaultTemplate:!0,user:void 0,tableName:"",sql:void 0},createView:function(){return new e({model:this})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./merge_step_view":171}],171:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,g=a("../../view_helpers/random_quote.js"),h=a("../../views/error_details_view");b.exports=f.core.View.extend({initialize:function(){d.bindAll(this,"_onMergeSuccess","_onMergeError"),this._startMerge()},render:function(){return this.$el.html(this.getTemplate("common/templates/loading")({title:"Merging datasets and generating the new one…",quote:g()})),this},_startMerge:function(){e.ajax({type:"POST",url:f.config.prefixUrl()+"/api/v1/imports",data:{table_name:this.model.get("tableName")+"_merge",sql:this.model.get("sql")},success:this._onMergeSuccess,error:this._onMergeError})},_onMergeSuccess:function(a){var b=this.importation=new f.admin.Import({item_queue_id:a.item_queue_id});this.add_related_model(b),b.bind("importComplete",function(){b.unbind(),window.location.href=f.config.prefixUrl()+"/tables/"+(b.get("table_name")||b.get("table_id"))+"/"},this);var c=this;b.bind("importError",function(a){c._showError(a.attributes.error_code,a.attributes.get_error_text.title,a.attributes.get_error_text.what_about,a.attributes.item_queue_id)},this),b.pollCheck()},_onMergeError:function(a){try{this._showError(a.attributes.error_code,a.attributes.get_error_text.title,a.attributes.get_error_text.what_about,a.attributes.item_queue_id)}catch(a){this._showError("99999","Unknown","")}},_showError:function(a,b,c,d){var e=new h({err:{error_code:a,title:b,what_about:c,item_queue_id:d},user:this.model.get("user")});this.addView(e),this.$el.html(e.render().el)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_helpers/random_quote.js":212,"../../views/error_details_view":215}],172:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./spatial_merge_view"),f=a("../merge_step_model"),g=a("./generate_spatial_merge_sql");b.exports=d.core.Model.extend({INSTRUCTIONS_SAFE_HTML:"Calculate the intersecting geospatial records between two datasets (ex. points in polygons).<br/>You'll need to decide the operation to perform here.",defaults:{isReadyForNextStep:!1,user:void 0,mergeMethods:void 0,leftTable:void 0,leftKeyColumn:void 0,leftColumns:void 0,rightTableData:void 0,rightKeyColumn:void 0,rightColumns:void 0},createView:function(){return this.set("gotoNextStep",!1),this.get("mergeMethods").each(function(a){a.set("disabled",!this.isCountMergeMethod(a))},this),this.get("rightColumns").comparator=function(a){return a.get("name")},new e({model:this})},selectedMergeMethod:function(){return this.get("mergeMethods").find(this._isSelectedColumn)},selectedRightMergeColumn:function(){return this.get("rightColumns").find(this._isSelectedColumn)},changedRightMergeColumn:function(a){this._updateMergeMethods(a),this._assertIfReadyForNextStep()},changedSelectedMergeMethod:function(a){var b=this.get("mergeMethods").chain().without(a);b.each(this._deselect),this.isCountMergeMethod(a)?(b.each(this._enable),this.get("rightColumns").each(this._deselect)):this._updateMergeMethods(this.selectedRightMergeColumn()),this._assertIfReadyForNextStep()},_updateMergeMethods:function(a){this.get("mergeMethods").each(function(b){b.changedMergeColumn(a)})},isCountMergeMethod:function(a){return a&&"count"===a.NAME},nextStep:function(){return new this.constructor.nextStep({user:this.get("user"),tableName:this.get("leftTable").get("name"),sql:this._sqlForMergeMethod()})},_deselect:function(a){a.set("selected",!1)},_disable:function(a){a.set("disabled",!0)},_enable:function(a){a.set("disabled",!1)},_assertIfReadyForNextStep:function(){var a=this.selectedMergeMethod(),b=a&&(this.isCountMergeMethod(a)||!a.get("disabled")&&this.selectedRightMergeColumn());this.set("isReadyForNextStep",b)},_sqlForMergeMethod:function(){var a=this.get("rightTableData").name,b=this.selectedMergeMethod(),c=this.selectedRightMergeColumn(),d=b.sqlSelectClause(a,c?c.get("name"):"");return g({leftTableName:this.get("leftTable").get("name"),leftColumnsNames:this._selectedLeftColumnsNames(),rightTableName:a,selectClause:d,intersectType:b.NAME})},_selectedLeftColumnsNames:function(){return this.get("leftColumns").filter(this._isSelectedColumn).map(function(a){return a.get("name")})},_isSelectedColumn:function(a){return a.get("selected")}},{header:{icon:"CDB-IconFont-wizard",title:"Choose merge columns"},nextStep:f})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../merge_step_model":170,"./generate_spatial_merge_sql":175,"./spatial_merge_view":181}],173:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,g="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,h=a("./merge_methods/sum_merge_method"),i=a("./merge_methods/avg_merge_method"),j=a("./merge_methods/count_merge_method"),k=a("./spatial_merge_view"),l=a("./choose_merge_method_model");b.exports=d.core.Model.extend({INSTRUCTIONS_SAFE_HTML:"Calculate the intersecting geospatial records between two datasets (ex. points in polygons).<br/>You'll need to decide the operation to perform here.",defaults:{user:void 0,leftTable:void 0,excludeColumns:void 0,leftKeyColumn:void 0,leftColumns:void 0,mergeMethods:void 0,rightTableData:void 0,rightColumns:void 0},initialize:function(a){if(!a.leftTable)throw new Error("leftTable is required");a.excludeColumns&&!f.isEmpty(a.excludeColumns)||d.log.error("excludeColumns was empty"),this._initColumns(),this._initLeftKeyColumn(),this._initMergeMethods()},createView:function(){return this.set({gotoNextStep:!1,rightTableData:void 0}),this.get("mergeMethods").each(function(a){a.set({selected:!1,disabled:!0})}),this.get("rightColumns").reset(),new k({model:this})},assertIfReadyForNextStep:function(){return!1},fetchRightColumns:function(a){this.set("rightTableData",a),e.ajax({url:d.config.prefixUrl()+"/api/v1/tables/"+a.id,dataType:"jsonp",success:this._onFetchedRightColumns.bind(this)})},nextStep:function(){return new this.constructor.nextStep({user:this.get("user"),mergeMethods:this.get("mergeMethods"),leftTable:this.get("leftTable"),leftKeyColumn:this.get("leftKeyColumn"),leftColumns:this.get("leftColumns"),rightTableData:this.get("rightTableData"),rightKeyColumn:this._rightKeyColumn(),rightColumns:this.get("rightColumns")})},_initColumns:function(){var a=this._filterColumns(this.get("leftTable").get("schema"));this.set("leftColumns",new g.Collection(a)),this.set("rightColumns",new g.Collection)},_initMergeMethods:function(){var a=new g.Collection([new h,new j,new i]);this.set("mergeMethods",a)},_filterColumns:function(a){var b=this.get("excludeColumns");return f.chain(a).map(this._columnDataToColumn).reject(function(a){return f.contains(b,a.name)}).value()},_columnDataToColumn:function(a){return{name:a[0],type:a[1]}},_initLeftKeyColumn:function(){var a=this.get("leftColumns").find(this._isColumnTheGeom);this.set("leftKeyColumn",a.clone())},_onFetchedRightColumns:function(a){var b=this._filterColumns(a.schema);this.get("rightColumns").reset(b,{silent:!0}),this.set("gotoNextStep",!0)},_rightKeyColumn:function(){return this.get("rightColumns").find(this._isColumnTheGeom).clone()},_isColumnTheGeom:function(a){return"the_geom"===a.get("name")}},{header:{icon:"CDB-IconFont-play",title:"Choose dataset to merge"},nextStep:l})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./choose_merge_method_model":172,"./merge_methods/avg_merge_method":177,"./merge_methods/count_merge_method":178,"./merge_methods/sum_merge_method":179,"./spatial_merge_view":181}],174:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({initialize:function(){this._initBinds()},render:function(){var a=this.model.get("rightColumns");return this.$el.html(this.getTemplate("common/dialogs/merge_datasets/spatial_merge/footer_info")({leftTableName:this.model.get("leftTable").get("name"),rightColumnName:a?a.get("name"):""})),this},_initBinds:function(){var a=this.model.get("rightColumns");a.bind("change:selected",this._updatePieces,this),this.add_related_model(a);var b=this.model.get("mergeMethods");b.bind("change:selected",this._updatePieces,this),this.add_related_model(b)},_updatePieces:function(){var a=this.model.selectedMergeMethod();if(this.$(".js-merge-method-name").text(a?a.NAME:""),this.model.isCountMergeMethod(a))this._changeRightPiece(this.model.get("rightTableData").name);else{var b=this.model.selectedRightMergeColumn();this._changeRightPiece(b?b.get("name"):"")}},_changeRightPiece:function(a){this.$(".js-right").text(a||"").toggleClass("is-placeholder",!a)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],175:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=function(a){var b=a.leftTableName,d=a.leftColumnsNames,e=a.rightTableName,f=a.selectClause,g=a.intersectType,h=["SELECT",b+".cartodb_id,",b+".the_geom_webmercator,",b+".the_geom,"];return c.each(d,function(a){"the_geom"!==a&&h.push(b+"."+a+",")}),h.push("(SELECT "+f+" FROM "+e,"WHERE ST_Intersects("+b+".the_geom, "+e+".the_geom)",") AS intersect_"+g,"FROM "+b),h.join(" ")}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],176:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"TabLink TabLink--positive TabLink--textCenterUpcase",events:{hover:"_onHover",mouseout:"_onMouseOut",click:"_onClick"},initialize:function(){this._initBinds()},render:function(){var a=this.model.get("disabled");return this.$el.text(this.model.NAME).toggleClass("disabled",a).toggleClass("selected",this.model.get("selected")&&!a),a&&this._tooltipView().show(),this},_tooltipView:function(){return this._tooltip||(this._tooltip=new c.common.TipsyTooltip({el:this.$el,trigger:"manual",title:function(){return"Select a column of type number to use this merge method"}}),this.addView(this._tooltip)),this._tooltip},_initBinds:function(){this.model.bind("change:selected",this.render,this),this.model.bind("change:disabled",this.render,this)},_onHover:function(a){this.killEvent(a),this.model.get("disabled")&&this._tooltip.showTipsy()},_onMouseOut:function(a){this.killEvent(a),this._tooltip&&this._tooltip.hideTipsy()},_onClick:function(a){this.killEvent(a),this.model.get("disabled")||this.model.set("selected",!0)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],177:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({NAME:"avg",defaults:{disabled:!1,selected:!1},changedMergeColumn:function(a){var b=!a||"number"!==a.get("type");this.set({disabled:b,selected:this.get("selected")&&!b})},sqlSelectClause:function(a,b){return"AVG("+a+"."+b+")"}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],178:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({NAME:"count",defaults:{disabled:!1,selected:!1},changedMergeColumn:function(a){},sqlSelectClause:function(){return"COUNT(*)"}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],179:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({NAME:"sum",defaults:{disabled:!1,selected:!1},changedMergeColumn:function(a){var b=!a||"number"!==a.get("type");this.set({disabled:b,selected:this.get("selected")&&!b})},sqlSelectClause:function(a,b){return"SUM("+a+"."+b+")"}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],180:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./choose_right_dataset_model");b.exports=d.core.Model.extend({ILLUSTRATION_ICON_TYPE:"IllustrationIcon--royal",ICON:"CDB-IconFont-mergeSpatial",TITLE:"Spatial join",DESC:"Measure the number of intesecting records between two datasets (ex. count point inside polygons)",defaults:{user:void 0,table:void 0,excludeColumns:[]},initialize:function(a){if(!a.user)throw new Error("user is required");if(!a.table)throw new Error("table is required");a.excludeColumns&&!e.isEmpty(a.excludeColumns)||d.log.error("excludeColumns was empty")},isAvailable:function(){return!0},firstStep:function(){return new f({user:this.get("user"),leftTable:this.get("table"),excludeColumns:this.get("excludeColumns")})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./choose_right_dataset_model":173}],181:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,g=a("../columns_selector_view"),h=a("../tables_selector_view"),i=a("./merge_method_view"),j=a("../sticky_header_view"),k=a("../footer_view"),l=a("./footer_info_view");b.exports=f.core.View.extend({initialize:function(){this._initViews(),this._initBinds()},render:function(){var a=this._hasSelectedRightTable(),b=d(this.getTemplate("common/dialogs/merge_datasets/spatial_merge/spatial_merge")({leftKeyColumn:this.model.get("leftKeyColumn"),hasSelectedRightTable:a,rightKeyColumn:this.model.get("rightKeyColumn"),rightColumns:this.model.get("rightColumns")}));return b.find(".js-left-table").append(this._leftTableComboView.render().$el),b.find(".js-left-columns").append(this._leftColumnsView.render().$el),b.find(".js-right-columns").append(this._rightColumnsView.render().$el),b.append(this._footerView.render().$el),a?(b.find(".js-sticky-header").append(this._stickyHeaderView.render().$el),b.find(".js-right-table").append(this._rightTableComboView.render().$el),this._renderMergeMethods(b.find(".js-merge-methods"))):b.find(".js-right-tables").append(this._rightTablesSelectorView.render().$el),this.$el.html(b),this},onChangeKeyColumnsVisiblity:function(){this._hasSelectedRightTable()&&this._stickyHeaderView.$el.slideToggle(200)},_hasSelectedRightTable:function(){return e.isObject(this.model.get("rightTableData"))},_initViews:function(){this._leftTableComboView=new f.forms.Combo({className:"Select",width:"100%",disabled:!0,extra:[this.model.get("leftTable").get("name")]}),this.addView(this._leftTableComboView),this._leftColumnsView=new g({collection:this.model.get("leftColumns"),excludeFilter:this._columnsExcludeFilter,selectorType:"switch"}),this.addView(this._leftColumnsView);var a,b=this.model.get("rightTableData");b?(this._stickyHeaderView=new j({leftKeyColumn:this.model.get("leftKeyColumn"),rightKeyColumn:this.model.get("rightKeyColumn"),addRadioPlaceholder:!0}),this.addView(this._stickyHeaderView),this._rightTableComboView=new f.forms.Combo({className:"Select",width:"100%",disabled:!0,extra:[this.model.get("rightTableData").name]}),this.addView(this._rightTableComboView),a=new l({model:this.model})):(this._rightTablesSelectorView=new h({excludeFilter:this._rightTablesExcludeFilter.bind(this),initialOption:{label:b?b.name:"Select dataset"}}),this.addView(this._rightTablesSelectorView)),this._rightColumnsView=new g({collection:this.model.get("rightColumns"),excludeFilter:this._columnsExcludeFilter,selectorType:"radio"}),this.addView(this._rightColumnsView),this._mergeMethodViews=this.model.get("mergeMethods").map(this._createMergeMethodView,this),this._footerView=new k({model:this.model,nextLabel:b?"Merge datasets":void 0,infoView:a}),this.addView(this._footerView)},_createMergeMethodView:function(a){var b=new i({model:a});return this.addView(b),b},_initBinds:function(){var a=this.model.get("rightColumns");a.bind("change:selected",this._onChangeSelectedRightColumn,this),this.add_related_model(a);var b=this.model.get("mergeMethods");b&&(b.bind("change:selected",this._onChangeSelectedMergeMethod,this),this.add_related_model(b)),this._rightTablesSelectorView&&(this._rightTablesSelectorView.model.bind("change:tableData",this._onChangeRightTableData,this),this.add_related_model(this._rightTablesSelectorView.model))},_onChangeRightTableData:function(a,b){this._rightColumnsView.model.set("loading","columns"),this.model.fetchRightColumns(b)},_onChangeSelectedRightColumn:function(a,b){b&&this.model.changedRightMergeColumn(a)},_onChangeSelectedMergeMethod:function(a,b){if(b){this.model.changedSelectedMergeMethod(a);var c=this.model.isCountMergeMethod(a);this.$(".js-count-merge-method-info").toggle(c),this.$(".js-right-columns").toggle(!c)}},_renderMergeMethods:function(a){a.append.apply(a,this._$renderedMergeMethodViews())},_$renderedMergeMethodViews:function(){return e.map(this._mergeMethodViews,function(a){return a.render().$el})},_columnsExcludeFilter:function(a){return"the_geom"===a.get("name")},_rightTablesExcludeFilter:function(a){return a.get("name")===this.model.get("leftTable").get("name")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../columns_selector_view":165,"../footer_view":166,"../sticky_header_view":182,"../tables_selector_view":183,"./footer_info_view":174,"./merge_method_view":176}],182:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"MergeDatasets-stickyHeader",attributes:{style:"display: none"},render:function(){var a=this.options.leftKeyColumn,b=this.options.rightKeyColumn;return this.$el.html(this.getTemplate("common/dialogs/merge_datasets/sticky_header")({leftColumnName:a.get("name"),leftColumnType:a.get("type"),rightColumnName:b.get("name"),rightColumnType:b.get("type"),addRadioPlaceholder:this.options.addRadioPlaceholder})),this}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],183:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.forms.Combo.extend({className:"Select",initialize:function(){this.options.width="100%",this.options.disabled=!0,this.options.extra=[this._initialOptionDataItem()||"Loading tables…"],this.options.excludeFilter=this.options.excludeFilter||function(){},this.elder("initialize"),this.model=this.model||new d.core.Model,this._initVisualizations(),this._initBinds(),this._fetchTables()},_formatResult:function(a){return JSON.stringify(a)},_initVisualizations:function(){var a=new d.admin.Visualizations;a.options.set({type:"table",per_page:1e5,table_data:!1}),this.model.set("visualizations",a)},_initBinds:function(){this.bind("change",this._onChangeOption,this);var a=this.model.get("visualizations");a.bind("reset",this._onResetTables,this),this.add_related_model(a)},_fetchTables:function(){this.model.get("visualizations").fetch({data:{o:{updated_at:"desc"},exclude_raster:!0}})},_onResetTables:function(){this.options.disabled=!1;var a=this.model.get("visualizations").reject(this.options.excludeFilter),b=c.map(a,this._visToComboDataItem,this),d=this._initialOptionDataItem();d&&b.unshift(d),this.updateData(b);var e=a[0];!d&&e&&this._onChangeOption(e.id)},_visToComboDataItem:function(a){return this._comboDataItem(a.get("name"),a.id)},_initialOptionDataItem:function(){if(c.isObject(this.options.initialOption)){var a=this.options.initialOption;return this._comboDataItem(a.label,a.value)}},_comboDataItem:function(a,b){return[a,b]},_onChangeOption:function(a){var b=this.model.get("visualizations").get(a);this.model.set("tableData",b?b.get("table"):void 0)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],184:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,g=a("cartodb-pecan");b.exports=d.core.View.extend({_CARD_WIDTH:288,_CARD_HEIGHT:170,_TABS_PER_ROW:3,_GET_BBOX_FROM_THE_GEOM:!0,tagName:"li",className:"GalleryList-item MapsList-item js-card",events:{"click ":"_onClick"},initialize:function(){this.template=d.templates.getTemplate("common/dialogs/pecan/card")},render:function(){var a=this.options.url+"?api_key="+this.options.api_key,b=this.model.get("visualizationType").charAt(0).toUpperCase()+this.model.get("visualizationType").slice(1),c=+(this.model.get("null_ratio")*this.model.get("count")).toFixed(2),e=f.formatNumber(c);this.$el.html(this.template({column:this.model.get("column"),wizard:b,metadata:this.model.get("metadata"),null_count:e,weight:this.model.get("weight")})),"choropleth"===this.model.get("visualizationType")&&this._addHistogram();var g=this,h=new Image;return h.onerror=function(){d.log.info("error loading the image for "+g.model.get("column"))},h.onload=function(){g.$(".js-loader").hide(),g.$(".js-header").append('<img class="MapCard-preview" src="'+a+'" />'),g.$("img").show()},h.src=a,this},_onClick:function(a){this.killEvent(a),this.trigger("click",this.model,this)},_addHistogram:function(){var a=this.model.get("cat_hist").slice(0,7);a=e.sortBy(a,function(a){return a[0]});var b=g.getMethodProperties(this.model.attributes).name,c=37,h=11,i=2,j=d3.scale.ordinal().rangeRoundBands([0,c],.1),k=d3.scale.linear().range([h,0]),l=d3.svg.axis().scale(j).orient("bottom"),m=d3.select(this.$(".js-graph")[0]).append("svg").attr("width",c).attr("height",h).append("g");return j.domain(a.map(function(a){return a[0]})),k.domain([0,d3.max(a,function(a){return a[1]})]),m.append("g").attr("class","x axis").attr("transform","translate(0,"+h+")").call(l),m.selectAll(".bar").data(a).enter().append("rect").attr("fill",function(a,c){return d.admin.color_ramps[b][7][c]}).attr("class","HistogramGraph-bar").attr("data-title",function(a){return f.formatNumber(a[1])}).attr("x",function(a){return j(a[0])}).attr("width",4).attr("y",function(a){var b=h-k(a[1]),c=k(a[1]);return b<i?h-i:c}).attr("height",function(a){var b=h-k(a[1]);return b<i?i:b}),this}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"cartodb-pecan":234}],185:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=("undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,a("cartodb-pecan")),f=a("../../views/base_dialog/view"),g=a("../../view_factory"),h=a("../../view_helpers/random_quote"),i=a("./pecan_card");b.exports=f.extend({_CARD_MARGIN:20,_CARD_WIDTH:288,_CARD_HEIGHT:170,_STROKE_PX_LIMIT:.04,_TABS_PER_ROW:3,_GET_BBOX_FROM_THE_GEOM:!0,_DEFAULT_BASEMAP_TEMPLATE:"http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",_SUPPORTED_BASEMAPS:["light_all","dark_all","light_nolabels","dark_nolabels","base-antique","base-flatblue","toner","watercolor"],events:f.extendEvents({"click .js-goPrev":"_prevPage","click .js-goNext":"_nextPage","click .js-skip":"cancel"}),initialize:function(){if(this.elder("initialize"),!this.options.vis)throw new Error("vis is required");if(!this.options.user)throw new Error("user is required");this.columns=this.options.collection,this.add_related_model(this.collection),this._initModels(),this._initViews(),this._initBinds()},render_content:function(){return this._panes.getActivePane().render().el},render:function(){return f.prototype.render.apply(this,arguments),this},_initModels:function(){this.model=new d.core.Model({page:1,maxPages:0})},_initViews:function(){_.bindAll(this,"_addCard","_generateThumbnail","_refreshMapList","_setWizardProperties"),this.vis=this.options.vis,this.map=this.vis.map,this.user=this.options.user,this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("vis",g.createByTemplate("common/dialogs/pecan/template",{})),this._panes.addTab("applying",g.createByTemplate("common/templates/loading",{title:"Applying style…",quote:h()})),this._panes.addTab("loading",g.createByTemplate("common/templates/loading",{title:"Loading previews…",quote:h()})),this._getBBox(),this._sendOpenStats(),this._loadCards()},_initBinds:function(){this.model.bind("change:page",this._moveTabsNavigation,this),this._panes.bind("tabEnabled",this.render,this)},_getBBox:function(){this.columns.each(function(a){"the_geom"===a.get("column")&&(this.bbox=a.get("bbox"))},this)},_loadCards:function(){this.columns.each(this._loadCard,this)},_loadCard:function(a){var b=this;a.get("success")&&this._generateThumbnail(a,function(c,e){c?d.log.error(c):b._addCard(e,a)})},_sendAppliedStats:function(){d.god.trigger("metrics","applied_pecan",{email:window.user_data.email})},_sendOpenStats:function(){d.god.trigger("metrics","open_pecan_list",{email:window.user_data.email})},_skip:function(){var a,b=this.vis.get("active_layer_id"),c=this.vis.map.layers.where({id:b});c&&(a=c[0].table.get("name"));var d="pecan_"+this.options.user.get("username")+"_"+a;localStorage[d]=!0},_nextPage:function(){var a=this.model.get("page"),b=this.model.get("maxPages");a<b&&this.model.set("page",a+1)},_prevPage:function(){var a=this.model.get("page");a>1&&this.model.set("page",a-1)},_moveTabsNavigation:function(){var a=this.model.get("page"),b=960,c=b*(a-1);this.$(".js-map-list").css("margin-left","-"+c+"px"),this._refreshNavigation()},_refreshNavigation:function(){var a=this.model.get("page"),b=this.model.get("maxPages");this.$(".js-goPrev")[a>1?"removeClass":"addClass"]("is-disabled"),
this.$(".js-goNext")[a<b?"removeClass":"addClass"]("is-disabled")},_hideNavigation:function(){this.$(".js-navigation").addClass("is-hidden")},_setupCSS:function(a,b){var c=this.options.vis.tableMetadata().get("row_count"),d=c/(this._CARD_WIDTH*this._CARD_HEIGHT),e=d>this._STROKE_PX_LIMIT;return"line"!==b&&e&&(a=a.replace("marker-line-width: 1;","marker-line-width: 0.7;"),a=a.replace("marker-width: 10;","marker-width: 7;")),a},_setupTemplate:function(){var a=this.map.getLayerAt(0).get("urlTemplate");if(a)var b=_.find(this._SUPPORTED_BASEMAPS,function(b){return a.indexOf(b)!==-1});return a&&b||(a=this._DEFAULT_BASEMAP_TEMPLATE),a},_generateLayerDefinition:function(a){var b=a.get("visualizationType"),c=a.get("sql"),e=this._setupCSS(a.get("css"),a.get("geometryType")),f=this.user.get("api_key"),g=d.config.get("maps_api_template"),h=this._setupTemplate(),i={user_name:user_data.username,maps_api_template:g,api_key:f,layers:[{type:"http",options:{urlTemplate:h,subdomains:["a","b","c"]}},{type:"cartodb",options:{sql:c,cartocss:e,cartocss_version:"2.1.1"}}]};return"torque"!==b&&"heatmap"!==b||(i.layers[1]={type:"torque",options:{sql:c,cartocss:e,cartocss_version:"2.1.1"}}),i},_generateThumbnail:function(a,b){var c=this._generateLayerDefinition(a),e=function(a,c){b&&b(a,c)};this.columns.find(function(a){return"the_geom"===a.get("column")});this.bbox&&this._GET_BBOX_FROM_THE_GEOM?d.Image(c).size(this._CARD_WIDTH,this._CARD_HEIGHT).bbox(this.bbox).getUrl(e):d.Image(c).size(this._CARD_WIDTH,this._CARD_HEIGHT).zoom(this.map.get("zoom")).center(this.map.get("center")).getUrl(e)},_addCard:function(a,b){var c=new i({url:a,urlTemplate:this.map.getLayerAt(0).get("urlTemplate"),api_key:this.user.get("api_key"),model:b});c.bind("click",this._onCardClick,this),c.render(),this._panes.active("vis"),this._getSuccessColumns().length<3&&this.$(".js-map-list").addClass("is--centered"),"heatmap"===b.get("visualizationType")||"torque"===b.get("visualizationType")?this.$(".js-map-list").prepend(c.$el):this.$(".js-map-list").append(c.$el),this._refreshMapList(c.$el),this._refreshNavigation()},_refreshMapList:function(a){var b=a.width(),c=this.$(".js-card").length;this.$(".js-map-list").width(b*c+(c-1)*this._CARD_MARGIN),this.model.set("maxPages",Math.ceil(this.$(".js-card").size()/this._TABS_PER_ROW))},_getSuccessColumns:function(){return this.columns.filter(function(a){return a.get("success")})},_bindDataLayer:function(){this.layer.wizard_properties.unbind("load",this._setWizardProperties,this),this.layer.wizard_properties.bind("load",this._setWizardProperties,this)},_getProperties:function(a){var b=a.get("column"),c=this._getWizardName(a.get("visualizationType")),d={property:b};return"category"===c?this._getCategoriesProperties(d):"choropleth"===c?this._getChoroplethProperties(d):"heatmap"===c?this._getHeatmapProperties(d):void 0},_onCardClick:function(a){this._panes.active("applying"),this.model.set("column",a),this._skip(),this.layer=this._getDataLayer(),this._sendAppliedStats();var b=this._getWizardName(a.get("visualizationType")),c=this._getProperties(a);this._bindDataLayer(),this.layer.wizard_properties.active(b,c)},_getWizardName:function(a){var b={heatmap:"torque_heat"};return b[a]||a},_getDataLayer:function(){return this.map.layers.getDataLayers()[0]},_setWizardProperties:function(){var a=this._getProperties(this.model.get("column"));this.layer.wizard_properties.unbind("load",this._setWizardProperties,this),a&&this.layer.wizard_properties.set(a),this.close()},_getChoroplethProperties:function(a){var b=this.model.get("column"),c=(b.get("column"),b.get("type"),b.get("dist_type")),d=b.get("stats");return a.qfunction=this._getQFunction(c),a.color_ramp=e.getMethodProperties(d).name,a},_getCategoriesProperties:function(a){var b=this.model.get("column");return a.metadata=b.get("metadata"),a.categories=b.get("metadata"),a},_getHeatmapProperties:function(a){return a.property="cartodb_id",a["torque-resolution"]=2,a},_getQFunction:function(a){var b="Jenks";return"L"===a||"J"==a?b="Heads/Tails":"A"===a||"U"==a?b="Jenks":"F"===a&&(b="Quantile"),b},_keydown:function(a){a.keyCode===$.ui.keyCode.LEFT?this._prevPage():a.keyCode===$.ui.keyCode.RIGHT&&this._nextPage(),f.prototype._keydown.call(this,a)},clean:function(){this.layer&&this.layer.wizard_properties.unbind("load",this._setWizardProperties,this),f.prototype.clean.call(this)},cancel:function(a){this.killEvent(a),this.model.set("disabled",!0),this._skip(),this.elder("cancel")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"../../view_helpers/random_quote":212,"../../views/base_dialog/view":213,"./pecan_card":184,"cartodb-pecan":234}],186:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;"undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,a("../../views/base_dialog/view"),a("../../view_factory"),a("../../view_helpers/random_quote");b.exports=d.core.View.extend({_MAX_ROWS:1e5,_MAX_COLS:60,_EXCLUDED_COLUMNS:["cartodb_id","lat","lon","lng","long","latitude","longitude","longitudenumber","latitudenumber","minlat","maxlat","minlon","maxlon","minlng","maxlng","center_lat","centerlat","center_lon","centerlon","latdd","longdd","shape_length","shape_area","objectid","id","created_at","updated_at","iso2","iso3","x","y","x_coord","y_coord","xcoord","ycoord","coord_x","coord_y","coordx","coordy","cartodb_georef_status","scalerank","strokweig","country","state","area_sqkm","region","subregion","funcstat","classfp","county_fip","county","aland10"],initialize:function(){if(this.elder("initialize"),!this.options.table)throw new Error("table is required");this._initModels(),this._initViews()},_check:function(){var a=this.options.table.isGeoreferenced(),b=this.options.table.data(),c=b.table&&b.table.get("geometry_types"),d=!!(c&&c.length>0),e=b.table.get("rows_counted"),f=e>0&&e<this._MAX_ROWS,g=_(this.query_schema).size(),h=g>0&&g<this._MAX_COLS;return a&&d&&f&&h},_initModels:function(){this.columns=new Backbone.Collection,this.model=new d.core.Model({page:1,maxPages:0})},_initViews:function(){this.table=this.options.table,this.query_schema=this.table.data().query_schema,this.backgroundPollingModel=this.options.backgroundPollingModel,this._check()&&this.backgroundPollingModel.canAddAnalysis()&&(this._setupColumns(),this._start())},_getSimplifiedGeometryType:function(a){return{st_multipolygon:"polygon",st_polygon:"polygon",st_multilinestring:"line",st_linestring:"line",st_multipoint:"point",st_point:"point"}[a.toLowerCase()]},_getGeometryType:function(){var a=this.table.data().table.get("geometry_types");return this._getSimplifiedGeometryType(a[0])},_start:function(){var a=this.columns.map(function(a){return{table_id:this.table.id,column:a.get("name"),geometry_type:a.get("geometry_type")}},this);this.backgroundPollingModel.addAnalysis(a)},_setupColumns:function(){_(this.query_schema).each(function(a,b){_.include(this._EXCLUDED_COLUMNS,b)||this.columns.add({name:b.concat(""),geometry_type:this._getGeometryType()})},this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"../../view_helpers/random_quote":212,"../../views/base_dialog/view":213}],187:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({isDisabled:function(){return this.get("isPrivacyPrivate")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],188:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"OptionCard OptionCard--static",events:{"click input":"_onClickInput"},initialize:function(){this.elder("initialize"),this._template=c.templates.getTemplate(this.model.get("template")),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this._template({model:this.model})),this.$el.toggleClass("is-disabled",!!this.model.isDisabled()),this},_initBinds:function(){this.model.bind("change",this.render,this)},_onClickInput:function(a){this.killEvent(a),this.$("input").select()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],189:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,g="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,h=a("../../views/base_dialog/view"),i=a("./publish_option_view"),j=a("./options/view_model");b.exports=h.extend({events:function(){return e.extend({},h.prototype.events,{"click .js-change-privacy":"_openPrivacyDialog"})},initialize:function(){if(this.elder("initialize"),!this.model)throw new Error("model (vis) is required");if(!this.options.user)throw new Error("user is required");this._initOptions(),this._initBinds()},render_content:function(){this.clearSubViews();var a=f(d.templates.getTemplate("common/dialogs/publish/publish")({}));return this._options.each(function(b){var c=new i({model:b});this.addView(c),a.find(".js-publish-options").append(c.render().el)},this),d.god.trigger("metrics","published_visualization",{email:window.user_data.email}),a},_initOptions:function(){this._options=new g.Collection,this._publicUrlOption=new j({template:"common/dialogs/publish/options/public_url"}),this._options.add(this._publicUrlOption),this._embedOption=new j({template:"common/dialogs/publish/options/embed",embedURL:this.model.embedURL()}),this._options.add(this._embedOption),this._options.add(new j({template:"common/dialogs/publish/options/cdb",vizjsonURL:this.model.vizjsonURL()})),this._updateOptionsWithNewPrivacy()},_updateOptionsWithNewPrivacy:function(){var a="PRIVATE"===this.model.get("privacy");if(this._publicUrlOption.set("isPrivacyPrivate",a),this._embedOption.set("isPrivacyPrivate",a),!a){var b=this.model.publicURL();this._publicUrlOption.set({url:b})}},_initBinds:function(){this.model.bind("change:privacy",this._updateOptionsWithNewPrivacy,this)},_openPrivacyDialog:function(a){this.killEvent(a);var b=new d.editor.ChangePrivacyView({vis:this.model,user:this.options.user,clean_on_hide:!0,enter_to_confirm:!0}),c=this.options.clean_on_hide;this.options.clean_on_hide=!1,this.close(),b.appendToBody();var e=this,f=function(){b.unbind("hide",f),e.options.clean_on_hide=c,e.show(),b.close()};b.bind("hide",f)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../views/base_dialog/view":213,"./options/view_model":187,"./publish_option_view":188}],190:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view");a("../../view_factory"),a("../../view_helpers/random_quote"),"undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null;b.exports=e.extend({_FORMAT:"png",events:e.extendEvents({"click .js-format":"_onClickFormat","keyup .js-textInput":"_onKeyUp","focus .js-textInput":"_onFocus","blur .js-textInput":"_onBlur"}),initialize:function(){this.elder("initialize"),this.options=_.defaults(this.options,{format:this._FORMAT}),this.model=new d.core.Model(this.options),this.mapView=this.options.mapView,this._initBinds()},render_content:function(){return this.getTemplate("common/dialogs/static_image/advanced_export_view")(this.model.attributes)},_initBinds:function(){this.model.on("change:format",this._onChangeFormat,this)},_onKeyUp:function(a){var b=+$(a.target).val();$(a.target).parent().toggleClass("has-error",!(_.isNumber(b)&&b>10))},_onFocus:function(a){$(a.target).parent().addClass("is-focused")},_onBlur:function(a){$(a.target).parent().removeClass("is-focused")},_onChangeFormat:function(){this.$(".js-radioButton").removeClass("is-checked"),this.$(".js-"+this.model.get("format")).addClass("is-checked")},_onClickFormat:function(a){this.killEvent(a);var b=$(a.target).closest(".js-format");this.model.set("format",b.data("format"))},_getBounds:function(){var a=this.mapView.pixelToLatLon([this.options.x+this.options.width,this.options.y]),b=this.mapView.pixelToLatLon([this.options.x,this.options.y+this.options.height]);return[[b.lat,b.lng],[a.lat,a.lng]]},_ok:function(){var a=+this.$(".js-width").val(),b=+this.$(".js-height").val(),c=this.model.get("format"),d=this._getBounds();this.trigger("generate_image",{width:a,height:b,bounds:d,format:c}),this.close()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"../../view_helpers/random_quote":212,"../../views/base_dialog/view":213}],191:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("../../view_factory"),g=a("../../view_helpers/random_quote"),h="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null;b.exports=e.extend({events:e.extendEvents({"click .js-input":"_onInputClick","click .js-open-image":"close"}),initialize:function(){this.elder("initialize"),this._initViews(),this._initBinds()},render_content:function(){return this._panes.getActivePane().render().el},_initViews:function(){this.vis=this.options.vis,this.user=this.options.user,this.column=this.options.column,this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("loading",f.createByTemplate("common/templates/loading",{title:"Generating image",quote:g()})),this._panes.addTab("fail",f.createByTemplate("common/templates/fail",{msg:"Could not generate image"})),this._panes.active("loading")},loadURL:function(a){this._showResult({displayedLink:a,filename:a,content:a,type:"url"})},_generateImageFilename:function(){var a=this.vis.get("name")+" by "+this.user.nameOrUsername()+" "+h(new Date).format("MM DD YYYY hh mm ss");return a.replace(/ /g,"_").toLowerCase()},generateImage:function(a){var b=function(a){var b=this._generateImageFilename();this._showResult({content:a,type:"url",displayedLink:b+"."+this.options.format,filename:b})};d.config.get("static_image_upload_endpoint")&&(b=this._exportImage),this._loadMapImage(a,b.bind(this))},_showResult:function(a){this._panes.addTab("result",f.createByTemplate("common/dialogs/static_image/export_image_result_view",{column:this.column,response:a})),this._panes.active("result"),this.trigger("finish",this)},_initBinds:function(){this._panes.bind("tabEnabled",this.render,this)},_loadMapImage:function(a,b){var c=this,d=new Image;d.crossOrigin="Anonymous",d.onload=function(){c._mergeAnnotations(d,b)},d.src=a},_exportImage:function(a){var b=this,c=this.options.vis;$.ajax({type:"POST",url:d.config.get("static_image_upload_endpoint"),data:{base64image:a,name:c.get("name"),visualization_uuid:c.get("id"),description:c.get("description")},success:function(a){b._showResult({content:a,type:"html"})},error:function(a){d.editor.ViewFactory.createDialogByTemplate("common/templates/fail",{msg:a.errors}).render().appendToBody()}})},_mergeAnnotations:function(a,b){var c=this.options.x,e=this.options.y,f=this.options.width,g=this.options.height,h=this.options.format;"jpg"===h&&(h="jpeg");var i=d.config.get("url_prefix")+"/api/v1/image_proxy";html2canvas($(".cartodb-map")[0],{allowTaint:!1,taintTest:!0,proxy:{url:i,api_key:this.options.user.get("api_key")},background:void 0,onclone:function(a){var b=$(a);return b.find(".cartodb-map > div:not(.annotation, .text, .image, .ExportImageView)").remove(),b.find(".ExportImageView").addClass("is-exportable"),b.find(".cartodb-map").css("background-color","transparent"),!0},onrendered:function(d){var i=document.createElement("canvas");i.width=f,i.height=g;var j=i.getContext("2d");j.drawImage(a,0,0),j.drawImage(d,c,e,f,g,0,0,f,g),b(i.toDataURL("image/"+h))}})},ok:function(){this.close()},_onInputClick:function(a){$(a.target).focus().select()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"../../view_helpers/random_quote":212,"../../views/base_dialog/view":213}],192:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({tagName:"li",className:"DatasetSelected-syncOptionsItem",events:{click:"_onClick"},initialize:function(){this._setupModel(),this._template=c.templates.getTemplate("common/dialogs/sync_dataset/interval_template"),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this._template(this.model.attributes)),this},_initBinds:function(){this.model.bind("change:checked",this._onToggleChecked,this)},_setupModel:function(){this.model=this.options.model},_onClick:function(a){this.killEvent(a),this.model.get("disabled")||(this.model.set("checked",!0),this.trigger("checked",this.model,this))},_onToggleChecked:function(){this.model.get("checked")?(this.$(".js-interval").addClass("is-checked"),this.$(".js-input").addClass("is-checked")):(this.$(".js-interval").removeClass("is-checked"),this.$(".js-input").removeClass("is-checked"))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],193:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,g=a("../../views/base_dialog/view"),h=a("./interval_view"),i=a("../../view_helpers/random_quote");b.exports=g.extend({_INTERVALS:[{name:"Every hour",time:3600,type:"hourly",if_external_source:!1},{name:"Every day",time:86400,type:"daily",if_external_source:!1},{name:"Every week",time:604800,type:"weekly",if_external_source:!1},{name:"Every month",time:2592e3,type:"monthly",if_external_source:!0},{name:"Never",time:0,type:"never",if_external_source:!0}],initialize:function(){if(!this.options.table)throw new TypeError("table is required");this.elder("initialize"),this.model=new f.core.Model({option:"interval",state:"prefetching",wait:!0}),this.table=this.options.table,this._initBinds(),this.table.fetch({success:this._onFetchedTable.bind(this),error:this._setterForDefaultErrorState()})},_initBinds:function(){this.model.bind("change:state",this.render,this)},render:function(){return this.clearSubViews(),g.prototype.render.call(this),this._initIntervals(),this},render_content:function(){switch(this.model.get("state")){case"prefetching":return this._renderLoading("Checking synchronization");case"error":return this.getTemplate("common/templates/fail")({msg:""});case"saving":return this._renderLoading("Saving…");default:return this.getTemplate("common/dialogs/sync_dataset/sync_dataset")({service:this._serviceName(),url:this._serviceURL()})}},_onFetchedTable:function(){this.model.set({state:"idle",interval:this.table.synchronization.get("interval")})},_renderLoading:function(a){return this.getTemplate("common/templates/loading")({title:a,quote:i()})},_serviceURL:function(){return this.table.synchronization.get("service_name")||this.table.synchronization.get("service_item_id")?this.table.synchronization.get("service_item_id"):this.table.synchronization.get("url")},_serviceName:function(){var a=this.table.synchronization.get("service_name");if(a&&d.isString(a))return f.Utils.capitalize(a)},_initIntervals:function(){this._intervals=new e.Collection;var a=this.table.synchronization.from_external_source;d.each(this._INTERVALS,function(b){var c=a&&!b.if_external_source;this._intervals.add({name:b.name,interval:b.time,checked:this.table.synchronization.get("interval")===b.time,disabled:c})},this),this._intervals.each(function(a){var b=new h({model:a});b.bind("checked",this._onIntervalChecked,this),this.$(".js-intervals").append(b.render().$el),this.addView(b)},this)},_onIntervalChecked:function(a){this._intervals.each(function(b){a.get("interval")!==b.get("interval")&&b.set("checked",!1)},this)},_getSelectedInterval:function(){return this._intervals.find(function(a){return a.get("checked")})},_addTab:function(a,b){this._contentPane.addTab(a,b.render()),this.addView(b)},ok:function(){var a=this._getSelectedInterval();if(a){this.model.set("state","saving");var b={success:this.close.bind(this),error:this._setterForDefaultErrorState()},c=a.get("interval");c?this.table.synchronization.save({interval:c},b):this.table.synchronization.destroy(b)}else this.close()},_setterForDefaultErrorState:function(){return this.model.set.bind(this.model,"state","error")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_helpers/random_quote":212,"../../views/base_dialog/view":213,"./interval_view":192}],194:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,a("../edit_field_view"));"undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,"undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null;b.exports=d.extend({options:{template:"common/edit_fields/boolean_field/boolean_field"},events:{"click .js-true":"_onTrueClick","click .js-false":"_onFalseClick","click .js-null":"_onNullClick"},_initBinds:function(){this.model.bind("change",this.render,this)},_onTrueClick:function(){this.model.set("value",!0)},_onFalseClick:function(){this.model.set("value",!1)},_onNullClick:function(){this.model.set("value",null)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../edit_field_view":200}],195:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,a("../edit_field_view")),e=a("./date_picker/date_picker_view"),f=a("./time_input/time_input_view");"undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,"undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null;b.exports=d.extend({className:"EditField EditField--withBorder EditField--withSeparator",options:{showTime:!0,showGMT:!1,timezone:"Z"},render:function(){return this.clearSubViews(),this._initViews(),this},_initViews:function(){this.datePicker=new e({model:this.model}),this.datePicker.bind("onDateChange",this._setDate,this),this.$el.append(this.datePicker.render().el),this.addView(this.datePicker),this.options.showTime&&(this.timeInput=new f({model:this.model}),this.$el.append(this.timeInput.render().el),this.timeInput.bind("onTimeChange",this._setTime,this),this.timeInput.bind("onSubmit",function(){this.trigger("onSubmit",this.model,this)},this),this.addView(this.timeInput))},_setTime:function(a){var b,c=moment(this.model.get("value")),d=moment(new Date);c.isValid()?(c.hour(d.hour()).minutes(d.minutes()).seconds(d.seconds()),b=c.format("YYYY-MM-DDT")):b=d.format("YYYY-MM-DDT"),this.model.set("value",b+a+this.options.timezone)},_setDate:function(a){var b,c=moment(this.model.get("value")),d=moment(a);c.isValid()?(c.month(d.month()).date(d.date()).year(d.year()),b=c.format("YYYY-MM-DDTHH:mm:ss")):b=d.format("YYYY-MM-DDTHH:mm:ss"),this.model.set("value",b+this.options.timezone)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../edit_field_view":200,"./date_picker/date_picker_view":197,"./time_input/time_input_view":198}],196:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null,f="undefined"!=typeof window?window.moment:"undefined"!=typeof a?a.moment:null;b.exports=c.admin.DropdownMenu.extend({className:"Dropdown",options:{flat:!0,date:"2008-07-01",current:"2008-07-31",calendars:1,starts:1},initialize:function(){if(!this.model)throw new Error("model is required");this.elder("initialize"),this.template=c.templates.getTemplate("common/edit_fields/date_field/date_picker/calendar_dropdown"),this._initDefaults()},render:function(){return this.$el.html(this.template({initialDateStr:f(this.model.get("value")).format("YYYY-MM-DD")})),c.god.bind("closeDialogs",this.hide,this),e("body").append(this.el),this._initCalendar(),this},clean:function(){this._$calendar().DatePickerHide(),c.admin.DropdownMenu.prototype.clean.call(this)},_initDefaults:function(){var a=(new Date).getTimezoneOffset(),b=f(new Date).utcOffset(a).format("YYYY-MM-DD");this.options.date=this.model.get("value")&&f(this.model.get("value")).format("YYYY-MM-DD")||b,this.options.current=this.options.date},_initCalendar:function(){var a=this;this._$calendar().DatePicker(d.extend(this.options,this.model.attributes,{onChange:function(b,c){a.trigger("onDateSelected",c,this),a.hide()}}))},_$calendar:function(){return this.$(".js-calendar")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],197:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,g="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null,h=a("./calendar_dropdown_view.js");b.exports=d.admin.DropdownMenu.extend({className:"DatePicker",events:{"click .js-date-picker":"_onClickDateBtn"},options:{vertical_position:"down",tick:"center",dateFormat:"YYYY-MM-DD"},initialize:function(){this.elder("initialize"),this._initBinds()},render:function(){var a=this.model.get("value")||new Date;return this.$el.html(d.templates.getTemplate("common/edit_fields/date_field/date_picker/date_picker")({readOnly:this.model.get("readOnly"),date:g(a).format(this.options.dateFormat)})),this.model.get("readOnly")&&this.undelegateEvents(),this},_initBinds:function(){this.model.bind("change",this.render,this)},_onClickDateBtn:function(a){this.killEvent(a),this._calendar?this._destroyCalendarDropdown():(this._calendar=new h(e.extend(this.options,{target:f(a.target).closest("button"),model:this.model})),this.addView(this._calendar),this._calendar.render(),this._calendar.on("onDropdownHidden",this._destroyCalendarDropdown,this),this._calendar.on("onDateSelected",function(a){this.trigger("onDateChange",a,this)},this),this._calendar.open())},_destroyCalendarDropdown:function(){this._calendar.options.target.unbind("click",this._calendar._handleClick),this._calendar.clean(),this._calendar=null}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./calendar_dropdown_view.js":196}],198:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"TimeInput",events:{"keydown .js-input":"_onKeyDown","keyup .js-input":"_onKeyUp"},initialize:function(){this.template=c.templates.getTemplate("common/edit_fields/date_field/time_input/time_input")},render:function(){var a=this.model.get("value")||new Date;return this.$el.html(this.template({readOnly:this.model.get("readOnly"),time:moment(a).format("HH:mm:ss")})),this.model.get("readOnly")&&this.undelegateEvents(),this},_onKeyDown:function(a){if(13===a.keyCode)return a.preventDefault(),this.trigger("onSubmit",this),!1},_onKeyUp:function(a){var b=$(a.target).val();this.trigger("onTimeChange",b,this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],199:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window.moment:"undefined"!=typeof a?a.moment:null;b.exports=c.core.Model.extend({defaults:{attribute:"",value:"",type:"string",readOnly:!1},initialize:function(){this.validationError="",this.bind("valid",function(){this.validationError=""},this),this.bind("error",function(a,b){this.validationError=b})},_validate:function(a,b){var d=c.core.Model.prototype._validate.apply(this,arguments);return!!d&&(this.trigger("valid"),!0)},validate:function(a){if(a){var b=a.value,c=a.type;if("number"===a.type){var e=/^(\+|-)?(?:[0-9]+|[0-9]*\.[0-9]+)$/;if(b&&!e.test(b))return"Invalid number"}return"boolean"===c&&null!==b&&b!==!0&&b!==!1?"Invalid boolean":"date"===c&&b&&!d(b).isValid()?"Invalid date":void 0}},getError:function(){return this.validationError},isValid:function(){return!this.validate||!this.validate(this.attributes)&&""===this.validationError}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],200:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"EditField",options:{template:"common/edit_fields/edit_field"},initialize:function(){this.model||(this.model=new c.core.Model({value:""})),this.options.template&&(this.template=c.templates.getTemplate(this.options.template)),this._initBinds()},render:function(){return this.$el.html(this.template(_.extend(this.options,{type:this.model.get("type"),value:this.model.get("value"),attribute:this.model.get("attribute"),readOnly:this.model.get("readOnly")}))),this.model.get("readOnly")&&this.undelegateEvents(),this},_initBinds:function(){this.model.bind("error valid",this._setFieldStyle,this),this.model.bind("change:readOnly",this.render,this)},_setFieldStyle:function(){this.$el[this.model.getError()?"addClass":"removeClass"]("is-invalid")},_hasSubmit:function(a){if(!a)throw new Error("event needed to check if user has submitted from the input");var b=navigator.userAgent.toLowerCase(),c=/mac os/.test(b);return(c&&a.metaKey||!c&&a.ctrlKey)&&13===a.keyCode},isValid:function(){return this.model.isValid()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],201:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,a("../edit_field_view")),e=("undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,"undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null);b.exports=d.extend({options:{template:"common/edit_fields/number_field/number_field"},events:{"keydown .js-input":"_onKeyDown","keyup .js-input":"_onKeyUp"},_hasSubmit:function(a){if(!a)throw new Error("event needed to check if user has submitted from the input");return 13===a.keyCode},_onKeyDown:function(a){if(this._hasSubmit(a)&&this.model.isValid())return a.preventDefault(),this.trigger("onSubmit",this.model,this),!1},_onKeyUp:function(a){if(this._hasSubmit(a)&&this.model.isValid())return a.preventDefault(),!1;var b=e(a.target).val();""===b&&(b=null),this.model.set("value",b)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../edit_field_view":200}],202:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,a("../edit_field_view")),e=("undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,"undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null);b.exports=d.extend({options:{template:"common/edit_fields/string_field/string_field",autoResize:!0},events:{"keydown .js-textarea":"_onKeyDown","keyup .js-textarea":"_onKeyUp"},render:function(){return this.elder("render"),this.options.autoResize&&this._resize(),this},_onKeyDown:function(a){if(this._hasSubmit(a))return a.preventDefault(),this.trigger("onSubmit",this.model,this),!1},_onKeyUp:function(a){
a.preventDefault();var b=e(a.target).val();this.model.set("value",b),this.options.autoResize&&this._resize()},_resize:function(){var a=this.$(".js-textarea");a&&setTimeout(function(){a.height(20),a.height(a[0].scrollHeight-22)})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../edit_field_view":200}],203:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;c.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof a?a.cdb.admin:null;var d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null;b.exports=c.core.View.extend({className:"form-view form_spinner",defaults:{max:999999999999,min:-999999999999,inc:1,width:25,pattern:/^-?[0-9]+\.?[0-9]*$/,debounce_time:200},events:{"click .plus":"_plus","click .minus":"_minus","keypress input.value":"_checkInputPress","keydown input.value":"_checkInputPress","keyup input.value":"_checkInputUp","change .value":"_checkValueChange"},initialize:function(){d.bindAll(this,"_fireChange","_checkNumber"),this.property=this.options.property,this.model.bind("change",this.render,this),this.options.pattern&&"object"==typeof this.options.pattern&&("object"!=typeof this.options.pattern||this.options.pattern.test)||delete this.options.pattern,d.defaults(this.options,this.defaults),this.options.debounce_time>0&&(this._fireChange=d.debounce(this._fireChange,this.options.debounce_time))},render:function(a){var b=this.options.initValue||this.model.get(this.property);return a&&d.isNumber(a)&&(b=a),this.$el.html('<input class="value" '+(this.options.disabled?"readonly":"")+' value="" style="width:'+this.options.width+'px!important"/><a href="#" class="plus">+</a><a href="#" class="minus">-</a>'),this.$(".value").val(b),this.options.disabled&&(this.undelegateEvents(),this.$el.addClass("disabled").find("a").bind("click",this.killEvent)),this},_fireChange:function(){this.model.change()},_changeValue:function(a){this.model.set(a,{silent:!0}),this._fireChange()},inc:function(a){var b={},c=b[this.property]=this.model.get(this.property)+a;c=b[this.property]=Math.min(this.options.max,c.toFixed?c.toFixed(1):1*c),b[this.property]=Math.max(this.options.min,c),this._changeValue(b),this.render(b[this.property])},_plus:function(a){return a&&a.preventDefault(),this.inc(this.options.inc),!1},_minus:function(a){return a&&a.preventDefault(),this.inc(-this.options.inc),!1},_checkNumber:function(a){return this.options.pattern.test(a)},_checkInputPress:function(a){var b=String.fromCharCode(a.charCode);return"-"==b||"."==b||1*b!==NaN||(a.preventDefault(),a.stopPropagation(),!1)},_checkInputUp:function(a){this.value?null:this.value=this.model.get(this.property);var b=e(a.target).val();return 13===a.keyCode?(this._saveValue(a),!1):(this._checkNumber(b)||"-"==b||""==b?"-"!=b&&""!=b&&(this.value=e(a.target).val()):this.$el.find("input.value").val(this.value),!0)},_checkValueChange:function(a){var b=e(a.target).val();return b=""==b||"-"==b?0:1*b,this._checkNumber(b)?(this._saveValue(a),this.value=e(a.target).val()):this.$el.find("input.value").val(this.value),!0},_saveValue:function(a){var b={},d=this.$el.find("input.value").val(),e=this.options.min<0&&this.options.max>0?0:this.options.min,f=""==d||"-"==d?e:1*d;this.$el.find("input.value").val(f),b[this.property]=f,this.model.set(b),c.god.trigger("closeDialogs")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],204:[function(a,b,c){var d=a("../views/base_dialog/view");b.exports=d.extend({className:"Dialog is-opening MamufasDialog",overrideDefaults:{template_name:"common/views/base_dialog/template",triggerDialogEvents:!1},initialize:function(){d.prototype.initialize.apply(this,arguments),this.template=cdb.templates.getTemplate("common/mamufas_import/mamufas_import_dialog")},render_content:function(){return this.template()},render:function(){return this.elder("render"),this.$(".Dialog-content").addClass("Dialog-content--expanded"),this},hide:function(){d.prototype.hide.apply(this,arguments),this.trigger("hide"),this._setBodyForDialogMode("remove")}})},{"../views/base_dialog/view":213}],205:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./mamufas_import_dialog_view");b.exports=d.core.View.extend({initialize:function(){this.user=this.options.user,this.model=new d.core.Model({visible:!1})},render:function(){return this},_createDragster:function(){this.dragster&&this._destroyDragster(),this.dragster=new Dragster(this.$el[0])},_createDropzone:function(){this.dropzone&&this._destroyDropzone(),this.dropzone=new Dropzone(this.$el[0],{url:":)",autoProcessQueue:!1,previewsContainer:!1})},_destroyDragster:function(){this.dragster&&(this.dragster.removeListeners(),this.dragster.reset(),delete this.dragster)},_destroyDropzone:function(){this.dropzone&&(this.dropzone.destroy(),delete this.dropzone)},_initBinds:function(){var a=this,b=new e({clean_on_hide:!0});this.$el.on("dragster:enter",function(a){b.appendToBody()}),this.$el.on("dragster:leave",function(a){b.hide()}),this.dropzone.on("drop",function(c){a.dragster.dragleave(c),b.hide(),a.dropzone.removeFile(c);var e=c.dataTransfer.files;e&&e.length>0&&(1===e.length&&(e=e[0]),d.god.trigger("fileDropped",e,this))})},_removeBinds:function(){this.$el.off("dragster:enter"),this.$el.off("dragster:leave")},enable:function(){this.model.get("visible")||(this._createDragster(),this._createDropzone(),this._initBinds(),this.model.set("visible",!0))},disable:function(){this.model.get("visible")&&(this._removeBinds(),this._destroyDragster(),this._destroyDropzone(),this.model.set("visible",!1))},clean:function(){this._removeBinds(),this.elder("clean")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./mamufas_import_dialog_view":204}],206:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({defaults:{per_page:20,page:1},fetch:function(a){return a.trigger("fetching"),a.fetch({data:this.attributes})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],207:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({_DATASOURCE_NAME:"dropbox",initialize:function(a,b){b.datasource_name&&(this._DATASOURCE_NAME=b.datasource_name)},url:function(a){var b=c.config.urlVersion("imports_service",a);return"/api/"+b+"/imports/service/"+this._DATASOURCE_NAME+"/auth_url"},parse:function(a){return a}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],208:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({_DATASOURCE_NAME:"dropbox",initialize:function(a,b){b.datasource_name&&(this._DATASOURCE_NAME=b.datasource_name)},url:function(a){var b=c.config.urlVersion("imports_service",a);return"/api/"+b+"/imports/service/"+this._DATASOURCE_NAME+"/token_valid"},parse:function(a){return a}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],209:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("./views/base_dialog/view");b.exports={createDialogByTemplate:function(a,b,c){return this.createDialogByView(this.createByTemplate(a,b),c)},createByTemplate:function(a,b,c){var f=d.isString(a)?e.templates.getTemplate(a):a,g=new e.core.View(c);return g.render=function(){return this.$el.html(f(b)),this},g},createByList:function(a,b){var c=new e.core.View(b);return c.render=function(){return this.clearSubViews(),d.each(a,function(a){this.addView(a),this.$el.append(a.render().$el)},this),this},c},createDialogByView:function(a,b){var c=d.extend({clean_on_hide:!0,enter_to_confirm:!0},b);return new(f.extend({initialize:function(){this.elder("initialize"),this.addView(a)},render_content:function(){return a.render().el}}))(c)}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./views/base_dialog/view":213}],210:[function(a,b,c){(function(a){function c(a){return 2===a.which||3===a.which}function d(a){return a.metaKey}function e(a){return a.ctrlKey}var f="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null;b.exports=function(a){this.killEvent(a);var b=f(a.target).closest("a").attr("href");return!!b&&void(c(a)||d(a)?(e(a)||d(a))&&window.open(b,"_blank"):(this.router||this.options.router).navigate(b,{trigger:!0}))}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],211:[function(a,b,c){var d=function(a,b,c){return 2===arguments.length?d.call(this,arguments[0],arguments[0]+"s",arguments[1]):1===c?a:b};d.prefixWithCount=function(a,b,c){return d("1 "+a,c+" "+b,c)},b.exports=d},{}],212:[function(a,b,c){b.exports=function(){var a=_.template('<p class="CDB-Text CDB-Size-medium u-altTextColor">"<%= quote %>"</p><% if (author) { %><p class="CDB-Text CDB-Size-medium u-altTextColor u-tSpace"><em>– <%- author %></em></p><% } %>'),b=[{quote:"Geographers never get lost. They just do accidental field work.",author:"Nicholas Chrisman"},{quote:"Geography is just physics slowed down, with a couple of trees stuck in it.",author:"Terry Pratchett"},{quote:"Not all those who wander are lost.",author:"J. R. R. Tolkien"},{quote:"In that Empire, the Art of Cartography attained such Perfection that the map of a single Province occupied the entirety of a City.",author:"Jorge Luis Borges"},{quote:"X marks the spot",author:"Indiana Jones"},{quote:"It's turtles all the way down.",author:null},{quote:"Remember: no matter where you go, there you are.",author:null},{quote:"Without geography, you're nowhere!",author:"Jimmy Buffett"},{quote:"our earth is a globe / whose surface we probe /<br />no map can replace her / but just try to trace her",author:"Steve Waterman"},{quote:"Everything happens somewhere.",author:"Doctor Who"},{quote:"A map is the greatest of all epic poems. Its lines and colors show the realization of great dreams.",author:"Gilbert H. Grosvenor"},{quote:"Everything is related to everything else,<br />but near things are more related than distant things.",author:"Tobler's first law of geography"},{quote:"Hic Sunt Dracones",author:null},{quote:"Here be dragons",author:null},{quote:"Stand in the place where you live / Now face North /<br/>Think about direction / Wonder why you haven't before",author:"R.E.M"},{quote:"The virtue of maps, they show what can be done with limited space, they foresee that everything can happen therein.",author:"José Saramago"}],c=Math.round(Math.random()*(b.length-1));return a(b[c])}},{}],213:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null,f=c.ui.common.Dialog;b.exports=f.extend({className:"Dialog is-opening",overrideDefaults:{template_name:"common/views/base_dialog/template",triggerDialogEvents:!0},initialize:function(){d.defaults(this.options,this.overrideDefaults),this.elder("initialize"),this.bind("show",this._setBodyForDialogMode.bind(this,"add")),this.bind("hide",this._setBodyForDialogMode.bind(this,"remove"))},show:function(){f.prototype.show.apply(this,arguments),this.trigger("show"),this.options.triggerDialogEvents&&c.god.trigger("dialogOpened"),this.$el.removeClass("is-closing"),document.activeElement&&document.activeElement.blur()},render:function(){return f.prototype.render.apply(this,arguments),this.$(".content").addClass("is-newContent"),this._isSticky()&&this.$el.addClass("is-sticky"),this.show(),this},_isSticky:function(){return this.options&&this.options.sticky},close:function(){this._cancel(void 0,!0)},open:function(){f.prototype.open.apply(this,arguments),this.show()},hide:function(){f.prototype.hide.apply(this,arguments),this.trigger("hide")},_cancel:function(a,b){if(a&&this.killEvent(a),!this._isSticky()){this.$el.removeClass("is-opening").addClass("is-closing");var d=this;setTimeout(function(){d.cancel&&!b&&d.cancel(),f.prototype.hide.call(d)},80),this.trigger("hide"),this.options.triggerDialogEvents&&c.god.trigger("dialogClosed")}},_ok:function(a){this.killEvent(a),this.ok?this.ok():this.close()},_setBodyForDialogMode:function(a){e("body")[a+"Class"]("is-inDialog")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],214:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var f="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null,g=a("../../forms/spinner");b.exports=d.core.View.extend({_MAX_RANGE:30,className:"DatePicker",options:{flat:!0,date:["2008-07-31","2008-07-31"],current:"2008-07-31",calendars:2,mode:"range",starts:1},events:{"click .js-dates":"_toggleCalendar","click .js-fourHours":"_setLastFourHours","click .js-oneDay":"_setLastDay","click .js-oneWeek":"_setLastWeek"},initialize:function(){this.model=new d.core.Model({fromDate:"",fromHour:0,fromMin:0,toDate:"",toHour:23,toMin:59,user_timezone:0}),this.template=this.options.template||d.templates.getTemplate("common/views/date_pickers/dates_range"),this._initBinds(),this._setToday()},render:function(){var a=this;return this.clearSubViews(),this.$el.append(this.template(e.extend(this.model.attributes,{max_days:this._MAX_RANGE}))),setTimeout(function(){a._initCalendar(),a._hideCalendar(),a._initTimers()},100),this},_initBinds:function(){e.bindAll(this,"_onDatesChange","_onDocumentClick"),this.model.bind("change",this._setValues,this),this.model.bind("change",this._onValuesChange,this),$(document).bind("click",this._onDocumentClick)},_destroyBinds:function(){$(document).unbind("click",this._onDocumentClick)},_setValues:function(a,b){var c="Choose your dates",e=this.model.attributes;e.fromDate&&e.toDate&&(c="From <strong>"+this.model.get("fromDate")+" "+(d.Utils.pad(this.model.get("fromHour"),2)+":"+d.Utils.pad(this.model.get("fromMin"),2))+"</strong> to <strong>"+this.model.get("toDate")+" "+(d.Utils.pad(this.model.get("toHour"),2)+":"+d.Utils.pad(this.model.get("toMin"),2))+'</strong><i class="CDB-IconFont CDB-IconFont-calendar DatePicker-datesIcon"></i>'),this.$(".DatePicker-dates").html(c)},_setToday:function(){var a=this.model.get("user_timezone"),b=f().utc(a),c=f().utc(a).subtract(this._MAX_RANGE-1,"days");this.options.date=[c.format("YYYY-MM-DD"),b.format("YYYY-MM-DD")],this.options.current=b.format("YYYY-MM-DD"),this._setModelFromPrevious(c)},_initCalendar:function(){var a=".DatePicker-calendar";document.body.contains(this.$(a)[0])&&(this.calendar=this.$(a).DatePicker(e.extend(this.options,{onChange:this._onDatesChange,onRender:function(a){var b=a.valueOf(),c=new Date,d=new Date;return d.setDate(c.getDate()-30),b<d||b>c?{disabled:!0}:""}})))},_onDatesChange:function(a,b){var c=f(a[0]),d=f(a[1]);Math.abs(c.diff(d,"days"))>this._MAX_RANGE&&(a[1]=f(a[0]).add("days",this._MAX_RANGE).format("YYYY-MM-DD"),this.$(".DatePicker-calendar").DatePickerSetDate([a[0],a[1]])),this.model.set({fromDate:a[0],toDate:a[1]})},_hideCalendar:function(a){a&&this.killEvent(a),this.$(".DatePicker-dropdown").hide()},_toggleCalendar:function(a){a&&this.killEvent(a),this.$(".DatePicker-dropdown").toggle()},_setLastFourHours:function(){var a=f().utc(0).subtract(4,"hours");this._setModelFromPrevious(a),this._setDatepickerFromPrevious(a),this.closeCalendar()},_setLastDay:function(){var a=f().utc(0).subtract(1,"day");this._setModelFromPrevious(a),this._setDatepickerFromPrevious(a),this.closeCalendar()},_setLastWeek:function(){var a=f().utc(0).subtract(1,"week");this._setModelFromPrevious(a),this._setDatepickerFromPrevious(a),this.closeCalendar()},_setModelFromPrevious:function(a){var b=f().utc(0);this.model.set({fromDate:a.format("YYYY-MM-DD"),fromHour:parseInt(a.format("H")),fromMin:parseInt(a.format("m")),toDate:b.format("YYYY-MM-DD"),toHour:parseInt(b.format("H")),toMin:parseInt(b.format("m"))})},_setDatepickerFromPrevious:function(a){var b=f().utc(0);this.$(".DatePicker-calendar").DatePickerSetDate([a.format("YYYY-MM-DD"),b.format("YYYY-MM-DD")])},_initTimers:function(){var a=this.$(".DatePicker-timersFrom"),b=new g({model:this.model,property:"fromHour",min:0,max:23,inc:1,width:15,pattern:/^([12]?\d{0,1}|3[01]{0,2})$/,debounce_time:0});a.find(".DatePicker-timersHour").append(b.render().el),this.addView(b);var c=new g({model:this.model,property:"fromMin",min:0,max:59,inc:1,width:15,pattern:/^([12345]?\d{0,1})$/,debounce_time:0});a.find(".DatePicker-timersMin").append(c.render().el),this.addView(c);var d=this.$(".DatePicker-timersTo"),e=new g({model:this.model,property:"toHour",min:0,max:23,inc:1,width:15,pattern:/^([12]?\d{0,1}|3[01]{0,2})$/,debounce_time:0});d.find(".DatePicker-timersHour").append(e.render().el),this.addView(e);var f=new g({model:this.model,property:"toMin",min:0,max:59,inc:1,width:15,pattern:/^([12345]?\d{0,1})$/,debounce_time:0});d.find(".DatePicker-timersMin").append(f.render().el),this.addView(f)},_onValuesChange:function(){this.trigger("changeDate",this.model.toJSON(),this)},getDates:function(){return this.model.toJSON()},closeCalendar:function(){this.$(".DatePicker-dropdown").hide()},_onDocumentClick:function(a){var b=$(a.target);0===b.closest(".DatePicker").length&&this.closeCalendar()},clean:function(){this._destroyBinds(),this.closeCalendar(),this.$(".DatePicker-calendar").DatePickerHide(),d.core.View.prototype.clean.call(this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../forms/spinner":203}],215:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({_TEMPLATES:{8001:"common/views/size_error_details_upgrade_template",8005:"common/views/layers_error_details_upgrade_template",default:"common/views/error_details"},initialize:function(){this.user=this.options.user,this.err=this.options.err},render:function(){var a=this.err.error_code&&parseInt(this.err.error_code),b=c.config.get("upgrade_url"),d=b&&!c.config.get("cartodb_com_hosted")&&(!this.user.isInsideOrg()||this.user.isOrgOwner()),e=this._TEMPLATES.default,f=this.err.original_url,g=this.err.http_response_code,h=this.err.http_response_code_message;d&&this._TEMPLATES[a]&&(e=this._TEMPLATES[a]);var i=c.templates.getTemplate(e);return this.$el.html(i({errorCode:a,title:this.err.title,text:this.err.what_about,itemQueueId:this.err.item_queue_id,originalUrl:f,httpResponseCode:g,httpResponseCodeMessage:h,userCanUpgrade:d,showTrial:this.user.canStartTrial(),upgradeUrl:b})),this}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],216:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({tagName:"a",events:{click:"_toggleLike"},initialize:function(){this.template=c.templates.getTemplate("common/views/likes/template"),this.model.bind("change:likeable change:liked change:likes error",this.render,this)},render:function(){return this.$el.html(this.template({likes:this.model.get("likes"),size:this.model.get("size"),show_count:this.model.get("show_count"),show_label:this.model.get("show_label")})).attr({class:this._classNames(),href:this._hrefLocation()}),this},_hrefLocation:function(){var a="#/like";return this.model.get("likeable")||(a=window.login_url),a},_classNames:function(){var a=["LikesIndicator"];return this.model.get("likeable")&&a.push("is-likeable"),this.model.get("liked")&&a.push("is-liked"),this._animate&&(a.push("is-animated"),this.$el.one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){this._animate=!1,this.render()}.bind(this))),a.join(" ")},_toggleLike:function(a){this.model.get("likeable")&&(this.killEvent(a),this._animate=!0,this.model.toggleLiked())}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],217:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=d.core.View.extend({options:{width:300,height:170,privacy:"PUBLIC",username:"",visId:"",mapsApiResource:"",className:"",authTokens:[]},_TEMPLATES:{regular:"<%- protocol %>://<%= mapsApiResource %>/api/v1/map/static/named/<%- tpl %>/<%- width %>/<%- height %>.png<%= authTokens %>",cdn:"<%- protocol %>://<%- cdn %>/<%- username %>/api/v1/map/static/named/<%- tpl %>/<%- width %>/<%- height %>.png<%= authTokens %>"},initialize:function(){e.each(["visId","mapsApiResource","username"],function(a){this.options[a]||console.log(a+" is required for Static Map instantiation")},this)},load:function(){return this._startLoader(),this._loadFromVisId(),this},_generateImageTemplate:function(){return"tpl_"+this.options.visId.replace(/-/g,"_")},_loadFromVisId:function(){var a=this._isHTTPS()?"https":"http",b=d.config.get("cdn_url"),c=e.template(b?this._TEMPLATES.cdn:this._TEMPLATES.regular),f={protocol:a,username:this.options.username,mapsApiResource:this.options.mapsApiResource,tpl:this._generateImageTemplate(),width:this.options.width,height:this.options.height,authTokens:this._generateAuthTokensParams()};b&&(f=e.extend(f,{cdn:b[a]}));var g=c(f);this._loadImage({},g)},_generateAuthTokensParams:function(){var a=this.options.authTokens;return a&&a.length>0?"?"+e.map(a,function(a){return"auth_token="+a}).join("&"):""},_isHTTPS:function(){return 0===location.protocol.indexOf("https")},loadURL:function(a){var b=c('<img class="MapCard-preview" src="'+a+'" />');this.$el.append(b),this.options.className&&b.addClass(this.options.className),b.fadeIn(250)},showError:function(){this._onError()},_startLoader:function(){this.$el.addClass("is-loading")},_stopLoader:function(){this.$el.removeClass("is-loading")},_onSuccess:function(a){this._stopLoader(),this.loadURL(a),this.trigger("loaded",a)},_onError:function(a){this._stopLoader(),this.$el.addClass("has-error");var b=c('<div class="MapCard-error" />');this.$el.append(b),b.fadeIn(250),this.trigger("error")},_loadImage:function(a,b){var c=this,d=new Image;d.onerror=function(){c._onError(a)},d.onload=function(){c._onSuccess(b)};try{d.src=b}catch(a){this._onError(a)}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],218:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,g="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,h=a("../pagination/model"),i=a("../../view_helpers/random_quote"),j=a("../../view_factory"),k=a("../pagination/view");b.exports=d.core.View.extend({events:{"click .js-search-link":"_onSearchClick","click .js-clean-search":"_onCleanSearchClick","keydown .js-search-input":"_onKeyDown","submit .js-search-form":"killEvent"},initialize:function(){e.each(["collection","pagedSearchModel","createListView"],function(a){if(!this.options[a])throw new Error(a+" is required")},this),this.collection=this.options.collection,this.options.noResults=this.options.noResults||{};var a=this.options.pagedSearchModel;this.paginationModel=new h({current_page:a.get("page"),total_count:this.collection.totalCount()||0,per_page:a.get("per_page")}),this.elder("initialize"),this._initBinds(),this.options.pagedSearchModel.fetch(this.collection)},render:function(){return this.clearSubViews(),this._renderContent(this.getTemplate("common/views/paged_search/paged_search")({thinFilters:this.options.thinFilters,q:this.options.pagedSearchModel.get("q")})),this._initViews(),this._$cleanSearchBtn().hide(),this._renderExtraFilters(),this},_renderExtraFilters:function(){this.options.filtersExtrasView&&this.options.filtersExtrasView&&this.$(".js-filters").append(this.options.filtersExtrasView.render().el)},_renderContent:function(a){this.options.isUsedInDialog&&(a=this.getTemplate("common/views/paged_search/paged_search_dialog_wrapper")({htmlToWrap:a})),this.$el.html(a),this.options.isUsedInDialog&&(this.$el.addClass("Dialog-expandedSubContent"),this._$tabPane().addClass("Dialog-bodyInnerExpandedWithSubFooter"))},_initBinds:function(){this.collection.bind("fetching",function(){this._toggleCleanSearchBtn(),this._activatePane("loading")},this),this.collection.bind("error",function(a){(!a||a&&"abort"!==a.statusText)&&this._activatePane("error"),this._toggleCleanSearchBtn()},this),this.collection.bind("reset",function(a){this.paginationModel.set({total_count:this.collection.totalCount(),current_page:this.options.pagedSearchModel.get("page")}),this._activatePane(this.collection.totalCount()>0?"list":"no_results"),this._toggleCleanSearchBtn()},this),this.paginationModel.bind("change:current_page",function(a,b){this.options.pagedSearchModel.set("page",b),this.options.pagedSearchModel.fetch(this.collection)},this),this.add_related_model(this.options.pagedSearchModel),this.add_related_model(this.collection),this.add_related_model(this.paginationModel)},_toggleCleanSearchBtn:function(){this._$cleanSearchBtn().toggle(!!this.options.pagedSearchModel.get("q"))},_initViews:function(){this._panes=new d.ui.common.TabPane({el:this._$tabPane()}),this.addView(this._panes),this._panes.addTab("list",j.createByList([this._createListView(),new k({className:"CDB-Text CDB-Size-medium Pagination Pagination--shareList",model:this.paginationModel})])),this._panes.addTab("error",j.createByTemplate("common/templates/fail",{msg:""})),this._panes.addTab("no_results",j.createByTemplate("common/templates/no_results",{icon:this.options.noResults.icon||"CDB-IconFont-defaultUser",title:this.options.noResults.title||"Oh! No results",msg:this.options.noResults.msg||"Unfortunately we could not find anything with these parameters"})),this._panes.addTab("loading",j.createByTemplate("common/templates/loading",{title:"Searching",quote:i()})),this.options.pagedSearchModel.get("q")&&this._focusSearchInput(),this._activatePane(this._chooseActivePaneName(this.collection.totalCount()))},_createListView:function(){var a=this.options.createListView();return a instanceof d.core.View?a:(d.log.error("createListView function must return a view"),new d.core.View)},_activatePane:function(a){this._panes&&this._panes.size()>0&&this._panes.active(a).render()},_chooseActivePaneName:function(a){return 0===a?"no_results":a>0?"list":"loading"},_focusSearchInput:function(){this._$searchInput().focus().val(this._$searchInput().val())},_onSearchClick:function(a){this.killEvent(a),this._$searchInput().focus()},_onCleanSearchClick:function(a){this.killEvent(a),this._cleanSearch()},_onKeyDown:function(a){var b=a.keyCode==f.ui.keyCode.ENTER,c=a.keyCode==f.ui.keyCode.ESCAPE;b?(this.killEvent(a),this._submitSearch()):c&&(this.killEvent(a),this.options.pagedSearchModel.get("q")&&this._cleanSearch())},_submitSearch:function(a){this._makeNewSearch(g.stripHTML(this._$searchInput().val().trim()))},_cleanSearch:function(){this._$searchInput().val(""),this._makeNewSearch()},_makeNewSearch:function(a){this.options.pagedSearchModel.set({q:a,page:1}),this.options.pagedSearchModel.fetch(this.collection)},_$searchInput:function(){return this.$(".js-search-input")},_$cleanSearchBtn:function(){return this.$(".js-clean-search")},_$tabPane:function(){return this.$(".js-tab-pane")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":209,"../../view_helpers/random_quote":212,"../pagination/model":219,"../pagination/view":220}],219:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.core.Model.extend({defaults:{total_count:0,per_page:10,current_page:1,display_count:5,extras_display_count:1,url_to:void 0},pagesCount:function(){return Math.max(Math.ceil(this.get("total_count")/this.get("per_page")),1)},isCurrentPage:function(a){return this.get("current_page")===a},shouldBeVisible:function(){var a=this.pagesCount();return this.get("total_count")>0&&a>1&&this.get("current_page")<=a},urlTo:function(a){if(this.hasUrl())return this.get("url_to")(a)},hasUrl:function(){return"function"==typeof this.get("url_to")},pagesToDisplay:function(){var a;return a=this._inLowRange()?1:this._inHighRange()?this.get("current_page")-this._startOffset():this.pagesCount()-this.get("display_count")+1,a=Math.max(a,1),this._withExtraPages(d.range(a,this._rangeEnd(a)))},_withExtraPages:function(a){var b=this.pagesCount(),c=this.get("extras_display_count"),e=d.range(1,c+1),f=d.range(b-c+1,b+1),g=a[0]-e.slice(-1)[0];2===g?e.push(a[0]-1):g>2&&e.push(-1);var h=f[0]-a.slice(-1);return 2===h&&f.unshift(f[0]-1),h>2&&f.unshift(-2),d.union(e,a,f)},_inLowRange:function(){return this.get("current_page")<this._startOffset()},_inHighRange:function(){return this.get("current_page")<this._highBoundary()},_highBoundary:function(){return this.pagesCount()-this._startOffset()},_startOffset:function(){return Math.floor(this.get("display_count")/2)},_rangeEnd:function(a){return Math.min(a+this.get("display_count"),this.pagesCount()+1)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],220:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f=a("../../view_helpers/navigate_through_router");b.exports=d.core.View.extend({className:"Pagination CDB-Text CDB-Size-medium",events:{"click a":"_paginate"},initialize:function(){if(this.template=d.templates.getTemplate("common/views/pagination/template"),this.router=this.options.router,this.router&&!this.model.hasUrl())throw new Error("since router is set the model must have a url method set too");this.model.bind("change",this.render,this)},render:function(){return this.model.shouldBeVisible()?(this.$el.html(this.template({m:this.model,pagesCount:this.model.pagesCount(),currentPage:this.model.get("current_page")})),this.$el.addClass(this.className),this.delegateEvents()):this.$el.html(""),this},_paginate:function(a){this.router?f.apply(this,arguments):this.model.hasUrl()||this.killEvent(a);var b=e(a.target).data("page");this.model.set("current_page",b)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_helpers/navigate_through_router":210}],221:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({_TEMPLATES:{partial_import:"common/views/partial_import_details",too_many_files:"common/views/too_many_files_details",too_many_rows_connection:"common/views/too_many_rows_connection_details"},initialize:function(){this.warnings=this.options.warnings},render:function(){var a=this.warnings,b=this._getTemplateKey(a),d=c.templates.getTemplate(this._TEMPLATES[b]);
return this.$el.html(d({warnings:a})),this},_getTemplateKey:function(a){return a.user_max_layers&&a.max_tables_per_import?a.user_max_layers<a.max_tables_per_import?"partial_import":"too_many_files":a.user_max_layers?"partial_import":a.max_tables_per_import?"too_many_files":a.max_rows_per_connection?"too_many_rows_connection":void 0}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],222:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({defaults:{content_type:"",page:1,q:"",tag:"",category:"",shared:"no",locked:!1,liked:!1,library:!1,order:"updated_at",deepInsights:!1},isSearching:function(){return this.get("q")||this.get("tag")},isDatasets:function(){return"datasets"===this.get("content_type")},isMaps:function(){return"maps"===this.get("content_type")},isDeepInsights:function(){return this.isMaps()&&this.get("deepInsights")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],223:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null;c.editor={CreateVisFirstView:a("./common/dialogs/create_vis_first/create_vis_first_view"),ImportsCollection:a("./common/background_polling/models/imports_collection"),GeocodingModel:a("./common/background_polling/models/geocoding_model"),LonLatGeocodingModel:a("./common/background_polling/models/lon_lat_geocoding_model"),BackgroundPollingModel:a("./editor/background_polling_model"),ImagePickerView:a("./common/dialogs/map/image_picker_view"),BackgroundPollingView:a("./common/background_polling/background_polling_view"),AddLayerView:a("./common/dialogs/map/add_layer_view"),SyncView:a("./common/dialogs/sync_dataset/sync_dataset_view"),ScratchView:a("./common/dialogs/map/scratch_view"),AddLayerModel:a("./common/dialogs/map/add_layer_model"),FeatureDataView:a("./common/dialogs/feature_data/feature_data_dialog_view"),ChangePrivacyView:a("./common/dialogs/change_privacy/change_privacy_view"),EditVisMetadataView:a("./common/dialogs/edit_vis_metadata/edit_vis_metadata_dialog_view"),DeleteItemsView:a("./common/dialogs/delete_items_view"),DeleteItemsViewModel:a("./common/dialogs/delete_items_view_model"),DeleteLayerView:a("./common/dialogs/delete_layer/delete_layer_view"),DeleteColumnView:a("./common/dialogs/delete_column/delete_column_view"),DeleteRowView:a("./common/dialogs/delete_row/delete_row_view"),ExportImageResultView:a("./common/dialogs/static_image/export_image_result_view"),AdvancedExportView:a("./common/dialogs/static_image/advanced_export_view"),PublishView:a("./common/dialogs/publish/publish_view"),ChangeLockViewModel:a("./common/dialogs/change_lock/change_lock_view_model"),ChangeLockView:a("./common/dialogs/change_lock/change_lock_view"),BuilderFeaturesWarningDialog:a("./common/dialogs/builder_features_warning/builder_features_warning_view"),PecanView:a("./common/dialogs/pecan/pecan_view"),DuplicateVisView:a("./common/dialogs/duplicate_vis_view"),DuplicateDatasetView:a("./common/dialogs/duplicate_dataset_view"),ExportView:a("./common/dialogs/export/export_view"),MergeDatasetsView:a("./common/dialogs/merge_datasets/merge_datasets_view"),GeoreferenceView:a("./common/dialogs/georeference/georeference_view"),LimitsReachView:a("./common/dialogs/limits_reach/limits_reached_view"),MamufasImportView:a("./common/mamufas_import/mamufas_import_view"),AddCustomBasemapView:a("./common/dialogs/add_custom_basemap/add_custom_basemap_view"),ViewFactory:a("./common/view_factory"),randomQuote:a("./common/view_helpers/random_quote.js"),ExportMapView:a("./common/dialogs/export_map/export_map_view")}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./common/background_polling/background_polling_view":2,"./common/background_polling/models/geocoding_model":4,"./common/background_polling/models/imports_collection":9,"./common/background_polling/models/lon_lat_geocoding_model":11,"./common/dialogs/add_custom_basemap/add_custom_basemap_view":26,"./common/dialogs/builder_features_warning/builder_features_warning_view":43,"./common/dialogs/change_lock/change_lock_view":44,"./common/dialogs/change_lock/change_lock_view_model":45,"./common/dialogs/change_privacy/change_privacy_view":46,"./common/dialogs/create_vis_first/create_vis_first_view":93,"./common/dialogs/delete_column/delete_column_view":94,"./common/dialogs/delete_items_view":95,"./common/dialogs/delete_items_view_model":96,"./common/dialogs/delete_layer/delete_layer_view":97,"./common/dialogs/delete_row/delete_row_view":98,"./common/dialogs/duplicate_dataset_view":99,"./common/dialogs/duplicate_vis_view":100,"./common/dialogs/edit_vis_metadata/edit_vis_metadata_dialog_view":103,"./common/dialogs/export/export_view":104,"./common/dialogs/export_map/export_map_view":105,"./common/dialogs/feature_data/feature_data_dialog_view":107,"./common/dialogs/georeference/georeference_view":118,"./common/dialogs/limits_reach/limits_reached_view":135,"./common/dialogs/map/add_layer_model":139,"./common/dialogs/map/add_layer_view":140,"./common/dialogs/map/image_picker_view":155,"./common/dialogs/map/scratch_view":156,"./common/dialogs/merge_datasets/merge_datasets_view":168,"./common/dialogs/pecan/pecan_view":186,"./common/dialogs/publish/publish_view":189,"./common/dialogs/static_image/advanced_export_view":190,"./common/dialogs/static_image/export_image_result_view":191,"./common/dialogs/sync_dataset/sync_dataset_view":193,"./common/mamufas_import/mamufas_import_view":205,"./common/view_factory":209,"./common/view_helpers/random_quote.js":212,"./editor/background_polling_model":224}],224:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,a("../common/background_polling/models/imports_collection"),a("../common/background_polling/models/geocodings_collection"),a("../common/background_polling/background_polling_model"));b.exports=d.extend({addImportItem:function(a){return!!a&&(this.user.canAddLayerTo(this.vis.map)||a.setError({error_code:8005,get_error_text:{title:"Max layers per map reached",what_about:"You can't add more layers to your map. Please upgrade your account."}}),void this.importsCollection.add(a))},_onImportsStateChange:function(a){if(a.hasCompleted()){this.trigger("importCompleted",a,this);var b=this;this.vis.map.addCartodbLayerFromTable(a.imp.get("table_name"),this.user.get("username"),{vis:this.vis,success:function(){b.vis.map.layers.saveLayers();var c=a.get("upload").service_name,d=c&&"twitter_search"===c;d||b.importsCollection.remove(a)},error:function(){b.trigger("importLayerFail","Failed to add the connected dataset as a layer to this map"),b.importsCollection.remove(a)}})}},_onGeocodingsStateChange:function(a){a.hasCompleted()&&this.trigger("geocodingCompleted",a,this),a.hasFailed()&&this.trigger("geocodingFailed",a,this)},_onAnalysisStateChange:function(a,b){}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../common/background_polling/background_polling_model":1,"../common/background_polling/models/geocodings_collection":6,"../common/background_polling/models/imports_collection":9}],225:[function(a,b,c){var d=a("./cartocss/get-geo-attr"),e=a("./cartocss/get-default-css-for-geometry-type"),f=a("./cartocss/color-ramps");b.exports={choropleth:function(a,b,c,f,g){for(var h=d(f),i="#"+b,j=e(f),k="/** choropleth visualization */\n\n"+i+" {\n  "+h+": "+g[0]+";\n"+j.join("\n")+"\n}\n",l=a.length-1;l>=0;--l)void 0!==a[l]&&null!=a[l]&&(k+="\n"+i+"["+c+" <= "+a[l]+"] {\n",k+="  "+h+":"+g[l]+";\n}");return k},categoryMetadata:function(a,b){for(var c=[],d=b&&b.ramp?b.ramp:f.category,e=b&&b.type?b.type:"string",g=0;g<a.length;g++){var h=a[g];g<10&&void 0!==h&&("string"===e&&null!=h||"string"!==e)&&c.push({title:h,title_type:e,value_type:"color",color:d[g]})}return a.length>10&&c.push({title:"Others",value_type:"color",default:!0,color:d[d.length-1]}),c},category:function(a,b,c,g,h){for(var i,j,k=d(g),l="#"+b,m=f.category,n=h&&h.type?h.type:"string",m=h&&h.ramp?h.ramp:f.category,o=e(g),p="/** category visualization */\n\n"+l+" {\n  "+k+": "+m[0]+";\n"+o.join("\n")+"\n}\n",q=0;q<a.length;q++){var r=a[q];"string"===n?(i=r.replace(/\n/g,"\\n").replace(/\"/g,'\\"'),j='"'+i+'"'):j=r,q<10&&void 0!==r&&("string"===n&&null!=r||"string"!==n)&&(p+="\n"+l+"["+c+"="+j+"] {\n",p+="  "+k+":"+m[q]+";\n}")}return a.length>10&&(p+="\n"+l+"{\n",p+="  "+k+": "+m[m.length-1]+";\n}"),p},torque:function(a,b,c){var d="#"+b,e=["/** torque visualization */","Map {","  -torque-time-attribute: "+a.column+";",'  -torque-aggregation-function: "count(cartodb_id)";',"  -torque-frame-count: "+a.steps+";","  -torque-animation-duration: 10;","  -torque-resolution: 2;","}",d+" {","  marker-width: 3;","  marker-fill-opacity: 0.8;","  marker-fill: #0F3B82; ",'  comp-op: "lighten"; ',"  [frame-offset = 1] { marker-width: 10; marker-fill-opacity: 0.05;}","  [frame-offset = 2] { marker-width: 15; marker-fill-opacity: 0.02;}","}"];return e=e.join("\n")},bubble:function(a,b,c){var d="#"+b,f="/** bubble visualization */\n\n"+d+" {\n";f+=e("point").join("\n"),f+="\nmarker-fill: #FF5C00;",f+="\n}\n\n";for(var g=10,h=30,i=[],j=10,k=0;k<j;++k){var l=k/(j-1);i.push(g+l*(h-g))}for(var k=j-1;k>=0;--k)void 0!==a[k]&&null!=a[k]&&(f+="\n#"+b+" [ "+c+" <= "+a[k]+"] {\n",f+="   marker-width: "+i[k].toFixed(1)+";\n}");return f},heatmap:function(a,b,c){var d="#"+b,e=["/** heatmap visualization */","Map {",'  -torque-time-attribute: "cartodb_id";','  -torque-aggregation-function: "count(cartodb_id)";',"  -torque-frame-count: 1;","  -torque-animation-duration: 10;","  -torque-resolution: 2;","}",d+" {","  marker-width: 10;","  marker-fill-opacity: 0.4;","  marker-fill: #0F3B82; ",'  comp-op: "lighten"; ',"  image-filters: colorize-alpha(blue, cyan, lightgreen, yellow , orange, red);","  marker-file: url(http://s3.amazonaws.com/com.cartodb.assets.static/alphamarker.png);","}"];return e=e.join("\n")}}},{"./cartocss/color-ramps":226,"./cartocss/get-default-css-for-geometry-type":227,"./cartocss/get-geo-attr":228}],226:[function(a,b,c){b.exports={bool:["#229A00","#F84F40","#DDDDDD"],green:["#EDF8FB","#D7FAF4","#CCECE6","#66C2A4","#41AE76","#238B45","#005824"],blue:["#FFFFCC","#C7E9B4","#7FCDBB","#41B6C4","#1D91C0","#225EA8","#0C2C84"],pink:["#F1EEF6","#D4B9DA","#C994C7","#DF65B0","#E7298A","#CE1256","#91003F"],black:["#F7F7F7","#D9D9D9","#BDBDBD","#969696","#737373","#525252","#252525"],red:["#FFFFB2","#FED976","#FEB24C","#FD8D3C","#FC4E2A","#E31A1C","#B10026"],category:["#A6CEE3","#1F78B4","#B2DF8A","#33A02C","#FB9A99","#E31A1C","#FDBF6F","#FF7F00","#CAB2D6","#6A3D9A","#DDDDDD"],divergent:["#0080FF","#40A0FF","#7FBFFF","#FFF2CC","#FFA6A6","#FF7A7A","#FF4D4D"]}},{}],227:[function(a,b,c){b.exports=function(a){return"polygon"===a?["polygon-opacity: 0.7;","line-color: #FFF;","line-width: 0.5;","line-opacity: 1;"]:"line"===a?["line-width: 2;","line-opacity: 0.7;"]:["marker-fill-opacity: 0.9;","marker-line-color: #FFF;","marker-line-width: 1;","marker-line-opacity: 1;","marker-placement: point;","marker-type: ellipse;","marker-width: 10;","marker-allow-overlap: true;"]}},{}],228:[function(a,b,c){b.exports=function(a){return{line:"line-color",polygon:"polygon-fill",point:"marker-fill"}[a]}},{}],229:[function(a,b,c){var d=function(a,b){var c={};for(var e in b)if(b.hasOwnProperty(e)){var f,g=b[e];"object"==typeof a&&(f=a[e]),"object"==typeof g&&"object"==typeof f?c[e]=d(f,g):"object"!=typeof g&&void 0!==f?c[e]=f:c[e]=g}return c||{}};b.exports=d},{}],230:[function(a,b,c){var d=a("./cartocss/color-ramps.js");b.exports=function(a){var b,c=d.blue,e="blue";return["A","U"].indexOf(a.dist_type)!=-1?(b=a.jenks,a.min<0&&a.max>0&&(c=d.divergent,e="spectrum2")):"F"===a.dist_type?(b=a.equalint,c=d.red,e="red"):"J"===a.dist_type?(b=a.headtails,c=d.blue,e="blue"):(b=a.headtails,c=d.red,e="red"),{name:e,ramp:c,method:b}}},{"./cartocss/color-ramps.js":226}],231:[function(a,b,c){b.exports=function(a){return{U:.9,A:.9,L:.7,J:.7,S:.5,F:.3}[a]}},{}],232:[function(a,b,c){var d=a("./cartocss/color-ramps"),e=a("./get-weight-from-shape"),f=a("./get-method-properties"),g=a("./deep-defaults"),h=a("./cartocss");b.exports=function(a){var b=a.dependencies.underscore,c=a.tableName,i=g(a.thresholds,{number:{forBubbleMap:{minCalcWeight:.5,maxStatsCount:200},forCategoryOrBubbleMap:{minStatsWeight:.5,distinctPercentage:25,forCategory:{maxDistinctPercentage:1},forBubble:{minDistinctPercentage:1}}}}),j=a.column,k=j.geometryType,l=j.stats,m=l.column,n="choropleth",o=null,p=l.type,q=[],r=l.distinct/l.count*100;if("number"===p){var s=(l.weight+e(l.dist_type))/2;if(s>=i.number.forBubbleMap.minCalcWeight){var t=h.choropleth,u=f(l);l.count<i.number.forBubbleMap.maxStatsCount&&"point"===k&&(n="bubble",t=h.bubble),o=t(u.method,c,m,k,u.ramp)}else if(l.weight>i.number.forCategoryOrBubbleMap.minStatsWeight||r<i.number.forCategoryOrBubbleMap.maxDistinctPercentage)if(r<i.number.forCategoryOrBubbleMap.forCategory.maxDistinctPercentage){n="category";var v=l.cat_hist;v=b.sortBy(v,function(a){return a[1]}).reverse().slice(0,d.category.length),v=b.sortBy(v,function(a){return a[0]}),v=v.map(function(a){return a[0]}),o=h.category(v,c,m,k,{type:p}),q=h.categoryMetadata(v,{type:p})}else if(r>=i.number.forCategoryOrBubbleMap.forBubble.minDistinctPercentage){var t=h.choropleth;"point"===k&&(n="bubble",t=h.bubble);var u=f(l);o=t(u.method,c,m,k,u.ramp)}}else if("string"===p){n="category";var v=l.hist;v=b.sortBy(v,function(a){return a[1]}).reverse().slice(0,d.category.length),v=b.sortBy(v,function(a){return a[0]}),v=v.map(function(a){return a[0]}),o=h.category(v,c,m,k),q=h.categoryMetadata(v)}else if("date"===p)n="torque",o=h.torque(l,c);else if("boolean"===p){n="category";var w=d.bool,v=["true","false",null],x={type:p,ramp:w};o=h.category(v,c,m,k,x),q=h.categoryMetadata(v,x)}else"geom"===l.type&&(n="heatmap",o=h.heatmap(l,c,x));var u={geometryType:k,column:m,bbox:j.bbox,type:p,visualizationType:n};return o?u.css=o:(u.css=null,u.weight=-100),l&&(u.stats=l),q&&(u.metadata=q),u}},{"./cartocss":225,"./cartocss/color-ramps":226,"./deep-defaults":229,"./get-method-properties":230,"./get-weight-from-shape":231}],233:[function(a,b,c){var d=a("./get-weight-from-shape"),e=a("./deep-defaults"),f={geom:function(a){var b=a.stats;return a.isPointGeometryType&&b.cluster_rate*b.density>=a.thresholds.geom.minStatsDensity},string:function(a){return a.stats.weight>=a.thresholds.string.minWeight},number:function(a){var b=a.stats,c=b.distinct/b.count*100,e=(b.weight+d(b.dist_type))/2;return b.weight>=a.thresholds.number.minWeight&&(e>=a.thresholds.number.minCalcWeight||b.weight>a.thresholds.number.minWeightIfNoOtherApplies||c<a.thresholds.number.maxDistinctPercentage)},boolean:function(a){return a.stats.null_ratio<=a.thresholds.boolean.maxNullRatio},date:function(a){return a.isPointGeometryType&&a.stats.null_ratio<=a.thresholds.date.maxNullRatio}};b.exports=function(a){var b=!1,a=a||{};if(a.thresholds=e(a.thresholds,{geom:{minStatsDensity:.1},string:{minWeight:.8},number:{minWeight:.1,minCalcWeight:.5,maxDistinctPercentage:25,minWeightIfNoOtherApplies:.5},boolean:{maxNullRatio:.75},date:{maxNullRatio:.75}}),a&&a.stats){var c=f[a.stats.type];"function"==typeof c&&(b=c.call(this,a))}return b}},{"./deep-defaults":229,"./get-weight-from-shape":231}],234:[function(a,b,c){b.exports={hasEnoughToGuess:a("./has-enough-to-guess"),guessMap:a("./guess-map"),getWeightFromShape:a("./get-weight-from-shape"),getMethodProperties:a("./get-method-properties")}},{"./get-method-properties":230,"./get-weight-from-shape":231,"./guess-map":232,"./has-enough-to-guess":233}],235:[function(a,b,c){!function(a,d){"object"==typeof c&&"undefined"!=typeof b?b.exports=d():"function"==typeof define&&define.amd?define("queue",d):a.queue=d()}(this,function(){"use strict";function a(){}function b(b){function c(){if(!k)for(;k=o&&p<b;){var a=q+p,c=m[a],d=c.length-1,f=c[d];c[d]=g(a),--o,++p,m[a]=f.apply(null,c)||e}}function g(a){return function(b,d){if(!m[a])throw new Error;--p,++q,m[a]=null,null==l&&(null!=b?h(b):(n[a]=d,o?c():p||i()))}}function h(a){l=a,o=NaN,i()}function i(){null!=l?r(l):s?r(null,n):r.apply(null,f.concat(n))}if(!(b>=1))throw new Error;var j,k,l,m=[],n=[],o=0,p=0,q=0,r=a,s=!0;return j={defer:function(b){if(r!==a)throw new Error;var e=d.call(arguments,1);return e.push(b),++o,m.push(e),c(),j},abort:function(){if(null==l){for(var a,b=q+p;--b>=0;)(a=m[b])&&a.abort&&a.abort();h(new Error("abort"))}return j},await:function(b){if(r!==a)throw new Error;return r=b,s=!1,o||p||i(),j},awaitAll:function(b){if(r!==a)throw new Error;return r=b,s=!0,o||p||i(),j}}}function c(a){return b(arguments.length?+a:1/0)}var d=[].slice,e={},f=[null];return c.version="1.2.1",c})},{}]},{},[223]);
//# sourceMappingURL=editor.js.map