(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
var _ = require('underscore');
var Notifier = require('./components/notifier/notifier');

var NOTIFICATION_ERROR_TEMPLATE = _.template("<span class='u-errorTextColor'><%- title %></span>");
var NOTIFICATION_PREFIX = 'cartocss-notification-';

var CartoCSSNotifications = {
  track: function (view) {
    // In order to not bloat the notification center we will create
    // only one notification, and update it along the way
    this._notificationId = NOTIFICATION_PREFIX + view.cid;
  },

  showSuccessNotification: function () {
    var notificationAttrs = {
      status: 'success',
      info: _t('notifications.cartocss.success'),
      closable: true,
      delay: Notifier.DEFAULT_DELAY
    };

    this._addOrUpdateNotification(this._notificationId, notificationAttrs);
  },

  showErrorNotification: function (errors) {
    var notificationAttrs = {
      status: 'error',
      info: _t('notifications.cartocss.error.body', {
        body: NOTIFICATION_ERROR_TEMPLATE({
          title: _t('notifications.cartocss.error.title')
        }),
        error: this._transformErrors(errors)
      }),
      closable: true,
      delay: Notifier.DEFAULT_DELAY
    };

    this._addOrUpdateNotification(this._notificationId, notificationAttrs);
  },

  _transformErrors: function (errors) {
    return _.map(errors, function (err) {
      return err.message;
    }, this).join('. ');
  },

  _addOrUpdateNotification: function (notificationId, notificationAttrs) {
    var notification = this._getNotification(notificationId);
    if (notification) {
      notification.set(notificationAttrs);
    } else {
      this._addNotification(notificationId, notificationAttrs);
    }
  },

  _addNotification: function (notificationId, notificationAttrs) {
    notificationAttrs = _.extend({
      id: notificationId
    }, notificationAttrs);
    Notifier.addNotification(notificationAttrs);
  },

  _getNotification: function (notificationId) {
    return Notifier.getNotification(notificationId);
  }
};

module.exports = CartoCSSNotifications;

},{"./components/notifier/notifier":475,"underscore":"underscore"}],2:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var Notifier = require('../../components/notifier/notifier');
var UploadConfig = require('../../config/upload-config');
var ErrorDetailsView = require('./error-details-view');
var WarningsDetailsView = require('./warnings-details-view');
var TwitterImportDetailsDialog = require('./twitter-import-details-view');

/**
 *  Import item within background importer
 *
 */

var DELEGATIONS = {
  loading: require('./delegated-import-views/loading'),
  error: require('./delegated-import-views/failed'),
  warning: require('./delegated-import-views/warnings'),
  success: require('./delegated-import-views/success')
};

module.exports = CoreView.extend({
  initialize: function (opts) {
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.modals) throw new Error('modals is required');
    if (!opts.importModel) throw new Error('importModel is required');

    this._userModel = opts.userModel;
    this._configModel = opts.configModel;
    this._modals = opts.modals;
    this._importModel = opts.importModel;
    this._showSuccessDetailsButton = opts.showSuccessDetailsButton;

    this._notification = Notifier.addNotification({});

    this._initBinds();
  },

  _initBinds: function () {
    this._importModel.on('change', this.updateNotification, this);
    this._importModel.on('remove', this.clean, this);
    this._notification.on('notification:close', this._closeHandler, this);
    this._notification.on('notification:action', this._actionHandler, this);
    this.add_related_model(this._importModel);
    this.add_related_model(this._notification);
  },

  _closeHandler: function () {
    this.trigger('remove', this._importModel, this);
    this._importModel.pause();
    this.clean();
  },

  _actionHandler: function (action) {
    if (action === 'show_errors') {
      this._showImportError();
    } else if (action === 'show_stats') {
      this._showImportStats();
    } else if (action === 'show_table') {
      this._showImportDataset();
    } else if (action === 'show_warnings') {
      this._showImportWarnings();
    }
  },

  _getStatus: function () {
    var status = 'loading';
    var failed = this._importModel.hasFailed();
    var completed = this._importModel.hasCompleted();
    var warnings = this._importModel.getWarnings();

    if (failed) {
      status = 'error';
    } else if (completed && !warnings) {
      status = 'success';
    } else if (completed && warnings) {
      status = 'warning';
    }

    return status;
  },

  _getInfo: function () {
    var upload = this._importModel.get('upload');
    var imp = this._importModel.get('import');

    var d = {
      name: '',
      state: this._importModel.get('state'),
      progress: '',
      service: '',
      step: this._importModel.get('step'),
      failed: this._importModel.hasFailed(),
      completed: this._importModel.hasCompleted(),
      warnings: this._importModel.getWarnings(),
      showSuccessDetailsButton: this._showSuccessDetailsButton,
      tables_created_count: imp.tables_created_count
    };

    // Name
    if (upload.type) {
      if (upload.type === 'file') {
        if (upload.value.length > 1) {
          d.name = upload.value.length + ' files';
        } else {
          d.name = upload.value.name;
        }
      }
      if (upload.type === 'url' || upload.type === 'remote') {
        d.name = upload.value;
      }
      if (upload.type === 'service') {
        d.name = upload.value && upload.value.filename || '';
      }
      if (upload.service_name === 'twitter_search') {
        d.name = 'Twitter import';
      }
      if (upload.type === 'sql') {
        d.name = 'SQL';
      }
      if (upload.type === 'duplication') {
        d.name = upload.table_name || upload.value;
      }
    } else {
      d.name = imp.display_name || imp.item_queue_id || 'import';
    }

    // Service
    d.service = upload.service_name;

    // Progress
    if (this._importModel.get('step') === 'upload') {
      d.progress = this._importModel.get('upload').progress;
    } else {
      d.progress = Math.max(0, (UploadConfig.uploadStates.indexOf(d.state) / UploadConfig.uploadStates.length) * 100);
    }

    d.progress = d.progress.toFixed(0);

    return d;
  },

  updateNotification: function () {
    var status = this._getStatus();
    var delegated = DELEGATIONS[status];
    delegated.call(this, this._importModel, this._notification, status, this._getInfo(), this._showSuccessDetailsButton);
  },

  _showImportDataset: function () {
    var dataset = this._importModel.get('import').table_name;
    window.location = this._configModel.get('base_url') + '/dataset/' + dataset;
  },

  _showImportStats: function () {
    var self = this;
    this._modals.create(function (modalModel) {
      return new TwitterImportDetailsDialog({
        modalModel: modalModel,
        userModel: self._userModel,
        model: self._importModel
      });
    });
  },

  _showImportError: function () {
    var self = this;
    this._modals.create(function (modalModel) {
      return new ErrorDetailsView({
        configModel: self._configModel,
        modalModel: modalModel,
        error: self._importModel.getError(),
        userModel: self._userModel
      });
    });
  },

  _showImportWarnings: function () {
    var self = this;
    this._modals.create(function (modalModel) {
      return new WarningsDetailsView({
        modalModel: modalModel,
        warnings: self._importModel.getWarnings(),
        userModel: self._userModel
      });
    });
  }
});

},{"../../components/notifier/notifier":475,"../../config/upload-config":597,"./delegated-import-views/failed":6,"./delegated-import-views/loading":8,"./delegated-import-views/success":10,"./delegated-import-views/warnings":12,"./error-details-view":14,"./twitter-import-details-view":16,"./warnings-details-view":22,"backbone/core-view":1127}],3:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./background-import-limit.tpl');
var Notifier = require('../../components/notifier/notifier');

/**
 *  Import limit message within background importer
 *
 */

module.exports = CoreView.extend({
  initialize: function (opts) {
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.configModel) throw new Error('configModel is required');

    this._userModel = opts.userModel;
    this._configModel = opts.configModel;

    this._notification = Notifier.addNotification({
      status: 'error',
      closable: true,
      button: false,
      info: this._getInfo()
    });

    this._initBinds();
  },

  _initBinds: function () {
    this._notification.on('notification:close', this._closeHandler, this);
    this.add_related_model(this._notification);
  },

  _closeHandler: function () {
    this.clean();
  },

  _getInfo: function () {
    var importQuota = this._userModel.getMaxConcurrentImports();
    var isUpgradeable = !this._configModel.get('cartodb_com_hosted') && importQuota === 1;

    return template({
      upgradeUrl: window.upgrade_url,
      isUpgradeable: isUpgradeable,
      importQuota: importQuota
    });
  }
});

},{"../../components/notifier/notifier":475,"./background-import-limit.tpl":4,"backbone/core-view":1127}],4:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (isUpgradeable) { 
__p+='\n'+
((__t=( _t('components.background-importer.background-import-limit.hurry', { upgradeUrl: upgradeUrl }) ))==null?'':_.escape(__t))+
'\n';
 } else { 
__p+='\n'+
((__t=( _t('components.background-importer.background-import-limit.one-file', { importQuota: importQuota }) ))==null?'':_.escape(__t))+
'\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],5:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var ImportItemView = require('./background-import-item-view');
var ImportLimitItemView = require('./background-import-limit-view');
var ImportsModel = require('../../data/background-importer/imports-model');

/**
 *  Background polling manager
 *
 *  It will pool all polling operations (imports) that happens
 *  in the Builder
 *
 */

var BackgroundImporter = function (options) {
  this.options = options || {};
  this._importers = {};
  this.initialize(this.options);
};

BackgroundImporter.prototype = {
  initialize: function (opts) {
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.modals) throw new Error('modals is required');
    if (!opts.pollingModel) throw new Error('pollingModel is required');

    this._userModel = opts.userModel;
    this._configModel = opts.configModel;
    this._createVis = opts.createVis;
    this._modals = opts.modals;
    this._model = opts.pollingModel;

    this._initBinds();
  },

  addView: function (view) {
    this._importers[view.cid] = view;
  },

  removeView: function (view) {
    delete this._importers[view.cid];
  },

  enable: function () {
    this._model.startPollings();
  },

  disable: function () {
    this._model.stopPollings();
  },

  removeImport: function (model) {
    this._model.removeImportItem(model);
  },

  destroy: function () {
    this._model.off(null, null, this);
  },

  _initBinds: function () {
    this._model.on('importAdded', this._addImport, this);
    this._model.on('importByUploadData', this._addDataset, this);
  },

  _addImport: function (m) {
    var importItemView = new ImportItemView({
      configModel: this._configModel,
      showSuccessDetailsButton: this._model.get('showSuccessDetailsButton'),
      modals: this._modals,
      importModel: m,
      userModel: this._userModel
    });

    importItemView.on('remove', this._removeImport, this);
    this.addView(importItemView);
    this.enable();
  },

  _addDataset: function (d) {
    if (d) {
      this._addImportsItem(d);
    }
  },

  _onDroppedFile: function (files) {
    if (files) {
      this._addImportsItem({
        type: 'file',
        value: files,
        create_vis: this._createVis
      });
    }
  },

  _addImportsItem: function (uploadData) {
    if (this._model.canAddImport()) {
      this._removeLimitItem();
    } else {
      this._addLimitItem();
      return false;
    }

    var imp = new ImportsModel({}, {
      upload: uploadData,
      userModel: this._userModel,
      configModel: this._configModel
    });

    this._model.addImportItem(imp);
  },

  _addLimitItem: function () {
    if (!this._importLimit) {
      var view = new ImportLimitItemView({
        configModel: this._configModel,
        userModel: this._userModel
      });

      this.addView(view);
      this._importLimit = view;
    }
  },

  _removeLimitItem: function () {
    var view = this._importLimit;
    if (view) {
      view.clean();
      this.removeView(view);
      delete this._importLimit;
    }
  },

  _removeImport: function (model, view) {
    this._model.removeImportItem(model);
    this.removeView(view);
  }
};

// Supporting default Backbone events like on, off, trigger, listenTo etc
_.extend(BackgroundImporter.prototype, Backbone.Events, {
  remove: function () {
    this.stopListening();
  }
});

var manager = (function () {
  var initialized = false;
  var importer;

  return {
    init: function (opts) {
      if (!initialized) {
        importer = new BackgroundImporter(opts);
      }
      return importer;
    }
  };
})();

module.exports = manager;

},{"../../data/background-importer/imports-model":612,"./background-import-item-view":2,"./background-import-limit-view":3,"backbone":"backbone","underscore":"underscore"}],6:[function(require,module,exports){
var template = require('./failed.tpl');

function getAction () {
  return 'show_errors';
}

function getButton () {
  return _t('components.background-importer.background-importer-item.show');
}

function getClosable () {
  return true;
}

function updateNotification (info) {
  var data = {
    info: info,
    status: _status,
    closable: getClosable(),
    button: getButton(),
    action: getAction()
  };

  _notification.update(data);
}

var _notification;
var _status;

module.exports = function (model, notification, status, info, showDetails) {
  _notification = notification;
  _status = status;
  updateNotification(template(info));
};

},{"./failed.tpl":7}],7:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+=''+
((__t=( _t('components.background-importer.background-importer-item.error-connecting', { name: name }) ))==null?'':__t)+
' ';
 if (service) { 
__p+=' '+
((__t=( _t('components.background-importer.background-importer-item.from') ))==null?'':_.escape(__t))+
' '+
((__t=( service ))==null?'':_.escape(__t))+
' ';
 } 
__p+='';
}
return __p;
};

},{"underscore":"underscore"}],8:[function(require,module,exports){
var template = require('./loading.tpl');

function getAction () {
  return false;
}

function getButton () {
  return false;
}

function getClosable () {
  var state = _model.get('state');
  var step = _model.get('step');
  return state === 'uploading' && step === 'upload';
}

function updateNotification (info) {
  var data = {
    info: info,
    status: _status,
    closable: getClosable(),
    button: getButton(),
    action: getAction()
  };

  _notification.update(data);
}

var _model;
var _notification;
var _status;

module.exports = function (model, notification, status, info, showDetails) {
  _model = model;
  _notification = notification;
  _status = status;
  updateNotification(template(info));
};

},{"./loading.tpl":9}],9:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<span class=\'CDB-Text is-semibold\'>'+
((__t=( progress ))==null?'':_.escape(__t))+
'% '+
((__t=( state ))==null?'':_.escape(__t))+
'</span> '+
((__t=( name ))==null?'':_.escape(__t))+
' ';
 if (service && service != "twitter_search") { 
__p+=' '+
((__t=( _t('components.background-importer.background-importer-item.from') ))==null?'':_.escape(__t))+
' '+
((__t=( service ))==null?'':_.escape(__t))+
' ';
 } 
__p+='';
}
return __p;
};

},{"underscore":"underscore"}],10:[function(require,module,exports){
var template = require('./success.tpl');

function getAction () {
  var service = _model.get('upload').service_name;
  var tables_created_count = _model.get('import').tables_created_count;

  if (_showDetails) {
    if (service && service === 'twitter_search') {
      return 'show_stats';
    } else if (tables_created_count === 1) {
      return 'show_table';
    }
  }

  return false;
}

function getButton () {
  var service = _model.get('upload').service_name;
  var tables_created_count = _model.get('import').tables_created_count;

  if (_showDetails) {
    if (service && service === 'twitter_search') {
      return _t('components.background-importer.background-importer-item.show');
    } else if (tables_created_count === 1) {
      return _t('components.background-importer.background-importer-item.show');
    }
  }

  return false;
}

function getClosable () {
  return true;
}

function updateNotification (info) {
  var data = {
    info: info,
    status: _status,
    closable: getClosable(),
    button: getButton(),
    action: getAction()
  };

  _notification.update(data);
}

var _model;
var _notification;
var _status;
var _showDetails;

module.exports = function (model, notification, status, info, showDetails) {
  _model = model;
  _notification = notification;
  _status = status;
  _showDetails = showDetails;
  updateNotification(template(info));
};

},{"./success.tpl":11}],11:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+=''+
((__t=( name ))==null?'':_.escape(__t))+
' ';
 if (service && service != "twitter_search") { 
__p+=' '+
((__t=( _t('components.background-importer.background-importer-item.from') ))==null?'':_.escape(__t))+
' '+
((__t=( service ))==null?'':_.escape(__t))+
' ';
 } 
__p+=' <span class=\'CDB-Text is-semibold\'>'+
((__t=( _t('components.background-importer.background-importer-item.completed') ))==null?'':_.escape(__t))+
'</span>';
}
return __p;
};

},{"underscore":"underscore"}],12:[function(require,module,exports){
var template = require('./warnings.tpl');

function getAction () {
  return 'show_warnings';
}

function getButton () {
  return _t('components.background-importer.background-importer-item.show');
}

function getClosable () {
  return true;
}

function updateNotification (info) {
  var data = {
    info: info,
    status: _status,
    closable: getClosable(),
    button: getButton(),
    action: getAction()
  };

  _notification.update(data);
}

var _notification;
var _status;

module.exports = function (model, notification, status, info, showDetails) {
  _notification = notification;
  _status = status;
  updateNotification(template(info));
};

},{"./warnings.tpl":13}],13:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<span class=\'CDB-Text is-semibold\'>Some warnings</span> were produced for '+
((__t=( name ))==null?'':_.escape(__t))+
' ';
 if (service) { 
__p+=' '+
((__t=( _t('components.background-importer.background-importer-item.from') ))==null?'':_.escape(__t))+
' '+
((__t=( service ))==null?'':_.escape(__t))+
' ';
 } 
__p+='';
}
return __p;
};

},{"underscore":"underscore"}],14:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var defaultTemplate = require('./error-details.tpl');
var upgradeErrorTemplate = require('./upgrade-errors.tpl');
var UPGRADE_ERROR_CODES = [8001, 8005];

/**
 * Error details view, to be used together with an error object from an import model.
 *
 */

module.exports = CoreView.extend({
  initialize: function (opts) {
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.error) throw new Error('error is required');

    this._userModel = opts.userModel;
    this._configModel = opts.configModel;
    this._error = opts.error;
  },

  render: function () {
    var isUpgradeError = _.contains(UPGRADE_ERROR_CODES, this._error.errorCode);
    var upgradeUrl = this._configModel.get('upgrade_url');
    var userCanUpgrade = upgradeUrl && !this._configModel.get('cartodb_com_hosted') && (!this._userModel.isInsideOrg() || this._userModel.isOrgOwner());
    var template = this._getTemplate(isUpgradeError);

    var html = template({
      errorCode: this._error.errorCode,
      title: this._error.title,
      text: this._error.what_about,
      itemQueueId: this._error.item_queue_id,
      originalUrl: this._error.originalUrl,
      httpResponseCode: this._error.httpResponseCode,
      httpResponseCodeMessage: this._error.httpRresponseCodeMessage,
      userCanUpgrade: userCanUpgrade,
      showTrial: this._userModel.canStartTrial(),
      upgradeUrl: upgradeUrl
    });

    this.$el.html(html);

    return this;
  },

  _getTemplate: function (isUpgradeError) {
    var template = defaultTemplate;

    if (isUpgradeError) {
      template = upgradeErrorTemplate;
    }
    return template;
  }
});

},{"./error-details.tpl":15,"./upgrade-errors.tpl":18,"backbone/core-view":1127,"underscore":"underscore"}],15:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Dialog-header">\n  <div class="Dialog-headerIcon Dialog-headerIcon--negative u-flex u-alignCenter u-justifyCenter">\n    <i class="CDB-IconFont CDB-IconFont-cloud"></i>\n  </div>\n  <h2 class="CDB-Text CDB-Size-large u-bSpace u-errorTextColor">\n    '+
((__t=( title ))==null?'':_.escape(__t))+
' ';
 if (errorCode) { 
__p+='('+
((__t=( errorCode ))==null?'':_.escape(__t))+
')';
 } 
__p+='\n  </h2>\n  <h3 class="CDB-Text CDB-Size-medium u-secondaryTextColor">\n    ';
 if (itemQueueId) { 
__p+='\n    '+
((__t=( _t('components.background-importer.error-details.dont-panic') ))==null?'':_.escape(__t))+
'\n    ';
 } else { 
__p+='\n    '+
((__t=( _t('components.background-importer.error-details.check-errors') ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  </h3>\n</div>\n\n<div class="Dialog-body ErrorDetails-body">\n  <ul class="Modal-containerList">\n    ';
 if (httpResponseCode) { 
__p+='\n      <li class="ErrorDetails-item">\n        <div class="ErrorDetails-itemStep CDB-Text CDB-Size-medium is-semibold u-flex u-alignCenter u-justifyCenter">1</div>\n        <div class="ErrorDetails-itemText">\n          <p class="CDB-Text CDB-Size-medium">\n            '+
((__t=( _t('components.background-importer.error-details.remote-server-code', { httpResponseCode: httpResponseCode}) ))==null?'':__t)+
' '+
((__t=( httpResponseCodeMessage ))==null?'':_.escape(__t))+
'\n          </p>\n        </div>\n      </li>\n      <li class="ErrorDetails-item">\n        <div class="ErrorDetails-itemStep CDB-Text CDB-Size-medium is-semibold u-flex u-alignCenter u-justifyCenter">2</div>\n        <div class="ErrorDetails-itemText">\n          <p class="CDB-Text CDB-Size-medium">\n            '+
((__t=( _t('components.background-importer.error-details.check-url') ))==null?'':_.escape(__t))+
':<br/>\n          </p>\n          <span class=\'CDB-Text CDB-Size-medium ErrorDetails-itemTextStrong\'><a href="'+
((__t=( originalUrl ))==null?'':_.escape(__t))+
'">'+
((__t=( originalUrl ))==null?'':_.escape(__t))+
'</a></span>\n        </div>\n      </li>\n    ';
 } else { 
__p+='\n      <li class="ErrorDetails-item">\n        <div class="ErrorDetails-itemStep CDB-Text CDB-Size-medium is-semibold u-flex u-alignCenter u-justifyCenter">1</div>\n        <div class="ErrorDetails-itemText">\n          <p class="CDB-Text CDB-Size-medium">\n            ';
 if (text) { 
__p+='\n            '+
((__t=( cdb.core.sanitize.html(text) ))==null?'':__t)+
'\n            ';
 } else { 
__p+='\n            '+
((__t=( _t('components.background-importer.error-details.unknown-error') ))==null?'':_.escape(__t))+
'\n            ';
 } 
__p+='\n          </p>\n        </div>\n      </li>\n    ';
 } 
__p+='\n    ';
 if (itemQueueId) { 
__p+='\n      <li class="ErrorDetails-item">\n        <div class="ErrorDetails-itemStep CDB-Text CDB-Size-medium is-semibold u-flex u-alignCenter u-justifyCenter">!</div>\n        <div class="ErrorDetails-itemText">\n          <p class="CDB-Text CDB-Size-medium">\n            '+
((__t=( _t('components.background-importer.error-details.send-us-the-error-code') ))==null?'':__t)+
':<br/>\n          </p>\n          <span class="CDB-Text CDB-Size-medium ErrorDetails-itemTextStrong">'+
((__t=( itemQueueId ))==null?'':_.escape(__t))+
'</span>\n        </div>\n      </li>\n    ';
 } 
__p+='\n  </ul>\n</div>\n\n\n<div class="Dialog-footer--simple u-inner">\n  <button class="CDB-Button CDB-Button--error u-tSpace--m js-close">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n      '+
((__t=( _t('components.background-importer.error-details.close') ))==null?'':_.escape(__t))+
'\n    </span>\n  </button>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],16:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var Utils = require('../../helpers/utils');
var template = require('./twitter-import-details.tpl');

/**
 *  When a Twitter import finishes, this dialog displays
 *  all the info about the price/cost etc.
 *
 */
module.exports = CoreView.extend({

  className: 'TwitterImportDetails',

  events: {
    'click .js-close': '_onCloseClick'
  },

  initialize: function (opts) {
    if (!opts.modalModel) throw new Error('modalModel is required');
    if (!opts.userModel) throw new Error('userModel is required');
    this._userModel = opts.userModel;
    this._modalModel = opts.modalModel;
  },

  render: function () {
    var imp = this.model.get('import');
    var userTwitterValues = this._userModel.get('twitter');
    var availableTweets = userTwitterValues.quota - userTwitterValues.monthly_use;

    this.$el.html(
      template({
        datasetTotalRows: imp.tweets_georeferenced,
        datasetTotalRowsFormatted: Utils.formatNumber(imp.tweets_georeferenced),
        tweetsCost: imp.tweets_cost,
        tweetsCostFormatted: Utils.formatNumber(imp.tweets_cost),
        availableTweets: availableTweets,
        availableTweetsFormatted: Utils.formatNumber(availableTweets),
        tweetsOverquota: imp.tweets_overquota,
        tweetsOverquotaFormatted: Utils.formatNumber(imp.tweets_overquota),
        blockSizeFormatted: Utils.formatNumber(userTwitterValues.block_size),
        blockPriceFormatted: Utils.formatNumber(userTwitterValues.block_price)
      })
    );

    return this;
  },

  _onCloseClick: function () {
    this._modalModel.destroy();
  }
});

},{"../../helpers/utils":1102,"./twitter-import-details.tpl":17,"backbone/core-view":1127}],17:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Dialog-header">\n  <div class="Dialog-headerIcon Dialog-headerIcon--twitter u-flex u-alignCenter u-justifyCenter">\n    <i class="CDB-IconFont CDB-IconFont-twitter"></i>\n  </div>\n  <h2 class="CDB-Text CDB-Size-large u-bSpace Dialog-headerIcon--twitter">\n    '+
((__t=( _t('components.background-importer.twitter-import-details.twitter-import-title') ))==null?'':_.escape(__t))+
'\n  </h2>\n  <h3 class="CDB-Text CDB-Size-medium u-altTextColor">\n    ';
 if (datasetTotalRows === 0) { 
__p+='\n      '+
((__t=( _t('components.background-importer.twitter-import-details.errors.no-results') ))==null?'':_.escape(__t))+
'\n    ';
 } else { 
__p+='\n      '+
((__t=( _t('components.background-importer.twitter-import-details.new-type-created', { datasetTotalRowsFormatted: datasetTotalRowsFormatted, tweetPlural: datasetTotalRows != 1 ? 's' : '' }) ))==null?'':__t)+
'\n    ';
 } 
__p+='\n  </h3>\n</div>\n\n<div class="Dialog-body ErrorDetails-body">\n  <ul class="Modal-containerList">\n    <li class="ErrorDetails-item">\n      <div class="ErrorDetails-itemIcon ErrorDetails-itemIcon--success CDB-Size-big u-flex u-alignCenter u-justifyCenter u-rSpace--xl">\n        <i class="CDB-IconFont CDB-IconFont-dollar"></i>\n      </div>\n      <div class="ErrorDetails-itemText">\n        <p class="CDB-Text CDB-Size-large u-secondaryTextColor">\n          ';
 if (tweetsCost > 0) { 
__p+='\n            '+
((__t=( _t('components.background-importer.twitter-import-details.tweet-cost.paid', { tweetsCostFormatted: tweetsCostFormatted }) ))==null?'':_.escape(__t))+
'\n          ';
 } else { 
__p+='\n            '+
((__t=( _t('components.background-importer.twitter-import-details.tweet-cost.free', { tweetsCostFormatted: tweetsCostFormatted }) ))==null?'':_.escape(__t))+
'\n          ';
 } 
__p+='\n        </p>\n        <p class="CDB-Text CDB-Size-medium u-altTextColor">\n          ';
 if (tweetsCost > 0 || availableTweets <= 0) { 
__p+='\n            '+
((__t=( _t('components.background-importer.twitter-import-details.no-more-credits', { blockPriceFormatted: blockPriceFormatted, blockSizeFormatted: blockSizeFormatted }) ))==null?'':_.escape(__t))+
'\n          ';
 } else { 
__p+='\n            ';
 if (availableTweets != 1) { 
__p+='\n              '+
((__t=( _t('components.background-importer.twitter-import-details.credits-left', { availableTweetsFormatted: availableTweetsFormatted }) ))==null?'':_.escape(__t))+
'\n            ';
 } else { 
__p+='\n              '+
((__t=( _t('components.background-importer.twitter-import-details.credit-left', { availableTweetsFormatted: availableTweetsFormatted }) ))==null?'':_.escape(__t))+
'\n            ';
 } 
__p+='\n          ';
 } 
__p+='\n        </p>\n      </div>\n    </li>\n  </ul>\n</div>\n\n<div class="Dialog-footer--simple u-inner">\n  <button class="CDB-Button CDB-Button--primary u-tSpace--m">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase js-close">\n      '+
((__t=( _t('components.background-importer.error-details.close') ))==null?'':_.escape(__t))+
'\n    </span>\n  </button>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],18:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Dialog-header">\n  <div class="Dialog-headerIcon Dialog-headerIcon--negative u-flex u-alignCenter u-justifyCenter">\n    <i class="CDB-IconFont CDB-IconFont-barometer"></i>\n  </div>\n  <h2 class="CDB-Text CDB-Size-large u-bSpace u-errorTextColor">\n    '+
((__t=( _t('components.background-importer.upgrade-errors.' + errorCode + '.title') ))==null?'':_.escape(__t))+
'\n  </h2>\n  <h3 class="CDB-Text CDB-Size-medium u-secondaryTextColor">\n    '+
((__t=( _t('components.background-importer.upgrade-errors.' + errorCode + '.description') ))==null?'':_.escape(__t))+
'\n  </h3>\n</div>\n\n<div class="Dialog-body ErrorDetails-body">\n  <ul class="Modal-containerList">\n    <li class="ErrorDetails-item">\n      <div class="ErrorDetails-itemIcon ErrorDetails-itemIcon--success CDB-Size-big u-flex u-alignCenter u-justifyCenter u-rSpace--xl">\n        <i class="CDB-IconFont CDB-IconFont-rocket"></i>\n      </div>\n      <div class="ErrorDetails-itemText">\n        <p class="CDB-Text CDB-Size-medium">\n          '+
((__t=( _t('components.background-importer.upgrade-errors.' + errorCode + '.info') ))==null?'':_.escape(__t))+
'\n          ';
 if (showTrial) { 
__p+='\n            <br/>\n            <a href="'+
((__t=( upgradeUrl ))==null?'':__t)+
'">'+
((__t=( _t('components.background-importer.free-trial', { days: 14 }) ))==null?'':_.escape(__t))+
'</a>\n          ';
 } 
__p+='\n        </p>\n      </div>\n    </li>\n  </ul>\n</div>\n\n<div class="Dialog-footer--simple u-inner">\n  <a href="'+
((__t=( upgradeUrl ))==null?'':_.escape(__t))+
'" class="CDB-Button CDB-Button--primary u-tSpace--m">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n      '+
((__t=( _t('components.background-importer.upgrade-errors.upgrade') ))==null?'':_.escape(__t))+
'\n    </span>\n  </a>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],19:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Dialog-header ErrorDetails-header">\n  <div class="Dialog-headerIcon Dialog-headerIcon--alert">\n    <i class="CDB-IconFont CDB-IconFont-cloud"></i>\n  </div>\n  <p class="Dialog-headerTitle--warning">\n    '+
((__t=( _t('components.background-importer.partial-import-details.unable-to-import-as-layers') ))==null?'':_.escape(__t))+
'\n  </p>\n  <p class="Dialog-headerText">\n    '+
((__t=( _t('components.background-importer.partial-import-details.find-connected-datasets') ))==null?'':_.escape(__t))+
'</br>\n    '+
((__t=( _t('components.background-importer.partial-import-details.upgrade-your-account', { userMaxLayers: userMaxLayers }) ))==null?'':_.escape(__t))+
'</br>\n  </p>\n</div>\n';
 if (maxTablesPerImport) { 
__p+='\n  <div class="Dialog-body ErrorDetails-body">\n    <ul class="ErrorDetails-list">\n      <li class="ErrorDetails-item">\n        <div class="ErrorDetails-itemStep">!</div>\n        <div class="ErrorDetails-itemText">\n          '+
((__t=( _t('components.background-importer.partial-import-details.too-many-datasets', { maxTablesPerImport: maxTablesPerImport }) ))==null?'':_.escape(__t))+
'</br>\n        </div>\n      </li>\n    </ul>\n  </div>\n';
 } 
__p+='\n<div class="Dialog-footer ErrorDetails-footer">\n  <button class="Button Button--secondary ErrorDetails-footerButton js-close">\n    <span>'+
((__t=( _t('components.background-importer.partial-import-details.continue-btn') ))==null?'':_.escape(__t))+
'</span>\n  </button>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],20:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Dialog-header ErrorDetails-header">\n  <div class="Dialog-headerIcon Dialog-headerIcon--alert">\n    <i class="CDB-IconFont CDB-IconFont-cloud"></i>\n  </div>\n  <p class="Dialog-headerTitle--warning">\n    '+
((__t=( _t('components.background-importer.warnings-details.unable-to-import-datasets') ))==null?'':_.escape(__t))+
'\n  </p>\n  <p class="Dialog-headerText">\n    '+
((__t=( _t('components.background-importer.warnings-details.no-more-datasets', { maxTablesPerImport: maxTablesPerImport}) ))==null?'':_.escape(__t))+
'<br />\n    '+
((__t=( _t('components.background-importer.warnings-details.find-connected-datasets') ))==null?'':_.escape(__t))+
'\n  </p>\n</div>\n<div class="Dialog-footer ErrorDetails-footer">\n  <button class="Button Button--secondary ErrorDetails-footerButton u-upperCase js-close">\n    <span>'+
((__t=( _t('components.background-importer.warnings-details.continue-btn') ))==null?'':_.escape(__t))+
'</span>\n  </button>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],21:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Dialog-header ErrorDetails-header">\n  <div class="Dialog-headerIcon Dialog-headerIcon--alert">\n    <i class="CDB-IconFont CDB-IconFont-cloud"></i>\n  </div>\n  <p class="Dialog-headerTitle--warning">\n    '+
((__t=( _t('components.background-importer.connector-warning-details.too-many-rows') ))==null?'':_.escape(__t))+
'\n  </p>\n  <p class="Dialog-headerText">\n    '+
((__t=( _t('components.background-importer.connector-warning-details.unable-to-import-all-rows', { maxRowsPerConnectorImport: maxRowsPerConnectorImport}) ))==null?'':_.escape(__t))+
'<br />\n  </p>\n</div>\n<div class="Dialog-footer ErrorDetails-footer">\n  <button class="Button Button--secondary ErrorDetails-footerButton u-upperCase js-close">\n    <span>'+
((__t=( _t('components.background-importer.connector-warning-details.continue-btn') ))==null?'':_.escape(__t))+
'</span>\n  </button>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],22:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var partialImportDetailsTemplate = require('./warning-partial-import-details.tpl');
var tooManyFilesDetailsTemplate = require('./warning-too-many-files-details.tpl');
var tooManyRowsConnectorTemplate = require('./warning-too-many-rows-connector-details.tpl');

/**
 * Error details view, to be used together with an error object from an import model.
 *
 */

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.warnings) throw new Error('warnings is required');

    this._userModel = this.options.userModel;
    this._warnings = this.options.warnings;
  },

  render: function () {
    var warnings = this._warnings;
    var template = this._getTemplate(warnings);

    this.$el.html(
      template({
        userMaxLayers: warnings.user_max_layers,
        maxTablesPerImport: warnings.max_tables_per_import,
        maxRowsPerConnectorImport: warnings.max_rows_per_connection
      })
    );

    return this;
  },

  _getTemplate: function (warnings) {
    if (warnings.user_max_layers && warnings.max_tables_per_import) {
      return (warnings.user_max_layers < warnings.max_tables_per_import) ? partialImportDetailsTemplate : tooManyFilesDetailsTemplate;
    } else if (warnings.user_max_layers) {
      return partialImportDetailsTemplate;
    } else if (warnings.max_tables_per_import) {
      return tooManyFilesDetailsTemplate;
    } else if (warnings.max_rows_per_connection) {
      return tooManyRowsConnectorTemplate;
    }
  }
});

},{"./warning-partial-import-details.tpl":19,"./warning-too-many-files-details.tpl":20,"./warning-too-many-rows-connector-details.tpl":21,"backbone/core-view":1127}],23:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var CarouselView = require('./custom-carousel/custom-carousel-view');

/**
 *  Carousel form view
 */

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.collection) throw new Error('Carousel collection is required');
    if (!opts.template) throw new Error('template is required');
    this.template = opts.template;
    this._initBinds();
  },

  render: function () {
    var selectedItem = this.collection.getSelected();
    var selectedName = selectedItem && selectedItem.getName();
    this.$el.html(
      this.template({
        name: selectedName
      })
    );
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this.collection.bind('change:highlighted', this._onChangeHighlighted, this);
  },

  _initViews: function () {
    var carousel = new CarouselView(_.extend(this.options, {
      collection: this.collection
    }));

    if (!this.$('.js-selector').length) throw new Error('HTML element with js-selector class is required');

    this.$('.js-selector').append(carousel.render().el);
    carousel.initScroll();
    this.addView(carousel);
  },

  _onChangeHighlighted: function () {
    var item = this.collection.getHighlighted() || this.collection.getSelected();
    if (item) {
      var $el = this.$('.js-highlight');
      if ($el) {
        $el.text(item.getName());
      }
    }
  }

});

},{"./custom-carousel/custom-carousel-view":44,"backbone/core-view":1127,"underscore":"underscore"}],24:[function(require,module,exports){
var COLOR_KEYWORDS = require('../../helpers/color-keywords');

/*
  LESS mode - http://www.lesscss.org/
  Ported to CodeMirror by Peter Kroon <plakroon@gmail.com>
  Report bugs/issues here: https://github.com/marijnh/CodeMirror/issues  GitHub: @peterkroon
*/

module.exports = function (CodeMirror) {
  CodeMirror.defineMode('cartocss', function (config) {
    var indentUnit = config.indentUnit;
    var type;

    function ret (style, tp) {
      type = tp;
      return style;
    }
    // html tags
    var tags = 'a abbr acronym address applet area article aside audio b base basefont bdi bdo big blockquote body br button canvas caption cite code col colgroup command datalist dd del details dfn dir div dl dt em embed fieldset figcaption figure font footer form frame frameset h1 h2 h3 h4 h5 h6 head header hgroup hr html i iframe img input ins keygen kbd label legend li link map mark menu meta meter nav noframes noscript object ol optgroup option output p param pre progress q rp rt ruby s samp script section select small source span strike strong style sub summary sup table tbody td textarea tfoot th thead time title tr track tt u ul var video wbr'.split(' ');
    var colorKeywords = keySet(COLOR_KEYWORDS);

    function inTagsArray (val) {
      for (var i = 0; i < tags.length; i++) {
        if (val === tags[i]) return true;
      }
    }

    var selectors = /(^\:root$|^\:nth\-child$|^\:nth\-last\-child$|^\:nth\-of\-type$|^\:nth\-last\-of\-type$|^\:first\-child$|^\:last\-child$|^\:first\-of\-type$|^\:last\-of\-type$|^\:only\-child$|^\:only\-of\-type$|^\:empty$|^\:link|^\:visited$|^\:active$|^\:hover$|^\:focus$|^\:target$|^\:lang$|^\:enabled^\:disabled$|^\:checked$|^\:first\-line$|^\:first\-letter$|^\:before$|^\:after$|^\:not$|^\:required$|^\:invalid$)/;

    function tokenBase (stream, state) {
      var ch = stream.next();

      if (ch === '@') {
        stream.eatWhile(/[\w\-]/);
        return ret('meta', stream.current());
      } else if (ch === '/' && stream.eat('*')) {
        state.tokenize = tokenCComment;
        return tokenCComment(stream, state);
      } else if (ch === '<' && stream.eat('!')) {
        state.tokenize = tokenSGMLComment;
        return tokenSGMLComment(stream, state);
      } else if (ch === '=') ret(null, 'compare');
      else if (ch === '|' && stream.eat('=')) return ret(null, 'compare');
      else if (ch === '\'' || ch === '\'') {
        state.tokenize = tokenString(ch);
        return state.tokenize(stream, state);
      } else if (ch === '/') { // e.g.: .png will not be parsed as a class
        if (stream.eat('/')) {
          state.tokenize = tokenSComment;
          return tokenSComment(stream, state);
        } else {
          if (type === 'string' || type === '(') {
            return ret('string', 'string');
          }
          if (state.stack[state.stack.length - 1] !== undefined) {
            return ret(null, ch);
          }
          stream.eatWhile(/[\a-zA-Z0-9\-_.\s]/);
          if (/\/|\)|#/.test(stream.peek() || (stream.eatSpace() && stream.peek() === ')')) || stream.eol()) {
            return ret('string', 'string'); // let url(/images/logo.png) without quotes return as string
          }
        }
      } else if (ch === '!') {
        stream.match(/^\s*\w*/);
        return ret('keyword', 'important');
      } else if (/\d/.test(ch)) {
        stream.eatWhile(/[\w.%]/);
        return ret('number', 'unit');
      } else if (/[,+<>*\/]/.test(ch)) {
        if (stream.peek() === '=' || type === 'a') {
          return ret('string', 'string');
        }
        return ret(null, 'select-op');
      } else if (/[;{}:\[\]()~\|]/.test(ch)) {
        if (ch === ':') {
          stream.eatWhile(/[a-z\\\-]/);

          if (selectors.test(stream.current())) {
            return ret('tag', 'tag');
          } else if (stream.peek() === ':') { // ::-webkit-search-decoration
            stream.next();
            stream.eatWhile(/[a-z\\\-]/);
            if (stream.current().match(/\:\:\-(o|ms|moz|webkit)\-/)) {
              return ret('string', 'string');
            }
            if (selectors.test(stream.current().substring(1))) {
              return ret('tag', 'tag');
            }
            return ret(null, ch);
          } else {
            return ret(null, ch);
          }
        } else if (ch === '~') {
          if (type === 'r') {
            return ret('string', 'string');
          }
        } else {
          return ret(null, ch);
        }
      } else if (ch === '.') {
        if (type === '(' || type === 'string') {
          return ret('string', 'string'); // allow url(../image.png)
        }
        stream.eatWhile(/[\a-zA-Z0-9\-_]/);
        if (stream.peek() === ' ') {
          stream.eatSpace();
        }
        if (stream.peek() === ')') {
          return ret('number', 'unit'); // rgba(0,0,0,.25);
        }
        return ret('tag', 'tag');
      } else if (ch === '#') {
        // we don't eat white-space, we want the hex color and or id only
        stream.eatWhile(/[A-Za-z0-9]/);
        // check if there is a proper hex color length e.g. #eee || #eeeEEE
        if (stream.current().length === 4 || stream.current().length === 7) {
          if (stream.current().match(/[A-Fa-f0-9]{6}|[A-Fa-f0-9]{3}/, false) != null) { // is there a valid hex color value present in the current stream
            // when not a valid hex value, parse as id
            if (stream.current().substring(1) !== stream.current().match(/[A-Fa-f0-9]{6}|[A-Fa-f0-9]{3}/, false)[0]) {
              return ret('atom', 'tag');
            }
            // eat white-space
            stream.eatSpace();
            // when hex value declaration doesn't end with [;,] but is does with a slash/cc comment treat it as an id, just like the other hex values that don't end with[;,]
            if (/[\/<>.({!$%^&*_\-\\?=+\|#'~`]/.test(stream.peek())) {
              return ret('atom', 'tag');
            } else if (stream.peek() === '}') {
              // #time { color: #aaa }
              return ret('color', 'unit');
            } else if (/[a-zA-Z\\]/.test(stream.peek())) {
              // we have a valid hex color value, parse as id whenever an element/class is defined after the hex(id) value e.g. #eee aaa || #eee .aaa
              return ret('color', 'unit');
            } else if (stream.eol()) {
              // when a hex value is on the end of a line, parse as id
              return ret('color', 'unit');
            } else {
              // default
              return ret('color', 'unit');
            }
          } else { // when not a valid hexvalue in the current stream e.g. #footer
            stream.eatWhile(/[\w\\\-]/);
            return ret('atom', 'tag');
          }
        } else { // when not a valid hexvalue length
          stream.eatWhile(/[\w\\\-]/);
          return ret('atom', 'tag');
        }
      } else if (ch === '&') {
        stream.eatWhile(/[\w\-]/);
        return ret(null, ch);
      } else {
        stream.eatWhile(/[\w\\\-_%.{]/);
        if (type === 'string') {
          return ret('string', 'string');
        } else if (stream.current().match(/(^http$|^https$)/) != null) {
          stream.eatWhile(/[\w\\\-_%.{:\/]/);
          return ret('string', 'string');
        } else if (stream.peek() === '<' || stream.peek() === '>') {
          return ret('tag', 'tag');
        } else if (/\(/.test(stream.peek())) {
          return ret(null, ch);
        } else if (stream.peek() === '/' && state.stack[state.stack.length - 1] !== undefined) { // url(dir/center/image.png)
          return ret('string', 'string');
        } else if (stream.current().match(/\-\d|\-.\d/)) { // match e.g.: -5px -0.4 etc... only colorize the minus sign
          // commment out these 2 comment if you want the minus sign to be parsed as null -500px
          // stream.backUp(stream.current().length-1);
          // return ret(null, ch); //console.log( stream.current() );
          return ret('number', 'unit');
        } else if (inTagsArray(stream.current().toLowerCase())) { // match html tags
          return ret('tag', 'tag');
        } else if (/\/|[\s\)]/.test(stream.peek() || stream.eol() || (stream.eatSpace() && stream.peek() === '/')) && stream.current().indexOf('.') !== -1) {
          if (stream.current().substring(stream.current().length - 1, stream.current().length) === '{') {
            stream.backUp(1);
            return ret('tag', 'tag');
          } // end if
          stream.eatSpace();
          if (/[{<>.a-zA-Z\/]/.test(stream.peek()) || stream.eol()) return ret('tag', 'tag'); // e.g. button.icon-plus
          return ret('string', 'string'); // let url(/images/logo.png) without quotes return as string
        } else if (stream.eol() || stream.peek() === '[' || stream.peek() === '#' || type === 'tag') {
          if (stream.current().substring(stream.current().length - 1, stream.current().length) === '{') stream.backUp(1);
          return ret('tag', 'tag');
        } else if (type === 'compare' || type === 'a' || type === '(') {
          return ret('string', 'string');
        } else if (type === '|' || stream.current() === '-' || type === '[') {
          return ret(null, ch);
        } else if (stream.peek() === ':') {
          stream.next();
          var t_v = stream.peek() === ':';
          if (!t_v) {
            var old_pos = stream.pos;
            var sc = stream.current().length;
            stream.eatWhile(/[a-z\\\-]/);
            var new_pos = stream.pos;
            if (stream.current().substring(sc - 1).match(selectors) != null) {
              stream.backUp(new_pos - (old_pos - 1));
              return ret('tag', 'tag');
            } else stream.backUp(new_pos - (old_pos - 1));
          } else {
            stream.backUp(1);
          }
          if (t_v) return ret('tag', 'tag');
          else return ret('variable', 'variable');

          // It is a color variable?
        } else if (colorKeywords.hasOwnProperty(stream.current())) {
          return ret('color', 'unit');
        } else {
          return ret('variable', 'variable');
        }
      }
    }

    function keySet (array) {
      var keys = {};
      for (var i = 0; i < array.length; ++i) {
        keys[array[i]] = true;
      }
      return keys;
    }

    function tokenSComment (stream, state) { // SComment = Slash comment
      stream.skipToEnd();
      state.tokenize = tokenBase;
      return ret('comment', 'comment');
    }

    function tokenCComment (stream, state) {
      var maybeEnd = false;
      var ch;
      while ((ch = stream.next()) != null) {
        if (maybeEnd && ch === '/') {
          state.tokenize = tokenBase;
          break;
        }
        maybeEnd = (ch === '*');
      }
      return ret('comment', 'comment');
    }

    function tokenSGMLComment (stream, state) {
      var dashes = 0;
      var ch;
      while ((ch = stream.next()) != null) {
        if (dashes >= 2 && ch === '>') {
          state.tokenize = tokenBase;
          break;
        }
        dashes = (ch === '-') ? dashes + 1 : 0;
      }
      return ret('comment', 'comment');
    }

    function tokenString (quote) {
      return function (stream, state) {
        var escaped = false;
        var ch;
        while ((ch = stream.next()) != null) {
          if (ch === quote && !escaped) {
            break;
          }
          escaped = !escaped && ch === '\\';
        }
        if (!escaped) state.tokenize = tokenBase;
        return ret('string', 'string');
      };
    }

    return {
      startState: function (base) {
        return {
          tokenize: tokenBase,
          baseIndent: base || 0,
          stack: []
        };
      },

      token: function (stream, state) {
        if (stream.eatSpace()) return null;
        var style = state.tokenize(stream, state);

        var context = state.stack[state.stack.length - 1];
        if (type === 'hash' && context === 'rule') style = 'atom';
        else if (style === 'variable') {
          if (context === 'rule') style = null; // 'tag'
          else if (!context || context === '@media{') {
            style = stream.current() === 'when' ? 'variable'
            : /[\s,|\s\)|\s]/.test(stream.peek()) ? 'tag' : type;
          }
        }

        if (context === 'rule' && /^[\{\};]$/.test(type)) {
          state.stack.pop();
        }
        if (type === '{') {
          if (context === '@media') state.stack[state.stack.length - 1] = '@media{';
          else state.stack.push('{');
        } else if (type === '}') state.stack.pop();
        else if (type === '@media') state.stack.push('@media');
        else if (context === '{' && type !== 'comment') state.stack.push('rule');
        return style;
      },

      indent: function (state, textAfter) {
        var n = state.stack.length;
        if (/^\}/.test(textAfter)) {
          n -= state.stack[state.stack.length - 1] === 'rule' ? 2 : 1;
        }
        return state.baseIndent + n * indentUnit;
      },

      electricChars: '}'
    };
  });

  CodeMirror.defineMIME('text/x-carto', 'cartocss');
};

},{"../../helpers/color-keywords":1089}],25:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<i class="CodeMirror-bullet"></i>';
}
return __p;
};

},{"underscore":"underscore"}],26:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="CodeMirror-error">\n  <li class="CodeMirror-errorMessage u-lSpace--xl u-rSpace--xl">\n    '+
((__t=( _t('components.codemirror.syntax-error') ))==null?'':_.escape(__t))+
'. '+
((__t=( _t('components.codemirror.line') ))==null?'':_.escape(__t))+
' '+
((__t=( line ))==null?'':_.escape(__t))+
': <span>'+
((__t=( message ))==null?'':_.escape(__t))+
'</span>\n  </li>\n</ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],27:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var CodeMirror = require('codemirror');
var ColorPicker = require('./colorpicker.code-mirror');
var template = require('./code-mirror.tpl');
var bulletTemplate = require('./code-mirror-bullet.tpl');
var errorTemplate = require('./code-mirror-error.tpl');

require('./mode/sql')(CodeMirror);
require('./mode/mustache')(CodeMirror);
require('./cartocss.code-mirror')(CodeMirror);
require('./scroll.code-mirror')(CodeMirror);
require('./show-hint.code-mirror')(CodeMirror);
require('./hint/custom-list-hint')(CodeMirror);
require('./searchcursor.code-mirror')(CodeMirror);
require('./placeholder.code-mirror')(CodeMirror);

var ESCAPE_KEY_CODE = 27;
var RETURN_KEY_CODE = 13;

var NOHINT = [ESCAPE_KEY_CODE, RETURN_KEY_CODE];

var ADDONS = {
  'color-picker': ColorPicker
};

module.exports = CoreView.extend({
  className: 'Editor-content',

  options: {
    readonly: false,
    lineNumbers: true,
    autocompleteChars: 3
  },

  initialize: function (opts) {
    if (!opts) throw new Error('options for codemirror are required.');
    if (!opts.model) throw new Error('Model for codemirror is required.');
    if (opts.model.get('content') === void 0 &&
        opts.placeholder === void 0) throw new Error('Content property or placeholder for codemirror is required.');
    if (opts.tip === void 0) throw new Error('tip message is required');

    this._autocompleteChars = opts.autocompleteChars || this.options.autocompleteChars;
    this._mode = opts.mode || 'cartocss';
    this._addons = opts.addons;
    this._hints = opts.hints;
    this._autocompletePrefix = opts.autocompletePrefix;
    this._autocompleteTriggers = opts.autocompleteTriggers;
    this._autocompleteSuffix = opts.autocompleteSuffix;
    this._errorTemplate = opts.errorTemplate || errorTemplate;
    this._tip = opts.tip;
    this._lineWithErrors = [];
    this._onInputRead = _.bind(this._onKeyUpEditor, this);
    this._placeholder = opts.placeholder;
  },

  render: function () {
    this.$el.html(
      template({
        content: this.model.get('content'),
        tip: this._tip
      })
    );

    this._initViews();
    this._bindEvents();
    this._showErrors();
    return this;
  },

  _initViews: function () {
    var options = _.defaults(_.extend({}, this.model.toJSON()), this.options);

    var isReadOnly = options.readonly;
    var hasLineNumbers = options.lineNumbers;

    var extraKeys = {
      'Ctrl-S': this.triggerApplyEvent.bind(this),
      'Cmd-S': this.triggerApplyEvent.bind(this),
      'Ctrl-Space': this._completeIfAfterCtrlSpace.bind(this)
    };

    this.editor = CodeMirror.fromTextArea(this.$('.js-editor').get(0), {
      lineNumbers: hasLineNumbers,
      theme: 'material',
      mode: this._mode,
      scrollbarStyle: 'simple',
      lineWrapping: true,
      readOnly: isReadOnly,
      extraKeys: extraKeys,
      placeholder: this._placeholder
    });
    this.editor.on('change', _.debounce(this._onCodeMirrorChange.bind(this), 150), this);

    if (!_.isEmpty(this._addons)) {
      _.each(this._addons, function (addon) {
        var Class = ADDONS[addon];
        var addonView = new Class({
          editor: this.editor
        });
        addonView.bind('codeSaved', this.triggerApplyEvent, this);
        this.$el.append(addonView.el);
        this.addView(addonView);
      }, this);
    }

    if (this._hints) {
      this.editor.on('keyup', this._onInputRead);
    }

    this._toggleReadOnly();

    setTimeout(function () {
      this.editor.refresh();
    }.bind(this), 0);
  },

  _completeIfAfterCtrlSpace: function (cm) {
    var autocompletePrefix = this._autocompletePrefix;
    var opts = {};
    var cur = cm.getCursor();

    if (autocompletePrefix &&
        cm.getRange(CodeMirror.Pos(cur.line, cur.ch - autocompletePrefix.length), cur) !== autocompletePrefix) {
      opts = { autocompletePrefix: autocompletePrefix };
    }

    return this._completeAfter(cm, opts);
  },

  updateHints: function (hints) {
    this._hints = hints;
  },

  _onKeyUpEditor: function (cm, event) {
    var code = event.keyCode;
    var hints = this._hints;
    var autocompleteChars = this._autocompleteChars - 1;
    var autocompletePrefix = this._autocompletePrefix;

    if (NOHINT.indexOf(code) === -1) {
      var self = this;

      if (this._autocompleteTimeout) clearTimeout(this._autocompleteTimeout);

      this._autocompleteTimeout = setTimeout(function () {
        var opts = {};
        var cur = cm.getCursor();
        var str = cm.getTokenAt(cur).string;
        str = str.toLowerCase();

        if (autocompletePrefix &&
            cm.getRange(CodeMirror.Pos(cur.line, cur.ch - autocompletePrefix.length), cur) !== autocompletePrefix) {
          opts = { autocompletePrefix: autocompletePrefix };
        }

        return self._completeAfter(cm, opts, function () {
          var autocompleteHandler = function (listItem) {
            // every list can be an array of strings or an array of objects {text, type}
            var hit = _.isObject(listItem) ? listItem.text : listItem;
            hit = hit.toLowerCase();
            return hit.indexOf(str) !== -1;
          };

          if (str.length > autocompleteChars) {
            var listHints = _.filter(hints, autocompleteHandler);

            return listHints.length > 0 || autocompletePrefix && autocompletePrefix === str;
          }
        });
      }, 150);
    }
  },

  _onCodeMirrorChange: function () {
    this.trigger('codeChanged');
  },

  _completeAfter: function (cm, opts, pred) {
    if (!pred || pred()) {
      if (!cm.state.completionActive) {
        this._showAutocomplete(cm, _.extend({}, opts));
      }
    }

    return CodeMirror.Pass;
  },

  _showAutocomplete: function (cm, opts) {
    var autocompletePrefix = opts && opts.autocompletePrefix;

    CodeMirror.showHint(cm, CodeMirror.hint['custom-list'], {
      completeSingle: false,
      list: this._hints,
      autocompletePrefix: autocompletePrefix,
      autocompleteSuffix: this._autocompleteSuffix
    });
  },

  _bindEvents: function () {
    var self = this;
    this.editor.on('change', function (editor, changed) {
      self.model.set('content', self.getContent(), {silent: true});
    });

    this.model.on('change:content', function () {
      this.setContent(this.model.get('content'));
    }, this);

    this.model.on('change:readonly', this._toggleReadOnly, this);

    this.model.on('change:errors', function () {
      this._showErrors();
    }, this);

    this.model.on('undo redo', function () {
      this.setContent(this.model.get('content'));
    }, this);
  },

  _toggleReadOnly: function () {
    var isReadOnly = !!this.model.get('readonly');
    this.editor.setOption('readOnly', isReadOnly);
    if (isReadOnly) {
      this.editor.setOption('theme', '');
      this._getInfo().hide();
    } else {
      this.editor.setOption('theme', 'material');
      this._getInfo().show();
    }
  },

  search: function (query, caseInsensitive) {
    var cursor = this.editor.getSearchCursor(query, null, true);
    cursor.find();
    return cursor.pos;
  },

  markReadOnly: function (from, to) {
    var options = {readOnly: true, inclusiveLeft: true};
    this.editor.markText(from, to, options);

    for (var i = from.line; i <= to.line; i++) {
      this.editor.addLineClass(i, 'background', 'CodeMirror-readonlyLine');
    }
  },

  setContent: function (value) {
    this.editor.setValue(value);
  },

  getContent: function () {
    return this.editor.getValue();
  },

  triggerApplyEvent: function () {
    this.trigger('codeSaved', this.getContent(), this);
  },

  destroyEditor: function () {
    this.editor.off('change');
    var el = this.editor.getWrapperElement();
    el.parentNode.removeChild(el);
  },

  _getInfo: function () {
    return this.$('.js-console');
  },

  _getConsole: function () {
    return this.$('.js-console-error');
  },

  _getCode: function () {
    return this.$('.CodeMirror-code');
  },

  _removeErrors: function () {
    this._getConsole().empty();
    _.each(this._lineWithErrors, function ($line) {
      $line.find('.CodeMirror-bullet').remove();
      $line.find('.CodeMirror-linenumber').removeClass('has-error');
    });

    this._lineWithErrors = [];
  },

  _showErrors: function () {
    var errors = this.model.get('errors');
    this._removeErrors();

    if (errors && errors.length > 0) {
      _.each(errors, function (err) {
        this._renderError(err);
        this._renderBullet(err);
      }, this);
    }
  },

  _renderBullet: function (error) {
    var line = error.line;
    var $line;
    if (line) {
      $line = this._getCode().children().eq(+line - 1);
      $line.append(bulletTemplate);
      $line.find('.CodeMirror-linenumber').addClass('has-error');
      this._lineWithErrors.push($line);
    }
  },

  _renderError: function (error) {
    this._getConsole().append(this._errorTemplate(error));
  },

  clean: function () {
    this.destroyEditor();
    CoreView.prototype.clean.apply(this);
  }
});

},{"./cartocss.code-mirror":24,"./code-mirror-bullet.tpl":25,"./code-mirror-error.tpl":26,"./code-mirror.tpl":28,"./colorpicker.code-mirror":29,"./hint/custom-list-hint":30,"./mode/mustache":31,"./mode/sql":32,"./placeholder.code-mirror":33,"./scroll.code-mirror":34,"./searchcursor.code-mirror":35,"./show-hint.code-mirror":36,"backbone/core-view":1127,"codemirror":"codemirror","underscore":"underscore"}],28:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CodeMirror-editor">\n  <textarea class="js-editor">'+
((__t=( content ))==null?'':_.escape(__t))+
'</textarea>\n</div>\n\n';
 if (tip) { 
__p+='\n<div class="CodeMirror-console js-console">\n  '+
((__t=( tip ))==null?'':_.escape(__t))+
'\n  <div class="js-console-error"></div>\n</div>\n';
 } 
__p+='';
}
return __p;
};

},{"underscore":"underscore"}],29:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var $ = require('jquery');
var _ = require('underscore');
var ColorPicker = require('../form-components/editors/fill/color-picker/color-picker.js');
var COLOR_KEYWORDS = require('../../helpers/color-keywords');

/**
 *  Show color picker when user clicks over
 *  a color in the Codemirror editor.
 *
 *  new CodemirrorColorPicker({
 *    editor: codemirror-editor...
 *  })
 */

var REQUIRED_OPTS = [
  'editor'
];

var STYLE = _.template('1px solid  <%- color %>');
var COLORPICKER_HEIGHT = 220;

var stopPropagation = function (e) {
  e.stopPropagation();
};

module.exports = CoreView.extend({
  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this._updateColors = _.debounce(this._updateColors, 5).bind(this);
    this._onDocumentClick = this._onDocumentClick.bind(this);
    this._editor = opts.editor;
    this._initBinds();
  },

  _initBinds: function () {
    var self = this;
    var destroyPicker = function () {
      this._destroyPicker();
    }.bind(this);

    this._enableUpdateBind();

    this._editor.on('mousedown', function (cm, ev) {
      _.delay(self._onClick.bind(self, cm, ev), 50);
    });

    this._editor.on('keydown', destroyPicker);
    this._editor.on('viewportChange', destroyPicker);
    this._editor.on('scroll', destroyPicker);

    var wrapper = this._editor.getWrapperElement();
    wrapper.addEventListener('click', stopPropagation);
  },

  _disableBinds: function () {
    var wrapper = this._editor.getWrapperElement();
    wrapper.removeEventListener('click', stopPropagation);
    this._editor.off(null, null, this);
  },

  _enableUpdateBind: function () {
    this._editor.on('update', this._updateColors);
  },

  _disableUpdateBind: function () {
    this._editor.off('update', this._updateColors);
  },

  _onClick: function (cm, ev) {
    var cursor = this._editor.getCursor(true);
    var token = this._editor.getTokenAt(cursor);

    if (token.type === 'color') {
      this._createPicker(ev, cursor, token);
    } else {
      this._destroyPicker();
    }
  },

  _updateColors: function (cm) {
    var wrapper = cm.getWrapperElement();
    _.each(wrapper.querySelectorAll('.cm-color'), function (node) {
      this._paintColor(node.textContent, node);
    }, this);
  },

  _replaceColor: function (color, target) {
    var cursor = this._editor.getCursor();
    var nameMatch = this._getMatch(cursor, 'name');
    var hexMatch = this._getMatch(cursor, 'hex');
    var match = nameMatch || hexMatch;
    var start;
    var end;

    if (match) {
      start = {
        line: cursor.line,
        ch: match.start
      };
      end = {
        line: cursor.line,
        ch: match.end
      };

      this._editor.replaceRange(color, start, end, 'paste');

      var wrapper = this._editor.getWrapperElement();
      _.each(wrapper.querySelectorAll('.cm-color'), function (node) {
        var nodeStyle = node.style;
        var nodeColor = node.innerText;
        if (!nodeStyle || !nodeStyle.borderBottom) {
          this._paintColor(nodeColor, node);
        }
      }, this);
    }
  },

  _paintColor: function (color, target) {
    target.style.borderBottom = STYLE({color: color});
  },

  _getMatch: function (cursor, type) {
    if (!type) return;
    var re;

    switch (type.toLowerCase()) {
      case 'name':
        re = new RegExp(COLOR_KEYWORDS.join('|'), 'g');
        break;
      case 'hsl':
        re = /hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)/g;
        break;
      case 'rgb':
        re = /rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)/;
        break;
      case 'hex':
        re = /#[a-fA-F0-9]{3,6}/g;
        break;
      default:
        console.log('Invalid color match selection');
        return;
    }

    var line = this._editor.getLine(cursor.line);
    var match = re.exec(line);

    while (match) {
      var val = match[0];
      var len = val.length;
      var start = match.index;
      var end = match.index + len;
      if (cursor.ch >= start && cursor.ch <= end) {
        match = null;
        return {
          start: start,
          end: end,
          string: val
        };
      }
      match = re.exec(line);
    }
    return;
  },

  _createPicker: function (ev, cursor, token) {
    var cursorCoords = this._editor.cursorCoords();
    this._destroyPicker();

    this._colorPicker = new ColorPicker({
      className: 'Editor-boxModal ColorPicker--cm Editor-boxModal--darked Editor-FormDialog CDB-Text',
      value: token.string,
      disableOpacity: true
    });
    this._colorPicker.$el.attr('data-colorpicker-cid', this.cid);
    this._colorPicker.bind('change', _.debounce(this._onColorPickerChange.bind(this, ev), 5), this);

    var top = cursorCoords.top + 20;
    var maxTop = $(window).outerHeight();

    if (top + COLORPICKER_HEIGHT > maxTop) {
      top = cursorCoords.top - COLORPICKER_HEIGHT - 20;
    }

    this._colorPicker.$el.css({
      left: cursorCoords.left,
      top: top
    });

    document.body.appendChild(this._colorPicker.render().el);
    document.addEventListener('click', this._onDocumentClick);
  },

  _onDocumentClick: function (e) {
    var $el = $(e.target);
    if ($el.closest('[data-colorpicker-cid="' + this.cid + '"]').length === 0) {
      this._destroyPicker();
    }
  },

  _onColorPickerChange: function (ev, values) {
    this._disableUpdateBind();
    this._replaceColor(values.hex, ev.target);
    this.trigger('codeSaved');
    this._enableUpdateBind();
  },

  _destroyPicker: function () {
    if (this._colorPicker) {
      this.removeView(this._colorPicker);
      this._colorPicker.clean();
      delete this._colorPicker;
    }

    document.removeEventListener('click', this._onDocumentClick);
  },

  clean: function () {
    this._disableBinds();
    CoreView.prototype.clean.call(this);
  }
});

},{"../../helpers/color-keywords":1089,"../form-components/editors/fill/color-picker/color-picker.js":99,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],30:[function(require,module,exports){
var _ = require('underscore');

module.exports = function (CodeMirror) {
  var Pos = CodeMirror.Pos;

  function arrayContains (arr, item) {
    return arr.indexOf(item) !== -1;
  }

  function scriptHint (editor, keywords, getToken, options) {
    // Find the token at the cursor
    var cur = editor.getCursor();
    var token = getToken(editor, cur);
    var tprop = token;
    token.state = CodeMirror.innerMode(editor.getMode(), token.state).state;

    // If it's not a 'word-style' token, ignore the token.
    if (!/^[\w$_-]*$/.test(token.string)) {
      token = tprop = {
        start: cur.ch,
        end: cur.ch,
        string: '',
        state: token.state,
        type: token.string === '.' ? 'property' : null
      };
    }
    // If it is a property, find out what it is a property of.
    while (tprop.type === 'property') {
      tprop = getToken(editor, Pos(cur.line, tprop.start));
      if (tprop.string !== '.') return;
      tprop = getToken(editor, Pos(cur.line, tprop.start));
      if (tprop.string === ')') {
        var level = 1;
        do {
          tprop = getToken(editor, Pos(cur.line, tprop.start));
          switch (tprop.string) {
            case ')':
              level++;
              break;
            case '(':
              level--;
              break;
            default:
              break;
          }
        } while (level > 0);
        tprop = getToken(editor, Pos(cur.line, tprop.start));
        if (tprop.type.indexOf('variable') === 0) tprop.type = 'function';
        else return; // no clue
      }
      if (!context) var context = [];
      context.push(tprop);
    }

    return {
      list: getCompletions(token, context, keywords, options),
      from: Pos(cur.line, token.start),
      to: Pos(cur.line, token.end)
    };
  }

  function columnsHint (editor, options) {
    return scriptHint(editor, [], /* javascriptKeywords */
      function (e, cur) {
        return e.getTokenAt(cur);
      },
    options);
  }

  CodeMirror.registerHelper('hint', 'custom-list', columnsHint);

  function getCompletions (token, context, keywords, options) {
    var found = [];
    var start = token.string.toLowerCase();

    function maybeAdd (str) {
      var hit = _.isObject(str) ? str.text : str;
      hit = hit.toLowerCase();
      if (hit.indexOf(start) === 0 && start !== hit && !arrayContains(found, hit)) {
        found.push(str);
      }
    }

    function gatherCompletions (obj) {
      for (var name in obj) {
        maybeAdd(obj[name]);
      }
    }

    gatherCompletions(options.list);
    _.each(keywords, maybeAdd);

    return found;
  }
};

},{"underscore":"underscore"}],31:[function(require,module,exports){
module.exports = function (CodeMirror) {
  CodeMirror.defineMode('mustache', function () {
    return {
      token: function (stream, state) {
        var ch;

        if (stream.match('{{')) {
          ch = stream.peek();
          if (ch == null || ch != null && ch.match(/[{]{1,}/)) {
            stream.next();
            return 'mustache-error';
          } else if (ch != null && ch.match(/[a-zA-Z\u00C0-\u024F_]+/)) {
            return null;
          }
        }

        if (stream.match('}}')) {
          ch = stream.peek();
          if (ch != null && ch.match(/[}]{1,}/)) {
            stream.next();
            return 'mustache-error';
          } else if (ch == null) {
            return null;
          }
        }

        if (stream.match('}')) {
          ch = stream.peek();
          if (ch == null || ch != null && ch.match(/[}]{1,}/)) {
            stream.next();
            return 'mustache-error';
          }
        }

        if (stream.match('{')) {
          ch = stream.peek();
          if (ch == null || ch != null && ch.match(/[{]{1,}/)) {
            stream.next();
            return 'mustache-error';
          }
        }

        // Delimiter character
        if (stream.match(/[a-zA-Z\u00C0-\u024F_]+/, true)) {
          return 'mustache-text';
        }

        // jump to the next item, needed OR CRASH
        stream.next();
      }
    };
  });

  (function () {
    var sqlKeywords = '{{  }}';

    function set (str) {
      var obj = {};
      var words = str.split(' ');
      for (var i = 0; i < words.length; ++i) obj[words[i]] = true;
      return obj;
    }

    CodeMirror.defineMIME('text/mustache', {
      name: 'mustache',
      client: set('source'),
      keywords: set(sqlKeywords)
    });
  }());
};

},{}],32:[function(require,module,exports){
// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

/* eslint-disable */
module.exports = function(CodeMirror) {
"use strict";

CodeMirror.defineMode("sql", function(config, parserConfig) {
  "use strict";

  var client         = parserConfig.client || {},
      atoms          = parserConfig.atoms || {"false": true, "true": true, "null": true},
      builtin        = parserConfig.builtin || {},
      keywords       = parserConfig.keywords || {},
      operatorChars  = parserConfig.operatorChars || /^[*+\-%<>!=&|~^]/,
      support        = parserConfig.support || {},
      hooks          = parserConfig.hooks || {},
      dateSQL        = parserConfig.dateSQL || {"date" : true, "time" : true, "timestamp" : true};

  function tokenBase(stream, state) {
    var ch = stream.next();

    // call hooks from the mime type
    if (hooks[ch]) {
      var result = hooks[ch](stream, state);
      if (result !== false) return result;
    }

    if (support.hexNumber == true &&
      ((ch == "0" && stream.match(/^[xX][0-9a-fA-F]+/))
      || (ch == "x" || ch == "X") && stream.match(/^'[0-9a-fA-F]+'/))) {
      // hex
      // ref: http://dev.mysql.com/doc/refman/5.5/en/hexadecimal-literals.html
      return "number";
    } else if (support.binaryNumber == true &&
      (((ch == "b" || ch == "B") && stream.match(/^'[01]+'/))
      || (ch == "0" && stream.match(/^b[01]+/)))) {
      // bitstring
      // ref: http://dev.mysql.com/doc/refman/5.5/en/bit-field-literals.html
      return "number";
    } else if (ch.charCodeAt(0) > 47 && ch.charCodeAt(0) < 58) {
      // numbers
      // ref: http://dev.mysql.com/doc/refman/5.5/en/number-literals.html
          stream.match(/^[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?/);
      support.decimallessFloat == true && stream.eat('.');
      return "number";
    } else if (ch == "?" && (stream.eatSpace() || stream.eol() || stream.eat(";"))) {
      // placeholders
      return "variable-3";
    } else if (ch == "'" || (ch == '"' && support.doubleQuote)) {
      // strings
      // ref: http://dev.mysql.com/doc/refman/5.5/en/string-literals.html
      state.tokenize = tokenLiteral(ch);
      return state.tokenize(stream, state);
    } else if ((((support.nCharCast == true && (ch == "n" || ch == "N"))
        || (support.charsetCast == true && ch == "_" && stream.match(/[a-z][a-z0-9]*/i)))
        && (stream.peek() == "'" || stream.peek() == '"'))) {
      // charset casting: _utf8'str', N'str', n'str'
      // ref: http://dev.mysql.com/doc/refman/5.5/en/string-literals.html
      return "keyword";
    } else if (/^[\(\),\;\[\]]/.test(ch)) {
      // no highlighting
      return null;
    } else if (support.commentSlashSlash && ch == "/" && stream.eat("/")) {
      // 1-line comment
      stream.skipToEnd();
      return "comment";
    } else if ((support.commentHash && ch == "#")
        || (ch == "-" && stream.eat("-") && (!support.commentSpaceRequired || stream.eat(" ")))) {
      // 1-line comments
      // ref: https://kb.askmonty.org/en/comment-syntax/
      stream.skipToEnd();
      return "comment";
    } else if (ch == "/" && stream.eat("*")) {
      // multi-line comments
      // ref: https://kb.askmonty.org/en/comment-syntax/
      state.tokenize = tokenComment;
      return state.tokenize(stream, state);
    } else if (ch == ".") {
      // .1 for 0.1
      if (support.zerolessFloat == true && stream.match(/^(?:\d+(?:e[+-]?\d+)?)/i)) {
        return "number";
      }
      // .table_name (ODBC)
      // // ref: http://dev.mysql.com/doc/refman/5.6/en/identifier-qualifiers.html
      if (support.ODBCdotTable == true && stream.match(/^[a-zA-Z_]+/)) {
        return "variable-2";
      }
    } else if (operatorChars.test(ch)) {
      // operators
      stream.eatWhile(operatorChars);
      return null;
    } else if (ch == '{' &&
        (stream.match(/^( )*(d|D|t|T|ts|TS)( )*'[^']*'( )*}/) || stream.match(/^( )*(d|D|t|T|ts|TS)( )*"[^"]*"( )*}/))) {
      // dates (weird ODBC syntax)
      // ref: http://dev.mysql.com/doc/refman/5.5/en/date-and-time-literals.html
      return "number";
    } else {
      stream.eatWhile(/^[_\w\d]/);
      var word = stream.current().toLowerCase();
      // dates (standard SQL syntax)
      // ref: http://dev.mysql.com/doc/refman/5.5/en/date-and-time-literals.html
      if (dateSQL.hasOwnProperty(word) && (stream.match(/^( )+'[^']*'/) || stream.match(/^( )+"[^"]*"/)))
        return "number";
      if (atoms.hasOwnProperty(word)) return "atom";
      if (builtin.hasOwnProperty(word)) return "builtin";
      if (keywords.hasOwnProperty(word)) return "keyword";
      if (client.hasOwnProperty(word)) return "string-2";
      return null;
    }
  }

  // 'string', with char specified in quote escaped by '\'
  function tokenLiteral(quote) {
    return function(stream, state) {
      var escaped = false, ch;
      while ((ch = stream.next()) != null) {
        if (ch == quote && !escaped) {
          state.tokenize = tokenBase;
          break;
        }
        escaped = !escaped && ch == "\\";
      }
      return "string";
    };
  }
  function tokenComment(stream, state) {
    while (true) {
      if (stream.skipTo("*")) {
        stream.next();
        if (stream.eat("/")) {
          state.tokenize = tokenBase;
          break;
        }
      } else {
        stream.skipToEnd();
        break;
      }
    }
    return "comment";
  }

  function pushContext(stream, state, type) {
    state.context = {
      prev: state.context,
      indent: stream.indentation(),
      col: stream.column(),
      type: type
    };
  }

  function popContext(state) {
    state.indent = state.context.indent;
    state.context = state.context.prev;
  }

  return {
    startState: function() {
      return {tokenize: tokenBase, context: null};
    },

    token: function(stream, state) {
      if (stream.sol()) {
        if (state.context && state.context.align == null)
          state.context.align = false;
      }
      if (stream.eatSpace()) return null;

      var style = state.tokenize(stream, state);
      if (style == "comment") return style;

      if (state.context && state.context.align == null)
        state.context.align = true;

      var tok = stream.current();
      if (tok == "(")
        pushContext(stream, state, ")");
      else if (tok == "[")
        pushContext(stream, state, "]");
      else if (state.context && state.context.type == tok)
        popContext(state);
      return style;
    },

    indent: function(state, textAfter) {
      var cx = state.context;
      if (!cx) return CodeMirror.Pass;
      var closing = textAfter.charAt(0) == cx.type;
      if (cx.align) return cx.col + (closing ? 0 : 1);
      else return cx.indent + (closing ? 0 : config.indentUnit);
    },

    blockCommentStart: "/*",
    blockCommentEnd: "*/",
    lineComment: support.commentSlashSlash ? "//" : support.commentHash ? "#" : null
  };
});

(function() {
  "use strict";

  // `identifier`
  function hookIdentifier(stream) {
    // MySQL/MariaDB identifiers
    // ref: http://dev.mysql.com/doc/refman/5.6/en/identifier-qualifiers.html
    var ch;
    while ((ch = stream.next()) != null) {
      if (ch == "`" && !stream.eat("`")) return "variable-2";
    }
    stream.backUp(stream.current().length - 1);
    return stream.eatWhile(/\w/) ? "variable-2" : null;
  }

  // variable token
  function hookVar(stream) {
    // variables
    // @@prefix.varName @varName
    // varName can be quoted with ` or ' or "
    // ref: http://dev.mysql.com/doc/refman/5.5/en/user-variables.html
    if (stream.eat("@")) {
      stream.match(/^session\./);
      stream.match(/^local\./);
      stream.match(/^global\./);
    }

    if (stream.eat("'")) {
      stream.match(/^.*'/);
      return "variable-2";
    } else if (stream.eat('"')) {
      stream.match(/^.*"/);
      return "variable-2";
    } else if (stream.eat("`")) {
      stream.match(/^.*`/);
      return "variable-2";
    } else if (stream.match(/^[0-9a-zA-Z$\.\_]+/)) {
      return "variable-2";
    }
    return null;
  };

  // short client keyword token
  function hookClient(stream) {
    // \N means NULL
    // ref: http://dev.mysql.com/doc/refman/5.5/en/null-values.html
    if (stream.eat("N")) {
        return "atom";
    }
    // \g, etc
    // ref: http://dev.mysql.com/doc/refman/5.5/en/mysql-commands.html
    return stream.match(/^[a-zA-Z.#!?]/) ? "variable-2" : null;
  }

  // these keywords are used by all SQL dialects (however, a mode can still overwrite it)
  var sqlKeywords = "alter and as asc between by count create delete desc distinct drop from group having in insert into is join like not on or order select set table union update values where limit ";

  // turn a space-separated list into an array
  function set(str) {
    var obj = {}, words = str.split(" ");
    for (var i = 0; i < words.length; ++i) obj[words[i]] = true;
    return obj;
  }

  CodeMirror.defineMIME("text/x-pgsql", {
    name: "sql",
    client: set("source"),
    // http://www.postgresql.org/docs/9.5/static/sql-keywords-appendix.html
    keywords: set(sqlKeywords + "a abort abs absent absolute access according action ada add admin after aggregate all allocate also always analyse analyze any are array array_agg array_max_cardinality asensitive assertion assignment asymmetric at atomic attribute attributes authorization avg backward base64 before begin begin_frame begin_partition bernoulli binary bit_length blob blocked bom both breadth c cache call called cardinality cascade cascaded case cast catalog catalog_name ceil ceiling chain characteristics characters character_length character_set_catalog character_set_name character_set_schema char_length check checkpoint class class_origin clob close cluster coalesce cobol collate collation collation_catalog collation_name collation_schema collect column columns column_name command_function command_function_code comment comments commit committed concurrently condition condition_number configuration conflict connect connection connection_name constraint constraints constraint_catalog constraint_name constraint_schema constructor contains content continue control conversion convert copy corr corresponding cost covar_pop covar_samp cross csv cube cume_dist current current_catalog current_date current_default_transform_group current_path current_role current_row current_schema current_time current_timestamp current_transform_group_for_type current_user cursor cursor_name cycle data database datalink datetime_interval_code datetime_interval_precision day db deallocate dec declare default defaults deferrable deferred defined definer degree delimiter delimiters dense_rank depth deref derived describe descriptor deterministic diagnostics dictionary disable discard disconnect dispatch dlnewcopy dlpreviouscopy dlurlcomplete dlurlcompleteonly dlurlcompletewrite dlurlpath dlurlpathonly dlurlpathwrite dlurlscheme dlurlserver dlvalue do document domain dynamic dynamic_function dynamic_function_code each element else empty enable encoding encrypted end end-exec end_frame end_partition enforced enum equals escape event every except exception exclude excluding exclusive exec execute exists exp explain expression extension external extract false family fetch file filter final first first_value flag float floor following for force foreign fortran forward found frame_row free freeze fs full function functions fusion g general generated get global go goto grant granted greatest grouping groups handler header hex hierarchy hold hour id identity if ignore ilike immediate immediately immutable implementation implicit import including increment indent index indexes indicator inherit inherits initially inline inner inout input insensitive instance instantiable instead integrity intersect intersection invoker isnull isolation k key key_member key_type label lag language large last last_value lateral lead leading leakproof least left length level library like_regex link listen ln load local localtime localtimestamp location locator lock locked logged lower m map mapping match matched materialized max maxvalue max_cardinality member merge message_length message_octet_length message_text method min minute minvalue mod mode modifies module month more move multiset mumps name names namespace national natural nchar nclob nesting new next nfc nfd nfkc nfkd nil no none normalize normalized nothing notify notnull nowait nth_value ntile null nullable nullif nulls number object occurrences_regex octets octet_length of off offset oids old only open operator option options ordering ordinality others out outer output over overlaps overlay overriding owned owner p pad parameter parameter_mode parameter_name parameter_ordinal_position parameter_specific_catalog parameter_specific_name parameter_specific_schema parser partial partition pascal passing passthrough password percent percentile_cont percentile_disc percent_rank period permission placing plans pli policy portion position position_regex power precedes preceding prepare prepared preserve primary prior privileges procedural procedure program public quote range rank read reads reassign recheck recovery recursive ref references referencing refresh regr_avgx regr_avgy regr_count regr_intercept regr_r2 regr_slope regr_sxx regr_sxy regr_syy reindex relative release rename repeatable replace replica requiring reset respect restart restore restrict result return returned_cardinality returned_length returned_octet_length returned_sqlstate returning returns revoke right role rollback rollup routine routine_catalog routine_name routine_schema row rows row_count row_number rule savepoint scale schema schema_name scope scope_catalog scope_name scope_schema scroll search second section security selective self sensitive sequence sequences serializable server server_name session session_user setof sets share show similar simple size skip snapshot some source space specific specifictype specific_name sql sqlcode sqlerror sqlexception sqlstate sqlwarning sqrt stable standalone start state statement static statistics stddev_pop stddev_samp stdin stdout storage strict strip structure style subclass_origin submultiset substring substring_regex succeeds sum symmetric sysid system system_time system_user t tables tablesample tablespace table_name temp template temporary then ties timezone_hour timezone_minute to token top_level_count trailing transaction transactions_committed transactions_rolled_back transaction_active transform transforms translate translate_regex translation treat trigger trigger_catalog trigger_name trigger_schema trim trim_array true truncate trusted type types uescape unbounded uncommitted under unencrypted unique unknown unlink unlisten unlogged unnamed unnest until untyped upper uri usage user user_defined_type_catalog user_defined_type_code user_defined_type_name user_defined_type_schema using vacuum valid validate validator value value_of varbinary variadic var_pop var_samp verbose version versioning view views volatile when whenever whitespace width_bucket window within work wrapper write xmlagg xmlattributes xmlbinary xmlcast xmlcomment xmlconcat xmldeclaration xmldocument xmlelement xmlexists xmlforest xmliterate xmlnamespaces xmlparse xmlpi xmlquery xmlroot xmlschema xmlserialize xmltable xmltext xmlvalidate year yes loop repeat"),
    // http://www.postgresql.org/docs/9.5/static/datatype.html
    builtin: set("bigint int8 bigserial serial8 bit varying varbit boolean bool box bytea character char varchar cidr circle date double precision float8 inet integer int int4 interval json jsonb line lseg macaddr money numeric decimal path pg_lsn point polygon real float4 smallint int2 smallserial serial2 serial serial4 text time without zone with timetz timestamp timestamptz tsquery tsvector txid_snapshot uuid xml"),
    atoms: set("false true null unknown"),
    operatorChars: /^[*+\-%<>!=&|^]/,
    dateSQL: set("date time timestamp"),
    support: set("ODBCdotTable decimallessFloat zerolessFloat binaryNumber hexNumber nCharCast charsetCast commentHash commentSpaceRequired")
  });
}());

};

/* eslint-enable */

},{}],33:[function(require,module,exports){
// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

/* eslint-disable */
module.exports = function (CodeMirror) {
  CodeMirror.defineOption("placeholder", "", function(cm, val, old) {
    var prev = old && old != CodeMirror.Init;
    if (val && !prev) {
      cm.on("blur", onBlur);
      cm.on("change", onChange);
      cm.on("swapDoc", onChange);
      onChange(cm);
    } else if (!val && prev) {
      cm.off("blur", onBlur);
      cm.off("change", onChange);
      cm.off("swapDoc", onChange);
      clearPlaceholder(cm);
      var wrapper = cm.getWrapperElement();
      wrapper.className = wrapper.className.replace(" CodeMirror-empty", "");
    }

    if (val && !cm.hasFocus()) onBlur(cm);
  });

  function clearPlaceholder(cm) {
    if (cm.state.placeholder) {
      cm.state.placeholder.parentNode.removeChild(cm.state.placeholder);
      cm.state.placeholder = null;
    }
  }
  function setPlaceholder(cm) {
    clearPlaceholder(cm);
    var elt = cm.state.placeholder = document.createElement("pre");
    elt.style.cssText = "height: 0; overflow: visible";
    elt.className = "CodeMirror-placeholder";
    var placeHolder = cm.getOption("placeholder")
    if (typeof placeHolder == "string") placeHolder = document.createTextNode(placeHolder)
    elt.appendChild(placeHolder)
    cm.display.lineSpace.insertBefore(elt, cm.display.lineSpace.firstChild);
  }

  function onBlur(cm) {
    if (isEmpty(cm)) setPlaceholder(cm);
  }
  function onChange(cm) {
    var wrapper = cm.getWrapperElement(), empty = isEmpty(cm);
    wrapper.className = wrapper.className.replace(" CodeMirror-empty", "") + (empty ? " CodeMirror-empty" : "");

    if (empty) setPlaceholder(cm);
    else clearPlaceholder(cm);
  }

  function isEmpty(cm) {
    return (cm.lineCount() === 1) && (cm.getLine(0) === "");
  }
};
/* eslint-enable */

},{}],34:[function(require,module,exports){
// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

module.exports = function (CodeMirror) {
  function Bar (cls, orientation, scroll) {
    this.orientation = orientation;
    this.scroll = scroll;
    this.screen = this.total = this.size = 1;
    this.pos = 0;

    this.node = document.createElement('div');
    this.node.className = cls + '-' + orientation;
    this.inner = this.node.appendChild(document.createElement('div'));

    var self = this;
    CodeMirror.on(this.inner, 'mousedown', function (e) {
      if (e.which !== 1) return;
      CodeMirror.e_preventDefault(e);
      var axis = self.orientation === 'horizontal' ? 'pageX' : 'pageY';
      var start = e[axis];
      var startpos = self.pos;
      function done () {
        CodeMirror.off(document, 'mousemove', move);
        CodeMirror.off(document, 'mouseup', done);
      }
      function move (e) {
        if (e.which !== 1) return done();
        self.moveTo(startpos + (e[axis] - start) * (self.total / self.size));
      }
      CodeMirror.on(document, 'mousemove', move);
      CodeMirror.on(document, 'mouseup', done);
    });

    CodeMirror.on(this.node, 'click', function (e) {
      CodeMirror.e_preventDefault(e);
      var innerBox = self.inner.getBoundingClientRect();
      var where;
      if (self.orientation === 'horizontal') {
        where = e.clientX < innerBox.left ? -1 : e.clientX > innerBox.right ? 1 : 0;
      } else {
        where = e.clientY < innerBox.top ? -1 : e.clientY > innerBox.bottom ? 1 : 0;
      }
      self.moveTo(self.pos + where * self.screen);
    });

    function onWheel (e) {
      var moved = CodeMirror.wheelEventPixels(e)[self.orientation === 'horizontal' ? 'x' : 'y'];
      var oldPos = self.pos;
      self.moveTo(self.pos + moved);
      if (self.pos !== oldPos) {
        CodeMirror.e_preventDefault(e);
      }
    }
    CodeMirror.on(this.node, 'mousewheel', onWheel);
    CodeMirror.on(this.node, 'DOMMouseScroll', onWheel);
  }

  Bar.prototype.setPos = function (pos, force) {
    if (pos < 0) pos = 0;
    if (pos > this.total - this.screen) pos = this.total - this.screen;
    if (!force && pos === this.pos) return false;
    this.pos = pos;
    this.inner.style[this.orientation === 'horizontal' ? 'left' : 'top'] =
      (pos * (this.size / this.total)) + 'px';
    return true;
  };

  Bar.prototype.moveTo = function (pos) {
    if (this.setPos(pos)) this.scroll(pos, this.orientation);
  };

  var minButtonSize = 10;

  Bar.prototype.update = function (scrollSize, clientSize, barSize) {
    var sizeChanged = this.screen !== clientSize || this.total !== scrollSize || this.size !== barSize;
    if (sizeChanged) {
      this.screen = clientSize;
      this.total = scrollSize;
      this.size = barSize;
    }

    var buttonSize = this.screen * (this.size / this.total);
    if (buttonSize < minButtonSize) {
      this.size -= minButtonSize - buttonSize;
      buttonSize = minButtonSize;
    }
    this.inner.style[this.orientation === 'horizontal' ? 'width' : 'height'] =
      buttonSize + 'px';
    this.setPos(this.pos, sizeChanged);
  };

  function SimpleScrollbars (cls, place, scroll) {
    this.addClass = cls;
    this.horiz = new Bar(cls, 'horizontal', scroll);
    place(this.horiz.node);
    this.vert = new Bar(cls, 'vertical', scroll);
    place(this.vert.node);
    this.width = null;
  }

  SimpleScrollbars.prototype.update = function (measure) {
    if (this.width == null) {
      var style = window.getComputedStyle ? window.getComputedStyle(this.horiz.node) : this.horiz.node.currentStyle;
      if (style) {
        this.width = parseInt(style.height, 10);
      }
    }
    var width = this.width || 0;

    var needsH = measure.scrollWidth > measure.clientWidth + 1;
    var needsV = measure.scrollHeight > measure.clientHeight + 1;
    this.vert.node.style.display = needsV ? 'block' : 'none';
    this.horiz.node.style.display = needsH ? 'block' : 'none';

    if (needsV) {
      this.vert.update(measure.scrollHeight, measure.clientHeight,
        measure.viewHeight - (needsH ? width : 0));
      this.vert.node.style.bottom = needsH ? width + 'px' : '0';
    }
    if (needsH) {
      this.horiz.update(measure.scrollWidth, measure.clientWidth,
        measure.viewWidth - (needsV ? width : 0) - measure.barLeft);
      this.horiz.node.style.right = needsV ? width + 'px' : '0';
      this.horiz.node.style.left = measure.barLeft + 'px';
    }

    return {right: needsV ? width : 0, bottom: needsH ? width : 0};
  };

  SimpleScrollbars.prototype.setScrollTop = function (pos) {
    this.vert.setPos(pos);
  };

  SimpleScrollbars.prototype.setScrollLeft = function (pos) {
    this.horiz.setPos(pos);
  };

  SimpleScrollbars.prototype.clear = function () {
    var parent = this.horiz.node.parentNode;
    parent.removeChild(this.horiz.node);
    parent.removeChild(this.vert.node);
  };

  CodeMirror.scrollbarModel.simple = function (place, scroll) {
    return new SimpleScrollbars('CodeMirror-simplescroll', place, scroll);
  };

  CodeMirror.scrollbarModel.overlay = function (place, scroll) {
    return new SimpleScrollbars('CodeMirror-overlayscroll', place, scroll);
  };
};

},{}],35:[function(require,module,exports){
// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

module.exports = function (CodeMirror) {
  /*eslint-disable */
  var Pos = CodeMirror.Pos;

  function SearchCursor(doc, query, pos, caseFold) {
    this.atOccurrence = false; this.doc = doc;
    if (caseFold == null && typeof query == "string") caseFold = false;

    pos = pos ? doc.clipPos(pos) : Pos(0, 0);
    this.pos = {from: pos, to: pos};

    // The matches method is filled in based on the type of query.
    // It takes a position and a direction, and returns an object
    // describing the next occurrence of the query, or null if no
    // more matches were found.
    if (typeof query != "string") { // Regexp match
      if (!query.global) query = new RegExp(query.source, query.ignoreCase ? "ig" : "g");
      this.matches = function(reverse, pos) {
        if (reverse) {
          query.lastIndex = 0;
          var line = doc.getLine(pos.line).slice(0, pos.ch), cutOff = 0, match, start;
          for (;;) {
            query.lastIndex = cutOff;
            var newMatch = query.exec(line);
            if (!newMatch) break;
            match = newMatch;
            start = match.index;
            cutOff = match.index + (match[0].length || 1);
            if (cutOff == line.length) break;
          }
          var matchLen = (match && match[0].length) || 0;
          if (!matchLen) {
            if (start == 0 && line.length == 0) {match = undefined;}
            else if (start != doc.getLine(pos.line).length) {
              matchLen++;
            }
          }
        } else {
          query.lastIndex = pos.ch;
          var line = doc.getLine(pos.line), match = query.exec(line);
          var matchLen = (match && match[0].length) || 0;
          var start = match && match.index;
          if (start + matchLen != line.length && !matchLen) matchLen = 1;
        }
        if (match && matchLen)
          return {from: Pos(pos.line, start),
                  to: Pos(pos.line, start + matchLen),
                  match: match};
      };
    } else { // String query
      var origQuery = query;
      if (caseFold) query = query.toLowerCase();
      var fold = caseFold ? function(str){return str.toLowerCase();} : function(str){return str;};
      var target = query.split("\n");
      // Different methods for single-line and multi-line queries
      if (target.length == 1) {
        if (!query.length) {
          // Empty string would match anything and never progress, so
          // we define it to match nothing instead.
          this.matches = function() {};
        } else {
          this.matches = function(reverse, pos) {
            if (reverse) {
              var orig = doc.getLine(pos.line).slice(0, pos.ch), line = fold(orig);
              var match = line.lastIndexOf(query);
              if (match > -1) {
                match = adjustPos(orig, line, match);
                return {from: Pos(pos.line, match), to: Pos(pos.line, match + origQuery.length)};
              }
             } else {
               var orig = doc.getLine(pos.line).slice(pos.ch), line = fold(orig);
               var match = line.indexOf(query);
               if (match > -1) {
                 match = adjustPos(orig, line, match) + pos.ch;
                 return {from: Pos(pos.line, match), to: Pos(pos.line, match + origQuery.length)};
               }
            }
          };
        }
      } else {
        var origTarget = origQuery.split("\n");
        this.matches = function(reverse, pos) {
          var last = target.length - 1;
          if (reverse) {
            if (pos.line - (target.length - 1) < doc.firstLine()) return;
            if (fold(doc.getLine(pos.line).slice(0, origTarget[last].length)) != target[target.length - 1]) return;
            var to = Pos(pos.line, origTarget[last].length);
            for (var ln = pos.line - 1, i = last - 1; i >= 1; --i, --ln)
              if (target[i] != fold(doc.getLine(ln))) return;
            var line = doc.getLine(ln), cut = line.length - origTarget[0].length;
            if (fold(line.slice(cut)) != target[0]) return;
            return {from: Pos(ln, cut), to: to};
          } else {
            if (pos.line + (target.length - 1) > doc.lastLine()) return;
            var line = doc.getLine(pos.line), cut = line.length - origTarget[0].length;
            if (fold(line.slice(cut)) != target[0]) return;
            var from = Pos(pos.line, cut);
            for (var ln = pos.line + 1, i = 1; i < last; ++i, ++ln)
              if (target[i] != fold(doc.getLine(ln))) return;
            if (fold(doc.getLine(ln).slice(0, origTarget[last].length)) != target[last]) return;
            return {from: from, to: Pos(ln, origTarget[last].length)};
          }
        };
      }
    }
  }

  SearchCursor.prototype = {
    findNext: function() {return this.find(false);},
    findPrevious: function() {return this.find(true);},

    find: function(reverse) {
      var self = this, pos = this.doc.clipPos(reverse ? this.pos.from : this.pos.to);
      function savePosAndFail(line) {
        var pos = Pos(line, 0);
        self.pos = {from: pos, to: pos};
        self.atOccurrence = false;
        return false;
      }

      for (;;) {
        if (this.pos = this.matches(reverse, pos)) {
          this.atOccurrence = true;
          return this.pos.match || true;
        }
        if (reverse) {
          if (!pos.line) return savePosAndFail(0);
          pos = Pos(pos.line-1, this.doc.getLine(pos.line-1).length);
        }
        else {
          var maxLine = this.doc.lineCount();
          if (pos.line == maxLine - 1) return savePosAndFail(maxLine);
          pos = Pos(pos.line + 1, 0);
        }
      }
    },

    from: function() {if (this.atOccurrence) return this.pos.from;},
    to: function() {if (this.atOccurrence) return this.pos.to;},

    replace: function(newText, origin) {
      if (!this.atOccurrence) return;
      var lines = CodeMirror.splitLines(newText);
      this.doc.replaceRange(lines, this.pos.from, this.pos.to, origin);
      this.pos.to = Pos(this.pos.from.line + lines.length - 1,
                        lines[lines.length - 1].length + (lines.length == 1 ? this.pos.from.ch : 0));
    }
  };

  // Maps a position in a case-folded line back to a position in the original line
  // (compensating for codepoints increasing in number during folding)
  function adjustPos(orig, folded, pos) {
    if (orig.length == folded.length) return pos;
    for (var pos1 = Math.min(pos, orig.length);;) {
      var len1 = orig.slice(0, pos1).toLowerCase().length;
      if (len1 < pos) ++pos1;
      else if (len1 > pos) --pos1;
      else return pos1;
    }
  }

  CodeMirror.defineExtension("getSearchCursor", function(query, pos, caseFold) {
    return new SearchCursor(this.doc, query, pos, caseFold);
  });
  CodeMirror.defineDocExtension("getSearchCursor", function(query, pos, caseFold) {
    return new SearchCursor(this, query, pos, caseFold);
  });

  CodeMirror.defineExtension("selectMatches", function(query, caseFold) {
    var ranges = [];
    var cur = this.getSearchCursor(query, this.getCursor("from"), caseFold);
    while (cur.findNext()) {
      if (CodeMirror.cmpPos(cur.to(), this.getCursor("to")) > 0) break;
      ranges.push({anchor: cur.from(), head: cur.to()});
    }
    if (ranges.length)
      this.setSelections(ranges, 0);
  });
  /*eslint-enable */
};

},{}],36:[function(require,module,exports){
// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

/* eslint-disable */
module.exports = function (CodeMirror) {
  "use strict";

  var HINT_ELEMENT_CLASS        = "CodeMirror-hint";
  var ACTIVE_HINT_ELEMENT_CLASS = "CodeMirror-hint-active";

  // This is the old interface, kept around for now to stay
  // backwards-compatible.
  CodeMirror.showHint = function(cm, getHints, options) {
    if (!getHints) return cm.showHint(options);
    if (options && options.async) getHints.async = true;
    var newOpts = {hint: getHints};
    if (options) for (var prop in options) newOpts[prop] = options[prop];
    return cm.showHint(newOpts);
  };

  CodeMirror.defineExtension("showHint", function(options) {
    options = parseOptions(this, this.getCursor("start"), options);
    var selections = this.listSelections()
    if (selections.length > 1) return;
    // By default, don't allow completion when something is selected.
    // A hint function can have a `supportsSelection` property to
    // indicate that it can handle selections.
    if (this.somethingSelected()) {
      if (!options.hint.supportsSelection) return;
      // Don't try with cross-line selections
      for (var i = 0; i < selections.length; i++)
        if (selections[i].head.line != selections[i].anchor.line) return;
    }

    if (this.state.completionActive) this.state.completionActive.close();
    var completion = this.state.completionActive = new Completion(this, options);
    if (!completion.options.hint) return;

    CodeMirror.signal(this, "startCompletion", this);
    completion.update(true);
  });

  function Completion(cm, options) {
    this.cm = cm;
    this.options = options;
    this.widget = null;
    this.debounce = 0;
    this.tick = 0;
    this.startPos = this.cm.getCursor("start");
    this.startLen = this.cm.getLine(this.startPos.line).length - this.cm.getSelection().length;

    var self = this;
    cm.on("cursorActivity", this.activityFunc = function() { self.cursorActivity(); });
  }

  var requestAnimationFrame = window.requestAnimationFrame || function(fn) {
    return setTimeout(fn, 1000/60);
  };
  var cancelAnimationFrame = window.cancelAnimationFrame || clearTimeout;

  Completion.prototype = {
    close: function() {
      if (!this.active()) return;
      this.cm.state.completionActive = null;
      this.tick = null;
      this.cm.off("cursorActivity", this.activityFunc);

      if (this.widget && this.data) CodeMirror.signal(this.data, "close");
      if (this.widget) this.widget.close();
      CodeMirror.signal(this.cm, "endCompletion", this.cm);
    },

    active: function() {
      return this.cm.state.completionActive == this;
    },

    pick: function(data, i) {
      var completion = data.list[i];
      if (completion.hint) completion.hint(this.cm, data, completion);
      else this.cm.replaceRange(getText(completion, this.options), completion.from || data.from,
                                completion.to || data.to, "complete");
      CodeMirror.signal(data, "pick", completion);
      this.close();
    },

    cursorActivity: function() {
      if (this.debounce) {
        cancelAnimationFrame(this.debounce);
        this.debounce = 0;
      }

      var pos = this.cm.getCursor(), line = this.cm.getLine(pos.line);
      if (pos.line != this.startPos.line || line.length - pos.ch != this.startLen - this.startPos.ch ||
          pos.ch < this.startPos.ch || this.cm.somethingSelected() ||
          (pos.ch && this.options.closeCharacters.test(line.charAt(pos.ch - 1)))) {
        this.close();
      } else {
        var self = this;
        this.debounce = requestAnimationFrame(function() {self.update();});
        if (this.widget) this.widget.disable();
      }
    },

    update: function(first) {
      if (this.tick == null) return
      var self = this, myTick = ++this.tick
      fetchHints(this.options.hint, this.cm, this.options, function(data) {
        if (self.tick == myTick) self.finishUpdate(data, first)
      })
    },

    finishUpdate: function(data, first) {
      if (this.data) CodeMirror.signal(this.data, "update");

      var picked = (this.widget && this.widget.picked) || (first && this.options.completeSingle);
      if (this.widget) this.widget.close();

      if (data && this.data && isNewCompletion(this.data, data)) return;
      this.data = data;

      if (data && data.list.length) {
        if (picked && data.list.length == 1) {
          this.pick(data, 0);
        } else {
          this.widget = new Widget(this, data);
          CodeMirror.signal(data, "shown");
        }
      }
    }
  };

  function isNewCompletion(old, nw) {
    var moved = CodeMirror.cmpPos(nw.from, old.from)
    return moved > 0 && old.to.ch - old.from.ch != nw.to.ch - nw.from.ch
  }

  function parseOptions(cm, pos, options) {
    var editor = cm.options.hintOptions;
    var out = {};
    for (var prop in defaultOptions) out[prop] = defaultOptions[prop];
    if (editor) for (var prop in editor)
      if (editor[prop] !== undefined) out[prop] = editor[prop];
    if (options) for (var prop in options)
      if (options[prop] !== undefined) out[prop] = options[prop];
    if (out.hint.resolve) out.hint = out.hint.resolve(cm, pos)
    return out;
  }

  function getText(completion, options) {
    var autocompleteSuffix = options && options.autocompleteSuffix ? options.autocompleteSuffix : '';
    var autocompletePrefix = options && options.autocompletePrefix ? options.autocompletePrefix : '';

    if (typeof completion !== "string") {
      completion = completion.text
    }

    return autocompletePrefix + completion + autocompleteSuffix;
  }

  function getType(completion) {
    if (typeof completion == "string") return '';
    else return completion.type;
  }

  function buildKeyMap(completion, handle) {
    var baseMap = {
      Up: function() {handle.moveFocus(-1);},
      Down: function() {handle.moveFocus(1);},
      PageUp: function() {handle.moveFocus(-handle.menuSize() + 1, true);},
      PageDown: function() {handle.moveFocus(handle.menuSize() - 1, true);},
      Home: function() {handle.setFocus(0);},
      End: function() {handle.setFocus(handle.length - 1);},
      Enter: handle.pick,
      Tab: handle.pick,
      Esc: handle.close
    };
    var custom = completion.options.customKeys;
    var ourMap = custom ? {} : baseMap;
    function addBinding(key, val) {
      var bound;
      if (typeof val != "string")
        bound = function(cm) { return val(cm, handle); };
      // This mechanism is deprecated
      else if (baseMap.hasOwnProperty(val))
        bound = baseMap[val];
      else
        bound = val;
      ourMap[key] = bound;
    }
    if (custom)
      for (var key in custom) if (custom.hasOwnProperty(key))
        addBinding(key, custom[key]);
    var extra = completion.options.extraKeys;
    if (extra)
      for (var key in extra) if (extra.hasOwnProperty(key))
        addBinding(key, extra[key]);
    return ourMap;
  }

  function getHintElement(hintsElement, el) {
    while (el && el != hintsElement) {
      if (el.nodeName.toUpperCase() === "LI" && el.parentNode == hintsElement) return el;
      el = el.parentNode;
    }
  }

  function styleHint(hint) {
    var element = document.createElement(hint.displayText || getText(hint));
    element = document.createElement("span");
    element.className = 'CDB-Size-small has-letter';
    element.innerHTML = hint.displayText || getText(hint);

    var type = getType(hint);
    if (type) {
      element.className = 'CDB-Size-small has-letter';
      element.dataset.type = type;
    }

    return element;
  }

  function Widget(completion, data) {
    this.completion = completion;
    this.data = data;
    this.picked = false;
    var widget = this, cm = completion.cm;

    var hints = this.hints = document.createElement("ul");
    hints.className = "CodeMirror-hints";
    this.selectedHint = data.selectedHint || 0;

    var element;
    var completions = data.list;
    for (var i = 0; i < completions.length; ++i) {
      var elt = hints.appendChild(document.createElement("li")), cur = completions[i];
      var className = HINT_ELEMENT_CLASS + (i != this.selectedHint ? "" : " " + ACTIVE_HINT_ELEMENT_CLASS);
      if (cur.className != null) className = cur.className + " " + className;
      elt.className = className;
      if (cur.render) cur.render(elt, data, cur);
      else {
        element = styleHint(cur);
        elt.appendChild(element);
      }

      elt.hintId = i;
    }

    var pos = cm.cursorCoords(completion.options.alignWithWord ? data.from : null);
    var left = pos.left, top = pos.bottom, below = true;
    hints.style.left = left + "px";
    hints.style.top = top + "px";
    // If we're at the edge of the screen, then we want the menu to appear on the left of the cursor.
    var winW = window.innerWidth || Math.max(document.body.offsetWidth, document.documentElement.offsetWidth);
    var winH = window.innerHeight || Math.max(document.body.offsetHeight, document.documentElement.offsetHeight);
    (completion.options.container || document.body).appendChild(hints);
    var box = hints.getBoundingClientRect(), overlapY = box.bottom - winH;
    if (overlapY > 0) {
      var height = box.bottom - box.top, curTop = pos.top - (pos.bottom - box.top);
      if (curTop - height > 0) { // Fits above cursor
        hints.style.top = (top = pos.top - height) + "px";
        below = false;
      } else if (height > winH) {
        hints.style.height = (winH - 5) + "px";
        hints.style.top = (top = pos.bottom - box.top) + "px";
        var cursor = cm.getCursor();
        if (data.from.ch != cursor.ch) {
          pos = cm.cursorCoords(cursor);
          hints.style.left = (left = pos.left) + "px";
          box = hints.getBoundingClientRect();
        }
      }
    }
    var overlapX = box.right - winW;
    if (overlapX > 0) {
      if (box.right - box.left > winW) {
        hints.style.width = (winW - 5) + "px";
        overlapX -= (box.right - box.left) - winW;
      }
      hints.style.left = (left = pos.left - overlapX) + "px";
    }

    cm.addKeyMap(this.keyMap = buildKeyMap(completion, {
      moveFocus: function(n, avoidWrap) { widget.changeActive(widget.selectedHint + n, avoidWrap); },
      setFocus: function(n) { widget.changeActive(n); },
      menuSize: function() { return widget.screenAmount(); },
      length: completions.length,
      close: function() { completion.close(); },
      pick: function() { widget.pick(); },
      data: data
    }));

    if (completion.options.closeOnUnfocus) {
      var closingOnBlur;
      cm.on("blur", this.onBlur = function() { closingOnBlur = setTimeout(function() { completion.close(); }, 100); });
      cm.on("focus", this.onFocus = function() { clearTimeout(closingOnBlur); });
    }

    var startScroll = cm.getScrollInfo();
    cm.on("scroll", this.onScroll = function() {
      var curScroll = cm.getScrollInfo(), editor = cm.getWrapperElement().getBoundingClientRect();
      var newTop = top + startScroll.top - curScroll.top;
      var point = newTop - (window.pageYOffset || (document.documentElement || document.body).scrollTop);
      if (!below) point += hints.offsetHeight;
      if (point <= editor.top || point >= editor.bottom) return completion.close();
      hints.style.top = newTop + "px";
      hints.style.left = (left + startScroll.left - curScroll.left) + "px";
    });

    CodeMirror.on(hints, "dblclick", function(e) {
      var t = getHintElement(hints, e.target || e.srcElement);
      if (t && t.hintId != null) {widget.changeActive(t.hintId); widget.pick();}
    });

    CodeMirror.on(hints, "click", function(e) {
      var t = getHintElement(hints, e.target || e.srcElement);
      if (t && t.hintId != null) {
        widget.changeActive(t.hintId);
        if (completion.options.completeOnSingleClick) widget.pick();
      }
    });

    CodeMirror.on(hints, "mousedown", function() {
      setTimeout(function(){cm.focus();}, 20);
    });

    CodeMirror.signal(data, "select", completions[0], hints.firstChild);
    return true;
  }

  Widget.prototype = {
    close: function() {
      if (this.completion.widget != this) return;
      this.completion.widget = null;
      this.hints.parentNode.removeChild(this.hints);
      this.completion.cm.removeKeyMap(this.keyMap);

      var cm = this.completion.cm;
      if (this.completion.options.closeOnUnfocus) {
        cm.off("blur", this.onBlur);
        cm.off("focus", this.onFocus);
      }
      cm.off("scroll", this.onScroll);
    },

    disable: function() {
      this.completion.cm.removeKeyMap(this.keyMap);
      var widget = this;
      this.keyMap = {Enter: function() { widget.picked = true; }};
      this.completion.cm.addKeyMap(this.keyMap);
    },

    pick: function() {
      this.completion.pick(this.data, this.selectedHint);
    },

    changeActive: function(i, avoidWrap) {
      if (i >= this.data.list.length)
        i = avoidWrap ? this.data.list.length - 1 : 0;
      else if (i < 0)
        i = avoidWrap ? 0  : this.data.list.length - 1;
      if (this.selectedHint == i) return;
      var node = this.hints.childNodes[this.selectedHint];
      node.className = node.className.replace(" " + ACTIVE_HINT_ELEMENT_CLASS, "");
      node = this.hints.childNodes[this.selectedHint = i];
      node.className += " " + ACTIVE_HINT_ELEMENT_CLASS;
      if (node.offsetTop < this.hints.scrollTop)
        this.hints.scrollTop = node.offsetTop - 3;
      else if (node.offsetTop + node.offsetHeight > this.hints.scrollTop + this.hints.clientHeight)
        this.hints.scrollTop = node.offsetTop + node.offsetHeight - this.hints.clientHeight + 3;
      CodeMirror.signal(this.data, "select", this.data.list[this.selectedHint], node);
    },

    screenAmount: function() {
      return Math.floor(this.hints.clientHeight / this.hints.firstChild.offsetHeight) || 1;
    }
  };

  function applicableHelpers(cm, helpers) {
    if (!cm.somethingSelected()) return helpers
    var result = []
    for (var i = 0; i < helpers.length; i++)
      if (helpers[i].supportsSelection) result.push(helpers[i])
    return result
  }

  function fetchHints(hint, cm, options, callback) {
    if (hint.async) {
      hint(cm, callback, options)
    } else {
      var result = hint(cm, options)
      if (result && result.then) result.then(callback)
      else callback(result)
    }
  }

  function resolveAutoHints(cm, pos) {
    var helpers = cm.getHelpers(pos, "hint"), words
    if (helpers.length) {
      var resolved = function(cm, callback, options) {
        var app = applicableHelpers(cm, helpers);
        function run(i) {
          if (i == app.length) return callback(null)
          fetchHints(app[i], cm, options, function(result) {
            if (result && result.list.length > 0) callback(result)
            else run(i + 1)
          })
        }
        run(0)
      }
      resolved.async = true
      resolved.supportsSelection = true
      return resolved
    } else if (words = cm.getHelper(cm.getCursor(), "hintWords")) {
      return function(cm) { return CodeMirror.hint.fromList(cm, {words: words}) }
    } else if (CodeMirror.hint.anyword) {
      return function(cm, options) { return CodeMirror.hint.anyword(cm, options) }
    } else {
      return function() {}
    }
  }

  CodeMirror.registerHelper("hint", "auto", {
    resolve: resolveAutoHints
  });

  CodeMirror.registerHelper("hint", "fromList", function(cm, options) {
    var cur = cm.getCursor(), token = cm.getTokenAt(cur);
    var to = CodeMirror.Pos(cur.line, token.end);
    if (token.string && /\w/.test(token.string[token.string.length - 1])) {
      var term = token.string, from = CodeMirror.Pos(cur.line, token.start);
    } else {
      var term = "", from = to;
    }
    var found = [];
    for (var i = 0; i < options.words.length; i++) {
      var word = options.words[i];
      if (word.slice(0, term.length) == term)
        found.push(word);
    }

    if (found.length) return {list: found, from: from, to: to};
  });

  CodeMirror.commands.autocomplete = CodeMirror.showHint;

  var defaultOptions = {
    hint: CodeMirror.hint.auto,
    completeSingle: true,
    alignWithWord: true,
    closeCharacters: /[\s()\[\]{};:>,]/,
    closeOnUnfocus: true,
    completeOnSingleClick: true,
    container: null,
    customKeys: null,
    extraKeys: null
  };

  CodeMirror.defineOption("hintOptions", null);
};
/* eslint-enable */

},{}],37:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var ContextMenuView = require('./context-menu/context-menu-view');
var CustomListCollection = require('./custom-list/custom-list-collection');
var template = require('./context-menu-factory.tpl');

var REQUIRED_OPTS = [
  'menuItems'
];

module.exports = CoreView.extend({
  events: {
    'click .js-toggle-menu': '_onToggleContextMenuClicked'
  },

  className: 'CDB-Shape',

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this.template = opts.template || template;
    this._initContextMenu(this._menuItems);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(this.template());
    return this;
  },

  _initContextMenu: function (items) {
    this._menuItems = new CustomListCollection(items);
    this._menuItems.on('change:selected', this._onContextMenuSelect, this);
    this.add_related_model(this._menuItems);
  },

  _onContextMenuSelect: function (menuItem) {
    var action = menuItem.get('action');
    action && action.call(this);
  },

  _showContextMenu: function (position) {
    var triggerElementID = 'context-menu-trigger-' + this.cid;
    this.$('.js-toggle-menu').attr('id', triggerElementID);

    var menuItems = this._menuItems;
    this._resetContextMenuItems();
    this._menuView = new ContextMenuView({
      collection: menuItems,
      triggerElementID: triggerElementID,
      position: position
    });

    this._menuView.model.on('change:visible', function (model, isContextMenuVisible) {
      if (this._hasContextMenu() && !isContextMenuVisible) {
        this._hideContextMenu();
      }
    }, this);

    this._menuView.show();
    this.addView(this._menuView);
  },

  _resetContextMenuItems: function () {
    var selected = this._menuItems.getSelectedItem();
    selected && selected.set({selected: false}, {silent: true});
  },

  _hasContextMenu: function () {
    return this._menuView != null;
  },

  _hideContextMenu: function () {
    this.removeView(this._menuView);
    this._menuView.clean();
    delete this._menuView;
  },

  _onToggleContextMenuClicked: function (event) {
    event.preventDefault();
    if (this._hasContextMenu()) {
      this._hideContextMenu();
    } else {
      this._showContextMenu({
        x: event.pageX,
        y: event.pageY
      });
    }
  },

  getContextMenu: function () {
    return this._menuView;
  }
});

},{"./context-menu-factory.tpl":38,"./context-menu/context-menu-view":39,"./custom-list/custom-list-collection":47,"backbone/core-view":1127,"underscore":"underscore"}],38:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button class="CDB-Shape-threePoints is-blue is-small js-toggle-menu">\n  <div class="CDB-Shape-threePointsItem"></div>\n  <div class="CDB-Shape-threePointsItem"></div>\n  <div class="CDB-Shape-threePointsItem"></div>\n</button>';
}
return __p;
};

},{"underscore":"underscore"}],39:[function(require,module,exports){
var $ = require('jquery');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var CustomListView = require('../custom-list/custom-list-view');
var CustomListItemView = require('../custom-list/custom-list-item-view');
var itemTemplate = require('../custom-list/custom-list-item.tpl');
var magicPositioner = require('../../helpers/magic-positioner');

var ESCAPE_KEY_CODE = 27;

/*
 *  A context menu
 */
module.exports = CoreView.extend({

  options: {
    position: {
      x: 0,
      y: 0
    },
    offset: {
      x: 0,
      y: 15
    },
    itemTemplate: itemTemplate,
    itemView: CustomListItemView
  },

  className: 'CDB-Box-modal CDB-SelectItem CustomList CustomList--small',
  tagName: 'div',

  initialize: function (opts) {
    opts = opts || {};
    if (!opts.collection) throw new Error('collection option is required');
    if (!opts.triggerElementID) throw new Error('element id is required');

    this._triggerElementID = opts.triggerElementID;

    this.model = new Backbone.Model({
      visible: false
    });

    this._onEscapePressed = this._onEscapePressed.bind(this);
    this._onDocumentElementClicked = this._onDocumentElementClicked.bind(this);

    this._initBinds();
  },

  _initBinds: function () {
    this.model.on('change:visible', function (mdl, isVisible) {
      this.render();
      if (isVisible) {
        this._initDocumentBinds();
      } else {
        this._destroyDocumentBinds();
      }
    }, this);
    this.collection.on('change:selected', this.hide, this);
    this.add_related_model(this.collection);
  },

  _initDocumentBinds: function () {
    $(document).on('keydown', this._onEscapePressed);
    $(document).on('mousedown', this._onDocumentElementClicked);
  },

  _destroyDocumentBinds: function () {
    $(document).off('keydown', this._onEscapePressed);
    $(document).off('mousedown', this._onDocumentElementClicked);
  },

  render: function () {
    var $body = $('body');
    var posX = (this.options.position.x || 0) + this.options.offset.x;
    var posY = (this.options.position.y || 0) + this.options.offset.y;

    this.clearSubViews();
    this.$el.empty();
    this._renderList();

    this.$el.toggle(this.isVisible());

    $body.append(this.el);

    this.$el.css(
      magicPositioner({
        parentView: $body,
        posX: posX,
        posY: posY
      })
    );

    return this;
  },

  _onEscapePressed: function (ev) {
    if (ev.which === ESCAPE_KEY_CODE) {
      this.hide();
    }
  },

  _onDocumentElementClicked: function (ev) {
    var $el = $(ev.target);
    if ($el.closest(this.$el).length === 0 && $el.closest($('#' + this._triggerElementID)).length === 0) {
      this.hide();
    }
  },

  _renderList: function () {
    this._listView = new CustomListView({
      model: this.model,
      collection: this.collection,
      typeLabel: '',
      ItemView: this.options.itemView,
      itemTemplate: this.options.itemTemplate,
      size: 5
    });
    this.$el.append(this._listView.render().el);
    this.addView(this._listView);
  },

  show: function () {
    this.model.set('visible', true);
  },

  hide: function () {
    this.model.set('visible', false);
  },

  toggle: function () {
    this.model.set('visible', !this.model.get('visible'));
  },

  isVisible: function () {
    return this.model.get('visible');
  },

  clean: function () {
    this._destroyDocumentBinds();
    CoreView.prototype.clean.apply(this);
  }
});

},{"../../helpers/magic-positioner":1093,"../custom-list/custom-list-item-view":50,"../custom-list/custom-list-item.tpl":52,"../custom-list/custom-list-view":57,"backbone":"backbone","backbone/core-view":1127,"jquery":"jquery"}],40:[function(require,module,exports){
var Backbone = require('backbone');
var CustomCarouselModel = require('./custom-carousel-item-model');

/*
 *  Custom list collection, it parses pairs like:
 *
 *  [{ val, label }]
 *  ["string"]
 */

module.exports = Backbone.Collection.extend({

  model: function (attrs, opts) {
    var d = {};
    if (typeof attrs === 'string') {
      d.val = attrs;
    } else {
      d = attrs;
    }
    return new CustomCarouselModel(d);
  },

  initialize: function () {
    this._initBinds();
  },

  _initBinds: function () {
    this.bind('change:selected', this._onSelectedChange, this);
  },

  _onSelectedChange: function (changedModel, isSelected) {
    if (isSelected) {
      this.each(function (m) {
        if (m.cid !== changedModel.cid && m.get('selected')) {
          m.set('selected', false);
        }
      });
    }
  },

  getSelected: function () {
    return this.findWhere({ selected: true });
  },

  getSelectedValue: function () {
    var selectedModel = this.getSelected();
    return selectedModel && selectedModel.get('val');
  },

  getHighlighted: function () {
    return this.findWhere({ highlighted: true });
  }

});

},{"./custom-carousel-item-model":41,"backbone":"backbone"}],41:[function(require,module,exports){
var Backbone = require('backbone');

/*
 *  List item model
 *
 */

module.exports = Backbone.Model.extend({

  defaults: {
    selected: false,
    label: '',
    template: function () {
      return '';
    }
  },

  getName: function () {
    return this.get('label') || this.getValue();
  },

  getValue: function () {
    return this.get('val');
  }

});

},{"backbone":"backbone"}],42:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./custom-carousel-item.tpl');

module.exports = CoreView.extend({

  className: 'Carousel-item',
  tagName: 'li',

  events: {
    'mouseenter': '_onMouseEnter',
    'mouseleave': '_onMouseLeave',
    'click': '_onClick'
  },

  initialize: function (opts) {
    this._itemClassName = opts && opts.itemOptions ? opts.itemOptions.className : '';
    this._initBinds();
  },

  render: function () {
    this.$el.html(
      template({
        name: this.model.getName(),
        className: this._itemClassName,
        template: this.model.get('template')()
      })
    );

    if (this.model.getValue()) {
      this.$el.addClass('js-' + this.model.getValue());
    }
    this.$el.toggleClass('is-selected', !!this.model.get('selected'));
    return this;
  },

  _initBinds: function () {
    this.model.bind('change:selected', this.render, this);
  },

  _onMouseEnter: function () {
    this.model.set('highlighted', true);
  },

  _onMouseLeave: function () {
    this.model.set('highlighted', false);
  },

  _onClick: function (e) {
    this.killEvent(e);
    this.model.set('selected', true);
  }
});

},{"./custom-carousel-item.tpl":43,"backbone/core-view":1127}],43:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button';
 if (className) { 
__p+=' class="'+
((__t=( className ))==null?'':_.escape(__t))+
'"';
 } 
__p+='>\n  '+
((__t=( template ))==null?'':__t)+
'\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],44:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var Ps = require('perfect-scrollbar');
var template = require('./custom-carousel.tpl');
var CarouselCollection = require('./custom-carousel-collection');
var CarouselItemView = require('./custom-carousel-item-view');
var _ = require('underscore');
/*
 *  A custom carousel selector
 *
 *  It accepts a collection of (val, label) model attributes or a values array
 *  with the same content or only strings.
 *
 *  new CustomCarousel({
 *    options: [
 *      {
 *        val: 'hello',
 *        label: 'hi'
 *      }
 *    ]
 *  });
 */

module.exports = CoreView.extend({

  className: 'Carousel',
  tagName: 'div',

  initialize: function (opts) {
    if (!opts.collection) {
      if (!opts.options) { throw new Error('options array {value, label} is required'); }
      this.collection = new CarouselCollection(opts.options);
      this.options = opts;
    }
    this._bindedCheckShadows = this._checkShadows.bind(this);
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());
    this._renderList();
    this._applyCustomScroll();
    return this;
  },

  _initBinds: function () {
    this.collection.bind('change:selected', this._checkScroll, this);
  },

  _renderList: function () {
    this.collection.each(function (mdl) {
      this._createItem(mdl);
    }, this);
  },

  _createItem: function (mdl) {
    var opts = this.options;
    var className = opts && opts.listItemOptions ? opts.listItemOptions.className : 'Carousel-item';
    var view = new CarouselItemView({
      className: className,
      model: mdl,
      itemOptions: this.options.itemOptions
    });

    this._listContainer().append(view.render().el);
    this.addView(view);
  },

  _applyCustomScroll: function () {
    Ps.initialize(this._listContainer().get(0), {
      wheelSpeed: 1,
      wheelPropagation: false,
      swipePropagation: true,
      suppressScrollY: true,
      stopPropagationOnClick: false,
      minScrollbarLength: 120
    });
    this._checkScroll();
    this._bindScroll();
  },

  _destroyCustomScroll: function () {
    this._unbindScroll();
    Ps.destroy(this._listContainer().get(0));
  },

  _bindScroll: function () {
    this._listContainer()
      .on('ps-x-reach-start', this._bindedCheckShadows)
      .on('ps-x-reach-end', this._bindedCheckShadows)
      .on('ps-scroll-x', this._bindedCheckShadows);
  },

  _unbindScroll: function () {
    this._listContainer()
      .off('ps-x-reach-start', this._bindedCheckShadows)
      .off('ps-x-reach-end', this._bindedCheckShadows)
      .off('ps-scroll-x', this._bindedCheckShadows);
  },

  _checkScroll: function () {
    var position = this.$('.is-selected').position();
    if (position) {
      this._listContainer().scrollLeft(position.left - 20);
      this._bindedCheckShadows();
    }
  },

  _listContainer: function () {
    return this.$('.js-list');
  },

  _checkShadows: function () {
    var currentPos = this._listContainer().scrollLeft();
    var max = this._listContainer().get(0).scrollWidth;
    var width = this._listContainer().outerWidth();
    var maxPos = max - width;

    this.$('.js-leftShadow').toggleClass('is-visible', currentPos > 0);
    this.$('.js-rightShadow').toggleClass('is-visible', currentPos < maxPos);
  },

  clean: function () {
    this._destroyCustomScroll();
    CoreView.prototype.clean.apply(this);
  },

  initScroll: function () {
    setTimeout(_.bind(function () {
      this._checkShadows();
      this._checkScroll();
      Ps.update(this._listContainer().get(0));
    }, this), 0);
  }

});

},{"./custom-carousel-collection":40,"./custom-carousel-item-view":42,"./custom-carousel.tpl":45,"backbone/core-view":1127,"perfect-scrollbar":"perfect-scrollbar","underscore":"underscore"}],45:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Carousel-shadow Carousel-shadow--left js-leftShadow"></div>\n<div class="Carousel-shadow Carousel-shadow--right is-visible js-rightShadow"></div>\n<ul class="Carousel-list js-list"></ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],46:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-ListDecoration-item CustomList-item js-listItem">\n  <button type="button" class="CDB-ListDecoration-itemLink CustomList-itemLink js-add-custom-value u-ellipsis" data-val="'+
((__t=( query ))==null?'':_.escape(__t))+
'" title="'+
((__t=( query ))==null?'':_.escape(__t))+
'">\n    <p class="CDB-Text CDB-FontSize-small u-altTextColor">'+
((__t=( _t('components.custom-list.add-custom-result') ))==null?'':_.escape(__t))+
'</p>\n    “'+
((__t=( query ))==null?'':_.escape(__t))+
'”\n  </button>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],47:[function(require,module,exports){
var Backbone = require('backbone');
var CustomListItemModel = require('./custom-list-item-model');
var _ = require('underscore');

/*
 *  Custom list collection, it parses pairs like:
 *
 *  [{ val, label }]
 *  ["string"]
 */

module.exports = Backbone.Collection.extend({
  sort_key: 'id', // default sort key

  initialize: function (models, options) {
    this.options = _.extend({ silent: true }, options);
    this._initBinds();
  },

  comparator: function (item) {
    return item.get(this.sort_key) ? item.get(this.sort_key).toLowerCase() : item.get(this.sort_key);
  },

  model: function (attrs, opts) {
    var d = {};
    if (typeof attrs === 'string') {
      d.val = attrs;
    } else {
      d = attrs;
    }
    return new CustomListItemModel(d, opts);
  },

  sortByKey: function (key) {
    this.sort_key = key;
    this.sort();
  },

  _initBinds: function () {
    this.bind('change:selected', this._onSelectedChange, this);
  },

  search: function (query) {
    if (!query) return this;
    query = query.toLowerCase();

    return _(this.filter(function (model) {
      var name = model.getName();
      var val = _.isString(name) ? name.toLowerCase() : name;
      return val ? ~val.indexOf(query) : -1;
    }));
  },

  _onSelectedChange: function (changedModel, isSelected) {
    if (isSelected) {
      this.each(function (m) {
        if (m.cid !== changedModel.cid) {
          m.set({
            selected: false
          }, {
            silent: this.options.silent
          });
        }
      }, this);
    }
  },

  getSelectedItem: function () {
    return _.first(
      this.where({ selected: true })
    );
  },

  containsValue: function (value) {
    return this.find(function (mdl) {
      return mdl.getValue() === value;
    });
  },

  setSelected: function (value) {
    var selectedModel;
    var silent = { silent: this.options.silent };

    this.each(function (mdl) {
      if (mdl.getValue() === value) {
        mdl.set({
          selected: true
        }, silent);
        selectedModel = mdl;
      } else {
        mdl.set({
          selected: false
        }, silent);
      }
    });
    return selectedModel;
  },

  removeSelected: function () {
    this.each(function (mdl) {
      mdl.set({
        selected: false
      });
    });
  }
});

},{"./custom-list-item-model":49,"backbone":"backbone","underscore":"underscore"}],48:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CustomList-message">\n  <p class="CustomList-messageText CDB-Text CDB-Size-medium u-secondaryTextColor">\n    ';
 if (query && query.length) { 
__p+='\n      '+
((__t=( _t('components.custom-list.no-results', { typeLabel: typeLabel, query: query }) ))==null?'':_.escape(__t))+
'\n    ';
 } else { 
__p+='\n      '+
((__t=( _t('components.custom-list.no-items', { typeLabel: typeLabel }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  </p>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],49:[function(require,module,exports){
var Backbone = require('backbone');

/*
 *  List item model
 *
 */

module.exports = Backbone.Model.extend({

  defaults: {
    selected: false
  },

  getName: function () {
    return (this.get('label') == null) ? this.getValue() : this.get('label'); // eslint-disable-line
  },

  getValue: function () {
    return this.get('val');
  }

});

},{"backbone":"backbone"}],50:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');

module.exports = CoreView.extend({

  options: {
    template: require('./custom-list-item.tpl')
  },

  className: 'CDB-ListDecoration-item CustomList-item js-listItem',
  tagName: 'li',

  events: {
    'mouseenter': '_onMouseEnter',
    'mouseleave': '_onMouseLeave',
    'click': '_onClick'
  },

  initialize: function (opts) {
    this.options = _.extend({}, this.options, opts);
    this.model.on('change', this.render, this);
  },

  render: function () {
    this.$el.empty();
    this.clearSubViews();

    var name = this.model.getName() == null ? 'null' : this.model.getName();

    this.$el.append(
      this.options.template(
        _.extend({
          typeLabel: this.options.typeLabel,
          isSelected: this.model.get('selected'),
          isDisabled: this.model.get('disabled'),
          isDestructive: this.model.get('destructive'),
          name: name,
          val: this.model.getValue(),
          options: this.model.get('renderOptions')
        })
      )
    );

    this.$el
      .attr('data-val', this.model.getValue())
      .toggleClass('is-disabled', !!this.model.get('disabled'));

    return this;
  },

  _onMouseLeave: function () {
    this.$el.removeClass('is-highlighted');
  },

  _onMouseEnter: function () {
    this.$el.addClass('is-highlighted');
  },

  _onClick: function (ev) {
    this.killEvent(ev);
    this.model.set({
      selectedClass: ev.target.classList,
      selected: true
    });
  }
});

},{"./custom-list-item.tpl":52,"backbone/core-view":1127,"underscore":"underscore"}],51:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button type="button" class="CDB-ListDecoration-itemLink u-ellipsis\n  ';
 if (isSelected) { 
__p+=' is-selected ';
 } 
__p+='\n  ';
 if (isDestructive) { 
__p+='\n  u-errorTextColor\n  ';
 } else if (isDisabled) { 
__p+='\n  u-hintTextColor\n  ';
 } else { 
__p+='\n  u-actionTextColor\n  ';
 } 
__p+='\n  " title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">\n\n  <div class="u-iBlock u-rSpace">\n    <input class="CDB-Checkbox js-input" type="checkbox" name="" value="" ';
 if (isSelected) { 
__p+='checked';
 } 
__p+=' ';
 if (isDisabled) { 
__p+='disabled';
 } 
__p+=' />\n    <span class="u-iBlock CDB-Checkbox-face"></span>\n  </div>\n  '+
((__t=( name ))==null?'':_.escape(__t))+
'\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],52:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button type="button" class="CDB-ListDecoration-itemLink u-ellipsis\n    ';
 if (isSelected) { 
__p+=' is-selected ';
 } 
__p+='\n    ';
 if (isDestructive) { 
__p+='\n      u-errorTextColor\n    ';
 } else if (isDisabled) { 
__p+='\n      u-hintTextColor\n    ';
 } else { 
__p+='\n      u-actionTextColor\n    ';
 } 
__p+='\n  " title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">\n  '+
((__t=( name ))==null?'':_.escape(__t))+
'\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],53:[function(require,module,exports){
var _ = require('underscore');
var CustomListCollection = require('./custom-list-collection');

module.exports = CustomListCollection.extend({
  _initBinds: function () { },

  setSelected: function (value) {
    var selectedModel;
    var silentTrue = { silent: true };

    if (_.isArray(value)) {
      this.each(function (mdl) {
        if (_.contains(value, mdl.getValue())) {
          mdl.set({
            selected: true
          }, silentTrue);
          selectedModel = mdl;
        } else {
          mdl.set({
            selected: false
          }, silentTrue);
        }
      });
    } else {
      this.each(function (mdl) {
        if (mdl.getValue() === value) {
          mdl.set({
            selected: true
          }, silentTrue);
          selectedModel = mdl;
        } else {
          mdl.set({
            selected: false
          }, silentTrue);
        }
      });
    }
    return selectedModel;
  }
});

},{"./custom-list-collection":47,"underscore":"underscore"}],54:[function(require,module,exports){
var CustomListItemView = require('./custom-list-item-view');

module.exports = CustomListItemView.extend({
  _onClick: function (ev) {
    this.killEvent(ev);
    this.model.set('selected', !this.model.get('selected'));
  }
});

},{"./custom-list-item-view":50}],55:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./custom-list-search.tpl');

module.exports = CoreView.extend({

  className: 'CustomList-form CDB-Box-modalHeader',
  tagName: 'form',

  events: {
    'keyup .js-search': '_onSearchType',
    'click .js-clear': '_onClickClear',
    'submit': '_submit'
  },

  initialize: function () {
    this.template = this.options.template || template;
    this.searchPlaceholder = this.options.searchPlaceholder || _t('components.custom-list.placeholder', { typeLabel: this.options.typeLabel });
    this._initBinds();
  },

  render: function () {
    this.$el
      .empty()
      .append(
        this.template({
          query: this.model.get('query'),
          searchPlaceholder: this.searchPlaceholder
        })
      );
    return this;
  },

  _initBinds: function () {
    this.model.on('change:query', this._checkButtons, this);
  },

  _checkButtons: function () {
    var query = this.model.get('query');
    this.$('.js-clear').toggle(query.length > 0);
  },

  _onSearchType: function (e) {
    this._submit();
  },

  _onClickClear: function (e) {
    e.stopPropagation();
    this.model.set('query', '');
    this.render();
    this.focus();
  },

  focus: function () {
    this.$('.js-search').focus();
  },

  _submit: function (ev) {
    this.killEvent(ev);
    var query = this.$('.js-search').val();
    this.model.set('query', query);
  }
});

},{"./custom-list-search.tpl":56,"backbone/core-view":1127}],56:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeaderItem">\n  <input type="text" name="text" autocomplete="off" placeholder="'+
((__t=( searchPlaceholder ))==null?'':_.escape(__t))+
'" class="CDB-InputTextPlain CDB-Text js-search">\n  <button type="button" style="display:none" class="u-lSpace--xl js-clear">\n    <div class="CDB-Shape">\n      <div class="CDB-Shape-close is-blue is-large"></div>\n    </div>\n  </button>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],57:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var Ps = require('perfect-scrollbar');
var emptyTemplate = require('./custom-list-empty.tpl');
var addTemplate = require('./custom-list-add.tpl');
var template = require('./custom-list.tpl');
var ARROW_DOWN_KEY_CODE = 40;
var Utils = require('../../helpers/utils');
var ARROW_UP_KEY_CODE = 38;
var ENTER_KEY_CODE = 13;

module.exports = CoreView.extend({
  options: {
    size: 3
  },

  className: 'CDB-Text CDB-Size-medium CustomList-listWrapper',

  tagName: 'div',

  events: {
    'click .js-add-custom-value': '_onClickAddCustomValue'
  },

  initialize: function (opts) {
    this.options = _.extend({}, this.options, opts);
    this._onKeyDownBinded = this._onKeyDown.bind(this);
    this._needsMaxSize = true;
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this._removeArrowBinds();
    this._destroyCustomScroll();
    this.$el.empty();

    var query = this.model.get('query');
    var items = this.collection.search(query);

    this.$el.append(template());

    var allowFreeTextInput = this.options.allowFreeTextInput;
    var containsValue = !this.collection.containsValue(query);

    if (allowFreeTextInput && query && !Utils.isBlank(query) && containsValue) {
      this.$el.prepend(
        addTemplate({
          query: query,
          typeLabel: this.options.typeLabel
        })
      );
    }

    if (items.size() > 0) {
      items.each(this._renderItem, this);
      this._applyArrowBinds();
      // Perfect-scroll needs to have the element in the DOM in order to
      // style/positionate the scroll properly, small trick
      setTimeout(this._applyCustomScroll.bind(this), 0);
    } else if (!allowFreeTextInput || Utils.isBlank(query)) {
      this.$el.append(
        emptyTemplate({
          query: query,
          typeLabel: this.options.typeLabel
        })
      );
    }

    return this;
  },

  _renderItem: function (mdl) {
    var ItemViewClass = this.options.ItemView;
    var itemView = new ItemViewClass({
      model: mdl,
      typeLabel: this.options.typeLabel,
      template: this.options.itemTemplate
    });
    this.$('.js-list').append(itemView.render().el);
    this.addView(itemView);

    itemView.bind('customEvent', function (eventName, item) {
      this.trigger('customEvent', eventName, item, this);
    }, this);
  },

  _initBinds: function () {
    this.model.bind('change:query', this.render, this);
  },

  _applyArrowBinds: function () {
    document.addEventListener('keydown', this._onKeyDownBinded);
  },

  _removeArrowBinds: function () {
    document.removeEventListener('keydown', this._onKeyDownBinded);
  },

  _getSelected: function () {
    var selectedModel = this.collection.getSelectedItem();
    var selectedValue;

    if (selectedModel) {
      selectedValue = selectedModel.getValue();
      return this.$("[data-val='" + selectedValue + "']");
    }

    return null;
  },

  _highlightSelected: function (item) {
    var itemHeight = item.outerHeight();
    item.addClass('is-highlighted');
    this.$('.js-list').scrollTop(item.index() * itemHeight);
  },

  _onClickAddCustomValue: function (e) {
    this.killEvent(e);

    var query = this.model.get('query');

    var mdl = this.collection.add({
      val: query,
      label: '“' + query + '”'
    });

    this.collection.sortByKey('val');
    mdl.set('selected', true);
  },

  _onKeyDown: function (e) {
    if (this.model.get('visible') === false) {
      return;
    }

    var key = e.which;
    var $listItems = this.$('.js-listItem');
    var $highlighted = $listItems.filter('.is-highlighted');
    var $current;
    var mdl;

    $highlighted.removeClass('is-highlighted');

    if (key === ARROW_DOWN_KEY_CODE) {
      if (!$highlighted.length || $highlighted[0] === $listItems.last()[0]) {
        $current = $listItems.eq(0);
      } else {
        $current = $highlighted.next();
      }
    } else if (key === ARROW_UP_KEY_CODE) {
      if (!$highlighted.length || $highlighted[0] === $listItems.first()[0]) {
        $current = $listItems.last();
      } else {
        $current = $highlighted.prev();
      }
    } else if (key === ENTER_KEY_CODE) {
      e.preventDefault();
      if ($highlighted && $highlighted.length) {
        mdl = _.first(this.collection.where({ val: $highlighted.data('val') }));
        if (mdl) {
          mdl.set('selected', true);
        }
        return false;
      }
    }

    $current && this._highlightSelected($current);
  },

  _applyCustomScroll: function () {
    Ps.initialize(this._wrapperContainer().get(0), {
      wheelSpeed: 2,
      wheelPropagation: true,
      stopPropagationOnClick: false,
      minScrollbarLength: 20
    });
  },

  _destroyCustomScroll: function () {
    if (this._wrapperContainer().length > 0) {
      Ps.destroy(this._wrapperContainer().get(0));
    }
  },

  _wrapperContainer: function () {
    return this.$('.js-list');
  },

  clean: function () {
    this._removeArrowBinds();
    this._destroyCustomScroll();
    CoreView.prototype.clean.apply(this);
  },

  highlight: function () {
    var selected = this._getSelected();
    selected && this._highlightSelected(selected);
  }
});

},{"../../helpers/utils":1102,"./custom-list-add.tpl":46,"./custom-list-empty.tpl":48,"./custom-list.tpl":58,"backbone/core-view":1127,"perfect-scrollbar":"perfect-scrollbar","underscore":"underscore"}],58:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="CustomList-list js-list"></ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],59:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var CustomListCollection = require('./custom-list-collection');
var SearchView = require('./custom-list-search-view');
var CustomListView = require('./custom-list-view');
var itemTemplate = require('./custom-list-item.tpl');
var CustomListItemView = require('./custom-list-item-view');

/*
 *  A custom list with possibility to search within values.
 *
 *  It accepts a collection of (val, label) model attributes or a values array
 *  with the same content or only strings.
 *
 *  new CustomList({
 *    showSearch: false,
 *    itemTemplate: itemTemplate,
 *    values: [
 *      {
 *        val: 'hello',
 *        label: 'hi'
 *      }
 *    ]
 *  });
 */

module.exports = CoreView.extend({

  options: {
    showSearch: true,
    allowFreeTextInput: false,
    typeLabel: 'column',
    itemTemplate: itemTemplate,
    itemView: CustomListItemView
  },

  className: 'CDB-Box-modal CustomList',
  tagName: 'div',

  initialize: function (opts) {
    if (!opts.collection) {
      if (!opts.options) { throw new Error('options array {value, label} is required'); }
      this.collection = new CustomListCollection(opts.options);
    }

    if (opts.position) {
      this.$el.css(opts.position);
    }

    this.options = _.extend({}, this.options, opts);
    this.model = new Backbone.Model({
      query: '',
      visible: false
    });
    this._initBinds();
  },

  render: function () {
    this.$el.empty();
    this.clearSubViews();

    if (this.options.showSearch) {
      this._renderSearch();
    }
    this._renderList();

    if (this.options.showSearch) {
      this._focusSearch();
    }
    return this;
  },

  _initBinds: function () {
    this.model.bind('change:visible', function (mdl, isVisible) {
      this._resetQuery();
      this._toggleVisibility();

      if (!isVisible) {
        this.clearSubViews();
      } else {
        this.render();
      }
    }, this);
  },

  _renderSearch: function () {
    this._searchView = new SearchView({
      template: this.options.searchTemplate,
      typeLabel: this.options.typeLabel,
      searchPlaceholder: this.options.searchPlaceholder,
      model: this.model
    });
    this.$el.prepend(this._searchView.render().el);
    this.addView(this._searchView);
  },

  _focusSearch: function () {
    setTimeout(function () {
      this._searchView && this._searchView.focus();
    }.bind(this), 0);
  },

  _renderList: function () {
    this._listView = new CustomListView({
      model: this.model,
      allowFreeTextInput: this.options.allowFreeTextInput,
      collection: this.collection,
      typeLabel: this.options.typeLabel,
      ItemView: this.options.itemView,
      itemTemplate: this.options.itemTemplate,
      size: this.options.size
    });
    this.$el.append(this._listView.render().el);

    this._listView.highlight();
    this.addView(this._listView);

    this._listView.bind('customEvent', function (eventName, item) {
      this.trigger(eventName, item, this);
    }, this);
  },

  highlight: function () {
    this._listView.highlight();
  },

  _resetQuery: function () {
    this.model.set('query', '');
  },

  show: function () {
    this.model.set('visible', true);
  },

  hide: function () {
    this.trigger('hidden', this);
    this.model.set('visible', false);
  },

  toggle: function () {
    this.model.set('visible', !this.model.get('visible'));
  },

  _toggleVisibility: function () {
    this.$el.toggleClass('is-visible', !!this.model.get('visible'));
  },

  isVisible: function () {
    return this.model.get('visible');
  },

  remove: function () {
    this._listView && this._listView.clean();
    CoreView.prototype.remove.call(this);
  }
});

},{"./custom-list-collection":47,"./custom-list-item-view":50,"./custom-list-item.tpl":52,"./custom-list-search-view":55,"./custom-list-view":57,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],60:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var SQLNotifications = require('../../sql-notifications');
var SQLUtils = require('../../helpers/sql-utils');
var Notifier = require('../../components/notifier/notifier');
var cdb = require('cartodb.js');
var checkAndBuildOpts = require('../../helpers/required-opts');

var REQUIRED_OPTS = [
  'configModel',
  'editorModel',
  'layerDefinitionModel',
  'querySchemaModel'
];

module.exports = CoreView.extend({

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._clearSQLModel = new Backbone.Model({
      visible: false
    });

    this._sqlModel = this._layerDefinitionModel.sqlModel;

    this._SQL = new cdb.SQL({
      user: this._configModel.get('user_name'),
      sql_api_template: this._configModel.get('sql_api_template'),
      api_key: this._configModel.get('api_key')
    });

    this._codemirrorModel = new Backbone.Model({
      content: this._querySchemaModel.get('query'),
      readonly: false
    });

    SQLNotifications.track(this);
  },

  _internalParseSQL: function (callbackAfterAlterSuccess) {
    var appliedQuery = this._querySchemaModel.get('query');
    var currentQuery = this._codemirrorModel.get('content');

    // Remove last character if it has ';'
    if (currentQuery && currentQuery.slice(-1) === ';') {
      currentQuery = currentQuery.slice(0, currentQuery.length - 1);
      this._codemirrorModel.set('content', currentQuery);
    }

    var isSameQuery = SQLUtils.isSameQuery(currentQuery, appliedQuery);
    var altersData = SQLUtils.altersData(currentQuery);

    if (currentQuery === '' || isSameQuery) {
      SQLNotifications.removeNotification();
      return false;
    }

    if (altersData) {
      SQLNotifications.showNotification({
        status: 'loading',
        info: _t('notifications.sql.alter-loading'),
        closable: false
      });

      this._sqlModel.set('content', currentQuery);

      this._SQL.execute(currentQuery, null, {
        success: function () {
          SQLNotifications.showNotification({
            status: 'success',
            info: _t('notifications.sql.alter-success'),
            closable: true,
            delay: Notifier.DEFAULT_DELAY
          });
          this._applyDefaultSQLAfterAlteringData();
          if (typeof callbackAfterAlterSuccess === 'function') {
            callbackAfterAlterSuccess.call(this);
          }
        }.bind(this),
        error: function (errors) {
          errors = errors.responseJSON.error;
          var parsedErrors = this._parseErrors(errors);
          this._codemirrorModel.set('errors', parsedErrors);
          SQLNotifications.showErrorNotification(parsedErrors);
          this._checkClearButton();
        }.bind(this)
      });
    } else {
      this._runQuery(currentQuery, this._saveSQL.bind(this));
    }
  },

  _checkClearButton: function () {
    var customSql = this._codemirrorModel.get('content');
    var isDefaultQuery = SQLUtils.isSameQuery(customSql, this._defaultSQL());
    this._clearSQLModel.set({ visible: !isDefaultQuery });
  },

  _applyDefaultSQLAfterAlteringData: function () {
    var originalQuery = this._defaultSQL();
    this._codemirrorModel.set({
      content: originalQuery,
      errors: []
    });
    this._sqlModel.set('content', originalQuery);
    this._querySchemaModel.set('query_errors', []);
    this._clearSQLModel.set({ visible: false });
    this._querySchemaModel.resetDueToAlteredData();
    this._clearSQL();
  },

  _clearSQL: function () {
    var originalQuery = this._defaultSQL();
    this._codemirrorModel.set({
      content: originalQuery,
      errors: []
    });
    this._runQuery(originalQuery, this._saveSQL.bind(this));
  },

  _showErrors: function (model) {
    var errors = this._querySchemaModel.get('query_errors');
    var hasErrors = errors && errors.length > 0;
    this._codemirrorModel.set('errors', this._parseErrors(errors));
    this._editorModel.set('disabled', hasErrors);

    if (hasErrors) {
      SQLNotifications.showErrorNotification(this._parseErrors(errors));
    }

    this._checkClearButton();
  },

  _parseErrors: function (errors) {
    return errors.map(function (error) {
      return {
        message: error
      };
    });
  }
});

},{"../../components/notifier/notifier":475,"../../helpers/required-opts":1097,"../../helpers/sql-utils":1099,"../../sql-notifications":1118,"backbone":"backbone","backbone/core-view":1127,"cartodb.js":"cartodb.js"}],61:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form class="DatePicker-timers">\n  <div class="DatePicker-timersField u-rSpace--xl">\n    <div class="DatePicker-timersInput" data-fields="fromHour"></div>\n  </div>\n  <div class="DatePicker-timersField u-rSpace--xl">\n    <div class="DatePicker-timersInput" data-fields="fromMin"></div>\n  </div>\n  <div class="DatePicker-timersField DatePicker-timersField--spaced u-rSpace--xl">\n    <div class="DatePicker-timersInput" data-fields="toHour"></div>\n  </div>\n  <div class="DatePicker-timersField">\n    <div class="DatePicker-timersInput" data-fields="toMin"></div>\n  </div>\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],62:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var moment = require('moment');
var $ = require('jquery');
var Utils = require('../../helpers/utils');
require('../form-components/index');
require('datepicker');
var datePickerTemplate = require('./date-picker-range-form.tpl');
var template = require('./date-picker-range.tpl');
var MAX_RANGE = 30;

/**
 * Custom picer for a dates range.
 */
module.exports = CoreView.extend({

  className: 'DatePicker',

  options: {
    flat: true,
    date: ['2008-07-31', '2008-07-31'],
    current: '2008-07-31',
    calendars: 2,
    mode: 'range',
    starts: 1
  },

  events: {
    'click .js-dates': '_toggleCalendar',
    'click .js-fourHours': '_setLastFourHours',
    'click .js-oneDay': '_setLastDay',
    'click .js-oneWeek': '_setLastWeek'
  },

  initialize: function (opts) {
    this.model = new Backbone.Model({
      fromDate: '',
      fromHour: 0,
      fromMin: 0,
      toDate: '',
      toHour: 23,
      toMin: 59,
      user_timezone: 0 // Explained as GMT+0
    });

    this.template = opts.template || template;
    this._initBinds();
    this._setDefaultDate();
  },

  render: function () {
    var self = this;

    this.clearSubViews();

    this.$el.append(
      this.template(
        _.extend(
          this.model.attributes,
          {
            max_days: MAX_RANGE,
            pad: Utils.pad
          }
        )
      )
    );

    setTimeout(function () {
      self._initCalendar();
      self._hideCalendar();
      self._initTimers();
    }, 100);

    return this;
  },

  _initBinds: function () {
    this.model.bind('change', this._setValues, this);
    this.model.bind('change', this._onValuesChange, this);
    $(document).bind('click', this._onDocumentClick.bind(this));
  },

  _destroyBinds: function () {
    $(document).unbind('click', this._onDocumentClick.bind(this));
  },

  _setValues: function (m, c) {
    var text = _t('components.datepicker.dates-placeholder');
    var data = this.model.attributes;

    if (data.fromDate && data.toDate) {
      text =
        _t('components.datepicker.from') + ' ' +
        '<strong>' +
        this.model.get('fromDate') + ' ' +
        (Utils.pad(this.model.get('fromHour'), 2) + ':' + Utils.pad(this.model.get('fromMin'), 2)) +
        '</strong>' +
        ' ' + _t('components.datepicker.to') + ' ' +
        '<strong>' +
        this.model.get('toDate') + ' ' +
        (Utils.pad(this.model.get('toHour'), 2) + ':' + Utils.pad(this.model.get('toMin'), 2)) +
        '</strong>' +
        '<i class="CDB-IconFont CDB-IconFont-calendar DatePicker-datesIcon"></i>';
    }

    this.$('.DatePicker-dates').html(text);
  },

  _setDefaultDate: function () {
    var datesUTC = this.model.get('user_timezone');
    var today = moment().utc(datesUTC);
    var previous = moment().utc(datesUTC).subtract((MAX_RANGE - 1), 'days');
    this.options.date = [previous.format('YYYY-MM-DD'), today.format('YYYY-MM-DD')];
    this.options.current = today.format('YYYY-MM-DD');
    this._setModelFromPrevious(previous);
  },

  _initCalendar: function () {
    var selector = '.DatePicker-calendar';

    // Can't initialize calendar if not already present in document... avoid errors being thrown
    if (!document.body.contains(this.$(selector)[0])) return;

    this.calendar = this.$(selector).DatePicker(
      _.extend(this.options, {
        onChange: this._onDatesChange.bind(this),
        onRender: function (d) { // Disable future dates and dates < MAX_RANGE days ago
          var date = d.valueOf();
          var now = new Date();

          var thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(now.getDate() - MAX_RANGE);

          return (date < thirtyDaysAgo) || (date > now) ? { disabled: true } : '';
        }
      })
    );
  },

  _onDatesChange: function (formatted, dates) {
    // Check if selected dates have more than MAX_RANGE days
    var start = moment(formatted[0]);
    var end = moment(formatted[1]);

    if (Math.abs(start.diff(end, 'days')) > MAX_RANGE) {
      formatted[1] = moment(formatted[0]).add('days', MAX_RANGE).format('YYYY-MM-DD');
      this.$('.DatePicker-calendar').DatePickerSetDate([formatted[0], formatted[1]]);
    }

    this.model.set({
      fromDate: formatted[0],
      toDate: formatted[1]
    });
  },

  _hideCalendar: function (e) {
    if (e) this.killEvent(e);
    this.$('.DatePicker-dropdown').hide();
  },

  _toggleCalendar: function (ev) {
    if (ev) this.killEvent(ev);
    this.$('.DatePicker-dropdown').toggle();
  },

  _setLastFourHours: function () {
    var previous = moment().utc(0).subtract(4, 'hours');
    this._setModelFromPrevious(previous);
    this._setDatepickerFromPrevious(previous);
    this.closeCalendar();
  },

  _setLastDay: function () {
    var previous = moment().utc(0).subtract(1, 'day');
    this._setModelFromPrevious(previous);
    this._setDatepickerFromPrevious(previous);
    this.closeCalendar();
  },

  _setLastWeek: function () {
    var previous = moment().utc(0).subtract(1, 'week');
    this._setModelFromPrevious(previous);
    this._setDatepickerFromPrevious(previous);
    this.closeCalendar();
  },

  _setModelFromPrevious: function (previous) {
    var today = moment().utc(0);

    this.model.set({
      fromDate: previous.format('YYYY-MM-DD'),
      fromHour: parseInt(previous.format('H'), 10),
      fromMin: parseInt(previous.format('m'), 10),
      toDate: today.format('YYYY-MM-DD'),
      toHour: parseInt(today.format('H'), 10),
      toMin: parseInt(today.format('m'), 10)
    });
  },

  _setDatepickerFromPrevious: function (previous) {
    var today = moment().utc(0);
    this.$('.DatePicker-calendar').DatePickerSetDate([ previous.format('YYYY-MM-DD'), today.format('YYYY-MM-DD') ]);
  },

  _initTimers: function () {
    var generateNumberType = function (min, max) {
      var title = max === 23
        ? _t('components.datepicker.hour')
        : _t('components.datepicker.min');
      return {
        type: 'Number',
        title: title,
        validators: ['required', {
          type: 'interval',
          min: min,
          max: max
        }]
      };
    };

    this.model.schema = {
      fromHour: generateNumberType(0, 23),
      fromMin: generateNumberType(0, 59),
      toHour: generateNumberType(0, 23),
      toMin: generateNumberType(0, 59)
    };

    this._datesForm = new Backbone.Form({
      model: this.model,
      template: datePickerTemplate
    });

    this._datesForm.bind('change', function () {
      this.commit();
    });
    this.$('.js-timers').append(this._datesForm.render().el);
  },

  _onValuesChange: function () {
    this.trigger('changeDate', this.model.toJSON(), this);
  },

  getDates: function () {
    return this.model.toJSON();
  },

  closeCalendar: function () {
    this.$('.DatePicker-dropdown').hide();
  },

  _onDocumentClick: function (e) {
    var $el = $(e.target);

    if ($el.closest('.DatePicker').length === 0) {
      this.closeCalendar();
    }
  },

  clean: function () {
    this._datesForm.remove();
    this._destroyBinds();
    this.closeCalendar();
    this.$('.DatePicker-calendar').DatePickerHide();
    CoreView.prototype.clean.call(this);
  }

});

},{"../../helpers/utils":1102,"../form-components/index":211,"./date-picker-range-form.tpl":61,"./date-picker-range.tpl":63,"backbone":"backbone","backbone/core-view":1127,"datepicker":1133,"jquery":"jquery","moment":"moment","underscore":"underscore"}],63:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button class="DatePicker-dates js-dates has-icon CDB-Text CDB-Size-medium">\n  '+
((__t=( _t('components.datepicker.from') ))==null?'':_.escape(__t))+
' <strong>'+
((__t=( fromDate ))==null?'':_.escape(__t))+
' '+
((__t=( pad(fromHour,2) ))==null?'':_.escape(__t))+
':'+
((__t=( pad(fromMin,2) ))==null?'':_.escape(__t))+
'</strong> '+
((__t=( _t('components.datepicker.to') ))==null?'':_.escape(__t))+
' <strong>'+
((__t=( toDate ))==null?'':_.escape(__t))+
' '+
((__t=( pad(toHour,2) ))==null?'':_.escape(__t))+
':'+
((__t=( pad(toMin,2) ))==null?'':_.escape(__t))+
'</strong>\n  <i class="CDB-IconFont CDB-IconFont-calendar DatePicker-datesIcon"></i>\n</button>\n<div class="DatePicker-dropdown CDB-Text">\n  <div class="DatePicker-calendar"></div>\n  <div class="DatePicker-timers js-timers"></div>\n  <div class="DatePicker-shortcuts">\n    <p class="DatePicker-shortcutsText">\n      '+
((__t=( _t('components.datepicker.get-last') ))==null?'':_.escape(__t))+
' <button type="button" class="Button--link js-fourHours">'+
((__t=( _t('components.datepicker.hours-pluralize', { smart_count: 4 }) ))==null?'':_.escape(__t))+
'</button>,\n      <button type="button" class="Button--link js-oneDay">'+
((__t=( _t('components.datepicker.days-pluralize', { smart_count: 1 }) ))==null?'':_.escape(__t))+
'</button> '+
((__t=( _t('components.datepicker.or') ))==null?'':_.escape(__t))+
'\n      <button type="button" class="Button--link js-oneWeek">'+
((__t=( _t('components.datepicker.weeks-pluralize', { smart_count: 1 }) ))==null?'':_.escape(__t))+
'</button>\n    </p>\n    <p class="DatePicker-shortcutsText">'+
((__t=( _t('components.datepicker.gmt-convertion') ))==null?'':_.escape(__t))+
'</p>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],64:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var moment = require('moment');
var $ = require('jquery');
require('../form-components/index');
require('datepicker');
var template = require('./date-picker.tpl');

/**
 * Custom picer for a dates range.
 */
module.exports = CoreView.extend({

  className: 'DatePicker',

  options: {
    flat: true,
    date: '2008-07-31',
    current: '2008-07-31',
    calendars: 1,
    starts: 1
  },

  events: {
    'click .js-dates': '_toggleCalendar'
  },

  initialize: function (opts) {
    this.template = opts.template || template;
    this._initBinds();
    this._setDefaultDate();
  },

  render: function () {
    this.clearSubViews();

    this.$el.append(this.template({
      readOnly: this.model.get('readOnly'),
      date: this.options.date
    }));

    if (this.model.get('readOnly')) {
      this.undelegateEvents();
    }

    return this;
  },

  _initBinds: function () {
    $(document).bind('click', this._onDocumentClick.bind(this));
  },

  _destroyBinds: function () {
    $(document).unbind('click', this._onDocumentClick.bind(this));
  },

  _setDefaultDate: function () {
    var utc = new Date().getTimezoneOffset();
    var today = moment(new Date()).utcOffset(utc).format('YYYY-MM-DD');
    this.options.date = this.model.get('value') && moment(this.model.get('value')).format('YYYY-MM-DD') || today;
    this.options.current = this.options.date;
  },

  _$calendar: function () {
    return this.$('.js-calendar');
  },

  _$dropdown: function () {
    return this.$('.js-DatePicker-simpleDropdown');
  },

  _hideCalendar: function (ev) {
    if (ev) {
      this.killEvent(ev);
    }
    this.model.set('visible', false);
    this._destroyCalendar();
    this._$dropdown().hide();
  },

  _showCalendar: function () {
    this.model.set('visible', true);

    this._$calendar().DatePicker(
      _.extend(this.options, this.model.attributes, {
        onChange: function (formatted, date) {
          this.model.set('value', formatted);
          this.$('.js-date-str').text(formatted);
          this._hideCalendar();
        }.bind(this),
        onRender: function (d) { // Disable future dates and dates
          var date = d.valueOf();
          var now = new Date();

          return (date > now) ? { disabled: true } : '';
        }
      })
    );

    this._$dropdown().show();
  },

  _destroyCalendar: function () {
    if (this.$('.DatePicker').length > 0) {
      this._$calendar() && this._$calendar().DatePickerHide();
    }
  },

  _toggleCalendar: function (ev) {
    if (ev) {
      this.killEvent(ev);
    }

    this.model.get('visible') ? this._hideCalendar() : this._showCalendar();
  },

  closeCalendar: function () {
    this._hideCalendar();
  },

  _onDocumentClick: function (e) {
    var $el = $(e.target);

    if ($el.closest('.DatePicker').length === 0) {
      this._hideCalendar();
    }
  },

  clean: function () {
    this._destroyBinds();
    this._hideCalendar();
    CoreView.prototype.clean.call(this);
  }

});

},{"../form-components/index":211,"./date-picker.tpl":65,"backbone/core-view":1127,"datepicker":1133,"jquery":"jquery","moment":"moment","underscore":"underscore"}],65:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button class="js-dates DatePicker-dates DatePicker-dates--singleDate js-DatePicker-dates has-icon ';
 if (readOnly) { 
__p+=' is-disabled ';
 } 
__p+='">\n  <strong class="js-date-str">'+
((__t=( date ))==null?'':_.escape(__t))+
'</strong>\n  <i class="CDB-IconFont CDB-IconFont-calendar DatePicker-datesIcon"></i>\n</button>\n<div class="DatePicker-simpleDropdown datepickerHidden js-DatePicker-simpleDropdown">\n  <div class="js-calendar DatePicker-calendar DatePicker-calendar--simple"></div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],66:[function(require,module,exports){
var Backbone = require('backbone');
var moment = require('moment');

/**
 *  Default model for each field model
 *
 */

module.exports = Backbone.Model.extend({

  defaults: {
    attribute: '',
    value: '',
    type: 'string',
    readOnly: false
  },

  initialize: function () {
    // Validation control variable
    this.validationError = '';
    this.bind('valid', function () {
      this.validationError = '';
    }, this);
    this.bind('error', function (m, error) {
      this.validationError = error;
    });
  },

  _validate: function (attrs, options) {
    var valid = Backbone.Model.prototype._validate.apply(this, arguments);
    if (valid) {
      this.trigger('valid');
      return true;
    } else {
      return false;
    }
  },

  validate: function (attrs) {
    if (!attrs) return;

    var val = attrs.value;
    var type = attrs.type;

    if (attrs.type === 'number') {
      var pattern = /^(\+|-)?(?:[0-9]+|[0-9]*\.[0-9]+)$/;
      if (val && !pattern.test(val)) {
        return 'Invalid number';
      }
    }

    if (type === 'boolean') {
      if (val !== null && val !== true && val !== false) {
        return 'Invalid boolean';
      }
    }

    if (type === 'date') {
      if (val && !moment(val).isValid()) {
        return 'Invalid date';
      }
    }
  },

  getError: function () {
    return this.validationError;
  },

  isValid: function () {
    if (!this.validate) {
      return true;
    }
    return !this.validate(this.attributes) && this.validationError === '';
  }

});

},{"backbone":"backbone","moment":"moment"}],67:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var cdb = require('cartodb.js');
var baseTemplate = require('./error.tpl');

/**
 * A typical error view.
 * @param {Object} options
 * @param {String} options.title If not provided will use a generic text as fallback
 * @param {String} options.desc If not provied will use a generic text as fallback
 */
module.exports = CoreView.extend({

  className: 'IntermediateInfo',

  initialize: function (opts) {
    var attrs = _.defaults(
      _.pick(opts, ['title', 'desc']),
      {
        title: _t('components.error.default-title'),
        desc: _t('components.error.default-desc')
      }
    );
    this._template = this.options && this.options.template || baseTemplate;
    this.model = new Backbone.Model(attrs);
  },

  render: function () {
    this.$el.html(this._html());
    return this;
  },

  _html: function () {
    var m = this.model;
    return this._template({
      title: m.get('title'),
      desc: cdb.core.sanitize.html(m.get('desc'))
    });
  }
});

},{"./error.tpl":68,"backbone":"backbone","backbone/core-view":1127,"cartodb.js":"cartodb.js","underscore":"underscore"}],68:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="LayoutIcon LayoutIcon--negative">\n  <i class="CDB-IconFont CDB-IconFont-cockroach"></i>\n</div>\n<h3 class="CDB-Text CDB-Size-large u-mainTextColor u-errorTextColor u-bSpace--m u-tSpace-xl">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h3>\n<p class="CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( desc ))==null?'':__t)+
'</p>\n';
}
return __p;
};

},{"underscore":"underscore"}],69:[function(require,module,exports){
var Backbone = require('backbone');
var $ = require('jquery');
var ESC_KEY_CODE = 27;

Backbone.Form.editors.Base = Backbone.Form.editors.Base.extend({

  applyESCBind: function (callback) {
    this._ESCBindCallback = callback;
    document.addEventListener('keydown', this._onKeyDown.bind(this));
  },

  _onKeyDown: function (ev) {
    var anyModalOpen;
    if (ev.which === ESC_KEY_CODE) {
      anyModalOpen = this._anyModalOpen();
      !anyModalOpen && this._ESCBindCallback();
    }
  },

  applyClickOutsideBind: function (callback) {
    this._clickBindCallback = callback;
    this.$el.attr('data-cid', this.cid);
    document.addEventListener('click', this._onDocumentClick.bind(this));
  },

  _onDocumentClick: function (e) {
    var $el = $(e.target);
    var anyModalOpen = this._anyModalOpen();
    if ($el.closest('[data-cid="' + this.cid + '"]').length === 0 && !anyModalOpen) {
      this._clickBindCallback();
    }
  },

  _anyModalOpen: function () {
    var modals = this.options.modals;
    if (!modals) {
      return false;
    }

    return modals.isOpen();
  },

  remove: function () {
    if (this._ESCBindCallback) {
      document.removeEventListener('keydown', this._onKeyDown.bind(this));
    }
    if (this._clickBindCallback) {
      document.removeEventListener('click', this._onDocumentClick.bind(this));
    }
    Backbone.View.prototype.remove.call(this);
  }

});

},{"backbone":"backbone","jquery":"jquery"}],70:[function(require,module,exports){
var $ = require('jquery');
var Backbone = require('backbone');
var FactoryHints = require('../../../editor/editor-hints/factory-hints');
var CodeMirrorView = require('../../code-mirror/code-mirror-view');

Backbone.Form.editors.CodeEditor = Backbone.Form.editors.TextArea.extend({
  render: function () {
    this.setValue(this.value);

    this._codemirrorModel = new Backbone.Model({
      content: this.value,
      readonly: false,
      lineNumbers: false
    });

    FactoryHints.init({
      tokens: this.options.tokens,
      tableName: false,
      columnsName: false
    });

    this._initViews();

    this._toggleDisableState();

    return this;
  },

  getValue: function () {
    var val = this.$el.val();

    val = this.codeMirrorView.getContent();

    return (val === '') ? null : val;
  },

  _initViews: function () {
    this._destroyEditor();

    var hints = FactoryHints.reset().hints;
    this.codeMirrorView = new CodeMirrorView({
      model: this._codemirrorModel,
      hints: hints,
      mode: 'text/mustache',
      autocompleteChars: 2,
      autocompletePrefix: '{{',
      autocompleteSuffix: '}}',
      placeholder: this.options.placeholder,
      tip: ''
    });
    this.codeMirrorView.bind('codeChanged', function () {
      this.trigger('change', this.codeMirrorView.getContent());
    }, this);

    var $codeMirrorEl = $(this.codeMirrorView.render().el);
    this.$el.replaceWith($codeMirrorEl);
    this.setElement($codeMirrorEl);
    this.$el.addClass('CodeMirror-formInput');
    // The default el is replace it with another dom node
    // we should add tracking class manually again
    this._addTrackingClass();
  },

  _addTrackingClass: function () {
    if (this.options.trackingClass) {
      var trackClasses = this.options.trackingClass + ' track-' + this.options.key + this.options.editorType;
      this.$el.addClass(trackClasses);
    }
  },

  _hasEditor: function () {
    return this.options.editor && !!this.codeMirrorView;
  },

  _destroyEditor: function () {
    if (this._hasEditor()) {
      this.codeMirrorView.remove();
    }
  },

  remove: function () {
    this._destroyEditor();
    Backbone.Form.editors.Base.prototype.remove.apply(this);
  },

  clean: function () {
    this.$el.remove();
  }
});

},{"../../../editor/editor-hints/factory-hints":700,"../../code-mirror/code-mirror-view":27,"backbone":"backbone","jquery":"jquery"}],71:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var checkAndBuildOpts = require('../../../../helpers/required-opts');
var StackLayoutView = require('../../../../components/stack-layout/stack-layout-view');
var MeasurementsView = require('./measurement-list-view');
var FiltersView = require('./filter-list-view');

var REQUIRED_OPTS = [
  'measurementsCollection',
  'filtersCollection'
];

module.exports = CoreView.extend({
  className: 'CDB-Box-modal CustomList',

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    // For internal state
    this.model = new Backbone.Model({
      visible: false
    });

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._generateStackLayoutView();
    return this;
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:visible', function (mdl, isVisible) {
      isVisible ? this.render() : this.clearSubViews();
      this._toggleVisibility();
    });
  },

  _generateStackLayoutView: function () {
    var self = this;

    var stackViewCollection = new Backbone.Collection([{
      createStackView: function (stackLayoutModel, opts) {
        return self._createListView(stackLayoutModel, opts).bind(self);
      }
    }, {
      createStackView: function (stackLayoutModel, opts) {
        return self._createFilterView(stackLayoutModel, opts).bind(self);
      }
    }]);

    this._stackLayoutView = new StackLayoutView({ collection: stackViewCollection });
    this.addView(this._stackLayoutView);
    this.$el.append(this._stackLayoutView.render().$el);
  },

  _createListView: function (stackLayoutModel, opts) {
    var view = new MeasurementsView({
      measurementsCollection: this._measurementsCollection,
      filtersCollection: this._filtersCollection
    });

    view.bind('filters', function () {
      stackLayoutModel.nextStep();
    }, this);

    return view;
  },

  _createFilterView: function (stackLayoutModel, opts) {
    var view = new FiltersView({
      filtersCollection: this._filtersCollection
    });

    view.bind('back', function () {
      stackLayoutModel.prevStep();
    }, this);

    return view;
  },

  hide: function () {
    this.model.set('visible', false);
  },

  toggle: function () {
    this.model.set('visible', !this.model.get('visible'));
  },

  isVisible: function () {
    return this.model.get('visible');
  },

  _toggleVisibility: function () {
    this.$el.toggleClass('is-visible', !!this.isVisible());
  },

  clean: function () {
    // Other ops here
    CoreView.prototype.clean.apply(this, arguments);
  }
});

},{"../../../../components/stack-layout/stack-layout-view":533,"../../../../helpers/required-opts":1097,"./filter-list-view":77,"./measurement-list-view":82,"backbone":"backbone","backbone/core-view":1127}],72:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (typeof isLoading != 'undefined' && isLoading) { 
__p+='\n  <div class="u-flex">\n    <div class="CDB-LoaderIcon CDB-LoaderIcon--small is-dark">\n      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n      </svg>\n    </div>\n    <span class="u-lSpace u-secondaryTextColor">'+
((__t=( _t('components.backbone-forms.select.loading') ))==null?'':_.escape(__t))+
'</span>\n  </div>\n';
 } else { 
__p+='\n  '+
((__t=( label ))==null?'':_.escape(__t))+
'\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],73:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var template = require('./dropdown.tpl');
var selectedItemTemplate = require('./dropdown-item.tpl');
var DropdownDialogView = require('./dropdown-dialog-view');
var PopupManager = require('../../../popup-manager');
var MeasurementsCollection = require('./measurements-collection');
var FiltersCollection = require('./measurements-filters-collection');

var ENTER_KEY_CODE = 13;
var STATE = {
  idle: 'idle',
  loading: 'loading',
  fetching: 'fetching',
  fetched: 'fetched',
  error: 'error'
};

Backbone.Form.editors.DataObservatoryDropdown = Backbone.Form.editors.Base.extend({

  tagName: 'div',
  className: 'u-ellipsis Editor-formSelect',

  events: {
    'click .js-button': '_onButtonClick',
    'keydown .js-button': '_onButtonKeyDown',
    'focus .js-button': function () {
      this.trigger('focus', this);
    },
    'blur': function () {
      this.trigger('blur', this);
    }
  },

  options: {
    selectedItemTemplate: selectedItemTemplate
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    this.template = opts.template || template;
    this.dialogMode = this.options.dialogMode || 'nested';

    var collectionOptions = {
      configModel: this.options.configModel,
      layerDefinitionModel: this.options.layerDefinitionModel,
      country: this.model.get('country') || null
    };

    this.measurementsCollection = new MeasurementsCollection([], collectionOptions);
    this.filtersCollection = new FiltersCollection([], collectionOptions);

    this._modelView = new Backbone.Model({
      state: STATE.idle
    });

    this._initBinds();

    this._dialogView = new DropdownDialogView({
      measurementsCollection: this.measurementsCollection,
      filtersCollection: this.filtersCollection
    });

    this._fetch();
  },

  render: function () {
    var isLoading = this._isLoading();
    var isEmpty = !this._hasItems();
    var isDisabled = !isEmpty ? this.options.disabled : true;
    var name = this.model.get(this.options.keyAttr);
    var item = this.measurementsCollection.getItem(name);
    var isNull = name === null;
    var label = isNull ? 'null' : (item ? item.get('name') : false);
    var placeholder = this.options.placeholder;

    this.$el.html(
      this.template({
        label: label,
        keyAttr: this.options.keyAttr,
        placeholder: placeholder,
        isDisabled: isDisabled,
        isLoading: isLoading,
        isEmpty: isEmpty,
        isNull: isNull
      })
    );

    this._popupManager = new PopupManager(this.cid, this.$el, this._dialogView.$el);
    this._popupManager.append(this.dialogMode);

    return this;
  },

  _initBinds: function () {
    var hide = function () {
      this._dialogView.hide();
      this._popupManager.untrack();
    }.bind(this);

    this.applyESCBind(hide);
    this.applyClickOutsideBind(hide);

    this.listenTo(this.measurementsCollection, 'change:selected', this._onItemSelected);
    this.listenTo(this._modelView, 'change:state', this.render);
    this.listenTo(this.model, 'change:country', this._fetch);
  },

  _fetch: function () {
    var fetchOptions = {
      success: this._onFetchSuccess.bind(this),
      error: this._onFetchError.bind(this)
    };

    this.measurementsCollection.fetch(fetchOptions);
    this.filtersCollection.fetch(fetchOptions);
    this._modelView.set({state: STATE.loading});

    this.setValue(this.model.get(this.options.keyAttr));
  },

  _onFetchSuccess: function () {
    var measurementsReady = this.measurementsCollection.getState() === STATE.fetched;
    var filtersReady = this.filtersCollection.getState() === STATE.fetched;

    if (filtersReady && measurementsReady) {
      this._modelView.set({state: STATE.fetched});
    }
  },

  _onFetchError: function () {
    this._modelView.set({state: STATE.error});
  },

  _hasItems: function () {
    var state = this.measurementsCollection.getState();
    return state === STATE.fetched && this.measurementsCollection.filter(function (mdl) {
      var filter = mdl.get('filter');
      return filter.length > 0;
    }).length > 0;
  },

  _isLoading: function () {
    var state = this.measurementsCollection.getState();
    return state === STATE.fetching;
  },

  _onItemSelected: function (mdl) {
    this._dialogView.hide();
    this._popupManager.untrack();
    this._renderButton(mdl).focus();
    this.trigger('change', this);
  },

  _onButtonClick: function () {
    if (this._hasItems()) {
      this._dialogView.toggle();
      this._dialogView.isVisible() ? this._popupManager.track() : this._popupManager.untrack();
    }
  },

  _onButtonKeyDown: function (ev) {
    if (ev.which === ENTER_KEY_CODE) {
      ev.preventDefault();
      if (!this._dialogView.isVisible()) {
        ev.stopPropagation();
        this._onButtonClick();
      } else {
        this._popupManager.track();
      }
    }
  },

  getValue: function () {
    var item = this.measurementsCollection.getSelectedItem();
    if (item) {
      return item.getName();
    }
    return;
  },

  setValue: function (value) {
    var selectedModel = this.measurementsCollection.setSelected(value);
    if (selectedModel) {
      this._renderButton(selectedModel);
    }
    this.value = value;
  },

  _renderButton: function (mdl) {
    var button = this.$('.js-button');
    var $html = this.options.selectedItemTemplate({
      label: mdl.getName()
    });

    button
      .removeClass('is-empty')
      .html($html);

    return button;
  },

  remove: function () {
    this._popupManager && this._popupManager.destroy();
    this._dialogView && this._dialogView.clean();
    Backbone.Form.editors.Base.prototype.remove.call(this);
  }

});

},{"../../../popup-manager":522,"../editor-helpers-extend":92,"./dropdown-dialog-view":71,"./dropdown-item.tpl":72,"./dropdown.tpl":74,"./measurements-collection":84,"./measurements-filters-collection":85,"backbone":"backbone"}],74:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-InputText CDB-Text is-cursor js-button u-ellipsis\n  ';
 if (isDisabled) { 
__p+=' is-disabled ';
 } 
__p+='\n  ';
 if (!label) { 
__p+=' is-empty ';
 } 
__p+='\n  ';
 if (isNull) { 
__p+=' is-empty ';
 } 
__p+='"\n  tabindex="0">\n  ';
 if (isLoading) { 
__p+='\n    <div class="CDB-LoaderIcon CDB-LoaderIcon--small is-dark u-iBlock">\n      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n      </svg>\n    </div>\n    <span class="u-lSpace u-secondaryTextColor">'+
((__t=( _t('components.backbone-forms.select.loading') ))==null?'':_.escape(__t))+
'</span>\n  ';
 } else { 
__p+='\n    ';
 if (isEmpty) { 
__p+='\n      '+
((__t=( _t('components.backbone-forms.select.empty') ))==null?'':_.escape(__t))+
'\n    ';
 } else { 
__p+='\n      '+
((__t=( placeholder || label || _t('components.backbone-forms.select.placeholder', { keyAttr: keyAttr }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  ';
 } 
__p+='\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],75:[function(require,module,exports){
var _ = require('underscore');
var CustomListMultiItemView = require('../../../custom-list/custom-list-multi-item-view');

var NAME = _.template('<%-name %> (<%- items %>)');

module.exports = CustomListMultiItemView.extend({
  render: function () {
    this.clearSubViews();
    this.$el.empty();

    var name = this.model.getName() == null ? 'null' : this.model.getName();
    name = name.replace(/"/g, '');

    this.$el.append(
      this.options.template(
        _.extend({
          isSelected: this.model.get('selected'),
          isDisabled: this.model.get('disabled'),
          name: NAME({
            name: name,
            items: this.model.get('items')
          }),
          val: this.model.getValue(),
          description: this.model.get('description')
        })
      )
    );

    this.$el
      .attr('data-val', this.model.getValue())
      .toggleClass('is-disabled', !!this.model.get('disabled'));

    return this;
  }
});

},{"../../../custom-list/custom-list-multi-item-view":54,"underscore":"underscore"}],76:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button type="button" class="CDB-ListDecoration-itemLink\n  ';
 if (isSelected) { 
__p+=' is-selected ';
 } 
__p+='\n  " title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">\n  <div class="u-flex">\n    <div class="u-iBlock u-rSpace--m">\n      <input class="CDB-Checkbox js-input" type="checkbox" name="" value="" ';
 if (isSelected) { 
__p+='checked';
 } 
__p+=' ';
 if (isDisabled) { 
__p+='disabled';
 } 
__p+=' />\n      <span class="u-iBlock CDB-Checkbox-face"></span>\n    </div>\n    <div>\n      <div class="u-bSpace">'+
((__t=( name ))==null?'':_.escape(__t))+
'</div>\n      <div class="CDB-Size-small u-altTextColor">'+
((__t=( description ))==null?'':_.escape(__t))+
'</div>\n    </div>\n  </div>\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],77:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var CustomListView = require('../../../custom-list/custom-view');
var CustomListItemView = require('./filter-list-item-view');
var itemListTemplate = require('./filter-list-item.tpl');
var template = require('./filter-list-view.tpl');
var checkAndBuildOpts = require('../../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'filtersCollection'
];

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_onClickBack'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._initBinds();

    this._listView = new CustomListView({
      className: 'DO-Filters',
      typeLabel: _t('components.backbone-forms.data-observatory.dropdown.filter.filters'),
      showSearch: false,
      collection: this._filtersCollection,
      itemTemplate: itemListTemplate,
      itemView: CustomListItemView
    });

    this.addView(this._listView);
  },

  render: function () {
    this.$el.append(template({
      headerTitle: _t('components.backbone-forms.data-observatory.dropdown.filter.header')
    }));

    this.$('.js-content').append(this._listView.render().$el);

    return this;
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.trigger('back', this);
  },

  _initBinds: function () {
    this.listenTo(this._filtersCollection, 'change:selected', this._onSelectItem, this);
  },

  _onSelectItem: function (item) {
    this.trigger('selectItem', item, this);
  }
});

},{"../../../../helpers/required-opts":1097,"../../../custom-list/custom-view":59,"./filter-list-item-view":75,"./filter-list-item.tpl":76,"./filter-list-view.tpl":78,"backbone/core-view":1127}],78:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeader">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <button class="u-actionTextColor js-back u-rSpace">\n        <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n      </button>\n      '+
((__t=( headerTitle))==null?'':_.escape(__t))+
'\n    </li>\n  </ul>\n</div>\n<div class="js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],79:[function(require,module,exports){
var _ = require('underscore');
var BaseView = require('../../../custom-list/custom-list-item-view');

module.exports = BaseView.extend({
  render: function () {
    this.$el.empty();
    this.clearSubViews();

    var name = this.model.getName() == null ? 'null' : this.model.getName();

    this.$el.append(
      this.options.template(
        _.extend({
          isSelected: this.model.get('selected'),
          isDisabled: this.model.get('disabled'),
          name: name,
          val: this.model.getValue(),
          description: this.model.get('description')
        })
      )
    );

    this.$el
      .attr('data-val', this.model.getValue())
      .toggleClass('is-disabled', !!this.model.get('disabled'));

    return this;
  }
});

},{"../../../custom-list/custom-list-item-view":50,"underscore":"underscore"}],80:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button type="button" class="CDB-ListDecoration-itemLink\n    ';
 if (isSelected) { 
__p+=' is-selected ';
 } 
__p+='\n  " title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">\n  <div class="u-bSpace">'+
((__t=( name ))==null?'':_.escape(__t))+
'</div>\n  <div class="CDB-Size-small u-altTextColor">'+
((__t=( description ))==null?'':_.escape(__t))+
'</div>\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],81:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeaderItem">\n  <div  class="u-flex u-grow">\n    <div class="u-flex u-grow">\n      <input type="text" name="text" autocomplete="off" placeholder="'+
((__t=( searchPlaceholder ))==null?'':_.escape(__t))+
'" class="CDB-InputTextPlain CDB-Text js-search">\n      <button type="button" style="display:none" class="u-lSpace--xl u-rSpace--xl js-clear">\n        <div class="CDB-Shape">\n          <div class="CDB-Shape-close is-blue is-large"></div>\n        </div>\n      </button>\n    </div>\n\n    <div>\n      <button class="CDB-Text CDB-Size-medium u-actionTextColor js-filters u-rSpace--m">'+
((__t=( _t('analyses.data-observatory-measure.filters') ))==null?'':_.escape(__t))+
'</button>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],82:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var CustomListCollection = require('../../../custom-list/custom-list-collection');
var CustomListView = require('../../../custom-list/custom-view');
var CustomListItemView = require('./measurement-list-item-view');
var itemListTemplate = require('./measurement-list-item.tpl');
var checkAndBuildOpts = require('../../../../helpers/required-opts');
var searchTemplate = require('./measurement-list-search.tpl');

var REQUIRED_OPTS = [
  'measurementsCollection',
  'filtersCollection'
];

module.exports = CoreView.extend({
  events: {
    'click .js-filters': '_onClickFilters'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._initCollection();
    this._initBinds();

    this._listView = new CustomListView({
      className: 'DO-Measurements',
      typeLabel: _t('components.backbone-forms.data-observatory.dropdown.measurement.type'),
      showSearch: true,
      itemView: CustomListItemView,
      searchTemplate: searchTemplate,
      collection: this.collection,
      itemTemplate: itemListTemplate,
      searchPlaceholder: _t('components.backbone-forms.data-observatory.dropdown.measurement.search')
    });

    this.addView(this._listView);
  },

  render: function () {
    this.$el.append(this._listView.render().$el);
    return this;
  },

  _initCollection: function () {
    var filtersApplied = _.map(this._filtersCollection.getSelected(), function (mdl) {
      return mdl.getValue();
    });
    var measurements = this._measurementsCollection.filter(function (mdl) {
      var filters = mdl.get('filter');
      // if filters applied, we look for hits
      // if not, we check if measurement has filter
      if (filtersApplied.length > 0) {
        return _.some(filters, function (filter) {
          return filtersApplied.indexOf(filter.id) >= 0;
        });
      } else {
        return filters.length > 0;
      }
    });

    this.collection = new CustomListCollection(_.map(measurements, function (measurement) {
      return measurement.attributes;
    }));
  },

  _onClickFilters: function (e) {
    this.killEvent(e);
    this.trigger('filters');
  },

  _initBinds: function () {
    this.listenTo(this.collection, 'change:selected', this._onSelectItem);
  },

  _onSelectItem: function (item) {
    this._measurementsCollection.setSelected(item.getValue());
  }
});

},{"../../../../helpers/required-opts":1097,"../../../custom-list/custom-list-collection":47,"../../../custom-list/custom-view":59,"./measurement-list-item-view":79,"./measurement-list-item.tpl":80,"./measurement-list-search.tpl":81,"backbone/core-view":1127,"underscore":"underscore"}],83:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var cdb = require('cartodb.js');
var errorParse = require('../../../../helpers/error-parser');
var checkAndBuildOpts = require('../../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'configModel',
  'layerDefinitionModel'
];

module.exports = Backbone.Collection.extend({
  initialize: function (models, options) {
    checkAndBuildOpts(options, REQUIRED_OPTS, this);
    this._country = options.country || 'NULL';
    this._querySchemaModel = this._layerDefinitionModel.getAnalysisDefinitionNodeModel().querySchemaModel;

    var configModel = options.configModel;
    this.SQL = new cdb.SQL({
      user: configModel.get('user_name'),
      sql_api_template: configModel.get('sql_api_template'),
      api_key: configModel.get('api_key')
    });

    this._state = 'unfetched';
  },

  fetch: function (options) {
    this._success = options && options.success;
    this._error = options && options.error;
    var table = this._layerDefinitionModel.getTableName();
    var query = this._querySchemaModel.get('query');

    var sqlQuery = this._queryTemplate({
      table: table,
      query: query,
      country: this._country
    });

    if (!this.isFetching()) {
      this._state = 'fetching';
      this.SQL.execute(sqlQuery, null, {
        success: function (data) {
          this._state = 'fetched';
          this._onFetchSuccess(data);
          this._success && this._success();
        }.bind(this),
        error: function (err) {
          this._state = 'error';
          this._error && this._error(errorParse(err));
        }.bind(this)
      });
    }
  },

  _onFetchSuccess: function (data) {
    var models = data.rows;
    this.reset(models);
  },

  isFetching: function () {
    return this.getState() === 'fetching';
  },

  getState: function () {
    return this._state;
  },

  // these methods below is to use this collection as base collection for custom list view.
  getSelectedItem: function () {
    return _.first(this.getSelected());
  },

  getSelected: function () {
    return this.filter(function (mdl) {
      return mdl.get('selected') === true;
    });
  },

  removeSelected: function () {
    this.each(function (mdl) {
      mdl.set({
        selected: false
      });
    });
  }
});

},{"../../../../helpers/error-parser":1090,"../../../../helpers/required-opts":1097,"backbone":"backbone","cartodb.js":"cartodb.js","underscore":"underscore"}],84:[function(require,module,exports){
var _ = require('underscore');
var BaseCollection = require('./measurements-base-collection');
var BaseModel = require('../../../custom-list/custom-list-item-model');

var MEASUREMENTS_QUERY = 'SELECT * FROM OBS_GetAvailableNumerators((SELECT ST_SetSRID(ST_Extent(the_geom), 4326) FROM (<%- query %>) q), <%- country %>) numers';

module.exports = BaseCollection.extend({
  initialize: function (models, options) {
    this._queryTemplate = _.template(MEASUREMENTS_QUERY);
    BaseCollection.prototype.initialize.call(this, models, options);
  },

  model: function (attrs, opts) {
    var o = {};
    // label and val to custom list compatibility
    o.val = attrs.numer_id;
    o.label = attrs.numer_name;
    o.description = attrs.numer_description;
    // a measurement can belong to more than one category (filter)
    o.filter = [];
    var tags = JSON.parse(attrs.numer_tags);
    for (var key in tags) {
      if (/^subsection/.test(key)) {
        o.filter.push({
          id: key,
          name: tags[key]
        });
      }

      if (/^license/.test(key)) {
        o.license = tags[key];
      }
    }

    return new BaseModel(o);
  },

  getItem: function (value) {
    return this.findWhere({ val: value });
  },

  setSelected: function (value) {
    var selectedModel;
    var silent = { silent: true };

    this.each(function (mdl) {
      if (mdl.getValue() === value) {
        mdl.set({
          selected: true
        });
        selectedModel = mdl;
      } else {
        mdl.set({
          selected: false
        }, silent);
      }
    });
    return selectedModel;
  }
});

},{"../../../custom-list/custom-list-item-model":49,"./measurements-base-collection":83,"underscore":"underscore"}],85:[function(require,module,exports){
var _ = require('underscore');
var BaseCollection = require('./measurements-base-collection');
var BaseModel = require('../../../custom-list/custom-list-item-model');

var FILTERS_QUERY = "SELECT count(*) num_measurements, tag.key subsection_id, tag.value subsection_name FROM OBS_GetAvailableNumerators((SELECT ST_SetSRID(ST_Extent(the_geom), 4326) FROM (<%- query %>) q), <%- country %>) numers, Jsonb_Each(numers.numer_tags) tag WHERE tag.key like 'subsection%' GROUP BY tag.key, tag.value";

module.exports = BaseCollection.extend({
  initialize: function (models, options) {
    this._queryTemplate = _.template(FILTERS_QUERY);
    BaseCollection.prototype.initialize.call(this, models, options);
  },

  model: function (attrs, opts) {
    // label and val to custom list compatibility
    var o = {};
    o.val = attrs.subsection_id;
    o.label = attrs.subsection_name;
    o.items = attrs.num_measurements;

    return new BaseModel(o);
  },

  setSelected: function (value) {
    var silentTrue = { silent: true };

    if (_.isArray(value)) {
      this.each(function (mdl) {
        if (_.contains(value, mdl.getValue())) {
          mdl.set({
            selected: true
          }, silentTrue);
        } else {
          mdl.set({
            selected: false
          }, silentTrue);
        }
      });
    } else {
      this.each(function (mdl) {
        if (mdl.getValue() === value) {
          mdl.set({
            selected: true
          }, silentTrue);
        } else {
          mdl.set({
            selected: false
          }, silentTrue);
        }
      });
    }
  },

  search: function () {
    return _(this.models);
  },

  containsValue: function (value) {
    return this.length > 0;
  }
});

},{"../../../custom-list/custom-list-item-model":49,"./measurements-base-collection":83,"underscore":"underscore"}],86:[function(require,module,exports){
var Backbone = require('backbone');

/**
 * View model of the fill dialog
 */
module.exports = Backbone.Model.extend({

  defaults: {
    show: false
  },

  show: function () {
    this.set('show', true);
  },

  hide: function () {
    this.set('show', false);
  },

  isHidden: function () {
    return !this.get('show');
  },

  /**
   * @override {Backbone.Model.prototype.destroy}
   */
  destroy: function () {
    var args = Array.prototype.slice.call(arguments);
    this.trigger.apply(this, ['destroy'].concat(args));
  }
});

},{"backbone":"backbone"}],87:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var DatetimeEditorView = require('./datetime-editor-view');

module.exports = CoreView.extend({

  className: 'CDB-Box-modal CustomList CustomList--inputs is-visible has-visibility js-datetimePicker',

  initialize: function () {
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();

    this._datetimeEditorView = new DatetimeEditorView({
      model: this.model
    });
    this.addView(this._datetimeEditorView);
    this.$el.append(this._datetimeEditorView.render().el);

    return this;
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:show', this._onShowChange);
    this.listenTo(this.model, 'destroy', this._onDestroy);
  },

  _onShowChange: function (mdl, show) {
    if (show) {
      this.$el.show();
      this.$el.removeClass('is-closing').addClass('is-opening');
    } else {
      this.$el.removeClass('is-opening').addClass('is-closing');
      this.$el.hide();
    }
  },

  show: function () {
    this.model.show();
  },

  hide: function () {
    this.model.hide();
  },

  _onDestroy: function () {
    this.hide();
    this.clean();
  }
});

},{"./datetime-editor-view":89,"backbone/core-view":1127}],88:[function(require,module,exports){
var Backbone = require('backbone');
var Utils = require('../../../../helpers/utils');
var moment = require('moment');

var MONTHS = [
  {
    val: 0,
    label: _t('months.january')
  }, {
    val: 1,
    label: _t('months.february')
  }, {
    val: 2,
    label: _t('months.march')
  }, {
    val: 3,
    label: _t('months.april')
  }, {
    val: 4,
    label: _t('months.may')
  }, {
    val: 5,
    label: _t('months.june')
  }, {
    val: 6,
    label: _t('months.july')
  }, {
    val: 7,
    label: _t('months.august')
  }, {
    val: 8,
    label: _t('months.september')
  }, {
    val: 9,
    label: _t('months.october')
  }, {
    val: 10,
    label: _t('months.november')
  }, {
    val: 11,
    label: _t('months.december')
  }
];

module.exports = Backbone.Model.extend({

  initialize: function () {
    this.schema = {
      day: {
        type: 'Text',
        title: '',
        validators: [
          'required',
          /^(([0]?[1-9])|([1-2][0-9])|(3[01]))$/,
          function (value, formValues) {
            var date = moment(Utils.formatDate(formValues));
            if (!date.isValid()) {
              return {
                type: 'date',
                message: _t('components.datepicker.invalid-date')
              };
            }
          }
        ]
      },
      month: {
        type: 'Select',
        title: '',
        position: {
          'left': 0,
          'min-width': '200px'
        },
        options: MONTHS
      },
      year: {
        title: '',
        type: 'Text',
        validators: ['required', /^([0-9]{0,4})$/]
      },
      time: {
        title: '',
        type: 'Text',
        validators: ['required', /^([01]{1}[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/]
      }
    };
  },

  getFormattedDate: function () {
    return Utils.formatDate(this.toJSON());
  }
});

},{"../../../../helpers/utils":1102,"backbone":"backbone","moment":"moment"}],89:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var moment = require('moment');
var DatetimeEditorModel = require('./datetime-editor-model');

module.exports = CoreView.extend({

  tagName: 'div',
  className: 'Table-editorDate',

  events: {
    'keyup': '_onKeyUp'
  },

  initialize: function () {
    var dateAttr = this.model.get('value');
    var date = {};

    if (!dateAttr) {
      date = moment().utc();
    } else {
      date = moment(dateAttr).utc();
    }

    this._formModel = new DatetimeEditorModel({
      day: date.date(),
      month: date.month(),
      year: date.year(),
      time: date.format('HH:mm:ss'),
      utcOffset: date.utcOffset()
    });
    this._formModel.bind('change', this._setValue, this);
    this.add_related_model(this._formModel);

    this._setValue();
  },

  render: function () {
    this._formView = new Backbone.Form({
      model: this._formModel
    });

    this._formView.bind('change', function () {
      this.commit();
    });

    this.$el.html(this._formView.render().el);

    return this;
  },

  _setValue: function () {
    this.model.set('value', this._formModel.getFormattedDate());
  },

  _onKeyUp: function () {
    this._setValue();
  },

  clean: function () {
    this._formView.remove();
    CoreView.prototype.clean.apply(this);
  }

});

},{"./datetime-editor-model":88,"backbone":"backbone","backbone/core-view":1127,"moment":"moment"}],90:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var moment = require('moment');

var DatetimeDialogModel = require('./datetime-dialog-model');
var DatetimeDialogView = require('./datetime-dialog-view');
var template = require('./datetime.tpl');

var PopupManager = require('../../../popup-manager');

Backbone.Form.editors.DateTime = Backbone.Form.editors.Base.extend({
  className: 'Editor-formInput u-flex u-alignCenter',

  events: {
    'click .js-input': '_onInputClick'
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    this.dialogMode = this.options.dialogMode || 'nested';
    this._initBinds();
    this.render();
  },

  render: function () {
    Backbone.Form.editors.Base.prototype.render.apply(this, arguments);

    this._removeDateTimeDialog();

    this.$el.html(
      template({
        value: this._getFormattedDatetime()
      })
    );

    this._initViews();

    return this;
  },

  _getFormattedDatetime: function () {
    if (this.value) {
      var value = new Date(this.value).toUTCString();
      var momentObj = moment(value).utc();
      return momentObj.format('YYYY-MM-DD') + 'T' + momentObj.format('HH:mm:ss') + 'Z';
    }

    // for datetime type, empty '' value raises an error on Postgres
    return null;
  },

  _initViews: function () {
    if (this.options.editorAttrs && this.options.editorAttrs.disabled) {
      this.$el.addClass('is-disabled');
    }

    this._datetimeDialogModel = new DatetimeDialogModel({
      value: this._getFormattedDatetime()
    });
    this._datetimeDialogModel.bind('change:value', this._onInputChanged, this);

    this._datetimeDialogView = new DatetimeDialogView({
      model: this._datetimeDialogModel
    });

    this._popupManager = new PopupManager(this.cid, this.$el, this._datetimeDialogView.$el);
  },

  _initBinds: function () {
    var hide = function () {
      this._removeDateTimeDialog();
    }.bind(this);
    this.applyESCBind(hide);
    this.applyClickOutsideBind(hide);
  },

  _onInputClick: function () {
    this._datetimeDialogView.render();
    this._popupManager.append(this.dialogMode);
    this._popupManager.track();
  },

  _removeDateTimeDialog: function () {
    if (this._datetimeDialogView) {
      this._popupManager.untrack();
      this._datetimeDialogView.remove();
    }
  },

  _onInputChanged: function (mdl) {
    var value = this._datetimeDialogModel.get('value');
    this.setValue(value);

    this.trigger('change', this);
  },

  _updateInput: function (value) {
    this.$('.js-input')
      .toggleClass('is-empty', !value)
      .text(value);
  },

  getValue: function () {
    return this._datetimeDialogModel.get('value');
  },

  setValue: function (value) {
    this._updateInput(value);
    this.value = value;
  },

  remove: function () {
    this._removeDateTimeDialog();
    this._popupManager && this._popupManager.destroy();
    Backbone.Form.editors.Base.prototype.remove.apply(this);
  }
});

},{"../../../popup-manager":522,"../editor-helpers-extend":92,"./datetime-dialog-model":86,"./datetime-dialog-view":87,"./datetime.tpl":91,"backbone":"backbone","moment":"moment"}],91:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button type="button" class="CDB-InputText\n  ';
 if (!value) { 
__p+=' is-empty ';
 } 
__p+='\n  u-txt-left js-input">'+
((__t=( value ? value : 'null' ))==null?'':_.escape(__t))+
'</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],92:[function(require,module,exports){
var _ = require('underscore');

module.exports = {

  setOptions: function (editor, opts) {
    var validators = [];

    if (opts.schema && opts.schema.validators) {
      validators = validators.concat(opts.schema.validators);
    }

    if (editor.options && editor.options.validators) {
      validators = validators.concat(editor.options.validators);
    }

    editor.validators = validators;

    editor.options = _.extend(
      {},
      _.omit(editor.options, 'validators') || {},
      opts.schema,
      // 'editorAttrs' can appear in schema if it comes from a Backbone form component
      // or in options directly if the component is created without a Backbone form
      opts.schema && opts.schema.editorAttrs || {},
      opts.editorAttrs,
      {
        keyAttr: opts.key
      },
      {
        validators: validators
      },
      _.omit(opts, 'validators')
    );

    if (editor.options.className) {
      editor.$el.addClass(editor.options.className);
    }

    if (editor.options.trackingClass) {
      var trackClasses = editor.options.trackingClass + ' track-' + editor.options.key + editor.options.editorType;
      editor.$el.addClass(trackClasses);
    }
  }
};

},{"underscore":"underscore"}],93:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var $ = require('jquery');
var _ = require('underscore');
var TipsyTooltipView = require('../../../tipsy-tooltip-view');
var template = require('./enabler-editor.tpl');

/**
 *  Creates an element that enables another component, tested with:
 *
 *  select, number and input so far.
 */

Backbone.Form.editors.EnablerEditor = Backbone.Form.editors.Base.extend({
  tagName: 'div',
  className: 'Editor-checker u-flex u-alignCenter',

  events: {
    'click .js-check': '_onCheckClicked'
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    // Disable validators unless it's enabled
    this.validators = null;

    if (!this.options.editor) {
      throw new Error('editor options is required');
    }

    this._editorOptions = this.options.editor;
    this.value = this.model.get(opts.key);
    this._checkModel = new Backbone.Model({
      enabled: !!this.value
    });
    this.template = template;

    this._initBinds();
  },

  render: function () {
    this.$el.html(
      this.template({
        label: this.options.label,
        isChecked: this._isChecked(),
        help: this.options.help || ''
      })
    );

    if (this.options.help) {
      this._helpTooltip = new TipsyTooltipView({
        el: this.$('.js-help'),
        gravity: 's',
        offset: 0,
        title: function () {
          return $(this).data('tooltip');
        }
      });
    }

    this._renderComponent();

    return this;
  },

  _initBinds: function () {
    this._checkModel.bind('change:enabled', function (mdl, isEnabled) {
      this._manageValue(isEnabled);
      this._renderComponent();
      this._triggerChange();
    }, this);
  },

  _manageValue: function (isEnabled) {
    if (isEnabled) {
      this.validators = this.options.validators;
      this.value = this.options.defaultValue || '';
      this._editorComponent.setValue(this.options.defaultValue || '');
    } else {
      this.validators = null;
      this.value = '';
      this._editorComponent.setValue('');
    }
    this.model.set(this.options.keyAttr, this.value);
    this.validate();
  },

  _isChecked: function () {
    return this._checkModel.get('enabled');
  },

  _renderComponent: function () {
    if (this._editorComponent) {
      this._removeComponent();
    }

    var EditorClass = Backbone.Form.editors[this._editorOptions.type];
    var editorAttrs = _.extend(
      this._editorOptions.editorAttrs || {},
      {
        disabled: !this._isChecked()
      }
    );

    this._editorComponent = new EditorClass(
      _.extend(
        {
          model: this.model,
          key: this.options.keyAttr,
          editorAttrs: editorAttrs,
          trackingClass: this.options.trackingClass,
          editorType: this._editorOptions.type
        },
        _.omit(this._editorOptions, 'editorAttrs', 'type')
      )
    );
    this._editorComponent.bind('change', this._setEditorComponentValue, this);
    this.$('.js-editor').html(this._editorComponent.render().el);

    // Not all editor implement the focus method
    try {
      this._editorComponent.focus();
    } catch (e) {}
  },

  _removeComponent: function () {
    this._editorComponent.remove();
    this._editorComponent.unbind('change', this._setEditorComponentValue, this);
  },

  _setEditorComponentValue: function () {
    this.value = this._editorComponent.getValue();
    this._triggerChange();
  },

  _triggerChange: function () {
    this.trigger('change', this);
  },

  getValue: function () {
    if (this._checkModel.get('enabled')) {
      return this._editorComponent && this._editorComponent.getValue() || '';
    } else {
      return '';
    }
  },

  setValue: function (value) {
    this._checkModel.set('enabled', !!value);
    if (this._editorComponent) {
      this._editorComponent.setValue(value);
    }
    this.value = value;
  },

  _onCheckClicked: function (ev) {
    this._checkModel.set('enabled', $(ev.target).is(':checked'));
  },

  remove: function () {
    if (this._editorComponent) {
      this._removeComponent();
    }
    if (this._helpTooltip) {
      this._helpTooltip.clean();
    }
    Backbone.Form.editors.Base.prototype.remove.call(this);
  }

});

},{"../../../tipsy-tooltip-view":589,"../editor-helpers-extend":92,"./enabler-editor.tpl":94,"backbone":"backbone","jquery":"jquery","underscore":"underscore"}],94:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex Editor-checkerInput CDB-Text CDB-Size-medium u-rSpace--xl">\n  <input class="CDB-Checkbox js-check" type="checkbox" name="" value="" ';
 if (isChecked) { 
__p+='checked';
 } 
__p+='>\n  <span class="CDB-Checkbox-face u-rSpace--m"></span>\n  <label class="CDB-Text CDB-Size-small u-ellipsis u-upperCase is-semibold u-flex u-alignCenter Editor-formLabel">\n    <span class="u-ellipsis ';
 if (help) { 
__p+=' js-help is-underlined';
 } 
__p+='" ';
 if (help) { 
__p+=' data-tooltip="'+
((__t=( help ))==null?'':_.escape(__t))+
'"';
 } 
__p+='  title="'+
((__t=( label ))==null?'':_.escape(__t))+
'">'+
((__t=( label ))==null?'':_.escape(__t))+
'</span>\n  </label>\n</div>\n<div class="Editor-checkerComponent js-editor"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],95:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<label class="CDB-Legend u-upperCase CDB-Text is-semibold CDB-Size-small">\n  <div class="u-flex u-alignCenter">\n    <div class="u-iBlock u-rSpace--m">\n      <input class="CDB-Checkbox js-input" type="checkbox" name="" value="" ';
 if (checked) { 
__p+='checked';
 } 
__p+=' ';
 if (disabled) { 
__p+='disabled';
 } 
__p+='>\n      <span class="u-iBlock CDB-Checkbox-face"></span>\n    </div>\n    <span class="';
 if (help) { 
__p+=' js-help is-underlined';
 } 
__p+='" ';
 if (help) { 
__p+=' data-tooltip="'+
((__t=( help ))==null?'':_.escape(__t))+
'"';
 } 
__p+=' >'+
((__t=( label ))==null?'':_.escape(__t))+
'</span>\n  </div>\n</label>\n<div class="Editor-checkerComponent js-editor"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],96:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var $ = require('jquery');
var TipsyTooltipView = require('../../../tipsy-tooltip-view');
var template = require('./enabler.tpl');
var templateReversed = require('./enabler-reversed.tpl');

Backbone.Form.editors.Enabler = Backbone.Form.editors.Base.extend({
  tagName: 'div',

  events: {
    'change .js-input': '_onCheckChange',
    'focus .js-input': function () {
      this.trigger('focus', this);
    },
    'blur .js-input': function () {
      this.trigger('blur', this);
    }
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    this.template = opts.schema && opts.schema.editorAttrs && opts.schema.editorAttrs.reversed ? templateReversed : (opts.template || template);
    this._initViews();
  },

  _initViews: function () {
    this.$el.html(
      this.template({
        checked: this.options.disabled ? false : this.model.get(this.options.key),
        label: this.options.label,
        title: this.options.title,
        help: this.options.help || '',
        disabled: this.options.disabled
      })
    );

    if (this.options.help) {
      this._removeTooltip();

      this._helpTooltip = new TipsyTooltipView({
        el: this.$('.js-help'),
        gravity: 's',
        title: function () {
          return $(this).data('tooltip');
        }
      });
    }

    if (this.options.disabled) {
      this.undelegateEvents();
    }
  },

  _onCheckChange: function () {
    var isEnabled = this.$('.js-input').is(':checked');
    this.model.set('enabler', isEnabled);
    this.trigger('change', this);
  },

  getValue: function () {
    return this.$('.js-input').is(':checked');
  },

  setValue: function (value) {
    this.$('.js-input')[value ? 'attr' : 'removeAttr']('checked', '');
    this.model.set(this.key, value);
  },

  _removeTooltip: function () {
    if (this._helpTooltip) {
      this._helpTooltip.clean();
    }
  },

  remove: function () {
    this._removeTooltip();
    Backbone.Form.editors.Base.prototype.remove.apply(this);
  }

});

},{"../../../tipsy-tooltip-view":589,"../editor-helpers-extend":92,"./enabler-reversed.tpl":95,"./enabler.tpl":97,"backbone":"backbone","jquery":"jquery"}],97:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<label class="CDB-Legend u-upperCase CDB-Text is-semibold CDB-Size-small">\n  <div class="u-flex u-alignCenter">\n    <div class="u-iBlock u-rSpace--m">\n      <input class="CDB-Checkbox js-input" type="checkbox" name="" value="" ';
 if (checked) { 
__p+='checked';
 } 
__p+=' ';
 if (disabled) { 
__p+='disabled';
 } 
__p+='>\n      <span class="u-iBlock CDB-Checkbox-face"></span>\n    </div>\n    <span class="';
 if (help) { 
__p+=' js-help is-underlined';
 } 
__p+='" ';
 if (help) { 
__p+=' data-tooltip="'+
((__t=( help ))==null?'':_.escape(__t))+
'"';
 } 
__p+=' >'+
((__t=( title ))==null?'':_.escape(__t))+
'</span>\n  </div>\n</label>\n<div class="CDB-Text CDB-Size-medium Editor-formInput js-editor"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],98:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="colorpicker dropdown-menu">\n  <div class="colorpicker-saturation">\n    <i><b></b></i>\n  </div>\n  <div class="colorpicker-hue">\n    <i class="ColorPicker-ball"></i>\n  </div>\n  <div class="colorpicker-alpha js-alpha">\n    <i class="ColorPicker-ball"></i>\n  </div>\n  <div class="ColorPicker-colorWrapper">\n    <div class="ColorPicker-color colorpicker-color js-color"></div>\n  </div>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],99:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
require('bootstrap-colorpicker');
var template = require('./template.tpl');
var colorPickerTemplate = require('./color-picker-template.tpl');
var Utils = require('../../../../../helpers/utils');

var ESCAPE_KEY_CODE = 27;

module.exports = CoreView.extend({
  events: {
    'blur .js-hex': '_onChangeHex',
    'blur .js-inputColor': '_onChangeColorValue',
    'blur .js-a': '_onChangeOpacity'
  },

  initialize: function (opts) {
    var opacity = opts.opacity != null ? opts.opacity : 1;

    this.model = new Backbone.Model({
      hex: opts.value,
      opacity: opacity
    });

    this._onEscape = this._onEscapePressed.bind(this);
    this._initBinds();
  },

  render: function () {
    var rgb = Utils.hexToRGB(this.model.get('hex'));

    var color = _.extend(rgb, {
      hex: this.model.get('hex'),
      opacity: this.model.get('opacity'),
      opacityDisabled: this.options.disableOpacity
    });

    this.$el.append(template(color));

    var rgbaTemplate = _.template('rgba(<%- r %>, <%- g %>, <%- b %>, <%- opacity %>)');

    this.$('.js-colorPicker').colorpicker({
      color: rgbaTemplate(color),
      format: 'rgba',
      container: true,
      horizontal: true,
      inline: true,
      customClass: 'ColorPicker',
      template: colorPickerTemplate(),
      slidersHorz: {
        saturation: {
          maxLeft: 206,
          maxTop: 95,
          callLeft: 'setSaturation',
          callTop: 'setBrightness'
        },
        hue: {
          maxLeft: 180,
          maxTop: 0,
          callLeft: 'setHue',
          callTop: false
        },
        alpha: {
          maxLeft: 180,
          maxTop: 0,
          callLeft: 'setAlpha',
          callTop: false
        }
      }
    });

    if (this.options.disableOpacity) {
      this.$('.js-colorPicker .js-alpha').addClass('is-hidden');
    }

    var setNewColor = function (e) {
      var rgb = e.color.toRGB();
      var hex = e.color.toHex();
      this.model.set({ hex: hex, r: rgb.r, g: rgb.g, b: rgb.b, opacity: rgb.a });
      this.$('.js-color').css('opacity', rgb.a);
    }.bind(this);

    this.$('.js-colorPicker').colorpicker().on('changeColor', setNewColor);

    this._initDocumentBinds();
    return this;
  },

  _initBinds: function () {
    this.model.bind('change:hex', this._onChangeColor, this);
    this.model.bind('change:r', this._onChangeColor, this);
    this.model.bind('change:g', this._onChangeColor, this);
    this.model.bind('change:b', this._onChangeColor, this);
    this.model.bind('change:opacity', this._onChangeColor, this);
  },

  _onEscapePressed: function (ev) {
    if (ev.which === ESCAPE_KEY_CODE) {
      this.remove();
    }
  },

  _initDocumentBinds: function () {
    $(document).on('keydown', this._onEscape);
  },

  _destroyDocumentBinds: function () {
    $(document).off('keydown', this._onEscape);
  },

  _onChangeColor: function () {
    this.trigger('change', {
      opacity: this.model.get('opacity'),
      hex: this.model.get('hex')
    }, this);

    this.$('.js-hex').val(this.model.get('hex'));
    this.$('.js-r').val(this.model.get('r'));
    this.$('.js-g').val(this.model.get('g'));
    this.$('.js-b').val(this.model.get('b'));
    this.$('.js-a').val(this.model.get('opacity'));
  },

  _onChangeOpacity: function () {
    var opacity = +this.$('.js-a').val();
    if (_.isNumber(opacity) && opacity >= 0 && opacity <= 1) {
      this.setColor(this.model.get('hex'), opacity);
    }
  },

  _onChangeColorValue: function (e) {
    this.$(e.target).removeClass('has-error');

    var r = +this.$('.js-r').val();
    var g = +this.$('.js-g').val();
    var b = +this.$('.js-b').val();

    var hex = Utils.rgbToHex(r, g, b);

    if (Utils.isValidHex(hex)) {
      this.setColor(hex);
    } else {
      this.$(e.target).addClass('has-error');
    }
  },

  _onChangeHex: function (e) {
    this.$(e.target).removeClass('has-error');

    var hex = this.$('.js-hex').val();

    if (Utils.isValidHex(hex)) {
      this.setColor(hex);
    } else {
      this.$(e.target).addClass('has-error');
    }
  },

  setColor: function (hex, opacity) {
    if (opacity === undefined) {
      opacity = this.model.get('opacity') || 1;
    }

    this.$('.js-colorPicker').colorpicker('setValue', Utils.hexToRGBA(hex, opacity));
  },

  clean: function () {
    this._destroyDocumentBinds();
    CoreView.prototype.clean.apply(this);
  }
});

},{"../../../../../helpers/utils":1102,"./color-picker-template.tpl":98,"./template.tpl":100,"backbone":"backbone","backbone/core-view":1127,"bootstrap-colorpicker":"bootstrap-colorpicker","jquery":"jquery","underscore":"underscore"}],100:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-boxModalContent">\n  <div class="ColorPicker-pickerWrapper js-colorPicker"></div>\n  <div class="ColorPicker-inputs">\n    <div class="ColorPicker-inputWrapper CDB-Text">\n      <input type="text" class="CDB-Text CDB-InputText ColorPicker-input is-color js-hex" value="'+
((__t=( hex ))==null?'':_.escape(__t))+
'"/>\n      <span class="ColorPicker-inputLabel u-upperCase">HEX</span>\n    </div>\n    <div class="ColorPicker-inputWrapper CDB-Text">\n      <input type="text" class="CDB-Text CDB-InputText ColorPicker-input js-inputColor js-r" value="'+
((__t=( r ))==null?'':_.escape(__t))+
'"/>\n      <span class="ColorPicker-inputLabel u-upperCase">R</span>\n    </div>\n    <div class="ColorPicker-inputWrapper CDB-Text">\n      <input type="text" class="CDB-Text CDB-InputText ColorPicker-input js-inputColor js-g" value="'+
((__t=( g ))==null?'':_.escape(__t))+
'" />\n      <span class="ColorPicker-inputLabel u-upperCase">G</span>\n    </div>\n    <div class="ColorPicker-inputWrapper CDB-Text">\n      <input type="text" class="CDB-Text CDB-InputText ColorPicker-input js-inputColor js-b" value="'+
((__t=( b ))==null?'':_.escape(__t))+
'" />\n      <span class="ColorPicker-inputLabel u-upperCase">B</span>\n    </div>\n    <div class="ColorPicker-inputWrapper CDB-Text">\n      <input type="text" class="CDB-Text CDB-InputText ColorPicker-input js-a';
 if (opacityDisabled) { 
__p+=' is-disabled';
 } 
__p+='" value="'+
((__t=( opacity ))==null?'':_.escape(__t))+
'" ';
 if (opacityDisabled) { 
__p+='disabled';
 } 
__p+=' />\n      <span class="ColorPicker-inputLabel u-upperCase">A</span>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],101:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var CustomListView = require('../../../custom-list/custom-view');
var CustomListCollection = require('../../../custom-list/custom-list-collection');
var template = require('./column-list-view.tpl');

module.exports = CoreView.extend({
  defaults: {
    headerTitle: ''
  },

  events: {
    'click .js-back': '_onClickBack'
  },

  initialize: function (opts) {
    if (!opts.stackLayoutModel) throw new Error('stackLayoutModel is required');
    if (!opts.columns) throw new Error('columns param is required');

    this._stackLayoutModel = opts.stackLayoutModel;
    this._columns = opts.columns;
    this._showSearch = opts.showSearch || false;
    this._typeLabel = opts.typeLabel;
    this._itemTemplate = opts.itemTemplate;

    this.collection = new CustomListCollection(this._columns);
    this.listenTo(this.collection, 'change:selected', this._onSelectItem);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    this.$el.append(
      template({
        headerTitle: this.options.headerTitle
      })
    );

    this._initViews();

    return this;
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.trigger('back', this);
  },

  _initViews: function () {
    this._listView = new CustomListView({
      collection: this.collection,
      showSearch: this._showSearch,
      typeLabel: this._typeLabel,
      itemTemplate: this._itemTemplate
    });
    this.$('.js-content').append(this._listView.render().$el);
    this.addView(this._listView);
  },

  _onSelectItem: function (item) {
    this.trigger('selectItem', item, this);
  }
});

},{"../../../custom-list/custom-list-collection":47,"../../../custom-list/custom-view":59,"./column-list-view.tpl":102,"backbone/core-view":1127}],102:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (headerTitle) { 
__p+='\n<div class="CDB-Box-modalHeader">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <button class="u-actionTextColor js-back u-rSpace">\n        <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n      </button>\n      '+
((__t=( headerTitle))==null?'':_.escape(__t))+
'\n    </li>\n  </ul>\n</div>\n';
 } 
__p+='\n<div class="js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],103:[function(require,module,exports){
module.exports={
  "number": {
    "quantifications": {
      "items": ["quantiles", "jenks", "equal", "headtails"],
      "defaultIndex": 0
    },
    "bins": {
      "items": ["2", "3", "4", "5", "6", "7"],
      "defaultIndex": 3
    }
  },
  "color": {
    "quantifications": {
      "items": ["jenks", "equal", "headtails", "quantiles", "category"],
      "defaultIndex": 0
    }
  },
  "color-ramps": {
    "quantifications": {
      "items": ["quantiles", "jenks", "equal", "headtails", "category"],
      "defaultIndex": 0
    },
    "bins": {
      "items": ["2", "3", "4", "5", "6", "7"],
      "defaultIndex": 3
    }
  }
}

},{}],104:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');

/**
 * View model of the fill dialog
 */
module.exports = Backbone.Model.extend({

  defaults: {
    visible: true,
    createContentView: function () {
      return new CoreView();
    }
  },

  createContentView: function () {
    return this.get('createContentView')(this);
  },

  show: function () {
    this.set('visible', true);
  },

  hide: function () {
    this.set('visible', false);
  },

  isHidden: function () {
    return !this.get('visible');
  },

  /**
   * @override {Backbone.Model.prototype.destroy}
   */
  destroy: function () {
    var args = Array.prototype.slice.call(arguments);
    this.trigger.apply(this, ['destroy'].concat(args));
  }
});

},{"backbone":"backbone","backbone/core-view":1127}],105:[function(require,module,exports){
var CoreView = require('backbone/core-view');

module.exports = CoreView.extend({
  className: 'Editor-boxModal Editor-FormDialog js-formDialog is-opening',

  initialize: function () {
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this._renderContentView();
    return this;
  },

  _renderContentView: function () {
    var view = this.model.createContentView();
    this.addView(view);
    this.$el.append(view.render().$el);
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:show', this._onShowChange);
    this.listenTo(this.model, 'destroy', this._onDestroy);
  },

  _onShowChange: function (m, show) {
    if (show) {
      this.$el.show();
      this.$el.removeClass('is-closing').addClass('is-opening');
    } else {
      this.$el.removeClass('is-opening').addClass('is-closing');
      this.$el.hide();
    }
  },

  show: function () {
    this.model.show();
  },

  hide: function () {
    this.model.hide();
  },

  _onDestroy: function () {
    this.hide();
    this.clean();
  }
});

},{"backbone/core-view":1127}],106:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-boxModalHeader">\n  <nav class="CDB-NavMenu">\n    <ul class="CDB-NavMenu-Inner CDB-NavMenu-inner--no-margin CDB-NavMenu-inner--is-dropdown CDB-Text is-semibold CDB-Size-medium js-menu"></ul>\n  </nav>\n</div>\n<div class="js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],107:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="CDB-OptionInput-container js-content"></ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],108:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');

var FillDialogModel = require('./fill-dialog-model');
var FillDialogView = require('./fill-dialog');

var InputCollection = require('./input-collection');
var InputNumber = require('./input-number/input-number');
var InputColor = require('./input-color/input-color');

var template = require('./fill-template.tpl');

var PopupManager = require('../../../popup-manager');

var INPUT_TYPE_MAP = {
  'size': InputNumber,
  'color': InputColor,
  'image': InputColor
};

var QUANTIFICATION_REF = {
  'Jenks': 'jenks',
  'Equal Interval': 'equal',
  'Heads/Tails': 'headtails',
  'Quantile': 'quantiles'
};

var MIN_IMAGE_SIZE = 20;

Backbone.Form.editors.Fill = Backbone.Form.editors.Base.extend({
  className: 'Form-InputFill CDB-OptionInput CDB-Text js-input',

  events: {
    focus: function () {
      this.trigger('focus', this);
    },
    blur: function () {
      this.trigger('blur', this);
    }
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts); // Options

    this.options = _.extend(
      this.options,
      {
        columns: this.options.options,
        query: this.options.query,
        configModel: this.options.configModel,
        userModel: this.options.userModel,
        editorAttrs: this.options.editorAttrs,
        modals: this.options.modals
      }
    );

    this._keyAttr = opts.key;
    this.dialogMode = this.options.dialogMode || 'nested';

    this._initBinds();
    this._initViews();
  },

  _initViews: function () {
    this.$el.append(template());

    if (this.options.editorAttrs && this.options.editorAttrs.disabled) {
      this.$el.addClass('is-disabled');
    }

    this._initFillDialog();
    this._initInputFields();

    this._popupManager = new PopupManager(this.cid, this.$el, this._fillDialogView.$el);
  },

  _initInputFields: function () {
    var inputKlass;

    this._inputCollection = new InputCollection();

    _.each(this.model.get(this._keyAttr), function (value, key) {
      this._inputCollection.add(_.extend({ type: key }, value));
    }, this);

    this._inputCollection.each(function (inputModel) {
      var type = inputModel.get('type');

      var Klass = INPUT_TYPE_MAP[type];

      if (!Klass) {
        throw new Error(type + ' is not a valid type of constructor');
      }

      if (inputModel.get('quantification') && QUANTIFICATION_REF[inputModel.get('quantification')]) {
        inputModel.set('quantification', QUANTIFICATION_REF[inputModel.get('quantification')], { silent: true });
      }

      inputKlass = new Klass(({
        model: inputModel,
        columns: this.options.columns,
        query: this.options.query,
        configModel: this.options.configModel,
        userModel: this.options.userModel,
        modals: this.options.modals,
        editorAttrs: this.options.editorAttrs ? this.options.editorAttrs[type] : {},
        disabled: this.options.editorAttrs && this.options.editorAttrs.disabled
      }));

      inputKlass.bind('click', this._onInputClick, this);

      this.$('.js-content').append(inputKlass.render().$el);
    }, this);

    this._inputCollection.bind('inputChanged', this._onInputChanged, this);
  },

  _initBinds: function () {
    this.applyESCBind(function () {
      this._removeDialog();
    });
    this.applyClickOutsideBind(function () {
      this._removeDialog();
    });
  },

  _onInputClick: function (inputModel) {
    if (inputModel.get('selected')) {
      this._removeDialog();
      return;
    }

    inputModel.set('selected', true);
    this._fillDialogView.model.set('createContentView', inputModel.get('createContentView'));
    this._fillDialogView.render();
    this._fillDialogView.show();

    this._popupManager.append(this.dialogMode);
    this._popupManager.track();
  },

  _onInputChanged: function (mdl) {
    this._adjustImageSize(mdl);
    this.trigger('change', this);
  },

  _adjustImageSize: function (mdl) {
    if (mdl.get('type') !== 'color' && mdl.get('kind') !== 'marker') {
      return;
    }

    var changedImage = mdl.get('image') && mdl.hasChanged('image') && !mdl.previous('image');

    var hasImages = _.isEmpty(_.compact(mdl.get('images')));
    var hadImages = _.isEmpty(_.compact(mdl.previous('images')));
    var changedImages = !hasImages && mdl.hasChanged('images') && hadImages;

    if (changedImage || changedImages) {
      var size = this._inputCollection.findWhere({ type: 'size' });

      if (size && size.get('fixed') < MIN_IMAGE_SIZE) {
        size.set('fixed', MIN_IMAGE_SIZE);
      }
    }
  },

  _initFillDialog: function () {
    var fillDialogModel = new FillDialogModel();

    this.listenToOnce(fillDialogModel, 'destroy', function () {
      this._fillDialogView = null;
      this.stopListening(fillDialogModel);
    });

    this._fillDialogView = new FillDialogView({
      model: fillDialogModel
    });
  },

  _removeDialog: function (dialog) {
    this._inputCollection.unselect();
    this._fillDialogView.remove();
    this._popupManager.untrack();
  },

  focus: function () {
    if (this.hasFocus) return;
    this.$('.js-fillInput').focus();
  },

  blur: function () {
    if (!this.hasFocus) return;
    this.$('.js-fillInput').blur();
  },

  getValue: function () {
    return this._inputCollection.getValues();
  },

  setValue: function (value) {
    // TODO: add setter
  },

  remove: function () {
    this._removeDialog();
    this._popupManager.destroy();
    this._inputCollection.unbind('inputChanged', this._onInputChanged, this);
    Backbone.Form.editors.Base.prototype.remove.apply(this);
  }
});

},{"../../../popup-manager":522,"../editor-helpers-extend":92,"./fill-dialog":105,"./fill-dialog-model":104,"./fill-template.tpl":107,"./input-collection":109,"./input-color/input-color":151,"./input-number/input-number":167,"backbone":"backbone","underscore":"underscore"}],109:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

var INPUT_TYPE_ORDER = ['size', 'color'];

module.exports = Backbone.Collection.extend({
  constructor: function (models, options) {
    options = _.extend(options || {}, { silent: false });
    Backbone.Collection.prototype.constructor.call(this, models, options);
  },

  comparator: function (m) {
    return INPUT_TYPE_ORDER.indexOf(m.get('type'));
  },

  initialize: function () {
    this.bind('change:selected', this._onSelectedChange, this);
    this.bind('change', this._onModelsChanged, this);
  },

  getSelected: function () {
    return this.find(function (model) {
      return model.get('selected');
    });
  },

  unselect: function () {
    this.each(function (model) {
      model.set('selected', false);
    }, this);
  },

  _onSelectedChange: function (itemModel, isSelected) {
    if (!isSelected) {
      return;
    }

    this.each(function (model) {
      if (model !== itemModel) {
        model.set('selected', false);
      }
    }, this);
  },

  _onModelsChanged: function (mdl) {
    var mdlChanges = mdl.changed;

    // If there is any change about selected, don't propagate it
    if (_.isEmpty(mdlChanges) || (_.size(mdlChanges) === 1 && mdl.changed.hasOwnProperty('selected'))) {
      return;
    }

    this.trigger('inputChanged', mdl, this);
  },

  getValues: function () {
    return this.reduce(function (memo, mdl) {
      var data = {};
      var typeValues = mdl.toJSON();

      if (typeValues.fixed) {
        data.fixed = typeValues.fixed;

        if (typeValues.type === 'color') {
          if (typeValues.image) {
            data.image = typeValues.image;
          }
          if (typeValues.kind) {
            data.kind = typeValues.kind;
          }
          data.opacity = typeValues.opacity;
        }
      } else {
        data = _.omit(typeValues, ['createContentView', 'selected', 'type']);
      }

      memo[typeValues.type] = data;

      return memo;
    }, {});
  }
});

},{"backbone":"backbone","underscore":"underscore"}],110:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var checkAndBuildOpts = require('../../../../../../helpers/required-opts');
var template = require('./asset-header-view.tpl');

var REQUIRED_OPTS = [
  'title',
  'editable'
];

module.exports = CoreView.extend({
  events: {
    'click .js-remove': '_onClickRemove',
    'click .js-select-all': '_onClickSelectAll',
    'click .js-deselect-all': '_onClickDeselectAll'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._assetsCollection = this.options.assetsCollection;

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();

    var selectedCount = this._getSelectedAssetsCount();

    var assetsCount = this._assetsCollection.size();

    this.$el.html(template({
      title: this._title,
      editable: this._editable,
      assetsCount: assetsCount,
      selectedCount: selectedCount,
      allSelected: selectedCount === assetsCount
    }));

    return this;
  },

  _initBinds: function () {
    this.listenTo(this._assetsCollection, 'add change remove', this.render);
  },

  _onClickRemove: function () {
    this.trigger('remove');
  },

  _onClickSelectAll: function () {
    this.trigger('select-all');
  },

  _onClickDeselectAll: function () {
    this.trigger('deselect-all');
  },

  _getSelectedAssetsCount: function () {
    var selectedAssets = this._assetsCollection.where({ state: 'selected' });
    return selectedAssets ? selectedAssets.length : 0;
  }
});

},{"../../../../../../helpers/required-opts":1097,"./asset-header-view.tpl":111,"backbone/core-view":1127}],111:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul>\n  <li class="CDB-NavSubmenu-item">\n    <h2 class="CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h2>\n  </li>\n  ';
 if (editable && assetsCount > 0) { 
__p+='\n    ';
 if (allSelected) { 
__p+='\n      <li class="CDB-NavSubmenu-item">\n        <button class="CDB-NavSubmenu-itemLink CDB-Text CDB-Size-medium u-actionTextColor js-deselect-all">'+
((__t=( _t('components.modals.assets-picker.deselect-all') ))==null?'':_.escape(__t))+
'</button>\n      </li>\n      ';
 } else if (selectedCount > 0) { 
__p+='\n      <li class="CDB-NavSubmenu-item">\n        <button class="CDB-NavSubmenu-itemLink CDB-Text CDB-Size-medium u-actionTextColor js-select-all">'+
((__t=( _t('components.modals.assets-picker.select-all') ))==null?'':_.escape(__t))+
'</button>\n      </li>\n    ';
 } 
__p+='\n\n    ';
 if (selectedCount > 0) { 
__p+='\n      <li class="CDB-NavSubmenu-item">\n          ';
 if (selectedCount > 1) { 
__p+='\n        <button class="CDB-NavSubmenu-itemLink CDB-Text CDB-Size-medium u-errorTextColor js-remove">'+
((__t=( _t('components.modals.assets-picker.delete-images') ))==null?'':_.escape(__t))+
'</button>\n        ';
 } else { 
__p+='\n        <button class="CDB-NavSubmenu-itemLink CDB-Text CDB-Size-medium u-errorTextColor js-remove">'+
((__t=( _t('components.modals.assets-picker.delete-image') ))==null?'':_.escape(__t))+
'</button>\n        ';
 } 
__p+='\n      </li>\n    ';
 } 
__p+='\n  ';
 } 
__p+='\n</ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],112:[function(require,module,exports){
var CoreView = require('backbone/core-view');

var template = require('./asset-item-view.tpl');

var ASSET_HEIGHT = 24;

module.exports = CoreView.extend({
  tagName: 'li',
  className: 'AssetsList-item AssetsList-item--medium',

  events: {
    'click .js-asset': '_onClick'
  },

  initialize: function (opts) {
    this.listenTo(this.model, 'change:state', this._changeState);
  },

  render: function () {
    this.clearSubViews();

    this.$el.attr('id', this.model.get('id'));

    var type = this.model.get('type') || 'icon';

    this.$el.append(template({
      type: type,
      height: this.options.assetHeight || ASSET_HEIGHT,
      name: this.model.get('name'),
      public_url: this.model.get('public_url')
    }));

    this.$el.addClass('AssetsList-item--' + type);

    return this;
  },

  _onClick: function (e) {
    this.killEvent(e);
    this.trigger('selected', this.model);
  },

  _changeState: function () {
    this.$el.toggleClass('is-selected', this.model.get('state') === 'selected');
  }
});

},{"./asset-item-view.tpl":113,"backbone/core-view":1127}],113:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="AssetItem-label CDB-Text CDB-Size-big ';
 if (type === 'icon') { 
__p+='u-mainTextColor';
 } else { 
__p+='u-actionTextColor';
 } 
__p+=' u-upperCase js-asset" title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">\n  ';
 if (type === 'icon' || type === 'file') { 
__p+='\n    <img height="'+
((__t=( height ))==null?'':_.escape(__t))+
'" src="'+
((__t=( public_url ))==null?'':_.escape(__t))+
'" alt="'+
((__t=( name ))==null?'':_.escape(__t))+
'" />\n  ';
 } else { 
__p+='\n    '+
((__t=( name ))==null?'':_.escape(__t))+
'\n  ';
 } 
__p+='\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],114:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var StaticAssetItemView = require('./static-asset-item-view');
var StaticAssetsCollection = require('../../../../../../data/static-assets-collection');
var checkAndBuildOpts = require('../../../../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'icons',
  'selectedAsset'
];

module.exports = CoreView.extend({
  tagName: 'ul',
  className: 'AssetsList',

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this._setupAssets(opts);
  },

  render: function () {
    this.clearSubViews();
    this._renderAssets();
    return this;
  },

  _renderAssets: function () {
    this._assetsCollection.each(function (mdl) {
      var item = new StaticAssetItemView({
        model: mdl
      });

      if (this.model && item.model.getURLFor(mdl.get('icon')) === this.model.get('image')) {
        item.model.set('state', 'selected');
      }

      item.bind('selected', this._selectItem, this);

      this.$el.append(item.render().el);
      this.addView(item);
    }, this);
  },

  _setupAssets: function (opts) {
    if (!_.isEmpty(opts)) {
      this._icons = _.map(this._icons, function (asset) {
        return _.extend(asset, opts);
      });
    }

    var assets = this._icons;

    if (this.options.limit) {
      assets = assets.slice(0, this.options.limit);
    }

    this._assetsCollection = new StaticAssetsCollection(assets);
    this.add_related_model(this._assetsCollection);
  },

  _selectItem: function (m) {
    this._selectedAsset.set({
      url: m.get('public_url'),
      kind: m.get('kind')
    });

    this._assetsCollection.deselectAll(m);
  }
});

},{"../../../../../../data/static-assets-collection":662,"../../../../../../helpers/required-opts":1097,"./static-asset-item-view":123,"backbone/core-view":1127,"underscore":"underscore"}],115:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var Backbone = require('backbone');

var Utils = require('../../../../../../helpers/utils');
var MakiIcons = require('../assets/maki-icons');
var UserAssetsView = require('./user-assets-tab');
var OrganizationAssetsListView = require('./organization-assets-list-view');
var OrganizationAssetsCollection = require('../../../../../../data/organization-assets-collection');
var UploadAssetsView = require('./upload-assets-tab');

var checkAndBuildOpts = require('../../../../../../helpers/required-opts');
var AssetsCollection = require('../../../../../../data/assets-collection');
var createTextLabelsTabPane = require('../../../../../tab-pane/create-text-labels-tab-pane');
var ScrollView = require('../../../../../scroll/scroll-view');
var AssetsListView = require('./assets-list-view');
var loadingView = require('../../../../../loading/render-loading');

var ErrorView = require('../../../../../error/error-view');
var errorTemplate = require('./upload-assets-error.tpl');
var errorParser = require('../../../../../../helpers/error-parser');

var template = require('./assets-view.tpl');
var tabPaneTemplate = require('./tab-pane-template.tpl');

var KIND = 'custom-marker';

var REQUIRED_OPTS = [
  'modalModel',
  'configModel',
  'userModel'
];

module.exports = CoreView.extend({
  className: 'Dialog-content Dialog-content--expanded',

  events: {
    'click .js-add': '_onSetImage',
    'click .js-upload': '_initUpload',
    'change .js-fileInput': '_onFileSelected',
    'click .js-back': '_onClickBack'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._initModels();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template({
      disclaimer: MakiIcons.disclaimer
    }));

    if (this._hasFetchedAllCollections()) {
      this._initTabPane();
    } else if (this._isLoading()) {
      this._renderLoading();
    } else if (this._hasError()) {
      this._renderError();
    }
    return this;
  },

  _hasFetchedAllCollections: function () {
    return this._stateModel.get('status') === 'show';
  },

  _initModels: function () {
    var self = this;

    this._selectedAsset = new Backbone.Model({
      url: this.model.get('image')
    });

    this._stateModel = new Backbone.Model({
      status: 'loading',
      modalEnabled: false,
      uploads: 0
    });

    this._assetCollections = [];

    this._userAssetCollection = new AssetsCollection(null, {
      configModel: this._configModel,
      userModel: this._userModel
    });

    this._assetCollections.push(this._userAssetCollection);

    if (this._userModel.isInsideOrg()) {
      this._organizationAssetCollection = new OrganizationAssetsCollection(null, {
        configModel: this._configModel,
        orgId: this._userModel.getOrganization().get('id')
      });
      this._assetCollections.push(this._organizationAssetCollection);
    }

    var onFetchAssetCollections = _.invoke(this._assetCollections, 'fetch');
    $.when.apply($, onFetchAssetCollections)
      .then(function () {
        self._stateModel.set('status', 'show');
      }, function (model, response) {
        self._setError(response);
      });
  },

  _initBinds: function () {
    this.listenTo(this._selectedAsset, 'change:url', this._onChangeSelectedAsset);
    this.listenTo(this._stateModel, 'change:status', this.render);
    this.listenTo(this._stateModel, 'change:modalEnabled', this._onChangeSetButton);
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this._stateModel.set('status', 'show');
    this._assetsTabPaneView.setSelectedTabPaneByName('upload-file');
  },

  _upload: function (data) {
    this._userAssetCollection.create(data, {
      beforeSend: this._beforeAssetUpload.bind(this),
      success: this._onAssetUploaded.bind(this),
      error: this._onAssetUploadError.bind(this),
      complete: this._onAssetUploadComplete.bind(this)
    });
  },

  _renderError: function () {
    this._hideDisclaimer();

    this.$('.js-body').html(
      new ErrorView({
        title: Utils.capitalize(this._stateModel.get('error_message')),
        desc: _t('components.modals.assets-picker.error-desc'),
        template: errorTemplate
      }).render().el
    );
  },

  _renderLoading: function () {
    this._hideDisclaimer();

    this.$('.js-body').html(
      loadingView({
        title: _t('components.modals.assets-picker.loading')
      })
    );
  },

  _isLoading: function () {
    return this._stateModel.get('status') === 'loading';
  },

  _hasError: function () {
    return this._stateModel.get('status') === 'error';
  },

  _initTabPane: function () {
    var tabPaneTabs = [{
      name: 'maki-icons',
      label: _t('components.modals.add-asset.icons'),
      createContentView: this._createMakiIconsView.bind(this)
    }, {
      name: 'your-uploads',
      label: _t('components.modals.add-asset.your-uploads'),
      createContentView: this._createYourUploadsView.bind(this)
    }];

    if (this._userModel.isInsideOrg() && this._organizationAssetCollection.length > 0) {
      tabPaneTabs.push({
        name: 'organization-uploads',
        label: _t('components.modals.add-asset.organization-uploads'),
        createContentView: this._createOrganizationUploadsView.bind(this)
      });
    }

    tabPaneTabs.push({
      name: 'upload-file',
      label: _t('components.modals.add-asset.upload-file'),
      createContentView: this._createUploadFileView.bind(this)
    });

    var tabPaneOptions = {
      tabPaneOptions: {
        template: tabPaneTemplate,
        disclaimer: MakiIcons.disclaimer,
        tabPaneItemOptions: {
          tagName: 'li',
          className: 'CDB-NavMenu-item'
        }
      },
      tabPaneItemLabelOptions: {
        tagName: 'button',
        className: 'CDB-NavMenu-link u-upperCase'
      }
    };

    this._assetsTabPaneView = createTextLabelsTabPane(tabPaneTabs, tabPaneOptions);
    this.listenTo(this._assetsTabPaneView.collection, 'change', this._onChangeSelectedTab);

    this.addView(this._assetsTabPaneView);
    this.$('.js-body').append(this._assetsTabPaneView.render().el);

    this._initSetButtonState();
  },

  _onChangeSelectedTab: function () {
    switch (this._assetsTabPaneView.getSelectedTabPaneName()) {
      case 'maki-icons':
        this._setDisclaimer(MakiIcons.disclaimer);
        this._toggleSetButton();
        break;
      case 'upload-file':
        this._hideDisclaimer();
        this._disableSetButton();
        break;
      default:
        this._hideDisclaimer();
        this._toggleSetButton();
        break;
    }
  },

  _toggleSetButton: function () {
    this._stateModel.set('modalEnabled', this._selectedAsset.get('url') !== undefined);
  },

  _initSetButtonState: function () {
    if (!this.model.get('image')) {
      return;
    }

    var selectedAssetExist = false;

    if (this.model.get('kind') === 'marker') {
      selectedAssetExist = true;
    }

    if (!selectedAssetExist) {
      _.each(this._assetCollections, function (assetCollection) {
        if (!selectedAssetExist) {
          selectedAssetExist = assetCollection.some(function (mdl) {
            return this.model.get('image') === mdl.get('public_url');
          }, this);
        }
      }, this);
    }

    if (selectedAssetExist) {
      this._enableSetButton();
    }
  },

  _enableSetButton: function () {
    this._stateModel.set('modalEnabled', true);
  },

  _disableSetButton: function () {
    this._stateModel.set('modalEnabled', false);
  },

  _createYourUploadsView: function () {
    var view = new UserAssetsView({
      model: this.model,
      selectedAsset: this._selectedAsset,
      title: _t('components.modals.add-asset.your-uploads'),
      organizationAssetCollection: this._organizationAssetCollection,
      userAssetCollection: this._userAssetCollection,
      userModel: this._userModel
    }).bind(this);

    this._userAssetsView = view;

    view.bind('init-upload', this._initUpload, this);

    this._hideDisclaimer();

    return this._userAssetsView;
  },

  _createOrganizationUploadsView: function () {
    var view = new ScrollView({
      createContentView: function () {
        return new OrganizationAssetsListView({
          title: _t('components.modals.add-asset.organization-uploads'),
          model: this.model,
          organizationAssetCollection: this._organizationAssetCollection,
          userAssetCollection: this._userAssetCollection,
          selectedAsset: this._selectedAsset
        });
      }.bind(this)
    });

    this._hideDisclaimer();

    return view;
  },

  _createUploadFileView: function () {
    var view = new UploadAssetsView({
      model: this.model,
      userModel: this._userModel,
      configModel: this._configModel
    }).bind(this);

    view.bind('upload-complete', this._onUploadComplete, this);
    view.bind('upload-files', this._uploadFiles, this);
    view.bind('upload-url', this._uploadURL, this);
    return view;
  },

  _createMakiIconsView: function () {
    return new ScrollView({
      createContentView: function () {
        return new AssetsListView({
          model: this.model,
          selectedAsset: this._selectedAsset,
          title: _t('components.modals.add-asset.maki-icons'),
          icons: MakiIcons.icons,
          folder: 'maki-icons',
          kind: 'marker',
          size: '18'
        });
      }.bind(this)
    });
  },

  _onUploadComplete: function () {
    this._assetsTabPaneView.setSelectedTabPaneByName('your-uploads');
  },

  _onChangeSetButton: function () {
    this.$('.js-add').toggleClass('is-disabled', !this._stateModel.get('modalEnabled'));
  },

  _onChangeSelectedAsset: function () {
    if (!this._selectedAsset.get('url')) {
      this.model.unset('image');
      this.model.unset('kind');
    }

    this._stateModel.set('modalEnabled', !!this._selectedAsset.get('url'));
  },

  _initUpload: function (e) {
    this.killEvent(e);
    this.$('.js-fileInput').click();
  },

  _setDisclaimer: function (disclaimer) {
    this.$('.js-disclaimer').html(disclaimer);
  },

  _hideDisclaimer: function () {
    this.$('.js-disclaimer').html('');
  },

  _getSelectedFiles: function () {
    return this.$('.js-fileInput').prop('files');
  },

  _uploadURL: function (url) {
    this._upload({
      type: 'url',
      kind: KIND,
      url: url
    });
  },

  _uploadFiles: function (files) {
    _.each(files, function (file) {
      this._upload({
        kind: KIND,
        type: 'file',
        filename: file
      });
    }, this);
  },

  _onFileSelected: function () {
    this._uploadFiles(this._getSelectedFiles());
  },

  _beforeAssetUpload: function () {
    this._stateModel.set('uploads', this._stateModel.get('uploads') + 1);

    if (this._stateModel.get('uploads') > 0) {
      this._stateModel.set('status', 'loading');
    }
  },

  _onAssetUploaded: function (iconModel) {
    this._resetFileSelection();
  },

  _setError: function (error) {
    this._stateModel.set({
      error_message: errorParser(error),
      status: 'error'
    });
  },

  _onAssetUploadError: function (model, response) {
    this._resetFileSelection();
    this._setError(response);
  },

  _onAssetUploadComplete: function () {
    this._stateModel.set('uploads', this._stateModel.get('uploads') - 1);

    if (this._stateModel.get('uploads') < 1 && !this._hasError()) {
      this._stateModel.set('status', 'show');
      this._onUploadComplete();
    }
  },

  _resetFileSelection: function () {
    this.$('.js-fileInput').val('');
  },

  _onSetImage: function (e) {
    this.killEvent(e);

    if (!this._stateModel.get('modalEnabled')) {
      return;
    }

    this.model.set({
      image: this._selectedAsset.get('url'), // backend serves the url of the asset in `image`
      kind: this._selectedAsset.get('kind')
    });

    this.trigger('change', {
      url: this._selectedAsset.get('url'),
      kind: this._selectedAsset.get('kind')
    }, this);

    this._modalModel.destroy(this.model);
  }
});

},{"../../../../../../data/assets-collection":606,"../../../../../../data/organization-assets-collection":650,"../../../../../../helpers/error-parser":1090,"../../../../../../helpers/required-opts":1097,"../../../../../../helpers/utils":1102,"../../../../../error/error-view":67,"../../../../../loading/render-loading":230,"../../../../../scroll/scroll-view":530,"../../../../../tab-pane/create-text-labels-tab-pane":537,"../assets/maki-icons":132,"./assets-list-view":114,"./assets-view.tpl":116,"./organization-assets-list-view":121,"./tab-pane-template.tpl":125,"./upload-assets-error.tpl":126,"./upload-assets-tab":127,"./user-assets-tab":131,"backbone":"backbone","backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],116:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Modal">\n  <div class="Modal-header">\n    <div class="Modal-headerContainer">\n      <h2 class="CDB-Text CDB-Size-huge is-light u-bSpace">'+
((__t=( _t('components.modals.add-asset.modal-title') ))==null?'':_.escape(__t))+
'</h2>\n      <h3 class="CDB-Text CDB-Size-medium u-altTextColor"><button class="u-actionTextColor js-upload">'+
((__t=( _t('components.modals.add-asset.upload-asset') ))==null?'':_.escape(__t))+
'</button> '+
((__t=( _t('components.modals.add-asset.modal-desc') ))==null?'':_.escape(__t))+
'</h3>\n    </div>\n  </div>\n\n  <div class="Modal-container js-body"></div>\n\n  <div class="Modal-footer">\n    <div class="Modal-footerContainer u-flex u-justifySpace">\n      <div class="CDB-Text CDB-Size-medium js-disclaimer">\n        ';
 if (disclaimer) { 
__p+='\n        '+
((__t=( disclaimer ))==null?'':__t)+
'\n        ';
 } 
__p+='\n      </div>\n\n      <button class="CDB-Button CDB-Button--primary is-disabled js-add">\n        <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.add-asset.set-image') ))==null?'':_.escape(__t))+
'</span>\n      </button>\n    </div>\n  </div>\n</div>\n\n<form accept-charset="UTF-8" enctype="multipart/form-data" method="post">\n  <input type="file" accept="image/jpeg,image/jpg,image/gif,image/png,image/svg+xml" class="js-fileInput" style="position: absolute; clip: rect(0px 0px 0px 0px); opacity: 0;" multiple="multiple">\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],117:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./input-asset-picker-header.tpl');
var ImageLoaderView = require('../../../../../img-loader-view');

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_onClickBack',
    'click .js-colorPicker': '_onClickColorPicker'
  },

  initialize: function (opts) {
    this._imageEnabled = opts.imageEnabled;

    this._initBinds();
  },

  render: function (model, options) {
    this.clearSubViews();
    this.$el.empty();

    var rampItem = this._getRampItem();

    this.$el.append(template({
      index: this.model.get('index') || 0,
      color: rampItem.color || '',
      label: rampItem.title || _t('form-components.editors.fill.input-categories.others'),
      image: rampItem.image || '',
      imageEnabled: this._imageEnabled
    }));

    this._loadImages();

    return this;
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:image', this.render);
  },

  _getRampItem: function () {
    var ramp = this.model.get('ramp');

    if (!ramp) {
      return {
        color: '',
        title: _t('form-components.editors.fill.input-categories.others'),
        image: ''
      };
    }

    return ramp[this.model.get('index')];
  },

  _loadImages: function () {
    var rampItem = this._getRampItem();

    this.iconView = new ImageLoaderView({
      imageClass: 'CDB-Text u-actionTextColor js-assetPicker',
      imageUrl: rampItem.image,
      color: rampItem.color
    });
    this.addView(this.iconView);
    this.$('.js-image-container').append(this.iconView.render().el);
  },

  _onClickBack: function (ev) {
    this.killEvent(ev);
    this.trigger('back', this);
  },

  _onClickColorPicker: function (ev) {
    this.killEvent(ev);
    this.trigger('goToColorPicker', this);
  }
});

},{"../../../../../img-loader-view":213,"./input-asset-picker-header.tpl":118,"backbone/core-view":1127}],118:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeader">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemDisplay--flex CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <div class=\'CDB-ListDecoration-secondaryContainer\'>\n        <button class="u-rSpace u-actionTextColor js-back">\n          <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n        </button>\n        <span class="label js-label">'+
((__t=( label ))==null?'':_.escape(__t))+
'</span>\n      </div>\n\n      <div class=\'CDB-ListDecoration-secondaryContainer\'>\n        <nav class=\'CDB-NavMenu\'>\n          <ul class=\'CDB-NavMenu-Inner CDB-NavMenu-inner--no-margin js-menu\'>\n            <li class=\'CDB-NavMenu-item\'>\n              <div class=\'CDB-NavMenu-link CDB-ListDecoration-rampNav-item\'>\n                <button class="ColorBar CDB-ListDecoration-rampItemBar u-rSpace--xl js-colorPicker" style="background-color: '+
((__t=( color ))==null?'':__t)+
';" type="button"></button>\n              </div>\n            </li>\n\n            ';
 if (imageEnabled) { 
__p+='\n              <li class=\'CDB-NavMenu-item is-selected\'>\n                <div class=\'CDB-NavMenu-link CDB-ListDecoration-rampNav-item\'>\n                  ';
 if (image) { 
__p+='\n                    <div class=\'CDB-ListDecoration-rampImg js-image-container\'></div>\n                  ';
 } else { 
__p+='\n                    <span class="CDB-ListDecoration-rampImg CDB-Text js-assetPicker">'+
((__t=( _t('form-components.editors.fill.input-color.img') ))==null?'':__t)+
'</span>\n                  ';
 } 
__p+='\n                </div>\n              </li>\n            ';
 } 
__p+='\n          </ul>\n        </nav>\n      </div>\n    </li>\n  </ul>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],119:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var template = require('./input-asset-picker-view.tpl');
var InputAssetPickerHeader = require('./input-asset-picker-header');
var InputAssetPickerView = require('../input-color-file-view');
var checkAndBuildOpts = require('../../../../../../helpers/required-opts');
var REQUIRED_OPTS = [
  'configModel',
  'modals',
  'ramp',
  'userModel'
];

module.exports = CoreView.extend({
  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this._imageEnabled = opts.imageEnabled;

    this.model = new Backbone.Model({
      index: this.options.index,
      ramp: opts.ramp
    });
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());
    this._initViews();
    return this;
  },

  _initViews: function () {
    this._headerView = new InputAssetPickerHeader({
      model: this.model,
      imageEnabled: this._imageEnabled
    });
    this._headerView.bind('goToColorPicker', this._onGoToColorPicker, this);
    this._headerView.bind('back', this._onClickBack, this);
    this.$('.js-header').append(this._headerView.render().el);
    this.addView(this._headerView);

    this._assetPicker = new InputAssetPickerView({
      model: this.model,
      userModel: this._userModel,
      configModel: this._configModel,
      modals: this._modals,
      imageEnabled: this._imageEnabled
    });
    this._assetPicker.bind('change', _.debounce(this._onChangeImage, 50), this);
    this.$('.js-content').append(this._assetPicker.render().el);
    this.addView(this._assetPicker);
  },

  _getRampItem: function () {
    var ramp = this.model.get('ramp');

    if (!ramp) {
      return {
        color: '',
        title: _t('form-components.editors.fill.input-categories.others'),
        image: ''
      };
    }

    return ramp[this.model.get('index')];
  },

  _onChangeImage: function (data) {
    var url = data && data.url || '';
    var kind = data && data.kind || '';

    this._getRampItem().image = url;
    this.model.trigger('change:image');

    this.trigger('change:image', {
      url: url,
      kind: kind,
      index: this.model.get('index')
    }, this);
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.trigger('back', this);
  },

  _onGoToColorPicker: function (e) {
    this.killEvent(e);
    this.trigger('goToColorPicker', this);
  }
});

},{"../../../../../../helpers/required-opts":1097,"../input-color-file-view":143,"./input-asset-picker-header":117,"./input-asset-picker-view.tpl":120,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],120:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-header"></div>\n<div class="js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],121:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var checkAndBuildOpts = require('../../../../../../helpers/required-opts');
var AssetItemView = require('./asset-item-view');
var template = require('./organization-assets-list-view.tpl');

var REQUIRED_OPTS = [
  'userAssetCollection',
  'organizationAssetCollection',
  'selectedAsset'
];

var KIND = 'custom-marker';
var ASSET_HEIGHT = 48;

module.exports = CoreView.extend({
  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template);

    this._organizationAssetCollection.deselectAll();
    this._organizationAssetCollection.each(this._renderAsset, this);

    return this;
  },

  _initBinds: function () {
    this.listenTo(this._organizationAssetCollection, 'reset', this.render);
    this.listenTo(this._organizationAssetCollection, 'change', this._onChangeAssets);
  },

  _getSelectedAsset: function () {
    var selectedAssets = this._organizationAssetCollection.where({ state: 'selected' });
    return selectedAssets && selectedAssets[0];
  },

  _renderAsset: function (assetModel) {
    var assetItemView = new AssetItemView({
      model: assetModel,
      assetHeight: ASSET_HEIGHT,
      selectedAsset: this._selectedAsset
    });

    if (assetModel.get('public_url') === this.model.get('image')) {
      assetModel.set('state', 'selected');
    }

    assetItemView.bind('selected', this._selectAsset, this);

    this.$('.js-assets').append(assetItemView.render().el);
    this.addView(assetItemView);
  },

  _onChangeAssets: function () {
    var selectedAsset = this._getSelectedAsset();

    this._selectedAsset.set({
      url: selectedAsset && selectedAsset.get('public_url'),
      kind: KIND
    });
  },

  _selectAsset: function (m) {
    m.set('state', 'selected');

    this._organizationAssetCollection.deselectAll(m);
    this._userAssetCollection.deselectAll();
  }

});

},{"../../../../../../helpers/required-opts":1097,"./asset-item-view":112,"./organization-assets-list-view.tpl":122,"backbone/core-view":1127}],122:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="AssetsList js-assets"></ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],123:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./static-asset-item-view.tpl');

module.exports = CoreView.extend({
  tagName: 'li',
  className: 'AssetsList-item AssetsList-item--medium',

  events: {
    'click .js-asset': '_onClick'
  },

  initialize: function () {
    this.listenTo(this.model, 'change:state', this._changeState);
  },

  render: function () {
    this.clearSubViews();

    this.$el.append(template({
      type: 'icon',
      name: this.model.get('name'),
      public_url: this.model.get('public_url')
    }));
    return this;
  },

  _onClick: function (e) {
    this.killEvent(e);
    this.trigger('selected', this.model);
    this.model.set('state', 'selected');
  },

  _changeState: function () {
    this.$el.toggleClass('is-selected', this.model.get('state') === 'selected');
  }
});

},{"./static-asset-item-view.tpl":124,"backbone/core-view":1127}],124:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (type === 'icon') { 
__p+='\n<div class="AssetItem-icon js-asset"><img height="24" src="'+
((__t=( public_url ))==null?'':_.escape(__t))+
'" alt="'+
((__t=( name ))==null?'':_.escape(__t))+
'" crossOrigin="anonymous" /></div>\n';
 } else { 
__p+='\n<div class="AssetItem-label CDB-Text CDB-Size-small u-altTextColor u-upperCase js-asset" title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">\n  '+
((__t=( name ))==null?'':_.escape(__t))+
'\n</div>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],125:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Modal-navigation">\n  <ul class="Modal-navigationInner CDB-Text is-semibold CDB-Size-medium js-menu"></ul>\n</div>\n<div class="Tab-paneContent Publish-modalContent Modal-inner Modal-inner--with-navigation js-content">\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],126:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="LayoutIcon LayoutIcon--negative">\n  <i class="CDB-IconFont CDB-IconFont-cockroach"></i>\n</div>\n<h3 class="CDB-Text CDB-Size-large u-mainTextColor u-errorTextColor u-bSpace--m u-tSpace-xl">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h3>\n<p class="CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( desc ))==null?'':__t)+
'</p>\n\n<button class="CDB-Button CDB-Button--primary u-tSpace-xl js-back">\n  <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.assets-picker.go-back') ))==null?'':_.escape(__t))+
'</span>\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],127:[function(require,module,exports){
var $ = require('jquery');
var Backbone = require('backbone');
var Utils = require('../../../../../../helpers/utils');

require('dragster');
var Dropzone = require('dropzone');
var CoreView = require('backbone/core-view');
var checkAndBuildOpts = require('../../../../../../helpers/required-opts');
var AssetsCollection = require('../../../../../../data/assets-collection');
var template = require('./upload-assets-tab.tpl');

var REQUIRED_OPTS = [
  'configModel',
  'userModel'
];

module.exports = CoreView.extend({
  className: 'Form-modal',

  events: {
    'keyup .js-url': '_onURLChanged',
    'click .js-submit': '_onClickSubmit'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._stateModel = new Backbone.Model({
      status: 'show',
      uploads: 0
    });

    this.listenTo(this._stateModel, 'change:status', this.render);

    this._assetCollection = new AssetsCollection(
      null, {
        configModel: this._configModel,
        userModel: this._userModel
      }
    );
  },

  render: function () {
    this.clearSubViews();

    this.$el.html(template());
    this._initDropzone();

    return this;
  },

  _initDropzone: function () {
    var el = $('html')[0];
    var self = this;

    this.dragster = new Dragster(el); // eslint-disable-line

    $(el).bind('dragster:enter', function (e) {
      self._showDropzone();
    });

    $(el).bind('dragster:leave', function (e) {
      self._hideDropzone();
    });

    if (el.dropzone) { // avoid loading the dropzone twice
      return;
    }

    this.dropzone = new Dropzone(el, {
      url: ':)',
      autoProcessQueue: false,
      previewsContainer: false
    });

    this.dropzone.on('dragover', function () {
      self._showDropzone();
    });

    this.dropzone.on('drop', function (e) {
      self.trigger('upload-files', e.dataTransfer.files);
      self._hideDropzone();
    });
  },

  _showDropzone: function () {
    this.$('.Form-upload').addClass('is-dropping');
  },

  _hideDropzone: function () {
    this.$('.Form-upload').removeClass('is-dropping');
  },

  _destroyDropzone: function () {
    var el = $('html')[0];

    if (this.dragster) {
      this.dragster.removeListeners();
      this.dragster.reset();
      $(el).unbind('dragster:enter dragster:leave');
    }

    if (this.dropzone) {
      this.dropzone.destroy();
    }
  },

  _hasError: function () {
    return this._stateModel.get('status') === 'error';
  },

  _onClickSubmit: function (e) {
    this.killEvent(e);

    var url = this._getURL();

    if (!url) {
      this._hideURLError();
      return;
    } else if (!Utils.isURL(url)) {
      this._showURLError();
      return;
    } else {
      this._hideURLError();
    }

    this.trigger('upload-url', url);
  },

  _getURL: function () {
    return this.$('.js-url').val();
  },

  _onURLChanged: function () {
    var url = this._getURL();

    if (!url) {
      this._hideURLError();
    } else if (!Utils.isURL(url)) {
      this._showURLError();
    } else {
      this._hideURLError();
    }
  },

  _showURLError: function () {
    this.$('.js-url-error').addClass('is-visible');
  },

  _hideURLError: function () {
    this.$('.js-url-error').removeClass('is-visible');
  },

  clean: function () {
    this._destroyDropzone();
    CoreView.prototype.clean.apply(this);
  }
});

},{"../../../../../../data/assets-collection":606,"../../../../../../helpers/required-opts":1097,"../../../../../../helpers/utils":1102,"./upload-assets-tab.tpl":128,"backbone":"backbone","backbone/core-view":1127,"dragster":1134,"dropzone":1135,"jquery":"jquery"}],128:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ImportPanel-header">\n  <h3 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m">\n    '+
((__t=( _t('components.modals.assets-picker.upload-file-url') ))==null?'':_.escape(__t))+
'\n  </h3>\n  <p class="CDB-Text CDB-Size-medium u-altTextColor">\n    '+
((__t=( _t('components.modals.assets-picker.upload-desc') ))==null?'':_.escape(__t))+
'\n  </p>\n</div>\n<div class="Form-row Form-row--centered">\n  <div class="Form-rowData Form-rowData--med Form-rowData--noMargin js-dropzone">\n    <div class="Form-upload">\n      <label class="Form-fileLabel js-fileLabel CDB-Text CDB-Size-medium">'+
((__t=( _t('components.modals.assets-picker.drag-and-drop') ))==null?'':_.escape(__t))+
'</label>\n      <label class="Form-fileLabel Form-fileLabel--error CDB-Text CDB-Size-small js-fileError"></label>\n      <div class="Form-file">\n        <span class="CDB-Button CDB-Button--primary Form-fileButton CDB-Button-Text CDB-Text is-semibold CDB-Size-small u-upperCase js-upload">\n          '+
((__t=( _t('components.modals.assets-picker.browse') ))==null?'':_.escape(__t))+
'\n        </span>\n      </div>\n    </div>\n  </div>\n  <span class="u-lSpace--xl u-rSpace--xl u-flex u-alignCenter CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( _t('components.modals.assets-picker.or') ))==null?'':_.escape(__t))+
'</span>\n  <div class="Form-rowData Form-rowData--noMargin Form-rowData--med">\n    <input type="text" class="Form-input Form-input--med has-submit js-url CDB-Text CDB-Size-medium" value="" placeholder="https://carto.com/markers/pin.png" />\n    <button type="submit" class="CDB-Text CDB-Size-small Form-inputSubmit u-upperCase u-actionTextColor Form-inputSubmit js-submit">\n      <span>'+
((__t=( _t('components.modals.assets-picker.submit') ))==null?'':_.escape(__t))+
'</span>\n    </button>\n    <div class="Form-inputError CDB-Text js-url-error">'+
((__t=( _t('components.modals.assets-picker.incorrect-url') ))==null?'':_.escape(__t))+
'</div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],129:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var AssetItemView = require('./asset-item-view');
var checkAndBuildOpts = require('../../../../../../helpers/required-opts');
var Backbone = require('backbone');
var loadingView = require('../../../../../loading/render-loading');
var AssetHeaderView = require('./asset-header-view');

var ErrorView = require('../../../../../error/error-view');
var errorTemplate = require('./upload-assets-error.tpl');
var template = require('./user-assets-list-view.tpl');

var REQUIRED_OPTS = [
  'userModel',
  'userAssetCollection',
  'selectedAsset'
];

var KIND = 'custom-marker';
var ASSET_HEIGHT = 48;

module.exports = CoreView.extend({
  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    if (this._userModel.isInsideOrg()) {
      if (!opts.organizationAssetCollection) throw new Error('organizationAssetCollection is required');

      this._organizationAssetCollection = opts.organizationAssetCollection;
    }

    this._stateModel = new Backbone.Model();

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template);

    if (this._isLoading()) {
      this._renderLoading();
    } else if (this._hasError()) {
      this._renderError();
    } else {
      this._renderRegularView();
    }

    return this;
  },

  _addHeaderView: function () {
    this._assetHeaderView = new AssetHeaderView({
      editable: true,
      title: this.options.title,
      assetsCollection: this._userAssetCollection
    });

    this.addView(this._assetHeaderView);
    this.$('.js-nav').append(this._assetHeaderView.render().el);

    this._assetHeaderView.bind('select-all', this._selectAllAssets, this);
    this._assetHeaderView.bind('deselect-all', this._deselectAllAssets, this);
    this._assetHeaderView.bind('remove', this._removeSelectedAssets, this);
  },

  _renderRegularView: function () {
    this._addHeaderView();
    this._renderAddButton();

    this._userAssetCollection.deselectAll();
    this._userAssetCollection.each(this._renderAsset, this);
  },

  _renderAddButton: function () {
    var addAssetButton = new AssetItemView({
      model: new Backbone.Model({
        type: 'text',
        name: '+'
      }),
      assetHeight: ASSET_HEIGHT
    });

    addAssetButton.bind('selected', function () {
      this.trigger('init-upload');
    }, this);

    this.addView(addAssetButton);
    this.$('.js-assets').append(addAssetButton.render().$el);
  },

  _initBinds: function () {
    this._keyDown = this._onKeyDown.bind(this);
    $(document).on('keydown', this._keyDown);

    this._keyUp = this._onKeyUp.bind(this);
    $(document).on('keyup', this._keyUp);

    this.listenTo(this._stateModel, 'change:status', this.render);
    this.listenTo(this._userAssetCollection, 'change', this._onChangeAssets);
  },

  _getSelectedAsset: function () {
    return this._userAssetCollection.findWhere({ state: 'selected' });
  },

  _getSelectedAssetsCount: function () {
    var selectedAssets = this._userAssetCollection.where({ state: 'selected' });
    return selectedAssets ? selectedAssets.length : 0;
  },

  _onKeyDown: function (ev) {
    this._shiftKeyPressed = ev.shiftKey;
  },

  _onKeyUp: function (ev) {
    this._shiftKeyPressed = ev.shiftKey;
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this._stateModel.unset('status');
  },

  _renderAsset: function (assetModel) {
    var assetItemView = new AssetItemView({
      model: assetModel,
      assetHeight: ASSET_HEIGHT,
      selectedAsset: this._selectedAsset
    });

    if (assetModel.get('public_url') === this.model.get('image')) {
      assetModel.set('state', 'selected');
    }

    assetItemView.bind('selected', this._selectAsset, this);

    this.$('.js-assets').append(assetItemView.render().el);
    this.addView(assetItemView);
  },

  _onChangeAssets: function () {
    if (this._getSelectedAssetsCount() === 1) {
      var selectedAsset = this._getSelectedAsset();
      this._selectedAsset.set({
        url: selectedAsset && selectedAsset.get('public_url'),
        kind: KIND
      });
    } else {
      this._selectedAsset.set({
        url: '',
        kind: ''
      });
    }
  },

  _selectAllAssets: function () {
    this._userAssetCollection.selectAll();
  },

  _deselectAllAssets: function () {
    this._userAssetCollection.deselectAll();
  },

  _selectAsset: function (m) {
    if (this._shiftKeyPressed) {
      m.set('state', m.get('state') === 'selected' ? '' : 'selected');
    } else {
      m.set('state', 'selected');
    }

    if (!this._shiftKeyPressed) {
      this._userAssetCollection.deselectAll(m);

      if (this._userModel.isInsideOrg()) {
        this._organizationAssetCollection.deselectAll();
      }
    }
  },

  _removeSelectedAssetsFromView: function () {
    var selectedAssets = this._userAssetCollection.select(function (asset) {
      return asset.get('state') === 'selected';
    }, this);

    _.each(selectedAssets, function (asset) {
      this.$('#' + asset.get('id')).remove();
    }, this);
  },

  _removeSelectedAssets: function () {
    this._stateModel.set('status', 'loading');

    var selectedAssets = this._userAssetCollection.select(function (asset) {
      return asset.get('state') === 'selected';
    }, this);

    _.each(selectedAssets, function (asset) {
      asset.destroy({
        complete: this._onDestroyFinished.bind(this)
      });
    }, this);
  },

  _onDestroyFinished: function (response) {
    if (response.status === 200) {
      this._removeSelectedAssetsFromView();
      this._stateModel.unset('status');
      this._selectedAsset.unset('kind');
      this._selectedAsset.unset('url');
    } else {
      this._stateModel.set({
        error_message: response.statusText,
        status: 'error'
      });
    }
  },

  _isLoading: function () {
    return this._stateModel.get('status') === 'loading';
  },

  _hasError: function () {
    return this._stateModel.get('status') === 'error';
  },

  _renderLoading: function () {
    this.$el.html(
      loadingView({
        title: _t('components.modals.assets-picker.loading')
      })
    );
  },

  _renderError: function () {
    this.$el.html(
      new ErrorView({
        title: this._stateModel.get('error_message'),
        desc: _t('components.modals.assets-picker.error-desc'),
        template: errorTemplate
      }).render().el
    );
  },

  _disableBinds: function () {
    $(document).off('keydown', this._keyDown);
    $(document).off('keyup', this._keyUp);
  },

  clean: function () {
    this._disableBinds();
    CoreView.prototype.clean.apply(this);
  }
});

},{"../../../../../../helpers/required-opts":1097,"../../../../../error/error-view":67,"../../../../../loading/render-loading":230,"./asset-header-view":110,"./asset-item-view":112,"./upload-assets-error.tpl":126,"./user-assets-list-view.tpl":130,"backbone":"backbone","backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],130:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<nav class="CDB-NavMenu u-bSpace--m u-inner js-nav"></nav>\n<ul class="AssetsList js-assets"></ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],131:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var checkAndBuildOpts = require('../../../../../../helpers/required-opts');
var ScrollView = require('../../../../../scroll/scroll-view');
var UserAssetsListView = require('./user-assets-list-view');

var REQUIRED_OPTS = [
  'userModel',
  'userAssetCollection',
  'title',
  'selectedAsset'
];

module.exports = CoreView.extend({
  events: {
    'change .js-uploadInput': '_onFileSelected'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    if (this._userModel.isInsideOrg()) {
      if (!opts.organizationAssetCollection) throw new Error('organizationAssetCollection is required');

      this._organizationAssetCollection = opts.organizationAssetCollection;
    }
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._renderAssets();
    return this;
  },

  _renderAssets: function () {
    var view = new ScrollView({
      createContentView: function () {
        var view = new UserAssetsListView({
          title: this._title,
          model: this.model,
          organizationAssetCollection: this._organizationAssetCollection,
          userAssetCollection: this._userAssetCollection,
          selectedAsset: this._selectedAsset,
          userModel: this._userModel
        });

        view.bind('init-upload', function () {
          this.trigger('init-upload');
        }, this);

        return view;
      }.bind(this)
    });

    this.addView(view);
    this.$el.append(view.render().el);
  }
});

},{"../../../../../../helpers/required-opts":1097,"../../../../../scroll/scroll-view":530,"./user-assets-list-view":129,"backbone/core-view":1127}],132:[function(require,module,exports){
// Maki icons from https://github.com/mapbox/maki
// and https://github.com/mapbox/maki/blob/mb-pages/_includes/maki.json
module.exports = {
  disclaimer: _t('assets.maki-icons.disclaimer'),
  icons: [
    {
      'name': 'Square stroked',
      'icon': 'square-stroked'
    },
    {
      'name': 'Square solid',
      'icon': 'square'
    },
    {
      'name': 'Triangle stroked',
      'icon': 'triangle-stroked'
    },
    {
      'name': 'Triangle solid',
      'icon': 'triangle'
    },
    {
      'name': 'Star stroked',
      'icon': 'star-stroked'
    },
    {
      'name': 'Star solid',
      'icon': 'star'
    },
    {
      'name': 'Cross',
      'icon': 'cross'
    },
    {
      'name': 'Marker Stroke',
      'icon': 'marker-stroked'
    },
    {
      'name': 'Marker Solid',
      'icon': 'marker'
    },
    {
      'name': 'Religious Jewish',
      'icon': 'religious-jewish'
    },
    {
      'name': 'Religious Christian',
      'icon': 'religious-christian'
    },
    {
      'name': 'Religious Muslim',
      'icon': 'religious-muslim'
    },
    {
      'name': 'Cemetery',
      'icon': 'cemetery'
    },
    {
      'name': 'Rocket',
      'icon': 'rocket'
    },
    {
      'name': 'Airport',
      'icon': 'airport'
    },
    {
      'name': 'Heliport',
      'icon': 'heliport'
    },
    {
      'name': 'Rail',
      'icon': 'rail'
    },
    {
      'name': 'Rail Metro',
      'icon': 'rail-metro'
    },
    {
      'name': 'Rail Light',
      'icon': 'rail-light'
    },
    {
      'name': 'Bus',
      'icon': 'bus'
    },
    {
      'name': 'Fuel',
      'icon': 'fuel'
    },
    {
      'name': 'Parking',
      'tags': [
        'parking',
        'transportation'
      ],
      'icon': 'parking'
    },
    {
      'name': 'Parking Garage',
      'tags': [
        'parking',
        'transportation',
        'garage'
      ],
      'icon': 'parking-garage'
    },
    {
      'name': 'Airfield',
      'tags': [
        'airfield',
        'airport',
        'plane',
        'landing strip'
      ],
      'icon': 'airfield'
    },
    {
      'name': 'Roadblock',
      'tags': [
        'roadblock',
        'stop',
        'warning',
        'dead end'
      ],
      'icon': 'roadblock'
    },
    {
      'name': 'Ferry',
      'tags': [
        'ship',
        'boat',
        'water',
        'ferry',
        'transportation'
      ],
      'icon': 'ferry'
    },
    {
      'name': 'Harbor',
      'tags': [
        'marine',
        'dock',
        'water',
        'wharf'
      ],
      'icon': 'harbor'
    },
    {
      'name': 'Bicycle',
      'tags': [
        'cycling',
        'cycle',
        'transportation'
      ],
      'icon': 'bicycle'
    },
    {
      'name': 'Park',
      'tags': [
        'recreation',
        'park',
        'forest',
        'tree',
        'green',
        'woods',
        'nature'
      ],
      'icon': 'park'
    },
    {
      'name': 'Park 2',
      'tags': [
        'recreation',
        'park',
        'forest',
        'tree',
        'green',
        'woods',
        'nature'
      ],
      'icon': 'park2'
    },
    {
      'name': 'Museum',
      'tags': [
        'recreation',
        'museum',
        'tourism'
      ],
      'icon': 'museum'
    },
    {
      'name': 'Lodging',
      'tags': [
        'lodging',
        'hotel',
        'recreation',
        'motel',
        'tourism'
      ],
      'icon': 'lodging'
    },
    {
      'name': 'Monument',
      'tags': [
        'recreation',
        'statue',
        'monument',
        'tourism'
      ],
      'icon': 'monument'
    },
    {
      'name': 'Zoo',
      'tags': [
        'recreation',
        'zoo',
        'animal',
        'giraffe'
      ],
      'icon': 'zoo'
    },
    {
      'name': 'Garden',
      'tags': [
        'recreation',
        'garden',
        'park',
        'flower',
        'nature'
      ],
      'icon': 'garden'
    },
    {
      'name': 'Campsite',
      'tags': [
        'recreation',
        'campsite',
        'camp',
        'camping',
        'tent',
        'nature'
      ],
      'icon': 'campsite'
    },
    {
      'name': 'Theatre',
      'tags': [
        'recreation',
        'theatre',
        'theater',
        'entertainment',
        'play',
        'performance'
      ],
      'icon': 'theatre'
    },
    {
      'name': 'Art gallery',
      'tags': [
        'art',
        'center',
        'museum',
        'gallery',
        'creative',
        'recreation',
        'entertainment',
        'studio'
      ],
      'icon': 'art-gallery'
    },
    {
      'name': 'Pitch',
      'tags': [
        'pitch',
        'track',
        'athletic',
        'sports',
        'field'
      ],
      'icon': 'pitch'
    },
    {
      'name': 'Soccer',
      'tags': [
        'soccer',
        'sports'
      ],
      'icon': 'soccer'
    },
    {
      'name': 'American Football',
      'tags': [
        'football',
        'sports'
      ],
      'icon': 'america-football'
    },
    {
      'name': 'Tennis',
      'tags': [
        'tennis',
        'court',
        'ball',
        'sports'
      ],
      'icon': 'tennis'
    },
    {
      'name': 'Basketball',
      'tags': [
        'basketball',
        'ball',
        'sports'
      ],
      'icon': 'basketball'
    },
    {
      'name': 'Baseball',
      'tags': [
        'baseball',
        'softball',
        'ball',
        'sports'
      ],
      'icon': 'baseball'
    },
    {
      'name': 'Golf',
      'tags': [
        'golf',
        'sports',
        'course'
      ],
      'icon': 'golf'
    },
    {
      'name': 'Swimming',
      'tags': [
        'swimming',
        'water',
        'swim',
        'sports'
      ],
      'icon': 'swimming'
    },
    {
      'name': 'Cricket',
      'tags': [
        'cricket',
        'sports'
      ],
      'icon': 'cricket'
    },
    {
      'name': 'Skiing',
      'tags': [
        'winter',
        'skiing',
        'ski',
        'sports'
      ],
      'icon': 'skiing'
    },
    {
      'name': 'School',
      'tags': [
        'school',
        'highschool',
        'elementary',
        'children',
        'amenity',
        'middle'
      ],
      'icon': 'school'
    },
    {
      'name': 'College',
      'tags': [
        'college',
        'school',
        'amenity',
        'university'
      ],
      'icon': 'college'
    },
    {
      'name': 'Library',
      'tags': [
        'library',
        'books',
        'amenity'
      ],
      'icon': 'library'
    },
    {
      'name': 'Post',
      'tags': [
        'post',
        'office',
        'amenity',
        'mail',
        'letter'
      ],
      'icon': 'post'
    },
    {
      'name': 'Fire station',
      'tags': [
        'fire',
        'station',
        'amenity'
      ],
      'icon': 'fire-station'
    },
    {
      'name': 'Town hall',
      'tags': [
        'townhall',
        'mayor',
        'building',
        'amenity',
        'government'
      ],
      'icon': 'town-hall'
    },
    {
      'name': 'Police',
      'tags': [
        'police',
        'jail',
        'arrest',
        'amenity',
        'station'
      ],
      'icon': 'police'
    },
    {
      'name': 'Prison',
      'tags': [
        'prison',
        'jail',
        'amenity'
      ],
      'icon': 'prison'
    },
    {
      'name': 'Embassy',
      'tags': [
        'embassy',
        'diplomacy',
        'consulate',
        'amenity',
        'flag'
      ],
      'icon': 'embassy'
    },
    {
      'name': 'Beer',
      'tags': [
        'bar',
        'beer',
        'drink',
        'commercial',
        'biergarten',
        'pub'
      ],
      'icon': 'beer'
    },
    {
      'name': 'Restaurant',
      'tags': [
        'restaurant',
        'commercial'
      ],
      'icon': 'restaurant'
    },
    {
      'name': 'Cafe',
      'tags': [
        'cafe',
        'coffee',
        'commercial',
        'tea'
      ],
      'icon': 'cafe'
    },
    {
      'name': 'Shop',
      'tags': [
        'shop',
        'mall',
        'commercial',
        'store'
      ],
      'icon': 'shop'
    },
    {
      'name': 'Fast Food',
      'tags': [
        'food',
        'fast',
        'commercial',
        'burger',
        'drive-through'
      ],
      'icon': 'fast-food'
    },
    {
      'name': 'Bar',
      'tags': [
        'bar',
        'drink',
        'commercial',
        'club',
        'martini',
        'lounge'
      ],
      'icon': 'bar'
    },
    {
      'name': 'Bank',
      'tags': [
        'bank',
        'atm',
        'commercial',
        'money'
      ],
      'icon': 'bank'
    },
    {
      'name': 'Grocery',
      'tags': [
        'food',
        'grocery',
        'commercial',
        'store',
        'market'
      ],
      'icon': 'grocery'
    },
    {
      'name': 'Cinema',
      'tags': [
        'cinema',
        'theatre',
        'film',
        'movie',
        'commercial',
        'theater',
        'entertainment'
      ],
      'icon': 'cinema'
    },
    {
      'name': 'Pharmacy',
      'tags': [
        'pharmacy',
        'drugs',
        'medication',
        'social',
        'medicine',
        'prescription'
      ],
      'icon': 'pharmacy'
    },
    {
      'name': 'Hospital',
      'tags': [
        'hospital',
        'health',
        'medication',
        'social',
        'medicine',
        'medical',
        'clinic'
      ],
      'icon': 'hospital'
    },
    {
      'name': 'Danger',
      'tags': [
        'minefield',
        'landmine',
        'disaster',
        'dangerous',
        'hazard'
      ],
      'icon': 'danger'
    },
    {
      'name': 'Industrial',
      'tags': [
        'industrial',
        'factory',
        'property',
        'building'
      ],
      'icon': 'industrial'
    },
    {
      'name': 'Warehouse',
      'tags': [
        'warehouse',
        'property',
        'storage',
        'building'
      ],
      'icon': 'warehouse'
    },
    {
      'name': 'Commercial',
      'tags': [
        'commercial',
        'property',
        'business',
        'building'
      ],
      'icon': 'commercial'
    },
    {
      'name': 'Building',
      'tags': [
        'building',
        'property',
        'structure',
        'business',
        'building'
      ],
      'icon': 'building'
    },
    {
      'name': 'Place of worship',
      'tags': [
        'religion',
        'ceremony',
        'religious',
        'nondenominational',
        'church',
        'temple'
      ],
      'icon': 'place-of-worship'
    },
    {
      'name': 'Alcohol shop',
      'tags': [
        'alcohol',
        'liquor',
        'store',
        'shop',
        'beer',
        'wine',
        'vodka'
      ],
      'icon': 'alcohol-shop'
    },
    {
      'name': 'Logging',
      'tags': [
        'logger',
        'chainsaw',
        'woods',
        'industry'
      ],
      'icon': 'logging'
    },
    {
      'name': 'Oil well',
      'tags': [
        'oil',
        'natural',
        'environment',
        'industry',
        'resources'
      ],
      'icon': 'oil-well'
    },
    {
      'name': 'Slaughterhouse',
      'tags': [
        'cows',
        'cattle',
        'food',
        'meat',
        'industry',
        'resources'
      ],
      'icon': 'slaughterhouse'
    },
    {
      'name': 'Dam',
      'tags': [
        'water',
        'natural',
        'hydro',
        'hydroelectric',
        'energy',
        'environment',
        'industry',
        'resources'
      ],
      'icon': 'dam'
    },
    {
      'name': 'Water',
      'tags': [
        'water',
        'natural',
        'hydro',
        'lake',
        'river',
        'ocean',
        'resources'
      ],
      'icon': 'water'
    },
    {
      'name': 'Wetland',
      'tags': [
        'water',
        'swamp',
        'natural'
      ],
      'icon': 'wetland'
    },
    {
      'name': 'Disability',
      'tags': [
        'handicap',
        'wheelchair',
        'access'
      ],
      'icon': 'disability'
    },
    {
      'name': 'Telephone',
      'tags': [
        'payphone',
        'call'
      ],
      'icon': 'telephone'
    },
    {
      'name': 'Emergency Telephone',
      'tags': [
        'payphone',
        'danger',
        'safety',
        'call'
      ],
      'icon': 'emergency-telephone'
    },
    {
      'name': 'Toilets',
      'tags': [
        'bathroom',
        'men',
        'women',
        'sink',
        'washroom',
        'lavatory'
      ],
      'icon': 'toilets'
    },
    {
      'name': 'Waste Basket',
      'tags': [
        'trash',
        'rubbish',
        'bin',
        'garbage'
      ],
      'icon': 'waste-basket'
    },
    {
      'name': 'Music',
      'tags': [
        'stage',
        'performance',
        'band',
        'concert',
        'venue'
      ],
      'icon': 'music'
    },
    {
      'name': 'Land Use',
      'tags': [
        'zoning',
        'usage',
        'area'
      ],
      'icon': 'land-use'
    },
    {
      'name': 'City',
      'tags': [
        'area',
        'point',
        'place',
        'urban'
      ],
      'icon': 'city'
    },
    {
      'name': 'Town',
      'tags': [
        'area',
        'point',
        'place',
        'small'
      ],
      'icon': 'town'
    },
    {
      'name': 'Village',
      'tags': [
        'area',
        'point',
        'place',
        'small',
        'rural'
      ],
      'icon': 'village'
    },
    {
      'name': 'Farm',
      'tags': [
        'building',
        'farming',
        'crops',
        'plants',
        'agriculture',
        'rural'
      ],
      'icon': 'farm'
    },
    {
      'name': 'Bakery',
      'tags': [
        'bakery',
        'pastry',
        'croissant',
        'food',
        'shop',
        'bread'
      ],
      'icon': 'bakery'
    },
    {
      'name': 'Dog Park',
      'tags': [
        'dog',
        'pet'
      ],
      'icon': 'dog-park'
    },
    {
      'name': 'Lighthouse',
      'tags': [
        'building',
        'navigation',
        'nautical',
        'ocean',
        'logistics'
      ],
      'icon': 'lighthouse'
    },
    {
      'name': 'Clothing Store',
      'tags': [
        'clothing',
        'store',
        'shop'
      ],
      'icon': 'clothing-store'
    },
    {
      'name': 'Polling Place',
      'icon': 'polling-place'
    },
    {
      'name': 'Playground',
      'icon': 'playground'
    },
    {
      'name': 'Entrance',
      'icon': 'entrance'
    },
    {
      'name': 'Heart',
      'icon': 'heart'
    },
    {
      'name': 'London Underground',
      'icon': 'london-underground'
    },
    {
      'name': 'Minefield',
      'icon': 'minefield'
    },
    {
      'name': 'Rail Underground',
      'icon': 'rail-underground'
    },
    {
      'name': 'Rail Above',
      'icon': 'rail-above'
    },
    {
      'name': 'Camera',
      'icon': 'camera'
    },
    {
      'name': 'Laundry',
      'icon': 'laundry'
    },
    {
      'name': 'Car',
      'icon': 'car'
    },
    {
      'name': 'Suitcase',
      'icon': 'suitcase'
    },
    {
      'name': 'Hairdresser',
      'icon': 'hairdresser'
    },
    {
      'name': 'Chemist',
      'icon': 'chemist'
    },
    {
      'name': 'Mobile phone',
      'icon': 'mobilephone'
    },
    {
      'name': 'Scooter',
      'icon': 'scooter'
    }
  ]
};

},{}],133:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');
var ImageLoaderView = require('../../../../../../img-loader-view');
var CustomListItemView = require('../../../../../../custom-list/custom-list-item-view');

module.exports = CustomListItemView.extend({

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    var name = this.model.getName() == null ? 'null' : this.model.getName();

    this.$el.append(
      this.options.template(
        _.extend({
          typeLabel: this.options.typeLabel,
          isSelected: this.model.get('selected'),
          isDisabled: this.model.get('disabled'),
          isDestructive: this.model.get('destructive'),
          name: name,
          val: this.model.getValue(),
          options: this.model.get('renderOptions'),
          image: this.model.get('image'),
          imageEnabled: this.options.imageEnabled
        })
      )
    );

    this._loadImages();

    this.$el
      .attr('data-val', this.model.getValue())
      .toggleClass('is-disabled', !!this.model.get('disabled'));

    return this;
  },

  _loadImages: function () {
    this.iconView = new ImageLoaderView({
      imageClass: 'CDB-Text u-actionTextColor js-assetPicker',
      imageUrl: this.model.get('image'),
      color: this.model.get('val')
    });
    this.addView(this.iconView);
    this.$('.js-image-container').append(this.iconView.render().el);
  },

  _onClick: function (ev) {
    this.killEvent(ev);
    var $target = $(ev.target);
    var isIconClicked = $target.closest('.js-image-container').length > 0;
    var isImgClicked = $target.closest('.js-assetPicker').length > 0;

    this.model.set({
      selectedClass: isImgClicked || isIconClicked ? ['js-assetPicker'] : [],
      selected: true
    });
  }
});

},{"../../../../../../custom-list/custom-list-item-view":50,"../../../../../../img-loader-view":213,"jquery":"jquery","underscore":"underscore"}],134:[function(require,module,exports){
var CustomListView = require('../../../../../../custom-list/custom-list-view');

module.exports = CustomListView.extend({
  _renderItem: function (mdl) {
    var ItemViewClass = this.options.ItemView;
    var itemView = new ItemViewClass({
      model: mdl,
      typeLabel: this.options.typeLabel,
      template: this.options.itemTemplate,
      imageEnabled: this.options.imageEnabled
    });
    this.$('.js-list').append(itemView.render().el);
    this.addView(itemView);

    // 'customEvent' comes from custom list component
    itemView.bind('customEvent', function (eventName, item) {
      this.trigger('customEvent', eventName, item, this);
    }, this);
  }
});

},{"../../../../../../custom-list/custom-list-view":57}],135:[function(require,module,exports){
var CustomView = require('../../../../../../custom-list/custom-view.js');
var itemTemplate = require('../../../../../../custom-list/custom-list-item.tpl');
var CategoriesListItemView = require('./categories-list-item-view');
var CategoriesListView = require('./categories-list-view');

module.exports = CustomView.extend({
  options: {
    showSearch: true,
    allowFreeTextInput: false,
    typeLabel: 'column',
    itemTemplate: itemTemplate,
    itemView: CategoriesListItemView
  },

  _renderList: function () {
    this._listView = new CategoriesListView({
      model: this.model,
      allowFreeTextInput: this.options.allowFreeTextInput,
      collection: this.collection,
      typeLabel: this.options.typeLabel,
      ItemView: this.options.itemView,
      itemTemplate: this.options.itemTemplate,
      size: this.options.size,
      imageEnabled: this.options.imageEnabled
    });
    this.$el.append(this._listView.render().el);
    this._listView.highlight();
    this.addView(this._listView);

    // 'customEvent' comes from custom list component
    this._listView.bind('customEvent', function (eventName, item) {
      this.trigger(eventName, item, this);
    }, this);
  }
});

},{"../../../../../../custom-list/custom-list-item.tpl":52,"../../../../../../custom-list/custom-view.js":59,"./categories-list-item-view":133,"./categories-list-view":134}],136:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-ListDecoration-itemLink u-flex u-justifySpace u-alignCenter ';
 if (isSelected) { 
__p+=' is-selected ';
 } 
__p+='">\n  <span class="RampItem-text CDB-Text u-ellipsis u-actionTextColor" title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">'+
((__t=( name ))==null?'':_.escape(__t))+
'</span>\n\n  <div class=\'RampItem-secondaryContainer\'>\n    <div class="ColorBar RampItem-bar js-colorPicker" style="background-color: '+
((__t=( val ))==null?'':_.escape(__t))+
';"></div>\n\n    ';
 if (imageEnabled) { 
__p+='\n      <div class=\'RampItem-img\'>\n        ';
 if (image) { 
__p+='\n          <div class=\'js-image-container u-flex\'></div>\n        ';
 } else { 
__p+='\n          <button class="CDB-Text u-actionTextColor js-assetPicker">'+
((__t=( _t('form-components.editors.fill.input-color.img') ))==null?'':__t)+
'</button>\n        ';
 } 
__p+='\n      </div>\n    ';
 } 
__p+='\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],137:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');
var Utils = require('../../../../../../helpers/utils');
var CoreView = require('backbone/core-view');
var CategoriesListView = require('./categories-list/categories-view');
var CustomListCollection = require('../../../../../custom-list/custom-list-collection');
var template = require('./input-color-categories-list-view.tpl');
var itemTemplate = require('./input-color-categories-list-item.tpl');

module.exports = CoreView.extend({
  events: {
    'click .js-color': '_onClickColor'
  },

  initialize: function (opts) {
    this._showSearch = opts.showSearch || false;
    this._typeLabel = opts.typeLabel;
    this._maxValues = opts.maxValues;

    this._setupCollection();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    this.$el.append(template({
      range: this.model.get('range'),
      attribute: this.model.get('attribute')
    }));

    this._listView = new CategoriesListView({
      itemTemplate: itemTemplate,
      collection: this._collection,
      showSearch: this._showSearch,
      typeLabel: this._typeLabel,
      imageEnabled: this.options.imageEnabled
    });

    this.addView(this._listView);

    this.$('.js-content').append(this._listView.render().$el);

    return this;
  },

  _setupCollection: function () {
    this._collection = new CustomListCollection(null, {silent: false});

    var range = this.model.get('range');
    var domain = this.model.get('domain');
    var images = this.model.get('images');

    if (range && range.length && domain && domain.length) {
      var categories = _.map(range, function (color, i) {
        var isNull = domain[i] == null || (_.isString(domain[i]) && Utils.isBlank(domain[i]));
        var label = domain[i];

        if (i >= this._maxValues) {
          label = _t('form-components.editors.fill.input-categories.others');
        } else if (isNull) {
          label = _t('form-components.editors.fill.input-categories.null');
        }

        var attrs = {
          label: label,
          val: color
        };

        if (images && images.length) {
          attrs['image'] = images[i];
        }

        return attrs;
      }, this);

      this._collection.reset(categories);
    }
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.trigger('back', this);
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:range', this.render);
    this.listenTo(this.model, 'change:domain', this.render);
    this.listenTo(this._collection, 'change:selected', this._onSelectItem);
  },

  _onClickColor: function (ev) {
    this.killEvent(ev);
    var index = $(ev.target).index();
    var color = this._collection.at(index);
    color && this._onSelectItem(color);
  },

  _onSelectItem: function (item) {
    var selectedItem = {
      index: this._collection.indexOf(item),
      target: _.contains(item.get('selectedClass'), 'js-assetPicker') ? 'asset' : 'color'
    };

    this.trigger('selectItem', selectedItem, this);
  }
});

},{"../../../../../../helpers/utils":1102,"../../../../../custom-list/custom-list-collection":47,"./categories-list/categories-view":135,"./input-color-categories-list-item.tpl":136,"./input-color-categories-list-view.tpl":138,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],138:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeader">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical CDB-Text CDB-Size-medium u-secondaryTextColor u-flex u-alignCenter">\n      <ul class="ColorBarContainer">\n        ';
 _.each(range, function (color) { 
__p+='\n          <li class="ColorBar ColorBar--spaceless ColorBar--clickable js-color" style="background-color: '+
((__t=( color ))==null?'':_.escape(__t))+
';"></li>\n        ';
 }); 
__p+='\n      </ul>\n    </li>\n  </ul>\n</div>\n<div class="js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],139:[function(require,module,exports){
var _ = require('underscore');
var CDB = require('cartodb.js');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var template = require('./input-color-categories.tpl');
var StackLayoutView = require('../../../../../../components/stack-layout/stack-layout-view');
var InputColorPickerView = require('../input-color-picker/input-color-picker-view');
var CategoriesListView = require('./input-color-categories-list-view');
var rampList = require('cartocolor');
var AssetPickerView = require('../assets-picker/input-asset-picker-view');
var MAX_VALUES = 10;
var DEFAULT_COLORS = _.clone(rampList.Prism[MAX_VALUES + 1]); // max values + "others" color
var queryTemplate = _.template('SELECT <%= column %>, count(<%= column %>) FROM (<%= sql %>) _table_sql GROUP BY <%= column %> ORDER BY count DESC, <%= column %> ASC LIMIT <%= max_values %>');
var checkAndBuildOpts = require('../../../../../../helpers/required-opts');
var REQUIRED_OPTS = [
  'columns',
  'configModel',
  'modals',
  'query',
  'userModel'
];

function _quote (c) {
  if (c && c !== true) {
    return '"' + c.toString().replace(/"/g, '\\"').replace(/\n/g, '\\n') + '"';
  }
  return c;
}

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_onClickBack',
    'click .js-quantification': '_onClickQuantification'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this._imageEnabled = opts.imageEnabled;
    this.listenTo(this.model, 'change:attribute', this._fetchColumns);
    this._viewModel = new Backbone.Model({
      step: 0,
      status: 'idle'
    });

    this.listenTo(this._viewModel, 'change:status', this.render);

    // If it comes from a quantification change
    if (this.model.hasChanged('quantification') && this.model.get('quantification') === 'category') {
      this._fetchColumns();
    }
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    var column = this._getColumn();
    var columnType = column && column.type;

    this.$el.append(template({
      status: this._viewModel.get('status'),
      columnType: columnType,
      attribute: this.model.get('attribute'),
      quantification: this.model.get('quantification') || 'category'
    }));

    this._generateStackLayoutView();

    return this;
  },

  _generateStackLayoutView: function () {
    var currentStep = this._viewModel.get('step');

    var stackViewCollection = new Backbone.Collection([{
      selected: currentStep === 0,
      createStackView: function (stackLayoutModel, opts) {
        return this._createRangeListView(stackLayoutModel, opts).bind(this);
      }.bind(this)
    }, {
      selected: currentStep === 1,
      createStackView: function (stackLayoutModel, opts) {
        return this._createColorPickerView(stackLayoutModel, opts).bind(this);
      }.bind(this)
    }]);

    if (this._iconStylingEnabled()) {
      stackViewCollection.add({
        selected: currentStep === 2,
        createStackView: function (stackLayoutModel, opts) {
          return this._createImagePickerView(stackLayoutModel, opts).bind(this);
        }.bind(this)
      });
    }

    this._stackLayoutView = new StackLayoutView({ collection: stackViewCollection });
    this._stackLayoutView.bind('positionChanged', this._onStackLayoutPositionChange, this);

    this.addView(this._stackLayoutView);
    this.$('.js-content').append(this._stackLayoutView.render().$el);
  },

  _onStackLayoutPositionChange: function () {
    this.$('.js-prevStep').toggle(this._stackLayoutView.getCurrentPosition() === 0);
  },

  _iconStylingEnabled: function () {
    return this._imageEnabled;
  },

  _getColumn: function () {
    return _.find(this._columns, function (column) {
      return column.label === this.model.get('attribute');
    }, this);
  },

  _fetchColumns: function () {
    if (!this.model.get('attribute')) {
      return;
    }

    if (this._query) {
      this._setViewStatus('loading');

      var sql = new CDB.SQL({
        user: this._configModel.get('user_name'),
        sql_api_template: this._configModel.get('sql_api_template'),
        api_key: this._configModel.get('api_key')
      });

      sql.execute(
        queryTemplate({
          sql: this._query,
          column: this.model.get('attribute'),
          max_values: MAX_VALUES + 1
        }),
        null,
        {
          success: this._onQueryDone.bind(this),
          error: function () {
            this._setViewStatus('error');
          }.bind(this)
        }
      );
    } else {
      this._onQueryDone();
    }
  },

  _onQueryDone: function (data) {
    data = data || {};
    this._updateRangeAndDomain(data.rows);
    this._setViewStatus('idle');
  },

  _updateRangeAndDomain: function (rows) {
    rows = rows || [];
    var categoryNames = _.pluck(rows, this.model.get('attribute'));

    var domain = _.map(categoryNames, function (name, i) {
      return name;
    }).slice(0, MAX_VALUES);

    if (this.model.get('attribute_type') !== 'number') {
      domain = domain.filter(function (item, pos, self) {
        return self.indexOf(item) === pos;
      }).map(_quote);
    }

    var range = _.map(categoryNames, function (name, i) {
      return (i < MAX_VALUES) ? DEFAULT_COLORS[i] : DEFAULT_COLORS[MAX_VALUES + 1];
    });

    if (this._iconStylingEnabled()) {
      var images = _.map(categoryNames, function () {
        return '';
      });

      this.model.attributes.images = images;
    }

    this.model.set({
      range: range,
      domain: domain
    });
  },

  _setViewStatus: function (status) {
    var attrs = {
      status: status
    };

    if (status === 'loading') {
      attrs.step = 0;
    }

    this._viewModel.set(attrs);
  },

  _getRange: function () {
    return _.map(this.model.get('range'), function (color, i) {
      var range = {
        val: color,
        color: color,
        title: this.model.get('domain')[i]
      };

      if (this._iconStylingEnabled()) {
        range.image = this.model.get('images')[i];
      }

      return range;
    }, this);
  },

  _updateRange: function (categories) {
    var range = _.clone(this.model.get('range'));
    range[this._index] = categories[this._index].color;
    this.model.set('range', range);
  },

  _createColorPickerView: function (stackLayoutModel, opts) {
    var range = this._getRange();

    var opacity = typeof this.model.get('opacity') !== 'undefined' ? this.model.get('opacity') : 1;

    var view = new InputColorPickerView({
      index: this._index,
      ramp: range,
      opacity: opacity,
      imageEnabled: this._iconStylingEnabled()
    });

    view.bind('back', function (value) {
      stackLayoutModel.prevStep();
    }, this);

    view.bind('goToAssetPicker', function () {
      stackLayoutModel.nextStep();
    }, this);

    view.bind('change', this._updateRange, this);
    view.bind('changeIndex', function (index) {
      this._index = index;
    }, this);
    view.bind('change:opacity', function (opacity) {
      this.model.set('opacity', opacity);
    }, this);

    return view;
  },

  _createRangeListView: function (stackLayoutModel, opts) {
    var view = new CategoriesListView({
      maxValues: MAX_VALUES,
      model: this.model,
      imageEnabled: this._iconStylingEnabled()
    });

    view.bind('back', function (value) {
      stackLayoutModel.prevStep();
    }, this);

    view.bind('selectItem', function (item) {
      this._index = item.index;

      if (item.target === 'asset') {
        stackLayoutModel.goToStep(2);
      } else {
        stackLayoutModel.goToStep(1);
      }
    }, this);

    return view;
  },

  _createImagePickerView: function (stackLayoutModel, opts) {
    var range = this._getRange();

    var view = new AssetPickerView({
      userModel: this._userModel,
      configModel: this._configModel,
      index: this._index,
      ramp: range,
      modals: this._modals,
      imageEnabled: this._iconStylingEnabled()
    });

    view.bind('back', function (value) {
      stackLayoutModel.goToStep(0);
    }, this);

    view.bind('goToColorPicker', function () {
      stackLayoutModel.prevStep();
    }, this);

    if (this._iconStylingEnabled()) {
      view.bind('change:image', this._onImageChanged, this);
    }

    return view;
  },

  _onImageChanged: function (data) {
    var images = _.clone(this.model.get('images'));
    images[this._index] = data.url;
    this.model.set('images', images);
  },

  _onClickQuantification: function (e) {
    this.killEvent(e);
    this.trigger('selectQuantification', this);
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.trigger('back', this);
  }
}, {
  MAX_VALUES: MAX_VALUES
});

},{"../../../../../../components/stack-layout/stack-layout-view":533,"../../../../../../helpers/required-opts":1097,"../assets-picker/input-asset-picker-view":119,"../input-color-picker/input-color-picker-view":148,"./input-color-categories-list-view":137,"./input-color-categories.tpl":140,"backbone":"backbone","backbone/core-view":1127,"cartocolor":"cartocolor","cartodb.js":"cartodb.js","underscore":"underscore"}],140:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeader js-prevStep">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <ul class="u-flex u-justifySpace">\n        <li class="u-flex">\n          <button class="u-rSpace u-actionTextColor js-back">\n            <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n          </button>\n          <span class="label js-label">'+
((__t=( attribute ))==null?'':_.escape(__t))+
'</span>\n        </li>\n        ';
 if (columnType === 'number') { 
__p+='\n          <li class="u-flex">\n            '+
((__t=( _t('form-components.editors.fill.quantification.methods.' + quantification) ))==null?'':_.escape(__t))+
'\n            <button class="CDB-Shape u-lSpace js-quantification">\n              <div class="CDB-Shape-threePoints is-horizontal is-blue is-small">\n                <div class="CDB-Shape-threePointsItem"></div>\n                <div class="CDB-Shape-threePointsItem"></div>\n                <div class="CDB-Shape-threePointsItem"></div>\n              </div>\n            </button>\n          </li>\n        ';
 } 
__p+='\n      </ul>\n    </li>\n  </ul>\n</div>\n\n';
 if (status === 'loading') { 
__p+='\n  <div class="InputColorCategory-loader js-loader">\n    <div class="CDB-LoaderIcon is-dark">\n      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n      </svg>\n    </div>\n  </div>\n';
 } else if (status === 'error') { 
__p+='\n  <div class="u-flex u-alignCenter u-justifyCenter CDB-Text CDB-Size-medium u-bSpace--m u-tSpace--m u-errorTextColor">'+
((__t=( _t('form-components.editors.fill.error') ))==null?'':_.escape(__t))+
'</div>\n';
 } else { 
__p+='\n  <div class="InputColorCategory-content js-content"></div>\n';
 } 
__p+='';
}
return __p;
};

},{"underscore":"underscore"}],141:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var tabPaneTemplate = require('../fill-tab-pane.tpl');
var createTextLabelsTabPane = require('../../../../../components/tab-pane/create-text-labels-tab-pane');
var InputColorFixedContentView = require('./input-color-fixed-content-view');
var InputColorValueContentView = require('./input-color-value-content-view');

module.exports = CoreView.extend({
  initialize: function (opts) {
    if (this.options.editorAttrs) {
      var editorAttrs = this.options.editorAttrs;

      if (editorAttrs.hidePanes) {
        this._hidePanes = editorAttrs.hidePanes;

        if (!_.contains(this._hidePanes, 'value')) {
          if (!opts.configModel) throw new Error('configModel param is required');
          if (!opts.userModel) throw new Error('userModel param is required');
          if (!opts.modals) throw new Error('modals param is required');
          if (!opts.query) throw new Error('query param is required');
        }
      }

      if (editorAttrs.categorizeColumns) {
        this._categorizeColumns = true;
      }

      if (editorAttrs.imageEnabled) {
        this._imageEnabled = true;
      }
    }

    if (!opts.columns) throw new Error('columns is required');

    this._columns = opts.columns;
    this._configModel = opts.configModel;
    this._userModel = opts.userModel;
    this._modals = opts.modals;
    this._query = opts.query;

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this.model.on('change:fixed', function () {
      if (!this.model.get('fixed') || this.model.get('range')) {
        this.model.unset('image', { silent: true });
      }
    }, this);
  },

  _initViews: function () {
    var self = this;

    var fixedPane = {
      name: 'fixed',
      label: _t('form-components.editors.fill.input-color.solid'),
      createContentView: function () {
        return self._generateFixedContentView();
      }
    };

    var valuePane = {
      name: 'value',
      label: _t('form-components.editors.fill.input-color.value'),
      createContentView: function () {
        return self._generateValueContentView();
      }
    };

    this._tabPaneTabs = [];

    if (this._hidePanes) {
      if (!_.contains(this._hidePanes, 'fixed')) {
        this._tabPaneTabs.push(fixedPane);
      }
      if (!_.contains(this._hidePanes, 'value')) {
        this._tabPaneTabs.push(valuePane);
      }
    } else {
      this._tabPaneTabs = [fixedPane, valuePane];
    }

    var tabPaneOptions = {
      tabPaneOptions: {
        template: tabPaneTemplate,
        tabPaneItemOptions: {
          tagName: 'li',
          className: 'CDB-NavMenu-item'
        }
      },
      tabPaneItemLabelOptions: {
        tagName: 'button',
        className: 'CDB-NavMenu-link u-upperCase'
      }
    };

    if (this.model.get('range') && this._tabPaneTabs.length > 1) {
      this._tabPaneTabs[1].selected = true;
    }

    this._tabPaneView = createTextLabelsTabPane(this._tabPaneTabs, tabPaneOptions);
    this._tabPaneView.collection.bind('change:selected', this._onChangeTabPaneViewTab, this);
    this.$el.append(this._tabPaneView.render().$el);
    this.addView(this._tabPaneView);
  },

  _onChangeTabPaneViewTab: function () {
    var selectedTabPaneName = this._tabPaneView.getSelectedTabPaneName();
    var attrsToUnsetIfFixed = ['domain', 'bins', 'attribute', 'quantification'];

    if (selectedTabPaneName === 'fixed') {
      _.each(attrsToUnsetIfFixed, function (attr) {
        this.model.unset(attr, { silent: true });
      }, this);

      if (!this.model.get('fixed')) {
        if (this.model.get('range')) {
          this.model.set('fixed', this.model.get('range')[0]);
          this.model.unset('range');
        } else {
          this.model.set('fixed', '#0303FF');
        }
      }
    }

    this.trigger('change', selectedTabPaneName, this);
  },

  _generateFixedContentView: function () {
    return new InputColorFixedContentView({
      model: this.model,
      configModel: this._configModel,
      userModel: this._userModel,
      modals: this._modals,
      editorAttrs: this.options.editorAttrs
    });
  },

  _generateValueContentView: function () {
    return new InputColorValueContentView({
      model: this.model,
      columns: this._columns,
      configModel: this._configModel,
      categorizeColumns: this._categorizeColumns,
      imageEnabled: this._imageEnabled,
      userModel: this._userModel,
      modals: this._modals,
      hideTabs: this.options.hideTabs,
      query: this._query
    });
  }
});

},{"../../../../../components/tab-pane/create-text-labels-tab-pane":537,"../fill-tab-pane.tpl":106,"./input-color-fixed-content-view":145,"./input-color-value-content-view":150,"backbone/core-view":1127,"underscore":"underscore"}],142:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-selector"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],143:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./input-color-file-view.tpl');
var AssetsView = require('./assets-picker/assets-view');
var CarouselFormView = require('../../../../../components/carousel-form-view');
var CarouselCollection = require('../../../../../components/custom-carousel/custom-carousel-collection');
var StaticAssetsCollection = require('../../../../../data/static-assets-collection');
var StaticAssetModel = require('../../../../../data/static-asset-model');
var AssetTemplate = require('./assets-picker/static-asset-item-view.tpl');
var CarouselTemplate = require('./input-color-file-carousel.tpl');
var MakiIcons = require('./assets/maki-icons');

module.exports = CoreView.extend({

  events: {
    'click .js-show-collection': '_onClickShowCollection'
  },

  initialize: function (opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.modals) throw new Error('modals is required');

    this._configModel = opts.configModel;
    this._userModel = opts.userModel;
    this._modals = opts.modals;

    this._initCarouselCollection();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());
    this._renderAssets();
    return this;
  },

  _initBinds: function () {
    this.listenTo(this._carouselCollection, 'change:selected', this._onSelectAsset);
    this.listenTo(this._carouselCollection, 'reset', this.render);
  },

  _resetCarouselCollection: function (url) {
    this._icons.reset(MakiIcons.icons);

    var selectedItem = this._carouselCollection.find(function (m) { return m.get('url') === url; });

    if (selectedItem) {
      selectedItem.set('selected', true);
    }

    this._icons.unshift(this._resetAsset);
    this._carouselCollection.reset(this._getIcons());
  },

  _initCarouselCollection: function () {
    this._icons = new StaticAssetsCollection(MakiIcons.icons);
    this.add_related_model(this._icons);

    this._resetAsset = new StaticAssetModel({
      type: 'none',
      selected: !this._getIconSelected(),
      name: _t('form-components.editors.fill.image.none'),
      action: function (m) {
        this._resetImage(m);
      }.bind(this)
    });

    this._icons.unshift(this._resetAsset);

    this._carouselCollection = new CarouselCollection(this._getIcons());
    this.add_related_model(this._carouselCollection);
  },

  _getIcons: function () {
    var defaultAction = function (m) {
      this._changeIcon(m);
    }.bind(this);

    return this._icons.map(function (icon) {
      var type = icon.get('type') ? icon.get('type') : 'icon';
      var action = icon.get('action') ? icon.get('action') : defaultAction;
      var selectedIcon = this._getIconSelected();

      return {
        selected: icon.get('selected') || icon.getURLFor(icon.get('icon')) === selectedIcon,
        icon: icon,
        type: type,
        name: icon.get('name'),
        url: icon.get('public_url'),
        action: action,
        template: function () {
          return AssetTemplate({ type: type, public_url: icon.get('public_url') + '?req=markup', name: icon.get('name') });
        }
      };
    }, this);
  },

  _getIconSelected: function () {
    if (this.model.get('ramp')) {
      var rampIndex = this.model.get('index') || 0;
      var categoryImage = this.model.get('ramp')[rampIndex].image;

      return categoryImage || '';
    } else {
      return this.model.get('image') || '';
    }
  },

  _renderAssets: function () {
    this.clearSubViews();
    this.$el.html(template());

    var view = new CarouselFormView({
      collection: this._carouselCollection,
      template: CarouselTemplate,
      listItemOptions: {
        className: 'Carousel-item AssetListItem'
      },
      itemOptions: {
        className: 'AssetItem-button'
      }
    });

    this.addView(view);
    this.$('.js-assets').append(view.render().el);
  },

  _onSelectAsset: function (m) {
    m.get('action')(m);
  },

  _changeIcon: function (m) {
    var icon = m.get('icon');

    this.trigger('change', {
      url: icon.get('public_url'),
      kind: icon.get('kind')
    }, this);
  },

  _resetImage: function () {
    this.trigger('change', null, this);
  },

  _onClickShowCollection: function (e) {
    this.killEvent(e);

    var self = this;

    this._modals.create(function (modalModel) {
      var view = new AssetsView({
        model: self.model,
        modalModel: modalModel,
        configModel: self._configModel,
        userModel: self._userModel
      });

      view.bind('change', function (data) {
        this._resetCarouselCollection(data.url);
        this.trigger('change', data, this);
      }, self);

      return view;
    });
  }
});

},{"../../../../../components/carousel-form-view":23,"../../../../../components/custom-carousel/custom-carousel-collection":40,"../../../../../data/static-asset-model":661,"../../../../../data/static-assets-collection":662,"./assets-picker/assets-view":115,"./assets-picker/static-asset-item-view.tpl":124,"./assets/maki-icons":132,"./input-color-file-carousel.tpl":142,"./input-color-file-view.tpl":144,"backbone/core-view":1127}],144:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-boxModalContent js-assets">\n  <h2 class="CDB-Text CDB-Size-small u-bSpace--m u-upperCase">\n    '+
((__t=( _t('form-components.editors.fill.image.recently-title') ))==null?'':_.escape(__t))+
'\n  </h2>\n</div>\n<div class="CustomRamp-list">\n  <div class="CustomList-item CustomList-item--add">\n    <button class="CDB-ListDecoration-itemLink CDB-Text CDB-Size-medium u-actionTextColor js-show-collection" type="button">\n      '+
((__t=( _t('form-components.editors.fill.image.show-all') ))==null?'':_.escape(__t))+
'\n    </button>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],145:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var tabPaneTemplate = require('../fill-tab-pane.tpl');
var createMixedLabelsTabPane = require('../../../../../components/tab-pane/create-mixed-labels-tab-pane');
var ColorPicker = require('../color-picker/color-picker');
var InputColorFileView = require('./input-color-file-view');

module.exports = CoreView.extend({
  initialize: function (opts) {
    if (this.options.editorAttrs) {
      var editorAttrs = this.options.editorAttrs;

      this._imageEnabled = editorAttrs.imageEnabled;

      if (editorAttrs.hidePanes) {
        this._hidePanes = editorAttrs.hidePanes;

        if (this._imageEnabled && !_.contains(this._hidePanes, 'file')) {
          if (!opts.configModel) throw new Error('configModel param is required');
          if (!opts.userModel) throw new Error('userModel param is required');
          if (!opts.modals) throw new Error('modals param is required');
        }
      }

      if (editorAttrs.disableOpacity) {
        this._disableOpacity = true;
      }
    }

    this._userModel = opts.userModel;
    this._configModel = opts.configModel;
    this._modals = opts.modals;
    this._query = opts.query;
  },

  render: function () {
    this.clearSubViews();

    if (this._imageEnabled) {
      this._setupTabPanes();
    }

    if (this._tabPaneView) {
      this.$el.append(this._tabPaneView.render().$el);
    } else {
      this.$el.append(this._generateFixedContentView().render().$el);
    }
    return this;
  },

  _setupTabPanes: function () {
    var self = this;

    var fixedPane = {
      name: 'fixed',
      type: 'color',
      label: this.model.get('fixed'),
      createContentView: function () {
        return self._generateFixedContentView();
      }
    };

    var filePane = {
      name: 'file',
      type: this.model.get('image') ? 'image' : 'text',
      label: this.model.get('image') || _t('form-components.editors.fill.input-color.img'),
      kind: this.model.get('kind') || 'marker',
      color: this.model.get('fixed'),
      createContentView: function () {
        return self._generateFileContentView();
      }
    };

    this._tabPaneTabs = [];

    if (this.options.editorAttrs && this.options.editorAttrs.hidePanes) {
      this._hidePanes = this.options.editorAttrs.hidePanes;

      if (!_.contains(this._hidePanes, 'fixed')) {
        this._tabPaneTabs.push(fixedPane);
      }

      if (!_.contains(this._hidePanes, 'file')) {
        this._tabPaneTabs.push(filePane);
      }
    } else {
      this._tabPaneTabs = [fixedPane, filePane];
    }

    var tabPaneOptions = {
      tabPaneOptions: {
        template: tabPaneTemplate,
        tabPaneItemOptions: {
          tagName: 'li',
          className: 'CDB-NavMenu-item'
        }
      },
      tabPaneItemLabelOptions: {
        tagName: 'button',
        className: 'CDB-NavMenu-link u-upperCase'
      }
    };

    if (this.model.get('image') && this._tabPaneTabs.length > 1) {
      this._tabPaneTabs[1].selected = true;
    }
    this.listenTo(this.model, 'change:image', this._updateImageTabPane);
    this.listenTo(this.model, 'change:fixed', this._updateTextTabPane);

    this._tabPaneView = createMixedLabelsTabPane(this._tabPaneTabs, tabPaneOptions);
    this.addView(this._tabPaneView);
  },

  _updateTextTabPane: function () {
    this._updateImageTabPane();
    this._tabPaneView.collection.at(0).set('label', this.model.get('fixed'));
  },

  _updateImageTabPane: function () {
    if (this.model.get('image')) {
      this._tabPaneView.collection.at(1).set({ label: this.model.get('image'), color: this.model.get('fixed') });
    } else {
      this._tabPaneView.collection.at(1).set('label', _t('form-components.editors.fill.input-color.img'));
    }
  },

  _generateFixedContentView: function () {
    var contentView = new ColorPicker({
      value: this.model.get('fixed'),
      opacity: this.model.get('opacity'),
      disableOpacity: this._disableOpacity
    });

    contentView.bind('change', this._onChangeValue, this);
    return contentView;
  },

  _generateFileContentView: function () {
    var contentView = new InputColorFileView({
      model: this.model,
      userModel: this._userModel,
      configModel: this._configModel,
      modals: this._modals
    });

    contentView.bind('change', this._onChangeFile, this);
    return contentView;
  },

  _onChangeFile: function (data) {
    if (data && data.url) {
      this.model.set({
        image: data.url,
        kind: data.kind
      });
    } else {
      this.model.unset('image');
    }
  },

  _onChangeValue: function (color) {
    this.model.set({ fixed: color.hex, opacity: color.opacity });
  }
});

},{"../../../../../components/tab-pane/create-mixed-labels-tab-pane":535,"../color-picker/color-picker":99,"../fill-tab-pane.tpl":106,"./input-color-file-view":143,"backbone/core-view":1127,"underscore":"underscore"}],146:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var ImageLoaderView = require('../../../../../img-loader-view');
var template = require('./input-color-picker-header.tpl');
var MAX = 1;

module.exports = CoreView.extend({
  events: {
    'click .js-color': '_onClickColor',
    'click .js-assetPicker': '_onClickAssetPicker',
    'keyup .js-a': '_onChangeOpacity'
  },

  initialize: function (opts) {
    this.listenTo(this.model, 'change', this.render);
  },

  render: function (model, options) {
    if (model && model.changed && typeof model.changed.opacity !== 'undefined') {
      this._reRenderOpacity();
      return this;
    }

    this.clearSubViews();
    this.$el.empty();

    var rampItem = this._getRampItem();
    this.$el.append(template({
      ramp: this.model.get('ramp'),
      index: this.model.get('index'),
      opacity: this.model.get('opacity'),
      label: rampItem.title || _t('form-components.editors.fill.input-categories.others'),
      color: rampItem.color || '',
      iconStylingEnabled: this.options.iconStylingEnabled,
      isCategorized: _.has(rampItem, 'image'),
      image: rampItem.image || '',
      imageEnabled: this.options.imageEnabled
    }));

    this._slider = this.$('.js-slider').slider({
      range: 'min',
      value: this._inverseSliderValue(this.model.get('opacity')),
      min: 0,
      max: MAX,
      step: 0.02,
      orientation: 'horizontal',
      disabled: false,
      slide: this._onSlideChange.bind(this)
    });

    this._loadImages();

    return this;
  },

  _getRampItem: function () {
    var ramp = this.model.get('ramp');

    if (!ramp) {
      return {
        color: '',
        title: _t('form-components.editors.fill.input-categories.others'),
        image: ''
      };
    }

    return ramp[this.model.get('index')];
  },

  _loadImages: function () {
    var rampItem = this._getRampItem();

    this.iconView = new ImageLoaderView({
      imageClass: 'CDB-Text u-actionTextColor js-assetPicker',
      imageUrl: rampItem.image,
      color: rampItem.color
    });
    this.addView(this.iconView);
    this.$('.js-image-container').append(this.iconView.render().el);
  },

  _onClickColor: function (ev) {
    this.killEvent(ev);
    this.model.set('index', $(ev.target).index());
  },

  _onClickBack: function (ev) {
    this.killEvent(ev);
    this.trigger('back', this);
  },

  _onClickAssetPicker: function (ev) {
    this.killEvent(ev);
    this.trigger('goToAssetPicker', this);
  },

  _onSlideChange: function (evt, obj) {
    this.model.set('opacity', this._inverseSliderValue(obj.value));
  },

  _inverseSliderValue: function (value) {
    return parseFloat(Number(MAX - value).toFixed(2));
  },

  _onChangeOpacity: function () {
    var $input = this.$('.js-a');
    var value = $input.val();
    var isValid = this._isValidOpacity(value);
    $input.toggleClass('has-error', !isValid);
    if (isValid) {
      this.model.set('opacity', parseFloat(value));
    }
  },

  _isValidOpacity: function (value) {
    var regex = /^((0(\.\d+)?)|(1(\.0)?))$/;
    return regex.test(value);
  },

  _reRenderOpacity: function () {
    var $input = this.$('.js-a');
    var $slider = this.$('.js-slider');
    var opacity = this.model.get('opacity');
    var inputValue;
    var sliderValue;

    if ($input.length > 0) {
      inputValue = $input.val();
      if (!this._isValidOpacity(inputValue) || (this._isValidOpacity(inputValue) && parseFloat(inputValue) !== opacity)) {
        $input.val(opacity);
      }
    }

    if (typeof $slider.slider('instance') !== 'undefined') {
      sliderValue = $slider.slider('value');
      if (typeof sliderValue !== 'undefined' && sliderValue !== this._inverseSliderValue(opacity)) {
        $slider.slider('value', this._inverseSliderValue(opacity));
      }
    }
  }
});

},{"../../../../../img-loader-view":213,"./input-color-picker-header.tpl":147,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],147:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeader">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemDisplay--flex CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <div class=\'CDB-ListDecoration-secondaryContainer\'>\n        <button class="u-rSpace u-actionTextColor js-back" type="button">\n          <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n        </button>\n        <span class="label js-label">'+
((__t=( label ))==null?'':_.escape(__t))+
'</span>\n      </div>\n\n      ';
 if (isCategorized && imageEnabled) { 
__p+='\n        <div class=\'CDB-ListDecoration-secondaryContainer\'>\n          <nav class=\'CDB-NavMenu\'>\n            <ul class=\'CDB-NavMenu-Inner CDB-NavMenu-inner--no-margin js-menu\'>\n              <li class=\'CDB-NavMenu-item is-selected\'>\n                <div class=\'CDB-NavMenu-link CDB-ListDecoration-rampNav-item\'>\n                  <button class=\'ColorBar CDB-ListDecoration-rampItemBar u-rSpace--xl js-colorPicker\' type="button" style="background-color: '+
((__t=( color ))==null?'':__t)+
';"></button>\n                </div>\n              </li>\n              <li class=\'CDB-NavMenu-item\'>\n                <div class=\'CDB-NavMenu-link CDB-ListDecoration-rampNav-item\'>\n                  ';
 if (image) { 
__p+='\n                    <button class="CDB-ListDecoration-rampImg js-image-container" type="button"></button>\n                  ';
 } else { 
__p+='\n                    <button class="CDB-ListDecoration-rampImg CDB-Text u-actionTextColor js-assetPicker" type="button">'+
((__t=( _t('form-components.editors.fill.input-color.img') ))==null?'':__t)+
'</button>\n                  ';
 } 
__p+='\n                </div>\n              </li>\n            </ul>\n          </nav>\n        </div>\n      ';
 } 
__p+='\n    </li>\n  </ul>\n</div>\n\n<div class="CDB-Box-modalHeader">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <ul class="ColorBarContainer ColorBarContainer--rampEditing">\n        ';
 _.each(ramp, function (color, i) { 
__p+='\n        <li class="ColorBar is-link ColorBar--spaceless ColorBar--clickable js-color'+
((__t=( i === index ? ' is-selected' : '' ))==null?'':_.escape(__t))+
'" data-label="'+
((__t=( color.title ))==null?'':_.escape(__t))+
'" data-color="'+
((__t=( color.color ))==null?'':_.escape(__t))+
'" style="background-color: '+
((__t=( color.color ))==null?'':_.escape(__t))+
';"></li>\n        ';
 }); 
__p+='\n      </ul>\n      <div class="OpacityEditor">\n        <div class="OpacityEditor-slider js-slider"></div>\n        <div class="OpacityEditor-inputWrapper">\n          <input type="text" class="CDB-InputText ColorPicker-input js-a" value="'+
((__t=( opacity ))==null?'':_.escape(__t))+
'">\n        </div>\n      </div>\n    </li>\n  </ul>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],148:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var ColorPicker = require('../../color-picker/color-picker');
var template = require('./input-color-picker-view.tpl');
var InputColorPickerHeader = require('./input-color-picker-header');
var checkAndBuildOpts = require('../../../../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'ramp',
  'opacity'
];

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_onClickBack'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this.model = new Backbone.Model({
      index: this.options.index,
      ramp: opts.ramp,
      opacity: opts.opacity
    });

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:index', this._onChangeIndex);
    this.listenTo(this.model, 'change:opacity', this._onOpacityChanged);
  },

  _initViews: function () {
    this._headerView = new InputColorPickerHeader({
      model: this.model,
      imageEnabled: this.options.imageEnabled
    });

    this.addView(this._headerView);
    this._headerView.bind('goToAssetPicker', this._onGoToAssetPicker, this);
    this.$('.js-header').append(this._headerView.render().$el);

    this._colorPicker = new ColorPicker({
      value: this._getColor(),
      opacity: 1,
      disableOpacity: true
    });

    this.addView(this._colorPicker);
    this._colorPicker.bind('change', this._onChangeValue, this);
    this.$('.js-content').append(this._colorPicker.render().$el);
  },

  _setColor: function (color) {
    var ramp = _.clone(this.model.get('ramp'));
    ramp[this.model.get('index')].color = color;
    this.model.set('ramp', ramp);
    this.model.trigger('change', ramp);
    this.trigger('change', ramp);
  },

  _getColor: function () {
    var ramp = this.model.get('ramp');
    return ramp[this.model.get('index') || 0].color;
  },

  _onChangeIndex: function () {
    this._colorPicker.setColor(this._getColor());
    this.trigger('changeIndex', this.model.get('index'), this);
  },

  _onChangeValue: function (color) {
    this._setColor(color.hex);
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.trigger('back', this);
  },

  _onOpacityChanged: function () {
    var opacity = this.model.get('opacity');
    this.trigger('change:opacity', opacity);
  },

  _onGoToAssetPicker: function () {
    this.trigger('goToAssetPicker');
  }
});

},{"../../../../../../helpers/required-opts":1097,"../../color-picker/color-picker":99,"./input-color-picker-header":146,"./input-color-picker-view.tpl":149,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],149:[function(require,module,exports){
arguments[4][120][0].apply(exports,arguments)
},{"dup":120,"underscore":"underscore"}],150:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var StackLayoutView = require('../../../../../components/stack-layout/stack-layout-view');
var ColumnListView = require('../column-list-view');
var quantificationMethodItemTemplate = require('./quantification-method-item.tpl');
var InputColorRamps = require('./input-ramps/input-color-ramps');
var InputColorCategories = require('./input-categories/input-color-categories');
var DefaultFillSettings = require('../default-fill-settings.json');
var checkAndBuildOpts = require('../../../../../helpers/required-opts');

var EXCLUDED_COLUMNS = ['the_geom', 'the_geom_webmercator'];
var REQUIRED_OPTS = [
  'columns',
  'configModel',
  'modals',
  'query',
  'userModel'
];

module.exports = CoreView.extend({
  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._settings = DefaultFillSettings.color;

    this._categorizeColumns = opts.categorizeColumns;
    this._imageEnabled = opts.imageEnabled;

    this._column = this._getColumn();
    this._columnType = this._column && this._column.type;

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:quantification', function () {
      if (this.model.previous('quantification') === 'category') {
        delete this.model.attributes.range;
      }

      if (this.model.get('quantification') !== 'category') {
        this.model.unset('domain');
      }
    });
  },

  _initViews: function () {
    var self = this;

    var stackViewCollection = new Backbone.Collection([{
      createStackView: function (stackLayoutModel, opts) {
        return self._createColumnListView(stackLayoutModel, opts).bind(self);
      }
    }, {
      createStackView: function (stackLayoutModel, opts) {
        return self._createInputColorRamps(stackLayoutModel, opts).bind(self);
      }
    }, {
      createStackView: function (stackLayoutModel, opts) {
        return self._createInputColorCategories(stackLayoutModel, opts).bind(self);
      }
    }, {
      createStackView: function (stackLayoutModel, opts) {
        return self._createQuantificationListView(stackLayoutModel, opts).bind(self);
      }
    }]);

    this._stackLayoutView = new StackLayoutView({
      collection: stackViewCollection
    });

    if (this.model.get('attribute')) {
      var hasDomain = this.model.get('domain') && this.model.get('domain').length;
      var hasRange = this.model.get('range') && this.model.get('range').length;
      var showCategories = (this._columnType === 'string') || (hasDomain && hasRange);

      if (showCategories) {
        this._stackLayoutView.model.set('position', 2);
      } else {
        this._stackLayoutView.model.set('position', 1);
      }
    }

    this.$el.append(this._stackLayoutView.render().$el);
    this.addView(this._stackLayoutView);
  },

  _createInputColorCategories: function (stackLayoutModel, opts) {
    var view = new InputColorCategories({
      model: this.model,
      query: this._query,
      columns: this._columns,
      configModel: this._configModel,
      userModel: this._userModel,
      modals: this._modals,
      imageEnabled: this._imageEnabled
    });

    view.bind('selectQuantification', function (item) {
      stackLayoutModel.goToStep(3);
    }, this);

    view.bind('back', function (value) {
      stackLayoutModel.goToStep(0);
    }, this);

    return view;
  },

  _createQuantificationListView: function (stackLayoutModel, opts) {
    var view = new ColumnListView({
      headerTitle: _t('form-components.editors.fill.quantification.title'),
      stackLayoutModel: stackLayoutModel,
      itemTemplate: quantificationMethodItemTemplate,
      columns: this._settings.quantifications.items,
      showSearch: false
    });

    view.bind('selectItem', function (item) {
      this.model.set('quantification', item.get('val'));
      stackLayoutModel.goToStep(1);
    }, this);

    view.bind('back', function (value) {
      stackLayoutModel.goToStep(0);
    }, this);

    return view;
  },

  _createInputColorRamps: function (stackLayoutModel, opts) {
    var view = new InputColorRamps({
      hideTabs: this.options.hideTabs,
      model: this.model
    });

    view.bind('switch', function () {
      stackLayoutModel.goToStep(2);
    }, this);

    view.bind('back', function (value) {
      stackLayoutModel.prevStep();
    }, this);

    return view;
  },

  _getColumn: function (columnName) {
    return _.find(this._columns, function (column) {
      return column.label === (columnName || this.model.get('attribute'));
    }, this);
  },

  _createColumnListView: function (stackLayoutModel, opts) {
    var columns = _.reject(this._columns, function (column) {
      return column.type === 'geometry' || _.contains(EXCLUDED_COLUMNS, column.label);
    }, this);

    var view = new ColumnListView({
      stackLayoutModel: stackLayoutModel,
      columns: columns,
      showSearch: true,
      typeLabel: 'column'
    });

    view.bind('selectItem', function (item) {
      this._onChangeAttribute(item.get('val'), stackLayoutModel);
    }, this);

    return view;
  },

  _onChangeAttribute: function (columnName, stackLayoutModel) {
    var validCategoryTypes = ['string', 'boolean'];
    var attrsToUnset = ['image', 'fixed', 'quantification', 'opacity'];
    var wasQuantificationCategory = this.model.get('quantification') === 'category';

    this._column = this._getColumn(columnName);
    this._columnType = this._column && this._column.type;

    _.each(attrsToUnset, function (attr) {
      this.model.unset(attr, { silent: true });
    }, this);

    if (_.contains(validCategoryTypes, this._columnType) || this._categorizeColumns) {
      this.model.unset('bins', { silent: true });
      stackLayoutModel.goToStep(2);
    } else if (this._columnType === 'number') {
      this.model.unset('images', { silent: true });
      this.model.unset('domain', { silent: true });

      // Unset range if previous quantification was category
      if (wasQuantificationCategory) {
        this.model.unset('range', { silent: true });
      }

      stackLayoutModel.goToStep(1);
    }

    this.model.set({
      attribute: columnName,
      attribute_type: this._columnType
    });
  }
});

},{"../../../../../components/stack-layout/stack-layout-view":533,"../../../../../helpers/required-opts":1097,"../column-list-view":101,"../default-fill-settings.json":103,"./input-categories/input-color-categories":139,"./input-ramps/input-color-ramps":154,"./quantification-method-item.tpl":161,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],151:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./input-color.tpl');
var InputDialogContent = require('./input-color-dialog-content');
var Utils = require('../../../../../helpers/utils');
var rampList = require('./input-ramps/ramps');
var ImageLoaderView = require('../../../../img-loader-view');

module.exports = CoreView.extend({
  tagName: 'li',
  className: 'CDB-OptionInput-item',

  events: {
    'click': '_onClick'
  },

  initialize: function (opts) {
    if (this.options.editorAttrs) {
      this._editorAttrs = this.options.editorAttrs;
      this._imageEnabled = this._editorAttrs.imageEnabled;
      var hidePanes = this._editorAttrs.hidePanes;

      if (hidePanes && !_.contains(hidePanes, 'value')) {
        if (!opts.configModel) throw new Error('configModel param is required');
        if (!opts.userModel) throw new Error('userModel param is required');
        if (!opts.modals) throw new Error('modals param is required');
        if (!opts.query) throw new Error('query param is required');
      }
    }

    if (!opts.columns) throw new Error('columns is required');

    this._columns = opts.columns;
    this._configModel = opts.configModel;
    this._userModel = opts.userModel;
    this._modals = opts.modals;
    this._query = opts.query;

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    if (this.options.disabled) {
      this.$el.addClass('is-disabled');
    }

    var column = this._getColumn();
    var columnType = column && column.type;
    var hasDomain = this.model.get('domain') && this.model.get('domain').length;

    if (this.model.get('range') && _.isString(this.model.get('range'))) {
      this._migrateRange();
    }

    var hasRange = this.model.get('range') && this.model.get('range').length;
    var showCategories = (columnType === 'string') || (hasDomain && hasRange);
    var imageURL = this._getImageURL();
    var categoryImagesPresent = this._iconStylingEnabled() && !this._getImageURL() && this._categoryImagesPresent();

    this.$el.html(template({
      categoryImagesPresent: categoryImagesPresent,
      imageURL: imageURL,
      kind: this._getKind(),
      showCategories: showCategories,
      value: this._getValue(),
      opacity: this._getOpacity()
    }));

    this._loadImages();

    return this;
  },

  _loadImages: function () {
    this.iconView = new ImageLoaderView({
      imageClass: 'Editor-fillImageAsset',
      imageUrl: this._getImageURL(),
      color: this.model.get('fixed')
    });
    this.addView(this.iconView);
    this.$('.js-image-container').append(this.iconView.render().el);
  },

  _categoryImagesPresent: function () {
    var images = this.model.get('images');

    for (var i in images) {
      if (!_.isEmpty(images[i])) {
        return true;
      }
    }

    return false;
  },

  _iconStylingEnabled: function () {
    return this._imageEnabled;
  },

  _getKind: function () {
    return this.model.get('kind') && this._iconStylingEnabled() ? this.model.get('kind') : '';
  },

  _getImageURL: function () {
    return this.model.get('image') && this._iconStylingEnabled() ? this.model.get('image') : '';
  },

  // Converts reference to the old color ramp to the full color list
  _migrateRange: function () {
    var rangeName = this.model.get('range');
    var bins = this.model.get('bins') || 3;

    if (rampList[rangeName] && rampList[rangeName][bins]) {
      this.model.set('range', rampList[rangeName][bins]);
    }
  },

  _getColumn: function () {
    return _.find(this._columns, function (column) {
      return column.label === this.model.get('attribute');
    }, this);
  },

  _createContentView: function () {
    var view = new InputDialogContent({
      configModel: this._configModel,
      userModel: this._userModel,
      modals: this._modals,
      query: this._query,
      model: this.model,
      columns: this._columns,
      editorAttrs: this._editorAttrs
    });

    view.bind('change', this.render, this);

    return view;
  },

  _onClick: function (e) {
    if (this.options.disabled) {
      return;
    }
    this.trigger('click', this.model);
  },

  _initBinds: function () {
    var self = this;

    this.model.set('createContentView', function () {
      return self._createContentView();
    }).bind(this);

    this.model.on('change:images', this.render, this);
    this.model.on('change:selected', this._onToggleSelected, this);
    this.model.on('change:opacity', this.render, this);
    this.model.on('change:fixed', this.render, this);
    this.model.on('change:fixed', this._updateColor, this);
    this.model.on('change:image', this.render, this);
    this.model.on('change:range', this.render, this);
  },

  _updateColor: function () {
    this.iconView && this.iconView.updateImageColor(this.model.get('fixed'));
  },

  _getValue: function () {
    var value = this.model.get('fixed');

    if (value) {
      value = Utils.hexToRGBA(value, this._getOpacity());
    }

    if (this.model.get('range') && this.model.get('range').length) {
      value = _.map(this.model.get('range'), function (color) {
        return Utils.hexToRGBA(color, this._getOpacity());
      }, this);
    }

    return value;
  },

  _getOpacity: function () {
    return this.model.get('opacity') != null ? this.model.get('opacity') : 1;
  },

  _onToggleSelected: function () {
    this.$el.toggleClass('is-active', this.model.get('selected'));
  }
});

},{"../../../../../helpers/utils":1102,"../../../../img-loader-view":213,"./input-color-dialog-content":141,"./input-color.tpl":152,"./input-ramps/ramps":160,"backbone/core-view":1127,"underscore":"underscore"}],152:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (showCategories) { 
__p+='\n  <ul class="ColorsBar">\n    ';
 _.each(value, function (color) { 
__p+='\n      <li class="ColorBar '+
((__t=( categoryImagesPresent ? 'ColorBar--spaceSmall' : 'ColorBar--spaceMedium' ))==null?'':_.escape(__t))+
'" style="background-color: '+
((__t=( color ))==null?'':_.escape(__t))+
'"></li>\n    ';
 }); 
__p+='\n  </ul>\n';
 } else { 
__p+='\n  <button type="button" class="Editor-fillContainer">\n    <ul class="ColorBarContainer">\n      ';
 if (_.isArray(value)) { 
__p+='\n        <li class="ColorBar ColorBar-gradient" style="background: linear-gradient(90deg,'+
((__t=( value.join(',') ))==null?'':_.escape(__t))+
')"></li>\n      ';
 } else { 
__p+='\n        <li class="ColorBar" style="background-color: '+
((__t=( value ))==null?'':_.escape(__t))+
'"></li>\n      ';
 } 
__p+='\n    </ul>\n  </button>\n';
 } 
__p+='\n\n';
 if (imageURL && kind !== 'custom-marker') { 
__p+='\n<button type="button" class="Editor-fillImage">\n  <div class="js-image-container"></div>\n</button>\n';
 } 
__p+='\n\n';
 if ((!imageURL && categoryImagesPresent) || (imageURL && kind === 'custom-marker')) { 
__p+='\n<button type="button" class="Editor-fillImage">\n  <div class=\'Editor-categoryImagesTag CDB-Text CDB-FontSize-small u-altTextColor is-semibold u-upperCase\'>'+
((__t=( _t('form-components.editors.fill.input-color.img') ))==null?'':__t)+
'</div>\n</button>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],153:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (customRamp && customRamp.length) { 
__p+='\n<li class="CDB-ListDecoration-item CustomList-item CustomRamp js-customRampItem">\n  <div class="CustomRamp-listOptions CDB-ListDecoration-itemLink CDB-ListDecoration-itemLink--double js-customRamp js-listItemLink is-selected">\n    <ul class="ColorBarContainer">\n      ';
 _.each(customRamp, function (color) { 
__p+='\n      <li class="ColorBar ColorBar--spaceless" style="background-color: '+
((__t=( color ))==null?'':_.escape(__t))+
';"></li>\n      ';
 }); 
__p+='\n    </ul>\n  </div>\n  <button class="CDB-ListDecoration-itemLink CustomRamp-clear js-clear">\n    <div class="CDB-Shape">\n      <div class="CDB-Shape-close is-blue is-large"></div>\n    </div>\n  </button>\n</li>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],154:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var StackLayoutView = require('../../../../../../components/stack-layout/stack-layout-view');
var ColumnListView = require('../../column-list-view');
var quantificationMethodItemTemplate = require('../quantification-method-item.tpl');
var InputRampContentView = require('./input-ramp-content-view');
var rampList = require('cartocolor');
var DefaultFillSettings = require('../../default-fill-settings.json');

module.exports = CoreView.extend({
  initialize: function (opts) {
    this._settings = DefaultFillSettings['color-ramps'];

    this._setupModel();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _setupModel: function () {
    var options = {};

    if (!this.model.get('quantification')) {
      options.quantification = this._settings.quantifications.items[this._settings.quantifications.defaultIndex];
    }

    if (!this.model.get('bins')) {
      options.bins = this._settings.bins.items[this._settings.bins.defaultIndex];
    }

    if (+this.model.get('bins') > +this._settings.bins.items[this._settings.bins.items.length - 1]) {
      options.bins = this._settings.bins.items[this._settings.bins.items.length - 1];
    }

    this.model.set(options);
  },

  _initBinds: function () {
    var range = this.model.get('range');

    this.listenTo(this.model, 'change:bins', this._updateRange);
    this.listenTo(this.model, 'change:attribute', this.render);
    this.listenTo(this.model, 'change:quantification', this._onChangeQuantification);

    this.model.unset('fixed');

    if (!range || !this._isValidRange(range)) {
      this.model.set('range', this._getDefaultRamp());
    }
  },

  // range minimun size should be 2
  _isValidRange: function (range) {
    return range && range.length > 1 || false;
  },

  _initViews: function () {
    var self = this;

    var collectionOptions = [
      {
        createStackView: function (stackLayoutModel, opts) {
          return self._createInputRampContentView(stackLayoutModel, opts).bind(self);
        }
      }
    ];

    if (!this.options.hideTabs || !_.contains(this.options.hideTabs, 'quantification')) {
      collectionOptions.push(
        {
          createStackView: function (stackLayoutModel, opts) {
            return self._createQuantificationListView(stackLayoutModel, opts).bind(self);
          }
        }
      );
    }

    if (!this.options.hideTabs || !_.contains(this.options.hideTabs, 'bins')) {
      collectionOptions.push(
        {
          createStackView: function (stackLayoutModel, opts) {
            return self._createBinsListView(stackLayoutModel, opts).bind(self);
          }
        }
      );
    }

    var stackViewCollection = new Backbone.Collection(collectionOptions);

    this._stackLayoutView = new StackLayoutView({
      collection: stackViewCollection
    });

    this.$el.append(this._stackLayoutView.render().$el);
    this.addView(this._stackLayoutView);
  },

  _updateRange: function () {
    var previousBins = this.model.previous('bins');

    if (!previousBins) {
      return;
    }

    var previousRamps = _.find(rampList, function (ramp) {
      var previousRamp = ramp[previousBins];
      var range = this.model.get('range');
      return previousRamp && range && previousRamp.join('').toLowerCase() === range.join('').toLowerCase();
    }, this);

    if (previousRamps) {
      var bins = this.model.get('bins');
      this.model.set('range', previousRamps[bins]);
    }
  },

  _createInputRampContentView: function (stackLayoutModel, opts) {
    var view = new InputRampContentView({
      stackLayoutModel: stackLayoutModel,
      model: this.model
    });

    view.bind('back', function (value) {
      this.trigger('back');
    }, this);

    view.bind('selectItem', function (value) {
      this.model.unset('domain');
      this.model.set('range', value);
    }, this);

    view.bind('selectQuantification', function (value) {
      stackLayoutModel.goToStep(1);
    }, this);

    view.bind('selectBins', function (value) {
      stackLayoutModel.goToStep(2);
    }, this);

    return view;
  },

  _createBinsListView: function (stackLayoutModel, opts) {
    var view = new ColumnListView({
      headerTitle: _t('form-components.editors.fill.bins'),
      stackLayoutModel: stackLayoutModel,
      columns: this._settings.bins.items
    });

    view.bind('selectItem', function (item) {
      this.model.set('bins', item.get('val'));
      stackLayoutModel.goToStep(0);
    }, this);

    view.bind('back', function (value) {
      stackLayoutModel.goToStep(0);
    }, this);

    return view;
  },

  _createQuantificationListView: function (stackLayoutModel, opts) {
    var view = new ColumnListView({
      headerTitle: _t('form-components.editors.fill.quantification.title'),
      stackLayoutModel: stackLayoutModel,
      itemTemplate: quantificationMethodItemTemplate,
      columns: this._settings.quantifications.items,
      showSearch: false
    });

    view.bind('selectItem', function (item) {
      this.model.set('quantification', item.get('val'));
      stackLayoutModel.prevStep();
    }, this);

    view.bind('back', function (value) {
      stackLayoutModel.goToStep(0);
    }, this);

    return view;
  },

  _getDefaultRamp: function () {
    return _.map(rampList, function (ramp) {
      return ramp[this.model.get('bins')];
    }, this)[0];
  },

  _onChangeQuantification: function () {
    if (this.model.get('quantification') === 'category') {
      this.trigger('switch', this);
    }
  },

  remove: function () {
    CoreView.prototype.remove.apply(this);
  }
});

},{"../../../../../../components/stack-layout/stack-layout-view":533,"../../column-list-view":101,"../../default-fill-settings.json":103,"../quantification-method-item.tpl":161,"./input-ramp-content-view":155,"backbone":"backbone","backbone/core-view":1127,"cartocolor":"cartocolor","underscore":"underscore"}],155:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var InputRampListView = require('./input-ramp-list-view');
var StackLayoutView = require('../../../../../../components/stack-layout/stack-layout-view');
var InputColorPickerView = require('../input-color-picker/input-color-picker-view');

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_onClickBack'
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initViews: function () {
    var self = this;

    var stackViewCollection = new Backbone.Collection([{
      createStackView: function (stackLayoutModel, opts) {
        return self._createInputRampListView(stackLayoutModel, opts).bind(self);
      }
    }, {
      createStackView: function (stackLayoutModel, opts) {
        return self._createColorPickerView(stackLayoutModel, opts).bind(self);
      }
    }]);

    this._stackLayoutView = new StackLayoutView({
      collection: stackViewCollection
    });

    this.$el.append(this._stackLayoutView.render().$el);
    this.addView(this._stackLayoutView);
  },

  _createColorPickerView: function (stackLayoutModel, opts) {
    var range = _.map(this.model.get('range'), function (color, i) {
      return {
        val: color,
        color: color,
        title: this.model.get('attribute')
      };
    }, this);

    var opacity = (typeof this.model.get('opacity') !== 'undefined') ? this.model.get('opacity') : 1;

    var view = new InputColorPickerView({
      index: 0,
      ramp: range,
      opacity: opacity
    });

    view.bind('back', function (value) {
      stackLayoutModel.prevStep();
    }, this);

    view.bind('change', this._updateRange, this);
    view.bind('change:opacity', function (opacity) {
      this.model.set('opacity', opacity);
    }, this);

    return view;
  },

  _createInputRampListView: function (stackLayoutModel, opts) {
    var view = new InputRampListView({
      model: this.model,
      showSearch: this.options.showSearch || false,
      typeLabel: this.options.typeLabel
    });

    view.bind('customize', function (value) {
      stackLayoutModel.nextStep();
    }, this);

    view.bind('change_ramp', this._updateRamp, this);
    view.bind('change', this._updateRange, this);

    view.bind('back', function (value) {
      this.trigger('back', this);
    }, this);

    view.bind('switch', function (value) {
      this.trigger('switch', this);
    }, this);

    view.bind('selectItem', function (item) {
      this.trigger('selectItem', item.get('val'), this);
    }, this);

    view.bind('selectBins', function (item) {
      this.trigger('selectBins', this);
    }, this);

    view.bind('selectQuantification', function (item) {
      this.trigger('selectQuantification', this);
    }, this);

    return view;
  },

  _updateRamp: function (ramp) {
    this.model.set('range', ramp);
  },

  _updateRange: function (categories) {
    this.model.set('range', _.pluck(categories, 'color'));
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.trigger('back', this);
  }
});


},{"../../../../../../components/stack-layout/stack-layout-view":533,"../input-color-picker/input-color-picker-view":148,"./input-ramp-list-view":159,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],156:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeader">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="InputColor-modalHeader CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <div class="u-flex u-alignStart u-ellipsis">\n        <button class="u-rSpace u-actionTextColor js-back">\n          <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n        </button>\n        <div class="u-ellipsis">\n          '+
((__t=( attribute ))==null?'':_.escape(__t))+
'\n        </div>\n      </div>\n    </li>\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <ul class="u-flex u-justifySpace">\n        <li class="u-flex">\n          '+
((__t=( bins ))==null?'':_.escape(__t))+
' '+
((__t=( _t('form-components.editors.fill.input-ramp.buckets', { smart_count: bins }) ))==null?'':_.escape(__t))+
'\n          <button class="CDB-Shape u-lSpace js-bins">\n            <div class="CDB-Shape-threePoints is-horizontal is-blue is-small">\n              <div class="CDB-Shape-threePointsItem"></div>\n              <div class="CDB-Shape-threePointsItem"></div>\n              <div class="CDB-Shape-threePointsItem"></div>\n            </div>\n          </button>\n        </li>\n        <li class="u-flex">\n          '+
((__t=( _t('form-components.editors.fill.quantification.methods.' + quantification) ))==null?'':_.escape(__t))+
'\n          <button class="CDB-Shape u-lSpace js-quantification">\n            <div class="CDB-Shape-threePoints is-horizontal is-blue is-small">\n              <div class="CDB-Shape-threePointsItem"></div>\n              <div class="CDB-Shape-threePointsItem"></div>\n              <div class="CDB-Shape-threePointsItem"></div>\n            </div>\n          </button>\n        </li>\n      </ul>\n    </li>\n  </ul>\n</div>\n<div class="js-content"></div>\n<div class="CDB-Text CDB-Size-medium CustomRamp-list CustomList-listWrapper">\n  <ul class="CustomList-list js-customList">\n    <li class="CDB-ListDecoration-item CustomList-item CustomList-item--add">\n      <button class="CDB-ListDecoration-itemLink js-listItemLink js-customize u-actionTextColor">'+
((__t=( _t('form-components.editors.fill.customize') ))==null?'':_.escape(__t))+
'</button>\n    </li>\n  </ul>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],157:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ColorBarWrapper--withInvertLink CDB-ListDecoration-itemLink CDB-ListDecoration-itemLink--double js-listItemLink ';
 if (isSelected) { 
__p+=' is-selected ';
 } 
__p+='">\n  <ul class="ColorBarContainer">\n    ';
 _.each(name, function (color) { 
__p+='\n    <li class="ColorBar ColorBar--spaceless" style="background-color: '+
((__t=( color ))==null?'':_.escape(__t))+
';"></li>\n    ';
 }); 
__p+='\n  </ul>\n</div>\n<button class="ColorBar-invertLink js-invert" data-event="invert"></button>\n\n';
}
return __p;
};

},{"underscore":"underscore"}],158:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');

module.exports = CoreView.extend({

  className: 'CDB-ListDecoration-item CustomList-item CustomList-item--invert js-listItem',
  tagName: 'li',

  events: {
    'mouseenter': '_onMouseEnter',
    'mouseleave': '_onMouseLeave',
    'click .js-listItemLink': '_onClick',
    'click .js-invert': '_onClickInvert'
  },

  initialize: function (opts) {
    this.options = _.extend({}, this.options, opts);
    this.listenTo(this.model, 'change', this.render);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    this.$el.append(
      this.options.template(
        _.extend({
          typeLabel: this.options.typeLabel,
          isSelected: this.model.get('selected'),
          isInverted: this.model.get('inverted'),
          isDisabled: this.model.get('disabled'),
          isDestructive: this.model.get('destructive'),
          name: this.model.getName(),
          val: this.model.getValue(),
          options: this.model.get('renderOptions')
        })
      )
    );

    this.$el
      .attr('data-val', this.model.getValue())
      .toggleClass('is-disabled', !!this.model.get('disabled'))
      .toggleClass('is-selected', !!this.model.get('selected'))
      .toggleClass('is-inverted', !!this.model.get('inverted'));

    return this;
  },

  _onMouseLeave: function () {
    this.$el.removeClass('is-highlighted');
  },

  _onMouseEnter: function () {
    this.$el.addClass('is-highlighted');
  },

  _onClick: function (ev) {
    this.killEvent(ev);

    if (this.model.get('selected')) {
      this.trigger('customEvent', 'customize', this.model.get('val'), this);
    } else {
      this.model.set('selected', true);
    }
  },

  _onClickInvert: function (e) {
    this.killEvent(e);
    this.model.set('inverted', !this.model.get('inverted'));
    this.trigger('customEvent', 'invert', this.model, this);
  }
});

},{"backbone/core-view":1127,"underscore":"underscore"}],159:[function(require,module,exports){
var _ = require('underscore');
var cdb = require('cartodb.js');
var CoreView = require('backbone/core-view');
var CustomListView = require('../../../../../custom-list/custom-view');
var CustomListCollection = require('../../../../../custom-list/custom-list-collection');
var rampItemTemplate = require('./input-ramp-list-item-template.tpl');
var rampItemView = require('./input-ramp-list-item-view');
var customRampTemplate = require('./custom-ramp-template.tpl');
var rampList = require('cartocolor');
var template = require('./input-ramp-content-view.tpl');

var DEFAULT_RAMP_ITEM_COLOR = '#CCCCCC';

module.exports = CoreView.extend({
  events: {
    'click .js-customize': '_onClickCustomize',
    'click .js-clear': '_onClickClear',
    'click .js-customRamp': '_onClickCustomRamp',
    'click .js-back': '_onClickBack',
    'click .js-switch': '_onClickSwitch',
    'click .js-quantification': '_onClickQuantification',
    'click .js-bins': '_onClickBins'
  },

  initialize: function (opts) {
    this._showSearch = opts.showSearch || false;
    this._typeLabel = opts.typeLabel;

    this._initModels();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    this.$el.append(template({
      bins: this.model.get('bins'),
      attribute: this.model.get('attribute'),
      quantification: this.model.get('quantification')
    }));

    this._initViews();

    var customRamp = this._customRamp.get('range');

    this.$('.js-customList').prepend(customRampTemplate({
      customRamp: customRamp
    }));

    if (customRamp) {
      this.$('.js-customList').addClass('is-customized');
    } else {
      var selectedRamp = this.collection.getSelectedItem();

      if (!selectedRamp) {
        selectedRamp = this.collection.first();
      }

      this._selectRamp(selectedRamp);
    }

    return this;
  },

  _initModels: function () {
    this._customRamp = new cdb.core.Model();
    this._setupCollection();
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:bins', this._onChangeBins);
    this.listenTo(this.model, 'change:attribute_type', this._updateRampOnAttributeChange);
    this.listenTo(this.collection, 'change:selected', this._onSelectItem);
  },

  _initViews: function () {
    this._listView = new CustomListView({
      collection: this.collection,
      showSearch: this._showSearch,
      typeLabel: this._typeLabel,
      itemTemplate: rampItemTemplate,
      itemView: rampItemView
    });

    this._listView.bind('invert', this._invertRamp, this);
    this._listView.bind('customize', function (ramp) {
      this.trigger('customize', ramp, this);
    }, this);

    this.$('.js-content').append(this._listView.render().el);
    this.addView(this._listView);
  },

  _getRamps: function () {
    var attributeType = this.model.get('attribute_type');
    // select only suitable ramps for the data type
    // number -> ramps
    // string -> category
    var rampTypeFromType = {
      number: ['quantitative', 'diverging'],
      string: ['qualitative']
    };
    var ramps = rampList;
    if (rampTypeFromType[attributeType]) {
      ramps = _.filter(ramps, function (r) {
        // ramp without tags is discarded
        if (r.tags) {
          return _.contains(rampTypeFromType[attributeType], r.tags[0]);
        }
        return false;
      });
    }

    ramps = _.map(ramps, function (rampItem, name) {
      var ramp = rampItem[this.model.get('bins')];
      var range = this.model.get('range');
      var isSelected = false;
      var isInverted = false;

      if (ramp && ramp.length && range && range.length) {
        isSelected = ramp.join().toLowerCase() === range.join().toLowerCase();

        if (!isSelected) {
          isSelected = _.clone(ramp).reverse().join().toLowerCase() === range.join().toLowerCase();
          isInverted = isSelected;
        }
      }

      if (!ramp) {
        return null;
      }

      return {
        selected: isSelected,
        inverted: isInverted,
        name: name,
        val: ramp
      };
    }, this);

    return ramps;
  },

  _setupCollection: function () {
    var ramps = this._getRamps();
    this.collection = new CustomListCollection(_.compact(ramps), { silent: false });
    if (!this.collection.getSelectedItem()) {
      this._customRamp.set('range', this.model.get('range'));
    }
  },

  _updateRampOnAttributeChange: function (m, type) {
    var ramps = this._getRamps();
    // Update the ramps when the attribute changes
    this.collection.reset(_.compact(ramps), {silent: true});
    // and delete the custom ramp
    this._customRamp.set('range', false);

    // apply the first ramp
    var first = this.collection.first();
    first && first.set('selected', true);
    this.render();
  },

  _invertRamp: function (item) {
    if (!item) {
      return;
    }

    this._customRamp.set('range', null);
    item.set('selected', false);
    var ramp = [].concat(item.get('val')).reverse();
    item.set({ val: ramp, selected: true });
    this.model.set('range', ramp);
  },

  _selectRamp: function (item) {
    if (!item) {
      return;
    }

    var range = item.get('val');
    // 'manually' select the item to preserve scroll position
    this.$('.js-listItemLink').removeClass('is-selected');
    this.$('.js-listItem[data-val="' + range.join(',') + '"] .js-listItemLink').addClass('is-selected');
  },

  _onClickClear: function (e) {
    this.killEvent(e);

    this._customRamp.set('range', null);

    if (!this.collection.getSelectedItem()) {
      this.collection.first().set('selected', true);
    }

    this.render();
    this._listView.highlight();
  },

  _onClickCustomRamp: function (e) {
    this.killEvent(e);

    if (this.model.get('range') === this._customRamp.get('range')) {
      this.trigger('customize', this.collection.getSelectedItem(), this);
    } else {
      this.model.set('range', this._customRamp.get('range'));
    }

    this.$('.js-listItemLink').removeClass('is-selected');
    this.$('.js-customRamp').addClass('is-selected');
  },

  _onClickCustomize: function (e) {
    this.killEvent(e);
    var ramp = this.collection.getSelectedItem();
    this._customRamp.set('range', ramp);
    this.trigger('customize', ramp, this);
  },

  _onChangeBins: function () {
    var customRange = this._customRamp.get('range');

    if (customRange) {
      if (this.model.get('bins') > customRange.length) {
        customRange = _.range(this.model.get('bins')).map(function (i) {
          return i >= customRange.length ? DEFAULT_RAMP_ITEM_COLOR : customRange[i];
        });
      } else {
        customRange = customRange.slice(0, this.model.get('bins'));
      }

      this.model.set('range', customRange);
      this._customRamp.set('range', customRange);
    }
  },

  _onSelectItem: function (item) {
    this._selectRamp(item);
    this.trigger('selectItem', item, this);
  },

  _onClickSwitch: function (e) {
    this.killEvent(e);
    this.trigger('switch', this);
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.trigger('back', this);
  },

  _onClickQuantification: function (e) {
    this.killEvent(e);
    this.trigger('selectQuantification', this);
  },

  _onClickBins: function (e) {
    this.killEvent(e);
    this.trigger('selectBins', this);
  }
});

},{"../../../../../custom-list/custom-list-collection":47,"../../../../../custom-list/custom-view":59,"./custom-ramp-template.tpl":153,"./input-ramp-content-view.tpl":156,"./input-ramp-list-item-template.tpl":157,"./input-ramp-list-item-view":158,"backbone/core-view":1127,"cartocolor":"cartocolor","cartodb.js":"cartodb.js","underscore":"underscore"}],160:[function(require,module,exports){
module.exports = {
  green: {
    '3': ['#E5F5F9', '#99D8C9', '#2CA25F'],
    '4': ['#EDF8FB', '#B2E2E2', '#66C2A4', '#238B45'],
    '5': ['#EDF8FB', '#B2E2E2', '#66C2A4', '#2CA25F', '#006D2C'],
    '6': ['#EDF8FB', '#CCECE6', '#99D8C9', '#66C2A4', '#2CA25F', '#006D2C'],
    '7': ['#EDF8FB', '#D7FAF4', '#CCECE6', '#66C2A4', '#41AE76', '#238B45', '#005824']
  },
  blue: {
    '3': ['#EDF8B1', '#7FCDBB', '#2C7FB8'],
    '4': ['#FFFFCC', '#A1DAB4', '#41B6C4', '#225EA8'],
    '5': ['#FFFFCC', '#A1DAB4', '#41B6C4', '#2C7FB8', '#253494'],
    '6': ['#FFFFCC', '#C7E9B4', '#7FCDBB', '#41B6C4', '#2C7FB8', '#253494'],
    '7': ['#FFFFCC', '#C7E9B4', '#7FCDBB', '#41B6C4', '#1D91C0', '#225EA8', '#0C2C84']
  },
  pink: {
    '3': ['#E7E1EF', '#C994C7', '#DD1C77'],
    '4': ['#F1EEF6', '#D7B5D8', '#DF65B0', '#CE1256'],
    '5': ['#F1EEF6', '#D7B5D8', '#DF65B0', '#DD1C77', '#980043'],
    '6': ['#F1EEF6', '#D4B9DA', '#C994C7', '#DF65B0', '#DD1C77', '#980043'],
    '7': ['#F1EEF6', '#D4B9DA', '#C994C7', '#DF65B0', '#E7298A', '#CE1256', '#91003F']
  },
  black: {
    '3': ['#F0F0F0', '#BDBDBD', '#636363'],
    '4': ['#F7F7F7', '#CCCCCC', '#969696', '#525252'],
    '5': ['#F7F7F7', '#CCCCCC', '#969696', '#636363', '#252525'],
    '6': ['#F7F7F7', '#D9D9D9', '#BDBDBD', '#969696', '#636363', '#252525'],
    '7': ['#F7F7F7', '#D9D9D9', '#BDBDBD', '#969696', '#737373', '#525252', '#252525']
  },
  red: {
    '3': ['#FFEDA0', '#FEB24C', '#F03B20'],
    '4': ['#FFFFB2', '#FECC5C', '#FD8D3C', '#E31A1C'],
    '5': ['#FFFFB2', '#FECC5C', '#FD8D3C', '#F03B20', '#BD0026'],
    '6': ['#FFFFB2', '#FED976', '#FEB24C', '#FD8D3C', '#F03B20', '#BD0026'],
    '7': ['#FFFFB2', '#FED976', '#FEB24C', '#FD8D3C', '#FC4E2A', '#E31A1C', '#B10026']
  },
  inverted_green: {
    '3': ['#2CA25F', '#99D8C9', '#E5F5F9'],
    '4': ['#238B45', '#66C2A4', '#B2E2E2', '#EDF8FB'],
    '5': ['#006D2C', '#2CA25F', '#66C2A4', '#B2E2E2', '#EDF8FB'],
    '6': ['#006D2C', '#2CA25F', '#66C2A4', '#99D8C9', '#CCECE6', '#EDF8FB'],
    '7': ['#005824', '#238B45', '#41AE76', '#66C2A4', '#CCECE6', '#D7FAF4', '#EDF8FB']
  },
  inverted_blue: {
    '3': ['#2C7FB8', '#7FCDBB', '#EDF8B1'],
    '4': ['#225EA8', '#41B6C4', '#A1DAB4', '#FFFFCC'],
    '5': ['#253494', '#2C7FB8', '#41B6C4', '#A1DAB4', '#FFFFCC'],
    '6': ['#253494', '#2C7FB8', '#41B6C4', '#7FCDBB', '#C7E9B4', '#FFFFCC'],
    '7': ['#0C2C84', '#225EA8', '#1D91C0', '#41B6C4', '#7FCDBB', '#C7E9B4', '#FFFFCC']
  },
  inverted_pink: {
    '3': ['#DD1C77', '#C994C7', '#E7E1EF'],
    '4': ['#CE1256', '#DF65B0', '#D7B5D8', '#F1EEF6'],
    '5': ['#980043', '#DD1C77', '#DF65B0', '#D7B5D8', '#F1EEF6'],
    '6': ['#980043', '#DD1C77', '#DF65B0', '#C994C7', '#D4B9DA', '#F1EEF6'],
    '7': ['#91003F', '#CE1256', '#E7298A', '#DF65B0', '#C994C7', '#D4B9DA', '#F1EEF6']
  },
  inverted_black: {
    '3': ['#636363', '#BDBDBD', '#F0F0F0'],
    '4': ['#525252', '#969696', '#CCCCCC', '#F7F7F7'],
    '5': ['#252525', '#636363', '#969696', '#CCCCCC', '#F7F7F7'],
    '6': ['#252525', '#636363', '#969696', '#BDBDBD', '#D9D9D9', '#F7F7F7'],
    '7': ['#252525', '#525252', '#737373', '#969696', '#BDBDBD', '#D9D9D9', '#F7F7F7']
  },
  inverted_red: {
    '3': ['#F03B20', '#FEB24C', '#FFEDA0'],
    '4': ['#E31A1C', '#FD8D3C', '#FECC5C', '#FFFFB2'],
    '5': ['#BD0026', '#F03B20', '#FD8D3C', '#FECC5C', '#FFFFB2'],
    '6': ['#BD0026', '#F03B20', '#FD8D3C', '#FEB24C', '#FED976', '#FFFFB2'],
    '7': ['#B10026', '#E31A1C', '#FC4E2A', '#FD8D3C', '#FEB24C', '#FED976', '#FFFFB2']
  },
  spectrum1: {
    '3': ['#1a9850', '#fff2cc', '#d73027'],
    '4': ['#1a9850', '#d2ecb4', '#fed6b0', '#d73027'],
    '5': ['#1a9850', '#8cce8a', '#fff2cc', '#f79272', '#d73027'],
    '6': ['#1a9850', '#8cce8a', '#d2ecb4', '#fed6b0', '#f79272', '#d73027'],
    '7': ['#1a9850', '#8cce8a', '#d2ecb4', '#fff2cc', '#fed6b0', '#f79272', '#d73027']
  },
  spectrum2: {
    '3': ['#0080ff', '#fff2cc', '#ff4d4d'],
    '4': ['#0080ff', '#7fbfff', '#ffa6a6', '#ff4d4d'],
    '5': ['#0080ff', '#40a0ff', '#fff2cc', '#ff7a7a', '#ff4d4d'],
    '6': ['#0080ff', '#40a0ff', '#7fbfff', '#ffa6a6', '#ff7a7a', '#ff4d4d'],
    '7': ['#0080ff', '#40a0ff', '#7fbfff', '#fff2cc', '#ffa6a6', '#ff7a7a', '#ff4d4d']
  },
  purple_states: {
    '3': ['#F1E6F1', '#B379B3', '#8A4E8A'],
    '4': ['#F1E6F1', '#D8BBD8', '#A05AA0', '#8A4E8A'],
    '5': ['#F1E6F1', '#D8BBD8', '#B379B3', '#A05AA0', '#8A4E8A'],
    '6': ['#F1E6F1', '#D8BBD8', '#CCA5CC', '#B379B3', '#A05AA0', '#8A4E8A'],
    '7': ['#F1E6F1', '#D8BBD8', '#CCA5CC', '#C08FC0', '#B379B3', '#A05AA0', '#8A4E8A']
  },
  red_states: {
    '3': ['#F2D2D3', '#D4686C', '#C1373C'],
    '4': ['#F2D2D3', '#EBB7B9', '#CC4E52', '#C1373C'],
    '5': ['#F2D2D3', '#EBB7B9', '#D4686C', '#CC4E52', '#C1373C'],
    '6': ['#F2D2D3', '#EBB7B9', '#E39D9F', '#D4686C', '#CC4E52', '#C1373C'],
    '7': ['#F2D2D3', '#EBB7B9', '#E39D9F', '#DB8286', '#D4686C', '#CC4E52', '#C1373C']
  },
  blue_states: {
    '3': ['#ECF0F6', '#6182B5', '#43618F'],
    '4': ['#ECF0F6', '#B2C2DB', '#4E71A6', '#43618F'],
    '5': ['#ECF0F6', '#B2C2DB', '#6182B5', '#4E71A6', '#43618F'],
    '6': ['#ECF0F6', '#B2C2DB', '#9BB0D0', '#6182B5', '#4E71A6', '#43618F'],
    '7': ['#ECF0F6', '#B2C2DB', '#9BB0D0', '#849EC5', '#6182B5', '#4E71A6', '#43618F']
  },
  inverted_purple_states: {
    '3': ['#8A4E8A', '#B379B3', '#F1E6F1'],
    '4': ['#8A4E8A', '#A05AA0', '#D8BBD8', '#F1E6F1'],
    '5': ['#8A4E8A', '#A05AA0', '#B379B3', '#D8BBD8', '#F1E6F1'],
    '6': ['#8A4E8A', '#A05AA0', '#B379B3', '#CCA5CC', '#D8BBD8', '#F1E6F1'],
    '7': ['#8A4E8A', '#A05AA0', '#B379B3', '#C08FC0', '#CCA5CC', '#D8BBD8', '#F1E6F1']
  },
  inverted_red_states: {
    '3': ['#C1373C', '#D4686C', '#F2D2D3'],
    '4': ['#C1373C', '#CC4E52', '#EBB7B9', '#F2D2D3'],
    '5': ['#C1373C', '#CC4E52', '#D4686C', '#EBB7B9', '#F2D2D3'],
    '6': ['#C1373C', '#CC4E52', '#D4686C', '#E39D9F', '#EBB7B9', '#F2D2D3'],
    '7': ['#C1373C', '#CC4E52', '#D4686C', '#DB8286', '#E39D9F', '#EBB7B9', '#F2D2D3']
  },
  inverted_blue_states: {
    '3': ['#43618F', '#6182B5', '#ECF0F6'],
    '4': ['#43618F', '#4E71A6', '#B2C2DB', '#ECF0F6'],
    '5': ['#43618F', '#4E71A6', '#6182B5', '#B2C2DB', '#ECF0F6'],
    '6': ['#43618F', '#4E71A6', '#6182B5', '#9BB0D0', '#B2C2DB', '#ECF0F6'],
    '7': ['#43618F', '#4E71A6', '#6182B5', '#849EC5', '#9BB0D0', '#B2C2DB', '#ECF0F6']
  }
};

},{}],161:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-ListDecoration-itemLink u-flex u-justifySpace u-alignCenter u-actionTextColor ';
 if (isSelected) { 
__p+=' is-selected ';
 } 
__p+='">\n  '+
((__t=( _t('form-components.editors.fill.quantification.methods.' + name) ))==null?'':_.escape(__t))+
'\n</div>\n\n';
}
return __p;
};

},{"underscore":"underscore"}],162:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var template = require('./input-number-value-content-view.tpl');

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_onClickBack',
    'click .js-bins': '_onClickBins',
    'click .js-quantification': '_onClickQuantification'
  },

  render: function () {
    this.clearSubViews();
    this._removeForm();
    this.$el.empty();

    this.$el.append(template({
      bins: this.model.get('bins'),
      attribute: this.model.get('attribute'),
      quantification: this.model.get('quantification')
    }));

    this._initForm();

    return this;
  },

  _calculateRangeFromFixed: function (fixed, percent) {
    percent = percent || 30;

    var span = this.options.max - this.options.min;
    var delta = fixed / span;

    return [
      Math.floor(Math.max(this.options.min, fixed - percent * delta)),
      Math.floor(Math.min(this.options.max, fixed + percent * delta))
    ];
  },

  _initForm: function () {
    var self = this;

    if (this._formView) {
      this._formView.remove();
    }

    // when range min === max means we come from a fixed value
    // calculate the range values based on this
    var range = this.model.get('range');
    var min, max;

    min = max = this.model.get('fixed');

    if (range) {
      min = +range[0];
      max = +range[1];
    }

    if (min === max) {
      var r = this._calculateRangeFromFixed(min);
      // set the range so changes are propagated
      min = r[0];
      max = r[1];
      this.model.set('range', r);
    }

    this._formModel = new Backbone.Model({
      min: min,
      max: max
    });

    this._formModel.schema = {
      min: {
        type: 'Number',
        validators: ['required', {
          type: 'interval',
          min: self.options.min,
          max: self.options.max
        }]
      },
      max: {
        type: 'Number',
        validators: ['required', {
          type: 'interval',
          min: self.options.min,
          max: self.options.max
        }]
      }
    };

    this._formModel.bind('change', function (input) {
      this.model.set('range', [(+input.get('min')), (+input.get('max'))]);
    }, this);

    this._formView = new Backbone.Form({
      className: 'Editor-boxList',
      model: this._formModel
    });

    this._formView.bind('change', function () {
      this.commit();
    });

    this.$('.js-content').append(this._formView.render().$el);
  },

  _removeForm: function () {
    // Backbone.Form removes the view with the following method
    this._formView && this._formView.remove();
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.trigger('back', this);
  },

  _onClickQuantification: function (e) {
    this.killEvent(e);
    this.trigger('selectQuantification', this);
  },

  _onClickBins: function (e) {
    this.killEvent(e);
    this.trigger('selectBins', this);
  },

  clean: function () {
    this._removeForm();
    CoreView.prototype.clean.call(this);
  }
});

},{"./input-number-value-content-view.tpl":166,"backbone":"backbone","backbone/core-view":1127}],163:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var tabPaneTemplate = require('../fill-tab-pane.tpl');
var createTextLabelsTabPane = require('../../../../../components/tab-pane/create-text-labels-tab-pane');
var InputNumberFixedContentView = require('./input-number-fixed-content-view');
var InputNumberValueContentView = require('./input-number-value-content-view');

var DEFAULT_INPUT_MIN_VALUE = 0;
var DEFAULT_INPUT_MAX_VALUE = 100;
var DEFAULT_INPUT_STEP_VALUE = 1;

module.exports = CoreView.extend({
  initialize: function (opts) {
    if (!opts.columns) throw new Error('columns param is required');
    this._columns = opts.columns;

    this.listenTo(this.model, 'change:attribute', this._updateRangeValue);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initViews: function () {
    var self = this;

    var fixedPane = {
      name: 'fixed',
      label: _t('form-components.editors.fill.input-number.fixed'),
      createContentView: function () {
        return self._generateFixedContentView();
      }
    };

    var valuePane = {
      name: 'value',
      label: _t('form-components.editors.fill.input-number.value'),
      createContentView: function () {
        return self._generateValueContentView();
      }
    };

    this._tabPaneTabs = [];

    if (this.options.editorAttrs && this.options.editorAttrs.hidePanes) {
      var hidePanes = this.options.editorAttrs.hidePanes;
      if (!_.contains(hidePanes, 'fixed')) {
        this._tabPaneTabs.push(fixedPane);
      }
      if (!_.contains(hidePanes, 'value')) {
        this._tabPaneTabs.push(valuePane);
      }
    } else {
      this._tabPaneTabs = [fixedPane, valuePane];
    }

    var tabPaneOptions = {
      tabPaneOptions: {
        template: tabPaneTemplate,
        tabPaneItemOptions: {
          tagName: 'li',
          className: 'CDB-NavMenu-item'
        }
      },
      tabPaneItemLabelOptions: {
        tagName: 'button',
        className: 'CDB-NavMenu-link u-upperCase'
      }
    };

    if (this.model.get('range') && this._tabPaneTabs.length > 1) {
      this._tabPaneTabs[1].selected = true;
    }

    this._tabPaneView = createTextLabelsTabPane(this._tabPaneTabs, tabPaneOptions);
    this.listenTo(this._tabPaneView.collection, 'change:selected', this._onChangeTabPaneViewTab);
    this.addView(this._tabPaneView);
    this.$el.append(this._tabPaneView.render().$el);
  },

  _onChangeTabPaneViewTab: function () {
    var selectedTabPaneName = this._tabPaneView.getSelectedTabPaneName();

    if (selectedTabPaneName === 'fixed') {
      this._updateFixedValue();
    } else {
      this._updateRangeValue();
    }

    this.trigger('change', selectedTabPaneName, this);
  },

  _updateFixedValue: function () {
    if (this.model.get('range')) {
      // when coming from range calculate the average
      var r = this.model.get('range');
      var avg = 0.5 * (+r[0] + +r[1]);
      this.model.set('fixed', avg);
      this.model.unset('range');
    }
  },

  _updateRangeValue: function () {
    if (this.model.get('fixed') !== null && this.model.get('fixed') !== undefined && this.model.get('attribute')) {
      this.model.set('range', [this.model.get('fixed'), this.model.get('fixed')]);
      this.model.unset('fixed');
    }
  },

  _generateFixedContentView: function () {
    var editorAttrs = this.options.editorAttrs;
    return new InputNumberFixedContentView({
      model: this.model,
      min: (editorAttrs && editorAttrs.min) || DEFAULT_INPUT_MIN_VALUE,
      max: (editorAttrs && editorAttrs.max) || DEFAULT_INPUT_MAX_VALUE,
      step: (editorAttrs && editorAttrs.step) || DEFAULT_INPUT_STEP_VALUE
    });
  },

  _generateValueContentView: function () {
    var editorAttrs = this.options.editorAttrs;
    return new InputNumberValueContentView({
      model: this.model,
      columns: this._columns,
      min: (editorAttrs && editorAttrs.min) || DEFAULT_INPUT_MIN_VALUE,
      max: (editorAttrs && editorAttrs.max) || DEFAULT_INPUT_MAX_VALUE
    });
  },

  _onChangeValue: function (input) {
    this.model.set('fixed', input.value);
  }
});

},{"../../../../../components/tab-pane/create-text-labels-tab-pane":537,"../fill-tab-pane.tpl":106,"./input-number-fixed-content-view":164,"./input-number-value-content-view":165,"backbone/core-view":1127,"underscore":"underscore"}],164:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');

module.exports = CoreView.extend({
  render: function () {
    this.clearSubViews();
    this._removeForm();
    this.$el.empty();
    this._initForm();
    return this;
  },

  _initForm: function () {
    this._formModel = new Backbone.Model({
      value: this.model.get('fixed')
    });

    this._formModel.schema = {
      value: {
        type: 'Number',
        validators: ['required', {
          type: 'interval',
          min: this.options.min,
          max: this.options.max,
          step: this.options.step
        }]
      }
    };

    this._formModel.bind('change', function (input) {
      this.model.set('fixed', input.get('value'));
    }, this);

    this._formView = new Backbone.Form({
      className: 'CDB-ListDecoration-itemPadding',
      model: this._formModel
    });

    this._formView.bind('change', function () {
      this.commit();
    });

    this.$el.append(this._formView.render().$el);
  },

  _removeForm: function () {
    // Backbone.Form removes the view with the following method
    this._formView && this._formView.remove();
  },

  clean: function () {
    this._removeForm();
    CoreView.prototype.clean.call(this);
  }
});

},{"backbone":"backbone","backbone/core-view":1127}],165:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var StackLayoutView = require('../../../../../components/stack-layout/stack-layout-view');
var ColumnListView = require('../column-list-view');
var quantificationMethodItemTemplate = require('./quantification-method-item.tpl');
var InputNumberContentView = require('./input-number-content-view');
var DefaultFillSettings = require('../default-fill-settings.json');

/**
 * add the number of classes
 * change the max depending on the min
 * smaller values on top
 */
var COLUMN_PANE_INDEX = 0;
var MAIN_PAIN_INDEX = 1;
var QUANTIFICATION_PANE_INDEX = 2;

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_onClickBack'
  },

  initialize: function (opts) {
    if (!opts.columns) throw new Error('columns param is required');
    this._columns = opts.columns;

    this._settings = DefaultFillSettings.number;

    this._setupModel();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _setupModel: function () {
    var options = {};

    if (!this.model.get('quantification')) {
      options.quantification = this._settings.quantifications.items[this._settings.quantifications.defaultIndex];
    }

    if (!this.model.get('bins')) {
      options.bins = this._settings.bins.items[this._settings.bins.defaultIndex];
    }

    if (+this.model.get('bins') > +this._settings.bins.items[this._settings.bins.items.length - 1]) {
      options.bins = this._settings.bins.items[this._settings.bins.items.length - 1];
    }

    this.model.set(options);
  },

  _initViews: function () {
    var self = this;

    var stackViewCollection = new Backbone.Collection([{
      createStackView: function (stackLayoutModel, opts) {
        return self._createInputRampContentView(stackLayoutModel, opts).bind(self);
      }
    }, {
      createStackView: function (stackLayoutModel, opts) {
        return self._createInputNumberContentView(stackLayoutModel, opts).bind(self);
      }
    }, {
      createStackView: function (stackLayoutModel, opts) {
        return self._createQuantificationListView(stackLayoutModel, opts).bind(self);
      }
    }, {
      createStackView: function (stackLayoutModel, opts) {
        return self._createBinsListView(stackLayoutModel, opts).bind(self);
      }
    }]);

    this._stackLayoutView = new StackLayoutView({
      collection: stackViewCollection
    });

    var position = MAIN_PAIN_INDEX;

    if (!this.model.get('attribute')) {
      position = COLUMN_PANE_INDEX;
    } else if (!this.model.get('quantification')) {
      position = QUANTIFICATION_PANE_INDEX;
    }

    this._stackLayoutView.model.set('position', position);
    this.$el.append(this._stackLayoutView.render().$el);
    this.addView(this._stackLayoutView);
  },

  _createInputRampContentView: function (stackLayoutModel, opts) {
    var view = new ColumnListView({
      stackLayoutModel: stackLayoutModel,
      columns: this._columns.filter(function (f) {
        return f.type === 'number';
      }),
      showSearch: true,
      typeLabel: 'column'
    });

    view.bind('selectItem', function (item) {
      this.model.set('attribute', item.get('val'));
      var step = MAIN_PAIN_INDEX;
      if (!this.model.get('quantification')) {
        step = QUANTIFICATION_PANE_INDEX;
      }
      this._stackLayoutView.model.goToStep(step);
    }, this);

    return view;
  },

  _createInputNumberContentView: function (stackLayoutModel, opts) {
    var view = new InputNumberContentView({
      stackLayoutModel: stackLayoutModel,
      model: this.model,
      min: this.options.min,
      max: this.options.max
    });

    view.bind('back', function (value) {
      stackLayoutModel.prevStep();
    }, this);

    view.bind('selectQuantification', function (value) {
      stackLayoutModel.goToStep(2);
    }, this);

    view.bind('selectBins', function (value) {
      stackLayoutModel.goToStep(3);
    }, this);

    return view;
  },

  _createQuantificationListView: function (stackLayoutModel, opts) {
    var view = new ColumnListView({
      headerTitle: _t('form-components.editors.fill.quantification.title'),
      stackLayoutModel: stackLayoutModel,
      columns: this._settings.quantifications.items,
      itemTemplate: quantificationMethodItemTemplate,
      showSearch: false
    });

    view.bind('selectItem', function (item) {
      this.model.set('quantification', item.get('val'));
      stackLayoutModel.prevStep();
    }, this);

    view.bind('back', function (value) {
      stackLayoutModel.prevStep();
    }, this);

    return view;
  },

  _createBinsListView: function (stackLayoutModel, opts) {
    var view = new ColumnListView({
      headerTitle: _t('form-components.editors.fill.bins'),
      stackLayoutModel: stackLayoutModel,
      columns: this._settings.bins.items
    });

    view.bind('selectItem', function (item) {
      this.model.set('bins', item.get('val'));
      stackLayoutModel.goToStep(1);
    }, this);

    view.bind('back', function (value) {
      stackLayoutModel.goToStep(1);
    }, this);

    return view;
  },

  _onClickBack: function (e) {
    this.killEvent(e);
  }
});

},{"../../../../../components/stack-layout/stack-layout-view":533,"../column-list-view":101,"../default-fill-settings.json":103,"./input-number-content-view":162,"./quantification-method-item.tpl":169,"backbone":"backbone","backbone/core-view":1127}],166:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeader">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="InputColor-modalHeader CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <div class="u-flex u-alignStart u-ellipsis">\n        <button class="u-rSpace u-actionTextColor js-back">\n          <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n        </button>\n        <div class="u-ellipsis">\n          '+
((__t=( attribute ))==null?'':_.escape(__t))+
'\n        </div>\n      </div>\n    </li>\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <ul class="u-flex u-justifySpace">\n        <li class="u-flex">\n          '+
((__t=( bins ))==null?'':_.escape(__t))+
' '+
((__t=( _t('form-components.editors.fill.input-ramp.buckets', { smart_count: bins }) ))==null?'':_.escape(__t))+
'\n          <button class="CDB-Shape u-lSpace js-bins">\n            <div class="CDB-Shape-threePoints is-horizontal is-blue is-small">\n              <div class="CDB-Shape-threePointsItem"></div>\n              <div class="CDB-Shape-threePointsItem"></div>\n              <div class="CDB-Shape-threePointsItem"></div>\n            </div>\n          </button>\n        </li>\n        <li class="u-flex">\n          '+
((__t=( _t('form-components.editors.fill.quantification.methods.' + quantification) ))==null?'':_.escape(__t))+
'\n          <button class="CDB-Shape u-lSpace js-quantification">\n            <div class="CDB-Shape-threePoints is-horizontal is-blue is-small">\n              <div class="CDB-Shape-threePointsItem"></div>\n              <div class="CDB-Shape-threePointsItem"></div>\n              <div class="CDB-Shape-threePointsItem"></div>\n            </div>\n          </button>\n        </li>\n      </ul>\n    </li>\n  </ul>\n</div>\n<div class="js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],167:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./input-number.tpl');
var InputDialogContent = require('./input-number-dialog-content');

module.exports = CoreView.extend({
  tagName: 'li',
  className: 'CDB-OptionInput-item',

  events: {
    'click': '_onClick'
  },

  initialize: function (opts) {
    if (!opts.columns) throw new Error('columns is required');
    this._columns = opts.columns;

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    if (this.options.disabled) {
      this.$el.addClass('is-disabled');
    }

    this.$el.html(template({
      value: this._getValue()
    }));

    return this;
  },

  _createContentView: function () {
    var view = new InputDialogContent({
      model: this.model,
      columns: this._columns,
      editorAttrs: this.options.editorAttrs
    });

    view.bind('change', this.render, this);

    return view;
  },

  _onClick: function (e) {
    if (this.options.disabled) {
      return;
    }
    this.trigger('click', this.model);
  },

  _initBinds: function () {
    this.model.set('createContentView', function () {
      return this._createContentView();
    }.bind(this));

    this.listenTo(this.model, 'change:selected', this._onToggleSelected);
    this.listenTo(this.model, 'change:fixed', this._onChangeValue);
    this.listenTo(this.model, 'change:range', this._onChangeValue);
  },

  _getValue: function () {
    // 1.0 -> 1
    function dropDecimal (f) {
      return f.replace(/\.0$/, '');
    }

    if (this.model.get('range')) {
      return this.model.get('range').map(function (v) {
        return dropDecimal((+v).toFixed(1));
      }).join('..');
    }
    return dropDecimal((+this.model.get('fixed')).toFixed(1));
  },

  _onChangeValue: function () {
    this.$('.js-value').text(this._getValue());
  },

  _onToggleSelected: function () {
    this.$el.toggleClass('is-active', this.model.get('selected'));
  }
});

},{"./input-number-dialog-content":163,"./input-number.tpl":168,"backbone/core-view":1127}],168:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button type="button" class="CDB-OptionInput-content js-value">'+
((__t=( value ))==null?'':_.escape(__t))+
'</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],169:[function(require,module,exports){
arguments[4][161][0].apply(exports,arguments)
},{"dup":161,"underscore":"underscore"}],170:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');

Backbone.Form.editors.List.CategoryModel = Backbone.Form.editors.NestedModel.extend({

  initialize: function (options) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, options);
    EditorHelpers.setOptions(this, options);

    if (!this.form) throw new Error('Missing required option "form"');
    if (!options.schema.model) throw new Error('Missing required "schema.model" option for NestedModel editor');
  },

  render: function () {
    // Get the constructor for creating the nested form; i.e. the same constructor as used by the parent form
    var NestedForm = this.form.constructor;

    var data = this.value || {};
    var NestedModel = this.schema.model;

    // Wrap the data in a model if it isn't already a model instance
    var modelInstance = (data.constructor === NestedModel) ? data : new NestedModel(data, this.options);

    this.nestedForm = new NestedForm({
      model: modelInstance,
      idPrefix: this.id + '_',
      fieldTemplate: 'nestedField'
    });

    this._observeFormEvents();

    // Render form
    this.$el.html(this.nestedForm.render().el);

    if (this.hasFocus) this.trigger('blur', this);

    return this;
  }

});

},{"../editor-helpers-extend":92,"backbone":"backbone"}],171:[function(require,module,exports){
var Backbone = require('backbone');
var $ = require('jquery');
var _ = require('underscore');

/**
 * A single item in the list
 *
 * @param {editors.List} options.list The List editor instance this item belongs to
 * @param {Function} options.Editor   Editor constructor function
 * @param {String} options.key        Model key
 * @param {Mixed} options.value       Value
 * @param {Object} options.schema     Field schema
 */
Backbone.Form.editors.List.Item = Backbone.Form.editors.Base.extend({

  events: {
    'click [data-action="remove"]': function (event) {
      event.preventDefault();
      this.list.removeItem(this);
    },
    'keydown input[type=text]': function (event) {
      if (event.keyCode !== 13) return;
      event.preventDefault();
      this.list.addItem();
      this.list.$list.find('> li:last input').focus();
    }
  },

  initialize: function (options) {
    this.list = options.list;
    this.schema = options.schema || this.list.schema;
    this.value = options.value;
    this.Editor = options.Editor || Backbone.Form.editors.Text;
    this.key = options.key;
    this.template = options.template || this.schema.itemTemplate || this.constructor.template;
    this.errorClassName = options.errorClassName || this.constructor.errorClassName;
    this.form = options.form;
    this.userModel = options.userModel;
    this.configModel = options.configModel;
    this.modals = options.modals;
  },

  render: function () {
    // Create editor
    this.editor = new this.Editor({
      key: this.key,
      schema: this.schema,
      value: this.value,
      list: this.list,
      item: this,
      form: this.form
    }, {
      userModel: this.userModel,
      configModel: this.configModel,
      modals: this.modals
    }).render();

    // Create main element
    var $el = $($.trim(this.template()));

    $el.find('[data-editor]').append(this.editor.el);

    // Replace the entire element so there isn't a wrapper tag
    this.setElement($el);

    return this;
  },

  getValue: function () {
    return this.editor.getValue();
  },

  setValue: function (value) {
    this.editor.setValue(value);
  },

  focus: function () {
    this.editor.focus();
  },

  blur: function () {
    this.editor.blur();
  },

  remove: function () {
    this.editor.remove();

    Backbone.View.prototype.remove.call(this);
  },

  validate: function () {
    var value = this.getValue();
    var formValues = this.list.form ? this.list.form.getValue() : {};
    var validators = this.schema.validators;
    var getValidator = this.getValidator;

    if (!validators) return null;

    // Run through validators until an error is found
    var error = null;
    _.every(validators, function (validator) {
      error = getValidator(validator)(value, formValues);

      return !!error;
    });

    // Show/hide error
    if (error) {
      this.setError(error);
    } else {
      this.clearError();
    }

    // Return error to be aggregated by list
    return error ? error : null; // eslint-disable-line
  },

  /**
   * Show a validation error
   */
  setError: function (err) {
    this.$el.addClass(this.errorClassName);
    this.$el.attr('title', err.message);
  },

  /**
   * Hide validation errors
   */
  clearError: function () {
    this.$el.removeClass(this.errorClassName);
    this.$el.attr('title', null);
  }
}, {

  /*eslint-disable */
  template: _.template('\
      <div>\
        <span data-editor></span>\
        <button type="button" data-action="remove">&times;</button>\
      </div>\
    ', null, Backbone.Form.templateSettings),
  errorClassName: 'error'
  /*eslint-enable */
});

},{"backbone":"backbone","jquery":"jquery","underscore":"underscore"}],172:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var $ = require('jquery');
var _ = require('underscore');

Backbone.Form.editors.List = Backbone.Form.editors.Base.extend({

  events: {
    'click [data-action="add"]': function (event) {
      event.preventDefault();
      this.addItem(null, true);
    }
  },

  initialize: function (options) {
    options = options || {};

    var editors = Backbone.Form.editors;

    editors.Base.prototype.initialize.call(this, options);
    EditorHelpers.setOptions(this, options);

    var schema = this.schema;
    if (!schema) throw new Error("Missing required option 'schema'");

    this.template = options.template || schema.listTemplate || this.constructor.template;

    // Determine the editor to use
    this.Editor = (function () {
      var type = schema.itemType;

      // Default to Text
      if (!type) return editors.Text;

      // Use List-specific version if available
      if (editors.List[type]) return editors.List[type];

      // Or whichever was passed
      return editors[type];
    })();

    this._userModel = this.options.userModel;
    this._configModel = this.options.configModel;
    this._modals = this.options.modals;

    this.items = [];
  },

  render: function () {
    var self = this;
    var value = this.value || [];

    // Create main element
    var $el = $($.trim(this.template()));

    // Store a reference to the list (item container)
    this.$list = $el.is('[data-items]') ? $el : $el.find('[data-items]');

    // Add existing items
    if (value.length) {
      _.each(value, function (itemValue) {
        self.addItem(itemValue);
      });
    } else {
      // If no existing items create an empty one, unless the editor specifies otherwise
      if (!this.Editor.isAsync) this.addItem();
    }

    this.setElement($el);
    this.$el.attr('id', this.id);
    this.$el.attr('name', this.key);

    if (this.hasFocus) this.trigger('blur', this);

    return this;
  },

  /**
   * Add a new item to the list
   * @param {Mixed} [value]           Value for the new item editor
   * @param {Boolean} [userInitiated] If the item was added by the user clicking 'add'
   */
  addItem: function (value, userInitiated) {
    var self = this;
    var editors = Backbone.Form.editors;

    // Create the item
    var item = new editors.List.Item({
      list: this,
      form: this.form,
      schema: this.schema,
      value: value,
      Editor: this.Editor,
      key: this.key,
      userModel: this._userModel,
      configModel: this._configModel,
      modals: this._modals
    }).render();

    var _addItem = function () {
      self.items.push(item);
      self.$list.append(item.el);

      item.editor.on('all', function (event) {
        if (event === 'change') return;

        // args = ["key:change", itemEditor, fieldEditor]
        var args = _.toArray(arguments);
        args[0] = 'item:' + event;
        args.splice(1, 0, self);
        // args = ["item:key:change", this=listEditor, itemEditor, fieldEditor]

        editors.List.prototype.trigger.apply(this, args);
      }, self);

      item.editor.on('change', function () {
        if (!item.addEventTriggered) {
          item.addEventTriggered = true;
          this.trigger('add', this, item.editor);
        }
        this.trigger('item:change', this, item.editor);
        this.trigger('change', this);
      }, self);

      item.editor.on('focus', function () {
        if (this.hasFocus) return;
        this.trigger('focus', this);
      }, self);
      item.editor.on('blur', function () {
        if (!this.hasFocus) return;
        var self = this;
        setTimeout(function () {
          if (_.find(self.items, function (item) {
            return item.editor.hasFocus;
          })) return;
          self.trigger('blur', self);
        }, 0);
      }, self);

      if (userInitiated || value) {
        item.addEventTriggered = true;
      }

      if (userInitiated) {
        self.trigger('add', self, item.editor);
        self.trigger('change', self);
      }
    };

    // Check if we need to wait for the item to complete before adding to the list
    if (this.Editor.isAsync) {
      item.editor.on('readyToAdd', _addItem, this);
    } else {
      // Most editors can be added automatically
      _addItem();
      item.editor.focus();
    }

    return item;
  },

  /**
   * Remove an item from the list
   * @param {List.Item} item
   */
  removeItem: function (item) {
    // Confirm delete
    var confirmMsg = this.schema.confirmDelete;
    if (confirmMsg && !confirm(confirmMsg)) return; // eslint-disable-line

    var index = _.indexOf(this.items, item);

    this.items[index].remove();
    this.items.splice(index, 1);

    if (item.addEventTriggered) {
      this.trigger('remove', this, item.editor);
      this.trigger('change', this);
    }

    if (!this.items.length && !this.Editor.isAsync) this.addItem();
  },

  getValue: function () {
    var values = _.map(this.items, function (item) {
      return item.getValue();
    });

    // Filter empty items
    return _.without(values, undefined, '');
  },

  setValue: function (value) {
    this.value = value;
    this.render();
  },

  focus: function () {
    if (this.hasFocus) return;

    if (this.items[0]) this.items[0].editor.focus();
  },

  blur: function () {
    if (!this.hasFocus) return;

    var focusedItem = _.find(this.items, function (item) {
      return item.editor.hasFocus;
    });

    if (focusedItem) focusedItem.editor.blur();
  },

  /**
   * Override default remove function in order to remove item views
   */
  remove: function () {
    _.invoke(this.items, 'remove');

    Backbone.Form.editors.Base.prototype.remove.call(this);
  },

  /**
   * Run validation
   *
   * @return {Object|Null}
   */
  validate: function () {
    if (!this.validators) return null;

    // Collect errors
    var errors = _.map(this.items, function (item) {
      return item.validate();
    });

    // Check if any item has errors
    var hasErrors = !!_.compact(errors).length;
    if (!hasErrors) return null;

    // If so create a shared error
    var fieldError = {
      type: 'list',
      message: 'Some of the items in the list failed validation',
      errors: errors
    };

    return fieldError;
  }
}, {

  /*eslint-disable */
  template: _.template('\
      <div>\
        <div data-items></div>\
        <button type="button" data-action="add">Add</button>\
      </div>\
    ', null, Backbone.Form.templateSettings)
  /*eslint-enable */
});

},{"../editor-helpers-extend":92,"backbone":"backbone","jquery":"jquery","underscore":"underscore"}],173:[function(require,module,exports){
var CustomListItemView = require('../../../custom-list/custom-list-item-view');
var _ = require('underscore');

module.exports = CustomListItemView.extend({

  render: function () {
    this.$el.empty();
    this.clearSubViews();

    this.$el.append(
      this.options.template(
        _.extend(
          {
            typeLabel: this.options.typeLabel,
            isSelected: this.model.get('selected'),
            name: this.model.getName(),
            val: this.model.getValue()
          },
          this.model.attributes
        )
      )
    );

    this.$el
      .attr('data-val', this.model.getValue())
      .toggleClass('is-disabled', !!this.model.get('disabled'));

    return this;
  }

});

},{"../../../custom-list/custom-list-item-view":50,"underscore":"underscore"}],174:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button type="button" class="CDB-ListDecoration-itemLink u-ellipsis u-actionTextColor" title="'+
((__t=( val ))==null?'':_.escape(__t))+
'">\n  ';
 if (typeof type != 'undefined' && type === 'node') { 
__p+='\n    <div class="u-flex">\n      <span\n        class="SelectorLayer-letter CDB-Text CDB-Size-small u-whiteTextColor u-rSpace u-upperCase"\n        style="background-color: '+
((__t=( color ))==null?'':_.escape(__t))+
';">'+
((__t=( val ))==null?'':_.escape(__t))+
'</span>\n      <p class="CDB-Text CDB-Size-medium u-ellipsis u-flex">\n        '+
((__t=( nodeTitle ))==null?'':_.escape(__t))+
'<span class="u-altTextColor u-lSpace u-ellipsis">'+
((__t=( layerName ))==null?'':_.escape(__t))+
'</span>\n      </p>\n    </div>\n  ';
 } else { 
__p+='\n    '+
((__t=( val ))==null?'':_.escape(__t))+
'\n  ';
 } 
__p+='\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],175:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (typeof isLoading != 'undefined' && isLoading) { 
__p+='\n  <div class="u-flex">\n    <div class="CDB-LoaderIcon CDB-LoaderIcon--small is-dark">\n      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n      </svg>\n    </div>\n    <span class="u-lSpace u-secondaryTextColor">'+
((__t=( _t('components.backbone-forms.select.loading') ))==null?'':_.escape(__t))+
'</span>\n  </div>\n';
 } else { 
__p+='\n  ';
 if (typeof type != 'undefined' && type === 'node') { 
__p+='\n    <div class="u-flex">\n      <span\n        class="SelectorLayer-letter CDB-Text CDB-Size-small u-whiteTextColor u-rSpace u-upperCase"\n        style="background-color: '+
((__t=( color ))==null?'':_.escape(__t))+
';">'+
((__t=( val ))==null?'':_.escape(__t))+
'</span>\n        <p class="CDB-Text CDB-Size-medium u-ellipsis u-flex" title="'+
((__t=( nodeTitle ))==null?'':_.escape(__t))+
' - '+
((__t=( layerName ))==null?'':_.escape(__t))+
'">\n          '+
((__t=( nodeTitle ))==null?'':_.escape(__t))+
' <span class="u-altTextColor u-lSpace u-ellipsis">'+
((__t=( layerName ))==null?'':_.escape(__t))+
'</span>\n        </p>\n    </div>\n  ';
 } else { 
__p+='\n    '+
((__t=( label ))==null?'':_.escape(__t))+
'\n  ';
 } 
__p+='\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],176:[function(require,module,exports){
var Backbone = require('backbone');
var NodeDatasetItemView = require('./node-dataset-item-view');
var nodeDatasetSelectedTemplate = require('./node-dataset-selected.tpl');
var nodeDatasetItemTemplate = require('./node-dataset-item.tpl');

Backbone.Form.editors.NodeDataset = Backbone.Form.editors.Select.extend({

  options: {
    selectedItemTemplate: nodeDatasetSelectedTemplate,
    itemListTemplate: nodeDatasetItemTemplate,
    customListItemView: NodeDatasetItemView
  }

});

},{"./node-dataset-item-view":173,"./node-dataset-item.tpl":174,"./node-dataset-selected.tpl":175,"backbone":"backbone"}],177:[function(require,module,exports){
var Backbone = require('backbone');
var template = require('./number.tpl');
var EditorHelpers = require('../editor-helpers-extend');
require('jquery');
require('jquery-ui');

var UP_ARROW_KEY_CODE = 38;
var BOTTOM_ARROW_KEY_CODE = 40;
var SPACE_KEY_CODE = 32;
var ENTER_KEY_CODE = 13;

var SMALL_INCREMENT = 1;
var BIG_INCREMENT = 10;

Backbone.Form.editors.Number = Backbone.Form.editors.Base.extend({

  tagName: 'ul',
  className: 'CDB-OptionInput-container CDB-OptionInput-container--noMargin u-grow',

  // backbone-forms 0.14.1 has a 'number' validator:
  // https://github.com/powmedia/backbone-forms/blob/v0.14.1/src/validators.js#L64
  // We're on 0.14.0 so we have to use a 'regexp' validator
  options: {
    min: 0,
    max: 10,
    step: 1,
    showSlider: true,
    validators: [{
      type: 'regexp',
      regexp: /^[+-]?((\.\d+)|(\d+(\.\d+)?))$/,
      message: _t('editor.edit-feature.valid')
    }]
  },

  events: {
    'keydown .js-input': '_onInputKeyDown',
    'keyup .js-input': '_onInputKeyUp',
    focus: function () {
      this.trigger('focus', this);
    },
    blur: function () {
      this.trigger('blur', this);
    }
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    // Setting min, max and step from validators, if exists.
    this._validators = opts.validators || (opts.schema && opts.schema.validators);
    if (this._validators && this._validators[1]) {
      this.options.min = this._validators[1].min;
      this.options.max = this._validators[1].max;
      this.options.step = this._validators[1].step;
    }

    this._initViews();
  },

  _initViews: function () {
    var placeholder = (this.value === null) ? 'null' : '';

    this.$el.html(
      template({
        value: this.value,
        isDisabled: this.options.disabled,
        hasSlider: this.options.showSlider,
        isFormatted: this.options.isFormatted,
        placeholder: placeholder
      })
    );

    if (this.options.showSlider) {
      this.$('.js-slider').slider({
        range: 'min',
        value: this.value,
        min: this.options.min,
        max: this.options.max,
        step: this.options.step,
        orientation: 'horizontal',
        disabled: this.options.disabled,
        slide: this._onSlideChange.bind(this),
        stop: this._onSlideStop.bind(this)
      });
    }

    this.$el.toggleClass('CDB-OptionInput-container--noSlider', !!this.options.showSlider);
  },

  _onSlideChange: function (ev, ui) {
    this.value = ui.value;
    this.$('.js-input').val(this.value);
  },

  _onSlideStop: function (ev, ui) {
    this.trigger('change', this);
  },

  _onInputKeyDown: function (e) {
    var value = +this.getValue();
    var inc = SMALL_INCREMENT;
    var $input = this.$('.js-input');

    if (e.shiftKey === true) {
      inc = BIG_INCREMENT;
    }

    switch (e.which) {
      case SPACE_KEY_CODE:
      case ENTER_KEY_CODE:
        return false;
      case UP_ARROW_KEY_CODE:
        value += inc;
        $input.val(value);
        break;
      case BOTTOM_ARROW_KEY_CODE:
        value -= inc;
        $input.val(value);
        break;
      default:
        // Any other case!
    }
  },

  _hasSlider: function () {
    return this.options.showSlider && this.$('.js-slider').data('ui-slider');
  },

  _onInputKeyUp: function () {
    var value = this.$('.js-input').val();
    if (this._hasSlider()) {
      this.$('.js-slider').slider('value', value);
    }

    this.value = value;
    this.trigger('change', this);
  },

  focus: function () {
    if (this.hasFocus) return;
    this.$('.js-input').focus();
  },

  blur: function () {
    if (!this.hasFocus) return;
    this.$('.js-input').blur();
  },

  getValue: function () {
    var val = this.$('.js-input').val();

    return (val === '') ? null : +val;
  },

  setValue: function (value) {
    if (this._hasSlider()) {
      this.$('.js-slider').slider('value', value);
    }

    this.$('.js-input').val(value);
    this.value = value;
  },

  _destroySlider: function () {
    if (this._hasSlider()) {
      this.$('.js-slider').slider('destroy');
    }
  },

  remove: function () {
    this._destroySlider();
    Backbone.Form.editors.Base.prototype.remove.apply(this);
  },

  clean: function () {
    this.$el.remove();
  }
});

},{"../editor-helpers-extend":92,"./number.tpl":178,"backbone":"backbone","jquery":"jquery","jquery-ui":1128}],178:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (hasSlider) { 
__p+='\n  <li class="CDB-OptionInput-item CDB-OptionInput-item--noSeparator">\n    <div class="UISlider js-slider"></div>\n  </li>\n';
 } 
__p+='\n<li class="CDB-OptionInput-item">\n  <input type="text" class="CDB-InputText ';
 if (isFormatted) { 
__p+='is-number';
 } 
__p+=' ';
 if (isDisabled) { 
__p+='is-disabled';
 } 
__p+=' js-input" ';
 if (isDisabled) { 
__p+='readonly';
 } 
__p+=' value="'+
((__t=( value ))==null?'':_.escape(__t))+
'" placeholder="'+
((__t=( placeholder ))==null?'':_.escape(__t))+
'" />\n</li>\n';
}
return __p;
};

},{"underscore":"underscore"}],179:[function(require,module,exports){
var CustomListCollection = require('../../../custom-list/custom-list-collection');
var _ = require('underscore');

/*
 *  Custom list collection, it parses pairs like:
 *
 *  [{ val, label }]
 *  ["string"]
 */

module.exports = CustomListCollection.extend({

  search: function (query) {
    query = query.toLowerCase();

    return _(this.filter(function (model) {
      var val = model.getName().toLowerCase();
      var type = model.get('type').toLowerCase();
      return ~val.indexOf(query) && type === 'number';
    }));
  }

});

},{"../../../custom-list/custom-list-collection":47,"underscore":"underscore"}],180:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text CDB-Size-medium u-altTextColor Editor-dropDownInfoText">\n  '+
((__t=( _t('components.backbone-forms.operators.count-message') ))==null?'':_.escape(__t))+
'\n</p>\n';
}
return __p;
};

},{"underscore":"underscore"}],181:[function(require,module,exports){
var Backbone = require('backbone');

module.exports = Backbone.Model.extend({

  defaults: {
    visible: false,
    operator: 'count',
    attribute: ''
  },

  isValidOperator: function () {
    var operator = this.get('operator');
    var attribute = this.get('attribute');

    if (operator === 'count') {
      return true;
    } else {
      if (operator && attribute) {
        return true;
      }
      return false;
    }
  }

});

},{"backbone":"backbone"}],182:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var $ = require('jquery');
var CustomListView = require('../../../custom-list/custom-view');
var OperatorsListModel = require('./operators-list-model');
var emptyTemplate = require('./operators-list-count.tpl');
var template = require('./operators-list.tpl');

module.exports = CoreView.extend({

  className: 'Editor-dropdown Editor-boxModal Editor-dropdownOperators',
  tagName: 'div',

  events: {
    'change input[name="operator"]': '_onOperationChange'
  },

  initialize: function (opts) {
    this.model = new OperatorsListModel({
      operator: opts.operator,
      attribute: opts.attribute,
      visible: false
    });

    if (opts.attribute) {
      this.collection.setSelected(opts.attribute);
    }

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this.$el.append(
      template({
        operator: this.model.get('operator')
      })
    );
    this._renderList();
    return this;
  },

  _initBinds: function () {
    this.model.bind('change:operator change:attribute', _.debounce(this._onModelChange.bind(this), 10));
    this.model.bind('change:visible', function (mdl, isVisible) {
      this._toggleVisibility();

      if (!isVisible) {
        this._destroyList();
        this.$('.js-list').html(emptyTemplate());
      } else {
        this.render();
      }
    }, this);
    this.collection.bind('change:selected', this._onAttributeSelected, this);
    this.add_related_model(this.collection);
  },

  _hasList: function () {
    return !!this._listView;
  },

  _renderList: function () {
    if (this.model.get('operator') !== 'count') {
      if (this._hasList()) {
        return;
      }

      this._listView = new CustomListView({
        className: 'CDB-Dropdown-options CDB-Text CDB-Size-medium',
        collection: this.collection,
        showSearch: true,
        typeLabel: this.options.keyAttr
      });
      this.$('.js-list').html(this._listView.render().el);
    } else {
      this._destroyList();
      this.$('.js-list').html(emptyTemplate());
    }
  },

  _destroyList: function () {
    if (this._hasList()) {
      this.removeView(this._listView);
      this._listView.clean();
      delete this._listView;
    }
  },

  _onModelChange: function () {
    if (this.model.isValidOperator()) {
      this.trigger('change', this.model.toJSON(), this);
    }
  },

  _onOperationChange: function (ev) {
    var $input = $(ev.target);
    var operator = $input.val();

    if (operator === 'count') {
      this.model.set('attribute', '');
      this.collection.removeSelected();
    }

    this.model.set('operator', operator);

    this._renderList();
  },

  _onAttributeSelected: function (mdl) {
    if (mdl.get('selected')) {
      this.model.set('attribute', mdl.getValue());
    }
  },

  _toggleVisibility: function () {
    this.$el.toggleClass('is-visible', !!this.model.get('visible'));
  },

  show: function () {
    this.model.set('visible', true);
  },

  hide: function () {
    this.model.set('visible', false);
  },

  toggle: function () {
    this.model.set('visible', !this.model.get('visible'));
  },

  isVisible: function () {
    return this.model.get('visible');
  },

  remove: function () {
    this._destroyList();
    this.$el.empty();
    CoreView.prototype.remove.call(this);
  }
});

},{"../../../custom-list/custom-view":59,"./operators-list-count.tpl":180,"./operators-list-model":181,"./operators-list.tpl":183,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],183:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="Editor-dropdownCalculations CDB-Text is-semibold">\n  <li class="Editor-dropdownCalculationsElement CDB-Fieldset">\n    <input class="CDB-Radio" type="radio" name="operator" value="count" ';
 if (operator === 'count') { 
__p+='checked';
 } 
__p+='>\n    <span class="u-iBlock CDB-Radio-face"></span>\n    <label class="u-iBlock u-lSpace">'+
((__t=( _t('operators.count') ))==null?'':_.escape(__t))+
'</label>\n  </li>\n  <li class="Editor-dropdownCalculationsElement CDB-Fieldset">\n    <input class="CDB-Radio" type="radio" name="operator" value="sum" ';
 if (operator === 'sum') { 
__p+='checked';
 } 
__p+='>\n    <span class="u-iBlock CDB-Radio-face"></span>\n    <label class="u-iBlock u-lSpace">'+
((__t=( _t('operators.sum') ))==null?'':_.escape(__t))+
'</label>\n  </li>\n  <li class="Editor-dropdownCalculationsElement CDB-Fieldset">\n    <input class="CDB-Radio" type="radio" name="operator" value="avg" ';
 if (operator === 'avg') { 
__p+='checked';
 } 
__p+='>\n    <span class="u-iBlock CDB-Radio-face"></span>\n    <label class="u-iBlock u-lSpace">'+
((__t=( _t('operators.avg') ))==null?'':_.escape(__t))+
'</label>\n  </li>\n  <li class="Editor-dropdownCalculationsElement CDB-Fieldset">\n    <input class="CDB-Radio" type="radio" name="operator" value="max" ';
 if (operator === 'max') { 
__p+='checked';
 } 
__p+='>\n    <span class="u-iBlock CDB-Radio-face"></span>\n    <label class="u-iBlock u-lSpace">'+
((__t=( _t('operators.max') ))==null?'':_.escape(__t))+
'</label>\n  </li>\n  <li class="Editor-dropdownCalculationsElement CDB-Fieldset">\n    <input class="CDB-Radio" type="radio" name="operator" value="min" ';
 if (operator === 'min') { 
__p+='checked';
 } 
__p+='>\n    <span class="u-iBlock CDB-Radio-face"></span>\n    <label class="u-iBlock u-lSpace">'+
((__t=( _t('operators.min') ))==null?'':_.escape(__t))+
'</label>\n  </li>\n</ul>\n<div class="js-list"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],184:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var _ = require('underscore');
var $ = require('jquery');
var OperatorListView = require('./operators-list-view');
var OperatorListCollection = require('./operators-list-collection');
var template = require('./operators.tpl');
var ENTER_KEY_CODE = 13;
var PopupManager = require('../../../popup-manager');

Backbone.Form.editors.Operators = Backbone.Form.editors.Base.extend({

  tagName: 'div',
  className: 'Editor-formSelect u-ellipsis',

  events: {
    'click .js-button': '_onButtonClick',
    'keydown .js-button': '_onButtonKeyDown',
    'focus .js-button': function () {
      this.trigger('focus', this);
    },
    'blur': function () {
      this.trigger('blur', this);
    }
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    this.collection = new OperatorListCollection(this.options.options);
    this.dialogMode = this.options.dialogMode || 'nested';

    this._initViews();
    this.setValue(this.model.get(this.options.keyAttr));
    this._initBinds();
  },

  _initViews: function () {
    var value = this.model.get(this.options.keyAttr);

    this.$el.append(
      $('<div>').addClass('js-operator')
    );

    this._setOperatorTemplate();

    this._operatorsListView = new OperatorListView({
      operator: value.operator,
      attribute: value.attribute,
      collection: this.collection
    });
    this._operatorsListView.bind('change', this._onOperatorsChange, this);

    this._popupManager = new PopupManager(this.cid, this.$el, this._operatorsListView.$el);
    this._popupManager.append(this.dialogMode);

    if (this.options.disabled) {
      this.undelegateEvents();
    }
  },

  _setOperatorTemplate: function () {
    this.$('.js-operator').html(
      template({
        name: this._getOperatorsTextValue(),
        disabled: this.options.disabled,
        keyAttr: this.options.keyAttr
      })
    );
  },

  _initBinds: function () {
    var hide = function () {
      this._operatorsListView.hide();
      this._popupManager.untrack();
    }.bind(this);

    this.applyESCBind(hide);
    this.applyClickOutsideBind(hide);
  },

  _onOperatorsChange: function (data) {
    this.model.set(this.options.keyAttr, data);
    this._setOperatorTemplate();
    this.$('.js-button').focus();
    this.trigger('change', this);
  },

  _getOperatorsTextValue: function () {
    var value = this.model.get(this.options.keyAttr);
    if (value && value.operator) {
      return value.operator.toUpperCase() + (value.attribute ? '(' + value.attribute + ')' : '');
    } else {
      return '';
    }
  },

  _onButtonClick: function (ev) {
    this._operatorsListView.toggle();
    this._operatorsListView.isVisible() ? this._popupManager.track() : this._popupManager.untrack();
  },

  _onButtonKeyDown: function (ev) {
    if (ev.which === ENTER_KEY_CODE) {
      ev.preventDefault();
      if (!this._operatorsListView.isVisible()) {
        ev.stopPropagation();
        this._operatorsListView.toggle();
        this._popupManager.track();
      } else {
        this._popupManager.untrack();
      }
    }
  },

  getValue: function () {
    var data = this.model.get(this.options.keyAttr);
    return _.omit(data, 'visible');
  },

  setValue: function (value) {
    var textValue = this._getOperatorsTextValue();
    this.value = textValue;
    this._setOperatorTemplate();
  },

  remove: function () {
    this._popupManager && this._popupManager.destroy();
    this._operatorsListView && this._operatorsListView.clean();
    Backbone.Form.editors.Base.prototype.remove.call(this);
  }

});

},{"../../../popup-manager":522,"../editor-helpers-extend":92,"./operators-list-collection":179,"./operators-list-view":182,"./operators.tpl":185,"backbone":"backbone","jquery":"jquery","underscore":"underscore"}],185:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-InputText CDB-Text is-cursor js-button u-ellipsis\n  ';
 if (disabled) { 
__p+=' is-disabled ';
 } 
__p+='\n  ';
 if (!name) { 
__p+=' is-empty ';
 } 
__p+='"\n  tabindex="0">\n  '+
((__t=( name || _t('components.backbone-forms.select.placeholder', { keyAttr: keyAttr }) ))==null?'':_.escape(__t))+
'\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],186:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var template = require('./radio.tpl');
var _ = require('underscore');
var $ = require('jquery');
var TipsyTooltipView = require('../../../tipsy-tooltip-view');

Backbone.Form.editors.Radio = Backbone.Form.editors.Radio.extend({

  className: 'CDB-Text CDB-Size-medium u-flex u-alignCenter',

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.apply(this, arguments);
    EditorHelpers.setOptions(this, opts);
  },

  render: function () {
    this.setOptions(this.schema.options); // It comes from the default Select editor (not ours)
    this._setHelp();
    return this;
  },

  _setHelp: function () {
    var containsHelp = _.find(this.schema.options, function (option) {
      return option.help;
    });

    if (containsHelp) {
      this._helpTooltip = this._createTooltip({
        $el: this.$('.js-help')
      });
    }
  },

  _createTooltip: function (opts) {
    return new TipsyTooltipView({
      el: opts.$el || this.$el,
      gravity: opts.gravity || 's',
      className: opts.className || '',
      offset: opts.offset || 0,
      title: function () {
        return opts.msg || $(this).data('tooltip');
      }
    });
  },

  getValue: function () {
    var value = this.$('input[type=radio]:checked').val();

    return (value === '') ? null : value;
  },

  _arrayToHtml: function (array) {
    var selectedVal = this.form.model.get(this.key);

    var items = _.map(array, function (option, index) {
      var val = option.val;

      var item = {
        name: this.getName(),
        value: (val === null) ? '' : val.toString(),
        help: option.help,
        id: this.id,
        label: option.label,
        className: option.className
      };

      // Can't be selected and disabled simultaneously
      if (selectedVal === val) {
        item.selected = true;
      } else {
        item.disabled = option.disabled;
      }

      return item;
    }, this);

    return template({
      items: items
    });
  },

  remove: function () {
    if (this._helpTooltip) {
      this._helpTooltip.clean();
    }
    Backbone.Form.editors.Base.prototype.remove.call(this);
  }
});

},{"../../../tipsy-tooltip-view":589,"../editor-helpers-extend":92,"./radio.tpl":187,"backbone":"backbone","jquery":"jquery","underscore":"underscore"}],187:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 _.each(items, function(item, index) { 
__p+='\n  <li class="u-flex u-alignCenter '+
((__t=( (index === (items.length - 1)) ? '' : 'u-rSpace--xl' ))==null?'':_.escape(__t))+
'">\n    <input type="radio" class="CDB-Radio u-iBlock';
 if (item.className) { 
__p+=' '+
((__t=( item.className ))==null?'':_.escape(__t))+
' ';
 } 
__p+='"\n    name="'+
((__t=( item.name ))==null?'':_.escape(__t))+
'" value="'+
((__t=( item.value ))==null?'':_.escape(__t))+
'" id="'+
((__t=( item.id ))==null?'':_.escape(__t))+
'" \n        ';
 if (item.selected) { 
__p+='\n          checked="checked"\n        ';
 } else if (item.disabled) { 
__p+='\n          disabled="disabled"\n        ';
 } 
__p+='\n      />\n    <span class="u-rSpace CDB-Radio-face"></span>\n      ';
 if (item.help) { 
__p+='\n        <span class="js-help is-underlined u-lSpace" data-tooltip="'+
((__t=( item.help ))==null?'':_.escape(__t))+
'">\n      ';
 } 
__p+='\n      '+
((__t=( item.label ))==null?'':_.escape(__t))+
'\n      ';
 if (item.help) { 
__p+='\n        </span>\n      ';
 } 
__p+='\n  </li>\n';
 }); 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],188:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var _ = require('underscore');
var CustomListView = require('../../../custom-list/custom-view');
var CustomListCollection = require('../../../custom-list/custom-list-multi-collection');
var selectedItemTemplate = require('./select-item.tpl');
var CustomListItemView = require('../../../custom-list/custom-list-multi-item-view');
var itemListTemplate = require('../../../custom-list/custom-list-item-with-checkbox.tpl');
var template = require('./select.tpl');
var PopupManager = require('../../../popup-manager');

var ENTER_KEY_CODE = 13;

Backbone.Form.editors.MultiSelect = Backbone.Form.editors.Base.extend({

  tagName: 'div',
  className: 'u-ellipsis Editor-formSelect',

  events: {
    'click .js-button': '_onButtonClick',
    'keydown .js-button': '_onButtonKeyDown',
    'focus .js-button': function () {
      this.trigger('focus', this);
    },
    'blur': function () {
      this.trigger('blur', this);
    }
  },

  options: {
    selectedItemTemplate: selectedItemTemplate,
    itemListTemplate: itemListTemplate,
    customListItemView: CustomListItemView
  },

  initialize: function (opts) {
    EditorHelpers.setOptions(this, opts);

    this.collection = new CustomListCollection(opts.schema.options);
    this.dialogMode = this.options.dialogMode || 'nested';

    this._initViews();
    this.setValue(this.model.get(opts.key));
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);

    this._initBinds();
  },

  _getLabel: function () {
    var itemCount = _.compact(this.collection.pluck('selected')).length;
    return _t('components.backbone-forms.select.selected', { count: itemCount });
  },

  _initViews: function () {
    var isLoading = this.options.loading;
    var isEmpty = !this.collection.length;
    var isDisabled = !isEmpty ? this.options.disabled : true;
    var name = this._getLabel();
    var isNull = name === null;
    var label = isNull ? 'null' : name;

    this.$el.html(
      template({
        label: label,
        keyAttr: this.options.keyAttr,
        isDisabled: isDisabled,
        isLoading: isLoading,
        isEmpty: isEmpty,
        isNull: isNull,
        placeholder: null
      })
    );

    if (isDisabled) {
      this.undelegateEvents();
    }

    this._listView = new CustomListView({
      collection: this.collection,
      showSearch: this.options.showSearch,
      typeLabel: this.options.keyAttr,
      itemTemplate: this.options.itemListTemplate,
      itemView: this.options.customListItemView,
      searchPlaceholder: null
    });

    this._listView.bind('hidden', this._onHide, this);

    this._popupManager = new PopupManager(this.cid, this.$el, this._listView.$el);
    this._popupManager.append(this.dialogMode);
  },

  _initBinds: function () {
    var hide = function () {
      this._listView.hide();
      this._popupManager.untrack();
    }.bind(this);

    this.collection.bind('change:selected', this._onItemSelected, this);
    this.applyESCBind(hide);
    this.applyClickOutsideBind(hide);
  },

  _onItemSelected: function (mdl) {
    this._renderButton(mdl).focus();
    this.trigger('change', this);
  },

  _onButtonClick: function (ev) {
    this._listView.toggle();
    this._listView.isVisible() ? this._popupManager.track() : this._popupManager.untrack();
  },

  _onButtonKeyDown: function (ev) {
    if (ev.which === ENTER_KEY_CODE) {
      ev.preventDefault();
      if (!this._listView.isVisible()) {
        ev.stopPropagation();
        this._listView.toggle();
        this._popupManager.track();
      } else {
        this._popupManager.untrack();
      }
    }
  },

  _getSelectedValues: function () {
    return this.collection.chain().map(function (m) { return m.get('selected') ? m.get('val') : null; }).compact().value();
  },

  getValue: function () {
    var values = this._getSelectedValues();
    if (values.length > 0) {
      return values;
    }
    return;
  },

  setValue: function (value) {
    if (value) {
      var selectedModel = this.collection.setSelected(value);

      if (selectedModel) {
        this._renderButton(selectedModel);
      }
    }
  },

  _renderButton: function (mdl) {
    var button = this.$('.js-button');
    var data = _.extend({}, mdl.attributes, { label: this._getLabel() });
    var $html = this.options.selectedItemTemplate(data);

    button
      .removeClass('is-empty')
      .html($html);

    return button;
  },

  _onHide: function () {
    if (this._getSelectedValues().length > 0) {
      this.trigger('change', this);
    }
  },

  remove: function () {
    this._popupManager && this._popupManager.destroy();
    this._listView && this._listView.clean();
    Backbone.Form.editors.Base.prototype.remove.call(this);
  }
});

},{"../../../custom-list/custom-list-item-with-checkbox.tpl":51,"../../../custom-list/custom-list-multi-collection":53,"../../../custom-list/custom-list-multi-item-view":54,"../../../custom-list/custom-view":59,"../../../popup-manager":522,"../editor-helpers-extend":92,"./select-item.tpl":189,"./select.tpl":194,"backbone":"backbone","underscore":"underscore"}],189:[function(require,module,exports){
arguments[4][72][0].apply(exports,arguments)
},{"dup":72,"underscore":"underscore"}],190:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button type="button" class="CDB-ListDecoration-itemLink\n  ';
 if (isSelected) { 
__p+=' is-selected ';
 } 
__p+=' ';
 if (isDestructive) { 
__p+='  u-alertTextColor ';
 } else { 
__p+=' u-actionTextColor ';
 } 
__p+='"\n  title="'+
((__t=( nodeTitle ))==null?'':_.escape(__t))+
' - '+
((__t=( layerName ))==null?'':_.escape(__t))+
'">\n  <div class="u-flex">\n    <span class="SelectorLayer-letter CDB-Text CDB-Size-small u-whiteTextColor u-rSpace u-upperCase" style="background-color: '+
((__t=( color ))==null?'':_.escape(__t))+
';">'+
((__t=( layer_id ))==null?'':_.escape(__t))+
'</span>\n    <p class="CDB-Text CDB-Size-medium u-ellipsis u-flex">\n      '+
((__t=( nodeTitle ))==null?'':_.escape(__t))+
' <span class="u-altTextColor u-lSpace u-ellipsis">'+
((__t=( layerName ))==null?'':_.escape(__t))+
'</span>\n    </p>\n  </div>\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],191:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');

module.exports = CoreView.extend({

  options: {
    template: require('./select-layer-list-item.tpl')
  },

  className: 'CDB-ListDecoration-item CustomList-item js-listItem',
  tagName: 'li',

  events: {
    'mouseenter': '_onMouseEnter',
    'mouseleave': '_onMouseLeave',
    'click': '_onClick'
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    this.$el.append(
      this.options.template(
        _.extend({
          typeLabel: this.options.typeLabel,
          isSelected: this.model.get('selected'),
          isDestructive: this.model.get('destructive'),
          layerName: this.model.get('layerName'),
          nodeTitle: this.model.get('nodeTitle'),
          color: this.model.get('color'),
          layer_id: this.model.get('layer_id')
        })
      )
    );

    this.$el.attr('data-val', this.model.getValue());

    return this;
  },

  _onMouseLeave: function () {
    this.$el.removeClass('is-highlighted');
  },

  _onMouseEnter: function () {
    this.$el.addClass('is-highlighted');
  },

  _onClick: function (e) {
    e.stopPropagation();
    this.model.set('selected', true);
  }
});

},{"./select-layer-list-item.tpl":192,"backbone/core-view":1127,"underscore":"underscore"}],192:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex">\n  <span class="SelectorLayer-letter CDB-Text CDB-Size-small u-whiteTextColor u-rSpace u-upperCase" style="background-color: '+
((__t=( color ))==null?'':_.escape(__t))+
';">'+
((__t=( layer_id ))==null?'':_.escape(__t))+
'</span>\n  <p class="CDB-Text CDB-Size-medium u-ellipsis u-flex" title="'+
((__t=( nodeTitle ))==null?'':_.escape(__t))+
' - '+
((__t=( layerName ))==null?'':_.escape(__t))+
'">\n    '+
((__t=( nodeTitle ))==null?'':_.escape(__t))+
' <span class="u-altTextColor u-lSpace u-ellipsis">'+
((__t=( layerName ))==null?'':_.escape(__t))+
'</span>\n  </p>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],193:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var _ = require('underscore');
var CustomListView = require('../../../custom-list/custom-view');
var CustomListCollection = require('../../../custom-list/custom-list-collection');
var selectedItemTemplate = require('./select-item.tpl');
var CustomListItemView = require('../../../custom-list/custom-list-item-view');
var itemListTemplate = require('../../../custom-list/custom-list-item.tpl');
var template = require('./select.tpl');
var PopupManager = require('../../../popup-manager');

var ENTER_KEY_CODE = 13;

Backbone.Form.editors.Select = Backbone.Form.editors.Base.extend({

  tagName: 'div',
  className: 'u-ellipsis Editor-formSelect',

  events: {
    'click .js-button': '_onButtonClick',
    'keydown .js-button': '_onButtonKeyDown',
    'focus .js-button': function () {
      this.trigger('focus', this);
    },
    'blur': function () {
      this.trigger('blur', this);
    }
  },

  options: {
    selectedItemTemplate: selectedItemTemplate,
    itemListTemplate: itemListTemplate,
    customListItemView: CustomListItemView
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    this.template = opts.template || template;
    this.dialogMode = this.options.dialogMode || 'nested';
    this.collection = new CustomListCollection(this.options.options);
    this._initViews();

    this.setValue(this.model.get(this.options.keyAttr));

    this._initBinds();
  },

  _initViews: function () {
    var isLoading = this.options.loading;
    var isEmpty = !this.collection.length;
    var isDisabled = !isEmpty ? this.options.disabled : true;
    var name = this.model.get(this.options.keyAttr);
    var isNull = name === null;
    var label = isNull ? 'null' : name;
    var placeholder = this.options.placeholder;
    var typeLabel = this.options.keyAttr;

    this.$el.html(
      this.template({
        label: label,
        keyAttr: this.options.keyAttr,
        placeholder: placeholder,
        isDisabled: isDisabled,
        isLoading: isLoading,
        isEmpty: isEmpty,
        isNull: isNull
      })
    );

    if (isDisabled) {
      this.undelegateEvents();
    }

    this._listView = new CustomListView({
      collection: this.collection,
      showSearch: this.options.showSearch,
      allowFreeTextInput: this.options.allowFreeTextInput,
      typeLabel: typeLabel,
      itemTemplate: this.options.itemListTemplate,
      itemView: this.options.customListItemView,
      position: this.options.position,
      searchPlaceholder: this.options.searchPlaceholder
    });

    this._popupManager = new PopupManager(this.cid, this.$el, this._listView.$el);
    this._popupManager.append(this.dialogMode);
  },

  _initBinds: function () {
    var hide = function () {
      this._listView.hide();
      this._popupManager.untrack();
    }.bind(this);

    this.collection.bind('change:selected', this._onItemSelected, this);
    this.applyESCBind(hide);
    this.applyClickOutsideBind(hide);
  },

  _onItemSelected: function (mdl) {
    this._listView.hide();
    this._popupManager.untrack();
    this._renderButton(mdl).focus();
    this.trigger('change', this);
  },

  _onButtonClick: function (ev) {
    this._listView.toggle();
    this._listView.isVisible() ? this._popupManager.track() : this._popupManager.untrack();
  },

  _onButtonKeyDown: function (ev) {
    if (ev.which === ENTER_KEY_CODE) {
      ev.preventDefault();
      if (!this._listView.isVisible()) {
        ev.stopPropagation();
        this._listView.toggle();
      } else {
        this._popupManager.track();
      }
    }
  },

  getValue: function () {
    var item = this.collection.getSelectedItem();
    if (item) {
      return item.getValue();
    }
    return;
  },

  setValue: function (value) {
    var selectedModel = this.collection.setSelected(value);
    if (selectedModel) {
      this._renderButton(selectedModel);
    }
    this.value = value;
  },

  _renderButton: function (mdl) {
    var button = this.$('.js-button');
    var data = _.extend({}, {label: mdl.getName()}, mdl.attributes);
    var $html = this.options.selectedItemTemplate(data);

    button
      .removeClass('is-empty')
      .html($html);

    return button;
  },

  remove: function () {
    this._popupManager && this._popupManager.destroy();
    this._listView && this._listView.clean();
    Backbone.Form.editors.Base.prototype.remove.call(this);
  }

});

},{"../../../custom-list/custom-list-collection":47,"../../../custom-list/custom-list-item-view":50,"../../../custom-list/custom-list-item.tpl":52,"../../../custom-list/custom-view":59,"../../../popup-manager":522,"../editor-helpers-extend":92,"./select-item.tpl":189,"./select.tpl":194,"backbone":"backbone","underscore":"underscore"}],194:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-InputText CDB-Text is-cursor js-button u-ellipsis\n  ';
 if (isDisabled) { 
__p+=' is-disabled ';
 } 
__p+='\n  ';
 if (!label) { 
__p+=' is-empty ';
 } 
__p+='\n  ';
 if (isNull) { 
__p+=' is-empty ';
 } 
__p+='"\n  tabindex="0">\n  ';
 if (isLoading) { 
__p+='\n    <div class="CDB-LoaderIcon CDB-LoaderIcon--small is-dark">\n      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n      </svg>\n      <span class="u-lSpace u-secondaryTextColor">'+
((__t=( _t('components.backbone-forms.select.loading') ))==null?'':_.escape(__t))+
'</span>\n    </div>\n  ';
 } else { 
__p+='\n    ';
 if (isEmpty) { 
__p+='\n      '+
((__t=( _t('components.backbone-forms.select.empty') ))==null?'':_.escape(__t))+
'\n    ';
 } else { 
__p+='\n      '+
((__t=( placeholder || label || _t('components.backbone-forms.select.placeholder', { keyAttr: keyAttr }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  ';
 } 
__p+='\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],195:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var _ = require('underscore');
var CustomListView = require('../../../custom-list/custom-view');
var CustomListCollection = require('../../../custom-list/custom-list-collection');
var selectedItemTemplate = require('./select-item.tpl');
var CustomListItemView = require('../../../custom-list/custom-list-item-view');
var itemListTemplate = require('../../../custom-list/custom-list-item.tpl');
var template = require('./select.tpl');
var PopupManager = require('../../../popup-manager');

var ENTER_KEY_CODE = 13;

Backbone.Form.editors.Suggest = Backbone.Form.editors.Base.extend({

  tagName: 'div',
  className: 'u-ellipsis Editor-formSelect',

  events: {
    'click .js-button': '_onButtonClick',
    'keydown .js-button': '_onButtonKeyDown',
    'focus .js-button': function () {
      this.trigger('focus', this);
    },
    'blur': function () {
      this.trigger('blur', this);
    }
  },

  options: {
    selectedItemTemplate: selectedItemTemplate,
    itemListTemplate: itemListTemplate,
    customListItemView: CustomListItemView
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    this.template = opts.template || template;
    this.dialogMode = this.options.dialogMode || 'nested';

    this._setupCollection();
    this.setValue(this.model.get(this.options.keyAttr));
    this._initBinds();
  },

  render: function () {
    this.setValue(this.value);

    return this;
  },

  _setupCollection: function () {
    this.collection = new CustomListCollection(this.options.options);

    if (this.options.editorAttrs && this.options.editorAttrs.collectionData) {
      var categories = _.map(this.options.editorAttrs.collectionData, function (d) {
        return { label: d, val: d };
      });

      this.collection.reset(categories);
    }
  },

  _initViews: function () {
    var isLoading = this.options.loading;
    var isEmpty = !this.collection.length;
    var isDisabled = !isEmpty ? this.options.disabled : true;
    var name = this.model.get(this.options.keyAttr);
    var isNull = name === null;
    var label = isNull ? 'null' : name;

    this.$el.html(
      this.template({
        label: label,
        keyAttr: this.options.keyAttr,
        isDisabled: isDisabled,
        isLoading: isLoading,
        isEmpty: isEmpty,
        isNull: isNull,
        placeholder: null
      })
    );

    if (isDisabled) {
      this.undelegateEvents();
    }

    this._listView = new CustomListView({
      collection: this.collection,
      showSearch: this.options.showSearch,
      allowFreeTextInput: this.options.allowFreeTextInput,
      typeLabel: this.options.keyAttr,
      itemTemplate: this.options.itemListTemplate,
      itemView: this.options.customListItemView,
      position: this.options.position,
      searchPlaceholder: null
    });

    this._popupManager = new PopupManager(this.cid, this.$el, this._listView.$el);
    this._popupManager.append(this.dialogMode);
  },

  _initBinds: function () {
    var hide = function () {
      this._listView.hide();
      this._popupManager.untrack();
    }.bind(this);

    this.collection.bind('change:selected', this._onItemSelected, this);
    this.collection.bind('reset', this.render, this);
    this.applyESCBind(hide);
    this.applyClickOutsideBind(hide);
  },

  _onItemSelected: function (mdl) {
    this._listView.hide();
    this._popupManager.untrack();
    this._renderButton(mdl).focus();
    this.trigger('change', this);
  },

  _onButtonClick: function (ev) {
    this._listView.toggle();
    this._listView.isVisible() ? this._popupManager.track() : this._popupManager.untrack();
  },

  _onButtonKeyDown: function (ev) {
    if (ev.which === ENTER_KEY_CODE) {
      ev.preventDefault();
      if (!this._listView.isVisible()) {
        ev.stopPropagation();
        this._listView.toggle();
        this._popupManager.track();
      } else {
        this._popupManager.untrack();
      }
    }
  },

  getValue: function () {
    var item = this.collection.getSelectedItem();

    if (item) {
      return item.getValue();
    }

    return;
  },

  setValue: function (value) {
    var selectedModel = this.collection.setSelected(value);

    if (!selectedModel) {
      this.collection.add({ label: value, val: value });
      selectedModel = this.collection.setSelected(value);
    }

    this._initViews();
    this._renderButton(selectedModel);

    this.value = value;
  },

  _renderButton: function (mdl) {
    var button = this.$('.js-button');
    var name = mdl.getName();
    var isNull = name === null || name === 'null';
    var label = isNull ? 'null' : name;

    var data = _.extend({}, mdl.attributes, { label: label });
    var $html = this.options.selectedItemTemplate(data);

    button
      .html($html)
      .toggleClass('is-empty', isNull);

    return button;
  },

  remove: function () {
    this._popupManager && this._popupManager.destroy();
    this._listView && this._listView.clean();
    Backbone.Form.editors.Base.prototype.remove.call(this);
  },

  clean: function () {
    this._popupManager && this._popupManager.destroy();
  }

});

},{"../../../custom-list/custom-list-collection":47,"../../../custom-list/custom-list-item-view":50,"../../../custom-list/custom-list-item.tpl":52,"../../../custom-list/custom-view":59,"../../../popup-manager":522,"../editor-helpers-extend":92,"./select-item.tpl":189,"./select.tpl":194,"backbone":"backbone","underscore":"underscore"}],196:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var template = require('./slider.tpl');
require('jquery');
require('jquery-ui');

Backbone.Form.editors.Slider = Backbone.Form.editors.Base.extend({

  tagName: 'ul',
  className: 'CDB-OptionInput-container CDB-OptionInput-container--noMargin',

  options: {
    direction: ''
  },

  events: {
    focus: function () {
      this.trigger('focus', this);
    },
    blur: function () {
      this.trigger('blur', this);
    }
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    if (!this.options.labels) {
      throw new Error('labels is required');
    }

    if (this.options.values && this.options.labels.length !== this.options.values.length) {
      throw new Error('values and labels should have the same length');
    }

    this._values = this.options.values;
    this._labels = this.options.labels;

    this._initViews();
  },

  _initViews: function () {
    this.$el.html(
      template({
        direction: this.options.direction
      })
    );

    var step = this._getStepPercentage();
    this._ticks = this._getTicks(step);

    var tickID = this._getInitialTickID();

    this.$('.js-slider').slider({
      range: 'min',
      value: this._ticks[tickID],
      step: step,
      orientation: 'horizontal',
      disabled: this.options.disabled,
      slide: this._onSlideChange.bind(this),
      stop: this._onSlideStop.bind(this)
    });

    this._addTicks(step);
    this._updateUI(tickID);
  },

  _getInitialTickID: function () {
    var value = this.value;

    if (this._values) {
      value = this._values.indexOf(this.value);

      if (value === -1) {
        value = 0;
      }
    } else if (!value) {
      value = 0;
    }

    return value;
  },

  _updateUI: function (tickID) {
    if (tickID === undefined) {
      tickID = 0;
    }

    this._updateLabel(tickID);
    this._highlightTick(tickID);
  },

  _getTickID: function () {
    var v = 0;

    if (this.value && _.isNumber(this.value)) {
      v = this._calculateTickValue(this.value);
    }

    return this._ticks.indexOf(v);
  },

  _addTicks: function (step) {
    _.each(this._ticks, function (amount) {
      $('<div class="UISlider-tick js-tick"></div>')
        .css('left', amount + '%')
        .appendTo(this.$('.js-slider'));
    }, this);
  },

  _highlightTick: function (tickID) {
    this.$('.js-tick').removeClass('is-highlighted');
    $(this.$('.js-tick').get(tickID)).addClass('is-highlighted');
  },

  _updateLabel: function (tickID) {
    this.$('.js-label').text(this._labels[tickID]);
  },

  _getTicks: function (step) {
    var self = this;

    return [0].concat(_(this._labels.length - 1).times(function (n) {
      return self._calculateTickValue(step * (n + 1));
    }));
  },

  _getStepPercentage: function () {
    return (100 / (this._labels.length - 1));
  },

  _calculateTickValue: function (value) {
    return +value.toFixed(2);
  },

  _onSlideChange: function (ev, ui) {
    this.value = ui.value;

    this._updateUI(this._getTickID());
  },

  _onSlideStop: function (ev, ui) {
    this.trigger('change', this);
  },

  _hasSlider: function () {
    return this.$('.js-slider').data('ui-slider');
  },

  getValue: function () {
    var value = this._values ? this._values[this._getTickID()] : this._getTickID();
    return (this.value === '') ? null : value;
  },

  setValue: function (value) {
    this.$('.js-slider').slider('value', value);
    this.value = value;
  },

  _destroySlider: function () {
    if (this._hasSlider()) {
      this.$('.js-slider').slider('destroy');
    }
  },

  remove: function () {
    this._destroySlider();
    Backbone.Form.editors.Base.prototype.remove.apply(this);
  },

  clean: function () {
    this.$el.remove();
  }
});

},{"../editor-helpers-extend":92,"./slider.tpl":197,"backbone":"backbone","jquery":"jquery","jquery-ui":1128,"underscore":"underscore"}],197:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<li class="CDB-OptionInput-item CDB-OptionInput-item--noSeparator">\n  ';
 if (direction === 'desc') { 
__p+='\n  <svg class="UISlider-scale" width="160px" height="7px" viewBox="0 0 160 7" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n      <g fill="#EEEEEE">\n        <path d="M0,3.96972188 C0,2.86143684 0.899814069,1.95171147 1.99402962,1.93799103 L158.00597,-0.0182528125 C159.107243,-0.0320617354 160,0.846465216 160,1.95103649 L160,4.98745286 C160,6.08887023 159.100186,6.96483876 158.00597,6.94427947 L1.99402962,4.012961 C0.89275747,3.99226913 0,3.08692473 0,1.96876746 L0,3.96972188 Z" id="Mask" transform="translate(80.000000, 3.458568) scale(-1, 1) translate(-80.000000, -3.458568) "></path>\n      </g>\n    </g>\n  </svg>\n  ';
 } else if (direction === 'asc') { 
__p+='\n  <svg class="UISlider-scale" width="160px" height="7px" viewBox="0 0 160 7" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n      <g transform="translate(80.000000, 4.000000) rotate(-180.000000) translate(-80.000000, -4.000000) " fill-rule="nonzero" fill="#EEEEEE">\n        <path d="M0,4.96972188 C0,3.86143684 0.899814069,2.95171147 1.99402962,2.93799103 L158.00597,0.981747188 C159.107243,0.967938265 160,1.84646522 160,2.95103649 L160,5.98745286 C160,7.08887023 159.100186,7.96483876 158.00597,7.94427947 L1.99402962,5.012961 C0.89275747,4.99226913 0,4.08692473 0,2.96876746 L0,4.96972188 Z" id="Mask" transform="translate(80.000000, 4.463110) scale(-1, 1) translate(-80.000000, -4.463110) "></path>\n      </g>\n    </g>\n  </svg>\n  ';
 } 
__p+='\n  <div class="UISlider is-standalone ';
 if (direction) { 
__p+='without-line';
 } 
__p+=' js-slider"></div>\n  <span class="UISlider-label js-label"></span>\n</li>\n';
}
return __p;
};

},{"underscore":"underscore"}],198:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
require('jquery-ui');

Backbone.Form.editors.SortableList = Backbone.Form.editors.List.extend({
  initialize: function () {
    Backbone.Form.editors.List.prototype.initialize.apply(this, arguments);
  },

  render: function () {
    Backbone.Form.editors.List.prototype.render.apply(this, arguments);
    this._initSortable();
    return this;
  },

  _initSortable: function () {
    this.$list.sortable({
      axis: 'y',
      items: '.js-sortable',
      tolerance: 'pointer',
      containment: this.$list,
      forceHelperSize: true,
      forcePlaceholderSize: true,
      update: this._onSortableUpdate.bind(this)
    });
  },

  _onSortableUpdate: function (event, ui) {
    var sorted = [];
    _.each(this.items, function (item) {
      var index = item.$el.index(this.$list);
      sorted[index] = item;
    });

    this.items = sorted;
    this.commit();
  }
});

},{"backbone":"backbone","jquery-ui":1128,"underscore":"underscore"}],199:[function(require,module,exports){
var Backbone = require('backbone');

module.exports = Backbone.Collection.extend({
  removeTag: function (label) {
    var m = this.findWhere({label: label});
    m && this.remove(m);
  },

  addTag: function (label) {
    var m = this.findWhere({label: label});
    !m && this.add({label: label});
  },

  getValue: function () {
    return this.map(function (mdl) {
      return mdl.get('label');
    });
  }
});

},{"backbone":"backbone"}],200:[function(require,module,exports){
var CoreView = require('backbone/core-view');

module.exports = CoreView.extend({
  tagName: 'li',

  initialize: function (opts) {
    if (!opts.label) throw new Error('label is required');
    this._label = opts.label;
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(this._label);
    return this;
  }
});

},{"backbone/core-view":1127}],201:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var template = require('./taglist.tpl');
var TagView = require('./taglist-item-view');
var TagCollection = require('./taglist-collection');
var EditorHelpers = require('../editor-helpers-extend');

require('jquery');
require('jquery-ui');
require('tagit');

Backbone.Form.editors.Taglist = Backbone.Form.editors.Base.extend({
  className: 'Form-tags CDB-Text',
  events: {
    'mouseover': '_onMouseOver',
    'mouseout': '_onMouseOut'
  },
  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    this._tagCollection = new TagCollection(this._normalize(opts.schema.options.tags));

    this.isEditable = opts.schema.options.isEditable || opts.schema.options.isEditable === undefined;
  },

  render: function () {
    this._initViews();
    return this;
  },

  _initViews: function () {
    var self = this;
    var tagsPlaceholder = (!this.isEditable && this._tagCollection.length === 0)
                          ? _t('components.taglist.none')
                          : _t('components.taglist.placeholder');

    this.$el.html(template());

    this._tagCollection.each(this._renderTag, this);

    this.$('.js-tagsList').tagit({
      allowSpaces: true,
      caseSensitive: false,
      placeholderText: tagsPlaceholder,
      readOnly: !this.isEditable,
      onBlur: function () {
        self.isEditable && self.$el.removeClass('is-focus');
        self.trigger('blur', self);
      },
      onFocus: function () {
        self.isEditable && self.$el.removeClass('is-hover').addClass('is-focus');
        self.trigger('focus', self);
      },
      afterTagAdded: self._onTagAdded.bind(self),
      afterTagRemoved: self._onTagRemoved.bind(self)
    });
  },

  _renderTag: function (model) {
    var view = new TagView({
      label: model.get('label')
    });

    this.$('.js-tagsList').append(view.render().el);
  },

  focus: function () {
    if (this.hasFocus) return;
    this.$el.focus();
  },

  blur: function () {
    if (!this.hasFocus) return;
    this.$el.blur();
  },

  getValue: function () {
    return this._tagCollection.getValue();
  },

  setValue: function (tags) {
    this._tagCollection.reset(this._normalize(tags));
    this._destroyTagit();
    this.render();
    this.trigger('change', this);
  },

  _onMouseOver: function () {
    !this.$el.hasClass('is-focus') && this.$el.addClass('is-hover');
  },

  _onMouseOut: function () {
    !this.$el.hasClass('is-focus') && this.$el.removeClass('is-hover');
  },

  _onTagRemoved: function (e, ui) {
    var tag = ui.tag.find('.tagit-label').text();
    this._tagCollection.removeTag(tag);
    this.trigger('change', this);
  },

  _onTagAdded: function (e, ui) {
    var tag = ui.tag.find('.tagit-label').text();
    this._tagCollection.addTag(tag);
    this.trigger('change', this);
  },

  _normalize: function (tags) {
    return _.map(tags, function (tag) {
      return {
        label: tag.trim()
      };
    });
  },

  _destroyTagit: function () {
    // cannot call public methods before initilization
    // checking ui-widget class does the trick
    (this.$('.ui-widget').length > 0) && this.$('.js-tagsList').tagit('destroy');
  },

  remove: function () {
    this._destroyTagit();
    Backbone.Form.editors.Base.prototype.remove.apply(this);
  },

  clean: function () {
    this.$el.remove();
  }
});

},{"../editor-helpers-extend":92,"./taglist-collection":199,"./taglist-item-view":200,"./taglist.tpl":202,"backbone":"backbone","jquery":"jquery","jquery-ui":1128,"tagit":1138,"underscore":"underscore"}],202:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="Form-tagsList js-tagsList"></ul>';
}
return __p;
};

},{"underscore":"underscore"}],203:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var EditorHelpers = require('./editor-helpers-extend');

Backbone.Form.editors.Text = Backbone.Form.editors.Text.extend({
  className: 'CDB-InputText CDB-Text',

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    var schema = this.schema;

    // Allow customising text type (email, phone etc.) for HTML5 browsers
    var type = 'text';

    if (schema && schema.editorAttrs && schema.editorAttrs.type) type = schema.editorAttrs.type;
    if (schema && schema.dataType) type = schema.dataType;

    this.$el.attr('type', type);

    this.determineChange = _.debounce(this.determineChange, 200);
  },

  render: function () {
    this.setValue(this.value);
    this._toggleDisableState();

    if (this._isCopyButtonEnabled()) {
      this._toggleClipboardState();
    }

    return this;
  },

  getValue: function () {
    var val = this.$el.val();

    return (val === '') ? null : val;
  },

  _toggleClipboardState: function () {
    this.$el.toggleClass('Share-input-field u-ellipsis', this._isCopyButtonEnabled());
  },

  _togglePlaceholder: function () {
    if (this.options.placeholder) {
      this.$el.attr('placeholder', this.options.placeholder);
    } else {
      var placeholder = (this.value === null) ? 'null' : '';
      this.$el.attr('placeholder', placeholder);
    }
  },

  _toggleDisableState: function () {
    if (this.options.disabled) {
      this.$el.attr('readonly', '');
      this.$el.attr('placeholder', '');

      // if it's disabled AND has copy, leave just readonly
      if (this._isCopyButtonEnabled()) {
        this.$el.removeAttr('disabled');
      }
    } else {
      this.$el.removeAttr('readonly');
      this._togglePlaceholder();
    }

    this.$el.toggleClass('is-disabled', !!this.options.disabled);
  },

  _isCopyButtonEnabled: function () {
    return !!this.options.hasCopyButton;
  }
});

},{"./editor-helpers-extend":92,"backbone":"backbone","underscore":"underscore"}],204:[function(require,module,exports){
var Backbone = require('backbone');

Backbone.Form.editors.TextArea = Backbone.Form.editors.Text.extend({
  tagName: 'textarea',
  className: 'CDB-Textarea',

  render: function () {
    this.setValue(this.value);
    this._toggleDisableState();

    return this;
  },

  getValue: function () {
    var val = this.$el.val();

    return (val === '') ? null : val;
  },

  _toggleDisableState: function () {
    if (this.options.disabled) {
      this.$el.attr('readonly', '');
      this.$el.attr('placeholder', '');
    } else {
      this.$el.removeAttr('readonly');
      this._togglePlaceholder();
    }

    this.$el.toggleClass('is-disabled', !!this.options.disabled);
  }
});

},{"backbone":"backbone"}],205:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var template = require('./toggle.tpl');

Backbone.Form.editors.Toggle = Backbone.Form.editors.Radio.extend({
  className: 'Editor-formLabel CDB-Text CDB-Size-medium u-alignCenter',

  _arrayToHtml: function (array) {
    var name = this.getName();
    var id = this.id;

    var items = _.map(array, function (option, index) {
      var val = this.form.model.get(this.key);
      var item = {
        name: name,
        id: id + '-' + index
      };

      if (_.isObject(option)) {
        item.value = (option.val || option.val === 0) ? option.val : '';
        item.label = option.label;
        item.help = option.help;
        item.labelHTML = option.labelHTML;
        item.selected = (val !== void 0) ? val === option.val : option.selected;
      } else {
        item.value = option;
        item.label = option;
        item.selected = (val !== void 0) ? val === option : option.selected;
      }

      return item;
    }.bind(this));

    return template({ items: items });
  }
});

},{"./toggle.tpl":206,"backbone":"backbone","underscore":"underscore"}],206:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 _.each(items, function(item, index) { 
__p+='\n  ';
 if (item.selected) { 
__p+='\n    <li class="u-tSpace">\n      <input type="radio" class="Editor-toggleRadio" name="'+
((__t=( item.name ))==null?'':__t)+
'" value="'+
((__t=( item.value ))==null?'':_.escape(__t))+
'" id="'+
((__t=( item.id ))==null?'':__t)+
'" checked="checked" />\n      ';
 if (item.help) { 
__p+='<p class="Editor-toggleHelp CDB-Text CDB-Size-small u-altTextColor">'+
((__t=( item.help ))==null?'':__t)+
'</p>';
 } 
__p+='\n    </li>\n  ';
 } else { 
__p+='\n    <li class="u-tSpace u-txt-right">\n      <input type="radio" name="'+
((__t=( item.name ))==null?'':__t)+
'" value="'+
((__t=( item.value ))==null?'':_.escape(__t))+
'" id="'+
((__t=( item.id ))==null?'':__t)+
'" />\n      <label class="u-upperCase u-actionTextColor CDB-Text is-semibold CDB-Size-small u-iBlock" for="'+
((__t=( item.id ))==null?'':__t)+
'">';
 if (item.labelHTML){ 
__p+=''+
((__t=( item.labelHTML ))==null?'':__t)+
'';
 }else{ 
__p+=''+
((__t=( item.label ))==null?'':_.escape(__t))+
'';
 } 
__p+='</label>\n    </li>\n  ';
 } 
__p+='\n';
 }); 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],207:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var $ = require('jquery');
var TipsyTooltipView = require('../tipsy-tooltip-view.js');
var Clipboard = require('clipboard');

Backbone.Form.Field = Backbone.Form.Field.extend({

  initialize: function (options) {
    this.trackingClass = options.trackingClass;
    this.constructor.__super__.initialize.apply(this, arguments);
  },

  render: function () {
    this.constructor.__super__.render.apply(this, arguments);
    if (this.schema.help) {
      this._setHelp();
    }
    if (this._isCopyButtonEnabled()) {
      this._initClipboard();
    }
    return this;
  },

  /**
  * OVERWRITTEN the creation of the full field schema, merging defaults etc.
  *
  * @param {Object|String} schema
  *
  * @return {Object}
  */
  createSchema: function (schema) {
    var editorType = schema.type;
    schema = this.constructor.__super__.createSchema.apply(this, arguments);
    schema.editorType = editorType;
    return schema;
  },

  /**
   * OVERWRITTEN the creation of the editor specified in the schema; either an
   * editor string name or a constructor function
   *
   * @return {View}
   */
  createEditor: function () {
    var options = _.extend(
      _.pick(this, 'schema', 'form', 'key', 'model', 'value', 'trackingClass'),
      { id: this.createEditorId() }
    );

    var ConstructorFn = this.schema.type;

    return new ConstructorFn(options);
  },

  _setHelp: function () {
    this._helpTooltip = this._createTooltip({
      $el: this.$('.js-help')
    });
  },

  // Changed original setError function in order to add
  // the error tooltip
  setError: function (msg) {
    if (this.editor.hasNestedForm) return;
    this.$el.addClass(this.errorClassName);
    this._destroyErrorTooltip();
    this._errorTooltip = this._createTooltip({
      gravity: 'w',
      className: 'is-error',
      msg: msg,
      offset: 5
    });
    this._errorTooltip.showTipsy();
  },

  // Changed original clearError function in order to remove
  // the error tooltip
  clearError: function () {
    this.$el.removeClass(this.errorClassName);
    this._destroyErrorTooltip();
  },

  _initClipboard: function () {
    if (this._clipboard) {
      this._clipboard.destroy();
    }

    var btn = this.$('.js-copy');
    this._clipboard = new Clipboard(btn.get(0));
  },

  _createTooltip: function (opts) {
    return new TipsyTooltipView({
      el: opts.$el || this.$el,
      gravity: opts.gravity || 's',
      className: opts.className || '',
      offset: opts.offset || 0,
      title: function () {
        return opts.msg || $(this).data('tooltip');
      }
    });
  },

  _destroyErrorTooltip: function () {
    if (this._errorTooltip) {
      this._errorTooltip.hideTipsy();
      this._errorTooltip.destroyTipsy();
    }
  },

  _destroyHelpTooltip: function () {
    if (this._helpTooltip) {
      this._helpTooltip.destroyTipsy();
    }
  },

  _destroyClipboard: function () {
    if (this._clipboard) {
      this._clipboard.destroy();
    }
  },

  // Changed original templateData function in order to add a
  // new template attribute (hasNestedForm)
  templateData: function () {
    var schema = this.schema;
    var type;

    try {
      type = this.form.schema[this.key].type;
    } catch (e) {
      type = undefined;
    }

    return {
      help: schema.help || '',
      isCopyButtonEnabled: this._isCopyButtonEnabled(),
      hasNestedForm: this.editor.hasNestedForm,
      title: schema.title,
      fieldAttrs: schema.fieldAttrs,
      editorAttrs: schema.editorAttrs,
      key: this.key,
      type: type,
      editorId: this.editor.id,
      editorType: this.editor.el.type
    };
  },

  _isCopyButtonEnabled: function () {
    return !!this.schema.hasCopyButton;
  },

  remove: function () {
    this._destroyErrorTooltip();
    this._destroyHelpTooltip();
    this._destroyClipboard();
    this.editor.remove();
    Backbone.View.prototype.remove.call(this);
  }

}, {
  template: require('./field.tpl'),
  errorClassName: 'CDB-FieldError'
});

},{"../tipsy-tooltip-view.js":589,"./field.tpl":208,"backbone":"backbone","clipboard":"clipboard","jquery":"jquery","underscore":"underscore"}],208:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Text Editor-formInner';
 if (type){ 
__p+=' Editor-formInner--'+
((__t=( type ))==null?'':_.escape(__t))+
'';
 } 
__p+='">\n  ';
 if (title) { 
__p+='\n    <label class="CDB-Legend ';
 if (editorType){ 
__p+=' CDB-Legend--'+
((__t=( editorType ))==null?'':_.escape(__t))+
'';
 } 
__p+=' u-upperCase CDB-Text is-semibold CDB-Size-small u-rSpace--m" for="'+
((__t=( editorId ))==null?'':_.escape(__t))+
'" title="'+
((__t=( title ))==null?'':_.escape(__t))+
'">\n      <div class="u-ellipsis ';
 if (help) { 
__p+='Editor-formHelp';
 } 
__p+='">\n        <span class="';
 if (help) { 
__p+=' js-help is-underlined';
 } 
__p+='" ';
 if (help) { 
__p+=' data-tooltip="'+
((__t=( help ))==null?'':_.escape(__t))+
'"';
 } 
__p+=' >'+
((__t=( title ))==null?'':_.escape(__t))+
'</span>\n      </div>\n    </label>\n  ';
 } 
__p+='\n  <div class="Editor-formInput u-flex u-alignCenter" data-editor>\n    ';
 if (isCopyButtonEnabled) { 
__p+='\n      <button type="button" class="Share-copy CDB-Button CDB-Button--small js-copy" data-clipboard-target="#'+
((__t=( editorId ))==null?'':_.escape(__t))+
'">\n        <span class="CDB-Button-Text CDB-Text CDB-Size-small u-actionTextColor">'+
((__t=( _t('components.backbone-forms.copy-button') ))==null?'':_.escape(__t))+
'</span>\n      </button>\n    ';
 } 
__p+='\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],209:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

// overwirte template in order to be able to use flex
/*eslint-disable */
Backbone.Form.Fieldset.template = _.template('\
  <div class="Editor-fieldset" data-fields>\
    <% if (legend) { %>\
      <legend><%= legend %></legend>\
    <% } %>\
  </div>\
');
/*eslint-enable */

},{"backbone":"backbone","underscore":"underscore"}],210:[function(require,module,exports){
var Backbone = require('backbone');

Backbone.Form = Backbone.Form.extend({

  initialize: function (options) {
    this.options = options;
    this.constructor.__super__.initialize.apply(this, arguments);
  },

  createField: function (key, schema) {
    var options = {
      form: this,
      key: key,
      schema: schema,
      idPrefix: this.idPrefix,
      trackingClass: this.options.trackingClass
    };

    if (this.model) {
      options.model = this.model;
    } else if (this.data) {
      options.value = this.data[key];
    } else {
      options.value = undefined;
    }

    var field = new this.Field(options);

    this.listenTo(field.editor, 'all', this.handleEditorEvent);

    return field;
  }

});

},{"backbone":"backbone"}],211:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var Backbone = require('backbone');
require('backbone-forms');
Backbone.$ = $;

// Custom validators
_.extend(
  Backbone.Form.validators,
  {
    interval: require('./validators/interval.js')
  }
);

// Requiring custom form components
require('./form.js');
require('./fieldset-template.js');
require('./field.js');
require('./editors/base.js');
require('./editors/text.js');
require('./editors/textarea.js');
require('./editors/number/number.js');
require('./editors/select/select-view.js');
require('./editors/select/multi-select-view.js');
require('./editors/radio/radio.js');
require('./editors/enabler/enabler-view.js');
require('./editors/toggle/toggle.js');
require('./editors/enabler-editor/enabler-editor-view.js');
require('./editors/node-dataset/node-dataset-view.js');
require('./editors/operators/operators-view.js');
require('./editors/list/list.js');
require('./editors/list/list-item.js');
require('./editors/sortable-list.js');
require('./editors/legend/category-item.js');
require('./editors/slider/slider.js');
require('./editors/fill/fill.js');
require('./editors/taglist/taglist.js');
require('./editors/datetime/datetime.js');
require('./editors/select/suggest-view.js');
require('./editors/data-observatory/dropdown-view.js');
require('./editors/code-editor');

},{"./editors/base.js":69,"./editors/code-editor":70,"./editors/data-observatory/dropdown-view.js":73,"./editors/datetime/datetime.js":90,"./editors/enabler-editor/enabler-editor-view.js":93,"./editors/enabler/enabler-view.js":96,"./editors/fill/fill.js":108,"./editors/legend/category-item.js":170,"./editors/list/list-item.js":171,"./editors/list/list.js":172,"./editors/node-dataset/node-dataset-view.js":176,"./editors/number/number.js":177,"./editors/operators/operators-view.js":184,"./editors/radio/radio.js":186,"./editors/select/multi-select-view.js":188,"./editors/select/select-view.js":193,"./editors/select/suggest-view.js":195,"./editors/slider/slider.js":196,"./editors/sortable-list.js":198,"./editors/taglist/taglist.js":201,"./editors/text.js":203,"./editors/textarea.js":204,"./editors/toggle/toggle.js":205,"./field.js":207,"./fieldset-template.js":209,"./form.js":210,"./validators/interval.js":212,"backbone":"backbone","backbone-forms":"backbone-forms","jquery":"jquery","underscore":"underscore"}],212:[function(require,module,exports){
module.exports = function (opts) {
  // get the min value
  var minValue = parseFloat(opts.min) || 0;
  var maxValue = parseFloat(opts.max) || 0;
  var err = {
    type: opts.type,
    message: _t('components.backbone-forms.interval-error', { minValue: opts.min, maxValue: opts.max })
  };
  return function interval (value, attrs) {
    var fieldValue = 0;

    if (value === null || value === undefined || value === '') return err;

    // check if the value is number
    if (!isNaN(parseFloat(value)) && isFinite(value)) {
      fieldValue = parseFloat(value);
    }
    if (minValue > fieldValue || maxValue < fieldValue) {
      return err;
    }
    return;
  };
};

},{}],213:[function(require,module,exports){
var $ = require('jquery');
var CoreView = require('backbone/core-view');
var utils = require('../helpers/utils');
var _ = require('underscore');

var IMAGE_DIM = 18;
var IMAGE_FILE_ATTRS = {
  width: '18px',
  height: '18px'
};

var VIEWBOX = _.template('0 0 <%- w %> <%- h %>');
module.exports = CoreView.extend({
  initialize: function (opts) {
    if (!opts.imageClass) { throw new Error('Image class is mandatory.'); }

    this._imageClass = opts.imageClass;
    this._imageURL = opts.imageUrl;
    this._color = opts.color;

    this._lastImage = {
      url: null,
      content: null
    };
  },

  render: function () {
    this.$el.empty();

    this._loadImage();

    return this;
  },

  _loadImage: function () {
    if (!this._imageURL) { // the URL could be null or undefined
      return;
    }

    var self = this;

    if (this._isSVG(this._imageURL)) {
      this._loadSVG();
    } else {
      var $img = $('<img crossorigin="anonymous"/>');
      $img.attr('class', self._imageClass + ' js-image');
      $img.attr('src', this._imageURL + '?req=markup');

      for (var attribute in IMAGE_FILE_ATTRS) {
        $img.attr(attribute, IMAGE_FILE_ATTRS[attribute]);
      }

      this.$el.append($img);
    }
  },

  _loadSVG: function () {
    var self = this;

    this._requestImageURL(this._imageURL, function (content) {
      var svg = content.cloneNode(true);
      var $svg = $(svg);
      $svg = $svg.removeAttr('xmlns:a');
      $svg.attr('class', self._imageClass + ' js-image');

      var bbox = {
        w: IMAGE_DIM,
        h: IMAGE_DIM
      };

      if (!$svg.attr('viewBox')) {
        if ($svg.attr('height') && $svg.attr('width')) {
          bbox = {
            w: svg.width.baseVal.value,
            h: svg.height.baseVal.value
          };
        }

        $svg.attr('viewBox', VIEWBOX(bbox));
      }

      for (var attribute in IMAGE_FILE_ATTRS) {
        $svg.attr(attribute, IMAGE_FILE_ATTRS[attribute]);
      }

      self.$el.append($svg);

      $svg.css('fill', self._color);
      $svg.find('g').css('fill', 'inherit');
      $svg.find('path').css('fill', 'inherit');
    });
  },

  _requestImageURL: function (url, callback) {
    var self = this;
    var completeUrl = url + '?req=ajax';

    if (this._lastImage.url === completeUrl) {
      callback && callback(this._lastImage.content);
    } else {
      $.ajax(completeUrl)
      .done(function (data) {
        self._lastImage.url = completeUrl;
        var content = self._lastImage.content = data.getElementsByTagName('svg')[0];
        callback && callback(content);
      })
      .fail(function () {
        throw new Error("Couldn't get " + completeUrl + ' file.');
      });
    }
  },

  updateImageColor: function (color) {
    this.$('.js-image').css('fill', color);
  },

  _isSVG: function (url) {
    if (!url) {
      return false;
    }
    var noQueryString = url.split('?')[0];
    return noQueryString && utils.endsWith(noQueryString.toUpperCase(), 'SVG');
  }
});

},{"../helpers/utils":1102,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],214:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (type === 'primary') { 
__p+='\n  <button class="CDB-Button CDB-Button--primary CDB-Button--medium ';
 if (disabled) { 
__p+='is-disabled';
 } 
__p+=' js-'+
((__t=( action ))==null?'':_.escape(__t))+
' js-action">\n    <span class="CDB-Button-Text CDB-Text is-semibold u-upperCase CDB-Size-small">'+
((__t=( label ))==null?'':__t)+
'</span>\n  </button>\n';
 } else { 
__p+='\n  <button class="Infobox-buttonLink u-upperCase ';
 if (disabled) { 
__p+='is-disabled';
 } 
__p+=' js-'+
((__t=( action ))==null?'':_.escape(__t))+
' js-action CDB-Text is-semibold CDB-Size-small">\n    '+
((__t=( label ))==null?'':__t)+
'\n  </button>\n';
 } 
__p+='';
}
return __p;
};

},{"underscore":"underscore"}],215:[function(require,module,exports){
var Backbone = require('backbone');
var InfoboxModel = require('./infobox-item-model');
var _ = require('underscore');

/*
 *  Infobox states collection
 */

module.exports = Backbone.Collection.extend({
  model: InfoboxModel,

  initialize: function () {
    this._initBinds();
  },

  reset: function (models, options) {
    this._defaultSelected(models);
    Backbone.Collection.prototype.reset.call(this, models, options);
  },

  _initBinds: function () {
    this.on('change:selected', this._onSelectedChange, this);
    this.on('reset', this._defaultSelected, this);
  },

  _defaultSelected: function (models) {
    var selected = _.first(_.where(models, {selected: true}));
    if (!selected) {
      selected = _.first(models);
      if (this._isModel(selected)) {
        selected.set({selected: true}, {silent: true});
      } else {
        selected.selected = true;
      }
    }
  },

  _onSelectedChange: function (changedModel, isSelected) {
    if (isSelected) {
      this.each(function (m) {
        if (m.cid !== changedModel.cid) {
          m.set({selected: false}, {silent: true});
        }
      });
    }
  },

  getState: function (state) {
    return _.first(this.where({state: state}));
  },

  getSelected: function () {
    var selected;
    selected = _.first(this.where({selected: true}));
    return selected;
  },

  setSelected: function (state) {
    var selectedModel;

    this.each(function (mdl) {
      if (mdl.get('state') === state) {
        mdl.set({selected: true}, {silent: true});
        selectedModel = mdl;
      } else {
        mdl.set({selected: false}, {silent: true});
      }
    });

    return selectedModel;
  }

});

},{"./infobox-item-model":217,"backbone":"backbone","underscore":"underscore"}],216:[function(require,module,exports){
var InfoboxView = require('./infobox-item-view');

module.exports = {
  // Infobox with no buttons, only message
  createInfo: function (opts) {
    var closable = opts.closable === undefined ? true : opts.closable;
    return new InfoboxView({
      type: opts.type || 'default',
      title: opts.title,
      body: opts.body,
      closable: closable
    });
  },

  createWithAction: function (opts) {
    var closable = opts.closable === undefined ? true : opts.closable;
    var options = {
      type: opts.type || 'default',
      title: opts.title,
      body: opts.body,
      closable: closable
    };

    if (opts.mainAction) {
      options.mainAction = {
        label: opts.mainAction.label,
        type: opts.mainAction.type
      };
    }

    if (opts.secondAction) {
      options.secondAction = {
        label: opts.secondAction.label,
        type: opts.secondAction.type
      };
    }

    return new InfoboxView(options);
  },

  createLoading: function (opts) {
    return new InfoboxView({
      type: opts.type || 'default',
      title: opts.title || '',
      body: opts.body,
      loading: true
    });
  },

  createQuota: function (opts) {
    if (opts.closable === undefined) {
      opts.closable = true;
    }

    return new InfoboxView(opts);
  }
};

},{"./infobox-item-view":218}],217:[function(require,module,exports){
var Backbone = require('backbone');

/*
 *  Infobox item model
 *
 */

module.exports = Backbone.Model.extend({
  defaults: {
    selected: false
  }
});

},{"backbone":"backbone"}],218:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var template = require('./infobox.tpl');
var templateButton = require('./infobox-button.tpl');
var templateQuota = require('./infobox-quota.tpl');

var INFOBOX_TYPE = {
  error: 'is-error',
  alert: 'is-alert',
  code: 'is-dark',
  success: 'is-success',
  default: ''
};

module.exports = CoreView.extend({
  events: {
    'click .js-mainAction': '_onMainClick',
    'click .js-secondAction': '_onSecondClick',
    'click .js-close': '_onClose'
  },

  initialize: function (opts) {
    if (opts.title === undefined) throw new Error('Title is required');
    if (opts.body === undefined) throw new Error('Body is required');

    this._title = opts.title;
    this._body = opts.body;
    this._loading = opts.loading;
    this._isClosable = opts.closable;

    if (opts.quota) {
      this._quota = opts.quota;
    }

    if (opts.mainAction) {
      this._mainLabel = opts.mainAction.label;
      this._mainType = opts.mainAction.type;
      this._mainDisabled = opts.mainAction.disabled;
    }

    if (opts.secondAction) {
      this._secondLabel = opts.secondAction.label;
      this._secondType = opts.secondAction.type;
      this._secondDisabled = opts.secondAction.disabled;
    }

    this._type = INFOBOX_TYPE[opts.type || 'default'];
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initViews: function () {
    var hasButtons = this._mainLabel || this._secondLabel;
    var hasQuota = !_.isEmpty(this._quota);
    var isLoading = this._loading;

    var view = template({
      title: this._title,
      body: this._body,
      type: this._type,
      isLoading: isLoading,
      hasQuota: hasQuota,
      hasButtons: hasButtons,
      isClosable: this._isClosable
    });

    this.setElement(view);

    if (this._mainLabel) {
      this.$('.js-leftPosition').html(templateButton({
        action: 'mainAction',
        label: this._mainLabel,
        type: this._mainType,
        disabled: this._mainDisabled
      }));
    }

    if (this._secondLabel) {
      this.$('.js-rightPosition').html(templateButton({
        action: 'secondAction',
        label: this._secondLabel,
        type: this._secondType,
        disabled: this._secondDisabled
      }));
    }

    if (hasQuota) {
      var quota = this._quota;
      var quotaPer = ((quota.usedQuota / quota.totalQuota) * 100);
      if (isNaN(quotaPer)) {
        quotaPer = 100;
      }
      var progressState = 'fine';
      if (quotaPer > 75 && quotaPer < 90) {
        progressState = 'alert';
      } else if (quotaPer >= 90) {
        progressState = 'caution';
      }

      this.$('.js-quota').html(templateQuota({
        quotaMessage: quota.quotaMessage || '',
        progressState: progressState,
        quotaPer: quotaPer
      }));
    }
  },

  _onMainClick: function (e) {
    this.trigger('action:main');
  },

  _onSecondClick: function (e) {
    this.trigger('action:second');
  },

  _onClose: function (e) {
    this.trigger('action:close');
  }
});

},{"./infobox-button.tpl":214,"./infobox-quota.tpl":220,"./infobox.tpl":222,"backbone/core-view":1127,"underscore":"underscore"}],219:[function(require,module,exports){
var Backbone = require('backbone');
var INFOBOX_DEFAULT_STATE = '';

/**
 * View model of a infobox
 *
 */

module.exports = Backbone.Model.extend({

  defaults: {
    state: INFOBOX_DEFAULT_STATE
  }

});

},{"backbone":"backbone"}],220:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<label class="CDB-Text CDB-Size CDB-Size-small u-secondaryTextColor">'+
((__t=( quotaMessage ))==null?'':_.escape(__t))+
'</label>\n<div class="Infobox-quotaBar Progress u-tSpace">\n  <div class="Infobox-quotaBarProgress Progress-bar Progress-bar--'+
((__t=( progressState ))==null?'':_.escape(__t))+
'"\n    style="width: '+
((__t=( quotaPer ))==null?'':_.escape(__t))+
'%"\n  ></div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],221:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var checkAndBuildOpts = require('../../helpers/required-opts');

var REQUIRED_OPTS = [
  'infoboxModel',
  'infoboxCollection'
];

module.exports = CoreView.extend({

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._initBinds();
    this._setSelectedModel();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this.listenTo(this._infoboxModel, 'change:state', this._onChangeState);
    this.listenTo(this._infoboxModel, 'change:visible', this.render);
  },

  _initViews: function () {
    var createContentView;

    if (this._selectedModel) {
      createContentView = this._selectedModel.get('createContentView');
      this.infoboxView = createContentView();
      this.$el.append(this.infoboxView.render().el);
      this.addView(this.infoboxView);
      this._initSubviewBinds();
    }
  },

  _setSelectedModel: function () {
    var state = this._infoboxModel.get('state');
    this._selectedModel = this._infoboxCollection.setSelected(state);
  },

  _onChangeState: function () {
    this._setSelectedModel();
    this.render();
  },

  _initSubviewBinds: function () {
    this.listenTo(this.infoboxView, 'action:main', this._onMainAction);
    this.listenTo(this.infoboxView, 'action:second', this._onSecondAction);
    this.listenTo(this.infoboxView, 'action:close', this._onClose);
  },

  _onMainAction: function () {
    var action = this._selectedModel.get('mainAction');
    action && action();
  },

  _onSecondAction: function () {
    var action = this._selectedModel.get('secondAction');
    action && action();
  },

  _onClose: function () {
    var action = this._selectedModel.get('closeAction');
    if (action) {
      action();
    } else {
      // if no action associated, we still need to hide the infobox
      this._infoboxModel.set('state', null);
    }
  }
});

},{"../../helpers/required-opts":1097,"backbone/core-view":1127}],222:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Infobox '+
((__t=( type ))==null?'':_.escape(__t))+
'">\n  <div class="u-flex u-justifySpace u-alignCenter u-bSpace--m">\n    <h2 class="CDB-Text is-semibold CDB-Size-small u-upperCase">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h2>\n\n    ';
 if (isClosable) { 
__p+='\n    <button class="CDB-Shape js-close">\n      <div class="CDB-Shape-close is-large js-theme is-blue"></div>\n    </button>\n    ';
 } 
__p+='\n  </div>\n\n  <div class="CDB-Text CDB-Size-medium u-bSpace--xl u-flex">\n    ';
 if (isLoading) { 
__p+='\n      <div class="CDB-LoaderIcon is-dark u-rSpace--m">\n        <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n          <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n        </svg>\n      </div>\n    ';
 } 
__p+='\n    <div>\n      '+
((__t=( body ))==null?'':__t)+
'\n    </div>\n  </div>\n\n  <div class="u-flex u-justifySpace u-alignCenter">\n    ';
 if (hasQuota) { 
__p+='\n      <div class="Infobox-quota js-quota"></div>\n    ';
 } 
__p+='\n    ';
 if (hasButtons) { 
__p+='\n      <ul class="Infobox-buttons ';
 if (hasQuota) { 
__p+='Infobox-buttons--quota';
 } 
__p+='">\n        <li class="Infobox-button js-leftPosition"></li>\n        <li class="Infobox-button Infobox-button--right js-rightPosition"></li>\n      </ul>\n    ';
 } 
__p+='\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],223:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var utils = require('../../helpers/utils');

var REQUIRED_OPTS = [
  'template',
  'onEdit',
  'renderOptions'
];

var DBLCLICK_TIMEOUT = 200;
var clicks = 0;
var ESCAPE_KEY_CODE = 27;
var ENTER_KEY_CODE = 13;

module.exports = CoreView.extend({
  events: {
    'blur .js-input': 'hide',
    'keyup .js-input': '_onKeyUpInput'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this._onClickHandler = this._onClickHandler.bind(this);
    this.edit = this.edit.bind(this);

    this._timeout = opts.timeout || DBLCLICK_TIMEOUT;
  },

  render: function () {
    this._unbindEvents();
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    this._initBinds();
    return this;
  },

  _initBinds: function () {
    if (this.options.onClick) {
      this._onClick = this.options.onClick;
      this._title().on('click', this._onClickHandler);
    } else {
      this._title().on('dblclick', this.edit);
    }
  },

  _unbindEvents: function () {
    var $title = this._title();
    $title && $title.off('click dblclick');
  },

  _onClickHandler: function (e) {
    var self = this;
    clicks++;
    if (clicks === 1) {
      setTimeout(function () {
        if (clicks === 1) {
          self._onClick && self._onClick(e);
        } else {
          self.edit();
        }
        clicks = 0;
      }, this._timeout);
    }
  },

  _initViews: function () {
    this.$el.append(this._template(this._renderOptions));
    this.setElement(this.$('.Inline-editor'));
  },

  edit: function () {
    this.$('.js-input').prop('readonly', false).show().focus();
    this.$('.js-input').get(0).setSelectionRange(0, this.$('.js-input').val().length);
  },

  getValue: function () {
    var inputValue = this.$('.js-input').val();
    return utils.sanitizeHtml(inputValue);
  },

  _title: function () {
    return this.$('.js-title');
  },

  hide: function () {
    this.$('.js-input').prop('readonly', true).hide();
  },

  clean: function () {
    this._unbindEvents();
    CoreView.prototype.clean.call(this);
  },

  _onKeyUpInput: function (e) {
    if (e.which === ESCAPE_KEY_CODE) {
      this.hide();
    }

    if (e.which === ENTER_KEY_CODE) {
      this._onEdit && this._onEdit(this.getValue());
    }
  }
});

},{"../../helpers/utils":1102,"backbone/core-view":1127,"underscore":"underscore"}],224:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

var LikeModel = Backbone.Model.extend({
  defaults: {
    likeable: true
  },

  url: function (method) {
    var version = this._configModel.urlVersion('like');
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/' + version + '/viz/' + this.get('vis_id') + '/like';
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    if (!attrs.vis_id) throw new Error('vis_id attribute is required');
    this._configModel = opts.configModel;

    this.on('destroy', function () {
      this.set({
        liked: false,
        likes: this.get('likes') - 1
      });
    }, this);
  },

  _onSaveError: function (model, response) {
    this.trigger('error', {
      status: response.status,
      statusText: response.statusText
    });
  },

  toggleLiked: function () {
    if (this.get('liked')) {
      this.destroy();
    } else {
      this.set({ id: null }, { silent: true });
      this.save({}, {
        error: this._onSaveError.bind(this)
      });
    }
  }

}, {
  newByVisData: function (opts) {
    var d = _.defaults({
      id: opts.liked ? opts.vis_id : null
    }, _.omit(opts, 'url', 'configModel'));

    var m = new LikeModel(d, {
      configModel: opts.configModel
    });

    if (opts.url) {
      m.url = opts.url;
    }

    return m;
  }
});

module.exports = LikeModel;

},{"backbone":"backbone","underscore":"underscore"}],225:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./likes.tpl');

/**
 * Responsible for likes (♥ 123) and its toggling behaviour.
 */
module.exports = CoreView.extend({
  tagName: 'a',

  events: {
    'click': '_toggleLike'
  },

  initialize: function () {
    this.model.bind('change:likeable change:liked change:likes error', this.render, this);
  },

  render: function () {
    this.$el.html(
      template({
        likes: this.model.get('likes'),
        size: this.model.get('size'),
        show_count: this.model.get('show_count'),
        show_label: this.model.get('show_label')
      })
    );
    this.$el.attr({
      class: this._classNames(),
      href: this._hrefLocation()
    });

    return this;
  },

  _hrefLocation: function () {
    var href = '#/like';

    if (!this.model.get('likeable')) {
      href = window.login_url;
    }

    return href;
  },

  _classNames: function () {
    var classNames = ['LikesIndicator'];

    if (this.model.get('likeable')) {
      classNames.push('is-likeable');
    }

    if (this.model.get('liked')) {
      classNames.push('is-liked');
    }

    if (this._animate) {
      classNames.push('is-animated');
      this.$el.one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function () {
        // unset animate and force re-render to avoid race conditions
        this._animate = false;
        this.render();
      }.bind(this));
    }

    return classNames.join(' ');
  },

  _toggleLike: function (ev) {
    if (this.model.get('likeable')) {
      this.killEvent(ev);

      this._animate = true;
      this.model.toggleLiked();
    }
  }
});

},{"./likes.tpl":226,"backbone/core-view":1127}],226:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<i class="CDB-IconFont CDB-IconFont-heartFill LikesIndicator-icon ';
 if ((typeof size != "undefined") && size === 'big') { 
__p+='LikesIndicator-icon--big Navmenu-icon';
 } 
__p+='"></i>\n';
 if (likes > 2 || show_count) { 
__p+='\n  <span class="CDB-Text CDB-Size-medium LikesIndicator-count">'+
((__t=( likes ))==null?'':_.escape(__t))+
'</span>\n  ';
 if (show_label && likes > 3) { 
__p+='\n    <span class="CDB-Text CDB-Size-medium LikesIndicator-label">'+
((__t=( _t('components.likes-pluralize', { smart_count: likes }) ))==null?'':_.escape(__t))+
'</span>\n  ';
 } 
__p+='\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],227:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="IntermediateInfo">\n  <div class="CDB-LoaderIcon CDB-LoaderIcon--big is-dark js-loader">\n    <svg class="CDB-LoaderIcon-spinner" viewbox="0 0 50 50">\n      <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"/>\n    </svg>\n  </div>\n  <h4 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m u-tSpace-xl">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h4>\n  <div class="CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( descHTML ))==null?'':__t)+
'</div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],228:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text CDB-Size-medium u-altTextColor">\n  "'+
((__t=( quote ))==null?'':__t)+
'"\n</p>\n';
 if (author) { 
__p+='\n  <p class="CDB-Text CDB-Size-medium u-altTextColor u-tSpace"><i>– '+
((__t=( author ))==null?'':_.escape(__t))+
'</i></p>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],229:[function(require,module,exports){
var template = require('./quote.tpl');

var QUOTES = [
  { quote: 'Geographers never get lost. They just do accidental field work.', author: 'Nicholas Chrisman' },
  { quote: 'Geography is just physics slowed down, with a couple of trees stuck in it.', author: 'Terry Pratchett' },
  { quote: 'Not all those who wander are lost.', author: 'J. R. R. Tolkien' },
  { quote: 'In that Empire, the Art of Cartography attained such Perfection that the map of a single Province occupied the entirety of a City.', author: 'Jorge Luis Borges' },
  { quote: 'X marks the spot', author: 'Indiana Jones' },
  { quote: "It's turtles all the way down.", author: null },
  { quote: 'Remember: no matter where you go, there you are.', author: null },
  { quote: "Without geography, you're nowhere!", author: 'Jimmy Buffett' },
  { quote: 'our earth is a globe / whose surface we probe /<br />no map can replace her / but just try to trace her', author: 'Steve Waterman' },
  { quote: 'Everything happens somewhere.', author: 'Doctor Who' },
  { quote: 'A map is the greatest of all epic poems. Its lines and colors show the realization of great dreams.', author: 'Gilbert H. Grosvenor' },
  { quote: 'Everything is related to everything else,<br />but near things are more related than distant things.', author: "Tobler's first law of geography" },
  { quote: 'Hic Sunt Dracones', author: null },
  { quote: 'Here be dragons', author: null },
  { quote: "Stand in the place where you live / Now face North /<br/>Think about direction / Wonder why you haven't before", author: 'R.E.M' },
  { quote: 'The virtue of maps, they show what can be done with limited space, they foresee that everything can happen therein.', author: 'José Saramago' }
];

/**
 * Random quote
 */
module.exports = function () {
  var idx = Math.round(Math.random() * (QUOTES.length - 1));

  return template(QUOTES[idx]);
};

},{"./quote.tpl":228}],230:[function(require,module,exports){
var cdb = require('cartodb.js');
var template = require('./loading.tpl');
var randomQuote = require('./random-quote');

/**
 * @param {Object} opts
 * @param {String=} opts.title
 * @param {String=} opts.desc
 */
module.exports = function (opts) {
  var customDesc = opts.desc && cdb.core.sanitize(opts.desc);

  return template({
    title: opts.title || '',
    descHTML: customDesc || randomQuote()
  });
};

},{"./loading.tpl":227,"./random-quote":229,"cartodb.js":"cartodb.js"}],231:[function(require,module,exports){
var storage = (function () {
  var storageName = 'cdb';
  var version = '0.1.0';
  var mainStorageKey;
  var initialized = false;
  var userModel;

  function init (key, opts) {
    if (!key) {
      throw new Error('key is required');
    }

    if (!userModel && !opts) {
      throw new Error('userModel is required');
    }

    if (!userModel && opts && opts.userModel) {
      userModel = opts.userModel;
    }

    mainStorageKey = key;
    initialized = true;
  }

  function getKey (key) {
    return [storageName, version, userModel.get('username'), mainStorageKey, key].join('.');
  }

  function isSupported () {
    try {
      return 'localStorage' in window && window['localStorage'] !== null;
    } catch (e) {
      return false;
    }
  }

  return {
    init: function (key, opts) {
      if (!isSupported()) throw new Error('localStorage not supported in your browser');
      init(key, opts);
    },

    get: function (key) {
      if (!initialized) {
        init();
      }
      var storageKey = getKey(key);
      return localStorage[storageKey];
    },

    set: function (key, value) {
      if (!initialized) {
        init();
      }
      var storageKey = getKey(key);
      localStorage[storageKey] = value;
    },

    delete: function (key) {
      if (!initialized) {
        init();
      }

      var storageKey = getKey(key);
      delete localStorage[storageKey];
    }
  };
})();

module.exports = storage;

},{}],232:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

module.exports = Backbone.Model.extend({

  defaults: {
    eventName: '',
    eventProperties: {}
  },

  url: function () {
    return this._configModel.get('base_url') + '/api/v3/metrics';
  },

  initialize: function (attrs, opts) {
    if (!opts.userId) { throw new Error('userId is required'); }
    if (!opts.visId) { throw new Error('visId is required'); }
    if (!opts.configModel) { throw new Error('configModel is required'); }

    this._userId = opts.userId;
    this._visId = opts.visId;
    this._configModel = opts.configModel;
  },

  toJSON: function () {
    return {
      name: this.get('eventName'),
      properties: _.extend(
        {},
        this.get('eventProperties'),
        {
          visualization_id: this._visId,
          user_id: this._userId
        }
      )
    };
  }
});

},{"backbone":"backbone","underscore":"underscore"}],233:[function(require,module,exports){
var MetricsModel = require('./metrics-model');

/**
 *  Metrics singleton tracker.
 *  It sends any event to metrics endpoint.
 */

module.exports = (function () {
  return {
    init: function (opts) {
      if (!opts) { throw new Error('visId, userId and configModel are required'); }
      if (!opts.userId) { throw new Error('userId is required'); }
      if (!opts.visId) { throw new Error('visId is required'); }
      if (!opts.configModel) { throw new Error('configModel is required'); }

      this._userId = opts.userId;
      this._visId = opts.visId;
      this._configModel = opts.configModel;
    },

    track: function (eventName, eventProperties) {
      if (!eventName) { throw new Error('eventName is required'); }

      var metricModel = new MetricsModel({
        eventName: eventName,
        eventProperties: eventProperties
      }, {
        userId: this._userId,
        visId: this._visId,
        configModel: this._configModel
      });

      metricModel.save();
    }
  };
})();

},{"./metrics-model":232}],234:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Modal">\n  <div class="Modal-header">\n    <div class="Modal-headerContainer">\n      <h2 class="CDB-Text CDB-Size-huge is-light u-bSpace">'+
((__t=( _t('components.modals.add-analysis.modal-title') ))==null?'':_.escape(__t))+
'</h2>\n      <h3 class="CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( _t('components.modals.add-analysis.modal-desc') ))==null?'':_.escape(__t))+
'</h3>\n    </div>\n  </div>\n  <div class="Modal-container Modal-container--analysis">\n    <div class="Modal-inner js-body">\n    </div>\n  </div>\n  <div class="Modal-footer">\n    <div class="Modal-footerContainer u-flex u-justifyEnd">\n      <button class="CDB-Button CDB-Button--primary is-disabled js-add">\n        <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.add-analysis.add-btn') ))==null?'':_.escape(__t))+
'</span>\n      </button>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],235:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var Analyses = require('../../../data/analyses');
var AnalysisOptionsCollection = require('./analysis-options-collection');
var analysisOptions = require('./analysis-options');
var StackLayoutView = require('../../../components/stack-layout/stack-layout-view');
var AnalysisViewPane = require('./analysis-view-pane');
var AnalysisInfoPane = require('./analysis-info-pane');
var renderLoading = require('../../../components/loading/render-loading');
var DataServicesApiCheck = require('../../../editor/layers/layer-content-views/analyses/analyses-quota/analyses-quota-info');

/**
 * View to add a new analysis node.
 * Expected to be rendered in a modal.
 */
module.exports = CoreView.extend({
  className: 'Dialog-content Dialog-content--expanded',

  events: {
    'click .js-add': '_onAddAnalysis'
  },

  initialize: function (opts) {
    if (!opts.modalModel) throw new Error('modalModel is required');
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');

    this._modalModel = opts.modalModel;
    this._layerDefinitionModel = opts.layerDefinitionModel;
    this._userModel = opts.userModel;
    this._configModel = opts.configModel;
    this._analysisDefinitionNodeModel = this._layerDefinitionModel.getAnalysisDefinitionNodeModel();

    this._analysisOptions = analysisOptions(Analyses, this._userModel, this._configModel);
    this._analysisOptionsCollection = new AnalysisOptionsCollection();

    this.add_related_model(this._analysisOptionsCollection);

    this._queryGeometryModel = this._analysisDefinitionNodeModel.queryGeometryModel;
    this._queryGeometryModel.on('change', this.render, this);
    this.add_related_model(this._queryGeometryModel);

    this._dataservicesApiHealth = DataServicesApiCheck.get();

    if (!this._isFetchingGeometry()) {
      this._queryGeometryModel.fetch();
    }

    this._initOptions();
  },

  render: function () {
    this.clearSubViews();

    var render = this.render.bind(this);
    var dsApiNeedsCheck = this._dataservicesApiHealth.needsCheck();
    if (dsApiNeedsCheck) {
      this._dataservicesApiHealth.fetch({
        success: render
      });
    }

    if (this._isFetchingGeometry() || dsApiNeedsCheck) {
      this._renderLoadingView();
    } else {
      this._renderStackView();
    }

    return this;
  },

  _renderLoadingView: function () {
    this.$el.html(
      renderLoading({
        title: _t('components.modals.add-widgets.loading-title')
      })
    );
  },

  _renderStackView: function () {
    var stackViewCollection = new Backbone.Collection([{
      createStackView: function (stackLayoutModel, opts) {
        var view = new AnalysisViewPane({
          modalModel: this._modalModel,
          stackLayoutModel: stackLayoutModel,
          analysisOptions: this._analysisOptions,
          analysisOptionsCollection: this._analysisOptionsCollection,
          layerDefinitionModel: this._layerDefinitionModel,
          queryGeometryModel: this._queryGeometryModel
        });
        this._analysisViewPane = view;
        return view;
      }.bind(this)
    }, {
      createStackView: function (stackLayoutModel, opts) {
        var view = new AnalysisInfoPane({
          stackLayoutModel: stackLayoutModel,
          modalModel: this._modalModel,
          layerDefinitionModel: this._layerDefinitionModel,
          collection: this._analysisOptionsCollection
        });

        view.bind('backToCategory', function (categoryName) {
          stackLayoutModel.prevStep();
          this._analysisViewPane.goToTabItem(categoryName);
        }, this);

        return view;
      }.bind(this)
    }]);

    this._stackLayoutView = new StackLayoutView({
      className: 'Editor-content',
      collection: stackViewCollection
    });

    this.$el.html(this._stackLayoutView.render().$el);
    this.addView(this._stackLayoutView);
  },

  _isFetchingGeometry: function () {
    return this._queryGeometryModel.get('status') === 'fetching';
  },

  _initOptions: function () {
    // Flatten the options hierarchy to a flat array structure that's easier to handle programmatically.
    var modelsAttrs = _.reduce(Object.keys(this._analysisOptions), function (memo, category) {
      var categoryDef = this._analysisOptions[category];
      categoryDef.analyses.forEach(function (d) {
        memo.push(_.extend({}, d, { category: category, type: d.nodeAttrs.type }));
      });

      return memo;
    }, [], this);

    this._analysisOptionsCollection.reset(modelsAttrs);
  }
});

},{"../../../components/loading/render-loading":230,"../../../components/stack-layout/stack-layout-view":533,"../../../data/analyses":599,"../../../editor/layers/layer-content-views/analyses/analyses-quota/analyses-quota-info":796,"./analysis-info-pane":240,"./analysis-options":248,"./analysis-options-collection":247,"./analysis-view-pane":249,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],236:[function(require,module,exports){
var _ = require('underscore');
var AnalysisCategoryView = require('./analysis-category-pane-view');

module.exports = function (analysisOptions) {
  return [{
    type: 'create_clean',
    createTabPaneItem: function (optionsCollection, opts) {
      return {
        label: _t('analysis-category.create-clean'),
        name: 'create_clean',
        createContentView: function () {
          return new AnalysisCategoryView(_.extend({
            analysisOptions: analysisOptions,
            analysisType: 'create_clean',
            collection: optionsCollection
          }, opts));
        }
      };
    }
  }, {
    type: 'analyze_predict',
    createTabPaneItem: function (optionsCollection, opts) {
      return {
        label: _t('analysis-category.analyze-predict'),
        name: 'analyze_predict',
        createContentView: function () {
          return new AnalysisCategoryView(_.extend({
            analysisOptions: analysisOptions,
            analysisType: 'analyze_predict',
            collection: optionsCollection
          }, opts));
        }
      };
    }
  }, {
    type: 'data_transformation',
    createTabPaneItem: function (optionsCollection, opts) {
      return {
        label: _t('analysis-category.data-transformation'),
        name: 'data_transformation',
        createContentView: function () {
          return new AnalysisCategoryView(_.extend({
            analysisOptions: analysisOptions,
            analysisType: 'data_transformation',
            collection: optionsCollection
          }, opts));
        }
      };
    }
  }];
};

},{"./analysis-category-pane-view":237,"underscore":"underscore"}],237:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var ScrollView = require('../../scroll/scroll-view');
var AnalysisCategoryPane = require('./analysis-category-pane');

/**
 * View to add a new analysis node.
 * Expected to be rendered in a modal.
 */
module.exports = CoreView.extend({
  className: 'Dialog-content Dialog-content--expanded',

  initialize: function (opts) {
    if (!opts.modalModel) throw new Error('modalModel is required');
    if (!opts.stackLayoutModel) throw new Error('stackLayoutModel is required');
    if (!opts.analysisOptionsCollection) throw new Error('analysisOptionsCollection is required');
    if (!opts.analysisType) throw new Error('analysisType is required');
    if (!opts.analysisOptions) throw new Error('analysisOptions is required');
    if (!opts.queryGeometryModel) throw new Error('queryGeometryModel is required');

    this._modalModel = opts.modalModel;
    this._stackLayoutModel = opts.stackLayoutModel;
    this._queryGeometryModel = opts.queryGeometryModel;
    this._analysisOptionsCollection = opts.analysisOptionsCollection;
    this._analysisType = opts.analysisType;
    this._analysisOptions = opts.analysisOptions;
  },

  render: function () {
    this.clearSubViews();

    var view = new ScrollView({
      createContentView: function () {
        return new AnalysisCategoryPane({
          stackLayoutModel: this._stackLayoutModel,
          collection: this._analysisOptionsCollection,
          title: this.options.categoryTitle || this.options.category,
          category: this._analysisType === 'all' ? null : this._analysisType,
          categoryTitle: this._analysisType === 'all' ? null : this._analysisOptions[this._analysisType].label,
          simpleGeometryType: this._queryGeometryModel.get('simple_geom')
        });
      }.bind(this)
    });

    this.addView(view);
    this.$el.append(view.render().el);

    return this;
  }
});

},{"../../scroll/scroll-view":530,"./analysis-category-pane":238,"backbone/core-view":1127}],238:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var AnalysisOptionView = require('./analysis-option-view');
var template = require('./analysis-category.tpl');

/**
 * View to render an individual analysis category and its analysis options
 */
module.exports = CoreView.extend({

  className: 'Modal-analysisContainer',

  options: {
    category: '',
    categoryTitle: '',
    simpleGeometryType: ''
  },

  initialize: function (opts) {
    if (!opts.stackLayoutModel) throw new Error('stackLayoutModel is required');
    this._stackLayoutModel = opts.stackLayoutModel;
  },

  render: function () {
    this.clearSubViews();

    this.$el.html(this._html());
    this.collection.each(this._renderOption, this);

    return this;
  },

  _html: function () {
    return template({
      title: this.options.title
    });
  },

  _renderOption: function (analysisOptionModel) {
    if (this.options.category && !analysisOptionModel.belongsTo(this.options.category)) {
      return;
    }

    var view = new AnalysisOptionView({
      model: analysisOptionModel,
      simpleGeometryTypeInput: this.options.simpleGeometryType
    });

    view.bind('onClickInfo', function () {
      this._stackLayoutModel.nextStep();
    }, this);

    this.addView(view);
    this._$list().append(view.render().el);
  },

  _$list: function () {
    return this.$('.js-analyses-list');
  }
});

},{"./analysis-category.tpl":239,"./analysis-option-view":245,"backbone/core-view":1127}],239:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="ModalBlockList js-analyses-list"></ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],240:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./analysis-info-pane.tpl');
var Analyses = require('../../../data/analyses');

/**
 * View to render an individual analysis category and its analysis options
 */
module.exports = CoreView.extend({
  className: 'Modal',

  events: {
    'click .js-back': '_onClickBack',
    'click .js-backToCategory': '_onClickBackToCategory',
    'click .js-add': '_onAddAnalysis'
  },

  initialize: function (opts) {
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
    if (!opts.modalModel) throw new Error('modalModel is required');
    if (!opts.stackLayoutModel) throw new Error('stackLayoutModel is required');

    this._layerDefinitionModel = opts.layerDefinitionModel;
    this._modalModel = opts.modalModel;
    this._stackLayoutModel = opts.stackLayoutModel;

    this.collection.on('change:selected', this.render, this);
  },

  render: function () {
    this.clearSubViews();

    var selectedAnalysis = this.collection.find('selected');
    var analysisType;
    var genericType;
    var opts = { title: '', category: '', type: '', genericType: '', analysisParams: '' };

    if (selectedAnalysis) {
      var analysisParams = {};
      analysisType = selectedAnalysis.get('type');
      var analysisItem = Analyses.getAnalysisByType(analysisType);
      var animationTemplate = analysisItem && analysisItem.animationTemplate;

      if (animationTemplate) {
        genericType = analysisItem.genericType || analysisType;
        analysisParams = analysisItem.animationParams || {};
      }

      this._analysisCategoryName = selectedAnalysis.get('category');

      opts = {
        type: analysisType,
        genericType: genericType,
        category: this._analysisCategoryName.replace(/_/g, '-'),
        title: selectedAnalysis.get('title'),
        analysisParams: analysisParams
      };
    }

    this.$el.html(template(opts));

    if (animationTemplate) {
      this.$('.js-animation').append(animationTemplate);
    }

    return this;
  },

  _onClickBackToCategory: function () {
    this.trigger('backToCategory', this._analysisCategoryName, this);
  },

  _onClickBack: function () {
    this._stackLayoutModel.prevStep();
  },

  _isSelected: function (m) {
    return !!m.get('selected');
  },

  _onAddAnalysis: function () {
    var selectedOptionModel = this.collection.find(this._isSelected);

    if (selectedOptionModel) {
      var analysisFormAttrs = selectedOptionModel.getFormAttrs(this._layerDefinitionModel);
      this._modalModel.destroy(analysisFormAttrs);
    }
  }
});

},{"../../../data/analyses":599,"./analysis-info-pane.tpl":241,"backbone/core-view":1127}],241:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Modal-header">\n  <div class="Modal-headerContainer">\n    <div class="CDB-HeaderInfo">\n      <button class="u-rSpace--xl CDB-HeaderInfo-back u-actionTextColor js-back">\n        <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n      </button>\n      <div class="CDB-HeaderInfo-inner">\n        <h2 class="CDB-Text CDB-Size-huge is-light u-bSpace">'+
((__t=( _t('components.modals.add-analysis.modal-title') ))==null?'':_.escape(__t))+
'</h2>\n        <h3 class="CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( _t('components.modals.add-analysis.modal-desc') ))==null?'':_.escape(__t))+
'</h3>\n      </div>\n    </div>\n  </div>\n</div>\n\n<div class="Modal-inner Modal-inner--with-navigation js-content">\n  <div class="Dialog-content Dialog-content--expanded">\n    <div class="ScrollView">\n      <div class="ScrollView-content">\n        <div class="Modal-analysisContainer">\n          <ul class="CDB-NavMenu-inner CDB-Text is-semibold CDB-Size-small SubmenuModal u-flex u-alignCenter">\n            <li class="CDB-NavMenu-item SubmenuModal-item u-flex u-alignCenter">\n              <button class="js-back u-mainTextColor u-upperCase">'+
((__t=( _t('analysis-category.all') ))==null?'':_.escape(__t))+
'</button>\n            </li>\n            <li class="CDB-NavMenu-item SubmenuModal-item u-flex u-alignCenter">\n              <button class="js-backToCategory u-mainTextColor u-upperCase">'+
((__t=( _t('analysis-category.' + category) ))==null?'':_.escape(__t))+
'</button>\n            </li>\n            <li class="CDB-NavMenu-item u-upperCase SubmenuModal-item u-flex u-alignCenter">\n              '+
((__t=( title ))==null?'':_.escape(__t))+
'\n            </li>\n          </ul>\n          <div class="Modal-inner u-justifyCenter">\n            <div class="Analysis-moreInfo">\n              <div class="Analysis-animation ';
 if (genericType) { 
__p+='is-'+
((__t=( genericType ))==null?'':_.escape(__t))+
'';
 } 
__p+=' has-autoplay js-animation is-rounded"></div>\n              <h2 class="CDB-Text CDB-Size-huge is-light Analysis-moreInfoTitle">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h2>\n              <p class="CDB-Text CDB-Size-medium u-secondaryTextColor">\n                '+
((__t=( _t('analyses-onboarding.' + genericType + '.description', analysisParams) ))==null?'':_.escape(__t))+
'\n              </p>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n<div class="Modal-footer">\n  <div class="Modal-footerContainer u-flex u-justifyEnd">\n    <button class="CDB-Button CDB-Button--primary js-add">\n      <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.add-analysis.add-btn') ))==null?'':_.escape(__t))+
'</span>\n    </button>\n  </div>\n</div>\n\n';
}
return __p;
};

},{"underscore":"underscore"}],242:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var camshaftReference = require('../../../../data/camshaft-reference');
var nodeIds = require('../../../../value-objects/analysis-node-ids');

module.exports = Backbone.Model.extend({

  defaults: {
    title: '',
    category: '',
    selected: false,
    type_group: '',
    desc: ''
  },

  initialize: function (attrs, opts) {
    if (!opts.nodeAttrs) throw new Error('nodeAttrs is required');

    this._nodeAttrs = opts.nodeAttrs;
  },

  belongsTo: function (category) {
    return this.get('category') === category;
  },

  acceptsGeometryTypeAsInput: function (simpleGeometryType) {
    return camshaftReference.isValidInputGeometryForType(simpleGeometryType, this._nodeAttrs.type);
  },

  getValidInputGeometries: function () {
    return camshaftReference.getValidInputGeometriesForType(this._nodeAttrs.type);
  },

  getFormAttrs: function (layerDefModel) {
    var letter = layerDefModel.get('letter');
    var sourceId = layerDefModel.get('source');

    return _.extend(
      {
        source: sourceId,
        id: letter === nodeIds.letter(sourceId)
          ? nodeIds.next(sourceId)
          : letter + '1'
      },
      this._nodeAttrs
    );
  }

});

},{"../../../../data/camshaft-reference":615,"../../../../value-objects/analysis-node-ids":1119,"backbone":"backbone","underscore":"underscore"}],243:[function(require,module,exports){
var _ = require('underscore');
var AnalysisOptionModel = require('./analysis-option-model');
var camshaftReference = require('../../../../data/camshaft-reference');

/**
 * Model to represent a generated analysis option.
 */
module.exports = AnalysisOptionModel.extend({

  /**
   * @override {AnalysisOptionModel.getNodeAttrs}
   */
  getFormAttrs: function () {
    var attrs = AnalysisOptionModel.prototype.getFormAttrs.apply(this, arguments);

    this._removeSourceIfThereAreMultipleSources(attrs);

    return attrs;
  },

  _removeSourceIfThereAreMultipleSources: function (attrs) {
    var params = camshaftReference.paramsForType(attrs.type);
    var sourceCount = _.reduce(Object.keys(params), function (memo, name) {
      if (params[name].type === 'node') {
        memo++;
      }
      return memo;
    }, 0);

    if (sourceCount > 1) {
      delete attrs.source;
    }
  }

});

},{"../../../../data/camshaft-reference":615,"./analysis-option-model":242,"underscore":"underscore"}],244:[function(require,module,exports){
var _ = require('underscore');
var AnalysisOptionModel = require('./analysis-option-model');

/**
 * Custom model for merge type, to set correct primary source
 */
module.exports = AnalysisOptionModel.extend({

  /**
   * @override {AnalysisOptionModel.getNodeAttrs}
   */
  getFormAttrs: function (layerDefModel) {
    var attrs = AnalysisOptionModel.prototype.getFormAttrs.apply(this, arguments);
    delete attrs.source;

    _.extend(attrs, {
      primary_source_name: 'left_source',
      left_source: layerDefModel.get('source')
    });

    return attrs;
  }

});

},{"./analysis-option-model":242,"underscore":"underscore"}],245:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');
var CoreView = require('backbone/core-view');
var template = require('./analysis-option.tpl');
var Analyses = require('../../../data/analyses');

/**
 * View for an individual analysis option.
 */
module.exports = CoreView.extend({

  tagName: 'li',
  className: 'ModalBlockList-item',

  events: {
    'mouseenter': '_onMouseEnter',
    'mouseleave': '_onMouseLeave',
    'click': '_onClick'
  },

  initialize: function (opts) {
    this._simpleGeometryTypeInput = opts.simpleGeometryTypeInput; // might be undefined/null, so don't check

    this.listenTo(this.model, 'change:selected', this.render);
  },

  render: function () {
    var props = this.model.pick('title', 'type_group', 'desc', 'selected');

    props.enabled = this._acceptsInputGeometry();

    if (!props.enabled) {
      props.desc = this._disabledDesc();
    }

    var analysisType = this.model.get('type');
    var analysisItem = Analyses.getAnalysisByType(analysisType);
    var animationTemplate = analysisItem && analysisItem.animationTemplate;
    var genericType = '';

    if (animationTemplate) {
      genericType = analysisItem.genericType || analysisType;
    }

    this.$el.html(template(_.extend(props, { type: genericType })));

    if (animationTemplate) {
      this.$('.js-animation').append(animationTemplate);
    }

    this.$el.toggleClass('is-selected', this.model.get('selected'));
    this.$el.toggleClass('is-disabled', !props.enabled);

    return this;
  },

  _onMouseEnter: function () {
    if (this._acceptsInputGeometry()) {
      this.$('.js-animation').addClass('has-autoplay');
    }
  },

  _onMouseLeave: function () {
    if (this._acceptsInputGeometry()) {
      this.$('.js-animation').removeClass('has-autoplay');
    }
  },

  _onClick: function (e) {
    if (e && e.target && $(e.target).hasClass('js-more')) {
      this.trigger('onClickInfo', this);
    }

    if (this._acceptsInputGeometry()) {
      this.model.set('selected', true);
    }
  },

  _disabledDesc: function (desc) {
    return _t('components.modals.add-analysis.disabled-option-desc', {
      simpleGeometryType: this._simpleGeometryTypeInput || _t('components.modals.add-analysis.unknown-geometry-type'),
      requiredInputGeometries: this.model.getValidInputGeometries()
    });
  },

  _acceptsInputGeometry: function () {
    return this.model.acceptsGeometryTypeAsInput(this._simpleGeometryTypeInput);
  }

});

},{"../../../data/analyses":599,"./analysis-option.tpl":246,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],246:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Analysis-animation ';
 if (enabled) { 
__p+='is-enabled';
 } 
__p+=' ';
 if (type) { 
__p+='is-'+
((__t=( type ))==null?'':_.escape(__t))+
'';
 } 
__p+=' js-animation u-flex u-alignCenter u-justifyCenter"></div>\n<div class="Analysis-info u-flex">\n  <div class="ModalBlockList-itemInput CDB-Size-large">\n    <input class="CDB-Radio" type="radio" value="true"\n        ';
 if (selected) { 
__p+='checked="checked"';
 } 
__p+='\n        ';
 if (!enabled) { 
__p+='disabled="disabled"';
 } 
__p+='\n      >\n    <span class="u-iBlock CDB-Radio-face"></span>\n  </div>\n  <div class="ModalBlockList-inner">\n    <div class="ModalBlockList-item-header u-bSpace">\n      <h2 class="ModalBlockList-item-headerTitle CDB-Text CDB-Size-large u-rSpace--m u-ellipsis" title="'+
((__t=( title ))==null?'':_.escape(__t))+
'">\n        '+
((__t=( title ))==null?'':_.escape(__t))+
'\n      </h2>\n    </div>\n    <div class="ModalBlockList-item-body">\n      <p class="CDB-Text CDB-Size-small u-altTextColor">\n        '+
((__t=( desc ))==null?'':_.escape(__t))+
'\n      </p>\n      <button class="CDB-Text CDB-Size-small u-tSpace-xl u-actionTextColor js-more">'+
((__t=( _t('components.modals.add-analysis.info-analysis') ))==null?'':_.escape(__t))+
'</button>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],247:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var AnalysisOptionModel = require('./analysis-option-models/analysis-option-model');

module.exports = Backbone.Collection.extend({

  model: function (d, opts) {
    var Model = d.Model || AnalysisOptionModel;

    var attrs = _.omit(d, 'Model', 'nodeAttrs');

    return new Model(attrs, {nodeAttrs: d.nodeAttrs});
  },

  initialize: function (models, opts) {
    this.on('change:selected', this._onSelectedChange, this);
  },

  _onSelectedChange: function (changedModel, isSelected) {
    if (isSelected) {
      this.each(function (m) {
        if (m !== changedModel) {
          m.set('selected', false);
        }
      });
    }
  }
});

},{"./analysis-option-models/analysis-option-model":242,"backbone":"backbone","underscore":"underscore"}],248:[function(require,module,exports){
var _ = require('underscore');
var GeneratedAnalysisOptionModel = require('./analysis-option-models/generated-analysis-option-model');
var camshaftReference = require('camshaft-reference');
var latestCamshaftReference = camshaftReference.getVersion('latest');

/**
 * Analysis definitions, organized in buckets per top-level category
 *
 *  - {Obj} -> analyses list (data/analyses.js file)
 *  - {Obj} -> user model
 *  - {Obj} -> config model
 */
module.exports = function (Analyses, userModel, configModel) {
  var categories = {
    create_clean: {
      title: _t('analysis-category.create-clean'),
      analyses: Analyses.getAnalysesByModalCategory('create_clean', configModel, userModel)
    },
    data_transformation: {
      title: _t('analysis-category.data-transformation'),
      analyses: Analyses.getAnalysesByModalCategory('data_transformation', configModel, userModel)
    },
    analyze_predict: {
      title: _t('analysis-category.analyze-predict'),
      analyses: Analyses.getAnalysesByModalCategory('analyze_predict', configModel, userModel)
    }
  };
  var alsoGenerateFromCamshaftReference = userModel.featureEnabled('generate_analysis_options');

  if (alsoGenerateFromCamshaftReference) {
    var implementedAnalyses = _.reduce(Object.keys(categories), function (memo, category) {
      return memo.concat(
        categories[category].analyses.map(function (analysis) {
          return analysis.nodeAttrs.type;
        })
      );
    }, []);

    categories['generated'] = {
      title: 'Generated analyses by the Camshaft reference v' + _.last(camshaftReference.versions),
      analyses: _.compact(
        Object
          .keys(latestCamshaftReference.analyses)
          .filter(function (type) {
            return type !== 'source' && !_.contains(implementedAnalyses, type);
          })
          .map(function (type) {
            if (!Analyses.isAnalysisValidByType(type, configModel, userModel)) {
              return false;
            }

            return {
              Model: GeneratedAnalysisOptionModel,
              nodeAttrs: {type: type},
              title: type,
              desc: JSON.stringify(latestCamshaftReference.analyses[type])
            };
          })
      )
    };
  }

  return categories;
};

},{"./analysis-option-models/generated-analysis-option-model":243,"camshaft-reference":"camshaft-reference","underscore":"underscore"}],249:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var AnalysisCategoryView = require('./analysis-category-pane-view');
var createTemplateTabPane = require('../../tab-pane/create-template-tab-pane');
var template = require('./add-analyses.tpl');
var tabPaneButtonTemplate = require('./tab-pane-button-template.tpl');
var tabPaneTemplate = require('./tab-pane-template.tpl');
var analysesTypes = require('./analyses-types');

/**
 * View to select the analysis to create.
 */
module.exports = CoreView.extend({
  className: 'Dialog-content Dialog-content--expanded',

  events: {
    'click .js-add': '_onAddAnalysis'
  },

  initialize: function (opts) {
    if (!opts.modalModel) throw new Error('modalModel is required');
    if (!opts.stackLayoutModel) throw new Error('stackLayoutModel is required');
    if (!opts.analysisOptionsCollection) throw new Error('analysisOptionsCollection is required');
    if (!opts.analysisOptions) throw new Error('analysisOptions is required');
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
    if (!opts.queryGeometryModel) throw new Error('queryGeometryModel is required');

    this._modalModel = opts.modalModel;
    this._stackLayoutModel = opts.stackLayoutModel;
    this._analysisOptions = opts.analysisOptions;
    this._analysisOptionsCollection = opts.analysisOptionsCollection;
    this._layerDefinitionModel = opts.layerDefinitionModel;
    this._queryGeometryModel = opts.queryGeometryModel;

    this.listenTo(this._analysisOptionsCollection, 'change:selected', this._toggleAddButton);
    this._generateTabPaneItems();
  },

  render: function () {
    this.clearSubViews();

    this.$el.html(template());

    var options = {
      tabPaneOptions: {
        template: tabPaneTemplate,
        tabPaneItemOptions: {
          tagName: 'li',
          className: 'CDB-NavMenu-item'
        }
      },
      tabPaneTemplateOptions: {
        tagName: 'button',
        className: 'CDB-NavMenu-link u-upperCase',
        template: tabPaneButtonTemplate
      }
    };

    this._tabPane = createTemplateTabPane(this._tabPaneItems, options);
    this.addView(this._tabPane);
    this._$body().append(this._tabPane.render().el);
    return this;
  },

  goToTabItem: function (tabItemName) {
    var tabItem = _.first(this._tabPane.collection.where({ name: tabItemName }));
    if (tabItem) {
      tabItem.set('selected', true);
      this._toggleAddButton(); // set the right state for the add button
    }
  },

  _generateTabPaneItems: function () {
    var availableTypes = _.unique(_.keys(this._analysisOptions));

    this._tabPaneItems = _.map(analysesTypes(this._analysisOptions), function (d) {
      if (_.contains(availableTypes, d.type)) {
        return d.createTabPaneItem(this._analysisOptionsCollection, {
          modalModel: this._modalModel,
          stackLayoutModel: this._stackLayoutModel,
          analysisOptionsCollection: this._analysisOptionsCollection,
          queryGeometryModel: this._queryGeometryModel
        });
      }
    }.bind(this));

    this._tabPaneItems.unshift({
      label: _t('analysis-category.all'),
      name: 'all',
      createContentView: function () {
        return new AnalysisCategoryView({
          analysisType: 'all',
          stackLayoutModel: this._stackLayoutModel,
          modalModel: this._modalModel,
          analysisOptions: this._analysisOptions,
          analysisOptionsCollection: this._analysisOptionsCollection,
          queryGeometryModel: this._queryGeometryModel
        });
      }.bind(this)
    });
  },

  _$body: function () {
    return this.$('.js-body');
  },

  _onAddAnalysis: function () {
    var selectedOptionModel = this._analysisOptionsCollection.find(this._isSelected);

    if (selectedOptionModel) {
      var analysisFormAttrs = selectedOptionModel.getFormAttrs(this._layerDefinitionModel);
      this._modalModel.destroy(analysisFormAttrs);
    }
  },

  _toggleAddButton: function () {
    this.$('.js-add').toggleClass('is-disabled', !this._analysisOptionsCollection.any(this._isSelected));
  },

  _isSelected: function (m) {
    return !!m.get('selected');
  }
});

},{"../../tab-pane/create-template-tab-pane":536,"./add-analyses.tpl":234,"./analyses-types":236,"./analysis-category-pane-view":237,"./tab-pane-button-template.tpl":266,"./tab-pane-template.tpl":267,"backbone/core-view":1127,"underscore":"underscore"}],250:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="308px" height="98px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g fill="#9DE0AD" fill-rule="evenodd" transform="translate(50, 8)">\n    <circle class="aoi-area area01" fill="#5A7E6D" cx="20" cy="36" r="20"></circle>\n    <circle class="aoi-point area-point01" cx="20" cy="36" r="4"></circle>\n    <circle class="aoi-area area02" fill="#5A7E6D" cx="56" cy="28" r="20"></circle>\n    <circle class="aoi-point area-point02"  cx="56" cy="28" r="4"></circle>\n    <circle class="aoi-area area03" fill="#5A7E6D" cx="76" cy="44" r="20"></circle>\n    <circle class="aoi-point area-point03" cx="76" cy="44" r="4"></circle>\n    <circle class="aoi-area area04" fill="#5A7E6D" cx="138" cy="60" r="20"></circle>\n    <circle class="aoi-point area-point04" cx="138" cy="60" r="4"></circle>\n    <circle class="aoi-area area05" fill="#5A7E6D" cx="156" cy="20" r="20"></circle>\n    <circle class="aoi-point area-point05" cx="156" cy="20" r="4"></circle>\n    <circle class="aoi-area area06" fill="#5A7E6D" cx="188" cy="28" r="20"></circle>\n    <circle class="aoi-point area-point06" cx="188" cy="28" r="4"></circle>\n  </g>\n</svg>\n';
}
return __p;
};

},{"underscore":"underscore"}],251:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="148px" height="141px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g fill="#636D72" fill-rule="evenodd">\n    <circle class="Centroid-pointsHighlight" fill="#9DE0AD" cx="74" cy="70" r="4"></circle>\n    <circle class="Centroid-line" fill="none" stroke="#9DE0AD" cx="74.5" cy="70" r="70"></circle>\n    <circle class="Centroid-points Centroid-points01" cx="4" cy="65" r="4"></circle>\n    <circle class="Centroid-points Centroid-points02" cx="34" cy="85" r="4"></circle>\n    <circle class="Centroid-points Centroid-points03" cx="103" cy="50" r="4"></circle>\n    <circle class="Centroid-points Centroid-points04" cx="83" cy="40" r="4"></circle>\n    <circle class="Centroid-points Centroid-points05" cx="63" cy="90" r="4"></circle>\n    <circle class="Centroid-points Centroid-points06" cx="144" cy="65" r="4"></circle>\n    <circle class="Centroid-points Centroid-points07" cx="93" cy="96" r="4"></circle>\n    <circle class="Centroid-points Centroid-points08" cx="44" cy="55" r="4"></circle>\n    <circle class="Centroid-points Centroid-points09" cx="112" cy="83" r="4"></circle>\n    <circle class="Centroid-points Centroid-points10" cx="24" cy="45" r="4"></circle>\n  </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],252:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="306" height="98" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g transform="translate(30, 16)" fill="#636D72">\n\n    <g>\n      <path class="Line Line-01" d="M109,32 L42,29"></path>\n      <path class="Line Line-02" d="M109,32 L72,49"></path>\n      <path class="Line Line-03" d="M109,32 L101,54"></path>\n      <path class="Line Line-04" d="M109,32 L131,60"></path>\n      <path class="Line Line-05" d="M109,32 L82,19"></path>\n      <path class="Line Line-06" d="M109,32 L150,47"></path>\n      <path class="Line Line-07" d="M109,32 L121,4"></path>\n      <path class="Line Line-08" d="M109,32 L141,14"></path>\n      <path class="Line Line-09" d="M109,32 L159,25"></path>\n    </g>\n\n    <circle class="Dot Dot--withColorChange Dot-01" cx="42" cy="29" r="4"></circle>\n    <circle class="Dot Dot--withColorChange Dot-02" cx="72" cy="49" r="4"></circle>\n    <circle class="Dot Dot--withColorChange Dot-03" cx="101" cy="54" r="4"></circle>\n    <circle class="Dot Dot--withColorChange Dot-04" cx="131" cy="60" r="4"></circle>\n    <circle class="Dot Dot--withColorChange Dot-05" cx="82" cy="19" r="4"></circle>\n    <circle class="Dot Dot--withColorChange Dot-06" cx="150" cy="47" r="4"></circle>\n    <circle class="Dot Dot--withColorChange Dot-07" cx="141" cy="14" r="4"></circle>\n    <circle class="Dot Dot--withColorChange Dot-08" cx="121" cy="4" r="4"></circle>\n    <circle class="Dot Dot--withColorChange Dot-09" cx="159" cy="25" r="4"></circle>\n\n    <circle class="Dot Dot--withFadeOut Dot-10" cx="52" cy="54" r="4"></circle>\n    <circle class="Dot Dot--withFadeOut Dot-11" cx="4" cy="54" r="4"></circle>\n    <circle class="Dot Dot--withFadeOut Dot-12" cx="28" cy="14" r="4"></circle>\n    <circle class="Dot Dot--withFadeOut Dot-13" cx="188" cy="6" r="4"></circle>\n    <circle class="Dot Dot--withFadeOut Dot-14" cx="196" cy="46" r="4"></circle>\n    <circle class="Dot Dot--withFadeOut Dot-15" cx="228" cy="26" r="4"></circle>\n    <circle class="Dot Dot--withFadeOut Dot-16" cx="182" cy="29" r="4"></circle>\n    <circle class="Dot Dot--withFadeOut Dot-17" cx="62" cy="9" r="4"></circle>\n\n    <circle class="Dot" fill="white" cx="109" cy="32" r="4"></circle>\n  </g>\n</svg>\n';
}
return __p;
};

},{"underscore":"underscore"}],253:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="148px" height="64px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g stroke="none" fill="#636D72">\n    <polyline class="Line" stroke="#9DE0AD" points="4.08007812 29.7382812 34.2617188 49.4335938 24.2285156 9.83007812 43.7246094 18.7578125 62.9414062 54.7128906 73.6425781 30.9160156 92.3808594 59.359375 83.328125 3.75585938 103.042969 14.6777344 111.734375 47.1640625 144.171875 28.3574219"></polyline>\n    <circle class="Dot Dot-01" cx="4" cy="29" r="4"></circle>\n    <circle class="Dot Dot-02" cx="34" cy="49" r="4"></circle>\n    <circle class="Dot Dot-03" cx="24" cy="9" r="4"></circle>\n    <circle class="Dot Dot-04" cx="44" cy="19" r="4"></circle>\n    <circle class="Dot Dot-05" cx="63" cy="54" r="4"></circle>\n    <circle class="Dot Dot-06" cx="74" cy="32" r="4"></circle>\n    <circle class="Dot Dot-07" cx="93" cy="60" r="4"></circle>\n    <circle class="Dot Dot-08" cx="83" cy="4" r="4"></circle>\n    <circle class="Dot Dot-09" cx="103" cy="14" r="4"></circle>\n    <circle class="Dot Dot-10" cx="112" cy="47" r="4"></circle>\n    <circle class="Dot Dot-11" cx="144" cy="29" r="4"></circle>\n  </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],254:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="302px" height="98px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <defs>\n    <rect id="path-1" x="0" y="0" width="304" height="96"></rect>\n    <rect id="path-3" x="48" y="0" width="48" height="64"></rect>\n    <mask id="mask-4" x="0" y="0" width="48" height="64" fill="white">\n      <use xlink:href="#path-3"></use>\n    </mask>\n    <rect id="path-5" x="0" y="31" width="49" height="33"></rect>\n    <mask id="mask-6" x="0" y="0" width="49" height="33" fill="white">\n      <use xlink:href="#path-5"></use>\n    </mask>\n    <rect id="path-7" x="95" y="0" width="57" height="24"></rect>\n    <mask id="mask-8" x="0" y="0" width="57" height="24" fill="white">\n      <use xlink:href="#path-7"></use>\n    </mask>\n    <rect id="path-9" x="151" y="8" width="18" height="16"></rect>\n    <mask id="mask-10" x="0" y="0" width="18" height="16" fill="white">\n      <use xlink:href="#path-9"></use>\n    </mask>\n    <rect id="path-11" x="24" y="16" width="25" height="16"></rect>\n    <mask id="mask-12" x="0" y="0" width="25" height="16" fill="white">\n      <use xlink:href="#path-11"></use>\n    </mask>\n    <rect id="path-13" x="95" y="23" width="25" height="25"></rect>\n    <mask id="mask-14" x="0" y="0" width="25" height="25" fill="white">\n      <use xlink:href="#path-13"></use>\n    </mask>\n    <rect id="path-15" x="119" y="23" width="58" height="33"></rect>\n    <mask id="mask-16" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="58" height="33" fill="white">\n      <use xlink:href="#path-15"></use>\n    </mask>\n  </defs>\n  <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n    <g>\n      <g>\n        <g>\n          <mask id="mask-2" fill="white">\n            <use xlink:href="#path-1"></use>\n          </mask>\n          <use id="Rectangle-10" xlink:href="#path-1"></use>\n        </g>\n        <g transform="translate(64, 16)" stroke="#282C2F" stroke-width="2" fill="#9DE0AD">\n          <use class="rect-01" mask="url(#mask-4)" fill-opacity="0.32" xlink:href="#path-3"></use>\n          <use class="rect-02" mask="url(#mask-6)" fill-opacity="0.8" xlink:href="#path-5"></use>\n          <use class="rect-03" mask="url(#mask-8)" fill-opacity="0.639999986" xlink:href="#path-7"></use>\n          <use class="rect-04" mask="url(#mask-10)" fill-opacity="0.160000011" xlink:href="#path-9"></use>\n          <use class="rect-05" mask="url(#mask-12)" fill-opacity="0.48" xlink:href="#path-11"></use>\n          <use class="rect-06" mask="url(#mask-14)" xlink:href="#path-13"></use>\n          <use class="rect-07" mask="url(#mask-16)" fill-opacity="0.800000012" xlink:href="#path-15"></use>\n        </g>\n      </g>\n    </g>\n  </g>\n</svg>\n';
}
return __p;
};

},{"underscore":"underscore"}],255:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="306" height="98" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <circle class="Dot" cx="117" cy="33" r="4"></circle>\n  <circle class="Dot" cx="91" cy="57" r="4"></circle>\n  <circle class="Dot--withSplash Dot--withSplash--01" cx="91" cy="57" r="4"></circle>\n  <circle class="Dot" cx="73" cy="27" r="4"></circle>\n  <circle class="Dot" cx="223" cy="39" r="4"></circle>\n  <circle class="Dot--withSplash Dot--withSplash--02" cx="223" cy="39" r="4"></circle>\n  <circle class="Dot" cx="125" cy="69" r="4"></circle>\n  <circle class="Dot" cx="64" cy="65" r="4"></circle>\n  <circle class="Dot" cx="151" cy="71" r="4"></circle>\n  <circle class="Dot--withSplash Dot--withSplash--03" cx="151" cy="71" r="4"></circle>\n  <circle class="Dot" cx="205" cy="75" r="4"></circle>\n  <circle class="Dot" cx="163" cy="61" r="4"></circle>\n  <circle class="Dot" cx="133" cy="43" r="4"></circle>\n  <circle class="Dot" cx="189" cy="46" r="4"></circle>\n  <circle class="Dot--withSplash Dot--withSplash--04" cx="189" cy="46" r="4"></circle>\n  <circle class="Dot" cx="242" cy="45" r="4"></circle>\n  <circle class="Dot" cx="155" cy="39" r="4"></circle>\n  <circle class="Dot" cx="195" cy="23" r="4"></circle>\n  <circle class="Dot--green Dot-01" cx="91" cy="57" r="4"></circle>\n  <circle class="Dot--green Dot-02" cx="223" cy="39" r="4"></circle>\n  <circle class="Dot--green Dot-03" cx="151" cy="71" r="4"></circle>\n  <circle class="Dot--green Dot-04" cx="189" cy="46" r="4"></circle>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],256:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="304" height="96" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g fill="#636D72" stroke="none" stroke-width="1">\n    <g stroke="#FFFFFF" stroke-linecap="square">\n      <path class="Line" d="M174.5,58.5 L166.5,35.5" id="Line"></path>\n      <path class="Line" d="M174.5,58.5 L145.5,40.5" id="Line"></path>\n      <path class="Line" d="M128.5,29.5 L145.5,40.5" id="Line"></path>\n      <path class="Line" d="M128.5,29.5 L84.5,24.5" id="Line"></path>\n      <path class="Line--withHighlight" d="M174.5,58.5 L136.5,66.5" id="Line"></path>\n      <path class="Line--withHighlight" d="M103.5,53.5 L136.5,66.5" id="Line"></path>\n      <path class="Line--withHighlight" d="M76.5,61.5 L104.5,53.5" id="Line"></path>\n      <path class="Line" d="M174.5,58.5 L162.5,68.5" id="Line"></path>\n      <path class="Line" d="M174.5,58.5 L217.5,71.5" id="Line"></path>\n      <path class="Line" d="M235.5,35.5 L217.5,71.5" id="Line"></path>\n      <path class="Line" d="M235.5,35.5 L253.5,41.5" id="Line"></path>\n      <path class="Line" d="M202.5,42.5 L166.5,35.5" id="Line"></path>\n      <path class="Line" d="M202.5,42.5 L207.5,18.5" id="Line"></path>\n      <path class="Line--withFade" d="M174.5,58.5 L136.5,66.5" id="Line"></path>\n      <path class="Line--withFade" d="M103.5,53.5 L136.5,66.5" id="Line"></path>\n      <path class="Line--withFade" d="M76.5,61.5 L104.5,53.5" id="Line"></path>\n    </g>\n\n    <circle class="Dot Dot-01" cx="129" cy="30" r="4"></circle>\n    <circle class="Dot Dot-02" cx="85" cy="24" r="4"></circle>\n    <circle class="Dot Dot-03" cx="235" cy="36" r="4"></circle>\n    <circle class="Dot Dot-04" cx="163" cy="68" r="4"></circle>\n    <circle class="Dot Dot-05" cx="217" cy="72" r="4"></circle>\n    <circle class="Dot Dot-06" cx="145" cy="40" r="4"></circle>\n    <circle class="Dot Dot-07" cx="201" cy="43" r="4"></circle>\n    <circle class="Dot Dot-08" cx="254" cy="42" r="4"></circle>\n    <circle class="Dot Dot-09" cx="167" cy="36" r="4"></circle>\n    <circle class="Dot Dot-10" cx="207" cy="20" r="4"></circle>\n\n    <circle class="Dot-11 Dot--withHighlight" cx="103" cy="54" r="4"></circle>\n    <circle class="Dot-12 Dot--withHighlight" cx="137" cy="66" r="4"></circle>\n    <circle class="Dot-13 Dot--withHighlight" cx="76" cy="62" r="4"></circle>\n    <circle class="Dot-14 Dot--withHighlight" cx="175" cy="58" r="4"></circle>\n  </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],257:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="306px" height="98px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g fill="#636D72" fill-rule="evenodd" transform="translate(70, 15)">\n    <polygon fill="none" class="Filter-line" stroke="#9DE0AD" points="73.703125 13.6435547 97.5439453 17.5722656 106.554688 42.9824219 92.5517578 55.5849609 63.3261719 53.5224609 54.0126953 15.3515625 59.0839844 11.4414062"></polygon>\n    <circle class="Filter-dotHighlight Filter-dotHighlight--01" cx="95" cy="20" r="4"></circle>\n    <circle class="Filter-dotHighlight Filter-dotHighlight--06" cx="73" cy="24" r="4"></circle>\n    <circle class="Filter-dotHighlight Filter-dotHighlight--02" cx="103" cy="42" r="4"></circle>\n    <circle class="Filter-dotHighlight Filter-dotHighlight--03" cx="91" cy="52" r="4"></circle>\n    <circle class="Filter-dotHighlight Filter-dotHighlight--05" cx="57" cy="14" r="4"></circle>\n    <circle class="Filter-dotHighlight Filter-dotHighlight--04" cx="65" cy="50" r="4"></circle>\n    <circle class="Filter-dot circle08" cx="163" cy="20" r="4"></circle>\n    <circle class="Filter-dot circle07" cx="31" cy="38" r="4"></circle>\n    <circle class="Filter-dot circle06" cx="13" cy="8" r="4"></circle>\n    <circle class="Filter-dot circle05" cx="4" cy="46" r="4"></circle>\n    <circle class="Filter-dot circle04" cx="145" cy="56" r="4"></circle>\n    <circle class="Filter-dot circle03" cx="129" cy="27" r="4"></circle>\n    <circle class="Filter-dot circle02" cx="182" cy="26" r="4"></circle>\n    <circle class="Filter-dot circle01" cx="135" cy="4" r="4"></circle>\n  </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],258:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="302px" height="99px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g fill="#9DE0AD" fill-rule="evenodd">\n    <path d="M0.5,41.5 L305.5,24.5" class="Georeference-street00" stroke="#282C2F" stroke-width="8" stroke-linecap="square"></path>\n    <path d="M134,0 L141,91" class="Georeference-street01" stroke="#282C2F" stroke-width="8" stroke-linecap="square"></path>\n    <path d="M258,0 L265,91" class="Georeference-street02" stroke="#282C2F" stroke-width="8" stroke-linecap="square"></path>\n    <text class="Georeference-point02-text" font-family="Open Sans" font-size="10" font-weight="300" fill="#FFFFFF">\n      <tspan x="63" y="62">-63.578373</tspan>\n      <tspan x="63" y="76">44.642619</tspan>\n    </text>\n    <text class="Georeference-point01-text" font-family="Open Sans" font-size="10" font-weight="300" fill="#FFFFFF">\n      <tspan x="198" y="54">IP 214.80.33.47</tspan>\n    </text>\n    <circle class="Dot Dot-01" fill="#9DE0AD" cx="43" cy="40" r="8"></circle>\n    <circle class="Dot Dot-02" fill="#9DE0AD" cx="183" cy="32" r="8"></circle>\n  </g>\n</svg>\n';
}
return __p;
};

},{"underscore":"underscore"}],259:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="176" height="64" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g fill="#9DE0AD">\n    <polygon fill="none" class="Group-line" stroke="#9EE0AD" points="88.4493047 0.0859375 175.58896 0.0859375 175.58896 23.2574383 135.581141 32.7431641 135.581141 54.9504597 117.092373 54.9504597 101.982508 63.6816406 59.4503976 63.6816406 44.9366094 55.6914063 1 55.6914063 1 24.8914834 44.6201536 24.8914834 56.9346563 0"></polygon>\n    <circle class="Group-point Group-point01" cx="60" cy="60" r="4"></circle>\n    <circle class="Group-point Group-point02" cx="100" cy="4" r="4"></circle>\n    <circle class="Group-point Group-point03" cx="132" cy="52" r="4"></circle>\n    <circle class="Group-point Group-point04" cx="116" cy="52" r="4"></circle>\n    <circle class="Group-point Group-point05" cx="116" cy="36" r="4"></circle>\n    <circle class="Group-point Group-point06" cx="116" cy="20" r="4"></circle>\n    <circle class="Group-point Group-point07" cx="172" cy="20" r="4"></circle>\n    <circle class="Group-point Group-point08" cx="172" cy="4" r="4"></circle>\n    <circle class="Group-point Group-point09" cx="44" cy="28" r="4"></circle>\n    <circle class="Group-point Group-point10" cx="4" cy="28" r="4"></circle>\n    <circle class="Group-point Group-point11" cx="4" cy="52" r="4"></circle>\n    <circle class="Group-point Group-point12" cx="44" cy="52" r="4"></circle>\n    <circle class="Group-point Group-point13" cx="100" cy="60" r="4"></circle>\n    <circle class="Group-point Group-point14" cx="132" cy="36" r="4"></circle>\n    <circle class="Group-point Group-point15" cx="60" cy="4" r="4"></circle>\n  </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],260:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="308px" height="98px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g fill="#636D72" fill-rule="evenodd" transform="translate(55, 15)">\n    <circle class="intersect intersect-layer" fill="#5A7E6D" stroke="#9DE0AD" cx="101" cy="32" r="32"></circle>\n    <circle class="intersect intersect-circle1" cx="57" cy="14" r="4"></circle>\n    <circle class="intersect intersect-circle2" cx="31" cy="38" r="4"></circle>\n    <circle class="intersect intersect-circle3" cx="13" cy="8" r="4"></circle>\n    <circle class="intersect intersect-circle4" cx="163" cy="20" r="4"></circle>\n    <circle class="intersect intersect-circle5" cx="65" cy="50" r="4"></circle>\n    <circle class="intersect intersect-circle6" cx="4" cy="46" r="4"></circle>\n    <circle class="intersect intersect-circle1Highlight" cx="91" cy="52" r="4"></circle>\n    <circle class="intersect intersect-circle7" cx="145" cy="56" r="4"></circle>\n    <circle class="intersect intersect-circle2Highlight" cx="103" cy="42" r="4"></circle>\n    <circle class="intersect intersect-circle3Highlight"  cx="73" cy="24" r="4"></circle>\n    <circle class="intersect intersect-circle4Highlight" cx="129" cy="27" r="4"></circle>\n    <circle class="intersect intersect-circle8" cx="182" cy="26" r="4"></circle>\n    <circle class="intersect intersect-circle5Highlight" cx="95" cy="20" r="4"></circle>\n    <circle class="intersect intersect-circle9" cx="135" cy="4" r="4"></circle>\n  </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],261:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="185px" height="64px" viewBox="512 388 185 64" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g id="Group" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(513.000000, 389.000000)">\n    <polygon class="Path Path-01" stroke="#FFFFFF" points="7.92876627e-08 47 22.7004054 47 22.7004054 62.1132254 0 62.1132254"></polygon>\n    <polygon class="Path Path-03" stroke="#FFFFFF" points="160 24 182.700012 24 182.700012 38.9848139 160 38.9848139"></polygon>\n    <polygon class="Path Path-02" stroke="#FFFFFF" points="87.7216797 0.278320312 110.836973 0.278320312 110.836973 24.2279707 87.8211856 24.2279707"></polygon>\n    <polygon class="Path Path-03Green" stroke="#9DE0AD" points="128 24 182.862039 24 182.862039 55.6141883 128.202651 55.6141883"></polygon>\n    <polygon class="Path Path-01Green" stroke="#9DE0AD" points="0.0502868199 31 47.7467919 31 47.7467919 62.177811 0 62.177811"></polygon>\n    <polygon class="Path Path-02Green" stroke="#9DE0AD" points="63.9970703 0.033203125 110.710209 0.033203125 110.710209 62.0109574 63.8597689 62.0109574"></polygon>\n    <circle class="Dot Dot-01" fill="#FFFFFF" cx="7" cy="55" r="4"></circle>\n    <circle class="Dot Dot-02" fill="#FFFFFF" cx="99" cy="11" r="4"></circle>\n    <circle class="Dot Dot-03"  fill="#FFFFFF" cx="171" cy="31" r="4"></circle>\n  </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],262:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="306" height="98" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g transform="translate(50, 20)">\n    <circle class="Dot Dot--01 Dot--gray" cx="4" cy="46" r="4"></circle>\n    <circle class="Dot Dot--02 Dot--gray" cx="31" cy="38" r="4"></circle>\n    <circle class="Dot Dot--03 Dot--gray" cx="13" cy="8" r="4"></circle>\n    <circle class="Dot Dot--04 Dot--green" cx="57" cy="14" r="4"></circle>\n    <circle class="Dot Dot--05 Dot--green" cx="65" cy="50" r="4"></circle>\n    <circle class="Dot Dot--06 Dot--green" cx="91" cy="52" r="4"></circle>\n    <circle class="Dot Dot--07 Dot--green" cx="103" cy="42" r="4"></circle>\n    <circle class="Dot Dot--08 Dot--green" cx="73" cy="24" r="4"></circle>\n    <circle class="Dot Dot--09 Dot--green" cx="95" cy="20" r="4"></circle>\n    <circle class="Dot Dot--10 Dot--darkGray" cx="145" cy="56" r="4"></circle>\n    <circle class="Dot Dot--11 Dot--darkGray" cx="129" cy="27" r="4"></circle>\n    <circle class="Dot Dot--12 Dot--darkGray" cx="135" cy="4" r="4"></circle>\n    <circle class="Dot Dot--13 Dot--white" cx="163" cy="20" r="4"></circle>\n    <circle class="Dot Dot--14 Dot--white" cx="182" cy="26" r="4"></circle>\n  </g>\n</svg>\n';
}
return __p;
};

},{"underscore":"underscore"}],263:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="306px" height="98px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g id="Mod-Analysis" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n    <g fill="#9DE0AD">\n      <text x="8" y="19" class="Text Text-LH" font-family="OpenSans, Open Sans" font-size="10" font-weight="normal">\n        '+
((__t=( _t('components.modals.add-analysis.option-types.moran-cluster.low-high') ))==null?'':_.escape(__t))+
'\n      </text>\n      <text x="227" y="19" class="Text Text-HH" font-family="OpenSans, Open Sans" font-size="10" font-weight="normal">\n        '+
((__t=( _t('components.modals.add-analysis.option-types.moran-cluster.high-high') ))==null?'':_.escape(__t))+
'\n      </text>\n      <text x="233" y="85" class="Text Text-HL" font-family="OpenSans, Open Sans" font-size="10" font-weight="normal">\n        '+
((__t=( _t('components.modals.add-analysis.option-types.moran-cluster.high-low') ))==null?'':_.escape(__t))+
'\n      </text>\n      <text x="10" y="85" class="Text Text-LL" font-family="OpenSans, Open Sans" font-size="10" font-weight="normal">\n        '+
((__t=( _t('components.modals.add-analysis.option-types.moran-cluster.low-low') ))==null?'':_.escape(__t))+
'\n      </text>\n    </g>\n    <g fill="#FFF">\n      <circle class="Dot Dot-04" fill-opacity="0.4" cx="106" cy="57" r="4"></circle>\n      <circle class="Dot Dot-04" fill-opacity="0.4" cx="137" cy="66" r="4"></circle>\n      <circle class="Dot Dot-04" fill-opacity="0.4" cx="79" cy="62" r="4"></circle>\n      <circle class="Dot Dot-06" fill-opacity="0.6" cx="193" cy="70" r="4"></circle>\n      <circle class="Dot Dot-06" fill-opacity="0.6" cx="175" cy="58" r="4"></circle>\n      <circle class="Dot Dot-08" fill-opacity="0.8" cx="129" cy="30" r="4"></circle>\n      <circle class="Dot Dot-08" fill-opacity="0.8" cx="145" cy="40" r="4"></circle>\n      <circle class="Dot Dot-1" cx="231" cy="36" r="4"></circle>\n      <circle class="Dot Dot-1" cx="197" cy="40" r="4"></circle>\n      <circle class="Dot Dot-1" cx="250" cy="38" r="4"></circle>\n      <circle class="Dot Dot-1" cx="167" cy="36" r="4"></circle>\n      <circle class="Dot Dot-1" cx="203" cy="20" r="4"></circle>\n    </g>\n    <g stroke="#9DE0AD">\n      <path d="M0,49 L304,49" class="Line Line-horizontal" stroke-dasharray="2,3"></path>\n      <path d="M152,0 L152,98" class="Line Line-vertical" stroke-dasharray="2,3"></path>\n    </g>\n  </g>\n</svg>\n';
}
return __p;
};

},{"underscore":"underscore"}],264:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='  <svg width="306px" height="98px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g transform="translate(87, 22)" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" stroke-linecap="square">\n      <path class="Arrow-04" d="M98.5,45.5 L97.5,40.5" stroke="#9CE0AC"></path>\n      <path class="Arrow-04" d="M98.5,45.5 L92.5,46.5" stroke="#9CE0AC"></path>\n      <path class="Line-04" d="M75.5,34.5 L98.5,45.5" stroke="#9DE0AD"></path>\n\n      <path class="Line-03" d="M0.5,44.5 L3.5,39.5" stroke="#9CE0AC"></path>\n      <path class="Line-03" d="M0.5,44.5 L5.5,47.5" stroke="#9CE0AC"></path>\n      <path class="Line-03" d="M0.5,44.5 L55.5,32.5" stroke="#9DE0AD"></path>\n\n      <g transform="translate(75.000000, 1.000000)">\n        <path class="Arrow-01" d="M31.5,8.5 L32.5,2.5" stroke="#95D6A6"></path>\n        <path class="Arrow-01" d="M26.5,0.5 L32.5,2.5" stroke="#95D6A6"></path>\n        <path class="Line-01" d="M0.5,18.5 L32.5,2.5" stroke="#9DE0AD"></path>\n      </g>\n\n      <g transform="translate(19.000000, 0.000000)" stroke="#979797">\n        <path class="Arrow-02" d="M36.5,19.5 L35.5,14.5"></path>\n        <path class="Arrow-02" d="M36.5,19.5 L31.5,21.5"></path>\n        <path class="Line-02" d="M0.5,0.5 L36.5,19.5"></path>\n      </g>\n    </g>\n  </g>\n  <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n    <g stroke="#636D72">\n      <path d="M0,49 L304,49" class="Line Line-horizontal" stroke-dasharray="2,3"></path>\n      <path d="M152,0 L152,98" class="Line Line-vertical" stroke-dasharray="2,3"></path>\n    </g>\n  </g>\n  <g transform="translate(72, 11)">\n    <circle class="Dot Dot--center" cx="80" cy="38" r="4" stroke="#9DE0AD" fill="#2E3C43"></circle>\n    <circle class="Dot Dot-01" fill="#9DE0AD" cx="133" cy="10" r="4"></circle>\n    <circle class="Dot Dot-02" fill="#979EA1" cx="24" cy="4" r="4"></circle>\n    <circle class="Dot Dot-03" fill="#9DE0AD" cx="4" cy="57" r="4"></circle>\n    <circle class="Dot Dot-04" fill="#9DE0AD" cx="122" cy="61" r="4"></circle>\n  </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],265:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="306" height="98" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g transform="translate(30, 16)" fill="#9DE0AD">\n    <circle class="Dot" cx="42" cy="29" r="4"></circle>\n    <circle class="Dot--withFadeOut Dot-01" cx="72" cy="49" r="4"></circle>\n    <circle class="Dot" cx="52" cy="54" r="4"></circle>\n    <circle class="Dot--withFadeOut Dot-02" cx="4" cy="54" r="4"></circle>\n    <circle class="Dot--withFadeOut Dot-03" cx="28" cy="14" r="4"></circle>\n    <circle class="Dot" cx="188" cy="6" r="4"></circle>\n    <circle class="Dot" cx="196" cy="46" r="4"></circle>\n    <circle class="Dot--withFadeOut Dot-03" cx="159" cy="25" r="4"></circle>\n    <circle class="Dot" cx="228" cy="26" r="4"></circle>\n    <circle class="Dot" cx="141" cy="14" r="4"></circle>\n    <circle class="Dot--withFadeOut Dot-04" cx="121" cy="4" r="4"></circle>\n    <circle class="Dot" cx="101" cy="54" r="4"></circle>\n    <circle class="Dot" cx="182" cy="29" r="4"></circle>\n    <circle class="Dot--withFadeOut Dot-05" cx="131" cy="60" r="4"></circle>\n    <circle class="Dot" cx="82" cy="19" r="4"></circle>\n    <circle class="Dot" cx="150" cy="47" r="4"></circle>\n    <circle class="Dot--withFadeOut Dot-06" cx="62" cy="9" r="4"></circle>\n    <circle class="Dot" cx="109" cy="32" r="4"></circle>\n  </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],266:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+=''+
((__t=( label ))==null?'':_.escape(__t))+
'\n';
}
return __p;
};

},{"underscore":"underscore"}],267:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Modal-navigation">\n  <ul class="Modal-navigationInner CDB-Text is-semibold CDB-Size-medium js-menu"></ul>\n</div>\n<div class="Modal-inner Modal-inner--with-navigation js-content">\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],268:[function(require,module,exports){
var Backbone = require('backbone');
var XYZModel = require('./xyz/xyz-model');
var mosaicThumbnail = require('../../mosaic/mosaic-thumbnail.tpl');
var MapboxModel = require('./mapbox/mapbox-model');
var WMSModel = require('./wms/wms-model');
var TileJSONModel = require('./tilejson/tilejson-model');
var NASAModel = require('./nasa/nasa-model');

/**
 * Add basemap model
 */
module.exports = Backbone.Model.extend({
  defaults: {
    tabs: undefined,
    contentPane: 'tabs', // [tabs, loading, error]
    currentTab: 'xyz' // [xyz, wms, nasa, mapbox, tilejson, nasa]
  },

  initialize: function (attrs, opts) {
    if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
    if (!opts.basemapsCollection) throw new Error('basemapsCollection is required');
    if (!opts.customBaselayersCollection) throw new Error('customBaselayersCollection is required');

    this._layerDefinitionsCollection = opts.layerDefinitionsCollection;
    this._basemapsCollection = opts.basemapsCollection;
    this._customBaselayersCollection = opts.customBaselayersCollection;
    this._currentTab = opts.currentTab;

    this._initTabs();
    this._initBinds();
  },

  activeTabModel: function () {
    return this.get('tabs').findWhere({ name: this.get('currentTab') });
  },

  canSaveBasemap: function () {
    return this.get('contentPane') === 'tabs' && this._layerToSave();
  },

  saveBasemap: function () {
    var self = this;

    this.set('contentPane', 'addingBasemap');

    var customBaselayerModel = this._layerToSave();
    var attrs = customBaselayerModel.getAttributes();

    if (this.activeTabModel().hasAlreadyAddedLayer(this._customBaselayersCollection)) {
      // update selected in basemaps collection
      this._basemapsCollection.updateSelected(attrs.className);
      // update category if needed in basemaps collection,
      // this is the case for mapbox basemaps which were stored without category in the editor
      this._basemapsCollection.updateCategory(attrs.className, attrs.category);

      // update baselayer
      this._onBasemapSaved(attrs);
    } else {
      // Add to customBaselayersCollection before saving, so save URL resolves to the expected endpoint
      this._customBaselayersCollection.add(customBaselayerModel);

      customBaselayerModel.save({}, {
        success: function (mdl, mdlAttrs) {
          var options = mdlAttrs.options;

          var name = options.name ? options.name : 'Custom basemap ' + mdlAttrs.order;
          var className = options.className;
          var urlTemplate = options.urlTemplate;

          // add in basemaps collection
          self._basemapsCollection.add({
            id: mdlAttrs.id,
            urlTemplate: urlTemplate,
            maxZoom: options.minZoom || 21,
            minZoom: options.minZoom || 0,
            name: name,
            className: className,
            attribution: options.attribution,
            category: options.category,
            tms: options.tms,
            type: options.type,
            val: className,
            label: name,
            template: function (imgURL) {
              return mosaicThumbnail({
                imgURL: imgURL
              });
            }
          });

          // update baselayer
          self._onBasemapSaved(attrs);
        },
        error: function () {
          // Cleanup, remove layer it could not be saved!
          self._customBaselayersCollection.remove(customBaselayerModel);
          self.set('contentPane', 'addBasemapFailed');
        }
      });
    }
  },

  _onBasemapSaved: function (layerAttrs) {
    // Update baseLayer
    this._layerDefinitionsCollection.setBaseLayer(layerAttrs);

    this.trigger('saveBasemapDone');
  },

  _initTabs: function () {
    var tabs = new Backbone.Collection([
      new XYZModel(),
      new MapboxModel(),
      new WMSModel(null, {
        customBaselayersCollection: this._customBaselayersCollection
      }),
      new TileJSONModel(),
      new NASAModel()
    ]);
    this.set({
      tabs: tabs,
      currentTab: this._currentTab || tabs.first().get('name')
    });
  },

  _initBinds: function () {
    this.get('tabs').each(function (tabModel) {
      tabModel.bind('saveBasemap', this.saveBasemap, this);
    }, this);
  },

  _layerToSave: function () {
    return this.activeTabModel().get('layer');
  }

});

},{"../../mosaic/mosaic-thumbnail.tpl":462,"./mapbox/mapbox-model":272,"./nasa/nasa-model":275,"./tilejson/tilejson-model":282,"./wms/wms-model":292,"./xyz/xyz-model":295,"backbone":"backbone"}],269:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./add-basemap.tpl');
var TabPaneView = require('../../tab-pane/tab-pane-view');
var TabPaneCollection = require('../../tab-pane/tab-pane-collection');
var ViewFactory = require('../../view-factory');
var renderLoading = require('../../loading/render-loading');
var ErrorView = require('../../error/error-view');
var _ = require('underscore');
var TabsView = require('./tabs-view');

/**
 * Add basemap dialog
 */
module.exports = CoreView.extend({

  className: 'Dialog-content Dialog-content--expanded',

  events: {
    'click .js-ok': 'ok'
  },

  initialize: function (opts) {
    if (!opts.modalModel) throw new TypeError('modalModel is required');
    if (!opts.createModel) throw new TypeError('createModel is required');

    this._modalModel = opts.modalModel;
    this._createModel = opts.createModel;
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());
    this._initViews();
  },

  _initBinds: function () {
    this._createModel.bind('saveBasemapDone', this._modalModel.destroy.bind(this._modalModel), this);
    this._createModel.bind('change:contentPane', this._onChangeContentView, this);
    this.add_related_model(this._createModel);
  },

  _onChangeContentView: function () {
    var context = this._createModel.get('contentPane');
    var paneModel = _.first(this._tabPaneCollection.where({ name: context }));
    paneModel.set('selected', true);
  },

  _initViews: function () {
    var self = this;

    this._submitButtom = this.$('.js-ok');
    this._modalFooter = this.$('.js-Modal-footer');

    this._tabPaneCollection = new TabPaneCollection([
      {
        name: 'tabs',
        selected: this._createModel.get('contentPane') === 'tabs',
        createContentView: function () {
          return new TabsView({
            model: self._createModel,
            submitButton: self._submitButtom,
            modalFooter: self._modalFooter
          });
        }
      }, {
        name: 'addingBasemap',
        selected: this._createModel.get('contentPane') === 'addingBasemap',
        createContentView: function () {
          self._disableModalFooter(true);

          return ViewFactory.createByHTML(
            renderLoading({
              title: _t('components.modals.add-basemap.adding-basemap')
            })
          );
        }
      }, {
        name: 'addBasemapFailed',
        selected: this._createModel.get('contentPane') === 'addBasemapFailed',
        createContentView: function () {
          return new ErrorView({
            title: _t('components.modals.add-basemap.add-basemap-error')
          });
        }
      }
    ]);

    var tabPaneView = new TabPaneView({
      collection: this._tabPaneCollection
    });
    this.addView(tabPaneView);
    this.$('.js-content-container').append(tabPaneView.render().el);
  },

  _disableModalFooter: function (disable) {
    this._modalFooter.toggleClass('is-disabled', disable);
  },

  ok: function () {
    if (this._createModel.canSaveBasemap()) {
      this._createModel.saveBasemap();
    }
  }

});

},{"../../error/error-view":67,"../../loading/render-loading":230,"../../tab-pane/tab-pane-collection":538,"../../tab-pane/tab-pane-view":549,"../../view-factory":594,"./add-basemap.tpl":270,"./tabs-view":278,"backbone/core-view":1127,"underscore":"underscore"}],270:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Modal">\n  <div class="Modal-header">\n    <div class="Modal-headerContainer">\n      <h2 class="CDB-Text CDB-Size-huge is-light u-mainTextColor u-bSpace">'+
((__t=( _t('components.modals.add-basemap.modal-title') ))==null?'':_.escape(__t))+
'</h2>\n      <h3 class="CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( _t('components.modals.add-basemap.modal-desc') ))==null?'':_.escape(__t))+
'</h3>\n    </div>\n  </div>\n  <div class="Modal-container">\n    <div class="Tab-pane js-content-container">\n    </div>\n  </div>\n  <div class="Modal-footer js-Modal-footer">\n    <div class="Modal-footerContainer u-flex u-justifyEnd">\n      <button class="CDB-Button CDB-Button--primary is-disabled js-ok ok">\n        <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.add-basemap.add-btn') ))==null?'':_.escape(__t))+
'</span>\n      </button>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],271:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-alignCenter Modal-basemapContainer">\n  <h3 class="CDB-Text CDB-Size-large u-mainTextColor Modal-titleBasemap">'+
((__t=( _t('components.modals.add-basemap.mapbox.insert') ))==null?'':_.escape(__t))+
'</h3>\n  <div class="CDB-Text u-flex u-alignCenter ">\n    <label class="Metadata-label Metadata-label--big CDB-Text CDB-Size-small is-semibold u-upperCase u-ellipsis">'+
((__t=( _t('components.modals.add-basemap.mapbox.enter') ))==null?'':_.escape(__t))+
'</label>\n    <div class="Form-rowData Form-rowData--longer">\n      <input type="text" class="CDB-InputText CDB-Text js-url" value="'+
((__t=( url ))==null?'':_.escape(__t))+
'" placeholder="'+
((__t=( _t('components.modals.add-basemap.xyz.eg') ))==null?'':_.escape(__t))+
' username.ab12cd3">\n    </div>\n  </div>\n  <div class="u-tSpace-xl CDB-Text u-flex u-alignCenter">\n    <label class="Metadata-label Metadata-label--big CDB-Text CDB-Size-small is-semibold u-upperCase u-ellipsis">'+
((__t=( _t('components.modals.add-basemap.mapbox.enter-token') ))==null?'':_.escape(__t))+
'</label>\n    <div class="Form-rowData Form-rowData--longer">\n      <input type="text" class="CDB-InputText CDB-Text js-access-token" value="'+
((__t=( accessToken ))==null?'':_.escape(__t))+
'" placeholder="'+
((__t=( _t('components.modals.add-basemap.xyz.eg') ))==null?'':_.escape(__t))+
' pk.bfg32ewdsadeyJ1Ijoi…">\n      <div class="XYZPanel-error CDB-InfoTooltip CDB-InfoTooltip--left is-error CDB-Text CDB-Size-medium CDB-InfoTooltip-text js-error '+
((__t=( lastErrorMsg ? 'is-visible' : '' ))==null?'':_.escape(__t))+
'">'+
((__t=( lastErrorMsg ))==null?'':_.escape(__t))+
'</div>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],272:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var MapboxView = require('./mapbox-view');
var MapboxToTileLayerFactory = require('./mapbox-to-tile-layer-factory');

/**
 * View model for Mapbox tab content.
 */

module.exports = Backbone.Model.extend({

  defaults: {
    name: 'mapbox',
    label: 'Mapbox',
    currentView: 'enterURL', //, validatingInputs, valid
    lastErrorMsg: '', // set if fails to save
    layer: undefined // will be set when valid
  },

  createView: function (opts) {
    if (!opts.submitButton) throw new Error('submitButton is required');
    if (!opts.modalFooter) throw new Error('modalFooter is required');

    this._submitButton = opts.submitButton;
    this._modalFooter = opts.modalFooter;

    this.set({
      currentView: 'enterURL',
      layer: undefined
    });

    return new MapboxView({
      model: this,
      submitButton: this._submitButton,
      modalFooter: this._modalFooter
    });
  },

  hasAlreadyAddedLayer: function (userLayers) {
    var urlTemplate = this.get('layer').get('urlTemplate');
    return _.any(userLayers.isCustomCategory(), function (customLayer) {
      return customLayer.get('urlTemplate') === urlTemplate;
    });
  },

  validateInputs: function (url, accessToken) {
    this.set({
      currentView: 'validatingInputs',
      url: url,
      accessToken: accessToken
    });

    var self = this;

    var mf = new MapboxToTileLayerFactory({
      url: url,
      accessToken: accessToken
    });
    mf.createTileLayer({
      success: function (tileLayer) {
        self.set('layer', tileLayer);
        self.trigger('saveBasemap');
      },
      error: function (errorMsg) {
        self.set({
          currentView: 'enterURL',
          lastErrorMsg: errorMsg
        });
      }
    });
  }

});

},{"./mapbox-to-tile-layer-factory":273,"./mapbox-view":274,"backbone":"backbone","underscore":"underscore"}],273:[function(require,module,exports){
/* global Image, location */

var $ = require('jquery');
var _ = require('underscore');
var Backbone = require('backbone');
var CustomBaselayerModel = require('../../../../data/custom-baselayer-model');

/**
 * Factory to create a CustomBaselayerModel from a given URL and access token tuple for Mapbox.
 */

module.exports = Backbone.Model.extend({

  defaults: {
    url: '',
    accessToken: ''
  },

  _MAPBOX: {
    version: 4,
    https: 'https://dnv9my2eseobd.cloudfront.net',
    base: 'https://a.tiles.mapbox.com/'
  },

  /**
   * @param {Object} callbacks
   *   success {Function} given a new TileLayer object
   *   error {Function} given an error explanation
   */
  createTileLayer: function (callbacks) {
    var val = this.get('url');
    var url = this._lowerXYZ(val);
    var access_token = this.get('accessToken');
    var type = 'json';
    var subdomains = ['a', 'b', 'c'];
    var mapbox_id;

    // Detects the URL's type
    if (url.indexOf('{x}') < 0 && url.indexOf('tiles.mapbox.com') !== -1) {
      mapbox_id = this._getMapBoxMapID(url);
      if (mapbox_id) {
        type = 'mapbox_id';
        url = mapbox_id;
      }
    } else if (url.indexOf('{x}') !== -1) {
      type = 'xyz';
      url = url.replace(/\{s\}/g, function () {
        return subdomains[Math.floor(Math.random() * 3)];
      })
        .replace(/\{x\}/g, '0')
        .replace(/\{y\}/g, '0')
        .replace(/\{z\}/g, '0');
    } else if (url && url.indexOf('http') < 0 && url.match(/(.*?)\.(.*)/) != null && url.match(/(.*?)\.(.*)/).length === 3) {
      type = 'mapbox_id';
      mapbox_id = val;
    } else { // If not, check https
      url = this._fixHTTPS(url);
    }

    var self = this;
    var image;
    if (type === 'mapbox') {
      callbacks.success(this._newTileLayer({ tiles: [url] }));
    } else if (type === 'xyz') {
      image = new Image();
      image.onload = function () {
        callbacks.success(self._newTileLayer({
          tiles: [self._lowerXYZ(val)]
        }));
      };
      image.onerror = function () {
        callbacks.error(self._errorToMsg());
      };
      image.src = url;
    } else if (type === 'mapbox_id') {
      var params = '?access_token=' + access_token;
      var base_url = this._MAPBOX.base + 'v' + this._MAPBOX.version + '/' + mapbox_id;
      var tile_url = base_url + '/{z}/{x}/{y}.png' + params;
      var json_url = base_url + '.json' + params;

      // JQuery has a faulty implementation of the getJSON method and doesn't return
      // a 404, so we use a timeout. TODO: replace with CORS
      var errorTimeout = setTimeout(function () {
        callbacks.error(self._errorToMsg());
      }, 5000);

      $.ajax({
        url: json_url,
        success: function (data) {
          clearTimeout(errorTimeout);
          callbacks.success(self._newTileLayer({
            tiles: [tile_url],
            attribution: data.attribution,
            minzoom: data.minzoom,
            maxzoom: data.maxzoom,
            name: data.name
          }));
        },
        error: function (e) {
          clearTimeout(errorTimeout);
          callbacks.error(self._errorToMsg(e));
        }
      });
    } else {
      callbacks.error(this._errorToMsg());
    }
  },

  _newTileLayer: function (data) {
    // Check if the respond is an array
    // In that case, get only the first
    if (_.isArray(data) && _.size(data) > 0) {
      data = _.first(data);
    }

    var url = data.tiles[0];
    var attribution = data.attribution || null;

    var layer = new CustomBaselayerModel({
      urlTemplate: url,
      attribution: attribution,
      maxZoom: data.maxzoom || 21,
      minZoom: data.minzoom || 0,
      name: data.name || '',
      category: 'Mapbox',
      type: 'Tiled'
    });
    layer.set('className', layer._generateClassName(url));

    return layer;
  },

  _errorToMsg: function (error) {
    if (typeof error === 'object' || !error) {
      if (error && error.status && error.status === 401) {
        return _t('components.modals.add-basemap.mapbox.error');
      } else {
        return _t('components.modals.add-basemap.mapbox.invalid');
      }
    }

    return error;
  },

  _lowerXYZ: function (url) {
    return url.replace(/\{S\}/g, '{s}')
      .replace(/\{X\}/g, '{x}')
      .replace(/\{Y\}/g, '{y}')
      .replace(/\{Z\}/g, '{z}');
  },

  // Extracts the Mapbox MapId from a Mapbox URL
  _getMapBoxMapID: function (url) {
    // http://d.tiles.mapbox.com/v3/{user}.{map}/3/4/3.png
    // http://a.tiles.mapbox.com/v3/{user}.{map}/page.html
    // http://a.tiles.mapbox.com/v4/{user}.{map}.*
    var reg1 = /https?:\/\/[a-z]?\.?tiles\.mapbox.com\/v(\d)\/([^\/.]*)\.([^\/.]*)/;

    // https://tiles.mapbox.com/{user}/edit/{map}?newmap&preset=Streets#3/0.00/-0.09
    var reg2 = /https?:\/\/tiles\.mapbox\.com\/(.*?)\/edit\/(.*?)(\?|#)/;

    var match = '';

    // Check first expresion
    match = url.match(reg1);

    if (match && match[1] && match[2]) {
      return match[2] + '.' + match[3];
    }

    // Check second expresion
    match = url.match(reg2);

    if (match && match[1] && match[2]) {
      return match[1] + '.' + match[2];
    }
  },

  /**
   * return a https url if the current application is loaded from https
   */
  _fixHTTPS: function (url, loc) {
    loc = loc || location;

    // fix the url to https or http
    if (url.indexOf('https') !== 0 && loc.protocol === 'https:') {
      // search for mapping
      var i = url.indexOf('mapbox.com');
      if (i !== -1) {
        return this._MAPBOX.https + url.substr(i + 'mapbox.com'.length);
      }
      return url.replace(/http/, 'https');
    }
    return url;
  }

});

},{"../../../../data/custom-baselayer-model":619,"backbone":"backbone","jquery":"jquery","underscore":"underscore"}],274:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var ViewFactory = require('../../../view-factory');
var renderLoading = require('../../../loading/render-loading');
var enterUrl = require('./enter-url.tpl');

/**
 * Represents the Mapbox tab content.
 */

module.exports = CoreView.extend({

  events: {
    'keydown': '_onKeyDown',
    'keyup': '_onKeyUp'
  },

  initialize: function (opts) {
    if (!opts.submitButton) throw new Error('submitButton is required');
    if (!opts.modalFooter) throw new Error('modalFooter is required');

    this._submitButton = opts.submitButton;
    this._modalFooter = opts.modalFooter;
    this._onClickBinded = this._onClickOK.bind(this);

    this._bindSubmitButton();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();

    var view;

    switch (this.model.get('currentView')) {
      case 'validatingInputs':
        this._disableModalFooter(true);

        view = ViewFactory.createByHTML(
          renderLoading({
            title: _t('components.modals.add-basemap.validating')
          })
        );
        break;
      case 'enterURL':
      default:
        this._disableModalFooter(false);

        view = ViewFactory.createByHTML(
          enterUrl({
            url: this.model.get('url'),
            accessToken: this.model.get('accessToken'),
            lastErrorMsg: this.model.get('lastErrorMsg')
          })
        );
    }
    this.addView(view);
    this.$el.append(view.render().el);

    this._updateOkBtn();
    this._onKeyUp();
    return this;
  },

  _initBinds: function () {
    this.model.bind('change', this.render, this);
  },

  _hasValues: function () {
    return this._urlVal() && this._accessToken();
  },

  _urlVal: function () {
    return this.$('.js-url').val();
  },

  _accessToken: function () {
    return this.$('.js-access-token').val();
  },

  _onClickOK: function (e) {
    this.killEvent(e);

    if (this._hasValues()) {
      var url = this._urlVal();
      var accessToken = this._accessToken();

      this.model.validateInputs(url, accessToken);
    }
  },

  _disableModalFooter: function (disable) {
    this._modalFooter.toggleClass('is-disabled', disable);
  },

  _updateOkBtn: function () {
    this._submitButton.find('span').text(_t('components.modals.add-basemap.add-btn'));
  },

  _onKeyDown: function (e) {
    e.stopPropagation();

    this.$('.js-error').removeClass('is-visible');
  },

  _onKeyUp: function (e) {
    e && e.stopPropagation();
    this._submitButton.toggleClass('is-disabled', !this._hasValues());
  },

  _bindSubmitButton: function () {
    this._submitButton.on('click', this._onClickBinded);
  },

  _unBindSubmitButton: function () {
    this._submitButton.off('click', this._onClickBinded);
  },

  clean: function () {
    this._unBindSubmitButton();
    CoreView.prototype.clean.call(this);
  }

});

},{"../../../loading/render-loading":230,"../../../view-factory":594,"./enter-url.tpl":271,"backbone/core-view":1127}],275:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var moment = require('moment');
var NASAView = require('./nasa-view');
var CustomBaselayerModel = require('../../../../data/custom-baselayer-model');

var TYPES = {
  day: {
    url: 'http://map1.vis.earthdata.nasa.gov/wmts-webmerc/MODIS_Terra_CorrectedReflectance_TrueColor/default/<%- date %>/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpeg',
    limit: '2012-05-01',
    default: '2012-05-01',
    attribution: '<a href="http://earthdata.nasa.gov/gibs" target="_blank">NASA EOSDIS GIBS</a>',
    name: 'NASA Terra',
    maxZoom: 9,
    minZoom: 1
  },
  night: {
    url: 'http://map1.vis.earthdata.nasa.gov/wmts-webmerc/VIIRS_CityLights_2012/default/<%- date %>/GoogleMapsCompatible_Level8/{z}/{y}/{x}.jpeg',
    limit: '2012-05-01',
    default: '2012-05-02',
    attribution: '<a href="http://earthdata.nasa.gov/gibs" target="_blank">NASA EOSDIS GIBS</a>',
    name: 'NASA Earth at night',
    maxZoom: 8,
    minZoom: 1
  }
};

/**
 * View model for NASA tab content.
 */

module.exports = Backbone.Model.extend({

  defaults: {
    name: 'nasa',
    label: 'NASA',
    layer: undefined, // gets set on dayOrNight/date changes
    layerType: 'day',
    date: undefined, // for date picker
    current: undefined,
    format: 'Y-m-d' // YYYY-MM-DD
  },

  initialize: function () {
    this._initBinds();
  },

  createView: function (opts) {
    if (!opts.submitButton) throw new Error('submitButton is required');

    this._submitButton = opts.submitButton;

    var utc = new Date().getTimezoneOffset();
    var today = moment(new Date()).utcOffset(utc).format('YYYY-MM-DD');
    var yesterday = moment(new Date()).utcOffset(utc).subtract(1, 'days').format('YYYY-MM-DD');

    this.set({
      current: today,
      date: yesterday
    });

    return new NASAView({
      model: this,
      submitButton: this._submitButton
    });
  },

  hasAlreadyAddedLayer: function (userLayers) {
    var urlTemplate = this.get('layer').get('urlTemplate');
    return _.any(userLayers.isCustomCategory(), function (customLayer) {
      return customLayer.get('urlTemplate') === urlTemplate;
    });
  },

  _initBinds: function () {
    this.bind('change:date change:layerType', this._onChange, this);
  },

  _onChange: function () {
    var dateStr = this.get('date');
    var layerType = this.get('layerType');

    var url = _.template(TYPES[layerType].url)({
      date: dateStr
    });

    var name = TYPES[layerType].name;

    if (layerType === 'day') {
      name = name + ' ' + dateStr;
    }

    var layer = new CustomBaselayerModel({
      urlTemplate: url,
      attribution: TYPES[layerType].attribution,
      maxZoom: TYPES[layerType].maxZoom,
      minZoom: TYPES[layerType].minZoom,
      name: name,
      category: 'NASA',
      type: 'Tiled'
    });
    layer.set('className', layer._generateClassName(url));

    this.set('layer', layer);
  }

});

},{"../../../../data/custom-baselayer-model":619,"./nasa-view":276,"backbone":"backbone","moment":"moment","underscore":"underscore"}],276:[function(require,module,exports){
var $ = require('jquery');
var moment = require('moment');
var CoreView = require('backbone/core-view');
var DatePickerView = require('../../../../components/date-picker/date-picker-view');
var EditFieldModel = require('../../../../components/date-picker/edit-field-model');
var TipsyTooltipView = require('../../../../components/tipsy-tooltip-view');
var template = require('./nasa.tpl');

/**
 * Represents the NASA tab content
 */

module.exports = CoreView.extend({

  options: {
    dateFormat: 'YYYY-MM-DD'
  },

  events: {
    'click .js-day': '_onChangeToDay',
    'click .js-night': '_onChangeToNight'
  },

  initialize: function (opts) {
    if (!opts.submitButton) throw new Error('submitButton is required');

    this._submitButton = opts.submitButton;
    this.dateModel = new EditFieldModel({
      value: this.model.get('date'),
      type: 'date'
    });

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();

    this._updateOkBtn();
    this._disableOkBtn(false);

    this.$el.html(
      template({
        layerType: this.model.get('layerType')
      })
    );

    this._renderDatePicker();

    return this;
  },

  _initBinds: function () {
    this.model.bind('change:layerType', function () {
      this.dateModel.set('readOnly', this.model.get('layerType') === 'night');
      this.render();
    }, this);
    this.dateModel.bind('change:value', function () {
      var date = moment(this.dateModel.get('value')).format(this.options.dateFormat);
      this.model.set('date', date);
    }, this);
    this.add_related_model(this.dateModel);
  },

  _renderDatePicker: function () {
    // Date picker
    var datepicker = this.datepicker = new DatePickerView({
      className: 'DatePicker DatePicker--withBorder',
      model: this.dateModel
    });
    this._$datePicker().html(datepicker.render().el);
    this.addView(datepicker);

    // Disabled tooltip
    if (this.dateModel.get('readOnly')) {
      var tooltip = new TipsyTooltipView({
        el: this._$datePicker(),
        title: function (e) {
          return $(this).attr('data-title');
        }
      });
      this.addView(tooltip);
    }
  },

  _onChangeToNight: function () {
    this.model.set('layerType', 'night');
  },

  _onChangeToDay: function () {
    this.model.set('layerType', 'day');
  },

  _$datePicker: function () {
    return this.$('.js-datePicker');
  },

  _updateOkBtn: function () {
    this._submitButton.find('span').text(_t('components.modals.add-basemap.add-btn'));
  },

  _disableOkBtn: function (disable) {
    this._submitButton.toggleClass('is-disabled', disable);
  }

});

},{"../../../../components/date-picker/date-picker-view":64,"../../../../components/date-picker/edit-field-model":66,"../../../../components/tipsy-tooltip-view":589,"./nasa.tpl":277,"backbone/core-view":1127,"jquery":"jquery","moment":"moment"}],277:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-alignCenter Modal-basemapContainer">\n  <h3 class="CDB-Text CDB-Size-large u-mainTextColor Modal-titleBasemap">'+
((__t=( _t('components.modals.add-basemap.nasa.select') ))==null?'':_.escape(__t))+
'</h3>\n  <div class="CDB-Text u-flex u-alignCenter">\n    <div class="Form-rowData Form-rowData--short Form-rowData--alignLeft">\n      <div class="Form-rowData Form-rowData--full">\n        <div class="RadioButton js-day">\n          <button type="button" class="RadioButton-input ';
 if (layerType === 'day') { 
__p+='is-checked';
 } 
__p+='"></button>\n          <label class="Metadata-label Metadata-label--auto CDB-Text CDB-Size-small is-semibold u-upperCase u-ellipsis" for="nasa-type-day">'+
((__t=( _t('components.modals.add-basemap.nasa.day') ))==null?'':_.escape(__t))+
'</label>\n        </div>\n      </div>\n      <div class="Form-rowData Form-rowData--full">\n        <div class="RadioButton js-night">\n          <button type="button" class="RadioButton-input ';
 if (layerType === 'night') { 
__p+='is-checked';
 } 
__p+='"/></button>\n          <label class="Metadata-label Metadata-label--auto CDB-Text CDB-Size-small is-semibold u-upperCase u-ellipsis" for="nasa-type-night">'+
((__t=( _t('components.modals.add-basemap.nasa.night') ))==null?'':_.escape(__t))+
'</label>\n        </div>\n      </div>\n    </div>\n    <div class="Form-rowData Form-rowData--short">\n      <div class="js-datePicker" data-title="'+
((__t=( _t('components.modals.add-basemap.nasa.cant-select') ))==null?'':_.escape(__t))+
'"></div>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],278:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var ScrollView = require('../../scroll/scroll-view');
var $ = require('jquery');
var template = require('./tabs.tpl');

/**
 * View representing the tabs content of the dialog.
 */
module.exports = CoreView.extend({

  events: {
    'click .js-tabs button': '_onClickTab'
  },

  attributes: function () {
    return {
      class: 'Modal-outer'
    };
  },

  initialize: function (opts) {
    if (!opts.submitButton) throw new Error('submitButton is required');
    if (!opts.modalFooter) throw new Error('modalFooter is required');

    this._submitButton = opts.submitButton;
    this._modalFooter = opts.modalFooter;

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();

    this.$el.html(template({
      model: this.model
    }));

    this._initViews();

    return this;
  },

  _initViews: function () {
    var scrollView = new ScrollView({
      className: 'ScrollView ScrollView--withoutMargins',
      createContentView: function () {
        return this._createTabContentView();
      }.bind(this)
    });

    this.addView(scrollView);
    this.$('.js-tab-content').append(scrollView.render().el);
  },

  _initBinds: function () {
    this.model.bind('change:currentTab', this.render, this);
  },

  _createTabContentView: function () {
    if (this._currentTabView) {
      this._currentTabView.clean();
    }
    this._currentTabView = this.model.activeTabModel().createView({
      submitButton: this._submitButton,
      modalFooter: this._modalFooter
    });
    this.addView(this._currentTabView);
    return this._currentTabView.render();
  },

  _onClickTab: function (e) {
    this.killEvent(e);
    var name = $(e.target).closest('button').data('name');
    if (name) {
      this.model.set('currentTab', name);
    } else {
      throw new Error('tab name was expected but was empty');
    }
  }

});

},{"../../scroll/scroll-view":530,"./tabs.tpl":279,"backbone/core-view":1127,"jquery":"jquery"}],279:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Modal-navigation">\n  <ul class="Modal-navigationInner CDB-Text is-semibold CDB-Size-medium js-tabs">\n    ';
 model.get('tabs').each(function(tab) { 
__p+='\n      <li class="CDB-NavMenu-item '+
((__t=( model.get('currentTab') === tab.get('name') ? 'is-selected' : '' ))==null?'':_.escape(__t))+
'">\n        <button data-name="'+
((__t=( tab.get('name') ))==null?'':_.escape(__t))+
'" class="CDB-NavMenu-link u-upperCase">\n          '+
((__t=( tab.get('label') ))==null?'':_.escape(__t))+
'\n        </button>\n      </li>\n    ';
 }) 
__p+='\n  </ul>\n</div>\n<div class="Modal-inner Modal-inner--with-navigation js-tab-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],280:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-alignCenter Modal-basemapContainer">\n  <h3 class="CDB-Text CDB-Size-large u-mainTextColor Modal-titleBasemap">'+
((__t=( _t('components.modals.add-basemap.tilejson.insert') ))==null?'':_.escape(__t))+
'</h3>\n  <div class="CDB-Text u-flex u-alignCenter">\n    <label class="Metadata-label Metadata-label--auto  CDB-Text CDB-Size-small is-semibold u-upperCase u-ellipsis">'+
((__t=( _t('components.modals.add-basemap.xyz.enter') ))==null?'':_.escape(__t))+
'</label>\n    <div class="Form-rowData Form-rowData--longer">\n      <input type="text" class="has-icon CDB-InputText CDB-Text js-url" value="" placeholder="'+
((__t=( _t('components.modals.add-basemap.xyz.eg') ))==null?'':_.escape(__t))+
' http://domain.com/tiles.json?foo=bar">\n      <i class="CDB-IconFont CDB-IconFont-dribbble Form-inputIcon js-idle"></i>\n      <i class="Spinner XYZPanel-inputIcon Spinner--formIcon Form-inputIcon js-validating" style="display: none;"></i>\n      <div class="XYZPanel-error CDB-InfoTooltip CDB-InfoTooltip--left is-error CDB-Text CDB-Size-medium CDB-InfoTooltip-text js-error"></div>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],281:[function(require,module,exports){
var Backbone = require('backbone');
var CustomBaselayerModel = require('../../../../data/custom-baselayer-model');

/**
 * Model to representing a TileJSON endpoint
 * See https://github.com/mapbox/tilejson-spec/tree/master/2.1.0 for details
 */

module.exports = Backbone.Model.extend({

  url: function () {
    return this.get('tilejson_url');
  },

  newTileLayer: function () {
    if (!this._isFetched()) throw new Error('no tiles, have fetch been called and returned a successful resultset?');

    var url = this._urlTemplate();

    var layer = new CustomBaselayerModel({
      urlTemplate: url,
      attribution: this.get('attribution'),
      maxZoom: this.get('maxzoom'),
      minZoom: this.get('minzoom'),
      name: this._name(),
      bounding_boxes: this.get('bounds'),
      tms: this.get('scheme') === 'tms',
      category: 'TileJSON',
      type: 'Tiled'
    });
    layer.set('className', layer._generateClassName(url));

    return layer;
  },

  setUrl: function (url) {
    this.set('tilejson_url', url);
  },

  _isFetched: function () {
    return this.get('tiles').length > 0;
  },

  _urlTemplate: function () {
    return this.get('tiles')[0];
  },

  _name: function () {
    return this.get('name') || this.get('description');
  }

});

},{"../../../../data/custom-baselayer-model":619,"backbone":"backbone"}],282:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var TileJSONView = require('./tilejson-view');
var TileJSONLayerModel = require('./tilejson-layer-model');

/**
 * View model for TileJSON tab content.
 */
module.exports = Backbone.Model.extend({

  defaults: {
    name: 'tilejson',
    label: 'TileJSON',
    layer: undefined // will be set when valid
  },

  createView: function (opts) {
    if (!opts.submitButton) throw new Error('submitButton is required');

    this._submitButton = opts.submitButton;

    var tileJSONLayerModel = new TileJSONLayerModel();

    return new TileJSONView({
      model: this,
      submitButton: this._submitButton,
      tileJSONLayerModel: tileJSONLayerModel
    });
  },

  hasAlreadyAddedLayer: function (userLayers) {
    var urlTemplate = this.get('layer').get('urlTemplate');
    return _.any(userLayers.isCustomCategory(), function (customLayer) {
      return customLayer.get('urlTemplate') === urlTemplate;
    });
  }

});

},{"./tilejson-layer-model":281,"./tilejson-view":283,"backbone":"backbone","underscore":"underscore"}],283:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./enter-url.tpl');

/**
 * Represents the TileJSON tab content.
 */
module.exports = CoreView.extend({

  events: {
    'keydown .js-url': '_onKeydown',
    'paste .js-url': '_onPaste'
  },

  initialize: function (opts) {
    if (!opts.submitButton) throw new Error('submitButton is required');
    if (!opts.tileJSONLayerModel) throw new Error('tileJSONLayerModel is required');

    this._submitButton = opts.submitButton;
    this._tileJSONLayerModel = opts.tileJSONLayerModel;
    this._lastURL = '';
    this._debouncedUpdate = _.debounce(this._update.bind(this), 150);
  },

  render: function () {
    this._updateOkBtn();
    this._disableOkBtn(true);

    this.$el.html(
      template()
    );

    return this;
  },

  _onKeydown: function (e) {
    e.stopPropagation();
    this._debouncedUpdate();
  },

  _onPaste: function (e) {
    e.stopPropagation();
    this._debouncedUpdate();
  },

  _update: function () {
    var self = this;

    this._disableOkBtn(true);
    this._indicateIsValidating(true);

    var url = this._urlWithHTTP();

    if (url === this._lastURL) {
      // Even if triggered nothing really changed so just update UI and return early
      this._indicateIsValidating(false);
      this._updateError();

      return;
    }

    this._lastURL = url;

    this._indicateIsValidating(true);

    this._tileJSONLayerModel.setUrl(url);

    this._tileJSONLayerModel.fetch({
      success: function (mdl) {
        if (url === self._lastURL) {
          self.model.set('layer', mdl.newTileLayer());
          self._disableOkBtn(false);
          self._indicateIsValidating(false);
          self._updateError();
        }
      },
      error: function () {
        if (url === self._lastURL) {
          self._indicateIsValidating(false);
          // Note that this text can not be longer, or it will exceed available space of the error label.
          self._updateError(_t('components.modals.add-basemap.tilejson.invalid'));
        }
      }
    });
  },

  _updateOkBtn: function () {
    this._submitButton.find('span').text(_t('components.modals.add-basemap.add-btn'));
  },

  _disableOkBtn: function (disable) {
    this._submitButton.toggleClass('is-disabled', disable);
  },

  _updateError: function (msg) {
    this.$('.js-error').text(msg)[msg ? 'addClass' : 'removeClass']('is-visible');
  },

  _indicateIsValidating: function (indicate) {
    if (indicate) {
      this.$('.js-idle').hide();
      this.$('.js-validating').show();
    } else {
      this.$('.js-validating').hide();
      this.$('.js-idle').show();
    }
  },

  // So don't try to be fetched relatively to current URL path later
  _urlWithHTTP: function () {
    var str = this.$('.js-url').val();

    if (str.indexOf('http://') === -1 && str.indexOf('https://') === -1) {
      return 'http://' + str;
    } else {
      return str;
    }
  }

});

},{"./enter-url.tpl":280,"backbone/core-view":1127,"underscore":"underscore"}],284:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-alignCenter Modal-basemapContainer">\n  <h3 class="CDB-Text CDB-Size-large u-mainTextColor Modal-titleBasemap">'+
((__t=( _t('components.modals.add-basemap.wms.insert') ))==null?'':_.escape(__t))+
'</h3>\n  <div class="CDB-Text u-flex u-alignCenter">\n    <label class="Metadata-label Metadata-label--auto  CDB-Text CDB-Size-small is-semibold u-upperCase u-ellipsis">'+
((__t=( _t('components.modals.add-basemap.xyz.enter') ))==null?'':_.escape(__t))+
'</label>\n    <div class="Form-rowData Form-rowData--longer">\n      <input type="text" class="has-icon CDB-InputText CDB-Text js-url" value="" placeholder="'+
((__t=( _t('components.modals.add-basemap.xyz.eg') ))==null?'':_.escape(__t))+
' http://openlayers.org/en/v3.5.0/examples/data/ogcsample.xml">\n      <i class="CDB-IconFont CDB-IconFont-dribbble Form-inputIcon js-idle"></i>\n      <i class="Spinner XYZPanel-inputIcon XYZPanel-inputIcon--loader Spinner--formIcon Form-inputIcon js-validating" style="display: none;"></i>\n      <div class="XYZPanel-error CDB-InfoTooltip CDB-InfoTooltip--left is-error CDB-Text CDB-Size-medium CDB-InfoTooltip-text js-error '+
((__t=( (layersFetched && layers.length === 0) ? 'is-visible' : '' ))==null?'':_.escape(__t))+
'">\n        ';
 if (layersFetched && layers.length === 0) { 
__p+='\n          '+
((__t=( _t('components.modals.add-basemap.wms.invalid') ))==null?'':_.escape(__t))+
'\n        ';
 } 
__p+='\n      </div>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],285:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./select-layer.tpl');
var WMSLayersView = require('./wms-layers-view');

/**
 * Sub view, to select what layer to use as basemap.
 */
module.exports = CoreView.extend({

  events: {
    'click .js-back': '_onClickBack'
  },

  initialize: function (opts) {
    if (!opts.customBaselayersCollection) throw new Error('customBaselayersCollection is required');
    this._customBaselayersCollection = opts.customBaselayersCollection;
  },

  render: function () {
    this.clearSubViews();

    this.$el.html(
      template({
        searchQuery: this.model.get('searchQuery'),
        layersFound: this.model.getLayers(),
        layersAvailableCount: this.model.layersAvailableCount()
      })
    );

    this._initViews();

    return this;
  },

  _initViews: function () {
    var wmsListView = new WMSLayersView({
      model: this.model,
      customBaselayersCollection: this._customBaselayersCollection
    });

    this.addView(wmsListView);
    this.$('.js-layers').append(wmsListView.render().el);
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.model.set('currentView', 'enterURL');
  }

});

},{"./select-layer.tpl":286,"./wms-layers-view":291,"backbone/core-view":1127}],286:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-inner">\n  <div class="Filters WMSSSelectLayer-Filter is-relative">\n    <div class="Filters-inner">\n      <div class="Filters-row">\n        <div class="Filters-group">\n          <div class="Filters-typeItem Filters-typeItem--searchEnabler">\n            <button class="Filters-searchLink CDB-Text is-semibold u-upperCase CDB-Size-medium js-search-link">\n              <i class="Filters-searchLinkIcon CDB-IconFont CDB-IconFont-lens"></i>'+
((__t=( _t('components.modals.add-layer.navigation.search') ))==null?'':_.escape(__t))+
'\n            </button>\n          </div>\n        </div>\n\n        <div class="Filters-typeItem Filters-typeItem--searchField">\n          <form class="Filters-searchForm js-search-form" action="#">\n            <input class="Filters-searchInput CDB-Text CDB-Size-medium js-search-input" type="text" value="'+
((__t=( searchQuery ))==null?'':_.escape(__t))+
'" placeholder="'+
((__t=( _t('components.modals.add-basemap.wms.placeholder', { layersFoundCount: layersFound.length, layersFoundCountPluralize: _t('components.modals.add-basemap.wms.tables-pluralize', { smart_count: layersFound.length }), layersAvailableCount: layersAvailableCount, layersAvailableCountPluralize: _t('components.modals.add-basemap.wms.tables-pluralize', { smart_count: layersAvailableCount }) }) ))==null?'':_.escape(__t))+
'" />\n            <button type="button" class="Filters-cleanSearch js-clean-search u-actionTextColor">\n              <i class="CDB-IconFont CDB-IconFont-close"></i>\n            </button>\n          </form>\n        </div>\n\n        <span class="Filters-separator"></span>\n      </div>\n    </div>\n  </div>\n\n  ';
 if (searchQuery && layersFound.length == 0) { 
__p+='\n    <div class="IntermediateInfo">\n      <div class="LayoutIcon">\n        <i class="CDB-IconFont CDB-IconFont-defaultUser"></i>\n      </div>\n      <h4 class="CDB-Text CDB-Size-large u-mainTextColor u-bSpace u-secondaryTextColor u-tSpace-xl">'+
((__t=( _t('components.modals.add-basemap.wms.oh-no') ))==null?'':_.escape(__t))+
'</h4>\n      <p class="CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( _t('components.modals.add-basemap.wms.unfortunately') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  ';
 } else { 
__p+='\n    <div class="js-layers"></div>\n  ';
 } 
__p+='\n</div>\n\n<button class="NavButton Dialog-backBtn js-back">\n  <i class="CDB-IconFont CDB-IconFont-arrowPrev"></i>\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],287:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CustomBaselayerModel = require('../../../../data/custom-baselayer-model');

/**
 * Model for an individual WMS/WMTS layer.
 */

module.exports = Backbone.Model.extend({

  defaults: {
    state: 'idle' // idle, saving, saveDone, saveFail
  },

  url: function () {
    return this._wmsService.saveLayerURL({
      title: this.get('title'),
      name: this.get('name'),
      layer: this.get('name'),
      srs: this.get('srs'),
      bounding_boxes: this.get('llbbox'),
      type: this.get('type'), // wms/wmts
      matrix_sets: this.get('matrix_sets')
    });
  },

  sync: function (method, model, options) {
    options = options || {};
    options.url = this.url(method.toLowerCase());
    options.dataType = 'jsonp';
    method = 'READ';

    return Backbone.sync.apply(this, arguments);
  },

  initialize: function (attrs, opts) {
    if (!opts.wmsService) throw new Error('wmsService is required');

    this._wmsService = opts.wmsService;
  },

  canSave: function (customBaselayersCollection) {
    return !_.any(customBaselayersCollection.isCustomCategory(), function (customLayer) {
      return customLayer.get('name') === this.get('title');
    }, this);
  },

  createProxiedLayerOrCustomBaselayerModel: function () {
    this.set('state', 'saving');
    this._shouldBeProxied() ? this._createProxiedLayer() : this._newCustomBaselayerModel();
  },

  _shouldBeProxied: function () {
    if (this.get('type') === 'wmts') {
      var supportedMatrixSets = this._wmsService.supportedMatrixSets(this.get('matrix_sets') || []);

      return supportedMatrixSets.length > 0;
    }

    return true;
  },

  _createProxiedLayer: function () {
    var self = this;

    this.save({}, {
      success: function () {
        var proxiedBaselayerModel;

        try {
          proxiedBaselayerModel = self._newProxiedBaselayerModel();
        } catch (e) {
        }

        if (proxiedBaselayerModel) {
          self._setCustomBaselayerModel(proxiedBaselayerModel);
        } else {
          self.set('state', 'saveFail');
        }
      },
      error: function (e) {
        self.set('state', 'saveFail');
      }
    });
  },

  _newCustomBaselayerModel: function () {
    var customBaselayerModel = this._byCustomURL(this._xyzURLTemplate());

    customBaselayerModel.set({
      name: this.get('title') || this.get('name'),
      attribution: this.get('attribution'),
      bounding_boxes: this.get('llbbox')
    });
    this._setCustomBaselayerModel(customBaselayerModel);

    return customBaselayerModel;
  },

  _newProxiedBaselayerModel: function () {
    if (!this.get('mapproxy_id')) {
      throw new Error('mapproxy_id must be set');
    }

    var url = this._wmsService.getProxyTilesURL() + '/' + this.get('mapproxy_id') + '/wmts/map/webmercator/{z}/{x}/{y}.png';
    var proxiedBaselayerModel = this._generateCustomBaselayerModel(url);

    proxiedBaselayerModel.set({
      name: this.get('title') || this.get('name'),
      attribution: this.get('attribution'),
      proxy: true,
      bounding_boxes: this.get('bounding_boxes')
    });

    return proxiedBaselayerModel;
  },

  _generateCustomBaselayerModel: function (url) {
    var layer = new CustomBaselayerModel({
      urlTemplate: url,
      attribution: null,
      maxZoom: 21,
      minZoom: 0,
      name: '',
      category: 'WMS',
      tms: false,
      type: 'Tiled'
    });
    layer.set('className', layer._generateClassName(url));

    return layer;
  },

  _byCustomURL: function (url) {
    // Minimal test for "valid URL" w/o having to complicate it with regex
    if (url && url.indexOf('/') === -1) throw new TypeError('invalid URL');

    // Only lowercase the placeholder variables, since the URL may contain case-sensitive data (e.g. API keys and such)
    url = url.replace(/\{S\}/g, '{s}')
      .replace(/\{X\}/g, '{x}')
      .replace(/\{Y\}/g, '{y}')
      .replace(/\{Z\}/g, '{z}');

    var layer = this._generateCustomBaselayerModel(url);

    return layer;
  },

  _xyzURLTemplate: function () {
    var urlTemplate = this.get('url_template') || '';
    // Convert the proxy template variables to XYZ format, http://foo.com/bar/%%(z)s/%%(x)s/%%(y)s.png"
    return urlTemplate.replace(/%%\((\w)\)s/g, '{$1}');
  },

  _setCustomBaselayerModel: function (customBaselayerModel) {
    this.set({
      state: 'saveDone',
      customBaselayerModel: customBaselayerModel
    });
  }

});

},{"../../../../data/custom-baselayer-model":619,"backbone":"backbone","underscore":"underscore"}],288:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./wms-layer.tpl');

/**
 * View for an individual layer item.
 */
module.exports = CoreView.extend({

  tagName: 'li',

  className: 'List-row',

  events: {
    'click .js-add': '_onClickAdd'
  },

  initialize: function (opts) {
    if (!opts.customBaselayersCollection) throw new Error('customBaselayersCollection is required');

    this._customBaselayersCollection = opts.customBaselayersCollection;
  },

  render: function () {
    this.$el.html(
      template({
        model: this.model,
        canSave: this.model.canSave(this._customBaselayersCollection)
      })
    );
    return this;
  },

  _onClickAdd: function (e) {
    this.killEvent(e);

    if (this.model.canSave(this._customBaselayersCollection)) {
      this.model.createProxiedLayerOrCustomBaselayerModel();
    }
  }

});

},{"./wms-layer.tpl":289,"backbone/core-view":1127}],289:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="List-rowItem">\n  <div class="DefaultTitle '+
((__t=( canSave ? '': 'is-disabled' ))==null?'':_.escape(__t))+
'">'+
((__t=( model.get('title') || model.get('name') ))==null?'':_.escape(__t))+
'</div>\n  <button class="js-add Button Button--secondary Button--secondaryTransparentBkg '+
((__t=( canSave ? '' : 'is-disabled' ))==null?'':_.escape(__t))+
'">\n    <span>Add this</span>\n  </button>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],290:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var WMSLayerModel = require('./wms-layer-model');

module.exports = Backbone.Collection.extend({

  model: function (attrs, opts) {
    var self = opts.collection;

    return new WMSLayerModel(attrs, {
      wmsService: self._wmsService
    });
  },

  parse: function (r) {
    var layers = [];

    if (r.layers) {
      layers = _.map(r.layers, function (layer) {
        return _.extend({ type: r.type || 'wms' }, layer);
      });
    }

    return layers;
  },

  sync: function (method, model, options) {
    options = options || {};
    options.url = this.url(method.toLowerCase());
    options.dataType = 'jsonp';
    method = 'READ';

    return Backbone.sync.apply(this, arguments);
  },

  url: function () {
    return this._wmsService.getFetchLayersURL();
  },

  initialize: function (models, opts) {
    if (!opts.wmsService) throw new Error('wmsService is required');

    this._wmsService = opts.wmsService;
  }

});

},{"./wms-layer-model":287,"backbone":"backbone","underscore":"underscore"}],291:[function(require,module,exports){
var WMSLayerView = require('./wms-layer-view');
var CoreView = require('backbone/core-view');

/**
 * Sub view, to select what layer to use as basemap.
 */
module.exports = CoreView.extend({

  className: 'List',
  tagName: 'ul',

  initialize: function (opts) {
    if (!opts.customBaselayersCollection) throw new Error('customBaselayersCollection is required');
    if (!this.model) throw new Error('model is required');

    this._customBaselayersCollection = opts.customBaselayersCollection;
  },

  render: function () {
    this.clearSubViews();
    this.$el.append.apply(this.$el, this._renderedLayers());
    return this;
  },

  _renderedLayers: function () {
    return this.model.getLayers().map(function (layer) {
      var view = new WMSLayerView({
        model: layer,
        customBaselayersCollection: this._customBaselayersCollection
      });

      this.addView(view);

      return view.render().el;
    }, this);
  }

});

},{"./wms-layer-view":288,"backbone/core-view":1127}],292:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var WMSView = require('./wms-view');
var WMSLayersCollection = require('./wms-layers-collection');
var WMSService = require('../../../../data/wms-service');

/**
 * View model for WMS/WMTS tab content.
 */
module.exports = Backbone.Model.extend({

  defaults: {
    name: 'wms',
    label: 'WMS/WMTS',
    currentView: 'enterURL', // [fetchingLayers, selectLayer, savingLayer]
    layersFetched: false,
    layer: undefined // will be set when selected
  },

  initialize: function (attrs, opts) {
    if (!opts.customBaselayersCollection) throw new Error('customBaselayersCollection is required');

    this._customBaselayersCollection = opts.customBaselayersCollection;

    this.wmsService = new WMSService();
    this.wmsLayersCollection = new WMSLayersCollection(null, {
      wmsService: this.wmsService
    });

    this._initBinds();
  },

  _initBinds: function () {
    this.wmsLayersCollection.bind('change:state', this._onLayerStateChange, this);
    this.wmsLayersCollection.bind('reset', function () {
      this.set({
        currentView: this.wmsLayersCollection.length > 0 ? 'selectLayer' : 'enterURL',
        layersFetched: true
      });

      this.trigger('layersFetched');
    }, this);
  },

  createView: function (opts) {
    if (!opts.submitButton) throw new Error('submitButton is required');
    if (!opts.modalFooter) throw new Error('modalFooter is required');

    this._submitButton = opts.submitButton;
    this._modalFooter = opts.modalFooter;

    this.set({
      currentView: 'enterURL',
      layersFetched: false
    });

    return new WMSView({
      model: this,
      customBaselayersCollection: this._customBaselayersCollection,
      submitButton: this._submitButton,
      modalFooter: this._modalFooter
    });
  },

  fetchLayers: function (url) {
    this.set('currentView', 'fetchingLayers');

    this.wmsService.setUrl(url);

    this.wmsLayersCollection.fetch({
      reset: true
    });
  },

  layersAvailableCount: function () {
    return _.difference(
      this.wmsLayersCollection.pluck('title'),
      this._customBaselayersCollection.pluck('name')
    ).length;
  },

  get: function (name) {
    if (name === 'layer') {
      var customBaselayerModel = this.wmsLayersCollection.find(function (mdl) {
        return mdl.get('state') === 'saveDone';
      });

      return customBaselayerModel && customBaselayerModel.get('customBaselayerModel');
    } else {
      return Backbone.Model.prototype.get.apply(this, arguments);
    }
  },

  getLayers: function () {
    if (this.get('searchQuery')) {
      var regExp = new RegExp(this.get('searchQuery'), 'i');

      return this.wmsLayersCollection.filter(function (layer) {
        return layer.get('name').match(regExp);
      }, this);
    } else {
      return this.wmsLayersCollection;
    }
  },

  hasAlreadyAddedLayer: function () {
    // Already added layers are disabled to be saved for each layer
    return false;
  },

  _onLayerStateChange: function (mdl, newState) {
    switch (newState) {
      case 'saving':
        this.set('currentView', 'savingLayer');
        break;
      case 'saveDone':
        this.set('layer', mdl.get('customBaselayerModel'));
        this.trigger('saveBasemap');
        break;
      case 'saveFail':
        this.set('currentView', 'saveFail');
        break;
      default:
        this.set('currentView', 'selectLayer');
    }
  }

});

},{"../../../../data/wms-service":682,"./wms-layers-collection":290,"./wms-view":293,"backbone":"backbone","underscore":"underscore"}],293:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var SelectLayerView = require('./select-layer-view');
var ViewFactory = require('../../../view-factory');
var ErrorView = require('../../../error/error-view');
var renderLoading = require('../../../loading/render-loading');
var enterUrl = require('./enter-url.tpl');
var $ = require('jquery');

/**
 * Represents the WMS/WMTS tab category.
 * Current state is defined by presence (or lack of) layers
 */
module.exports = CoreView.extend({

  events: {
    'keydown .js-search-input': '_onKeyDown',
    'submit .js-search-form': 'killEvent',
    'keydown .js-url': '_onKeydown',
    'paste .js-url': '_onPaste',
    'click .js-clean-search': '_onCleanSearchClick',
    'click .js-search-link': '_submitSearch'
  },

  initialize: function (opts) {
    if (!opts.customBaselayersCollection) throw new Error('customBaselayersCollection is required');
    if (!opts.submitButton) throw new Error('submitButton is required');
    if (!opts.modalFooter) throw new Error('modalFooter is required');

    this._customBaselayersCollection = opts.customBaselayersCollection;
    this._submitButton = opts.submitButton;
    this._modalFooter = opts.modalFooter;
    this._debouncedUpdate = _.debounce(this._update.bind(this), 150);
    this._onClickBinded = this._onClickOK.bind(this);

    this._bindSubmitButton();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();

    this._updateOkBtn();
    this._disableOkBtn(true);

    var view;

    switch (this.model.get('currentView')) {
      case 'savingLayer':
        this._disableModalFooter(true);

        view = ViewFactory.createByHTML(
          renderLoading({
            title: _t('components.modals.add-basemap.saving')
          })
        );
        break;
      case 'selectLayer':
        this._disableModalFooter(true);

        view = new SelectLayerView({
          model: this.model,
          customBaselayersCollection: this._customBaselayersCollection
        });
        break;
      case 'saveFail':
        this._disableModalFooter(true);

        view = new ErrorView({
          title: _t('components.modals.add-basemap.add-basemap-error')
        });
        break;
      case 'fetchingLayers':
        this._disableModalFooter(true);

        view = ViewFactory.createByHTML(
          renderLoading({
            title: _t('components.modals.add-basemap.fetching')
          })
        );
        break;
      case 'enterURL':
      default:
        this._disableModalFooter(false);

        view = ViewFactory.createByHTML(
          enterUrl({
            layersFetched: this.model.get('layersFetched'),
            layers: this.model.wmsLayersCollection
          })
        );
        break;
    }
    this.addView(view);
    this.$el.append(view.render().el);

    this.$('.js-search-input').focus();

    return this;
  },

  _showCleanSearchButton: function () {
    this.$('.js-clean-search').show();
  },

  _hideCleanSearchButton: function () {
    this.$('.js-clean-search').hide();
  },

  _initBinds: function () {
    this.model.bind('change', this.render, this);
    this.model.bind('change', this._onChangeSearchQuery, this);
    this.model.bind('layersFetched', this.render, this);
  },

  _onKeydown: function (e) {
    e.stopPropagation();

    this._debouncedUpdate();
  },

  _onPaste: function (e) {
    e.stopPropagation();

    this._debouncedUpdate();
  },

  _update: function (e) {
    this._disableOkBtn(!this.$('.js-url').val());
    this.$('.js-error').removeClass('is-visible'); // resets error state when changed
  },

  _disableOkBtn: function (disable) {
    this._submitButton.toggleClass('is-disabled', disable);
  },

  _onKeyDown: function (e) {
    var enterPressed = (e.keyCode === $.ui.keyCode.ENTER);

    if (enterPressed) {
      this.killEvent(e);

      this._submitSearch();
    }
  },

  _submitSearch: function (e) {
    this.killEvent(e);

    this.model.set('searchQuery', this.$('.js-search-input').val());
  },

  _onChangeSearchQuery: function () {
    var searchQuery = this.model.get('searchQuery');

    if (!searchQuery) {
      this._hideCleanSearchButton();
    }
  },

  _onCleanSearchClick: function (e) {
    this.killEvent(e);

    this.model.set('searchQuery', '');
  },

  _onClickOK: function (e) {
    this.killEvent(e);

    var url = this.$('.js-url').val();

    if (url) {
      this.model.fetchLayers(url);
    }
  },

  _disableModalFooter: function (disable) {
    this._modalFooter.toggleClass('is-disabled', disable);
  },

  _updateOkBtn: function () {
    this._submitButton.find('span').text(_t('components.modals.add-basemap.get-layers'));
  },

  _bindSubmitButton: function () {
    this._submitButton.on('click', this._onClickBinded);
  },

  _unBindSubmitButton: function () {
    this._submitButton.off('click', this._onClickBinded);
  },

  clean: function () {
    this._unBindSubmitButton();
    CoreView.prototype.clean.call(this);
  }

});

},{"../../../error/error-view":67,"../../../loading/render-loading":230,"../../../view-factory":594,"./enter-url.tpl":284,"./select-layer-view":285,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],294:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-alignCenter Modal-basemapContainer">\n  <h3 class="CDB-Text CDB-Size-large u-mainTextColor Modal-titleBasemap">'+
((__t=( _t('components.modals.add-basemap.xyz.insert') ))==null?'':_.escape(__t))+
'</h3>\n  <div class="CDB-Text u-flex u-alignCenter">\n    <label class="Metadata-label Metadata-label--auto  CDB-Text CDB-Size-small is-semibold u-upperCase u-ellipsis">'+
((__t=( _t('components.modals.add-basemap.xyz.enter') ))==null?'':_.escape(__t))+
'</label>\n    <div class="Form-rowData Form-rowData--longer">\n      <input type="text" class="has-icon CDB-InputText CDB-Text js-url" value="" placeholder="E.g. https://{s}.carto.com/foobar/{z}/{x}/{y}.png">\n      <i class="Spinner XYZPanel-inputIcon XYZPanel-inputIcon--loader Spinner--formIcon Form-inputIcon js-validating" style="display: none;"></i>\n      <div class="Checkbox XYZPanel-inputCheckbox js-tms" data-title="Inverts Y axis numbering for tiles">\n        <button class="Checkbox-input u-rSpace--m"></button>\n        <label class="CDB-Text CDB-Size-small is-semibold u-upperCase">'+
((__t=( _t('components.modals.add-basemap.xyz.tms') ))==null?'':_.escape(__t))+
'</label>\n      </div>\n      <div class="XYZPanel-error CDB-InfoTooltip CDB-InfoTooltip--left is-error CDB-Text CDB-Size-medium CDB-InfoTooltip-text js-error"></div>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],295:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var XYZView = require('./xyz-view');

/**
 * View model for XYZ tab content.
 */
module.exports = Backbone.Model.extend({

  defaults: {
    name: 'xyz',
    label: 'XYZ',
    tms: false,
    layer: undefined // will be set when valid
  },

  createView: function (opts) {
    if (!opts.submitButton) throw new Error('submitButton is required');
    if (!opts.modalFooter) throw new Error('modalFooter is required');

    this._submitButton = opts.submitButton;
    this._modalFooter = opts.modalFooter;

    return new XYZView({
      model: this,
      submitButton: this._submitButton,
      modalFooter: this._modalFooter
    });
  },

  hasAlreadyAddedLayer: function (userLayers) {
    var urlTemplate = this.get('layer').get('urlTemplate');
    return _.any(userLayers.isCustomCategory(), function (customLayer) {
      return customLayer.get('urlTemplate') === urlTemplate;
    });
  }

});

},{"./xyz-view":296,"backbone":"backbone","underscore":"underscore"}],296:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./enter-url.tpl');
var CustomBaselayerModel = require('../../../../data/custom-baselayer-model');
var TipsyTooltipView = require('../../../../components/tipsy-tooltip-view');

/**
 * Represents the XYZ tab content.
 */

module.exports = CoreView.extend({

  className: 'XYZPanel',

  events: {
    'click .js-tms': '_changeTMS',
    'keydown .js-url': '_onKeydown',
    'paste .js-url': '_onPaste'
  },

  initialize: function (opts) {
    if (!opts.submitButton) throw new Error('submitButton is required');

    this._submitButton = opts.submitButton;
    this._lastCallSeq = 0;
    this._debouncedUpdate = _.debounce(this._update.bind(this), 150);

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();

    this._updateOkBtn();
    this._disableOkBtn(true);

    this.$el.html(
      template()
    );

    this._initViews();

    return this;
  },

  _initViews: function () {
    // Add TMS tooltip
    var tooltip = new TipsyTooltipView({
      el: this.$('.js-tms'),
      title: function () {
        return $(this).data('title');
      }
    });
    this.addView(tooltip);
  },

  _onKeydown: function (e) {
    e.stopPropagation();
    this._debouncedUpdate();
  },

  _onPaste: function (e) {
    e.stopPropagation();
    this._debouncedUpdate();
  },

  _initBinds: function () {
    this.model.bind('change:tms', this._setTMSCheckbox, this);
  },

  _update: function () {
    this._disableOkBtn(true);
    this._indicateIsValidating(true);
    var layer;
    var urlErrorMsg;

    var url = this.$('.js-url').val();
    var tms = this.model.get('tms');

    if (url) {
      try {
        layer = this._byCustomURL(url, tms);
      } catch (e) {
        urlErrorMsg = _t('components.modals.add-basemap.xyz.not-valid');
      }
    }

    this.model.set('layer', layer);

    if (layer) {
      var self = this;
      // Make sure only the last call made is the one that defines view change,
      // avoids laggy responses to indicate wrong state
      var thisCallSeq = ++this._lastCallSeq;
      layer.validateTemplateURL({
        success: function () {
          if (thisCallSeq === self._lastCallSeq) {
            self._disableOkBtn(false);
            self._indicateIsValidating(false);
            self._updateError();
          }
        },
        error: function () {
          if (thisCallSeq === self._lastCallSeq) {
            self._disableOkBtn(false);
            self._indicateIsValidating(false);
            self._updateError(_t('components.modals.add-basemap.xyz.couldnt-validate'));
          }
        }
      });
    } else if (url) {
      this._indicateIsValidating(false);
      this._updateError(urlErrorMsg);
    } else {
      this._indicateIsValidating(false);
      this._updateError();
    }
  },

  _changeTMS: function (e) {
    this.model.set('tms', !this.model.get('tms'));
    this._onKeydown(e);
  },

  _setTMSCheckbox: function (e) {
    this.$('.js-tms .Checkbox-input').toggleClass('is-checked', this.model.get('tms'));
  },

  _byCustomURL: function (url, tms) {
    // Minimal test for "valid URL" w/o having to complicate it with regex
    if (url && url.indexOf('/') === -1) throw new TypeError('invalid URL');

    // Only lowercase the placeholder variables, since the URL may contain case-sensitive data (e.g. API keys and such)
    url = url.replace(/\{S\}/g, '{s}')
      .replace(/\{X\}/g, '{x}')
      .replace(/\{Y\}/g, '{y}')
      .replace(/\{Z\}/g, '{z}');

    var layer = new CustomBaselayerModel({
      urlTemplate: url,
      attribution: null,
      maxZoom: 21,
      minZoom: 0,
      name: '',
      tms: tms,
      category: 'Custom',
      type: 'Tiled'
    });
    layer.set('className', layer._generateClassName(url));

    return layer;
  },

  _setTMS: function (ev) {
    var $checkbox = $(ev.target).closest('.Checkbox');
    $checkbox.find('.Checkbox-input').toggleClass('is-checked');
    this._update(ev);
  },

  _updateOkBtn: function () {
    this._submitButton.find('span').text(_t('components.modals.add-basemap.add-btn'));
  },

  _disableOkBtn: function (disable) {
    this._submitButton.toggleClass('is-disabled', disable);
  },

  _updateError: function (msg) {
    this.$('.js-error').text(msg)[ msg ? 'addClass' : 'removeClass' ]('is-visible');
  },

  _indicateIsValidating: function (indicate) {
    this.$('.js-validating').toggle(!!indicate);
  }

});

},{"../../../../components/tipsy-tooltip-view":589,"../../../../data/custom-baselayer-model":619,"./enter-url.tpl":294,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],297:[function(require,module,exports){
var Backbone = require('backbone');
var UploadModel = require('../../../data/upload-model');
var VisualizationFetchModel = require('../../../data/visualizations-fetch-model');
var TablesCollection = require('../../../data/visualizations-collection');
var TableModel = require('../../../data/table-model');

/**
 * Add layer model
 *
 * "Implements" the CreateListingModel.
 */
module.exports = Backbone.Model.extend({
  defaults: {
    type: 'addLayer',
    contentPane: 'listing', // [listing, loading]
    listing: 'datasets', // [import, datasets, scratch]
    collectionFetched: false,
    activeImportPane: 'file'
  },

  initialize: function (attrs, opts) {
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.userActions) throw new Error('userActions is required');
    if (!opts.pollingModel) throw new Error('pollingModel is required');

    this._userModel = opts.userModel;
    this._userActions = opts.userActions;
    this._configModel = opts.configModel;
    this._pollingModel = opts.pollingModel;

    this._uploadModel = new UploadModel({
      create_vis: false
    }, {
      userModel: this._userModel,
      configModel: this._configModel
    });

    this._selectedDatasetsCollection = new Backbone.Collection();
    this._tablesCollection = new TablesCollection([], {
      configModel: this._configModel
    });
    this._visualizationFetchModel = new VisualizationFetchModel({
      content_type: 'datasets',
      library: this.showLibrary()
    });
    this._initBinds();
    this._fetchCollection();
  },

  getTablesCollection: function () {
    return this._tablesCollection;
  },

  getSelectedDatasetsCollection: function () {
    return this._selectedDatasetsCollection;
  },

  getVisualizationFetchModel: function () {
    return this._visualizationFetchModel;
  },

  getUploadModel: function () {
    return this._uploadModel;
  },

  canSelect: function (dataset) {
    return dataset.get('selected') || this._selectedDatasetsCollection.length < 1; // for now only allow 1 item
  },

  showLibrary: function () {
    return false;
  },

  showDatasets: function () {
    return true;
  },

  setActiveImportPane: function (name) {
    this.set('activeImportPane', name);
  },

  canFinish: function () {
    if (this.get('listing') === 'import') {
      return this._uploadModel.isValidToUpload();
    } else if (this.get('listing') === 'datasets') {
      return this._selectedDatasetsCollection.length > 0;
    }
  },

  finish: function () {
    if (this.get('listing') === 'import') {
      this._pollingModel.trigger('importByUploadData', this._uploadModel.toJSON(), this);
    } else if (this.get('listing') === 'datasets') {
      var mdl = this._selectedDatasetsCollection.at(0);
      if (mdl.get('type') === 'remote') {
        var d = {
          create_vis: false,
          type: 'remote',
          value: mdl.get('name'),
          remote_visualization_id: mdl.get('id'),
          size: mdl.get('external_source') ? mdl.get('external_source').size : undefined
        };
        // See BackgroundImporter where the same event is bound to be handled..
        this._pollingModel.trigger('importByUploadData', d, this);
      } else {
        this._addNewLayer(mdl.getTableModel());
      }
    }
  },

  getImportState: function () {
    return this.get('activeImportPane');
  },

  showGuessingToggler: function () {
    return this.get('listing') === 'import';
  },

  showPrivacyToggler: function () {
    return this.get('listing') === 'import';
  },

  createFromScratch: function () {
    var self = this;
    this.set('contentPane', 'creatingFromScratch');
    var tableModel = new TableModel({}, {
      configModel: this._configModel
    });
    tableModel.save({}, {
      success: function () {
        self._addNewLayer(tableModel);
      },
      error: function () {
        self.set('contentPane', 'addLayerFailed');
      }
    });
  },

  _initBinds: function () {
    this._uploadModel.bind('change', function () {
      this.trigger('change:upload', this);
    }, this);
    this._visualizationFetchModel.bind('change', this._fetchCollection, this);
    this.bind('change:listing', this._fetchCollection, this);

    this._tablesCollection.bind('change:selected', function (changedModel, wasSelected) {
      this._selectedDatasetsCollection[ wasSelected ? 'add' : 'remove' ](changedModel);
    }, this);
    this._tablesCollection.bind('sync', function () {
      this._selectedDatasetsCollection.each(function (model) {
        var sameModel = this._tablesCollection.get(model.id);
        if (sameModel) {
          sameModel.set('selected', true);
        }
      }, this);
    }, this);
  },

  _fetchCollection: function () {
    var params = this._visualizationFetchModel.attributes;
    var types;

    if (this._visualizationFetchModel.isSearching()) {
      // Supporting search in data library and user datasets at the same time
      types = 'table,remote';
    } else {
      types = params.library ? 'remote' : 'table';
    }

    this._tablesCollection.fetch({
      data: {
        locked: '',
        q: params.q,
        page: params.page,
        tags: params.tag,
        shared: params.shared,
        only_liked: params.liked,
        type: '',
        types: types
      }
    });
  },

  _onCollectionChange: function () {
    this._selectedDatasetsCollection.reset(
      this._tablesCollection.where({ selected: true })
    );
  },

  _addNewLayer: function (tableModel) {
    this.set('contentPane', 'addingNewLayer');

    this._userActions.createLayerFromTable(tableModel, {
      success: function () {
        this.trigger('addLayerDone');
      }.bind(this),
      error: function () {
        this.set('contentPane', 'addLayerFailed');
      }.bind(this)
    });
  }
});

},{"../../../data/table-model":665,"../../../data/upload-model":668,"../../../data/visualizations-collection":678,"../../../data/visualizations-fetch-model":679,"backbone":"backbone"}],298:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var template = require('./add-layer.tpl');
var FooterView = require('./footer/footer-view');
var NavigationView = require('./content/navigation-view');
var ListingView = require('./content/listing-view');
var TabPaneView = require('../../tab-pane/tab-pane-view');
var TabPaneCollection = require('../../tab-pane/tab-pane-collection');
var ViewFactory = require('../../view-factory');
var renderLoading = require('../../loading/render-loading');
var ErrorView = require('../../error/error-view');

/**
 * Add layer dialog, typically used from editor
 */
module.exports = CoreView.extend({

  className: 'Dialog-content Dialog-content--expanded',

  initialize: function (opts) {
    if (!opts.modalModel) throw new TypeError('model is required');
    if (!opts.createModel) throw new TypeError('createModel is required');
    if (!opts.configModel) throw new TypeError('configModel is required');
    if (!opts.userModel) throw new TypeError('userModel is required');
    if (!opts.pollingModel) throw new TypeError('pollingModel is required');

    this._modalModel = opts.modalModel;
    this._createModel = opts.createModel;
    this._userModel = opts.userModel;
    this._configModel = opts.configModel;
    this._pollingModel = opts.pollingModel;
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());
    this._initViews();
  },

  _initBinds: function () {
    this._createModel.bind('addLayerDone', this._modalModel.destroy.bind(this._modalModel), this);
    this._createModel.bind('change:contentPane', this._onChangeContentView, this);
    this._pollingModel.bind('importByUploadData', this._modalModel.destroy.bind(this._modalModel), this);
    this.add_related_model(this._pollingModel);
    this.add_related_model(this._createModel);
  },

  _initViews: function () {
    var self = this;

    this._navigationView = new NavigationView({
      el: this.$('.js-navigation'),
      userModel: this._userModel,
      routerModel: this._createModel.getVisualizationFetchModel(),
      createModel: this._createModel,
      tablesCollection: this._createModel.getTablesCollection()
    });
    this._navigationView.render();
    this.addView(this._navigationView);

    this._tabPaneCollection = new TabPaneCollection([
      {
        name: 'listing',
        selected: this._createModel.get('contentPane') === 'listing',
        createContentView: function () {
          return new ListingView({
            createModel: self._createModel,
            configModel: self._configModel,
            userModel: self._userModel
          });
        }
      }, {
        name: 'creatingFromScratch',
        selected: this._createModel.get('contentPane') === 'creatingFromScratch',
        createContentView: function () {
          return ViewFactory.createByHTML(
            renderLoading({
              title: _t('components.modals.add-layer.create-loading-title')
            })
          );
        }
      }, {
        name: 'addingNewLayer',
        selected: this._createModel.get('contentPane') === 'addingNewLayer',
        createContentView: function () {
          return ViewFactory.createByHTML(
            renderLoading({
              title: _t('components.modals.add-layer.adding-new-layer')
            })
          );
        }
      }, {
        name: 'addLayerFailed',
        selected: this._createModel.get('contentPane') === 'addLayerFailed',
        createContentView: function () {
          return new ErrorView({
            title: _t('components.modals.add-layer.add-layer-error')
          });
        }
      }
    ]);

    var tabPaneView = new TabPaneView({
      collection: this._tabPaneCollection
    });
    this.addView(tabPaneView);
    this.$('.js-content-container').append(tabPaneView.render().el);

    this._footerView = new FooterView({
      configModel: this._configModel,
      createModel: this._createModel,
      userModel: this._userModel
    });
    this.addView(this._footerView);
    this.$('.js-footer').append(this._footerView.render().el);
  },

  _onChangeContentView: function () {
    var context = this._createModel.get('contentPane');
    var paneModel = _.first(this._tabPaneCollection.where({ name: context }));
    var paneModelName = paneModel.get('name');
    paneModel.set('selected', true);

    if (paneModelName === 'loading') {
      this._footerView.hide();
    }
    if (paneModelName !== 'listing') {
      this._navigationView.hide();
    }
  }
});

},{"../../error/error-view":67,"../../loading/render-loading":230,"../../tab-pane/tab-pane-collection":538,"../../tab-pane/tab-pane-view":549,"../../view-factory":594,"./add-layer.tpl":299,"./content/listing-view":362,"./content/navigation-view":363,"./footer/footer-view":365,"backbone/core-view":1127,"underscore":"underscore"}],299:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Dialog-header Dialog-header--expanded CreateDialog-header with-separator">\n  <div class="Dialog-headerIcon Dialog-headerIcon--neutral">\n    <i class="CDB-IconFont CDB-IconFont-add"></i>\n  </div>\n  <h2 class="CDB-Text CDB-Size-large u-mainTextColor u-bSpace">'+
((__t=( _t('components.modals.add-layer.modal-title') ))==null?'':_.escape(__t))+
'</h2>\n  <h3 class="CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( _t('components.modals.add-layer.modal-desc') ))==null?'':_.escape(__t))+
'</h3>\n</div>\n<div class="Filters Filters--navListing Filters--static js-navigation"></div>\n<div class="js-content-container Dialog-body Dialog-body--expanded Dialog-body--create Dialog-body--noPaddingTop Dialog-body--withoutBorder"></div>\n<div class="Dialog-footer Dialog-footer--expanded CreateDialog-footer js-footer"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],300:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var randomQuote = require('../../../../loading/random-quote');

/*
 *  Content result default view
 */

module.exports = CoreView.extend({
  events: {
    'click .js-connect': '_onConnectClick'
  },

  initialize: function (opts) {
    if (!opts.routerModel) throw new Error('routerModel is required');
    if (!opts.tablesCollection) throw new Error('tablesCollection is required');
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.template) throw new Error('template is required');

    this._userModel = opts.userModel;
    this._routerModel = opts.routerModel;
    this._tablesCollection = opts.tablesCollection;
    this.template = opts.template;

    this._initBinds();
  },

  render: function () {
    var type = this._routerModel.get('content_type');

    this.$el.html(this.template({
      page: this._routerModel.get('page'),
      tag: this._routerModel.get('tag'),
      q: this._routerModel.get('q'),
      shared: this._routerModel.get('shared'),
      locked: this._routerModel.get('locked'),
      library: this._routerModel.get('library'),
      quote: randomQuote(),
      type: type,
      totalItems: this._tablesCollection.size(),
      totalEntries: this._tablesCollection.getTotalStat('total_entries')
    }));

    return this;
  },

  _initBinds: function () {
    this._routerModel.bind('change', this.render, this);
    this._tablesCollection.bind('sync', this.render, this);
    this.add_related_model(this._routerModel);
    this.add_related_model(this._tablesCollection);
  },

  _onConnectClick: function () {
    this.trigger('connectDataset', this);
  }

});

},{"../../../../loading/random-quote":229,"backbone/core-view":1127}],301:[function(require,module,exports){
var cdb = require('cartodb.js');
var CoreView = require('backbone/core-view');
var $ = require('jquery');
var _ = require('underscore');
var moment = require('moment');
var Utils = require('../../../../../helpers/utils');
var TipsyTooltipView = require('../../../../tipsy-tooltip-view');
var template = require('./dataset-item.tpl');
var LikesView = require('../../../../likes/likes-view');

/**
 * View representing an item in the list under datasets route.
 */
module.exports = CoreView.extend({
  tagName: 'li',
  className: 'ModalBlockList-item ModalBlockList-item--full',

  events: {
    'click .js-tag-link': '_onTagClick',
    'click': '_toggleSelected'
  },

  initialize: function (opts) {
    if (!opts.createModel) throw new Error('createModel is required');
    if (!opts.userModel) throw new Error('userModel is required');

    this._createModel = opts.createModel;
    this._userModel = opts.userModel;
    this._routerModel = this._createModel.getVisualizationFetchModel();

    this.model.on('change', this.render, this);
  },

  render: function () {
    var tableModel = this.model.getTableModel();
    var permissionModel = this.model.getPermissionModel();
    var synchronizationModel = this.model.getSynchronizationModel();
    var tags = this.model.get('tags') || [];
    var description = cdb.core.sanitize.html(this.model.get('description'));
    var tableGeomColumnTypes = tableModel.getGeometryType() || [];

    var d = {
      isRaster: this.model.isRaster(),
      geometryType: tableGeomColumnTypes.length > 0 ? tableGeomColumnTypes[0] : '',
      title: this.model.get('name'),
      isOwner: permissionModel.isOwner(this._userModel),
      owner: permissionModel.getOwner().renderData(this._userModel),
      showPermissionIndicator: !permissionModel.hasWriteAccess(this._userModel),
      description: description,
      privacy: this.model.get('privacy').toLowerCase(),
      likes: this.model.get('likes') || 0,
      timeDiff: moment(this.model.get('updated_at')).fromNow(),
      tags: tags,
      tagsCount: tags.length,
      maxTagsToShow: 3,
      rowCount: undefined,
      datasetSize: undefined,
      syncStatus: undefined,
      syncRanAt: undefined
    };

    var rowCount = tableModel.get('row_count');
    if (rowCount >= 0) {
      d.rowCount = rowCount;
      d.rowCountFormatted = (rowCount < 10000 ? Utils.formatNumber(rowCount) : Utils.readizableNumber(rowCount));
    }

    var datasetSize = tableModel.get('size');
    if (datasetSize >= 0) {
      d.datasetSize = Utils.readablizeBytes(datasetSize, true);
    }

    if (!_.isEmpty(synchronizationModel)) {
      d.syncRanAt = moment(synchronizationModel.get('ran_at') || new Date()).fromNow();
      d.syncStatus = synchronizationModel.get('state');
    }

    this.$el.html(template(d));

    this._renderLikesIndicator();
    this._renderTooltips();

    // Item selected?
    this.$el.toggleClass('is-selected', !!this.model.get('selected'));

    return this;
  },

  _renderLikesIndicator: function () {
    var view = new LikesView({
      model: this.model.getLikesModel()
    });
    this.$('.js-likes-indicator').replaceWith(view.render().el);
    this.addView(view);
  },

  _renderTooltips: function () {
    if (!_.isEmpty(this.model.get('synchronization'))) {
      this.addView(
        new TipsyTooltipView({
          el: this.$('.DatasetsList-itemStatus'),
          title: function (e) {
            return $(this).attr('data-title');
          }
        })
      );
    }
  },

  _onTagClick: function (ev) {
    var tag = $(ev.target).val();

    if (tag) {
      this._routerModel.set('tag', tag);
    }
  },

  _toggleSelected: function (ev) {
    // Let links use default behaviour
    if (ev.target.tagName !== 'A') {
      this.killEvent(ev);
      if (this._createModel.canSelect(this.model)) {
        this.model.set('selected', !this.model.get('selected'));
      }
    }
  }
});

},{"../../../../../helpers/utils":1102,"../../../../likes/likes-view":225,"../../../../tipsy-tooltip-view":589,"./dataset-item.tpl":302,"backbone/core-view":1127,"cartodb.js":"cartodb.js","jquery":"jquery","moment":"moment","underscore":"underscore"}],302:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="DatasetsList-itemCategory is--'+
((__t=( isRaster ? 'raster' : geometryType ))==null?'':_.escape(__t))+
'Dataset">\n  ';
 if (syncStatus) { 
__p+='\n    <i\n    ';
 if (syncStatus === "failure") { 
__p+='\n      data-title="'+
((__t=( _t('components.modals.add-layer.datasets.item.sync-failed') ))==null?'':_.escape(__t))+
' '+
((__t=( syncRanAt ))==null?'':_.escape(__t))+
'"\n    ';
 } else if (syncStatus === "syncing") { 
__p+='\n      data-title="'+
((__t=( _t('components.modals.add-layer.datasets.item.syncing') ))==null?'':_.escape(__t))+
'"\n    ';
 } else { 
__p+='\n      data-title="'+
((__t=( _t('components.modals.add-layer.datasets.item.synced') ))==null?'':_.escape(__t))+
' '+
((__t=( syncRanAt ))==null?'':_.escape(__t))+
'"\n    ';
 } 
__p+='\n    class="CDB-IconFont CDB-IconFont-wifi DatasetsList-itemStatus is-'+
((__t=( syncStatus ))==null?'':_.escape(__t))+
'"></i>\n  ';
 } 
__p+='\n</div>\n<div class="ModalDataset-itemInfo">\n  <div class="ModalDataset-itemInfoTitle">\n    <h3 class="CDB-Text CDB-Size-large u-bSpace u-ellipsis">\n      '+
((__t=( title ))==null?'':_.escape(__t))+
'\n      ';
 if (showPermissionIndicator) { 
__p+='\n        <span class="Tag Tag--outline Tag-outline--grey CDB-Text CDB-Size-small u-upperCase">\n          '+
((__t=( _t('components.modals.add-layer.datasets.item.read') ))==null?'':_.escape(__t))+
'\n        </span>\n      ';
 } 
__p+='\n    </h3>\n    ';
 if (description && description.length > 0) { 
__p+='\n      <p class="u-ellipsis CDB-Text CDB-Size-medium u-altTextColor" title="'+
((__t=( description ))==null?'':_.escape(__t))+
'">'+
((__t=( description ))==null?'':_.escape(__t))+
'</p>\n    ';
 } else { 
__p+='\n      <span class="NoResults CDB-Text CDB-Size-medium">'+
((__t=( _t('components.modals.add-layer.datasets.item.no-description') ))==null?'':_.escape(__t))+
'</span>\n    ';
 } 
__p+='\n  </div>\n  <div>\n    <div class="DatasetsList-itemMeta">\n\n      <span class="CDB-Tag is-'+
((__t=( privacy ))==null?'':_.escape(__t))+
' CDB-Text is-semibold CDB-Size-small u-upperCase">\n        '+
((__t=( privacy ))==null?'':_.escape(__t))+
'\n      </span>\n      ';
 if (rowCount) { 
__p+='\n        <span class="RowsIndicator">\n          <span class="CDB-Text CDB-Size-small u-altTextColor">'+
((__t=( rowCountFormatted ))==null?'':_.escape(__t))+
' '+
((__t=( _t('components.modals.add-layer.datasets.item.rows-pluralize', { smart_count: rowCount }) ))==null?'':_.escape(__t))+
'</span>\n        </span>\n      ';
 } 
__p+='\n      ';
 if (datasetSize) { 
__p+='\n        <span class="SizeIndicator">\n          <span class="CDB-Text CDB-Size-small u-altTextColor">'+
((__t=( datasetSize ))==null?'':_.escape(__t))+
'</span>\n        </span>\n      ';
 } 
__p+='\n      <span class="DatasetsList-itemTimeDiff DefaultTimeDiff">\n        <span class="CDB-Text CDB-Size-small u-altTextColor">'+
((__t=( timeDiff ))==null?'':_.escape(__t))+
'</span>\n        ';
 if (!isOwner) { 
__p+='\n          <span class="CDB-Text CDB-Size-small u-altTextColor u-lSpace--xl u-rSpace">\n            '+
((__t=( _t('components.modals.add-layer.datasets.item.by') ))==null?'':_.escape(__t))+
'\n          </span>\n          <span class="DatasetsList-avatar">\n            <img class="DatasetsList-avatarImg" src="'+
((__t=( owner.avatar_url ))==null?'':_.escape(__t))+
'" alt="'+
((__t=( owner.name || owner.username  ))==null?'':_.escape(__t))+
'" title="'+
((__t=( owner.name || owner.username  ))==null?'':_.escape(__t))+
'" />\n          </span>\n        ';
 } 
__p+='\n      </span>\n    </div>\n    <div class="DatasetsList-itemMeta DatasetsList-itemTags">\n      ';
 if (tagsCount > 0) { 
__p+='\n        <div class="DefaultTags CDB-Text CDB-Size-small">\n          ';
 for (var i = 0, l = Math.min(maxTagsToShow, tags.length); i < l; ++i) { 
__p+='\n            <button class="CDB-Text CDB-Size-small u-upperCase DefaultTags-item js-tag-link u-actionTextColor" value="'+
((__t=( tags[i] ))==null?'':_.escape(__t))+
'">'+
((__t=( tags[i] ))==null?'':_.escape(__t))+
'</button>';
 if (i !== (l-1)) { 
__p+='';
 } 
__p+='\n          ';
 } 
__p+='\n          ';
 if (tagsCount > maxTagsToShow) { 
__p+='\n            '+
((__t=( _t('components.modals.add-layer.datasets.item.tags-more', { tagsCount: tagsCount - maxTagsToShow }) ))==null?'':_.escape(__t))+
'\n          ';
 } 
__p+='\n        </div>\n      ';
 } else { 
__p+='\n        <span class="NoResults CDB-Text CDB-Size-small u-altTextColor">'+
((__t=( _t('components.modals.add-layer.datasets.item.no-tags') ))==null?'':_.escape(__t))+
'</span>\n      ';
 } 
__p+='\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],303:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="IntermediateInfo">\n  <div class="LayoutIcon LayoutIcon--negative">\n    <i class="CDB-IconFont CDB-IconFont-cockroach"></i>\n  </div>\n  <h4 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m">\n    '+
((__t=( _t('components.modals.add-layer.datasets.error.title') ))==null?'':_.escape(__t))+
'\n  </h4>\n  <p class="CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( _t('components.modals.add-layer.datasets.error.desc') ))==null?'':_.escape(__t))+
' <a class="js-mail-link" href="mailto:support@carto.com">support@carto.com</a>.</p>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],304:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var DATASETS_ITEMS = {
  'datasets': require('./dataset-item-view'),
  'remotes': require('./remote-dataset-item-view')
};

/**
 * View representing the list of datasets
 */
module.exports = CoreView.extend({

  tagName: 'ul',
  className: 'DatasetsList',

  initialize: function (opts) {
    if (!opts.createModel) throw new Error('createModel is required');
    if (!opts.userModel) throw new Error('userModel is required');

    this._createModel = opts.createModel;
    this._userModel = opts.userModel;
    this._tablesCollection = this._createModel.getTablesCollection();

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this._tablesCollection.each(this._addItem, this);
    return this;
  },

  _initBinds: function () {
    this._tablesCollection.bind('sync', this.render, this);
    this.add_related_model(this._tablesCollection);
  },

  _addItem: function (m, i) {
    var type = m.get('type') === 'remote' ? 'remotes' : 'datasets';

    var item = new DATASETS_ITEMS[type]({
      model: m,
      createModel: this._createModel,
      userModel: this._userModel
    });

    this.addView(item);
    this.$el.append(item.render().el);
  },

  show: function () {
    this.$el.removeClass('is-hidden');
  },

  hide: function () {
    this.$el.addClass('is-hidden');
  }

});

},{"./dataset-item-view":301,"./remote-dataset-item-view":310,"backbone/core-view":1127}],305:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="IntermediateInfo">\n  <div class="CDB-LoaderIcon CDB-LoaderIcon--big is-dark js-loader">\n    <svg class="CDB-LoaderIcon-spinner" viewbox="0 0 50 50">\n      <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"/>\n    </svg>\n  </div>\n  <h4 class="CDB-Text CDB-Size-large u-mainTextColor u-bSpace u-secondaryTextColor u-tSpace-xl">\n    '+
((__t=( _t('components.modals.add-layer.datasets.' + (q || tag  ? 'searching' : 'loading')) ))==null?'':_.escape(__t))+
'...\n  </h4>\n  <div class="CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( quote ))==null?'':__t)+
'</div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],306:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="IntermediateInfo">\n  <div class="LayoutIcon ';
 (q || tag) ? 'LayoutIcon--negative' : '' 
__p+='">\n    <i class="CDB-IconFont\n      ';
 if (shared) { 
__p+=' CDB-IconFont-defaultUser\n      ';
 } else if (locked) { 
__p+=' CDB-IconFont-lock\n      ';
 } else if (library) { 
__p+=' CDB-IconFont-dribbble\n      ';
 } else { 
__p+=' CDB-IconFont-lens ';
 } 
__p+='" />\n  </div>\n  <h4 class="CDB-Text CDB-Size-large u-mainTextColor u-bSpace u-secondaryTextColor u-tSpace-xl">\n    ';
 if (page > 1 || totalItems === 0 && totalEntries > 0) { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.datasets.no-results.desc') ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n\n    ';
 if (( tag || q ) && totalItems === 0 && totalEntries === 0) { 
__p+='\n      0 '+
((__t=( tag || q ))==null?'':_.escape(__t))+
' '+
((__t=( type ))==null?'':_.escape(__t))+
' '+
((__t=( _t('components.modals.add-layer.datasets.no-results.found') ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n\n    ';
 if (page === 1 && !tag && !q && totalItems === 0 && totalEntries === 0) { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.datasets.no-results.there-are-no') ))==null?'':_.escape(__t))+
' '+
((__t=( shared === "only" ? 'shared' : '' ))==null?'':_.escape(__t))+
' '+
((__t=( locked ? 'locked' : '' ))==null?'':_.escape(__t))+
' '+
((__t=( library ? 'library' : '' ))==null?'':_.escape(__t))+
' '+
((__t=( type ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  </h4>\n  <p class="CDB-Text CDB-Size-medium u-altTextColor">\n    ';
 if (!tag && !q && totalItems === 0 && totalEntries === 0) { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.datasets.no-results.no-fun', { type: type }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  </p>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],307:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var PaginationModel = require('../../../../pagination/pagination-model');
var PaginationView = require('../../../../pagination/pagination-view');

/**
 * Responsible for the datasets paginator
 *  ___________________________________________________________________________
 * |                                                                           |
 * |                                             Page 2 of 42 [1] 2 [3][4][5]  |
 * |___________________________________________________________________________|
 *
 */

module.exports = CoreView.extend({
  className: 'DatasetsPaginator',

  initialize: function (opts) {
    if (!opts.routerModel) throw new TypeError('routerModel is required');
    if (!opts.tablesCollection) throw new TypeError('tablesCollection is required');

    this._routerModel = opts.routerModel;
    this._tablesCollection = opts.tablesCollection;

    this.model = new PaginationModel({
      current_page: this._routerModel.get('page')
    });

    this._initBinds();
    this._initViews();
  },

  render: function () {
    this.clearSubViews();
    this.$el.append(this.paginationView.render().el);
    return this;
  },

  _initBinds: function () {
    this.model.bind('change', this.render, this);
    this.model.bind('change:current_page', function () {
      this._routerModel.set('page', this.model.get('current_page'));
    }, this);
    this._tablesCollection.bind('sync', this._updatePaginationModelByCollection, this);
    this._routerModel.bind('change:page', this._updatePaginationModelByRouterModel, this);

    this.add_related_model(this._routerModel);
    this.add_related_model(this._tablesCollection);
    this.add_related_model(this.model);
  },

  _initViews: function () {
    this.paginationView = new PaginationView({
      model: this.model
    });
    this.addView(this.paginationView);
  },

  _updatePaginationModelByCollection: function () {
    this.model.set({
      per_page: this._tablesCollection.getDefaultParam('per_page'),
      total_count: this._tablesCollection.getTotalStat('total_entries')
    });
  },

  _updatePaginationModelByRouterModel: function () {
    this.model.set('current_page', this._routerModel.get('page'));
  }

});

},{"../../../../pagination/pagination-model":519,"../../../../pagination/pagination-view":520,"backbone/core-view":1127}],308:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var ContentResultView = require('./content-result-view');
var DatasetsListView = require('./datasets-list-view');
var DatasetsPaginationView = require('./datasets-pagination-view');
var noResultsTemplate = require('./no-datasets.tpl');
var datasetsNoResultTemplate = require('./datasets-no-result.tpl');
var datasetsErrorTemplate = require('./datasets-error.tpl');
var datasetsLoaderTemplate = require('./datasets-loader.tpl');

/**
 *  Datasets list view
 *
 *  Show datasets view to select them for
 *  creating a map or importing a dataset
 *
 */

module.exports = CoreView.extend({
  initialize: function (opts) {
    if (!opts.createModel) throw new Error('createModel is required');
    if (!opts.userModel) throw new Error('userModel is required');

    this._createModel = opts.createModel;
    this._userModel = opts.userModel;
    this._routerModel = this._createModel.getVisualizationFetchModel();
    this._tablesCollection = this._createModel.getTablesCollection();

    this._initViews();
    this._initBinds();
    this._onDataLoading();
  },

  _initBinds: function () {
    this._routerModel.bind('change', this._onRouterChange, this);
    this._tablesCollection.bind('loading', this._onDataLoading, this);
    this._tablesCollection.bind('sync', this._onDataFetched, this);
    this._tablesCollection.bind('error', function (e) {
      // Old requests can be stopped, so aborted requests are not
      // considered as an error
      if (!e || (e && e.statusText !== 'abort')) {
        this._onDataError();
      }
    }, this);
    this.add_related_model(this._routerModel);
    this.add_related_model(this._tablesCollection);
  },

  _initViews: function () {
    this.controlledViews = {}; // All available views
    this.enabledViews = []; // Visible views

    var noDatasetsView = new ContentResultView({
      className: 'ContentResult no-datasets',
      userModel: this._userModel,
      routerModel: this._routerModel,
      tablesCollection: this._tablesCollection,
      template: noResultsTemplate
    });
    noDatasetsView.bind('connectDataset', function () {
      if (this._userModel.canCreateDatasets()) {
        this._createModel.set('listing', 'import');
      }
    }, this);
    noDatasetsView.render().hide();
    this.controlledViews['no_datasets'] = noDatasetsView;
    this.$el.append(noDatasetsView.el);
    this.addView(noDatasetsView);

    var listView = new DatasetsListView({
      userModel: this._userModel,
      createModel: this._createModel
    });
    this.controlledViews.list = listView;
    this.$el.append(listView.render().el);
    this.addView(listView);

    var noResultsView = new ContentResultView({
      userModel: this._userModel,
      routerModel: this._routerModel,
      tablesCollection: this._tablesCollection,
      template: datasetsNoResultTemplate
    });
    noResultsView.render().hide();
    this.controlledViews.no_results = noResultsView;
    this.$el.append(noResultsView.el);
    this.addView(noResultsView);

    var errorView = new ContentResultView({
      userModel: this._userModel,
      routerModel: this._routerModel,
      tablesCollection: this._tablesCollection,
      template: datasetsErrorTemplate
    });
    errorView.render().hide();
    this.controlledViews.error = errorView;
    this.$el.append(errorView.el);
    this.addView(errorView);

    var mainLoaderView = new ContentResultView({
      userModel: this._userModel,
      routerModel: this._routerModel,
      tablesCollection: this._tablesCollection,
      template: datasetsLoaderTemplate
    });
    this.controlledViews.main_loader = mainLoaderView;
    this.$el.append(mainLoaderView.render().el);
    this.addView(mainLoaderView);

    var datasetsPaginationView = new DatasetsPaginationView({
      routerModel: this._routerModel,
      tablesCollection: this._tablesCollection
    });
    this.controlledViews.content_footer = datasetsPaginationView;
    this.$el.append(datasetsPaginationView.render().el);
    this.addView(datasetsPaginationView);
  },

  _onRouterChange: function () {
    this._hideBlocks();
    this._showBlocks([ 'main_loader' ]);
  },

  /**
   * Arguments may vary, depending on if it's the collection or a model that triggers the event callback.
   * @private
   */
  _onDataFetched: function () {
    var activeViews = [ 'content_footer' ];
    var tag = this._routerModel.get('tag');
    var q = this._routerModel.get('q');
    var shared = this._routerModel.get('shared');
    var locked = this._routerModel.get('locked');
    var library = this._routerModel.get('library');

    if (library && this._tablesCollection.getTotalStat('total_user_entries') === 0) {
      activeViews.push('no_datasets');
    }

    if (this._tablesCollection.size() === 0) {
      if (!tag && !q && shared === 'no' && !locked) {
        if (!library) {
          this._goToLibrary();
          return;
        } else {
          activeViews.push('no_results');
        }
      } else {
        activeViews.push('no_results');
      }
    } else {
      activeViews.push('list');
    }

    this._hideBlocks();
    this._showBlocks(activeViews);
  },

  _onDataLoading: function () {
    this._hideBlocks();
    this._showBlocks([ 'main_loader' ]);
  },

  _onDataError: function (e) {
    this._hideBlocks();
    this._showBlocks([ 'error' ]);
  },

  _showBlocks: function (views) {
    var self = this;
    if (views) {
      _.each(views, function (v) {
        if (self.controlledViews[v]) {
          self.controlledViews[v].show();
          self.enabledViews.push(v);
        }
      });
    } else {
      self.enabledViews = [];
      _.each(this.controlledViews, function (v) {
        v.show();
        self.enabledViews.push(v);
      });
    }
  },

  _goToLibrary: function () {
    this._routerModel.set({
      shared: 'no',
      library: true,
      page: 1
    });
  },

  _hideBlocks: function (views) {
    var self = this;
    if (views) {
      _.each(views, function (v) {
        if (self.controlledViews[v]) {
          self.controlledViews[v].hide();
          self.enabledViews = _.without(self.enabledViews, v);
        }
      });
    } else {
      _.each(this.controlledViews, function (v) {
        v.hide();
      });
      self.enabledViews = [];
    }
  },

  _isBlockEnabled: function (name) {
    if (name) {
      return _.contains(this.enabledViews, name);
    }
    return false;
  }
});

},{"./content-result-view":300,"./datasets-error.tpl":303,"./datasets-list-view":304,"./datasets-loader.tpl":305,"./datasets-no-result.tpl":306,"./datasets-pagination-view":307,"./no-datasets.tpl":309,"backbone/core-view":1127,"underscore":"underscore"}],309:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h4 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m u-tSpace-xl">\n  '+
((__t=( _t('components.modals.add-layer.datasets.no-datasets.title') ))==null?'':_.escape(__t))+
'\n</h4>\n<p class="CDB-Text CDB-Size-medium u-altTextColor">\n  ';
 var connectDatasetHTML = '<button class="Button--link js-connect">' + _t('components.modals.add-layer.datasets.no-datasets.connect-datasets') + '</button>'; 
__p+='\n  ';
 var searchHTML = '<strong>' + _t('components.modals.add-layer.datasets.no-datasets.search') + '</strong>'; 
__p+='\n  '+
((__t=( _t('components.modals.add-layer.datasets.no-datasets.desc', {
      connectDataset: connectDatasetHTML,
      search: searchHTML
    }) ))==null?'':_.escape(__t))+
'\n</p>\n<div class="NoDatasets-illustration"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],310:[function(require,module,exports){
var cdb = require('cartodb.js');
var $ = require('jquery');
var DatasetItem = require('./dataset-item-view');
var moment = require('moment');
var markdown = require('markdown');
var Utils = require('../../../../../helpers/utils');
var TipsyTooltipView = require('../../../../tipsy-tooltip-view');
var UploadConfig = require('../../../../../config/upload-config');
var template = require('./remote-dataset-item.tpl');

/**
 *  Remote dataset item view
 *
 */

module.exports = DatasetItem.extend({
  tagName: 'li',
  className: 'ModalBlockList-item ModalBlockList-item--full',

  events: {
    'click .js-tag-link': '_onTagClick',
    'click': '_toggleSelected'
  },

  render: function () {
    var tableModel = this.model.getTableModel();
    var tags = this.model.get('tags') || [];
    var description = cdb.core.sanitize.html(this.model.get('description') || '');
    var source = markdown.toHTML(this.model.get('source') || '');
    var tableGeomColumnTypes = tableModel.getGeometryType() || [];

    var d = {
      isRaster: this.model.isRaster(),
      geometryType: tableGeomColumnTypes.length > 0 ? tableGeomColumnTypes[0] : '',
      title: this.model.get('display_name') || this.model.get('name'),
      source: source,
      description: description,
      timeDiff: moment(this.model.get('updated_at')).fromNow(),
      tags: tags,
      tagsCount: tags.length,
      routerModel: this._routerModel,
      maxTagsToShow: 3,
      canImportDataset: this._canImportDataset(),
      rowCount: undefined,
      datasetSize: undefined
    };

    var rowCount = tableModel.get('row_count');
    if (rowCount >= 0) {
      d.rowCount = rowCount;
      d.rowCountFormatted = (rowCount < 10000 ? Utils.formatNumber(rowCount) : Utils.readizableNumber(rowCount));
    }

    var datasetSize = tableModel.get('size');
    if (datasetSize >= 0) {
      d.datasetSize = Utils.readablizeBytes(
        datasetSize,
        datasetSize.toString().length > 9
      );
    }

    this.$el.html(template(d));
    this._setItemClasses();
    this._renderTooltips();

    return this;
  },

  _setItemClasses: function () {
    // Item selected?
    this.$el.toggleClass('is-selected', !!this.model.get('selected'));
    // Check if it is selectable
    this.$el.toggleClass('is-selectable', !!this._canImportDataset());
    // Check if it is importable
    this.$el.toggleClass('is-banned', !this._canImportDataset());
  },

  _renderTooltips: function () {
    this.addView(
      new TipsyTooltipView({
        el: this.$('.DatasetsList-itemStatus'),
        title: function (e) {
          return $(this).attr('data-title');
        }
      })
    );
  },

  _onTagClick: function (ev) {
    if (ev) {
      this.killEvent(ev);
    }

    var tag = $(ev.target).val();

    if (tag) {
      this._routerModel.set({
        tag: tag,
        library: true
      });
    }
  },

  _canImportDataset: function () {
    var tableModel = this.model.getTableModel();
    var tableSize = tableModel.get('size') || 0;
    return (
      this._userModel.get('remaining_byte_quota') * UploadConfig.fileTimesBigger >= tableSize &&
      this._userModel.get('limits')['import_file_size'] > tableSize
    );
  },

  _toggleSelected: function (ev) {
    // Let links use default behaviour
    if (ev.target.tagName !== 'A') {
      this.killEvent(ev);
      if (this._canImportDataset() && this._createModel.canSelect(this.model)) {
        this.model.set('selected', !this.model.get('selected'));
      }
    }
  }

});

},{"../../../../../config/upload-config":597,"../../../../../helpers/utils":1102,"../../../../tipsy-tooltip-view":589,"./dataset-item-view":301,"./remote-dataset-item.tpl":311,"cartodb.js":"cartodb.js","jquery":"jquery","markdown":1137,"moment":"moment"}],311:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="DatasetsList-itemCategory is--'+
((__t=( isRaster ? 'raster' : geometryType ))==null?'':_.escape(__t))+
'Dataset">\n  <i data-title="Public dataset" class="CDB-IconFont CDB-IconFont-book DatasetsList-itemStatus '+
((__t=( canImportDataset ? 'is-public' : 'is-banned' ))==null?'':_.escape(__t))+
'"></i>\n</div>\n<div class="ModalDataset-itemInfo">\n  <div class="ModalDataset-itemInfoTitle">\n    <h3 class="CDB-Text CDB-Size-large u-bSpace u-ellipsis">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h3>\n    ';
 if (description && description.length > 0) { 
__p+='\n      <p class="u-ellipsis CDB-Text CDB-Size-medium u-altTextColor" title="'+
((__t=( description ))==null?'':_.escape(__t))+
'">'+
((__t=( description ))==null?'':_.escape(__t))+
'</p>\n    ';
 } else { 
__p+='\n      <span class="NoResults CDB-Text CDB-Size-medium">'+
((__t=( _t('components.modals.add-layer.datasets.item.no-description')))==null?'':_.escape(__t))+
'</span>\n    ';
 } 
__p+='\n  </div>\n  <div>\n    <ul class="DatasetsList-itemMeta CDB-Text CDB-Size-small u-altTextColor">\n      ';
 if (rowCount) { 
__p+='\n        <li class="RowsIndicator">\n          '+
((__t=( rowCountFormatted ))==null?'':_.escape(__t))+
' '+
((__t=( _t('components.modals.add-layer.datasets.item.rows-pluralize', { smart_count: rowCount }) ))==null?'':_.escape(__t))+
'\n        </li>\n      ';
 } 
__p+='\n      ';
 if (datasetSize) { 
__p+='\n        <li class="SizeIndicator">\n          '+
((__t=( datasetSize ))==null?'':_.escape(__t))+
'\n        </li>\n      ';
 } 
__p+='\n      <li class="DatasetsList-itemTimeDiff DefaultTimeDiff CDB-Text CDB-Size-small u-altTextColor">\n        '+
((__t=( timeDiff ))==null?'':_.escape(__t))+
' <span class="DatasetsList-itemSource js-source">';
 if (source) { 
__p+=''+
((__t=( _t('components.modals.add-layer.datasets.item.from') ))==null?'':_.escape(__t))+
' '+
((__t=( cdb.core.sanitize.html(source) ))==null?'':__t)+
'';
 } 
__p+='</span>\n      </li>\n    </ul>\n    <div class="DatasetsList-itemMeta DatasetsList-itemTags">\n      ';
 if (tagsCount > 0) { 
__p+='\n        <div class="DefaultTags CDB-Text CDB-Size-small">\n          ';
 for (var i = 0, l = Math.min(maxTagsToShow, tags.length); i < l; ++i) { 
__p+='\n            <button class="CDB-Text CDB-Size-small u-upperCase DefaultTags-item js-tag-link u-actionTextColor" value="'+
((__t=( tags[i] ))==null?'':_.escape(__t))+
'">'+
((__t=( tags[i] ))==null?'':_.escape(__t))+
'</button>';
 if (i !== (l-1)) { 
__p+='';
 } 
__p+='\n          ';
 } 
__p+='\n          ';
 if (tagsCount > maxTagsToShow) { 
__p+='\n            '+
((__t=( _t('components.modals.add-layer.datasets.item.tags-more', { tagsCount: tagsCount - maxTagsToShow }) ))==null?'':_.escape(__t))+
'\n          ';
 } 
__p+='\n        </div>\n      ';
 } else { 
__p+='\n        <span class="NoResults CDB-Text CDB-Size-small u-altTextColor">'+
((__t=( _t('components.modals.add-layer.datasets.item.no-tags') ))==null?'':_.escape(__t))+
'</span>\n      ';
 } 
__p+='\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],312:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ImportPanel-header">\n  <div class="LayoutIcon u-bSpace--xl">\n    <i class="CDB-IconFont CDB-IconFont-gift"></i>\n  </div>\n  <h3 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m">ArcGIS<sup>&trade;</sup> '+
((__t=( _t('components.modals.add-layer.imports.connector') ))==null?'':_.escape(__t))+
'</h3>\n  <p class="CDB-Text CDB-Size-medium u-altTextColor u-bSpace--xl">\n    '+
((__t=( _t('components.modals.add-layer.imports.arcgis.fallback-desc', {
      brand: 'ArcGIS<sup>&trade;</sup>'
    }) ))==null?'':__t)+
'\n  </p>\n  <a href="mailto:sales@carto.com?subject='+
((__t=( _t('components.modals.add-layer.imports.demo-email-title', { name: 'ArcGIS' }) ))==null?'':_.escape(__t))+
'&body='+
((__t=( _t('components.modals.add-layer.imports.demo-email-desc', { name: 'ArcGIS' }) ))==null?'':_.escape(__t))+
'" class="CDB-Button CDB-Button--primary CDB-Button--medium">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.add-layer.imports.ask-for-demo') ))==null?'':_.escape(__t))+
'</span>\n  </a>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],313:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ImportPanel-header">\n  <div class="LayoutIcon u-bSpace--xl">\n    <i class="CDB-IconFont CDB-IconFont-gift"></i>\n  </div>\n  <h3 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m">Box '+
((__t=( _t('components.modals.add-layer.imports.connector') ))==null?'':_.escape(__t))+
'</h3>\n  <p class="CDB-Text CDB-Size-medium u-altTextColor u-bSpace--xl">\n    '+
((__t=( _t('components.modals.add-layer.imports.box.fallback-desc', { brand: 'Box' }) ))==null?'':_.escape(__t))+
'\n  </p>\n  <a href="mailto:sales@carto.com?subject='+
((__t=( _t('components.modals.add-layer.imports.demo-email-title', { name: 'Box' }) ))==null?'':_.escape(__t))+
'&body='+
((__t=( _t('components.modals.add-layer.imports.demo-email-desc', { name: 'Box' }) ))==null?'':_.escape(__t))+
'" class="CDB-Button CDB-Button--primary CDB-Button--medium">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.add-layer.imports.ask-for-demo') ))==null?'':_.escape(__t))+
'</span>\n  </a>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],314:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ImportPanel-header">\n  <div class="LayoutIcon u-bSpace--xl">\n    <i class="CDB-IconFont CDB-IconFont-gift"></i>\n  </div>\n  <h3 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m">MailChimp '+
((__t=( _t('components.modals.add-layer.imports.connector') ))==null?'':_.escape(__t))+
'</h3>\n  <p class="CDB-Text CDB-Size-medium u-altTextColor u-bSpace--xl">'+
((__t=( _t('components.modals.add-layer.imports.mailchimp.fallback-desc', { brand: 'Mailchimp' }) ))==null?'':_.escape(__t))+
'</p>\n  <a href="mailto:sales@carto.com?subject='+
((__t=( _t('components.modals.add-layer.imports.demo-email-title', { name: 'MailChimp' }) ))==null?'':_.escape(__t))+
'&body='+
((__t=( _t('components.modals.add-layer.imports.demo-email-desc', { name: 'MailChimp' }) ))==null?'':_.escape(__t))+
'" class="CDB-Button CDB-Button--primary CDB-Button--medium">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.add-layer.imports.ask-for-demo') ))==null?'':_.escape(__t))+
'</span>\n  </a>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],315:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ImportPanel-header">\n  <div class="LayoutIcon u-bSpace--xl">\n    <i class="CDB-IconFont CDB-IconFont-gift"></i>\n  </div>\n  <h3 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m">Salesforce '+
((__t=( _t('components.modals.add-layer.imports.connector') ))==null?'':_.escape(__t))+
'</h3>\n  <p class="CDB-Text CDB-Size-medium u-altTextColor u-bSpace--xl">\n    '+
((__t=( _t('components.modals.add-layer.imports.salesforce.fallback-desc', { brand: 'Salesforce' }) ))==null?'':_.escape(__t))+
'\n  </p>\n  <a href="mailto:sales@carto.com?subject='+
((__t=( _t('components.modals.add-layer.imports.demo-email-title', { name: 'Salesforce' }) ))==null?'':_.escape(__t))+
'&body='+
((__t=( _t('components.modals.add-layer.imports.demo-email-desc', { name: 'Salesforce' }) ))==null?'':_.escape(__t))+
'" class="CDB-Button CDB-Button--primary CDB-Button--medium">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.add-layer.imports.ask-for-demo') ))==null?'':_.escape(__t))+
'</span>\n  </a>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],316:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ImportPanel-header">\n  <div class="LayoutIcon u-bSpace--xl">\n    <i class="CDB-IconFont CDB-IconFont-gift"></i>\n  </div>\n  <h3 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m">'+
((__t=( _t('components.modals.add-layer.imports.twitter.fallback-title', { brand: 'Twitter' }) ))==null?'':_.escape(__t))+
'</h3>\n  <p class="CDB-Text CDB-Size-medium u-altTextColor u-bSpace--xl">\n    '+
((__t=( _t('components.modals.add-layer.imports.twitter.fallback-desc', { brand: 'Twitter' }) ))==null?'':_.escape(__t))+
'\n  </p>\n  <a href="mailto:sales@carto.com?subject='+
((__t=( _t('components.modals.add-layer.imports.demo-email-title', { name: 'Twitter' }) ))==null?'':_.escape(__t))+
'&body='+
((__t=( _t('components.modals.add-layer.imports.demo-email-desc', { name: 'Twitter' }) ))==null?'':_.escape(__t))+
'" class="CDB-Button CDB-Button--primary CDB-Button--medium">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">ask for a demo</span>\n  </a>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],317:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form class="Form js-form">\n  <div class="Form-row">\n    <div class="Form-rowLabel">\n      <label class="CDB-Text CDB-Size-medium">'+
((__t=( _t('components.modals.add-layer.imports.form-import.title') ))==null?'':_.escape(__t))+
'</label>\n    </div>\n    <div class="Form-rowData Form-rowData--longer">\n      <input type="text" class="CDB-Text CDB-Size-medium Form-input Form-input--longer has-submit js-textInput" value="" placeholder="'+
((__t=( _t('components.modals.add-layer.imports.arcgis.input-placeholder', { brand: 'ArcGIS Server&trade;' }) ))==null?'':__t)+
'" />\n      <button type="submit" class="CDB-Text CDB-Size-small Form-inputSubmit u-upperCase u-actionTextColor Form-inputSubmit">\n        <span>'+
((__t=( _t('components.modals.add-layer.imports.form-import.submit') ))==null?'':_.escape(__t))+
'</span>\n      </button>\n      <div class="Form-inputError CDB-Text">'+
((__t=( _t('components.modals.add-layer.imports.form-import.error-desc') ))==null?'':_.escape(__t))+
'</div>\n    </div>\n  </div>\n  <div class="Form-row">\n    <div class="Form-rowLabel"></div>\n    <div class="Form-rowData Form-rowData--longer">\n      <p class="CDB-Text CDB-Size-small Form-rowInfoText--centered Form-rowInfoText--block u-altTextColor">\n        '+
((__t=( _t('components.modals.add-layer.imports.form-import.format') ))==null?'':_.escape(__t))+
': http://&#60;host&#62;/arcgis/rest/services/&#60;folder&#62;/&#60;serviceName&#62;/&#60;serviceType&#62;<br/>\n        '+
((__t=( _t('components.modals.add-layer.imports.arcgis.url-desc') ))==null?'':_.escape(__t))+
'\n      </p>\n    </div>\n  </div>\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],318:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h3 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m">\n  ';
 if (state === 'selected') { 
__p+='\n    '+
((__t=( _t('components.modals.add-layer.imports.header-import.type-selected', { brand: 'ArcGIS<sup>&trade;</sup>' }) ))==null?'':__t)+
'\n  ';
 } else { 
__p+='\n    '+
((__t=( _t('components.modals.add-layer.imports.header-import.type-import', { brand: 'ArcGIS<sup>&trade;</sup>' }) ))==null?'':__t)+
'\n  ';
 } 
__p+='\n</h3>\n<p class="CDB-Text CDB-Size-medium u-altTextColor">\n  ';
 if (state !== "selected") { 
__p+='\n    '+
((__t=( _t('components.modals.add-layer.imports.arcgis.import-data', { brand: 'ArcGIS<sup>&trade;</sup>' }) ))==null?'':__t)+
'\n  ';
 } else { 
__p+='\n    '+
((__t=( _t('components.modals.add-layer.imports.arcgis.sync-options') ))==null?'':_.escape(__t))+
'\n  ';
 } 
__p+='\n</p>\n';
 if (state === "selected") { 
__p+='\n  <button class="NavButton NavButton--back ImportPanel-headerButton js-back">\n    <i class="CDB-IconFont CDB-IconFont-arrowPrev"></i>\n  </button>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],319:[function(require,module,exports){
var Utils = require('../../../../../../helpers/utils');
var SelectedDatasetView = require('../import-selected-dataset-view');
var template = require('../import-selected-dataset.tpl');

/**
 *  Selected ArcGIS dataset
 *
 *  - Displays the result when an ArcGIS url/dataset is selected, no matter the type.
 *  - It will show available sync options if user can and the url is an ArcGIS layer.
 *  - Upgrade link for people who don't have sync permissions.
 *
 */

module.exports = SelectedDatasetView.extend({
  render: function () {
    var title = this.options.fileAttrs.title && this.model.get('value')[this.options.fileAttrs.title] || this.model.get('value');
    var description = this._genDescription();
    var ext = this.options.fileAttrs.ext ? Utils.getFileExtension(title) : '';

    if (this.options.fileAttrs.ext) {
      title = title && title.replace('.' + ext, '');
    }

    var upgradeUrl = window.upgrade_url;
    var userCanSync = this._userModel.isActionEnabled('sync_tables');
    var customInstall = this._configModel.get('cartodb_com_hosted');

    this.$el.html(
      template({
        title: title,
        description: description,
        ext: ext,
        interval: this.model.get('interval'),
        importCanSync: this.options.acceptSync && this._isArcGISLayer(title),
        userCanSync: userCanSync,
        showTrial: this._userModel.canStartTrial(),
        showUpgrade: !userCanSync && !customInstall && upgradeUrl && !this._userModel.isInsideOrg(),
        upgradeUrl: upgradeUrl
      })
    );
    return this;
  },

  _isArcGISLayer: function (url) {
    return url.search(/([0-9]+\/|[0-9]+)/) !== -1;
  }

});

},{"../../../../../../helpers/utils":1102,"../import-selected-dataset-view":331,"../import-selected-dataset.tpl":332}],320:[function(require,module,exports){
var FormView = require('../import-data/import-data-form-view');
var HeaderView = require('../import-data/import-data-header-view');
var SelectedDatasetView = require('./import-arcgis-selected-dataset-view');
var ImportDataView = require('../import-data/import-data-view');
var headerTemplate = require('./import-arcgis-header.tpl');
var formTemplate = require('./import-arcgis-form.tpl');

/**
 *  Import ArcGIS panel
 *
 *  - It only accepts an url, and it could be a map or a layer.
 *
 */

module.exports = ImportDataView.extend({
  options: {
    fileExtensions: [],
    type: 'service',
    service: 'arcgis',
    acceptSync: true,
    fileEnabled: false,
    fileAttrs: {
      ext: false,
      title: '',
      description: ''
    }
  },

  _initViews: function () {
    var headerView = new HeaderView({
      el: this.$('.ImportPanel-header'),
      model: this.model,
      userModel: this._userModel,
      collection: this.collection,
      fileEnabled: this.options.fileEnabled,
      acceptSync: this.options.acceptSync,
      template: headerTemplate
    });
    headerView.render();
    this.addView(headerView);

    var selected = new SelectedDatasetView({
      el: this.$('.DatasetSelected'),
      userModel: this._userModel,
      model: this.model,
      acceptSync: this.options.acceptSync,
      fileAttrs: this.options.fileAttrs,
      configModel: this._configModel
    });
    selected.render();
    this.addView(selected);

    var formView = new FormView({
      el: this.$('.ImportPanel-form'),
      userModel: this._userModel,
      model: this.model,
      template: formTemplate,
      fileEnabled: this.options.fileEnabled
    });

    formView.render();
    this.addView(formView);
  }
});

},{"../import-data/import-data-form-view":321,"../import-data/import-data-header-view":323,"../import-data/import-data-view":325,"./import-arcgis-form.tpl":317,"./import-arcgis-header.tpl":318,"./import-arcgis-selected-dataset-view":319}],321:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var $ = require('jquery');
require('dragster');
var Dropzone = require('dropzone');
var template = require('./import-data-form.tpl');

/**
 *  Form view for url import for example
 *
 *  - It accepts an url
 *  - It checks if it is valid
 *  - It could have a file option
 *
 */

module.exports = CoreView.extend({
  options: {
    template: '',
    fileEnabled: false
  },

  events: {
    'keyup .js-textInput': '_onTextChanged',
    'submit .js-form': '_onSubmitForm'
  },

  initialize: function (opts) {
    if (!opts.userModel) throw new Error('userModel is required');

    this._userModel = opts.userModel;
    this.template = opts.template || template;
    this._initBinds();
    this._checkVisibility();
  },

  render: function () {
    this.$el.html(
      this.template(this.options)
    );
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this.model.bind('change:state', this._checkVisibility, this);
  },

  _initViews: function () {
    if (this.options.fileEnabled) {
      var self = this;
      this.$('.js-fileInput').bind('change', function (e) {
        if (this.files && this.files.length > 0) {
          self._onFileChanged(this.files);
        }
        this.value = '';
      });

      this._initDropzone();
    }
  },

  _initDropzone: function () {
    var el = $('html')[0]; // :(
    var self = this;

    this.dragster = new Dragster(el); // eslint-disable-line

    $(el).bind('dragster:enter', function (e) {
      self._showDropzone();
    });

    $(el).bind('dragster:leave', function (e) {
      self._hideDropzone();
    });

    if (el.dropzone) { // avoid loading the dropzone twice
      return;
    }

    this.dropzone = new Dropzone(el, {
      url: ':)',
      autoProcessQueue: false,
      previewsContainer: false
    });

    this.dropzone.on('dragover', function () {
      self._showDropzone();
    });

    this.dropzone.on('drop', function (ev) {
      var files = ev.dataTransfer.files;
      self._onFileChanged(files);
      self._hideDropzone();
    });
  },

  _destroyDropzone: function () {
    var el = $('html')[0]; // :(

    if (this.dragster) {
      this.dragster.removeListeners();
      this.dragster.reset();
      $(el).unbind('dragster:enter dragster:leave');
    }

    if (this.dropzone) {
      this.dropzone.destroy();
    }
  },

  _setValidFileExtensions: function (list) {
    return RegExp('(\.|\/)(' + list.join('|') + ')$', 'i');
  },

  _onTextChanged: function () {
    var value = this.$('.js-textInput').val();
    if (!value) {
      this._hideTextError();
    }
  },

  _onFileChanged: function (files) {
    this.trigger('fileSelected', this);

    if (files && files.length === 1) {
      files = files[0];
    }

    this.model.setUpload({
      type: 'file',
      value: files
    });

    if (this.model.get('state') !== 'error') {
      this._hideFileError();
      this.model.set('state', 'selected');
    } else {
      this._showFileError();
    }
  },

  _showTextError: function () {
    this.$('.Form-inputError').addClass('is-visible');
  },

  _hideTextError: function () {
    this.$('.Form-inputError').removeClass('is-visible');
  },

  _showDropzone: function () {
    this.$('.Form-upload').addClass('is-dropping');
    this._hideFileError();
  },

  _hideDropzone: function () {
    this.$('.Form-upload').removeClass('is-dropping');
  },

  _showFileError: function () {
    if (this.model.get('state') === 'error') {
      this.$('.js-fileError')
        .text(this.model.get('get_error_text').what_about)
        .show();
      this.$('.js-fileLabel').hide();
      this.$('.js-fileButton').addClass('Button--negative');
    }
  },

  _hideFileError: function () {
    this.$('.js-fileError').hide();
    this.$('.js-fileLabel').show();
    this.$('.js-fileButton').removeClass('Button--negative');
  },

  _onSubmitForm: function (e) {
    if (e) this.killEvent(e);

    var value = this.$('.js-textInput').val();

    if (!value) {
      this._hideTextError();
      return;
    }

    // Change file attributes :S
    this.trigger('urlSelected', this);

    // Change model
    var importType = this.model.get('service_name') ? 'service' : 'url';
    this.model.setUpload({
      type: importType,
      value: value,
      service_item_id: value,
      state: 'idle'
    });

    if (this.model.get('state') !== 'error') {
      this._hideFileError();
      this._hideTextError();
      this.model.set('state', 'selected');
    } else {
      this._showTextError();
    }
  },

  _checkVisibility: function () {
    var state = this.model.get('state');
    this[ state !== 'selected' ? 'show' : 'hide' ]();
  },

  clean: function () {
    this._destroyDropzone();
    this.$('.js-fileInput').unbind('change');
    CoreView.prototype.clean.apply(this);
  }

});

},{"./import-data-form.tpl":322,"backbone/core-view":1127,"dragster":1134,"dropzone":1135,"jquery":"jquery"}],322:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form class="Form js-form">\n  <div class="Form-row Form-row--centered">\n    ';
 if (fileEnabled) { 
__p+='\n      <div class="Form-rowData Form-rowData--med Form-rowData--noMargin js-dropzone">\n        <div class="Form-upload">\n          <label class="Form-fileLabel js-fileLabel CDB-Text CDB-Size-medium">'+
((__t=( _t('components.modals.add-layer.imports.form-import.drag-and-drop') ))==null?'':_.escape(__t))+
'</label>\n          <label class="Form-fileLabel Form-fileLabel--error CDB-Text CDB-Size-small js-fileError"></label>\n          <div class="Form-file">\n            <input type="file" class="js-fileInput" />\n            <span class="CDB-Button CDB-Button--primary Form-fileButton CDB-Button-Text CDB-Text is-semibold CDB-Size-small u-upperCase js-fileButton">\n              '+
((__t=( _t('components.modals.add-layer.imports.form-import.browse') ))==null?'':_.escape(__t))+
'\n            </span>\n          </div>\n        </div>\n      </div>\n      <span class="u-lSpace--xl u-rSpace--xl u-flex u-alignCenter CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( _t('components.modals.add-layer.imports.form-import.or') ))==null?'':_.escape(__t))+
'</span>\n    ';
 } 
__p+='\n    <div class="Form-rowData Form-rowData--noMargin Form-rowData--med">\n      <input type="text" class="Form-input Form-input--med has-submit js-textInput CDB-Text CDB-Size-medium" value="" placeholder="https://carto.com/data-library" />\n      <button type="submit" class="CDB-Text CDB-Size-small Form-inputSubmit u-upperCase u-actionTextColor Form-inputSubmit">\n        <span>'+
((__t=( _t('components.modals.add-layer.imports.form-import.submit') ))==null?'':_.escape(__t))+
'</span>\n      </button>\n      <div class="Form-inputError CDB-Text">'+
((__t=( _t('components.modals.add-layer.imports.form-import.error-desc') ))==null?'':_.escape(__t))+
'</div>\n    </div>\n  </div>\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],323:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./import-data-header.tpl');

/**
 *  Data header view
 *
 *  - It will change when upload state changes
 *  - Possibility to change state with a header button
 *
 */

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_goToStart'
  },

  options: {
    fileEnabled: false,
    acceptSync: false
  },

  initialize: function (opts) {
    if (!opts.userModel) throw new Error('userModel is required');

    this._userModel = opts.userModel;
    this.template = opts.template || template;
    this._initBinds();
    this._checkVisibility();
  },

  render: function () {
    var acceptSync = this.options.acceptSync && this._userModel.get('actions') && this._userModel.isActionEnabled('sync_tables') && this.model.get('type') !== 'file';

    this.$el.html(
      this.template({
        type: this.model.get('type'),
        fileEnabled: this.options.fileEnabled,
        acceptSync: acceptSync,
        state: this.model.get('state')
      })
    );
    this._checkVisibility();
    return this;
  },

  _initBinds: function () {
    this.model.bind('change:state', this.render, this);
  },

  _checkVisibility: function () {
    this.show();
  },

  _goToStart: function () {
    this.model.set('state', 'idle');
  }

});

},{"./import-data-header.tpl":324,"backbone/core-view":1127}],324:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h3 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m">\n  ';
 if (state === 'selected') { 
__p+='\n    '+
((__t=( _t('components.modals.add-layer.imports.header-import.file-selected') ))==null?'':_.escape(__t))+
'\n  ';
 } else { 
__p+='\n    '+
((__t=( _t('components.modals.add-layer.imports.header-import.upload-file-url', { smart_count: fileEnabled ? 1 : 0 }) ))==null?'':_.escape(__t))+
'\n  ';
 } 
__p+='\n</h3>\n<p class="CDB-Text CDB-Size-medium u-altTextColor">\n  ';
 if (state !== "selected") { 
__p+='\n    ';
 fileEnabledText = _t('components.modals.add-layer.imports.header-import.select-a-file') +
      ' <a href="https://carto.com/docs/carto-engine/import-api/importing-geospatial-data/#supported-geospatial-data-formats">' +
      _t('components.modals.add-layer.imports.header-import.see-all-formats') +
      '</a>'
    
__p+='\n    '+
((__t=( _t('components.modals.add-layer.imports.header-import.paste-url', {
      fileEnabled: fileEnabled ? fileEnabledText : ''
    }) ))==null?'':__t)+
'\n  ';
 } 
__p+='\n  ';
 if (state === "selected") { 
__p+='\n    ';
 if (acceptSync) { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.imports.header-import.sync-enabled') ))==null?'':_.escape(__t))+
'\n    ';
 } else { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.imports.header-import.sync-disabled') ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  ';
 } 
__p+='\n</p>\n';
 if (state === "selected") { 
__p+='\n  <button class="NavButton NavButton--back ImportPanel-headerButton js-back">\n    <i class="CDB-IconFont CDB-IconFont-arrowPrev"></i>\n  </button>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],325:[function(require,module,exports){
var ImportView = require('../import-view');
var UploadModel = require('../../../../../../data/upload-model');
var FormView = require('./import-data-form-view');
var HeaderView = require('./import-data-header-view');
var SelectedDatasetView = require('../import-selected-dataset-view');
var template = require('./import-data.tpl');

/**
 *  Import data panel
 *
 *  - It accepts an url
 *  - It checks if it is valid
 *
 */

module.exports = ImportView.extend({
  options: {
    fileExtensions: [],
    type: 'url',
    service: '',
    acceptSync: false,
    fileEnabled: false,
    formTemplate: '',
    headerTemplate: '',
    fileAttrs: {}
  },

  className: 'ImportPanel ImportDataPanel',

  initialize: function (opts) {
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.configModel) throw new Error('configModel is required');

    this._userModel = opts.userModel;
    this._configModel = opts.configModel;
    this.model = new UploadModel({
      type: this.options.type,
      service_name: this.options.service
    }, {
      userModel: this._userModel,
      configModel: this._configModel
    });

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());
    this._initViews();
    return this;
  },

  _initViews: function () {
    var headerView = new HeaderView({
      el: this.$('.ImportPanel-header'),
      model: this.model,
      userModel: this._userModel,
      fileEnabled: this.options.fileEnabled,
      acceptSync: this.options.acceptSync,
      template: this.options.headerTemplate
    });
    headerView.render();
    this.addView(headerView);

    var selected = new SelectedDatasetView({
      el: this.$('.DatasetSelected'),
      userModel: this._userModel,
      model: this.model,
      acceptSync: this.options.acceptSync,
      fileAttrs: this.options.fileAttrs,
      configModel: this._configModel
    });
    selected.render();
    this.addView(selected);

    var formView = new FormView({
      el: this.$('.ImportPanel-form'),
      userModel: this._userModel,
      model: this.model,
      template: this.options.formTemplate,
      fileEnabled: this.options.fileEnabled
    });

    formView.bind('fileSelected', function () {
      selected.setOptions({
        acceptSync: false,
        fileAttrs: {
          ext: true,
          title: 'name',
          description: {
            content: [{
              name: 'size',
              format: 'size'
            }]
          }
        }
      });
    });

    formView.bind('urlSelected', function () {
      selected.setOptions({
        acceptSync: true,
        fileAttrs: {
          ext: false,
          title: '',
          description: ''
        }
      });
    });
    formView.render();
    this.addView(formView);
  },

  _initBinds: function () {
    this.model.bind('change:state', this._checkState, this);
    this.model.bind('change', this._triggerChange, this);
  },

  _checkState: function () {
    if (this.model.previous('state') === 'selected') {
      this.model.set({
        type: undefined,
        value: '',
        service_name: '',
        service_item_id: '',
        interval: 0
      });
    }
  }

});

},{"../../../../../../data/upload-model":668,"../import-selected-dataset-view":331,"../import-view":359,"./import-data-form-view":321,"./import-data-header-view":323,"./import-data.tpl":326}],326:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ImportPanel-header">\n  <h3 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m">'+
((__t=( _t('components.modals.add-layer.imports.form-import.title') ))==null?'':_.escape(__t))+
'</h3>\n  <p class="ImportPanel-headerDescription">'+
((__t=( _t('components.modals.add-layer.imports.form-import.desc') ))==null?'':_.escape(__t))+
'</p>\n</div>\n<div class="ImportPanel-body">\n  <div class="ImportPanel-bodyWrapper">\n    <div class="ImportPanel-state ImportPanel-form is-idle"></div>\n    <div class="ImportPanel-state is-selected DatasetSelected"></div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],327:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (state !== 'list' ) { 
__p+='\n  <h3 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m">\n    ';
 if (state === 'selected') { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.imports.mailchimp.campaign-selected', { brand: 'MailChimp' }) ))==null?'':_.escape(__t))+
'\n    ';
 } else { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.imports.mailchimp.map-campaign', { brand: 'MailChimp' }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  </h3>\n  <p class="CDB-Text CDB-Size-medium u-altTextColor ';
 if (state === "error") { 
__p+='ImportPanel-headerDescription--negative';
 } 
__p+='">\n    ';
 if (state === "idle") { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.imports.mailchimp.state-idle', { brand: 'MailChimp' }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n    ';
 if (state === "error") { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.imports.mailchimp.state-error', { brand: 'MailChimp' }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n    ';
 if (state === "token") { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.imports.mailchimp.state-token', { brand: 'MailChimp' }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n    ';
 if (state === "oauth") { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.imports.mailchimp.state-oauth', { brand: 'MailChimp' }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n    ';
 if (state === "retrieving") { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.imports.mailchimp.state-retrieving', { brand: 'MailChimp' }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n    ';
 if (state === "selected") { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.imports.mailchimp.state-selected', { brand: 'MailChimp' }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  </p>\n  ';
 if (state === "selected") { 
__p+='\n    <button class="NavButton NavButton--back ImportPanel-headerButton js-back">\n      <i class="CDB-IconFont CDB-IconFont-arrowPrev"></i>\n    </button>\n  ';
 } 
__p+='\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],328:[function(require,module,exports){
var ImportDataView = require('./import-data/import-data-view');
var ImportServiceView = require('./import-service/import-service-view');
var ImportArcGISView = require('./import-arcgis/import-arcgis-view');
var ImportTwitterView = require('./import-twitter/import-twitter-view');

/**
 * Attributes:
 *
 *  view: import pane class view
 *  enabled: function that takes configModel and returns whether the service is enabled
 *  fallbackClassName: ...
 *  name: local name
 *  title: text for tab link
 *  options:
 *    - service:
 *    - fileExtensions:
 *    - showAvailableFormats:
 *    - acceptSync:
 *    - fileAttrs:
 *
 */

module.exports = {

  File: {
    view: ImportDataView,
    enabled: function (config, userModel) { return true; },
    name: 'file',
    title: 'Data file',
    options: {
      type: 'url',
      fileEnabled: true,
      acceptSync: true
    }
  },
  GDrive: {
    view: ImportServiceView,
    enabled: function (config, userModel) { return !!config.get('oauth_gdrive'); },
    name: 'gdrive',
    title: 'Google Drive',
    options: {
      service: 'gdrive',
      fileExtensions: ['Google SpreadSheet', 'CSV'],
      showAvailableFormats: false,
      acceptSync: true,
      fileAttrs: {
        ext: true,
        title: 'filename',
        description: {
          content: [{
            name: 'size',
            format: 'size',
            key: true
          }]
        }
      }
    }
  },
  Dropbox: {
    view: ImportServiceView,
    enabled: function (config, userModel) { return !!config.get('oauth_dropbox'); },
    name: 'dropbox',
    title: 'Dropbox',
    options: {
      service: 'dropbox',
      fileExtensions: ['CSV', 'XLS'],
      showAvailableFormats: false,
      acceptSync: true,
      fileAttrs: {
        ext: true,
        title: 'filename',
        description: {
          content: [
            {
              name: 'id',
              format: ''
            },
            {
              name: 'size',
              format: 'size',
              key: true
            }
          ],
          separator: '-'
        }
      }
    }
  },
  Box: {
    view: ImportServiceView,
    enabled: function (config, userModel) { return !!config.get('oauth_box'); },
    name: 'box',
    title: 'Box',
    fallback: require('./fallbacks/import-box-fallback.tpl'),
    options: {
      service: 'box',
      fileExtensions: ['CSV', 'XLS'],
      showAvailableFormats: false,
      acceptSync: true,
      fileAttrs: {
        ext: true,
        title: 'filename',
        description: {
          content: [
            {
              name: 'size',
              format: 'size',
              key: true
            }
          ],
          separator: '-'
        }
      }
    }
  },
  Twitter: {
    view: ImportTwitterView,
    enabled: function (config, userModel) { return userModel.get('twitter').enabled && !!config.get('datasource_search_twitter'); },
    fallback: require('./fallbacks/import-twitter-fallback.tpl'),
    name: 'twitter',
    title: 'Twitter'
  },
  Mailchimp: {
    view: ImportServiceView,
    enabled: function (config, userModel) { return userModel.get('mailchimp').enabled && !!config.get('oauth_mailchimp'); },
    fallback: require('./fallbacks/import-mailchimp-fallback.tpl'),
    name: 'mailchimp',
    title: 'MailChimp',
    options: {
      service: 'mailchimp',
      fileExtensions: [],
      acceptSync: true,
      showAvailableFormats: false,
      headerTemplate: require('./import-mailchimp/import-data-header-mailchimp.tpl'),
      fileAttrs: {
        ext: true,
        title: 'filename',
        description: {
          content: [{
            name: 'member_count',
            format: 'number',
            key: true
          }],
          itemName: 'member',
          separator: ''
        }
      }
    }
  },
  // Instagram: {
  //   view: ImportServiceView,
  //   fallback: require('./fallbacks/import-instagram-fallback.tpl'),
  //   name: 'instagram',
  //   title: 'Instagram',
  //   options: {
  //     service: 'instagram',
  //     fileExtensions: [],
  //     acceptSync: false,
  //     showAvailableFormats: false,
  //     fileAttrs: {
  //       ext: false,
  //       title: 'title'
  //     }
  //   }
  // },
  Arcgis: {
    view: ImportArcGISView,
    enabled: function (config, userModel) { return config.get('arcgis_enabled'); },
    fallback: require('./fallbacks/import-arcgis-fallback.tpl'),
    name: 'arcgis',
    title: 'ArcGIS Server&trade;'
  },
  Salesforce: {
    view: ImportDataView,
    enabled: function (config, userModel) { return config.get('salesforce_enabled'); },
    fallback: require('./fallbacks/import-salesforce-fallback.tpl'),
    name: 'salesforce',
    title: 'Salesforce',
    options: {
      type: 'service',
      service_name: 'salesforce',
      acceptSync: true,
      formTemplate: require('./import-salesforce/import-data-form-salesforce.tpl'),
      headerTemplate: require('./import-salesforce/import-data-header-salesforce.tpl')
    }
  }
};

},{"./fallbacks/import-arcgis-fallback.tpl":312,"./fallbacks/import-box-fallback.tpl":313,"./fallbacks/import-mailchimp-fallback.tpl":314,"./fallbacks/import-salesforce-fallback.tpl":315,"./fallbacks/import-twitter-fallback.tpl":316,"./import-arcgis/import-arcgis-view":320,"./import-data/import-data-view":325,"./import-mailchimp/import-data-header-mailchimp.tpl":327,"./import-salesforce/import-data-form-salesforce.tpl":329,"./import-salesforce/import-data-header-salesforce.tpl":330,"./import-service/import-service-view":346,"./import-twitter/import-twitter-view":352}],329:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form class="Form js-form">\n  <div class="Form-row">\n    <div class="Form-rowLabel">\n      <label class="CDB-Text CDB-Size-medium"><span>'+
((__t=( _t('components.modals.add-layer.imports.form-import.title') ))==null?'':_.escape(__t))+
'</span></label>\n    </div>\n    <div class="Form-rowData Form-rowData--longer">\n      <input type="text" class="CDB-Text CDB-Size-medium Form-input Form-input--longer has-submit js-textInput" value="" placeholder="'+
((__t=( _t('components.modals.add-layer.imports.salesforce.salesforce.input-placeholder', { brand: 'Salesforce' }) ))==null?'':_.escape(__t))+
'" />\n      <button type="submit" class="CDB-Text CDB-Size-small Form-inputSubmit u-upperCase u-actionTextColor Form-inputSubmit">\n        <span>'+
((__t=( _t('components.modals.add-layer.imports.form-import.submit') ))==null?'':_.escape(__t))+
'</span>\n      </button>\n      <div class="Form-inputError CDB-Text">\n        <span>'+
((__t=( _t('components.modals.add-layer.imports.form-import.error-desc') ))==null?'':_.escape(__t))+
'</span>\n      </div>\n    </div>\n  </div>\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],330:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h3 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m">\n  ';
 if (state === 'selected') { 
__p+='\n    '+
((__t=( _t('components.modals.add-layer.imports.header-import.type-selected', { brand: 'Salesforce'}) ))==null?'':_.escape(__t))+
'\n  ';
 } else { 
__p+='\n    '+
((__t=( _t('components.modals.add-layer.imports.header-import.type-import', { brand: 'Salesforce'}) ))==null?'':_.escape(__t))+
'\n  ';
 } 
__p+='\n</h3>\n<p class="CDB-Text CDB-Size-medium u-altTextColor">\n  ';
 if (state !== "selected") { 
__p+='\n    '+
((__t=( _t('components.modals.add-layer.imports.header-import.import-url', { brand: 'Salesforce'}) ))==null?'':_.escape(__t))+
'\n  ';
 } else { 
__p+='\n    ';
 if (acceptSync) { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.imports.header-import.sync-enabled', { brand: 'Salesforce'}) ))==null?'':_.escape(__t))+
'\n    ';
 } else { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.imports.header-import.sync-disabled', { brand: 'Salesforce'}) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  ';
 } 
__p+='\n</p>\n';
 if (state === "selected") { 
__p+='\n  <button class="NavButton NavButton--back ImportPanel-headerButton js-back">\n    <i class="CDB-IconFont CDB-IconFont-arrowPrev"></i>\n  </button>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],331:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var Utils = require('../../../../../helpers/utils');
var template = require('./import-selected-dataset.tpl');

/**
 *  Selected dataset
 *
 *  - Displays the result when a dataset is selected, no matter the type.
 *  - It will show available sync options if that import lets it.
 *  - Upgrade link for people who don't have sync permissions.
 *
 */

module.exports = CoreView.extend({
  className: 'DatasetSelected',

  _FORMATTERS: {
    'size': Utils.readablizeBytes,
    'number': Utils.formatNumber
  },

  options: {
    acceptSync: false,
    fileAttrs: {
      ext: false,
      title: '',
      description: {
        content: [{
          name: 'id',
          format: ''
        }],
        itemName: '',
        separator: ''
      }
    }
  },

  events: {
    'click .js-interval-0': '_onIntervalZero',
    'click .js-interval-1': '_onIntervalHour',
    'click .js-interval-2': '_onIntervalDay',
    'click .js-interval-3': '_onIntervalWeek',
    'click .js-interval-4': '_onIntervalMonth'
  },

  initialize: function (opts) {
    if (!opts.userModel) throw new TypeError('userModel is required');
    if (!opts.configModel) throw new TypeError('configModel is required');

    this._configModel = opts.configModel;
    this._userModel = opts.userModel;
    this._initBinds();
    this._checkVisibility();
  },

  render: function () {
    var title = this.options.fileAttrs.title && this.model.get('value')[this.options.fileAttrs.title] || this.model.get('value');
    var description = this._genDescription();
    var ext = this.options.fileAttrs.ext ? Utils.getFileExtension(title) : '';

    if (this.options.fileAttrs.ext) {
      title = title && title.replace('.' + ext, '');
    }

    var upgradeUrl = window.upgrade_url;
    var userCanSync = this._userModel.isActionEnabled('sync_tables');
    var customInstall = this._configModel.get('cartodb_com_hosted');

    this.$el.html(
      template({
        title: title,
        description: description,
        ext: ext,
        interval: this.model.get('interval'),
        importCanSync: this.options.acceptSync,
        userCanSync: userCanSync,
        showTrial: this._userModel.canStartTrial(),
        showUpgrade: !userCanSync && !customInstall && upgradeUrl && !this._userModel.isInsideOrg(),
        upgradeUrl: upgradeUrl
      })
    );
    return this;
  },

  _initBinds: function () {
    this.model.bind('change:value', this.render, this);
    this.model.bind('change:interval', this.render, this);
    this.model.bind('change:state', this._checkVisibility, this);
  },

  _genDescription: function () {
    if (this.options.fileAttrs && this.options.fileAttrs.description) {
      var descriptionOpts = this.options.fileAttrs.description;
      var descriptionKeyValue = '';
      var descriptionStr = '';
      var self = this;

      if (descriptionOpts.content && descriptionOpts.content.length > 0) {
        _.each(descriptionOpts.content, function (item, i) {
          if (i > 0 && descriptionOpts.separator) {
            descriptionStr += ' ' + descriptionOpts.separator + ' ';
          }

          var value = self.model.get('value')[item.name];
          var format = item.format && self._FORMATTERS[item.format];
          descriptionStr += format && format(value) || value;

          if (item.key) {
            descriptionKeyValue = item.name;
          }
        });
      }

      if (descriptionOpts.itemName && descriptionKeyValue) {
        descriptionStr += ' ' + (descriptionOpts.itemName && _t('components.modals.add-layer.imports.' + descriptionOpts.itemName + '-pluralize', { smart_count: descriptionKeyValue }) || '');
      }

      return descriptionStr;
    }

    return '';
  },

  _onIntervalZero: function () {
    this.model.set('interval', 0);
  },

  _onIntervalHour: function () {
    if (this.options.acceptSync && this._userModel.isActionEnabled('sync_tables')) {
      this.model.set('interval', 3600);
    }
  },

  _onIntervalDay: function () {
    if (this.options.acceptSync && this._userModel.isActionEnabled('sync_tables')) {
      this.model.set('interval', 86400);
    }
  },

  _onIntervalWeek: function () {
    if (this.options.acceptSync && this._userModel.isActionEnabled('sync_tables')) {
      this.model.set('interval', 604800);
    }
  },

  _onIntervalMonth: function () {
    if (this.options.acceptSync && this._userModel.isActionEnabled('sync_tables')) {
      this.model.set('interval', 2592000);
    }
  },

  setOptions: function (d) {
    if (d && !_.isEmpty(d)) {
      _.extend(this.options, d);
    }
  },

  _checkVisibility: function () {
    var state = this.model.get('state');
    if (state === 'selected') {
      this.show();
    } else {
      this.hide();
    }
  }

});

},{"../../../../../helpers/utils":1102,"./import-selected-dataset.tpl":332,"backbone/core-view":1127,"underscore":"underscore"}],332:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="DatasetSelected-item">\n  <div class="DatasetSelected-itemExt CDB-Text u-ellipsis">\n    '+
((__t=( ext || '?' ))==null?'':_.escape(__t))+
'\n  </div>\n  <div class="DatasetSelected-itemInfo u-ellipsis">\n    <h6 class="CDB-Text CDB-Size-large u-ellipsis" title="'+
((__t=( title ))==null?'':_.escape(__t))+
'">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h6>\n    <p class="CDB-Text CDB-Size-small u-ellipsis u-altTextColor">'+
((__t=( description ))==null?'':_.escape(__t))+
'</p>\n  </div>\n</div>\n';
 if (importCanSync) { 
__p+='\n  <div class="DatasetSelected-sync">\n    <div class="DatasetSelected-syncOptions">\n      <label class="DatasetSelected-syncLabel CDB-Text CDB-Size-medium u-mainTextColor">\n        '+
((__t=( _t('components.modals.add-layer.imports.selected-state.sync-my-data') ))==null?'':_.escape(__t))+
'\n      </label>\n      <ul class="DatasetSelected-syncOptionsList">\n        <li class="DatasetSelected-syncOptionsItem">\n          <div class="RadioButton">\n            <button class="RadioButton-input js-interval-0 '+
((__t=( interval === 0 ? 'is-checked' : '' ))==null?'':_.escape(__t))+
'"></button>\n            <label class="CDB-Text CDB-Size-medium u-altTextColor u-lSpace">'+
((__t=( _t('components.modals.add-layer.imports.selected-state.never') ))==null?'':_.escape(__t))+
'</label>\n          </div>\n        </li>\n        <li class="DatasetSelected-syncOptionsItem">\n          <div class="RadioButton '+
((__t=( !userCanSync ? 'is-disabled' : '' ))==null?'':_.escape(__t))+
'">\n            <button class="RadioButton-input js-interval-1 '+
((__t=( interval === 3600 ? 'is-checked' : '' ))==null?'':_.escape(__t))+
'"></button>\n            <label class="CDB-Text CDB-Size-medium u-altTextColor u-lSpace">'+
((__t=( _t('components.modals.add-layer.imports.selected-state.every-hour') ))==null?'':_.escape(__t))+
'</label>\n          </div>\n        </li>\n        <li class="DatasetSelected-syncOptionsItem">\n          <div class="RadioButton '+
((__t=( !userCanSync ? 'is-disabled' : '' ))==null?'':_.escape(__t))+
'">\n            <button class="RadioButton-input js-interval-2 '+
((__t=( interval === 86400 ? 'is-checked' : '' ))==null?'':_.escape(__t))+
'"></button>\n            <label class="CDB-Text CDB-Size-medium u-altTextColor u-lSpace">'+
((__t=( _t('components.modals.add-layer.imports.selected-state.every-day') ))==null?'':_.escape(__t))+
'</label>\n          </div>\n        </li>\n        <li class="DatasetSelected-syncOptionsItem">\n          <div class="RadioButton '+
((__t=( !userCanSync ? 'is-disabled' : '' ))==null?'':_.escape(__t))+
'">\n            <button class="RadioButton-input js-interval-3 '+
((__t=( interval === 604800 ? 'is-checked' : '' ))==null?'':_.escape(__t))+
'"></button>\n            <label class="CDB-Text CDB-Size-medium u-altTextColor u-lSpace">'+
((__t=( _t('components.modals.add-layer.imports.selected-state.every-week') ))==null?'':_.escape(__t))+
'</label>\n          </div>\n        </li>\n        <li class="DatasetSelected-syncOptionsItem">\n          <div class="RadioButton '+
((__t=( !userCanSync ? 'is-disabled' : '' ))==null?'':_.escape(__t))+
'">\n            <button class="RadioButton-input js-interval-4 '+
((__t=( interval === 2592000 ? 'is-checked' : '' ))==null?'':_.escape(__t))+
'"></button>\n            <label class="CDB-Text CDB-Size-medium u-altTextColor u-lSpace">'+
((__t=( _t('components.modals.add-layer.imports.selected-state.every-month') ))==null?'':_.escape(__t))+
'</label>\n          </div>\n        </li>\n      </ul>\n    </div>\n    ';
 if (showUpgrade) { 
__p+='\n      <div class="Upgrade-info">\n        <p class="CDB-Text CDB-Size-medium u-ellipsis u-secondaryTextColor">\n         ';
 featuresLink = '<a href="https://carto.com/pricing">' + _t('components.modals.add-layer.imports.selected-state.more-features') + '</a>' 
__p+='\n          '+
((__t=( _t('components.modals.add-layer.imports.selected-state.upgrade-desc', { features: featuresLink }) ))==null?'':_.escape(__t))+
'\n        </p>\n        <div class="Upgrade-infoActions">\n          ';
 if (showTrial) { 
__p+='\n            <p class="CDB-Text CDB-Size-medium u-ellipsis is-semibold u-rSpace--xl">'+
((__t=( _t('components.modals.add-layer.imports.selected-state.free-trial', { days: 14 }) ))==null?'':_.escape(__t))+
'</p>\n          ';
 } 
__p+='\n          <a href="'+
((__t=( upgradeUrl ))==null?'':_.escape(__t))+
'" class="CDB-Button CDB-Button--secondary">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.add-layer.imports.selected-state.upgrade') ))==null?'':_.escape(__t))+
'</span>\n          </a>\n        </div>\n      </div>\n    ';
 } 
__p+='\n  </div>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],333:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./import-service-header.tpl');

/**
 *  Service header
 *
 *  - It will change when upload state changes
 *  - Possibility to change state with a header button
 *
 */

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_goToList'
  },

  options: {
    title: 'Service',
    showAvailableFormats: false,
    acceptSync: false,
    fileExtensions: [],
    template: ''
  },

  initialize: function (opts) {
    if (!opts.userModel) throw new Error('userModel is required');
    this._userModel = opts.userModel;
    this.template = opts.template || template;
    this._initBinds();
  },

  render: function () {
    this.$el.html(
      this.template({
        items: this.collection.size(),
        service_name: this.model.get('service_name'),
        showAvailableFormats: this.options.showAvailableFormats,
        fileExtensions: this.options.fileExtensions,
        acceptSync: this.options.acceptSync && this._userModel.isActionEnabled('sync_tables'),
        state: this.model.get('state'),
        title: this.options.title
      })
    );
    this._checkVisibility();
    return this;
  },

  _initBinds: function () {
    this.model.bind('change:state', this.render, this);
  },

  _checkVisibility: function () {
    var state = this.model.get('state');
    this[ state !== 'list' ? 'show' : 'hide' ]();
  },

  _goToList: function () {
    this.model.set('state', 'list');
  }

});

},{"./import-service-header.tpl":334,"backbone/core-view":1127}],334:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (state !== 'list' ) { 
__p+='\n  <h3 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m">\n    ';
 if (state === 'selected') { 
__p+='\n      ';
 if (service_name === 'instagram') { 
__p+='\n        '+
((__t=( _t('components.modals.add-layer.imports.service-import.account-connected') ))==null?'':_.escape(__t))+
'\n        ';
 } else { 
__p+='\n        '+
((__t=( _t('components.modals.add-layer.imports.service-import.item-selected') ))==null?'':_.escape(__t))+
'\n      ';
 } 
__p+='\n    ';
 } else { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.imports.service-import.connect-with', { title: title }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  </h3>\n  <p class="CDB-Text CDB-Size-medium u-altTextColor ';
 if (state === "error") { 
__p+='ImportPanel-headerDescription--negative';
 } 
__p+='">\n    ';
 if (state === "idle") { 
__p+='\n      ';
 if (fileExtensions.length > 0) { 
__p+='\n        ';
 formatsLink = _t('components.modals.add-layer.imports.service-import.and') + ' <a target="_blank" href="https://docs.carto.com/cartodb-editor/datasets/#supported-file-formats" class="ImportPanel-headerDescriptionLink">' + _t('components.modals.add-layer.imports.service-import.many-more-formats') + '</a>' 
__p+='\n        '+
((__t=( fileExtensions.join(', ') ))==null?'':_.escape(__t))+
'';
 if (showAvailableFormats) { 
__p+=' '+
((__t=( formatsLink ))==null?'':_.escape(__t))+
' ';
 } 
__p+=' '+
((__t=( _t('components.modals.add-layer.imports.service-import.supported') ))==null?'':_.escape(__t))+
'.\n      ';
 } else { 
__p+='\n        '+
((__t=( _t('components.modals.add-layer.imports.service-import.state-idle-login') ))==null?'':_.escape(__t))+
'\n      ';
 } 
__p+='\n    ';
 } 
__p+='\n    ';
 if (state === "error") { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.imports.service-import.state-error') ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n    ';
 if (state === "token") { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.imports.service-import.state-token') ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n    ';
 if (state === "oauth") { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.imports.service-import.state-oauth') ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n    ';
 if (state === "retrieving") { 
__p+='\n      '+
((__t=( _t('components.modals.add-layer.imports.service-import.state-retrieving', { title: title }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n    ';
 if (state === "selected") { 
__p+='\n      ';
 if (acceptSync) { 
__p+='\n        '+
((__t=( _t('components.modals.add-layer.imports.service-import.state-selected-sync') ))==null?'':_.escape(__t))+
'\n      ';
 } else { 
__p+='\n        ';
 if (service_name === 'instagram') { 
__p+='\n          '+
((__t=( _t('components.modals.add-layer.imports.service-import.state-selected-instagram') ))==null?'':_.escape(__t))+
'\n        ';
 } else { 
__p+='\n          '+
((__t=( _t('components.modals.add-layer.imports.service-import.state-selected-no-sync') ))==null?'':_.escape(__t))+
'\n        ';
 } 
__p+='\n      ';
 } 
__p+='\n    ';
 } 
__p+='\n  </p>\n  ';
 if (state === "selected" && items > 1) { 
__p+='\n    <button class="CDB-Size-large ImportPanel-headerButton js-back">\n      <i class="CDB-IconFont CDB-IconFont-arrowPrev u-actionTextColor"></i>\n    </button>\n  ';
 } 
__p+='\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],335:[function(require,module,exports){
var Utils = require('../../../../../../helpers/utils');

/**
 *  Service list item format utils
 *
 *  - Create customized functions for service list items.
 *
 */

module.exports = {
  // Due to the fact that backend data source service
  // returns 0 size when it doesn't know it
  formatSize: function (s) {
    if (s && s > 0) {
      return Utils.readablizeBytes(s);
    } else {
      return 'Unknown';
    }
  }
};

},{"../../../../../../helpers/utils":1102}],336:[function(require,module,exports){
var Backbone = require('backbone');

/**
 *  Service item model
 *
 */

module.exports = Backbone.Model.extend({
  defaults: {
    id: '',
    filename: '',
    checksum: '',
    service: '',
    size: '',
    title: ''
  }
});

},{"backbone":"backbone"}],337:[function(require,module,exports){
var ServiceItem = require('./import-service-item-model');
var Backbone = require('backbone');

/**
 *  Service item model + Service items collection
 *
 *  - It needs a datasource name or it won't work.
 *
 */

module.exports = Backbone.Collection.extend({

  _DATASOURCE_NAME: 'dropbox',

  model: ServiceItem,

  url: function (method) {
    var version = this._configModel.urlVersion('imports_service');
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/' + version + '/imports/service/' + this._DATASOURCE_NAME + '/list_files';
  },

  initialize: function (coll, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.datasourceName) throw new Error('datasourceName is required');
    this._configModel = opts.configModel;
    this._DATASOURCE_NAME = opts.datasourceName;
  },

  fetch: function () {
    this.trigger('fetch', this);
    return Backbone.Collection.prototype.fetch.apply(this, arguments);
  },

  parse: function (r) {
    return r.files;
  }

});

},{"./import-service-item-model":336,"backbone":"backbone"}],338:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var Utils = require('../../../../../../helpers/utils');
var ServiceUtilsFormat = require('./import-service-item-description-format');
var template = require('./import-service-list-item.tpl');
var _ = require('underscore');

/**
 *  Service list item view
 *
 *  - Displays the item info.
 *  - It lets user to select the item for a future import.
 *
 */

module.exports = CoreView.extend({
  options: {
    title: '',
    fileAttrs: {
      ext: false,
      title: 'filename',
      description: 'size',
      itemName: 'file',
      formatDescription: ''
    }
  },

  _FORMATTERS: {
    'size': ServiceUtilsFormat.formatSize,
    'number': Utils.formatNumber
  },

  className: 'ServiceList-item',
  tagName: 'li',

  events: {
    'click .js-choose': '_onSelectItem'
  },

  render: function () {
    var title = this.model.get(this.options.fileAttrs.title);
    var description = this._genDescription();
    var ext = this.options.fileAttrs.ext ? Utils.getFileExtension(title) : '';

    if (this.options.fileAttrs.ext) {
      title = title && title.replace('.' + ext, '');
    }

    this.$el.html(
      template({
        name: this.options.title,
        ext: ext,
        title: title,
        description: description
      })
    );
    return this;
  },

  _genDescription: function () {
    if (this.options.fileAttrs && this.options.fileAttrs.description) {
      var descriptionOpts = this.options.fileAttrs.description;
      var descriptionKeyValue = '';
      var descriptionStr = '';
      var self = this;

      if (descriptionOpts.content && descriptionOpts.content.length > 0) {
        _.each(descriptionOpts.content, function (item, i) {
          if (i > 0 && descriptionOpts.separator) {
            descriptionStr += ' ' + descriptionOpts.separator + ' ';
          }

          var value = self.model.get(item.name);
          var format = item.format && self._FORMATTERS[item.format];
          descriptionStr += format && format(value) || value;

          if (item.key) {
            descriptionKeyValue = item.name;
          }
        });
      }

      if (descriptionOpts.itemName && descriptionKeyValue) {
        descriptionStr += ' ' + (descriptionOpts.itemName && _t('components.modals.add-layer.imports.' + descriptionOpts.itemName + '-pluralize', { smart_count: descriptionKeyValue }) || '');
      }

      return descriptionStr;
    }

    return '';
  },

  _onSelectItem: function () {
    this.trigger('selected', this.model, this);
  }

});

},{"../../../../../../helpers/utils":1102,"./import-service-item-description-format":335,"./import-service-list-item.tpl":339,"backbone/core-view":1127,"underscore":"underscore"}],339:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ServiceList-itemExt u-ellipsLongText CDB-Text CDB-Size-medium u-rSpace--xl">\n  '+
((__t=( ext || '?' ))==null?'':_.escape(__t))+
'\n</div>\n<div class="ServiceList-itemInfo u-flex u-alignCenter u-justifySpace">\n  <div class="ServiceList-itemInfoTitle">\n    <h6 class="CDB-Text CDB-Size-large u-bSpace u-ellipsis" >'+
((__t=( title ))==null?'':_.escape(__t))+
'</h6>\n    <p class="CDB-Text CDB-Size-medium u-altTextColor u-ellipsis">'+
((__t=( description ))==null?'':_.escape(__t))+
'</p>\n  </div>\n  <div class="ServiceList-itemActions">\n    <button class="CDB-Button CDB-Button--secondary js-choose">\n      <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small u-upperCase">'+
((__t=( _t('components.modals.add-layer.imports.service-import.choose') ))==null?'':_.escape(__t))+
'</span>\n    </button>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],340:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var ServiceListItemView = require('./import-service-list-item-view');
var template = require('./import-service-list.tpl');

/**
 *  Service list view
 *
 *  - It will display all the items available under
 *  the service and the possibility to chose one of
 *  them.
 *
 */

module.exports = CoreView.extend({
  options: {
    title: 'service',
    fileAttrs: {}
  },

  initialize: function () {
    this._initBinds();
    this._checkVisibility();
  },

  render: function () {
    this.clearSubViews();
    var size = this.collection.size();
    this.$el.html(
      template({
        size: size,
        title: this.options.title,
        pluralize: _t('components.modals.add-layer.imports.item-pluralize', { smart_count: size })
      })
    );
    if (this.collection.size() > 0) {
      this.collection.each(this._addItem, this);
    }
    return this;
  },

  _initBinds: function () {
    this.collection.bind('sync', this.render, this);
    this.model.bind('change:state', this._checkVisibility, this);
    this.add_related_model(this.collection);
  },

  _addItem: function (m) {
    var item = new ServiceListItemView({
      model: m,
      title: this.options.title,
      fileAttrs: this.options.fileAttrs
    });
    item.bind('selected', this._onSelectedItem, this);
    this.$('.ServiceList-items').append(item.render().el);
    this.addView(item);
  },

  _onSelectedItem: function (mdl) {
    this.model.setUpload({
      state: 'selected',
      value: mdl.toJSON(),
      service_item_id: mdl.get('id')
    });
  },

  _checkVisibility: function () {
    var state = this.model.get('state');
    if (state === 'list') {
      this.show();
    } else {
      this.hide();
    }
  }

});

},{"./import-service-list-item-view":338,"./import-service-list.tpl":341,"backbone/core-view":1127}],341:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ConnectDataset-header">\n  <h2 class="CDB-Text CDB-Size-medium u-altTextColor">\n    '+
((__t=( _t('components.modals.add-layer.imports.service-import.found-in', {
      size: size,
      pluralize: pluralize,
      title: title
    }) ))==null?'':_.escape(__t))+
'\n  </h2>\n</div>\n<div class="ServiceList-body">\n  ';
 if (size > 0) { 
__p+='\n    <ul class="ServiceList-items"></ul>\n  ';
 } else { 
__p+='\n    <div class="IntermediateInfo ServiceList-empty">\n      <div class="LayoutIcon">\n        <i class="CDB-IconFont CDB-IconFont-lens"></i>\n      </div>\n      <h4 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m">\n        '+
((__t=( _t('components.modals.add-layer.imports.service-import.no-results-title') ))==null?'':_.escape(__t))+
'\n      </h4>\n      <p class="CDB-Text CDB-Size-medium u-altTextColor">\n        '+
((__t=( _t('components.modals.add-layer.imports.service-import.no-results-desc') ))==null?'':_.escape(__t))+
'\n      </p>\n    </div>\n  ';
 } 
__p+='\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],342:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./import-service-loader.tpl');

/**
 *  Service loader view
 *
 *  - It will be on charge to make token and oauth petitions
 *
 */

module.exports = CoreView.extend({
  events: {
    'click .js-connect': '_checkToken'
  },

  initialize: function (opts) {
    if (!opts.serviceTokenModel) throw new Error('serviceTokenModel prodiver is required');
    if (!opts.serviceOauthModel) throw new Error('serviceOauthModel is required');

    this._serviceTokenModel = opts.serviceTokenModel;
    this._serviceOauthModel = opts.serviceOauthModel;
    this._initBinds();
    this._checkVisibility();
  },

  render: function () {
    this.$el.html(
      template({
        state: this.model.get('state')
      })
    );
    return this;
  },

  _initBinds: function () {
    this.model.bind('change:state', function () {
      this.render();
      this._checkVisibility();
    }, this);
  },

  _checkToken: function () {
    var self = this;
    this.model.set('state', 'token');
    this._serviceTokenModel.fetch({
      success: function (r) {
        if (!r.get('oauth_valid')) {
          self._getOauthURL();
        }
      },
      error: function (e) {
        self._getOauthURL();
      }
    });
  },

  _checkVisibility: function () {
    var state = this.model.get('state');
    if (state !== 'list' && state !== 'selected') {
      this.show();
    } else {
      this.hide();
    }
  },

  _getOauthURL: function () {
    var self = this;
    this.model.set('state', 'oauth');
    this._serviceOauthModel.set({ url: '' }, { silent: true });
    this._serviceOauthModel.fetch({
      error: function () {
        self.model.set('state', 'error');
      }
    });
  }

});

},{"./import-service-loader.tpl":343,"backbone/core-view":1127}],343:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ImportPanel-actions">\n  ';
 if (state === "idle") { 
__p+='\n    <button class="CDB-Button CDB-Button--primary js-connect">\n      <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small u-upperCase">\n        '+
((__t=( _t('components.modals.add-layer.imports.service-import.connect') ))==null?'':_.escape(__t))+
'\n      </span>\n    </button>\n  ';
 } else if (state === "error") { 
__p+='\n    <button class="CDB-Button CDB-Button--primary js-connect">\n      <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small u-upperCase">\n        '+
((__t=( _t('components.modals.add-layer.imports.service-import.try-again') ))==null?'':_.escape(__t))+
'\n      </span>\n    </button>\n  ';
 } else { 
__p+='\n    <div class="Spinner ImportPanel-actionsLoader"></div>\n  ';
 } 
__p+='\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],344:[function(require,module,exports){
var Backbone = require('backbone');

/**
 *  Get oauth url from the service requested
 *
 *  - It needs a datasource name or it won't work.
 *
 *  new ServiceOauthModel({ datasourceName: 'dropbox', configModel: configModel })
 */

module.exports = Backbone.Model.extend({

  _DATASOURCE_NAME: 'dropbox',

  url: function (method) {
    var version = this._configModel.urlVersion('imports_service');
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/' + version + '/imports/service/' + this._DATASOURCE_NAME + '/auth_url';
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.datasourceName) throw new Error('datasource_name is required');
    this._configModel = opts.configModel;
    this._DATASOURCE_NAME = opts.datasourceName;
  }

});

},{"backbone":"backbone"}],345:[function(require,module,exports){
var Backbone = require('backbone');

/**
 *  Model to check if oAuth token is valid or not
 *
 *  - It needs a datasource name or it won't work.
 *
 *  new ServiceTokenModel({ datasourceName: 'dropbox', configModel: configModel })
 */

module.exports = Backbone.Model.extend({

  _DATASOURCE_NAME: 'dropbox',

  url: function (method) {
    var version = this._configModel.urlVersion('imports_service');
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/' + version + '/imports/service/' + this._DATASOURCE_NAME + '/token_valid';
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.datasourceName) throw new Error('datasource_name is required');
    this._configModel = opts.configModel;
    this._DATASOURCE_NAME = opts.datasourceName;
  }

});

},{"backbone":"backbone"}],346:[function(require,module,exports){
var ImportView = require('../import-view');
var UploadModel = require('../../../../../../data/upload-model');
var ServiceHeaderView = require('./import-service-header-view');
var ServiceLoaderView = require('./import-service-loader-view');
var ServiceListView = require('./import-service-list-view');
var ServiceSelectedFileView = require('../import-selected-dataset-view');
var ServiceTokenModel = require('./import-service-token-model');
var ServiceOauthModel = require('./import-service-oauth-model');
var ServiceCollection = require('./import-service-items-collection');
var template = require('./import-service.tpl');
var WINDOW_INTERVAL = 1000; // miliseconds

/**
 *  Import service view
 *
 *  - Use a service import panel
 *  - It will request login to the service
 *  - If it works, a list of available files will appear.
 *  - Once a file is selected, sync options will appear.
 *
 */

module.exports = ImportView.extend({
  _DATASOURCE_NAME: 'dropbox',

  className: 'ImportPanel ImportPanelService',

  options: {
    service: '', // Name of the service
    showAvailableFormats: false, // If all available format link should appear or not
    fileExtensions: [], // File extensions
    acceptSync: false, // Accept sync this service?
    fileAttrs: { // Attributes or changes for service list or selected file:
      ext: false, // If files should show extension
      title: 'filename', // Title attribute
      description: '<%- size %>', // Description attribute
      formatDescription: 'size', // If any format function should be applied over the description
      headerTemplate: '' // Header template
    }
  },

  initialize: function (opts) {
    if (!opts.service) throw new Error('service prodiver is required');
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.configModel) throw new Error('configModel is required');

    this._userModel = opts.userModel;
    this._configModel = opts.configModel;
    this._DATASOURCE_NAME = this.options.service;

    this.model = new UploadModel({
      type: 'service',
      service_name: this._DATASOURCE_NAME
    }, {
      userModel: this._userModel,
      configModel: this._configModel
    });

    this._initModels();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template(this.options));
    this._initViews();
    return this;
  },

  _initModels: function () {
    this._serviceTokenModel = new ServiceTokenModel(null, {
      datasourceName: this._DATASOURCE_NAME,
      configModel: this._configModel
    });
    this._serviceOauthModel = new ServiceOauthModel(null, {
      datasourceName: this._DATASOURCE_NAME,
      configModel: this._configModel
    });
    this.collection = new ServiceCollection(null, {
      datasourceName: this._DATASOURCE_NAME,
      configModel: this._configModel
    });
  },

  _initBinds: function () {
    this.model.bind('change', this._triggerChange, this);
    this.model.bind('change:state', this._checkState, this);
    this._serviceTokenModel.bind('change:oauth_valid', this._onOauthChange, this);
    this._serviceOauthModel.bind('change:url', this._openWindow, this);
    this.add_related_model(this._serviceOauthModel);
    this.add_related_model(this._serviceTokenModel);
  },

  _initViews: function () {
    var header = new ServiceHeaderView({
      el: this.$('.ImportPanel-header'),
      userModel: this._userModel,
      model: this.model,
      collection: this.collection,
      title: this.options.title,
      showAvailableFormats: this.options.showAvailableFormats,
      fileExtensions: this.options.fileExtensions,
      acceptSync: this.options.acceptSync,
      template: this.options.headerTemplate
    });
    header.render();
    this.addView(header);

    var loader = new ServiceLoaderView({
      el: this.$('.ServiceLoader'),
      model: this.model,
      serviceTokenModel: this._serviceTokenModel,
      serviceOauthModel: this._serviceOauthModel
    });
    loader.render();
    this.addView(loader);

    var list = new ServiceListView({
      el: this.$('.ServiceList'),
      model: this.model,
      collection: this.collection,
      title: this.options.title,
      fileAttrs: this.options.fileAttrs
    });
    list.render();
    this.addView(list);

    var selected = new ServiceSelectedFileView({
      el: this.$('.ServiceSelected'),
      userModel: this._userModel,
      model: this.model,
      acceptSync: this.options.acceptSync,
      fileAttrs: this.options.fileAttrs,
      configModel: this._configModel
    });
    selected.render();
    this.addView(selected);
  },

  _onOauthChange: function () {
    if (this._serviceTokenModel.get('oauth_valid')) {
      this._getFiles();
    }
  },

  _getFiles: function () {
    var self = this;

    this.model.set('state', 'retrieving');

    this.collection.fetch({
      error: function () {
        self.model.set('state', 'error');
      },
      success: function () {
        self.model.set('state', 'list');
      }
    });
  },

  _checkState: function () {
    if (this.model.get('state') === 'list') {
      if (this.collection.size() === 1) {
        var item = this.collection.at(0);
        this.model.setUpload({
          state: 'selected',
          value: item.toJSON(),
          service_item_id: item.get('id')
        });
      }
    }
    if (this.model.get('state') !== 'selected') {
      this.model.set({
        value: '',
        service_item_id: '',
        interval: 0
      });
    }
  },

  _openWindow: function () {
    var url = this._serviceOauthModel.get('url');
    var self = this;
    var i = window.open(url, null, 'menubar=no,toolbar=no,width=600,height=495');
    var e = window.setInterval(function () {
      if (i && i.closed) {
        self._getFiles();
        clearInterval(e);
      } else if (!i) {
        self.model.set('state', 'error');
        clearInterval(e);
      }
    }, WINDOW_INTERVAL);
  }

});

},{"../../../../../../data/upload-model":668,"../import-selected-dataset-view":331,"../import-view":359,"./import-service-header-view":333,"./import-service-items-collection":337,"./import-service-list-view":340,"./import-service-loader-view":342,"./import-service-oauth-model":344,"./import-service-token-model":345,"./import-service.tpl":347}],347:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ImportPanel-header"></div>\n<div class="ImportPanel-body">\n  <div class="ImportPanel-bodyWrapper">\n    <div class="ImportPanel-state ServiceLoader is-idle is-token is-oauth is-retrieving is-error"></div>\n    <div class="ImportPanel-state ServiceList is-list"></div>\n    <div class="ImportPanel-state ServiceSelected DatasetSelected is-selected"></div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],348:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<i class=\'TabIcon is-'+
((__t=( name ))==null?'':_.escape(__t))+
'\'></i>\n<span>'+
((__t=( cdb.core.sanitize.html(title || name) ))==null?'':__t)+
'</span>\n';
}
return __p;
};

},{"underscore":"underscore"}],349:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var Utils = require('../../../../../../helpers/utils');
var template = require('./credits-info.tpl');

/**
 *  Credits info view
 *
 *  - Percentage of use
 *  - Possible money spent
 *
 */

module.exports = CoreView.extend({

  initialize: function (opts) {
    this._userModel = opts.userModel;
    this._initBinds();
  },

  render: function () {
    var twitterData = this._userModel.get('twitter');
    var remaining = twitterData.quota - twitterData.monthly_use;
    var per = Math.min(100, Math.ceil((this.model.get('value') * 100) / remaining));

    this.$el.html(
      template({
        value: this.model.get('value'),
        remaining: remaining,
        per: per,
        hardLimit: twitterData.hard_limit,
        remainingFormatted: Utils.formatNumber(remaining),
        quota: twitterData.quota,
        block_price: twitterData.block_price,
        block_size: Utils.readizableNumber(twitterData.block_size)
      })
    );
    return this;
  },

  _initBinds: function () {
    this.model.bind('change', this.render, this);
  }

});

},{"../../../../../../helpers/utils":1102,"./credits-info.tpl":350,"backbone/core-view":1127}],350:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 extraTweets = '<strong>$' + block_price/100 + '/' + block_size + ' ' + _t('components.modals.add-layer.imports.twitter.extra-tweets') + '</strong>' 
__p+='\n';
 if (value <= remaining) { 
__p+='\n  '+
((__t=( _t('components.modals.add-layer.imports.twitter.credits-left', {
    per: per,
    remainingFormatted: remainingFormatted
  }) ))==null?'':_.escape(__t))+
'\n';
 } else if (remaining <= 0 && !hardLimit) { 
__p+='\n  '+
((__t=( _t('components.modals.add-layer.imports.twitter.credits-consumed', {
    extraTweets: extraTweets
  }) ))==null?'':__t)+
'\n';
 } else { 
__p+='\n  '+
((__t=( _t('components.modals.add-layer.imports.twitter.credits-no-limit', {
    extraTweets: extraTweets
  }) ))==null?'':__t)+
'\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],351:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var _ = require('underscore');
require('jquery-ui');
var CreditsInfoView = require('./credits-info-view');
var DEFAULT_PER_VALUE = 80;
var MIN_PER_VALUE = 1;

/**
 *  Set max use of credits for Twitter
 *
 *  - Slider range = 1000 credits
 *  - Last step should be infinite if user doesn't
 *    have "soft_limit".
 *
 */

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.userModel) throw new Error('userModel is required');
    this._userModel = opts.userModel;
    this.model = new Backbone.Model();
    this._initBinds();
    this._setModel();
  },

  render: function () {
    this.clearSubViews();
    this._destroySlider();
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this.model.bind('change:value', this._onValueChange, this);
  },

  _setModel: function () {
    var twitterData = this._userModel.get('twitter');
    var max = twitterData.quota - twitterData.monthly_use;
    var min = (MIN_PER_VALUE * max) / 100; // Just 1% of the quota
    var defaultValue = (max * DEFAULT_PER_VALUE) / 100;
    var value = max > 0 ? defaultValue : (max + 1);

    this.model.set({
      max: (twitterData.hard_limit ? max : max + 1),
      min: min,
      step: min,
      value: max > 0 ? value : twitterData.quota,
      disabled: max <= 0
    });
  },

  _initViews: function () {
    this.$('.js-slider').slider(
      _.extend({
        range: 'min',
        orientation: 'horizontal',
        slide: this._onSlideChange.bind(this),
        change: this._onSlideChange.bind(this)
      },
        this.model.attributes
      )
    );

    var creditsInfo = new CreditsInfoView({
      el: this.$('.js-info'),
      userModel: this._userModel,
      model: this.model
    });
    creditsInfo.render();
    this.addView(creditsInfo);
  },

  _onSlideChange: function (ev, ui) {
    this.model.set('value', ui.value);
  },

  _onValueChange: function () {
    this.trigger('maxCreditsChange', this.getMaxCredits(), this);
  },

  getMaxCredits: function () {
    var twitterData = this._userModel.get('twitter');
    var max = twitterData.quota - twitterData.monthly_use;
    var value = this.model.get('value');
    return value > max ? 0 : value;
  },

  _destroySlider: function () {
    if (this.$('.js-slider').data('ui-slider')) {
      this.$('.js-slider').slider('destroy');
    }
  },

  clean: function () {
    this._destroySlider();
    CoreView.prototype.clean.call(this);
  }

});

},{"./credits-info-view":349,"backbone":"backbone","backbone/core-view":1127,"jquery-ui":1128,"underscore":"underscore"}],352:[function(require,module,exports){
var _ = require('underscore');
var moment = require('moment');
var ImportView = require('../import-view');
var UploadModel = require('../../../../../../data/upload-model');
var DatesRangePickerView = require('../../../../../date-picker-range/date-picker-range-view');
var TwitterCategoriesView = require('./twitter-categories/twitter-categories-view');
var CreditsUsageView = require('./credits-usage-view.js');
var template = require('./import-twitter.tpl');

/**
 *  Import twitter panel
 *
 *  - It accepts up to 3 categories
 *  - Date range can't be longer than 30 days
 *
 */

module.exports = ImportView.extend({
  options: {
    acceptSync: false,
    type: 'service',
    service: 'twitter_search'
  },

  className: 'ImportPanel ImportTwitterPanel',

  initialize: function (opts) {
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.configModel) throw new Error('configModel is required');

    this._userModel = opts.userModel;
    this._configModel = opts.configModel;
    this.model = new UploadModel({
      type: this.options.type,
      service_name: this.options.service
    }, {
      userModel: this._userModel,
      configModel: this._configModel
    });

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(
      template({
        currentGMT: moment().format('Z')
      })
    );
    this._initViews();
    return this;
  },

  _initViews: function () {
    // Categories
    var categories = this.categories = new TwitterCategoriesView();
    categories.bind('changeCategory', this._setModel, this);
    this.$('.ImportTwitterPanel-cagetories').append(categories.render().el);
    this.addView(categories);

    // Date picker
    var datepicker = this.datepicker = new DatesRangePickerView({
      className: 'DatePicker DatePicker--withBorder'
    });
    datepicker.bind('changeDate', this._setModel, this);
    this.$('.js-picker').append(datepicker.render().el);
    this.addView(datepicker);

    // Use slider
    var creditsUsage = this.creditsUsage = new CreditsUsageView({
      el: this.$('.CreditsUsage'),
      userModel: this._userModel
    });
    creditsUsage.bind('maxCreditsChange', this._setModel, this);
    creditsUsage.render();
    this.addView(creditsUsage);

    this._setModel();
  },

  _initBinds: function () {
    this.model.bind('change', this._triggerChange, this);
  },

  _getCategories: function () {
    var categories = this.categories.getCategories();
    return _.filter(categories, function (c) {
      return c.category && c.terms.length > 0;
    });
  },

  _getDates: function () {
    return this.datepicker.getDates();
  },

  _getMaxCredits: function () {
    return this.creditsUsage.getMaxCredits();
  },

  _setModel: function () {
    var categories = this._getCategories();
    var dates = this._getDates();
    var maxCredits = this._getMaxCredits();
    var d = {
      categories: categories,
      dates: dates
    };

    this.model.setUpload({
      value: d,
      service_item_id: d,
      user_defined_limits: {
        twitter_credits_limit: maxCredits
      }
    });
  }

});

},{"../../../../../../data/upload-model":668,"../../../../../date-picker-range/date-picker-range-view":62,"../import-view":359,"./credits-usage-view.js":351,"./import-twitter.tpl":353,"./twitter-categories/twitter-categories-view":355,"moment":"moment","underscore":"underscore"}],353:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ImportPanel-header">\n  <h3 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m">\n    '+
((__t=( _t('components.modals.add-layer.imports.twitter.title') ))==null?'':_.escape(__t))+
'\n  </h3>\n  <p class="CDB-Text CDB-Size-medium u-altTextColor">\n    '+
((__t=( _t('components.modals.add-layer.imports.twitter.terms-desc') ))==null?'':_.escape(__t))+
'\n  </p>\n</div>\n<div class="ImportPanel-body">\n  <form class="Form">\n    <div class="ImportTwitterPanel-cagetories"></div>\n    <div class="ImportTwitterPanel-datePicker">\n      <div class="Form-row">\n        <div class="Form-rowLabel">\n          <label class="CDB-Text CDB-Size-medium js-category">'+
((__t=( _t('components.modals.add-layer.imports.twitter.from-to') ))==null?'':_.escape(__t))+
'</label>\n        </div>\n        <div class="Form-rowData Form-rowData--longer js-picker CDB-Text CDB-Size-medium"></div>\n        <div class="Form-rowInfo DatePicker-info">\n          <p class="CDB-Text CDB-Size-small u-altTextColor">'+
((__t=( _t('components.modals.add-layer.imports.twitter.twitter-gmt') ))==null?'':_.escape(__t))+
' <br/>('+
((__t=( _t('components.modals.add-layer.imports.twitter.your-gmt') ))==null?'':_.escape(__t))+
''+
((__t=( currentGMT ))==null?'':_.escape(__t))+
')</p>\n        </div>\n      </div>\n    </div>\n    <div class="ImportTwitterPanel-creditsUsage">\n      <div class="Form-row">\n        <div class="Form-rowLabel">\n          <label class="CDB-Text CDB-Size-medium js-category">'+
((__t=( _t('components.modals.add-layer.imports.twitter.use') ))==null?'':_.escape(__t))+
'</label>\n        </div>\n        <div class="Form-rowData Form-rowData--longer CreditsUsage">\n          <div class="UISlider CreditsUsage-slider js-slider"></div>\n          <div class="CreditsUsage-info CDB-Text CDB-Size-medium js-info"></div>\n        </div>\n      </div>\n    </div>\n  </form>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],354:[function(require,module,exports){
var Backbone = require('backbone');
var TwitterCategoryModel = require('./twitter-category-model');

// Twitter categories collection

module.exports = Backbone.Collection.extend({
  model: TwitterCategoryModel
});

},{"./twitter-category-model":356,"backbone":"backbone"}],355:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var $ = require('jquery');
var TwitterCategoriesCollection = require('./twitter-categories-collection');
var TwitterCategoriesModel = require('./twitter-category-model');
var TwitterCategoryView = require('./twitter-category-view');

/**
 *  Twitter category list view
 *  - It will generate a collection to store all the
 *    terms added.
 */

module.exports = CoreView.extend({
  _MAX_CATEGORIES: 4,
  _MAX_TERMS: 29,

  initialize: function () {
    // Add a first empty model
    var m = this._generateCategory();
    this.collection = new TwitterCategoriesCollection([ m ]);

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.collection.each(this._addCategory, this);
    return this;
  },

  _initBinds: function () {
    this.collection.bind('change', this._manageCategories, this);
    this.collection.bind('change', this._onCategoryChange, this);
    this.add_related_model(this.collection);
  },

  _manageCategories: function () {
    var collection_size = this.collection.size();

    // Check if already created models are completed
    var nonFilled = this.collection.filter(function (m) {
      return m.get('terms').length === 0;
    });

    // if so, generate new one
    if (nonFilled.length === 0 && collection_size < this._MAX_CATEGORIES) {
      var categoryModel = this._generateCategory();
      this.collection.add(categoryModel);
      this._addCategory(categoryModel);
      return false;
    }

    // else, let's check
    if (nonFilled.length > 0) {
      var mdl = _.first(nonFilled);
      var view = _.find(this._subviews, function (view) {
        return mdl.cid === view.model.cid;
      });
      var pos = view.$el.index();

      // Only one item in the collection, do nothing
      if (collection_size === 1) return false;

      // If it is the last item but there is no more items, do nothing
      if (pos === (collection_size - 1)) return false;

      // If it is not the last item and there is another non-filled element
      // let's remove that one.
      if (pos !== (collection_size - 1) && nonFilled.length > 1) {
        mdl = nonFilled[1];
        view = _.find(this._subviews, function (view) {
          return mdl.cid === view.model.cid;
        });
        this._removeCategory(view);
      }

      // Reorder category indexes :(
      this._sortCategoryIndex();
    }
  },

  // Set proper index after any category removed
  _sortCategoryIndex: function () {
    var self = this;

    // Hack to set properly category numbers
    this.$('.twitter-category').each(function (i, el) {
      // Get category, removing Category word
      var category = $(el).find('.js-category').text().replace(_t('components.modals.add-layer.imports.twitter.category') + ' ', '');

      if (category !== (i + 1)) {
        // Find model
        var m = self.collection.find(function (m) { return m.get('category') === category; });
        // Find view
        m.set('category', (i + 1).toString());
      }
    });
  },

  _generateCategory: function () {
    return new TwitterCategoriesModel({
      terms: [],
      category: (this.collection ? (this.collection.size() + 1) : 1).toString()
    });
  },

  _addCategory: function (m) {
    var category = new TwitterCategoryView({ model: m });

    category.bind('submit', this._onCategorySubmit, this);
    category.bind('limit', this._onCategoryLimit, this);
    category.bind('nolimit', this._onCategoryNoLimit, this);

    this.$el.append(category.render().el);

    this.addView(category);
    this.trigger('addCategory');
  },

  _removeCategory: function (v) {
    v.hide();
    v.clean();
    v.model.destroy();
    this.trigger('removeCategory');
  },

  _onCategorySubmit: function () {
    this.trigger('submitCategory', this.collection.toJSON(), this);
  },

  _onCategoryLimit: function () {
    this.trigger('limitCategory', this.collection.toJSON(), this);
  },

  _onCategoryNoLimit: function () {
    this.trigger('noLimitCategory', this.collection.toJSON(), this);
  },

  _onCategoryChange: function () {
    this.trigger('changeCategory', this.collection.toJSON(), this);
  },

  getCategories: function () {
    return this.collection.toJSON();
  }

});

},{"./twitter-categories-collection":354,"./twitter-category-model":356,"./twitter-category-view":357,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],356:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var TERMS_CHARS = 4;

// Twitter category model

module.exports = Backbone.Model.extend({
  _MAX_COUNTER: 1014,

  _CHAR_MAP: {
    ' ': 2,
    '-': 2,
    '_': 2,
    '.': 2
  },

  defaults: {
    terms: [],
    category: '',
    counter: 1014
  },

  initialize: function () {
    this._initBinds();
  },

  _initBinds: function () {
    this.bind('change:terms', this._setCounter, this);
  },

  _setCounter: function () {
    var count = this._MAX_COUNTER;
    var self = this;

    // Check terms number
    if (this.get('terms').length > 1) {
      count = count - ((this.get('terms').length - 1) * TERMS_CHARS);
    }

    // Count characters
    _.each(this.get('terms'), function (term) {
      _.each(term, function (c) {
        if (self._CHAR_MAP[c] !== undefined) {
          count = count - self._CHAR_MAP[c];
        } else {
          count--;
        }
      });
    });

    // Count never should be less than 0 please!
    this.set('counter', Math.max(0, count));
  }

});

},{"backbone":"backbone","underscore":"underscore"}],357:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var $ = require('jquery');
var template = require('./twitter-category.tpl');

/**
 *  Twitter category item view
 *  - It just needs a twitter category model
 */

module.exports = CoreView.extend({
  className: 'TwitterCategory',

  _MAX_CATEGORIES: 4,
  _MAX_TERMS: 29,

  events: {
    'keydown .js-terms': '_onInputChange',
    'keypress .js-terms': '_onInputChange',
    'keyup .js-terms': '_onInputChange'
  },

  initialize: function () {
    this._initBinds();
  },

  render: function () {
    this.$el.append(
      template({
        terms: this.model.get('terms'),
        category: this.model.get('category'),
        counter: this.model.get('counter')
      })
    );

    this.show();

    return this;
  },

  _initBinds: function () {
    _.bindAll(this, '_onInputChange');
    this.model.bind('change:category', this._onCategoryChange, this);
  },

  _onCategoryChange: function () {
    this.$('.js-category').text(_t('components.modals.add-layer.imports.twitter.category') + ' ' + this.model.get('category'));
  },

  _onInputChange: function (e) {
    var value = $(e.target).val();
    var d = {};

    if (e.keyCode === 13/* ENTER */) {
      e.preventDefault();
      this.trigger('submit', this.model, this);
      return false;
    }

    this.$('.CDB-IconFont-twitter').toggleClass('is-highlighted', value.length > 0);

    // Check if it is possible to add new characters
    // if not, stop the action, unless user is deleting
    // any previous character
    if ((this.model.get('counter') === 0 || this.model.get('terms').length > this._MAX_TERMS) &&
      e.keyCode !== 37 /* left */ && e.keyCode !== 39 /* right */ && e.keyCode !== 8 && value.length > 0) {
      this.killEvent(e);
      this.trigger('limit', this.model, this);
      return false;
    } else {
      this.trigger('nolimit', this.model, this);
    }

    // Get valid terms array
    if (!value) {
      value = [];
    } else {
      value = value.split(',');
    }

    d['terms'] = value;

    this.model.set(d);
  },

  show: function () {
    this.$el.addClass('enabled');
  },

  hide: function () {
    this.$el.removeClass('enabled');
  }

});

},{"./twitter-category.tpl":358,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],358:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Form-row">\n  <div class="Form-rowLabel">\n    <label class="CDB-Text CDB-Size-medium js-category">'+
((__t=( _t('components.modals.add-layer.imports.twitter.category') ))==null?'':_.escape(__t))+
' '+
((__t=( category ))==null?'':_.escape(__t))+
'</label>\n  </div>\n  <div class="Form-rowData Form-rowData--longer">\n    <input type="text" class="CDB-Text CDB-Size-medium Form-input Form-input--longer has-icon js-terms" value="'+
((__t=( terms.join(",") ))==null?'':_.escape(__t))+
'" placeholder="'+
((__t=( _t('components.modals.add-layer.imports.twitter.terms-placeholder') ))==null?'':_.escape(__t))+
'" />\n    <i class="CDB-IconFont CDB-IconFont-twitter Form-inputIcon"></i>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],359:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var UploadModel = require('../../../../../data/upload-model');

/**
 *  Default view for an import item
 *
 *  - It is based in an upload model.
 *  - Will trigger a change when model changes.
 *  - It returns their data if it is requested with a method.
 */

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;
    this._userModel = opts.userModel;
    this.model = new UploadModel(null, {
      configModel: this._configModel,
      userModel: this._userModel
    });
    this._initBinds();
  },

  _initBinds: function () {
    this.model.bind('change', this._triggerChange, this);
  },

  _triggerChange: function () {
    this.trigger('change', this.model.toJSON(), this);
  },

  getModelData: function () {
    if (this.model) {
      return this.model.toJSON();
    }
    return {};
  }

});

},{"../../../../../data/upload-model":668,"backbone/core-view":1127}],360:[function(require,module,exports){
var cdb = require('cartodb.js');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var ViewFactory = require('../../../../view-factory');
var importViewTemplate = require('./imports.tpl');
var importTabViewTemplate = require('./import-tab.tpl');
var TipsyTooltipView = require('../../../../tipsy-tooltip-view');
var TabPaneView = require('../../../../tab-pane/tab-pane-view');
var TabPaneCollection = require('../../../../tab-pane/tab-pane-collection');
var _ = require('underscore');
var IMPORT_OPTIONS = require('./import-options');
var TABS_PER_ROW = 5;
var DEFAULT_IMPORT = 'file';
var ROW_WIDTH = 800;

/**
 *  Imports view
 *
 *  Displays all the import options available
 *  through new create dialog.
 *
 *  IMPORTANT!!
 *
 *  If you need to add a new import pane:
 *
 *  - Create the proper class within imports folder and its tests.
 *  - Add necessary info in import_options file.
 *  - Create a check function here if needed, if not will appear
 *    always enabled (for everybody!).
 *
 */

module.exports = CoreView.extend({
  className: 'ImportOptions',

  events: {
    'click .js-goNext': '_moveToNextTabs',
    'click .js-goPrev': '_moveToPrevTabs'
  },

  initialize: function (opts) {
    if (!opts.createModel) throw new Error('createModel is required');
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.configModel) throw new Error('configModel is required');

    this._userModel = opts.userModel;
    this._configModel = opts.configModel;
    this._createModel = opts.createModel;
    this.model = new Backbone.Model({
      page: 1,
      maxPages: 0
    });
  },

  render: function () {
    this._destroyBinds();
    this.clearSubViews();
    this.$el.empty();

    this._generateContent();
    this._generateNavigationTabs();
    this._initBinds();
    this._setOption();

    return this;
  },

  // //////////////////
  // TABS && PANES!  //
  // //////////////////

  _generateContent: function () {
    var paneItems = [];

    _.each(IMPORT_OPTIONS, function (importConfig, i) {
      var obj = {};
      if (!_.isEmpty(importConfig) && importConfig.enabled(this._configModel, this._userModel)) {
        obj = {
          name: importConfig.name,
          selected: importConfig.name === 'file'
        };

        obj.createButtonView = function () {
          return ViewFactory.createByTemplate(
            importTabViewTemplate,
            {
              title: cdb.core.sanitize.html(importConfig.title || importConfig.name),
              name: importConfig.name
            },
            {
              tagName: 'button',
              className: 'TabLink ' + 'js-' + importConfig.name + 'Tab'
            }
          );
        };

        var pane;

        // Check if import option function exists
        var fn = this['_check' + i + 'Import'];
        var isEnabled;

        if (fn) {
          isEnabled = fn.bind(this)();
        }

        if ((isEnabled || isEnabled === undefined) && !_.isEmpty(importConfig)) {
          var ImportView = importConfig.view;
          pane = new ImportView(
            _.extend(
              importConfig.options || {},
              {
                userModel: this._userModel,
                configModel: this._configModel,
                title: importConfig.title
              }
            )
          );
        } else if (importConfig.fallback) {
          pane = ViewFactory.createByTemplate(importConfig.fallback);
        }

        if (pane) {
          pane.render();
          pane.bind('change', this._setUploadModel, this);
          obj.createContentView = function () {
            return pane;
          };
        }

        paneItems.push(obj);
      }
    }, this);

    this._tabPaneCollection = new TabPaneCollection(paneItems);
    this._tabPaneView = new TabPaneView({
      template: importViewTemplate,
      collection: this._tabPaneCollection,
      tabPaneItemOptions: {
        tagName: 'li',
        className: 'ImportOptions-tab'
      }
    });
    this.$el.append(this._tabPaneView.render().el);
  },

  _generateNavigationTabs: function () {
    var numTabs = this.$('.ImportOptions-tab').size();
    if (numTabs <= 1) {
      this.$('.AddLayer-tabs').hide();
    }

    this.model.set('maxPages', Math.ceil(numTabs / TABS_PER_ROW));
    this._checkNavigationTabs();
    if (this.model.get('maxPages') <= 1) {
      this.$('.ImportOptions-navigation').hide();
    }
  },

  _moveToNextTabs: function () {
    var page = this.model.get('page');
    var maxPages = this.model.get('maxPages');

    if (page < maxPages) {
      this.model.set('page', page + 1);
    }
  },

  _moveToPrevTabs: function () {
    var page = this.model.get('page');
    if (page > 1) {
      this.model.set('page', page - 1);
    }
  },

  _moveNavigationTabs: function () {
    var page = this.model.get('page');
    var rowWidth = ROW_WIDTH;

    this.$('.js-menu').css('margin-left', '-' + (rowWidth * (page - 1)) + 'px');
    this._checkNavigationTabs();
  },

  _checkNavigationTabs: function () {
    var page = this.model.get('page');
    var maxPages = this.model.get('maxPages');
    this.$('.js-goPrev').toggleClass('is-disabled', page < 2);
    this.$('.js-goNext').toggleClass('is-disabled', page >= maxPages);
  },

  _checkGDriveImport: function () {
    if (!this._configModel.get('oauth_gdrive')) {
      this._setFailedTab('gdrive', 'key');
      return false;
    }
    return true;
  },

  _checkDropboxImport: function () {
    if (!this._configModel.get('oauth_dropbox')) {
      this._setFailedTab('dropbox', 'key');
      return false;
    }
    return true;
  },

  _checkBoxImport: function () {
    if (!this._configModel.get('oauth_box')) {
      this._setFailedTab('box', 'key');
      return false;
    }
    return true;
  },

  _checkTwitterImport: function () {
    if (!this._configModel.get('datasource_search_twitter')) {
      this._setFailedTab('twitter', 'key');
      return false;
    }

    if (!this._userModel.get('twitter').enabled) {
      return false;
    }

    if (!this._userModel.canCreateTwitterDataset()) {
      this._setFailedTab('twitter', 'credits');
      return false;
    }
    return true;
  },

  _checkInstagramImport: function () {
    if (!this._userModel.featureEnabled('instagram_import')) {
      return false;
    }
    if (!this._configModel.get('oauth_instagram')) {
      this._setFailedTab('instagram', 'key');
      return false;
    }
    return true;
  },

  _checkSalesforceImport: function () {
    if (!this._userModel.get('salesforce').enabled) {
      return false;
    }
    return true;
  },

  _checkMailchimpImport: function () {
    if (!this._configModel.get('oauth_mailchimp')) {
      this._setFailedTab('mailchimp', 'key');
      return false;
    }

    if (!this._userModel.featureEnabled('mailchimp_import')) {
      return false;
    }
    return true;
  },

  _setFailedTab: function (tabName, type) {
    var $tab = this.$('.js-' + tabName + 'Tab');
    $tab.addClass('disabled');

    var tooltip = new TipsyTooltipView({
      el: $tab,
      title: function () {
        return _t('components.modals.add-layer.imports.tab-options-error.' + type, { name: tabName });
      }
    });
    this.addView(tooltip);
  },

  _setUploadModel: function (d) {
    var uploadModel = this._createModel.getUploadModel();
    uploadModel.setFresh(d);
  },

  _initBinds: function () {
    this.model.bind('change:page', this._moveNavigationTabs, this);
    if (this._tabPaneCollection) {
      this._tabPaneCollection.bind('change:selected', this._onTabChange, this);
    }
  },

  _destroyBinds: function () {
    if (this._tabPaneCollection) {
      this._tabPaneCollection.bind('change:selected', null, this);
    }
  },

  _setOption: function () {
    // First option > data file
    var tabPaneModel = _.first(this._tabPaneCollection.where({ name: DEFAULT_IMPORT }));
    if (tabPaneModel) {
      tabPaneModel.set('selected', true);
      this._updateImportOption();
    }
  },

  _updateImportOption: function () {
    this._createModel.setActiveImportPane(this._tabPaneView.getSelectedTabPaneName());
  },

  // //////////
  // Events //
  // //////////

  _onTabChange: function (tabModel) {
    // var view = this._tabPaneView.getSelectedTabPane();
    // Set upload model from activated pane to create model
    // var upload = view.getModelData && view.getModelData();
    // this._setUploadModel(upload || {});
    this._updateImportOption();
  },

  clean: function () {
    this._destroyBinds();
    CoreView.prototype.clean.call(this);
  }

});

},{"../../../../tab-pane/tab-pane-collection":538,"../../../../tab-pane/tab-pane-view":549,"../../../../tipsy-tooltip-view":589,"../../../../view-factory":594,"./import-options":328,"./import-tab.tpl":348,"./imports.tpl":361,"backbone":"backbone","backbone/core-view":1127,"cartodb.js":"cartodb.js","underscore":"underscore"}],361:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ImportOptions-navigation">\n  <button class="Carousel-Navigation CDB-Size-large ImportOptions-navigationButton ImportOptions-navigationButton--prev js-goPrev">\n    <i class="CDB-IconFont CDB-IconFont-arrowPrev u-actionTextColor"></i>\n  </button>\n  <button class="Carousel-Navigation CDB-Size-large ImportOptions-navigationButton ImportOptions-navigationButton--next js-goNext">\n    <i class="CDB-IconFont CDB-IconFont-arrowNext u-actionTextColor"></i>\n  </button>\n</div>\n<div class="AddLayer-tabs">\n  <ul class="ImportOptions-tabsList js-menu CDB-Text CDB-Size-medium u-altTextColor"></ul>\n</div>\n<div class="ImportOptions-panes js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],362:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var DatasetsView = require('./datasets/datasets-view');
var ImportsView = require('./imports/imports-view');
var TabPaneView = require('../../../tab-pane/tab-pane-view');
var TabPaneCollection = require('../../../tab-pane/tab-pane-collection');

/**
 *  Create listing view
 *
 *  It will display all the possibilities to select
 *  any of your current datasets or connect a new dataset.
 *
 */
module.exports = CoreView.extend({
  className: 'CreateDialog-listing CreateDialog-listing--noPaddingTop',

  initialize: function (opts) {
    if (!opts.createModel) throw new Error('createModel is required');
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.configModel) throw new Error('configModel is required');

    this._userModel = opts.userModel;
    this._createModel = opts.createModel;
    this._configModel = opts.configModel;

    this._initBinds();
    this._onChangeListing();
  },

  render: function () {
    this.clearSubViews();
    this._initViews();
    return this;
  },

  _initBinds: function () {
    // Bug with binding... do not work with the usual one for some reason :(
    this._createModel.bind('change:listing', this._onChangeListing.bind(this));
    this.add_related_model(this._createModel);
  },

  _initViews: function () {
    var self = this;

    var paneModels = [{
      name: 'datasets',
      selected: false,
      createContentView: function () {
        return new DatasetsView({
          userModel: self._userModel,
          createModel: self._createModel
        });
      }
    }];

    if (this._userModel.canCreateDatasets()) {
      paneModels.push({
        name: 'import',
        selected: false,
        createContentView: function () {
          return new ImportsView({
            userModel: self._userModel,
            configModel: self._configModel,
            createModel: self._createModel
          });
        }
      });
    }

    this._tabPaneCollection = new TabPaneCollection(paneModels);
    var paneTabPaneView = new TabPaneView({
      collection: this._tabPaneCollection
    });
    this.addView(paneTabPaneView);
    this.$el.append(paneTabPaneView.render().el);
  },

  _onChangeListing: function () {
    if (this._tabPaneCollection) {
      var context = this._createModel.get('listing');
      var paneModel = _.first(this._tabPaneCollection.where({ name: context }));
      paneModel.set('selected', true);
    }
  }
});

},{"../../../tab-pane/tab-pane-collection":538,"../../../tab-pane/tab-pane-view":549,"./datasets/datasets-view":308,"./imports/imports-view":360,"backbone/core-view":1127,"underscore":"underscore"}],363:[function(require,module,exports){
var cdb = require('cartodb.js');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var $ = require('jquery');
var _ = require('underscore');
var template = require('./navigation.tpl');

/**
 *  Listing datasets navigation.
 *
 *  - 'Filter by' datasets.
 *  - 'Search' any pattern within dataset collection.
 *
 */
module.exports = CoreView.extend({
  events: {
    'submit .js-search-form': '_submitSearch',
    'keydown .js-search-form': '_onSearchKeyDown',
    'click .js-search-form': 'killEvent',
    'click .js-search-link': '_onSearchClick',
    'click .js-clean-search': '_onCleanSearchClick',
    'click .js-shared': '_onSharedClick',
    'click .js-library': '_onLibraryClick',
    'click .js-connect': '_onConnectClick',
    'click .js-datasets': '_onDatasetsClick',
    'click .js-create-empty': '_onCreateEmptyClick'
  },

  initialize: function (opts) {
    if (!opts.createModel) throw new Error('createModel is required');
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.routerModel) throw new Error('routerModel is required');
    if (!opts.tablesCollection) throw new Error('tablesCollection is required');

    this._routerModel = opts.routerModel;
    this._createModel = opts.createModel;
    this._userModel = opts.userModel;
    this._tablesCollection = opts.tablesCollection;
    this.model = new Backbone.Model();

    this._preRender();
    this._initBinds();
  },

  // It is necessary to add two static elements because
  // they can't be removed/replaced using render method
  // each time a change (in a model or a collection) happens.
  // This is due to the behaviour of the CSS animations.
  _preRender: function () {
    var $uInner = $('<div>').addClass('u-inner');
    var $filtersInner = $('<div>').addClass('Filters-inner');
    this.$el.append($uInner.append($filtersInner));
  },

  render: function (m, c) {
    this.clearSubViews();

    var selectedItemsCount = this._selectedItems().length;
    // If a change is made from content type we have to know
    // preventing show wrong data about total items
    var changedContentType = c && c.changes && c.changes.content_type;

    this.$('.Filters-inner').html(
      template(
        _.extend(
          {
            showDatasets: this._createModel.showDatasets(),
            createModelType: this._createModel.get('type'),
            canCreateDataset: this._userModel.canCreateDatasets(),
            listingType: this._createModel.get('listing'),
            isInsideOrg: this._userModel.isInsideOrg(),
            totalShared: this._tablesCollection.getTotalStat('total_shared'),
            totalItems: changedContentType ? 0 : this._tablesCollection.getTotalStat('total_user_entries'),
            selectedItemsCount: selectedItemsCount
          },
          this._routerModel.attributes
        )
      )
    );

    this._animate();
    if (this._routerModel.isSearching()) {
      this._focusSearchInput();
    }
    return this;
  },

  _initBinds: function () {
    this.model.on('change:isSearchEnabled', this._onChangeIsSearchEnabled, this);
    this._createModel.bind('change:listing', this.render, this);
    this._routerModel.bind('change', this.render, this);
    this._tablesCollection.bind('sync', this.render, this);
    this.add_related_model(this._createModel);
    this.add_related_model(this._tablesCollection);
    this.add_related_model(this._routerModel);
  },

  _onChangeIsSearchEnabled: function (model, isSearchEnabled) {
    this._enableSearchUI(isSearchEnabled);

    if (this._routerModel.isSearching()) {
      this._cleanSearch();
    } else if (isSearchEnabled) {
      this._$searchInput().val('');
      this._focusSearchInput();
    }
  },

  _$searchInput: function () {
    return this.$('.js-search-input');
  },

  _focusSearchInput: function () {
    this._$searchInput()
      .select()
      .focus();
  },

  _onSearchKeyDown: function (e) {
    if (e.keyCode === 27) { // ESC
      this.killEvent(e);
      this._cleanSearch();
    }
  },

  _selectedItems: function () {
    return this._tablesCollection.where({ selected: true });
  },

  _animate: function () {
    this._enableSearchUI(!!this._routerModel.isSearching());

    // Check if user doesn't have any table and it is in library section
    // to remove useless shadow
    var inLibrarySection = this._routerModel.get('library');
    var inDatasetsSection = this._createModel.get('listing') === 'datasets';
    var hasDatasets = this._tablesCollection.getTotalStat('total_user_entries') > 0;
    this.$el.toggleClass('no-shadow', inLibrarySection && !hasDatasets && inDatasetsSection);
  },

  _enableSearchUI: function (enable) {
    this.$('.js-search-field').toggle(enable);
    this.$('.js-links-list').toggleClass('is-hidden', enable);
    this.$('.js-order-list').toggleClass('is-hidden', enable);
  },

  _onDatasetsClick: function () {
    this._routerModel.set({
      shared: 'no',
      library: false,
      page: 1
    });
    this._createModel.set('listing', 'datasets');
  },

  _onSharedClick: function () {
    this._routerModel.set({
      shared: 'only',
      library: false,
      page: 1
    });
    this._createModel.set('listing', 'datasets');
  },

  _onLibraryClick: function () {
    this._routerModel.set({
      shared: 'no',
      library: true,
      page: 1
    });
    this._createModel.set('listing', 'datasets');
  },

  _onConnectClick: function () {
    if (this._userModel.canCreateDatasets()) {
      this._createModel.set('listing', 'import');
    }
  },

  _onCreateEmptyClick: function () {
    if (this._userModel.canCreateDatasets()) {
      this._createModel.createFromScratch();
    }
  },

  // Selection actions
  _onSearchClick: function (e) {
    this.killEvent(e);
    this.model.set('isSearchEnabled', !this.model.get('isSearchEnabled'));
  },

  // Filter actions
  _onCleanSearchClick: function (e) {
    if (e) {
      e.preventDefault();
    }
    this._cleanSearch();
  },

  _cleanSearch: function () {
    this._routerModel.set({
      q: '',
      tag: '',
      shared: 'no',
      library: this._createModel.showLibrary()
    });
    this.model.set('isSearchEnabled', false);
  },

  _submitSearch: function (e) {
    this.killEvent(e);
    var val = cdb.core.sanitize.html(this.$('.js-search-input').val().trim());
    var tag = val.search(':') === 0 ? val.replace(':', '') : '';
    var q = val.search(':') !== 0 ? val : '';

    this._routerModel.set({
      page: 1,
      tag: tag,
      q: q,
      shared: 'yes'
    });

    this._createModel.set('listing', 'datasets');
  }

});

},{"./navigation.tpl":364,"backbone":"backbone","backbone/core-view":1127,"cartodb.js":"cartodb.js","jquery":"jquery","underscore":"underscore"}],364:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<span class="Filters-separator"></span>\n\n<div class="Filters-row">\n  <div class="Filters-group">\n    <div class="Filters-typeItem Filters-typeItem--searchEnabler js-search-enabler">\n      <button class="Filters-searchLink CDB-Text is-semibold u-upperCase CDB-Size-medium js-search-link">\n        <i class="Filters-searchLinkIcon CDB-IconFont CDB-IconFont-lens"></i>'+
((__t=( _t('components.modals.add-layer.navigation.search') ))==null?'':_.escape(__t))+
'\n      </button>\n    </div>\n\n    <ul class="Filters-group js-links-list">\n      <li class="Filters-typeItem js-filter-type">\n        <button class="Filters-typeLink js-typeItem u-actionTextColor CDB-Text is-semibold u-upperCase CDB-Size-medium js-connect '+
((__t=( listingType === 'import' ? 'is-selected' : '' ))==null?'':_.escape(__t))+
' '+
((__t=( !canCreateDataset ? 'is-disabled' : '' ))==null?'':_.escape(__t))+
'">\n          '+
((__t=( _t('components.modals.add-layer.navigation.connect-dataset') ))==null?'':_.escape(__t))+
'\n        </button>\n      </li>\n      ';
 if (showDatasets) { 
__p+='\n        <li class="Filters-typeItem js-filter-type">\n          <button class="Filters-typeLink js-typeItem u-actionTextColor CDB-Text is-semibold u-upperCase CDB-Size-medium js-datasets '+
((__t=( listingType === 'datasets' && shared !== 'only' && !library ? 'is-selected' : '' ))==null?'':_.escape(__t))+
'">\n            ';
 if (totalItems) { 
__p+='\n              <strong>'+
((__t=( totalItems ))==null?'':_.escape(__t))+
'</strong>\n            ';
 } 
__p+='\n            '+
((__t=( _t('components.modals.add-layer.navigation.dataset-pluralize', { smart_count: totalItems }) ))==null?'':_.escape(__t))+
'\n          </button>\n        </li>\n        ';
 if (isInsideOrg) { 
__p+='\n          <li class="Filters-typeItem js-filter-type">\n            <button class="Filters-typeLink js-typeItem u-actionTextColor CDB-Text is-semibold u-upperCase CDB-Size-medium js-shared '+
((__t=( listingType === 'datasets' && shared === "only" ? 'is-selected' : '' ))==null?'':_.escape(__t))+
'">\n              ';
 if (totalShared) { 
__p+='\n                <strong>'+
((__t=( totalShared ))==null?'':_.escape(__t))+
'</strong>\n              ';
 } 
__p+='\n              '+
((__t=( _t('components.modals.add-layer.navigation.shared-with-you') ))==null?'':_.escape(__t))+
'\n            </button>\n          </li>\n        ';
 } 
__p+='\n      ';
 } 
__p+='\n      <li class="Filters-typeItem js-filter-type">\n        <button class="Filters-typeLink js-typeItem u-actionTextColor CDB-Text is-semibold u-upperCase CDB-Size-medium js-library '+
((__t=( listingType === 'datasets' && library ? 'is-selected' : '' ))==null?'':_.escape(__t))+
'">\n          '+
((__t=( _t('components.modals.add-layer.navigation.data-library') ))==null?'':_.escape(__t))+
'\n        </button>\n      </li>\n    </ul>\n  </div>\n\n  <div class="Filters-typeItem Filters-typeItem--searchField js-search-field">\n    <form class="Filters-searchForm js-search-form">\n      <input class="Filters-searchInput CDB-Text CDB-Size-medium js-search-input" type="text" value="'+
((__t=( ( tag && (':' + tag) ) || q ))==null?'':_.escape(__t))+
'" placeholder="'+
((__t=( _t('components.modals.add-layer.navigation.search-placeholder') ))==null?'':_.escape(__t))+
'" />\n      ';
 if (tag || q) { 
__p+='\n        <button type="button" class="Filters-cleanSearch js-clean-search u-actionTextColor">\n          <i class="CDB-IconFont CDB-IconFont-close"></i>\n        </button>\n      ';
 } 
__p+='\n    </form>\n  </div>\n\n  <div class="Filters-addLayer js-order-list">\n    <button class="Filters-typeLink js-typeItem u-actionTextColor CDB-Text is-semibold u-upperCase CDB-Size-medium js-create-empty '+
((__t=( listingType === 'scratch' ? 'is-selected' : '' ))==null?'':_.escape(__t))+
' '+
((__t=( !canCreateDataset ? 'is-disabled' : '' ))==null?'':_.escape(__t))+
'">\n      '+
((__t=( _t('components.modals.add-layer.navigation.create-empty-' + createModelType) ))==null?'':_.escape(__t))+
'\n    </button>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],365:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var GuessingTogglerView = require('./guessing-toggler-view');
var PrivacyTogglerView = require('./privacy-toggler-view');
var template = require('./footer.tpl');

/**
 * Footer view for the add layer modal.
 */
module.exports = CoreView.extend({
  events: {
    'click .js-ok': '_finish'
  },

  initialize: function (opts) {
    if (!opts.createModel) throw new TypeError('createModel is required');
    if (!opts.userModel) throw new TypeError('userModel is required');
    if (!opts.configModel) throw new TypeError('configModel is required');

    this._createModel = opts.createModel;
    this._userModel = opts.userModel;
    this._configModel = opts.configModel;
    this._guessingModel = new Backbone.Model({
      guessing: true
    });
    this._privacyModel = new Backbone.Model({
      privacy: this._userModel.canCreatePrivateDatasets() ? 'PRIVATE' : 'PUBLIC'
    });
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(
      template({
        canFinish: this._createModel.canFinish(),
        listing: this._createModel.get('listing')
      })
    );
    this._initViews();
    return this;
  },

  _initViews: function () {
    var guessingTogglerView = new GuessingTogglerView({
      guessingModel: this._guessingModel,
      createModel: this._createModel,
      configModel: this._configModel
    });
    this.$('.js-footer-info').append(guessingTogglerView.render().el);
    this.addView(guessingTogglerView);

    var privacyTogglerView = new PrivacyTogglerView({
      privacyModel: this._privacyModel,
      userModel: this._userModel,
      createModel: this._createModel,
      configModel: this._configModel
    });
    this.$('.js-footerActions').prepend(privacyTogglerView.render().el);
    this.addView(privacyTogglerView);
  },

  _initBinds: function () {
    var uploadModel = this._createModel.getUploadModel();
    uploadModel.bind('change', this.render, this);
    var selectedDatasetsCollection = this._createModel.getSelectedDatasetsCollection();
    selectedDatasetsCollection.bind('all', this._update, this);
    this._createModel.bind('change', this._update, this);
    this.add_related_model(uploadModel);
    this.add_related_model(selectedDatasetsCollection);
    this.add_related_model(this._createModel);
  },

  _update: function () {
    var contentPane = this._createModel.get('contentPane');
    var listing = this._createModel.get('listing');
    if (contentPane === 'listing' && listing !== 'scratch') {
      this.render().show();
    } else {
      this.hide();
    }
  },

  _finish: function (e) {
    this.killEvent(e);
    if (this._createModel.canFinish()) {
      // Set proper guessing values before starting the upload
      // if dialog is in import section
      if (this._createModel.get('listing') === 'import') {
        var uploadModel = this._createModel.getUploadModel();
        uploadModel.setPrivacy(this._privacyModel.get('privacy'));
        uploadModel.setGuessing(this._guessingModel.get('guessing'));
      }
      this._createModel.finish();
    }
  }

});

},{"./footer.tpl":366,"./guessing-toggler-view":367,"./privacy-toggler-view":369,"backbone":"backbone","backbone/core-view":1127}],366:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CreateDialog-footerShadow"></div>\n<div class="CreateDialog-footerLine"></div>\n<div class="CreateDialog-footerInner u-flex u-justifySpace u-alignCenter">\n  <div class="js-footer-info CreateDialog-footerInfo u-secondaryTextColor">\n  </div>\n  <div class="CreateDialog-footerActions js-footerActions">\n    <button class="js-ok CDB-Button CDB-Button--primary '+
((__t=( canFinish ? '' : 'is-disabled' ))==null?'':_.escape(__t))+
'">\n      <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small u-upperCase">'+
((__t=( _t('components.modals.add-layer.footer.add-layer') ))==null?'':_.escape(__t))+
'</span>\n    </button>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],367:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./guessing-toggler.tpl');

/**
 * Manages if upcoming import should guess or not.
 * Expected to be rendered in the footer of a create dialog.
 */

module.exports = CoreView.extend({

  events: {
    'click .js-toggle': '_toggle'
  },

  initialize: function (opts) {
    if (!opts.createModel) throw new Error('createModel is required');
    if (!opts.guessingModel) throw new Error('guessingModel is required');
    if (!opts.configModel) throw new TypeError('configModel is required');

    this._configModel = opts.configModel;
    this._createModel = opts.createModel;
    this.model = opts.guessingModel;
    this._initBinds();
  },

  render: function () {
    var htmlStr = '';
    if (this._createModel.showGuessingToggler()) {
      var uploadModel = this._createModel.getUploadModel();
      htmlStr = template({
        isGuessingEnabled: this.model.get('guessing'),
        importState: this._createModel.getImportState(),
        isUploadValid: uploadModel.isValidToUpload(),
        customHosted: this._configModel.get('cartodb_com_hosted')
      });
    }
    this.$el.html(htmlStr);
    return this;
  },

  _initBinds: function () {
    this._createModel.bind('change', this.render, this);
    this.model.bind('change', this.render, this);
    this.add_related_model(this._createModel);
  },

  _toggle: function () {
    var value = !this.model.get('guessing');
    this.model.set('guessing', value);
  }
});

},{"./guessing-toggler.tpl":368,"backbone/core-view":1127}],368:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (importState !== "twitter") { 
__p+='\n  <div class="u-iBlock CDB-Text CDB-Size-medium u-rSpace--xl js-toggle">\n    <input class="CDB-Checkbox" type="checkbox" '+
((__t=( isGuessingEnabled ? 'checked' : '' ))==null?'':_.escape(__t))+
'>\n    <span class="u-iBlock CDB-Checkbox-face"></span>\n    <label class="u-iBlock u-lSpace">'+
((__t=( _t('components.modals.add-layer.footer.guessing-desc') ))==null?'':_.escape(__t))+
'</label>\n  </div>\n';
 } else if (!customHosted) { 
__p+='\n  <span class="CDB-Text CDB-Size-medium">\n    '+
((__t=( _t('components.modals.add-layer.footer.twitter-desc') ))==null?'':_.escape(__t))+
'\n    <a href="mailto:support@carto.com">'+
((__t=( _t('components.modals.add-layer.footer.contact-team') ))==null?'':_.escape(__t))+
'</a>\n  </span>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],369:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var $ = require('jquery');
var template = require('./privacy-toggler.tpl');
var TipsyTooltipView = require('../../../tipsy-tooltip-view');
var publicPrivacy = 'PUBLIC';
var privatePrivacy = 'PRIVATE';

/**
 *  Change the privacy of the new dataset.
 *  - If the user can't change the privacy, it will refer to the upgrade page
 *   unless app is the "open source" version
 *
 */

module.exports = CoreView.extend({
  events: {
    'click': '_onClick'
  },

  initialize: function (opts) {
    if (!opts.createModel) throw new Error('createModel is required');
    if (!opts.privacyModel) throw new Error('privacyModel is required');
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.configModel) throw new TypeError('configModel is required');

    this._configModel = opts.configModel;
    this.model = opts.privacyModel;
    this._userModel = opts.userModel;
    this._createModel = opts.createModel;
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    if (this._createModel.showPrivacyToggler()) {
      var canChangePrivacy = this._userModel.canCreatePrivateDatasets();
      var privacy = this.model.get('privacy');
      var isPublic = privacy === publicPrivacy;
      var nextPrivacy = isPublic ? privatePrivacy : publicPrivacy;
      var icon = isPublic ? 'unlock' : 'lock';
      var upgradeUrl = this._configModel.get('upgrade_url') || window.upgrade_url;
      var canUpgrade = !this._configModel.get('cartodb_com_hosted') && !canChangePrivacy && upgradeUrl;

      this.$el.html(
        template({
          privacy: privacy,
          isDisabled: !canChangePrivacy,
          canUpgrade: canUpgrade,
          nextPrivacy: nextPrivacy,
          upgradeUrl: upgradeUrl,
          icon: icon
        })
      );

      this._initViews();
    }

    return this;
  },

  _initBinds: function () {
    this.model.bind('change:privacy', this.render, this);
  },

  _initViews: function () {
    // Tooltip
    this.addView(
      new TipsyTooltipView({
        el: this.$('.js-toggler'),
        html: true,
        title: function () {
          return $(this).attr('data-title');
        }
      })
    );
  },

  _onClick: function () {
    if (this._userModel.canCreatePrivateDatasets()) {
      var privacy = this.model.get('privacy');
      this.model.set('privacy', privacy === publicPrivacy ? privatePrivacy : publicPrivacy);
      return;
    }
  }

});

},{"../../../tipsy-tooltip-view":589,"./privacy-toggler.tpl":370,"backbone/core-view":1127,"jquery":"jquery"}],370:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (canUpgrade) { 
__p+='\n  <a href="'+
((__t=( upgradeUrl ))==null?'':_.escape(__t))+
'" class="PrivacyToggler js-toggler PrivacyToggler--'+
((__t=( privacy ))==null?'':_.escape(__t))+
' is-disabled"\n    data-title="'+
((__t=( _t('components.modals.add-layer.footer.privacy-change-not-allowed') ))==null?'':_.escape(__t))+
'">\n    <i class="CDB-IconFont CDB-IconFont-'+
((__t=( icon ))==null?'':_.escape(__t))+
'"></i>\n  </a>\n';
 } else {
__p+='\n  <button type="button" class="PrivacyToggler js-toggler PrivacyToggler--'+
((__t=( privacy ))==null?'':_.escape(__t))+
' '+
((__t=( isDisabled ? 'is-disabled' : '' ))==null?'':_.escape(__t))+
'"\n    data-title="\n      ';
 if (!isDisabled) { 
__p+='\n        '+
((__t=( _t('components.modals.add-layer.footer.privacy-change', { privacy: privacy.toLowerCase() }) ))==null?'':_.escape(__t))+
'.<br />'+
((__t=( _t('components.modals.add-layer.footer.privacy-click', { nextPrivacy: nextPrivacy.toLowerCase() }) ))==null?'':_.escape(__t))+
'.\n      ';
 } else { 
__p+='\n        '+
((__t=( _t('components.modals.add-layer.footer.privacy-change-banned') ))==null?'':_.escape(__t))+
'\n      ';
 } 
__p+='\n    ">\n    <i class="CDB-IconFont CDB-IconFont-'+
((__t=( icon ))==null?'':_.escape(__t))+
'"></i>\n  </button>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],371:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var createTuplesItems = require('./create-tuples-items');
var widgetsTypes = require('./widgets-types');
var BodyView = require('./body-view');
var template = require('./add-widgets.tpl');
var renderLoading = require('../../../components/loading/render-loading');
var TableStats = require('./tablestats.js');

/**
 * View to add new widgets.
 * Expected to be rendered in a modal.
 */
module.exports = CoreView.extend({
  className: 'Dialog-content Dialog-content--expanded',

  events: {
    'click .js-continue': '_onContinue'
  },

  initialize: function (opts) {
    if (!opts.userActions) throw new Error('userActions is required');
    if (!opts.modalModel) throw new Error('modalModel is required');
    if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
    if (!opts.widgetDefinitionsCollection) throw new Error('widgetDefinitionsCollection is required');
    if (!opts.analysisDefinitionNodesCollection) throw new Error('analysisDefinitionNodesCollection is required');

    this._userActions = opts.userActions;
    this._modalModel = opts.modalModel;
    this._layerDefinitionsCollection = opts.layerDefinitionsCollection;
    this._widgetDefinitionsCollection = opts.widgetDefinitionsCollection;
    this._analysisDefinitionNodesCollection = opts.analysisDefinitionNodesCollection;
    this._optionsCollection = new Backbone.Collection();
    this.tableStats = new TableStats({
      configModel: opts.configModel,
      userModel: opts.userModel
    });

    this._analysisDefinitionNodesCollection.each(function (m) {
      m = m.querySchemaModel;
      m.on('change', this._onQuerySchemaChange, this);
      this.add_related_model(m);
      m.fetch();
    }, this);

    this.listenTo(this._optionsCollection, 'change:selected', this._updateContinueButtonState);
    this.add_related_model(this._optionsCollection);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());

    if (this._hasFetchedAllQuerySchemas()) {
      this._renderBodyView();
    } else {
      this._renderLoadingView();
    }

    this._updateContinueButtonState();

    return this;
  },

  _onQuerySchemaChange: function () {
    if (this._hasFetchedAllQuerySchemas()) {
      this.render();
    }
  },

  _hasFetchedAllQuerySchemas: function () {
    return this._analysisDefinitionNodesCollection.all(function (m) {
      return m.querySchemaModel.get('status') !== 'fetching';
    });
  },

  _onContinue: function () {
    var selectedOptionModels = this._optionsCollection.filter(this._isSelected);

    if (selectedOptionModels.length > 0) {
      _.map(selectedOptionModels, function (selectedOptionModel) {
        this._userActions.saveWidgetOption(selectedOptionModel);
      }, this);
      this._modalModel.destroy();
    }
  },

  _renderBodyView: function () {
    this._createOptionsModels();
    var view = new BodyView({
      el: this._$body(),
      optionsCollection: this._optionsCollection,
      widgetsTypes: widgetsTypes
    });
    this.addView(view.render());
  },

  _renderLoadingView: function () {
    this._$body().html(
      renderLoading({
        title: _t('components.modals.add-widgets.loading-title')
      })
    );
  },

  _$body: function () {
    return this.$('.js-body');
  },

  _updateContinueButtonState: function () {
    this.$('.js-continue').toggleClass('is-disabled', !this._optionsCollection.any(this._isSelected));
  },

  _isSelected: function (m) {
    return !!m.get('selected');
  },

  _createOptionsModels: function () {
    var self = this;
    this._optionsCollection.reset();
    var tuplesItems = createTuplesItems(this._analysisDefinitionNodesCollection, this._layerDefinitionsCollection);

    _.each(widgetsTypes, function (d) {
      var models = d.createOptionModels(tuplesItems, this._widgetDefinitionsCollection);
      models = models.map(function (m) { m.stats = self.tableStats; return m; });
      this._optionsCollection.add(models);
    }, this);
  }
});

},{"../../../components/loading/render-loading":230,"./add-widgets.tpl":372,"./body-view":373,"./create-tuples-items":379,"./tablestats.js":394,"./widgets-types":403,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],372:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Modal">\n  <div class="Modal-header">\n    <div class="Modal-headerContainer">\n      <h2 class="CDB-Text CDB-Size-huge is-light u-mainTextColor u-bSpace">'+
((__t=( _t('components.modals.add-widgets.modal-title') ))==null?'':_.escape(__t))+
'</h2>\n      <h3 class="CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( _t('components.modals.add-widgets.modal-desc') ))==null?'':_.escape(__t))+
'</h3>\n    </div>\n  </div>\n  <div class="Modal-container js-body">\n    \n  </div>\n  <div class="Modal-footer">\n    <div class="Modal-footerContainer u-flex u-justifyEnd">\n      <button class="CDB-Button CDB-Button--primary is-disabled js-continue">\n        <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.add-widgets.continue-btn') ))==null?'':_.escape(__t))+
'</span>\n      </button>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],373:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var createTemplateTabPane = require('../../tab-pane/create-template-tab-pane');
var tabPaneButtonTemplate = require('./tab-pane-button-template.tpl');
var tabPaneTemplate = require('./tab-pane-template.tpl');

/**
 * View to select widget options to create.
 */
module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.optionsCollection) throw new Error('optionsCollection is required');
    if (!opts.widgetsTypes) throw new Error('widgetsTypes is required');

    // Only render tab items for types that have option models available
    var availableTypes = _.unique(opts.optionsCollection.pluck('type'));
    this._tabPaneItems = _
      .reduce(opts.widgetsTypes, function (memo, d) {
        if (_.contains(availableTypes, d.type)) {
          var tabPaneItem = d.createTabPaneItem(opts.optionsCollection);
          memo.push(tabPaneItem);
        }
        return memo;
      }, []);
  },

  render: function () {
    this.clearSubViews();

    var options = {
      tabPaneOptions: {
        template: tabPaneTemplate,
        tabPaneItemOptions: {
          tagName: 'li',
          className: 'CDB-NavMenu-item'
        }
      },
      tabPaneTemplateOptions: {
        tagName: 'button',
        className: 'CDB-NavMenu-link u-upperCase',
        template: tabPaneButtonTemplate
      }
    };

    var view = createTemplateTabPane(this._tabPaneItems, options);
    this.addView(view);
    this.$el.append(view.render().el);
    return this;
  }

});

},{"../../tab-pane/create-template-tab-pane":536,"./tab-pane-button-template.tpl":392,"./tab-pane-template.tpl":393,"backbone/core-view":1127,"underscore":"underscore"}],374:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="Widget-categoryFakeText"></p>\n<div class="Widget-categoryFake"></div>';
}
return __p;
};

},{"underscore":"underscore"}],375:[function(require,module,exports){
var _ = require('underscore');
var WidgetOptionModel = require('../widget-option-model');
var WidgetDefinitionModel = require('../../../../data/widget-definition-model');

module.exports = WidgetOptionModel.extend({
  defaults: _.defaults({type: 'category'}, WidgetOptionModel.defaults),

  save: function (widgetDefinitionsCollection) {
    var columnName = this.columnName();
    var model = this;
    var styleModel = this.layerDefinitionModel() && this.layerDefinitionModel().styleModel;
    var isAllowed = styleModel && styleModel.canApplyAutoStyle() || false;

    widgetDefinitionsCollection.trigger('loading', model);

    var attrs = {
      type: 'category',
      layer_id: this.layerDefinitionModel().id,
      source: {
        id: this.analysisDefinitionNodeModel().id
      },
      options: {
        column: columnName,
        aggregation_column: columnName,
        aggregation: this.get('aggregation'),
        title: this.get('title')
      },
      style: {
        widget_style: {
          definition: WidgetDefinitionModel.getDefaultWidgetStyle('category')
        },
        auto_style: {
          allowed: isAllowed,
          custom: false
        }
      }
    };

    return widgetDefinitionsCollection.create(attrs, {
      wait: true,
      success: function (mdl, attrs) {
        widgetDefinitionsCollection.trigger('success', model);
      },
      error: function (mdl, e) {
        widgetDefinitionsCollection.trigger('error', model, e);
      }
    });
  }
});

},{"../../../../data/widget-definition-model":680,"../widget-option-model":402,"underscore":"underscore"}],376:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var LayerSelectorView = require('../layer-selector-view');
var template = require('./category-option.tpl');
var categoryFake = require('./category-fake.tpl');

/**
 * View for an individual category option.
 */
module.exports = CoreView.extend({

  events: {
    'click .js-checkbox': '_onSelect'
  },

  initialize: function (opts) {
    this.listenTo(this.model, 'change:layer_index', this.render);
    this.listenTo(this.model, 'change:selected', this.render);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(this._html());
    this._renderLayerSelector();
    var tableStats = this.options.model.stats;
    if (tableStats) {
      this._drawGraph();
    }
    return this;
  },

  _html: function () {
    return template({
      columnName: this.model.columnName(),
      isSelected: !!this.model.get('selected')
    });
  },

  _renderLayerSelector: function () {
    var view = new LayerSelectorView({
      model: this.model
    });
    this.addView(view);
    this.$('.js-inner').append(view.render().el);
  },

  _onSelect: function () {
    this.model.set('selected', !this.model.get('selected'));
  },

  _drawGraph: function () {
    var self = this;
    this.options.model.stats.graphFor(
      this.model.analysisDefinitionNodeModel().get('table_name'),
      this.model.get('name'), function (graph) {
        if (graph.stats && graph.stats.freqs) {
          self.$('.js-Category-bar').append(graph.getCategory({
            color: '#9DE0AD',
            width: 240,
            height: 10
          }));
          var stats = self.$('.js-catstats').children();
          self.$(stats[0]).text(graph.getNullsPercentage() + '% null');
          self.$(stats[1]).text((graph.getPercentageInTopCategories() * 100).toFixed(2) + _t('components.modals.add-widgets.percentage-in-top-cats'));
          self.$('.js-catstats').css('display', 'flex');
        } else {
          self.$('.js-Category-bar').append(categoryFake());
        }
      }
    );
  }

});

},{"../layer-selector-view":390,"./category-fake.tpl":374,"./category-option.tpl":377,"backbone/core-view":1127}],377:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="WidgetList-option">\n  <input class="CDB-Checkbox js-checkbox" type="checkbox" ';
 if (isSelected) { 
__p+='checked="checked"';
 } 
__p+=' />\n  <span class="u-iBlock CDB-Checkbox-face"></span>\n</div>\n\n<div class="WidgetList-inner js-inner">\n  <h3 class="u-ellipsis CDB-Text CDB-Size-large u-bSpace--m">'+
((__t=( columnName ))==null?'':_.escape(__t))+
'</h3>\n  <ul class="js-catstats u-flex CDB-Text CDB-Size-small u-secondaryTextColor u-upperCase">\n    <li class=\'u-rSpace--m\'></li>\n    <li class=\'u-rSpace--m\'></li>\n  </ul>\n  <div class="u-bSpace--m js-Category-bar">\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],378:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var CategoryOptionView = require('./category-option-view.js');

/**
 * View to select category widget options
 */
module.exports = CoreView.extend({

  tagName: 'ul',
  className: 'WidgetList',

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this.collection
      .chain()
      .filter(this._isCategory)
      .each(this._renderOption, this);
    return this;
  },

  _renderOption: function (m) {
    var view = new CategoryOptionView({
      tagName: 'li',
      className: 'WidgetList-item',
      model: m
    });
    this.addView(view);
    this.$el.append(view.render().el);
  },

  _isCategory: function (m) {
    return m.get('type') === 'category';
  }

});

},{"./category-option-view.js":376,"backbone/core-view":1127}],379:[function(require,module,exports){
var _ = require('underscore');

var BLACKLISTED_COLUMNS = ['created_at', 'the_geom', 'the_geom_webmercator', 'updated_at'];

/**
 * Tmp data structure with column and layer-def models for each unique name+type tuple.
 * Each bucket contains a columnModel and layerDefinitionModel tuple,
 * since they are unique even if the columns' name+type happen to be the same
 * From this widget definition options for specific needs
 *
 * @param {Object} layerDefinitionsCollection
 * @return {Object} e.g.
 *   e.g.
 *     {
 *       foobar-string: [{
 *         columnModel: M({name: 'foobar', type: 'string', …}),
 *         layerDefinitionModel: M({ id: 'abc-123', … })
 *       }]
 *     }
 */
module.exports = function (analysisDefinitionNodesCollection, layerDefinitionsCollection) {
  return analysisDefinitionNodesCollection
    .reduce(function (tuplesItems, nodeDefModel) {
      var layerDefinitionModel = layerDefinitionsCollection.find(function (l) { return l.isOwnerOfAnalysisNode(nodeDefModel); });
      if (!layerDefinitionModel) return tuplesItems; // e.g. if the node is one of those temporary tables

      var querySchemaModel = nodeDefModel.querySchemaModel;
      var queryGeometryModel = nodeDefModel.queryGeometryModel;
      if (!querySchemaModel || !queryGeometryModel) return tuplesItems;
      if (!queryGeometryModel.hasValue()) return tuplesItems;

      querySchemaModel.columnsCollection.each(function (m) {
        var columnName = m.get('name');

        if (!_.contains(BLACKLISTED_COLUMNS, columnName)) {
          var key = columnName + '-' + m.get('type');
          var tuples = tuplesItems[key] = tuplesItems[key] || [];
          tuples.push({
            analysisDefinitionNodeModel: nodeDefModel,
            layerDefinitionModel: layerDefinitionModel,
            columnModel: m
          });
        }
      });

      return tuplesItems;
    }, {});
};

},{"underscore":"underscore"}],380:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class=\'Widget-formulaFakeContainer\'>\n  <p class=\'Widget-categoryFakeText\'></p>\n  <div class=\'Widget-formulaFake\'></div>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],381:[function(require,module,exports){
var _ = require('underscore');
var WidgetOptionModel = require('../widget-option-model');

module.exports = WidgetOptionModel.extend({
  defaults: _.defaults({type: 'formula'}, WidgetOptionModel.defaults),

  save: function (widgetDefinitionsCollection) {
    var model = this;
    widgetDefinitionsCollection.trigger('loading', model);

    var attrs = {
      type: 'formula',
      layer_id: this.layerDefinitionModel().id,
      source: {
        id: this.analysisDefinitionNodeModel().id
      },
      options: {
        column: this.columnName(),
        title: this.get('title'),
        operation: this.get('operation')
      }
    };

    return widgetDefinitionsCollection.create(attrs, {
      wait: true,
      success: function (mdl, attrs) {
        widgetDefinitionsCollection.trigger('success', model);
      },
      error: function (mdl, e) {
        widgetDefinitionsCollection.trigger('error', model, e);
      }
    });
  }
});

},{"../widget-option-model":402,"underscore":"underscore"}],382:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var LayerSelectorView = require('../layer-selector-view');
var template = require('./formula-option.tpl');
var formulaFake = require('./formula-fake.tpl');
var _ = require('underscore');

/**
 * View for an individual formula option.
 */
module.exports = CoreView.extend({

  events: {
    'click .js-checkbox': '_onSelect'
  },

  initialize: function (opts) {
    this.listenTo(this.model, 'change:layer_index', this.render);
    this.listenTo(this.model, 'change:selected', this.render);
    this.aggregation = this.model.get('operation');
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(this._html());
    this._renderLayerSelector();
    var tableStats = this.options.model.stats;
    if (tableStats) {
      this._drawGraph();
    }
    return this;
  },

  _html: function () {
    return template({
      columnName: this.model.get('title'),
      isSelected: !!this.model.get('selected')
    });
  },

  _renderLayerSelector: function () {
    var view = new LayerSelectorView({
      model: this.model
    });
    this.addView(view);
    this.$('.js-inner').append(view.render().el);
  },

  _onSelect: function () {
    this.model.set('selected', !this.model.get('selected'));
  },

  _drawGraph: function () {
    var self = this;
    this.options.model.stats.graphFor(
      this.model.analysisDefinitionNodeModel().get('table_name'),
      this.model.get('name'), function (graph) {
        if (graph.stats) {
          var stats = self.$('.js-formulastats').children();
          var aggregation = graph[{ // eslint-disable-line
            'avg': 'getAverage',
            'sum': 'getSum',
            'min': 'getMin',
            'max': 'getMax',
            'count': 'getCount'
          }[self.aggregation]]();
          if (_.isNumber(aggregation)) {
            self.$(stats[0]).text(graph.getNullsPercentage() + '% null');
            if (self.aggregation === 'count') {
              self.$(stats[1]).text(aggregation.toFixed().toString());
            } else {
              self.$(stats[1]).text(aggregation.toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ','));
            }
            self.$('.js-formulastats').show();
          } else {
            self.$('.js-formulastats').append(formulaFake());
            self.$('.js-formulastats').show();
          }
        } else {
          self.$('.js-formulastats').append(formulaFake());
          self.$('.js-formulastats').show();
        }
      }
    );
  }

});

},{"../layer-selector-view":390,"./formula-fake.tpl":380,"./formula-option.tpl":383,"backbone/core-view":1127,"underscore":"underscore"}],383:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="WidgetList-option">\n  <input class="CDB-Checkbox js-checkbox" type="checkbox" ';
 if (isSelected) { 
__p+='checked="checked"';
 } 
__p+=' />\n  <span class="u-iBlock CDB-Checkbox-face"></span>\n</div>\n\n<div class="WidgetList-inner js-inner">\n  <h3 class="u-ellipsis CDB-Text CDB-Size-large u-bSpace--m">'+
((__t=( columnName ))==null?'':_.escape(__t))+
'</h3>\n  <div class="js-formulastats" style="display: none;">\n    <ul class="u-flex CDB-Text CDB-Size-small u-secondaryTextColor u-upperCase">\n      <li class=\'u-rSpace\'></li>\n    </ul>\n  	<h4 class="CDB-Text CDB-Size-huge u-bSpace--m"></h4>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],384:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var FormulaOptionView = require('./formula-option-view.js');

/**
 * View to select formula widget options
 */
module.exports = CoreView.extend({

  className: 'WidgetList',

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this.collection
      .chain()
      .filter(this._isFormula)
      .each(this._renderOption, this);
    return this;
  },

  _renderOption: function (m) {
    var view = new FormulaOptionView({
      className: 'WidgetList-item',
      model: m
    });
    this.addView(view);
    this.$el.append(view.render().el);
  },

  _isFormula: function (m) {
    return m.get('type') === 'formula';
  }

});

},{"./formula-option-view.js":382,"backbone/core-view":1127}],385:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Widget-histogramFakeContainer">\n  <p class="Widget-categoryFakeText"></p>\n  <div class="Widget-histogramFake"></div>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],386:[function(require,module,exports){
var _ = require('underscore');
var WidgetOptionModel = require('../widget-option-model');
var WidgetDefinitionModel = require('../../../../data/widget-definition-model');

module.exports = WidgetOptionModel.extend({
  defaults: _.defaults({type: 'histogram'}, WidgetOptionModel.defaults),

  save: function (widgetDefinitionsCollection) {
    var styleModel = this.layerDefinitionModel() && this.layerDefinitionModel().styleModel;
    var isAllowed = styleModel && styleModel.canApplyAutoStyle() || false;

    var attrs = {
      type: 'histogram',
      layer_id: this.layerDefinitionModel().id,
      source: {
        id: this.analysisDefinitionNodeModel().id
      },
      options: {
        column: this.columnName(),
        title: this.get('title'),
        bins: this.get('bins')
      },
      style: {
        widget_style: {
          definition: WidgetDefinitionModel.getDefaultWidgetStyle('histogram')
        },
        auto_style: {
          allowed: isAllowed,
          custom: false
        }
      }
    };

    var model = this;
    widgetDefinitionsCollection.trigger('loading', model);

    return widgetDefinitionsCollection.create(attrs, {
      wait: true,
      success: function (mdl, attrs) {
        widgetDefinitionsCollection.trigger('success', model);
      },
      error: function (mdl, e) {
        widgetDefinitionsCollection.trigger('error', model, e);
      }
    });
  }
});

},{"../../../../data/widget-definition-model":680,"../widget-option-model":402,"underscore":"underscore"}],387:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var LayerSelectorView = require('../layer-selector-view');
var template = require('./histogram-option.tpl');
var histogramFake = require('./histogram-fake.tpl');

/**
 * View for an individual histogram option.
 */
module.exports = CoreView.extend({

  events: {
    'click .js-checkbox': '_onSelect'
  },

  initialize: function (opts) {
    this.listenTo(this.model, 'change:layer_index', this.render);
    this.listenTo(this.model, 'change:selected', this.render);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(this._html());
    this._renderLayerSelector();
    var tableStats = this.options.model.stats;
    if (tableStats) {
      this._drawGraph();
    }
    return this;
  },

  _html: function () {
    return template({
      columnName: this.model.columnName(),
      isSelected: !!this.model.get('selected')
    });
  },

  _renderLayerSelector: function () {
    var view = new LayerSelectorView({
      model: this.model
    });
    this.addView(view);
    this.$('.js-inner').append(view.render().el);
  },

  _onSelect: function () {
    this.model.set('selected', !this.model.get('selected'));
  },

  _drawGraph: function () {
    var self = this;
    this.options.model.stats.graphFor(
      this.model.analysisDefinitionNodeModel().get('table_name'),
      this.model.get('name'), function (graph) {
        if (graph.stats) {
          self.$('.js-Histogram').append(graph.getHistogram({
            color: '#9DE0AD',
            width: 240,
            height: 20,
            bins: 20
          }));
          var stats = self.$('.js-histstats').children();
          self.$(stats[0]).text(graph.getNullsPercentage() + '% null');
          self.$('.js-histstats').css('display', 'flex');
        } else {
          self.$('.js-Histogram').append(histogramFake());
        }
      }
    );
  }

});

},{"../layer-selector-view":390,"./histogram-fake.tpl":385,"./histogram-option.tpl":388,"backbone/core-view":1127}],388:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="WidgetList-option">\n  <input class="CDB-Checkbox js-checkbox" type="checkbox" ';
 if (isSelected) { 
__p+='checked="checked"';
 } 
__p+=' />\n  <span class="u-iBlock CDB-Checkbox-face"></span>\n</div>\n\n<div class="WidgetList-inner js-inner">\n  <h3 class="u-ellipsis CDB-Text CDB-Size-large u-bSpace--m">'+
((__t=( columnName ))==null?'':_.escape(__t))+
'</h3>\n  <ul class="js-histstats u-flex CDB-Text CDB-Size-small u-upperCase" style="display: none;">\n    <li class=\'u-rSpace\'></li>\n  </ul>\n  <div class="u-tSpace--m u-bSpace--m js-Histogram"></div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],389:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var HistogramOptionView = require('./histogram-option-view.js');

/**
 * View to select histogram widget options
 */
module.exports = CoreView.extend({

  className: 'WidgetList',

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this.collection
      .chain()
      .filter(this._isHistogram)
      .each(this._renderOption, this);
    return this;
  },

  _renderOption: function (m) {
    var view = new HistogramOptionView({
      className: 'WidgetList-item',
      model: m
    });
    this.addView(view);
    this.$el.append(view.render().el);
  },

  _isHistogram: function (m) {
    return m.get('type') === 'histogram';
  }

});

},{"./histogram-option-view.js":387,"backbone/core-view":1127}],390:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var analyses = require('../../../data/analyses');
require('../../form-components/index');
var CustomListItemView = require('../../form-components/editors/select/select-layer-list-item-view');
var itemListTemplate = require('../../form-components/editors/select/select-layer-item.tpl');
var selectedItemTemplate = require('../../form-components/editors/select/select-layer-list-item.tpl');

/**
 * View for selecting the layer through which to load the column data.
 */
module.exports = CoreView.extend({

  className: 'SelectorLayer',

  events: {
    'change': '_onChange'
  },

  initialize: function (opts) {
    this.listenTo(this.model, 'change:layer_index', this.render);
  },

  render: function () {
    this._unbindEvents();
    this._initViews();
    this._bindEvents();
    return this;
  },

  _initViews: function () {
    var self = this;
    var options = this._buildOptions();

    this._selectView = new Backbone.Form.editors.Select({
      className: 'Widget-select u-flex u-alignCenter',
      key: 'name',
      schema: {
        options: options
      },
      model: self.model,
      showSearch: false,
      template: require('./select.tpl'),
      selectedItemTemplate: selectedItemTemplate,
      customListItemView: CustomListItemView,
      itemListTemplate: itemListTemplate
    });

    this._selectView.setValue(this.model.get('layer_index') || 0);
    this.$el.html(this._selectView.render().el);
  },

  _buildOptions: function () {
    return _.map(this.model.get('tuples'), function (item, index) {
      var layerDefModel = item.layerDefinitionModel;
      var nodeDefModel = item.analysisDefinitionNodeModel;

      return {
        val: index,
        layerName: layerDefModel.getName(),
        nodeTitle: analyses.title(nodeDefModel),
        layer_id: nodeDefModel.id,
        color: item.layerDefinitionModel.get('color')
      };
    });
  },

  _bindEvents: function () {
    if (this._selectView) {
      this._selectView.on('change', this._onChange, this);
    }
  },

  _unbindEvents: function () {
    if (this._selectView) {
      this._selectView.off('change', this._onChange, this);
    }
  },

  _onChange: function () {
    this.model.set('layer_index', this._selectView.getValue());
  }

});

},{"../../../data/analyses":599,"../../form-components/editors/select/select-layer-item.tpl":190,"../../form-components/editors/select/select-layer-list-item-view":191,"../../form-components/editors/select/select-layer-list-item.tpl":192,"../../form-components/index":211,"./select.tpl":391,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],391:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text CDB-Size-small u-upperCase u-altTextColor Widget-selectTitle">Select Layer</p>\n<div class="CDB-InputText CDB-Text is-cursor js-button u-ellipsis\n  ';
 if (isDisabled) { 
__p+=' is-disabled ';
 } 
__p+='\n  ';
 if (!label) { 
__p+=' is-empty ';
 } 
__p+='"\n  tabindex="0">\n  ';
 if (isLoading) { 
__p+='\n    <div class="CDB-LoaderIcon CDB-LoaderIcon--small is-dark">\n      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n      </svg>\n    </div>\n    <span class="u-lSpace u-secondaryTextColor">'+
((__t=( _t('components.backbone-forms.select.loading') ))==null?'':_.escape(__t))+
'</span>\n  ';
 } else { 
__p+='\n    ';
 if (isEmpty) { 
__p+='\n      '+
((__t=( _t('components.backbone-forms.select.empty') ))==null?'':_.escape(__t))+
'\n    ';
 } else { 
__p+='\n      '+
((__t=( label || _t('components.backbone-forms.select.placeholder', { keyAttr: keyAttr }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  ';
 } 
__p+='\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],392:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+=''+
((__t=( label ))==null?'':_.escape(__t))+
'';
}
return __p;
};

},{"underscore":"underscore"}],393:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Modal-navigation">\n  <ul class="Modal-navigationInner CDB-Text is-semibold CDB-Size-medium js-menu"></ul>\n</div>\n<div class="Modal-inner Modal-inner--with-navigation js-content">\n</div>\n\n';
}
return __p;
};

},{"underscore":"underscore"}],394:[function(require,module,exports){
var CDB = require('cartodb.js');
var _ = require('underscore');

function TableStats (opts) {
  if (opts.user && opts.api_key) {
    this.user = opts.username;
    this.api_key = opts.api_key;
  } else if (opts.configModel) {
    this.configModel = opts.configModel;
    this.userModel = opts.userModel;
  }
  this.tables = {};
  this.queue = {};
}

TableStats.prototype = {

  graphFor: function (tableName, column, callback) {
    this._getPgStats(tableName, function (stats) {
      var graph = new ColumnGraph(stats[column]);
      callback(graph);
    });
  },

  _getPgStats: function (table, callback) {
    var userModel = this.userModel;
    var self = this;
    if (this.tables[table]) {
      if (!_.isEmpty(this.tables[table])) {
        callback(this.tables[table]);
      } else {
        this.queue[table].push(callback);
      }
    } else {
      this.tables[table] = {};
      this.queue[table] = [callback];

      var schema = userModel.getSchemaName();
      var sql = new CDB.SQL({
        user: this.configModel.get('user_name'),
        sql_api_template: this.configModel.get('sql_api_template'),
        api_key: this.configModel.get('api_key')
      });

      sql.execute(
        'with a as (select reltuples from pg_class where relname = \'' + table + '\'), b as (select * from pg_stats where tablename = \'' + table + '\' and schemaname = \'' + schema + '\') select * from a,b',
        null,
        {
          rows_per_page: 40,
          page: 0
        }
      ).done(function (data) {
        data = data || {};
        var rows = data.rows.map(function (r) {
          var count = r.reltuples;
          var bounds = self._reformatToJSON(r.histogram_bounds);
          if (bounds) {
            var avgs = bounds.reduce(function (p, c, i) {
              if (i < bounds.length - 1) {
                p.push((bounds[i + 1] + c) / 2);
              }
              return p;
            }, []);
            var binsize = count / (bounds.length - 1);
            var sum = avgs.reduce(function (p, c) {
              return p + c * binsize;
            }, 0);
            var average = sum / count;
            var min = bounds[0];
            var max = _.last(bounds);
          }
          var mostCommon = self._reformatToJSON(r.most_common_vals);
          var trues;
          if (mostCommon) {
            var trueIndex = mostCommon.indexOf('t');
            var falseIndex = mostCommon.indexOf('f');
            if (trueIndex > -1 && falseIndex > -1) {
              trues = r.most_common_freqs[trueIndex];
            }
          }
          return {
            column: r.attname,
            histogram_bounds: bounds,
            freqs: r.most_common_freqs,
            mostcommon: mostCommon,
            nulls: r.null_frac,
            count: count,
            sum: sum,
            min: min,
            max: max,
            avg: average,
            trues: trues
          };
        });

        var stats = rows.reduce(function (p, c) {
          var column = c.column;
          delete c.column;
          p[column] = c;
          return p;
        }, {});
        self.tables[table] = stats;
        self._processQueue(table);
      });
    }
  },

  _processQueue: function (table) {
    var self = this;
    this.queue[table].forEach(function (callback) {
      callback(self.tables[table]);
    });
  },

  _reformatToJSON: function (sqlData) {
    if (!sqlData) return null;
    sqlData = sqlData.replace('{', '').replace('}', '').split(',');
    if (!sqlData.some(isNaN)) {
      sqlData = sqlData.map(function (n) {
        return parseInt(n, 10);
      });
    }
    return sqlData;
  }
};

function ColumnGraph (stats, options) {
  options = options || {};
  this.stats = stats;
  this.normalize = typeof options.normalize === 'undefined' ? true : options.normalize;
}

ColumnGraph.prototype = {
  getNullsPercentage: function () {
    return this.stats.nulls;
  },

  getPercentageInTopCategories: function (topx) {
    return this.stats.freqs.slice(0, topx || 10).reduce(function (p, c) { return p + c; });
  },

  getTrues: function () {
    return this.stats.trues;
  },

  getHistogram: function (options) {
    return this._generateHistogram(options.width, options.height, options.color, options.bins);
  },

  getCategory: function (options) {
    return this._generateCategory(options.width, options.height, options.color);
  },

  getMin: function () {
    return this.stats.min;
  },

  getMax: function () {
    return this.stats.max;
  },

  getAverage: function () {
    return this.stats.avg;
  },

  getCount: function () {
    return this.stats.count;
  },

  getSum: function () {
    return this.stats.sum;
  },

  _generateCategory: function (width, height, color) {
    if (!this.stats.freqs) return;
    var canvas = document.createElement('canvas');
    var context = canvas.getContext('2d');
    var proportion;
    if (_.isNumber(this.getTrues())) {
      proportion = this.getTrues();
    } else {
      proportion = this.getPercentageInTopCategories();
    }
    canvas.height = height || 10;
    canvas.width = width || 400;
    var spacing = 2;
    var begin = spacing;
    var end = canvas.width - spacing * 2;
    var greenPosition = (end - begin) * proportion + begin;
    context.lineCap = 'round';
    context.strokeStyle = '#EDEDED';
    context.lineWidth = 4;
    context.beginPath();
    context.moveTo(begin, canvas.height / 2);
    context.lineTo(end, canvas.height / 2);
    context.stroke();
    context.strokeStyle = color;
    context.beginPath();
    context.moveTo(begin, canvas.height / 2);
    context.lineTo(greenPosition, canvas.height / 2);
    context.stroke();
    return canvas;
  },

  _generateHistogram: function (width, height, color, bins) {
    var histogram;

    if (_.isEmpty(this.stats)) {
      return;
    }

    if (this.stats.freqs && this.stats.freqs.length < 60) {
      histogram = this._getHistogramFromFreqs(bins);
    } else if (this.stats.histogram_bounds) {
      histogram = this._getHistogramFromBounds(bins);
    }

    if (!histogram || _.isEmpty(histogram)) {
      return;
    }

    if (this.normalize) {
      var max = _.max(histogram);
      histogram = histogram.map(function (bin) {
        return bin / max;
      });
    }

    bins = histogram.length;

    var canvas = document.createElement('canvas');
    var context = canvas.getContext('2d');
    canvas.height = height || 90;
    canvas.width = width || 400;

    var barSeparation = 2;
    var barWidth = (canvas.width - barSeparation * (bins - 1)) / bins;
    context.strokeStyle = '#EDEDED';
    context.lineWidth = 1;

    // Guides

    context.beginPath();
    context.moveTo(0, 0);
    context.lineTo(canvas.width, 0);
    context.stroke();
    context.beginPath();
    context.moveTo(0, canvas.height / 2);
    context.lineTo(canvas.width, canvas.height / 2);
    context.stroke();

    // Bars

    histogram.forEach(function (bar, index) {
      var x = index * (barWidth + barSeparation);
      var barHeight = canvas.height * bar;
      context.beginPath();
      context.fillStyle = color;
      context.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
    });

    // Base line

    context.strokeStyle = '#A1BBA7';
    context.lineWidth = 2;
    context.beginPath();
    context.moveTo(0, canvas.height);
    context.lineTo(canvas.width, canvas.height);
    context.stroke();

    return canvas;
  },

  _getHistogramFromBounds: function (bins) {
    var bounds = this.stats.histogram_bounds;
    bounds = bounds.sort(function (a, b) { return a - b; });
    var min = bounds[0];
    var max = bounds[bounds.length - 1];
    var width = (max - min) / bins;
    var histogram = new Array(bins + 1).join('0').split('').map(parseFloat);
    function scaleBin (value) {
      if (max === min) return min;
      return Math.floor((bins - 1) * (value - min) / (max - min));
    }

    var boundProportion = 1 / (bounds.length - 1);
    for (var i = 0; i < bounds.length - 1; ++i) {
      var binMin = scaleBin(bounds[i]);
      var binMax = scaleBin(bounds[i + 1]);
      if (binMin === binMax) {
        histogram[binMin] += boundProportion;
      } else {
        var proportionForFirstBin = ((min + width * (binMin + 1)) - bounds[i]) / (bounds[i + 1] - bounds[i]);
        histogram[binMin] += proportionForFirstBin * boundProportion;
        var proportionForLastBin = (bounds[i + 1] - (min + width * (binMax))) / (bounds[i + 1] - bounds[i]);
        histogram[binMax] += proportionForLastBin * boundProportion;
        var remaining = boundProportion - proportionForFirstBin - proportionForLastBin;
        _.range(binMin + 1, binMax).forEach(function (binIndex, i, array) {
          histogram[binIndex] = remaining / array.length;
        });
      }
    }

    return histogram;
  },

  _getHistogramFromFreqs: function (bins) {
    var values = this.stats.mostcommon;
    var freqs = this.stats.freqs;
    bins = Math.min(bins, values.length);
    var min = _.min(values);
    var max = _.max(values);

    // If there is only one value, histogram should not be rendered
    if (min === max) {
      return [];
    }

    var histogram = new Array(bins + 1).join('0').split('').map(parseFloat);
    function scale (value) {
      if (max === min) return min;
      return (bins - 1) * (value - min) / (max - min);
    }
    values.forEach(function (v, i) {
      histogram[Math.floor(scale(v))] += freqs[i];
    });
    return histogram;
  }

};

module.exports = TableStats;

},{"cartodb.js":"cartodb.js","underscore":"underscore"}],395:[function(require,module,exports){
var _ = require('underscore');
var WidgetOptionModel = require('../widget-option-model');

/**
 * Special case for the time-series type, when if selected it deletes an existing time-series if there is one,
 * otherwise it does nothing.
 */
module.exports = WidgetOptionModel.extend({

  defaults: _.defaults({type: 'time-series'}, WidgetOptionModel.defaults),

  save: function (widgetDefinitionsCollection) {
    var m = widgetDefinitionsCollection.find(this._isTimesSeries);
    if (m) {
      m.destroy({ wait: true });
    }
  },

  _isTimesSeries: function (m) {
    return m.get('type') === 'time-series';
  }
});

},{"../widget-option-model":402,"underscore":"underscore"}],396:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./time-series-none-option.tpl');

/**
 * Represents the (default) no-option view, i.e. since time-series options only can have one selection,
 * this serves as the "unselect" option.
 */
module.exports = CoreView.extend({

  events: {
    'click .js-radio': '_onSelect'
  },

  initialize: function (opts) {
    this.listenTo(this.model, 'change:selected', this.render);
  },

  render: function () {
    this.$el.html(this._html());
    return this;
  },

  _html: function () {
    return template({
      isSelected: !!this.model.get('selected')
    });
  },

  _onSelect: function () {
    this.model.set('selected', !this.model.get('selected'));
  }

});

},{"./time-series-none-option.tpl":397,"backbone/core-view":1127}],397:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="WidgetList-option">\n  <input class="CDB-Radio u-iBlock js-radio" type="radio" ';
 if (isSelected) { 
__p+='checked="checked"';
 } 
__p+=' />\n  <span class="u-iBlock CDB-Radio-face"></span>\n</div>\n\n<div class="WidgetList-inner js-inner">\n  <h3 class="WidgetList-title CDB-Text CDB-Size-large u-bSpace--xl">'+
((__t=( _t('components.modals.add-widgets.time-series-no-option-title') ))==null?'':_.escape(__t))+
'</h3>\n  <p class="CDB-Text CDB-Size-small u-altTextColor">'+
((__t=( _t('components.modals.add-widgets.time-series-no-option-desc') ))==null?'':_.escape(__t))+
'</p>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],398:[function(require,module,exports){
var _ = require('underscore');
var WidgetOptionModel = require('../widget-option-model');
var WidgetDefinitionModel = require('../../../../data/widget-definition-model');

module.exports = WidgetOptionModel.extend({
  defaults: _.defaults({type: 'time-series'}, WidgetOptionModel.defaults),

  save: function (widgetDefinitionsCollection) {
    var columnName = this.columnName();
    var layerId = this.layerDefinitionModel().id;
    var model = this;

    var attrs = {
      type: 'time-series',
      layer_id: layerId,
      source: {
        id: this.analysisDefinitionNodeModel().id
      },
      options: {
        column: columnName,
        title: this.get('title'),
        bins: this.get('bins')
      },
      style: {
        widget_style: {
          definition: WidgetDefinitionModel.getDefaultWidgetStyle('time-series')
        }
      }
    };

    var attrsSave = {
      type: 'time-series',
      layer_id: layerId,
      source: this.analysisDefinitionNodeModel().id,
      column: columnName,
      title: this.get('title'),
      bins: this.get('bins'),
      widget_style_definition: WidgetDefinitionModel.getDefaultWidgetStyle('time-series')
    };

    var successHandler = function (mdl, attrs) {
      widgetDefinitionsCollection.trigger('success', model);
    };

    var errorHandler = function (mdl, e) {
      widgetDefinitionsCollection.trigger('error', model, e);
    };

    var createNotification = function (type) {
      if (type === 'create') {
        widgetDefinitionsCollection.trigger('loading', model);
      } else {
        widgetDefinitionsCollection.trigger('updating', model);
      }
    };

    var m = widgetDefinitionsCollection.find(this._isTimesSeries);
    if (m) {
      // Update existing widget, but only if the column or layer differs
      if (m.get('column') !== columnName || m.get('layer_id') !== layerId) {
        createNotification('update');
        return m.save(attrsSave, {
          wait: true,
          success: successHandler,
          error: errorHandler
        });
      }
    } else {
      createNotification('create');
      return widgetDefinitionsCollection.create(attrs, {
        wait: true,
        success: successHandler,
        error: errorHandler
      });
    }
  },

  _isTimesSeries: function (m) {
    return m.get('type') === 'time-series';
  }
});

},{"../../../../data/widget-definition-model":680,"../widget-option-model":402,"underscore":"underscore"}],399:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var LayerSelectorView = require('../layer-selector-view');
var template = require('./time-series-option.tpl');

/**
 * View for an individual time-series option.
 */
module.exports = CoreView.extend({

  events: {
    'click .js-radio': '_onSelect'
  },

  initialize: function (opts) {
    this.listenTo(this.model, 'change:layer_index', this.render);
    this.listenTo(this.model, 'change:selected', this.render);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(this._html());
    this._renderLayerSelector();
    return this;
  },

  _html: function () {
    return template({
      columnName: this.model.columnName(),
      isSelected: !!this.model.get('selected')
    });
  },

  _renderLayerSelector: function () {
    var view = new LayerSelectorView({
      model: this.model
    });
    this.addView(view);
    this.$('.js-inner').append(view.render().el);
  },

  _onSelect: function () {
    this.model.set('selected', !this.model.get('selected'));
  }

});

},{"../layer-selector-view":390,"./time-series-option.tpl":400,"backbone/core-view":1127}],400:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="WidgetList-option">\n  <input class="CDB-Radio u-iBlock js-radio" type="radio" ';
 if (isSelected) { 
__p+='checked="checked"';
 } 
__p+=' />\n  <span class="u-iBlock CDB-Radio-face"></span>\n</div>\n\n<div class="WidgetList-inner js-inner">\n  <h3 class="u-ellipsis CDB-Text CDB-Size-large u-bSpace--m">'+
((__t=( columnName ))==null?'':_.escape(__t))+
'</h3>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],401:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var TimeSeriesOptionView = require('./time-series-option-view.js');
var TimeSeriesNoneOptionView = require('./time-series-none-option-view.js');

/**
 * View to select time-series widget options
 */
module.exports = CoreView.extend({

  className: 'WidgetList',

  initialize: function () {
    this.listenTo(this.collection, 'change:selected', this._onSelectedChange);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    this.collection
      .chain()
      .filter(this._isTimeSeries)
      .each(this._renderOption, this);
    return this;
  },

  _renderOption: function (m) {
    var ViewClass = m.has('tuples')
      ? TimeSeriesOptionView
      : TimeSeriesNoneOptionView;

    var view = new ViewClass({
      className: 'WidgetList-item',
      model: m
    });
    this.addView(view);
    this.$el.append(view.render().el);
  },

  _isTimeSeries: function (m) {
    return m.get('type') === 'time-series';
  },

  _onSelectedChange: function (selectedModel, isSelected) {
    // Make sure there can only be one selected time-series widget option
    if (isSelected) {
      this.collection.each(function (m) {
        if (this._isTimeSeries(m) && m !== selectedModel) {
          m.set('selected', false);
        }
      }, this);
    }
  }

});

},{"./time-series-none-option-view.js":396,"./time-series-option-view.js":399,"backbone/core-view":1127}],402:[function(require,module,exports){
var Backbone = require('backbone');

module.exports = Backbone.Model.extend({

  defaults: {
    layer_index: 0,
    tuples: []
  },

  analysisDefinitionNodeModel: function () {
    return this._selectedItem().analysisDefinitionNodeModel;
  },

  layerDefinitionModel: function () {
    return this._selectedItem().layerDefinitionModel;
  },

  columnName: function () {
    return this._selectedItem().columnModel.get('name');
  },

  save: function () {
    throw new Error('save should be implemented by child');
  },

  _selectedItem: function () {
    var i = this.get('layer_index') || 0;
    var tuples = this.get('tuples') || [];
    return tuples[i] || {};
  }

});

},{"backbone":"backbone"}],403:[function(require,module,exports){
var _ = require('underscore');
var CategoryOptionModel = require('./category/category-option-model');
var CategoryOptionsView = require('./category/category-options-view');
var HistogramOptionModel = require('./histogram/histogram-option-model');
var HistogramOptionsView = require('./histogram/histogram-options-view');
var FormulaOptionModel = require('./formula/formula-option-model');
var FormulaOptionsView = require('./formula/formula-options-view');
var TimeSeriesOptionModel = require('./time-series/time-series-option-model');
var TimeSeriesNoneOptionModel = require('./time-series/time-series-none-option-model');
var TimeSeriesOptionsView = require('./time-series/time-series-options-view');
var ScrollView = require('../../scroll/scroll-view');

var CARTODB_ID = 'cartodb_id';

// Order is the same in how things will be presented in the UI
module.exports = [
  {
    type: 'category',
    createOptionModels: function (tuplesItems) {
      return _.reduce(tuplesItems, function (memo, tuples) {
        var columnModel = tuples[0].columnModel;
        var type = columnModel.get('type');
        var m;
        if (type === 'string' || type === 'boolean') {
          m = new CategoryOptionModel({
            tuples: tuples,
            title: columnModel.get('name'),
            name: columnModel.get('name'),
            aggregation: 'count' // or sum
          });
          memo.push(m);
        }
        return memo;
      }, []);
    },
    createTabPaneItem: function (optionsCollection) {
      return {
        label: _t('components.modals.add-widgets.tab-pane.category-label'),
        name: 'category',
        createContentView: function () {
          return new ScrollView({
            createContentView: function () {
              return new CategoryOptionsView({
                collection: optionsCollection
              });
            }
          });
        }
      };
    }
  },
  {
    type: 'histogram',
    createOptionModels: function (tuplesItems) {
      return _.reduce(tuplesItems, function (memo, tuples) {
        var columnModel = tuples[0].columnModel;
        if (columnModel.get('type') === 'number') {
          var m = new HistogramOptionModel({
            tuples: tuples,
            title: columnModel.get('name'),
            name: columnModel.get('name'),
            bins: 10
          });
          memo.push(m);
        }
        return memo;
      }, []);
    },
    createTabPaneItem: function (optionsCollection) {
      return {
        label: _t('components.modals.add-widgets.tab-pane.histogram-label'),
        name: 'histogram',
        createContentView: function () {
          return new ScrollView({
            createContentView: function () {
              return new HistogramOptionsView({
                collection: optionsCollection
              });
            }
          });
        }
      };
    }
  },
  {
    type: 'formula',
    createOptionModels: function (tuplesItems) {
      return _.reduce(tuplesItems, function (memo, tuples) {
        var columnModel = tuples[0].columnModel;
        var columnName = columnModel.get('name');
        var node;
        var layerDef = tuples[0].layerDefinitionModel;
        var geometry;
        var operation = 'avg';
        var title = columnName;

        if (columnModel.get('type') === 'number') {
          if (columnName === CARTODB_ID) {
            node = layerDef.getAnalysisDefinitionNodeModel();
            if (node && node.queryGeometryModel) {
              geometry = node.queryGeometryModel.get('simple_geom');
            }
            operation = 'count';
            title = _t('editor.data.stats.number-of', {
              geometry: geometry
            });
          }

          var m = new FormulaOptionModel({
            tuples: tuples,
            title: title,
            operation: operation,
            name: columnModel.get('name')
          });
          memo.push(m);
        }
        return memo;
      }, []);
    },
    createTabPaneItem: function (optionsCollection) {
      return {
        label: _t('components.modals.add-widgets.tab-pane.formula-label'),
        name: 'formula',
        createContentView: function () {
          return new ScrollView({
            createContentView: function () {
              return new FormulaOptionsView({
                collection: optionsCollection
              });
            }
          });
        }
      };
    }
  },
  {
    type: 'time-series',
    createOptionModels: function (tuplesItems, widgetDefinitionsCollection) {
      var existingDefModel = widgetDefinitionsCollection.find(function (m) {
        return m.get('type') === 'time-series';
      });

      var models = _.reduce(tuplesItems, function (memo, tuples) {
        var columnModel = tuples[0].columnModel;
        var columnName = columnModel.get('name');
        if (columnModel.get('type') === 'date' || columnModel.get('type') === 'number') {
          var attrs = {
            tuples: tuples,
            title: columnName,
            bins: 256
          };

          // Preselect the correct tuple, if there already exists a widget definition
          if (existingDefModel && existingDefModel.get('column') === columnName) {
            _.find(tuples, function (d, i) {
              if (d.layerDefinitionModel.id === existingDefModel.get('layer_id')) {
                attrs.selected = true;
                attrs.layer_index = i;
                return true;
              }
            });
          }

          var m = new TimeSeriesOptionModel(attrs);
          memo.push(m);
        }

        return memo;
      }, []);

      // Special-case; preprend the none-model since it should appear first
      var noneOptionModel = new TimeSeriesNoneOptionModel();
      return [noneOptionModel].concat(models);
    },
    createTabPaneItem: function (optionsCollection) {
      return {
        label: _t('components.modals.add-widgets.tab-pane.time-series-label'),
        name: 'time-series',
        createContentView: function () {
          return new ScrollView({
            createContentView: function () {
              return new TimeSeriesOptionsView({
                collection: optionsCollection
              });
            }
          });
        }
      };
    }
  }
];

},{"../../scroll/scroll-view":530,"./category/category-option-model":375,"./category/category-options-view":378,"./formula/formula-option-model":381,"./formula/formula-options-view":384,"./histogram/histogram-option-model":386,"./histogram/histogram-options-view":389,"./time-series/time-series-none-option-model":395,"./time-series/time-series-option-model":398,"./time-series/time-series-options-view":401,"underscore":"underscore"}],404:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var $ = require('jquery');
var _ = require('underscore');
var renderLoading = require('../../loading/render-loading');
var ENTER_KEY_CODE = 13;
var REQUIRED_OPTS = [
  'template',
  'runAction',
  'modalModel'
];

/**
 *  Confirmation modal dialog
 */

module.exports = CoreView.extend({
  className: 'Dialog-content',

  events: {
    'click .js-confirm': '_onConfirm',
    'click .js-cancel': '_onCancel'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    if (opts.loadingTitle) {
      this._hasLoading = true;
      this._loadingTitle = opts.loadingTitle;
    }

    if (opts.renderOpts) {
      this._hasRenderOpts = true;
      this._renderOpts = opts.renderOpts;
    }

    this._onKeyDown = this._onKeyDown.bind(this);
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();

    var html = this._hasRenderOpts ? this._template(this._renderOpts) : this._template();
    this.$el.html(html);

    return this;
  },

  _initBinds: function () {
    $(document).bind('keydown', this._onKeyDown);
  },

  _disableBinds: function () {
    $(document).unbind('keydown', this._onKeyDown);
  },

  _onKeyDown: function (ev) {
    var keyCode = ev.which;
    if (keyCode === ENTER_KEY_CODE) {
      this._onConfirm();
    }
  },

  _renderLoadingView: function () {
    this.$el.html(
      renderLoading({
        title: this._loadingTitle
      })
    );
  },

  _$content: function () {
    return this.$('.js-content');
  },

  _onConfirm: function () {
    if (this._hasLoading) {
      this._renderLoadingView();
    } else {
      this._modalModel.destroy();
    }

    this._runAction();
  },

  _onCancel: function () {
    this._modalModel.destroy();
  },

  clean: function () {
    this._disableBinds();
    CoreView.prototype.clean.apply(this);
  }

});

},{"../../loading/render-loading":230,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],405:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var renderLoading = require('../../loading/render-loading');
var ErrorView = require('../../error/error-view');
var REQUIRED_OPTS = [
  'errorTitle',
  'loadingTitle',
  'runAction',
  'modalModel'
];

/**
 *  Remove confirmation dialog
 */
module.exports = CoreView.extend({
  className: 'Dialog-content',

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(
      renderLoading({
        title: this._loadingTitle
      })
    );
    this._runAction({
      error: this._renderErrorView.bind(this)
    });
    return this;
  },

  _renderErrorView: function (errorMessage) {
    var errorView = new ErrorView({
      title: this._errorTitle,
      desc: errorMessage
    });
    this.$el.html(errorView.render().el);
    this.addView(errorView);
  }

});

},{"../../error/error-view":67,"../../loading/render-loading":230,"backbone/core-view":1127,"underscore":"underscore"}],406:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./editor-visualization-warning.tpl');
var VisDefinitionModel = require('../../../data/vis-definition-model');
var renderLoading = require('../../loading/render-loading');
var ErrorView = require('../../error/error-view');
var errorParser = require('../../../helpers/error-parser');
var VIS_VERSION = 3;

/**
 *  Confirmation modal dialog
 */

module.exports = CoreView.extend({
  className: 'Dialog-content',

  events: {
    'click .js-open': '_onOpen',
    'click .js-duplicate': '_onDuplicate',
    'click .js-cancel': '_onCancel'
  },

  initialize: function (opts) {
    if (!opts.visDefinitionModel) throw new Error('visDefinitionModel is required');
    if (!opts.modalModel) throw new Error('modalModel is required');

    this._visDefinitionModel = opts.visDefinitionModel;
    this._modalModel = opts.modalModel;

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();

    this.$el.html(template());
    return this;
  },

  _initBinds: function () {
    this._modalModel.bind('change:show', this._goToDashboard, this);
    this.add_related_model(this._modalModel);
  },

  _disableBinds: function () {
    this._modalModel.unbind('change:show', this._goToDashboard, this);
  },

  _onOpen: function () {
    this._disableBinds();
    this._renderLoading('open');

    this._visDefinitionModel.save({
      version: VIS_VERSION
    }, {
      wait: true,
      success: function () {
        this._modalModel.destroy();
      }.bind(this),
      error: function (mdl, e) {
        this._renderError(errorParser(e));
      }.bind(this)
    });
  },

  _onDuplicate: function () {
    this._renderLoading('duplicate');

    var newVisModel = new VisDefinitionModel({
      name: this._visDefinitionModel.get('name')
    }, {
      configModel: this._visDefinitionModel._configModel
    });

    newVisModel.save({
      source_visualization_id: this._visDefinitionModel.get('id')
    }, {
      success: function (visModel) {
        this._redirectToBuilder(visModel.builderURL());
      }.bind(this),
      error: function (mdl, e) {
        this._renderError(errorParser(e));
      }.bind(this)
    });
  },

  _redirectToBuilder: function (redirect) {
    window.location = redirect;
  },

  _renderLoading: function (renderOption) {
    var mapName = this._visDefinitionModel.get('name');
    var titleText = '';

    if (renderOption === 'duplicate') {
      titleText = _t('editor.maps.duplicate.loading', { name: mapName });
    } else if (renderOption === 'open') {
      titleText = _t('components.modals.editor-vis-warning.opening-title', { name: mapName });
    }

    this.$el.html(
      renderLoading({
        title: titleText
      })
    );
  },

  _renderError: function (errorMessage) {
    var mapName = this._visDefinitionModel.get('name');
    var errorView = new ErrorView({
      title: _t('editor.maps.duplicate.error', { name: mapName }),
      desc: errorMessage
    });
    this.$el.html(errorView.render().el);
    this.addView(errorView);
  },

  _goToDashboard: function (redirect) {
    window.location = redirect;
  },

  _onCancel: function () {
    this._goToDashboard(this._visDefinitionModel._configModel.get('base_url'));
  },

  clean: function () {
    this._disableBinds();
    CoreView.prototype.clean.apply(this);
  }

});

},{"../../../data/vis-definition-model":675,"../../../helpers/error-parser":1090,"../../error/error-view":67,"../../loading/render-loading":230,"./editor-visualization-warning.tpl":407,"backbone/core-view":1127}],407:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--medium u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="32px" height="32px" viewbox="459 348 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <g id="Editor-vis-warning" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(459.000000, 348.000000)">\n        	<path d="M15.081,7.19c0.472,0.473,1.1,0.732,1.768,0.732c0.667,0,1.295-0.26,1.768-0.732s0.732-1.101,0.732-1.768\n        		c0-0.668-0.26-1.296-0.732-1.768c-0.945-0.946-2.592-0.944-3.536,0c-0.472,0.472-0.732,1.1-0.732,1.768S14.608,6.719,15.081,7.19z\n        		 M15.788,4.362c0.283-0.283,0.66-0.439,1.061-0.439c0.4,0,0.777,0.156,1.061,0.439c0.284,0.283,0.439,0.659,0.439,1.061\n        		c0,0.4-0.156,0.777-0.439,1.061c-0.567,0.566-1.556,0.566-2.122,0c-0.283-0.283-0.439-0.659-0.439-1.061S15.504,4.646,15.788,4.362\n        		z" fill="#FFA500"/>\n        	<path d="M13.676,12.131c0.094-0.094,0.146-0.221,0.146-0.354s-0.053-0.26-0.146-0.354l-2.829-2.828\n        		c-0.195-0.195-0.512-0.195-0.707,0l-2.828,2.828c-0.195,0.195-0.195,0.512,0,0.707l2.828,2.828\n        		c0.098,0.098,0.226,0.146,0.354,0.146s0.256-0.049,0.354-0.146L13.676,12.131z M8.373,11.777l2.121-2.121l2.122,2.121l-2.122,2.121\n        		L8.373,11.777z" fill="#FFA500"/>\n        	<path d="M23.375,17.965c-0.182-0.205-0.499-0.227-0.706-0.044c-2.704,2.385-6.065,3.678-8.77,3.367\n        		c-1.699-0.194-3.106-0.991-4.199-2.354l0.989-0.989c0.087,0.331,0.252,0.646,0.511,0.904c0.39,0.39,0.902,0.584,1.414,0.584\n        		c0.512,0,1.024-0.194,1.415-0.584l2.122-2.122c0.081-0.08,0.139-0.175,0.213-0.26c0.05-0.023,0.099-0.052,0.14-0.093l4.596-4.597\n        		c0.755-0.755,1.171-1.76,1.171-2.828c0-0.983-0.367-1.904-1.012-2.635c0.059-0.29,0.089-0.588,0.089-0.892\n        		c0-1.202-0.468-2.332-1.318-3.183c-0.85-0.85-1.98-1.317-3.182-1.317c-0.304,0-0.602,0.03-0.893,0.089\n        		c-1.569-1.381-3.963-1.339-5.462,0.159L5.897,5.768C5.856,5.809,5.829,5.856,5.806,5.906C5.72,5.98,5.625,6.04,5.544,6.121\n        		L3.423,8.242c-0.78,0.779-0.78,2.049,0,2.828c0.255,0.255,0.576,0.416,0.915,0.499l-3.744,3.743\n        		c-0.377,0.378-0.585,0.88-0.585,1.414c0,0.535,0.208,1.037,0.585,1.414c0.756,0.756,2.073,0.756,2.829,0l3.182-3.182\n        		c0.196-0.195,0.513-0.194,0.708,0c0.195,0.195,0.195,0.513,0,0.708L4.13,18.849c-0.378,0.377-0.586,0.879-0.586,1.414\n        		S3.752,21.3,4.13,21.677c0.39,0.39,0.902,0.585,1.414,0.585s1.025-0.195,1.415-0.585l2.032-2.032\n        		c1.244,1.506,2.888,2.419,4.796,2.637c0.298,0.034,0.603,0.051,0.914,0.051c2.789,0,6.012-1.352,8.63-3.661\n        		C23.538,18.488,23.558,18.172,23.375,17.965z M21.272,8.949c0,0.802-0.312,1.555-0.878,2.121l-2.85,2.85\n        		c0.035-0.24,0.071-0.48,0.071-0.729c0-1.24-0.466-2.402-1.287-3.319c0.173,0.021,0.344,0.051,0.521,0.051\n        		c1.202,0,2.332-0.468,3.182-1.318c0.345-0.345,0.608-0.743,0.821-1.166C21.119,7.894,21.272,8.407,21.272,8.949z M19.323,2.947\n        		c0.661,0.661,1.025,1.54,1.025,2.476c0,0.935-0.364,1.813-1.025,2.475c-1.294,1.292-3.521,1.312-4.855,0.076l-0.176-0.176\n        		c-1.273-1.37-1.252-3.517,0.082-4.851c0.661-0.661,1.54-1.024,2.475-1.024C17.783,1.923,18.662,2.286,19.323,2.947z M11.201,1.878\n        		c0.984-0.982,2.482-1.128,3.631-0.458c-0.422,0.213-0.821,0.477-1.165,0.82c-1.01,1.011-1.419,2.385-1.266,3.704\n        		c-0.918-0.822-2.079-1.288-3.321-1.288c-0.248,0-0.488,0.036-0.728,0.071L11.201,1.878z M6.251,20.97\n        		c-0.391,0.391-1.025,0.39-1.415,0c-0.188-0.188-0.292-0.439-0.292-0.707s0.104-0.519,0.293-0.707l3.183-3.182\n        		c0.584-0.586,0.584-1.538,0-2.122c-0.585-0.586-1.537-0.586-2.122,0l-3.182,3.182c-0.378,0.378-1.037,0.376-1.415,0\n        		c-0.189-0.188-0.292-0.439-0.292-0.707c0-0.267,0.104-0.519,0.292-0.707l5.186-5.185l0.472-0.472l0,0L9.08,8.242\n        		c0.195-0.195,0.195-0.512,0-0.707s-0.512-0.195-0.707,0L5.78,10.128l-0.236,0.235c-0.378,0.379-1.036,0.377-1.414,0\n        		c-0.39-0.39-0.39-1.024,0-1.414l2.121-2.121c1.511-1.512,4.146-1.512,5.657,0l1.677,1.677c0.03,0.031,0.051,0.068,0.082,0.1\n        		c0.032,0.032,0.071,0.054,0.103,0.085l1.674,1.674c0.755,0.756,1.171,1.76,1.171,2.828s-0.416,2.073-1.171,2.828l-2.121,2.122\n        		c-0.39,0.389-1.024,0.389-1.415,0c-0.189-0.189-0.293-0.44-0.293-0.708c0-0.267,0.104-0.518,0.292-0.707l2.829-2.828\n        		c0.195-0.195,0.195-0.512,0-0.707s-0.512-0.195-0.707,0l-2.121,2.121l0,0l-0.707,0.707c0,0,0,0.001-0.001,0.001L6.251,20.97z" fill="#FFA500"/>\n        </g>\n      </svg>\n    </div>\n\n    <div>\n      <h2 class="Dialog-headerTitle--warning CDB-Text CDB-Size-huge is-light u-bSpace--m">'+
((__t=( _t('components.modals.editor-vis-warning.title') ))==null?'':_.escape(__t))+
'</h2>\n      <p class="CDB-Text CDB-Size-medium u-secondaryTextColor u-bSpace--xl">'+
((__t=( _t('components.modals.editor-vis-warning.explanation') ))==null?'':_.escape(__t))+
'</p>\n      <p class="CDB-Text CDB-Size-medium is-semibold u-secondaryTextColor">'+
((__t=( _t('components.modals.editor-vis-warning.question') ))==null?'':_.escape(__t))+
'</p>\n\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small u-upperCase">\n              '+
((__t=( _t('components.modals.editor-vis-warning.go-back') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-open">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small u-upperCase">\n              '+
((__t=( _t('components.modals.editor-vis-warning.open') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n\n      <p class="CDB-Text CDB-Size-medium u-secondaryTextColor u-tSpace-xl">or <button class="CDB-Text is-semibold u-actionTextColor js-duplicate">'+
((__t=( _t('components.modals.editor-vis-warning.duplicate') ))==null?'':_.escape(__t))+
'</button>.</p>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],408:[function(require,module,exports){
var $ = require('jquery');
var CoreView = require('backbone/core-view');
var renderLoading = require('../../loading/render-loading');
var ErrorView = require('../../error/error-view');
var template = require('./modal-export-data.tpl');
var MAX_SQL_GET_LENGTH = 1000;
var CSV_FILTER = 'SELECT * FROM (%%sql%%) as subq ';
var FORMATS = [
  {
    format: 'csv',
    fetcher: 'fetchCSV',
    geomRequired: false
  }, {
    format: 'shp',
    fetcher: 'fetch',
    geomRequired: true
  }, {
    format: 'kml',
    fetcher: 'fetch',
    geomRequired: true
  }, {
    format: 'geojson',
    label: 'geo json',
    fetcher: 'fetch',
    geomRequired: true
  }, {
    format: 'svg',
    fetcher: 'fetchSVG',
    geomRequired: true
  }
];

module.exports = CoreView.extend({
  className: 'Dialog-content',

  events: {
    'click .js-confirm': '_onConfirm',
    'click .js-cancel': '_close'
  },

  options: {
    autoClose: true
  },

  initialize: function (opts) {
    if (!opts.fileName) throw new Error('name is required');
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.queryGeometryModel) throw new Error('queryGeometryModel is required');
    if (!opts.modalModel) throw new Error('modalModel is required');

    this._configModel = opts.configModel;
    this._fileName = opts.fileName;
    this._queryGeometryModel = opts.queryGeometryModel;
    this._modalModel = opts.modalModel;

    this._initBinds();

    if (this._queryGeometryModel.get('status') === 'unfetched') {
      this._queryGeometryModel.fetch();
    }
  },

  render: function () {
    var geom = this._queryGeometryModel.get('simple_geom');

    if (this._queryGeometryModel.get('status') === 'fetched' || this._queryGeometryModel.get('status') === 'unavailable') {
      this.$el.html(
        template({
          formats: FORMATS,
          url: this._configModel.getSqlApiUrl(),
          isGeoreferenced: !!geom
        })
      );
    } else {
      this._renderLoadingContent(_t('components.modals.export-data.loading.geometry'));
    }

    return this;
  },

  _initBinds: function () {
    this._queryGeometryModel.bind('change:status', function () {
      if (this._queryGeometryModel.get('status') !== 'unavailable') {
        this.render();
      } else {
        this.showError(_t('components.modals.export-data.error.geometry-error'));
      }
    }, this);
    this.add_related_model(this._queryGeometryModel);
  },

  /**
   * search a format based on its name in the format array
   * @param  {string} format Format name
   * @return {Object}
   */
  _getFormat: function (format) {
    for (var n in FORMATS) {
      if (FORMATS[n].format === format) {
        return FORMATS[n];
      }
    }
  },

  _onConfirm: function () {
    this._form = this.$('.js-form');
    var formatName = $('.js-format[name=format]:checked', this._form).data('format');
    var format = this._getFormat(formatName);

    this[format.fetcher](formatName);
  },

  /**
   * Create a dictionary with the options shared between all the methods
   * @return {Object}
   */
  getBaseOptions: function () {
    return {
      filename: this._fileName,
      apiKey: this._configModel.get('api_key')
    };
  },

  /**
   * Returns a specific sql filtered by the_geom, used on CSV exports
   * @return {string}
   */
  getGeomFilteredSql: function () {
    var sql = this._queryGeometryModel.get('query');
    var geom = this._queryGeometryModel.get('simple_geom');

    // if we have "the_geom" in our current schema, we apply a custom sql
    if (geom) {
      return CSV_FILTER.replace(/%%sql%%/g, sql);
    }
    // Otherwise, we apply regular sql
    return sql;
  },

  /**
   * Populates the hidden form with the format related values and submits them to get the file
   * @param  {Object} options Base options
   * @param  {String} sql Sql of the document to be retrieved
   */
  _fetch: function (options, sql) {
    this.$('.js-format').val(options.format);
    this.$('.js-q').val(sql);
    this.$('.js-filename').val(options.filename);
    this.$('.js-apiKey').val(options.apiKey);

    var skipFields = ['the_geom_webmercator'];
    if (options.format !== 'csv') {
      skipFields.push('the_geom');
    }
    this.$('.js-skipfields').val(skipFields.join(','));

    // TODO: track metrics

    // check if the sql is big or not, and send the request as a verb or other. This is a HACK.
    if (sql.length < MAX_SQL_GET_LENGTH) {
      var location = this.$('.js-form').attr('action') + '?' + this.$('.js-form').serialize();
      this._fetchGET(location);
    } else {
      // I can't find a way of making the iframe trigger load event when its get a form posted,
      // so we need to leave like it was until
      this.submit();
    }

    this.$('.js-skipfields').attr('disabled', 'disabled');

    if (this.options.autoClose) {
      this._close();
    } else {
      this._renderLoadingContent(_t('components.modals.export-data.loading.preparing'));
    }
  },

  showError: function (errorMessage) {
    var errorView = new ErrorView({
      title: _t('hello'),
      desc: errorMessage
    });
    this.$el.html(errorView.render().el);
    this.addView(errorView);
  },

  _fetchGET: function (url) {
    function getError (content) {
      // sql api returns a json when it fails
      // but if the browser is running some plugin that
      // formats it, the window content is the html
      // so search for the word "error"
      var error = null;
      try {
        var json = JSON.parse(content);
        error = json.error[0];
      } catch (e) {
        if (content && content.indexOf('error') !== -1) {
          error = _t('components.modals.export-data.error.unknown');
        }
      }
      return error;
    }

    var self = this;
    var checkInterval;

    var w = window.open(url);
    w.onload = function () {
      clearInterval(checkInterval);
      var error = getError(w.document.body.textContent);
      if (error) {
        self.showError(error);
      } else {
        self._close();
      }
      w.close();
    };
    window.focus();
    checkInterval = setInterval(function check () {
      // safari needs to check the body because it never
      // calls onload
      if (w.closed || (w.document && w.document.body.textContent.length === 0)) {
        self._close();
        clearInterval(checkInterval);
      }
    }, 100);
  },

  /**
   * Base fetch, for the formats that don't require special threatment
   * @param  {String} formatName
   */
  fetch: function (formatName) {
    var options = this.getBaseOptions();
    options.format = formatName;
    var sql = this._queryGeometryModel.get('query');
    this._fetch(options, sql);
  },

  /**
   * Gets the options needed for csv format and fetch the document
   * @param  {String} formatName
   */
  fetchCSV: function () {
    var options = this.getBaseOptions();
    options.format = 'csv';
    var sql = this.getGeomFilteredSql();
    this.$('.js-skipfields').removeAttr('disabled');
    this._fetch(options, sql);
  },
  /**
   * Gets the options needed for svg format and fetch the document
   * @param  {String} formatName
   */
  fetchSVG: function () {
    this.fetch('svg');
  },

  /**
   * Submits the form. This method is separated to ease the testing
   */
  submit: function () {
    this.$('.js-form').submit();
  },

  _renderLoadingContent: function (title) {
    this.$el.html(
      renderLoading({
        title: title
      })
    );
  },

  _close: function () {
    this._modalModel.destroy();
  }

});

},{"../../error/error-view":67,"../../loading/render-loading":230,"./modal-export-data.tpl":409,"backbone/core-view":1127,"jquery":"jquery"}],409:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="24px" height="24px" viewbox="459 348 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <g id="Export-dataset" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(459.000000, 348.000000)">\n          <path d="M1,1 L11,1 L11,5.5 C11,5.776 11.224,6 11.5,6 L16,6 L16,9.5 L17,9.5 L17,5.502 C17,5.502 17,5.502 17,5.501 C17,5.5 17,5.501 17,5.5 C17,5.447 16.985,5.398 16.97,5.35 C16.966,5.337 16.967,5.323 16.962,5.311 C16.936,5.247 16.896,5.19 16.847,5.142 L11.854,0.147 C11.808,0.101 11.753,0.064 11.692,0.039 C11.632,0.014 11.567,0 11.5,0 L0.5,0 C0.224,0 0,0.224 0,0.5 L0,21.5 C0,21.776 0.224,22 0.5,22 L10.5,22 L10.5,21 L1,21 L1,1 L1,1 Z M12,1.708 L15.291,5 L12,5 L12,1.708 L12,1.708 Z" id="Shape" fill="#2E3C43"/>\n          <path d="M17.5,11 C13.916,11 11,13.916 11,17.5 C11,21.084 13.916,24 17.5,24 C21.084,24 24,21.084 24,17.5 C24,13.916 21.084,11 17.5,11 L17.5,11 Z M17.5,23 C14.467,23 12,20.533 12,17.5 C12,14.467 14.467,12 17.5,12 C20.533,12 23,14.467 23,17.5 C23,20.533 20.533,23 17.5,23 L17.5,23 Z" id="Shape" fill="#2E3C43"/>\n          <path d="M17.858,14.425 C17.767,14.331 17.641,14.272 17.5,14.272 C17.359,14.272 17.232,14.331 17.142,14.425 L14.965,16.602 C14.77,16.797 14.77,17.114 14.965,17.309 C15.16,17.504 15.477,17.504 15.672,17.309 L17,15.981 L17,20.226 C17,20.502 17.224,20.726 17.5,20.726 C17.776,20.726 18,20.502 18,20.226 L18,15.981 L19.328,17.309 C19.426,17.407 19.554,17.455 19.682,17.455 C19.81,17.455 19.938,17.406 20.036,17.309 C20.231,17.114 20.231,16.797 20.036,16.602 L17.858,14.425 L17.858,14.425 Z" id="Shape" fill="#2E3C43" transform="translate(17.500500, 17.499000) scale(1, -1) translate(-17.500500, -17.499000) "/>\n        </g>\n      </svg>\n    </div>\n\n    <div>\n      <h2 class="CDB-Text CDB-Size-huge is-light u-bSpace--xl">'+
((__t=( _t('components.modals.export-data.title') ))==null?'':_.escape(__t))+
'</h2>\n      <p class="CDB-Text CDB-Size-large u-altTextColor">'+
((__t=( _t('components.modals.export-data.desc') ))==null?'':_.escape(__t))+
'.</p>\n      ';
 if (!isGeoreferenced) { 
__p+='\n        <p class="CDB-Text CDB-Size-large u-altTextColor u-tSpace-xl">'+
((__t=( _t('components.modals.export-data.no-geometry') ))==null?'':_.escape(__t))+
'</p>\n      ';
 } 
__p+='\n\n      <div class="Modal-listTextItem u-flex u-alignCenter">\n        <h3 class="CDB-Text CDB-Size-medium is-semibold u-upperCase">Select format</h3>\n\n        <form class="js-form" method="POST" action="'+
((__t=( url ))==null?'':_.escape(__t))+
'">\n          <input type="hidden" class="js-filename" name="filename" />\n          <input type="hidden" class="js-q" name="q" />\n          <input type="hidden" class="js-apiKey" name="api_key" />\n          <input type="hidden" class="js-skipfields" name="skipfields" disabled="disabled" value="" />\n          <input type="hidden" class="js-dp" name="dp" value="4" disabled="disabled" />\n\n          <ul class="Modal-listForm u-flex u-alignCenter CDB-Text CDB-Size-medium">\n            ';
 _.each(formats, function (format) { 
__p+='\n            <li class="Modal-listFormItem\n              ';
 if (isGeoreferenced === false && format.geomRequired === true) { 
__p+='\n                is-disabled\n              ';
 } 
__p+='"\n            >\n              <input class="CDB-Radio js-format" type="radio" name="format" data-format="'+
((__t=( format.format ))==null?'':_.escape(__t))+
'"\n                ';
 if (isGeoreferenced === false && format.geomRequired === true) { 
__p+='\n                  disabled\n                ';
 } 
__p+='\n\n                ';
 if (format.format === 'csv') { 
__p+='\n                  checked\n                ';
 } 
__p+='\n              >\n              <span class="u-iBlock CDB-Radio-face"></span>\n              <label class="u-iBlock u-lSpace u-upperCase">'+
((__t=( format.label || format.format ))==null?'':_.escape(__t))+
'</label>\n            </li>\n            ';
 }); 
__p+='\n          </ul>\n        </form>\n\n      </div>\n\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.export-data.cancel') ))==null?'':_.escape(__t))+
'</span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.export-data.download') ))==null?'':_.escape(__t))+
'</span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],410:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./footer.tpl');

module.exports = CoreView.extend({

  tagName: 'ul',
  className: 'Modal-listActions u-flex u-alignCenter ',

  events: {
    'click .js-save': '_save'
  },

  initialize: function (opts) {
    if (!opts.visMetadataModel) throw new Error('visMetadataModel is required');
    if (!opts.onSaveAction) throw new Error('onSaveAction is required');

    this._visMetadataModel = opts.visMetadataModel;
    this._onSaveAction = opts.onSaveAction;
    this._initBinds();
  },

  _initBinds: function () {
    this._visMetadataModel.on('change', this.render, this);
  },

  render: function () {
    this.$el.html(
      template({
        canFinish: this._visMetadataModel.isValid()
      })
    );
    return this;
  },

  _save: function () {
    this._visMetadataModel.isValid() && this._onSaveAction();
  }

});

},{"./footer.tpl":411,"backbone/core-view":1127}],411:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<li class="Modal-listActionsitem">\n  <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-close">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n      '+
((__t=( _t('components.modals.maps-metadata.cancel-btn') ))==null?'':_.escape(__t))+
'\n    </span>\n  </button>\n</li>\n<li class="Modal-listActionsitem">\n  <button class="CDB-Button CDB-Button--primary CDB-Button--big js-save '+
((__t=( canFinish ? '' : 'is-disabled' ))==null?'':_.escape(__t))+
'">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase ">\n      '+
((__t=( _t('components.modals.maps-metadata.save-btn') ))==null?'':_.escape(__t))+
'\n    </span>\n  </button>\n</li>\n\n';
}
return __p;
};

},{"underscore":"underscore"}],412:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var templateForm = require('./form.tpl');
require('../../../form-components/index');
var TipsyTooltipView = require('../../../tipsy-tooltip-view');
var utils = require('../../../../helpers/utils');

var REQUIRED_OPTS = [
  'visDefinitionModel',
  'visMetadataModel'
];

module.exports = CoreView.extend({
  className: 'Metadata-form',

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(templateForm());
    this._initViews();
    return this;
  },

  _initViews: function () {
    this._addInputView();
    this._addTextareaView();
    this._addTagsView();
    this._addTooltip();
  },

  _addInputView: function () {
    this._inputView = new Backbone.Form.editors.Text({
      key: 'name',
      model: this._visMetadataModel,
      schema: {
        options: this._visDefinitionModel.get('name'),
        editorAttrs: {
          placeholder: _t('components.modals.maps-metadata.form.name-placeholder')
        }
      }
    });
    this._inputView.on('change', this._commitView, this);

    this.$('.js-name-field').append(this._inputView.render().$el);
  },

  _addTextareaView: function () {
    this._textareaView = new Backbone.Form.editors.TextArea({
      className: 'CDB-Textarea Metadata-textarea',
      key: 'description',
      model: this._visMetadataModel,
      schema: {
        options: this._visDefinitionModel.get('description'),
        editorAttrs: {
          placeholder: _t('components.modals.maps-metadata.form.description-placeholder')
        }
      }
    });

    this._textareaView.on('change', this._commitView, this);

    this.$('.js-description-field').append(this._textareaView.render().$el);
  },

  _addTagsView: function () {
    this._taglistView = new Backbone.Form.editors.Taglist({
      key: 'tags',
      model: this._visMetadataModel,
      schema: {
        options: {
          tags: this._visDefinitionModel.get('tags') || []
        }
      }
    });

    this._taglistView.on('change', this._commitView, this);

    this.$('.js-tags-field').append(this._taglistView.render().$el);
    this.addView(this._taglistView);
  },

  _addTooltip: function () {
    var title = this.$('.js-markdown').data('tooltip');
    this._removeTooltip();

    this._tooltip = new TipsyTooltipView({
      el: this.$('.js-markdown'),
      html: true,
      title: function () {
        return title;
      }
    });
  },

  _commitView: function (view) {
    view.commit();
    // Commit moves values from form to model. We need to override model value after commit()
    if (view.model.changed.hasOwnProperty('name')) {
      this._sanitizeName(view.model.get('name'));
    }
  },

  _sanitizeName: function (name) {
    this._visMetadataModel.set('name', utils.sanitizeHtml(name));
  },

  _removeTooltip: function () {
    if (this._tooltip) {
      this._tooltip.clean();
    }
  },

  _removeBinds: function () {
    this._inputView && this._inputView.off('change', this._commitView, this);
    this._textareaView && this._textareaView.off('change', this._commitView, this);
    this._taglistView && this._taglistView.off('change', this._commitView, this);
  },

  clean: function () {
    this._removeBinds();
    CoreView.prototype.clean.call(this);
  }
});

},{"../../../../helpers/utils":1102,"../../../form-components/index":211,"../../../tipsy-tooltip-view":589,"./form.tpl":413,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],413:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-tSpace-xl CDB-Text u-flex js-name-field">\n  <label class="Metadata-label CDB-Text CDB-Size-medium is-semibold u-upperCase u-ellipsis">'+
((__t=( _t('components.modals.maps-metadata.form.name') ))==null?'':_.escape(__t))+
'</label>\n</div>\n\n<div class="u-tSpace-xl CDB-Text u-flex">\n  <label class="Metadata-label CDB-Text CDB-Size-medium is-semibold u-upperCase u-ellipsis">'+
((__t=( _t('components.modals.maps-metadata.form.description') ))==null?'':_.escape(__t))+
'</label>\n  <div class="u-grow">\n    <div class="js-description-field u-bSpace"></div>\n    <div class="Markdown">\n      <span class="Markdown-tooltip js-markdown" data-tooltip="<em>_italics_</em><br/><b>*bold*</b><br/>[link](http://link.com)">\n        <span class="Markdown-icon">\n          <i class="Markdown-icon-text">M</i>\n          <i class="Markdown-icon-char">￬</i>\n        </span>\n        '+
((__t=( _t('components.modals.maps-metadata.form.markdown') ))==null?'':_.escape(__t))+
'\n      </span>\n    </div>\n  </div>\n\n</div>\n\n<div class="u-tSpace-xl CDB-Text u-flex u-alignCenter js-tags-field">\n  <label class="Metadata-label CDB-Text CDB-Size-medium is-semibold u-upperCase u-ellipsis">'+
((__t=( _t('components.modals.maps-metadata.form.tags') ))==null?'':_.escape(__t))+
'</label>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],414:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="IntermediateInfo">\n  <div class="Dialog-header Modal-header js-header">\n    <div class="Dialog-headerIcon Dialog-headerIcon--negative">\n      <i class="CDB-IconFont CDB-IconFont-cockroach"></i>\n    </div>\n    <h2 class="CDB-Text CDB-Size-large u-bSpace u-errorTextColor">'+
((__t=( _t('components.modals.maps-metadata.error.title') ))==null?'':_.escape(__t))+
'</h2>\n    <h3 class="CDB-Text CDB-Size-medium u-secondaryTextColor">'+
((__t=( error ))==null?'':__t)+
'</h3>\n  </div>\n\n  <div class="Modal-body">\n    <div class="Modal-body-inner">\n\n      <div class="js-footer">\n        <ul class="Modal-actions is-narrow">\n          <li class="Modal-actions-button">\n            <button class="CDB-Button CDB-Button--primary js-back">\n              <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.maps-metadata.back-btn') ))==null?'':_.escape(__t))+
'</span>\n            </button>\n          </li>\n        </ul>\n      </div>\n    </div>\n  </div>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],415:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var VisMetadataModel = require('../../../data/vis-metadata-model');
var template = require('./map-metadata.tpl');
var FooterView = require('./footer/footer-view');
var templateError = require('./map-metadata-error.tpl');
var templateLoading = require('../../loading/render-loading');
var FormView = require('./form/form-view');
var saveMetadata = require('./save-metadata-map');
var errorParser = require('../../../helpers/error-parser');
var Notifier = require('../../../components/notifier/notifier');
var utils = require('../../../helpers/utils');

/**
 * Add layer dialog, typically used from editor
 */
module.exports = CoreView.extend({
  events: {
    'click .js-back': '_onBackFromError'
  },

  className: 'Dialog-content Dialog-content--expanded',

  initialize: function (opts) {
    if (!opts.modalModel) throw new TypeError('modalModel is required');
    if (!opts.visDefinitionModel) throw new TypeError('visDefinitionModel is required');

    this._modalModel = opts.modalModel;
    this._visDefinitionModel = opts.visDefinitionModel;

    this._visMetadataModel = new VisMetadataModel({
      name: this._visDefinitionModel.get('name'),
      description: this._visDefinitionModel.get('description'),
      tags: this._visDefinitionModel.get('tags')
    });

    this._stateModel = new Backbone.Model({
      status: 'show'
    });

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();

    if (this._hasError()) {
      this._renderError();
    } else if (this._isLoading()) {
      this._renderLoading();
    } else {
      this.$el.html(template());
      this._initViews();
    }
    return this;
  },

  _initViews: function () {
    var formView = new FormView({
      visDefinitionModel: this._visDefinitionModel,
      visMetadataModel: this._visMetadataModel
    });

    this.$('.js-content').append(formView.render().el);
    this.addView(formView);

    var footerView = new FooterView({
      visMetadataModel: this._visMetadataModel,
      onSaveAction: this._onSave.bind(this)
    });

    this.$('.js-footer').append(footerView.render().el);
    this.addView(footerView);
  },

  _renderError: function () {
    var error = this._stateModel.get('error');
    this.$el.html(templateError({
      error: _t('components.modals.maps-metadata.error.subtitle', {error: error})
    }));
  },

  _renderLoading: function () {
    this.$el.html(
      templateLoading({
        title: _t('components.modals.maps-metadata.loading')
      })
    );
  },

  _initBinds: function () {
    this._stateModel.on('change:status', this.render, this);
    this.add_related_model(this._stateModel);
  },

  _hasError: function () {
    return this._stateModel.get('status') === 'error';
  },

  _isLoading: function () {
    return this._stateModel.get('status') === 'loading';
  },

  _onSave: function () {
    this._stateModel.set({status: 'loading'});

    saveMetadata({
      onSuccess: this._onSuccessSave.bind(this),
      onError: this._onErrorSave.bind(this),
      visDefinitionModel: this._visDefinitionModel,
      name: this._getMetadataName(),
      description: this._getMetadataDescription(),
      tags: this._getMetadataTags()
    });
  },

  _onSuccessSave: function () {
    var self = this;
    Notifier.addNotification({
      status: 'success',
      info: _t('components.modals.maps-metadata.success', {
        name: self._getMetadataName()
      }),
      closable: true,
      delay: Notifier.DEFAULT_DELAY
    });

    this._modalModel.destroy();
  },

  _onErrorSave: function (e) {
    this._stateModel.set({
      status: 'error',
      error: errorParser(e)
    });
  },

  _onBackFromError: function () {
    this._stateModel.set({status: 'show'});
  },

  _getMetadataName: function () {
    return utils.sanitizeHtml(this._visMetadataModel.get('name'));
  },

  _getMetadataDescription: function () {
    return utils.sanitizeHtml(this._visMetadataModel.get('description'));
  },

  _getMetadataTags: function () {
    return _.map(this._visMetadataModel.get('tags'), function (tag) {
      return utils.sanitizeHtml(tag);
    });
  }
});

},{"../../../components/notifier/notifier":475,"../../../data/vis-metadata-model":676,"../../../helpers/error-parser":1090,"../../../helpers/utils":1102,"../../loading/render-loading":230,"./footer/footer-view":410,"./form/form-view":412,"./map-metadata-error.tpl":414,"./map-metadata.tpl":416,"./save-metadata-map":417,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],416:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--grid u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="25px" height="25px" viewBox="0 0 25 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n          <g id="Group" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n              <path d="M16,13 L17,13 L17,5.5 C17,5.433 16.986,5.368 16.961,5.308 C16.936,5.247 16.899,5.192 16.853,5.146 L11.854,0.147 C11.808,0.101 11.753,0.064 11.692,0.039 C11.632,0.014 11.567,0 11.5,0 L0.5,0 C0.224,0 0,0.224 0,0.5 L0,21.5 C0,21.776 0.224,22 0.5,22 L9.5,22 L9.5,21 L1,21 L1,1 L11,1 L11,5.5 C11,5.776 11.224,6 11.5,6 L16,6 L16,13 L16,13 Z M12,1.707 L15.293,5 L12,5 L12,1.707 L12,1.707 Z" id="Shape" fill="#2E3C43"></path>\n              <path d="M23.854,14.646 L21.354,12.146 C21.166,11.958 20.834,11.958 20.647,12.146 L13.146,19.648 C13.089,19.705 13.054,19.773 13.03,19.845 C13.028,19.852 13.021,19.857 13.019,19.865 L12.019,23.365 C11.969,23.539 12.018,23.727 12.146,23.856 C12.241,23.951 12.369,24.002 12.5,24.002 C12.546,24.002 12.592,23.996 12.637,23.983 L16.137,22.983 C16.144,22.981 16.149,22.974 16.157,22.972 C16.229,22.948 16.297,22.913 16.354,22.856 L23.855,15.354 C24.05,15.158 24.05,14.842 23.854,14.646 L23.854,14.646 Z M16,21.795 L14.207,20.002 L19.001,15.207 L20.794,17 L16,21.795 L16,21.795 Z M13.747,20.957 L15.045,22.255 L13.228,22.775 L13.747,20.957 L13.747,20.957 Z M21.501,16.293 L19.708,14.5 L21.001,13.207 L22.794,15 L21.501,16.293 L21.501,16.293 Z" id="Shape" fill="#2E3C43"></path>\n          </g>\n      </svg>\n    </div>\n    <div>\n      <h2 class="CDB-Text CDB-Size-huge is-light u-bSpace--xl">\n        '+
((__t=( _t('components.modals.maps-metadata.modal-title') ))==null?'':_.escape(__t))+
'\n      </h2>\n      <p class="CDB-Text CDB-Size-large u-altTextColor">\n        '+
((__t=( _t('components.modals.maps-metadata.modal-desc') ))==null?'':_.escape(__t))+
'\n      </p>\n      <div class="Modal-listTextItem js-content"></div>\n      <div class="js-footer"></div>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],417:[function(require,module,exports){
var TITLE_SUFIX = require('../visualization-title-suffix-metadata');

module.exports = function (opts) {
  if (!opts.visDefinitionModel) throw new Error('visDefinitionModel is required');
  if (!opts.name) throw new Error('name is required');

  var visDefinitionModel = opts.visDefinitionModel;
  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;
  var name = opts.name;
  var description = opts.description;
  var tags = opts.tags;

  var oldName = visDefinitionModel.get('name');

  visDefinitionModel.save({
    name: name,
    description: description,
    tags: tags
  }, {
    wait: true,
    success: function (mdl, attrs) {
      document.title = name + TITLE_SUFIX;
      successCallback && successCallback();
    },
    error: function (mdl, e) {
      document.title = oldName + TITLE_SUFIX;
      errorCallback && errorCallback(e);
    }
  });
};

},{"../visualization-title-suffix-metadata":456}],418:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');

/**
 * View model of a modal
 */
module.exports = Backbone.Model.extend({

  defaults: {
    show: true,
    createContentView: function () {
      return new CoreView();
    }
  },

  createContentView: function () {
    return this.get('createContentView')(this);
  },

  show: function () {
    this.set('show', true);
  },

  hide: function () {
    this.set('show', false);
  },

  isHidden: function () {
    return !this.get('show');
  },

  /**
   * @override {Backbone.Model.prototype.destroy}
   */
  destroy: function () {
    var args = Array.prototype.slice.call(arguments);
    this.trigger.apply(this, ['destroy'].concat(args));
  }
});

},{"backbone":"backbone","backbone/core-view":1127}],419:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./modal.tpl');

// Ought to match the duration of the .Dialog.is-closing animation.
var CLOSE_DELAY_MS = 120;

module.exports = CoreView.extend({
  className: function () {
    if (this.options.escapeOptionsDisabled) {
      return 'Dialog is-white';
    } else {
      return 'Dialog is-opening is-white';
    }
  },

  events: {
    'click .js-close': '_onClose'
  },

  initialize: function () {
    this.listenTo(this.model, 'change:show', this._onShowChange);
    this.listenTo(this.model, 'destroy', this._onDestroy);

    this._escapeOptionsDisabled = this.options.escapeOptionsDisabled;
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(
      template({
        escapeOptionsDisabled: this.options.escapeOptionsDisabled || false
      })
    );

    var view = this.model.createContentView();
    this.addView(view);
    view.render();
    this.$('.js-content').append(view.el);

    return this;
  },

  show: function () {
    this.model.show();
  },

  hide: function () {
    this.model.hide();
  },

  destroy: function () {
    // 'remove' would be a better name ofc, but there is already an internal method with that name in CoreView
    this.model.destroy();
  },

  _onShowChange: function (m, show) {
    if (show) {
      this.$el.show();
      this.$el.removeClass('is-closing').addClass('is-opening');
    } else {
      this.$el.removeClass('is-opening').addClass('is-closing');
      this._delayDueToAnimation(function () {
        this.$el.hide();
      });
    }
  },

  _onClose: function (e) {
    e.stopPropagation();
    this.destroy();
  },

  _onDestroy: function () {
    this.hide();
    _.invoke(this._subviews, 'allOff');
    this._delayDueToAnimation(function () {
      this.clean();
    });
  },

  _delayDueToAnimation: function (fn) {
    setTimeout(fn.bind(this), CLOSE_DELAY_MS);
  }

});

},{"./modal.tpl":420,"backbone/core-view":1127,"underscore":"underscore"}],420:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (!escapeOptionsDisabled) { 
__p+='\n  <button class="CDB-Shape js-close Dialog-closeBtn">\n    <div class="CDB-Shape-close is-blue is-huge"></div>\n  </button>\n';
 } 
__p+='\n<div class="Dialog-contentWrapper js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],421:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var ModalView = require('./modal-view');
var ModalViewModel = require('./modal-view-model');

var DESTROYED_MODAL_EVENT = 'destroyedModal';

/**
 * Top-level API to handle modals.
 * Is intended to be instantiated and registered in some top-level namespace to be accessibel within the lifecycle of
 * an client-side application.
 *
 * Example:
 * // In some entry-point:
 * cdb.modals = new ModalsServiceModel();
 *
 * // Later, in any view, calling create will create a new modal viewModel
 * var modalView = cdb.modals.create(fn)
 *
 * You will probably see the name of "Dialog" here and there, it's the old nomenclature for the concept of Modal.
 */
module.exports = Backbone.Model.extend({

  /**
   * Creates a new modal view
   *
   * @param {Function} createContentView
   * @return {View} the new modal view
   */
  create: function (createContentView, escapeOptionsDisabled) {
    if (!_.isFunction(createContentView)) throw new Error('createContentView is required');

    if (escapeOptionsDisabled) {
      this._escapeOptionsDisabled = escapeOptionsDisabled;
    }

    if (!this._modalView) {
      this.trigger('willCreateModal');
      this._modalView = this._newModalView();
      this.trigger('didCreateModal', this._modalView);
      document.body.appendChild(this._modalView.el);
    }

    this._modalView.model.set('createContentView', createContentView);
    this._modalView.render();

    return this._modalView;
  },

  /**
   * Convenience method to add a listener when current modal is destroyed
   *
   * This is the same as doing
   * modals.create(function (model) {
   *   model.once('destroy', callback, context); // <-- same as modals.onDestroyOnce(callback, context);
   *   return new MyView({ … });
   * });
   *
   * @param {Function} callback
   * @param {Object} [context = undefined]
   */
  onDestroyOnce: function (callback, context) {
    this.once(DESTROYED_MODAL_EVENT, callback, context);
  },

  destroy: function () {
    if (this._modalView) {
      this._modalView.model.destroy();
    }
  },

  _newModalView: function () {
    var self = this;
    var viewModel = new ModalViewModel();
    this._handleBodyClass(viewModel);

    if (!this._escapeOptionsDisabled) {
      this._destroyOnEsc(viewModel);
    }

    this.listenToOnce(viewModel, 'destroy', function () {
      this._modalView = null;
      this.trigger.apply(this, [DESTROYED_MODAL_EVENT].concat(Array.prototype.slice.call(arguments)));
      this.stopListening(viewModel);
    });
    return new ModalView({
      model: viewModel,
      escapeOptionsDisabled: self._escapeOptionsDisabled
    });
  },

  _destroyOnEsc: function (viewModel) {
    var destroyOnEsc = function (ev) {
      if (ev.keyCode === 27) {
        ev.stopPropagation();
        viewModel.destroy();
      }
    };
    document.addEventListener('keydown', destroyOnEsc);
    this.listenToOnce(viewModel, 'destroy', function () {
      document.removeEventListener('keydown', destroyOnEsc);
    });
  },

  /**
   * TL;DR this method manages document.body class state, to enable scroll inside of an open modal.
   *
   * Some modal content have too much content that can be displayed in the viewport the scroll needs to be enabled.
   * Since the modal is implemented as a fixed positioned element the body needs to be fixated too, for the scroll to
   * be enabled inside the modal instead.
   */
  _handleBodyClass: function (viewModel) {
    var bodyClass = 'is-inDialog';
    document.body.classList.add(bodyClass);
    this.set('open', true);

    this.listenTo(viewModel, 'change:show', function (m, show) {
      document.body.classList[show ? 'add' : 'remove'](bodyClass);
      this.set('open', show);
    });

    this.listenToOnce(viewModel, 'destroy', function () {
      document.body.classList.remove(bodyClass);
      this.set('open', false);
    });
  },

  isOpen: function () {
    return this.get('open') === true;
  }

});

},{"./modal-view":419,"./modal-view-model":418,"backbone":"backbone","underscore":"underscore"}],422:[function(require,module,exports){
var _ = require('underscore');

/**
 * type property should match the value given from the API.
 */
var ALL_OPTIONS = [{
  privacy: 'PUBLIC',
  title: _t('components.modals.publish.privacy.public.title'),
  desc: _t('components.modals.publish.privacy.public.body'),
  alwaysEnabled: true,
  cssClass: 'green'
}, {
  privacy: 'LINK',
  title: _t('components.modals.publish.privacy.link.title'),
  desc: _t('components.modals.publish.privacy.link.body'),
  cssClass: 'orange'
}, {
  privacy: 'PASSWORD',
  title: _t('components.modals.publish.privacy.password.title'),
  desc: _t('components.modals.publish.privacy.password.body'),
  cssClass: 'orange-dark'
}, {
  privacy: 'PRIVATE',
  title: _t('components.modals.publish.privacy.private.title'),
  desc: _t('components.modals.publish.privacy.private.body'),
  cssClass: 'red'
}];

module.exports = function (visDefinitionModel, userModel) {
  var isVisualization = visDefinitionModel.isVisualization();
  var actions = userModel.get('actions');
  var canSelectPremiumOptions = actions[ isVisualization ? 'private_maps' : 'private_tables' ];
  var currentPrivacy = visDefinitionModel.get('privacy');
  var availableOptions = visDefinitionModel.privacyOptions();

  return _.chain(ALL_OPTIONS)
    .filter(function (option) {
      return _.contains(availableOptions, option.privacy);
    })
    .map(function (option) {
      // Set state that depends on vis and user attrs, they should not vary during the lifecycle of this collection
      return _.defaults({
        selected: option.privacy === currentPrivacy,
        disabled: !(option.alwaysEnabled || canSelectPremiumOptions)
      }, option);
    })
    .value();
};

},{"underscore":"underscore"}],423:[function(require,module,exports){
var Backbone = require('backbone');
var PrivacyModel = require('./privacy-model');
var PasswordModel = require('./privacy-password-model');

/**
 * Collection that holds the different privacy options.
 */
module.exports = Backbone.Collection.extend({

  model: function (attrs, options) {
    if (attrs.privacy === 'PASSWORD') {
      return new PasswordModel(attrs, options);
    } else {
      return new PrivacyModel(attrs, options);
    }
  },

  initialize: function () {
    this.bind('change:selected', this._deselectLastSelected, this);
  },

  searchByPrivacy: function (privacy) {
    return this.findWhere({privacy: privacy});
  },

  selectedOption: function () {
    return this.find(function (option) {
      return option.get('selected');
    });
  },

  passwordOption: function () {
    return this.find(function (option) {
      return option.get('privacy') === 'PASSWORD';
    });
  },

  _deselectLastSelected: function (m, isSelected) {
    if (isSelected) {
      this.each(function (option) {
        if (option !== m) {
          option.set({selected: false});
        }
      });
    }
  }
});

},{"./privacy-model":424,"./privacy-password-model":425,"backbone":"backbone"}],424:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

module.exports = Backbone.Model.extend({

  defaults: {
    privacy: 'PUBLIC',
    disabled: false,
    selected: false,
    password: undefined
  },

  validate: function (attrs) {
    if (attrs.disabled && attrs.selected) {
      return 'Option can not be disabled and selected at the same time';
    }
  },

  classNames: function () {
    return _.chain(['disabled', 'selected'])
      .map(function (attr) { return this.attributes[attr] !== undefined ? 'is-' + attr : undefined; }, this)
      .compact().value().join(' ');
  },

  canSave: function () {
    return !this.get('disabled');
  },

  isPassword: function () {
    return false;
  },

  isSelected: function () {
    return this.get('selected') === true;
  },

  saveToVis: function (vis, callbacks) {
    return vis.save(this._attrsToSave(), _.extend({ wait: true }, callbacks));
  },

  _attrsToSave: function () {
    return _.pick(this.attributes, 'privacy', 'password');
  }
});

},{"backbone":"backbone","underscore":"underscore"}],425:[function(require,module,exports){
var _ = require('underscore');
var PrivacyModel = require('./privacy-model');

var FAKE_PASSWORD = '!@#!@#';

/**
 * View model for the special privacy option representing a password protected map.
 * It handles the logic related to the password that needs to be set for the option.
 */
module.exports = PrivacyModel.extend({

  initialize: function () {
    PrivacyModel.prototype.initialize.apply(this, arguments);
    this.set('password', FAKE_PASSWORD);
  },

  /**
   * @override OptionModel.attrsToSave
   */
  _attrsToSave: function () {
    var attrs = PrivacyModel.prototype._attrsToSave.call(this);

    if (attrs.password === FAKE_PASSWORD) {
      delete attrs.password;
    }

    return attrs;
  },

  canSave: function () {
    return !this.get('disabled') && !_.isEmpty(this.get('password'));
  },

  isPassword: function () {
    return true;
  }
});

},{"./privacy-model":424,"underscore":"underscore"}],426:[function(require,module,exports){
var $ = require('jquery');
var moment = require('moment');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var template = require('./publish-button.tpl');

var REQUIRED_OPTS = [
  'visDefinitionModel',
  'mapcapsCollection',
  'configModel'
];

module.exports = CoreView.extend({

  events: {
    'click .js-button': '_onUpdate'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this.model = new Backbone.Model({
      status: 'idle'
    });

    this._initBinds();
  },

  render: function () {
    var publishedOn = this._mapcapsCollection.length > 0
                    ? _t('components.modals.publish.share.last-published', { date:
                        this.model.get('status') === 'updated'
                        ? moment(this._mapcapsCollection.first().get('created_at')).fromNow()
                        : moment(this._mapcapsCollection.first().get('created_at')).format('Do MMMM YYYY, HH:mm')
                      })
                    : _t('components.modals.publish.share.unpublished');

    this.clearSubViews();
    this.$el.html(template({
      isPublished: this._mapcapsCollection.length > 0,
      isLoading: this._isLoading(),
      isDisabled: this._isDisabled(),
      publishedOn: publishedOn
    }));
    return this;
  },

  _initBinds: function () {
    this._mapcapsCollection.on('reset', this.render, this);
    this.add_related_model(this._mapcapsCollection);
    this.model.on('change:status', this.render, this);
  },

  _isLoading: function () {
    return this.model.get('status') === 'loading';
  },

  _isDisabled: function () {
    return this.model.get('status') === 'updated';
  },

  _onUpdate: function () {
    var self = this;
    var url = this._visDefinitionModel.mapcapsURL();
    var data = {
      api_key: this._configModel.get('api_key')
    };

    if (this._isDisabled()) return false;

    self.model.set({status: 'loading'});

    $.post(url, data)
    .done(function (data) {
      self._visDefinitionModel.set('visChanges', 0);
      self._mapcapsCollection.add(data, {at: 0});
      self.model.set({status: 'updated'});
    })
    .fail(function () {
      self.model.set({status: 'error'});
    });
  }
});

},{"./publish-button.tpl":427,"backbone":"backbone","backbone/core-view":1127,"jquery":"jquery","moment":"moment","underscore":"underscore"}],427:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button class="Publish-modalButton CDB-Button CDB-Button--primary CDB-Button--small u-rSpace js-button ';
 if (isDisabled) {
__p+='is-disabled';
 } 
__p+='">\n  <div class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small u-upperCase u-flex">\n    ';
 if (isLoading) { 
__p+='\n      <div class="CDB-LoaderIcon CDB-LoaderIcon--small u-iBlock">\n        <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n          <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n        </svg>\n      </div>\n      ';
 if (isPublished) { 
__p+='\n      '+
((__t=( _t('components.modals.publish.updating-btn') ))==null?'':_.escape(__t))+
'\n      ';
 } else { 
__p+='\n      '+
((__t=( _t('components.modals.publish.publishing-btn') ))==null?'':_.escape(__t))+
'\n      ';
 } 
__p+='\n    ';
 } else { 
__p+='\n      ';
 if (isPublished) { 
__p+='\n      '+
((__t=( _t('components.modals.publish.update-btn') ))==null?'':_.escape(__t))+
'\n      ';
 } else { 
__p+='\n      '+
((__t=( _t('components.modals.publish.publish-btn') ))==null?'':_.escape(__t))+
'\n      ';
 } 
__p+='\n    ';
 } 
__p+='\n  </div>\n</button> '+
((__t=( publishedOn ))==null?'':_.escape(__t))+
'';
}
return __p;
};

},{"underscore":"underscore"}],428:[function(require,module,exports){
var _ = require('underscore');
var moment = require('moment');
var CoreView = require('backbone/core-view');
var template = require('./publish.tpl');
var TabPaneTemplate = require('./tab-pane-submenu.tpl');
var createTextLabelsTabPane = require('../../tab-pane/create-text-labels-tab-pane');
var PublishView = require('./publish/publish-view');
var ShareView = require('./share/share-view');
var PrivacyDropdown = require('../../privacy-dropdown/privacy-dropdown-view');
var PublishButton = require('./publish-button-view');
var ShareWith = require('./share-with-view');
var UpgradeView = require('./upgrade-view');

var REQUIRED_OPTS = [
  'modalModel',
  'visDefinitionModel',
  'privacyCollection',
  'userModel',
  'configModel'
];

var MODE_FULL = 'full';
var MODE_SHARE = 'share';
var MODE_PUBLISH = 'publish';

module.exports = CoreView.extend({
  className: 'Publish-modal',

  events: {
    'click .js-done': '_onDone'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    // Optional options
    this._mapcapsCollection = opts.mapcapsCollection;
    this.mode = opts.mode || MODE_FULL;
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template({
      name: this._visDefinitionModel.get('name'),
      isSimple: !this._hasTabs(),
      hasShareStats: this._hasShareStats()
    }));

    this._initViews();

    if (this.mode === MODE_FULL) {
      if (!this._hasOrganization()) {
        this._makePublishView();
      } else {
        this._initTabsViews();
      }
    } else if (this.mode === MODE_SHARE) {
      this._makeShareView();
    } else if (this.mode === MODE_PUBLISH) {
      this._makePublishView();
    }

    return this;
  },

  _hasShareStats: function () {
    return this.mode !== MODE_PUBLISH && this._hasOrganization();
  },

  _hasOrganization: function () {
    return this._userModel.isInsideOrg();
  },

  _hasTabs: function () {
    var hasOrganization = this._hasOrganization();
    return hasOrganization && this.mode === MODE_FULL;
  },

  _makePublishView: function () {
    var view = this._createPublishView();
    this.$('.js-panes').append(view.render().el);
    this.addView(view);
  },

  _makeShareView: function () {
    var view = this._createShareView();
    this.$('.js-panes').append(view.render().el);
    this.addView(view);
  },

  _initViews: function () {
    var dropdown;
    var publishButton;
    var shareWith;
    var upgradeView;
    var publishedOn;

    dropdown = new PrivacyDropdown({
      privacyCollection: this._privacyCollection,
      visDefinitionModel: this._visDefinitionModel,
      userModel: this._userModel,
      configModel: this._configModel
    });

    this.$('.js-dropdown').append(dropdown.render().el);
    this.addView(dropdown);

    if (this._mapcapsCollection !== undefined) {
      publishButton = new PublishButton({
        visDefinitionModel: this._visDefinitionModel,
        mapcapsCollection: this._mapcapsCollection,
        configModel: this._configModel
      });

      this.$('.js-update').append(publishButton.render().el);
      this.addView(publishButton);
    } else {
      publishedOn = _t('components.modals.publish.share.last-published', { date:
                      moment(this._visDefinitionModel.get('updated_at')).format('Do MMMM YYYY, HH:mm')
                    });

      this.$('.js-update').html(publishedOn);
    }

    if (this._hasShareStats()) {
      shareWith = new ShareWith({
        visDefinitionModel: this._visDefinitionModel,
        userModel: this._userModel,
        avatarClass: 'Share-user--big',
        separationClass: 'u-rSpace--xl'
      });
      this.$('.js-share-users').append(shareWith.render().el);
      this.addView(shareWith);
    }

    if (!this._hasOrganization()) {
      upgradeView = new UpgradeView();
      this.$('.js-upgrade').append(upgradeView.render().el);
      this.addView(upgradeView);
    }
  },

  _initTabsViews: function () {
    var self = this;

    var tabPaneTabs = [{
      name: 'share',
      label: _t('components.modals.publish.menu.share'),
      createContentView: self._createShareView.bind(self)
    }, {
      name: 'publish',
      label: _t('components.modals.publish.menu.publish'),
      createContentView: self._createPublishView.bind(self)
    }];

    var tabPaneOptions = {
      tabPaneOptions: {
        template: TabPaneTemplate,
        tabPaneItemOptions: {
          tagName: 'li',
          className: 'CDB-NavSubmenu-item'
        }
      },
      tabPaneItemLabelOptions: {
        tagName: 'button',
        className: 'CDB-NavSubmenu-link u-upperCase Publish-modalLink'
      }
    };

    this._layerTabPaneView = createTextLabelsTabPane(tabPaneTabs, tabPaneOptions);
    this.$('.js-panes').append(this._layerTabPaneView.render().$el);
    this.addView(this._layerTabPaneView);
  },

  _createShareView: function () {
    return new ShareView({
      className: 'Share-wrapper',
      currentUserId: this._userModel.id,
      visDefinitionModel: this._visDefinitionModel,
      organization: this._userModel._organizationModel,
      configModel: this._configModel
    });
  },

  _createPublishView: function () {
    return new PublishView({
      visDefinitionModel: this._visDefinitionModel,
      mapcapsCollection: this._mapcapsCollection,
      userModel: this._userModel
    });
  },

  _onDone: function () {
    this._modalModel.destroy();
  }
});

},{"../../privacy-dropdown/privacy-dropdown-view":527,"../../tab-pane/create-text-labels-tab-pane":537,"./publish-button-view":426,"./publish.tpl":429,"./publish/publish-view":433,"./share-with-view":439,"./share/share-view":444,"./tab-pane-submenu.tpl":450,"./upgrade-view":451,"backbone/core-view":1127,"moment":"moment","underscore":"underscore"}],429:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Publish-modalHeader">\n  <div class="u-inner">\n    <div class="CDB-Text CDB-Size-huge is-light u-ellipsis u-bSpace--m">'+
((__t=( name ))==null?'':_.escape(__t))+
'</div>\n    <ul class="u-flex u-alignCenter">\n      <li class="js-dropdown u-rSpace--xl"></li>\n      ';
 if (hasShareStats) { 
__p+='\n      <li class="js-share-users">\n      </li>\n      ';
 } 
__p+='\n      <li class="CDB-Text CDB-Size-medium u-altTextColor js-update">\n      </li>\n  </div>\n</div>\n\n<div class="Publish-modalBody js-panes\n';
 if (isSimple) { 
__p+='is-simple';
 } 
__p+='\n">\n  ';
 if (isSimple) { 
__p+='\n    <div class="Publish-modalShadow"></div>\n  ';
 } 
__p+='\n\n</div>\n\n<div class="Dialog-footer Dialog-footer--expanded CreateDialog-footer Publish-modalFooter">\n  <div>\n    <div class="CreateDialog-footerShadow"></div>\n    <div class="CreateDialog-footerLine"></div>\n    <div class="CreateDialog-footerInner ">\n      <div class="CreateDialog-footerInfo"></div>\n      <div class="CreateDialog-footerActions js-footerActions u-flex u-justifySpace u-grow">\n        <div class="js-upgrade"></div>\n        <button class="CDB-Button CDB-Button--secondary js-done">\n          <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.publish.done-btn') ))==null?'':_.escape(__t))+
'</span>\n        </button>\n      </div>\n    </div>\n  </div>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],430:[function(require,module,exports){
var linkIconTemplate = require('./icon-link.tpl');
var embedIconTemplate = require('./icon-embed.tpl');

module.exports = function (visDefinitionModel) {
  return [{
    createIcon: function () {
      return linkIconTemplate();
    },
    type: 'get-link',
    content: visDefinitionModel.embedURL(),
    private: visDefinitionModel.get('privacy') === 'PRIVATE'
  }, {
    createIcon: function () {
      return embedIconTemplate();
    },
    type: 'embed',
    content: '<iframe width="100%" height="520" frameborder="0" src="' + encodeURI(visDefinitionModel.embedURL()) + '" allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen></iframe>',
    url: encodeURI(visDefinitionModel.embedURL()),
    private: visDefinitionModel.get('privacy') === 'PRIVATE'
  }];
};

},{"./icon-embed.tpl":431,"./icon-link.tpl":432}],431:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='\n<svg width="25px" height="25px" viewBox="682 469 25 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <path d="M697.141667,478.48556 C695.774797,477.117815 695.774797,474.90231 697.141553,473.535553 L697.495051,473.182056 L697.141609,472.828502 L693.960609,469.646502 L693.607124,469.292907 L693.253515,469.646378 L690.685515,472.213378 L691.039,472.567 L691.469343,472.312431 C691.271611,471.978171 691.043454,471.678347 690.778553,471.413447 C689.020272,469.655166 686.171603,469.655166 684.414333,471.41356 C682.657184,473.170709 682.657184,476.020291 684.414447,477.777553 C684.682252,478.044267 684.982655,478.273359 685.314094,478.468734 L685.568,478.038 L685.214447,477.684447 L682.646447,480.252447 L682.292893,480.606 L682.646447,480.959553 L685.828447,484.141553 L686.181887,484.494994 L686.53544,484.141667 C687.903185,482.774797 690.11869,482.774797 691.485447,484.141553 C692.852184,485.508291 692.852184,487.724709 691.485447,489.091447 L691.131893,489.445 L691.485447,489.798553 L694.667447,492.980553 L695.021,493.334107 L695.374553,492.980553 L697.941553,490.413553 L697.588,490.06 L697.157928,490.315025 C697.3561,490.649221 697.584149,490.948256 697.849447,491.213553 C699.60664,492.971872 702.456485,492.971872 704.21278,491.213327 C705.970872,489.45636 705.970872,486.606515 704.212327,484.85022 C703.948015,484.584823 703.647051,484.355236 703.312906,484.158266 L703.059,484.589 L703.412553,484.942553 L705.979553,482.375553 L706.333107,482.022 L705.979553,481.668447 L702.797553,478.486447 L702.444,478.132893 L702.090447,478.486447 C700.725536,479.851357 698.508943,479.851087 697.141327,478.48522 L697.141667,478.48556 Z M696.434673,479.19278 C698.192747,480.948604 701.042155,480.948952 702.797553,479.193553 L702.090447,479.193553 L705.272447,482.375553 L705.272447,481.668447 L702.705447,484.235447 L702.248976,484.691917 L702.805094,485.019734 C703.068228,485.174844 703.301587,485.35286 703.504724,485.55683 C704.873128,486.923485 704.873128,489.13964 703.50556,490.506333 C702.139515,491.874128 699.92336,491.874128 698.556667,490.50656 C698.35252,490.302414 698.175052,490.069704 698.018072,489.804975 L697.689693,489.2512 L697.234447,489.706447 L694.667447,492.273447 L695.374553,492.273447 L692.192553,489.091447 L692.192553,489.798553 C693.949816,488.041291 693.949816,485.191709 692.192553,483.434447 C690.43531,481.677203 687.586815,481.677203 685.82856,483.434333 L686.535553,483.434447 L683.353553,480.252447 L683.353553,480.959553 L685.921553,478.391553 L686.378024,477.935083 L685.821906,477.607266 C685.560783,477.453341 685.327004,477.275057 685.12083,477.069724 C683.754816,475.703709 683.754816,473.487291 685.121553,472.120553 C686.488397,470.752834 688.703728,470.752834 690.071447,472.120553 C690.274695,472.323801 690.452152,472.557 690.608657,472.821569 L690.936742,473.376188 L691.392485,472.920622 L693.960485,470.353622 L693.253391,470.353498 L696.434391,473.535498 L696.434447,472.828447 C694.677203,474.58569 694.677203,477.434185 696.434333,479.19244 L696.434673,479.19278 Z" id="Embed-it" stroke="none" fill="#AAAAAA" fill-rule="evenodd"></path>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],432:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='  <svg width="23px" height="23px" viewBox="683 470 23 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n      <path d="M696.399947,482.106803 L696.485947,482.192803 C697.462209,483.169066 699.044791,483.169066 700.021053,482.192803 L703.986009,478.228848 C705.34724,476.86645 705.34724,474.642218 703.986356,473.279 L702.227953,471.521596 C700.866908,470.159384 698.640092,470.159384 697.278795,471.521848 L693.313991,475.485652 C692.337722,476.461921 692.337722,478.044329 693.31372,479.021577 L693.40202,479.108865 L694.10498,478.397635 L694.01898,478.312635 C693.435278,477.728171 693.435278,476.778579 694.021053,476.192803 L697.986009,472.228848 C698.956908,471.257116 700.550092,471.257116 701.520795,472.228652 L703.279047,473.985904 C704.24976,474.958282 704.24976,476.55005 703.278795,477.521848 L699.313991,481.485652 C698.728209,482.071434 697.778791,482.071434 697.193053,481.485697 L697.107053,481.399697 L696.399947,482.106803 L696.399947,482.106803 Z M692.10498,480.397635 L692.01898,480.312635 C691.044791,479.338434 689.462209,479.338434 688.485947,480.314697 L684.520991,484.278652 C683.159735,485.641076 683.159735,487.866424 684.520795,489.228652 L686.279047,490.985904 C687.640092,492.348116 689.866908,492.348116 691.228205,490.985652 L695.193009,487.021848 C696.169278,486.045579 696.169278,484.463171 695.19328,483.485923 L695.107053,483.399697 L694.399947,484.106803 L694.485947,484.192803 C695.071722,484.779329 695.071722,485.728921 694.485947,486.314697 L690.520991,490.278652 C689.550092,491.250384 687.956908,491.250384 686.986205,490.278848 L685.227953,488.521596 C684.257265,487.550076 684.257265,485.957424 685.228205,484.985652 L689.193009,481.021848 C689.778791,480.436066 690.728209,480.436066 691.313947,481.021803 L691.40202,481.108865 L692.10498,480.397635 L692.10498,480.397635 Z M690.718053,485.495803 L698.496053,477.717803 L697.788947,477.010697 L690.010947,484.788697 L690.718053,485.495803 L690.718053,485.495803 Z" id="Get-link" stroke="none" fill="#AAAAAA" fill-rule="evenodd"></path>\n  </svg>';
}
return __p;
};

},{"underscore":"underscore"}],433:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var CreateShareOptions = require('./create-share-options');
var ShareCollection = require('./share-collection');
var ShareItemView = require('./share-item-view');
var template = require('./publish.tpl');

var REQUIRED_OPTS = [
  'visDefinitionModel',
  'mapcapsCollection',
  'userModel'
];

module.exports = CoreView.extend({
  className: 'Publish-modalShare u-inner',

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this.hasOrganization = this._userModel.isInsideOrg();

    var shareOptions = CreateShareOptions(this._visDefinitionModel);
    this._shareCollection = new ShareCollection(shareOptions);

    this._initBinds();
  },

  render: function () {
    var isPublished = this._mapcapsCollection.length > 0;
    this.clearSubViews();
    this.$el.html(template({
      isPublished: isPublished
    }));
    this._initViews();
    return this;
  },

  _initViews: function () {
    var renderItemView = this._renderItemView.bind(this);
    this._shareCollection.each(renderItemView);
  },

  _renderItemView: function (model) {
    var self = this;
    var isPublished = this._mapcapsCollection.length > 0;
    var view = new ShareItemView({
      model: model,
      isPublished: isPublished,
      hasOrganization: self.hasOrganization
    });

    this.$('.js-list').append(view.render().el);
    this.addView(view);
  },

  _revampPrivacyOptions: function () {
    var shareOptions = CreateShareOptions(this._visDefinitionModel);
    this._shareCollection.reset(shareOptions);
  },

  _initBinds: function () {
    this._visDefinitionModel.on('sync', this._revampPrivacyOptions, this);
    this.add_related_model(this._visDefinitionModel);

    this._shareCollection.on('reset', this.render, this);
    this.add_related_model(this._shareCollection);

    this._mapcapsCollection.on('reset add', this.render, this);
    this.add_related_model(this._mapcapsCollection);
  }
});

},{"./create-share-options":430,"./publish.tpl":434,"./share-collection":435,"./share-item-view":436,"backbone/core-view":1127,"underscore":"underscore"}],434:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="Publish-optionsList u-flex u-justifySpace js-list"></ul>\n';
 if (!isPublished) { 
__p+='\n<div class="Share-info">\n  <div>\n    <h2 class="CDB-Text CDB-Size-large u-secondaryTextColor u-bSpace is-light">'+
((__t=( _t('components.modals.publish.share.unpublished-header') ))==null?'':_.escape(__t))+
'</h2>\n    <p class="CDB-Text CDB-Size-medium is-light">'+
((__t=( _t('components.modals.publish.share.unpublished-subheader') ))==null?'':_.escape(__t))+
'</p>\n  </div>\n</div>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],435:[function(require,module,exports){
var Backbone = require('backbone');
var ShareModel = require('./share-model');

module.exports = Backbone.Collection.extend({
  model: ShareModel
});

},{"./share-model":438,"backbone":"backbone"}],436:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var Clipboard = require('clipboard');
var template = require('./share-item.tpl');
var browserDetect = require('../../../../helpers/browser-detect');

var PRIVATE_LABEL_TEMPLATE = _.template("<span class='CDB-Text CDB-Size-small is-semibold u-errorTextColor'><%- private %></span>.<br>")({
  private: _t('components.modals.publish.share.private')
});

module.exports = CoreView.extend({
  className: 'Card',
  tagName: 'li',

  events: {
    'click .js-change-privacy': '_onChangePrivacyClick'
  },

  initialize: function (opts) {
    if (!opts.model) throw new Error('model is required');
    if (opts.isPublished == null) throw new Error('isPublished is required');

    this._isPublished = opts.isPublished;
    this._type = this.model.type();
    this._hasOrganization = opts.hasOrganization;
    this._title = _t('components.modals.publish.share.' + this._type + '.title');

    if (this.model.isPrivate()) {
      this._body = _t('components.modals.publish.share.' + this._type + '.private.body', {
        private: PRIVATE_LABEL_TEMPLATE
      });
    } else {
      this._body = _t('components.modals.publish.share.' + this._type + '.body');
    }

    this._link = _t('components.modals.publish.share.' + this._type + '.link');
    this._copy = this._getButtonLabel();
    this.$el.toggleClass('is-disabled', this.model.isPrivate());
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    if (!this.model.isPrivate() && this._isPublished) {
      this._initClipboard();
    }
    return this;
  },

  _getButtonLabel: function () {
    var browser = browserDetect();
    var label = _t('components.modals.publish.share.' + this._type + '.copy');
    if (browser.name === 'Safari') {
      label = _t('components.modals.publish.share.' + this._type + '.select');
    }

    return label;
  },

  getValue: function () {
    return this.$('.js-input').val();
  },

  _initViews: function () {
    var view = template({
      id: this.cid,
      isPrivate: this.model.isPrivate(),
      type: this._type,
      title: this._title,
      body: this._body,
      content: this.model.content(),
      link: this._link,
      copy: this._copy,
      url: this.model.url(),
      isPublished: this._isPublished
    });

    this.$el.append(view);

    var iconTemplate = this.model.createIcon();
    this.$('.js-icon').append(iconTemplate());
  },

  _initClipboard: function () {
    if (this._clipboard) {
      this._clipboard.destroy();
    }

    var btn = this.$('.js-copy');
    this._clipboard = new Clipboard(btn.get(0));
  },

  _onChangePrivacyClick: function (e) {
    this.killEvent(e);
    this.options.onChangePrivacy && this.options.onChangePrivacy();
  },

  clean: function () {
    this._clipboard && this._clipboard.destroy();
    CoreView.prototype.clean.call(this);
  }
});

},{"../../../../helpers/browser-detect":1088,"./share-item.tpl":437,"backbone/core-view":1127,"clipboard":"clipboard","underscore":"underscore"}],437:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Card-icon u-bSpace--xl js-icon"></div>\n\n<div class="Card-body u-bSpace--xl">\n  ';
 if (isPrivate) { 
__p+='\n    <h3 class="CDB-Text CDB-Size-large u-altTextColor u-bSpace--m">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h3>\n  ';
 } else { 
__p+='\n    <h3 class="CDB-Text CDB-Size-large u-mainTextColor u-bSpace--m">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h3>\n  ';
 } 
__p+='\n  <div class="CDB-Text CDB-Size-medium u-altTextColor">\n    '+
((__t=( body ))==null?'':__t)+
'\n    <br/>\n    ';
 if (url && !isPrivate) { 
__p+='\n    <a href="'+
((__t=( url ))==null?'':_.escape(__t))+
'" class="Share-link js-link">'+
((__t=( link ))==null?'':_.escape(__t))+
'</a>\n    ';
 } 
__p+='\n  </div>\n</div>\n\n';
 if (!isPrivate && isPublished) { 
__p+='\n  <div class="Share-input">\n    <input type="text" id="'+
((__t=( id ))==null?'':_.escape(__t))+
'" value="'+
((__t=( content ))==null?'':_.escape(__t))+
'" class="Share-input-field CDB-InputText is-disabled CDB-Text CDB-Size-medium u-ellipsis js-input" readonly>\n    <button class="Share-copy CDB-Button CDB-Button--small js-copy" data-clipboard-target="#'+
((__t=( id ))==null?'':_.escape(__t))+
'">\n      <span class="CDB-Button-Text CDB-Text CDB-Size-small u-actionTextColor">'+
((__t=( copy ))==null?'':_.escape(__t))+
'</span>\n    </button>\n  </div>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],438:[function(require,module,exports){
var Backbone = require('backbone');

module.exports = Backbone.Model.extend({
  createIcon: function () {
    return this.get('createIcon');
  },

  type: function () {
    return this.get('type');
  },

  content: function () {
    return this.get('content');
  },

  url: function () {
    return this.get('url');
  },

  isPrivate: function () {
    return this.get('private');
  }
});

},{"backbone":"backbone"}],439:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var template = require('./share-with.tpl');

var REQUIRED_OPTS = [
  'visDefinitionModel',
  'userModel'
];

module.exports = CoreView.extend({
  className: 'Share-with u-flex u-alignCenter',

  events: {
    'click .js-action': '_onAction'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this.separationClass = opts.separationClass || '';
    this.avatarClass = opts.avatarClass || '';

    this._acl = this._visDefinitionModel._permissionModel.acl;
    this._initBinds();
  },

  render: function () {
    var people = this._getPeople();
    var hasAction = this.options.action !== undefined && this._hasOrganization();

    this.clearSubViews();
    this.$el.html(template({
      avatar: this._userModel.get('avatar_url'),
      people: people,
      avatarClass: this.avatarClass,
      separationClass: this.separationClass,
      hasAction: hasAction
    }));
    return this;
  },

  _getPeople: function () {
    var types = this._acl.pluck('type');
    if (types.indexOf('org') > -1) {
      return this._userModel.getOrganization().get('user_count') - 1;
    } else {
      var users = [];

      // Grab all ids from every group
      _.each(this._acl.where({type: 'group'}), function (group) {
        var entity = group.get('entity');
        Array.prototype.push.apply(users, entity.users.pluck('id'));
      }, this);

      // Grab all ids from every user
      _.each(this._acl.where({type: 'user'}), function (group) {
        var entity = group.get('entity');
        users.push(entity.get('id'));
      }, this);

      // remove current user id because it can be part of a group
      users = _.without(users, this._userModel.id);

      // counts unique ids
      return _.unique(users).length;
    }
  },

  _hasOrganization: function () {
    return this._userModel.isInsideOrg();
  },

  _initBinds: function () {
    this._acl.on('fetch', this.render, this);
    this.add_related_model(this._acl);
  },

  _onAction: function () {
    this.options.action && this.options.action();
  }
});

},{"./share-with.tpl":440,"backbone/core-view":1127,"underscore":"underscore"}],440:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (people > 0) { 
__p+='\n<div class="Share-user '+
((__t=( avatarClass ))==null?'':_.escape(__t))+
' u-rSpace u-iBlock" style="background-image: url('+
((__t=( avatar ))==null?'':_.escape(__t))+
')"></div>\n<span class="u-secondaryTextColor CDB-Text CDB-Size-small '+
((__t=( separationClass ))==null?'':_.escape(__t))+
'">+ '+
((__t=( people ))==null?'':_.escape(__t))+
'</span>\n';
 } else { 
__p+='\n  ';
 if (hasAction) { 
__p+='\n  <button class="CDB-Text CDB-Size-small u-upperCase u-actionTextColor js-action '+
((__t=( separationClass ))==null?'':_.escape(__t))+
'">'+
((__t=( _t('components.modals.publish.share.add-people') ))==null?'':_.escape(__t))+
'</button>\n  ';
 } 
__p+='\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],441:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var PermissionView = require('./share-permission-view');

var REQUIRED_OPTS = [
  'collection',
  'currentUserId',
  'organization',
  'hasOrganization',
  'sharePermissionModel',
  'isVisualization'
];

module.exports = CoreView.extend({
  className: 'Share-list',

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    // To avoid jumps in rendering when the user gets permission
    // we sort the collection only the first time
    this._sortedCollection = this._sortCollection();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this._sharePermissionModel.acl.on('add remove reset change', this.render, this);
    this.add_related_model(this._sharePermissionModel);
  },

  _initViews: function () {
    if (this._hasOrganization) {
      this._renderOrganization();
    }

    _.each(this._sortedCollection, this._renderItem, this);
  },

  _sortCollection: function () {
    // sharing first
    var sharing = this._collection.filter(function (model) {
      var permission = this._sharePermissionModel;
      var hasWriteAccess = permission.hasWriteAccess(model);
      var hasReadAccess = permission.hasReadAccess(model);
      return hasWriteAccess || hasReadAccess;
    }, this);

    var noSharing = this._collection.filter(function (model) {
      var permission = this._sharePermissionModel;
      var hasWriteAccess = permission.hasWriteAccess(model);
      var hasReadAccess = permission.hasReadAccess(model);
      return !hasWriteAccess && !hasReadAccess;
    }, this);

    return sharing.concat(noSharing);
  },

  _renderOrganization: function () {
    var self = this;
    var organization = this._organization;
    var permission = this._sharePermissionModel;
    var hasWriteAccessAvailable = !self._isVisualization;
    var canChangeWriteAccess = permission.canChangeWriteAccess(organization);
    var hasWriteAccess = permission.hasWriteAccess(organization);
    var canChangeReadAccess = permission.canChangeReadAccess(organization);
    var hasReadAccess = permission.hasReadAccess(organization);

    var view = new PermissionView({
      model: organization,
      permission: permission,
      avatar: organization.get('avatar_url'),
      description: _t('components.modals.publish.share.organization.desc'),
      name: _t('components.modals.publish.share.organization.title'),
      canChangeReadAccess: canChangeReadAccess,
      hasReadAccess: hasReadAccess,
      hasWriteAccessAvailable: hasWriteAccessAvailable,
      canChangeWriteAccess: canChangeWriteAccess,
      hasWriteAccess: hasWriteAccess,
      isSelected: hasReadAccess || hasWriteAccess
    });

    this.$el.append(view.render().$el);
    this.addView(view);
  },

  _renderItem: function (model) {
    var self = this;
    var view;
    var o = model.get('model');
    var permission = this._sharePermissionModel;
    var hasWriteAccessAvailable = !self._isVisualization;
    var canChangeWriteAccess = permission.canChangeWriteAccess(model);
    var hasWriteAccess = permission.hasWriteAccess(model);
    var canChangeReadAccess = permission.canChangeReadAccess(model);
    var hasReadAccess = permission.hasReadAccess(model);
    var role = this._getRole(o);

    if (model.id !== this._currentUserId) {
      view = new PermissionView({
        model: model,
        permission: permission,
        name: model.get('name'),
        avatar: model.get('avatar_url'),
        role: role,
        users: o.users,
        canChangeReadAccess: canChangeReadAccess,
        hasReadAccess: hasReadAccess,
        hasWriteAccessAvailable: hasWriteAccessAvailable,
        canChangeWriteAccess: canChangeWriteAccess,
        hasWriteAccess: hasWriteAccess,
        isSelected: hasReadAccess || hasWriteAccess
      });

      this.$el.append(view.render().$el);
      this.addView(view);
    }
  },

  _getRole: function (d) {
    if (d.viewer !== undefined) {
      return d.viewer === true ? _t('components.modals.publish.share.role.viewer')
                               : _t('components.modals.publish.share.role.builder');
    }

    return false;
  }
});

},{"./share-permission-view":442,"backbone/core-view":1127,"underscore":"underscore"}],442:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./share-permission.tpl');
var TipsyTooltipView = require('../../../tipsy-tooltip-view.js');
var $ = require('jquery');
var UsersGroup = require('./users-group-view');

var REQUIRED_OPTS = [
  'model',
  'permission',
  'name',
  'canChangeReadAccess',
  'hasReadAccess',
  'hasWriteAccessAvailable',
  'canChangeWriteAccess',
  'hasWriteAccess',
  'isSelected'
];

var OPTIONALS_OPT = [
  'description',
  'role',
  'avatar',
  'users'
];

module.exports = CoreView.extend({
  className: 'Share-permission',

  events: {
    'change .js-read': '_onChangeRead',
    'change .js-write': '_onChangeWrite',
    'mouseover .js-toggler.is-disabled': '_onHoverDisabledToggler',
    'mouseout .js-toggler': '_destroyTooltip',
    'mouseleave .js-toggler': '_destroyTooltip'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    _.each(OPTIONALS_OPT, function (item) {
      this['_' + item] = opts[item];
    }, this);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template({
      name: this._name,
      avatar: this._avatar,
      role: this._role,
      users: this._users,
      description: this._description,
      canChangeReadAccess: this._canChangeReadAccess,
      hasReadAccess: this._hasReadAccess,
      hasWriteAccessAvailable: this._hasWriteAccessAvailable,
      canChangeWriteAccess: this._canChangeWriteAccess,
      hasWriteAccess: this._hasWriteAccess
    }));

    if (this._users) {
      this._renderUsers();
    }

    this.$el.toggleClass('is-selected', this._isSelected);
    return this;
  },

  _renderUsers: function () {
    var view = new UsersGroup({
      className: 'u-flex u-alignCenter',
      users: this._users
    });

    this.$('.js-users').append(view.render().el);
    this.addView(view);
  },

  _onChangeWrite: function () {
    var p = this._permission;
    if (p.canChangeWriteAccess(this._model)) {
      if (p.hasWriteAccess(this._model)) {
        p.revokeWriteAccess(this._model);
      } else {
        p.grantWriteAccess(this._model);
      }
    }
  },

  _onChangeRead: function () {
    var p = this._permission;
    if (p.canChangeReadAccess(this._model)) {
      if (p.hasReadAccess(this._model)) {
        p.revokeAccess(this._model);
      } else {
        p.grantReadAccess(this._model);
      }
    }
  },

  _onHoverDisabledToggler: function (e) {
    var aclItem = this._permission.findRepresentableAclItem(this._model);
    var msg;
    var $el;

    if (aclItem && !aclItem.isOwn(this._model)) {
      msg = this._inheritedAccessTooltipText(aclItem);
      $el = $(e.currentTarget);

      this._tooltip = this._createTooltip({
        $el: $el,
        msg: msg
      });
      this._tooltip.showTipsy();
    }
  },

  _createTooltip: function (opts) {
    return new TipsyTooltipView({
      el: opts.$el,
      title: function () {
        return opts.msg;
      }
    });
  },

  _destroyTooltip: function () {
    if (this._tooltip) {
      this._tooltip.hideTipsy();
      this._tooltip.destroyTipsy();
    }
  },

  _inheritedAccessTooltipText: function (aclItem) {
    var type = aclItem.get('type');

    switch (type) {
      case 'group':
        return _t('components.modals.publish.share.tooltip.group', {
          name: aclItem.get('entity').get('name')
        });
      case 'org':
        return _t('components.modals.publish.share.tooltip.org');
      default:
        console.error('Trying to display inherited access for an unrecognized type ' + type);
        return '';
    }
  }

});

},{"../../../tipsy-tooltip-view.js":589,"./share-permission.tpl":443,"./users-group-view":448,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],443:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Share-permissionInfo">\n  <div class="Share-permissionIcon">\n    ';
 if (avatar) { 
__p+='\n      <div class="Share-user Share-user--huge" style="background-image: url('+
((__t=( avatar ))==null?'':_.escape(__t))+
')"></div>\n    ';
 } else { 
__p+='\n        <i class="CDB-IconFont CDB-IconFont-people"></i>\n    ';
 } 
__p+='\n  </div>\n  <div>\n    <div class="CDB-Text u-mainTextColor CDB-Size-medium is-semibold u-ellipsis">\n      '+
((__t=( name ))==null?'':_.escape(__t))+
'\n    </div>\n\n\n    <div class="CDB-Text u-mainTextColor u-tSpace CDB-Size-medium u-ellipsis">\n      ';
 if (role) { 
__p+='\n        <i class="Tag Tag--outline Tag--'+
((__t=( role ))==null?'':_.escape(__t))+
' CDB-Text CDB-Size-small u-upperCase">'+
((__t=( role ))==null?'':_.escape(__t))+
'</i>\n      ';
 } 
__p+='\n\n      ';
 if (users) { 
__p+='\n        <div class="js-users"></div>\n      ';
 } 
__p+='\n    </div>\n\n\n    ';
 if (description) { 
__p+='\n    <div class="CDB-Text u-mainTextColor u-tSpace CDB-Size-medium u-ellipsis">\n      '+
((__t=( description ))==null?'':_.escape(__t))+
'\n    </div>\n    ';
 } 
__p+='\n  </div>\n</div>\n<div class="Share-togglers">\n  ';
 if (hasWriteAccessAvailable) { 
__p+='\n    <div class="CDB-Text CDB-Size-medium u-rSpace--xl Share-toggler js-toggler ';
 if (!canChangeWriteAccess) { 
__p+='is-disabled';
 } 
__p+='">\n      <input class="CDB-Toggle u-iBlock js-write" type="checkbox"\n        ';
 if (!canChangeWriteAccess) { 
__p+='disabled="disabled"';
 } 
__p+='\n        ';
 if (hasWriteAccess) { 
__p+=' checked ';
 } 
__p+='\n      />\n      <span class="u-iBlock CDB-ToggleFace"></span>\n      <label class="u-iBlock u-altTextColor ">'+
((__t=( _t('components.modals.publish.share.toggle.write') ))==null?'':_.escape(__t))+
'</label>\n    </div>\n  ';
 } 
__p+='\n  <div class="CDB-Text CDB-Size-medium Share-toggler js-toggler ';
 if (!canChangeReadAccess) { 
__p+='is-disabled';
 } 
__p+='">\n    <input class="CDB-Toggle u-iBlock js-read" type="checkbox"\n      ';
 if (hasReadAccess) { 
__p+=' checked ';
 } 
__p+='\n      ';
 if (!canChangeReadAccess) { 
__p+='disabled="disabled"';
 } 
__p+='\n    />\n    <span class="u-iBlock CDB-ToggleFace"></span>\n    <label class="u-iBlock u-altTextColor ">'+
((__t=( _t('components.modals.publish.share.toggle.read') ))==null?'':_.escape(__t))+
'</label>\n  </div>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],444:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./share.tpl');
var GrantableCollection = require('../../../../data/grantables-collection');
var SearchPaginationView = require('../../../../components/pagination-search/pagination-search-view');
var ListView = require('./share-list-view');

var REQUIRED_OPTS = [
  'configModel',
  'currentUserId',
  'organization',
  'visDefinitionModel'
];

module.exports = CoreView.extend({
  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this._grantablesCollection = new GrantableCollection([], {
      currentUserId: this._currentUserId,
      organization: this._organization,
      configModel: this._configModel
    });

    this._sharePermissionModel = this._visDefinitionModel.getPermissionModel().clone();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template({
      name: this._visDefinitionModel.get('name')
    }));
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this._sharePermissionModel.acl.on('add remove reset change', this._onSave, this);
    this.add_related_model(this._sharePermissionModel.acl);
  },

  _initViews: function () {
    var self = this;

    this._searchPaginationView = new SearchPaginationView({
      className: 'u-inner',
      listCollection: this._grantablesCollection,
      createContentView: function (opts) {
        return new ListView(_.extend({}, opts, {
          collection: self._grantablesCollection,
          currentUserId: self._currentUserId,
          sharePermissionModel: self._sharePermissionModel,
          organization: self._organization,
          isVisualization: self._visDefinitionModel.isVisualization()
        }));
      }
    });
    this.addView(this._searchPaginationView);
    this.$('.js-body').html(this._searchPaginationView.render().el);
  },

  _onCancel: function () {
    this._modalModel.destroy();
  },

  _onBack: function () {
    this._modalModel.destroy();
    this._onBack();
  },

  _onSave: function () {
    var permission = this._visDefinitionModel.getPermissionModel();
    permission.overwriteAcl(this._sharePermissionModel);
    // Show loading here
    permission.save()
      .fail(this._searchPaginationView.showError.bind(this._searchPaginationView));
  }
});

},{"../../../../components/pagination-search/pagination-search-view":516,"../../../../data/grantables-collection":628,"./share-list-view":441,"./share.tpl":445,"backbone/core-view":1127,"underscore":"underscore"}],445:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-body">\n\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],446:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./user.tpl');
var TipsyTooltipView = require('../../../tipsy-tooltip-view');

var REQUIRED_OPTS = [
  'username',
  'avatar'
];

module.exports = CoreView.extend({

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template({
      avatar: this._avatar,
      username: this._username
    }));

    this._initViews();
    return this;
  },

  _initViews: function () {
    var tooltip = new TipsyTooltipView({
      el: this.$('.js-avatar'),
      title: function () {
        return $(this).attr('data-title');
      }
    });

    this.addView(tooltip);
  }
});

},{"../../../tipsy-tooltip-view":589,"./user.tpl":447,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],447:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Share-user u-rSpace js-avatar" style="background-image: url('+
((__t=( avatar ))==null?'':_.escape(__t))+
')" data-title="'+
((__t=( username ))==null?'':_.escape(__t))+
'"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],448:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var template = require('./users-group.tpl');
var UserView = require('./user-view');

var REQUIRED_OPTS = [
  'users'
];

var MAX_USERS_TO_SHOW = 3;

module.exports = CoreView.extend({
  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template({
      people: this._getRemainsPeople()
    }));
    this._renderUsers();
    return this;
  },

  _getRemainsPeople: function () {
    return Math.max(0, this._users.length - MAX_USERS_TO_SHOW);
  },

  _renderUsers: function () {
    _.each(this._users.slice(0, MAX_USERS_TO_SHOW), this._renderUser, this);
  },

  _renderUser: function (user) {
    var view = new UserView({
      username: user.username,
      avatar: user.avatar_url
    });

    this.$('.js-content').append(view.render().el);
    this.addView(view);
  }
});

},{"./user-view":446,"./users-group.tpl":449,"backbone/core-view":1127,"underscore":"underscore"}],449:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex js-content"></div>\n';
 if (people > 0) { 
__p+='\n  <div class="u-secondaryTextColor CDB-Text CDB-Size-small u-lSpace">+ '+
((__t=( people ))==null?'':_.escape(__t))+
'</div>\n';
 } 
__p+='';
}
return __p;
};

},{"underscore":"underscore"}],450:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Publish-modalMenu u-tSpace-xl">\n  <nav class="CDB-NavMenu u-inner">\n    <ul class="CDB-Size-medium CDB-Text is-semibold js-menu"></ul>\n  </nav>\n</div>\n\n<div class="Tab-paneContent Publish-modalContent js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],451:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./upgrade.tpl');

var CONTACT_LINK_TEMPLATE = _.template("<a href='mailto:<%- mail %>'><%- contact %></a>")({
  contact: _t('components.modals.publish.privacy.upgrade.contact'),
  mail: _t('components.modals.publish.privacy.upgrade.mail')
});

module.exports = CoreView.extend({
  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initViews: function () {
    var html = template({
      title: _t('components.modals.publish.privacy.upgrade.title'),
      desc: _t('components.modals.publish.privacy.upgrade.desc', {
        contact: CONTACT_LINK_TEMPLATE
      })
    });
    this.$el.html(html);
  }
});

},{"./upgrade.tpl":452,"backbone/core-view":1127,"underscore":"underscore"}],452:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-alignCenter">\n  <div class="Upgrade-icon u-rSpace--xl">\n    <svg width="16px" height="16px" viewBox="578 456 16 16">\n      <g id="present" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(578.000000, 456.000000)">\n        <path d="M10.0946667,4.4109223 C10.8886667,4.1368747 11.6846667,3.80147316 12.0073333,3.4715253 C12.7866667,2.67392407 12.7866667,1.37662907 12.0073333,0.579027844 C11.2513333,-0.193350099 9.934,-0.192668389 9.17866667,0.579027844 C8.74133333,1.0262299 8.29266667,2.36033726 8,3.37608583 C7.70666667,2.36033726 7.25866667,1.0262299 6.82133333,0.579027844 C6.066,-0.193350099 4.748,-0.192668389 3.99266667,0.579027844 C3.21266667,1.37662907 3.21266667,2.67392407 3.99266667,3.4715253 C4.316,3.80147316 5.11133333,4.1368747 5.90533333,4.4109223 L0.333333333,4.4109223 C0.149333333,4.4109223 0,4.56362544 0,4.75177753 L0,7.47861934 C0,7.66677142 0.149333333,7.81947456 0.333333333,7.81947456 L0.666666667,7.81947456 L0.666666667,15.6591448 C0.666666667,15.8472969 0.816,16 1,16 L15,16 C15.184,16 15.3333333,15.8472969 15.3333333,15.6591448 L15.3333333,7.81947456 L15.6666667,7.81947456 C15.8506667,7.81947456 16,7.66677142 16,7.47861934 L16,4.75177753 C16,4.56362544 15.8506667,4.4109223 15.6666667,4.4109223 L10.0946667,4.4109223 Z M6,6.95652174 L6,4.86956522 L10,4.86956522 L10,6.95652174 L6,6.95652174 L6,6.95652174 Z M10,7.65217391 L10,15.3043478 L6,15.3043478 L6,7.65217391 L10,7.65217391 L10,7.65217391 Z M9.80833133,1.08822938 C10.0510474,0.834996985 10.3727426,0.695652174 10.7169115,0.695652174 C11.0597961,0.695652174 11.3821334,0.834996985 11.6248495,1.08755946 C12.1250502,1.6101025 12.1250502,2.46023983 11.6248495,2.98278288 C11.2729754,3.34990286 9.79227867,3.85636766 8.66666667,4.17391304 C8.97102496,2.99953105 9.45581507,1.45534937 9.80833133,1.08822938 L9.80833133,1.08822938 Z M4.37515049,1.08822938 C4.6178666,0.834996985 4.94020387,0.695652174 5.28373064,0.695652174 C5.6266153,0.695652174 5.94895256,0.834996985 6.19166867,1.08755946 C6.54354282,1.45467944 7.02833293,2.99886112 7.33333333,4.17391304 C6.20707922,3.85569773 4.72638253,3.34990286 4.37515049,2.98278288 C3.87494984,2.46090976 3.87494984,1.61077243 4.37515049,1.08822938 L4.37515049,1.08822938 Z M0.666666667,4.86956522 L5.33333333,4.86956522 L5.33333333,6.95652174 L1,6.95652174 L0.666666667,6.95652174 L0.666666667,4.86956522 L0.666666667,4.86956522 Z M1.33333333,7.65217391 L5.33333333,7.65217391 L5.33333333,15.3043478 L1.33333333,15.3043478 L1.33333333,7.65217391 L1.33333333,7.65217391 Z M14.6666667,15.3043478 L10.6666667,15.3043478 L10.6666667,7.65217391 L14.6666667,7.65217391 L14.6666667,15.3043478 L14.6666667,15.3043478 Z M15.3333333,6.95652174 L15,6.95652174 L10.6666667,6.95652174 L10.6666667,4.86956522 L15.3333333,4.86956522 L15.3333333,6.95652174 L15.3333333,6.95652174 Z" id="Shape" fill="#9BC63B"></path>\n      </g>\n    </svg>\n  </div>\n  <div class="Upgrade-body">\n    <h2 class="CDB-Text CDB-Size-large">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h2>\n    <p class="CDB-Text CDB-Size-medium u-altTextColor ">'+
((__t=( desc ))==null?'':__t)+
'</p>\n  </div>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],453:[function(require,module,exports){
var _ = require('underscore');
var ConfirmationView = require('../confirmation/modal-confirmation-view');
var ExportView = require('../../../editor/components/modals/export-map/modal-export-map-view.js');
var ExportMapModel = require('../../../data/export-map-definition-model.js');
var templateConfirmation = require('../../../editor/layers/delete-layer-confirmation.tpl');
var removeLayer = require('../../../editor/layers/operations/remove-layer');
var REQUIRED_OPTS = [
  'modalModel',
  'layerModel',
  'modals',
  'widgetDefinitionsCollection',
  'visDefinitionModel',
  'userActions'
];
/**
 *  Remove layer modal dialog
 */

module.exports = ConfirmationView.extend({
  className: 'Dialog-content',

  events: function () {
    return _.extend({}, ConfirmationView.prototype.events, {
      'click [data-event=exportMapAction]': '_exportMap'
    });
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    if (opts.loadingTitle) {
      this._hasLoading = true;
      this._loadingTitle = opts.loadingTitle;
    }
  },

  render: function () {
    this.clearSubViews();

    this.$el.html(
      templateConfirmation({
        layerName: this._layerModel.getTableName(),
        layerVisName: this._visDefinitionModel.get('name'),
        affectedItemsMessages: this._getAffectedItemsMessages()
      })
    );
    return this;
  },

  _getAffectedItemsByLayer: function () {
    var layerModel = this._layerModel;
    var widgetDefinitionsCollection = this._widgetDefinitionsCollection;

    return [
      { widgets: widgetDefinitionsCollection.widgetsOwnedByLayer(layerModel.get('id')) },
      { analyses: layerModel.getNumberOfAnalyses() },
      { layers: layerModel.getAllDependentLayers() }
    ];
  },

  _getAffectedItemsMessages: function () {
    var affectedItems = this._getAffectedItemsByLayer();
    var affectedTemplateMessages = [];

    for (var i = 0; i < affectedItems.length; i++) {
      for (var key in affectedItems[i]) {
        if (affectedItems[i][key] > 0) {
          var text = _t('editor.layers.delete.' + key, { smart_count: affectedItems[i][key] });
          affectedTemplateMessages.push(text);
        }
      }
    }
    return affectedTemplateMessages;
  },

  _exportMap: function () {
    var self = this;

    this._modals.create(function () {
      var exportMapModel = new ExportMapModel({
        visualization_id: self._visDefinitionModel.get('id')
      }, {
        configModel: this.configModel
      });

      return new ExportView({
        modalModel: self._modalModel,
        exportMapModel: exportMapModel,
        renderOpts: {
          name: self._visDefinitionModel.get('name')
        }
      });
    });
  },

  _runAction: function () {
    removeLayer({
      userActions: this._userActions,
      layerDefinitionModel: this._layerModel
    });

    this._modalModel.destroy();
  }
});

},{"../../../data/export-map-definition-model.js":625,"../../../editor/components/modals/export-map/modal-export-map-view.js":693,"../../../editor/layers/delete-layer-confirmation.tpl":769,"../../../editor/layers/operations/remove-layer":994,"../confirmation/modal-confirmation-view":404,"underscore":"underscore"}],454:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./sync-options-modal.tpl');
var renderLoading = require('../../loading/render-loading');
var ErrorView = require('../../error/error-view');
var errorParser = require('../../../helpers/error-parser');

module.exports = CoreView.extend({
  className: 'Dialog-content',

  events: {
    'click .js-confirm': '_onConfirm',
    'click .js-cancel': '_onCancel'
  },

  initialize: function (opts) {
    if (!opts.modalModel) throw new Error('modalModel is required');
    if (!opts.syncModel) throw new Error('syncModel is required');
    if (!opts.tableName) throw new Error('tableName is required');

    this._syncModel = opts.syncModel;
    this._modalModel = opts.modalModel;
    this._tableName = opts.tableName;
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(
      template({
        interval: this._syncModel.get('interval'),
        service: this._syncModel.get('service_name') || '',
        isExternalSource: this._syncModel.get('from_external_source'),
        url: this._getServiceURL()
      })
    );
  },

  _renderErrorView: function (errorMessage) {
    var errorView = new ErrorView({
      title: _t('dataset.sync.error'),
      desc: errorMessage
    });
    this.$el.html(errorView.render().el);
    this.addView(errorView);
  },

  _renderLoadingView: function () {
    this.$el.html(
      renderLoading({
        title: _t('dataset.sync.loading', { tableName: this._tableName })
      })
    );
  },

  _getServiceURL: function () {
    if (this._syncModel.get('service_name') || this._syncModel.get('service_item_id')) {
      return this._syncModel.get('service_item_id');
    }
    return this._syncModel.get('url');
  },

  _onConfirm: function () {
    var interval = parseInt(this.$('[name="interval"]:checked').val(), 10);
    var opts = {
      wait: true,
      success: function () {
        this._modalModel.destroy();
      }.bind(this),
      error: function (mdl, e) {
        this._renderErrorView(errorParser(e));
      }.bind(this)
    };

    this._renderLoadingView();

    if (this._syncModel.get('interval') !== interval) {
      if (!interval) {
        this._syncModel.destroy(opts);
      } else {
        this._syncModel.save({
          interval: interval
        }, opts);
      }
    } else {
      this._modalModel.destroy();
    }
  },

  _onCancel: function () {
    this._modalModel.destroy();
  }

});

},{"../../../helpers/error-parser":1090,"../../error/error-view":67,"../../loading/render-loading":230,"./sync-options-modal.tpl":455,"backbone/core-view":1127}],455:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--full u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="24px" height="20px" viewBox="0 8 24 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n          <g id="Icon" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(0.000000, 8.000000)">\n              <path d="M19.591513,9.26858726 C19.7142261,9.39218837 19.8745043,9.45462604 20.0347826,9.45462604 C20.1950609,9.45462604 20.3553391,9.39218837 20.4780522,9.26858726 C20.7222261,9.0201108 20.7222261,8.61617729 20.4780522,8.36770083 C20.1988174,8.08354571 19.908313,7.81468144 19.6065391,7.56365651 C19.5652174,7.52925208 19.5201391,7.4999446 19.4775652,7.46554017 C17.3914435,5.76952909 14.824487,4.84060942 12.1147826,4.84060942 L12.1122783,4.84060942 L12.1097739,4.84060942 C8.95053913,4.84060942 5.98038261,6.0931856 3.74775652,8.36770083 C3.50358261,8.61617729 3.50358261,9.0201108 3.74775652,9.26858726 C3.87046957,9.3934626 4.03074783,9.45462604 4.19102609,9.45462604 C4.35130435,9.45462604 4.51158261,9.39218837 4.63304348,9.26858726 C6.63151304,7.23490305 9.28737391,6.11484765 12.1122783,6.11484765 C14.9371826,6.11484765 17.5930435,7.23490305 19.591513,9.26858726 L19.591513,9.26858726 Z" id="Shape" fill="#2E3C43"></path>\n              <path d="M22.7607652,5.95695291 C22.8834783,6.08182825 23.0437565,6.14299169 23.2040348,6.14299169 C23.364313,6.14299169 23.5245913,6.08055402 23.6473043,5.95695291 C23.8914783,5.70847645 23.8914783,5.30454294 23.6473043,5.05606648 C17.2862609,-1.41706371 6.93704348,-1.41451524 0.578504348,5.05606648 C0.334330435,5.30454294 0.334330435,5.70847645 0.578504348,5.95695291 C0.822678261,6.20542936 1.21961739,6.20542936 1.4637913,5.95695291 C7.33398261,-0.0179501385 16.8905739,-0.0166759003 22.7607652,5.95695291 L22.7607652,5.95695291 Z" id="Shape" fill="#2E3C43"></path>\n              <path d="M9.58789565,9.966759 C8.61495652,10.3273684 7.69586087,10.8854848 6.91575652,11.6793352 C6.67158261,11.9278116 6.67158261,12.3317452 6.91575652,12.5802216 C7.03846957,12.705097 7.19874783,12.7662604 7.35902609,12.7662604 C7.51930435,12.7662604 7.67958261,12.7038227 7.80229565,12.5802216 C10.1789217,10.1642659 14.046887,10.1642659 16.4247652,12.5802216 C16.5474783,12.705097 16.7077565,12.7662604 16.8680348,12.7662604 C17.028313,12.7662604 17.1885913,12.7038227 17.3113043,12.5802216 C17.5554783,12.3317452 17.5554783,11.9278116 17.3113043,11.6793352 C15.2239304,9.55645429 12.1924174,8.99961219 9.58789565,9.966759 L9.58789565,9.966759 Z" id="Shape" fill="#2E3C43"></path>\n              <path d="M12.1122783,14.1359557 C10.5307826,14.1359557 9.2448,15.4445983 9.2448,17.052687 C9.2448,18.6620499 10.5307826,19.9706925 12.1122783,19.9706925 C13.6925217,19.9706925 14.9785043,18.6620499 14.9785043,17.052687 C14.9785043,15.4458726 13.6925217,14.1359557 12.1122783,14.1359557 L12.1122783,14.1359557 Z M12.1122783,18.6977285 C11.2219826,18.6977285 10.4969739,17.9599446 10.4969739,17.0539612 C10.4969739,16.1479778 11.2219826,15.4114681 12.1122783,15.4114681 C13.0025739,15.4114681 13.7263304,16.1479778 13.7263304,17.0539612 C13.7263304,17.9599446 13.0025739,18.6977285 12.1122783,18.6977285 L12.1122783,18.6977285 Z" id="Shape" fill="#2E3C43"></path>\n          </g>\n      </svg>\n    </div>\n    <div>\n      <h2 class="CDB-Text CDB-Size-huge is-light u-bSpace--m">\n        '+
((__t=( _t('dataset.sync.title') ))==null?'':_.escape(__t))+
'\n     </h2>\n      <p class="CDB-Text CDB-Size-medium u-altTextColor">\n        '+
((__t=( _t('dataset.sync.desc', {
          service: service,
          url: url
        }) ))==null?'':__t)+
'\n      </p>\n      <div class="Modal-listTextItem u-flex u-alignCenter">\n        <h3 class="CDB-Text CDB-Size-small is-semibold u-upperCase">'+
((__t=( _t('dataset.sync.label') ))==null?'':_.escape(__t))+
'</h3>\n        <ul class="Modal-listForm u-flex u-alignCenter CDB-Text CDB-Size-small js-intervals">\n          <li class="Modal-listFormItem">\n            <input class="CDB-Radio" type="radio" name="interval" value="3600"\n              ';
 if (interval === 3600) { 
__p+='\n                checked\n              ';
 } 
__p+='\n\n              ';
 if (isExternalSource) { 
__p+='\n                disabled\n              ';
 } 
__p+='\n            >\n            <span class="u-iBlock CDB-Radio-face"></span>\n            <label class="u-iBlock u-lSpace u-upperCase">Every hour</label>\n          </li>\n          <li class="Modal-listFormItem">\n            <input class="CDB-Radio" type="radio" name="interval" value="86400"\n              ';
 if (interval === 86400) { 
__p+='\n                checked\n              ';
 } 
__p+='\n\n              ';
 if (isExternalSource) { 
__p+='\n                disabled\n              ';
 } 
__p+='\n            >\n            <span class="u-iBlock CDB-Radio-face"></span>\n            <label class="u-iBlock u-lSpace u-upperCase">Every day</label>\n          </li>\n          <li class="Modal-listFormItem">\n            <input class="CDB-Radio" type="radio" name="interval" value="604800"\n              ';
 if (interval === 604800) { 
__p+='\n                checked\n              ';
 } 
__p+='\n\n              ';
 if (isExternalSource) { 
__p+='\n                disabled\n              ';
 } 
__p+='\n            >\n            <span class="u-iBlock CDB-Radio-face"></span>\n            <label class="u-iBlock u-lSpace u-upperCase">Every week</label>\n          </li>\n          <li class="Modal-listFormItem">\n            <input class="CDB-Radio" type="radio" name="interval" value="2592000"\n              ';
 if (interval === 2592000) { 
__p+='\n                checked\n              ';
 } 
__p+='\n            >\n            <span class="u-iBlock CDB-Radio-face"></span>\n            <label class="u-iBlock u-lSpace u-upperCase">Every month</label>\n          </li>\n          <li class="Modal-listFormItem">\n            <input class="CDB-Radio" type="radio" name="interval" value="0"\n              ';
 if (interval === 0) { 
__p+='\n                checked\n              ';
 } 
__p+='\n            >\n            <span class="u-iBlock CDB-Radio-face"></span>\n            <label class="u-iBlock u-lSpace u-upperCase">Never</label>\n          </li>\n        </ul>\n      </div>\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('dataset.sync.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('dataset.sync.confirm') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n\n\n';
}
return __p;
};

},{"underscore":"underscore"}],456:[function(require,module,exports){
module.exports = ' | CARTO';

},{}],457:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var MosaicView = require('./mosaic/mosaic-view');

/**
 *  Mosaic form view
 */

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.collection) throw new Error('Mosaic collection is required');
    if (!opts.template) throw new Error('template is required');

    this.template = opts.template;
    this._disabled = opts.disabled;

    this._initBinds();
  },

  render: function () {
    var selectedItem = this.collection.getSelected();
    var selectedName = selectedItem && selectedItem.getName();
    this.$el.html(
      this.template({
        name: selectedName
      })
    );
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this.collection.bind('change:highlighted', this._onChangeHighlighted, this);
  },

  _initViews: function () {
    var mosaic = new MosaicView({
      collection: this.collection,
      disabled: this._disabled
    });

    if (!this.$('.js-selector').length) throw new Error('HTML element with js-selector class is required');

    this.$('.js-selector').append(mosaic.render().el);
    this.addView(mosaic);
  },

  _onChangeHighlighted: function () {
    var item = this.collection.getHighlighted() || this.collection.getSelected();
    if (item) {
      var $el = this.$('.js-highlight');
      if ($el) {
        $el.text(item.getName());
      }
    }
  }

});

},{"./mosaic/mosaic-view":463,"backbone/core-view":1127}],458:[function(require,module,exports){
var Backbone = require('backbone');
var MosaicModel = require('./mosaic-item-model');

/*
 *  List collection, it parses pairs like:
 *
 *  [{ val, label }]
 *  ["string"]
 */

module.exports = Backbone.Collection.extend({

  model: function (attrs, opts) {
    var d = {};
    if (typeof attrs === 'string') {
      d.val = attrs;
    } else {
      d = attrs;
    }
    return new MosaicModel(d);
  },

  initialize: function () {
    this._initBinds();
  },

  _initBinds: function () {
    this.bind('change:selected', this._onSelectedChange, this);
  },

  _onSelectedChange: function (changedModel, isSelected) {
    if (isSelected) {
      this.each(function (m) {
        if (m.cid !== changedModel.cid && m.get('selected')) {
          m.set('selected', false);
        }
      });
    }
  },

  getSelected: function () {
    return this.findWhere({ selected: true });
  },

  getHighlighted: function () {
    return this.findWhere({ highlighted: true });
  }

});

},{"./mosaic-item-model":459,"backbone":"backbone"}],459:[function(require,module,exports){
var Backbone = require('backbone');

/*
 *  List item model
 *
 */

module.exports = Backbone.Model.extend({

  defaults: {
    disabled: false,
    selected: false,
    label: '',
    template: function () {
      return '';
    }
  },

  getName: function () {
    return this.get('label') || this.getValue();
  },

  getValue: function () {
    return this.get('val');
  }

});

},{"backbone":"backbone"}],460:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./mosaic-item.tpl');

module.exports = CoreView.extend({

  className: 'Mosaic-item',

  tagName: 'li',

  events: {
    'mouseenter': '_onMouseEnter',
    'mouseleave': '_onMouseLeave',
    'click': '_onClick'
  },

  initialize: function (opts) {
    this._disabled = opts.disabled;

    this._initBinds();
  },

  render: function () {
    this.$el.html(
      template({
        name: this.model.getName(),
        template: this.model.get('template')()
      })
    );
    this.$el.addClass('js-' + this.model.getValue());
    this.$el.toggleClass('is-selected', !!this.model.get('selected'));
    return this;
  },

  _initBinds: function () {
    this.model.bind('change:selected', this.render, this);
  },

  _onMouseEnter: function () {
    this.model.set('highlighted', true);
  },

  _onMouseLeave: function () {
    this.model.set('highlighted', false);
  },

  _onClick: function () {
    if (this._disabled) {
      return false;
    }

    this.model.set('selected', true);
  }

});

},{"./mosaic-item.tpl":461,"backbone/core-view":1127}],461:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button class="Mosaic-inner">\n  '+
((__t=( template ))==null?'':__t)+
'\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],462:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<img src="'+
((__t=( imgURL ))==null?'':__t)+
'" class="Mosaic-image js-thumbnailImg" />\n';
}
return __p;
};

},{"underscore":"underscore"}],463:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./mosaic.tpl');
var MosaicCollection = require('./mosaic-collection');
var MosaicItemView = require('./mosaic-item-view');

/*
 *  A mosaic selector
 *
 *  It accepts a collection of (val, label) model attributes or a values array
 *  with the same content or only strings.
 *
 *  new Mosaic({
 *    options: [
 *      {
 *        val: 'hello',
 *        label: 'hi'
 *      }
 *    ]
 *  });
 */

module.exports = CoreView.extend({

  className: 'Mosaic',

  tagName: 'div',

  initialize: function (opts) {
    if (!opts.collection) {
      if (!opts.options) throw new Error('options array {value, label} is required');

      this.collection = new MosaicCollection(opts.options);
    }

    this._disabled = opts.disabled;
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());
    this._renderList();
    return this;
  },

  _renderList: function () {
    this.collection.each(function (mdl) {
      this._createItem(mdl);
    }, this);
  },

  _createItem: function (mdl) {
    var view = new MosaicItemView({
      model: mdl,
      disabled: this._disabled
    });
    this.$('.js-mosaic').append(view.render().el);
    this.addView(view);
  }

});

},{"./mosaic-collection":458,"./mosaic-item-view":460,"./mosaic.tpl":464,"backbone/core-view":1127}],464:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="Mosaic-list js-mosaic"></ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],465:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="IntermediateInfo">\n  <div class="LayoutIcon">\n    <i class="CDB-IconFont '+
((__t=( icon ))==null?'':_.escape(__t))+
'"></i>\n  </div>\n  <h4 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m u-tSpace-xl">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h4>\n  <p class="CDB-Text CDB-Size-medium u-altTextColor">\n    '+
((__t=( desc ))==null?'':_.escape(__t))+
'\n  </p>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],466:[function(require,module,exports){
var template = require('./no-results.tpl');

/**
 * @param {Object} opts
 * @param {String=} opts.icon
 * @param {String=} opts.title
 * @param {String=} opts.desc
 */

module.exports = function (opts) {
  return template({
    icon: opts.icon || 'CDB-IconFont-cockroach',
    title: opts.title || '',
    desc: opts.desc
  });
};

},{"./no-results.tpl":465}],467:[function(require,module,exports){
var CoreView = require('backbone/core-view');

module.exports = CoreView.extend({
  tagName: 'button',

  initialize: function (opts) {
    if (!opts.template) throw new Error('template is required');
    if (!opts.editorModel) throw new Error('editorModel is required');
    this.template = opts.template;
    this._editorModel = opts.editorModel;
    this._data = {};
    if (opts.model) {
      this._data = opts.model.toJSON();
    }
    this._initBinds();
  },

  _initBinds: function () {
    this.listenTo(this._editorModel, 'change:edition', this._changeStyle);
    this.add_related_model(this._editorModel);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this.$el.append(this.template(this._data));
    return this;
  },

  _changeStyle: function () {
    this.$('.js-theme').toggleClass('is-white', this._editorModel.isEditing());
  }
});

},{"backbone/core-view":1127}],468:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<span data-action="'+
((__t=( button ))==null?'':_.escape(__t))+
'" class="CDB-Text is-semibold u-lSpace u-actionTextColor u-upperCase">'+
((__t=( button ))==null?'':_.escape(__t))+
'</span>';
}
return __p;
};

},{"underscore":"underscore"}],469:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Shape-close is-blue is-large js-theme"></div>';
}
return __p;
};

},{"underscore":"underscore"}],470:[function(require,module,exports){
var Backbone = require('backbone');
var NotifierModel = require('./notifier-model');

module.exports = Backbone.Collection.extend({
  model: function (attrs, opts) {
    return new NotifierModel(attrs, opts);
  },

  findById: function (id) {
    return this.findWhere({id: id});
  }
});

},{"./notifier-model":473,"backbone":"backbone"}],471:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var Template = require('./notifier-item.tpl');
var ActionView = require('./notifier-action-view');
var closeTemplate = require('./notifier-close.tpl');
var actionTemplate = require('./notifier-action.tpl');

module.exports = CoreView.extend({
  className: 'Notifier-inner',
  tagName: 'li',
  events: {
    'click .js-close': '_closeHandler',
    'click .js-action': '_actionHandler'
  },

  initialize: function (opts) {
    if (!opts.notifierModel) throw new Error('notifierModel is required');
    if (!opts.editorModel) throw new Error('editorModel is required');

    this._editorModel = opts.editorModel;
    this.template = this.options.template || Template;
    this._notifierModel = opts.notifierModel;
    this.$el.attr('id', this._notifierModel.get('id'));

    this._delay = this._notifierModel.get('delay') || this._notifierModel.get('defaultDelay');

    if (this._notifierModel.get('delay') && this._notifierModel.get('closable') !== false) {
      this._timeout = setTimeout(this._autoClose.bind(this), this._delay);
    }

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    this._changeStyle();
    return this;
  },

  _initBinds: function () {
    this.listenTo(this._notifierModel, 'change', this.render);
    this.listenTo(this._notifierModel, 'change:status', this._onChangeStatus);
    this.add_related_model(this._notifierModel);

    this.listenTo(this._editorModel, 'change:edition', this._changeStyle);
    this.add_related_model(this._editorModel);
  },

  _initViews: function () {
    var actionable = this._notifierModel.getButton();
    var closable = this._notifierModel.isClosable();
    var view = this.template({
      status: this._notifierModel.getStatus(),
      info: this._notifierModel.getInfo(),
      isActionable: actionable,
      isClosable: closable
    });

    this.$el.append(view);

    if (actionable) {
      this._createActionView(actionable);
    }

    if (closable) {
      this._createCloseView();
    }
  },

  _createActionView: function (action) {
    var actionView = new ActionView({
      template: actionTemplate,
      className: 'js-action',
      model: this._notifierModel,
      editorModel: this._editorModel
    });

    this.$('.js-actionButton').append(actionView.render().el);
    this.addView(actionView);
  },

  _createCloseView: function () {
    var actionView = new ActionView({
      template: closeTemplate,
      className: 'CDB-Shape js-close',
      editorModel: this._editorModel
    });

    this.$('.js-closeButton').append(actionView.render().el);
    this.addView(actionView);
  },

  _closeHandler: function () {
    var status = this._notifierModel.getStatus();
    var action = this._notifierModel.getAction();
    this._notifierModel.trigger('notification:close', action || status);
    clearTimeout(this._timeout);
    if (this._notifierModel && this._notifierModel.collection) {
      this._notifierModel.collection.remove(this._notifierModel);
    }
  },

  _actionHandler: function () {
    var status = this._notifierModel.getStatus();
    var action = this._notifierModel.getAction();
    this._notifierModel.trigger('notification:action', action || status);
  },

  _changeStyle: function () {
    this.$('.Notifier-info').toggleClass('u-whiteTextColor', this._editorModel.isEditing());
    this.$('.Notifier-actions .CDB-Shape-close').toggleClass('is-blue', !this._editorModel.isEditing());
    this.$('.Notifier-actions .CDB-Shape-close').toggleClass('is-white', this._editorModel.isEditing());
  },

  _autoClose: function () {
    this._notifierModel.set({action: 'autoclose'}, {silent: true});
    this._closeHandler();
  },

  _onChangeStatus: function (model, status) {
    if ((status === 'success' || status === 'error') && this._notifierModel.get('closable') !== false && this._notifierModel.get('autoclosable') !== false) {
      this._timeout = setTimeout(this._autoClose.bind(this), this._delay);
    }
  }
});

},{"./notifier-action-view":467,"./notifier-action.tpl":468,"./notifier-close.tpl":469,"./notifier-item.tpl":472,"backbone/core-view":1127}],472:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Notifier-item Notifier-item--'+
((__t=( status ))==null?'':_.escape(__t))+
'">\n\n  ';
 if (status === 'loading') { 
__p+='\n  <div class="Notifier-icon CDB-LoaderIcon is-blue js-theme u-rSpace--m">\n    <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n      <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n    </svg>\n  </div>\n  ';
 } 
__p+='\n\n  ';
 if (status === 'success') { 
__p+='\n  <div class="Notifier-icon CDB-Shape u-rSpace--m">\n    <div class="CDB-Shape-CircleItem CDB-Shape-CircleItem--fill is-green">\n      <div class="CDB-Shape-tick is-medium is-white"></div>\n    </div>\n  </div>\n  ';
 } 
__p+='\n\n  ';
 if (status === 'error' || status === 'warning') { 
__p+='\n  <div class="Notifier-icon CDB-Shape u-rSpace--m">\n    <div class="CDB-Shape-CircleItem CDB-Shape-CircleItem--fill is-red">\n      <div class="CDB-Shape-close is-medium is-white"></div>\n    </div>\n  </div>\n  ';
 } 
__p+='\n\n  <div class="Notifier-info">\n    <p class="CDB-Text CDB-Size-medium">'+
((__t=( info ))==null?'':__t)+
' ';
 if (isActionable) { 
__p+=' <span class="js-actionButton"></span> ';
 } 
__p+='</p>\n  </div>\n\n  ';
 if (isClosable) { 
__p+='\n    <div class="Notifier-actions js-closeButton"></div>\n  ';
 } 
__p+='\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],473:[function(require,module,exports){
var Backbone = require('backbone');

module.exports = Backbone.Model.extend({
  defaults: {
    status: 'idle',
    info: '',
    closable: true
  },

  initialize: function (attrs, opts) {
    if (attrs.id === undefined) {
      this.set('id', 'notifier' + this.cid);
    }

    this.set('defaultDelay', opts.delay);

    if (opts.visDefinitionModel) {
      this._retriggerEvent(opts.visDefinitionModel, 'vis:reload');
      this._retriggerEvent(opts.visDefinitionModel, 'vis:error');
    }
  },

  isClosable: function () {
    return this.get('closable') === true;
  },

  updateClosable: function (val) {
    this.set({closable: val});
  },

  getButton: function () {
    return this.get('button');
  },

  updateButton: function (val) {
    this.set({button: val});
  },

  getStatus: function () {
    return this.get('status');
  },

  updateStatus: function (val) {
    this.set({status: val});
  },

  getInfo: function () {
    return this.get('info');
  },

  getAction: function () {
    return this.get('action');
  },

  setAction: function (val) {
    this.set({action: val});
  },

  updateInfo: function (val) {
    this.set({info: val});
  },

  update: function (state) {
    this.set(state);
  },

  _retriggerEvent: function (model, event) {
    model.on(event, function () {
      this.trigger(event, arguments);
    }, this);
  }
});

},{"backbone":"backbone"}],474:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var NotifierItemView = require('./notifier-item-view');
var template = require('./notifier.tpl');

module.exports = CoreView.extend({
  className: 'Notifier',

  initialize: function (opts) {
    if (!opts.collection) throw new Error('collection is mandatory');
    if (!opts.editorModel) throw new Error('editorModel is mandatory');

    this._editorModel = opts.editorModel;
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());
    this._renderAllSubviews();
    this._renderLoading();
    return this;
  },

  rebindEvents: function () {
    // Just in case
    this.stopListening(this.collection);
    this.stopListening(this._editorModel);
    this._initBinds();
    return this;
  },

  _initBinds: function () {
    this.listenTo(this.collection, 'reset update change:status', this.render);
    this.add_related_model(this.collection);

    this.listenTo(this._editorModel, 'change:edition', this._changeStyle);
    this.add_related_model(this._editorModel);
  },

  _renderAllSubviews: function () {
    this.collection.each(this._renderSubview, this);
  },

  _renderSubview: function (model) {
    var view = new NotifierItemView({
      notifierModel: model,
      editorModel: this._editorModel
    });

    var status = model.get('status');
    var container = (status === 'success' || status === 'error')
                    ? this._getDoneContainer()
                    : this._getLoadingContainer();
    container.append(view.render().el);
    this.addView(view);
  },

  _removeSubview: function (model) {
    var id = model.get('id');
    var view = _.first(_.filter(this._subviews, function (subview) {
      return subview._notifierModel.get('id') === id;
    }));

    if (view) {
      this.removeView(view);
      view.remove();
    }
  },

  _renderLoading: function () {
    this._getLoader().toggleClass('is-visible', this._anyNotificationLoading());
  },

  _anyNotificationLoading: function () {
    return this.collection.any(function (model) {
      return !_.contains(['success', 'error', 'warning'], model.get('status'));
    });
  },

  _changeStyle: function () {
    this.$el.toggleClass('is-dark', this._editorModel.isEditing());
  },

  _getDoneContainer: function () {
    return this.$('.js-status-done');
  },

  _getLoadingContainer: function () {
    return this.$('.js-status-loading');
  },

  _getLoader: function () {
    return this.$('.js-loader');
  }
});

},{"./notifier-item-view":471,"./notifier.tpl":476,"backbone/core-view":1127,"underscore":"underscore"}],475:[function(require,module,exports){
var NotifierView = require('./notifier-view');
var NotifierCollection = require('./notifier-collection');

var manager = (function () {
  var initialized = false;
  var notifierView;
  var collection = new NotifierCollection();
  var editorModel;

  function init (opts) {
    if (!editorModel && !opts) {
      throw new Error('editorModel is required');
    }

    if (!editorModel && opts && opts.editorModel) {
      editorModel = opts.editorModel;
    }

    initialized = true;
    notifierView = new NotifierView({
      collection: collection,
      editorModel: editorModel
    });
  }

  return {
    DEFAULT_DELAY: 5000,
    init: function (opts) {
      if (opts.visDefinitionModel) {
        this._visDefinitionModel = opts.visDefinitionModel;
      }
      init(opts);
    },

    getView: function () {
      if (!initialized) init();
      return notifierView.rebindEvents();
    },

    getCollection: function () {
      return collection;
    },

    getNotification: function (model) {
      var notification;
      if (typeof model === 'string') {
        notification = collection.findById(model);
      } else {
        notification = collection.findById(model.id);
      }
      return notification;
    },

    addNotification: function (attrs) {
      return collection.add(attrs, {
        visDefinitionModel: this._visDefinitionModel,
        delay: this.DEFAULT_DELAY
      });
    },

    removeNotification: function (model) {
      var notification;
      if (typeof model === 'string') {
        notification = collection.findById(model);
      } else {
        notification = collection.findById(model.id);
      }
      return collection.remove(notification);
    }
  };
})();

module.exports = manager;

},{"./notifier-collection":470,"./notifier-view":474}],476:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Loader js-loader"></div>\n<ul class="Notifier-list js-status-loading"></ul>\n<ul class="Notifier-list js-status-done"></ul>';
}
return __p;
};

},{"underscore":"underscore"}],477:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text Onboarding-headerDescription">\n  '+
((__t=( _t('analyses-onboarding.new-column-included') ))==null?'':_.escape(__t))+
'\n</p>\n\n<ul class="Onboarding-list">\n  ';
 if (aggregate_function === 'count') { 
__p+='\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">count_vals</div>\n  </li>\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">count_vals_density</div>\n  </li>\n  ';
 } else {
__p+='\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">'+
((__t=( aggregate_function ))==null?'':_.escape(__t))+
'_'+
((__t=( aggregate_column ))==null?'':_.escape(__t))+
'</div>\n  </li>\n  ';
 } 
__p+='\n</ul>\n\n<p class="CDB-Text Onboarding-description">\n  '+
((__t=( _t('analyses-onboarding.aggregate-intersection.description') ))==null?'':_.escape(__t))+
'\n</p>\n';
}
return __p;
};

},{"underscore":"underscore"}],478:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text Onboarding-headerDescription">\n  '+
((__t=( _t('analyses-onboarding.geometries-updated') ))==null?'':_.escape(__t))+
'\n</p>\n\n<ul class="Onboarding-list">\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">the_geom</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.area-of-influence.the-geom') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n</ul>\n\n<p class="CDB-Text Onboarding-description">\n  '+
((__t=( _t('analyses-onboarding.area-of-influence.description') ))==null?'':_.escape(__t))+
'\n</p>\n\n<p class="CDB-Text Onboarding-description">\n  <a href="https://carto.com/learn/guides/analysis/areas-of-influence" class="Onboarding-readMore" target="_blank">'+
((__t=( _t('analyses-onboarding.learn-more') ))==null?'':_.escape(__t))+
'</a>\n</p>\n';
}
return __p;
};

},{"underscore":"underscore"}],479:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text Onboarding-headerDescription">\n  '+
((__t=( _t('analyses-onboarding.new-columns-created') ))==null?'':_.escape(__t))+
'\n</p>\n\n<ul class="Onboarding-list">\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">the_geom</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.centroid.the-geom') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">value</div>\n    <p class="CDB-Text Onboarding-description">\n      ';
 if (aggregation) { 
__p+='\n      '+
((__t=( _t('analyses-onboarding.centroid.aggregated-value') ))==null?'':_.escape(__t))+
'\n      ';
 } else { 
__p+='\n      '+
((__t=( _t('analyses-onboarding.centroid.non-aggregated-value') ))==null?'':_.escape(__t))+
'\n      ';
 } 
__p+='\n    </p>\n  </li>\n  ';
 if (category_column) { 
__p+='\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">category</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.centroid.category') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n  ';
 } 
__p+='\n</ul>\n\n<p class="CDB-Text Onboarding-description">\n  '+
((__t=( _t('analyses-onboarding.centroid.description') ))==null?'':_.escape(__t))+
'\n</p>';
}
return __p;
};

},{"underscore":"underscore"}],480:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text Onboarding-headerDescription">\n  '+
((__t=( _t('analyses-onboarding.new-columns-created') ))==null?'':_.escape(__t))+
'\n</p>\n\n<ul class="Onboarding-list">\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">the_geom</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.closest.the-geom') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">source_cdb_id</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.closest.source_cdb_id') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n</ul>\n\n<p class="CDB-Text Onboarding-description">\n  '+
((__t=( _t('analyses-onboarding.closest.description') ))==null?'':_.escape(__t))+
'\n</p>';
}
return __p;
};

},{"underscore":"underscore"}],481:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text Onboarding-headerDescription">\n  '+
((__t=( _t('analyses-onboarding.geometries-updated') ))==null?'':_.escape(__t))+
'\n</p>\n\n<ul class="Onboarding-list">\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">the_geom</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.connect-with-lines.the-geom') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n</ul>\n\n<p class="CDB-Text Onboarding-description">\n  '+
((__t=( _t('analyses-onboarding.connect-with-lines.' + type) ))==null?'':_.escape(__t))+
'\n</p>\n\n<p class="CDB-Text Onboarding-description">\n  <a href="https://carto.com/learn/guides/analysis/connect-with-lines" class="Onboarding-readMore" target="_blank">'+
((__t=( _t('analyses-onboarding.learn-more') ))==null?'':_.escape(__t))+
'</a>\n</p>\n';
}
return __p;
};

},{"underscore":"underscore"}],482:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text Onboarding-headerDescription">\n  '+
((__t=( _t('analyses-onboarding.new-column-included') ))==null?'':_.escape(__t))+
'\n</p>\n\n<ul class="Onboarding-list">\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">'+
((__t=( final_column ))==null?'':_.escape(__t))+
'</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.data-observatory-measure.custom-column') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n</ul>\n\n<p class="CDB-Text Onboarding-description">\n  '+
((__t=( _t('analyses-onboarding.data-observatory-measure.description') ))==null?'':_.escape(__t))+
'\n</p>\n\n<p class="CDB-Text Onboarding-description">\n  <a href="https://carto.com/learn/guides/analysis/enrich-from-data-observatory" class="Onboarding-readMore" target="_blank">'+
((__t=( _t('analyses-onboarding.learn-more') ))==null?'':_.escape(__t))+
'</a>\n</p>';
}
return __p;
};

},{"underscore":"underscore"}],483:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text Onboarding-description">\n  '+
((__t=( _t('analyses-onboarding.filter-by-node-column.description') ))==null?'':_.escape(__t))+
'\n</p>\n';
}
return __p;
};

},{"underscore":"underscore"}],484:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text Onboarding-headerDescription">\n  '+
((__t=( _t('analyses-onboarding.new-columns-created') ))==null?'':_.escape(__t))+
'\n</p>\n\n<p class="CDB-Text Onboarding-description">\n  '+
((__t=( _t('analyses-onboarding.filter.description') ))==null?'':_.escape(__t))+
'\n</p>\n';
}
return __p;
};

},{"underscore":"underscore"}],485:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text Onboarding-headerDescription">\n  '+
((__t=( _t('analyses-onboarding.geometries-updated') ))==null?'':_.escape(__t))+
'\n</p>\n\n<ul class="Onboarding-list">\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">the_geom</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.georeference.the-geom') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n</ul>\n\n<p class="CDB-Text Onboarding-description">\n  '+
((__t=( _t('analyses-onboarding.georeference.description') ))==null?'':_.escape(__t))+
'\n</p>\n\n<p class="CDB-Text Onboarding-description">\n  <a href="https://carto.com/learn/guides/analysis/georeference" class="Onboarding-readMore" target="_blank">'+
((__t=( _t('analyses-onboarding.learn-more') ))==null?'':_.escape(__t))+
'</a>\n</p>';
}
return __p;
};

},{"underscore":"underscore"}],486:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text Onboarding-headerDescription">\n  '+
((__t=( _t('analyses-onboarding.geometries-updated') ))==null?'':_.escape(__t))+
'\n</p>\n\n<ul class="Onboarding-list">\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">the_geom</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.group-points.the-geom') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n  ';
 if (category_column) { 
__p+='\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">'+
((__t=( category_column ))==null?'':_.escape(__t))+
'</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.group-points.category') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n  ';
 } 
__p+='\n</ul>\n\n<p class="CDB-Text Onboarding-description">\n  '+
((__t=( _t('analyses-onboarding.group-points.description', { method: _t('analyses.' + type + '.title') }) ))==null?'':_.escape(__t))+
'\n</p>\n\n<p class="CDB-Text Onboarding-description">\n  <a href="http://postgis.net/docs/manual-2.2/" class="Onboarding-readMore" target="_blank">'+
((__t=( _t('analyses-onboarding.read-more') ))==null?'':_.escape(__t))+
'</a>\n</p>\n';
}
return __p;
};

},{"underscore":"underscore"}],487:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text Onboarding-headerDescription">\n  '+
((__t=( _t('analyses-onboarding.new-column-included') ))==null?'':_.escape(__t))+
'\n</p>\n\n<ul class="Onboarding-list">\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">source_cartodb_id</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.intersection.source-cartodb-id') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n</ul>\n\n<p class="CDB-Text Onboarding-description">\n  '+
((__t=( _t('analyses-onboarding.intersection.description') ))==null?'':_.escape(__t))+
'\n</p>\n\n<p class="CDB-Text Onboarding-description">\n  <a href="https://carto.com/learn/guides/analysis/intersect-second-layer" class="Onboarding-readMore" target="_blank">'+
((__t=( _t('analyses-onboarding.learn-more') ))==null?'':_.escape(__t))+
'</a>\n</p>\n';
}
return __p;
};

},{"underscore":"underscore"}],488:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text Onboarding-headerDescription">\n  '+
((__t=( _t('analyses-onboarding.new-column-added') ))==null?'':_.escape(__t))+
'\n</p>\n\n<ul class="Onboarding-list">\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">cluster_no</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.kmeans.cluster-no', { clusters: clusters }) ))==null?'':_.escape(__t))+
'</p>\n  </li>\n</ul>\n\n<p class="CDB-Text Onboarding-description">\n  '+
((__t=( _t('analyses-onboarding.kmeans.description') ))==null?'':_.escape(__t))+
'\n</p>\n';
}
return __p;
};

},{"underscore":"underscore"}],489:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text Onboarding-headerDescription">\n  '+
((__t=( _t('analyses-onboarding.new-columns-included-based-on-input') ))==null?'':_.escape(__t))+
'\n</p>\n\n<p class="CDB-Text Onboarding-description">\n  '+
((__t=( _t('analyses-onboarding.merge.description') ))==null?'':_.escape(__t))+
'\n</p>\n\n<p class="CDB-Text Onboarding-description">\n  <a href="https://carto.com/learn/guides/analysis/join-column-from-second-layer" class="Onboarding-readMore" target="_blank">'+
((__t=( _t('analyses-onboarding.learn-more') ))==null?'':_.escape(__t))+
'</a>\n</p>\n';
}
return __p;
};

},{"underscore":"underscore"}],490:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text Onboarding-headerDescription">\n  '+
((__t=( _t('analyses-onboarding.new-columns-included') ))==null?'':_.escape(__t))+
'\n</p>\n\n<ul class="Onboarding-list">\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">quads</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.moran.quads') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">significance</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.moran.significance') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">moran</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.moran.moran') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">rowid</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.moran.rowid') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n</ul>\n\n<p class="CDB-Text Onboarding-description">\n  '+
((__t=( _t('analyses-onboarding.moran.description') ))==null?'':_.escape(__t))+
'\n</p>\n\n<p class="CDB-Text Onboarding-description">\n  <a href="https://carto.com/learn/guides/analysis/detect-outliers-and-clusters" class="Onboarding-readMore" target="_blank">'+
((__t=( _t('analyses-onboarding.learn-more') ))==null?'':_.escape(__t))+
'</a>\n</p>';
}
return __p;
};

},{"underscore":"underscore"}],491:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text Onboarding-headerDescription">\n  '+
((__t=( _t('analyses-onboarding.no-new-columns') ))==null?'':_.escape(__t))+
'\n</p>\n\n<p class="CDB-Text Onboarding-description">\n  '+
((__t=( _t('analyses-onboarding.sampling.description', { percentage: Math.round(sampling * 100) }) ))==null?'':_.escape(__t))+
'\n</p>\n';
}
return __p;
};

},{"underscore":"underscore"}],492:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text Onboarding-headerDescription">\n  '+
((__t=( _t('analyses-onboarding.new-columns-included') ))==null?'':_.escape(__t))+
'\n</p>\n\n<ul class="Onboarding-list">\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">trend</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.spatial-markov-trend.trend') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">trend_up</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.spatial-markov-trend.trend_up') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">trend_down</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.spatial-markov-trend.trend_down') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n  <li class="Onboarding-listItem">\n    <div class="Onboarding-listItemValue">volatility</div>\n    <p class="CDB-Text Onboarding-description">'+
((__t=( _t('analyses-onboarding.spatial-markov-trend.volatility') ))==null?'':_.escape(__t))+
'</p>\n  </li>\n</ul>\n\n<p class="CDB-Text Onboarding-description">\n  '+
((__t=( _t('analyses-onboarding.spatial-markov-trend.description') ))==null?'':_.escape(__t))+
'\n</p>\n\n<p class="CDB-Text Onboarding-description">\n  <a href="https://carto.com/learn/guides/analysis/predict-trends-and-volatility" class="Onboarding-readMore" target="_blank">'+
((__t=( _t('analyses-onboarding.learn-more') ))==null?'':_.escape(__t))+
'</a>\n</p>\n';
}
return __p;
};

},{"underscore":"underscore"}],493:[function(require,module,exports){
var LocalStorage = require('../../../components/local-storage/local-storage');
var AnalysisOnboardingView = require('../../../components/onboardings/analysis/analysis-view');
var Analyses = require('../../../data/analyses');
var STORAGE_KEY = 'onboarding';

var launcher = (function () {
  var onboardings;
  var userModel;
  var editorModel;

  function init (opts) {
    if (!onboardings && !opts) {
      throw new Error('onboardings is required');
    }

    if (!userModel && !opts) {
      throw new Error('userModel is required');
    }

    if (!onboardings && opts && opts.onboardings) {
      onboardings = opts.onboardings;
    }

    if (!userModel && opts && opts.userModel) {
      userModel = opts.userModel;
    }

    editorModel = onboardings.editorModel;
  }

  return {
    init: function (opts) {
      init(opts);

      LocalStorage.init(STORAGE_KEY, {
        userModel: userModel
      });
    },

    launch: function (type, model) {
      var genericType = Analyses.getAnalysisByType(type).genericType || type;

      if (!LocalStorage.get(genericType) && genericType) {
        onboardings.create(function (modalModel) {
          return new AnalysisOnboardingView({
            modalModel: modalModel,
            userModel: userModel,
            editorModel: editorModel,
            model: model
          });
        });
      }
    }
  };
})();

module.exports = launcher;

},{"../../../components/local-storage/local-storage":231,"../../../components/onboardings/analysis/analysis-view":494,"../../../data/analyses":599}],494:[function(require,module,exports){
var LocalStorage = require('../../../components/local-storage/local-storage');
var CoreView = require('backbone/core-view');
var template = require('./analysis-view.tpl');
var Analyses = require('../../../data/analyses');

var STORAGE_KEY = 'onboarding';

module.exports = CoreView.extend({
  className: 'AnalysisCompletionDetails is-opening',

  events: {
    'click .js-close': '_close',
    'click .js-style': '_onStyle'
  },

  initialize: function (opts) {
    if (!opts.modalModel) throw new Error('modalModel is required');
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.editorModel) throw new Error('editorModel is required');

    this._modalModel = opts.modalModel;
    this._userModel = opts.userModel;
    this._editorModel = opts.editorModel;

    LocalStorage.init(STORAGE_KEY, {
      userModel: this._userModel
    });

    this._initBinds();
  },

  render: function () {
    this.$el.html(template({
      type: this._getGenericAnalysisType()
    }));

    var onboardingTemplate = this._typeDef().onboardingTemplate;
    var html = onboardingTemplate && onboardingTemplate(this.model.attributes);
    this.$('.js-content').html(html);

    this._onChangeEditorModelEdition(this._editorModel);

    return this;
  },

  _initBinds: function () {
    this.listenTo(this.model, 'destroy', this._close);
    this.listenTo(this._editorModel, 'change:edition', this._onChangeEditorModelEdition);
    this.add_related_model(this._editorModel);
  },

  _onChangeEditorModelEdition: function (mdl) {
    var isEditing = !!mdl.get('edition');
    this.$el.toggleClass('is-editing', isEditing);
  },

  _close: function () {
    this._checkForgetStatus();
    this.trigger('close', this);
  },

  _onStyle: function () {
    this._checkForgetStatus();
    this.trigger('customEvent', 'style', this);
  },

  _checkForgetStatus: function () {
    if (this.$('.js-forget:checked').val()) {
      this._forget();
    }
  },

  _forget: function () {
    LocalStorage.set(this._getGenericAnalysisType(), true);
  },

  _typeDef: function (type) {
    type = type || this.model.get('type');
    return Analyses.getAnalysisByType(type);
  },

  _getGenericAnalysisType: function () {
    var typeDef = this._typeDef();
    return typeDef && typeDef.genericType || this.model.get('type');
  }
});

},{"../../../components/local-storage/local-storage":231,"../../../data/analyses":599,"./analysis-view.tpl":495,"backbone/core-view":1127}],495:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Onboarding-fake"></div>\n<div class="Onboarding-contentWrapper">\n  <div class="Onboarding-body">\n    <p class="CDB-Text Onboarding-headerTitle">'+
((__t=( _t('analyses-onboarding.' + type + '.title') ))==null?'':_.escape(__t))+
'</p>\n    <p class="CDB-Text Onboarding-headerText">'+
((__t=( _t('analyses-onboarding.finished') ))==null?'':_.escape(__t))+
'</p>\n\n    <div class="js-content"></div>\n\n    <div class="Onboarding-footer">\n      <div class="Onboarding-footerButtons">\n        <button class="CDB-Button CDB-Button--secondary CDB-Button--white CDB-Button--big Onboarding-footer--marginRight js-close">\n          <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('analyses-onboarding.done') ))==null?'':_.escape(__t))+
'</span>\n        </button>\n\n        <button class="CDB-Button CDB-Button--primary CDB-Button--big js-style">\n          <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('analyses-onboarding.style-analysis') ))==null?'':_.escape(__t))+
'</span>\n        </button>\n      </div>\n\n      <div class="u-iBlock">\n        <input class="CDB-Checkbox js-forget" type="checkbox" id="forget-me" name="forget-me" value="true">\n        <span class="u-iBlock CDB-Checkbox-face"></span>\n        <label for="forget-me" class="Onboarding-forgetLabel Checkbox-label CDB-Text CDB-Size-small u-altTextColor u-lSpace">'+
((__t=( _t('analyses-onboarding.never-show-message') ))==null?'':_.escape(__t))+
'</label>\n      </div>\n    </div>\n  </div>\n</div>\n\n';
}
return __p;
};

},{"underscore":"underscore"}],496:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var $ = require('jquery');
var template = require('./builder-activated-notification.tpl');
var DASHBOARD_NOTIFICATION_KEY = 'builder_activated';

module.exports = CoreView.extend({
  className: 'js-builderNotification',
  events: {
    'click .js-close': '_onClose'
  },

  initialize: function () {
    if (!this.options.builderActivatedNotification) { throw new Error('builderActivatedNotification is required'); }
    this._notification = this.options.builderActivatedNotification;

    this.render();
  },

  render: function () {
    this.$el.html(template());
    $('body').prepend(this.$el);

    return this;
  },

  _onClose: function () {
    this._notification.setKey(DASHBOARD_NOTIFICATION_KEY, true);
    this._notification.save();

    this.clean();
  },

  clean: function () {
    this.constructor.__super__.clean.apply(this);
  }
});

},{"./builder-activated-notification.tpl":497,"backbone/core-view":1127,"jquery":"jquery"}],497:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="onboardingNotification Color-MainDark CDB-Text CDB-Size-medium u-flex u-justifyCenter">\n  <p>'+
((__t=( _t('builder-activated-notification.message') ))==null?'':__t)+
'</p>\n\n  <button class="onboardingNotification-closeButton js-close">\n    <div class="CDB-Shape-close is-large is-white"></div>\n  </button>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],498:[function(require,module,exports){
var $ = require('jquery');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var template = require('./builder-view.tpl');
var checkAndBuildOpts = require('../../../helpers/required-opts');

var BUILDER_KEY = 'onboarding';

var LEFT_KEY_CODE = 37;
var RIGHT_KEY_CODE = 39;

var REQUIRED_OPTS = [
  'userModel',
  'onboardingNotification',
  'editorModel'
];

module.exports = CoreView.extend({
  className: 'BuilderOnboarding is-step0 is-opening',

  events: {
    'click .js-start': '_onClickNext',
    'click .js-next': '_onClickNext',
    'click .js-close': '_close'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._initModels();
    this._initBinds();
  },

  render: function () {
    this.$el.html(template({
      name: this._userModel.get('name') || this._userModel.get('username')
    }));

    return this;
  },

  _initModels: function () {
    this.model = new Backbone.Model({
      step: 0
    });
  },

  _initBinds: function () {
    this._keyDown = this._onKeyDown.bind(this);
    $(document).on('keydown', this._keyDown);

    this.listenTo(this.model, 'change:step', this._onChangeStep);
    this.listenTo(this.model, 'destroy', this._close);
    this.listenTo(this._editorModel, 'change:edition', this._changeEdition);
  },

  _changeEdition: function (mdl) {
    var isEditing = !!mdl.get('edition');
    this.$el.toggleClass('is-editing', isEditing);
  },

  _prev: function () {
    if (this._currentStep() >= 1) {
      this.model.set('step', this._currentStep() - 1);
    }
  },

  _next: function () {
    if (this._currentStep() <= 3) {
      this.model.set('step', this._currentStep() + 1);
    }
  },

  _currentStep: function () {
    return this.model.get('step');
  },

  _onClickNext: function () {
    this._next();
  },

  _onChangeStep: function () {
    var self = this;

    this.$el.removeClass('is-step' + this.model.previous('step'), function () {
      self.$el.addClass('is-step' + self._currentStep());
    });

    this.$('.js-step').removeClass('is-step' + this.model.previous('step'), function () {
      self.$('.js-step').addClass('is-step' + self._currentStep());
    });
  },

  _close: function () {
    this._checkForgetStatus();
    this.trigger('close', this);
  },

  _onKeyDown: function (e) {
    e.stopPropagation();

    if (e.which === LEFT_KEY_CODE) {
      this._prev();
    } else if (e.which === RIGHT_KEY_CODE) {
      this._next();
    }
  },

  _checkForgetStatus: function () {
    if (this.$('.js-forget:checked').val()) {
      this._forget();
    }
  },

  _forget: function () {
    this._onboardingNotification.setKey(BUILDER_KEY, true);
    this._onboardingNotification.save();
  },

  clean: function () {
    $(document).off('keydown', this._keyDown);
    CoreView.prototype.clean.apply(this);
  }
});

},{"../../../helpers/required-opts":1097,"./builder-view.tpl":499,"backbone":"backbone","backbone/core-view":1127,"jquery":"jquery"}],499:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="BuilderOnboarding-pad"></div>\n<div class="BuilderOnboarding-pad2"></div>\n<div class="BuilderOnboarding-contentWrapper is-step0 js-step">\n  <div class="BuilderOnboarding-body">\n    <div class="BuilderOnboarding-header is-step0">\n      <p class="CDB-Text Onboarding-headerTitle">'+
((__t=( _t('builder-onboarding.title')))==null?'':_.escape(__t))+
'</p>\n      <p class="CDB-Text Onboarding-headerText">'+
((__t=( name ))==null?'':_.escape(__t))+
'</p>\n\n      <p class="CDB-Text BuilderOnboarding-description">\n        '+
((__t=( _t('builder-onboarding.description')))==null?'':_.escape(__t))+
'\n      </p>\n    </div>\n\n    <div class="BuilderOnboarding-footer is-step0">\n      <div class="BuilderOnboarding-footerButtons">\n        <button class="CDB-Button CDB-Button--secondary CDB-Button--white CDB-Button--big Onboarding-footer--marginRight js-start">\n          <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('builder-onboarding.take-tour')))==null?'':_.escape(__t))+
'</span>\n        </button>\n\n        <button class="CDB-Button CDB-Button--primary CDB-Button--big js-close">\n          <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('builder-onboarding.edit-map')))==null?'':_.escape(__t))+
'</span>\n        </button>\n      </div>\n\n      <div class="u-iBlock is-step1">\n        <input class="CDB-Checkbox js-forget" type="checkbox" id="forget-me" name="forget-me" value="true">\n        <span class="u-iBlock CDB-Checkbox-face"></span>\n        <label for="forget-me" class="BuilderOnboarding-forgetLabel Checkbox-label CDB-Text CDB-Size-small u-altTextColor u-lSpace">'+
((__t=( _t('analyses-onboarding.never-show-message') ))==null?'':_.escape(__t))+
'</label>\n      </div>\n    </div>\n\n    <div class="BuilderOnboarding-step is-step1">\n      <p class="CDB-Text Onboarding-headerTitle">1/4</p>\n      <p class="CDB-Text Onboarding-headerText">'+
((__t=( _t('builder-onboarding.toolbar.title')))==null?'':_.escape(__t))+
'</p>\n      <p class="CDB-Text BuilderOnboarding-description">\n        '+
((__t=( _t('builder-onboarding.toolbar.description')))==null?'':_.escape(__t))+
'\n      </p>\n    </div>\n\n    <div class="BuilderOnboarding-step is-step2">\n      <p class="CDB-Text Onboarding-headerTitle">2/4</p>\n      <p class="CDB-Text Onboarding-headerText">'+
((__t=( _t('builder-onboarding.configurator.title')))==null?'':_.escape(__t))+
'</p>\n      <p class="CDB-Text BuilderOnboarding-description">\n        '+
((__t=( _t('builder-onboarding.configurator.description')))==null?'':_.escape(__t))+
'\n      </p>\n    </div>\n\n    <div class="BuilderOnboarding-step is-step3">\n      <p class="CDB-Text Onboarding-headerTitle">3/4</p>\n      <p class="CDB-Text Onboarding-headerText">'+
((__t=( _t('builder-onboarding.map.title')))==null?'':_.escape(__t))+
'</p>\n      <p class="CDB-Text BuilderOnboarding-description">\n        '+
((__t=( _t('builder-onboarding.map.description')))==null?'':_.escape(__t))+
'\n      </p>\n    </div>\n\n    <div class="BuilderOnboarding-step is-step4">\n      <p class="CDB-Text Onboarding-headerTitle">4/4</p>\n      <p class="CDB-Text Onboarding-headerText">'+
((__t=( _t('builder-onboarding.widgets.title')))==null?'':_.escape(__t))+
'</p>\n      <p class="CDB-Text BuilderOnboarding-description">\n        '+
((__t=( _t('builder-onboarding.widgets.description')))==null?'':_.escape(__t))+
'\n      </p>\n    </div>\n\n    <div class="BuilderOnboarding-footer is-step1 is-step2 is-step3">\n      <div class="BuilderOnboarding-footerButtons">\n        <button class="CDB-Button CDB-Button--secondary CDB-Button--white CDB-Button--big Onboarding-footer--marginRight js-close">\n          <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('builder-onboarding.skip')))==null?'':_.escape(__t))+
'</span>\n        </button>\n\n        <button class="CDB-Button CDB-Button--primary CDB-Button--big js-next">\n          <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('builder-onboarding.next')))==null?'':_.escape(__t))+
'</span>\n        </button>\n      </div>\n    </div>\n\n    <div class="BuilderOnboarding-footer is-step4">\n      <div class="BuilderOnboarding-footerButtons">\n        <button class="CDB-Button CDB-Button--primary CDB-Button--big js-close">\n          <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('builder-onboarding.edit-map')))==null?'':_.escape(__t))+
'</span>\n        </button>\n      </div>\n    </div>\n  </div>\n</div>\n\n<div class="BuilderOnboarding-pad3"></div>\n<div class="BuilderOnboarding-pad4"></div>\n<div class="BuilderOnboarding-pad5"></div>\n<div class="BuilderOnboarding-shadow"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],500:[function(require,module,exports){
var BuilderOnboardingView = require('./builder-view');
var checkAndBuildOpts = require('../../../helpers/required-opts');

var BUILDER_KEY = 'onboarding';

var REQUIRED_OPTS = [
  'onboardings',
  'userModel',
  'onboardingNotification',
  'editorModel'
];

module.exports = (function () {
  return {
    init: function (opts) {
      checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    },

    launch: function () {
      if (!this._onboardingNotification.getKey(BUILDER_KEY)) {
        this._onboardings.create(function () {
          return new BuilderOnboardingView({
            userModel: this._userModel,
            editorModel: this._editorModel,
            onboardingNotification: this._onboardingNotification
          });
        }.bind(this));
      }
    }
  };
})();

},{"../../../helpers/required-opts":1097,"./builder-view":498}],501:[function(require,module,exports){
var _ = require('underscore');

var GenericOnboardingLauncher = function (launcherOpts, viewOpts) {
  var _view;
  var _onboardingNotification;
  var _notificationKey;
  var _onboardings;
  var _viewOpts;

  if (!launcherOpts || !launcherOpts.view) {
    throw new Error('view is required');
  }

  if (!launcherOpts.onboardingNotification) {
    throw new Error('onboardingNotification is required');
  }

  if (!launcherOpts.notificationKey) {
    throw new Error('notificationKey is required');
  }

  if (!launcherOpts.onboardings) {
    throw new Error('onboardings is required');
  }

  if (!viewOpts) {
    throw new Error('viewOpts is required');
  }

  _view = launcherOpts.view;
  _onboardingNotification = launcherOpts.onboardingNotification;
  _notificationKey = launcherOpts.notificationKey;
  _onboardings = launcherOpts.onboardings;
  _viewOpts = viewOpts;

  return {
    launch: function (launchOpts) {
      if (!_onboardingNotification.getKey(_notificationKey)) {
        _onboardings.create(function () {
          var extendedViewOptions = _.extend(_viewOpts, {
            onboardingNotification: _onboardingNotification,
            notificationKey: _notificationKey
          });
          return new _view(_.extend(extendedViewOptions, launchOpts));
        });
      }
    }
  };
};

module.exports = GenericOnboardingLauncher;

},{"underscore":"underscore"}],502:[function(require,module,exports){
var $ = require('jquery');
var Backbone = require('backbone');
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var checkAndBuildOpts = require('../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'onboardingNotification',
  'editorModel',
  'template',
  'numberOfSteps',
  'selector',
  'modifier',
  'notificationKey'
];

var LEFT_KEY_CODE = 37;
var RIGHT_KEY_CODE = 39;

module.exports = CoreView.extend({
  className: 'is-step0 is-opening',

  events: {
    'click .js-start': '_onClickNext',
    'click .js-next': '_onClickNext',
    'click .js-close': '_close',
    'click .js-highlight': '_close'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this.$el.addClass(this._selector);
    this.model = new Backbone.Model({
      step: -1
    });
    this._defaultBodyPos = {
      top: 32,
      left: 380
    };

    this._keyDown = this._onKeyDown.bind(this);
    this._initBinds();
  },

  render: function () {
    this.$el.addClass(this._selector + this._modifier);
    this.$el.html(this._template());
    if (this.model.get('step') === -1) {
      this._next();
    }
    return this;
  },

  _initBinds: function () {
    this.listenTo(this.model, 'destroy', this._close);
    this.listenTo(this.model, 'change:step', this._onChangeStep);
    this.listenTo(this._editorModel, 'change:edition', this._changeEdition);
    $(document).on('keydown', this._keyDown);
  },

  _changeEdition: function (mdl) {
    var isEditing = !!mdl.get('edition');
    this.$el.toggleClass('is-editing', isEditing);
  },

  _prev: function () {
    if (this._currentStep() >= 1) {
      this.model.set('step', this._currentStep() - 1);
    }
  },

  _next: function () {
    if (this._currentStep() < this._numberOfSteps) {
      this.model.set('step', this._currentStep() + 1);
    }
  },

  _currentStep: function () {
    return this.model.get('step');
  },

  _onClickNext: function () {
    this._next();
  },

  _onChangeStep: function () {
    var prev = this.model.previous('step');
    var step = this.model.get('step');

    this.$el.removeClass('is-step' + prev, function () {
      this.$el.addClass('is-step' + step);
    }.bind(this));

    this.$('.js-step').removeClass('is-step' + prev).addClass('is-step' + step);

    this.$('.' + this._selector + '-body').fadeOut(0).delay(200).fadeIn(100);

    this.$('.' + this._selector + '-step.is-step' + prev).css('display', 'none');
    this.$('.' + this._selector + '-footer.is-step' + prev).css('display', 'none');
    this.$('.' + this._selector + '-step.is-step' + step).css('display', 'block');
    this.$('.' + this._selector + '-footer.is-step' + step).css('display', 'block');

    this.$('.' + this._selector + '-contentBody').css('display', step === 0 ? 'block' : 'none');
  },

  _close: function () {
    this._checkForgetStatus();
    this.trigger('close', this);
  },

  _onKeyDown: function (e) {
    e.stopPropagation();

    if (e.which === LEFT_KEY_CODE) {
      this._prev();
    } else if (e.which === RIGHT_KEY_CODE) {
      this._next();
    }
  },

  _checkForgetStatus: function () {
    if (this.$('.js-forget:checked').val()) {
      this._forget();
    }
  },

  _forget: function () {
    this._onboardingNotification.setKey(this._notificationKey, true);
    this._onboardingNotification.save();
  },

  clean: function () {
    $(document).off('keydown', this._keyDown);
    CoreView.prototype.clean.apply(this);
  },

  _setMiddlePad: function (position, padding, body) {
    var $window = $(window);
    var $top = this.$('.' + this._selector + '-pads--left .' + this._selector + '-padTop');
    var $middle = this.$('.' + this._selector + '-pads--left .' + this._selector + '-padMiddle');
    var $bottom = this.$('.' + this._selector + '-pads--left .' + this._selector + '-padBottom');
    var vh = $window.height();
    var vw = $window.width();
    var isSelector = _.isString(position);
    var $el;
    var width = 0;
    var height = 0;
    var left = 0;
    var top = 0;
    if (isSelector) {
      $el = $(position);
      width = $el.outerWidth();
      height = $el.outerHeight();
      left = $el.offset().left;
      top = $el.offset().top;
    } else {
      width = position.width;
      height = position.height;
      left = position.left;
      top = position.top;
    }

    // Apply padding
    var appliedPadding = this._buildPadding(padding);
    top -= appliedPadding.top;
    left -= appliedPadding.left;
    width += appliedPadding.left + appliedPadding.right;
    height += appliedPadding.top + appliedPadding.bottom;

    // Is it place outside the viewport?
    if (vw - left > 0 && vw - left < width) {
      width = vw - left;
    } else if (vw - left <= 0) {
      width = 0;
    }

    // Left offset
    this.$('.' + this._selector + '-toolbarOverlay').outerWidth(left);

    // Right panel
    this.$('.' + this._selector + '-contentWrapper').outerWidth(vw - (left + width));

    // Width
    this.$('.' + this._selector + '-pads--left').outerWidth(width);
    $top.outerWidth(width);
    $middle.outerWidth(width);
    $bottom.outerWidth(width);

    // Height
    var topHeight = top;
    var middleHeight = height;
    var bottomHeight = vh - (topHeight + middleHeight);

    $top.outerHeight(topHeight);
    $middle.outerHeight(middleHeight);
    $bottom.outerHeight(bottomHeight);

    // Body text
    this.$('.' + this._selector + '-body').css('top', body && body.top ? body.top : this._defaultBodyPos.top);
    this.$('.' + this._selector + '-body').css('left', body && body.left ? body.left : this._defaultBodyPos.left);
  },

  _buildPadding: function (padding) {
    var result = {
      top: 0,
      right: 0,
      bottom: 0,
      left: 0
    };

    if (padding) {
      result.top = this._calculatePadding(padding.top);
      result.right = this._calculatePadding(padding.right);
      result.bottom = this._calculatePadding(padding.bottom);
      result.left = this._calculatePadding(padding.left);
    }

    return result;
  },

  _calculatePadding: function (padding) {
    return (padding && _.isFinite(padding)) ? padding : 0;
  }
});

},{"../../../helpers/required-opts":1097,"backbone":"backbone","backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],503:[function(require,module,exports){
var _ = require('underscore');
var OnboardingView = require('../../generic/generic-onboarding-view');
var AnalysesService = require('../../../../editor/layers/layer-content-views/analyses/analyses-service');
var template = require('./analysis-onboarding.tpl');

module.exports = OnboardingView.extend({
  events: OnboardingView.extendEvents({
    'click .js-add-analysis': '_onAddAnalysisClicked'
  }),

  initialize: function (opts) {
    OnboardingView.prototype.initialize.call(this, _.extend(opts, {
      template: template,
      numberOfSteps: 0,
      modifier: '--analysis'
    }));
  },

  _onAddAnalysisClicked: function () {
    this._checkForgetStatus();
    this.clean();
    AnalysesService.addAnalysis();
  },

  _onChangeStep: function () {
    OnboardingView.prototype._onChangeStep.call(this);

    var step = this.model.get('step');

    if (step === 0) {
      this._setMiddlePad('.js-editorPanel');
    }
  }
});

},{"../../../../editor/layers/layer-content-views/analyses/analyses-service":800,"../../generic/generic-onboarding-view":502,"./analysis-onboarding.tpl":504,"underscore":"underscore"}],504:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="LayerOnboarding-toolbarOverlay"></div>\n\n<div class="LayerOnboarding-pads LayerOnboarding-pads--left">\n  <div class="LayerOnboarding-padTop"></div>\n  <div class="LayerOnboarding-padMiddle js-highlight"></div>\n</div>\n\n<div class="LayerOnboarding-contentWrapper LayerOnboarding-contentWrapper--analysis is-step0 js-step">\n  <div class="LayerOnboarding-contentBody LayerOnboarding-contentBody--analysis is-step0 js-step">\n    <div class="Onboarding-body">\n      <p class="CDB-Text LayerOnboarding-headerTitle">'+
((__t=( _t('analysis-onboarding.title')))==null?'':_.escape(__t))+
'</p>\n\n      <p class="CDB-Text Onboarding-headerDescription">'+
((__t=( _t('analysis-onboarding.description')))==null?'':_.escape(__t))+
'</p>\n\n      <ul class="Onboarding-list">\n        <li class="Onboarding-listItem">\n          <p class="CDB-Text LayerOnboarding-description">'+
((__t=( _t('analysis-onboarding.description-list.item1')))==null?'':_.escape(__t))+
'</p>\n        </li>\n\n        <li class="Onboarding-listItem">\n          <p class="CDB-Text LayerOnboarding-description">'+
((__t=( _t('analysis-onboarding.description-list.item2')))==null?'':__t)+
'</p>\n        </li>\n\n        <li class="Onboarding-listItem">\n          <p class="CDB-Text LayerOnboarding-description">'+
((__t=( _t('analysis-onboarding.description-list.item3')))==null?'':_.escape(__t))+
'</p>\n        </li>\n\n        <li class="Onboarding-listItem">\n          <p class="CDB-Text LayerOnboarding-description">'+
((__t=( _t('analysis-onboarding.description-list.item4')))==null?'':_.escape(__t))+
'</p>\n        </li>\n      </ul>\n    </div>\n\n    <div class="LayerOnboarding-footer">\n      <div class="LayerOnboarding-footerButtons">\n        <button class="CDB-Button CDB-Button--secondary CDB-Button--white CDB-Button--big Onboarding-footer--marginRight js-close">\n          <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('analysis-onboarding.done')))==null?'':_.escape(__t))+
'</span>\n        </button>\n\n        <button class="CDB-Button CDB-Button--primary CDB-Button--big js-add-analysis">\n          <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('analysis-onboarding.add-analysis')))==null?'':_.escape(__t))+
'</span>\n        </button>\n      </div>\n\n      <div class="u-iBlock">\n        <input class="CDB-Checkbox js-forget" type="checkbox" id="forget-me" name="forget-me" value="true">\n        <span class="u-iBlock CDB-Checkbox-face"></span>\n        <label for="forget-me" class="Onboarding-forgetLabel Checkbox-label CDB-Text CDB-Size-small u-whiteTextColor is-light u-lSpace">'+
((__t=( _t('analyses-onboarding.never-show-message') ))==null?'':_.escape(__t))+
'</label>\n      </div>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],505:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');
var OnboardingView = require('../../generic/generic-onboarding-view');
var template = require('./data-onboarding.tpl');

module.exports = OnboardingView.extend({
  initialize: function (opts) {
    OnboardingView.prototype.initialize.call(this, _.extend(opts, {
      template: template,
      numberOfSteps: 4,
      modifier: '--data'
    }));
  },

  _onChangeStep: function () {
    OnboardingView.prototype._onChangeStep.call(this);

    var step = this.model.get('step');

    if (step === 0) {
      this._setMiddlePad('.js-editorPanel');
    } else if (step === 1) {
      this._setMiddlePad('.js-editorPanelHeader', {top: 16, right: 24, left: 24});
    } else if (step === 2) {
      this._setMiddlePad('.js-editorPanelContent', {top: 8, right: 24, left: 24, bottom: -$('.js-optionsBar').outerHeight()});
    } else if (step === 3) {
      this._setMiddlePad('.js-optionsBar', null, {top: -190});
    } else if (step === 4) {
      var featurePosition = this._getFeatureEditionPosition();
      this._setMiddlePad(featurePosition, {top: 8, right: 8, bottom: 8, left: 8}, {top: -270, left: -330});
    }
  },

  _getFeatureEditionPosition: function () {
    var $switch = $('.js-mapTableView').first();
    var $featureEdition = $('.js-newGeometryView').first();
    var leftOffset = Math.min($switch.length > 0 ? $switch.offset().left : Number.MAX_VALUE, $featureEdition.length > 0 ? $featureEdition.offset().left : Number.MAX_VALUE);
    var topOffset = Math.min($switch.length > 0 ? $switch.offset().top : Number.MAX_VALUE, $featureEdition.length > 0 ? $featureEdition.offset().top : Number.MAX_VALUE);
    var rightOffset = Math.max(
      $switch.length > 0 ? $switch.offset().left + $switch.outerWidth() : Number.MIN_VALUE,
      $featureEdition.length > 0 ? $featureEdition.offset().left + $featureEdition.outerWidth() : Number.MIN_VALUE
    );
    var bottomOffset = Math.max(
      $switch.length > 0 ? $switch.offset().top + $switch.outerHeight() : Number.MIN_VALUE,
      $featureEdition.length > 0 ? $featureEdition.offset().top + $featureEdition.outerHeight() : Number.MIN_VALUE
    );

    return {
      left: leftOffset,
      top: topOffset,
      width: rightOffset - leftOffset,
      height: bottomOffset - topOffset
    };
  }
});

},{"../../generic/generic-onboarding-view":502,"./data-onboarding.tpl":506,"jquery":"jquery","underscore":"underscore"}],506:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="LayerOnboarding-toolbarOverlay"></div>\n\n<div class="LayerOnboarding-pads LayerOnboarding-pads--left">\n  <div class="LayerOnboarding-padTop"></div>\n  <div class="LayerOnboarding-padMiddle js-highlight">\n    <div class="LayerOnboarding-body is-step0 js-step">\n      <div class="LayerOnboarding-step is-step1">\n        <p class="CDB-Text LayerOnboarding-headerTitle">1/4</p>\n        <p class="CDB-Text LayerOnboarding-headerText">'+
((__t=( _t('data-onboarding.layer-options.title')))==null?'':_.escape(__t))+
'</p>\n        <p class="CDB-Text LayerOnboarding-description">\n          '+
((__t=( _t('data-onboarding.layer-options.description')))==null?'':_.escape(__t))+
'\n        </p>\n      </div>\n      <div class="LayerOnboarding-step is-step2">\n        <p class="CDB-Text LayerOnboarding-headerTitle">2/4</p>\n        <p class="CDB-Text LayerOnboarding-headerText">'+
((__t=( _t('data-onboarding.data-tab.title')))==null?'':_.escape(__t))+
'</p>\n        <p class="CDB-Text LayerOnboarding-description">\n          '+
((__t=( _t('data-onboarding.data-tab.description')))==null?'':_.escape(__t))+
'\n        </p>\n      </div>\n\n      <div class="LayerOnboarding-step is-step3">\n        <p class="CDB-Text LayerOnboarding-headerTitle">3/4</p>\n        <p class="CDB-Text LayerOnboarding-headerText">'+
((__t=( _t('data-onboarding.sql-editor.title')))==null?'':_.escape(__t))+
'</p>\n        <p class="CDB-Text LayerOnboarding-description">\n          '+
((__t=( _t('data-onboarding.sql-editor.description')))==null?'':_.escape(__t))+
'\n        </p>\n      </div>\n\n      <div class="LayerOnboarding-step is-step4">\n        <p class="CDB-Text LayerOnboarding-headerTitle">4/4</p>\n        <p class="CDB-Text LayerOnboarding-headerText is-step4">'+
((__t=( _t('data-onboarding.add-geometry.title')))==null?'':_.escape(__t))+
'</p>\n        <p class="CDB-Text LayerOnboarding-description is-step4">\n          '+
((__t=( _t('data-onboarding.add-geometry.description')))==null?'':_.escape(__t))+
'\n        </p>\n      </div>\n\n      <div class="LayerOnboarding-footer is-step1 is-step2 is-step3">\n        <div class="LayerOnboarding-footerButtons">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--white CDB-Button--big Onboarding-footer--marginRight js-close">\n            <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('data-onboarding.exit')))==null?'':_.escape(__t))+
'</span>\n          </button>\n\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-next">\n            <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('data-onboarding.next')))==null?'':_.escape(__t))+
'</span>\n          </button>\n        </div>\n      </div>\n\n      <div class="LayerOnboarding-footer is-step4">\n        <div class="LayerOnboarding-footerButtons">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-close">\n            <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('data-onboarding.add-geometry.edit-layer') ))==null?'':_.escape(__t))+
'</span>\n          </button>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class="LayerOnboarding-padBottom"></div>\n</div>\n\n<div class="LayerOnboarding-contentWrapper is-step0 js-step">\n  <div class="LayerOnboarding-contentBody is-step0 js-step">\n    <div class="LayerOnboarding-header is-step0">\n      <p class="CDB-Text LayerOnboarding-headerTitle">'+
((__t=( _t('data-onboarding.title')))==null?'':_.escape(__t))+
'</p>\n\n      <p class="CDB-Text LayerOnboarding-description">\n        '+
((__t=( _t('data-onboarding.description')))==null?'':__t)+
'\n      </p>\n    </div>\n\n    <div class="LayerOnboarding-footer is-step0">\n      <div class="LayerOnboarding-footerButtons">\n        <button class="CDB-Button CDB-Button--secondary CDB-Button--white CDB-Button--big Onboarding-footer--marginRight js-start">\n          <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('data-onboarding.take-tour')))==null?'':_.escape(__t))+
'</span>\n        </button>\n\n        <button class="CDB-Button CDB-Button--primary CDB-Button--big js-close">\n          <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('data-onboarding.edit-layer')))==null?'':_.escape(__t))+
'</span>\n        </button>\n      </div>\n\n      <div class="u-iBlock is-step1">\n        <input class="CDB-Checkbox js-forget" type="checkbox" id="forget-me" name="forget-me" value="true">\n        <span class="u-iBlock CDB-Checkbox-face"></span>\n        <label for="forget-me" class="BuilderOnboarding-forgetLabel Checkbox-label CDB-Text CDB-Size-small u-whiteTextColor is-light u-lSpace">'+
((__t=( _t('style-onboarding.never-show-message') ))==null?'':_.escape(__t))+
'</label>\n      </div>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],507:[function(require,module,exports){
module.exports = 'layer-onboarding';

},{}],508:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');
var OnboardingView = require('../../generic/generic-onboarding-view');
var defaultTemplate = require('./style-onboarding.tpl');
var pointsTemplate = require('./style-points-onboarding.tpl');
var checkAndBuildOpts = require('../../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'geom'
];

module.exports = OnboardingView.extend({
  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    var template = defaultTemplate;
    var modifier = '--style';
    var steps = 2;

    if (this._geom === 'point') {
      template = pointsTemplate;
      steps = 3;
    }

    OnboardingView.prototype.initialize.call(this, _.extend(opts, {
      template: template,
      numberOfSteps: steps,
      modifier: modifier
    }));
  },

  _onChangeStep: function () {
    OnboardingView.prototype._onChangeStep.call(this);

    var step = this.model.get('step');

    switch (step) {
      case 0:
        this._setMiddlePad('.js-editorPanel');
        break;
      case 1:
        this._setStepOne();
        break;
      case 2:
        this._setStepTwo();
        break;
      case 3:
        this._highlightOptionsBar();
        break;
    }
  },

  _setStepOne: function () {
    var $noGeom = $('.js-styleNoGeom');

    if ($noGeom.length > 0) {
      this._setMiddlePad('.js-styleNoGeom', {top: 8, right: 24, left: 24, bottom: 8});
    } else if (this._numberOfSteps === 3) {
      var aggregationInfo = this._getAggregationPositionAndPadding();
      this._setMiddlePad(aggregationInfo.position, aggregationInfo.padding);
    } else {
      this._highlightStyleProperties();
    }
  },

  _setStepTwo: function () {
    if (this._numberOfSteps === 2) {
      this._highlightOptionsBar();
    } else {
      this._highlightStyleProperties();
    }
  },

  _highlightStyleProperties: function () {
    this._setMiddlePad('.js-styleProperties', {top: 8, right: 24, left: 24, bottom: 8});
  },

  _highlightOptionsBar: function () {
    this._setMiddlePad('.js-optionsBar', null, {top: -190});
  },

  _getAggregationPositionAndPadding: function () {
    var $aggregationTypes = $('.js-aggregationTypes');
    var $aggregationOptions = $('.js-aggregationOptions');
    var left = $aggregationTypes.offset().left;
    var top = $aggregationTypes.offset().top;
    var width = $aggregationTypes.outerWidth();
    var height = $aggregationTypes.outerHeight();
    var bottomPadding = 0;

    if ($aggregationOptions.length > 0) {
      height += $aggregationOptions.outerHeight();
      bottomPadding = 8;
    }

    return {
      position: {
        top: top,
        left: left,
        width: width,
        height: height
      },
      padding: {
        top: 8,
        right: 24,
        left: 24,
        bottom: bottomPadding
      }
    };
  }
});

},{"../../../../helpers/required-opts":1097,"../../generic/generic-onboarding-view":502,"./style-onboarding.tpl":509,"./style-points-onboarding.tpl":510,"jquery":"jquery","underscore":"underscore"}],509:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="LayerOnboarding-toolbarOverlay"></div>\n\n<div class="LayerOnboarding-pads LayerOnboarding-pads--left">\n  <div class="LayerOnboarding-padTop"></div>\n  <div class="LayerOnboarding-padMiddle js-highlight">\n    <div class="LayerOnboarding-body is-step0 js-step">\n      <div class="LayerOnboarding-step is-step1">\n        <p class="CDB-Text LayerOnboarding-headerTitle">1/2</p>\n        <p class="CDB-Text LayerOnboarding-headerText">'+
((__t=( _t('style-onboarding.style.title')))==null?'':_.escape(__t))+
'</p>\n        <p class="CDB-Text LayerOnboarding-description LayerOnboarding-description--style">\n          '+
((__t=( _t('style-onboarding.style.short-description')))==null?'':_.escape(__t))+
'\n        </p>\n      </div>\n\n      <div class="LayerOnboarding-step is-step2">\n        <p class="CDB-Text LayerOnboarding-headerTitle">2/2</p>\n        <p class="CDB-Text LayerOnboarding-headerText">'+
((__t=( _t('style-onboarding.cartocss.title')))==null?'':_.escape(__t))+
'</p>\n        <p class="CDB-Text LayerOnboarding-description">\n          '+
((__t=( _t('style-onboarding.cartocss.description')))==null?'':_.escape(__t))+
'\n        </p>\n      </div>\n\n      <div class="LayerOnboarding-footer is-step1">\n        <div class="LayerOnboarding-footerButtons">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--white CDB-Button--big Onboarding-footer--marginRight js-close">\n            <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('style-onboarding.exit')))==null?'':_.escape(__t))+
'</span>\n          </button>\n\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-next">\n            <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('style-onboarding.next')))==null?'':_.escape(__t))+
'</span>\n          </button>\n        </div>\n      </div>\n\n      <div class="LayerOnboarding-footer is-step2">\n        <div class="LayerOnboarding-footerButtons">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-close">\n            <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('style-onboarding.style-layer')))==null?'':_.escape(__t))+
'</span>\n          </button>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class="LayerOnboarding-padBottom"></div>\n</div>\n\n<div class="LayerOnboarding-contentWrapper is-step0 js-step">\n  <div class="LayerOnboarding-contentBody is-step0 js-step">\n    <div class="LayerOnboarding-header is-step0">\n      <p class="CDB-Text LayerOnboarding-headerTitle">'+
((__t=( _t('style-onboarding.title')))==null?'':_.escape(__t))+
'</p>\n\n      <p class="CDB-Text LayerOnboarding-description">\n        '+
((__t=( _t('style-onboarding.description')))==null?'':_.escape(__t))+
'\n      </p>\n    </div>\n\n    <div class="LayerOnboarding-footer is-step0">\n      <div class="LayerOnboarding-footerButtons">\n        <button class="CDB-Button CDB-Button--secondary CDB-Button--white CDB-Button--big Onboarding-footer--marginRight js-start">\n          <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('style-onboarding.take-tour')))==null?'':_.escape(__t))+
'</span>\n        </button>\n\n        <button class="CDB-Button CDB-Button--primary CDB-Button--big js-close">\n          <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('style-onboarding.style-layer')))==null?'':_.escape(__t))+
'</span>\n        </button>\n      </div>\n\n      <div class="u-iBlock is-step1">\n        <input class="CDB-Checkbox js-forget" type="checkbox" id="forget-me" name="forget-me" value="true">\n        <span class="u-iBlock CDB-Checkbox-face"></span>\n        <label for="forget-me" class="BuilderOnboarding-forgetLabel Checkbox-label CDB-Text CDB-Size-small u-whiteTextColor is-light u-lSpace">'+
((__t=( _t('style-onboarding.never-show-message') ))==null?'':_.escape(__t))+
'</label>\n      </div>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],510:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="LayerOnboarding-toolbarOverlay"></div>\n\n<div class="LayerOnboarding-pads LayerOnboarding-pads--left">\n  <div class="LayerOnboarding-padTop"></div>\n  <div class="LayerOnboarding-padMiddle js-highlight">\n    <div class="LayerOnboarding-body is-step0 js-step">\n      <div class="LayerOnboarding-step is-step1">\n        <p class="CDB-Text LayerOnboarding-headerTitle">1/3</p>\n        <p class="CDB-Text LayerOnboarding-headerText">'+
((__t=( _t('style-onboarding.aggregation.title')))==null?'':_.escape(__t))+
'</p>\n        <p class="CDB-Text LayerOnboarding-description">\n          '+
((__t=( _t('style-onboarding.aggregation.description')))==null?'':_.escape(__t))+
'\n        </p>\n      </div>\n      <div class="LayerOnboarding-step is-step2">\n        <p class="CDB-Text LayerOnboarding-headerTitle">2/3</p>\n        <p class="CDB-Text LayerOnboarding-headerText">'+
((__t=( _t('style-onboarding.style.title')))==null?'':_.escape(__t))+
'</p>\n        <p class="CDB-Text LayerOnboarding-description LayerOnboarding-description--style">\n          '+
((__t=( _t('style-onboarding.style.description')))==null?'':_.escape(__t))+
'\n        </p>\n      </div>\n\n      <div class="LayerOnboarding-step is-step3">\n        <p class="CDB-Text LayerOnboarding-headerTitle">3/3</p>\n        <p class="CDB-Text LayerOnboarding-headerText">'+
((__t=( _t('style-onboarding.cartocss.title')))==null?'':_.escape(__t))+
'</p>\n        <p class="CDB-Text LayerOnboarding-description">\n          '+
((__t=( _t('style-onboarding.cartocss.description')))==null?'':_.escape(__t))+
'\n        </p>\n      </div>\n\n      <div class="LayerOnboarding-footer is-step1 is-step2">\n        <div class="LayerOnboarding-footerButtons">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--white CDB-Button--big Onboarding-footer--marginRight js-close">\n            <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('style-onboarding.exit')))==null?'':_.escape(__t))+
'</span>\n          </button>\n\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-next">\n            <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('style-onboarding.next')))==null?'':_.escape(__t))+
'</span>\n          </button>\n        </div>\n      </div>\n\n      <div class="LayerOnboarding-footer is-step3">\n        <div class="LayerOnboarding-footerButtons">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-close">\n            <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('style-onboarding.style-layer')))==null?'':_.escape(__t))+
'</span>\n          </button>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class="LayerOnboarding-padBottom"></div>\n</div>\n\n<div class="LayerOnboarding-contentWrapper is-step0 js-step">\n  <div class="LayerOnboarding-contentBody is-step0 js-step">\n    <div class="LayerOnboarding-header is-step0">\n      <p class="CDB-Text LayerOnboarding-headerTitle">'+
((__t=( _t('style-onboarding.title')))==null?'':_.escape(__t))+
'</p>\n\n      <p class="CDB-Text LayerOnboarding-description">\n        '+
((__t=( _t('style-onboarding.description')))==null?'':_.escape(__t))+
'\n      </p>\n    </div>\n\n    <div class="LayerOnboarding-footer is-step0">\n      <div class="LayerOnboarding-footerButtons">\n        <button class="CDB-Button CDB-Button--secondary CDB-Button--white CDB-Button--big Onboarding-footer--marginRight js-start">\n          <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('style-onboarding.take-tour')))==null?'':_.escape(__t))+
'</span>\n        </button>\n\n        <button class="CDB-Button CDB-Button--primary CDB-Button--big js-close">\n          <span class="CDB-Button-Text CDB-Text u-upperCase is-semibold CDB-Size-medium">'+
((__t=( _t('style-onboarding.style-layer')))==null?'':_.escape(__t))+
'</span>\n        </button>\n      </div>\n\n      <div class="u-iBlock is-step1">\n        <input class="CDB-Checkbox js-forget" type="checkbox" id="forget-me" name="forget-me" value="true">\n        <span class="u-iBlock CDB-Checkbox-face"></span>\n        <label for="forget-me" class="BuilderOnboarding-forgetLabel Checkbox-label CDB-Text CDB-Size-small u-whiteTextColor is-light u-lSpace">'+
((__t=( _t('style-onboarding.never-show-message') ))==null?'':_.escape(__t))+
'</label>\n      </div>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],511:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');

/**
 * View model of a onboarding
 */
module.exports = Backbone.Model.extend({

  defaults: {
    show: true,
    createContentView: function () {
      return new CoreView();
    },
    getContentClasses: function () {
      return null;
    }
  },

  createContentView: function () {
    return this.get('createContentView')(this);
  },

  getContentClasses: function () {
    return this.get('contentClasses');
  },

  show: function () {
    this.set('show', true);
  },

  hide: function () {
    this.set('show', false);
  },

  isHidden: function () {
    return !this.get('show');
  },

  /**
   * @override {Backbone.Model.prototype.destroy}
   */
  destroy: function () {
    var args = Array.prototype.slice.call(arguments);
    this.trigger.apply(this, ['destroy'].concat(args));
  }
});

},{"backbone":"backbone","backbone/core-view":1127}],512:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./onboarding.tpl');

// Ought to match the duration of the .Dialog.is-closing animation.
var CLOSE_DELAY_MS = 120;

module.exports = CoreView.extend({
  className: 'Onboarding is-opening',

  initialize: function () {
    this.listenTo(this.model, 'change:show', this._onShowChange);
    this.listenTo(this.model, 'destroy', this._onDestroy);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());

    var view = this.model.createContentView();
    this.$el.addClass(this.model.getContentClasses());
    this.addView(view);

    view.bind('customEvent', this._onCustomEvent, this);
    view.bind('close', this._onClose, this);

    view.render();
    this.$('.js-content').append(view.el);

    return this;
  },

  show: function () {
    this.model.show();
  },

  hide: function () {
    this.model.hide();
  },

  destroy: function () {
    // 'remove' would be a better name ofc, but there is already an internal method with that name in CoreView
    this.model.destroy();
  },

  _onShowChange: function (m, show) {
    if (show) {
      this.$el.show();
      this.$el.removeClass('is-closing').addClass('is-opening');
    } else {
      this.$el.removeClass('is-opening').addClass('is-closing');
      this._delayDueToAnimation(function () {
        this.$el.hide();
      });
    }
  },

  _onClose: function () {
    this.destroy();
  },

  _onCustomEvent: function (customEventName) {
    this.destroy();
    this.trigger('customEvent', customEventName, this);
  },

  _onDestroy: function () {
    this.hide();
    _.invoke(this._subviews, 'allOff');
    this._delayDueToAnimation(function () {
      this.clean();
    });
  },

  _delayDueToAnimation: function (fn) {
    setTimeout(fn.bind(this), CLOSE_DELAY_MS);
  }
});

},{"./onboarding.tpl":513,"backbone/core-view":1127,"underscore":"underscore"}],513:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Onboarding js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],514:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var OnboardingView = require('./onboarding-view');
var OnboardingViewModel = require('./onboarding-view-model');

var DESTROYED_ONBOARDING_EVENT = 'destroyedOnboarding';

/**
 * Top-level API to handle onboardings.
 * Is intended to be instantiated and registered in some top-level namespace to be accessibel within the lifecycle of
 * an client-side application.
 *
 * Example:
 * // In some entry-point:
 * cdb.onboardings = new OnboardingsServiceModel();
 *
 * // Later, in any view, calling create will create a new onboarding viewModel
 * var onboardingView = cdb.onboardings.create(fn)
 *
 * You will probably see the name of "Onboarding" here and there, it's the old nomenclature for the concept of Onboarding.
 */
module.exports = Backbone.Model.extend({

  /**
   * Creates a new onboarding view
   *
   * @param {Function} createContentView
   * @return {View} the new onboarding view
   */
  create: function (createContentView, contentClasses) {
    if (!_.isFunction(createContentView)) throw new Error('createContentView is required');

    if (!this._onboardingView) {
      this.trigger('willCreateOnboarding');
      this._onboardingView = this._newOnboardingView();
      this.trigger('didCreateOnboarding', this._onboardingView);
      document.body.appendChild(this._onboardingView.el);
    }

    this._onboardingView.model.set('createContentView', createContentView);
    this._onboardingView.model.set('contentClasses', contentClasses);
    this._onboardingView.render();

    return this._onboardingView;
  },

  /**
   * Convenience method to add a listener when current onboarding is destroyed
   *
   * This is the same as doing
   * onboardings.create(function (model) {
   *   model.once('destroy', callback, context); // <-- same as onboardings.onDestroyOnce(callback, context);
   *   return new MyView({ … });
   * });
   *
   * @param {Function} callback
   * @param {Object} [context = undefined]
   */
  onDestroyOnce: function (callback, context) {
    this.once(DESTROYED_ONBOARDING_EVENT, callback, context);
  },

  destroy: function () {
    if (this._onboardingView) {
      this._onboardingView.model.destroy();
    }
  },

  _newOnboardingView: function () {
    var viewModel = new OnboardingViewModel();
    this._handleBodyClass(viewModel);
    this._destroyOnEsc(viewModel);

    this.listenToOnce(viewModel, 'destroy', function () {
      this._onboardingView = null;
      this.trigger.apply(this, [DESTROYED_ONBOARDING_EVENT].concat(Array.prototype.slice.call(arguments)));
      this.stopListening(viewModel);
    });

    var onboardingView = new OnboardingView({
      model: viewModel
    });

    onboardingView.bind('customEvent', function (eventName) {
      this.trigger(eventName);
    }, this);

    return onboardingView;
  },

  _destroyOnEsc: function (viewModel) {
    var destroyOnEsc = function (ev) {
      if (ev.keyCode === 27) {
        viewModel.destroy();
      }
    };
    document.addEventListener('keydown', destroyOnEsc);
    this.listenToOnce(viewModel, 'destroy', function () {
      document.removeEventListener('keydown', destroyOnEsc);
    });
  },

  /**
   * TL;DR this method manages document.body class state, to enable scroll inside of an open onboarding.
   *
   * Some onboarding content have too much content that can be displayed in the viewport the scroll needs to be enabled.
   * Since the onboarding is implemented as a fixed positioned element the body needs to be fixated too, for the scroll to
   * be enabled inside the onboarding instead.
   */
  _handleBodyClass: function (viewModel) {
    var bodyClass = 'is-inDialog';
    document.body.classList.add(bodyClass);

    this.listenTo(viewModel, 'change:show', function (m, show) {
      document.body.classList[show ? 'add' : 'remove'](bodyClass);
    });

    this.listenToOnce(viewModel, 'destroy', function () {
      document.body.classList.remove(bodyClass);
    });
  }

});


},{"./onboarding-view":512,"./onboarding-view-model":511,"backbone":"backbone","underscore":"underscore"}],515:[function(require,module,exports){
var Backbone = require('backbone');

/**
 * Model representing the query string params for a "paged search" of a collection (matching the server-side APIs).
 *
 * @example usage
 *   pagedSearch = new PaginationSearchModel({ … })
 *   pagedSearch.fetch(collection) // => jqXHR, GET /collection/123?page=1&per_page20
 *   pagedSearch.set({ page: 2, per_page: 10, q: 'test' });
 *   pagedSearch.fetch(collection) // => GET /collection/123?page=2&per_page10&q=test
 */
module.exports = Backbone.Model.extend({

  defaults: {
    per_page: 20,
    page: 1,
    q: ''
  },

  initialize: function (attrs, opts) {
    if (!opts.collection) throw new Error('collection is required');
    if (!opts.collection.totalCount) throw new Error('collection requires to implement totalCount method');

    this.collection = opts.collection;
    this._initBinds();
  },

  _initBinds: function () {
    this.collection.on('sync', this._updateStateFetched, this);
    this.collection.on('error', this._updateStateError, this);
  },

  fetch: function () {
    this.trigger('fetching', this);
    return this.collection.fetch({
      data: this.attributes
    }, {reset: true});
  },

  _updateStateFetched: function () {
    this.trigger('fetched', this);
  },

  _updateStateError: function () {
    this.trigger('error', this);
  }
});

},{"backbone":"backbone"}],516:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var PaginationModel = require('../pagination/pagination-model');
var PaginationSearchModel = require('./pagination-search-model');
var renderLoading = require('../loading/render-loading');
var renderNoResults = require('../no-results/render-no-results');
var ErrorView = require('../error/error-view');
var template = require('./pagination-search.tpl');
var Utils = require('../../helpers/utils');
var PaginationView = require('../pagination/pagination-view');
var paginationTemplate = require('./pagination.tpl');

/**
 * View to render a searchable/pageable collection.
 * Also allows to filter/search list.
 *
 */

var REQUIRED_OPTS = [
  'listCollection',
  'createContentView'
];

var ENTER_KEY_CODE = 13;
var ESCAPE_KEY_CODE = 27;

module.exports = CoreView.extend({

  events: {
    'click .js-search-link': '_onSearchClick',
    'click .js-clean-search': '_onCleanSearchClick',
    'keydown .js-search-input': '_onKeyDown'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this._paginationModel = new PaginationModel({
      current_page: 1
    });

    this._paginationSearchModel = new PaginationSearchModel({}, {
      collection: this._listCollection
    });

    this._stateModel = new Backbone.Model({
      state: 'idle'
    });

    this._initBinds();
    this._initPagination();
    this._paginationSearchModel.fetch();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template({
      q: this._paginationSearchModel.get('q')
    }));
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this._paginationSearchModel.on('fetching', this.showLoading, this);
    this._paginationSearchModel.on('fetched', this._updateStateFetched, this);
    this._paginationSearchModel.on('error', this.showError, this);

    this._paginationModel.bind('change:current_page', this._fetchByPagination, this);

    this._stateModel.on('change:state', this.render, this);

    this.add_related_model(this._paginationModel);
    this.add_related_model(this._stateModel);
    this.add_related_model(this._stateModel);
  },

  _fetchByPagination: function () {
    this._paginationSearchModel.set('page', this._paginationModel.get('current_page'));
    this._paginationSearchModel.fetch();
  },

  showError: function () {
    this._stateModel.set('state', 'error');
  },

  showLoading: function () {
    this._stateModel.set('state', 'loading');
  },

  _updateStateFetched: function () {
    this._paginationModel.set({
      per_page: this._paginationSearchModel.get('per_page'),
      total_count: this._listCollection.totalCount()
    });
    if (this._listCollection.length > 0) {
      this._stateModel.set('state', 'show');
    } else {
      this._stateModel.set('state', 'no-results');
    }
  },

  _initPagination: function () {
    this._paginationView = new PaginationView({
      className: 'Pagination Pagination--search Pagination--searchShare',
      model: this._paginationModel,
      template: paginationTemplate
    });
    this.addView(this._paginationView);
  },

  _initViews: function () {
    var state = this._stateModel.get('state');
    var view;

    this.$el.append(this._paginationView.render().el);

    if (state === 'loading') {
      this._content().html(renderLoading({
        title: _t('components.pagination-search.loading.title')
      }));
    }

    if (state === 'error') {
      var errorView = new ErrorView({
        title: _t('components.pagination-search.error.title'),
        desc: _t('components.pagination-search.error.desc')
      });
      this._content().html(errorView.render().el);
      this.addView(errorView);
    }

    if (state === 'show') {
      view = this._createContentView({
        hasOrganization: this._paginationSearchModel.get('q') === ''
      });
      this._content().html(view.render().el);
      this.addView(view);
    }

    if (state === 'no-results') {
      this._content().html(renderNoResults({
        icon: 'CDB-IconFont-defaultUser',
        title: _t('components.pagination-search.no-results.title'),
        desc: _t('components.pagination-search.no-results.desc')
      }));
    }
  },

  _focusSearchInput: function () {
    this._searchInput().focus().val();
  },

  _onSearchClick: function (e) {
    this.killEvent(e);
    this._searchInput().focus();
  },

  _onCleanSearchClick: function (e) {
    this.killEvent(e);
    this._cleanSearch();
  },

  _onKeyDown: function (e) {
    if (e.which === ENTER_KEY_CODE) {
      this.killEvent(e);
      this._submitSearch();
    } else if (e.which === ESCAPE_KEY_CODE) {
      if (this._paginationSearchModel.get('q')) {
        this.killEvent(e);
        this._cleanSearch();
      }
    }
  },

  _submitSearch: function (e) {
    this._makeNewSearch(Utils.stripHTML(this._searchInput().val().trim()));
  },

  _cleanSearch: function () {
    this._searchInput().val('');
    this._makeNewSearch('');
  },

  _makeNewSearch: function (query) {
    this._paginationSearchModel.set({
      q: query,
      page: 1
    });

    this._paginationSearchModel.fetch();
  },

  _searchInput: function () {
    return this.$('.js-search-input');
  },

  _cleanSearchBtn: function () {
    return this.$('.js-clean-search');
  },

  _content: function () {
    return this.$('.js-content');
  }

});

},{"../../helpers/utils":1102,"../error/error-view":67,"../loading/render-loading":230,"../no-results/render-no-results":466,"../pagination/pagination-model":519,"../pagination/pagination-view":520,"./pagination-search-model":515,"./pagination-search.tpl":517,"./pagination.tpl":518,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],517:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Filters is-relative">\n  <div class="Filters-inner">\n    <div class="Filters-row Share-filtersRow js-filters">\n      <div class="Filters-typeItem Filters-typeItem--searchEnabler">\n        <p class="Filters-searchLink js-search-link u-alignCenter CDB-Text CDB-Size-medium u-upperCase">\n          <i class="Filters-searchLinkIcon CDB-IconFont CDB-IconFont-lens u-rSpace--xl"></i> '+
((__t=( _t('components.pagination-search.filter.search') ))==null?'':_.escape(__t))+
'\n        </p>\n      </div>\n      <div class="Filters-typeItem Filters-typeItem--searchField">\n        <input class="Filters-searchInput CDB-Text CDB-Size-medium js-search-input" type="text" value="'+
((__t=( q ))==null?'':_.escape(__t))+
'" placeholder="'+
((__t=( _t('components.pagination-search.filter.placeholder') ))==null?'':_.escape(__t))+
'" />\n        ';
 if (q !== '') { 
__p+='\n        <button type="button" class="CDB-Shape Filters-cleanSearch js-clean-search u-actionTextColor">\n          <div class="CDB-Shape-close is-blue is-large"></div>\n        </button>\n        ';
 } 
__p+='\n      </div>\n    </div>\n  </div>\n</div>\n<div class="js-content"></div>';
}
return __p;
};

},{"underscore":"underscore"}],518:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<span class="CDB-Text CDB-Size-medium u-altTextColor Pagination-label">\n  Page '+
((__t=( currentPage ))==null?'':_.escape(__t))+
' of '+
((__t=( pagesCount ))==null?'':_.escape(__t))+
'\n</span>\n<ul class="Pagination-list CDB-Text CDB-Size-medium">\n  ';
 m.pagesToDisplay().forEach(function(page) { 
__p+='\n    ';
 if (page > 0) { 
__p+='\n      <li class="Pagination-listItem '+
((__t=( m.isCurrentPage(page) ? 'is-current' : '' ))==null?'':_.escape(__t))+
'">\n        <button class="Pagination-listItemInner Pagination-listItemInner--link u-actionTextColor js-listItem" data-page="'+
((__t=( page ))==null?'':_.escape(__t))+
'">'+
((__t=( page ))==null?'':_.escape(__t))+
'</button>\n      </li>\n    ';
 } else { 
__p+='\n      <li class="Pagination-listItem Pagination-listItem">\n        <span class="Pagination-listItemInner Pagination-listItemInner--more">&hellip;</span>\n      </li>\n    ';
 } 
__p+='\n  ';
 }) 
__p+='\n</ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],519:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

/**
 * View model intended to be responsible for pagination logic, and to be used in conjunction with a Pagination view.
 */
module.exports = Backbone.Model.extend({
  defaults: {
    total_count: 0,
    per_page: 10,
    current_page: 1,
    display_count: 5,
    extras_display_count: 1,
    url_to: undefined
  },

  pagesCount: function () {
    return Math.max(
      Math.ceil(
        this.get('total_count') / this.get('per_page')
      ), 1);
  },

  isCurrentPage: function (page) {
    return this.get('current_page') === page;
  },

  shouldBeVisible: function () {
    var pagesCount = this.pagesCount();
    return this.get('total_count') > 0 && pagesCount > 1 && this.get('current_page') <= pagesCount;
  },

  urlTo: function (page) {
    if (this.hasUrl()) {
      return this.get('url_to')(page);
    }
  },

  hasUrl: function () {
    return typeof this.get('url_to') === 'function';
  },

  /**
   * Get the pages that are expected to be displayed.
   * The current page will be in the middle of the returned sequence.
   *
   * @returns {number[]} a sequence of Numbers
   */
  pagesToDisplay: function () {
    var rangeStart;

    if (this._inLowRange()) {
      rangeStart = 1;
    } else if (this._inHighRange()) {
      rangeStart = this.get('current_page') - this._startOffset();
    } else {
      // Somewhere between the low and high boundary
      rangeStart = this.pagesCount() - this.get('display_count') + 1;
    }
    rangeStart = Math.max(rangeStart, 1);

    return this._withExtraPages(
      _.range(rangeStart, this._rangeEnd(rangeStart))
    );
  },

  _withExtraPages: function (pagesRelativeToCurrentPage) {
    var lastPage = this.pagesCount();
    var extraCount = this.get('extras_display_count');
    var extraStartPages = _.range(1, extraCount + 1);
    var extraEndPages = _.range(lastPage - extraCount + 1, lastPage + 1);

    var startPagesDiff = pagesRelativeToCurrentPage[0] - extraStartPages.slice(-1)[0];
    if (startPagesDiff === 2) {
      // There is only one missing page in the gap, so add it
      extraStartPages.push(pagesRelativeToCurrentPage[0] - 1);
    } else if (startPagesDiff > 2) {
      // There are more hidden pages at low range, add padding at end
      extraStartPages.push(-1);
    }

    var endPagesDiff = extraEndPages[0] - pagesRelativeToCurrentPage.slice(-1);
    if (endPagesDiff === 2) {
      // There is only one missing page in the gap, so add it
      extraEndPages.unshift(extraEndPages[0] - 1);
    } if (endPagesDiff > 2) {
      // There are more hidden pages at high range, add padding at beginning
      extraEndPages.unshift(-2);
    }

    return _.union(extraStartPages, pagesRelativeToCurrentPage, extraEndPages);
  },

  _inLowRange: function () {
    return this.get('current_page') < this._startOffset();
  },

  _inHighRange: function () {
    return this.get('current_page') < this._highBoundary();
  },

  _highBoundary: function () {
    return this.pagesCount() - this._startOffset();
  },

  _startOffset: function () {
    return Math.floor(this.get('display_count') / 2);
  },

  _rangeEnd: function (rangeStart) {
    // If we are too close to the range end then cap to the pages count.
    return Math.min(rangeStart + this.get('display_count'), this.pagesCount() + 1);
  }
});

},{"backbone":"backbone","underscore":"underscore"}],520:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var $ = require('jquery');
var navigateThroughRouter = require('../../helpers/navigate-through-router');
var template = require('./pagination.tpl');

/**
 * Responsible for pagination.
 *
 * Expected to be created with a pagination model, see the model for available params, here we create w/ the minimum:
 *   new PaginationView({
 *     model: new PaginationModel({
 *       // Compulsory:
 *       urlTo:  function(page) { return '/?page='+ page },

         // Optional, to router clicks on <a> tags through router.navigate by default
 *       routerModel: new Router(...)
 *     })
 *   });
 */
module.exports = CoreView.extend({
  className: 'Pagination',

  events: {
    'click .js-listItem': '_paginate'
  },

  initialize: function (opts) {
    this._routerModel = opts.routerModel; // Optional

    if (this.router && !this.model.hasUrl()) {
      throw new Error('since router is set the model must have a url method set too');
    }

    this.template = opts.template || template;
    this.model.bind('change', this.render, this);
  },

  render: function () {
    if (this.model.shouldBeVisible()) {
      this.$el.html(
        this.template({
          m: this.model,
          pagesCount: this.model.pagesCount(),
          currentPage: this.model.get('current_page')
        })
      );
      this.$el.addClass(this.className);
      this.delegateEvents();
    } else {
      this.$el.html('');
    }

    return this;
  },

  _paginate: function (ev) {
    if (this._routerModel) {
      navigateThroughRouter.apply(this, arguments);
    } else if (!this.model.hasUrl()) {
      this.killEvent(ev);
    }

    var page = $(ev.target).data('page');
    this.model.set('current_page', page);
  }
});

},{"../../helpers/navigate-through-router":1094,"./pagination.tpl":521,"backbone/core-view":1127,"jquery":"jquery"}],521:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<span class="CDB-Text CDB-Size-medium u-altTextColor Pagination-label">\n  Page '+
((__t=( currentPage ))==null?'':_.escape(__t))+
' of '+
((__t=( pagesCount ))==null?'':_.escape(__t))+
'\n</span>\n<ul class="Pagination-list CDB-Text CDB-Size-medium">\n  ';
 m.pagesToDisplay().forEach(function(page) { 
__p+='\n    ';
 if (page > 0) { 
__p+='\n      <li class="Pagination-listItem '+
((__t=( m.isCurrentPage(page) ? 'is-current' : '' ))==null?'':_.escape(__t))+
'">\n        <a class="Pagination-listItemInner Pagination-listItemInner--link js-listItem" href="'+
((__t=( m.urlTo(page) ))==null?'':_.escape(__t))+
'" data-page="'+
((__t=( page ))==null?'':_.escape(__t))+
'">'+
((__t=( page ))==null?'':_.escape(__t))+
'</a>\n      </li>\n    ';
 } else { 
__p+='\n      <li class="Pagination-listItem Pagination-listItem">\n        <span class="Pagination-listItemInner Pagination-listItemInner--more">&hellip;</span>\n      </li>\n    ';
 } 
__p+='\n  ';
 }) 
__p+='\n</ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],522:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');

var MutationObserver = window.MutationObserver;

var MARGINS = {
  top: 8,
  bottom: 8
};

var initObserver = function (popup, onChangeMutation) {
  var config = {
    childList: true,
    subtree: true
  };

  if (!MutationObserver) {
    return;
  }

  var observer = new MutationObserver(onChangeMutation);
  observer.observe(popup.get ? popup.get(0) : popup, config);
  return observer;
};

var initScroll = function (reference) {
  return reference.closest('.js-perfect-scroll');
};

var Manager = function (id, reference, popup) {
  this.id = id;
  this.reference = reference;
  this.popup = popup;
  this.state = {
    position: 'bottom',
    scroll: 0
  };

  // to capture click events and avoid close the dialog
  popup.attr('data-cid', id);
  popup.attr('data-dialog', id);
};

Manager.prototype = {
  append: function (mode) {
    this.mode = mode;
    var popup = this.popup.get(0);
    var ref = this.reference.get(0);
    if (mode === 'float') {
      document.body.appendChild(popup);
    } else {
      ref.appendChild(popup);
    }
  },

  track: function () {
    if (this.mode !== 'float') {
      return;
    }

    // we need to watch when the dialog's height changes in order to reposition it again
    this.observer = initObserver(this.popup, this.onChangeMutation.bind(this));
    this.emitter = initScroll(this.reference);
    this.repositionBinded = _.throttle(this.reposition.bind(this), 15);

    if (this.emitter) {
      this.emitter
        .on('ps-scroll-x', this.repositionBinded)
        .on('ps-scroll-y', this.repositionBinded);
    }

    this.reposition();
  },

  onChangeMutation: function (mutations) {
    _.each(mutations, function (mutation) {
      var target = $(mutation.target);
      var id = target.attr('data-cid');

      if (!id) {
        id = target.closest('[data-cid]').attr('data-cid');
      }

      if (id === this.id) {
        this.repositionBinded();
      }
    }, this);
  },

  reposition: function () {
    if (this.mode !== 'float' || !this.emitter) {
      return;
    }

    var scroll = this.emitter.get(0).scrollTop;

    var dh = $(window).height();
    var ref = this.reference;
    var popup = this.popup;
    var state = this.state;

    var refPosition = ref.offset();
    var ph = popup.outerHeight();

    var onBottom = refPosition.top + ref.outerHeight() + MARGINS.top;
    var onTop = refPosition.top - ph - MARGINS.bottom;
    var top;

    // If this condition matches, the dialog has changed its size
    if (state.scroll === scroll) {
      // We maintain position unless there is no space
      if (state.position === 'top') {
        if (onTop <= 0) {
          top = onBottom;
          state.position = 'bottom';
        } else {
          top = onTop;
        }
      } else {
        if (onBottom + ph + MARGINS.bottom >= dh) {
          top = onTop;
          state.position = 'top';
        } else {
          top = onBottom;
        }
      }
    } else {
      if (onBottom + ph + MARGINS.bottom >= dh) {
        top = onTop;
        state.position = 'top';
      } else {
        top = onBottom;
        state.position = 'bottom';
      }
    }

    // Boundries come from document height to avoid scroll
    if (top < 0) {
      top = MARGINS.top;
    } else {
      top = Math.min(top, dh - ph - MARGINS.bottom);
    }

    popup.css({
      top: top,
      left: refPosition.left
    });

    state.scroll = scroll;
  },

  untrack: function () {
    this.observer && this.observer.disconnect();
    if (this.emitter) {
      this.emitter
        .off('ps-scroll-x', this.repositionBinded)
        .off('ps-scroll-y', this.repositionBinded);
    }
  },

  destroy: function () {
    this.untrack();

    var el = document.querySelector('[data-dialog=' + this.id + ']');
    if (el) {
      el.parentNode.removeChild(el);
    }

    this.emitter = null;
    this.reference = null;
    this.popup = null;
  }
};

module.exports = Manager;

},{"jquery":"jquery","underscore":"underscore"}],523:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./password-dialog.tpl');
var _ = require('underscore');

var REQUIRED_OPTS = [
  'onBack',
  'onEdit'
];

var ESCAPE_KEY_CODE = 27;
var ENTER_KEY_CODE = 13;

module.exports = CoreView.extend({
  className: 'Editor-boxModal Editor-PrivacyDialog',

  events: {
    'click .js-back': '_onClickBack',
    'keyup .js-input': '_onKeyUpInput'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);
  },

  render: function () {
    this.$el.empty();
    this.$el.html(template());
    return this;
  },

  _onKeyUpInput: function (e) {
    if (e.which === ESCAPE_KEY_CODE) {
      this._onBack();
    }

    if (e.which === ENTER_KEY_CODE) {
      this._onEdit && this._onEdit(this.getValue());
    }
  },

  _onClickBack: function () {
    this._onBack();
  },

  getValue: function () {
    return this.$('.js-input').val();
  }
});

},{"./password-dialog.tpl":524,"backbone/core-view":1127,"underscore":"underscore"}],524:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeader">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical">\n      <button class="u-actionTextColor js-back CDB-Size-medium u-rSpace">\n        <i class="CDB-IconFont CDB-IconFont-arrowPrev"></i>\n      </button>\n      <span class="CDB-Text CDB-Size-medium">\n        '+
((__t=( _t('components.modals.publish.privacy.password.title') ))==null?'':_.escape(__t))+
'\n      </span>\n    </li>\n  </ul>\n</div>\n<ul class="CustomList-list js-customList">\n  <li class="Privacy-passwordField CustomList-item">\n    <input type="password" class="CDB-Text CDB-InputText js-input" placeholder="'+
((__t=( _t('components.modals.publish.privacy.password.placeholder') ))==null?'':_.escape(__t))+
'">\n  </li>\n</ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],525:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Privacy-cta u-flex">\n  <svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n      <path d="M10.0946667,4.4109223 C10.8886667,4.1368747 11.6846667,3.80147316 12.0073333,3.4715253 C12.7866667,2.67392407 12.7866667,1.37662907 12.0073333,0.579027844 C11.2513333,-0.193350099 9.934,-0.192668389 9.17866667,0.579027844 C8.74133333,1.0262299 8.29266667,2.36033726 8,3.37608583 C7.70666667,2.36033726 7.25866667,1.0262299 6.82133333,0.579027844 C6.066,-0.193350099 4.748,-0.192668389 3.99266667,0.579027844 C3.21266667,1.37662907 3.21266667,2.67392407 3.99266667,3.4715253 C4.316,3.80147316 5.11133333,4.1368747 5.90533333,4.4109223 L0.333333333,4.4109223 C0.149333333,4.4109223 0,4.56362544 0,4.75177753 L0,7.47861934 C0,7.66677142 0.149333333,7.81947456 0.333333333,7.81947456 L0.666666667,7.81947456 L0.666666667,15.6591448 C0.666666667,15.8472969 0.816,16 1,16 L15,16 C15.184,16 15.3333333,15.8472969 15.3333333,15.6591448 L15.3333333,7.81947456 L15.6666667,7.81947456 C15.8506667,7.81947456 16,7.66677142 16,7.47861934 L16,4.75177753 C16,4.56362544 15.8506667,4.4109223 15.6666667,4.4109223 L10.0946667,4.4109223 Z M6,6.95652174 L6,4.86956522 L10,4.86956522 L10,6.95652174 L6,6.95652174 L6,6.95652174 Z M10,7.65217391 L10,15.3043478 L6,15.3043478 L6,7.65217391 L10,7.65217391 L10,7.65217391 Z M9.80833133,1.08822938 C10.0510474,0.834996985 10.3727426,0.695652174 10.7169115,0.695652174 C11.0597961,0.695652174 11.3821334,0.834996985 11.6248495,1.08755946 C12.1250502,1.6101025 12.1250502,2.46023983 11.6248495,2.98278288 C11.2729754,3.34990286 9.79227867,3.85636766 8.66666667,4.17391304 C8.97102496,2.99953105 9.45581507,1.45534937 9.80833133,1.08822938 L9.80833133,1.08822938 Z M4.37515049,1.08822938 C4.6178666,0.834996985 4.94020387,0.695652174 5.28373064,0.695652174 C5.6266153,0.695652174 5.94895256,0.834996985 6.19166867,1.08755946 C6.54354282,1.45467944 7.02833293,2.99886112 7.33333333,4.17391304 C6.20707922,3.85569773 4.72638253,3.34990286 4.37515049,2.98278288 C3.87494984,2.46090976 3.87494984,1.61077243 4.37515049,1.08822938 L4.37515049,1.08822938 Z M0.666666667,4.86956522 L5.33333333,4.86956522 L5.33333333,6.95652174 L1,6.95652174 L0.666666667,6.95652174 L0.666666667,4.86956522 L0.666666667,4.86956522 Z M1.33333333,7.65217391 L5.33333333,7.65217391 L5.33333333,15.3043478 L1.33333333,15.3043478 L1.33333333,7.65217391 L1.33333333,7.65217391 Z M14.6666667,15.3043478 L10.6666667,15.3043478 L10.6666667,7.65217391 L14.6666667,7.65217391 L14.6666667,15.3043478 L14.6666667,15.3043478 Z M15.3333333,6.95652174 L15,6.95652174 L10.6666667,6.95652174 L10.6666667,4.86956522 L15.3333333,4.86956522 L15.3333333,6.95652174 L15.3333333,6.95652174 Z" id="Shape" fill="#9BC63B"></path>\n    </g>\n  </svg>\n  <div class="CDB-Text CDB-Size CDB-Size-small u-lSpace--xl">\n    <h3 class="u-secondaryTextColor">'+
((__t=( _t('components.modals.publish.privacy.cta.title') ))==null?'':_.escape(__t))+
'</h3>\n    <a href="'+
((__t=( upgradeURL ))==null?'':_.escape(__t))+
'">\n      '+
((__t=( _t( 'components.modals.publish.privacy.cta.desc-' + (showTrial ? 'trial' : 'notrial') ) ))==null?'':_.escape(__t))+
'\n    </a>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],526:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var CustomListView = require('../custom-list/custom-list-view');
var CustomListItemView = require('../custom-list/custom-list-item-view');
var privacyCTATemplate = require('./privacy-cta.tpl');
var _ = require('underscore');

var REQUIRED_OPTS = [
  'model',
  'collection',
  'userModel',
  'configModel'
];

module.exports = CoreView.extend({
  className: 'Editor-boxModal Privacy-dialog',

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);
  },

  render: function () {
    this.$el.empty();
    this.clearSubViews();
    this._renderList();
    return this;
  },

  _renderList: function () {
    var disabledOptions = this._collection.where({ disabled: true });
    var customInstall = this._configModel.get('cartodb_com_hosted');
    var upgradeURL = this._configModel.get('upgrade_url');

    var listView = new CustomListView({
      model: this._model,
      collection: this._collection,
      ItemView: CustomListItemView
    });
    this.$el.append(listView.render().el);
    this.addView(listView);

    if (disabledOptions.length > 0 && !customInstall && upgradeURL) {
      this.$el.append(
        privacyCTATemplate({
          upgradeURL: upgradeURL,
          showTrial: this._userModel.canStartTrial()
        })
      );
    }
  }
});

},{"../custom-list/custom-list-item-view":50,"../custom-list/custom-list-view":57,"./privacy-cta.tpl":525,"backbone/core-view":1127,"underscore":"underscore"}],527:[function(require,module,exports){
var $ = require('jquery');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var PrivacyDialogView = require('./privacy-dialog-view');
var PasswordDialogView = require('./password-dialog-view');
var TabPaneView = require('../tab-pane/tab-pane-view');
var TabPaneCollection = require('../tab-pane/tab-pane-collection');
var CustomListCollection = require('../custom-list/custom-list-collection');
var template = require('./privacy-dropdown.tpl');
var templateTabPane = require('./tab-pane.tpl');

var _ = require('underscore');

var ESCAPE_KEY_CODE = 27;

var REQUIRED_OPTS = [
  'visDefinitionModel',
  'userModel',
  'privacyCollection',
  'configModel'
];

var PRIVACY_MAP = {
  public: 'green',
  link: 'orange',
  password: 'orange-dark',
  private: 'red'
};

module.exports = CoreView.extend({

  events: {
    'click .js-toggle': '_onToggleDialogClicked'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this._triggerElementID = 'toggle' + this.cid;

    this.model = new Backbone.Model({
      privacy: opts.visDefinitionModel.get('privacy'),
      state: 'show'
    });

    this._onEscapePressed = this._onEscapePressed.bind(this);
    this._onDocumentElementClicked = this._onDocumentElementClicked.bind(this);

    this._configPrivacyCollection();
    this._configPanes();
    this._initBinds();
  },

  render: function () {
    var privacy = this.model.get('privacy');
    var cssClass = PRIVACY_MAP[privacy.toLowerCase()];

    this.clearSubViews();
    this._hideDialog();
    this.$el.html(template({
      privacy: privacy,
      cssClass: cssClass,
      isLoading: this.model.get('state') === 'loading'
    }));
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this._customCollection.on('change:selected', function (menuItem) {
      if (menuItem.get('disabled')) {
        return;
      }

      if (menuItem.get('val') === 'password') {
        this._showPasswordDialog();
      } else {
        this._onToggleDialogClicked();
        this._setPrivacy(menuItem.get('val'));
      }
    }, this);

    this.add_related_model(this._customCollection);

    this.model.on('change:privacy', this._savePrivacy, this);
    this.model.on('change:state', this.render, this);
    this.add_related_model(this.model); // explicit
  },

  _makePrivacyDialog: function () {
    return new PrivacyDialogView({
      model: this.model,
      collection: this._customCollection,
      userModel: this._userModel,
      configModel: this._configModel
    });
  },

  _makePasswordDialog: function () {
    return new PasswordDialogView({
      onBack: this._showPrivacyDialog.bind(this),
      onEdit: this._setPassword.bind(this)
    });
  },

  _setPrivacy: function (privacy) {
    this.model.set({privacy: privacy});
  },

  _setPassword: function (password) {
    if (password !== '') {
      this._privacyCollection.passwordOption().set({
        password: password
      });

      this.model.set({
        privacy: 'password',
        password: password
      });
    }
  },

  _savePrivacy: function () {
    var self = this;
    var privacy = this.model.get('privacy').toUpperCase();
    var vis = this._visDefinitionModel;
    this.model.set({state: 'loading'});
    this._privacyCollection.searchByPrivacy(privacy).saveToVis(vis, {
      success: function () {
        self.model.set({state: 'show'});
      },
      error: function () {
        self.model.set({state: 'error'});
      }
    });
  },

  _transformPrivacyOptions: function () {
    return this._privacyCollection.map(function (item) {
      return {
        label: item.get('title'),
        val: item.get('privacy').toLowerCase(),
        disabled: item.get('disabled'),
        selected: item.get('selected'),
        renderOptions: {
          cssClass: item.get('cssClass')
        }
      };
    }).filter(Boolean);
  },

  _configPrivacyCollection: function () {
    var models = this._transformPrivacyOptions();
    this._customCollection = new CustomListCollection(models);
  },

  _configPanes: function () {
    var self = this;
    var tabPaneTabs = [{
      createContentView: self._showNoneDialog
    }, {
      createContentView: self._makePrivacyDialog.bind(self)
    }, {
      createContentView: self._makePasswordDialog.bind(self)
    }];

    this._collectionPane = new TabPaneCollection(tabPaneTabs);
  },

  _showNoneDialog: function () {
    return false;
  },

  _showPasswordDialog: function () {
    this._collectionPane.at(2).set({selected: true});
  },

  _showPrivacyDialog: function () {
    this._customCollection.each(function (m) {
      m.set({selected: false}, {silent: true});
    });

    this._collectionPane.at(1).set({selected: true});
  },

  _onToggleDialogClicked: function () {
    if (this._isDialogVisible()) {
      this._hideDialog();
    } else {
      this._initDocumentBinds();
      this._showPrivacyDialog();
    }
  },

  _isDialogVisible: function () {
    return this._collectionPane.at(0).get('selected') === false;
  },

  _hideDialog: function () {
    this._destroyDocumentBinds();
    this._collectionPane.at(0).set({selected: true});
  },

  _showDialog: function () {
    this._showPrivacyDialog();
  },

  _initViews: function () {
    var view = new TabPaneView({
      collection: this._collectionPane,
      template: templateTabPane
    });
    this.$('.js-dialog').append(view.render().$el);
    this.addView(view);
  },

  _initDocumentBinds: function () {
    $(document).on('keydown', this._onEscapePressed);
    $(document).on('mousedown', this._onDocumentElementClicked);
  },

  _destroyDocumentBinds: function () {
    $(document).off('keydown', this._onEscapePressed);
    $(document).off('mousedown', this._onDocumentElementClicked);
  },

  _onEscapePressed: function (ev) {
    if (ev.which === ESCAPE_KEY_CODE) {
      this._hideDialog();
    }
  },

  _onDocumentElementClicked: function (ev) {
    var $el = $(ev.target);
    if ($el.closest(this.$el).length === 0 && $el.closest($('#' + this._triggerElementID)).length === 0) {
      this._hideDialog();
    }
  },

  clean: function () {
    this._destroyDocumentBinds();
    CoreView.prototype.clean.apply(this);
  }
});

},{"../custom-list/custom-list-collection":47,"../tab-pane/tab-pane-collection":538,"../tab-pane/tab-pane-view":549,"./password-dialog-view":523,"./privacy-dialog-view":526,"./privacy-dropdown.tpl":528,"./tab-pane.tpl":529,"backbone":"backbone","backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],528:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Privacy-dropdown">\n  <button class="Privacy-dropdownTrigger Tag Tag-fill Tag-fill--'+
((__t=( cssClass ))==null?'':_.escape(__t))+
' CDB-Text CDB-Size-small u-upperCase js-toggle">\n    ';
 if (isLoading) { 
__p+='\n      <div class="CDB-LoaderIcon CDB-LoaderIcon--small u-flex">\n        <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n          <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n        </svg>\n      </div>\n    ';
 } else { 
__p+='\n      '+
((__t=( privacy ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  </button>\n\n  <div class="js-dialog"></div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],529:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Tab-paneContent js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],530:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var Ps = require('perfect-scrollbar');
var template = require('./scroll.tpl');
var MutationObserver = window.MutationObserver;

module.exports = CoreView.extend({
  tagName: 'div',
  className: 'ScrollView',

  initialize: function (opts) {
    if (!opts.createContentView) throw new Error('A factory createContentView function is required');
    this.options = opts || {};
    this._type = opts.type || 'vertical'; // vertical or horizontal
    this._maxScroll = 0;
    this._bindedCheckShadows = this._checkShadows.bind(this);
  },

  render: function () {
    this.clearSubViews();
    this._html();

    var view = this.options.createContentView.call(this);
    this._contentContainer().append(view.render().el);
    this.addView(view);
    this._applyScroll();
    this._updateScrollWhenExist();
    return this;
  },

  _html: function () {
    this.$el.html(template({
      type: this._type
    }));

    (this._type === 'horizontal') && this.$el.addClass('ScrollView--horizontal');
  },

  _contentContainer: function () {
    return this.$('.js-content');
  },

  _wrapperContainer: function () {
    return this.$('.js-wrapper');
  },

  _updateScrollWhenExist: function () {
    // Phantom doesn't provide this api for window.
    if (!MutationObserver) return;

    // even with the changes in PS, we need to check when this element is added to the dom
    // in order to trigger manually an update.
    var element = document.body;
    var self = this._wrapperContainer().get(0);
    var onMutationObserver = function () {
      if (element.contains(self)) {
        Ps.update(self);
        observer.disconnect();
      }
    };

    var observer = new MutationObserver(onMutationObserver);
    onMutationObserver();

    var config = { subtree: true, childList: true };
    observer.observe(element, config);
  },

  _applyScroll: function () {
    Ps.initialize(this._wrapperContainer().get(0), {
      wheelSpeed: 2,
      wheelPropagation: true,
      stopPropagationOnClick: false,
      minScrollbarLength: 20,
      suppressScrollX: this._type === 'vertical',
      suppressScrollY: this._type === 'horizontal'
    });

    this._bindScroll();
  },

  _bindScroll: function () {
    this._wrapperContainer()
      .on('ps-dom-change', this._bindedCheckShadows)
      .on('ps-x-reach-start', this._bindedCheckShadows)
      .on('ps-x-reach-end', this._bindedCheckShadows)
      .on('ps-y-reach-start', this._bindedCheckShadows)
      .on('ps-y-reach-end', this._bindedCheckShadows)
      .on('ps-scroll-x', this._bindedCheckShadows)
      .on('ps-scroll-y', this._bindedCheckShadows);
  },

  _unbindScroll: function () {
    this._wrapperContainer()
      .off('ps-dom-change', this._bindedCheckShadows)
      .off('ps-x-reach-start', this._bindedCheckShadows)
      .off('ps-x-reach-end', this._bindedCheckShadows)
      .off('ps-y-reach-start', this._bindedCheckShadows)
      .off('ps-y-reach-end', this._bindedCheckShadows)
      .off('ps-scroll-x', this._bindedCheckShadows)
      .off('ps-scroll-y', this._bindedCheckShadows);
  },

  _checkShadows: function () {
    var currentPos;
    var max;
    var width;
    var height;
    var maxPos;

    if (this._type === 'horizontal') {
      currentPos = this._wrapperContainer().scrollLeft();
      max = this._wrapperContainer().get(0).scrollWidth;
      width = this._wrapperContainer().outerWidth();
      maxPos = max - width;

      this.$('> .js-leftShadow').toggleClass('is-visible', currentPos > 0);
      this.$('> .js-rightShadow').toggleClass('is-visible', currentPos < maxPos);
    } else {
      currentPos = this._wrapperContainer().scrollTop();
      max = this._wrapperContainer().get(0).scrollHeight;
      height = this._wrapperContainer().outerHeight();
      maxPos = max - height;

      // We use the direct descendant selector to avoid affect others nested view with scroll
      this.$('> .js-topShadow').toggleClass('is-visible', currentPos > 0);
      this.$('> .js-bottomShadow').toggleClass('is-visible', currentPos < maxPos);
    }
  },

  destroyScroll: function () {
    this._unbindScroll();
    Ps.destroy(this._wrapperContainer().get(0));
  },

  clean: function () {
    this.destroyScroll();
    CoreView.prototype.clean.apply(this, arguments);
  }
});

},{"./scroll.tpl":531,"backbone/core-view":1127,"perfect-scrollbar":"perfect-scrollbar"}],531:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (type === 'vertical') { 
__p+='\n<div class="ScrollView-shadow ScrollView-shadow--top js-topShadow"></div>\n<div class="ScrollView-shadow ScrollView-shadow--bottom js-bottomShadow"></div>\n';
 } else { 
__p+='\n<div class="Carousel-shadow Carousel-shadow--left js-leftShadow"></div>\n<div class="Carousel-shadow Carousel-shadow--right js-rightShadow"></div>\n';
 } 
__p+='\n<div class="ScrollView-wrapper js-wrapper js-perfect-scroll">\n  <div class="ScrollView-content js-content"></div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],532:[function(require,module,exports){
var Backbone = require('backbone');

/**
 *  Stack layout model checks and decides if next or previous
 *  positions are possible.
 */

module.exports = Backbone.Model.extend({

  defaults: {
    position: 0
  },

  initialize: function (attrs, opts) {
    this.stackLayoutItems = opts.stackLayoutItems;
  },

  goToStep: function (position) {
    var stackLayoutItemsSize = this.stackLayoutItems.size();

    if (position >= stackLayoutItemsSize) {
      throw new Error('There is no ' + position + ' stack view in the collection');
    } else {
      this.set({
        position: position
      }, {
        silent: true
      });
      this._rememberStep.apply(this, arguments);
      this._triggerPositionChanged(position, Array.prototype.slice.call(arguments, 1));
    }
  },

  nextStep: function () {
    var currentPos = this.get('position');
    var nextPosition = ++currentPos;
    this.goToStep.apply(this, Array.prototype.concat.apply([nextPosition], arguments));
  },

  prevStep: function () {
    var currentPos = this.get('position');
    var prevPosition = --currentPos;
    this.goToStep.apply(this, Array.prototype.concat.apply([prevPosition], arguments));
  },

  goBack: function () {
    if (this._goBackToArguments) {
      this.goToStep.apply(this, this._goBackToArguments);
    }
  },

  _triggerPositionChanged: function (position, args) {
    this.trigger('positionChanged', position, Array.prototype.slice.call(args));
  },

  _rememberStep: function () {
    this._goBackToArguments = this._lastStepArguments || [ 0 ];
    this._lastStepArguments = arguments;
  }
});

},{"backbone":"backbone"}],533:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var StackLayoutModel = require('./stack-layout-model');
var _ = require('underscore');

/**
 *  Stack layout view manages a "carousel" of views.
 *  They can go forward or backward.
 */

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!this.collection || !this.collection.size()) {
      throw new Error('A collection of stack views should be provided');
    }
    this.model = new StackLayoutModel({}, {
      stackLayoutItems: this.collection
    });
    this.model.bind('positionChanged', this._onPositionChange, this);
  },

  render: function () {
    this.clearSubViews();
    this._genNewStackView();
    return this;
  },

  _onPositionChange: function (newPos, opts) {
    this._removeOldStackView();
    this._genNewStackView(_.flatten(opts));
    this.trigger('positionChanged', this);
  },

  getCurrentPosition: function () {
    return this.model.get('position');
  },

  _removeOldStackView: function () {
    var oldView = this._getCurrentView();
    if (oldView) {
      oldView.clean();
      this.removeView(oldView);
    }
  },

  _getCurrentView: function () {
    for (var key in this._subviews) break;
    return this._subviews[key];
  },

  _genNewStackView: function () {
    var args = [this.model].concat([_.flatten(arguments)]);
    var nextView = this.collection.at(this.model.get('position')).get('createStackView').apply(this, args);
    this.$el.html(nextView.render().el);

    this.addView(nextView);
  }
});

},{"./stack-layout-model":532,"backbone/core-view":1127,"underscore":"underscore"}],534:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var TabPaneView = require('./tab-pane-view.js');
var TabPaneCollection = require('./tab-pane-collection');
var IconView = require('./tab-pane-icon-view');

/**
 * Creates a tab pane representing editor's left-vertical menu, where the tab items are large icons,
 * and the content on the right.
 *
 * Example usage:
 * {
 *   icon: 'my-icon',
 *   createContentView: CoreView(),
 *   selected: false
 * }
 * @param {Array} paneItems
 * @param {Object} options
 * @return {Object} instance of a Backbone view
 */
module.exports = function (paneItems, options) {
  options = options || {};
  var tabPaneItemIconOptions = options.tabPaneItemIconOptions;

  var items = paneItems.map(function (paneItem) {
    ['icon', 'createContentView'].forEach(function (check) {
      if (!paneItem[check]) {
        throw new Error(check + ' should be provided');
      }
    });

    return {
      selected: paneItem.selected,
      icon: paneItem.icon,
      createButtonView: function () {
        return new IconView(_.extend({ model: this }, tabPaneItemIconOptions));
      },
      createContentView: function () {
        return paneItem.createContentView && paneItem.createContentView() || new CoreView();
      }
    };
  });

  var collection = new TabPaneCollection(items);
  var tabPaneOptions = options.tabPaneOptions;

  return new TabPaneView(
    _.extend(
      { collection: collection },
      tabPaneOptions
    )
  );
};

},{"./tab-pane-collection":538,"./tab-pane-icon-view":542,"./tab-pane-view.js":549,"backbone/core-view":1127,"underscore":"underscore"}],535:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var TabPaneView = require('./tab-pane-view.js');
var TabPaneCollection = require('./tab-pane-collection');
var MixedLabelView = require('./tab-pane-mixed-view');
var ColorView = require('./tab-pane-color-view');

/**
 * Creates a tab pane, where the menu consists of text labels.
 *
 * Example usage:
 * {
 *   label: 'My label',
 *   createContentView: CoreView(),
 *   selected: false
 * }
 *
 * @param {Array} paneItems
 * @param {Object} options
 * @return {Object} instance of CoreView
 */
module.exports = function (paneItems, options) {
  options = options || {};
  var tabPaneItemLabelOptions = options.tabPaneItemLabelOptions;

  var items = paneItems.map(function (paneItem) {
    ['label', 'createContentView'].forEach(function (check) {
      if (!paneItem[check]) {
        throw new Error(check + ' should be provided');
      }
    });

    return {
      name: paneItem.name,
      selected: paneItem.selected,
      label: paneItem.label,
      color: paneItem.color,
      kind: paneItem.kind,
      selectedChild: paneItem.selectedChild,
      createButtonView: function () {
        if (paneItem.type === 'color') {
          return new ColorView(_.extend({ model: this }, tabPaneItemLabelOptions));
        } else {
          return new MixedLabelView(_.extend({ model: this, type: paneItem.type }, tabPaneItemLabelOptions));
        }
      },
      createContentView: function () {
        return paneItem.createContentView && paneItem.createContentView() || new CoreView();
      }
    };
  });

  this.collection = new TabPaneCollection(items);

  var tabPaneOptions = options.tabPaneOptions;

  return new TabPaneView(
    _.extend(
      { collection: this.collection },
      tabPaneOptions
    )
  );
};

},{"./tab-pane-collection":538,"./tab-pane-color-view":539,"./tab-pane-mixed-view":547,"./tab-pane-view.js":549,"backbone/core-view":1127,"underscore":"underscore"}],536:[function(require,module,exports){
var _ = require('underscore');
var cdb = require('cartodb.js');
var TabPaneView = require('./tab-pane-view.js');
var TabPaneCollection = require('./tab-pane-collection');
var TemplateView = require('./tab-pane-template-view');

/**
 * Creates a tab pane, where the menu consists of text labels.
 *
 * Example usage:
 * {
 *   label: 'My label',
 *   createContentView: cdb.core.View(),
 *   selected: false
 * }
 *
 * @param {Array} paneItems
 * @param {Object} options
 * @return {Object} instance of cdb.core.View
 */
module.exports = function (paneItems, options) {
  options = options || {};
  var tabPaneTemplateOptions = options.tabPaneTemplateOptions;

  var items = paneItems.map(function (paneItem) {
    ['label', 'name', 'createContentView'].forEach(function (check) {
      if (!paneItem[check]) {
        throw new Error(check + ' should be provided');
      }
    });

    return {
      name: paneItem.name,
      selected: paneItem.selected,
      label: paneItem.label,
      createButtonView: function () {
        return new TemplateView(_.extend({ model: this }, tabPaneTemplateOptions));
      },
      createContentView: function () {
        return paneItem.createContentView && paneItem.createContentView() || new cdb.core.View();
      }
    };
  });

  var collection = new TabPaneCollection(items);

  var tabPaneOptions = options.tabPaneOptions;

  return new TabPaneView(
    _.extend(
      { collection: collection },
      tabPaneOptions
    )
  );
};

},{"./tab-pane-collection":538,"./tab-pane-template-view":548,"./tab-pane-view.js":549,"cartodb.js":"cartodb.js","underscore":"underscore"}],537:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var TabPaneView = require('./tab-pane-view.js');
var TabPaneCollection = require('./tab-pane-collection');
var LabelView = require('./tab-pane-label-view');

/**
 * Creates a tab pane, where the menu consists of text labels.
 *
 * Example usage:
 * {
 *   label: 'My label',
 *   createContentView: CoreView(),
 *   selected: false
 * }
 *
 * @param {Array} paneItems
 * @param {Object} options
 * @return {Object} instance of CoreView
 */
module.exports = function (paneItems, options) {
  options = options || {};
  var tabPaneItemLabelOptions = options.tabPaneItemLabelOptions;

  var items = paneItems.map(function (paneItem) {
    ['label', 'createContentView'].forEach(function (check) {
      if (!paneItem[check]) {
        throw new Error(check + ' should be provided');
      }
    });

    return {
      name: paneItem.name,
      selected: paneItem.selected,
      label: paneItem.label,
      selectedChild: paneItem.selectedChild,
      createButtonView: function () {
        return new LabelView(_.extend({ model: this }, tabPaneItemLabelOptions));
      },
      createContentView: function () {
        return paneItem.createContentView && paneItem.createContentView() || new CoreView();
      }
    };
  });

  this.collection = new TabPaneCollection(items);

  var tabPaneOptions = options.tabPaneOptions;

  return new TabPaneView(
    _.extend(
      { collection: this.collection },
      tabPaneOptions
    )
  );
};

},{"./tab-pane-collection":538,"./tab-pane-label-view":545,"./tab-pane-view.js":549,"backbone/core-view":1127,"underscore":"underscore"}],538:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

module.exports = Backbone.Collection.extend({
  constructor: function (models, options) {
    options = _.extend(options || {}, { silent: false });
    Backbone.Collection.prototype.constructor.call(this, models, options);
  },

  initialize: function () {
    this.bind('reset', this._setSelected, this);
    this.bind('change:selected', this._onSelectedChange, this);
    this._setSelected();
  },

  getSelected: function () {
    return this.find(function (model) {
      return model.get('selected');
    });
  },

  _setSelected: function () {
    var isSelected = this.getSelected();

    if (!isSelected && this.size() > 0) {
      this.at(0).set('selected', true);
    }
  },

  _onSelectedChange: function (itemModel, isSelected) {
    if (!isSelected) {
      return;
    }

    this.each(function (model) {
      if (model !== itemModel) {
        model.set('selected', false);
      }
    }, this);
  },

  select: function (name, value) {
    var model = this.find(function (m) {
      return m.get(name) === value;
    }, this);

    if (model) {
      model.set('selected', true);
    }
  }
});

},{"backbone":"backbone","underscore":"underscore"}],539:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./tab-pane-color.tpl');

/**
 *  Label component
 */

module.exports = CoreView.extend({
  className: 'Label',

  initialize: function () {
    if (!this.model) {
      throw new Error('A model should be provided');
    }
    this.model.bind('change:label', this.render, this);
  },

  render: function () {
    this.clearSubViews();

    this.$el.html(template({
      color: this.model.get('label'),
      selectedChild: this.model.get('selectedChild') || ''
    }));
    return this;
  }
});

},{"./tab-pane-color.tpl":540,"backbone/core-view":1127}],540:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ColorBar ColorBar--inline" style="background-color: '+
((__t=( color ))==null?'':_.escape(__t))+
';"></div> ';
 if (selectedChild) { 
__p+=' <span class="CDB-NavSubmenu-status js-NavSubmenu-status u-hintTextColor">'+
((__t=( selectedChild ))==null?'':_.escape(__t))+
'</span>';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],541:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (type === 'text') { 
__p+='\n'+
((__t=( label ))==null?'':_.escape(__t))+
'';
 if (selectedChild) { 
__p+=' <span class="CDB-NavSubmenu-status js-NavSubmenu-status u-hintTextColor">'+
((__t=( selectedChild ))==null?'':_.escape(__t))+
'</span>';
 } 
__p+='\n';
 } else if (kind === 'custom-marker') { 
__p+='\n<div class=\'Editor-categoryImagesTag CDB-Text CDB-FontSize-small u-altTextColor is-semibold u-upperCase\'>'+
((__t=( _t('form-components.editors.fill.input-color.img') ))==null?'':_.escape(__t))+
'</div>\n';
 } else { 
__p+='\n<div class="Tab-paneLabelImageContainer js-image-container"></div>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],542:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var Template = require('./tab-pane-icon.tpl');

/**
 *  Icon component
 */

module.exports = CoreView.extend({
  tagName: 'i',

  className: 'CDB-IconFont',

  initialize: function (options) {
    if (!this.model) {
      throw new Error('A model should be provided');
    }

    this.template = this.options.template || Template;
  },

  render: function () {
    this.$el.html(this.template({
      icon: this.model.get('icon')
    }));

    return this;
  }
});

},{"./tab-pane-icon.tpl":543,"backbone/core-view":1127}],543:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<i class="CDB-IconFont CDB-IconFont-'+
((__t=( icon ))==null?'':_.escape(__t))+
'"></i>\n';
}
return __p;
};

},{"underscore":"underscore"}],544:[function(require,module,exports){
var CoreView = require('backbone/core-view');

/**
 *  TabPaneItem component
 */

module.exports = CoreView.extend({
  tagName: 'button',

  events: {
    'click': '_onButtonClicked'
  },

  initialize: function () {
    if (!this.model) {
      throw new Error('A model should be provided');
    }

    this.model.bind('change:selected', this._onChangeSelected, this);
  },

  render: function () {
    var view = this.model.get('createButtonView').call(this.model);
    this.addView(view);
    this.$el.append(view.render().$el);
    this.$el.toggleClass('is-selected', !!this.model.get('selected'));

    return this;
  },

  _onChangeSelected: function () {
    this.$el.toggleClass('is-selected', !!this.model.get('selected'));
  },

  _onButtonClicked: function (e) {
    e.preventDefault();
    this.model.set('selected', true);
  }
});

},{"backbone/core-view":1127}],545:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./tab-pane-label.tpl');

/**
 *  Label component
 */

module.exports = CoreView.extend({
  className: 'Label',

  initialize: function () {
    if (!this.model) {
      throw new Error('A model should be provided');
    }
  },

  render: function () {
    this.$el.html(template({
      label: this.model.get('label'),
      selectedChild: this.model.get('selectedChild') || ''
    }));
    return this;
  }
});

},{"./tab-pane-label.tpl":546,"backbone/core-view":1127}],546:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+=''+
((__t=( label ))==null?'':_.escape(__t))+
'';
 if (selectedChild) { 
__p+=' <span class="CDB-NavSubmenu-status js-NavSubmenu-status u-hintTextColor">'+
((__t=( selectedChild ))==null?'':_.escape(__t))+
'</span>';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],547:[function(require,module,exports){
var template = require('./tab-pane-file.tpl');
var CoreView = require('backbone/core-view');
var ImageLoaderView = require('../img-loader-view');

/**
 *  File component
 */

module.exports = CoreView.extend({
  tagName: 'i',

  className: 'CDB-IconFont',

  initialize: function (options) {
    if (!this.model) throw new Error('A model should be provided');

    this.model.bind('change:label', this.render, this);
    this.model.bind('change:color', this._updateColor, this);
  },

  render: function () {
    this.clearSubViews();

    var labelType = this._getLabelType();

    this.$el.html(template({
      type: labelType,
      label: this.model.get('label'),
      kind: this.model.get('kind'),
      selectedChild: this.model.get('selectedChild') || ''
    }));

    if (labelType === 'file') {
      this._loadImages();
    }

    return this;
  },

  _loadImages: function () {
    this.iconView = new ImageLoaderView({
      imageClass: 'Tab-paneLabelImage',
      imageUrl: this._getImageURL(),
      color: this.model.get('color')
    });
    this.addView(this.iconView);
    this.$('.js-image-container').append(this.iconView.render().el);
  },

  _updateColor: function () {
    this.iconView && this.iconView.updateImageColor(this.model.get('color'));
  },

  _getLabelType: function () {
    var label = this.model.get('label');
    return label && label.match(/^http/) ? 'file' : 'text';
  },

  _getImageURL: function () {
    return this.model.get('label');
  }
});

},{"../img-loader-view":213,"./tab-pane-file.tpl":541,"backbone/core-view":1127}],548:[function(require,module,exports){
var cdb = require('cartodb.js');

/**
 *  Icon component
 */

module.exports = cdb.core.View.extend({

  initialize: function (options) {
    if (!this.model) throw new Error('A model should be provided');
    if (!options.template) throw new Error('A template should be provided');
    this.template = options.template;
  },

  render: function () {
    this.$el.html(this.template(this.model.toJSON()));
    return this;
  }
});

},{"cartodb.js":"cartodb.js"}],549:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var TabPaneItem = require('./tab-pane-item-view.js');
var Template = require('./tab-pane.tpl');

/**
 *  TabPane component
 */

module.exports = CoreView.extend({
  className: 'Tab-pane',

  initialize: function (options) {
    if (!this.collection) {
      throw new Error('A TabPaneCollection should be provided');
    }

    this._tabPaneItemOptions = this.options.tabPaneItemOptions;
    this._createContentKey = this.options.createContentKey || 'createContentView';
    this.template = this.options.template || Template;

    this.collection.bind('change:selected', this._renderSelected, this);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    this.$el.html(this.template(this.options));

    this._renderCollection();

    var model = this.getSelectedTabPane();

    if (model) {
      this._renderSelected(model, true);
    }

    return this;
  },

  getSelectedTabPane: function () {
    return this.collection.getSelected();
  },

  getTabPane: function (name) {
    return _.first(this.collection.where({ name: name }));
  },

  getSelectedTabPaneName: function () {
    var selectedTab = this.getSelectedTabPane();
    return selectedTab ? selectedTab.get('name') : null;
  },

  setSelectedTabPaneByName: function (name) {
    return this.collection.select('name', name);
  },

  _renderSelected: function (model, isSelected) {
    if (isSelected) {
      if (this._selectedView) {
        this._selectedView.clean();
        this.removeView(this._selectedView);
      }

      this._selectedView = this._renderTabPaneContentView(model);
    }
  },

  _renderCollection: function () {
    this.collection.each(function (paneModel) {
      if (paneModel.get('createButtonView')) {
        this._renderTabPaneItemView(paneModel);
      }
    }, this);
  },

  _renderTabPaneItemView: function (model) {
    var tabPaneItemView = new TabPaneItem(_.extend({ model: model }, this._tabPaneItemOptions));
    this.addView(tabPaneItemView);
    this.$('.js-menu').append(tabPaneItemView.render().el);
  },

  _renderTabPaneContentView: function (model) {
    var tabPaneContentView = model.get(this._createContentKey).call(model);
    if (tabPaneContentView) {
      this.addView(tabPaneContentView);
      this.$('.js-content').append(tabPaneContentView.render().el);
    }
    return tabPaneContentView;
  },

  changeStyleMenu: function (m) {
    this.$('.js-theme').toggleClass('is-dark', m.isEditing());
  }
});

},{"./tab-pane-item-view.js":544,"./tab-pane.tpl":550,"backbone/core-view":1127,"underscore":"underscore"}],550:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-menu"></div>\n<div class="Tab-paneContent js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],551:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--grid u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="24px" height="25px" viewbox="521 436 24 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <path d="M524.5,440 L540.5,440 L540.5,460 L524.5,460 L524.5,440 Z M528.5,437 L536.5,437 L536.5,440 L528.5,440 L528.5,437 Z M522,440 L544,440 L522,440 Z M528.5,443.5 L528.5,455.5 L528.5,443.5 Z M532.5,443.5 L532.5,455.5 L532.5,443.5 Z M536.5,443.5 L536.5,455.5 L536.5,443.5 Z" id="Shape" stroke="#F19243" stroke-width="1" fill="none"/>\n      </svg>\n    </div>\n    <div>\n      <h2 class=" CDB-Text CDB-Size-huge is-light u-bSpace--xl">\n        '+
((__t=( _t('components.table.rows.destroy.title', { cartodb_id: cartodb_id }) ))==null?'':_.escape(__t))+
'\n      </h2>\n      <p class="CDB-Text CDB-Size-large u-altTextColor">'+
((__t=( _t('components.table.rows.destroy.desc') ))==null?'':_.escape(__t))+
'</p>\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.table.rows.destroy.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.table.rows.destroy.confirm') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],552:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<td class="Table-cellItem" data-attribute="'+
((__t=( columnName ))==null?'':_.escape(__t))+
'" title="'+
((__t=( value ))==null?'':_.escape(__t))+
'" data-clipboard-text=\''+
((__t=( value ))==null?'':_.escape(__t))+
'\'>\n  <div class="\n      Table-cell u-flex u-justifySpace\n      '+
((__t=( columnName === 'cartodb_id' || (type === 'geometry' && geometry !== 'point') ? 'Table-cell--short' : '' ))==null?'':_.escape(__t))+
'\n    ">\n    <p class="\n      CDB-Text CDB-Size-medium\n      u-ellipsis u-rSpace--xl\n      '+
((__t=( type === 'number' && columnName !== 'cartodb_id' ? 'is-number' : '' ))==null?'':_.escape(__t))+
'\n      '+
((__t=( value === null ? 'is-null' : '' ))==null?'':_.escape(__t))+
'\n      '+
((__t=( columnName === 'cartodb_id' ? 'is-cartodbId' : '' ))==null?'':_.escape(__t))+
'\n      js-value\n    ">\n      '+
((__t=( value === null ? 'null' : formattedValue ))==null?'':_.escape(__t))+
'\n    </p>\n\n    ';
 if (columnName !== 'cartodb_id') { 
__p+='\n      <button class="CDB-Shape-threePoints is-blue is-small Table-cellItemOptions js-cellOptions">\n        <div class="CDB-Shape-threePointsItem"></div>\n        <div class="CDB-Shape-threePointsItem"></div>\n        <div class="CDB-Shape-threePointsItem"></div>\n      </button>\n    ';
 } 
__p+='\n  </div>\n</td>\n';
}
return __p;
};

},{"underscore":"underscore"}],553:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var cellTemplate = require('./table-body-cell.tpl');
var pointGeojsonParser = require('../../../helpers/point-geojson-parser');

var FORMATTED_TYPE_VALUES = {
  'geometry': pointGeojsonParser
};

/*
 *  Table body row view
 */

module.exports = CoreView.extend({

  className: 'Table-row',
  tagName: 'tr',

  options: {
    simpleGeometry: ''
  },

  initialize: function (opts) {
    if (!opts.columnsCollection) throw new Error('columnsCollection is required');
    if (!opts.tableViewModel) throw new Error('tableViewModel is required');

    this._columnsCollection = opts.columnsCollection;
    this._tableViewModel = opts.tableViewModel;

    this.el.setAttribute('data-model', this.model.cid);

    this._initBinds();
  },

  render: function () {
    this.$el.empty();
    this._generateRowsHTML();
    return this;
  },

  _initBinds: function () {
    this.model.bind('change', this.render, this);
    this.model.bind('destroy', this.remove, this);
  },

  _generateRowsHTML: function () {
    var r = [];

    for (var i = 0, l = this._columnsCollection.size(); i < l; i++) {
      var mdl = this._columnsCollection.at(i);
      var columnName = mdl.get('name');

      if (columnName !== 'the_geom_webmercator' || (this._tableViewModel.isDisabled() && columnName === 'the_geom_webmercator')) {
        r[i] = this._generateCellHTML(columnName);
      }
    }

    this.el.innerHTML = r.join('');
  },

  _generateCellHTML: function (columnName) {
    var simpleGeometry = this.options.simpleGeometry;
    var columnModel = _.first(this._columnsCollection.where({ name: columnName }));
    var columnType = columnModel.get('type');
    var value = this.model.get(columnName);
    var formattedValue = value;

    if (columnType === 'geometry') {
      if (simpleGeometry === 'point') {
        formattedValue = FORMATTED_TYPE_VALUES[columnType](value);
      } else {
        formattedValue = simpleGeometry && (simpleGeometry.charAt(0).toUpperCase() + simpleGeometry.slice(1));
      }
    } else if (FORMATTED_TYPE_VALUES[columnType]) {
      formattedValue = FORMATTED_TYPE_VALUES[columnType](value);
    }

    return cellTemplate({
      value: value,
      formattedValue: formattedValue,
      type: columnType,
      columnName: columnName,
      geometry: simpleGeometry
    });
  }
});

},{"../../../helpers/point-geojson-parser":1096,"./table-body-cell.tpl":552,"backbone/core-view":1127,"underscore":"underscore"}],554:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var $ = require('jquery');
var _ = require('underscore');
var Clipboard = require('clipboard');
var TableBodyRowView = require('./table-body-row-view');
var ContextMenuView = require('../../context-menu/context-menu-view');
var CustomListCollection = require('../../custom-list/custom-list-collection');
var addTableRowOperation = require('../operations/table-add-row');
var removeTableRowOperation = require('../operations/table-remove-row');
var editCellOperation = require('../operations/table-edit-cell');
var ConfirmationModalView = require('../../modals/confirmation/modal-confirmation-view');
var TablePaginatorView = require('../paginator/table-paginator-view');
var tableBodyTemplate = require('./table-body.tpl');
var renderLoading = require('../../loading/render-loading');
var ErrorView = require('../../error/error-view');
var tableNoRowsTemplate = require('./table-no-rows.tpl');
var EditorsServiceModel = require('../editors/editors-service-model');
var EditorsModel = require('../editors/types/editor-model');
var errorParser = require('../../../helpers/error-parser');
var magicPositioner = require('../../../helpers/magic-positioner');
var checkAndBuildOpts = require('../../../helpers/required-opts');

var EDITORS_MAP = {
  'string': require('../editors/types/editor-string-view'),
  'number': require('../editors/types/editor-base-view'),
  'boolean': require('../editors/types/editor-boolean-view'),
  'date': require('../editors/types/editor-date-view'),
  'default': require('../editors/types/editor-string-view')
};

var REQUIRED_OPTS = [
  'columnsCollection',
  'modals',
  'queryGeometryModel',
  'querySchemaModel',
  'rowsCollection',
  'tableViewModel'
];

/*
 *  Table body view
 */

module.exports = CoreView.extend({

  className: 'Table-body',
  tagName: 'div',

  events: {
    'click': '_onClick',
    'dblclick': '_onDblClick'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._editors = new EditorsServiceModel();

    this._closeEditor = this._closeEditor.bind(this);
    this._hideContextMenu = this._hideContextMenu.bind(this);

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this._destroyScrollBinding();
    this.$el.empty();

    // Render results when we have the schema and goemetry is not being fetched
    if (this._querySchemaModel.isFetched() && !this._queryGeometryModel.isFetching() && !this._rowsCollection.isFetching()) {
      if (!this._rowsCollection.size()) {
        this._renderNoRows();
      } else {
        this.$el.html(tableBodyTemplate());
        this._rowsCollection.each(this._renderBodyRow, this);
        this._initPaginator();
      }
    } else {
      this._renderQueryState();
    }

    this.$el.toggleClass('Table-body--relative', !!this._tableViewModel.get('relativePositionated'));

    return this;
  },

  _initBinds: function () {
    this._queryGeometryModel.bind('change:status', this.render, this);
    this._querySchemaModel.bind('change:status', this.render, this);
    this._rowsCollection.bind('reset', _.debounce(this.render.bind(this), 20), this);
    this._rowsCollection.bind('add', function (model) {
      if (this._rowsCollection.size() === 1) {
        this.render();
      } else {
        this._renderBodyRow(model);
        this._scrollToBottom();
      }
    }, this);
    this._rowsCollection.bind('remove', this._onRemoveRow, this);
    this._rowsCollection.bind('fail', function (mdl, response) {
      if (!response || (response && response.statusText !== 'abort')) {
        this._renderError(errorParser(response));
      }
    }, this);
    this.add_related_model(this._queryGeometryModel);
    this.add_related_model(this._querySchemaModel);
    this.add_related_model(this._rowsCollection);
  },

  _renderQueryState: function () {
    var querySchemaStatus = this._querySchemaModel.get('status');
    var nodeReady = this._querySchemaModel.get('ready');
    var geometryStatus = this._queryGeometryModel.get('status');

    if (nodeReady) {
      if (querySchemaStatus === 'unavailable' && geometryStatus === 'unavailable') {
        this._renderError(this._querySchemaModel.get('query_errors'));
      } else {
        this._renderLoading();
      }
    } else {
      this._renderLoading();
    }
  },

  _renderLoading: function () {
    this.$el.html(
      renderLoading({
        title: _t('components.table.rows.loading.title')
      })
    );
  },

  _renderError: function (desc) {
    var view = new ErrorView({
      title: _t('components.table.rows.error.title'),
      desc: desc || _t('components.table.rows.error.desc')
    });
    this.addView(view);
    this.$el.html(view.render().el);
  },

  _renderNoRows: function () {
    this.$el.html(
      tableNoRowsTemplate({
        page: this._tableViewModel.get('page'),
        customQuery: this._tableViewModel.isCustomQueryApplied()
      })
    );
  },

  _initPaginator: function () {
    var paginatorView = new TablePaginatorView({
      rowsCollection: this._rowsCollection,
      tableViewModel: this._tableViewModel
    });

    // Bug in Chrome with position:fixed :(, so we have to choose body as
    // parent
    var $el = $('body');
    // But if we have chosen relativePositionated, we should add close
    // to the table view
    if (this._tableViewModel.get('relativePositionated')) {
      $el = this.$el.closest('.Table').parent();
    }

    $el.append(paginatorView.render().el);
    this.addView(paginatorView);
  },

  _initScrollBinding: function () {
    $('.Table').scroll(this._hideContextMenu);
    this.$('.js-tbody').scroll(this._hideContextMenu);
  },

  _destroyScrollBinding: function () {
    $('.Table').off('scroll', this._hideContextMenu);
    this.$('.js-tbody').off('scroll', this._hideContextMenu);
  },

  _renderBodyRow: function (mdl) {
    var view = new TableBodyRowView({
      model: mdl,
      columnsCollection: this._columnsCollection,
      simpleGeometry: this._queryGeometryModel.get('simple_geom'),
      tableViewModel: this._tableViewModel
    });
    this.addView(view);
    this.$('.js-tbody').append(view.render().el);
  },

  _onRemoveRow: function () {
    if (!this._rowsCollection.size()) {
      this._rowsCollection.resetFetch();

      var page = this._tableViewModel.get('page');
      if (page > 0) {
        this._tableViewModel.set('page', page - 1);
      } else {
        this.render();
      }
    }
  },

  _hasContextMenu: function () {
    return this._menuView;
  },

  _hideContextMenu: function () {
    this._unhighlightCell();
    this._destroyScrollBinding();
    this._menuView.collection.unbind(null, null, this);
    this.removeView(this._menuView);
    this._menuView.clean();
    delete this._menuView;
  },

  _highlightCell: function ($tableCellItem, $tableRow) {
    $tableCellItem.addClass('is-highlighted');
    $tableRow.addClass('is-highlighted');
  },

  _unhighlightCell: function () {
    this.$('.Table-cellItem.is-highlighted, .Table-row.is-highlighted').removeClass('is-highlighted');
  },

  _showContextMenu: function (ev) {
    var self = this;
    var position = { x: ev.clientX, y: ev.clientY };
    var $tableRow = $(ev.target).closest('.Table-row');
    var $tableCellItem = $(ev.target).closest('.Table-cellItem');
    var modelCID = $tableRow.data('model');
    var attribute = $tableCellItem.data('attribute');
    var rowModel = self._rowsCollection.get({ cid: modelCID });
    var menuItems = [];

    menuItems.push({
      label: _t('components.table.rows.options.copy'),
      val: 'copy',
      action: function () {
        self._copyValue($tableCellItem);
      }
    });

    if (!this._tableViewModel.isDisabled()) {
      menuItems = [
        {
          label: _t('components.table.rows.options.edit'),
          val: 'edit',
          action: function () {
            self._editCell(rowModel, attribute);
          }
        }, {
          label: _t('components.table.rows.options.create'),
          val: 'create',
          action: function () {
            self._addRow();
          }
        }
      ].concat(menuItems);

      menuItems.push({
        label: _t('components.table.rows.options.delete'),
        val: 'delete',
        destructive: true,
        action: function () {
          self._removeRow(rowModel);
        }
      });
    }

    // No options?, don't open anything
    if (!menuItems.length) {
      return false;
    }

    var collection = new CustomListCollection(menuItems);

    this._menuView = new ContextMenuView({
      className: 'Table-rowMenu ' + ContextMenuView.prototype.className,
      collection: collection,
      triggerElementID: modelCID,
      position: position
    });

    this._menuView.$el.css(
      magicPositioner({
        parentView: $('body'),
        posX: position.x,
        posY: position.y
      })
    );

    collection.bind('change:selected', function (menuItem) {
      var action = menuItem.get('action');
      action && action();
    }, this);

    this._menuView.model.bind('change:visible', function (model, isContextMenuVisible) {
      if (this._hasContextMenu() && !isContextMenuVisible) {
        this._hideContextMenu();
      }
    }, this);

    this._menuView.show();
    this.addView(this._menuView);

    this._highlightCell($tableCellItem, $tableRow);
    this._initScrollBinding();
  },

  _onClick: function (ev) {
    var isCellOptions = $(ev.target).hasClass('js-cellOptions');
    if (isCellOptions) {
      if (this._hasContextMenu()) {
        this._hideContextMenu();
      } else {
        this._showContextMenu(ev);
      }
    }
  },

  _onDblClick: function (ev) {
    var $tableCellItem = $(ev.target).closest('.Table-cellItem');
    var isCellOptions = $(ev.target).hasClass('js-cellOptions');

    if ($tableCellItem && !isCellOptions) {
      var $tableRow = $tableCellItem.closest('.Table-row');
      var modelCID = $tableRow.data('model');
      var attribute = $tableCellItem.data('attribute');
      var rowModel = this._rowsCollection.get({ cid: modelCID });

      if (!this._tableViewModel.isDisabled() && rowModel && attribute && attribute !== 'cartodb_id') {
        this._editCell(rowModel, attribute);
      }
    }
  },

  _copyValue: function ($el) {
    // Work-around for Clipboard \o/
    this._clipboard = new Clipboard($el.get(0));
    $el.click();
    this._clipboard.destroy();
  },

  _addRow: function () {
    addTableRowOperation({
      rowsCollection: this._rowsCollection
    });
  },

  _initEditorScrollBinding: function () {
    $('.Table').scroll(this._closeEditor);
    this.$('.js-tbody').scroll(this._closeEditor);
  },

  _destroyEditorScrollBinding: function () {
    $('.Table').unbind('scroll', this._closeEditor);
    this.$('.js-tbody').unbind('scroll', this._closeEditor);
  },

  _closeEditor: function () {
    this._unhighlightCell();
    this._destroyEditorScrollBinding();
    this._editors.unbind(null, null, this);
    this._editors.destroy();
  },

  _saveValue: function (rowModel, attribute, newValue) {
    if (rowModel.get(attribute) !== newValue) {
      editCellOperation({
        rowModel: rowModel,
        attribute: attribute,
        newValue: newValue
      });
    }
  },

  _doCellEdition: function (rowModel, attribute) {
    var $tableRow = this.$('[data-model="' + rowModel.cid + '"]');
    var $tableCell = $tableRow.find('[data-attribute="' + attribute + '"]');
    var $options = $tableCell.find('.js-cellOptions');
    var columnModel = _.first(this._columnsCollection.where({ name: attribute }));
    var type = columnModel.get('type');

    this._highlightCell($tableCell, $tableRow);
    this._initEditorScrollBinding();

    var model = new EditorsModel({
      type: type,
      value: rowModel.get(attribute)
    });

    this._editors.bind('destroyedEditor', this._closeEditor, this);
    this._editors.bind('confirmedEditor', function () {
      if (model.isValid()) {
        this._saveValue(
          rowModel,
          attribute,
          model.get('value')
        );
      }
    }, this);

    var position = $options.offset();

    if ($tableCell.index() > 1) {
      position.right = window.innerWidth - position.left;
      delete position.left;
    }

    if (this._rowsCollection.size() > 4 && ($tableRow.index() + 2) >= (this._rowsCollection.size() - 1)) {
      position.bottom = window.innerHeight - position.top;
      delete position.top;
    } else {
      position.top = position.top + 20;
    }

    var View = EDITORS_MAP[type];

    if (!View) {
      View = EDITORS_MAP['default'];
    }

    this._editors.create(
      function (editorModel) {
        return new View({
          editorModel: editorModel,
          model: model
        });
      },
      position
    );
  },

  _editCell: function (rowModel, attribute) {
    var callback = this._doCellEdition.bind(this, rowModel, attribute);
    rowModel.fetchRowIfGeomIsNotLoaded(callback);
  },

  _removeRow: function (rowModel) {
    var self = this;

    this._modals.create(
      function (modalModel) {
        return new ConfirmationModalView({
          modalModel: modalModel,
          template: require('./modals-templates/remove-table-row.tpl'),
          renderOpts: {
            cartodb_id: rowModel.get('cartodb_id')
          },
          loadingTitle: _t('components.table.rows.destroy.loading', {
            cartodb_id: rowModel.get('cartodb_id')
          }),
          runAction: function () {
            removeTableRowOperation({
              tableViewModel: self._tableViewModel,
              rowModel: rowModel,
              onSuccess: function () {
                modalModel.destroy();
              },
              onError: function (e) {
                modalModel.destroy();
              }
            });
          }
        });
      }
    );
  },

  _scrollToBottom: function () {
    var tbodyHeight = this.$('.js-tbody').get(0).scrollHeight;
    this.$('.js-tbody').animate({
      scrollTop: tbodyHeight
    }, 'slow');
  },

  clean: function () {
    this._destroyScrollBinding();
    CoreView.prototype.clean.apply(this);
  }

});

},{"../../../helpers/error-parser":1090,"../../../helpers/magic-positioner":1093,"../../../helpers/required-opts":1097,"../../context-menu/context-menu-view":39,"../../custom-list/custom-list-collection":47,"../../error/error-view":67,"../../loading/render-loading":230,"../../modals/confirmation/modal-confirmation-view":404,"../editors/editors-service-model":559,"../editors/types/editor-base-view":560,"../editors/types/editor-boolean-view":561,"../editors/types/editor-date-view":564,"../editors/types/editor-model":565,"../editors/types/editor-string-view":566,"../operations/table-add-row":577,"../operations/table-edit-cell":579,"../operations/table-remove-row":581,"../paginator/table-paginator-view":584,"./modals-templates/remove-table-row.tpl":551,"./table-body-row-view":553,"./table-body.tpl":555,"./table-no-rows.tpl":556,"backbone/core-view":1127,"clipboard":"clipboard","jquery":"jquery","underscore":"underscore"}],555:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<table>\n  <tbody class="js-tbody"></tbody>\n</table>\n';
}
return __p;
};

},{"underscore":"underscore"}],556:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="IntermediateInfo">\n  <div class="LayoutIcon">\n    <i class="CDB-IconFont CDB-IconFont-rows"></i>\n  </div>\n  <h3 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m u-tSpace-xl">\n    ';
 if (page !== 0) { 
__p+='\n      '+
((__t=( _t('components.table.rows.result.no-page-title', { page: page }) ))==null?'':_.escape(__t))+
'\n    ';
 } else { 
__p+='\n      '+
((__t=( _t('components.table.rows.result.no-results-title') ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  </h3>\n  <p class="CDB-Text CDB-Size-medium u-altTextColor">\n    ';
 if (page !== 0) { 
__p+='\n      '+
((__t=( _t('components.table.rows.result.no-page-desc', { page: page }) ))==null?'':_.escape(__t))+
'\n    ';
 } else { 
__p+='\n      '+
((__t=( _t('components.table.rows.result.no-results-desc', {
        addRow: _t('components.table.rows.result.no-results-button')
      }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  </p>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],557:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');

/**
 * View model of an editor
 */
module.exports = Backbone.Model.extend({

  defaults: {
    show: true,
    createContentView: function () {
      return new CoreView();
    }
  },

  createContentView: function () {
    return this.get('createContentView')(this);
  },

  show: function () {
    this.set('show', true);
  },

  hide: function () {
    this.set('show', false);
  },

  isHidden: function () {
    return !this.get('show');
  },

  confirm: function () {
    var args = Array.prototype.slice.call(arguments);
    this.trigger.apply(this, ['confirm'].concat(args));
  },

  /**
   * @override {Backbone.Model.prototype.destroy}
   */
  destroy: function () {
    var args = Array.prototype.slice.call(arguments);
    this.trigger.apply(this, ['destroy'].concat(args));
  }
});

},{"backbone":"backbone","backbone/core-view":1127}],558:[function(require,module,exports){
var CoreView = require('backbone/core-view');

module.exports = CoreView.extend({
  className: 'CDB-Box-modal Table-editor',

  initialize: function () {
    this.listenTo(this.model, 'change:show', this._onShowChange);
    this.listenTo(this.model, 'destroy', this._onDestroy);
  },

  render: function () {
    this.clearSubViews();

    var view = this.model.createContentView();
    this.addView(view);
    view.render();
    this.$el.append(view.el);
    this.$el.css(this.options.position);

    return this;
  },

  show: function () {
    this.model.show();
  },

  hide: function () {
    this.model.hide();
  },

  destroy: function () {
    this.model.destroy();
  },

  _onShowChange: function (m, show) {
    this.$el[show ? 'show' : 'hide']();
  },

  _onClose: function () {
    this.destroy();
  },

  _onDestroy: function () {
    this.hide();
    this.clean();
  }

});

},{"backbone/core-view":1127}],559:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');
var Backbone = require('backbone');
var EditorView = require('./editor-view');
var EditorViewModel = require('./editor-view-model');
var ESC_KEY_CODE = 27;
var DESTROYED_EDITOR_EVENT = 'destroyedEditor';
var CONFIRMED_EDITOR_EVENT = 'confirmedEditor';

/**
 * Top-level API to handle editor views.
 *
 * Example:
 * // In some entry-point:
 * table.editors = new EditorsServiceModel();
 *
 * // Later, in any view, calling create will create a new editor viewModel
 * var editorView = table.editors.create(fn);
 *
 * Same concept @viddo introduced with Modals.
 */
module.exports = Backbone.Model.extend({

  /**
   * Creates a new editor view
   *
   * @param {Function} createContentView
   * @return {View} the new editor view
   */
  create: function (createContentView, position) {
    if (!_.isFunction(createContentView)) throw new Error('createContentView is required');
    position = position || {
      left: '50%',
      top: '50%'
    };

    if (!this._editorView) {
      this._editorView = this._newEditorView(position);
      document.body.appendChild(this._editorView.el);
    }

    this._editorView.model.set('createContentView', createContentView);
    this._editorView.render();

    return this._editorView;
  },

  /**
   * Convenience method to add a listener when current editor is destroyed
   *
   * This is the same as doing
   * editors.create(function (model) {
   *   model.once('destroy', callback, context);
   *   return new MyView({ … });
   * });
   *
   * @param {Function} callback
   * @param {Object} [context = undefined]
   */

  confirm: function () {
    if (this._editorView) {
      this._editorView.model.confirm();
    }
  },

  destroy: function () {
    if (this._editorView) {
      this._editorView.model.destroy();
    }
  },

  _newEditorView: function (position) {
    var viewModel = new EditorViewModel();
    this._destroyOnEsc(viewModel);
    this.listenToOnce(viewModel, 'destroy', function () {
      this._editorView = null;
      this.trigger.apply(this, [DESTROYED_EDITOR_EVENT].concat(Array.prototype.slice.call(arguments)));
      this.stopListening(viewModel);
    });
    this.listenToOnce(viewModel, 'confirm', function () {
      this.trigger.apply(this, [CONFIRMED_EDITOR_EVENT].concat(Array.prototype.slice.call(arguments)));
      this.destroy();
    });
    var view = new EditorView({
      model: viewModel,
      position: position
    });
    this._destroyOnClickOutside(view);
    return view;
  },

  _destroyOnClickOutside: function (view) {
    var destroyOnClickOutside = function (ev) {
      if ($(ev.target).closest(view.el).length === 0) {
        view.model.confirm();
      }
    };
    document.addEventListener('click', destroyOnClickOutside);
    this.listenToOnce(view.model, 'destroy', function () {
      document.removeEventListener('click', destroyOnClickOutside);
    });
  },

  _destroyOnEsc: function (viewModel) {
    var destroyOnEsc = function (ev) {
      if (ev.which === ESC_KEY_CODE) {
        viewModel.destroy();
      }
    };
    document.addEventListener('keydown', destroyOnEsc);
    this.listenToOnce(viewModel, 'destroy', function () {
      document.removeEventListener('keydown', destroyOnEsc);
    });
  }

});

},{"./editor-view":558,"./editor-view-model":557,"backbone":"backbone","jquery":"jquery","underscore":"underscore"}],560:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var $ = require('jquery');
var ENTER_KEY_CODE = 13;

module.exports = CoreView.extend({

  tagName: 'input',
  className: 'CDB-InputText CDB-Text',

  events: {
    'keyup': '_onValueChange',
    'change': '_onValueChange'
  },

  initialize: function (opts) {
    if (!opts.editorModel) throw new Error('editorModel is required');
    this._editorModel = opts.editorModel;
    this._onKeyPressed = this._onKeyPressed.bind(this);
    this._onValueChange = this._onValueChange.bind(this);
  },

  render: function () {
    this.$el.val(
      this.model.get('value')
    );
    this._setFocus();
    this._initDocumentBind();
    return this;
  },

  _setFocus: function () {
    setTimeout(function () {
      this.$el.focus();
    }.bind(this), 100);
  },

  _initDocumentBind: function () {
    $(document).bind('keydown', this._onKeyPressed);
  },

  _destroyDocumentBind: function () {
    $(document).unbind('keydown', this._onKeyPressed);
  },

  _onKeyPressed: function (ev) {
    if (ev.which === ENTER_KEY_CODE) {
      if (this.model.isValid()) {
        this._editorModel.confirm();
      } else {
        return false;
      }
    }
  },

  _onValueChange: function () {
    this._setValue();
    this._checkValidity();
  },

  _setValue: function () {
    this.model.set('value', this.$el.val());
  },

  _checkValidity: function () {
    this.$el.toggleClass('has-error', !this.model.isValid());
  },

  clean: function () {
    this._destroyDocumentBind();
    CoreView.prototype.clean.apply(this);
  }

});

},{"backbone/core-view":1127,"jquery":"jquery"}],561:[function(require,module,exports){
var EditorBaseView = require('./editor-base-view');
var $ = require('jquery');
var template = require('./editor-boolean.tpl');

module.exports = EditorBaseView.extend({

  tagName: 'div',
  className: 'u-flex',

  events: {
    'change input:radio': '_onRadioChanged'
  },

  render: function () {
    var value = this.model.get('value');
    this.$el.html(
      template({
        value: value !== null ? value.toString() : 'null'
      })
    );
    return this;
  },

  _onRadioChanged: function (ev) {
    var value = $(ev.target).val();
    switch (value) {
      case 'true':
        value = true;
        break;
      case 'false':
        value = false;
        break;
      default:
        value = null;
    }
    this.model.set('value', value);
    this._editorModel.confirm();
  }

});

},{"./editor-base-view":560,"./editor-boolean.tpl":562,"jquery":"jquery"}],562:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-iBlock CDB-Text CDB-Size-medium u-rSpace--xl">\n  <input class="CDB-Radio" type="radio" name="value" value="true" ';
 if (value === 'true') { 
__p+='checked';
 } 
__p+='>\n  <span class="u-iBlock CDB-Radio-face"></span>\n  <label class="u-iBlock u-lSpace">True</label>\n</div>\n<div class="u-iBlock CDB-Text CDB-Size-medium u-rSpace--xl">\n  <input class="CDB-Radio" type="radio" name="value" value="false" ';
 if (value === 'false') { 
__p+='checked';
 } 
__p+='>\n  <span class="u-iBlock CDB-Radio-face"></span>\n  <label class="u-iBlock u-lSpace">False</label>\n</div>\n<div class="u-iBlock CDB-Text CDB-Size-medium u-rSpace--xl">\n  <input class="CDB-Radio" type="radio" name="value" value="null" ';
 if (value === 'null') { 
__p+='checked';
 } 
__p+='>\n  <span class="u-iBlock CDB-Radio-face"></span>\n  <label class="u-iBlock u-lSpace">Null</label>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],563:[function(require,module,exports){
var Backbone = require('backbone');
var moment = require('moment');
var Utils = require('../../../../helpers/utils');
var MONTHS = [
  {
    val: 0,
    label: _t('months.january')
  }, {
    val: 1,
    label: _t('months.february')
  }, {
    val: 2,
    label: _t('months.march')
  }, {
    val: 3,
    label: _t('months.april')
  }, {
    val: 4,
    label: _t('months.may')
  }, {
    val: 5,
    label: _t('months.june')
  }, {
    val: 6,
    label: _t('months.july')
  }, {
    val: 7,
    label: _t('months.august')
  }, {
    val: 8,
    label: _t('months.september')
  }, {
    val: 9,
    label: _t('months.october')
  }, {
    val: 10,
    label: _t('months.november')
  }, {
    val: 11,
    label: _t('months.december')
  }
];

module.exports = Backbone.Model.extend({

  parse: function (attrs) {
    var date;

    if (!attrs.date) {
      date = moment().utc();
    } else {
      date = moment(attrs.date).utc();
    }

    return {
      day: date.date(),
      month: date.month(),
      year: date.year(),
      time: date.format('HH:mm:ss'),
      utcOffset: date.utcOffset()
    };
  },

  initialize: function () {
    this.schema = {
      day: {
        title: '',
        type: 'Text',
        validators: [
          'required',
          /^([12]?\d{0,1}|3[01]{0,2})$/,
          function (value, formValues) {
            var date = moment(Utils.formatDate(formValues));
            if (!date.isValid()) {
              return {
                type: 'date',
                message: _t('components.datepicker.invalid-date')
              };
            }
          }
        ]
      },
      month: {
        type: 'Select',
        title: '',
        options: MONTHS
      },
      year: {
        title: '',
        type: 'Text',
        validators: ['required', /^([0-9]{0,4})$/]
      },
      time: {
        title: '',
        type: 'Text',
        validators: ['required', /^([01]{1}[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/]
      }
    };
  },

  getFormattedDate: function () {
    return Utils.formatDate(this.toJSON());
  }

});

},{"../../../../helpers/utils":1102,"backbone":"backbone","moment":"moment"}],564:[function(require,module,exports){
var Backbone = require('backbone');
var EditorBaseView = require('./editor-base-view');
var EditorDateFormModel = require('./editor-date-form-model');
require('../../../form-components/index');

module.exports = EditorBaseView.extend({

  tagName: 'div',
  className: 'Table-editorDate',

  initialize: function (opts) {
    EditorBaseView.prototype.initialize.apply(this, arguments);

    this._formModel = new EditorDateFormModel({
      date: this.model.get('value')
    }, {
      parse: true
    });

    this._setValue();
    this._formModel.bind('change', this._setValue, this);
    this.add_related_model(this._formModel);
  },

  render: function () {
    this._formView = new Backbone.Form({
      model: this._formModel
    });

    this._formView.bind('change', function () {
      this.commit();
    });

    this.$el.html(this._formView.render().el);

    return this;
  },

  _setValue: function () {
    this.model.set('value', this._formModel.getFormattedDate());
  },

  clean: function () {
    this._formView.remove();
    EditorBaseView.prototype.clean.apply(this);
  }

});

},{"../../../form-components/index":211,"./editor-base-view":560,"./editor-date-form-model":563,"backbone":"backbone"}],565:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

module.exports = Backbone.Model.extend({

  // Error labels will not be showed, not needed to be translated
  validate: function (attrs, opts) {
    if (attrs.type === 'number' && isNaN(attrs.value)) {
      return 'Number not valid';
    }

    if (attrs.type === 'boolean' && (!_.isBoolean(attrs.value) && attrs.value !== null)) {
      return 'Boolean not valid';
    }
  }

});

},{"backbone":"backbone","underscore":"underscore"}],566:[function(require,module,exports){
var EditorBaseView = require('./editor-base-view');
var ENTER_KEY_CODE = 13;

module.exports = EditorBaseView.extend({

  tagName: 'textarea',
  className: 'Table-editorTextarea CDB-Textarea CDB-Text',

  _onKeyPressed: function (ev) {
    if (!ev.shiftKey && ev.which === ENTER_KEY_CODE) {
      this._onValueChange();
      this._editorModel.confirm();
    }
  }

});

},{"./editor-base-view":560}],567:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--grid u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="25px" height="25px" viewBox="-1 4 25 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <g id="Outline_Icons" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(-1.000000, 4.000000)">\n          <path d="M1.9477838,21.5 C1.6977511,21.5 1.5,21.3016354 1.5,21.0431048 L1.5,1.95689523 C1.5,1.70555616 1.70315066,1.5 1.94113901,1.5 L16.058861,1.5 C16.2975949,1.5 16.5,1.70783627 16.5,1.96250326 L16.5,13.2661378 L17.5,13.2661378 L17.5,1.96250326 C17.5,1.16139088 16.8558926,0.5 16.058861,0.5 L1.94113901,0.5 C1.14821378,0.5 0.5,1.15588925 0.5,1.95689523 L0.5,21.0431048 C0.5,21.8532278 1.1447717,22.5 1.9477838,22.5 L10.0155676,22.5 L10.0155676,21.5 L1.9477838,21.5 Z" id="path-1" fill="#F19243"></path>\n          <rect id="Rectangle-2" fill="#F19243" x="1" y="5" width="16" height="1"></rect>\n          <path d="M23.854,14.646 L21.354,12.146 C21.166,11.958 20.834,11.958 20.647,12.146 L13.146,19.648 C13.089,19.705 13.054,19.773 13.03,19.845 C13.028,19.852 13.021,19.857 13.019,19.865 L12.019,23.365 C11.969,23.539 12.018,23.727 12.146,23.856 C12.241,23.951 12.369,24.002 12.5,24.002 C12.546,24.002 12.592,23.996 12.637,23.983 L16.137,22.983 C16.144,22.981 16.149,22.974 16.157,22.972 C16.229,22.948 16.297,22.913 16.354,22.856 L23.855,15.354 C24.05,15.158 24.05,14.842 23.854,14.646 L23.854,14.646 L23.854,14.646 Z M16,21.795 L14.207,20.002 L19.001,15.207 L20.794,17 L16,21.795 L16,21.795 L16,21.795 Z M13.747,20.957 L15.045,22.255 L13.228,22.775 L13.747,20.957 L13.747,20.957 L13.747,20.957 Z M21.501,16.293 L19.708,14.5 L21.001,13.207 L22.794,15 L21.501,16.293 L21.501,16.293 L21.501,16.293 Z" id="Shape" fill="#F19243"></path>\n        </g>\n      </svg>\n    </div>\n    <div>\n      <h2 class=" CDB-Text CDB-Size-huge is-light u-bSpace--xl">\n        '+
((__t=( _t('components.table.columns.change-type.title', { columnName: columnName, newType: newType }) ))==null?'':_.escape(__t))+
'\n      </h2>\n      <p class="CDB-Text CDB-Size-large u-altTextColor">\n        '+
((__t=( _t('components.table.columns.change-type.desc') ))==null?'':_.escape(__t))+
'\n      </p>\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.table.columns.change-type.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.table.columns.change-type.confirm') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],568:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--grid u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="24px" height="25px" viewbox="521 436 24 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <path d="M524.5,440 L540.5,440 L540.5,460 L524.5,460 L524.5,440 Z M528.5,437 L536.5,437 L536.5,440 L528.5,440 L528.5,437 Z M522,440 L544,440 L522,440 Z M528.5,443.5 L528.5,455.5 L528.5,443.5 Z M532.5,443.5 L532.5,455.5 L532.5,443.5 Z M536.5,443.5 L536.5,455.5 L536.5,443.5 Z" id="Shape" stroke="#F19243" stroke-width="1" fill="none"/>\n      </svg>\n    </div>\n    <div>\n      <h2 class=" CDB-Text CDB-Size-huge is-light u-bSpace--xl">\n        '+
((__t=( _t('components.table.columns.destroy.title', { columnName: name }) ))==null?'':_.escape(__t))+
'\n      </h2>\n      <p class="CDB-Text CDB-Size-large u-altTextColor">'+
((__t=( _t('components.table.columns.destroy.desc') ))==null?'':_.escape(__t))+
'</p>\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.table.columns.destroy.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.table.columns.destroy.confirm') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],569:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--grid u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="25px" height="25px" viewBox="67 153 25 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <g id="Group-Copy" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(67.000000, 153.000000)">\n          <path d="M16,13 L17,13 L17,5.5 C17,5.433 16.986,5.368 16.961,5.308 C16.936,5.247 16.899,5.192 16.853,5.146 L11.854,0.147 C11.808,0.101 11.753,0.064 11.692,0.039 C11.632,0.014 11.567,0 11.5,0 L0.5,0 C0.224,0 0,0.224 0,0.5 L0,21.5 C0,21.776 0.224,22 0.5,22 L9.5,22 L9.5,21 L1,21 L1,1 L11,1 L11,5.5 C11,5.776 11.224,6 11.5,6 L16,6 L16,13 L16,13 Z M12,1.707 L15.293,5 L12,5 L12,1.707 L12,1.707 Z" id="Shape" fill="#F19243"></path>\n          <path d="M23.854,14.646 L21.354,12.146 C21.166,11.958 20.834,11.958 20.647,12.146 L13.146,19.648 C13.089,19.705 13.054,19.773 13.03,19.845 C13.028,19.852 13.021,19.857 13.019,19.865 L12.019,23.365 C11.969,23.539 12.018,23.727 12.146,23.856 C12.241,23.951 12.369,24.002 12.5,24.002 C12.546,24.002 12.592,23.996 12.637,23.983 L16.137,22.983 C16.144,22.981 16.149,22.974 16.157,22.972 C16.229,22.948 16.297,22.913 16.354,22.856 L23.855,15.354 C24.05,15.158 24.05,14.842 23.854,14.646 L23.854,14.646 Z M16,21.795 L14.207,20.002 L19.001,15.207 L20.794,17 L16,21.795 L16,21.795 Z M13.747,20.957 L15.045,22.255 L13.228,22.775 L13.747,20.957 L13.747,20.957 Z M21.501,16.293 L19.708,14.5 L21.001,13.207 L22.794,15 L21.501,16.293 L21.501,16.293 Z" id="Shape" fill="#F19243"></path>\n        </g>\n      </svg>\n    </div>\n    <div>\n      <h2 class=" CDB-Text CDB-Size-huge is-light u-bSpace--m">\n        '+
((__t=( _t('components.table.columns.rename.title', {
          columnName: columnName,
          newName: newName
        }) ))==null?'':_.escape(__t))+
'\n      </h2>\n      <p class="CDB-Text CDB-Size-medium u-altTextColor">\n        '+
((__t=( _t('components.table.columns.rename.desc', {
              columnName: columnName,
              newName: newName
        }) ))==null?'':_.escape(__t))+
'\n      </p>\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.table.columns.rename.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.table.columns.rename.confirm') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],570:[function(require,module,exports){
var $ = require('jquery');
var CoreView = require('backbone/core-view');
var template = require('./table-head-item.tpl');
var ContextMenuView = require('../../context-menu/context-menu-view');
var CustomListCollection = require('../../custom-list/custom-list-collection');
var TableHeadOptionsItemView = require('./table-head-options-item-view');
var tableHeadOptionsItemTemplate = require('./table-head-options-item.tpl');
var ConfirmationModalView = require('../../modals/confirmation/modal-confirmation-view');
var QueryColumnModel = require('../../../data/query-column-model');
var addColumnOperation = require('../operations/table-add-column');
var renameColumnOperation = require('../operations/table-rename-column');
var changeColumnTypeOperation = require('../operations/table-change-column-type');
var removeTableColumnOperation = require('../operations/table-remove-column');
var ENTER_KEY_CODE = 13;
var ESC_KEY_CODE = 27;

/*
 *  Main table view
 */

module.exports = CoreView.extend({

  className: 'Table-headItem',
  tagName: 'th',

  events: {
    'dblclick .js-attribute': '_onAttributeDblClicked',
    'focusout .js-attribute': '_saveNewName',
    'click .js-columnOptions': '_showContextMenu'
  },

  initialize: function (opts) {
    if (!opts.tableViewModel) throw new Error('tableViewModel is required');
    if (!opts.columnsCollection) throw new Error('columnsCollection is required');
    if (!opts.modals) throw new Error('modals is required');

    this._tableViewModel = opts.tableViewModel;
    this._columnsCollection = opts.columnsCollection;
    this._modals = opts.modals;

    this._hideContextMenu = this._hideContextMenu.bind(this);
    this._onKeyDown = this._onKeyDown.bind(this);
  },

  render: function () {
    this.clearSubViews();
    var columnName = this.model.get('name');
    this.$el.html(
      template({
        name: columnName,
        type: this.model.get('type'),
        isOrderBy: this._tableViewModel.get('order_by') === columnName,
        sortBy: this._tableViewModel.get('sort_order'),
        geometry: this.options.simpleGeometry
      })
    );
    return this;
  },

  _hasContextMenu: function () {
    return this._menuView;
  },

  _hideContextMenu: function () {
    this._unhighlightHead();
    this._destroyScrollBinding();
    this._menuView.collection.unbind(null, null, this);
    this.removeView(this._menuView);
    this._menuView.clean();
    delete this._menuView;
  },

  _highlightHead: function () {
    this.$el.addClass('is-highlighted');
  },

  _unhighlightHead: function () {
    this.$el.removeClass('is-highlighted');
  },

  _initScrollBinding: function () {
    $('.Table').scroll(this._hideContextMenu);
  },

  _destroyScrollBinding: function () {
    $('.Table').off('scroll', this._hideContextMenu);
  },

  _showContextMenu: function (ev) {
    var self = this;
    var position = { x: ev.clientX, y: ev.clientY };
    var elementIndex = this.$el.index();
    var modelCID = this.model.cid;
    var columnName = this.model.get('name');

    this._highlightHead();

    var menuItems = [{
      label: _t('components.table.columns.options.order'),
      val: 'order',
      isOrderBy: this._tableViewModel.get('order_by') === columnName,
      sortBy: this._tableViewModel.get('sort_order'),
      action: function (mdl) {
        self._tableViewModel.set({
          sort_order: mdl.get('sort'),
          order_by: columnName
        });
      }
    }];

    if (!this._tableViewModel.isDisabled()) {
      if (!this.model.isCartoDBIDColumn() && !this.model.isGeometryColumn()) {
        menuItems = menuItems.concat([
          {
            label: _t('components.table.columns.options.rename'),
            val: 'rename',
            action: function () {
              self._startEditing();
            }
          }, {
            label: _t('components.table.columns.options.change'),
            type: this.model.get('type'),
            isLastColumns: (this._columnsCollection.size() - elementIndex) < 3,
            val: 'change',
            action: function (mdl) {
              self._changeColumnType(mdl.get('type'));
            }
          }
        ]);
      }

      menuItems.push({
        label: _t('components.table.columns.options.create'),
        val: 'create',
        action: function () {
          self._addColumn();
        }
      });

      if (!this.model.isCartoDBIDColumn() && !this.model.isGeometryColumn()) {
        menuItems.push(
          {
            label: _t('components.table.columns.options.delete'),
            val: 'delete',
            destructive: true,
            action: function () {
              self._removeColumn();
            }
          }
        );
      }
    }

    var collection = new CustomListCollection(menuItems);

    this._menuView = new ContextMenuView({
      className: ContextMenuView.prototype.className + ' Table-columnMenu',
      collection: collection,
      itemTemplate: tableHeadOptionsItemTemplate,
      itemView: TableHeadOptionsItemView,
      triggerElementID: modelCID,
      position: position
    });

    collection.bind('change:selected', function (menuItem) {
      var action = menuItem.get('action');
      action && action(menuItem);
    }, this);

    this._menuView.model.bind('change:visible', function (model, isContextMenuVisible) {
      if (this._hasContextMenu() && !isContextMenuVisible) {
        this._hideContextMenu();
      }
    }, this);

    this._menuView.show();
    this.addView(this._menuView);

    this._initScrollBinding();
  },

  _addColumn: function () {
    addColumnOperation({
      tableViewModel: this._tableViewModel,
      columnsCollection: this._columnsCollection
    });
  },

  _changeColumnType: function (newType) {
    var self = this;
    var oldType = this.model.get('type');
    var isTypeChangeDestructive = QueryColumnModel.isTypeChangeDestructive(oldType, newType);
    if (!isTypeChangeDestructive) {
      changeColumnTypeOperation({
        columnModel: this.model,
        newType: newType
      });
    } else {
      this._modals.create(
        function (modalModel) {
          return new ConfirmationModalView({
            modalModel: modalModel,
            template: require('./modals-templates/change-table-column-type.tpl'),
            renderOpts: {
              columnName: self.model.get('name'),
              newType: newType
            },
            loadingTitle: _t('components.table.columns.change-type.loading', {
              columnName: self.model.get('name')
            }),
            runAction: function () {
              changeColumnTypeOperation({
                columnModel: self.model,
                newType: newType,
                onSuccess: function () {
                  modalModel.destroy();
                },
                onError: function (e) {
                  modalModel.destroy();
                }
              });
            }
          });
        }
      );
    }
  },

  _removeColumn: function () {
    var self = this;
    this._modals.create(
      function (modalModel) {
        return new ConfirmationModalView({
          modalModel: modalModel,
          template: require('./modals-templates/remove-table-column.tpl'),
          renderOpts: {
            name: self.model.get('name')
          },
          loadingTitle: _t('components.table.columns.destroy.loading', {
            columnName: self.model.get('name')
          }),
          runAction: function () {
            removeTableColumnOperation({
              columnModel: self.model,
              onSuccess: function () {
                modalModel.destroy();
              },
              onError: function (e) {
                modalModel.destroy();
              }
            });
          }
        });
      }
    );
  },

  _onAttributeDblClicked: function () {
    if (this.model.isEditable() && !this._tableViewModel.isDisabled()) {
      this._startEditing();
    }
  },

  _initRenameBinds: function () {
    $(document).bind('keydown', this._onKeyDown);
  },

  _destroyRenameBinds: function () {
    $(document).unbind('keydown', this._onKeyDown);
  },

  _onKeyDown: function (ev) {
    var keyCode = ev.which;
    if (keyCode === ENTER_KEY_CODE) {
      this._saveNewName();
    } else if (keyCode === ESC_KEY_CODE) {
      this._finishEditing();
    }
  },

  _startEditing: function () {
    this.$('.js-attribute')
      .addClass('is-active')
      .removeAttr('readonly');

    this._initRenameBinds();
  },

  _finishEditing: function () {
    this.$('.js-attribute')
      .val(this.model.get('name'))
      .removeClass('is-active')
      .attr('readonly', '');

    this._destroyRenameBinds();
  },

  _saveNewName: function () {
    if (this.model.isEditable()) {
      var newName = this.$('.js-attribute').val();
      var columnModel = this.model;
      var oldName = columnModel.get('name');

      if (oldName !== newName && newName !== '') {
        this._modals.create(
          function (modalModel) {
            return new ConfirmationModalView({
              modalModel: modalModel,
              template: require('./modals-templates/rename-table-column.tpl'),
              renderOpts: {
                columnName: oldName,
                newName: newName
              },
              loadingTitle: _t('components.table.columns.rename.loading', {
                columnName: oldName,
                newName: newName
              }),
              runAction: function () {
                renameColumnOperation({
                  columnModel: columnModel,
                  newName: newName,
                  onSuccess: function () {
                    modalModel.destroy();
                  },
                  onError: function (e) {
                    modalModel.destroy();
                  }
                });
              }
            });
          }
        );
      }
    }

    // Setting old name just in case user cancel it
    this._finishEditing();
  },

  clean: function () {
    this._destroyRenameBinds();
    this._destroyScrollBinding();
    CoreView.prototype.clean.apply(this);
  }

});

},{"../../../data/query-column-model":654,"../../context-menu/context-menu-view":39,"../../custom-list/custom-list-collection":47,"../../modals/confirmation/modal-confirmation-view":404,"../operations/table-add-column":576,"../operations/table-change-column-type":578,"../operations/table-remove-column":580,"../operations/table-rename-column":582,"./modals-templates/change-table-column-type.tpl":567,"./modals-templates/remove-table-column.tpl":568,"./modals-templates/rename-table-column.tpl":569,"./table-head-item.tpl":571,"./table-head-options-item-view":572,"./table-head-options-item.tpl":573,"backbone/core-view":1127,"jquery":"jquery"}],571:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="\n    Table-headItemWrapper\n    '+
((__t=( name === 'cartodb_id' || (type === 'geometry' && geometry !== 'point') ? 'Table-headItemWrapper--short' : '' ))==null?'':_.escape(__t))+
'\n  ">\n  <div class="u-flex u-justifySpace">\n    <input class="Table-headItemName CDB-Text CDB-Size-medium is-semibold u-ellipsis js-attribute" value="'+
((__t=( name ))==null?'':_.escape(__t))+
'" title="'+
((__t=( name ))==null?'':_.escape(__t))+
'" readonly />\n\n    ';
 if (isOrderBy) { 
__p+='\n      <i class="CDB-Size CDB-Size-small CDB-IconFont CDB-IconFont-arrowNext\n        Table-columnSorted\n        Table-columnSorted--';
 if (sortBy === 'asc') {
__p+='asc';
 } else {
__p+='desc';
 } 
__p+='\n        u-rSpace u-altTextColor\n      "></i>\n    ';
 } 
__p+='\n\n    <button class="CDB-Shape-threePoints is-blue is-small js-columnOptions">\n      <div class="CDB-Shape-threePointsItem"></div>\n      <div class="CDB-Shape-threePointsItem"></div>\n      <div class="CDB-Shape-threePointsItem"></div>\n    </button>\n  </div>\n  <p class="CDB-Size-small Table-headItemInfo u-altTextColor">'+
((__t=( type ))==null?'':_.escape(__t))+
'</p>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],572:[function(require,module,exports){
var _ = require('underscore');
var CustomListItemView = require('../../custom-list/custom-list-item-view');
var CustomListView = require('../../custom-list/custom-view');
var QueryColumnModel = require('../../../data/query-column-model');

module.exports = CustomListItemView.extend({

  events: _.extend(
    CustomListItemView.prototype.events,
    {
      'click .js-desc': '_onDescClick',
      'click .js-asc': '_onAscClick',
      'click .js-order': 'killEvent'
    }
  ),

  render: function () {
    this.$el.empty();
    this.clearSubViews();

    this.$el.append(
      this.options.template(
        {
          typeLabel: this.options.typeLabel,
          isSelected: this.model.get('selected'),
          isDisabled: this.model.get('disabled'),
          isDestructive: this.model.get('destructive'),
          isOrderBy: this.model.get('isOrderBy'),
          sortBy: this.model.get('sortBy'),
          name: this.model.getName(),
          val: this.model.getValue()
        }
      )
    );

    this.$el
      .attr('data-val', this.model.getValue())
      .toggleClass('is-disabled', !!this.model.get('disabled'));

    return this;
  },

  _onClick: function (ev) {
    this.killEvent(ev);

    if (this.model.getValue() === 'change') {
      this._openSubContextMenu(ev);
    } else {
      this.model.set('selected', true);
    }
  },

  _hideSubContextMenu: function () {
    if (this._subContextMenu) {
      this._subContextMenu.clean();
      this.removeView(this._subContextMenu);
      delete this.collection;
      delete this._subContextMenu;
    }
  },

  _openSubContextMenu: function (ev) {
    if (this._subContextMenu) {
      this._hideSubContextMenu();
    }

    var subContextClassName = 'Table-columnTypeMenu ';
    if (this.model.get('isLastColumns')) {
      subContextClassName += ' Table-columnTypeMenu--toLeft ';
    }

    this._subContextMenu = new CustomListView({
      className: subContextClassName + CustomListView.prototype.className,
      options: [
        {
          label: _t('components.table.columns.types.number'),
          disabled: !QueryColumnModel.isTypeChangeAllowed(this.model.get('type'), 'number'),
          val: 'number'
        }, {
          label: _t('components.table.columns.types.string'),
          disabled: !QueryColumnModel.isTypeChangeAllowed(this.model.get('type'), 'string'),
          val: 'string'
        }, {
          label: _t('components.table.columns.types.date'),
          disabled: !QueryColumnModel.isTypeChangeAllowed(this.model.get('type'), 'date'),
          val: 'date'
        }, {
          label: _t('components.table.columns.types.boolean'),
          disabled: !QueryColumnModel.isTypeChangeAllowed(this.model.get('type'), 'boolean'),
          val: 'boolean'
        }
      ],
      showSearch: false,
      typeLabel: ''
    });

    this._subContextMenu.collection.bind('change:selected', function (menuItem) {
      if (!menuItem.get('disabled')) {
        this.model.set({
          type: menuItem.getValue(),
          selected: true
        });
      }
    }, this);

    this.$el.closest('.Table-columnMenu').append(this._subContextMenu.render().el);
    this._subContextMenu.show();
    this.addView(this._subContextMenu);
  },

  _onAscClick: function (ev) {
    this.killEvent(ev);
    this.model.set({
      sort: 'asc',
      selected: true
    });
  },

  _onDescClick: function (ev) {
    this.killEvent(ev);
    this.model.set({
      sort: 'desc',
      selected: true
    });
  }

});

},{"../../../data/query-column-model":654,"../../custom-list/custom-list-item-view":50,"../../custom-list/custom-view":59,"underscore":"underscore"}],573:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (val === 'order') { 
__p+='\n  <div class="u-flex u-justifySpace CDB-ListDecoration-itemLink js-order">\n    <p class="CDB-Text CDB-Size-medium">'+
((__t=( name ))==null?'':_.escape(__t))+
'</p>\n    <ul class="u-flex">\n      <li class="js-asc">\n        <i class="CDB-Text CDB-IconFont\n          CDB-IconFont-arrowNext u-actionTextColor\n          Table-columnSorted\n          Table-columnSorted--asc\n           ';
 if (isOrderBy && sortBy === 'asc') { 
__p+='is-disabled';
 } 
__p+='\n           ';
 if (isOrderBy && sortBy === 'desc') { 
__p+='is-semibold';
 } 
__p+='\n        "></i>\n      </li>\n      <li class="js-desc u-lSpace--xl">\n        <i class="CDB-Text CDB-IconFont\n          CDB-IconFont-arrowNext u-actionTextColor\n          Table-columnSorted\n          Table-columnSorted--desc\n           ';
 if (isOrderBy && sortBy === 'desc') { 
__p+='is-disabled';
 } 
__p+='\n           ';
 if (isOrderBy && sortBy === 'asc') { 
__p+='is-semibold';
 } 
__p+='\n        "></i>\n      </li>\n    </ul>\n  </div>\n';
 } else if (val === 'change') { 
__p+='\n  <div class="CDB-ListDecoration-itemLink u-actionTextColor u-flex u-justifySpace u-alignCenter" title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">\n    <span>'+
((__t=( name ))==null?'':_.escape(__t))+
'</span>\n    <i class="CDB-Text CDB-Size-small is-semibold CDB-IconFont CDB-IconFont-rArrowLight"></i>\n  </div>\n';
 } else { 
__p+='\n  <div class="CDB-ListDecoration-itemLink\n    ';
 if (isDestructive) { 
__p+='  u-errorTextColor ';
 } else { 
__p+=' u-actionTextColor ';
 } 
__p+='\n    ';
 if (val === 'change') { 
__p+=' u-flex ';
 } 
__p+='\n    " title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">\n    '+
((__t=( name ))==null?'':_.escape(__t))+
'\n    ';
 if (val === 'change') { 
__p+='\n      <span>\n        <i class="CDB-Text CDB-Size-small is-semibold CDB-IconFont CDB-IconFont-rArrowLight"></i>\n      </span>\n    ';
 } 
__p+='\n  </div>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],574:[function(require,module,exports){
var $ = require('jquery');
var CoreView = require('backbone/core-view');
var TableHeadItemView = require('./table-head-item-view');
var template = require('./table-head.tpl');

/*
 *  Main table head view
 */

module.exports = CoreView.extend({
  className: 'Table-head',
  tagName: 'table',

  initialize: function (opts) {
    if (!opts.columnsCollection) throw new Error('columnsCollection is required');
    if (!opts.tableViewModel) throw new Error('tableViewModel is required');
    if (!opts.queryGeometryModel) throw new Error('queryGeometryModel is required');
    if (!opts.modals) throw new Error('modals is required');

    this._columnsCollection = opts.columnsCollection;
    this._tableViewModel = opts.tableViewModel;
    this._queryGeometryModel = opts.queryGeometryModel;
    this._modals = opts.modals;

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this.$el.append(template());
    this._columnsCollection.each(this._renderColumnHead, this);
    return this;
  },

  _initBinds: function () {
    this._queryGeometryModel.bind('change:simple_geom', this.render, this);
    this.add_related_model(this._queryGeometryModel);
    this._tableViewModel.bind('change:sort_order change:order_by', this.render, this);
    this.add_related_model(this._tableViewModel);
    this._columnsCollection.bind('reset', function () {
      this.render();

      if (this._newColumn) {
        var scrollWidth = this.$el.get(0).scrollWidth;

        setTimeout(function () {
          this._scrollToLeft({
            pos: scrollWidth
          });
        }.bind(this), 500);

        delete this._newColumn;
      }
    }, this);
    this._columnsCollection.bind('add', function (mdl) {
      this._newColumn = mdl;
    }, this);
    this.add_related_model(this._columnsCollection);
  },

  _renderColumnHead: function (mdl) {
    if (!this._tableViewModel.isDisabled() && mdl.get('name') === 'the_geom_webmercator') {
      return;
    }

    var view = new TableHeadItemView({
      model: mdl,
      modals: this._modals,
      columnsCollection: this._columnsCollection,
      tableViewModel: this._tableViewModel,
      simpleGeometry: this._queryGeometryModel.get('simple_geom')
    });
    this.$('.js-headRow').append(view.render().el);
    this.addView(view);
  },

  _scrollToLeft: function (opts) {
    opts = opts || {};
    $('.Table').animate({
      scrollLeft: opts.pos || 0
    }, opts.speed || 'slow');
  }

});

},{"./table-head-item-view":570,"./table-head.tpl":575,"backbone/core-view":1127,"jquery":"jquery"}],575:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<thead>\n  <tr class="js-headRow"></tr>\n</thead>\n';
}
return __p;
};

},{"underscore":"underscore"}],576:[function(require,module,exports){
var Notifier = require('../../../components/notifier/notifier');
var errorParser = require('../../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.columnsCollection) throw new Error('columnsCollection is required');

  var columnsCollection = opts.columnsCollection;
  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;
  var notification = Notifier.addNotification({
    status: 'loading',
    info: _t('components.table.columns.create.loading'),
    closable: false
  });

  columnsCollection.addColumn({
    success: function (mdl, attrs) {
      successCallback && successCallback(mdl, attrs);
      notification.set({
        status: 'success',
        info: _t('components.table.columns.create.success', { columnName: attrs.name }),
        closable: true
      });
    },
    error: function (mdl, e) {
      errorCallback && errorCallback(mdl, e);
      notification.set({
        status: 'error',
        info: _t('components.table.columns.create.error', { error: errorParser(e) }),
        closable: true
      });
    }
  });
};

},{"../../../components/notifier/notifier":475,"../../../helpers/error-parser":1090}],577:[function(require,module,exports){
var Notifier = require('../../../components/notifier/notifier');
var errorParser = require('../../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.rowsCollection) { throw new Error('rowsCollection is required'); }

  var rowsCollection = opts.rowsCollection;
  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;
  var notification = Notifier.addNotification({
    status: 'loading',
    info: _t('components.table.rows.create.loading'),
    closable: false
  });

  rowsCollection.addRow({
    success: function (mdl, attrs) {
      successCallback && successCallback(mdl, attrs);
      notification.set({
        status: 'success',
        info: _t('components.table.rows.create.success'),
        closable: true
      });
    },
    error: function (mdl, e) {
      errorCallback && errorCallback(mdl, e);
      notification.set({
        status: 'error',
        info: _t('components.table.rows.create.error', { error: errorParser(e) }),
        closable: true
      });
    }
  });
};

},{"../../../components/notifier/notifier":475,"../../../helpers/error-parser":1090}],578:[function(require,module,exports){
var Notifier = require('../../../components/notifier/notifier');
var errorParser = require('../../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.columnModel) { throw new Error('columnModel is required'); }
  if (!opts.newType) { throw new Error('newType is required'); }

  var columnModel = opts.columnModel;
  var newType = opts.newType;

  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;

  var notification = Notifier.addNotification({
    status: 'loading',
    info: _t('components.table.columns.change-type.loading', {
      columnName: columnModel.get('name')
    }),
    closable: false
  });

  columnModel.save({
    type: newType
  }, {
    wait: true,
    success: function (mdl, attrs) {
      successCallback && successCallback(mdl, attrs);
      notification.set({
        status: 'success',
        info: _t('components.table.columns.change-type.success', {
          columnName: columnModel.get('name'),
          newType: newType
        }),
        closable: true
      });
    },
    error: function (mdl, e) {
      errorCallback && errorCallback(mdl, e);
      notification.set({
        status: 'error',
        info: _t('components.table.columns.change-type.error', {
          columnName: columnModel.get('name'),
          newType: newType,
          error: errorParser(e)
        }),
        closable: true
      });
    }
  });
};

},{"../../../components/notifier/notifier":475,"../../../helpers/error-parser":1090}],579:[function(require,module,exports){
var Notifier = require('../../../components/notifier/notifier');
var errorParser = require('../../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.rowModel) throw new Error('rowModel is required');
  if (opts.newValue === undefined) throw new Error('newValue is required');
  if (!opts.attribute) throw new Error('attribute is required');

  var rowModel = opts.rowModel;
  var newValue = opts.newValue;
  var attribute = opts.attribute;
  var cartodbId = rowModel.get('cartodb_id');
  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;
  var notification = Notifier.addNotification({
    status: 'loading',
    info: _t('components.table.rows.edit.loading', {
      attribute: attribute,
      cartodbId: cartodbId
    }),
    closable: false
  });

  // In order to preserve "previous" attribute
  rowModel.set(attribute, newValue);
  rowModel.save(null, {
    success: function (mdl, attrs) {
      successCallback && successCallback(mdl, attrs);
      notification.set({
        status: 'success',
        info: _t('components.table.rows.edit.success', {
          attribute: attribute,
          cartodbId: cartodbId
        }),
        closable: true
      });
    },
    error: function (mdl, e) {
      errorCallback && errorCallback(mdl, e);
      notification.set({
        status: 'error',
        info: _t('components.table.rows.edit.error', {
          attribute: attribute,
          cartodbId: cartodbId,
          error: errorParser(e)
        }),
        closable: true
      });
    }
  });
};

},{"../../../components/notifier/notifier":475,"../../../helpers/error-parser":1090}],580:[function(require,module,exports){
var Notifier = require('../../../components/notifier/notifier');
var errorParser = require('../../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.columnModel) { throw new Error('columnModel is required'); }

  var columnModel = opts.columnModel;
  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;
  var notification = Notifier.addNotification({
    status: 'loading',
    info: _t('components.table.columns.destroy.loading', { columnName: columnModel.get('name') }),
    closable: false
  });

  columnModel.destroy({
    wait: true,
    success: function (mdl, attrs) {
      successCallback && successCallback(mdl, attrs);
      notification.set({
        status: 'success',
        info: _t('components.table.columns.destroy.success', { columnName: columnModel.get('name') }),
        closable: true
      });
    },
    error: function (mdl, e) {
      errorCallback && errorCallback(mdl, e);
      notification.set({
        status: 'error',
        info: _t('components.table.columns.destroy.error', {
          columnName: columnModel.get('name'),
          error: errorParser(e)
        }),
        closable: true
      });
    }
  });
};

},{"../../../components/notifier/notifier":475,"../../../helpers/error-parser":1090}],581:[function(require,module,exports){
var Notifier = require('../../../components/notifier/notifier');
var errorParser = require('../../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.rowModel) { throw new Error('rowModel is required'); }

  var rowModel = opts.rowModel;
  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;
  var cartodbId = rowModel.get('cartodb_id');
  var notification = Notifier.addNotification({
    status: 'loading',
    info: _t('components.table.rows.destroy.loading', { cartodb_id: cartodbId }),
    closable: false
  });

  rowModel.destroy({
    wait: true,
    success: function (mdl, attrs) {
      successCallback && successCallback(mdl, attrs);
      notification.set({
        status: 'success',
        info: _t('components.table.rows.destroy.success', { cartodb_id: cartodbId }),
        closable: true
      });
    },
    error: function (mdl, e) {
      errorCallback && errorCallback(mdl, e);
      notification.set({
        status: 'error',
        info: _t('components.table.rows.destroy.error', { cartodb_id: cartodbId, error: errorParser(e) }),
        closable: true
      });
    }
  });
};

},{"../../../components/notifier/notifier":475,"../../../helpers/error-parser":1090}],582:[function(require,module,exports){
var Notifier = require('../../../components/notifier/notifier');
var errorParser = require('../../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.columnModel) { throw new Error('columnModel is required'); }
  if (!opts.newName) { throw new Error('newName is required'); }

  var columnModel = opts.columnModel;
  var oldName = columnModel.get('name');
  var newName = opts.newName;

  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;

  var notification = Notifier.addNotification({
    status: 'loading',
    info: _t('components.table.columns.rename.loading', { oldName: oldName, newName: newName }),
    closable: false
  });

  columnModel.save({
    new_name: newName,
    old_name: columnModel.get('name')
  }, {
    wait: true,
    success: function (mdl, attrs) {
      successCallback && successCallback(mdl, attrs);
      notification.set({
        status: 'success',
        info: _t('components.table.columns.rename.success', {
          columnName: oldName,
          newName: newName
        }),
        closable: true
      });
    },
    error: function (mdl, e) {
      errorCallback && errorCallback(mdl, e);
      notification.set({
        status: 'error',
        info: _t('components.table.columns.rename.error', {
          columnName: oldName,
          newName: newName,
          error: errorParser(e)
        }),
        closable: true
      });
    }
  });
};

},{"../../../components/notifier/notifier":475,"../../../helpers/error-parser":1090}],583:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-LoaderIcon is-dark">\n  <svg class="CDB-LoaderIcon-spinner" viewbox="0 0 50 50">\n    <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"/>\n  </svg>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],584:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./table-paginator.tpl');
var templateLoader = require('./table-paginator-loader.tpl');
var Notifier = require('../../../components/notifier/notifier');
var errorParser = require('../../../helpers/error-parser');

module.exports = CoreView.extend({

  tagName: 'div',
  className: 'Table-paginator js-tablePaginator',

  events: {
    'click .js-prev': '_onPrevPage',
    'click .js-next': '_onNextPage'
  },

  initialize: function (opts) {
    if (!opts.rowsCollection) throw new Error('rowsCollection is required');
    if (!opts.tableViewModel) throw new Error('tableViewModel is required');

    this._tableViewModel = opts.tableViewModel;
    this._rowsCollection = opts.rowsCollection;

    this._rowsCollection.bind('loading', function (item) {
      // Don't take into account row model loading triggers
      if (item.models) {
        this._isLoading = true;
      }
    }, this);
    this._rowsCollection.bind('add remove', this.render, this);
    this._tableViewModel.bind('change:page', this._onTablePageChange, this);
    this.add_related_model(this._tableViewModel);
    this.add_related_model(this._rowsCollection);
  },

  render: function () {
    var rowsSize = this._rowsCollection.size();
    var page = this._tableViewModel.get('page');
    var maxRowsPerPage = this._rowsCollection.DEFAULT_FETCH_OPTIONS.rows_per_page;

    this.$el.html(
      template({
        page: this._tableViewModel.get('page'),
        size: rowsSize,
        isNextAvailable: rowsSize >= maxRowsPerPage,
        isPrevAvailable: page > 0
      })
    );

    this.$el.toggleClass('Table-paginator--relative', !!this._tableViewModel.get('relativePositionated'));
    return this;
  },

  _onTablePageChange: function () {
    this._rowsCollection.fetch({
      data: _.extend(
        this._tableViewModel.pick('page', 'order_by', 'sort_order'),
        {
          exclude: !this._tableViewModel.isCustomQueryApplied() ? ['the_geom_webmercator'] : []
        }
      ),
      error: function (mdl, response) {
        this._isLoading = false;
        this.render();

        Notifier.addNotification({
          status: 'error',
          info: _t('components.table.rows.paginator.error', { error: errorParser(response) }),
          closable: true
        });
      }.bind(this)
    });
  },

  _onPrevPage: function (ev) {
    if (!this._isLoading) {
      this.$('.js-prev').html(templateLoader());
      this._tableViewModel.set('page', this._tableViewModel.get('page') - 1);
    }
  },

  _onNextPage: function (ev) {
    if (!this._isLoading) {
      this.$('.js-next').html(templateLoader());
      this._tableViewModel.set('page', this._tableViewModel.get('page') + 1);
    }
  }

});

},{"../../../components/notifier/notifier":475,"../../../helpers/error-parser":1090,"./table-paginator-loader.tpl":583,"./table-paginator.tpl":585,"backbone/core-view":1127,"underscore":"underscore"}],585:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button class="Table-paginatorButton Table-paginatorButton--prev\n  ';
 if (isPrevAvailable) { 
__p+='\n    js-prev\n  ';
 } 
__p+='\n">\n  <i class="CDB-Text is-semibold CDB-IconFont CDB-IconFont-lArrowLight CDB-Size-small\n  ';
 if (isPrevAvailable) { 
__p+='\n    u-actionTextColor\n  ';
 } else { 
__p+='\n    u-hintTextColor\n  ';
 } 
__p+='\n  "></i>\n</button>\n<p class="Table-paginatorText CDB-Text CDB-Size-small is-semibold u-upperCase">\n  ';
 if (!size) {
__p+='\n   <span class="u-mainTextColor">…</span>\n  ';
 } else { 
__p+='\n    <span class="u-mainTextColor">'+
((__t=( (page * 40) + 1 ))==null?'':_.escape(__t))+
'</span>\n    <span class="u-altTextColor u-lSpace u-rSpace">'+
((__t=( _t('components.table.rows.paginator.to') ))==null?'':_.escape(__t))+
'</span>\n    <span class="u-mainTextColor">'+
((__t=( (page * 40) + size ))==null?'':_.escape(__t))+
'</span>\n  ';
 } 
__p+='\n</p>\n<button class="Table-paginatorButton Table-paginatorButton--next\n  ';
 if (isNextAvailable) { 
__p+='\n    js-next\n  ';
 } 
__p+='\n">\n  <i class="CDB-Text is-semibold CDB-IconFont CDB-IconFont-rArrowLight CDB-Size-small\n  ';
 if (isNextAvailable) { 
__p+='\n    u-actionTextColor\n  ';
 } else { 
__p+='\n    u-hintTextColor\n  ';
 } 
__p+='\n  "></i>\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],586:[function(require,module,exports){
var TableView = require('./table-view');
var QueryColumnsCollection = require('../../data/query-columns-collection');
var TableNameUtils = require('../../helpers/table-name-utils');
var checkAndBuildOpts = require('../../helpers/required-opts');

var REQUIRED_OPTS = [
  'analysisDefinitionNodeModel',
  'configModel',
  'modals',
  'userModel'
];

/**
 *  Table manager that generates necessary models/collections
 *  for the view
 *
 */

module.exports = {
  create: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    // Adds the owner username if it's in an organization and the table name is not already qualified
    var tableName = this._analysisDefinitionNodeModel.get('table_name');
    var userName = TableNameUtils.getUsername(tableName) || this._userModel.get('username');
    tableName = TableNameUtils.getQualifiedTableName(
      tableName,
      userName,
      this._userModel.isInsideOrg()
    );

    var querySchemaModel = this._analysisDefinitionNodeModel.querySchemaModel;

    var columnsCollection = new QueryColumnsCollection(
      querySchemaModel.columnsCollection.toJSON(),
      {
        configModel: this._configModel,
        tableName: tableName,
        querySchemaModel: querySchemaModel
      }
    );

    return new TableView({
      relativePositionated: opts.relativePositionated,
      modals: this._modals,
      analysisDefinitionNodeModel: this._analysisDefinitionNodeModel,
      columnsCollection: columnsCollection,
      tableName: tableName
    });
  },

  destroy: function (tableView) {
    if (!tableView) throw new Error('tableView object is needed');
    tableView.clean();
  }
};

},{"../../data/query-columns-collection":655,"../../helpers/required-opts":1097,"../../helpers/table-name-utils":1101,"./table-view":588}],587:[function(require,module,exports){
var Backbone = require('backbone');

/**
 *  Table view model
 */

module.exports = Backbone.Model.extend({
  defaults: {
    page: 0,
    order_by: '',
    sort_order: '',
    readonly: false,
    tableName: ''
  },

  initialize: function (attrs, opts) {
    if (!opts.analysisDefinitionNodeModel) throw new Error('analysisDefinitionNodeModel is required');
    if (!opts.columnsCollection) throw new Error('columnsCollection is required');

    this._analysisDefinitionNodeModel = opts.analysisDefinitionNodeModel;
    this._columnsCollection = opts.columnsCollection;

    this._setOrderAndSort();

    this.listenTo(this._columnsCollection, 'reset', this._setOrderAndSort);
  },

  _setOrderAndSort: function () {
    var hasCartodbId = this._columnsCollection.where({name: 'cartodb_id'}).length;

    if (hasCartodbId && !this.isCustomQueryApplied()) {
      this.set({
        'order_by': 'cartodb_id',
        'sort_order': 'asc'
      }, {
        silent: true
      });
    }
  },

  resetFetchDefaults: function () {
    this.set({
      page: this.defaults.page,
      order_by: '',
      sort_order: ''
    }, {
      silent: true
    });
  },

  isDisabled: function () {
    return this._analysisDefinitionNodeModel.isReadOnly();
  },

  isCustomQueryApplied: function () {
    return this._analysisDefinitionNodeModel.isCustomQueryApplied();
  }
});

},{"backbone":"backbone"}],588:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var $ = require('jquery');
var TableViewModel = require('./table-view-model.js');
var TableHeadView = require('./head/table-head-view');
var TableBodyView = require('./body/table-body-view');
var addTableRow = require('./operations/table-add-row');
var addTableColumn = require('./operations/table-add-column');
var SQLUtils = require('../../helpers/sql-utils');
var checkAndBuildOpts = require('../../helpers/required-opts');

var REQUIRED_OPTS = [
  'analysisDefinitionNodeModel',
  'columnsCollection',
  'modals'
];

/*
 *  Main table view
 */

module.exports = CoreView.extend({

  className: 'Table-wrapper',
  tagName: 'div',

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._rowsCollection = this._analysisDefinitionNodeModel.queryRowsCollection;
    this._queryGeometryModel = this._analysisDefinitionNodeModel.queryGeometryModel;
    this._querySchemaModel = this._analysisDefinitionNodeModel.querySchemaModel;
    this._tableModel = this._analysisDefinitionNodeModel.isSourceType() && this._analysisDefinitionNodeModel.getTableModel();

    this._tableViewModel = new TableViewModel({
      relativePositionated: opts.relativePositionated,
      tableName: opts.tableName
    }, {
      analysisDefinitionNodeModel: this._analysisDefinitionNodeModel,
      columnsCollection: this._columnsCollection
    });

    this._initBinds();

    if (this._queryGeometryModel.shouldFetch()) {
      this._queryGeometryModel.fetch();
    }

    if (this._querySchemaModel.shouldFetch()) {
      this._querySchemaModel.fetch();
    } else if (this._rowsCollection.shouldFetch()) {
      this._fetchRowsData();
    }
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    var tableElement = $('<div>').addClass('Table js-table');
    this.$el.append(tableElement);
    this._initViews();

    this.$('.js-table').toggleClass('Table--relative', !!this._tableViewModel.get('relativePositionated'));
    this._setDisableState();
    return this;
  },

  _initBinds: function () {
    this._onChangeQueryOrStatus = this._onChangeQueryOrStatus.bind(this);

    this.listenTo(this._querySchemaModel, 'change:query change:status', _.debounce(this._onChangeQueryOrStatus, 100));
    this.listenTo(this._querySchemaModel, 'change:status', this._setDisableState);
    this.listenTo(this._querySchemaModel, 'change:query', this._onQueryChanged);
    this.listenTo(this._querySchemaModel, 'change:status', this._fetchRowsData);
    this.listenTo(this._tableViewModel, 'change:sort_order change:order_by', this._fetchRowsData);

    if (this._tableModel && this._tableModel.isSync()) {
      var syncModel = this._tableModel.getSyncModel();
      this.listenTo(syncModel, 'destroy', this.render);
    }
  },

  _setDisableState: function () {
    this.$('.js-table').toggleClass('is-disabled', !!this._tableViewModel.isDisabled());
  },

  _fetchRowsData: function (mdl) {
    var attrsChanged = mdl && _.keys(mdl.changed);
    var altersData = SQLUtils.altersData(this._querySchemaModel.get('query'));
    var isCustomQueryApplied = this._tableViewModel.isCustomQueryApplied();
    var changeComeFromSortOrOrder = false;

    if (attrsChanged && (_.contains(attrsChanged, 'sort_order') || _.contains(attrsChanged, 'order_by'))) {
      changeComeFromSortOrOrder = true;
    }

    if (this._querySchemaModel.isFetched() && !altersData) {
      this._rowsCollection.fetch({
        data: {
          page: this._tableViewModel.get('page'),
          order_by: !isCustomQueryApplied || changeComeFromSortOrOrder ? this._tableViewModel.get('order_by') : '',
          sort_order: !isCustomQueryApplied || changeComeFromSortOrOrder ? this._tableViewModel.get('sort_order') : '',
          exclude: !isCustomQueryApplied || changeComeFromSortOrOrder ? ['the_geom_webmercator'] : []
        }
      });
    }
  },

  _initViews: function () {
    var tableHeadView = new TableHeadView({
      modals: this._modals,
      queryGeometryModel: this._queryGeometryModel,
      columnsCollection: this._columnsCollection,
      tableViewModel: this._tableViewModel
    });

    this.addView(tableHeadView);
    this.$('.js-table').append(tableHeadView.render().el);

    var tableBodyView = new TableBodyView({
      modals: this._modals,
      columnsCollection: this._columnsCollection,
      rowsCollection: this._rowsCollection,
      queryGeometryModel: this._queryGeometryModel,
      querySchemaModel: this._querySchemaModel,
      tableViewModel: this._tableViewModel
    });

    this.addView(tableBodyView);
    this.$('.js-table').append(tableBodyView.render().el);
  },

  _onChangeQueryOrStatus: function () {
    var schemaStatus = this._querySchemaModel.get('status');
    var geometryStatus = this._queryGeometryModel.get('status');

    if (schemaStatus === 'unfetched' && this._querySchemaModel.canFetch()) {
      this._querySchemaModel.fetch();
    }

    if (geometryStatus === 'unfetched' && this._queryGeometryModel.canFetch()) {
      this._queryGeometryModel.fetch();
    }
  },

  addRow: function () {
    addTableRow({
      tableViewModel: this._tableViewModel,
      rowsCollection: this._rowsCollection
    });
  },

  addColumn: function () {
    addTableColumn({
      tableViewModel: this._tableViewModel,
      columnsCollection: this._columnsCollection
    });
  },

  getColumnsCollection: function () {
    return this._columnsCollection;
  },

  _onQueryChanged: function () {
    this._tableViewModel.resetFetchDefaults();
  },

  // Remove elements that are not applied in the view
  remove: function () {
    $('.Table-paginator').remove();
    CoreView.prototype.remove.apply(this);
  }

});

},{"../../helpers/required-opts":1097,"../../helpers/sql-utils":1099,"./body/table-body-view":554,"./head/table-head-view":574,"./operations/table-add-column":576,"./operations/table-add-row":577,"./table-view-model.js":587,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],589:[function(require,module,exports){
var CoreView = require('backbone/core-view');
require('tipsy');

/**
 *  Tipsy tooltip view.
 *
 *  - Needs an element to work.
 *  - Inits tipsy library.
 *  - Clean bastard tipsy bindings easily.
 *
 */

module.exports = CoreView.extend({
  options: {
    gravity: 's',
    opacity: 1,
    fade: true
  },

  initialize: function (opts) {
    if (!opts.el) throw new Error('Element is needed to have tipsy tooltip working');
    this._tipsyOpenedManually = opts.trigger === 'manual';
    this._initTipsy();
  },

  _initTipsy: function () {
    this.$el.tipsy(this.options);
    this.tipsy = this.$el.data('tipsy');
  },

  showTipsy: function () {
    this.$el.tipsy('show');
  },

  hideTipsy: function () {
    this.$el.tipsy('hide');
  },

  destroyTipsy: function () {
    if (this.tipsy) {
      // tipsy does not return this
      this.tipsy.hide();
      this.$el.unbind('mouseleave mouseenter');
    }
    if (this._tipsyOpenedManually) {
      this.$el.tipsy('hide');
    }

    this.$el.removeData('tipsy');
    delete this.tipsy;
  },

  clean: function () {
    this.destroyTipsy();
  }
});

},{"backbone/core-view":1127,"tipsy":1136}],590:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./toggler.tpl');

module.exports = CoreView.extend({

  className: 'Toggle',

  events: {
    'click .js-input': '_onClick'
  },

  initialize: function (opts) {
    if (!opts.editorModel) throw new Error('editorModel should be provided');

    this._editorModel = opts.editorModel;
    this._labelsArray = opts.labels;
    this._isDisableable = opts.isDisableable;

    this.listenTo(this._editorModel, 'change:edition', this.render);
    this.listenTo(this._editorModel, 'change:disabled', this.render);
    this.add_related_model(this._editorModel);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initViews: function () {
    var checked = this._editorModel.get('edition');
    var disabled = this._editorModel.get('disabled') && this._isDisableable;

    var _template = template({
      labels: this._labelsArray,
      checked: checked,
      disabled: disabled
    });

    this.$el.append(_template);
    return this;
  },

  _onClick: function () {
    var checked = this._editorModel.get('edition');
    this._editorModel.set({ edition: !checked });
  }
});

},{"./toggler.tpl":591,"backbone/core-view":1127}],591:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Text CDB-Size-small is-semibold u-rSpace--xl';
 if (disabled) { 
__p+=' is-disabled';
 } 
__p+='">\n  <label class="u-iBlock u-upperCase">'+
((__t=( labels[0] ))==null?'':_.escape(__t))+
'</label>\n  <input class="CDB-Toggle u-iBlock js-input" type="checkbox"\n    ';
 if (disabled) { 
__p+=' disabled';
 } 
__p+='\n    ';
 if (checked) { 
__p+=' checked ';
 } 
__p+=' >\n  <span class="u-iBlock CDB-ToggleFace"></span>\n  <label class="u-iBlock u-upperCase">'+
((__t=( labels[1] ))==null?'':_.escape(__t))+
'</label>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],592:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./undo-redo.tpl');

module.exports = CoreView.extend({
  events: {
    'click .js-redo': '_onRedoClick',
    'click .js-undo': '_onUndoClick',
    'click .js-apply': '_onApplyClick',
    'click .js-clear': '_onClearClick'
  },

  options: {
    applyButton: false,
    cancelButton: false
  },

  initialize: function (opts) {
    if (!opts.editorModel) throw new Error('editorModel is required');
    if (!opts.trackModel) throw new Error('trackModel is required');

    this._trackModel = opts.trackModel;
    this._editorModel = opts.editorModel;
    this._clearModel = opts.clearModel;

    this._initBinds();
  },

  render: function () {
    var canClear = false;
    if (this._clearModel) {
      canClear = this._clearModel.get('visible') === true;
    }

    this.$el.html(
      template({
        canUndo: this._trackModel.canUndo(),
        canRedo: this._trackModel.canRedo(),
        canApply: this.options.applyButton && this._editorModel.isEditing(),
        canClear: canClear
      })
    );
    this._checkButtonsStyle();
    return this;
  },

  _initBinds: function () {
    this._trackModel.bind('undo redo', this.render, this);
    this._trackModel.bind('unredoChanged', this.render, this);
    this._editorModel.bind('change:edition', this._checkButtonsStyle, this);
    this.add_related_model(this._trackModel);
    this.add_related_model(this._editorModel);

    if (this._clearModel) {
      this._clearModel.bind('change', this.render, this);
      this.add_related_model(this._clearModel);
    }
  },

  _onUndoClick: function () {
    if (this._trackModel.canUndo()) {
      this._trackModel.undo();
    }
  },

  _onRedoClick: function () {
    if (this._trackModel.canRedo()) {
      this._trackModel.redo();
    }
  },

  _onApplyClick: function () {
    if (this.options.applyButton && this.options.onApplyClick) {
      this.options.onApplyClick();
    }
  },

  _onClearClick: function () {
    if (this.options.clearButton && this.options.onClearClick) {
      this.options.onClearClick();
    }
  },

  _checkButtonsStyle: function (m) {
    var editing = this._editorModel.isEditing();
    this._getIcons().toggleClass('u-whiteTextColor', editing);
  },

  _getIcons: function () {
    return this.$('.js-theme');
  }
});

},{"./undo-redo.tpl":593,"backbone/core-view":1127}],593:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-alignCenter">\n  <button class="js-undo">\n    <i class="CDB-IconFont CDB-IconFont-undo Size-large u-actionTextColor js-theme ';
 if (!canUndo) { 
__p+='is-disabled';
 } 
__p+='"></i>\n  </button>\n  <button class="u-lSpace--xl js-redo">\n    <i class="CDB-IconFont CDB-IconFont-redo Size-large u-actionTextColor js-theme ';
 if (!canRedo) { 
__p+='is-disabled';
 } 
__p+='"></i>\n  </button>\n  ';
 if (canClear) { 
__p+='\n  <button class="u-lSpace--xl CDB-Button CDB-Button--secondary CDB-Button--white js-clear">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small">'+
((__t=( _t('components.undo-redo.clear') ))==null?'':_.escape(__t))+
'</span>\n  </button>\n  ';
 } 
__p+='\n  ';
 if (canApply) { 
__p+='\n  <button class="u-lSpace--xl CDB-Button CDB-Button--primary js-apply">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small">'+
((__t=( _t('components.undo-redo.apply') ))==null?'':_.escape(__t))+
'</span>\n  </button>\n  ';
 } 
__p+='\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],594:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');

/**
 * Convenient factory to create views without having to create new files.
 */
module.exports = {

  /**
   * @param {String} html e.g. '<div>whatever</div>'
   * @param {Object,undefined} viewOpts view options, .e.g {className: 'Whatever'}
   * @return {Object} instance of CoreView, which takes two params of template and templateData
   */
  createByHTML: function (html, viewOpts) {
    var view = new CoreView(viewOpts);
    view.render = function () {
      this.$el.html(html);
      return this;
    };

    return view;
  },

  /**
   * @param {Function} template e.g. from a `require('-/my-template.tpl')`
   * @param {Object,undefined} templatedata
   * @param {Object,undefined} viewOpts view options, .e.g {className: 'Whatever'}
   * @return {Object} instance of CoreView, which takes two params of template and templateData
   */
  createByTemplate: function (template, templateData, viewOpts) {
    var view = new CoreView(viewOpts);
    view.render = function () {
      this.$el.html(
        template(templateData)
      );
      return this;
    };

    return view;
  },

  /**
   * Creates an anonymous view to render a list of views as one.
   * Useful when wanting to interact with other components that requires a single view as content.
   *
   * @example
   *   var createViewList = [
   *     function() { return new HeaderView({…}); },
   *     function() { return new ItemsView({…}); },
   *     function() { return new FooterView({…}); }
   *   ]
   *   viewFactory.createListView(createViewList, {className: 'jsdoc-example'})
   *
   * @param {Array} fns - list of functions, each which should return a view representing an item in the list
   * @param {Object} viewOpts
   * @return {Object} A view
   */
  createListView: function (createViewFns, viewOpts) {
    if (!(createViewFns && createViewFns.forEach)) throw new Error('createViewFns is required as an iterable list');
    if (!_.all(createViewFns, _.isFunction)) throw new Error('createViewFns must only contain functions');

    var listView = new CoreView(viewOpts);

    listView.render = function () {
      this.clearSubViews();

      createViewFns.forEach(function (createItemView) {
        var view = createItemView();
        this.addView(view);
        this.$el.append(view.render().el);
      }, this);

      return this;
    };

    return listView;
  }
};

},{"backbone/core-view":1127,"underscore":"underscore"}],595:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./panel-with-options.tpl');
var InfoboxView = require('../../components/infobox/infobox-view');

module.exports = CoreView.extend({
  initialize: function (opts) {
    if (!opts.createContentView) throw new Error('createContentView factory function is mandatory');
    if (!opts.editorModel) throw new Error('editorModel is required');

    this.template = this.options.template || template;

    this._createContentView = opts.createContentView;
    this._editorModel = opts.editorModel;
    this._createControlView = opts.createControlView;
    this._createActionView = opts.createActionView;
    this._infoboxModel = opts.infoboxModel;
    this._infoboxCollection = opts.infoboxCollection;

    this._editorModel.on('change:edition', this._setStyleMenu, this);
    this.add_related_model(this._editorModel);
  },

  render: function () {
    var contentView;
    var controlView;
    var actionView;
    var infoboxView;

    this.clearSubViews();
    this.$el.empty();

    this.$el.html(this.template());

    contentView = this._createContentView();

    this._content().html(contentView.render().el);
    this.addView(contentView);

    if (this._infoboxModel) {
      infoboxView = new InfoboxView({
        infoboxModel: this._infoboxModel,
        infoboxCollection: this._infoboxCollection
      });

      this._info().html(infoboxView.render().el);
      this.addView(infoboxView);
    }

    if (this._createControlView) {
      controlView = this._createControlView();
      this._controls().html(controlView.render().el);
      this.addView(controlView);
    }

    if (this._createActionView) {
      actionView = this._createActionView();
      this._actions().html(actionView.render().el);
      this.addView(actionView);
    }

    this._setStyleMenu();

    return this;
  },

  _content: function () {
    return this.$('.js-content');
  },

  _controls: function () {
    return this.$('.js-controls');
  },

  _actions: function () {
    return this.$('.js-actions');
  },

  _info: function () {
    return this.$('.js-info');
  },

  _setStyleMenu: function () {
    this.$('.js-theme').toggleClass('is-dark', this._editorModel.isEditing());
  }
});

},{"../../components/infobox/infobox-view":221,"./panel-with-options.tpl":596,"backbone/core-view":1127}],596:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-content js-content"></div>\n<div class="js-info"></div>\n<ul class="Options-bar u-flex u-justifySpace js-theme js-optionsBar">\n  <li class="CDB-InfoBox-footerItem js-controls"></li>\n  <li class="CDB-InfoBox-footerItem CDB-InfoBox-footerItem--right js-actions"></li>\n</ul>';
}
return __p;
};

},{"underscore":"underscore"}],597:[function(require,module,exports){
/**
 *  Default upload config
 */

module.exports = {
  uploadStates: [
    'pending',
    'enqueued',
    'uploading',
    'unpacking',
    'importing',
    'guessing',
    'complete'
  ],
  fileExtensions: [
    'csv',
    'xls',
    'xlsx',
    'zip',
    'kml',
    'geojson',
    'json',
    'ods',
    'kmz',
    'tsv',
    'gpx',
    'tar',
    'gz',
    'tgz',
    'osm',
    'bz2',
    'tif',
    'tiff',
    'txt',
    'rar'
  ],
  // How big should the file be?
  fileTimesBigger: 3
};

},{}],598:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var PermissionModel = require('./permission-model');
var OWN_ATTR_NAMES = ['id', 'username', 'avatar_url', 'name'];

module.exports = Backbone.Model.extend({
  defaults: {
    access: 'r'
  },

  isOwn: function (model) {
    return model.id === this.get('entity').id;
  },

  validate: function (attrs, options) {
    if (attrs.access !== PermissionModel.READ_ONLY && attrs.access !== PermissionModel.READ_WRITE) {
      return "access can't take 'r' or 'rw' values";
    }
  },

  toJSON: function () {
    var entity = _.pick(this.get('entity').toJSON(), OWN_ATTR_NAMES);
    // translate name to username
    if (!entity.username) {
      entity.username = entity.name;
      delete entity.name;
    }
    return {
      type: this.get('type') || 'user',
      entity: entity,
      access: this.get('access')
    };
  }
});

},{"./permission-model":653,"backbone":"backbone","underscore":"underscore"}],599:[function(require,module,exports){
var _ = require('underscore');
var camshaftReference = require('./camshaft-reference');
var AreaOfInfluenceFormModel = require('../editor/layers/layer-content-views/analyses/analysis-form-models/area-of-influence-form-model');
var AggregateIntersectionFormModel = require('../editor/layers/layer-content-views/analyses/analysis-form-models/aggregate-intersection-form-model');
var FilterIntersectionFormModel = require('../editor/layers/layer-content-views/analyses/analysis-form-models/filter-intersection-form-model');
var FallbackFormModel = require('../editor/layers/layer-content-views/analyses/analysis-form-models/fallback-form-model');
var UnknownTypeFormModel = require('../editor/layers/layer-content-views/analyses/analysis-form-models/unknown-type-form-model');
var MergeAnalysisOptionModel = require('../components/modals/add-analysis/analysis-option-models/merge-analysis-option-model');
var DataServicesApiCheck = require('../editor/layers/layer-content-views/analyses/analyses-quota/analyses-quota-info');

var DAO_TYPES = ['age-and-gender', 'boundaries', 'education', 'employment', 'families', 'housing', 'income', 'language', 'migration', 'nationality', 'population-segments', 'race-and-ethnicity', 'religion', 'transportation'];

var MAP = {
  'aggregate-intersection': {
    title: _t('analyses.aggregate-intersection.short-title'),
    FormModel: AggregateIntersectionFormModel,
    modalTitle: _t('components.modals.add-analysis.option-types.aggregate-intersection.title'),
    modalDesc: _t('components.modals.add-analysis.option-types.aggregate-intersection.desc'),
    modalCategory: 'data_transformation',
    onboardingTemplate: require('../components/onboardings/analysis/analyses/aggregate-intersection.tpl'),
    animationTemplate: require('../components/modals/add-analysis/animation-templates/intersect.tpl')
  },
  'bounding-box': {
    title: _t('analyses.bounding-box.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/group-points-form-model'),
    onboardingTemplate: require('../components/onboardings/analysis/analyses/group-points.tpl'),
    genericType: 'group-points'
  },
  'bounding-circle': {
    title: _t('analyses.bounding-circle.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/group-points-form-model'),
    onboardingTemplate: require('../components/onboardings/analysis/analyses/group-points.tpl'),
    genericType: 'group-points'
  },
  'buffer': {
    title: _t('analyses.area-of-influence.short-title'),
    FormModel: AreaOfInfluenceFormModel,
    modalTitle: _t('components.modals.add-analysis.option-types.area-of-influence.title'),
    modalDesc: _t('components.modals.add-analysis.option-types.area-of-influence.desc'),
    modalCategory: 'data_transformation',
    onboardingTemplate: require('../components/onboardings/analysis/analyses/area-of-influence.tpl'),
    animationTemplate: require('../components/modals/add-analysis/animation-templates/aoi.tpl'),
    genericType: 'area-of-influence'
  },
  'centroid': {
    title: _t('analyses.centroid.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/centroid-form-model'),
    modalTitle: _t('components.modals.add-analysis.option-types.centroid.title'),
    modalDesc: _t('components.modals.add-analysis.option-types.centroid.desc'),
    modalCategory: 'data_transformation',
    onboardingTemplate: require('../components/onboardings/analysis/analyses/centroid.tpl'),
    animationTemplate: require('../components/modals/add-analysis/animation-templates/centroid.tpl'),
    genericType: 'centroid'
  },
  'convex-hull': {
    title: _t('analyses.convex-hull.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/group-points-form-model'),
    modalTitle: _t('components.modals.add-analysis.option-types.group-points.title'),
    modalDesc: _t('components.modals.add-analysis.option-types.group-points.desc'),
    modalCategory: 'data_transformation',
    onboardingTemplate: require('../components/onboardings/analysis/analyses//group-points.tpl'),
    animationTemplate: require('../components/modals/add-analysis/animation-templates/group-points.tpl'),
    animationParams: {
      method: _t('analyses-onboarding.placeholders.method')
    },
    genericType: 'group-points'
  },
  'concave-hull': {
    title: _t('analyses.concave-hull.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/group-points-form-model'),
    onboardingTemplate: require('../components/onboardings/analysis/analyses/group-points.tpl'),
    genericType: 'group-points'
  },
  'data-observatory-measure': {
    title: _t('analyses.data-observatory-measure.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/data-observatory-measure-model'),
    modalTitle: _t('components.modals.add-analysis.option-types.data-observatory-measure.title'),
    modalDesc: _t('components.modals.add-analysis.option-types.data-observatory-measure.desc'),
    modalCategory: 'create_clean',
    checkIfEnabled: function (configModel) {
      return checkIfDataObservatoryIsEnabled(configModel);
    },
    onboardingTemplate: require('../components/onboardings/analysis/analyses/data-observatory-measure.tpl'),
    animationTemplate: require('../components/modals/add-analysis/animation-templates/data-observatory-measure.tpl'),
    genericType: 'data-observatory-measure'
  },
  'filter-by-node-column': {
    title: _t('analyses.filter-by-node-column.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/filter-by-node-column'),
    modalTitle: _t('components.modals.add-analysis.option-types.filter-by-node-column.title'),
    modalDesc: _t('components.modals.add-analysis.option-types.filter-by-node-column.desc'),
    modalCategory: 'create_clean',
    onboardingTemplate: require('../components/onboardings/analysis/analyses/filter-by-node-column.tpl'),
    animationTemplate: require('../components/modals/add-analysis/animation-templates/filter-by-layer.tpl'),
    animationParams: {
      name_of_the_layer: _t('analyses-onboarding.placeholders.layer-name')
    }
  },
  'filter-category': {
    title: _t('analyses.filter.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/filter-form-model'),
    onboardingTemplate: require('../components/onboardings/analysis/analyses/filter.tpl'),
    genericType: 'filter'
  },
  'filter-range': {
    title: _t('analyses.filter.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/filter-form-model'),
    modalTitle: _t('components.modals.add-analysis.option-types.filter.title'),
    modalDesc: _t('components.modals.add-analysis.option-types.filter.desc'),
    modalCategory: 'data_transformation',
    onboardingTemplate: require('../components/onboardings/analysis/analyses/filter.tpl'),
    animationTemplate: require('../components/modals/add-analysis/animation-templates/filter-by-column-value.tpl'),
    genericType: 'filter'
  },
  'georeference-city': {
    title: _t('analyses.georeference.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/georeference-form-model'),
    checkIfEnabled: function (configModel) {
      return checkIfInternalGeocodingIsEnabled(configModel);
    },
    onboardingTemplate: require('../components/onboardings/analysis/analyses/georeference.tpl'),
    genericType: 'georeference'
  },
  'georeference-ip-address': {
    title: _t('analyses.georeference.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/georeference-form-model'),
    checkIfEnabled: function (configModel) {
      return checkIfInternalGeocodingIsEnabled(configModel);
    },
    onboardingTemplate: require('../components/onboardings/analysis/analyses/georeference.tpl'),
    genericType: 'georeference'
  },
  'georeference-country': {
    title: _t('analyses.georeference.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/georeference-form-model'),
    checkIfEnabled: function (configModel) {
      return checkIfInternalGeocodingIsEnabled(configModel);
    },
    onboardingTemplate: require('../components/onboardings/analysis/analyses/georeference.tpl'),
    genericType: 'georeference'
  },
  'georeference-long-lat': {
    title: _t('analyses.georeference.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/georeference-form-model'),
    modalTitle: _t('components.modals.add-analysis.option-types.georeference.title'),
    modalDesc: _t('components.modals.add-analysis.option-types.georeference.desc'),
    modalCategory: 'create_clean',
    onboardingTemplate: require('../components/onboardings/analysis/analyses/georeference.tpl'),
    animationTemplate: require('../components/modals/add-analysis/animation-templates/georeference.tpl'),
    genericType: 'georeference'
  },
  'georeference-postal-code': {
    title: _t('analyses.georeference.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/georeference-form-model'),
    checkIfEnabled: function (configModel) {
      return checkIfInternalGeocodingIsEnabled(configModel);
    },
    onboardingTemplate: require('../components/onboardings/analysis/analyses/georeference.tpl'),
    genericType: 'georeference'
  },
  'georeference-street-address': {
    title: _t('analyses.georeference.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/georeference-form-model'),
    checkIfEnabled: function (configModel) {
      return checkIfExternalGeocodingIsEnabled(configModel);
    },
    onboardingTemplate: require('../components/onboardings/analysis/analyses/georeference.tpl'),
    genericType: 'georeference'
  },
  'georeference-admin-region': {
    title: _t('analyses.georeference.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/georeference-form-model'),
    checkIfEnabled: function (configModel) {
      return checkIfInternalGeocodingIsEnabled(configModel);
    },
    onboardingTemplate: require('../components/onboardings/analysis/analyses/georeference.tpl'),
    genericType: 'georeference'
  },
  'intersection': {
    title: _t('analyses.filter-intersection.short-title'),
    FormModel: FilterIntersectionFormModel,
    modalTitle: _t('components.modals.add-analysis.option-types.filter-intersection.title'),
    modalDesc: _t('components.modals.add-analysis.option-types.filter-intersection.desc'),
    modalCategory: 'data_transformation',
    onboardingTemplate: require('../components/onboardings/analysis/analyses/intersection.tpl'),
    animationTemplate: require('../components/modals/add-analysis/animation-templates/filter-by-polygon.tpl')
  },
  'kmeans': {
    title: _t('analyses.kmeans.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/kmeans-form-model'),
    modalTitle: _t('components.modals.add-analysis.option-types.kmeans.title'),
    modalDesc: _t('components.modals.add-analysis.option-types.kmeans.desc'),
    modalCategory: 'analyze_predict',
    onboardingTemplate: require('../components/onboardings/analysis/analyses/kmeans.tpl'),
    animationTemplate: require('../components/modals/add-analysis/animation-templates/kmeans.tpl'),
    animationParams: {
      method: _t('analyses-onboarding.placeholders.clusters')
    }
  },
  'line-to-column': {
    title: _t('analyses.connect-with-lines.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/connect-with-lines-form-model'),
    onboardingTemplate: require('../components/onboardings/analysis/analyses/connect-with-lines.tpl'),
    animationTemplate: require('../components/modals/add-analysis/animation-templates/connect-with-lines.tpl'),
    genericType: 'connect-with-lines'
  },
  'line-to-single-point': {
    title: _t('analyses.connect-with-lines.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/connect-with-lines-form-model'),
    modalTitle: _t('components.modals.add-analysis.option-types.connect-with-lines.title'),
    modalDesc: _t('components.modals.add-analysis.option-types.connect-with-lines.desc'),
    modalCategory: 'data_transformation',
    onboardingTemplate: require('../components/onboardings/analysis/analyses/connect-with-lines.tpl'),
    animationTemplate: require('../components/modals/add-analysis/animation-templates/connect-with-lines.tpl'),
    genericType: 'connect-with-lines'
  },
  'line-source-to-target': {
    title: _t('analyses.connect-with-lines.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/connect-with-lines-form-model'),
    onboardingTemplate: require('../components/onboardings/analysis/analyses/connect-with-lines.tpl'),
    animationTemplate: require('../components/modals/add-analysis/animation-templates/connect-with-lines.tpl'),
    genericType: 'connect-with-lines'
  },
  'line-sequential': {
    title: _t('analyses.connect-with-lines.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/connect-with-lines-form-model'),
    onboardingTemplate: require('../components/onboardings/analysis/analyses/connect-with-lines.tpl'),
    animationTemplate: require('../components/modals/add-analysis/animation-templates/connect-with-lines.tpl'),
    genericType: 'connect-with-lines'
  },
  'merge': {
    title: _t('analyses.merge.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/merge-form-model'),
    modalTitle: _t('components.modals.add-analysis.option-types.merge.title'),
    modalDesc: _t('components.modals.add-analysis.option-types.merge.desc'),
    ModalModel: MergeAnalysisOptionModel,
    modalCategory: 'create_clean',
    onboardingTemplate: require('../components/onboardings/analysis/analyses/merge.tpl'),
    animationTemplate: require('../components/modals/add-analysis/animation-templates/join-two-columns.tpl')
  },
  'moran': {
    title: _t('analyses.moran-cluster.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/moran-form-model'),
    modalTitle: _t('components.modals.add-analysis.option-types.moran-cluster.title'),
    modalDesc: _t('components.modals.add-analysis.option-types.moran-cluster.desc'),
    modalCategory: 'analyze_predict',
    onboardingTemplate: require('../components/onboardings/analysis/analyses/moran.tpl'),
    animationTemplate: require('../components/modals/add-analysis/animation-templates/outliers.tpl')
  },
  'routing-sequential': {
    title: _t('analyses.routing.short-title'),
    FormModel: FallbackFormModel,
    checkIfEnabled: function (configModel) {
      return checkIfRoutingIsEnabled(configModel);
    }
  },
  'routing-to-layer-all-to-all': {
    title: _t('analyses.routing.short-title'),
    FormModel: FallbackFormModel,
    checkIfEnabled: function (configModel) {
      return checkIfRoutingIsEnabled(configModel);
    }
  },
  'routing-to-single-point': {
    title: _t('analyses.routing.short-title'),
    FormModel: FallbackFormModel,
    checkIfEnabled: function (configModel) {
      return checkIfRoutingIsEnabled(configModel);
    }
  },
  'sampling': {
    title: _t('analyses.sampling.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/sampling-form-model'),
    modalTitle: _t('components.modals.add-analysis.option-types.sampling.title'),
    modalDesc: _t('components.modals.add-analysis.option-types.sampling.desc'),
    modalCategory: 'data_transformation',
    onboardingTemplate: require('../components/onboardings/analysis/analyses/sampling.tpl'),
    animationTemplate: require('../components/modals/add-analysis/animation-templates/sampling.tpl'),
    animationParams: {
      percentage: _t('analyses-onboarding.placeholders.percentage')
    },
    genericType: 'sampling'
  },
  'spatial-markov-trend': {
    title: _t('analyses.spatial-markov-trend.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/spatial-markov-trend-model'),
    modalTitle: _t('components.modals.add-analysis.option-types.spatial-markov-trend.title'),
    modalDesc: _t('components.modals.add-analysis.option-types.spatial-markov-trend.desc'),
    modalCategory: 'analyze_predict',
    onboardingTemplate: require('../components/onboardings/analysis/analyses/spatial-markov-trend.tpl'),
    animationTemplate: require('../components/modals/add-analysis/animation-templates/predict-trends.tpl')
  },
  'trade-area': {
    title: _t('analyses.area-of-influence.short-title'),
    FormModel: AreaOfInfluenceFormModel,
    checkIfEnabled: function (configModel) {
      if (!configModel) throw new Error('configModel is required');
      return !!configModel.dataServiceEnabled('isolines');
    },
    onboardingTemplate: require('../components/onboardings/analysis/analyses/area-of-influence.tpl'),
    genericType: 'area-of-influence'
  },
  'weighted-centroid': {
    title: _t('analyses.centroid.short-title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/centroid-form-model'),
    onboardingTemplate: require('../components/onboardings/analysis/analyses/centroid.tpl'),
    genericType: 'centroid'
  },
  'closest': {
    title: _t('editor.layers.analysis-form.find-nearest.title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/closest-form-model'),
    modalTitle: _t('editor.layers.analysis-form.find-nearest.modal-title'),
    modalDesc: _t('editor.layers.analysis-form.find-nearest.modal-desc'),
    modalCategory: 'analyze_predict',
    animationTemplate: require('../components/modals/add-analysis/animation-templates/closest.tpl'),
    onboardingTemplate: require('../components/onboardings/analysis/analyses/closest.tpl')
  },
  'deprecated-sql-function': {
    title: _t('editor.layers.analysis-form.deprecated-sql-function.title'),
    FormModel: require('../editor/layers/layer-content-views/analyses/analysis-form-models/deprecated-sql-function-form-model'),
    modalTitle: _t('components.modals.add-analysis.option-types.deprecated-sql-function.title'),
    modalDesc: _t('components.modals.add-analysis.option-types.deprecated-sql-function.desc'),
    modalCategory: 'data_transformation',
    checkIfEnabled: function (configModel, userModel) {
      return userModel.featureEnabled('deprecated-sql-function');
    }
  }
};

var checkIfInternalGeocodingIsEnabled = function (configModel) {
  if (!configModel) throw new Error('configModel is required');
  return isDataServicesReady(configModel) && !!configModel.dataServiceEnabled('geocoder_internal');
};

var checkIfRoutingIsEnabled = function (configModel) {
  if (!configModel) throw new Error('configModel is required');
  return isDataServicesReady(configModel) && !!configModel.dataServiceEnabled('routing');
};

var checkIfExternalGeocodingIsEnabled = function (configModel) {
  if (!configModel) throw new Error('configModel is required');
  return isDataServicesReady(configModel) && !!configModel.dataServiceEnabled('hires_geocoder');
};

var checkIfDataObservatoryIsEnabled = function (configModel) {
  if (!configModel) throw new Error('configModel is required');
  return isDataServicesReady(configModel) && !!configModel.dataServiceEnabled('data_observatory');
};

var definitionByType = function (m) {
  var type = 'unknown';

  if (typeof m === 'string' && m !== '') {
    type = m;
  } else if (m && m.get) {
    type = m.get('type');

    if (type === 'data-observatory-measure' && m.has('measurement')) {
      var measurement = m.get('measurement').toLowerCase().split(' ').join('-');

      if (_.contains(DAO_TYPES, measurement)) {
        var measurementType = _.clone(MAP[type]);
        measurementType.title = _t('analyses.data-observatory-measure.' + measurement);
        return measurementType;
      }
    }
  }

  return MAP[type] || {
    title: _t('analyses.' + type),
    FormModel: FallbackFormModel
  };
};

var isDataServicesReady = function (configModel) {
  return DataServicesApiCheck.get(configModel).isReady();
};

var isAnalysisValidByType = function (type, configModel, userModel) {
  var analysis = MAP[type];
  return analysis && analysis.checkIfEnabled ? analysis.checkIfEnabled(configModel, userModel) : true;
};

module.exports = {
  MAP: MAP,

  findFormModelByType: function (type) {
    return camshaftReference.hasType(type)
      ? definitionByType(type).FormModel
      : UnknownTypeFormModel;
  },

  getAnalysesByModalCategory: function (category, configModel, userModel) {
    return _.reduce(MAP, function (memo, item, analysisType) {
      if (item.modalCategory === category) {
        if (isAnalysisValidByType(analysisType, configModel, userModel)) {
          var obj = {
            nodeAttrs: {
              type: analysisType
            },
            title: item.modalTitle,
            desc: item.modalDesc
          };

          if (item.ModalModel) {
            obj.Model = item.ModalModel;
          }

          memo.push(obj);
        }
      }

      return memo;
    }, []);
  },

  isAnalysisValidByType: function (type, configModel, userModel) {
    return isAnalysisValidByType(type, configModel, userModel);
  },

  getAnalysisByType: function (type) {
    return MAP[type];
  },

  title: function (m) {
    return definitionByType(m).title;
  }
};

},{"../components/modals/add-analysis/analysis-option-models/merge-analysis-option-model":244,"../components/modals/add-analysis/animation-templates/aoi.tpl":250,"../components/modals/add-analysis/animation-templates/centroid.tpl":251,"../components/modals/add-analysis/animation-templates/closest.tpl":252,"../components/modals/add-analysis/animation-templates/connect-with-lines.tpl":253,"../components/modals/add-analysis/animation-templates/data-observatory-measure.tpl":254,"../components/modals/add-analysis/animation-templates/filter-by-column-value.tpl":255,"../components/modals/add-analysis/animation-templates/filter-by-layer.tpl":256,"../components/modals/add-analysis/animation-templates/filter-by-polygon.tpl":257,"../components/modals/add-analysis/animation-templates/georeference.tpl":258,"../components/modals/add-analysis/animation-templates/group-points.tpl":259,"../components/modals/add-analysis/animation-templates/intersect.tpl":260,"../components/modals/add-analysis/animation-templates/join-two-columns.tpl":261,"../components/modals/add-analysis/animation-templates/kmeans.tpl":262,"../components/modals/add-analysis/animation-templates/outliers.tpl":263,"../components/modals/add-analysis/animation-templates/predict-trends.tpl":264,"../components/modals/add-analysis/animation-templates/sampling.tpl":265,"../components/onboardings/analysis/analyses//group-points.tpl":486,"../components/onboardings/analysis/analyses/aggregate-intersection.tpl":477,"../components/onboardings/analysis/analyses/area-of-influence.tpl":478,"../components/onboardings/analysis/analyses/centroid.tpl":479,"../components/onboardings/analysis/analyses/closest.tpl":480,"../components/onboardings/analysis/analyses/connect-with-lines.tpl":481,"../components/onboardings/analysis/analyses/data-observatory-measure.tpl":482,"../components/onboardings/analysis/analyses/filter-by-node-column.tpl":483,"../components/onboardings/analysis/analyses/filter.tpl":484,"../components/onboardings/analysis/analyses/georeference.tpl":485,"../components/onboardings/analysis/analyses/group-points.tpl":486,"../components/onboardings/analysis/analyses/intersection.tpl":487,"../components/onboardings/analysis/analyses/kmeans.tpl":488,"../components/onboardings/analysis/analyses/merge.tpl":489,"../components/onboardings/analysis/analyses/moran.tpl":490,"../components/onboardings/analysis/analyses/sampling.tpl":491,"../components/onboardings/analysis/analyses/spatial-markov-trend.tpl":492,"../editor/layers/layer-content-views/analyses/analyses-quota/analyses-quota-info":796,"../editor/layers/layer-content-views/analyses/analysis-form-models/aggregate-intersection-form-model":812,"../editor/layers/layer-content-views/analyses/analysis-form-models/area-of-influence-form-model":815,"../editor/layers/layer-content-views/analyses/analysis-form-models/centroid-form-model":821,"../editor/layers/layer-content-views/analyses/analysis-form-models/closest-form-model":823,"../editor/layers/layer-content-views/analyses/analysis-form-models/connect-with-lines-form-model":825,"../editor/layers/layer-content-views/analyses/analysis-form-models/data-observatory-measure-model":832,"../editor/layers/layer-content-views/analyses/analysis-form-models/deprecated-sql-function-form-model":834,"../editor/layers/layer-content-views/analyses/analysis-form-models/fallback-form-model":836,"../editor/layers/layer-content-views/analyses/analysis-form-models/filter-by-node-column":837,"../editor/layers/layer-content-views/analyses/analysis-form-models/filter-form-model":840,"../editor/layers/layer-content-views/analyses/analysis-form-models/filter-intersection-form-model":842,"../editor/layers/layer-content-views/analyses/analysis-form-models/georeference-form-model":849,"../editor/layers/layer-content-views/analyses/analysis-form-models/group-points-form-model":856,"../editor/layers/layer-content-views/analyses/analysis-form-models/kmeans-form-model":863,"../editor/layers/layer-content-views/analyses/analysis-form-models/merge-form-model":865,"../editor/layers/layer-content-views/analyses/analysis-form-models/moran-form-model":867,"../editor/layers/layer-content-views/analyses/analysis-form-models/sampling-form-model":869,"../editor/layers/layer-content-views/analyses/analysis-form-models/spatial-markov-trend-model":871,"../editor/layers/layer-content-views/analyses/analysis-form-models/unknown-type-form-model":873,"./camshaft-reference":615,"underscore":"underscore"}],600:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var syncAbort = require('./backbone/sync-abort');

/**
 * Analysis definition model.
 * Points to a node that is the head of the particular analysis.
 */
module.exports = Backbone.Model.extend({

  /**
   * @override {Backbone.prototype.sync} abort ongoing request if there is any
   */
  sync: syncAbort,

  initialize: function (attrs, opts) {
    if (!opts.analysisDefinitionNodesCollection) throw new Error('analysisDefinitionNodesCollection is required');

    this.USER_SAVED = false; // flag to indicate if the user saved the node and avoid triggering the onboarding model if they didn't

    this._analysisDefinitionNodesCollection = opts.analysisDefinitionNodesCollection;
  },

  parse: function (r, opts) {
    // If parse is called on a new model it have not yet called initialize and thus don't have the collection
    var nodesCollection = this._analysisDefinitionNodesCollection || opts.analysisDefinitionNodesCollection;

    // Merge and parse are used to sync all nodes in a definition with the backend response
    nodesCollection.add(r.analysis_definition, {silent: true, merge: true, parse: true});

    var attrs = _.omit(r, 'analysis_definition');
    attrs.node_id = r.analysis_definition.id;

    return attrs;
  },

  toJSON: function () {
    return {
      id: this.id,
      analysis_definition: this.getNodeDefinitionModel().toJSON()
    };
  },

  containsNode: function (other) {
    var nodeDefModel = this.getNodeDefinitionModel();
    return !!(nodeDefModel && nodeDefModel.containsNode(other));
  },

  getNodeDefinitionModel: function () {
    return this._analysisDefinitionNodesCollection.get(this.get('node_id'));
  }

});

},{"./backbone/sync-abort":607,"backbone":"backbone","underscore":"underscore"}],601:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var camshaftReference = require('./camshaft-reference');
var QueryGeometryModel = require('./query-geometry-model');
var QuerySchemaModel = require('./query-schema-model');
var nodeIds = require('../value-objects/analysis-node-ids');
var checkAndBuildOpts = require('../helpers/required-opts');
var QueryRowsCollection = require('./query-rows-collection');
var fetchAllQueryObjects = require('../helpers/fetch-all-query-objects');

var REQUIRED_OPTS = [
  'configModel'
];

/**
 *  Base model for an analysis definition node.
 *  May point to one or multiple nodes in turn (referenced by ids).
 *
 *
 *  Analysis-definition-node-model
 *   ├── Query-Schema-Model
 *   ├── Query-Geometry-Model
 *   └── Query-Rows-Collection
 */
module.exports = Backbone.Model.extend({

  initialize: function (attrs, opts) {
    if (!this.id) throw new Error('id is required');

    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    var modelOpts = {
      configModel: this._configModel,
      userModel: opts.userModel
    };

    var simpleGeom = this.get('simple_geom');

    this.querySchemaModel = new QuerySchemaModel(undefined, modelOpts);

    this.queryGeometryModel = new QueryGeometryModel({
      simple_geom: simpleGeom,
      status: simpleGeom ? 'fetched' : 'unfetched'
    }, modelOpts);

    this.queryRowsCollection = new QueryRowsCollection([], {
      configModel: this._configModel,
      userModel: opts.userModel,
      tableName: '',
      querySchemaModel: this.querySchemaModel
    });

    this.listenTo(this.queryGeometryModel, 'change:simple_geom', this._onGeometryTypeChanged);
  },

  fetchQueryObjects: function () {
    if (this.get('status') === 'ready' && !this.get('error')) {
      fetchAllQueryObjects({
        queryGeometryModel: this.queryGeometryModel,
        querySchemaModel: this.querySchemaModel,
        queryRowsCollection: this.queryRowsCollection
      });
    }
  },

  /**
   * @override {Backbone.prototype.parse}  flatten the provided analysis data and create source nodes if there are any.
   */
  parse: function (r, opts) {
    // Allow omitting type when merging into an existing node
    var sourceNames = (!r.type && opts.merge) ? [] : camshaftReference.getSourceNamesForAnalysisType(r.type);

    var parsedParams = _.reduce(r.params, function (memo, val, name) {
      var sourceName = sourceNames[sourceNames.indexOf(name)];

      if (sourceName) {
        this.collection.add(val, opts);
        memo[name] = val.id;
      } else {
        memo[name] = val;
      }

      return memo;
    }, {}, this);

    var parsedOptions = _.reduce(r.options, function (memo, val, name) {
      memo[name] = val;
      return memo;
    }, {}, this);

    return _.defaults(
      _.omit(r, 'params', 'options'),
      parsedOptions,
      parsedParams
    );
  },

  /**
   * @override {Backbone.prototype.toJSON} unflatten the internal structure to the expected nested JSON data structure.
   * @param {Object} options
   * @param {Boolean} options.skipOptions - Add or not analysis options to the definition
   */
  toJSON: function (options) {
    options = options || {};

    var analysisParams = [];
    var paramsforJSON = {};
    var paramsForType = camshaftReference.paramsForType(this.get('type'));

    // Undo the parsing of the params previously done in .parse() (when model was created)
    for (var name in paramsForType) {
      var param = paramsForType[name];
      var val = this.get(name);
      var includeParamInJSON = true;

      if (param.type === 'node') {
        var node = this.collection.get(val);
        if (node) {
          val = node.toJSON(options);
        } else if (param.optional) { // Node has no value but is optional. We don't serialize it.
          includeParamInJSON = false;
        } else { // Node has no value and is required. Throw error.
          throw new Error('no node found for param "' + name + '" with id "' + val + '" in node ' + JSON.stringify(this.attributes));
        }
      }

      if (includeParamInJSON) {
        paramsforJSON[name] = val;
        analysisParams.push(name);
      }
    }

    var json = {
      id: this.get('id'),
      type: this.get('type'),
      params: paramsforJSON
    };

    // style_history is not sent at all (neither inside params nor options). It is always set by the backend.
    var optionsAttrs = _.omit(this.attributes, analysisParams.concat('id', 'type', 'status', 'style_history'));
    if (!(options.skipOptions || _.isEmpty(optionsAttrs))) {
      json['options'] = optionsAttrs;
    }

    return json;
  },

  /**
   * @override {Backbone.prototype.isNew} for this.destroy() to work (not try to send DELETE request)
   */
  isNew: function () {
    return true;
  },

  isReadOnly: function () {
    // By default, any node should be read only by default, except the source node (with exceptions)
    return true;
  },

  isCustomQueryApplied: function () {
    // By default, any node shouldn't have a custom query applied, except the source node
    return false;
  },

  canBeDeletedByUser: function () {
    return this.hasPrimarySource();
  },

  hasFailed: function () {
    return this.get('status') === 'failed';
  },

  isDone: function () {
    return this.get('status') === 'ready';
  },

  destroy: function () {
    if (this.querySchemaModel) {
      this.querySchemaModel.destroy();
      this.querySchemaModel = null;
    }

    return Backbone.Model.prototype.destroy.apply(this, arguments);
  },

  /**
   * Creates a new node that have same params as the current node, with only the id differing.
   * @param {String} newId - e.g. 'b1'
   * @return {Object} instance of analysis-definition-node-model
   */
  clone: function (newId) {
    if (!newId) throw new Error('newId is required');
    if (!_.isString(newId) || newId.length < 2) throw new Error('newId is required as a non-empty string');
    if (newId === this.id) throw new Error('newId must be different from current id, ' + this.id);

    var attrs = this.toJSON();
    attrs.id = newId;
    return this.collection.add(attrs);
  },

  linkedListBySameLetter: function () {
    var list = [this];
    var prev = this;
    var letter = this.letter();

    while (true) {
      var current = prev.getPrimarySource();
      if (current && current.letter() === letter) {
        list.push(current);
        prev = current;
      } else {
        break;
      }
    }

    return list;
  },

  /**
   * @return {Boolean, null} null if the geoemtry type of this node is not known,
   *   this is to indicate that the query model is not ready yet, up to caller to make the call or not
   */
  isValidAsInputForType: function (analysisType) {
    if (analysisType === 'source') return false;

    var geometry = this.queryGeometryModel.get('simple_geom');
    return geometry
      ? camshaftReference.isValidInputGeometryForType(geometry, analysisType)
      : null;
  },

  containsNode: function (other) {
    if (!other) return false;
    return this.id === other.id || this._sourcesContains(other);
  },

  hasPrimarySource: function () {
    return !!this.getPrimarySource();
  },

  hasSecondarySource: function () {
    return !!this.getSecondarySource();
  },

  getPrimarySource: function () {
    return this.collection.get(this._getPrimarySourceId());
  },

  getSecondarySource: function () {
    // Assumption: there are only 1-2 sources, so secondary is the one that's not the primary
    var primarySourceId = this._getPrimarySourceId();
    var secondarySourceId = _.find(this.sourceIds(), function (sourceId) {
      return sourceId !== primarySourceId;
    });
    return this.collection.get(secondarySourceId);
  },

  // Default query by default is the query already applied in the node.
  // For source node is totally different
  getDefaultQuery: function () {
    return this.get('query');
  },

  /**
   * @return {Array} e.g. ['c3', 'b2']
   */
  sourceIds: function () {
    return _.map(this._sourceNames(), function (sourceName) {
      return this.get(sourceName);
    }, this);
  },

  changeSourceIds: function (currentId, newId, silenty) {
    this._sourceNames().forEach(function (sourceName) {
      if (this.get(sourceName) === currentId) {
        this.set(sourceName, newId, { silent: silenty });
      }
    }, this);
  },

  isSourceType: function () {
    return this.get('type') === 'source';
  },

  letter: function () {
    return nodeIds.letter(this.id);
  },

  getStyleHistoryForLayer: function (layer_id) {
    var styleHistory = this.get('style_history');
    return styleHistory && styleHistory[layer_id];
  },

  // Private methods

  _sourcesContains: function (other) {
    var primarySource = this.getPrimarySource();
    var secondarySource = this.getSecondarySource();
    return !!(
      (primarySource && primarySource.containsNode(other)) ||
      (secondarySource && secondarySource.containsNode(other))
    );
  },

  _getPrimarySourceId: function () {
    var primarySourceName = this.get('primary_source_name') || this._sourceNames()[0];
    return this.get(primarySourceName);
  },

  /**
   * @return {Array} e.g. ['polygons_source', 'points_source']
   */
  _sourceNames: function () {
    return camshaftReference.getSourceNamesForAnalysisType(this.get('type'));
  },

  _onGeometryTypeChanged: function (m, value) {
    this.set('simple_geom', value);
  }

});

},{"../helpers/fetch-all-query-objects":1092,"../helpers/required-opts":1097,"../value-objects/analysis-node-ids":1119,"./camshaft-reference":615,"./query-geometry-model":656,"./query-rows-collection":658,"./query-schema-model":659,"backbone":"backbone","underscore":"underscore"}],602:[function(require,module,exports){
var AnalysisDefinitionNodeModel = require('./analysis-definition-node-model');
var TableModel = require('./table-model');
var SQLUtils = require('../helpers/sql-utils');

/**
 *  Case of a node model representing a source node.
 *  - It should provide new info about if the node is read only or not.
 *
 *  Analysis-definition-node-source-model
 *   ├── Query-Schema-Model
 *   ├── Query-Geometry-Model
 *   └── Table-Model
 */
module.exports = AnalysisDefinitionNodeModel.extend({

  defaults: {
    status: 'ready'
  },

  /**
   * @override AnalysisDefinitionNodeModel.prototype.initialize
   */
  initialize: function (attrs, opts) {
    if (!opts.userModel) throw new Error('userModel is required');

    this._userModel = opts.userModel;
    AnalysisDefinitionNodeModel.prototype.initialize.apply(this, arguments);

    var query = this.get('query');
    this.querySchemaModel.set({
      query: query,
      ready: true
    }, { silent: true });

    this.queryGeometryModel.set({
      query: query,
      ready: true
    }, { silent: true });

    // TODO: we should check if it is necessary to check if we have to overwrite the whole
    //       initialize or with this change is enough.
    this.queryRowsCollection._tableName = this.get('table_name');

    var tableData = opts.tableData || { name: this.get('table_name') };
    this.tableModel = new TableModel(tableData, {
      configModel: opts.configModel,
      parse: true
    });
  },

  getDefaultQuery: function () {
    return SQLUtils.getDefaultSQL(
      this.get('table_name'),
      this.tableModel.getOwnerName(),
      this._userModel.isInsideOrg()
    );
  },

  isCustomQueryApplied: function () {
    return !SQLUtils.isSameQuery(
      this.querySchemaModel.get('query'),
      this.getDefaultQuery()
    );
  },

  isReadOnly: function () {
    var isTableReadOnly = this.tableModel.isReadOnly(this._userModel);
    var hasCustomQuery = this.isCustomQueryApplied();
    return isTableReadOnly || hasCustomQuery;
  },

  getTableModel: function () {
    return this.tableModel;
  },

  fetchTable: function () {
    if (!this.tableModel.get('id')) {
      this.tableModel.fetch();
    }
  },

  setTableName: function (name) {
    if (!name) throw new Error('name is required');

    this.set('table_name', name);
    this.tableModel.set('name', name);
    this.queryRowsCollection.setTableName(name);
    this.querySchemaModel.set({
      status: 'unfetched',
      query: this.getDefaultQuery()
    });
  }

});

},{"../helpers/sql-utils":1099,"./analysis-definition-node-model":601,"./table-model":665}],603:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var AnalysisDefinitionNodeSourceModel = require('./analysis-definition-node-source-model');
var AnalysisDefinitionNodeModel = require('./analysis-definition-node-model');
var SQLUtils = require('../helpers/sql-utils');
var TableNameUtils = require('../helpers/table-name-utils');
var checkAndBuildOpts = require('../helpers/required-opts');

var REQUIRED_OPTS = [
  'userModel',
  'configModel'
];

/**
 * Collection of analysis definitions nodes.
 */
module.exports = Backbone.Collection.extend({

  initialize: function (models, opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._relatedTableData = opts.relatedTableData || [];

    this._initBinds();
  },

  _initBinds: function () {
    this.on('queryObjectsUpdated', this._onQueryObjectsUpdated);
  },

  addRelatedTableData: function (tableData) {
    this._relatedTableData.push(tableData);
  },

  model: function (r, opts) {
    var self = opts.collection;

    opts = _.extend(
      {
        parse: true,
        configModel: self._configModel,
        userModel: self._userModel
      },
      opts
    );

    if (r.type === 'source') {
      var tableData = _.find(self._relatedTableData, function (t) {
        return TableNameUtils.isSameTableName(r.options.table_name, t.name, self._configModel.get('user_name'));
      });
      if (tableData) {
        opts.tableData = tableData;
      }
      return new AnalysisDefinitionNodeSourceModel(r, opts);
    } else {
      return new AnalysisDefinitionNodeModel(r, opts);
    }
  },

  createSourceNode: function (d) {
    d = d || {};
    if (!d.id) throw new Error('id is required');
    if (!d.tableName) throw new Error('tableName is required');

    return this.add({
      id: d.id,
      type: 'source',
      params: {
        query: d.query || SQLUtils.getDefaultSQL(d.tableName, TableNameUtils.getUsername(d.tableName), true)
      },
      options: {
        table_name: d.tableName
      }
    });
  },

  _onQueryObjectsUpdated: function (model) {
    this._fetchQueryObjectsIfOnTop(model);
  },

  _fetchQueryObjectsIfOnTop: function (model) {
    if (this._isNodeOnTop(model)) {
      model.fetchQueryObjects();
    }
  },

  _isNodeOnTop: function (model) {
    var currentPos = this.indexOf(model);

    return currentPos === this._getTopNodeIndex();
  },

  _getTopNodeIndex: function () {
    var nodeOnTop = this._getNodeOnTop();
    var at = this.indexOf(nodeOnTop);

    return at;
  },

  _getNodeOnTop: function () {
    return this.last();
  }
});

},{"../helpers/required-opts":1097,"../helpers/sql-utils":1099,"../helpers/table-name-utils":1101,"./analysis-definition-node-model":601,"./analysis-definition-node-source-model":602,"backbone":"backbone","underscore":"underscore"}],604:[function(require,module,exports){
var Backbone = require('backbone');
var nodeIds = require('../value-objects/analysis-node-ids');
var AnalysisDefinitionModel = require('./analysis-definition-model');

/**
 * Collection of analysis definitions.
 */
module.exports = Backbone.Collection.extend({

  model: function (d, opts) {
    var self = opts.collection;

    var m = new AnalysisDefinitionModel(d, {
      parse: true,
      collection: self, // used implicitly, for model to use collection.url()
      analysisDefinitionNodesCollection: self._analysisDefinitionNodesCollection
    });

    return m;
  },

  initialize: function (models, options) {
    if (!options.configModel) throw new Error('configModel is required');
    if (!options.vizId) throw new Error('vizId is required');
    if (!options.analysisDefinitionNodesCollection) throw new Error('analysisDefinitionNodesCollection is required');

    this._configModel = options.configModel;
    this._vizId = options.vizId;
    this._analysisDefinitionNodesCollection = options.analysisDefinitionNodesCollection;
  },

  url: function () {
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/v3/viz/' + this._vizId + '/analyses';
  },

  findAnalysisThatContainsNode: function (nodeDefModel) {
    return this.findWhere({node_id: nodeDefModel.id}) ||
      this.find(function (m) {
        return m.containsNode(nodeDefModel);
      });
  },

  findAnalysisForLayer: function (layerDefModel) {
    var layerLetter = layerDefModel.get('letter');

    return this.find(function (m) {
      var letter = nodeIds.letter(m.get('node_id'));
      return letter === layerLetter;
    });
  },

  newAnalysisForNode: function (nodeDefModel) {
    return this.add({analysis_definition: nodeDefModel.toJSON()});
  },

  /**
   * @param {object} layerDefModel - instance of an analysis-definition-node-model
   * @return {jqXHR, undefined} A promise if created a new analysis
   */
  saveAnalysisForLayer: function (layerDefModel) {
    if (!layerDefModel) throw new Error('layerDefModel is required');

    var nodeDefModel = layerDefModel.getAnalysisDefinitionNodeModel();
    var analysisDefModel = this.findAnalysisForLayer(layerDefModel);

    if (layerDefModel.isOwnerOfAnalysisNode(nodeDefModel)) {
      if (analysisDefModel) {
        analysisDefModel.set('node_id', nodeDefModel.id);
      } else {
        analysisDefModel = this.add({analysis_definition: nodeDefModel.toJSON()});
      }
    } else {
      if (analysisDefModel) {
        analysisDefModel.destroy(); // layer's node is owned by another layer, so the existing analysis should be deleted
      }
    }

    this.each(function (analysisDefModel) {
      if (analysisDefModel.containsNode(nodeDefModel)) {
        analysisDefModel.save();
      }
    });

    return analysisDefModel;
  }

});

},{"../value-objects/analysis-node-ids":1119,"./analysis-definition-model":600,"backbone":"backbone"}],605:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var Utils = require('../helpers/utils');

require('backbone-model-file-upload');

module.exports = Backbone.Model.extend({
  fileAttribute: 'filename',

  defaults: {
    type: '',
    filename: '',
    interval: 0,
    progress: 0,
    state: 'idle',
    option: ''
  },

  _initBinds: function () {
    this.bind('progress', function (progress) {
      this.set({
        progress: progress * 100,
        state: 'uploading'
      });
    }, this);

    this.bind('change:filename change:url', function () {
      if (this.get('state') === 'error') {
        this.set({ state: 'idle' });
        this.unset('get_error_text', { silent: true });
      }
    }, this);

    this.bind('error invalid', function (m, d) {
      this.set({
        state: 'error',
        error_code: (d && d.error_code) || '',
        get_error_text: {
          title: _t('componentes.data.asset-model.invalid-import'),
          what_about: (d && d.msg) || ''
        }
      }, { silent: true });
      // We need this, if not validate will run again and again and again... :(
      this.trigger('change');
    }, this);
  },

  validate: function (attrs) {
    if (!attrs) {
      return;
    }

    if (attrs.type === 'filename') { // Number of files
      if (attrs.filename && attrs.filename.length) {
        return {
          msg: _t('componentes.data.asset-model.one-file-per-upload')
        };
      }
      // File extension
      var name = attrs.filename.name;
      var ext = name.substr(name.lastIndexOf('.') + 1);

      if (ext) {
        ext = ext.toLowerCase();
      }

      if (!_.contains(['jpg', 'png', 'gif', 'svg'], ext)) {
        return {
          msg: _t('componentes.data.asset-model.invalid-extension')
        };
      }
    }

    if (attrs.type === 'url') { // Valid URL?
      if (!Utils.isURL(attrs.url)) {
        return {
          msg: _t('componentes.data.asset-model.invalid-url')
        };
      }
    }
  },

  isValid: function () {
    return (this.get('filename') || this.get('url')) && this.get('state') !== 'error';
  },

  upload: function () {
    var self = this;

    var options = {
      kind: this.get('kind')
    };

    if (this.get('type') === 'file') {
      options.filename = this.get('filename');
    } else if (this.get('type') === 'url') {
      options.filename = this.get('filename');
    }

    this.xhr = this.save(options, {
      success: function (m) {
        m.set('state', 'uploaded');
      },

      error: function (m, msg) {
        var response;
        var message = _t('componentes.data.asset-model.connection-error');

        if (msg && msg.status === 429) {
          response = JSON.parse(msg.responseText);
          message = response.error;
        } else if (msg && msg.status === 400) {
          response = JSON.parse(msg.responseText);
          message = response.error;
        }

        self.set({
          state: 'error',
          get_error_text: { title: _t('componentes.data.asset-model.error'), what_about: message }
        });
      },

      complete: function () {
        delete self.xhr;
      }
    });
  },

  stopUpload: function () {
    if (this.xhr) this.xhr.abort();
  }
});

},{"../helpers/utils":1102,"backbone":"backbone","backbone-model-file-upload":"backbone-model-file-upload","underscore":"underscore"}],606:[function(require,module,exports){
var Backbone = require('backbone');
var AssetModel = require('./asset-model');
var checkAndBuildOpts = require('../helpers/required-opts');

var REQUIRED_OPTS = [
  'configModel',
  'userModel'
];

module.exports = Backbone.Collection.extend({
  model: AssetModel,

  url: function (method) {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('asset', method);
    return baseUrl + '/api/' + version + '/users/' + this._userModel.get('id') + '/assets';
  },

  initialize: function (models, opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
  },

  parse: function (resp, xhr) {
    return resp.assets;
  },

  selectAll: function () {
    this.each(function (mdl) {
      mdl.set('state', 'selected');
    });
  },

  deselectAll: function (m) {
    this.each(function (mdl) {
      if (mdl !== m && mdl.get('state') === 'selected') {
        mdl.set('state', '');
      }
    });
  }
});

},{"../helpers/required-opts":1097,"./asset-model":605,"backbone":"backbone"}],607:[function(require,module,exports){
var Backbone = require('backbone');

/**
 * Custom sync method to only allow a single request at a time,
 * any prev ongoing request at a time of a sync call will be aborted.
 *
 * @example
 *   var MyModel = Backbone.Model.extend({
 *     // …
 *     sync: syncAbort,
 */
module.exports = function (method, self, opts) {
  if (this._xhr) {
    this._xhr.abort();
  }

  var xhr = this._xhr = Backbone.Model.prototype.sync.apply(this, arguments);
  xhr.always(function () {
    self._xhr = null;
  });

  return xhr;
};

},{"backbone":"backbone"}],608:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var ImportsModel = require('./imports-model');
var POLL_TIMER = 30000;

/**
 *  Imports collection
 *
 *  If it is fetched, it will add the import
 *
 */

module.exports = Backbone.Collection.extend({

  initialize: function (models, opts) {
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.configModel) throw new Error('configModel is required');

    this._userModel = opts.userModel;
    this._configModel = opts.configModel;
  },

  model: function (attrs, opts) {
    return new ImportsModel(attrs, {
      userModel: opts.collection._userModel,
      configModel: opts.collection._configModel
    });
  },

  url: function (method) {
    var version = this._configModel.urlVersion('import');
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/' + version + '/imports';
  },

  parse: function (r) {
    var self = this;

    if (r.imports.length === 0) {
      this.destroyCheck();
    } else {
      _.each(r.imports, function (id) {
        // Check if that import exists...
        var imports = self.filter(function (mdl) {
          return mdl._importModel.get('item_queue_id') === id;
        });

        if (imports.length === 0) {
          var importsModel = new ImportsModel({
            id: id
          }, {
            userModel: self._userModel,
            configModel: self._configModel
          });

          self.add(importsModel);
        }
      });
    }

    return this.models;
  },

  canImport: function () {
    var importQuota = this._userModel.getMaxConcurrentImports();
    var total = this.size();
    var finished = 0;

    this.each(function (m) {
      if (m.hasFailed() || m.hasCompleted()) {
        ++finished;
      }
    });

    return (total - finished) < importQuota;
  },

  pollCheck: function (i) {
    if (this.pollTimer) {
      return;
    }

    var self = this;

    this.pollTimer = setInterval(function () {
      self.fetch();
    }, POLL_TIMER || 2000);

    this.fetch();
  },

  destroyCheck: function () {
    clearInterval(this.pollTimer);
    delete this.pollTimer;
  },

  failedItems: function () {
    return this.filter(function (item) {
      return item.hasFailed();
    });
  }
});

},{"./imports-model":612,"backbone":"backbone","underscore":"underscore"}],609:[function(require,module,exports){
var Backbone = require('backbone');
var ImportsCollection = require('./background-importer-imports-collection');

var POLLINGS_TIMER = 3000;

/**
 *  Background polling default model
 *
 */

module.exports = Backbone.Model.extend({

  defaults: {
    showSuccessDetailsButton: true,
    importsPolling: false // enable imports polling
  },

  initialize: function (attrs, opts) {
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.configModel) throw new Error('configModel is required');

    this._userModel = opts.userModel;
    this._configModel = opts.configModel;

    this.importsCollection = opts.importsCollection || new ImportsCollection(null, {
      userModel: this._userModel,
      configModel: this._configModel
    });

    this._initBinds();
    this.startPollings();
  },

  _initBinds: function () {
    this.importsCollection.bind('change:state', function (mdl) {
      this.trigger('change', mdl, this);
      this._onImportsStateChange(mdl);
    }, this);

    this.importsCollection.bind('remove', function (mdl) {
      this.trigger('importRemoved', mdl, this);
    }, this);

    this.importsCollection.bind('add', function (mdl) {
      this.trigger('importAdded', mdl, this);
    }, this);
  },

  getTotalFailedItems: function () {
    return this.importsCollection.failedItems().length;
  },

  removeImportItem: function (mdl) {
    if (!mdl) {
      return false;
    }
    this.importsCollection.remove(mdl);
  },

  addImportItem: function (mdl) {
    if (!mdl) {
      return false;
    }
    this.importsCollection.add(mdl);
  },

  canAddImport: function () {
    return this.importsCollection.canImport();
  },

  getTotalImports: function () {
    return this.importsCollection.size();
  },

  getTotalPollings: function () {
    return this.importsCollection.size();
  },

  stopPollings: function () {
    if (this.get('importsPolling')) {
      this.importsCollection.destroyCheck();
    }
  },

  startPollings: function () {
    var self = this;
    // Don't start pollings inmediately
    setTimeout(function () {
      if (self.get('importsPolling')) {
        self.importsCollection.pollCheck();
      }
    }, POLLINGS_TIMER);
  },

  _onImportsStateChange: function () {},

  clean: function () {
    this.importsCollection.unbind(null, null, this);
  }
});

},{"./background-importer-imports-collection":608,"backbone":"backbone"}],610:[function(require,module,exports){
var _ = require('underscore');
var Poller = require('./poller');

var ImportModelPoller = function (model) {
  var POLLING_INTERVAL = 2000; // Interval time between poll checkings
  var POLLING_INTERVAL_MULTIPLIER = 2.5;  // Multiply interval by this number
  var POLLING_REQUESTS_BEFORE_INTERVAL_CHANGE = 30; // Max tries until interval change

  var options = {
    interval: function (numberOfRequests) {
      if (numberOfRequests >= POLLING_REQUESTS_BEFORE_INTERVAL_CHANGE) {
        return POLLING_INTERVAL * POLLING_INTERVAL_MULTIPLIER;
      }
      return POLLING_INTERVAL;
    },
    stopWhen: function (model) {
      var state = model.get('state');
      return (state === 'complete' || state === 'failure');
    }
  };

  Poller.call(this, model, options);
};

ImportModelPoller.prototype = _.extend({}, Poller.prototype);

module.exports = ImportModelPoller;

},{"./poller":613,"underscore":"underscore"}],611:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var ImportModelPoller = require('./import-model-poller');
var SynchronizationModel = require('../synchronization-model');

/**
 *  New import model that controls
 *  the state of an import
 *
 */
module.exports = Backbone.Model.extend({

  idAttribute: 'item_queue_id',

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;

    this._initBinds();
    this.poller = new ImportModelPoller(this);
  },

  urlRoot: function () {
    var version = this._configModel.urlVersion('import');
    var baseUrl = this._configModel.get('base_url');

    return baseUrl + '/api/' + version + '/imports';
  },

  _initBinds: function () {
    this.bind('change:item_queue_id', this._checkQueueId, this);
  },

  createImport: function (data) {
    var d = this._prepareData(data);
    this[d.interval === 0 ? '_createRegularImport' : '_createSyncImport'](d);
  },

  _checkQueueId: function () {
    if (this.get('item_queue_id')) {
      this.pollCheck();
    }
  },

  _prepareData: function (data) {
    var d = {
      create_vis: data.create_vis,
      privacy: data.privacy
    };

    var type = data.type;

    if (type !== 'remote') {
      _.extend(d, {
        type_guessing: data.type_guessing,
        content_guessing: data.content_guessing,
        interval: data.interval
      });
    }

    var service = data.service_name;

    if (type === 'url') {
      _.extend(d, {
        url: data.value
      });
    }

    if (type === 'remote') {
      _.extend(d, {
        type: 'remote',
        interval: null,
        remote_visualization_id: data.remote_visualization_id,
        create_vis: false,
        value: data.value
      });
    }

    if (type === 'sql') {
      _.extend(d, {
        table_name: data.table_name,
        sql: data.value
      });
    }

    if (type === 'duplication') {
      _.extend(d, {
        table_name: data.table_name,
        table_copy: data.value
      });
    }

    if (type === 'service') {
      // If service is Twitter, service_item_id should be
      // sent stringified
      var service_item_id = (service === 'twitter_search') ? JSON.stringify(data.service_item_id) : data.service_item_id;

      if (data.user_defined_limits) {
        d.user_defined_limits = data.user_defined_limits;
      }

      _.extend(d, {
        value: data.value,
        service_name: data.service_name,
        service_item_id: service_item_id
      });
    }

    return d;
  },

  _createSyncImport: function (d) {
    var self = this;
    this._synchronizationModel = new SynchronizationModel(d, {
      configModel: this._configModel
    });

    this._synchronizationModel.save(null, {
      success: function (m) {
        self.set('item_queue_id', m.get('data_import').item_queue_id);
      },
      error: function (mdl, r, opts) {
        self._setErrorState(r);
      }
    });
  },

  _createRegularImport: function (d) {
    var self = this;

    this.save(d, {
      error: function (mdl, r, opts) {
        self._setErrorState(r);
      }
    });
  },

  _setErrorState: function (r) {
    var msg;
    try {
      msg = r && JSON.parse(r.responseText).errors.imports;
    } catch (err) {
      msg = _t('data.import-model.error-starting-import');
    }
    this.set({
      state: 'failure',
      get_error_text: {
        title: _t('data.import-model.error-title'),
        what_about: msg
      }
    });
  },

  pollCheck: function () {
    this.poller.start();
  },

  destroyCheck: function () {
    this.poller.stop();
  }
});

},{"../synchronization-model":663,"./import-model-poller":610,"backbone":"backbone","underscore":"underscore"}],612:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var ImportModel = require('./import-model');
var UploadModel = require('../upload-model');
var VisDefinitionModel = require('../vis-definition-model');
var PermissionModel = require('../permission-model');

/**
 *  Upload/import model
 *
 *  It takes the control of the upload and import,
 *  listening the change of any of these steps.
 *
 *  Steps:
 *  - upload
 *  - import
 *
 */

module.exports = Backbone.Model.extend({

  defaults: {
    step: 'upload',
    state: ''
  },

  initialize: function (attrs, opts) {
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.configModel) throw new Error('configModel is required');

    this._userModel = opts.userModel;
    this._configModel = opts.configModel;

    this._uploadModel = new UploadModel(opts.upload, {
      userModel: this._userModel,
      configModel: this._configModel
    });

    if (_.isEmpty(opts)) {
      opts = {};
    }

    this._importModel = new ImportModel(opts.import, {
      configModel: this._configModel
    });
    this._initBinds();
    this._checkStatus();
  },

  _initBinds: function () {
    this.bind('change:import', this._onImportChange, this);
    this.bind('change:upload', this._onUploadChange, this);
    this.bind('change:id', this._onIdChange, this);

    this._importModel.bind('change', function () {
      this.trigger('change:import', this);
      this.trigger('change', this);
    }, this);

    this._uploadModel.bind('change', function () {
      this.trigger('change:upload', this);
      this.trigger('change', this);
    }, this);
  },

  _destroyBinds: function () {
    this._uploadModel.unbind(null, null, this);
    this._importModel.unbind(null, null, this);
  },

  _onIdChange: function () {
    var item_queue_id = this.get('id');
    if (item_queue_id) this._importModel.set('item_queue_id', item_queue_id);
    this.set('step', 'import');
  },

  _onUploadChange: function (m, i) {
    if (this.get('step') === 'upload') {
      var item_queue_id = this._uploadModel.get('item_queue_id');
      var state = this._uploadModel.get('state');

      if (item_queue_id) this.set('id', item_queue_id);
      if (state) this.set('state', state);
    }
  },

  _onImportChange: function () {
    if (this.get('step') === 'import') {
      var state = this._importModel.get('state');
      if (state) this.set('state', state);
    }
  },

  _checkStatus: function () {
    if (!this.get('id') && !this._uploadModel.isValid()) {
      this.trigger('change:upload');
      return;
    }

    if (this._uploadModel.get('type') === 'file') {
      this._uploadModel.upload();
    } else if (this.get('id')) {
      this.set('step', 'import');
      this._importModel.set('item_queue_id', this.get('id'));
    } else if (!this._importModel.get('item_queue_id') && this._uploadModel.get('type') !== '') {
      this.set('step', 'import');
      this._importModel.createImport(this._uploadModel.toJSON());
    }
  },

  pause: function () {
    this.stopUpload();
    this.stopImport();
  },

  hasFailed: function () {
    var state = this.get('state');
    var step = this.get('step');

    return (step === 'import' && state === 'failure') || (step === 'upload' && state === 'error');
  },

  hasCompleted: function () {
    return this.get('step') === 'import' && this._importModel && this._importModel.get('state') === 'complete';
  },

  getWarnings: function () {
    return this.get('step') === 'import' ? this._importModel.get('warnings') : '';
  },

  getError: function () {
    if (this.hasFailed()) {
      var step = this.get('step');
      return _.extend(
        {
          errorCode: this[step === 'upload' ? '_uploadModel' : '_importModel'].get('error_code'),
          itemQueueId: step === 'import' ? this._importModel.get('id') : '',
          originalUrl: step === 'import' ? this._importModel.get('original_url') : '',
          dataType: step === 'import' ? this._importModel.get('data_type') : '',
          httpResponseCode: step === 'import' ? this._importModel.get('http_response_code') : '',
          httpResponseCodeMessage: step === 'import' ? this._importModel.get('http_response_code_message') : ''
        },
        this[step === 'upload' ? '_uploadModel' : '_importModel'].get('get_error_text'));
    }

    return {
      title: '',
      what_about: '',
      error_code: ''
    };
  },

  importedVis: function () {
    if (this.get('import').derived_visualization_id) {
      return this._getMapVis();
    } else {
      return this._getDatasetVis();
    }
  },

  _getMapVis: function () {
    var derivedVisId = this._importModel.get('derived_visualization_id');

    if (!derivedVisId) {
      return false;
    }

    return this._createVis({
      type: 'derived',
      id: derivedVisId
    });
  },

  _getDatasetVis: function () {
    var tableName = this._importModel.get('table_name');

    if (!tableName) {
      return false;
    }

    return this._createVis({
      type: 'table',
      table: {
        name: tableName
      }
    });
  },

  _createVis: function (attrs) {
    var vis = new VisDefinitionModel(attrs, {
      configModel: this._configModel
    });

    vis.permission = new PermissionModel(null, {
      configModel: this._configModel,
      userModel: this._userModel
    });

    return vis;
  },

  setError: function (opts) {
    var stepModel = this[this.get('step') === 'upload' ? '_uploadModel' : '_importModel'];

    this.stopUpload();
    this.stopImport();

    stepModel.set(opts);

    this.set('state', 'error');
  },

  stopUpload: function () {
    this._uploadModel.stopUpload();
  },

  stopImport: function () {
    this._importModel.destroyCheck();
  },

  get: function (attr) {
    if (attr === 'upload') {
      return this._uploadModel.toJSON();
    }

    if (attr === 'import') {
      return this._importModel.toJSON();
    }

    return Backbone.Model.prototype.get.call(this, attr);
  },

  toJSON: function () {
    return {
      step: this.get('step'),
      id: this.get('id'),
      state: this.get('state'),
      upload: this._uploadModel.toJSON(),
      import: this._importModel.toJSON()
    };
  }
});

},{"../permission-model":653,"../upload-model":668,"../vis-definition-model":675,"./import-model":611,"backbone":"backbone","underscore":"underscore"}],613:[function(require,module,exports){
var _ = require('underscore');

/*
 * Periodically fetches a model/collection. It waits for ongoing
 * fetch requests before trying to fetch again. A stop condition
 * can be specified.
 *
 * Usage example:
 *
 * var poller = new Poller(model, {
 *   interval: 1000,
 *   stopWhen: function (model) {
 *     return model.get('state') === 'completed';
 *   }
 * });
 *
 * poller.start();
 *
 * // ...
 *
 * poller.stop();
 *
 */
var Poller = function (model, opts) {
  this.model = model;
  this.numberOfRequests = 0;
  this.polling = false;
  this.interval = opts.interval;
  if (typeof this.interval !== 'function') {
    this.interval = function () { return opts.interval; };
  }
  this.stopWhen = opts.stopWhen;
  this.error = opts.error;
  this.autoStart = opts.autoStart;

  if (this.autoStart) {
    this.start();
  }
};

Poller.prototype.start = function () {
  if (this.timeout) {
    return;
  }

  this._scheduleFetch();
};

Poller.prototype._scheduleFetch = function () {
  this.timeout = setTimeout(this._fetch.bind(this), this.interval(this.numberOfRequests));
};

Poller.prototype._fetch = function () {
  var self = this;
  if (!self.polling) {
    self.polling = true;
    self.model.fetch({
      success: function () {
        self.polling = false;
        self.numberOfRequests++;
        if (self._continuePolling()) {
          self._scheduleFetch();
        }
      },
      error: function (e) {
        _.isFunction(self.error) && self.error(self.model);
      }
    });
  }
};

Poller.prototype._continuePolling = function () {
  return !this.stopWhen ||
    (_.isFunction(this.stopWhen) && !this.stopWhen(this.model));
};

Poller.prototype.stop = function () {
  this.polling = false;
  clearTimeout(this.timeout);
  delete this.timeout;
};

module.exports = Poller;

},{"underscore":"underscore"}],614:[function(require,module,exports){
var PROVIDER_LEAFLET = 'leaflet';
var PROVIDER_GOOGLE_MAPS = 'googlemaps';
var CATEGORY_GOOGLE_MAPS = 'GMaps';
var LAYER_TYPE_GOOGLE_MAPS = 'GMapsBase';
var LAYER_TYPE_TILED = 'Tiled';

module.exports = {
  getProvider: function (layerType) {
    if (layerType === LAYER_TYPE_GOOGLE_MAPS) {
      return PROVIDER_GOOGLE_MAPS;
    }
    return PROVIDER_LEAFLET;
  },

  getLayerType: function (category) {
    if (this.isGoogleMapsCategory(category)) {
      return LAYER_TYPE_GOOGLE_MAPS;
    }
    return LAYER_TYPE_TILED;
  },

  isGoogleMapsCategory: function (category) {
    return category === CATEGORY_GOOGLE_MAPS;
  }
};

},{}],615:[function(require,module,exports){
var _ = require('underscore');
var camshaftReference = require('camshaft-reference').getVersion('latest');
var DefaultCartography = require('./default-cartography.json');

var SOURCE_NAMES_MAP = {}; // string -> array, e.g. {'intersection': ['source', 'target']}
var DEFAULT_MISSING_PARAM_VALUES = [undefined, null, '', NaN];

module.exports = {
  hasType: function (type) {
    return !!camshaftReference.analyses[type];
  },

  paramsForType: function (type) {
    if (!this.hasType(type)) throw new Error('no analysis params found for type: ' + type);

    return _.clone(camshaftReference.analyses[type].params);
  },

  /**
   * Validate raw form attrs
   * @param {Object} formAttrs - e.g. {type: 'buffer', source: 'a0', radius: 'meh'}
   * @return {Object, undefined} returns an object with keys as faulty input, e.g. {radius: 'invalid-value'} for above
   */
  validate: function (formAttrs) {
    var errors = {};

    var parsedAttrs = this.parse(formAttrs);
    var params = this.paramsForType(formAttrs.type);

    for (var name in params) {
      var param = params[name];
      var val = parsedAttrs[name];

      if (!param.optional || val !== undefined) {
        switch (param.type) {
          case 'node':
            if (!val) {
              errors[name] = _t('data.analysis-definition-node-model.validation.invalid-source');
            }
            break;
          case 'number':
            if (isNaN(val)) {
              errors[name] = _t('data.analysis-definition-node-model.validation.invalid-value');
            }
            break;
          case 'enum':
            if (!_.contains(param.values, val)) {
              errors[name] = _t('data.analysis-definition-node-model.validation.invalid-enum', {expectedValues: JSON.stringify(param.values)});
            }
            break;
          default:
            if (val === null) {
              errors[name] = _t('data.analysis-definition-node-model.validation.missing-required');
            }
        }
      }
    }

    if (!_.isEmpty(errors)) {
      return errors;
    }
  },

  /**
   * Get type-parsed attrs from the raw form attrs
   * @param {Object} formAttrs - e.g. {type: 'buffer', source: 'a0 ', radius: '123', dissolved: 'false'}
   * @return {Object} e.g. {type: 'buffer', source: 'a0', radius: 123, dissolved: false}
   */
  parse: function (formAttrs) {
    var parsedAttrs = _.extend({}, formAttrs);
    var params = this.paramsForType(formAttrs.type);

    for (var name in params) {
      var param = params[name];
      var val = parsedAttrs[name];

      if (param.optional && _.contains(DEFAULT_MISSING_PARAM_VALUES, val)) {
        delete parsedAttrs[name];
      } else {
        switch (param.type) {
          case 'node':
            parsedAttrs[name] = (val || '').trim();
            break;
          case 'number':
            parsedAttrs[name] = parseFloat(val, 10);
            break;
          case 'boolean':
            parsedAttrs[name] = val === 'true' || val === true;
            break;
          default:
            if (_.contains(DEFAULT_MISSING_PARAM_VALUES, val)) {
              parsedAttrs[name] = null;
            } else if (_.isString(val)) {
              parsedAttrs[name] = val.trim();
            }
        }
      }
    }

    return parsedAttrs;
  },

  getSourceNamesForAnalysisType: function (type) {
    if (!SOURCE_NAMES_MAP[type]) {
      var sourceNames = [];
      var params = this.paramsForType(type);

      for (var name in params) {
        var param = params[name];
        if (param.type === 'node') {
          sourceNames.push(name);
        }
      }

      SOURCE_NAMES_MAP[type] = sourceNames;
    }

    return SOURCE_NAMES_MAP[type];
  },

  getDefaultCartoCSSForType: function () {
    return _.template([
      "#layer['mapnik::geometry_type'=1] {",
      '  marker-width: <%= point.fill.size.fixed %>;',
      '  marker-fill: <%= point.fill.color.fixed %>;',
      '  marker-fill-opacity: <%= point.fill.color.opacity %>;',
      '  marker-line-color: <%= point.stroke.color.fixed %>;',
      '  marker-line-width: <%= point.stroke.size.fixed %>;',
      '  marker-line-opacity: <%= point.stroke.color.opacity %>;',
      '  marker-placement: point;',
      '  marker-type: ellipse;',
      '  marker-allow-overlap: true;',
      '}',
      "#layer['mapnik::geometry_type'=2] {",
      '  line-color: <%= line.stroke.color.fixed %>;',
      '  line-width: <%= line.stroke.size.fixed %>;',
      '  line-opacity: 1;',
      '}',
      "#layer['mapnik::geometry_type'=3] {",
      '  polygon-fill: <%= polygon.fill.color.fixed %>;',
      '  polygon-opacity: <%= polygon.fill.color.opacity %>;',
      '  polygon-gamma: 0.5;',
      '  line-color: <%= polygon.stroke.color.fixed%>;',
      '  line-width: <%= polygon.stroke.size.fixed %>;',
      '  line-opacity: <%= polygon.stroke.color.opacity %>;',
      '  line-comp-op: soft-light;',
      '}'
    ].join('\n'))(DefaultCartography.simple);
  },

  isValidInputGeometryForType: function (simpleGeometryType, analysisType) {
    var validGeometries = this.getValidInputGeometriesForType(analysisType);
    return _.contains(validGeometries, simpleGeometryType) || _.contains(validGeometries, '*');
  },

  getValidInputGeometriesForType: function (analysisType) {
    var params = this.paramsForType(analysisType);

    var geometries = [];

    for (var name in params) {
      var param = params[name];
      if (param.type === 'node') {
        geometries = _.union(geometries, param.geometry);
      }
    }

    return geometries;
  }
};

},{"./default-cartography.json":621,"camshaft-reference":"camshaft-reference","underscore":"underscore"}],616:[function(require,module,exports){
var Backbone = require('backbone');

module.exports = Backbone.Model.extend({
  idAttribute: 'name'
});

},{"backbone":"backbone"}],617:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CDB = require('cartodb.js');

var queryTemplate = _.template('SELECT <%= column %> FROM (<%= sql %>) _table_sql GROUP BY <%= column %> ORDER BY <%= column %> ASC');
var MAX_ROW_COUNT = 100;

module.exports = Backbone.Model.extend({
  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel param is required');
    if (!opts.nodeDefModel) throw new Error('nodeDefModel param is required');

    this._query = opts.nodeDefModel.querySchemaModel.get('query');
    this._rowData = [];

    this._SQL = new CDB.SQL({
      user: opts.configModel.get('user_name'),
      sql_api_template: opts.configModel.get('sql_api_template'),
      api_key: opts.configModel.get('api_key')
    });

    this.on('change:column', this.fetch, this);
  },

  _onQueryDone: function (r) {
    var resultCount = _.size(r.rows);

    if (resultCount && resultCount < MAX_ROW_COUNT) {
      this._rowData = _.pluck(r.rows, this.get('column'));
      this.trigger('columnsFetched', this._rowData);
    }
  },

  fetch: function () {
    if (this.get('column') && this._query) {
      this._SQL.execute(
        queryTemplate({
          sql: this._query,
          column: this.get('column')
        }),
        null,
        {
          extra_params: ['page', 'rows_per_page'],
          page: 0,
          rows_per_page: 40,
          success: this._onQueryDone.bind(this),
          error: function () {
            // TODO: what happens if fails?
          }
        }
      );
    }
  },

  getRows: function () {
    var rowDataCount = _.size(this._rowData);
    if (rowDataCount > 0) {
      if (rowDataCount && rowDataCount < MAX_ROW_COUNT) {
        return _.reject(this._rowData, _.isNull);
      } else {
        return false;
      }
    } else {
      return false;
    }
  }
});

},{"backbone":"backbone","cartodb.js":"cartodb.js","underscore":"underscore"}],618:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

/**
 * Model for general frontend configuration.
 * Ported from old cdb.config, since we can't reuse the older model that's tied to v3 of cartodb.js
 *
 * Also, rather than putting it as a global object, it's intended to be instantiated at the entry point and passed as
 * a collaborator object the models that needs it, e.g.:
 * var myModel = new MyModel({ id: 123, … }, {
 *   configModel: configModel
 * })
 */
module.exports = Backbone.Model.extend({

  defaults: {
    base_url: '/CHANGEME' // expected to be set when model is created
  },

  urlVersion: function (modelName, method, defaultVersion) {
    method = method || '';
    var version = this.get(modelName + '_' + method + '_url_version');
    return version || defaultVersion || 'v1';
  },

  /**
   * @param {String} [version=v2] Version of API to use
   * @return {String} the full sql api url, including the api endpoint, e.g. http://user.carto.com/api/v2/sql
   */
  getSqlApiUrl: function (version) {
    version = version || 'v2';
    return this._getSqlApiBaseUrl() + '/api/' + version + '/sql';
  },

  /**
   * @return {String} returns the base url to compose the final url, e.g. http://user.carto.com/
   */
  _getSqlApiBaseUrl: function () {
    var url;
    if (this.get('sql_api_template')) {
      url = this.get('sql_api_template').replace('{user}', this.get('user_name'));
    } else {
      url = this.get('sql_api_protocol') + '://' +
        this.get('user_name') + '.' +
        this.get('sql_api_domain') + ':' +
        this.get('sql_api_port');
    }
    return url;
  },

  dataServiceEnabled: function (name) {
    var dataServices = this.get('dataservices_enabled');
    if (!dataServices || !_.size(dataServices) || !name) {
      return false;
    }
    return !!dataServices[name];
  }
});

},{"backbone":"backbone","underscore":"underscore"}],619:[function(require,module,exports){
/* global Image */

var Backbone = require('backbone');
var _ = require('underscore');

module.exports = Backbone.Model.extend({

  getAttributes: function () {
    return JSON.parse(JSON.stringify(this.attributes));
  },

  _generateClassName: function (urlTemplate) {
    if (urlTemplate) {
      return urlTemplate.replace(/\s+/g, '').replace(/[^a-zA-Z_0-9 ]/g, '').toLowerCase();
    } else return '';
  },

  parse: function (data) {
    var attrs = {};

    _.extend(attrs, data.options, {
      id: data.id,
      className: this._generateClassName(data.options.urlTemplate),
      type: 'Tiled',
      order: data.order,
      parent_id: data.parent_id
    });

    return attrs;
  },

  toJSON: function () {
    var layerOptions = _.clone(_.omit(this.attributes, ['order', 'id']));
    var json = {
      kind: 'tiled',
      options: layerOptions,
      order: this.get('order'),
      id: this.id
    };

    return json;
  },

  getValue: function () {
    return this.get('val');
  },

  /**
   * validateTemplateURL - Validates current urlTemplate of layer.
   *
   * @param {Object} callbacks with success and error functions defined to be called depending on validation outcome.
   */
  validateTemplateURL: function (callbacks) {
    var subdomains = ['a', 'b', 'c'];
    var image = new Image();
    image.onload = callbacks.success;
    image.onerror = callbacks.error;
    image.src = this.get('urlTemplate').replace(/\{s\}/g, function () {
      return subdomains[Math.floor(Math.random() * 3)];
    })
      .replace(/\{x\}/g, '0')
      .replace(/\{y\}/g, '0')
      .replace(/\{z\}/g, '0');
  }

});

},{"backbone":"backbone","underscore":"underscore"}],620:[function(require,module,exports){
var Backbone = require('backbone');
var CustomBaselayerModel = require('./custom-baselayer-model');
var checkAndBuildOpts = require('../helpers/required-opts');

var REQUIRED_OPTS = [
  'configModel',
  'currentUserId'
];

module.exports = Backbone.Collection.extend({

  model: function (d, opts) {
    var self = opts.collection;

    var m = new CustomBaselayerModel(d, {
      parse: true,
      collection: self
    });

    return m;
  },

  url: function () {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('user');
    return baseUrl + '/api/' + version + '/users/' + this._currentUserId + '/layers';
  },

  initialize: function (models, opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
  },

  isCustomCategory: function () {
    var custom = this.where(function (mdl) {
      return ['NASA', 'TileJSON', 'WMS', 'Mapbox', 'Custom', undefined].some(function (category) {
        return mdl.get('category') === category;
      });
    });
    return custom;
  },

  getSelected: function () {
    return this.findWhere({ selected: true });
  },

  hasCustomBaseLayer: function (className) {
    if (!className) return;

    var customBaseLayer = this.where({ className: className });

    return customBaseLayer.length > 0;
  }

});

},{"../helpers/required-opts":1097,"./custom-baselayer-model":619,"backbone":"backbone"}],621:[function(require,module,exports){
module.exports={
  "simple": {

    "point": {
      "fill": {
        "size": {
          "fixed": 7
        },
        "color": {
          "fixed": "#FFB927",
          "opacity": 0.9
        }
      },
      "stroke": {
        "size": {
          "fixed": 1
        },
        "color": {
          "fixed": "#FFF",
          "opacity": 1
        }
      }
    },

    "line": {
      "fill": {},
      "stroke": {
        "size": {
          "fixed": 1.5
        },
        "color": {
          "fixed": "#3EBCAE",
          "opacity": 1
        }
      }
    },

    "polygon": {
      "fill": {
        "color": {
          "fixed": "#374C70",
          "opacity": 0.9
        }
      },
      "stroke": {
        "size": {
          "fixed": 1
        },
        "color": {
          "fixed": "#FFF",
          "opacity": 0.5
        }
      }
    }
  }
}

},{}],622:[function(require,module,exports){
module.exports={
  "fill": {
    "size": {
      "fixed": 7
    },
    "color": {
      "fixed": "#FFB927",
      "opacity": 0.9
    }
  },
  "stroke": {
    "size": {
      "fixed": 1
    },
    "color": {
      "fixed": "#FFF",
      "opacity": 1
    }
  },
  "blending": "none",
  "aggregation": {},
  "labels": {
    "enabled": false,
    "attribute": null,
    "font": "DejaVu Sans Book",
    "fill": {
      "size": {
        "fixed": 10
      },
      "color": {
        "fixed": "#FFFFFF",
        "opacity": 1
      }
    },
    "halo": {
      "size": {
        "fixed": 1
      },
      "color": {
        "fixed": "#6F808D",
        "opacity": 1
      }
    },
    "offset": -10,
    "overlap": true,
    "placement": "point"
  }
}

},{}],623:[function(require,module,exports){
var BackgroundPollingModel = require('./background-importer/background-polling-model');
var TableModel = require('./table-model');

/**
 *  Background polling model for the editor context.
 */

module.exports = BackgroundPollingModel.extend({

  initialize: function (attrs, opts) {
    BackgroundPollingModel.prototype.initialize.apply(this, arguments);

    if (!opts.userActions) { throw new Error('userActions is required'); }

    this._userActions = opts.userActions;
  },

  _onImportsStateChange: function (importsModel) {
    if (importsModel.hasCompleted()) {
      var tableName = importsModel.importedVis().get('table').name;
      var tableModel = new TableModel({
        name: tableName
      }, {
        configModel: this._configModel
      });

      // Provide table geometry in order to set properly styles when
      // layer is added to the current map
      var onTableFetched = function () {
        this._userActions.createLayerFromTable(tableModel);
        this.trigger('importCompleted', importsModel, this);
      }.bind(this);

      tableModel.fetch().always(onTableFetched);
    }
  }
});

},{"./background-importer/background-polling-model":609,"./table-model":665}],624:[function(require,module,exports){
var Backbone = require('backbone');

/**
 * Model for general editor configuration.
 */
module.exports = Backbone.Model.extend({
  defaults: {
    edition: false,
    disabled: false
  },
  isEditing: function () {
    return !!this.get('edition');
  },
  isDisabled: function () {
    return !!this.get('disabled');
  }
});

},{"backbone":"backbone"}],625:[function(require,module,exports){
var Backbone = require('backbone');

/**
 * Model that represents a visualization export (v3)
 */

module.exports = Backbone.Model.extend({

  initialize: function (attrs, opts) {
    if (!attrs.visualization_id) throw new Error('visualization_id is required');
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;
  },

  urlRoot: function () {
    var baseUrl = this._configModel.get('base_url');

    return baseUrl + '/api/v3/visualization_exports';
  },

  requestExport: function () {
    this.save(null, {
      success: this._requestExportSuccessHandler.bind(this)
    });

    // TODO add metrics for private and public exports
  },

  cancelExport: function () {
    this._interrupt();
  },

  _requestExportSuccessHandler: function () {
    this._pollPID = setInterval(function () {
      this.fetch({
        success: this._checkState.bind(this),
        error: this._errorHandler.bind(this)
      });
    }.bind(this), 2000);
  },

  _checkState: function () {
    if (this.get('state') === 'complete') {
      this._finishExport();
    } else if (this.get('state') === 'failure') {
      this._errorHandler();
    }
  },

  _finishExport: function () {
    clearInterval(this._pollPID);
  },

  _errorHandler: function () {
    this._interrupt();

    throw new Error('There is a problem with your export. Please try again.');
  },

  _interrupt: function () {
    clearInterval(this._pollPID);

    this.set('state', 'failure');
  }
});

},{"backbone":"backbone"}],626:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var QueryRowModel = require('./query-row-model');

var TYPES_POINT = 'point';
var TYPES_LINE = 'line';
var TYPES_POLYGON = 'polygon';

var GEOJSON_TO_FEATURE_TYPE = {
  Point: TYPES_POINT,
  MultiPoint: TYPES_POINT,
  LineString: TYPES_LINE,
  MultiLineString: TYPES_LINE,
  Polygon: TYPES_POLYGON,
  MultiPolygon: TYPES_POLYGON
};

var convertGeoJSONTypeToFeatureType = function (the_geom) {
  var geoJSON = null;

  try {
    geoJSON = JSON.parse(the_geom);
  } catch (err) {
    // if the geom is not a valid json value
  }

  var geometryType = geoJSON && geoJSON.type;
  var featureType = GEOJSON_TO_FEATURE_TYPE[geometryType];
  if (!featureType) {
    throw new Error("unsupported geometry type: '" + geometryType + "'");
  }

  return featureType;
};

var BLACKLISTED_COLUMNS = ['cartodb_id', 'created_at', 'the_geom_webmercator', 'updated_at'];

var FeatureDefinitionModel = Backbone.Model.extend({

  initialize: function (attrs, options) {
    if (!options.configModel) throw new Error('configModel is required');
    if (!options.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
    if (!options.userModel) throw new Error('userModel is required');

    this._configModel = options.configModel;
    this._layerDefinitionModel = options.layerDefinitionModel;
    this._userModel = options.userModel;
    this._featureType = options.featureType;

    this._firstNode = this._getAnalysisDefinitionNodeModel();
    this._changesHistory = [];

    if (this._firstNode.isSourceType()) {
      this._tableNodeModel = this._firstNode.getTableModel();
    }

    this._onChange = _.debounce(this._onChange.bind(this), 500);

    if (this.isNew()) {
      // Bind change event in order to "store" all changed columns after creation
      this._bindChangeEvent();
    }
  },

  isNew: function () {
    return !this.has('cartodb_id');
  },

  isPoint: function () {
    return this._isType(TYPES_POINT);
  },

  isPolygon: function () {
    return this._isType(TYPES_POLYGON);
  },

  isLine: function () {
    return this._isType(TYPES_LINE);
  },

  _isType: function (type) {
    return this._getType() === type;
  },

  isEditable: function () {
    var analysisDefinitionModel = this._getAnalysisDefinitionNodeModel();
    return !analysisDefinitionModel.isReadOnly();
  },

  _getPermissionModel: function () {
    return this._tableNodeModel && this._tableNodeModel.getPermissionModel();
  },

  isReadOnly: function () {
    return this._tableNodeModel && this._tableNodeModel.isReadOnly(this._userModel);
  },

  hasAnalyses: function () {
    return this._layerDefinitionModel.hasAnalyses();
  },

  isCustomQueryApplied: function () {
    var analysisDefinitionModel = this._getAnalysisDefinitionNodeModel();
    return analysisDefinitionModel.isCustomQueryApplied();
  },

  _getAnalysisDefinitionNodeModel: function () {
    return this._layerDefinitionModel.getAnalysisDefinitionNodeModel();
  },

  isEqual: function (featureDefinition) {
    return this.get('cartodb_id') === featureDefinition.get('cartodb_id') &&
      this.getLayerId() === featureDefinition.getLayerId();
  },

  getLayerId: function () {
    return this._layerDefinitionModel.id;
  },

  getLayerDefinition: function () {
    return this._layerDefinitionModel;
  },

  _cleanChangesHistory: function () {
    this._changesHistory = [];
  },

  _bindChangeEvent: function () {
    this.on('change', this._onChange, this);
  },

  _unbindChangeEvent: function () {
    this.off('change', this._onChange, this);
  },

  _onChange: function () {
    _.each(this.changed, function (value, key) {
      if (!_.contains(this._changesHistory, key)) {
        this._changesHistory.push(key);
      }
    }, this);
  },

  hasBeenChangedAfterLastSaved: function (key) {
    return _.contains(this._changesHistory, key);
  },

  getFeatureType: function () {
    if (this.isPoint()) {
      return 'point';
    }
    if (this.isLine()) {
      return 'line';
    }
    if (this.isPolygon()) {
      return 'polygon';
    }
  },

  fetch: function (options) {
    options = options || {};
    this._unbindChangeEvent();

    this._getQueryRowModel().fetch({
      success: function (data) {
        this.set(data.toJSON());
        // Bind change event in order to "store" all changed columns after starting edition
        this._bindChangeEvent();
        options.success && options.success();
      }.bind(this)
    });
  },

  save: function (options) {
    options = options || {};
    var columns = this._layerDefinitionModel.getColumnNamesFromSchema();
    var attrs = _.pick(this.toJSON(), _.difference(columns, BLACKLISTED_COLUMNS));

    this._getQueryRowModel().save(attrs, {
      success: function (queryRowModel) {
        if (this.isNew()) {
          this.set('cartodb_id', queryRowModel.get('cartodb_id'));
        }
        this.trigger('save', this, options);
        options.success && options.success();
        this._cleanChangesHistory();
      }.bind(this),
      error: function () {
        options.error && options.error();
      }
    });
  },

  destroy: function (options) {
    options = options || {};
    this._getQueryRowModel().destroy({
      success: function () {
        this.trigger('remove', this, options);
        options.success && options.success();
      }.bind(this),
      error: function () {
        options.error && options.error();
      }
    });
  },

  _getQueryRowModel: function () {
    var attrs = {};

    if (this.has('cartodb_id')) {
      attrs.cartodb_id = this.get('cartodb_id');
    }

    this._queryRowModel = this._queryRowModel || new QueryRowModel(attrs, {
      tableName: this._layerDefinitionModel.getTableName(),
      configModel: this._configModel,
      permissionModel: this._getPermissionModel(),
      userModel: this._userModel
    });

    return this._queryRowModel;
  },

  _getType: function () {
    var the_geom = this.get('the_geom');
    var type = the_geom && convertGeoJSONTypeToFeatureType(the_geom) || this._featureType;

    return type;
  }
});

module.exports = FeatureDefinitionModel;

},{"./query-row-model":657,"backbone":"backbone","underscore":"underscore"}],627:[function(require,module,exports){
var MAP = {
  'st_multipolygon': 'polygon',
  'st_polygon': 'polygon',
  'st_multilinestring': 'line',
  'st_linestring': 'line',
  'st_multipoint': 'point',
  'st_point': 'point'
};

/**
 * @param {String} val e.g. 'ST_MultiPoint'
 * @return {String} e.g. 'point'
 */
module.exports = function (val) {
  return MAP[val.toLowerCase()];
};

},{}],628:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var syncAbort = require('./backbone/sync-abort');
var UserModel = require('./user-model');
var GroupModel = require('./group-model');

/**
 * A collection of Grantable objects.
 */
module.exports = Backbone.Collection.extend({

  model: function (attrs, options) {
    var type = attrs.type;
    var configModel = attrs.configModel;
    options = _.extend(options, {
      configModel: configModel
    });

    if (attrs.model) {
      attrs = _.extend({}, attrs, attrs.model);
    }

    if (type === 'user') {
      return new UserModel(_.omit(attrs, 'configModel'), options);
    } else if (type === 'group') {
      return new GroupModel(_.omit(attrs, 'configModel'), options);
    }
  },

  sync: syncAbort,

  url: function (method) {
    var baseUrl = this.configModel.get('base_url');
    var version = this.configModel.urlVersion('organizationGrantables', method);
    return baseUrl + '/api/' + version + '/organization/' + this.organization.id + '/grantables';
  },

  initialize: function (users, opts) {
    if (!opts.organization) throw new Error('Organization is required');
    if (!opts.currentUserId) throw new Error('currentUserId is required');
    if (!opts.configModel) throw new Error('configModel is required');

    this.configModel = opts.configModel;
    this.organization = opts.organization;
    this.currentUserId = opts.currentUserId;
  },

  parse: function (response) {
    this.trigger('fetched', this);
    this.total_entries = response.total_entries;

    return _.reduce(response.grantables, function (memo, m) {
      if (m.id === this.currentUserId) {
        this.total_entries--;
      } else {
        m.organization = this.organization;
        m.configModel = this.configModel;
        memo.push(m);
      }
      return memo;
    }, [], this);
  },

  fetch: function (opts) {
    opts = opts || {};
    this.trigger('fetching', this);
    opts.error = function (model, response) {
      this.trigger('error', this);
    }.bind(this);

    return Backbone.Collection.prototype.fetch.call(this, opts);
  },

  totalCount: function () {
    return this.total_entries;
  }

});

},{"./backbone/sync-abort":607,"./group-model":629,"./user-model":671,"backbone":"backbone","underscore":"underscore"}],629:[function(require,module,exports){
var Backbone = require('backbone');
var UsersGroup = require('./users-group-collection');

/**
 * Model representing a group.
 * Expected to be used in the context of a groups collection (e.g. OrganizationGroups),
 * which defines its API endpoint path.
 */

module.exports = Backbone.Model.extend({

  defaults: {
    display_name: ''
  },

  initialize: function (attrs, opts) {
    this.parse(attrs || {}, opts); // handle given attrs in the same way as for .fetch()
  },

  parse: function (attrs, opts) {
    this.users = new UsersGroup(attrs.users, {
      group: this,
      configModel: opts.configModel,
      organization: opts.organization
    });

    return attrs;
  }
});

},{"./users-group-collection":673,"backbone":"backbone"}],630:[function(require,module,exports){
var InfowindowDefinitionModel = require('./infowindow-definition-model');

module.exports = InfowindowDefinitionModel.extend({

  defaults: {
    template_name: '',
    latlng: [0, 0],
    offset: [28, 0], // offset of the tip calculated from the bottom left corner
    maxHeight: 180, // max height of the content, not the whole infowindow
    autoPan: true,
    template: '',
    content: '',
    visibility: false,
    alternative_names: { },
    fields: null, // contains the fields displayed in the infowindow,
    width: 226,
    headerColor: {
      color: {
        fixed: '#35AAE5',
        opacity: 1
      }
    }
  },

  TEMPLATES: {
    infowindow_light: require('../mustache-templates/infowindows/infowindow_light.jst.mustache'),
    infowindow_dark: require('../mustache-templates/infowindows/infowindow_dark.jst.mustache'),
    infowindow_color: require('../mustache-templates/infowindows/infowindow_color.jst.mustache'),
    infowindow_header_with_image: require('../mustache-templates/infowindows/infowindow_header_with_image.jst.mustache'),
    custom_infowindow_light: require('../mustache-templates/infowindows_custom/infowindow_light.jst.mustache'),
    custom_infowindow_dark: require('../mustache-templates/infowindows_custom/infowindow_dark.jst.mustache'),
    custom_infowindow_color: require('../mustache-templates/infowindows_custom/infowindow_color.jst.mustache'),
    custom_infowindow_header_with_image: require('../mustache-templates/infowindows_custom/infowindow_header_with_image.jst.mustache')
  },

  _transformTemplate: function (template) {
    var fixed = this.get('headerColor').color.fixed;

    return template.replace('background: #35AAE5', 'background: ' + fixed);
  },

  setTemplate: function (templateName) {
    var template = (typeof (this.TEMPLATES[templateName]) === 'undefined') ? '' : this.TEMPLATES[templateName];

    if (templateName === 'infowindow_color') {
      template = this._transformTemplate(template);
    }

    var attrs = {
      'template_name': templateName,
      'template': template,
      'template_type': 'mustache'
    };

    if (templateName === '') {
      attrs.fields = [];
    }

    this.set(attrs);
  },

  isEmptyTemplate: function () {
    var isEmpty = this.fieldCount() === 0;
    return this.hasTemplate() && isEmpty;
  },

  setDefault: function () {
    this.setTemplate(this.defaults.template_name);
  }

});

},{"../mustache-templates/infowindows/infowindow_color.jst.mustache":1104,"../mustache-templates/infowindows/infowindow_dark.jst.mustache":1105,"../mustache-templates/infowindows/infowindow_header_with_image.jst.mustache":1106,"../mustache-templates/infowindows/infowindow_light.jst.mustache":1107,"../mustache-templates/infowindows_custom/infowindow_color.jst.mustache":1109,"../mustache-templates/infowindows_custom/infowindow_dark.jst.mustache":1110,"../mustache-templates/infowindows_custom/infowindow_header_with_image.jst.mustache":1111,"../mustache-templates/infowindows_custom/infowindow_light.jst.mustache":1112,"./infowindow-definition-model":631}],631:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var $ = require('jquery');

module.exports = Backbone.Model.extend({

  SYSTEM_COLUMNS: ['the_geom', 'the_geom_webmercator', 'created_at', 'updated_at', 'cartodb_id', 'cartodb_georef_status'],

  TEMPLATES: {},

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;
  },

  clearFields: function () {
    this.set({ 'fields': [] });
  },

  saveFields: function (where) {
    where = where || 'old_fields';
    this.set(where, _.clone(this.get('fields')));
  },

  fieldCount: function () {
    var fields = this.get('fields');
    if (!fields) return 0;
    return fields.length;
  },

  restoreFields: function (whiteList, from) {
    from = from || 'old_fields';
    var fields = this.get(from);
    if (whiteList) {
      fields = fields.filter(function (f) {
        return _.contains(whiteList, f.name);
      });
    }
    if (fields && fields.length) {
      this._setFields(fields);
    }
    this.unset(from);
  },

  containsField: function (fieldName) {
    var fields = this.get('fields') || [];
    return _.contains(_(fields).pluck('name'), fieldName);
  },

  getFieldProperty: function (fieldName, k) {
    if (this.containsField(fieldName)) {
      var fields = this.get('fields') || [];
      var idx = _.indexOf(_(fields).pluck('name'), fieldName);
      return fields[idx][k];
    }
    return null;
  },

  setFieldProperty: function (fieldName, k, v) {
    if (this.containsField(fieldName)) {
      var fields = this._cloneFields() || [];
      var idx = _.indexOf(_(fields).pluck('name'), fieldName);
      fields[idx][k] = v;
      this._setFields(fields);
    }
    return this;
  },

  _cloneFields: function () {
    return _(this.get('fields')).map(function (v) {
      return _.clone(v);
    });
  },

  _setFields: function (f) {
    f.sort(function (a, b) { return a.position - b.position; });
    this.set({ 'fields': f });
  },

  sortFields: function () {
    this.get('fields').sort(function (a, b) { return a.position - b.position; });
  },

  _addField: function (fieldName, at) {
    var dfd = $.Deferred();
    if (!this.containsField(fieldName)) {
      var fields = this.get('fields');

      if (fields) {
        at = at === undefined ? fields.length : at;
        fields.push({ name: fieldName, title: true, position: at });
      } else {
        at = at === undefined ? 0 : at;
        this.set('fields', [{ name: fieldName, title: true, position: at }], { silent: true });
      }
    }
    dfd.resolve();
    return dfd.promise();
  },

  addField: function (fieldName, at) {
    var self = this;
    $.when(this._addField(fieldName, at)).then(function () {
      self.sortFields();
      self.trigger('add:fields');
      self.trigger('change:fields', self, self.get('fields'));
      self.trigger('change', self);
    });
    return this;
  },

  removeField: function (fieldName) {
    if (this.containsField(fieldName)) {
      var fields = this._cloneFields() || [];
      var idx = _.indexOf(_(fields).pluck('name'), fieldName);
      if (idx >= 0) {
        fields.splice(idx, 1);
      }
      this._setFields(fields);
      this.trigger('remove:fields');
    }
    return this;
  },

  getAlternativeName: function (fieldName) {
    return this.get('alternative_names') && this.get('alternative_names')[fieldName];
  },

  setAlternativeName: function (fieldName, alternativeName) {
    var alternativeNames = _.clone(this.get('alternative_names') || {});

    alternativeNames[fieldName] = alternativeName;
    this.set({ 'alternative_names': alternativeNames });
    this.trigger('change:alternative_names');
  },

  getFieldPos: function (fieldName) {
    var p = this.getFieldProperty(fieldName, 'position');
    if (p === undefined) {
      return Number.MAX_VALUE;
    }
    return p;
  },

  unsetTemplate: function () {
    this.setTemplate('');
  },

  setTemplate: function (templateName) {
    var template = (typeof (this.TEMPLATES[templateName]) === 'undefined') ? '' : this.TEMPLATES[templateName];

    var attrs = {
      'template_name': templateName,
      'template': template,
      'template_type': 'mustache'
    };

    if (templateName === '') {
      attrs.fields = [];
    }

    this.set(attrs);
  },

  getTemplate: function () {
    var template_name = this.get('template_name');

    if (template_name !== '') {
      return this.TEMPLATES['custom_' + template_name];
    } else {
      return this.get('template');
    }
  },

  hasTemplate: function () {
    return !!this.get('template_name') && this.TEMPLATES[this.get('template_name')];
  },

  isCustomTemplate: function () {
    return this.get('template_name') === '' && this.get('template') !== '';
  }

});

},{"backbone":"backbone","jquery":"jquery","underscore":"underscore"}],632:[function(require,module,exports){
var InfowindowDefinitionModel = require('./infowindow-definition-model');

module.exports = InfowindowDefinitionModel.extend({

  defaults: {
    vertical_offset: 0,
    horizontal_offset: 0,
    position: 'top|center',
    template_name: '',
    template: ''
  },

  TEMPLATES: {
    tooltip_dark: require('../mustache-templates/tooltips/tooltip_dark.jst.mustache'),
    tooltip_light: require('../mustache-templates/tooltips/tooltip_light.jst.mustache'),
    custom_tooltip_dark: require('../mustache-templates/tooltips_custom/tooltip_dark.jst.mustache'),
    custom_tooltip_light: require('../mustache-templates/tooltips_custom/tooltip_light.jst.mustache')
  },

  setDefault: function () {
    this.setTemplate(this.defaults.template_name);
  }

});

},{"../mustache-templates/tooltips/tooltip_dark.jst.mustache":1113,"../mustache-templates/tooltips/tooltip_light.jst.mustache":1114,"../mustache-templates/tooltips_custom/tooltip_dark.jst.mustache":1115,"../mustache-templates/tooltips_custom/tooltip_light.jst.mustache":1116,"./infowindow-definition-model":631}],633:[function(require,module,exports){
module.exports = {
  COLORS: [
    '#66B79E',
    '#E65176',
    '#528995',
    '#FF710F',
    '#305482',
    '#CCD859',
    '#565175',
    '#FFB927',
    '#3EBCAE',
    '#E54C1F'
  ],

  /**
   * Returns a color given a letter
   * @param  {String} Letter. eg: 'a', 'b', 'c', etc.
   * @return {String} Hex color code: eg: '#7F3C8D'
   */
  getColorForLetter: function (letter) {
    if (!letter) {
      return this.COLORS[0];
    }

    var letterNumber = letter.charCodeAt(0) - 97;
    var colorIndex = ((letterNumber / this.COLORS.length % 1) * 10).toFixed();
    return this.COLORS[colorIndex] || this.COLORS[0];
  }
};

},{}],634:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var syncAbort = require('./backbone/sync-abort');
var StyleDefinitionModel = require('../editor/style/style-definition-model');
var StyleCartoCSSModel = require('../editor/style/style-cartocss-model');
var DataSQLModel = require('../editor/layers/layer-content-views/data/data-sql-model');
var layerTypesAndKinds = require('./layer-types-and-kinds');
var InfowindowModel = require('./infowindow-click-model');
var TooltipModel = require('./infowindow-hover-model');
var TableNameUtils = require('../helpers/table-name-utils');

// from_layer_id and from_letter are not attributes for the model, but are sent to the layer creation
// endpoint when creating a layer from an existing analysis node (see user-actions)
var OWN_ATTR_NAMES = ['id', 'order', 'infowindow', 'tooltip', 'error', 'from_layer_id', 'from_letter'];

/**
 * Model to edit a layer definition.
 * Should always exist as part of a LayerDefinitionsCollection, so its URL is given from there.
 */
module.exports = Backbone.Model.extend({

  /**
   * @override {Backbone.prototype.sync} abort ongoing request if there is any
   */
  sync: syncAbort,

  parse: function (r, opts) {
    r.options = r.options || {};

    // Flatten the attrs, to avoid having this.get('options').foobar internally
    var attrs = _
      .defaults(
        _.pick(r, OWN_ATTR_NAMES),
        _.omit(r.options, ['query', 'tile_style'])
    );

    // Only use type on the frontend, it will be mapped back when the model is serialized (see .toJSON)
    attrs.type = attrs.type || layerTypesAndKinds.getType(r.kind);

    // Map API endpoint attrs to the new names used client-side (cartodb.js in particular)
    if (r.options.tile_style) {
      attrs.cartocss = r.options.tile_style;
    }
    if (r.options.query) {
      attrs.sql = r.options.query;
    }

    if (r.infowindow) {
      if (!this.infowindowModel) {
        this.infowindowModel = new InfowindowModel(r.infowindow, {
          configModel: opts.configModel || this._configModel
        });
      }
    }
    if (r.tooltip) {
      if (!this.tooltipModel) {
        this.tooltipModel = new TooltipModel(r.tooltip, {
          configModel: opts.configModel || this._configModel
        });
      }
    }
    if (r.options.table_name) {
      // Set autostyle as false if it doesn't contain any id
      attrs.autoStyle = attrs.autoStyle || false;

      if (!this.styleModel) {
        this.styleModel = new StyleDefinitionModel(r.options.style_properties, {
          parse: true
        });

        this.cartocssModel = new StyleCartoCSSModel({
          content: attrs.cartocss
        }, {
          history: r.options.cartocss_history || r.options.tile_style_history
        });
      }

      if (!this.sqlModel) {
        this.sqlModel = new DataSQLModel({
          content: attrs.sql
        }, {
          history: r.options.sql_history
        });
      }
    }

    // Flatten the rest of the attributes
    return attrs;
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;

    this.on('change:source change:sql', this._onPosibleLayerSchemaChanged, this);

    if (this.styleModel) {
      this.styleModel.bind('change:type change:animated', function () {
        if (this.styleModel.isAggregatedType() || this.styleModel.isAnimation()) {
          // setTemplate will clear fields
          this.infowindowModel && this.infowindowModel.unsetTemplate();
          this.tooltipModel && this.tooltipModel.unsetTemplate();
        }
      }, this);
    }
  },

  save: function (attrs, options) {
    // We assume that if the layer is saved, we have to disable autostyle
    var autoStyleAttrs = {
      autoStyle: false
    };

    // But if the layer is saved with shouldPreserveAutoStyle option, we should preserve autostyle
    if (options && options.shouldPreserveAutoStyle) {
      delete autoStyleAttrs.autoStyle;
    } else if (this.get('autoStyle')) {
      this.styleModel && this.styleModel.resetPropertiesFromAutoStyle();
    }

    attrs = _.extend(
      {},
      autoStyleAttrs,
      attrs
    );

    return Backbone.Model.prototype.save.apply(this, [attrs, options]);
  },

  toJSON: function () {
    // Un-flatten the internal attrs to the datastructure that's expected by the API endpoint
    var options = _.omit(this.attributes, OWN_ATTR_NAMES.concat(['cartocss', 'sql', 'autoStyle']));

    // Map back internal attrs to the expected attrs names by the API endpoint
    var cartocss = this.get('cartocss');

    if (cartocss) {
      options.tile_style = cartocss;
    }
    var sql = this.get('sql');
    if (sql) {
      options.query = sql;
    }

    var d = {
      kind: layerTypesAndKinds.getKind(this.get('type')),
      options: options
    };

    var infowindowData = this.infowindowModel && this.infowindowModel.toJSON();
    if (!_.isEmpty(infowindowData)) {
      d.infowindow = this.infowindowModel.toJSON();
    }

    var tooltipData = this.tooltipModel && this.tooltipModel.toJSON();
    if (!_.isEmpty(tooltipData)) {
      d.tooltip = this.tooltipModel.toJSON();
    }

    if (this.styleModel && !this.styleModel.isAutogenerated()) {
      d.options.style_properties = this.styleModel.toJSON();
    }

    if (this.cartocssModel) {
      d.options.cartocss_history = this.cartocssModel.getHistory();
    }

    if (this.sqlModel) {
      d.options.sql_history = this.sqlModel.getHistory();
    }

    var attributes = _.omit(this.attributes, 'infowindow', 'tooltip', 'options', 'error', 'autoStyle');

    return _.defaults(
      d,
      _.pick(attributes, OWN_ATTR_NAMES)
    );
  },

  canBeDeletedByUser: function () {
    return this.collection.getNumberOfDataLayers() > 1 && this.isDataLayer() &&
      (this._canBeFoldedUnderAnotherLayer() || !this._isAllDataLayersDependingOnAnyAnalysisOfThisLayer());
  },

  isOwnerOfAnalysisNode: function (nodeModel) {
    return nodeModel && nodeModel.letter() === this.get('letter');
  },

  ownedPrimaryAnalysisNodes: function () {
    var nodeDefModel = this.getAnalysisDefinitionNodeModel();
    return this.isOwnerOfAnalysisNode(nodeDefModel)
      ? nodeDefModel.linkedListBySameLetter()
      : [];
  },

  getName: function () {
    return this.get('name') ||
    this.get('table_name_alias') ||
    this.get('table_name');
  },

  getTableName: function () {
    return this.get('table_name') || '';
  },

  containsNode: function (other) {
    var nodeDefModel = this.getAnalysisDefinitionNodeModel();
    return nodeDefModel && nodeDefModel.containsNode(other);
  },

  getAnalysisDefinitionNodeModel: function () {
    return this.findAnalysisDefinitionNodeModel(this.get('source'));
  },

  findAnalysisDefinitionNodeModel: function (id) {
    return this.collection && this.collection.findAnalysisDefinitionNodeModel(id);
  },

  _onPosibleLayerSchemaChanged: function (eventName, attrs, options) {
    // Used to avoid resetting styles on source_id changes when we have saved styles for the node
    if (options && options.ignoreSchemaChange) {
      return;
    }

    if (this.infowindowModel) {
      this.infowindowModel.clearFields();
    }
    if (this.tooltipModel) {
      this.tooltipModel.clearFields();
    }
    if (this.styleModel) {
      this.styleModel.resetStyles();
    }
  },

  toggleVisible: function () {
    this.set('visible', !this.get('visible'));
  },

  toggleCollapse: function () {
    this.set('collapsed', !this.get('collapsed'));
  },

  hasAnalyses: function () {
    return this.getNumberOfAnalyses() > 0;
  },

  getNumberOfAnalyses: function () {
    var analysisNode = this.getAnalysisDefinitionNodeModel();
    var count = 0;

    while (analysisNode && this.isOwnerOfAnalysisNode(analysisNode)) {
      analysisNode = analysisNode.getPrimarySource();

      if (analysisNode) {
        count += 1;
      }
    }

    return count;
  },

  getQualifiedTableName: function () {
    var userName = this.get('user_name') || this.collection.userModel.get('username');
    return TableNameUtils.getQualifiedTableName(
      this.getTableName(),
      userName,
      this.collection.userModel.isInsideOrg()
    );
  },

  getColumnNamesFromSchema: function () {
    return this._getQuerySchemaModel().getColumnNames();
  },

  _getQuerySchemaModel: function () {
    var nodeDefModel = this.getAnalysisDefinitionNodeModel();
    return nodeDefModel.querySchemaModel;
  },

  isDataLayer: function () {
    var layerType = this.get('type');
    return layerTypesAndKinds.isCartoDBType(layerType) ||
      layerTypesAndKinds.isTorqueType(layerType);
  },

  isTorqueLayer: function () {
    return this.get('type') === 'torque';
  },

  _canBeFoldedUnderAnotherLayer: function () {
    var thisNodeDefModel = this.getAnalysisDefinitionNodeModel();

    return this.collection.any(function (m) {
      if (m !== this && m.isDataLayer()) {
        var otherNodeDefModel = m.getAnalysisDefinitionNodeModel();
        if (otherNodeDefModel === thisNodeDefModel) return true;

        var lastNode = _.last(otherNodeDefModel.linkedListBySameLetter());
        return lastNode.getPrimarySource() === thisNodeDefModel;
      }
    }, this);
  },

  _isAllDataLayersDependingOnAnyAnalysisOfThisLayer: function () {
    var nodeDefModel = this.getAnalysisDefinitionNodeModel();
    if (!nodeDefModel) return false;
    if (!this.isOwnerOfAnalysisNode(nodeDefModel)) return false;

    var linkedNodesList = nodeDefModel.linkedListBySameLetter();

    return this.collection.chain()
      .filter(function (m) {
        return m !== this && !!m.get('source');
      }, this)
      .all(function (m) {
        return _.any(linkedNodesList, function (node) {
          return m.containsNode(node);
        });
      }, this)
      .value();
  },

  getAllDependentLayers: function () {
    var self = this;
    var layersCount = 0;

    var layerDefinitionsCollectionModels = self.collection.models;

    for (var i = 0; i < layerDefinitionsCollectionModels.length; i++) {
      var layer = layerDefinitionsCollectionModels[i];
      var dependentAnalysis = false;

      if (layer !== self) {
        var analysisNode = layer.getAnalysisDefinitionNodeModel();

        while (analysisNode) {
          if (self.isOwnerOfAnalysisNode(analysisNode)) {
            dependentAnalysis = true;
          }
          analysisNode = analysisNode.getPrimarySource();
        }

        if (dependentAnalysis) {
          layersCount += 1;
        }
      }
    }
    return layersCount;
  },

  matchesAttrs: function (otherAttrs) {
    if (this.get('type') !== otherAttrs.type) {
      return false;
    }

    if (layerTypesAndKinds.isTiledType(otherAttrs.type)) {
      return this.get('name') === otherAttrs.name &&
        this.get('urlTemplate') === otherAttrs.urlTemplate;
    }

    if (layerTypesAndKinds.isGMapsBase(otherAttrs.type)) {
      return this.get('name') === otherAttrs.name &&
        this.get('baseType') === otherAttrs.baseType &&
          this.get('style') === otherAttrs.style;
    }

    if (layerTypesAndKinds.isPlainType(otherAttrs.type)) {
      return this.get('color') === otherAttrs.color;
    }

    return false;
  },

  canBeGeoreferenced: function () {
    var hasGeocodingAnalysisApplied = function () {
      var analysisNode = this.getAnalysisDefinitionNodeModel();

      if (analysisNode && analysisNode.get('type') === 'geocoding') {
        return true;
      }

      while (analysisNode && this.isOwnerOfAnalysisNode(analysisNode)) {
        analysisNode = analysisNode.getPrimarySource();

        if (analysisNode && analysisNode.get('type') === 'geocoding') {
          return true;
        }
      }

      return false;
    }.bind(this);

    var analysisDefinitionNodeModel = this.getAnalysisDefinitionNodeModel();
    return !hasGeocodingAnalysisApplied() &&
           !analysisDefinitionNodeModel.queryGeometryModel.hasValue() &&
           !analysisDefinitionNodeModel.isCustomQueryApplied() &&
           !analysisDefinitionNodeModel.queryRowsCollection.isEmpty();
  }
});

},{"../editor/layers/layer-content-views/data/data-sql-model":889,"../editor/style/style-cartocss-model":1013,"../editor/style/style-definition-model":1025,"../helpers/table-name-utils":1101,"./backbone/sync-abort":607,"./infowindow-click-model":630,"./infowindow-hover-model":632,"./layer-types-and-kinds":637,"backbone":"backbone","underscore":"underscore"}],635:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var Backbone = require('backbone');
var LayerDefinitionModel = require('./layer-definition-model');
var layerLetters = require('./layer-letters');
var layerColors = require('./layer-colors');
var nodeIds = require('../value-objects/analysis-node-ids');
var layerTypesAndKinds = require('./layer-types-and-kinds');
var SQLUtils = require('../helpers/sql-utils');
var TableNameUtils = require('../helpers/table-name-utils');
var checkAndBuildOpts = require('../helpers/required-opts');
var REQUIRED_OPTS = [
  'analysisDefinitionNodesCollection',
  'configModel',
  'mapId',
  'stateDefinitionModel',
  'userModel'
];

var generateLabelsLayerName = function (layerName) {
  return layerName + ' Labels';
};

/**
 * Collection of layer definitions
 */
module.exports = Backbone.Collection.extend({

  initialize: function (models, opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
  },

  url: function () {
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/v1/maps/' + this._mapId + '/layers';
  },

  parse: function (r) {
    return r.layers;
  },

  save: function (options) {
    this.each(function (layerDefModel, index) {
      layerDefModel.set('order', index, { silent: true });
    });
    Backbone.sync('update', this, options);
  },

  toJSON: function () {
    return {
      layers: Backbone.Collection.prototype.toJSON.apply(this, arguments)
    };
  },

  /**
   * Intended to be called from entry point, to make sure initial layers are taken into account
   */
  resetByLayersData: function (layersData) {
    this.reset(layersData, {
      silent: true,
      initialLetters: _.chain(layersData)
        .pluck('options')
        .pluck('letter')
        .compact()
        .value()
    });
  },

  comparator: function (m) {
    return m.get('order');
  },

  model: function (d, opts) {
    var self = opts.collection;

    // Add data required for new editor if not set (e.g. a vis created on old editor doesn't contain letter and source)
    var o = _.clone(d.options) || {};
    var attrs = _.defaults(
      { options: o },
      _.omit(d, ['options']
    ));

    if (!isNaN(opts.at)) {
      attrs.options.order = opts.at;
    }

    if (layerTypesAndKinds.isKindDataLayer(attrs.kind)) {
      o.letter = o.letter || layerLetters.next(self._takenLetters(opts.initialLetters));
      o.color = o.color || layerColors.getColorForLetter(o.letter);

      // Create source attr if it does not already exist
      var sourceId = nodeIds.next(o.letter);

      if (o.table_name && (!o.source || o.source === sourceId)) {
        var tableName = TableNameUtils.getUnqualifiedName(o.table_name);
        var userName = o.user_name || TableNameUtils.getUsername(o.table_name);

        var qualifyTableName = (userName && self._configModel.get('user_name') !== userName) || self._userModel.isInsideOrg();
        tableName = TableNameUtils.getQualifiedTableName(o.table_name, userName, qualifyTableName);

        o.source = o.source || sourceId;
        o.query = o.query || SQLUtils.getDefaultSQLFromTableName(tableName);

        // Add analysis definition unless already existing
        self._analysisDefinitionNodesCollection.createSourceNode({
          id: sourceId,
          tableName: tableName,
          query: o.query
        });
      }
    }

    var parseAttrs = typeof opts.parse === 'boolean' ? opts.parse : true;
    var m = new LayerDefinitionModel(attrs, {
      parse: parseAttrs,
      collection: self,
      configModel: self._configModel
    });

    return m;
  },

  nextLetter: function () {
    return layerLetters.next(this._takenLetters());
  },

  findAnalysisDefinitionNodeModel: function (id) {
    return this._analysisDefinitionNodesCollection.get(id);
  },

  findOwnerOfAnalysisNode: function (nodeDefModel) {
    return this.find(function (layerDefModel) {
      return layerDefModel.isOwnerOfAnalysisNode(nodeDefModel);
    });
  },

  findPrimaryParentLayerToAnalysisNode: function (nodeDefModel, opts) {
    if (!nodeDefModel) return;

    opts = opts || {};
    if (!_.isArray(opts.exclude)) {
      opts.exclude = [opts.exclude];
    }
    var owner = this.findOwnerOfAnalysisNode(nodeDefModel);

    return this.find(function (layerDefModel) {
      if (layerDefModel === owner) return;
      if (_.contains(opts.exclude, layerDefModel)) return;

      var layerHeadNode = layerDefModel.getAnalysisDefinitionNodeModel();
      if (nodeDefModel === layerHeadNode) return true;

      if (layerHeadNode) {
        var primarySourceOfLastOwnNode = _.last(layerHeadNode.linkedListBySameLetter()).getPrimarySource();
        return nodeDefModel === primarySourceOfLastOwnNode;
      }
    });
  },

  isThereAnyGeometryData: function () {
    return this.filter(function (layerDefModel) {
      return layerDefModel.isDataLayer();
    }).some(function (layerDefModel) {
      var queryGeometryModel = layerDefModel.getAnalysisDefinitionNodeModel().queryGeometryModel;
      return queryGeometryModel && queryGeometryModel.hasValue();
    });
  },

  loadAllQueryGeometryModels: function (callback) {
    var promises = this.filter(function (layerDefModel) {
      return layerDefModel.isDataLayer();
    }).map(function (layerDefModel) {
      var queryGeometryModel = layerDefModel.getAnalysisDefinitionNodeModel().queryGeometryModel;
      var status = queryGeometryModel.get('status');
      var deferred = new $.Deferred();

      if (queryGeometryModel.isFetched()) {
        deferred.resolve();
      } else if (queryGeometryModel.canFetch()) {
        if (status !== 'fetching') {
          queryGeometryModel.fetch({
            success: function () {
              deferred.resolve();
            },
            error: function () {
              deferred.reject();
            }
          });
        } else {
          deferred.resolve();
        }
      } else {
        deferred.reject();
      }

      return deferred.promise();
    }, this);

    $.when.apply($, promises).done(callback);
  },

  isThereAnyTorqueLayer: function () {
    return this.any(function (m) {
      return layerTypesAndKinds.isTorqueType(m.get('type'));
    });
  },

  isThereAnyCartoDBLayer: function () {
    return this.any(function (m) {
      return layerTypesAndKinds.isCartoDBType(m.get('type'));
    });
  },

  anyContainsNode: function (nodeDefModel) {
    return this.any(function (layerDefModel) {
      return layerDefModel.containsNode(nodeDefModel);
    });
  },

  isDataLayerOnTop: function (lyrModel) {
    var currentPos = this.indexOf(lyrModel);
    return currentPos === this.getTopDataLayerIndex();
  },

  getTopDataLayerIndex: function () {
    var layerOnTop = this.getLayerOnTop();
    var at = this.indexOf(layerOnTop);
    var hasLabels = layerOnTop &&
      !layerTypesAndKinds.isCartoDBType(layerOnTop.get('type')) &&
      !layerTypesAndKinds.isTorqueType(layerOnTop.get('type'));

    if (hasLabels) { at--; }

    return at;
  },

  getNumberOfDataLayers: function () {
    return this.select(function (m) {
      return layerTypesAndKinds.isCartoDBType(m.get('type')) ||
        layerTypesAndKinds.isTorqueType(m.get('type'));
    }).length;
  },

  _takenLetters: function (otherLetters) {
    var valuesFromAddedModels = _.compact(this.pluck('letter'));

    // When adding multiple items the models created so far are stored in the internal object this._byId,
    // need to make sure to take them into account when returning already taken letter.
    var valuesFromModelsNotYetAdded = _.chain(this._byId).values().invoke('get', 'letter').value();

    return _.union(valuesFromAddedModels, valuesFromModelsNotYetAdded, otherLetters);
  },

  setBaseLayer: function (newBaseLayerAttrs) {
    this.trigger('changingBaseLayer');

    newBaseLayerAttrs = _.clone(newBaseLayerAttrs);
    if (this.isBaseLayerAdded(newBaseLayerAttrs)) {
      this.trigger('baseLayerChanged');
      return false;
    }

    var newBaseLayerHasLabels = newBaseLayerAttrs.labels && newBaseLayerAttrs.labels.url;

    var labelsLayerOptions = {
      silent: true,
      wait: true, // do not add/remove the layer unless it's created/removed/updated successfully
      success: function () {
        this.trigger('baseLayerChanged');
      }.bind(this),
      error: function () {
        this.trigger('baseLayerFailed');
      }.bind(this)
    };

    var baseLayerOptions = {
      silent: true,
      wait: true, // do not update the layer unless it's created/updated successfully
      success: function () {
        var labelsLayer = this.getLabelsLayer();
        if (newBaseLayerHasLabels) {
          if (labelsLayer) {
            this._updateLabelsLayer(newBaseLayerAttrs, labelsLayerOptions);
          } else {
            this._addLabelsLayer(newBaseLayerAttrs, labelsLayerOptions);
          }
        } else {
          if (labelsLayer) {
            this._destroyLabelsLayer(labelsLayerOptions);
          } else {
            this.trigger('baseLayerChanged');
          }
        }
      }.bind(this),
      error: function () {
        this.trigger('baseLayerFailed');
      }.bind(this)
    };

    if (this.getBaseLayer()) {
      this._updateBaseLayer(newBaseLayerAttrs, baseLayerOptions);
    } else {
      this._createBaseLayer(newBaseLayerAttrs, baseLayerOptions);
    }
  },

  isBaseLayerAdded: function (basemapAttrs) {
    var baseLayerDefinitionModel = this.getBaseLayer();
    return baseLayerDefinitionModel.matchesAttrs(basemapAttrs);
  },

  _updateBaseLayer: function (basemapAttrs, opts) {
    var currentBaseLayer = this.getBaseLayer();
    var newBaseLayerAttrs = _.omit(basemapAttrs, [ 'id', 'order', 'labels', 'template' ]);

    currentBaseLayer.attributes = _.extend({
      order: 0
    }, _.pick(currentBaseLayer.attributes, [
      'id',
      'type',
      'category'
    ]));
    currentBaseLayer.save(newBaseLayerAttrs, opts);
  },

  _createBaseLayer: function (newBaseLayerAttrs, opts) {
    newBaseLayerAttrs = _.extend(newBaseLayerAttrs, {
      order: 0
    });
    return this.create(newBaseLayerAttrs, _.extend({ at: 0 }, opts));
  },

  _updateLabelsLayer: function (newBaseLayerAttrs, opts) {
    var labelsLayer = this.getLabelsLayer();
    var newAttrs = _.omit(newBaseLayerAttrs, 'labels');
    newAttrs = _.pick(newAttrs, _.identity);
    newAttrs = _.extend(newAttrs, {
      name: generateLabelsLayerName(newBaseLayerAttrs.name),
      urlTemplate: newBaseLayerAttrs.labels.url
    });
    labelsLayer.save(newAttrs, opts);
  },

  _addLabelsLayer: function (newBaseLayerAttrs, opts) {
    var optionsAttribute = _.pick(newBaseLayerAttrs, ['type', 'subdomains', 'minZoom', 'maxZoom', 'name', 'className', 'attribution', 'category']);
    optionsAttribute = _.extend(optionsAttribute, {
      urlTemplate: newBaseLayerAttrs.labels.url,
      name: generateLabelsLayerName(newBaseLayerAttrs.name)
    });

    var labelsLayerAttrs = {
      order: this.getLayerOnTop().get('order') + 1,
      options: optionsAttribute
    };

    this.create(labelsLayerAttrs, opts);
  },

  _destroyLabelsLayer: function (opts) {
    this.getLayerOnTop().destroy(opts);
  },

  getBaseLayer: function () {
    return this.first();
  },

  getLabelsLayer: function () {
    var layerOnTop = this.getLayerOnTop();
    if (this.size() > 1 && layerTypesAndKinds.isTiledType(layerOnTop.get('type'))) {
      return layerOnTop;
    }
  },

  getLayerOnTop: function () {
    return this.last();
  }
});

},{"../helpers/required-opts":1097,"../helpers/sql-utils":1099,"../helpers/table-name-utils":1101,"../value-objects/analysis-node-ids":1119,"./layer-colors":633,"./layer-definition-model":634,"./layer-letters":636,"./layer-types-and-kinds":637,"backbone":"backbone","jquery":"jquery","underscore":"underscore"}],636:[function(require,module,exports){
var _ = require('underscore');

module.exports = {

  /**
   * Get the next available letter.
   * @param {Array} letters e.g. ['a', 'b', 'd']
   * @return {String} e.g. 'c'
   */
  next: function (letters) {
    return _.chain(letters)
      .sort()
      .reduce(function (memo, letter) {
        if (letter === memo) {
          return String.fromCharCode(letter.charCodeAt() + 1);
        } else {
          return memo;
        }
      }, 'a')
      .value();
  }

};

},{"underscore":"underscore"}],637:[function(require,module,exports){
// Types
var PLAIN = 'Plain';
var CARTODB = 'CartoDB';
var TILED = 'Tiled';
var TORQUE = 'torque';
var GMAPSBASE = 'GMapsBase';
var WMS = 'WMS';

// Values of `kind` attribute that the backend/DB knows about
var KIND_TO_TYPE_MAP = {
  'background': PLAIN,
  'carto': CARTODB,
  'gmapsbase': GMAPSBASE,
  'tiled': TILED,
  'torque': TORQUE,
  'wms': WMS
};

module.exports = {
  getType: function (kind) {
    var type = KIND_TO_TYPE_MAP[kind];

    if (!type) {
      throw new Error('no type found for given kind ' + kind);
    }

    return type;
  },

  getKind: function (type) {
    if (!type) {
      throw new Error('no kind found for given type ' + type);
    }

    var kind;
    for (kind in KIND_TO_TYPE_MAP) {
      if (KIND_TO_TYPE_MAP[kind] === type) {
        break;
      }
    }

    return kind;
  },

  isKindDataLayer: function (kind) {
    var type = KIND_TO_TYPE_MAP[kind];
    return this.isTypeDataLayer(type);
  },

  isTypeDataLayer: function (type) {
    return this.isCartoDBType(type) || this.isTorqueType(type);
  },

  isCartoDBType: function (type) {
    return type === CARTODB;
  },

  isTorqueType: function (type) {
    return type === TORQUE;
  },

  isTiledType: function (type) {
    return type === TILED;
  },

  isPlainType: function (type) {
    return type === PLAIN;
  },

  isGMapsBase: function (type) {
    return type === GMAPSBASE;
  }
};

},{}],638:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var syncAbort = require('../backbone/sync-abort');
var LegendsState = require('./legends-state');

/*
  Base model for a legend. It should have a reference to a layerDefinitionModel.
 */
module.exports = Backbone.Model.extend({
  defaults: {
    type: 'none',
    title: '',
    postHTMLSnippet: '',
    preHTMLSnippet: ''
  },

  sync: syncAbort,

  parse: function (r) {
    var attrs = _.extend({},
      _.omit(r, 'created_at', 'updated_at', 'definition', 'pre_html', 'post_html')
    );

    if (r.conf && r.conf.columns) {
      attrs.customState = r.conf.columns;
    }

    attrs.preHTMLSnippet = r.pre_html;
    attrs.postHTMLSnippet = r.post_html;
    return attrs;
  },

  urlRoot: function () {
    var baseUrl = this.configModel.get('base_url');
    return baseUrl + '/api/v3/viz/' + this.vizId + '/layer/' + this.layerDefinitionModel.id + '/legends';
  },

  initialize: function (attrs, opts) {
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.vizId) throw new Error('vizId is required');

    this.layerDefinitionModel = opts.layerDefinitionModel;
    this.configModel = opts.configModel;
    this.vizId = opts.vizId;
  },

  getStyles: function () {
    return this.layerDefinitionModel && this.layerDefinitionModel.styleModel || null;
  },

  fetch: function () {
    throw new Error('This model should not make any fetch calls. It should be created from the vizJSON.');
  },

  getType: function () {
    return this.get('type');
  },

  toJSON: function () {
    return _.extend(
      this.attributes,
      {
        type: this.getType()
      }
    );
  },

  getAttributes: function () {
    return _.extend(
      {},
      _.pick(this.attributes, _.keys(this.defaults)),
      _.omit(this.attributes, 'pre_html', 'post_html', 'customState')
    );
  },

  setAttributes: function (attrs) {
    // Store the real values
    LegendsState.set(this.layerDefinitionModel, this.get('type') || attrs.type, attrs);
    this.set(attrs);
  },

  // Overriding set
  set: function (key, val, options) {
    var attrs;
    if (typeof key === 'object') {
      attrs = key;
      options = val;
    } else {
      (attrs = {})[key] = val;
    }

    options || (options = {});

    var layerDefinitionModel = this.layerDefinitionModel || options.layerDefinitionModel;
    var type = this.get('type') || attrs.type;

    // Override attributes with the current custom state
    var state = LegendsState.get(layerDefinitionModel, type);
    var attributes = _.extend(attrs, {
      customState: _.keys(state)
    }, state);

    return Backbone.Model.prototype.set.call(this, attributes, options);
  },

  hasCustomHtml: function () {
    return false;
  }
});

},{"../backbone/sync-abort":607,"./legends-state":646,"backbone":"backbone","underscore":"underscore"}],639:[function(require,module,exports){
var _ = require('underscore');
var LegendBaseDefModel = require('./legend-base-definition-model');
var LegendColorHelper = require('../../editor/layers/layer-content-views/legend/form/legend-color-helper');
var DEFAULT_BUBBLES_COLOR = '#999999';

module.exports = LegendBaseDefModel.extend({
  defaults: _.extend({}, LegendBaseDefModel.prototype.defaults,
    {
      type: 'bubble',
      fillColor: DEFAULT_BUBBLES_COLOR,
      topLabel: '',
      bottomLabel: ''
    }
  ),

  parse: function (r, opts) {
    var attrs = LegendBaseDefModel.prototype.parse.call(this, r);

    if (opts.layerDefinitionModel) {
      if (r.definition) {
        attrs.fillColor = r.definition.color;
        attrs.topLabel = r.definition.top_label;
        attrs.bottomLabel = r.definition.bottom_label;
      } else {
        attrs.fillColor = this._inheritStyleColor(opts.layerDefinitionModel.styleModel);
      }
    }
    return attrs;
  },

  toJSON: function () {
    return _.extend(
      {},
      _.omit(this.attributes, 'fill', 'fillColor', 'topLabel', 'bottomLabel', 'postHTMLSnippet', 'preHTMLSnippet', 'customState'),
      {
        pre_html: this.get('preHTMLSnippet'),
        post_html: this.get('postHTMLSnippet')
      },
      {
        conf: {
          columns: this.get('customState')
        }
      },
      {
        definition: {
          color: this.get('fillColor'),
          top_label: this.get('topLabel'),
          bottom_label: this.get('bottomLabel')
        }
      }
    );
  },

  _inheritStyleColor: function (styleModel) {
    var fill = styleModel.get('fill');
    var stroke = styleModel.get('stroke');
    var color = (fill && fill.color) || (stroke && stroke.color);

    if (color && (color.fixed || color.range)) {
      return LegendColorHelper.getBubbles(color).color.fixed;
    } else {
      return DEFAULT_BUBBLES_COLOR;
    }
  }
});

},{"../../editor/layers/layer-content-views/legend/form/legend-color-helper":947,"./legend-base-definition-model":638,"underscore":"underscore"}],640:[function(require,module,exports){
var _ = require('underscore');
var LegendBaseDefModel = require('./legend-base-definition-model');

module.exports = LegendBaseDefModel.extend({
  defaults: _.extend({}, LegendBaseDefModel.prototype.defaults,
    {
      type: 'category'
    }
  ),

  toJSON: function () {
    return _.extend(
      {},
      _.omit(this.attributes, 'postHTMLSnippet', 'preHTMLSnippet', 'customState'),
      {
        pre_html: this.get('preHTMLSnippet'),
        post_html: this.get('postHTMLSnippet')
      },
      {
        conf: {
          columns: this.get('customState')
        }
      }
    );
  }
});

},{"./legend-base-definition-model":638,"underscore":"underscore"}],641:[function(require,module,exports){
var _ = require('underscore');
var LegendBaseDefModel = require('./legend-base-definition-model');

module.exports = LegendBaseDefModel.extend({
  defaults: _.extend({}, LegendBaseDefModel.prototype.defaults,
    {
      type: 'choropleth',
      prefix: '',
      suffix: '',
      leftLabel: '',
      rightLabel: ''
    }
  ),

  parse: function (r, opts) {
    var attrs = LegendBaseDefModel.prototype.parse.call(this, r);
    if (r.definition) {
      attrs.prefix = r.definition.prefix;
      attrs.suffix = r.definition.suffix;
      attrs.leftLabel = r.definition.left_label;
      attrs.rightLabel = r.definition.right_label;
    }
    return attrs;
  },

  toJSON: function () {
    var definition = {
      prefix: this.get('prefix'),
      suffix: this.get('suffix'),
      left_label: this.get('leftLabel'),
      right_label: this.get('rightLabel')
    };

    return _.extend(
      {},
      _.omit(this.attributes, 'prefix', 'suffix', 'leftLabel', 'rightLabel', 'postHTMLSnippet', 'preHTMLSnippet', 'customState'),
      {
        pre_html: this.get('preHTMLSnippet'),
        post_html: this.get('postHTMLSnippet')
      },
      {
        conf: {
          columns: this.get('customState')
        }
      },
      {
        definition: _.pick(definition, _.identity)
      }
    );
  }
});

},{"./legend-base-definition-model":638,"underscore":"underscore"}],642:[function(require,module,exports){
var _ = require('underscore');
var LegendBaseDefModel = require('./legend-base-definition-model');

module.exports = LegendBaseDefModel.extend({
  defaults: _.extend({}, LegendBaseDefModel.prototype.defaults,
    {
      type: 'custom_choropleth',
      prefix: '',
      suffix: '',
      colors: [],
      leftLabel: '',
      rightLabel: ''
    }
  ),

  parse: function (r, opts) {
    var attrs = LegendBaseDefModel.prototype.parse.call(this, r);
    var fill;
    var stroke;
    var color;

    if (r.definition) {
      attrs.colors = r.definition.colors;
      attrs.prefix = r.definition.prefix;
      attrs.suffix = r.definition.suffix;
      attrs.leftLabel = r.definition.left_label;
      attrs.rightLabel = r.definition.right_label;
    } else {
      fill = opts.layerDefinitionModel.styleModel.get('fill');
      stroke = opts.layerDefinitionModel.styleModel.get('stroke');
      color = fill.color || stroke.color;
      attrs.colors = this._inheritStyleColors(color);
    }
    return attrs;
  },

  toJSON: function () {
    var definition = {
      prefix: this.get('prefix'),
      suffix: this.get('suffix'),
      left_label: this.get('leftLabel'),
      right_label: this.get('rightLabel'),
      colors: this.get('colors').map(function (item) {
        return {
          color: item.color
        };
      })
    };

    return _.extend(
      {},
      _.omit(this.attributes, 'prefix', 'suffix', 'leftLabel', 'rightLabel', 'colors', 'postHTMLSnippet', 'preHTMLSnippet', 'customState'),
      {
        pre_html: this.get('preHTMLSnippet'),
        post_html: this.get('postHTMLSnippet')
      },
      {
        conf: {
          columns: this.get('customState')
        }
      },
      {
        definition: _.pick(definition, _.identity)
      }
    );
  },

  _inheritStyleColors: function (color) {
    var range = 0;
    var colors = [];

    if (color.range) {
      range = color.range.length;

      colors = _.range(range).map(function (v, index) {
        return {
          color: color.range[index]
        };
      });
    }

    return colors;
  }
});

},{"./legend-base-definition-model":638,"underscore":"underscore"}],643:[function(require,module,exports){
var _ = require('underscore');
var LegendBaseDefModel = require('./legend-base-definition-model');
var LegendColorHelper = require('../../editor/layers/layer-content-views/legend/form/legend-color-helper');

module.exports = LegendBaseDefModel.extend({
  defaults: _.extend({}, LegendBaseDefModel.prototype.defaults,
    {
      type: 'custom',
      items: [],
      html: ''
    }
  ),

  parse: function (r, opts) {
    var attrs = LegendBaseDefModel.prototype.parse.call(this, r);
    var fill;
    var stroke;
    var color;

    if (r.definition) {
      attrs.items = r.definition.categories;
      attrs.html = r.definition.html || '';
    } else {
      fill = opts.layerDefinitionModel.styleModel.get('fill');
      stroke = opts.layerDefinitionModel.styleModel.get('stroke');
      color = fill.color || stroke.color;
      attrs.items = this.inheritStyleCategories(color);
    }
    attrs.type = 'custom';
    return attrs;
  },

  toJSON: function () {
    var definition = {
      categories: this.get('items').map(function (item) {
        return {
          title: item.title || _t('editor.legend.legend-form.untitled'),
          color: item.color,
          icon: item.image || item.icon
        };
      })
    };

    if (this.hasCustomHtml()) {
      definition.html = this.get('html');
    }

    return _.extend(
      {},
      _.omit(this.attributes, 'items', 'html', 'postHTMLSnippet', 'preHTMLSnippet', 'customState'),
      {
        pre_html: this.get('preHTMLSnippet'),
        post_html: this.get('postHTMLSnippet')
      },
      {
        conf: {
          columns: this.get('customState')
        }
      },
      {
        definition: definition
      }
    );
  },

  inheritStyleCategories: function (color) {
    var range = 0;
    var items = [];

    if (color.range) {
      range = color.range.length;

      items = _.range(range).map(function (v, index) {
        return {
          color: color.range[index],
          title: color.domain && LegendColorHelper.unquoteColor(color.domain[index]) || '',
          icon: color.images && color.images[index] || ''
        };
      });
    } else if (color.fixed) {
      items = [{
        color: color.fixed,
        icon: color.image,
        title: ''
      }];
    }

    return items;
  },

  hasCustomHtml: function () {
    return this.get('html') !== '';
  }
});

},{"../../editor/layers/layer-content-views/legend/form/legend-color-helper":947,"./legend-base-definition-model":638,"underscore":"underscore"}],644:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var LegendBaseDefModel = require('./legend-base-definition-model');
var layerTypesAndKinds = require('../layer-types-and-kinds');

var CategoryModel = require('./legend-category-definition-model');
var BubbleModel = require('./legend-bubble-definition-model');
var ChoroplethModel = require('./legend-choropleth-definition-model');
var CustomChoroplethModel = require('./legend-custom-choropleth-definition-model');
var CustomModel = require('./legend-custom-definition-model');

var LEGEND_MODEL_TYPE = {
  'bubble': BubbleModel,
  'category': CategoryModel,
  'choropleth': ChoroplethModel,
  'custom_choropleth': CustomChoroplethModel,
  'custom': CustomModel,
  'html': CustomModel
};

module.exports = Backbone.Collection.extend({
  model: LegendBaseDefModel,

  initialize: function (models, options) {
    if (!options.configModel) throw new Error('configModel is required');
    if (!options.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
    if (!options.vizId) throw new Error('vizId is required');

    this.configModel = options.configModel;
    this.layerDefinitionsCollection = options.layerDefinitionsCollection;
    this.vizId = options.vizId;
  },

  /**
   * Intended to be called from entry point, to make sure initial layers are taken into account
   */
  resetByData: function (vizJSON) {
    var models = [];
    var layers = _.filter(vizJSON.layers, function (layer) {
      return this._isDataLayer(layer.type);
    }, this);

    _.each(layers, function (layer) {
      var layerDefModel = this._findLayerDefinitionModel(layer.id);
      var legends = [];
      if (layer.legends) {
        legends = layer.legends.map(function (legend) {
          var Klass = LEGEND_MODEL_TYPE[legend.type];

          return new Klass(legend, {
            layerDefinitionModel: layerDefModel,
            configModel: this.configModel,
            vizId: this.vizId,
            parse: true
          });
        }, this);
      }

      models.push(legends);
    }, this);

    this.reset(_.flatten(models));
  },

  fetch: function () {
    throw new Error('This collection should not make any fetch calls. It should be populated from the vizJSON.');
  },

  _isDataLayer: function (layerType) {
    return layerTypesAndKinds.isCartoDBType(layerType) ||
      layerTypesAndKinds.isTorqueType(layerType);
  },

  _findLayerDefinitionModel: function (id) {
    return this.layerDefinitionsCollection.findWhere({id: id});
  },

  findByLayerDefModel: function (layerDefModel) {
    var id = layerDefModel.id;
    return this.filter(function (legendDefModel) {
      var layerDefModel = legendDefModel.layerDefinitionModel;
      return layerDefModel.id === id;
    });
  },

  findByLayerDefModelAndType: function (layerDefModel, type) {
    var id = layerDefModel.id;
    return this.find(function (legendDefModel) {
      var layerDefModel = legendDefModel.layerDefinitionModel;
      return layerDefModel.id === id && legendDefModel.get('type') === type;
    });
  },

  findByLayerDefModelAndTypes: function (layerDefModel, types) {
    var id = layerDefModel.id;
    return this.filter(function (legendDefModel) {
      var layerDefModel = legendDefModel.layerDefinitionModel;
      var type = legendDefModel.get('type');
      return layerDefModel.id === id && types.indexOf(type) !== -1;
    });
  }
});

},{"../layer-types-and-kinds":637,"./legend-base-definition-model":638,"./legend-bubble-definition-model":639,"./legend-category-definition-model":640,"./legend-choropleth-definition-model":641,"./legend-custom-choropleth-definition-model":642,"./legend-custom-definition-model":643,"backbone":"backbone","underscore":"underscore"}],645:[function(require,module,exports){
var LEGENDS_METADATA = {
  bubble: {
    legendType: 'size'
  },
  category: {
    legendType: 'color'
  },
  choropleth: {
    legendType: 'color'
  },
  custom: {
    legendType: 'color'
  },
  custom_choropleth: {
    legendType: 'color'
  }
};

module.exports = LEGENDS_METADATA;

},{}],646:[function(require,module,exports){
var _ = require('underscore');
var legendsMetadata = require('./legends-metadata');

var CUSTOM_ATTRIBUTES = ['title'];
var instance;
var legends;

var State = (function () {
  var getType = function (type) {
    var legend = legendsMetadata[type];
    return legend && legend.legendType;
  };

  var onLayerAdded = function (layer) {
    instance[layer.id] = {};
  };

  var onLayerRemoved = function (layer) {
    delete instance[layer.id];
  };

  return {
    init: function (layersDefinitionCollection, legendsDefinitionCollection) {
      if (!instance) {
        instance = {};
        layersDefinitionCollection.on('add', onLayerAdded);
        layersDefinitionCollection.on('remove', onLayerRemoved);
        legends = legendsDefinitionCollection;
        this.reset();
      }
    },

    reset: function () {
      legends.each(function (legend) {
        var layer = legend.layerDefinitionModel;
        if (!instance[layer.id]) {
          instance[layer.id] = {};
        }

        var legendType = getType(legend.get('type'));
        if (!instance[layer.id][legendType]) {
          instance[layer.id][legendType] = {};
        }

        var state = _.pick(legend.attributes, legend.attributes.conf.columns);
        instance[layer.id][legendType] = state;
      });
    },

    set: function (layer, type, attrs) {
      var attributes = _.pick(attrs, CUSTOM_ATTRIBUTES);
      var legendType = getType(type);
      if (instance && legendType) {
        if (!instance[layer.id]) {
          instance[layer.id] = {};
        }
        instance[layer.id][legendType] = attributes;
      }
    },

    get: function (layer, type) {
      var legendType = getType(type);
      return instance && legendType && instance[layer.id] && instance[layer.id][legendType];
    },

    getInstance: function () {
      return instance;
    }
  };
})();

module.exports = State;

},{"./legends-metadata":645,"underscore":"underscore"}],647:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var OWN_ATTRS = ['drag', 'id', 'keyboard'];
var EMBED_ATTRS = ['legends', 'scrollwheel', 'layer_selector', 'dashboard_menu'];
var basemapProvidersAndCategories = require('./basemap-providers-and-categories');
/**
 * Model that represents a visualization's Map
 */
module.exports = Backbone.Model.extend({

  defaults: {
    drag: true,
    keyboard: true,
    cartodb_logo: false,
    legends: true,
    layer_selector: false,
    dashboard_menu: true,
    scrollwheel: true
  },

  parse: function (r) {
    return _.extend({
      provider: r['map_provider']
    },
      _.pick(r, OWN_ATTRS),
      _.pick(r.options, EMBED_ATTRS)
    );
  },

  urlRoot: function () {
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/v2/maps/';
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
    if (!opts.userModel) throw new Error('userModel is required');

    this._configModel = opts.configModel;
    this._userModel = opts.userModel;
    this._layerDefinitionsCollection = opts.layerDefinitionsCollection;

    this._layerDefinitionsCollection.bind('baseLayerChanged', this._onBaseLayerChanged, this);
  },

  _onBaseLayerChanged: function () {
    var baseLayer = this._layerDefinitionsCollection.getBaseLayer();
    var newProvider = basemapProvidersAndCategories.getProvider(baseLayer.get('type'));

    this.save({
      provider: newProvider,
      minZoom: baseLayer.get('minZoom'),
      maxZoom: baseLayer.get('maxZoom')
    });
  },

  toJSON: function () {
    return _.extend(
      {},
      _.omit(this.attributes, EMBED_ATTRS),
      {
        attribution: _.unique(this._layerDefinitionsCollection.pluck('attribution')),
        user_id: this._userModel.get('id')
      },
      {
        options: _.pick(this.attributes, EMBED_ATTRS)
      }
    );
  },

  setMapViewSize: function (size) {
    this._mapViewSize = size;
  },

  getMapViewSize: function () {
    return this._mapViewSize;
  },

  setStaticImageURLTemplate: function (staticImageURLTemplate) {
    this._staticImageURLTemplate = staticImageURLTemplate;
  },

  getStaticImageURLTemplate: function () {
    return this._staticImageURLTemplate;
  },

  setImageExportMetadata: function (metadata) {
    this._imageExportMetadata = metadata;
  },

  getImageExportMetadata: function () {
    return this._imageExportMetadata;
  },

  setConverters: function (converters) {
    _.each(converters, function (converter, key) {
      this[key] = converter;
    }, this);
  }
});

},{"./basemap-providers-and-categories":614,"backbone":"backbone","underscore":"underscore"}],648:[function(require,module,exports){
module.exports = function (overlaysCollection, mapDefModel, userModel) {
  var overlays = overlaysCollection.pluck('type');
  var canRemoveLogo = userModel.get('actions').remove_logo;

  return [{
    setting: 'search',
    label: _t('editor.settings.preview.options.elements.search'),
    related: 'overlays',
    disabled: false,
    active: overlays.indexOf('search') > 0
  },
  {
    setting: 'zoom',
    label: _t('editor.settings.preview.options.elements.zoom'),
    related: 'overlays',
    disabled: false,
    active: overlays.indexOf('zoom') > 0
  },
  {
    setting: 'logo',
    label: _t('editor.settings.preview.options.elements.logo'),
    related: 'overlays',
    disabled: !canRemoveLogo,
    active: overlays.indexOf('logo') > 0
  },
  {
    setting: 'legends',
    label: _t('editor.settings.preview.options.elements.legends'),
    related: 'map',
    disabled: false,
    active: mapDefModel.get('legends') === true
  },
  {
    setting: 'layer_selector',
    label: _t('editor.settings.preview.options.elements.layer_selector'),
    related: 'map',
    disabled: false,
    active: mapDefModel.get('layer_selector') === true
  },
  {
    setting: 'dashboard_menu',
    label: _t('editor.settings.preview.options.elements.dashboard_menu'),
    related: 'map',
    disabled: false,
    active: mapDefModel.get('dashboard_menu') === true
  },
  {
    setting: 'scrollwheel',
    label: _t('editor.settings.preview.options.elements.scrollwheel'),
    related: 'map',
    disabled: false,
    active: mapDefModel.get('scrollwheel') === true
  }];
};

},{}],649:[function(require,module,exports){
var Backbone = require('backbone');

module.exports = Backbone.Collection.extend({

  initialize: function (models, opts) {
    if (!opts.visDefinitionModel) throw new Error('visDefinitionModel is required');
    this.url = opts.visDefinitionModel.mapcapsURL();
  }
});

},{"backbone":"backbone"}],650:[function(require,module,exports){
var Backbone = require('backbone');
var AssetModel = require('./asset-model');
var checkAndBuildOpts = require('../helpers/required-opts');

var REQUIRED_OPTS = [
  'configModel',
  'orgId'
];

module.exports = Backbone.Collection.extend({
  model: AssetModel,

  url: function (method) {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('organization-assets', method);
    return baseUrl + '/api/' + version + '/organization/' + this._orgId + '/assets';
  },

  initialize: function (models, opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
  },

  deselectAll: function (m) {
    this.each(function (mdl) {
      if (mdl !== m && mdl.get('state') === 'selected') {
        mdl.set('state', '');
      }
    });
  }

});

},{"../helpers/required-opts":1097,"./asset-model":605,"backbone":"backbone"}],651:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

/**
 *  Organization info model
 *
 */
module.exports = Backbone.Model.extend({

  url: function () {
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/v1/org';
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;

    if (!_.isEmpty(this.get('owner'))) {
      this._ownerModel = new Backbone.Model(
        _.omit(this.get('owner'), 'organization')
      );
    }
  },

  getOwnerId: function () {
    return this._ownerModel && this._ownerModel.get('id');
  },

  getOwnerEmail: function () {
    return this._ownerModel && this._ownerModel.get('email');
  },

  isOrgAdmin: function (user) {
    return this.getOwnerId() === user.get('id') || !!_.find(this.get('admins'), function (u) {
      return u.id === user.get('id');
    });
  }
});

},{"backbone":"backbone","underscore":"underscore"}],652:[function(require,module,exports){
var Backbone = require('backbone');

module.exports = Backbone.Collection.extend({
  initialize: function (models, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.visId) throw new Error('visId is required');

    this._configModel = opts.configModel;
    this._visId = opts.visId;
  },

  url: function () {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('overlays');
    return baseUrl + '/api/' + version + '/viz/' + this._visId + '/overlays';
  },

  hasFetched: function () {
    return this.length > 0;
  },

  removeOverlay: function (type) {
    var overlay = this.findWhere({type: type});
    overlay && overlay.destroy();
  },

  createOverlay: function (type) {
    var types = {
      'fullscreen': this._createFullScreenOverlay,
      'layer_selector': this._createLayerSelectorOverlay,
      'search': this._createSearchOverlay,
      'zoom': this._createZoomOverlay,
      'logo': this._createLogoOverlay
    };
    var fn = types[type];
    fn && fn.call(this);
  },

  _createZoomOverlay: function () {
    var options = {
      type: 'zoom',
      order: 6,
      display: true,
      x: 20,
      y: 20
    };
    this.create(options);
  },

  _createLogoOverlay: function () {
    var options = {
      type: 'logo',
      order: 10,
      display: true,
      x: 10,
      y: 40
    };
    this.create(options);
  },

  _createSearchOverlay: function () {
    var options = {
      type: 'search',
      order: 3,
      display: true,
      x: 60,
      y: 20
    };
    this.create(options);
  },

  _createFullScreenOverlay: function () {
    var options = {
      type: 'fullscreen',
      order: 7,
      display: true,
      x: 20,
      y: 172
    };

    this.create(options);
  }
});

},{"backbone":"backbone"}],653:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var Utils = require('../helpers/utils');
var UserModel = require('./user-model');
var OrganizationModel = require('./organization-model');
var GroupModel = require('./group-model');
var ACLItemModel = require('./acl-item-model');
var READ_ONLY = 'r';
var READ_WRITE = 'rw';

/**
 * manages a cartodb permission object, it contains:
 * - owner: an UserModel instance
 * - acl: a collection which includes the user and their permission.
 *
 *   see https://github.com/Vizzuality/cartodb-management/wiki/multiuser-REST-API#permissions-object
 *
 *   this object is not created to work alone, it should be a member of
 *   an object like visualization table
 *
 */
var PermissionModel = module.exports = Backbone.Model.extend({
  urlRoot: function () {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('perm');
    return baseUrl + '/api/' + version + '/perm';
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;
    this.acl = new Backbone.Collection();
    this.owner = opts._userModel;
    this._generateOwner();
    this._generateAcl();
    this._initBinds();
  },

  _initBinds: function () {
    this.bind('change:owner', this._generateOwner, this);
    this.bind('change:acl', this._generateAcl, this);
  },

  _generateOwner: function () {
    if (!this.owner) {
      this.owner = new UserModel(null, {
        configModel: this._configModel
      });
    }
    this.owner.set(this.get('owner'));
  },

  getOwner: function () {
    return this.owner;
  },

  _generateAcl: function () {
    var self = this;
    this.acl.reset([], { silent: true });
    _.each(this.get('acl'), function (aclItem) {
      var model;
      switch (aclItem.type) {
        case 'user':
          model = new UserModel(aclItem.entity, {
            configModel: self._configModel
          });
          break;
        case 'org':
          model = new OrganizationModel(aclItem.entity, {
            configModel: self._configModel
          });
          break;
        case 'group':
          model = new GroupModel(aclItem.entity, {
            configModel: self._configModel
          });
          break;
        default:
          throw new Error('Unknown ACL item type: ' + aclItem.type);
      }
      this._grantAccess(model, aclItem.access);
    }, this);
  },

  cleanPermissions: function () {
    this.acl.reset();
  },

  hasAccess: function (model) {
    // Having at least read access is the same as having any access
    return this.hasReadAccess(model);
  },

  hasReadAccess: function (model) {
    // If there is a representable ACL item it must be one of at least READ_ONLY access
    return !!this.findRepresentableAclItem(model);
  },

  hasWriteAccess: function (model) {
    var access = Utils.result(this.findRepresentableAclItem(model), 'get', 'access');
    return access === READ_WRITE;
  },

  canChangeReadAccess: function (model) {
    return this._canChangeAccess(model);
  },

  canChangeWriteAccess: function (model) {
    return (!model.isBuilder || model.isBuilder()) && this._canChangeAccess(model, function (representableAclItem) {
      return Utils.result(representableAclItem, 'get', 'access') !== READ_WRITE;
    });
  },

  _canChangeAccess: function (model) {
    var representableAclItem = this.findRepresentableAclItem(model);
    return this.isOwner(model) || !representableAclItem ||
    representableAclItem === this._ownAclItem(model) || Utils.result(arguments, 1, representableAclItem) || false;
  },

  grantWriteAccess: function (model) {
    this._grantAccess(model, READ_WRITE);
  },

  grantReadAccess: function (model) {
    this._grantAccess(model, READ_ONLY);
  },

  revokeWriteAccess: function (model) {
    // Effectively "downgrades" to READ_ONLY
    this.grantReadAccess(model);
  },

  /**
   * Revokes access to a set of items
   * @param {Object} model A single model or an array of models
   */
  revokeAccess: function (model) {
    var aclItem = this._ownAclItem(model);
    if (aclItem) {
      this.acl.remove(aclItem);
    }
  },

  isOwner: function (model) {
    return _.result(this.owner, 'id') === _.result(model, 'id');
  },

  toJSON: function () {
    return {
      entity: this.get('entity'),
      acl: this.acl.toJSON()
    };
  },

  getUsersWithAnyPermission: function () {
    return this.acl.chain()
      .filter(this._hasTypeUser)
      .map(this._getEntity)
      .value();
  },

  isSharedWithOrganization: function () {
    return this.acl.any(this._hasTypeOrg);
  },

  clone: function () {
    var attrs = _.clone(this.attributes);
    delete attrs.id;
    return new PermissionModel(attrs, {
      configModel: this._configModel
    });
  },

  /**
   * Overwrite this ACL list from other permission object
   * @param otherPermission {Object} instance of PermissionModel
   */
  overwriteAcl: function (otherPermission) {
    this.acl.reset(otherPermission.acl.models);
  },

  // Note that this may return an inherited ACL item
  // use ._ownAclItem instead if only model's own is wanted (if there is any)
  findRepresentableAclItem: function (model) {
    if (this.isOwner(model)) {
      return this._newAclItem(model, READ_WRITE);
    } else {
      var checkList = ['_ownAclItem', '_organizationAclItem', '_mostPrivilegedGroupAclItem'];
      return this._findMostPrivilegedAclItem(checkList, function (fnName) {
        return this[fnName](model);
      });
    }
  },

  _hasTypeUser: function (m) {
    return m.get('type') === 'user';
  },

  _getEntity: function (m) {
    return m.get('entity');
  },

  _hasTypeOrg: function (m) {
    return m.get('type') === 'org';
  },

  _isOrganization: function (object) {
    return object instanceof OrganizationModel;
  },

  _ownAclItem: function (model) {
    if (!model || !_.isFunction(model.isNew)) {
      console.log('model is required to find an ACL item');
    }
    if (!model.isNew()) {
      return this.acl.find(function (aclItem) {
        return aclItem.get('entity').id === model.id;
      });
    }
  },

  _organizationAclItem: function (m) {
    var org = _.result(m.collection, 'organization') || m.organization;
    if (org) {
      return this._ownAclItem(org);
    }
  },

  _mostPrivilegedGroupAclItem: function (m) {
    var groups = _.result(m.groups, 'models');
    if (groups) {
      return this._findMostPrivilegedAclItem(groups, this._ownAclItem);
    }
  },

  /**
   * Iterates over a items in given list using the iteratee, stops and returns when found the ACL item with best access (i.e. READ_WRITE), or the
   * list is completed.
   * @param {Array} list
   * @param {Function} iteratee that takes an item from list and returns an access
   *   iteratee is called in context of this model.
   * @Return {String} 'r', 'rw', or undefined if there were no access for given item
   */
  _findMostPrivilegedAclItem: function (list, iteratee) {
    var aclItem;
    for (var i = 0, x = list[i]; x && Utils.result(aclItem, 'get', 'access') !== READ_WRITE; x = list[++i]) {
      // Keep last ACL item if iteratee returns nothing
      aclItem = iteratee.call(this, x) || aclItem;
    }
    return aclItem;
  },

  /**
   * Grants access to a set of items
   * @param {Object} model
   * @param {String} access can take the following values:
   * - 'r': read only
   * - 'rw': read and write permission
   */
  _grantAccess: function (model, access) {
    var aclItem = this._ownAclItem(model);
    if (aclItem) {
      aclItem.set('access', access);
    } else {
      aclItem = this._newAclItem(model, access);
      if (aclItem.isValid()) {
        this.acl.add(aclItem);
      } else {
        throw new Error(access + ' is not a valid ACL access');
      }
    }
  },

  _newAclItem: function (model, access) {
    var type;
    if (model instanceof UserModel) {
      type = 'user';
    } else if (model instanceof GroupModel) {
      type = 'group';
    } else if (this._isOrganization(model)) {
      type = 'org';
    } else {
      throw new Error('model not recognized as a valid ACL entity ' + model);
    }

    return new ACLItemModel({
      type: type,
      entity: model,
      access: access
    });
  }
});

exports.READ_ONLY = READ_ONLY;
exports.READ_WRITE = READ_WRITE;

},{"../helpers/utils":1102,"./acl-item-model":598,"./group-model":629,"./organization-model":651,"./user-model":671,"backbone":"backbone","underscore":"underscore"}],654:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var DEACTIVATE_MATRIX = {
  'number': ['date'],
  'boolean': ['date'],
  'date': ['boolean']
};
var DESTRUCTIVE_MATRIX = {
  'string': {
    'string': false,
    'number': true,
    'date': true,
    'boolean': true
  },
  'number': {
    'string': false,
    'number': false,
    'date': true,
    'boolean': true
  },
  'date': {
    'string': false,
    'number': true,
    'date': false,
    'boolean': true
  },
  'boolean': {
    'string': false,
    'number': false,
    'date': true,
    'boolean': false
  }
};
var NON_EDITABLE_ATTRIBUTES = [
  'the_geom_webmercator',
  'cartodb_id',
  'the_geom'
];

module.exports = Backbone.Model.extend({

  url: function () {
    if (this._tableName) {
      var baseUrl = this._configModel.get('base_url');
      var version = this._configModel.urlVersion('column');
      var url = baseUrl + '/api/' + version + '/tables/' + this._tableName + '/columns/';

      if (!this.isNew()) {
        // If name changes, we should point to the "old" name
        // in order to make the correct call
        url += this.previous('name') || this.get('name');
      }

      return url;
    }

    return false;
  },

  parse: function (attrs) {
    return {
      name: attrs.name,
      type: attrs.cartodb_type || attrs.type,
      isNew: false
    };
  },

  initialize: function (models, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._tableName = opts.tableName;
    this._configModel = opts.configModel;
  },

  isNew: function () {
    return this.get('isNew');
  },

  isEditable: function () {
    return !_.contains(NON_EDITABLE_ATTRIBUTES, this.get('name'));
  },

  // This is relative becuase we could set any value to cartodb_id
  isCartoDBIDColumn: function () {
    return this.get('name') === 'cartodb_id' && this.get('type') === 'number';
  },

  isGeometryColumn: function () {
    return this.get('type') === 'geometry';
  }
}, {
  isTypeChangeDestructive: function (type, newType) {
    return DESTRUCTIVE_MATRIX[type][newType];
  },

  isTypeChangeAllowed: function (type, newType) {
    var deactivated = DEACTIVATE_MATRIX[type] || [];
    deactivated = deactivated.concat([type]);
    return !_.contains(deactivated, newType);
  }
});

},{"backbone":"backbone","underscore":"underscore"}],655:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var QueryColumnModel = require('./query-column-model');

module.exports = Backbone.Collection.extend({

  model: function (attrs, opts) {
    var self = opts.collection;
    return new QueryColumnModel(attrs, {
      configModel: self._configModel,
      tableName: self._tableName
    });
  },

  url: function () {
    if (this._tableName) {
      var baseUrl = this._configModel.get('base_url');
      var version = this._configModel.urlVersion('column');
      return baseUrl + '/api/' + version + '/tables/' + this._tableName + '/columns';
    }

    return false;
  },

  initialize: function (models, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.querySchemaModel) throw new Error('querySchemaModel is required');

    this._tableName = opts.tableName;
    this._querySchemaModel = opts.querySchemaModel;
    this._configModel = opts.configModel;
    this._initBinds();
  },

  _initBinds: function () {
    this.bind('add remove change:type change:name', function () {
      this.reset();
      this._querySchemaModel.set('status', 'unfetched');
      this._querySchemaModel.fetch();
    }, this);
    this._querySchemaModel.bind('change:status', function (mdl, status) {
      if (status === 'fetched') {
        this.reset(this._querySchemaModel.columnsCollection.toJSON());
      }
    }, this);
  },

  setTableName: function (name) {
    if (!name) return;

    if (this._tableName) {
      this._tableName = name;

      this.each(function (columnModel) {
        columnModel._tableName = name;
      });
    }
  },

  addColumn: function (opts) {
    opts = opts || {};
    this.create(
      {
        name: 'column_' + new Date().getTime(),
        type: 'string',
        isNew: true
      },
      _.extend(
        opts,
        {
          wait: true,
          parse: false
        }
      )
    );
  }

});

},{"./query-column-model":654,"backbone":"backbone","underscore":"underscore"}],656:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var syncAbort = require('./backbone/sync-abort');
/* eslint-disable */
var template = _.template("" +
"SELECT CASE LOWER(ST_GeometryType(<%= geom_column %>)) " +
"     WHEN 'st_polygon' THEN 'polygon' " +
"     WHEN 'st_multipolygon' THEN 'polygon' " +
"     WHEN 'st_multilinestring' THEN 'line' " +
"     WHEN 'st_linestring' THEN 'line' " +
"     WHEN 'st_multipoint' THEN 'point' " +
"     WHEN 'st_point' THEN 'point' " +
"     ELSE '' " +
"  END AS the_geom FROM (<%= sql %>) __wrapped WHERE <%= geom_column %> IS NOT NULL"
/* eslint-enable */
);

var THE_GEOM_NOT_FOUND_ERROR = 'column \"the_geom\" does not exist';
var MAX_GET_LENGTH = 1024;
var PARAMS = {
  sort_order: 'asc',
  rows_per_page: 40,
  page: 0
};
var STATUS = {
  unavailable: 'unavailable',
  unfetched: 'unfetched',
  fetching: 'fetching',
  fetched: 'fetched'
};

/**
 * Model to represent a schema of a SQL query.
 */
module.exports = Backbone.Model.extend({

  defaults: {
    query: '',
    status: STATUS.unavailable, // , unfetched, fetching, fetched
    simple_geom: '', // , 'point', 'polygon', 'line'
    ready: false // until true there's no data available on the table(s) used in the query
  },

  /**
   * @override {Backbone.prototype.sync} abort ongoing request if there is any
   */
  sync: syncAbort,

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;

    this._addChangeListener();
  },

  url: function () {
    return this._configModel.getSqlApiUrl();
  },

  _addChangeListener: function () {
    this.bind('change', this._onChange, this);
  },

  _removeChangeListener: function () {
    this.unbind('change', this._onChange, this);
  },

  isFetched: function () {
    return this.get('status') === STATUS.fetched;
  },

  isFetching: function () {
    return this.get('status') === STATUS.fetching;
  },

  canFetch: function () {
    return this.hasQuery() && this.get('ready');
  },

  hasQuery: function () {
    return !!this.get('query');
  },

  shouldFetch: function () {
    return this.canFetch() && !this.isFetched() && !this.isFetching();
  },

  resetFetch: function () {
    this.set('status', STATUS.unfetched);
  },

  fetch: function (opts) {
    if (!this.canFetch()) return;

    this.set('status', STATUS.fetching);

    opts = opts || {};
    var errorCallback = opts && opts.error;

    opts.data = _.extend(
      opts.data || {},
      {
        api_key: this._configModel.get('api_key'),
        q: this._getSqlApiQueryParam(opts.geomColumnName)
      },
      PARAMS
    );

    opts.method = this._httpMethod();

    opts.error = function (model, response) {
      if (response && response.statusText !== 'abort') {
        var error = response.responseText ? JSON.parse(response.responseText).error : [];
        // in case we get an error of the_geom does not exists try with the_geom_webmercator to get the geometry type
        if (error.length === 1 && error[0] === THE_GEOM_NOT_FOUND_ERROR) {
          this.fetch(_.extend({}, opts, { geomColumnName: 'the_geom_webmercator' }));
        } else {
          errorCallback && errorCallback(error);
          this.set({
            simple_geom: '',
            query_errors: error,
            status: STATUS.unavailable
          });
        }
      }
    }.bind(this);

    return Backbone.Model.prototype.fetch.call(this, opts);
  },

  parse: function (r) {
    var simpleGeom;

    _.some(r.rows, function (row) {
      return !!(simpleGeom = row.the_geom); // to stop when found a valid simple geom
    });

    return {
      status: STATUS.fetched,
      simple_geom: simpleGeom || ''
    };
  },

  isNew: function () {
    return true; // override Backbone.Model.prototype.isNew for this.destroy() to do its w/o sending a DELETE request
  },

  hasValue: function () {
    return !!this.get('simple_geom');
  },

  _onChange: function () {
    this._removeChangeListener();

    if (!this.hasChanged('status') && this.get('status') === STATUS.fetching) {
      // If it is already fetching just redo the fetch with latest attrs
      // in case the query has changed
      if (this.hasChanged('query')) {
        this.fetch();
      }
    } else if (this.hasChanged('query') || this.hasChanged('ready')) {
      this.set('status', this.get('query') ? STATUS.unfetched : STATUS.unavailable);
    }

    this._addChangeListener();
  },

  _getSqlApiQueryParam: function (geomColumnName) {
    return template({
      geom_column: geomColumnName || 'the_geom',
      sql: this.get('query')
    });
  },

  _httpMethod: function () {
    return this._getSqlApiQueryParam().length > MAX_GET_LENGTH
      ? 'POST'
      : 'GET';
  }

});

},{"./backbone/sync-abort":607,"backbone":"backbone","underscore":"underscore"}],657:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

module.exports = Backbone.Model.extend({

  // In case that there is already an id attribute
  idAttribute: '__id',

  url: function () {
    if (this._tableName && this._configModel) {
      var baseUrl = this._configModel.get('base_url');
      var version = this._configModel.urlVersion('record');
      var url = baseUrl + '/api/' + version + '/tables/';

      if (this.hasWriteAccess(this._userModel) && !this.isOwner(this._userModel)) {
        var owner = this._permissionModel.getOwner();
        var ownerUsername = owner.get('username');

        url += ownerUsername + '.' + this._tableName + '/records';
      } else {
        url += this._tableName + '/records';
      }

      if (!this.isNew()) {
        url += '/' + this.get('cartodb_id');
      }

      return url;
    }

    return false;
  },

  initialize: function (attrs, opts) {
    this.collection = this.collection || {};

    this._tableName = opts.tableName || this.collection._tableName;
    this._configModel = opts.configModel || this.collection._configModel;
    this._permissionModel = opts.permissionModel || this.collection._permissionModel;
    this._userModel = opts.userModel || this.collection._userModel;

    this._initBinds();
  },

  _initBinds: function () {
    this.bind('error', this._onError, this);
  },

  hasWriteAccess: function (userModel) {
    if (!userModel || !this._permissionModel) {
      return false;
    }
    return this._permissionModel.hasWriteAccess(userModel);
  },

  isOwner: function (userModel) {
    if (!userModel || !this._permissionModel) {
      return false;
    }
    return this._permissionModel.isOwner(userModel);
  },

  isNew: function () {
    return !this.has('cartodb_id');
  },

  isGeomLoaded: function () {
    try {
      JSON.parse(this.get('the_geom'));
      return true;
    } catch (e) {
      return false;
    }
  },

  fetchRowIfGeomIsNotLoaded: function (callback) {
    if (this.isGeomLoaded()) {
      callback();
      return;
    }

    this.fetch({
      success: callback
    });
  },

  _onError: function () {
    this.set(this.previousAttributes());
  },

  sync: function () {
    this.trigger('loading', this);
    Backbone.Model.prototype.sync.apply(this, arguments);
  },

  parse: function (attrs) {
    if (!attrs.__id) {
      attrs.__id = _.uniqueId();
    }
    return attrs;
  },

  toJSON: function () {
    return _.omit(
      this.attributes,
      '__id',
      'the_geom_webmercator'
    );
  }

});

},{"backbone":"backbone","underscore":"underscore"}],658:[function(require,module,exports){
var Backbone = require('backbone');
var QueryRowModel = require('./query-row-model');
var syncAbort = require('./backbone/sync-abort');
var _ = require('underscore');

var MAX_GET_LENGTH = 1024;
var WRAP_SQL_TEMPLATE = 'select <%= selectedColumns %> from (<%= sql %>) __wrapped';

var STATUS = {
  unavailable: 'unavailable',
  unfetched: 'unfetched',
  fetching: 'fetching',
  fetched: 'fetched'
};

module.exports = Backbone.Collection.extend({

  DEFAULT_FETCH_OPTIONS: {
    rows_per_page: 40,
    sort_order: 'asc',
    page: 0
  },

  // Due to a problem how Backbone checks if there is a duplicated model
  // or not, we can't create the model with a function + its necessary options
  model: QueryRowModel,

  sync: syncAbort,

  url: function () {
    return this._configModel.getSqlApiUrl();
  },

  initialize: function (models, opts) {
    opts = opts || {};

    this._tableName = opts.tableName;
    this._querySchemaModel = opts.querySchemaModel;
    this._configModel = opts.configModel;

    this.statusModel = new Backbone.Model({
      status: STATUS.unavailable
    });

    this._initBinds();
  },

  _initBinds: function () {
    this.listenTo(this._querySchemaModel, 'change:query', this._onQuerySchemaQueryChange);
  },

  isFetched: function () {
    return this.statusModel.get('status') === STATUS.fetched;
  },

  isFetching: function () {
    return this.statusModel.get('status') === STATUS.fetching;
  },

  shouldFetch: function () {
    return !this.isFetched() && !this.isFetching() && this.canFetch();
  },

  resetFetch: function () {
    this.statusModel.set('status', STATUS.unfetched);
  },

  isEmpty: function () {
    return this.size() === 0;
  },

  canFetch: function () {
    return !!this._querySchemaModel.get('query') && this._querySchemaModel.get('ready') && this._querySchemaModel.isFetched();
  },

  _onQuerySchemaQueryChange: function () {
    this.statusModel.set('status', 'unfetched');
    this.reset([], { silent: true });
  },

  _geometryColumnSQL: function (column) {
    /* eslint-disable */
    return [
      "CASE",
      "WHEN GeometryType(" + column + ") = 'POINT' THEN",
        "ST_AsGeoJSON(" + column + ",8)",
      "WHEN (" + column + " IS NULL) THEN",
        "NULL",
      "ELSE",
        "GeometryType(" + column + ")",
      "END " + column
    ].join(' ');
    /* eslint-enable */
  },

  // return wrapped SQL removing the_geom and the_geom_webmercator
  // to avoid fetching those columns.
  // So for a sql like
  // select * from table the returned value is
  // select column1, column2, column3... from table
  _getWrappedSQL: function (excludeColumns) {
    var self = this;
    var schema = this._querySchemaModel.columnsCollection.toJSON();

    var selectedColumns = _
      .chain(schema)
      .omit(function (item) {
        return _.contains(excludeColumns, item.name);
      })
      .map(function (item, index) {
        if (item.type === 'geometry') {
          return self._geometryColumnSQL(item.name);
        }
        return '"' + item.name + '"';
      })
      .value();

    return _.template(WRAP_SQL_TEMPLATE)({
      selectedColumns: selectedColumns.join(','),
      sql: this._querySchemaModel.get('query')
    });
  },

  _httpMethod: function () {
    return this._querySchemaModel.get('query').length > MAX_GET_LENGTH
      ? 'POST'
      : 'GET';
  },

  fetch: function (opts) {
    opts = opts || {};

    this.statusModel.set('status', STATUS.fetching);

    var excludeColumns = (opts.data && opts.data.exclude) || [];

    opts = opts || {};
    opts.data = _.extend(
      {},
      this.DEFAULT_FETCH_OPTIONS,
      opts.data && _.omit(opts.data, 'exclude') || {},
      {
        api_key: this._configModel.get('api_key'),
        q: this._getWrappedSQL(excludeColumns)
      }
    );

    opts.method = this._httpMethod();
    var errorCallback = opts.error;
    opts.error = function (coll, resp) {
      this.trigger('fail', coll, resp);
      this.statusModel.set('status', STATUS.unavailable);
      errorCallback && errorCallback(coll, resp);
    }.bind(this);

    var successCallback = opts.success;
    opts.success = function (coll, resp) {
      this.statusModel.set('status', STATUS.fetched);
      successCallback && successCallback(coll, resp);
    }.bind(this);

    // Needed to reset the whole collection when a fetch is done
    opts.reset = true;

    return Backbone.Collection.prototype.fetch.call(this, opts);
  },

  parse: function (r) {
    return this._parseWithID(r.rows);
  },

  reset: function (result, opts) {
    var items = [];

    if (result && result.rows) {
      // If reset comes from a fetch, we need to parse the rows
      items = result.rows;
    } else {
      // If it comes directly from a simple reset function
      items = result;
    }

    Backbone.Collection.prototype.reset.apply(this, [this._parseWithID(items)]);
  },

  _parseWithID: function (array) {
    return _.map(array, function (attrs) {
      attrs.__id = _.uniqueId();
      return attrs;
    });
  },

  addRow: function (opts) {
    opts = opts || {};
    this.create(
      {
        __id: _.uniqueId()
      },
      _.extend(
        opts,
        {
          wait: true,
          parse: true
        }
      )
    );
  },

  setTableName: function (name) {
    if (!name) return;

    if (this._tableName) {
      this._tableName = name;

      this.each(function (rowModel) {
        rowModel._tableName = name;
      });
    }
  }
});

},{"./backbone/sync-abort":607,"./query-row-model":657,"backbone":"backbone","underscore":"underscore"}],659:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var syncAbort = require('./backbone/sync-abort');
var QueryRowsCollection = require('./query-rows-collection');
var SQLUtils = require('../helpers/sql-utils');

var DEFAULT_TABLE_QUERY_TEMPLATE = _.template('SELECT * FROM <%= tableName %>');
var WRAPPED_SQL_QUERY_TEMPLATE = _.template('SELECT * FROM (<%= sql %>) __wrapped');

var MAX_GET_LENGTH = 1024;
var STATUS = {
  unavailable: 'unavailable',
  unfetched: 'unfetched',
  fetching: 'fetching',
  fetched: 'fetched'
};

/**
 * Model to represent a schema of a SQL query.
 */
module.exports = Backbone.Model.extend({

  defaults: {
    query: '',
    sort_order: 'asc',
    rows_per_page: 0,
    page: 0,
    status: STATUS.unavailable, // unfetched, fetching, fetched
    ready: false // until true there's no data available on the table(s) used in the query
  },

  sync: syncAbort, // override {Backbone.prototype.sync} abort ongoing request if there is any

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;
    this.columnsCollection = new Backbone.Collection([]);
    this.rowsCollection = new QueryRowsCollection([]);

    if (this.get('status') === STATUS.unavailable) {
      this._setStatusPerQueryValue();
    }

    this._addChangeListener();
  },

  url: function () {
    return this._configModel.getSqlApiUrl();
  },

  _addChangeListener: function () {
    this.bind('change', this._onChange, this);
  },

  _removeChangeListener: function () {
    this.unbind('change', this._onChange, this);
  },

  isFetched: function () {
    return this.get('status') === STATUS.fetched;
  },

  isFetching: function () {
    return this.get('status') === STATUS.fetching;
  },

  canFetch: function () {
    return this.hasQuery() && this.get('ready');
  },

  hasQuery: function () {
    return !!this.get('query');
  },

  shouldFetch: function () {
    return this.canFetch() && !this.isFetched() && !this.isFetching();
  },

  fetch: function (opts) {
    if (!this.canFetch()) return;

    this.set('status', STATUS.fetching);

    opts = opts || {};
    var errorCallback = opts && opts.error;

    opts.data = _.extend(
      opts.data || {},
      {
        sort_order: this.get('sort_order'),
        rows_per_page: this.get('rows_per_page'),
        page: this.get('page'),
        api_key: this._configModel.get('api_key'),
        q: this._getSqlApiQueryParam()
      }
    );

    opts.method = this._httpMethod();

    opts.error = function (model, response) {
      if (response && response.statusText !== 'abort') {
        var error = response.responseText ? JSON.parse(response.responseText).error : [];
        errorCallback && errorCallback(error);
        this.set({
          query_errors: error,
          status: STATUS.unavailable
        });
      }
    }.bind(this);

    return Backbone.Model.prototype.fetch.call(this, opts);
  },

  parse: function (r) {
    this.rowsCollection.reset(r.rows);

    this.columnsCollection.reset(
      _.map(r.fields, function (d, name) {
        return {
          name: name,
          type: d.type
        };
      })
    );

    return { status: STATUS.fetched };
  },

  /**
   * @override {Backbone.prototype.isNew} for this.destroy() to work (not try to send DELETE request)
   */
  isNew: function () {
    return true;
  },

  hasDefaultQueryFor: function (tableName) {
    if (!this.hasQuery()) {
      return false;
    }
    var defaultQueryForTableName = DEFAULT_TABLE_QUERY_TEMPLATE({ tableName: tableName });
    return SQLUtils.isSameQuery(this.get('query'), defaultQueryForTableName);
  },

  getColumnNames: function () {
    return this.columnsCollection.pluck('name');
  },

  _onChange: function () {
    this._removeChangeListener();

    if (!this.hasChanged('status') && this.get('status') === STATUS.fetching) {
      this.fetch(); // If is already fetching just redo the fetch with latest attrs
    } else {
      if (this.hasChanged('query')) {
        this.columnsCollection.reset();
        this._setStatusPerQueryValue();
      }
    }

    this._addChangeListener();
  },

  _setStatusPerQueryValue: function () {
    this.set('status', this.get('query') ? STATUS.unfetched : STATUS.unavailable);
  },

  // Basically checks if an schema is different than the current one
  hasDifferentSchemaThan: function (schemaArray) {
    return !_.every(schemaArray, function (columnObj) {
      var columnModel = this.columnsCollection.findWhere({ name: columnObj.name });
      return columnModel && (columnModel.get('type') === columnObj.type || columnObj.type == null);
    }, this);
  },

  resetDueToAlteredData: function () {
    this.set('status', STATUS.unfetched);
    this.trigger('resetDueToAlteredData');
    this.fetch();
  },

  _getSqlApiQueryParam: function () {
    return WRAPPED_SQL_QUERY_TEMPLATE({
      sql: this.get('query')
    });
  },

  _httpMethod: function () {
    return this._getSqlApiQueryParam().length > MAX_GET_LENGTH
      ? 'POST'
      : 'GET';
  },

  resetFetch: function () {
    this.set('status', STATUS.unfetched);
  }

});

},{"../helpers/sql-utils":1099,"./backbone/sync-abort":607,"./query-rows-collection":658,"backbone":"backbone","underscore":"underscore"}],660:[function(require,module,exports){
var Backbone = require('backbone');
var syncAbort = require('./backbone/sync-abort');

/**
 * State definition model.
 * Used to persist the dashboard state at any time
 */
module.exports = Backbone.Model.extend({

  /**
   * @override {Backbone.prototype.sync} abort ongoing request if there is any
   */
  sync: syncAbort,

  url: function () {
    return this._visDefinitionModel.stateURL();
  },

  isNew: function () {
    return false;
  },

  initialize: function (attrs, opts) {
    if (!attrs.json) throw new Error('state json is required');
    if (!opts.visDefinitionModel) throw new Error('visDefinitionModel is required');

    this._visDefinitionModel = opts.visDefinitionModel;
  },

  toJSON: function () {
    return {
      json: this.get('json')
    };
  },

  updateState: function (state) {
    this.save({
      json: state
    });
  },

  setBounds: function (bounds) {
    this.trigger('boundsSet', bounds);
  },

  getZoom: function () {
    return this.get('json').map.zoom;
  },

  getCenter: function () {
    return this.get('json').map.center;
  }
});

},{"./backbone/sync-abort":607,"backbone":"backbone"}],661:[function(require,module,exports){
var _ = require('underscore');
var AssetModel = require('./asset-model');

module.exports = AssetModel.extend({

  defaults: {
    ext: 'svg',
    folder: 'maki-icons',
    host: 'https://s3.amazonaws.com',
    bucket: 'com.cartodb.users-assets.production',
    kind: 'marker',
    name: '',
    public_url: '',
    size: '18',
    state: 'idle'
  },

  getURLFor: function (name) {
    var url = this.get('host') + '/' + this.get('bucket') + '/' + this.get('folder') + '/' + name;
    var size = this.get('size') ? '-' + this.get('size') : '';
    return url + size + '.' + this.get('ext');
  },

  toJSON: function () {
    var c = _.clone(this.attributes);

    c['public_url'] = this.getURLFor(c['icon']);
    return c;
  },

  get: function (attr) {
    var r = this.attributes[attr];

    if (attr === 'public_url') {
      r = this.getURLFor(this.attributes['icon']);
    }

    return r;
  }
});

},{"./asset-model":605,"underscore":"underscore"}],662:[function(require,module,exports){
var StaticAssetModel = require('./static-asset-model');
var AssetsCollection = require('./assets-collection');

module.exports = AssetsCollection.extend({
  model: StaticAssetModel,

  url: function () {
    return '';
  },

  initialize: function (models, opts) {

  },

  parse: function (resp, xhr) {
    return [];
  }
});

},{"./assets-collection":606,"./static-asset-model":661}],663:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var $ = require('jquery');
var MULTIPLIER = 1.2; // Multiply current interval for this number
var INTERVAL = 1500; // Interval time between poll checkings
var SYNC_GAP = 900000; // Gap (in ms) necessary to perform next synchronization
var POLLING_GAP = 15000; // Gap (in seconds) necessary to start polling and checking synchronization

/**
 *  Synced table model
 */

module.exports = Backbone.Model.extend({
  defaults: {
    name: '',
    url: '',
    state: '',
    run_at: 0,
    ran_at: 0,
    retried_times: 0,
    interval: 0,
    error_code: 0,
    error_message: '',
    service_name: '',
    service_item_id: '',
    content_guessing: true,
    type_guessing: true
  },

  urlRoot: function () {
    var version = this._configModel.urlVersion('synchronizations');
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/' + version + '/synchronizations/';
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    this._configModel = opts.configModel;

    this.bind('destroy', function () {
      this.unset('id');
    });

    this._checkState();

    this.bind('change:error_code change:error_message change:state', this._checkState, this);
  },

  toJSON: function () {
    var c = _.clone(this.attributes);

    var d = {
      url: c.url,
      interval: c.interval,
      content_guessing: c.content_guessing,
      type_guessing: c.type_guessing,
      create_vis: c.create_vis
    };

    if (c.type === 'remote') {
      _.extend(d, {
        remote_visualization_id: c.remote_visualization_id,
        create_vis: false,
        value: c.value
      });
    }

    if (c.id !== undefined) {
      d.id = c.id;
    }

    // Comes from a service?
    if (c.service_name) {
      d.service_name = c.service_name;
      d.service_item_id = c.service_item_id;
    }

    return d;
  },

  _checkState: function () {
    if (this.get('error_code') || this.get('error_message')) {
      this.set('state', 'failure');
    }
  },

  syncNow: function (callback) {
    if (!callback) throw new Error('callback is required');

    $.ajax({
      url: this.url() + '/sync_now',
      type: 'PUT'
    }).always(callback);
  },

  // Checks for poll to finish
  pollCheck: function (i) {
    var self = this;
    var interval = INTERVAL;

    this.pollTimer = setInterval(request, interval);

    function request () {
      self.destroyCheck();

      self.fetch({
        error: function (m, e) {
          self.set({
            error_message: e.statusText || '',
            state: 'failure'
          });
        }
      });

      interval = interval * MULTIPLIER;

      self.pollTimer = setInterval(request, interval);
    }
  },

  destroyCheck: function () {
    clearInterval(this.pollTimer);
  },

  isSync: function () {
    return !this.isNew() && this.get('interval') > 0;
  },

  isSyncing: function () {
    return this.get('state') === 'syncing' || this.get('state') === 'queued';
  },

  canSyncNow: function () {
    var ranAt = new Date(this.get('ran_at'));
    var now = new Date();
    var gap = SYNC_GAP; // Importer needs some time to perform the next sync, set 15 min as default.

    if (this.isSyncing()) {
      return false;
    }

    return (now.getTime() - ranAt.getTime()) > gap;
  },

  linkToTable: function (tableModel) {
    var self = this;
    if (tableModel.has('synchronization')) {
      this.set(tableModel.get('synchronization'));
    }

    tableModel.bind('change:synchronization', function () {
      self.set(tableModel.get('synchronization'));
    }, tableModel);

    tableModel.bind('destroy', function destroy () {
      self.unbind(null, null, tableModel);
      self.destroy();
    }, tableModel);
  }
}, {
  SYNC_GAP: SYNC_GAP,
  POLLING_GAP: POLLING_GAP
});

},{"backbone":"backbone","jquery":"jquery","underscore":"underscore"}],664:[function(require,module,exports){
var Backbone = require('backbone');
var ColumnModel = require('./column-model');

/**
 * A collection of table columns
 */
module.exports = Backbone.Collection.extend({

  model: ColumnModel,

  initialize: function (models, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.tableModel) throw new Error('tableModel is required');

    this._configModel = opts.configModel;
    this._tableModel = opts.tableModel;
  },

  url: function () {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('column');
    return baseUrl + '/api/' + version + '/tables/' + this._tableModel.get('name') + '/columns';
  }

});

},{"./column-model":616,"backbone":"backbone"}],665:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var TableColumnsCollection = require('./table-columns-collection');
var getSimpleGeometryType = require('./get-simple-geometry-type');
var PermissionModel = require('./permission-model');
var SyncModel = require('./synchronization-model');
var TableNameUtils = require('../helpers/table-name-utils');

/**
 * Model representing a table.
 */
module.exports = Backbone.Model.extend({

  idAttribute: 'name',

  defaults: {
    // always not fetched to begin with, since the only way to currently get table data is by an individual request
    fetched: false,
    schema: []
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;
  },

  urlRoot: function () {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('table');
    return baseUrl + '/api/' + version + '/tables';
  },

  parse: function (r, opts) {
    var configModel = (opts && opts.configModel) || this._configModel;

    // "Sometimes" table presenter returns the needed data within table_visualization
    // attribute, because it returns the canonical visualization data. So we have to take
    // the data from there.
    if (r.table_visualization && !_.isEmpty(r.table_visualization)) {
      r = _.extend(
        {},
        r.table_visualization,
        {
          geometry_types: r.geometry_types
        }
      );
    }

    if (r.synchronization) {
      if (!this._syncModel) {
        this._syncModel = new SyncModel(r.synchronization, {
          configModel: configModel
        });
      } else {
        this._syncModel.set(r.synchronization);
      }
    }

    if (r.permission) {
      if (!this._permissionModel) {
        this._permissionModel = new PermissionModel(r.permission, {
          configModel: configModel
        });
      } else {
        this._permissionModel.set(r.permission);
      }
    }

    var attrs = _.defaults({
      fetched: true
    }, r);

    var columnsAttrs = _.map(r.schema, function (d) {
      return {
        name: d[0],
        type: d[1]
      };
    }, this);

    if (!this.columnsCollection) {
      this.columnsCollection = new TableColumnsCollection(columnsAttrs, {
        configModel: configModel,
        tableModel: this
      });
    } else {
      this.columnsCollection.reset(columnsAttrs);
    }

    return attrs;
  },

  isOwner: function (userModel) {
    if (!userModel || !this._permissionModel) {
      return false;
    }
    return this._permissionModel.isOwner(userModel);
  },

  getUnqualifiedName: function () {
    return TableNameUtils.getUnqualifiedName(this.get('name'));
  },

  getOwnerName: function () {
    var name = this.get('name');
    if (!name) return null;
    var tk = name.split('.');
    if (tk.length === 2) {
      return tk[0].replace(/"/g, '');
    } else if (this._permissionModel) {
      var ownerModel = this._permissionModel.getOwner();
      return ownerModel.get('username');
    } else {
      return '';
    }
  },

  // "user".table -> user.table
  getUnquotedName: function () {
    var name = this.get('name');
    return name && name.replace(/"/g, '');
  },

  getGeometryType: function () {
    var types = this.get('geometry_types');
    var geomTypes = [];
    if (!_.isArray(types)) {
      return [];
    }

    for (var t in types) {
      var type = types[t];
      // when there are rows with no geo type null is returned as geotype
      if (type) {
        var a = getSimpleGeometryType(type.toLowerCase());
        if (a) {
          geomTypes.push(a);
        }
      }
    }

    return _.uniq(geomTypes);
  },

  getPermissionModel: function () {
    return this._permissionModel;
  },

  isReadOnly: function (userModel) {
    return this.isSync() || !this.hasWriteAccess(userModel);
  },

  isSync: function () {
    var syncModel = this.getSyncModel();
    var isSync = syncModel && syncModel.get('id');

    return !!isSync;
  },

  hasWriteAccess: function (userModel) {
    if (!userModel || !this._permissionModel) {
      return false;
    }
    return this._permissionModel.hasWriteAccess(userModel);
  },

  getSyncModel: function () {
    return this._syncModel;
  }

});

},{"../helpers/table-name-utils":1101,"./get-simple-geometry-type":627,"./permission-model":653,"./synchronization-model":663,"./table-columns-collection":664,"backbone":"backbone","underscore":"underscore"}],666:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var TableModel = require('./table-model');

var DEFAULT_FETCH_OPTIONS = {
  type: 'table',
  order: 'updated_at',
  page: 1,
  per_page: 20,
  exclude_shared: false,
  exclude_raster: true,
  tags: '',
  q: ''
};

/**
 * A collection that holds Table models
 */
module.exports = Backbone.Collection.extend({

  model: function (d, opts) {
    var configModel = opts.collection._configModel;
    return new TableModel(d, {
      configModel: configModel,
      parse: true
    });
  },

  modelId: function (attrs) {
    return attrs.name;
  },

  initialize: function (models, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    this._configModel = opts.configModel;
    this._stats = {};
  },

  url: function () {
    var version = this._configModel.urlVersion('visualization');
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/' + version + '/viz';
  },

  // Overrides the default fetch, to use the internal methods to construct parmas
  fetch: function (opts) {
    opts = opts || {
      data: {
        // If reaches this code path it's because there were no opts given, i.e. should do a 'full fetch'
        // Since there is no current way to really do a full fetch let's just set a really high number to get all…
        // TODO this is obviously bad for organization users, how can we do this differently
        per_page: 1000
      }
    };
    opts.data = _.extend({}, DEFAULT_FETCH_OPTIONS, opts.data);
    return Backbone.Collection.prototype.fetch.call(this, opts);
  },

  getTotalStat: function (attribute) {
    return this._stats[attribute] || 0;
  },

  parse: function (res) {
    this._stats = _.omit(res, 'visualizations');

    return _.map(res.visualizations, function (d) {
      var dt = d.table; // embedded table data in the vis response
      return {
        // From embedded table with same key/value
        id: dt.id,
        geometry_types: dt.geometry_types,
        name: dt.name,
        privacy: dt.privacy,

        // From embedded table with same value, but different key
        // so re-map them to match what's returned from a GET /tables/t-id
        rows_counted: dt.row_count,
        table_size: dt.size,
        table_type: d.type // table or remote
      };
    }, this);
  }
});

},{"./table-model":665,"backbone":"backbone","underscore":"underscore"}],667:[function(require,module,exports){
var _ = require('underscore');
var BackboneUndo = require('backbone-undo');
var MAXIMUM_STACK_LENGTH = 30;

module.exports = {
  init: function (model, opts) {
    if (!model) throw new Error('model is required to initialize undoManager');

    opts = opts || {};
    this.model = model;

    this.model._undoManager = this.undoManager = new BackboneUndo({
      maximumStackLength: opts.maximumStackLength || MAXIMUM_STACK_LENGTH,
      register: this.model,
      track: opts.track
    });

    this._trackEvents();
    this._addMethods();

    if (!_.isEmpty(opts.history)) {
      opts.track && this.undoManager.stopTracking();
      this._addHistory(opts.history);
      opts.track && this.undoManager.startTracking();
    }
  },

  _trackEvents: function () {
    _.each(['undo', 'redo'], function (eventType) {
      this.undoManager.bind(eventType, function () {
        this.trigger(eventType, this.changed, this);
      }, this.model);
    }, this);

    this.undoManager.stack.bind('add remove reset', function () {
      this.trigger('unredoChanged', this.changed, this);
    }, this.model);
  },

  _addHistory: function (history) {
    var stack = this.undoManager.stack;

    _.each(history, function (attrs, i) {
      if (history[i + 1]) {
        stack.add({
          after: history[i + 1],
          before: attrs,
          type: 'change',
          undoTypes: this.undoManager.undoTypes,
          object: this.model,
          magicFusionIndex: 0
        });
      }
    }, this);

    stack.pointer = stack.length - 1;
  },

  _addMethods: function () {
    _.extend(
      this.model,
      {
        undo: function () {
          this._undoManager.undo();
        },

        redo: function () {
          this._undoManager.redo();
        },

        canUndo: function () {
          return this._undoManager.isAvailable('undo');
        },

        canRedo: function () {
          return this._undoManager.isAvailable('redo');
        },

        getUndoHistory: function () {
          var list = this._undoManager.stack.toJSON();
          var data = _.reduce(list, function (memo, attrs, i) {
            memo.push(attrs.before);
            return memo;
          }, [], this);
          data.push(this.attributes);
          return data;
        }
      }
    );
  }
};

},{"backbone-undo":"backbone-undo","underscore":"underscore"}],668:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var UploadConfig = require('../config/upload-config');
var Utils = require('../helpers/utils.js');
var moment = require('moment');
require('backbone-model-file-upload');

/**
 * Model that allows uploading files to CartoDB endpoints.
 *
 * NOTE: this model extends Backbone.Model instead of Backbone.Model, because
 * it's required for the vendor/backbone-model-file-upload.
 */
module.exports = Backbone.Model.extend({
  url: function () {
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/v1/imports';
  },

  fileAttribute: 'filename',

  defaults: {
    type: '',
    value: '',
    interval: 0,
    privacy: '',
    progress: 0,
    state: 'idle',
    service_item_id: '',
    service_name: '',
    option: '',
    content_guessing: true,
    type_guessing: true,
    create_vis: true
  },

  initialize: function (attrs, opts) {
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.configModel) throw new Error('configModel is required');

    this._userModel = opts.userModel;
    this._configModel = opts.configModel;
    this._initBinds();
    // We need to validate entry attributes
    this._validate(this.attributes, { validate: true });
  },

  setUpload: function (d) {
    this.set(d, {
      validate: true
    });
  },

  isValidToUpload: function () {
    return this.get('value') && this.get('state') !== 'error';
  },

  setFresh: function (d) {
    if (d && !_.isEmpty(d)) {
      // Set upload properties except create_vis (defined when created)
      this.set(_.omit(d, 'create_vis'));
    } else {
      this.clear();
    }
  },

  _initBinds: function () {
    this.bind('progress', function (progress) {
      this.set({
        progress: progress * 100,
        state: 'uploading'
      });
    }, this);

    this.bind('change:value', function () {
      if (this.get('state') === 'error') {
        this.set({ state: 'idle' });
        this.unset('get_error_text', { silent: true });
      }
    }, this);

    this.bind('error invalid', function (m, d) {
      this.set({
        state: 'error',
        error_code: (d && d.error_code) || '',
        get_error_text: {
          title: _t('data.upload-model.invalid-import'),
          what_about: (d && d.msg) || ''
        }
      });
    }, this);
  },

  validate: function (attrs) {
    if (!attrs) return;

    if (attrs.type === 'file') {
      // Number of files
      if (attrs.value && attrs.value.length) {
        return {
          msg: _t('data.upload-model.one-file')
        };
      }

      // File name
      var name = attrs.value.name;
      if (!name) {
        return {
          msg: _t('data.upload-model.file-defined')
        };
      }

      // File extension
      var ext = name.substr(name.lastIndexOf('.') + 1);
      if (ext) {
        ext = ext.toLowerCase();
      }
      if (!_.contains(UploadConfig.fileExtensions, ext)) {
        return {
          msg: _t('data.upload-model.file-extension')
        };
      }
      // File size
      if ((this._userModel.get('remaining_byte_quota') * UploadConfig.fileTimesBigger) < attrs.value.size) {
        return {
          msg: _t('data.upload-model.file-size'),
          error_code: 8001
        };
      }
    }

    if (attrs.type === 'remote') {
      // Valid remote visualization id?
      if (!attrs.remote_visualization_id) {
        return {
          msg: _t('data.upload-model.visualization-id')
        };
      }
      // Remote size?
      if (attrs.size && ((this._userModel.get('remaining_byte_quota') * UploadConfig.fileTimesBigger) < attrs.size)) {
        return {
          msg: _t('data.upload-model.remote-file-size'),
          error_code: 8001
        };
      }
    }

    if (attrs.type === 'url') {
      // Valid URL?
      if (!Utils.isURL(attrs.value)) {
        return {
          msg: _t('data.upload-model.url-invalid')
        };
      }
    }

    if (attrs.type === 'sql') {
      if (!attrs.value) {
        return {
          msg: _t('data.upload-model.query-undefined')
        };
      }
    }

    if (attrs.type === 'duplication') {
      if (!attrs.value) {
        return {
          msg: _t('data.upload-model.dataset-copy-undefined')
        };
      }
    }

    if (attrs.type === 'service' && attrs.service_name === 'twitter_search') {
      var service_item_id = attrs.service_item_id;

      // Empty?
      if (!service_item_id || _.isEmpty(service_item_id)) {
        return {
          msg: _t('data.upload-model.twitter-data')
        };
      }

      // Categories?
      if (_.isEmpty(service_item_id.categories)) {
        return {
          msg: _t('data.upload-model.twitter-categories-invalid')
        };
      }

      // Dates?
      var dates = service_item_id.dates;
      if (!dates || _.isEmpty(dates)) {
        return {
          msg: _t('data.upload-model.twitter-dates-empty')
        };
      }
      var isToDateValid = moment(dates.fromDate) <= moment(new Date());
      if (!dates.fromDate || !dates.toDate || !isToDateValid) {
        return {
          msg: _t('data.upload-model.twitter-dates-invalid')
        };
      }
    }
  },

  isValid: function () {
    return this.get('value') && this.get('state') !== 'error';
  },

  upload: function () {
    if (this.get('type') === 'file') {
      var self = this;
      this.xhr = this.save(
        {
          filename: this.get('value')
        },
        {
          success: function (m) {
            m.set('state', 'uploaded');
          },
          error: function (m, msg) {
            var message = _t('data.upload-model.connection-error');

            if (msg && msg.status === 429) {
              var response = JSON.parse(msg.responseText);
              message = response.errors.imports;
            }

            self.set({
              state: 'error',
              get_error_text: {
                title: _t('data.upload-model.error-happened'),
                what_about: message
              }
            });
          },
          complete: function () {
            delete self.xhr;
          }
        }
      );
    }
  },

  stopUpload: function () {
    if (this.xhr) this.xhr.abort();
  },

  setGuessing: function (val) {
    this.set({
      type_guessing: val,
      content_guessing: val
    });
  },

  setPrivacy: function (val) {
    this.set('privacy', val);
  }

});

},{"../config/upload-config":597,"../helpers/utils.js":1102,"backbone":"backbone","backbone-model-file-upload":"backbone-model-file-upload","moment":"moment","underscore":"underscore"}],669:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var nodeIds = require('../value-objects/analysis-node-ids');
var MetricsTracker = require('../components/metrics/metrics-tracker');
var SimpleStyleDefaults = require('../editor/style/style-defaults/simple-style-defaults');
var camshaftReference = require('./camshaft-reference');
var layerTypesAndKinds = require('./layer-types-and-kinds');
var layerColors = require('./layer-colors');
var Notifier = require('../components/notifier/notifier');
var resetStylePerNode = require('../helpers/reset-style-per-node');

/**
 * Coordinate side-effects done on explicit interactions.
 * @param {Object} params
 * @param {Object} params.userModel
 * @param {Object} params.analysisDefinitionsCollection
 * @param {Object} params.analysisDefinitionNodesCollection
 * @param {Object} params.widgetDefinitionsCollection
 * @return {Object} that contains all user-actions that the user may do related to a map
 */
module.exports = function (params) {
  if (!params.userModel) throw new Error('userModel is required');
  if (!params.analysisDefinitionsCollection) throw new Error('analysisDefinitionsCollection is required');
  if (!params.analysisDefinitionNodesCollection) throw new Error('analysisDefinitionNodesCollection is required');
  if (!params.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
  if (!params.widgetDefinitionsCollection) throw new Error('widgetDefinitionsCollection is required');

  var userModel = params.userModel;
  var analysisDefinitionsCollection = params.analysisDefinitionsCollection;
  var analysisDefinitionNodesCollection = params.analysisDefinitionNodesCollection;
  var layerDefinitionsCollection = params.layerDefinitionsCollection;
  var widgetDefinitionsCollection = params.widgetDefinitionsCollection;

  var createDefaultCartoDBAttrs = function (oldLayerStyle) {
    return {
      kind: 'carto',
      options: {
        interactivity: '',
        tile_style: (oldLayerStyle && oldLayerStyle.options.tile_style) || camshaftReference.getDefaultCartoCSSForType(),
        cartocss: (oldLayerStyle && oldLayerStyle.options.tile_style) || camshaftReference.getDefaultCartoCSSForType(),
        style_version: '2.1.1',
        visible: true,
        style_properties: (oldLayerStyle && oldLayerStyle.options.style_properties),
        sql_wrap: (oldLayerStyle && oldLayerStyle.options.sql_wrap)
      },
      tooltip: oldLayerStyle ? oldLayerStyle.tooltip : {},
      infowindow: oldLayerStyle ? oldLayerStyle.infowindow : {}
    };
  };

  var deleteOrphanedAnalyses = function () {
    analysisDefinitionNodesCollection
      .toArray()
      .forEach(function (nodeDefModel) {
        if (!layerDefinitionsCollection.anyContainsNode(nodeDefModel)) {
          nodeDefModel.destroy();
        }
      });

    analysisDefinitionsCollection
      .toArray()
      .forEach(function (analysisDefModel) {
        if (!analysisDefModel.getNodeDefinitionModel()) {
          analysisDefModel.destroy();
        }
      });
  };

  var restoreWidgetsFromLayer = function (affectedWidgets, layerDefModel, callback, callbackOptions) {
    if (!affectedWidgets || !_.isArray(affectedWidgets)) throw new Error('affectedWidgets is required');
    if (!layerDefModel) throw new Error('layerDefModel is required');
    if (!callback) throw new Error('callback is required');

    var notification;
    var restoringError;
    var onWidgetFinished = _.after(affectedWidgets.length, function () {
      if (!restoringError) {
        notification.set({
          status: 'success',
          info: _t('notifications.widgets.restored'),
          closable: true
        });
      } else {
        Notifier.removeNotification(notification);
      }
      callback(layerDefModel, callbackOptions);
    });

    if (affectedWidgets.length > 0) {
      notification = Notifier.addNotification({
        status: 'loading',
        info: _t('notifications.widgets.restoring'),
        closable: false
      });

      // Create widgets with new source and layer_id
      _.each(affectedWidgets, function (attrs) {
        attrs.layer_id = attrs.layer_id || layerDefModel.id;

        widgetDefinitionsCollection.create(
          attrs, {
            wait: true,
            success: onWidgetFinished,
            error: function (e, mdl) {
              notification = Notifier.addNotification({
                status: 'error',
                info: _t('notifications.widgets.error.title') +
                  _t('notifications.widgets.error.body', {
                    body: '',
                    error: mdl && mdl.get('title')
                  }),
                closable: true
              });
              restoringError = true;
              onWidgetFinished();
            }
          }
        );
      });
    } else {
      callback(layerDefModel, callbackOptions);
    }
  };

  return {
    _resetStylePerNode: function (nodeDefModel, layerDefModel, forceStyleUpdate, resetQueryReady) {
      resetStylePerNode(nodeDefModel, layerDefModel, forceStyleUpdate, resetQueryReady);
    },

    saveAnalysis: function (analysisFormModel) {
      if (!analysisFormModel.isValid()) return;

      var nodeDefModel = analysisDefinitionNodesCollection.get(analysisFormModel.id);

      if (nodeDefModel) {
        analysisFormModel.updateNodeDefinition(nodeDefModel);
        var layerDefModel = layerDefinitionsCollection.findOwnerOfAnalysisNode(nodeDefModel);
        analysisDefinitionsCollection.saveAnalysisForLayer(layerDefModel);

        MetricsTracker.track('Modified analysis', {
          analysis: {
            id: analysisFormModel.attributes['id'],
            natural_id: analysisFormModel.attributes['id'],
            type: analysisFormModel.attributes['type']
          }
        });

        this._resetStylePerNode(nodeDefModel, layerDefModel, false, true);
      } else {
        nodeDefModel = analysisFormModel.createNodeDefinition(this); // delegate creation to the form, but expect it to call userActions.createAnalysisNode when done with its internal stuff
      }
      nodeDefModel.USER_SAVED = true;
    },

    /**
     * Creates a new analysis node on a particular layer.
     * It's assumed to be created on top of an existing node.
     * @param {Object} nodeAttrs
     * @param {Object} layerDefModel - instance of layer-definition-model
     * @return {Object} instance of analysis-definition-node-model
     */
    createAnalysisNode: function (nodeAttrs, layerDefModel) {
      var nodeDefModel = analysisDefinitionNodesCollection.add(nodeAttrs, {parse: false});

      layerDefModel.save({
        cartocss: camshaftReference.getDefaultCartoCSSForType(),
        source: nodeDefModel.id
      });
      analysisDefinitionsCollection.saveAnalysisForLayer(layerDefModel);

      MetricsTracker.track('Created analysis', {
        analysis: {
          id: nodeDefModel.attributes['id'],
          natural_id: nodeDefModel.attributes['id'],
          type: nodeDefModel.attributes['type']
        }
      });

      this._resetStylePerNode(nodeDefModel, layerDefModel);

      return nodeDefModel;
    },

    saveAnalysisSourceQuery: function (query, nodeDefModel, layerDefModel) {
      if (!nodeDefModel) throw new Error('nodeDefModel is required');
      if (nodeDefModel.get('type') !== 'source') throw new Error('nodeDefModel must be a source node');

      nodeDefModel.set('query', query || '');

      analysisDefinitionsCollection.saveAnalysisForLayer(layerDefModel);
      this._resetStylePerNode(nodeDefModel, layerDefModel);
      layerDefModel.save(); // to make sure layer's source ref is persisted
    },

    saveWidgetOption: function (widgetOptionModel) {
      if (!widgetOptionModel) throw new Error('widgetOptionModel is required');

      if (widgetOptionModel.analysisDefinitionNodeModel()) { // Might not always have a node-definition, e.g. time-series none-option
        var layerDefModel = widgetOptionModel.layerDefinitionModel();
        analysisDefinitionsCollection.saveAnalysisForLayer(layerDefModel);
      }

      return widgetOptionModel.save(widgetDefinitionsCollection); // delegate back to form model to decide how to save
    },

    saveWidget: function (widgetDefModel) {
      if (!widgetDefModel) throw new Error('widgetDefModel is required');

      var widgetLayerId = widgetDefModel.get('layer_id');
      layerDefinitionsCollection.some(function (layerDefModel) {
        if (layerDefModel.id === widgetLayerId) {
          analysisDefinitionsCollection.saveAnalysisForLayer(layerDefModel);
          return true; // aborts the "some"-iterator
        }
      });

      widgetDefModel.save();
    },

    deleteAnalysisNode: function (nodeId) {
      var nodeDefModel = analysisDefinitionNodesCollection.get(nodeId);
      if (!nodeDefModel) return false; // abort if there is no node-definition; nothing to delete/change
      if (!nodeDefModel.canBeDeletedByUser()) return false;

      var layerDefModel = layerDefinitionsCollection.findOwnerOfAnalysisNode(nodeDefModel);
      var primarySourceNode = nodeDefModel.getPrimarySource();

      var containsNode = function (m) {
        return m !== layerDefModel && m !== nodeDefModel && m.containsNode(nodeDefModel);
      };
      _
        .flatten([
          widgetDefinitionsCollection.filter(containsNode),
          layerDefinitionsCollection.filter(containsNode),
          analysisDefinitionsCollection.filter(containsNode),
          analysisDefinitionNodesCollection.filter(containsNode),
          nodeDefModel
        ], true)
        .forEach(function (m) {
          m.destroy();
        });

      // Try to restore old styles if we have them, reset them if not
      var oldNodeStyle = primarySourceNode.getStyleHistoryForLayer(layerDefModel.id);
      if (oldNodeStyle) {
        layerDefModel.set({source: primarySourceNode.id}, {ignoreSchemaChange: true});
        layerDefModel.styleModel.set(layerDefModel.styleModel.parse(oldNodeStyle.options.style_properties));
        layerDefModel.set({
          cartocss: oldNodeStyle.options.tile_style,
          infowindow: oldNodeStyle.infowindow,
          tooltip: oldNodeStyle.tooltip,
          sql_wrap: oldNodeStyle.options.sql_wrap
        });
      } else {
        layerDefModel.set({source: primarySourceNode.id});
      }
      layerDefModel.save();
      analysisDefinitionsCollection.saveAnalysisForLayer(layerDefModel);

      MetricsTracker.track('Deleted analysis', {
        analysis: {
          id: nodeDefModel.attributes['id'],
          natural_id: nodeDefModel.attributes['id'],
          type: nodeDefModel.attributes['type']
        }
      });

      this._resetStylePerNode(primarySourceNode, layerDefModel);

      deleteOrphanedAnalyses();
    },

    /**
     * Create a new layer for a given table name
     * @param {model} [tableModel]
     * @param {object} [options]
     * @param {number} [options.at]
     */
    createLayerFromTable: function (tableModel, options) {
      options = options || {};

      var tableName = tableModel.getUnqualifiedName();
      var ownerName = tableModel.getOwnerName() || userModel.get('username');
      var tableGeometry = tableModel.getGeometryType() && tableModel.getGeometryType()[0];

      // Setting at assumes there to be at least one non-basemap layer
      var at = options.at || layerDefinitionsCollection.length;
      var layerOnTop = layerDefinitionsCollection.getLayerOnTop();
      var layerOnTopPos = layerDefinitionsCollection.indexOf(layerOnTop);
      var hasTorque = layerDefinitionsCollection.isThereAnyTorqueLayer();
      var hasLabels = layerOnTop &&
        !layerTypesAndKinds.isCartoDBType(layerOnTop.get('type')) &&
        !layerTypesAndKinds.isTorqueType(layerOnTop.get('type'));

      if (hasTorque || hasLabels) {
        layerOnTop.set('order', layerOnTopPos + 1); // persisted on collection.save in success callback below

        if (hasLabels) { at--; }
        if (hasTorque) { at--; }
      }

      var newLetter = layerDefinitionsCollection.nextLetter();
      var attrs = createDefaultCartoDBAttrs();
      attrs.letter = newLetter;
      attrs.options.table_name = tableName;
      if (ownerName) {
        attrs.options.user_name = ownerName;
      }

      if (tableGeometry) {
        attrs.options.style_properties = {
          type: 'simple',
          properties: SimpleStyleDefaults.generateAttributes(tableGeometry)
        };
      }

      analysisDefinitionNodesCollection.addRelatedTableData(tableModel.toJSON());

      return layerDefinitionsCollection.create(attrs, {
        wait: true,
        at: at,
        error: options.error,
        success: function () {
          layerDefinitionsCollection.each(function (layerDefModel) {
            if (!layerDefModel.isDataLayer()) return;
            if (analysisDefinitionsCollection.findAnalysisForLayer(layerDefModel)) return;

            analysisDefinitionsCollection.saveAnalysisForLayer(layerDefModel);
          });
          layerDefinitionsCollection.save();
          options.success && options.success();
        }
      });
    },

    /**
     * A layer for an existing node have different side-effects depending on the context in which the node exists.
     * @param {string} nodeid
     * @param {object} cfg
     * @param {number} cfg.at
     */
    createLayerForAnalysisNode: function (nodeId, cfg) {
      var userMaxLayers = userModel.get('limits').max_layers;
      if (layerDefinitionsCollection.getNumberOfDataLayers() >= userMaxLayers) {
        var err = new Error('max layers reached');
        err.userMaxLayers = userMaxLayers;
        throw err;
      }

      var nodeDefModel = analysisDefinitionNodesCollection.get(nodeId);
      if (!nodeDefModel) throw new Error('node with id ' + nodeId + ' does not exist');
      if (!cfg) throw new Error('cfg is required');
      if (isNaN(cfg.at) || cfg.at <= 0) throw new Error('cfg.at must be on top of the base layer');

      var newPosition = cfg.at;

      var attrs;
      var tableName;
      var tableNameAlias;
      var ownerName;
      var oldNodeStyle;
      var newLetter = layerDefinitionsCollection.nextLetter();
      var affectedWidgetAttrsBySourceChange = [];

      var onNewLayerSaved = function (layer, forceResetStyles) {
        this._resetStylePerNode(layer.getAnalysisDefinitionNodeModel(), layer, forceResetStyles);
        layerDefinitionsCollection.save(); // to persist layers order
      }.bind(this);

      var prevLayer = layerDefinitionsCollection.findWhere({source: nodeId});
      if (prevLayer) {
        if (nodeDefModel.hasPrimarySource()) {
          // Node is head of a layer, e.g. given nodeId A3 it should rename prev layer (A => B), and create a new layer (A)
          // where the prev layer was to take over its letter identity and its primary source (A2).
          // The motivation for this is to maintain the layer's state (styles, popup etc.) which really depends on the
          // last analysis output than the layer itself:
          //   _______       _______   ______
          //  | A    |      | A    |  | B    | <-- note that B is really A which just got moved & had it's nodes renamed
          //  |      |      |      |  |      |
          //  | {A3} |  =>  |      |  | {B1} |
          //  | [A2] |      | [A2] |  | [A2] |
          //  | [A1] |      | [A1] |  |      |
          //  | [A0] |      | [A0] |  |      |
          //  |______|      |______|  |______|
          var prevOrder = layerDefinitionsCollection.indexOf(prevLayer);
          var prevLetter = prevLayer.get('letter');

          // Change identity of prevLayer (A) so it appears as the new layer (B), including its analysis
          var renamedNodeId = newLetter + '1';
          var renamedNodeDefModel = nodeDefModel.clone(renamedNodeId); // e.g. A3 => B1
          analysisDefinitionNodesCollection.invoke('changeSourceIds', nodeId, renamedNodeId);

          // We have to manage all widgets associated with the layer due to the operations we do
          // creating a new one and managing the previous one
          var prevLayerNodeIds = _.pluck(prevLayer.ownedPrimaryAnalysisNodes(), 'id');
          var affectedWidgetsBySourceChange = widgetDefinitionsCollection.filter(function (widgetDefModel) {
            return _.contains(prevLayerNodeIds, widgetDefModel.get('source'));
          });

          _.each(affectedWidgetsBySourceChange, function (widgetDefModel) {
            var attrs;
            var widgetSourceId = widgetDefModel.get('source');

            // If this widget doesn't point to the "dragged" node, it will
            // keep the source but the layer_id will be totally different
            if (widgetSourceId !== nodeId) {
              attrs = _.extend(
                _.omit(widgetDefModel.toJSON(), 'id', 'layer_id', 'order'),
                {
                  avoidNotification: true
                }
              );
            } else {
              // On the other hand, if there is a widget pointing to the dragged node,
              // it will keep the layer_id but the source will be different
              attrs = _.extend(
                _.omit(widgetDefModel.toJSON(), 'id', 'source', 'order'),
                {
                  source: {
                    id: renamedNodeId
                  },
                  avoidNotification: true
                }
              );
            }

            affectedWidgetAttrsBySourceChange.push(attrs);
            widgetDefModel.attributes.avoidNotification = true;
            widgetDefModel.destroy();
          });

          prevLayer.save({
            letter: newLetter,
            color: layerColors.getColorForLetter(newLetter),
            source: renamedNodeId
          }, {ignoreSchemaChange: true});

          analysisDefinitionsCollection.newAnalysisForNode(renamedNodeDefModel); // will be saved by saveAnalysisForLayer later since containing that layer's node

          // Remove prevLayer (A) temporarily, to move the layers to expected positions
          layerDefinitionsCollection.remove(prevLayer, {silent: true}); // silent to avoid unwanted side-effects; re-added again later

          // New layer takes over the identity of the old layer (A), and its primary source as its head node
          // We apply the styles from the new header node (A2) if available
          oldNodeStyle = nodeDefModel.getPrimarySource().getStyleHistoryForLayer(prevLayer.id);
          tableName = prevLayer.get('table_name');
          tableNameAlias = prevLayer.get('table_name_alias');
          ownerName = prevLayer.get('user_name') || userModel.get('username');
          attrs = createDefaultCartoDBAttrs(oldNodeStyle);
          attrs.options = _.extend({}, attrs.options, {
            sql: 'SELECT * FROM ' + tableName,
            table_name: tableName,
            table_name_alias: tableNameAlias,
            letter: prevLetter,
            color: layerColors.getColorForLetter(prevLetter),
            source: nodeDefModel.getPrimarySource().id
          });
          if (ownerName) {
            attrs.options.user_name = ownerName;
          }

          // Tell the backend that this layer is a copy of the old one, and how to rename the analysis nodes.
          // This is used to keep the style_history valid in both the old a new layer
          attrs.from_layer_id = prevLayer.get('id');
          attrs.from_letter = prevLetter;
          var newLayerDefModel = layerDefinitionsCollection.add(attrs, {at: prevOrder});
          analysisDefinitionsCollection.saveAnalysisForLayer(newLayerDefModel);

          // Re-add source layer again, but after the new layer was created and before layer is getting saved
          layerDefinitionsCollection.add(prevLayer, {at: newPosition});

          // Reset styles from previous layer
          this._resetStylePerNode(prevLayer.getAnalysisDefinitionNodeModel(), prevLayer);

          newLayerDefModel.save(null, {
            success: function () {
              restoreWidgetsFromLayer(affectedWidgetAttrsBySourceChange, newLayerDefModel, onNewLayerSaved, !oldNodeStyle);
            },
            error: function () {
              Notifier.addNotification({
                status: 'error',
                info: _t('notifications.layer.error'),
                closable: true
              });
            }
          });
          nodeDefModel.destroy(); // replaced by new node
        } else {
          // Node is the source of a prevLayer
          // Create a new layer which simply points to that source
          //   _______       _______   ______
          //  | A    |      | A    |  | B    |
          //  |      |      |      |  |      |
          //  | [A0] |  =>  | [A0] |  | [A0] |
          //  |______|      |______|  |______|

          // Keep the same style in the new layer
          oldNodeStyle = {
            options: {
              tile_style: prevLayer.get('cartocss'),
              sql_wrap: prevLayer.get('sql_wrap'),
              style_properties: prevLayer.get('style_properties')
            },
            infowindow: prevLayer.get('infowindow'),
            tooltip: prevLayer.get('tooltip')
          };
          tableName = prevLayer.get('table_name');
          tableNameAlias = prevLayer.get('table_name_alias');
          ownerName = prevLayer.get('user_name') || userModel.get('username');
          attrs = createDefaultCartoDBAttrs(oldNodeStyle);
          attrs.options = _.extend({}, attrs.options, {
            sql: 'SELECT * FROM ' + tableName,
            table_name: tableName,
            table_name_alias: tableNameAlias,
            letter: newLetter,
            color: layerColors.getColorForLetter(newLetter),
            source: nodeId
          });
          if (ownerName) {
            attrs.options.user_name = ownerName;
          }
          newLayerDefModel = layerDefinitionsCollection.create(attrs, {
            at: newPosition,
            success: function () {
              onNewLayerSaved(newLayerDefModel, false);
            },
            error: function () {
              Notifier.addNotification({
                status: 'error',
                info: _t('notifications.layer.error'),
                closable: true
              });
            }
          });
        }
      } else {
        // Node is NOT a head of a node, e.g. given nodeId is 'a2' this would create a new layer B which takes over the
        // ownership of the given node and its underlying nodes
        //   _______       _______   ______
        //  | A    |      | A    |  | B    |
        //  |      |      |      |  |      |
        //  | [A3] |      | [A3] |  | {B2} |
        //  | {A2} |  =>  | {B2} |  | [B1] |
        //  | [A1] |      |      |  | [B0] |
        //  | [A0] |      |      |  |      |
        //  |______|      |______|  |______|

        var linkedNodesList = nodeDefModel.linkedListBySameLetter();

        var moveNode = function (oldNode) {
          var newId = nodeIds.changeLetter(oldNode.id, newLetter);
          var newNode = oldNode.clone(newId);
          var affectedWidgetsBySourceChange = widgetDefinitionsCollection.where({ source: oldNode.id });

          analysisDefinitionNodesCollection.invoke('changeSourceIds', oldNode.id, newId);

          _.each(affectedWidgetsBySourceChange, function (m) {
            // Store attrs from affected widget for creating a new
            // instance when layer is created
            affectedWidgetAttrsBySourceChange.push(
              _.extend(
                _.omit(m.toJSON(), 'id', 'layer_id', 'source', 'order'),
                {
                  avoidNotification: true,
                  source: {
                    id: newId
                  }
                }
              )
            );

            // Destroy widgets pointing to that source until new layer is created
            m.attributes.avoidNotification = true;
            m.destroy();
          });

          return newNode;
        };
        var newLayerHeadNode = moveNode(linkedNodesList[0]);
        _.rest(linkedNodesList).forEach(moveNode);

        // Create the new layer (B). Copy the layer style from the dragged node.
        var ownerLayer = layerDefinitionsCollection.findOwnerOfAnalysisNode(nodeDefModel);
        oldNodeStyle = nodeDefModel.getStyleHistoryForLayer(ownerLayer.id);
        tableName = ownerLayer.get('table_name');
        tableNameAlias = ownerLayer.get('table_name_alias');
        ownerName = ownerLayer.get('user_name') || userModel.get('username');
        attrs = createDefaultCartoDBAttrs(oldNodeStyle);
        attrs.options = _.extend({}, attrs.options, {
          sql: 'SELECT * FROM ' + tableName,
          table_name: tableName,
          table_name_alias: tableNameAlias,
          letter: newLetter,
          color: layerColors.getColorForLetter(newLetter),
          source: newLayerHeadNode.id
        });
        if (ownerName) {
          attrs.options.user_name = ownerName;
        }

        // Tell the backend that this layer is a copy of the old one, and how to rename the analysis nodes.
        // This is used to keep the style_history valid in both the old a new layer
        attrs.from_layer_id = ownerLayer.get('id');
        attrs.from_letter = ownerLayer.get('letter');
        newLayerDefModel = layerDefinitionsCollection.create(attrs, {
          at: newPosition,
          success: function () {
            restoreWidgetsFromLayer(affectedWidgetAttrsBySourceChange, newLayerDefModel, onNewLayerSaved, !oldNodeStyle);
          },
          error: function () {
            Notifier.addNotification({
              status: 'error',
              info: _t('notifications.layer.error'),
              closable: true
            });
          }
        });

        analysisDefinitionsCollection.saveAnalysisForLayer(newLayerDefModel);
        nodeDefModel.destroy(); // replaced by new node
      }

      deleteOrphanedAnalyses();
    },

    moveLayer: function (d) {
      var from = d.from;
      var to = d.to;

      var movingLayer = layerDefinitionsCollection.at(from);
      layerDefinitionsCollection.remove(movingLayer, {silent: true});
      layerDefinitionsCollection.add(movingLayer, {at: to, parse: false, silent: true});

      var saveAnalysisPromises = layerDefinitionsCollection
        .chain()
        .map(function (layerDefModel) {
          var nodeDefModel = layerDefModel.getAnalysisDefinitionNodeModel();
          if (nodeDefModel) {
            return analysisDefinitionsCollection.saveAnalysisForLayer(layerDefModel);
          }
        })
        .compact()
        .value();

      $.when.apply($, saveAnalysisPromises).done(function () { // http://api.jquery.com/jQuery.when/
        layerDefinitionsCollection.save({
          success: function () {
            layerDefinitionsCollection.trigger('layerMoved', movingLayer, from, to);
          }
        });
      });
    },

    deleteLayer: function (id) {
      var layerToDelete = layerDefinitionsCollection.get(id);
      if (!layerToDelete.canBeDeletedByUser()) return;

      var parentLayer;
      var toDestroy = [];

      // Iterate over each node in the list, to decide how to remove dependent objects or fold nodes (if possible)
      // under another layer's linked nodes list.
      var linkedNodesList = layerToDelete.ownedPrimaryAnalysisNodes();
      var nodeDefModel;

      for (var i = 0; i < linkedNodesList.length; i++) {
        nodeDefModel = linkedNodesList[i];

        parentLayer = layerDefinitionsCollection.findPrimaryParentLayerToAnalysisNode(nodeDefModel, {exclude: toDestroy});

        // No parent layer? delete all dependent objects, since can't move current nodeDefModel elsewhere
        if (!parentLayer) {
          toDestroy.push(nodeDefModel);

          layerDefinitionsCollection.each(function (layer) {
            if (layer.containsNode(nodeDefModel)) {
              if (!_.contains(toDestroy, layer)) {
                toDestroy.push(layer);
              }

              widgetDefinitionsCollection.each(function (widget) {
                if (!_.contains(toDestroy, widget) && widget.containsNode(nodeDefModel)) {
                  toDestroy.unshift(widget);
                }
              });
            }
          });

          continue; // to process all sequent nodes in the linekd list, and their (possibly) dependent objects
        }

        var newParentLinkedNodesList = parentLayer
          .ownedPrimaryAnalysisNodes()
          .concat(nodeDefModel.linkedListBySameLetter());

        // Since will reassign ids from the start of list need to calculate which sequence id to start on
        var idSequence = newParentLinkedNodesList.length;
        var firstSequence = nodeIds.sequence(newParentLinkedNodesList[0].id);

        // If first node has a higher sequence start from that one to avoid issues on renaming nodes
        if (idSequence <= firstSequence) {
          idSequence = firstSequence;
        }

        var lastNode = _.last(newParentLinkedNodesList);
        if (lastNode.get('type') !== 'source') {
          idSequence++; // to start on right id sequence, so last item in newParentLinkedNodesList gets assigned x1 as id, since its source will be a none-source node belong to another layer
        }

        // Reassign ids one-by-one, from start of list to avoid ids overlapping (e.g. [c2,c1]+[b2,b1] = [c4,c3,c2,c1])
        var prevId = parentLayer.get('letter') + idSequence;
        var moveNodeToParentLayer = function (node) {
          var oldNodeId = node.id;
          var newId = nodeIds.prev(prevId);

          node.set('id', newId);

          // Update any depending objects' source
          analysisDefinitionNodesCollection.each(function (m) {
            if (!_.contains(toDestroy, m)) {
              m.changeSourceIds(oldNodeId, newId, true);
            }
          });
          var maybeUpdateSource = function (m) {
            if (m.get('source') === oldNodeId && !_.contains(toDestroy, m)) {
              m.save({ source: newId }, { silent: true });
            }
          };
          layerDefinitionsCollection.each(maybeUpdateSource);
          widgetDefinitionsCollection.each(maybeUpdateSource);

          prevId = newId;

          return node;
        };
        var newParentLayerNode = moveNodeToParentLayer(newParentLinkedNodesList[0]);
        _.rest(newParentLinkedNodesList).forEach(moveNodeToParentLayer);

        parentLayer.save({source: newParentLayerNode.id});

        break; // since the remaining nodes have been move to a parent layer
      }

      if (!_.contains(toDestroy, layerToDelete)) {
        toDestroy.push(layerToDelete);
      }

      var promise = $.when.apply($, // http://api.jquery.com/jQuery.when/
        _.chain(toDestroy)
          .reduce(function (memo, m) {
            memo.push(m);
            var layerDefModel = layerDefinitionsCollection.get(m.id);
            if (layerDefModel) { // Also delete analyses associated with layers that are being deleted
              var aDefModel = analysisDefinitionsCollection.findAnalysisForLayer(layerDefModel);
              if (aDefModel) {
                memo.push(aDefModel);
              }
            }

            return memo;
          }, [])
          .unique()
          .map(function (m) {
            m.set({avoidNotification: true}, {silent: true});
            return m.destroy();
          })
          .value());

      if (parentLayer) {
        analysisDefinitionsCollection.saveAnalysisForLayer(parentLayer);
      }
      deleteOrphanedAnalyses();

      return promise;
    },

    /**
     * E.g. for styles, infowindows etc.
     * @param {object} layerDefModel - layer-definition-model
     * @param {object} options
     */
    saveLayer: function (layerDefModel, options) {
      if (!layerDefModel) throw new Error('layerDefModel is required');

      if (layerDefModel.isDataLayer()) {
        analysisDefinitionsCollection.saveAnalysisForLayer(layerDefModel);
      }

      deleteOrphanedAnalyses();

      var saveDefaultOptions = {
        shouldPreserveAutoStyle: false
      };
      options = _.extend({}, saveDefaultOptions, options);

      return layerDefModel.save(null, options);
    }

  };
};

},{"../components/metrics/metrics-tracker":233,"../components/notifier/notifier":475,"../editor/style/style-defaults/simple-style-defaults":1022,"../helpers/reset-style-per-node":1098,"../value-objects/analysis-node-ids":1119,"./camshaft-reference":615,"./layer-colors":633,"./layer-types-and-kinds":637,"jquery":"jquery","underscore":"underscore"}],670:[function(require,module,exports){
var Backbone = require('backbone');
var GroupModel = require('./group-model');

/**
 * Collection of a User's groups.
 */
module.exports = Backbone.Collection.extend({
  model: GroupModel,

  initialize: function (models, opts) {
    this.organization = opts.organization;
  }
});

},{"./group-model":629,"backbone":"backbone"}],671:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var OrganizationModel = require('./organization-model');
var UserGroups = require('./user-groups-collection');
var CustomBaselayersCollection = require('./custom-baselayers-collection');

/**
 *  User model
 *
 */

var UserModel = Backbone.Model.extend({
  urlRoot: function () {
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/v1/users';
  },

  defaults: {
    avatar_url: 'http://cartodb.s3.amazonaws.com/static/public_dashboard_default_avatar.png',
    username: '',
    email: ''
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    this._configModel = opts.configModel;
    attrs = attrs || {};

    if (!_.isEmpty(this.get('organization'))) {
      this._organizationModel = new OrganizationModel(
        this.get('organization'),
        {
          configModel: this._configModel,
          currentUserId: this.id
        }
      );
    }

    if (this.get('layers')) {
      this.layers = new CustomBaselayersCollection(this.get('layers'), {
        configModel: this._configModel,
        currentUserId: this.id
      });
    }

    this.groups = new UserGroups(attrs.groups, {
      organization: this._organizationModel
    });
  },

  isViewer: function () {
    return this.get('viewer') === true;
  },

  isBuilder: function () {
    return !this.isViewer();
  },

  canCreateDatasets: function () {
    if (!this.get('remaining_byte_quota') || this.get('remaining_byte_quota') <= 0) {
      return false;
    }
    return true;
  },

  hasCreateMapsFeature: function () {
    return this.isBuilder();
  },

  canCreateTwitterDataset: function () {
    return !((this.get('twitter').quota - this.get('twitter').monthly_use) <= 0 && this.get('twitter').hard_limit);
  },

  canStartTrial: function () {
    return !this.isInsideOrg() && this.get('account_type') === 'FREE' && this.get('table_count') > 0;
  },

  isActionEnabled: function (action) {
    return this.get('actions') && this.get('actions')[action];
  },

  canCreatePrivateDatasets: function () {
    var actions = this.get('actions');
    return actions && actions.private_tables;
  },

  isInsideOrg: function () {
    if (this._organizationModel) {
      return !!this._organizationModel.id || this.isOrgOwner();
    }
    return false;
  },

  isOrgOwner: function () {
    if (this._organizationModel) {
      return this._organizationModel.getOwnerId() === this.get('id');
    }
    return false;
  },

  isOrgAdmin: function () {
    if (this._organizationModel) {
      return this._organizationModel.isOrgAdmin(this);
    }
    return false;
  },

  featureEnabled: function (name) {
    var featureFlags = this.get('feature_flags');
    if (!featureFlags || featureFlags.length === 0 || !name) {
      return false;
    }
    return _.contains(featureFlags, name);
  },

  upgradeContactEmail: function () {
    if (this.isInsideOrg()) {
      if (this.isOrgOwner()) {
        return 'enterprise-support@carto.com';
      } else {
        return this._organizationModel.getOwnerEmail();
      }
    } else {
      return 'support@carto.com';
    }
  },

  nameOrUsername: function () {
    return this.get('name') || this.get('username');
  },

  getMaxConcurrentImports: function () {
    return (this.get('limits') && this.get('limits').concurrent_imports) || 1;
  },

  getSchemaName: function () {
    return this.isInsideOrg() ? this.get('username') : 'public';
  },

  renderData: function (currentUser) {
    var name = this.get('username');
    if (currentUser && currentUser.id === this.id) {
      name = _t('user.you');
    }
    return {
      username: name,
      avatar_url: this.get('avatar_url')
    };
  },

  clone: function () {
    var attrs = _.clone(this.attributes);
    delete attrs.id;
    return new UserModel(attrs, {
      configModel: this._configModel
    });
  },

  getOrganization: function () {
    return this._organizationModel;
  }
});

module.exports = UserModel;

},{"./custom-baselayers-collection":620,"./organization-model":651,"./user-groups-collection":670,"backbone":"backbone","underscore":"underscore"}],672:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');

/**
 *  User Notifications
 *
 */

var UserNotifications = Backbone.Model.extend({
  sync: function (method, model, options) {
    return Backbone.sync('update', model, options);
  },

  url: function () {
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/v3/notifications/' + this.get('key');
  },

  initialize: function (attrs, opts) {
    if (!opts.key) throw new Error('key is required');
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;
    this.attributes = _.extend({ notifications: attrs }, { key: opts.key });
  },

  getKey: function (key) {
    var notifications = this.get('notifications') || {};
    return notifications[key];
  },

  setKey: function (key, value) {
    var notifications = this.get('notifications') || {};
    notifications[key] = value;
    this.set('notifications', notifications);
  }
});

module.exports = UserNotifications;

},{"backbone":"backbone","underscore":"underscore"}],673:[function(require,module,exports){
var Backbone = require('backbone');
var syncAbort = require('./backbone/sync-abort');

/**
 * A collection representing a set of users in a group.
 */
module.exports = Backbone.Collection.extend({

  sync: syncAbort,

  initialize: function (models, opts) {
    if (!opts.group) throw new Error('group is required');
    this.group = opts.group;
    this.configModel = opts.configModel;
    this.organization = opts.organization;
  },

  url: function (method) {
    var baseUrl = this.configModel.get('base_url');
    var version = this.configModel.urlVersion('organizationGroups', method);
    return baseUrl + '/api/' + version + '/organization/' + this.organization.id + '/groups/' + this.group.id + '/users';
  },

  parse: function (response) {
    this.total_entries = response.total_entries;
    this.total_user_entries = response.total_user_entries;

    return response.users;
  },

  totalCount: function () {
    return this.total_user_entries;
  }

});

},{"./backbone/sync-abort":607,"backbone":"backbone"}],674:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var UsersGroup = require('./users-group-collection');

// This module fetch the user for every group present
// in the ACL permission collection. The vizjson doesn't
// provide and we need it for the sharing stats in the header.

module.exports = {
  track: function (opts) {
    this.acl = opts.acl;
    this.configModel = opts.configModel;
    this.userModel = opts.userModel;

    this.acl.on('reset', this.fetchUsers, this);
    this.fetchUsers();
  },

  fetchUsers: function () {
    var self = this;
    var promises = [];

    promises = _.map(this.acl.where({type: 'group'}), function (group) {
      var entity = group.get('entity');
      var deferred = new $.Deferred();

      if (!entity.users || entity.users.length === 0) {
        entity.users = new UsersGroup([], {
          group: entity,
          configModel: self.configModel,
          organization: self.userModel.getOrganization()
        });

        entity.users.fetch({
          success: function () {
            deferred.resolve();
          }
        });
      } else {
        deferred.resolve();
      }

      return deferred.promise();
    }, this);

    $.when.apply($, promises).done(function () {
      self.acl.trigger('fetch');
    });
  }
};

},{"./users-group-collection":673,"jquery":"jquery","underscore":"underscore"}],675:[function(require,module,exports){
var Backbone = require('backbone');
var PermissionModel = require('./permission-model');

/**
 * Model that represents a visualization (v3)
 *
 * Even though a table might be represented as a Visualization in some cases, please use TableModel if you want to work
 * with the table data instead of adding table-specific methods here.
 */

var PRIVACY_OPTIONS = ['PUBLIC', 'LINK', 'PRIVATE', 'PASSWORD'];

module.exports = Backbone.Model.extend({
  defaults: {
    visChanges: 0
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;

    if (this.get('permission')) {
      this._permissionModel = new PermissionModel(this.get('permission'), {
        configModel: opts.configModel
      });
      this.unset('permission');
    }
  },

  urlRoot: function () {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('visualization');
    return baseUrl + '/api/' + version + '/viz';
  },

  mapcapsURL: function () {
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/v3/viz/' + this.id + '/mapcaps';
  },

  embedURL: function () {
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/builder/' + this.id + '/embed';
  },

  builderURL: function () {
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/builder/' + this.id + '/';
  },

  vizjsonURL: function () {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('vizjson', 'read', 'v3');
    return baseUrl + '/api/' + version + '/viz/' + this.id + '/viz.json';
  },

  stateURL: function () {
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/v3/viz/' + this.id + '/state';
  },

  isVisualization: function () {
    return this.get('type') === 'derived';
  },

  privacyOptions: function () {
    return PRIVACY_OPTIONS;
  },

  recordChange: function () {
    var visChanges = this.get('visChanges');
    this.set('visChanges', visChanges + 1);
  },

  resetChanges: function () {
    this.set('visChanges', 0);
  },

  getPermissionModel: function () {
    return this._permissionModel;
  }
});

},{"./permission-model":653,"backbone":"backbone"}],676:[function(require,module,exports){
var Backbone = require('backbone');

/**
 *  Edit vis metadata dialog model
 *  to control if name and metadata
 *  are editable or not.
 *
 */

module.exports = Backbone.Model.extend({

  defaults: {
    name: ''
  },

  validate: function (attrs) {
    if (!attrs) return;
    if (!attrs.name) {
      return _t('components.modals.maps-metadata.validation.error.name');
    }
  }
});

},{"backbone":"backbone"}],677:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var TableModel = require('./table-model');
var PermissionModel = require('./permission-model');
var SynchronizationModel = require('./synchronization-model');
var LikesModel = require('../components/likes/likes-model');

/**
 * Model that represents a table visualization (v3)
 *
 */

var PRIVACY_OPTIONS = ['PUBLIC', 'LINK', 'PRIVATE'];

module.exports = Backbone.Model.extend({

  urlRoot: function () {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('visualization');
    return baseUrl + '/api/' + version + '/viz';
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    this._configModel = opts.configModel;

    this._initModels();
  },

  _initModels: function () {
    var d = this.get('table');
    if (!_.isEmpty(this.get('external_source'))) {
      d = this.get('external_source');
    }
    this._tableModel = new TableModel(d, {
      configModel: this._configModel,
      parse: true
    });

    if (this.get('permission')) {
      this._permissionModel = new PermissionModel(this.get('permission'), {
        configModel: this._configModel
      });
      this.unset('permission');
    }

    this._likesModel = LikesModel.newByVisData({
      vis_id: this.id,
      liked: this.get('liked'),
      likes: this.get('likes'),
      configModel: this._configModel
    });

    if (this.get('synchronization')) {
      this._synchronizationModel = new SynchronizationModel(this.get('synchronization'), {
        configModel: this._configModel
      });
      this._synchronizationModel.linkToTable(this._tableModel);
    }
  },

  isVisualization: function () {
    return false;
  },

  getTableModel: function () {
    return this._tableModel;
  },

  getLikesModel: function () {
    return this._likesModel;
  },

  getPermissionModel: function () {
    return this._permissionModel;
  },

  getSynchronizationModel: function () {
    return this._synchronizationModel;
  },

  vizjsonURL: function () {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('vizjson', 'read', 'v3');
    return baseUrl + '/api/' + version + '/viz/' + this.id + '/viz.json';
  },

  isRaster: function () {
    return this.get('kind') === 'raster';
  },

  datasetURL: function () {
    var baseUrl = this._configModel.get('base_url');
    var tableName = this.getTableModel().getUnquotedName();
    return baseUrl + '/dataset/' + tableName;
  },

  privacyOptions: function () {
    return PRIVACY_OPTIONS;
  },

  toJSON: function () {
    return _.omit(this.attributes, 'synchronization', 'stats', 'table');
  }
});

},{"../components/likes/likes-model":224,"./permission-model":653,"./synchronization-model":663,"./table-model":665,"backbone":"backbone","underscore":"underscore"}],678:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var VisualizationTableModel = require('./visualization-table-model');
var VisualizationModel = require('./vis-definition-model');

/**
 * A collection that holds visualization models
 */
module.exports = Backbone.Collection.extend({

  DEFAULT_FETCH_OPTIONS: {
    type: 'table',
    order: 'updated_at',
    page: 1,
    per_page: 20,
    exclude_shared: false,
    exclude_raster: true,
    tags: '',
    q: ''
  },

  model: function (d, opts) {
    var configModel = opts.collection._configModel;
    var Klass;

    if (d.type !== 'derived') {
      Klass = VisualizationTableModel;
    } else {
      Klass = VisualizationModel;
    }

    return new Klass(d, {
      configModel: configModel
    });
  },

  initialize: function (models, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    this._configModel = opts.configModel;

    // this.DEFAULT_FETCH_OPTIONS = _.extendOwn(this.DEFAULT_FETCH_OPTIONS, opts);
    this._stats = {};
  },

  url: function () {
    var version = this._configModel.urlVersion('visualization');
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/' + version + '/viz';
  },

  // Overrides the default fetch, to use the internal methods to construct parmas
  fetch: function (opts) {
    this.trigger('loading', this);
    opts = opts || {
      data: {
        // If reaches this code path it's because there were no opts given, i.e. should do a 'full fetch'
        // Since there is no current way to really do a full fetch let's just set a really high number to get all…
        // TODO this is obviously bad for organization users, how can we do this differently
        per_page: 1000
      }
    };
    opts.data = _.extend({}, this.DEFAULT_FETCH_OPTIONS, opts.data);
    return Backbone.Collection.prototype.fetch.call(this, opts);
  },

  getDefaultParam: function (param) {
    return this.DEFAULT_FETCH_OPTIONS[param];
  },

  getTotalStat: function (attribute) {
    return this._stats[attribute] || 0;
  },

  parse: function (res) {
    this._stats = _.omit(res, 'visualizations');
    return res.visualizations;
  }
});

},{"./vis-definition-model":675,"./visualization-table-model":677,"backbone":"backbone","underscore":"underscore"}],679:[function(require,module,exports){
var Backbone = require('backbone');

/**
 * Model that encapsulates params for fetching data in a cdb.admin.Visualizations collection.
 */
module.exports = Backbone.Model.extend({
  defaults: {
    content_type: '',
    page: 1,
    q: '',
    tag: '',
    category: '',
    shared: 'no',
    locked: false,
    liked: false,
    library: false,
    order: 'updated_at',
    deepInsights: false
  },

  isSearching: function () {
    return this.get('q') || this.get('tag');
  },

  isDatasets: function () {
    return this.get('content_type') === 'datasets';
  },

  isMaps: function () {
    return this.get('content_type') === 'maps';
  },

  isDeepInsights: function () {
    return this.isMaps() && this.get('deepInsights');
  }
});

},{"backbone":"backbone"}],680:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var syncAbort = require('./backbone/sync-abort');
var CartoColor = require('cartocolor');

var ATTRS_AT_TOP_LEVEL = ['id', 'layer_id', 'source', 'title', 'type', 'order'];
var STYLE_PROPERTIES = ['widget_style_definition', 'auto_style_definition', 'auto_style_allowed'];

var DEFAULT_WIDGET_COLOR = '#9DE0AD';
var TIME_SERIES_WIDGET_COLOR = '#F2CC8F';
var DEFAULT_WIDGET_STYLE = {
  color: {
    fixed: DEFAULT_WIDGET_COLOR,
    opacity: 1
  }
};

var getDefaultCategoriesByRange = function (range) {
  var widgetDomain = [];
  for (var i = 0, l = range.length; i < l; i++) {
    widgetDomain.push(_t('form-components.editors.fill.quantification.methods.category') + ' #' + (i + 1));
  }
  return widgetDomain;
};

/**
 * Widget definition Model
 */
module.exports = Backbone.Model.extend({
  defaults: {
    sync_on_data_change: true,
    sync_on_bbox_change: true,
    auto_style_allowed: true,
    widget_style_definition: DEFAULT_WIDGET_STYLE
  },

  /**
   * @override {Backbone.prototype.sync} abort ongoing request if there is any
   */
  sync: syncAbort,

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.mapId) throw new Error('mapId is required');

    this._configModel = opts.configModel;
    this._mapId = opts.mapId;
  },

  urlRoot: function () {
    // Since widget are stored under layers the collection can't figure out the URL by itself,
    // thus each widget sets its own urlRoot
    var baseUrl = this._configModel.get('base_url');
    var layerId = this.get('layer_id');
    return baseUrl + '/api/v3/maps/' + this._mapId + '/layers/' + layerId + '/widgets';
  },

  /**
   * The API response format is a little bit different, and may
   * @param {Object} r API response
   * @return {Object} attrs to be set on model
   */
  parse: function (r) {
    var attrs = _.defaults(
      _.pick(r, ATTRS_AT_TOP_LEVEL),
      r.options
    );

    if (!_.isEmpty(r.style)) {
      var style = JSON.parse(JSON.stringify(r.style));
      if (style.auto_style) {
        var autoStyle = style.auto_style;
        var autoStyleDefinition = autoStyle.definition;
        if (autoStyleDefinition && autoStyleDefinition.color && autoStyleDefinition.color.quantification === 'category') {
          autoStyle.definition.color.domain = getDefaultCategoriesByRange(autoStyleDefinition.color.range);
        }
        attrs.auto_style_definition = autoStyle.definition;
        attrs.auto_style_allowed = autoStyle.allowed;
      }
      attrs.widget_style_definition = r.style.widget_style.definition;
    }

    attrs.source = attrs.source && attrs.source.id;

    return attrs;
  },

  /**
   * @override Backbone.Model.prototype.toJSON
   * Formats the JSON to match the server-side API
   */
  toJSON: function () {
    var o = _.pick(this.attributes, ATTRS_AT_TOP_LEVEL);
    o.source = {id: this.get('source')};
    o.options = _.omit(this.attributes, ATTRS_AT_TOP_LEVEL, STYLE_PROPERTIES);

    if (this.get('widget_style_definition')) {
      o.style = {
        widget_style: {
          definition: this.get('widget_style_definition')
        }
      };

      o.style.auto_style = {
        custom: !!this.get('auto_style_definition'),
        allowed: this.get('auto_style_allowed')
      };

      if (this.get('auto_style_definition')) {
        var autoStyleDefinition = JSON.parse(JSON.stringify(this.get('auto_style_definition')));
        autoStyleDefinition.color = _.omit(autoStyleDefinition.color, 'domain', 'bins');
        o.style.auto_style.definition = autoStyleDefinition;
      }
    }

    return o;
  },

  changeType: function (type) {
    var attrsForNewType = _
      .defaults(
        { type: type },
        this.collection.attrsForThisType(type, this)
    );

    // Unset now irrelevant attributes due to the type change
    _
      .chain(this.attributes)
      .keys()
      .difference(
        ['sync_on_data_change', 'sync_on_bbox_change'].concat(ATTRS_AT_TOP_LEVEL, STYLE_PROPERTIES),
        _.keys(attrsForNewType)
    )
      .each(function (key) {
        this.unset(key, { silent: true });
      }, this);

    this.set(attrsForNewType);
  },

  containsNode: function (otherNodeDefModel) {
    if (!otherNodeDefModel) return false;

    var sourceId = this.get('source');
    var nodeDefModel = otherNodeDefModel.collection.get(sourceId);

    return !!(sourceId === otherNodeDefModel.id ||
    nodeDefModel && nodeDefModel.containsNode(otherNodeDefModel));
  }

}, {

  getDefaultWidgetStyle: function (type) {
    var widgetColor = type === 'time-series' ? TIME_SERIES_WIDGET_COLOR : DEFAULT_WIDGET_COLOR;
    var defaultWidgetStyle = DEFAULT_WIDGET_STYLE;
    defaultWidgetStyle.color.fixed = widgetColor;
    return defaultWidgetStyle;
  },

  getDefaultAutoStyle: function (type, columnName) {
    var defaultWidgetCategories = 10;
    var defaultWidgetRampSize = 7;
    var widgetRamp = _.first(
      _.compact(
        _.map(CartoColor, function (ramp) {
          return _.clone(ramp[defaultWidgetRampSize]);
        }, this)
      )
    );
    var widgetCategories = _.clone(CartoColor.Prism[defaultWidgetCategories]);
    var widgetRange = type === 'category' ? widgetCategories : widgetRamp;
    var widgetQuantification = type === 'category' ? 'category' : 'quantiles';

    var attrs = {
      color: {
        attribute: columnName,
        quantification: widgetQuantification,
        range: widgetRange
      }
    };

    if (type === 'category') {
      attrs.color.domain = getDefaultCategoriesByRange(widgetCategories);
    } else {
      attrs.color.bins = type === 'time-series' ? 256 : defaultWidgetRampSize;
    }

    return attrs;
  }
});

},{"./backbone/sync-abort":607,"backbone":"backbone","cartocolor":"cartocolor","underscore":"underscore"}],681:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var WidgetDefinitionModel = require('./widget-definition-model');

/**
 * Collection of widget definitions, synhronizes the internal definitions and the widget models.
 */
module.exports = Backbone.Collection.extend({
  comparator: 'order',

  model: function (d, opts) {
    var self = opts.collection;
    d.order = !_.isUndefined(d.order) ? d.order : self._getNextOrder();
    var m = new WidgetDefinitionModel(d, {
      parse: true, // make sure data is structured as expected
      collection: self,
      configModel: self._configModel,
      mapId: self._mapId
    });
    return m;
  },

  initialize: function (models, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.mapId) throw new Error('mapId is required');
    if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');

    this._configModel = opts.configModel;
    this._mapId = opts.mapId;
    this._layerDefinitionsCollection = opts.layerDefinitionsCollection;

    this._bindLayerStyleChanges();

    this._attrsForThisTypeMap = {
      formula: function (m) {
        return {
          column: m.get('column'),
          operation: m.get('operation') || 'max'
        };
      },
      category: function (m) {
        var columnName = m.get('column');
        return {
          aggregation: m.get('aggregation') || 'count',
          aggregation_column: m.get('aggregation_column') || columnName,
          column: columnName,
          widget_style_definition: m.get('widget_style_definition') || WidgetDefinitionModel.getDefaultWidgetStyle('category'),
          auto_style_definition: undefined
        };
      },
      histogram: function (m) {
        return {
          column: m.get('column'),
          bins: m.get('bins') || 10,
          widget_style_definition: m.get('widget_style_definition') || WidgetDefinitionModel.getDefaultWidgetStyle('histogram'),
          auto_style_definition: undefined
        };
      },
      'time-series': function (m) {
        return {
          column: m.get('column'),
          bins: m.get('bins') || 256,
          widget_style_definition: m.get('widget_style_definition') || WidgetDefinitionModel.getDefaultWidgetStyle('time-series')
        };
      }
    };
  },

  url: function () {
    throw new Error('Not possible, see WidgetDefinitionModel.urlRoot');
  },

  _bindLayerStyleChanges: function () {
    this._layerDefinitionsCollection.bind('change:style_properties', this._onLayerStyleChanged, this);
  },

  _onLayerStyleChanged: function (layerDefModel) {
    var styleModel = layerDefModel.styleModel;
    var isAllowed = styleModel && styleModel.canApplyAutoStyle();
    var affectedWidgets = this.where({ layer_id: layerDefModel.id });

    _.each(affectedWidgets, function (widgetDefModel) {
      var isNowAllowed = widgetDefModel.get('auto_style_allowed');
      var willBeAllowed = isAllowed;
      var attrs = {
        auto_style_allowed: willBeAllowed
      };

      if (isNowAllowed !== willBeAllowed) {
        // if autostyle is not allow, we should clean auto_style_definition
        if (willBeAllowed === false) {
          attrs = _.extend(attrs, { auto_style_definition: '' });
        }
        widgetDefModel.save(attrs);
      }
    });
  },

  attrsForThisType: function (newType, m) {
    return this._attrsForThisTypeMap[newType](m);
  },

  isThereTimeSeries: function (opts) {
    opts = opts || {};

    var timeSeries = opts.animated ? this.findWhere({ type: 'time-series', animated: opts.animated }) : this.findWhere({ type: 'time-series' });
    return !!timeSeries;
  },

  isThereOtherWidgets: function () {
    return !!this.find(function (widgetModel) {
      return widgetModel.get('type') !== 'time-series';
    });
  },

  _getNextOrder: function () {
    if (this.isEmpty()) {
      return 0;
    } else {
      var lastItemByOrder = this.max(function (mdl) {
        return mdl.get('order');
      });
      return lastItemByOrder.get('order') + 1;
    }
  },

  widgetsOwnedByLayer: function (layerId) {
    var widgets = this.where({ layer_id: layerId });

    return widgets.length;
  }

});

},{"./widget-definition-model":680,"backbone":"backbone","underscore":"underscore"}],682:[function(require,module,exports){
var _ = require('underscore');

var PROXY_URL = 'https://cartodb-wms.global.ssl.fastly.net/api';
var PROXY_TILES = 'https://cartodb-wms.global.ssl.fastly.net/mapproxy';
var METHOD_TO_URL = {
  'read': '/check',
  'create': '/add'
};
var SUPPORTED_MATRIX_SETS = [
  'EPSG:4326',
  'EPSG:4258'
];

function WMSService () {
  this._wms_url = null;
}

WMSService.prototype.generateURL = function (opts) {
  var req = PROXY_URL + METHOD_TO_URL[opts.method];
  var url = this._wms_url;

  var parser = document.createElement('a');

  parser.href = url;

  var params = parser.search.substr(1).split('&');

  var hasCapabilities = _.find(params, function (p) { return p.toLowerCase().indexOf('request=getcapabilities') !== -1; });
  var hasService = _.find(params, function (p) { return p.toLowerCase().indexOf('service=wms') !== -1; });

  // If the user didn't provided the necessary params, let's add them

  if (!hasCapabilities) {
    params.push('request=GetCapabilities');
  }

  if (!hasService) {
    params.push('service=WMS');
  }

  url += '?' + params.join('&');
  req += '?url=' + encodeURIComponent(url);

  var isWMTS = opts.type === 'wmts';
  req += '&type=' + (isWMTS ? 'wmts' : 'wms');

  if (opts.method === 'create') {
    if (opts.layer && opts.srs) {
      req += '&layer=' + opts.layer;
      req += '&srs=EPSG:' + opts.srs[0].split(':')[1];
    } else if (isWMTS && opts.layer && opts.matrix_sets.length > 0) {
      req += '&layer=' + opts.layer;
      req += '&matrix_set=' + this.supportedMatrixSets(opts.matrix_sets || [])[0];
    }
  }

  return req;
};

WMSService.prototype.getFetchLayersURL = function () {
  return this.generateURL({
    method: 'read'
  });
};

WMSService.prototype.saveLayerURL = function (opts) {
  var createOpts = _.extend({
    method: 'create'
  }, opts);

  return this.generateURL(createOpts);
};

WMSService.prototype.supportedMatrixSets = function (matrixSets) {
  return _.intersection(matrixSets, SUPPORTED_MATRIX_SETS);
};

WMSService.prototype.getProxyTilesURL = function () {
  return PROXY_TILES;
};

WMSService.prototype.setUrl = function (url) {
  this._wms_url = url;
};

module.exports = WMSService;

},{"underscore":"underscore"}],683:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var ConfirmationView = require('../components/modals/confirmation/modal-confirmation-view');
var templateConfirmation = require('./start-edition-confirmation.tpl');
var templateEditGeometry = require('./edit-geometry.tpl');
var TipsyTooltipView = require('../components/tipsy-tooltip-view');
var Notifier = require('../components/notifier/notifier');

var EditFeatureOverlay = CoreView.extend({

  MAX_VERTEXES: 1000,

  className: 'CDB-Overlay',
  type: 'custom',

  events: {
    'click .js-edit-feature': '_onEditButtonClicked'
  },

  initialize: function (options) {
    if (!options.map) throw new Error('map is required');
    if (!options.mapModeModel) throw new Error('mapModeModel is required');
    if (!options.modals) throw new Error('modals is required');

    this._map = options.map;
    this._mapModeModel = options.mapModeModel;
    this._modals = options.modals;

    this._onEditButtonClicked = this._onEditButtonClicked.bind(this);
    this.hide = this.hide.bind(this);
    this.show = this.show.bind(this);

    this._map.on('change:center', this.hide, this);
    this._map.on('change:zoom', this.hide, this);

    this._position = {
      x: 0,
      y: 0
    };
  },

  render: function () {
    this.clearSubViews();

    var isEditable = this._isEditable();

    this.$el.html(templateEditGeometry({
      isEditable: isEditable,
      hasAnalyses: this._hasAnalyses(),
      isCustomQueryApplied: this._isCustomQueryApplied(),
      isReadOnly: this._isReadOnly(),
      disabled: this._disabledTooltip()
    }));

    if (!isEditable) {
      var tooltip = new TipsyTooltipView({
        el: this.$('.js-edit-feature'),
        gravity: 's',
        offset: 0,
        title: function () {
          return $(this).data('tooltip');
        }
      });
      this.addView(tooltip);
      this.undelegateEvents();
    } else {
      this.delegateEvents();
    }

    return this;
  },

  _disabledTooltip: function () {
    var disabledLayerType;

    if (this._hasAnalyses()) {
      disabledLayerType = _t('editor.edit-feature.analysis');
    } else if (this._isCustomQueryApplied()) {
      disabledLayerType = _t('editor.edit-feature.custom-sql');
    } else if (this._isReadOnly()) {
      disabledLayerType = _t('editor.edit-feature.sync');
    }

    return _t('editor.edit-feature.disabled', { disabledLayerType: disabledLayerType });
  },

  _isEditable: function () {
    return this._featureDefinition && this._featureDefinition.isEditable();
  },

  _hasAnalyses: function () {
    return this._featureDefinition && this._featureDefinition.hasAnalyses();
  },

  _isCustomQueryApplied: function () {
    return this._featureDefinition && this._featureDefinition.isCustomQueryApplied();
  },

  _isReadOnly: function () {
    return this._featureDefinition && this._featureDefinition.isReadOnly();
  },

  hide: function (event) {
    this.killEvent(event);
    this.$el.hide();
    $(document).off('click', this.hide);
  },

  show: function () {
    this.$el.css({
      width: '20px',
      top: this._position.y,
      left: this._position.x,
      position: 'absolute'
    });
    this.$el.show();

    $(document).on('click', this.hide);
  },

  setPosition: function (position) {
    this._position = position;
  },

  setFeatureDefinition: function (featureDefinition) {
    this._featureDefinition = featureDefinition;
  },

  getFeatureDefinition: function () {
    return this._featureDefinition;
  },

  _getGeomCount: function (geojson) {
    var count = 0;

    _.each(geojson.coordinates, function (pol1, i) {
      _.each(pol1, function (pol2, j) {
        count = count + pol2.length;
      });
    });

    return count;
  },

  _confirmStopEdition: function () {
    var self = this;

    this._modals.create(function (modalModel) {
      return new ConfirmationView({
        modalModel: modalModel,
        template: templateConfirmation,
        runAction: self._startEdition.bind(self)
      });
    });
  },

  _startEdition: function () {
    // Exit editing feature mode to re-enter this mode again
    if (this._mapModeModel.isEditingFeatureMode()) {
      this._mapModeModel.enterViewingMode();
    }
    this._mapModeModel.enterEditingFeatureMode(this._featureDefinition);
  },

  _onEditButtonClicked: function (ev) {
    this.killEvent(ev);
    this.hide();

    if (!this._isEditable()) {
      return false;
    }

    var notification = Notifier.addNotification({
      status: 'loading',
      info: _t('notifications.edit-feature.edit.loading'),
      closable: false
    });

    this._featureDefinition && this._featureDefinition.fetch({
      success: function () {
        Notifier.removeNotification(notification);

        var geojson = JSON.parse(this._featureDefinition.get('the_geom'));

        if (this._getGeomCount(geojson) > this.MAX_VERTEXES) {
          this._confirmStopEdition();
        } else {
          this._startEdition();
        }
      }.bind(this),
      error: function () {
        notification.set({
          status: 'error',
          info: _t('notifications.edit-feature.edit.error'),
          closable: true,
          delay: Notifier.DEFAULT_DELAY
        });
      }
    });
  }
});

module.exports = EditFeatureOverlay;

},{"../components/modals/confirmation/modal-confirmation-view":404,"../components/notifier/notifier":475,"../components/tipsy-tooltip-view":589,"./edit-geometry.tpl":684,"./start-edition-confirmation.tpl":688,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],684:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button class="CDB-Attribution-button js-edit-feature\n  ';
 if (!isEditable) { 
__p+='is-disabled';
 } 
__p+='\n  ';
 if (hasAnalyses) { 
__p+='t-hasAnalyses';
 } 
__p+='\n  ';
 if (isCustomQueryApplied) { 
__p+='t-isCustomQueryApplied';
 } 
__p+='\n  ';
 if (isReadOnly) { 
__p+='t-isReadOnly';
 } 
__p+='" data-tooltip="'+
((__t=( disabled ))==null?'':_.escape(__t))+
'">\n  <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><path d="M10 22.91l1.217-3.65 8.924-8.924c.448-.448 1.177-.448 1.624 0l.81.81c.448.448.448 1.175 0 1.623l-8.923 8.924L10 22.91zm10.952-8.518l-2.434-2.434 2.434 2.434zm-7.3 7.302l-2.435-2.434 2.434 2.434z" stroke="#636D72" fill="none" fill-rule="evenodd"/></svg>\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],685:[function(require,module,exports){
var _ = require('underscore');
var LegendFactory = require('../editor/layers/layer-content-views/legend/legend-factory');
var LegendColorHelper = require('../editor/layers/layer-content-views/legend/form/legend-color-helper');
var DEFAULT_BUBBLES_COLOR = '#999999';

var onChange = function (layerDefModel) {
  var styleModel = layerDefModel.styleModel;
  var autoStyle = layerDefModel.get('autoStyle');
  var isAutoStyleApplied = autoStyle != null && autoStyle !== false;
  var fill;
  var stroke;
  var color;
  var size;

  function createColorLegend (layerDefModel, color) {
    var styleModel = layerDefModel.styleModel;

    if (styleModel.get('type') === 'animation') {
      LegendFactory.removeLegend(layerDefModel, 'choropleth', function () {
        LegendFactory.removeLegend(layerDefModel, 'custom_choropleth', function () {
          LegendFactory.createLegend(layerDefModel, 'category', {title: color.attribute});
        });
      });
    } else if (styleModel.get('type') === 'heatmap') {
      LegendFactory.removeLegend(layerDefModel, 'category', function () {
        LegendFactory.removeLegend(layerDefModel, 'choropleth', function () {
          LegendFactory.createLegend(layerDefModel, 'custom_choropleth', {title: _t('editor.legend.pixel-title')});
        });
      });
    } else {
      if ((color.attribute_type && color.attribute_type === 'string') || color.quantification === 'category') {
        LegendFactory.removeLegend(layerDefModel, 'choropleth', function () {
          LegendFactory.removeLegend(layerDefModel, 'custom_choropleth', function () {
            if (!isAutoStyleApplied) {
              LegendFactory.createLegend(layerDefModel, 'category', {title: color.attribute});
            } else {
              LegendFactory.removeLegend(layerDefModel, 'category');
            }
          });
        });
      } else {
        LegendFactory.removeLegend(layerDefModel, 'category', function () {
          LegendFactory.removeLegend(layerDefModel, 'custom_choropleth', function () {
            if (!isAutoStyleApplied) {
              LegendFactory.createLegend(layerDefModel, 'choropleth', {title: color.attribute});
            } else {
              LegendFactory.removeLegend(layerDefModel, 'choropleth');
            }
          });
        });
      }
    }
  }

  if (!styleModel) return;

  fill = styleModel.get('fill');
  stroke = styleModel.get('stroke');

  if (!fill && !stroke || _.isEmpty(fill) && _.isEmpty(stroke)) return;

  color = fill && fill.color || stroke && stroke.color;
  size = fill && fill.size || stroke && stroke.size;

  if (LegendFactory.isEnabledType('size')) {
    if (size && size.attribute !== undefined) {
      var attrs = { title: size.attribute };

      if (!isAutoStyleApplied) {
        // Do not apply the fill color of an autostyle ramp
        attrs.fillColor = color && (color.fixed || color.range)
          ? LegendColorHelper.getBubbles(color).color.fixed
          : DEFAULT_BUBBLES_COLOR;
      }

      LegendFactory.createLegend(layerDefModel, 'bubble', attrs);
    } else {
      LegendFactory.removeLegend(layerDefModel, 'bubble');
    }
  }

  if (LegendFactory.isEnabledType('color')) {
    if (color && color.attribute !== undefined) {
      var hasCustomLegend = LegendFactory.find(layerDefModel, 'custom');

      if (!hasCustomLegend) {
        createColorLegend(layerDefModel, color);
      }
    } else {
      LegendFactory.removeLegend(layerDefModel, 'category');
      LegendFactory.removeLegend(layerDefModel, 'choropleth');
      LegendFactory.removeLegend(layerDefModel, 'custom_choropleth');
    }
  }
};

module.exports = {
  track: function (layerDefModel) {
    var onStyleChange = function () {
      onChange(layerDefModel);
    };

    var styleModel = layerDefModel.styleModel;

    layerDefModel.on('change:cartocss', onChange);
    styleModel && styleModel.on('style:update', onStyleChange);

    layerDefModel.on('destroy', function () {
      layerDefModel.off('change:cartocss', onChange);
      styleModel && styleModel.off('style:update', onStyleChange);
    });
  }
};

},{"../editor/layers/layer-content-views/legend/form/legend-color-helper":947,"../editor/layers/layer-content-views/legend/legend-factory":961,"underscore":"underscore"}],686:[function(require,module,exports){
var infowindowNoneTemplate = require('../mustache-templates/infowindows/infowindow_none.tpl');

module.exports = function linkLayerInfowindow (layerDef, visMap) {
  if (!layerDef.infowindowModel) return;

  function updateInfowindow (infowindowModel) {
    var attrs = JSON.parse(JSON.stringify(infowindowModel.attributes));

    if (infowindowModel.isEmptyTemplate()) {
      var node = layerDef.getAnalysisDefinitionNodeModel();

      var cartodb_id = node && node.querySchemaModel.columnsCollection.find(function (m) {
        return m.get('name') === 'cartodb_id';
      });

      if (cartodb_id) {
        attrs.fields = [{
          name: 'cartodb_id',
          title: true,
          position: 0
        }];

        attrs.template = infowindowNoneTemplate({
          title: _t('editor.layers.infowindow.no-fields'),
          subtitle: _t('editor.layers.infowindow.select-fields')
        });
      }
    }

    var infowindow = visMap.getLayerById(layerDef.id).infowindow;
    // some layers like basemaps, torque, or aggregated don't have infowindows so skip update
    if (infowindow) {
      infowindow.update(attrs);
    }
  }

  function onChange (infowindowModel) {
    updateInfowindow(infowindowModel);
  }

  updateInfowindow(layerDef.infowindowModel);

  layerDef.infowindowModel.bind('change', onChange);

  layerDef.bind('destroy', function () {
    layerDef.infowindowModel.unbind('change', onChange);
  });
};

},{"../mustache-templates/infowindows/infowindow_none.tpl":1108}],687:[function(require,module,exports){
module.exports = function linkLayerTooltip (layerDef, visMap) {
  if (!layerDef.tooltipModel) return;

  function onChange (tooltipModel) {
    var attrs = JSON.parse(JSON.stringify(tooltipModel.attributes));
    var tooltip = visMap.getLayerById(layerDef.id).tooltip;
    // some layers like basemaps, torque, or aggregated don't have infowindows
    // so skip update
    tooltip && tooltip.update(attrs);
  }

  var tooltipModel = layerDef.tooltipModel;
  if (tooltipModel.get('template_name')) {
    tooltipModel.setTemplate(tooltipModel.get('template_name'));
  }

  tooltipModel.bind('change', onChange);

  layerDef.bind('destroy', function () {
    tooltipModel.unbind('change', onChange);
  });
};

},{}],688:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--grid u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="26" height="26" viewBox="0 0 26 26" xmlns="http://www.w3.org/2000/svg">\n        <path d="M1 25l2.262-6.787 16.59-16.59c.832-.83 2.185-.83 3.016 0l1.508 1.51c.83.83.83 2.182 0 3.015l-16.59 16.59L1 25zM21.36 9.165L16.835 4.64l4.525 4.525zM7.787 22.738l-4.525-4.525 4.525 4.525z" stroke="#F19243" fill="none" fill-rule="evenodd"/>\n      </svg>\n    </div>\n    <div>\n      <h2 class=" CDB-Text CDB-Size-huge is-light u-bSpace--m">'+
((__t=( _t('components.modals.edit-feature.confirmation.title') ))==null?'':_.escape(__t))+
'</h2>\n      <p class="CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( _t('components.modals.edit-feature.confirmation.desc') ))==null?'':_.escape(__t))+
'</p>\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.modals.edit-feature.confirmation.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.edit-feature.confirmation.continue') ))==null?'':_.escape(__t))+
'</span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],689:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');
var linkLayerInfowindow = require('./deep-insights-integration/link-layer-infowindow');
var linkLayerTooltip = require('./deep-insights-integration/link-layer-tooltip');
var LegendManager = require('./deep-insights-integration/legend-manager');
var AnalysisNotifications = require('./editor/layers/analysis-views/analysis-notifications');
var WidgetsNotifications = require('./widgets-notifications');
var AnalysisOnboardingLauncher = require('./components/onboardings/analysis/analysis-launcher');
var NotificationErrorMessageHandler = require('./editor/layers/notification-error-message-handler');
var VisNotifications = require('./vis-notifications');
var WidgetsService = require('./editor/widgets/widgets-service');
var WidgetDefinitionModel = require('./data/widget-definition-model');
var FeatureDefinitionModel = require('./data/feature-definition-model');
var Notifier = require('./components/notifier/notifier');
var layerTypesAndKinds = require('./data/layer-types-and-kinds');
var basemapProvidersAndCategories = require('./data/basemap-providers-and-categories');
var getStylesWithoutAutostyles = require('./helpers/styles-without-autostyle');

/**
 * Integration between various data collections/models with cartodb.js and deep-insights.
 */
var F = function (opts) {
  if (!opts.deepInsightsDashboard) throw new Error('deepInsightsDashboard is required');
  if (!opts.analysisDefinitionNodesCollection) throw new Error('analysisDefinitionNodesCollection is required');
  if (!opts.analysisDefinitionsCollection) throw new Error('analysisDefinitionsCollection is required');
  if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
  if (!opts.widgetDefinitionsCollection) throw new Error('widgetDefinitionsCollection is required');
  if (!opts.legendDefinitionsCollection) throw new Error('legendDefinitionsCollection is required');
  if (!opts.visDefinitionModel) throw new Error('visDefinitionModel is required');
  if (!opts.userModel) throw new Error('userModel is required');
  if (!opts.onboardings) throw new Error('onboardings is required');
  if (!opts.mapDefinitionModel) throw new Error('mapDefinitionModel is required');
  if (!opts.stateDefinitionModel) throw new Error('stateDefinitionModel is required');
  if (!opts.overlayDefinitionsCollection) throw new Error('overlayDefinitionsCollection is required');
  if (!opts.mapModeModel) throw new Error('mapModeModel is required');
  if (!opts.configModel) throw new Error('configModel is required');
  if (!opts.editorModel) throw new Error('editorModel is required');
  if (!opts.editFeatureOverlay) throw new Error('editFeatureOverlay is required');

  this._diDashboard = opts.deepInsightsDashboard;
  this._analysisDefinitionNodesCollection = opts.analysisDefinitionNodesCollection;
  this._analysisDefinitionsCollection = opts.analysisDefinitionsCollection;
  this._layerDefinitionsCollection = opts.layerDefinitionsCollection;
  this._visDefinitionModel = opts.visDefinitionModel;
  this._stateDefinitionModel = opts.stateDefinitionModel;
  this._userModel = opts.userModel;
  this._mapDefinitionModel = opts.mapDefinitionModel;
  this._onboardings = opts.onboardings;
  this._overlayDefinitionsCollection = opts.overlayDefinitionsCollection;
  this._mapModeModel = opts.mapModeModel;
  this._configModel = opts.configModel;
  this._widgetDefinitionsCollection = opts.widgetDefinitionsCollection;
  this._editorModel = opts.editorModel;
  this._editFeatureOverlay = opts.editFeatureOverlay;
  this._legendsDefinitionCollection = opts.legendDefinitionsCollection;

  this._getStylesWithoutAutostyles = getStylesWithoutAutostyles();
  this._layerDefinitionsCollection.each(this._linkLayerErrors, this);

  opts.analysisDefinitionNodesCollection.each(function (analysisDefinitionNode) {
    analysisDefinitionNode.queryRowsCollection.on('remove', this._invalidateMap, this);
  }, this);

  this._analysisDefinitionNodesCollection.on('add', this._analyseDefinitionNodeAdded, this);
  this._analysisDefinitionNodesCollection.on('change', this._analyseDefinitionNode, this);
  this._analysisDefinitionNodesCollection.on('change:id', this._onAnalysisDefinitionNodeIdChanged, this);
  this._analysisDefinitionNodesCollection.on('remove', this._onAnalysisDefinitionNodeRemoved, this);
  this._analysisDefinitionsCollection.on('add change:node_id sync', this._analyseDefinition, this);

  opts.layerDefinitionsCollection.on('add', this._onLayerDefinitionAdded, this);
  opts.layerDefinitionsCollection.on('sync', this._onLayerDefinitionSynced, this);
  opts.layerDefinitionsCollection.on('change', this._onLayerDefinitionChanged, this);
  opts.layerDefinitionsCollection.on('remove', this._onLayerDefinitionRemoved, this);
  opts.layerDefinitionsCollection.on('layerMoved', this._onLayerDefinitionMoved, this);
  opts.layerDefinitionsCollection.on('baseLayerChanged', this._onBaseLayerChanged, this);

  opts.layerDefinitionsCollection.each(function (layerDefModel) {
    LegendManager.track(layerDefModel);

    linkLayerInfowindow(layerDefModel, this.visMap());
    linkLayerTooltip(layerDefModel, this.visMap());

    if (layerDefModel.has('source')) {
      this._resetStylesIfNoneApplied(layerDefModel);
    }
  }, this);

  opts.legendDefinitionsCollection.on('add', this._onLegendDefinitionAdded, this);
  opts.legendDefinitionsCollection.on('change', this._onLegendDefinitionChanged, this);
  opts.legendDefinitionsCollection.on('remove', this._onLegendDefinitionRemoved, this);

  opts.widgetDefinitionsCollection.on('add', this._onWidgetDefinitionAdded, this);
  opts.widgetDefinitionsCollection.on('sync', this._onWidgetDefinitionSynced, this);
  opts.widgetDefinitionsCollection.on('change', this._onWidgetDefinitionChanged, this);
  opts.widgetDefinitionsCollection.on('destroy', this._onWidgetDefinitionDestroyed, this);
  opts.widgetDefinitionsCollection.on('add remove reset', this._invalidateSize, this);

  opts.widgetDefinitionsCollection.each(this._onWidgetDefinitionAdded, this);

  opts.overlayDefinitionsCollection.on('add', this._onOverlayDefinitionAdded, this);
  opts.overlayDefinitionsCollection.on('remove', this._onOverlayDefinitionRemoved, this);

  opts.mapDefinitionModel.on('change:minZoom change:maxZoom', _.debounce(this._onMinMaxZoomChanged.bind(this), 300), this);
  opts.mapDefinitionModel.on('change:scrollwheel', this._onScrollWheelChanged, this);
  opts.mapDefinitionModel.on('change:legends', this._onLegendsChanged, this);
  opts.mapDefinitionModel.on('change:layer_selector', this._onLayerSelectorChanged, this);

  this._onScrollWheelChanged();

  WidgetsNotifications.track(this._widgetDefinitionsCollection);

  opts.editorModel.on('change:settingsView', this._onEditorSettingsChanged, this);

  this._analysisDefinitionsCollection.each(this._analyseDefinition, this);
  this._vis().on('reload', this._visReload, this);
  this._vis().on('change:error', this._visErrorChange, this);

  var saveStateDefinition = _.debounce(this._saveStateDefinition.bind(this), 500);
  this._diDashboard.onStateChanged(saveStateDefinition);
  this._stateDefinitionModel.on('boundsSet', this._onBoundsSet, this);

  // In order to sync layer selector and layer visbility
  this._getLayers().on('change:visible', function (layer, visible) {
    var layerDefModel = opts.layerDefinitionsCollection.findWhere({id: layer.id});
    if (layerDefModel) {
      if (layerDefModel.get('visible') !== visible) {
        layerDefModel.save({visible: visible});
      }
    }
  }, this);

  VisNotifications.track(this._vis());

  opts.mapModeModel.on('change:mode', this._onMapModeChanged, this);

  this.visMap().on('featureClick', this._onFeatureClicked, this);
  this.visMap().on('mapViewSizeChanged', this._setMapViewSize, this);

  // Needed to image export feature
  this._getVisMetadata();
  this._setMapConverters();
  this._setMapViewSize();
};

F.prototype._onFeatureClicked = function (event) {
  var layerId = event.layer.id;
  var featureId = event.feature.cartodb_id;
  var position = event.position;
  var layerDefinitionModel = this._layerDefinitionsCollection.get(layerId);
  var isFeatureBeingEdited = false;

  var featureDefinition = new FeatureDefinitionModel({
    cartodb_id: featureId
  }, {
    configModel: this._configModel,
    layerDefinitionModel: layerDefinitionModel,
    userModel: this._userModel
  });

  if (this._mapModeModel.isEditingFeatureMode()) {
    var editingFeatureDefinitionModel = this._mapModeModel.getFeatureDefinition();
    isFeatureBeingEdited = featureDefinition.isEqual(editingFeatureDefinitionModel);
  }

  if (!isFeatureBeingEdited) {
    this._editFeatureOverlay.setPosition(position);
    this._editFeatureOverlay.setFeatureDefinition(featureDefinition);
    this._editFeatureOverlay
      .render()
      .show();
  }
};

F.prototype._onMapModeChanged = function (mapModeModel) {
  var map = this.visMap();
  var featureDefinition;
  var geometry;

  // VIEWING MODE
  if (mapModeModel.isViewingMode()) {
    map.stopDrawingGeometry();
    map.stopEditingGeometry();
  }

  // DRAWING FEATURES
  if (mapModeModel.isDrawingFeatureMode()) {
    featureDefinition = mapModeModel.getFeatureDefinition();
    if (featureDefinition.isPoint()) {
      geometry = map.drawPoint();
    } else if (featureDefinition.isLine()) {
      geometry = map.drawPolyline();
    } else if (featureDefinition.isPolygon()) {
      geometry = map.drawPolygon();
    }

    if (!geometry) {
      throw new Error("couldn't get geometry for feature of type " + featureDefinition.get('type'));
    }
  }

  // EDITING FEATURES
  if (mapModeModel.isEditingFeatureMode()) {
    featureDefinition = mapModeModel.getFeatureDefinition();
    var geojson = JSON.parse(featureDefinition.get('the_geom'));
    geometry = map.editGeometry(geojson);
  }

  if (featureDefinition && geometry) {
    this._bindGeometryToFeatureDefinition(geometry, featureDefinition);
    featureDefinition.on('save', function () {
      if (featureDefinition.hasBeenChangedAfterLastSaved('the_geom') || featureDefinition.hasBeenChangedAfterLastSaved('cartodb_id')) {
        this._invalidateMap();
        geometry.setCoordinatesFromGeoJSON(JSON.parse(featureDefinition.get('the_geom')));
      }
    }, this);
    featureDefinition.on('remove', function () {
      this._invalidateMap();
    }, this);
  }
};

F.prototype._bindGeometryToFeatureDefinition = function (geometry, featureDefinition) {
  geometry.on('change', function () {
    if (geometry.isComplete()) {
      $('.js-editOverlay').fadeOut(200, function () {
        $('.js-editOverlay').remove();
      });

      var geojson = geometry.toGeoJSON();
      geojson = geojson.geometry || geojson;
      featureDefinition.set({
        the_geom: JSON.stringify(geojson)
      });
      featureDefinition.trigger('updateFeature');
    }
  });
};

F.prototype._resetStylesIfNoneApplied = function (layerDefModel) {
  var nodeDefModel = layerDefModel.getAnalysisDefinitionNodeModel();
  var analysisCollection = this._analysis();
  var nodeModel = analysisCollection && analysisCollection.findNodeById(layerDefModel.get('source'));
  var isAnalysisNode = nodeModel && nodeModel.get('type') !== 'source';
  var isDone = nodeModel && nodeModel.isDone();
  var queryGeometryModel = nodeDefModel.queryGeometryModel;
  var styleModel = layerDefModel.styleModel;

  if (isAnalysisNode && styleModel.hasNoneStyles() && isDone) {
    var simpleGeom = queryGeometryModel.get('simple_geom');

    var applyDefaultStyles = function () {
      simpleGeom = queryGeometryModel.get('simple_geom');
      styleModel.setDefaultPropertiesByType('simple', simpleGeom);
    };

    if (!simpleGeom) {
      queryGeometryModel.once('change:simple_geom', applyDefaultStyles, this);
      queryGeometryModel.fetch();
    } else {
      applyDefaultStyles();
    }
  }
};

F.prototype._visReload = function () {
  this._getVisMetadata();
  this._visDefinitionModel.trigger('vis:reload');
  this._visDefinitionModel.recordChange();
};

F.prototype._getVisMetadata = function () {
  var vis = this._vis();
  var map = this.visMap();
  var layers = this._getLayers();

  var imageExportMetadata = {
    zoom: map.get('zoom'),
    mapType: map.getBaseLayer().get('baseType'),
    style: layers.at(0).get('style'),
    attribution: map.get('attribution'),
    provider: map.get('provider')
  };

  this._mapDefinitionModel.setImageExportMetadata(imageExportMetadata);
  this._mapDefinitionModel.setStaticImageURLTemplate(vis.getStaticImageURL.bind(vis));
};

F.prototype._setMapConverters = function () {
  var map = this.visMap();
  this._mapDefinitionModel.setConverters({
    pixelToLatLng: map.pixelToLatLng(),
    latLngToPixel: map.latLngToPixel()
  });
};

F.prototype._setMapViewSize = function () {
  this._mapDefinitionModel.setMapViewSize(this.visMap().getMapViewSize());
};

F.prototype._visErrorChange = function () {
  this._visDefinitionModel && this._visDefinitionModel.trigger('vis:error', this._vis().get('error'));
};

F.prototype._analyseDefinition = function (m) {
  var id = m.get('node_id');
  var nodeDefModel = this._analysisDefinitionNodesCollection.get(id);
  this._analyseDefinitionNode(nodeDefModel);
};

F.prototype._analyseDefinitionNodeAdded = function (m) {
  m.queryRowsCollection.on('remove', this._invalidateMap, this);
  this._analyseDefinitionNode(m);
};

F.prototype._analyseDefinitionNode = function (m) {
  if (!this._hasUpdateOnlyNodeAnalysisId(m)) {
    var attrs = m.toJSON({ skipOptions: true });
    this._analysis().analyse(attrs);

    // Unfortunately have to try to setup sync until this point, since a node doesn't exist until after analyse call
    this._analysisDefinitionNodesCollection.each(this._tryToSetupDefinitionNodeSync, this);
  }
};

F.prototype._onAnalysisDefinitionNodeIdChanged = function (m, changedAttributes) {
  if (this._hasUpdateOnlyNodeAnalysisId(m)) {
    var node = this._analysis().findNodeById(m.previous('id'));
    node && node.set('id', m.id);
  }
};

F.prototype._onAnalysisDefinitionNodeRemoved = function (m) {
  m.queryRowsCollection.off('remove', this._invalidateMap, this);

  var node = this._analysis().findNodeById(m.id);
  if (node) {
    node.set({avoidNotification: (m && !!m.get('avoidNotification'))}, {silent: true});
    node.remove();
  }
};

F.prototype._hasUpdateOnlyNodeAnalysisId = function (nodeDefModel) {
  return nodeDefModel.hasChanged('id') && _.size(nodeDefModel.changed) === 1;
};

F.prototype._tryToSetupDefinitionNodeSync = function (m) {
  if (m.__syncSetup) return; // only setup once

  var node = this._analysis().findNodeById(m.id);
  var layerDefModel = this._layerDefinitionsCollection.findOwnerOfAnalysisNode(m);
  if (!node) return; // might not exist when method is called, so do nothing to allow retries

  m.__syncSetup = true;
  m.__initialization = true;

  // Don't need to sync source nodes
  if (node.get('type') !== 'source') {
    AnalysisNotifications.track(node, layerDefModel);

    var updateAnalysisQuerySchema = function () {
      var query = node.get('query');
      var status = node.get('status');
      var error = node.get('error');

      m.querySchemaModel.set({
        status: 'unfetched',
        query: query,
        ready: status === 'ready'
      });
      m.queryGeometryModel.set({
        status: 'unfetched',
        query: query,
        ready: status === 'ready'
      });

      m.set({
        status: status,
        error: error
      });

      if (status === 'ready') {
        if (!m.__initialization) {
          m.trigger('queryObjectsUpdated', m);
        }

        m.__initialization = false;
      }
    };

    AnalysisOnboardingLauncher.init({
      onboardings: this._onboardings,
      userModel: this._userModel
    });

    m.listenTo(node, 'change:status', function (model, status) {
      if (status === 'ready' && m.USER_SAVED) {
        AnalysisOnboardingLauncher.launch(node.get('type'), model);
        m.USER_SAVED = false;
      }
    });

    updateAnalysisQuerySchema();

    m.listenTo(node, 'change:query change:status change:error', updateAnalysisQuerySchema);
    m.listenToOnce(node, 'destroy', m.stopListening);
  } else {
    m.listenTo(m.querySchemaModel, 'resetDueToAlteredData', this._invalidateMap.bind(this));
  }
};

F.prototype._onWidgetDefinitionAdded = function (m) {
  var widgetModel = this._diDashboard.getWidget(m.id);
  if (widgetModel) {
    widgetModel.set({
      show_stats: true,
      show_options: true
    });

    this._bindWidgetChanges(widgetModel);
  }
};

F.prototype._onWidgetDefinitionSynced = function (m) {
  var widgetModel = this._diDashboard.getWidget(m.id);
  if (!widgetModel) {
    this._createWidgetModel(m);
  }
};

F.prototype._onWidgetAutoStyleColorChanged = function (m) {
  var isAutoStyleApplied = m.isAutoStyle();
  var autoStyleInfo = m.getAutoStyle();
  var layerId = m.dataviewModel.layer.id;
  var layerDefModel = this._layerDefinitionsCollection.findWhere({ id: layerId });
  var nodeDefModel = layerDefModel && layerDefModel.getAnalysisDefinitionNodeModel();
  var styleModel = layerDefModel && layerDefModel.styleModel;
  var geometryType = nodeDefModel && nodeDefModel.get('simple_geom');

  if (layerDefModel) {
    layerDefModel.set({
      autoStyle: isAutoStyleApplied ? m.id : false,
      cartocss: autoStyleInfo.cartocss
    });
  }

  if (isAutoStyleApplied && styleModel && geometryType) {
    styleModel.setPropertiesFromAutoStyle({
      definition: autoStyleInfo.definition,
      geometryType: geometryType,
      widgetId: m.id
    });
  }
};

F.prototype._onWidgetAutoStyleChanged = function (m) {
  var isAutoStyleApplied = m.isAutoStyle();
  var autoStyleInfo = m.getAutoStyle();
  var layerId = m.dataviewModel.layer.id;
  var layerDefModel = this._layerDefinitionsCollection.findWhere({ id: layerId });
  var nodeDefModel = layerDefModel && layerDefModel.getAnalysisDefinitionNodeModel();
  var styleModel = layerDefModel && layerDefModel.styleModel;
  var onLayerChange = _.debounce(function () {
    var dontResetStyles = true; // In order to make it more visible
    m.cancelAutoStyle(dontResetStyles);
  }, 10);

  var stylesWithoutAutostyles = this._getStylesWithoutAutostyles(layerDefModel);

  if (layerDefModel && nodeDefModel) {
    if (isAutoStyleApplied) {
      layerDefModel.set({
        autoStyle: m.id
      });
    }
  } else {
    return;
  }

  if (isAutoStyleApplied) {
    var geometryType = nodeDefModel.get('simple_geom');
    styleModel.setPropertiesFromAutoStyle({
      definition: autoStyleInfo.definition,
      geometryType: geometryType,
      widgetId: m.id
    });

    layerDefModel.set(_.extend(
      {
        cartocss: autoStyleInfo.cartocss,
        cartocss_custom: false
      },
      stylesWithoutAutostyles
    ));

    layerDefModel.once('change:autoStyle change:cartocss', onLayerChange, this);
  } else {
    layerDefModel.unbind('change:autoStyle change:cartocss', onLayerChange, this);
    var autoStyleId = layerDefModel.get('autoStyle');

    if (autoStyleId && autoStyleId === m.id) {
      styleModel.resetPropertiesFromAutoStyle();

      layerDefModel.set({
        autoStyle: false,
        cartocss_custom: layerDefModel.get('previousCartoCSSCustom'),
        cartocss: layerDefModel.get('previousCartoCSS')
      });

      // Because we are messing with the autoStyle property on saving,
      // whenever we disable autoStyle, we save the layer to force
      // the sync on the cartocss
      layerDefModel.save();
    }
  }
};

F.prototype._onWidgetCustomAutoStyleColorChanged = function (m) {
  var isAutoStyleApplied = m.isAutoStyle();
  var autoStyleInfo = m.getAutoStyle();
  var layerId = m.dataviewModel.layer.id;
  var layerDefModel = this._layerDefinitionsCollection.findWhere({ id: layerId });
  var nodeDefModel = layerDefModel && layerDefModel.getAnalysisDefinitionNodeModel();
  var styleModel = layerDefModel && layerDefModel.styleModel;

  if (isAutoStyleApplied) {
    var geometryType = nodeDefModel.get('simple_geom');
    styleModel.setPropertiesFromAutoStyle({
      definition: autoStyleInfo.definition,
      geometryType: geometryType,
      widgetId: m.id
    });

    layerDefModel.set({
      cartocss: autoStyleInfo.cartocss,
      cartocss_custom: false
    }, {silent: true});

    // In order to make legends aware
    styleModel.trigger('style:update');
  }
};

F.prototype._onWidgetDefinitionChanged = function (m) {
  var widgetModel = this._diDashboard.getWidget(m.id);

  // Only try to update if there's a corresponding widget model
  // E.g. the change of type will remove the model and provoke change events, which are not of interest (here),
  // since the widget model should be re-created for the new type anyway.
  if (widgetModel) {
    if (m.hasChanged('type')) {
      widgetModel.remove();
      this._createWidgetModel(m);
    } else {
      var attrs = this._formatWidgetAttrs(m.changedAttributes(), m);
      widgetModel.update(attrs);
    }
  }
};

F.prototype._onWidgetDefinitionDestroyed = function (m) {
  var widgetModel = this._diDashboard.getWidget(m.id);

  if (widgetModel) {
    if (widgetModel.isAutoStyle()) {
      widgetModel.cancelAutoStyle();
    }
    this._unbindWidgetChanges(widgetModel);
    widgetModel.remove();
  }
};

F.prototype._onEditWidget = function (m) {
  var widgetDefModel = this._widgetDefinitionsCollection.get(m.id);
  if (widgetDefModel) {
    WidgetsService.editWidget(widgetDefModel);
  }
};

F.prototype._onRemoveWidget = function (m) {
  var widgetDefModel = this._widgetDefinitionsCollection.get(m.id);
  if (widgetDefModel) {
    WidgetsService.removeWidget(widgetDefModel);
  }
};

F.prototype._bindWidgetChanges = function (m) {
  m.bind('editWidget', this._onEditWidget, this);
  m.bind('removeWidget', this._onRemoveWidget, this);
  m.bind('customAutoStyle', this._onWidgetCustomAutoStyleColorChanged, this);
  m.bind('change:autoStyle', this._onWidgetAutoStyleChanged, this);
  m.bind('change:color', this._onWidgetAutoStyleColorChanged, this);
};

F.prototype._unbindWidgetChanges = function (m) {
  m.unbind('editWidget', this._onEditWidget, this);
  m.unbind('removeWidget', this._onRemoveWidget, this);
  m.unbind('customAutoStyle', this._onWidgetCustomAutoStyleColorChanged, this);
  m.unbind('change:autoStyle', this._onWidgetAutoStyleChanged, this);
  m.unbind('change:color', this._onWidgetAutoStyleColorChanged, this);
};

F.prototype._createWidgetModel = function (m) {
  // e.g. 'time-series' => createTimeSeriesWidget
  var infix = m.get('type').replace(/(^\w|-\w)/g, function (match) {
    return match.toUpperCase().replace('-', '');
  });
  var methodName = 'create' + infix + 'Widget';

  var layerModel = this.visMap().getLayerById(m.get('layer_id'));
  var attrs = this._formatWidgetAttrs(m.attributes, m);

  var widgetModel = this._diDashboard[methodName](attrs, layerModel);

  if (widgetModel) {
    widgetModel.set({
      show_stats: true,
      show_options: true
    });

    this._bindWidgetChanges(widgetModel);
  }
};

/**
 * Massage some data points to the expected format of deep-insights API
 */
F.prototype._formatWidgetAttrs = function (changedAttrs, widgetDefModel) {
  var widgetStyleParams = ['widget_style_definition', 'auto_style_definition', 'auto_style_allowed'];
  var formattedAttrs = changedAttrs;

  // Source formatting
  if (_.isString(formattedAttrs.source)) {
    formattedAttrs = _.omit(formattedAttrs, 'source');
    formattedAttrs.source = {id: changedAttrs.source};
  }

  // Widget style or auto style changes
  var thereIsWidgetStyleChange = _.find(formattedAttrs, function (value, key) {
    return _.contains(widgetStyleParams, key);
  });

  if (!_.isUndefined(thereIsWidgetStyleChange)) {
    formattedAttrs = _.omit(formattedAttrs, widgetStyleParams);
    formattedAttrs.style = widgetDefModel.toJSON().style;
  }

  return formattedAttrs;
};

F.prototype._onLayerDefinitionAdded = function (m, c, opts) {
  // Base and labels layers are synced in a separate method
  if (!layerTypesAndKinds.isTypeDataLayer(m.get('type'))) {
    return;
  }

  // If added but not yet saved, postpone the creation until persisted (see sync listener)
  if (!m.isNew()) {
    if (!this._getLayer(m)) {
      this._createLayer(m);
    } else {
      // we need to sync model positions
      this._tryUpdateLayerPosition(m);
    }
  }
};

F.prototype._tryUpdateLayerPosition = function (m) {
  var builderPosition = this._layerDefinitionsCollection.indexOf(m);
  var cdbLayer = this._getLayer(m);
  var cdbPosition;

  if (cdbLayer) {
    cdbPosition = this._getLayers().indexOf(cdbLayer);
  }

  var indexChanges = m.isDataLayer() && cdbPosition > 0 && builderPosition > 0 && builderPosition !== cdbPosition;

  if (indexChanges) {
    this.visMap().moveCartoDBLayer(cdbPosition, builderPosition);
  }
};

F.prototype._onLayerDefinitionSynced = function (m) {
  // Base and labels layers are synced in a separate method
  if (!layerTypesAndKinds.isTypeDataLayer(m.get('type'))) {
    return;
  }

  if (!this._getLayer(m)) {
    this._createLayer(m);
  }
};

F.prototype._onLayerDefinitionChanged = function (layerDefinitionModel, changedAttributes) {
  var attrs = layerDefinitionModel.changedAttributes();
  var attrsNames = _.keys(attrs);

  // Base and labels layers are synced in a separate method
  if (!layerTypesAndKinds.isTypeDataLayer(layerDefinitionModel.get('type'))) {
    return;
  }

  // return if only the 'error' attribute has changed (no need to sync anything)
  if (attrsNames.length === 1 && attrsNames[0] === 'error') {
    return;
  }

  var layer = this._getLayer(layerDefinitionModel);
  if (!layerDefinitionModel.isNew()) {
    if (!layer) {
      this._createLayer(layerDefinitionModel);
      return;
    }

    if (attrs.type) {
      layer.remove();
      this._createLayer(layerDefinitionModel);
    } else {
      if (layerDefinitionModel.get('source') && !layer.get('source')) {
        attrs.source = layerDefinitionModel.get('source');
      }
      attrs = this._adaptAttrsToCDBjs(layerDefinitionModel.get('type'), attrs);
      layer.update(attrs);
    }
    this._manageTimeSeriesForTorque(layerDefinitionModel);
  }
};

F.prototype._onBaseLayerChanged = function () {
  var baseLayerDefinition = this._layerDefinitionsCollection.getBaseLayer();
  var newBaseLayerAttrs = baseLayerDefinition.changedAttributes();

  var newBaseLayerType = baseLayerDefinition.get('type');
  var newMapProvider = basemapProvidersAndCategories.getProvider(newBaseLayerType);
  var mapProviderChanged = false;
  if (baseLayerDefinition.hasChanged('type')) {
    var previousBaseLayerType = baseLayerDefinition.previous('type');
    var previousMapProvider = basemapProvidersAndCategories.getProvider(previousBaseLayerType);
    mapProviderChanged = previousMapProvider !== newMapProvider;
  }

  // If the map provider has changed (eg: Leaflet -> Google Maps), we add/update/remove base and
  // labels layers silently so that CartoDB.js doesn't pick up those changes and tries to add/update/remove
  // layers until the new map provider has been set
  var handleLayersSilently = mapProviderChanged;

  // Base layer
  var cdbjsLayer = this._getLayer(baseLayerDefinition);

  // If the type of base layer has changed. eg: Tiled -> Plain
  if (newBaseLayerAttrs.type) {
    cdbjsLayer.remove({ silent: handleLayersSilently });
    this._createLayer(baseLayerDefinition, { silent: handleLayersSilently });
  } else {
    cdbjsLayer.update(this._adaptAttrsToCDBjs(baseLayerDefinition.get('type'), newBaseLayerAttrs), {
      silent: handleLayersSilently
    });
  }

  // Labels layer
  var labelsLayerDefinition = this._layerDefinitionsCollection.getLabelsLayer();
  var cdbjsTopLayer = this._getLayers().last();
  var cdbjsHasLabelsLayer = cdbjsTopLayer.get('type') === 'Tiled';

  if (labelsLayerDefinition) {
    if (cdbjsHasLabelsLayer) {
      var changedAttrs = labelsLayerDefinition.changedAttributes();
      if (changedAttrs) {
        cdbjsTopLayer.update(this._adaptAttrsToCDBjs(labelsLayerDefinition.get('type'), changedAttrs), {
          silent: handleLayersSilently
        });
      }
    } else {
      this._createLayer(labelsLayerDefinition, { silent: handleLayersSilently });
    }
  } else if (cdbjsHasLabelsLayer) {
    cdbjsTopLayer.remove({ silent: handleLayersSilently });
  }

  // Map provider
  this.visMap().set('provider', newMapProvider);

  if (handleLayersSilently) {
    // Reload map if everything (previously) was done silently
    this._diDashboard.reloadMap();
  }

  // Render again the edit-feature-overlay, in order to
  // decide if delegate or not events
  this._editFeatureOverlay.render();
  this._setMapConverters();
};

var CARTODBJS_TO_CARTODB_ATTRIBUTE_MAPPINGS = {
  'layer_name': ['table_name_alias', 'table_name']
};

var BLACKLISTED_LAYER_DEFINITION_ATTRS = {
  'all': [ 'letter', 'kind' ],
  'Tiled': [ 'category', 'selected', 'highlighted' ],
  'CartoDB': [ 'color', 'letter' ],
  'torque': [ 'color', 'letter' ]
};

F.prototype._adaptAttrsToCDBjs = function (layerType, attrs) {
  attrs = _.omit(attrs, BLACKLISTED_LAYER_DEFINITION_ATTRS['all'], BLACKLISTED_LAYER_DEFINITION_ATTRS[layerType]);
  _.each(CARTODBJS_TO_CARTODB_ATTRIBUTE_MAPPINGS, function (cdbAttrs, cdbjsAttr) {
    _.each(cdbAttrs, function (cdbAttr) {
      if (attrs[cdbAttr] && !attrs[cdbjsAttr]) {
        attrs[cdbjsAttr] = attrs[cdbAttr];
      }
    });
  });

  return attrs;
};

F.prototype._onLegendDefinitionAdded = function (m) {
  var layerDefModel = m.layerDefinitionModel;
  var layer = this._getLayer(layerDefModel);
  var type = m.get('type');
  var legend;
  if (layer && layer.legends) {
    legend = layer.legends[type];
    if (legend) {
      legend.reset();
      legend.set(m.getAttributes());
      legend.show();
    }
  }
};

F.prototype._onLegendDefinitionRemoved = function (m) {
  var layerDefModel = m.layerDefinitionModel;
  var layer = this._getLayer(layerDefModel);
  var type = m.get('type');
  var legend;
  if (layer && layer.legends) {
    legend = layer.legends[type];
    legend && legend.hide();
  }
};

F.prototype._onLegendDefinitionChanged = function (m) {
  var layerDefModel = m.layerDefinitionModel;
  var layer = this._getLayer(layerDefModel);
  var type = m.get('type');
  var legend;
  if (layer && layer.legends) {
    legend = layer.legends[type];
    if (legend) {
      legend.reset();
      legend.set(m.getAttributes());
    }
  }
};

F.prototype._manageTimeSeriesForTorque = function (m) {
  function recreateWidget (currentTimeseries, newLayer, animated) {
    var persistName = currentTimeseries && currentTimeseries.get('title');
    this._createTimeseries(newLayer, animated, persistName);
  }

  // not a cartodb layer
  if (!m.styleModel) return;
  var animatedChanged = m.styleModel.changedAttributes().animated;
  var attributeChanged;
  if (animatedChanged) attributeChanged = animatedChanged.attribute;
  var typeChanged = m.styleModel.changedAttributes().type;
  var animatedAttribute = m.styleModel.get('animated') && m.styleModel.get('animated').attribute;
  var previousType = m.styleModel.previous('type');

  if (!typeChanged && !attributeChanged) return;

  var type = m.styleModel.get('type');
  var widgetModel = this._diDashboard.getWidgets().filter(function (m) {
    return m.get('type') === 'time-series';
  })[0];

  var currentTimeseries = this._getTimeseriesDefinition();
  var persistWidget = !!currentTimeseries && currentTimeseries.get('title') !== 'time_date__t';
  var newLayer = this._getLayer(m);

  if (type !== 'animation' && previousType === 'animation' && this._lastType !== type) {
    if (widgetModel) {
      this._removeTimeseries();
    }

    if (persistWidget) {
      recreateWidget.call(this, currentTimeseries, newLayer, _.extend({ animated: false }, animatedChanged, { attribute: animatedAttribute }));
    }
    this._lastType = type;
    this._lastTSAnimateChange = '';
  }

  if (type === 'animation' && (this._lastTSAnimateChange !== attributeChanged || this._lastType !== 'animation')) {
    if (widgetModel) {
      this._removeTimeseries();
    }

    if (newLayer.get('type') === 'torque' || m.get('type') === 'torque' || persistWidget) {
      recreateWidget.call(this, currentTimeseries, newLayer, _.extend({ animated: true }, animatedChanged, { attribute: animatedAttribute }));
    }

    this._lastType = type;
    this._lastTSAnimateChange = attributeChanged;
  }
};

F.prototype._removeTimeseries = function () {
  this._widgetDefinitionsCollection.models.forEach(function (def) {
    if (def.get('type') === 'time-series') {
      def.set({avoidNotification: true}, {silent: true});
      def.destroy();
    }
  });
};

F.prototype._getTimeseriesDefinition = function () {
  return this._widgetDefinitionsCollection.where({type: 'time-series'})[0];
};

F.prototype._createTimeseries = function (newLayer, animatedChanged, persist) {
  this._removeTimeseries();
  var attribute = animatedChanged && animatedChanged.attribute || '';
  var animated = animatedChanged && animatedChanged.animated;
  if (attribute) {
    var baseAttrs = {
      type: 'time-series',
      layer_id: newLayer.get('id'),
      source: {
        id: newLayer.get('source')
      },
      options: {
        column: attribute,
        title: persist || 'time_date__t',
        bins: 256,
        animated: animated
      },
      style: {
        widget_style: WidgetDefinitionModel.getDefaultWidgetStyle('time-series')
      }
    };
    this._widgetDefinitionsCollection.create(baseAttrs, {wait: true});
  }
};

F.prototype._onLayerDefinitionRemoved = function (m) {
  if (!m.isNew()) {
    var layer = this._getLayer(m);
    layer && layer.remove();
  }
};

F.prototype._onLayerDefinitionMoved = function (m, from, to) {
  this.visMap().moveCartoDBLayer(from, to);
};

var LAYER_TYPE_TO_LAYER_CREATE_METHOD = {
  'cartodb': 'createCartoDBLayer',
  'gmapsbase': 'createGMapsBaseLayer',
  'plain': 'createPlainLayer',
  'tiled': 'createTileLayer',
  'torque': 'createTorqueLayer',
  'wms': 'createWMSLayer'
};

F.prototype._createLayer = function (layerDefModel, options) {
  options = options || {};
  var attrs = JSON.parse(JSON.stringify(layerDefModel.attributes)); // deep clone
  attrs = this._adaptAttrsToCDBjs(layerDefModel.get('type'), attrs);

  // create the legends for the new layer
  var legends = this._legendsDefinitionCollection.findByLayerDefModel(layerDefModel);
  if (legends.length > 0) {
    attrs.legends = _.map(legends, function (legend) {
      return legend.toJSON();
    });
  }

  var createMethodName = LAYER_TYPE_TO_LAYER_CREATE_METHOD[attrs.type.toLowerCase()];
  if (!createMethodName) throw new Error('no create method name found for type ' + attrs.type);

  if (attrs.source) {
    // Make sure the analysis is created first
    var nodeDefModel = this._analysisDefinitionNodesCollection.get(attrs.source);
    this._analyseDefinitionNode(nodeDefModel);
  }

  var visMap = this.visMap();
  var layerPosition = this._layerDefinitionsCollection.indexOf(layerDefModel);
  visMap[createMethodName](attrs, _.extend({
    at: layerPosition
  }, options));

  linkLayerInfowindow(layerDefModel, visMap);
  linkLayerTooltip(layerDefModel, visMap);
  LegendManager.track(layerDefModel);

  this._linkLayerErrors(layerDefModel);
};

F.prototype._linkLayerErrors = function (m) {
  var layer = this._getLayer(m);
  if (layer) {
    if (layer.get('error')) {
      this._setLayerError(m, layer.get('error'));
    }
    layer.on('change:error', function (model, cdbError) {
      this._setLayerError(m, cdbError);
    }, this);
  }
};

F.prototype._setLayerError = function (layerDefinitionModel, cdbError) {
  var notification = Notifier.getNotification(layerDefinitionModel.id);
  var mainErrorMessage = layerDefinitionModel.getName() + ': ' + (cdbError && cdbError.message);

  if (!cdbError) {
    layerDefinitionModel.unset('error');
    notification && Notifier.removeNotification(notification);
    return;
  }

  var errorMessage = NotificationErrorMessageHandler.extractError(mainErrorMessage);

  if (notification) {
    notification.update({
      status: errorMessage.type,
      info: errorMessage.message
    });
  } else {
    Notifier.addNotification({
      id: layerDefinitionModel.id,
      status: errorMessage.type,
      closable: true,
      button: false,
      info: errorMessage.message
    });
  }

  if (cdbError.type === 'turbo-carto') {
    var line;
    try {
      line = cdbError.context.source.start.line;
    } catch (error) {}

    layerDefinitionModel.set('error', {
      type: cdbError.type,
      line: line,
      message: cdbError.message
    });
  } else if (errorMessage) {
    layerDefinitionModel.set('error', {
      type: errorMessage.type,
      message: errorMessage.message
    });
  }
};

F.prototype._onOverlayDefinitionAdded = function (mdl) {
  this._vis().overlaysCollection.add(mdl.toJSON());
};

F.prototype._onOverlayDefinitionRemoved = function (mdl) {
  var collection = this._vis().overlaysCollection;
  var overlay = collection.findWhere({ type: mdl.get('type') });
  overlay && collection.remove(overlay);
};

F.prototype._onMinMaxZoomChanged = function () {
  var currentZoom = this.visMap().get('zoom');
  var maxZoom = this._mapDefinitionModel.get('maxZoom');
  var minZoom = this._mapDefinitionModel.get('minZoom');

  this.visMap().set({
    minZoom: minZoom,
    maxZoom: maxZoom,
    zoom: Math.min(currentZoom, maxZoom)
  });
};

F.prototype._saveStateDefinition = function () {
  var state = this._diDashboard.getState();
  this._stateDefinitionModel.updateState(state);
  this._getVisMetadata();
};

F.prototype._onScrollWheelChanged = function () {
  var scrollwheel = this._mapDefinitionModel.get('scrollwheel');
  var method = scrollwheel ? 'enableScrollWheel' : 'disableScrollWheel';
  var map = this.visMap();
  map && map[method] && map[method]();
};

F.prototype._onLegendsChanged = function () {
  var legends = this._mapDefinitionModel.get('legends');
  this._vis().settings.set('showLegends', legends);
};

F.prototype._onLayerSelectorChanged = function () {
  var layerSelector = this._mapDefinitionModel.get('layer_selector');
  this._vis().settings.set('showLayerSelector', layerSelector);
};

F.prototype._onEditorSettingsChanged = function () {
  var settingsView = this._editorModel.get('settingsView');
  this._vis().settings.set('layerSelectorEnabled', settingsView);
};

F.prototype._getLayer = function (m) {
  return this.visMap().getLayerById(m.id);
};

F.prototype._getLayers = function (m) {
  return this.visMap().layers;
};

F.prototype.visMap = function () {
  return this._vis().map;
};

F.prototype._analysis = function () {
  return this._vis().analysis;
};

F.prototype._vis = function () {
  return this._diDashboard.getMap();
};

F.prototype._invalidateSize = function () {
  this._vis().invalidateSize();
};

F.prototype._invalidateMap = function () {
  this._vis().reload();
};

F.prototype._onBoundsSet = function (bounds) {
  this._diDashboard._dashboard.vis.map.setBounds(bounds);
};

module.exports = F;

},{"./components/notifier/notifier":475,"./components/onboardings/analysis/analysis-launcher":493,"./data/basemap-providers-and-categories":614,"./data/feature-definition-model":626,"./data/layer-types-and-kinds":637,"./data/widget-definition-model":680,"./deep-insights-integration/legend-manager":685,"./deep-insights-integration/link-layer-infowindow":686,"./deep-insights-integration/link-layer-tooltip":687,"./editor/layers/analysis-views/analysis-notifications":724,"./editor/layers/notification-error-message-handler":992,"./editor/widgets/widgets-service":1085,"./helpers/styles-without-autostyle":1100,"./vis-notifications":1121,"./widgets-notifications":1122,"jquery":"jquery","underscore":"underscore"}],690:[function(require,module,exports){
var ACTIVE_LOCALE = window.ACTIVE_LOCALE;
if (ACTIVE_LOCALE !== 'en') {
  require('moment/locale/' + ACTIVE_LOCALE);
}
var Locale = require('../../locale/index');
var Polyglot = require('node-polyglot');
var polyglot = new Polyglot({
  locale: ACTIVE_LOCALE, // Needed for pluralize behaviour
  phrases: Locale[ACTIVE_LOCALE]
});
window._t = polyglot.t.bind(polyglot);

var $ = require('jquery');
var _ = require('underscore');
var Backbone = require('backbone');
var deepInsights = require('cartodb-deep-insights.js');
var ConfigModel = require('./data/config-model');
var EditorMapView = require('./editor/editor-map-view');
var MapDefinitionModel = require('./data/map-definition-model');
var AnalysisDefinitionNodesCollection = require('./data/analysis-definition-nodes-collection');
var AnalysisDefinitionsCollection = require('./data/analysis-definitions-collection');
var LayerDefinitionsCollection = require('./data/layer-definitions-collection');
var WidgetDefinitionsCollection = require('./data/widget-definitions-collection');
var VisDefinitionModel = require('./data/vis-definition-model');
var createEditorMenuTabPane = require('./components/tab-pane/create-editor-menu-tab-pane');
var editorPaneTemplate = require('./editor/editor-pane.tpl');
var editorPaneIconItemTemplate = require('./editor/editor-pane-icon.tpl');
var ModalsServiceModel = require('./components/modals/modals-service-model');
var AnalysesService = require('./editor/layers/layer-content-views/analyses/analyses-service.js');
var OnboardingsServiceModel = require('./components/onboardings/onboardings-service-model');
var BuilderOnboardingLauncher = require('./components/onboardings/builder/launcher');
var viewFactory = require('./components/view-factory');
var UserModel = require('./data/user-model');
var UserNotifications = require('./data/user-notifications');
var EditorModel = require('./data/editor-model');
var UserActions = require('./data/user-actions');
var ImporterManager = require('./components/background-importer/background-importer');
var BackgroundPollingModel = require('./data/editor-background-polling-model');
var StyleManager = require('./editor/style/style-manager');
var DeepInsightsIntegrations = require('./deep-insights-integrations');
var EditFeatureOverlay = require('./deep-insights-integration/edit-feature-overlay');
var Notifier = require('./components/notifier/notifier');
var MetricsTracker = require('./components/metrics/metrics-tracker');
var FeedbackButtonView = require('./editor/feedback/feedback-button-view');
var SettingsOptions = require('./data/map-settings');
var SettingsView = require('./editor/editor-settings-view');
var OverlaysCollection = require('./data/overlays-definition-collection');
var MapcapsCollection = require('./data/mapcaps-collection');
var PrivacyCollection = require('./components/modals/publish/privacy-collection');
var CreatePrivacyOptions = require('./components/modals/publish/create-privacy-options');
var UserGroupFetcher = require('./data/users-group-fetcher');
var State = require('./data/state-definition-model');
var LegendDefinitionsCollection = require('./data/legends/legend-definitions-collection');
var LegendsState = require('./data/legends/legends-state');
var LegendFactory = require('./editor/layers/layer-content-views/legend/legend-factory');
var EditorVisualizationWarningView = require('./components/modals/editor-visualization-warning/editor-visualization-warning-view');
var MapModeModel = require('./map-mode-model');
var BuilderActivatedNotification = require('./components/onboardings/builder-activated/builder-activated-notification-view');
var NodeGeometryTracker = require('./node-geometry-tracker');
var WidgetsService = require('./editor/widgets/widgets-service');
var DataServicesApiCheck = require('./editor/layers/layer-content-views/analyses/analyses-quota/analyses-quota-info');

// JSON data passed from entry point (editor/visualizations/show.html):
var vizJSON = window.vizJSON;
var stateJSON = window.stateJSON;
var userData = window.userData;
var frontendConfig = window.frontendConfig;
var visualizationData = window.visualizationData;
var layersData = window.layersData;
var analysesData = window.analysesData;
var builderNotifications = window.builderNotifications;
var dashboardNotifications = window.dashboardNotifications;
var mapcapsData = window.mapcapsData;
var overlaysData = window.overlaysData;
var basemaps = window.basemaps;

var configModel = new ConfigModel(
  _.defaults(
    {
      base_url: userData.base_url,
      api_key: userData.api_key
    },
    frontendConfig
  )
);

DataServicesApiCheck.get(configModel).fetch();

var onboardingNotification = new UserNotifications(builderNotifications, {
  key: 'builder',
  configModel: configModel
});

var userModel = new UserModel(userData, {
  configModel: configModel
});

var editorModel = new EditorModel();

var visDefinitionModel = new VisDefinitionModel(visualizationData, {
  configModel: configModel
});
var modals = new ModalsServiceModel();
var onboardings = new OnboardingsServiceModel();
onboardings.editorModel = editorModel;

UserGroupFetcher.track({
  userModel: userModel,
  configModel: configModel,
  acl: visDefinitionModel.getPermissionModel().acl
});

var stateDefModel = new State({
  json: stateJSON
}, {
  visDefinitionModel: visDefinitionModel
});

var mapId = visualizationData.map_id;

var analysisDefinitionNodesCollection = new AnalysisDefinitionNodesCollection(null, {
  userModel: userModel,
  configModel: configModel,
  relatedTableData: visualizationData.related_tables
});

var layerDefinitionsCollection = new LayerDefinitionsCollection(null, {
  configModel: configModel,
  userModel: userModel,
  analysisDefinitionNodesCollection: analysisDefinitionNodesCollection,
  mapId: mapId,
  stateDefinitionModel: stateDefModel
});

var analysisDefinitionsCollection = new AnalysisDefinitionsCollection(analysesData, {
  configModel: configModel,
  analysisDefinitionNodesCollection: analysisDefinitionNodesCollection,
  layerDefinitionsCollection: layerDefinitionsCollection,
  vizId: visDefinitionModel.id
});

layerDefinitionsCollection.resetByLayersData(layersData);

// Track geometry changes over any node definition model
NodeGeometryTracker.track({
  analysisDefinitionsCollection: analysisDefinitionsCollection,
  analysisDefinitionNodesCollection: analysisDefinitionNodesCollection,
  layerDefinitionsCollection: layerDefinitionsCollection
});

var widgetDefinitionsCollection = new WidgetDefinitionsCollection(null, {
  configModel: configModel,
  mapId: mapId,
  layerDefinitionsCollection: layerDefinitionsCollection
});

vizJSON.widgets.forEach(function (d) {
  widgetDefinitionsCollection.add(d);
});

var legendDefinitionsCollection = new LegendDefinitionsCollection(null, {
  configModel: configModel,
  layerDefinitionsCollection: layerDefinitionsCollection,
  vizId: visDefinitionModel.id
});
legendDefinitionsCollection.resetByData(vizJSON);
LegendFactory.init(legendDefinitionsCollection);
LegendsState.init(layerDefinitionsCollection, legendDefinitionsCollection);

Notifier.init({
  editorModel: editorModel,
  visDefinitionModel: visDefinitionModel
});

MetricsTracker.init({
  userId: userModel.get('id'),
  visId: visDefinitionModel.get('id'),
  configModel: configModel
});

BuilderOnboardingLauncher.init({
  onboardings: onboardings,
  userModel: userModel,
  editorModel: editorModel,
  onboardingNotification: onboardingNotification
});

AnalysesService.init({
  onboardings: onboardings,
  layerDefinitionsCollection: layerDefinitionsCollection,
  modals: modals,
  userModel: userModel,
  configModel: configModel
});

var userActions = UserActions({
  userModel: userModel,
  analysisDefinitionsCollection: analysisDefinitionsCollection,
  analysisDefinitionNodesCollection: analysisDefinitionNodesCollection,
  layerDefinitionsCollection: layerDefinitionsCollection,
  widgetDefinitionsCollection: widgetDefinitionsCollection
});

var privacyOptions = CreatePrivacyOptions(visDefinitionModel, userModel);
var privacyCollection = new PrivacyCollection(privacyOptions);

var mapcapsCollection = new MapcapsCollection(mapcapsData, {
  visDefinitionModel: visDefinitionModel
});

var backgroundPollingModel = new BackgroundPollingModel({
  importsPolling: false
}, {
  configModel: configModel,
  userModel: userModel,
  userActions: userActions
});

ImporterManager.init({
  pollingModel: backgroundPollingModel,
  createVis: false,
  userModel: userModel,
  configModel: configModel,
  modals: modals
});

var mapDefModel = new MapDefinitionModel(
  _.extend(
    vizJSON,
    {
      id: visualizationData.map_id
    }
  ),
  {
    parse: true,
    configModel: configModel,
    userModel: userModel,
    layerDefinitionsCollection: layerDefinitionsCollection
  }
);

var overlaysCollection = new OverlaysCollection(overlaysData, {
  configModel: configModel,
  visId: visDefinitionModel.id
});

var mapModeModel = new MapModeModel();

WidgetsService.init({
  widgetDefinitionsCollection: widgetDefinitionsCollection,
  analysisDefinitionNodesCollection: analysisDefinitionNodesCollection,
  layerDefinitionsCollection: layerDefinitionsCollection,
  userActions: userActions,
  modals: modals
});

var mapCreation = function () {
  BuilderOnboardingLauncher.launch();

  if (!configModel.get('cartodb_com_hosted')) {
    if (userModel.get('actions').builder_enabled && userModel.get('show_builder_activated_message') &&
        _.isEmpty(dashboardNotifications)) {
      var builderActivatedNotification = new UserNotifications(dashboardNotifications, {
        key: 'dashboard',
        configModel: configModel
      });

      var builderActivatedNotificationView = new BuilderActivatedNotification({
        builderActivatedNotification: builderActivatedNotification
      });

      $('.js-editor').addClass('Editor--topBar');
      builderActivatedNotificationView.bind('clean', function () {
        $('.js-editor').removeClass('Editor--topBar');
      }, this);
    }
  }

  deepInsights.createDashboard('#dashboard', vizJSON, {
    apiKey: configModel.get('api_key'),
    no_cdn: false,
    cartodb_logo: false,
    renderMenu: false,
    show_empty_infowindow_fields: true,
    state: stateJSON,
    interactiveFeatures: true,
    layerSelectorEnabled: false
  }, function (error, dashboard) {
    if (error) {
      console.error('Dashboard has some errors:\n', error);
    }

    var vis = dashboard.getMap();
    var dashboardView = dashboard.getView();

    dashboardView.listenTo(editorModel, 'change:edition', function (m) {
      dashboardView.$el.toggleClass('is-dark', m.isEditing());
    });

    var styleManager = new StyleManager(layerDefinitionsCollection, vis.map, configModel);

    var editFeatureOverlay = new EditFeatureOverlay({
      map: vis.map,
      mapModeModel: mapModeModel,
      modals: modals
    });
    editFeatureOverlay.hide();
    vis.addCustomOverlay(editFeatureOverlay);

    var deepInsightsIntegrations = new DeepInsightsIntegrations({
      onboardings: onboardings,
      userModel: userModel,
      deepInsightsDashboard: dashboard,
      analysisDefinitionsCollection: analysisDefinitionsCollection,
      analysisDefinitionNodesCollection: analysisDefinitionNodesCollection,
      layerDefinitionsCollection: layerDefinitionsCollection,
      legendDefinitionsCollection: legendDefinitionsCollection,
      widgetDefinitionsCollection: widgetDefinitionsCollection,
      overlayDefinitionsCollection: overlaysCollection,
      overlaysCollection: overlaysCollection,
      visDefinitionModel: visDefinitionModel,
      mapDefinitionModel: mapDefModel,
      stateDefinitionModel: stateDefModel,
      mapModeModel: mapModeModel,
      configModel: configModel,
      editorModel: editorModel,
      editFeatureOverlay: editFeatureOverlay
    });

    // Expose things after Map initialization
    window.deepInsightsIntegrations = deepInsightsIntegrations;
    window.styleManager = styleManager;
    window.dashboard = dashboard;
    window.vis = vis;
  });
};

if (visDefinitionModel.get('version') === 2 && modals) {
  visDefinitionModel.bind('change:version', function () {
    mapcapsCollection.fetch();
    mapCreation();
  }, this);

  modals.create(function (modalModel) {
    return new EditorVisualizationWarningView({
      modalModel: modalModel,
      visDefinitionModel: visDefinitionModel
    });
  }, true);
} else {
  mapCreation();
}

var editorTabPaneView = createEditorMenuTabPane([
  {
    icon: 'pencil',
    selected: true,
    createContentView: function () {
      editorModel.set({settingsView: false});
      return new EditorMapView({
        basemaps: basemaps,
        userActions: userActions,
        configModel: configModel,
        userModel: userModel,
        editorModel: editorModel,
        pollingModel: backgroundPollingModel,
        mapDefinitionModel: mapDefModel,
        onboardings: onboardings,
        modals: modals,
        visDefinitionModel: visDefinitionModel,
        layerDefinitionsCollection: layerDefinitionsCollection,
        analysisDefinitionNodesCollection: analysisDefinitionNodesCollection,
        widgetDefinitionsCollection: widgetDefinitionsCollection,
        mapcapsCollection: mapcapsCollection,
        privacyCollection: privacyCollection,
        legendDefinitionsCollection: legendDefinitionsCollection,
        mapModeModel: mapModeModel,
        stateDefinitionModel: stateDefModel,
        onboardingNotification: onboardingNotification
      });
    }
  }, {
    icon: 'settings',
    createContentView: function () {
      editorModel.set({settingsView: true});
      return new SettingsView({
        mapDefinitionModel: mapDefModel,
        overlaysCollection: overlaysCollection,
        mapcapsCollection: mapcapsCollection,
        visDefinitionModel: visDefinitionModel,
        privacyCollection: privacyCollection,
        configModel: configModel,
        userModel: userModel,
        modals: modals,
        editorModel: editorModel,
        settingsCollection: new Backbone.Collection(SettingsOptions(overlaysCollection, mapDefModel, userModel)),
        stateDefinitionModel: stateDefModel
      });
    }
  }
], {
  tabPaneOptions: {
    className: 'Editor-wrapper',
    template: editorPaneTemplate,
    url: userModel.get('base_url'),
    avatar_url: userModel.get('avatar_url'),
    tabPaneItemOptions: {
      tagName: 'li',
      className: 'EditorMenu-navigationItem'
    }
  },
  tabPaneItemIconOptions: {
    tagName: 'button',
    template: editorPaneIconItemTemplate,
    className: 'EditorMenu-navigationLink'
  }
});

$('.js-editor').prepend(editorTabPaneView.render().$el);

editorTabPaneView.listenTo(editorModel, 'change:edition', function (m) {
  editorTabPaneView.$('.Editor-panelWrapper').toggleClass('is-larger', m.isEditing());
});
editorTabPaneView.add_related_model(editorModel);

if (!configModel.get('cartodb_com_hosted')) {
  var feedbackView = new FeedbackButtonView({ modals: modals });
  $('.js-editorMenu').append(feedbackView.render().el);
}

document.title = visDefinitionModel.get('name') + ' | CARTO';

if (window.__backboneAgent) {
  window.__backboneAgent.handleBackbone(Backbone);
}

// Expose the root stuff to be able to inspect and modify state from
// developer console (before views)
window.configModel = configModel;
window.modals = modals;
window.onboardings = onboardings;
window.userActions = userActions;
window.userModel = userModel;
window.viewFactory = viewFactory;
window.visDefinitionModel = visDefinitionModel;
window.layerDefinitionsCollection = layerDefinitionsCollection;
window.widgetDefinitionsCollection = widgetDefinitionsCollection;
window.analysisDefinitionsCollection = analysisDefinitionsCollection;
window.analysisDefinitionNodesCollection = analysisDefinitionNodesCollection;
window.legendDefinitionsCollection = legendDefinitionsCollection;
window.editorModel = editorModel;
window.mapDefModel = mapDefModel;
window.overlaysCollection = overlaysCollection;
window.mapcapsCollection = mapcapsCollection;
window.stateDefModel = stateDefModel;

},{"../../locale/index":1125,"./components/background-importer/background-importer":5,"./components/metrics/metrics-tracker":233,"./components/modals/editor-visualization-warning/editor-visualization-warning-view":406,"./components/modals/modals-service-model":421,"./components/modals/publish/create-privacy-options":422,"./components/modals/publish/privacy-collection":423,"./components/notifier/notifier":475,"./components/onboardings/builder-activated/builder-activated-notification-view":496,"./components/onboardings/builder/launcher":500,"./components/onboardings/onboardings-service-model":514,"./components/tab-pane/create-editor-menu-tab-pane":534,"./components/view-factory":594,"./data/analysis-definition-nodes-collection":603,"./data/analysis-definitions-collection":604,"./data/config-model":618,"./data/editor-background-polling-model":623,"./data/editor-model":624,"./data/layer-definitions-collection":635,"./data/legends/legend-definitions-collection":644,"./data/legends/legends-state":646,"./data/map-definition-model":647,"./data/map-settings":648,"./data/mapcaps-collection":649,"./data/overlays-definition-collection":652,"./data/state-definition-model":660,"./data/user-actions":669,"./data/user-model":671,"./data/user-notifications":672,"./data/users-group-fetcher":674,"./data/vis-definition-model":675,"./data/widget-definitions-collection":681,"./deep-insights-integration/edit-feature-overlay":683,"./deep-insights-integrations":689,"./editor/editor-map-view":702,"./editor/editor-pane-icon.tpl":703,"./editor/editor-pane.tpl":705,"./editor/editor-settings-view":707,"./editor/feedback/feedback-button-view":719,"./editor/layers/layer-content-views/analyses/analyses-quota/analyses-quota-info":796,"./editor/layers/layer-content-views/analyses/analyses-service.js":800,"./editor/layers/layer-content-views/legend/legend-factory":961,"./editor/style/style-manager":1051,"./editor/widgets/widgets-service":1085,"./map-mode-model":1103,"./node-geometry-tracker":1117,"backbone":"backbone","cartodb-deep-insights.js":"cartodb-deep-insights.js","jquery":"jquery","node-polyglot":"node-polyglot","underscore":"underscore"}],691:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--grid u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="24px" height="24px" viewbox="459 348 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <g id="Export-dataset" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(459.000000, 348.000000)">\n          <path d="M1,1 L11,1 L11,5.5 C11,5.776 11.224,6 11.5,6 L16,6 L16,9.5 L17,9.5 L17,5.502 C17,5.502 17,5.502 17,5.501 C17,5.5 17,5.501 17,5.5 C17,5.447 16.985,5.398 16.97,5.35 C16.966,5.337 16.967,5.323 16.962,5.311 C16.936,5.247 16.896,5.19 16.847,5.142 L11.854,0.147 C11.808,0.101 11.753,0.064 11.692,0.039 C11.632,0.014 11.567,0 11.5,0 L0.5,0 C0.224,0 0,0.224 0,0.5 L0,21.5 C0,21.776 0.224,22 0.5,22 L10.5,22 L10.5,21 L1,21 L1,1 L1,1 Z M12,1.708 L15.291,5 L12,5 L12,1.708 L12,1.708 Z" id="Shape" fill="#2E3C43"/>\n          <path d="M17.5,11 C13.916,11 11,13.916 11,17.5 C11,21.084 13.916,24 17.5,24 C21.084,24 24,21.084 24,17.5 C24,13.916 21.084,11 17.5,11 L17.5,11 Z M17.5,23 C14.467,23 12,20.533 12,17.5 C12,14.467 14.467,12 17.5,12 C20.533,12 23,14.467 23,17.5 C23,20.533 20.533,23 17.5,23 L17.5,23 Z" id="Shape" fill="#2E3C43"/>\n          <path d="M17.858,14.425 C17.767,14.331 17.641,14.272 17.5,14.272 C17.359,14.272 17.232,14.331 17.142,14.425 L14.965,16.602 C14.77,16.797 14.77,17.114 14.965,17.309 C15.16,17.504 15.477,17.504 15.672,17.309 L17,15.981 L17,20.226 C17,20.502 17.224,20.726 17.5,20.726 C17.776,20.726 18,20.502 18,20.226 L18,15.981 L19.328,17.309 C19.426,17.407 19.554,17.455 19.682,17.455 C19.81,17.455 19.938,17.406 20.036,17.309 C20.231,17.114 20.231,16.797 20.036,16.602 L17.858,14.425 L17.858,14.425 Z" id="Shape" fill="#2E3C43" transform="translate(17.500500, 17.499000) scale(1, -1) translate(-17.500500, -17.499000) "/>\n        </g>\n      </svg>\n    </div>\n    <div>\n      <h2 class=" CDB-Text CDB-Size-huge is-light u-bSpace--xl">'+
((__t=( _t('editor.maps.export.confirmation.title', { name: name }) ))==null?'':_.escape(__t))+
'</h2>\n      <p class="CDB-Text CDB-Size-large u-altTextColor">'+
((__t=( _t('editor.maps.export.confirmation.desc') ))==null?'':_.escape(__t))+
'</p>\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n               '+
((__t=( _t('editor.maps.export.confirmation.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('editor.maps.export.confirmation.confirm') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],692:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Dialog-header">\n  <div class="Dialog-headerIcon Dialog-headerIcon--neutral">\n    <i class="CDB-IconFont CDB-IconFont-download"></i>\n  </div>\n  <h2 class="CDB-Text CDB-Size-large u-bSpace">\n    '+
((__t=( _t('editor.maps.export.download.title') ))==null?'':_.escape(__t))+
'\n  </h2>\n  <h3 class="CDB-Text CDB-Size-medium u-altTextColor">\n    '+
((__t=( _t('editor.maps.export.download.tip') ))==null?'':_.escape(__t))+
'</br>\n    '+
((__t=( _t('editor.maps.export.download.desc') ))==null?'':_.escape(__t))+
'\n  </h3>\n</div>\n<div class="Dialog-footer--simple u-inner">\n  <button class="CDB-Button CDB-Button--primary u-tSpace--m js-download">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n      '+
((__t=( _t('editor.maps.export.download.confirm') ))==null?'':_.escape(__t))+
'\n    </span>\n  </button>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],693:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var $ = require('jquery');
var _ = require('underscore');
var renderLoading = require('../../../../components/loading/render-loading.js');
var templateExportMapConfirmation = require('../../../components/modals/export-map/export-map-confirmation.tpl');
var templateExportMapDownload = require('../../../components/modals/export-map/export-map-download.tpl');
var ErrorView = require('../../../../components/error/error-view.js');

var ENTER_KEY_CODE = 13;
var REQUIRED_OPTS = [
  'renderOpts',
  'modalModel',
  'exportMapModel'
];

module.exports = CoreView.extend({
  className: 'Dialog-content',

  events: {
    'click .js-confirm': '_onConfirm',
    'click .js-cancel': '_onCancel',
    'click .js-download': '_download'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this._onKeyDown = this._onKeyDown.bind(this);
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();

    var state = this._exportMapModel.get('state');

    if (state === 'complete') {
      this._renderCompleteView();
    } else if (state === 'pending' || state === 'exporting' || state === 'uploading') {
      this._renderLoadingView(state);
    } else if (state === 'failure') {
      this._renderFailureView();
    } else {
      this._renderConfirmationView();
    }
  },

  _renderCompleteView: function () {
    var w = window.open(this._exportMapModel.get('url'));

    // If w is nullish, popup was blocked: we show a "click to download" modal. Else, download has started.
    if (w == null) {
      this.$el.html(templateExportMapDownload());
    } else {
      w.focus();
      this._modalModel.destroy();
    }
  },

  _renderLoadingView: function (state) {
    var loadingTitle = state.charAt(0).toUpperCase() + state.slice(1) + ' ...';

    this.$el.html(
      renderLoading({
        title: loadingTitle
      })
    );
  },

  _renderFailureView: function () {
    var errorView = new ErrorView({
      title: _t('editor.maps.export.error.title'),
      desc: _t('editor.maps.export.error.desc')
    });

    this.$el.html(errorView.render().el);
  },

  _renderConfirmationView: function () {
    this.$el.html(
      templateExportMapConfirmation({
        name: this._renderOpts.name
      })
    );
  },

  _initBinds: function () {
    $(document).bind('keydown', this._onKeyDown);

    this._exportMapModel.bind('change:state', function () {
      this.render();
    }, this);
  },

  _disableBinds: function () {
    $(document).unbind('keydown', this._onKeyDown);
  },

  _onKeyDown: function (ev) {
    var keyCode = ev.which;
    if (keyCode === ENTER_KEY_CODE) {
      this._onConfirm();
    }
  },

  _onConfirm: function () {
    this._exportMapModel.requestExport();
  },

  _onCancel: function () {
    this._exportMapModel.cancelExport();

    this._modalModel.destroy();
  },

  _download: function () {
    window.open(this._exportMapModel.get('url'));
    window.focus();

    this._modalModel.destroy();
  },

  clean: function () {
    this._disableBinds();
    CoreView.prototype.clean.apply(this);
  }
});

},{"../../../../components/error/error-view.js":67,"../../../../components/loading/render-loading.js":230,"../../../components/modals/export-map/export-map-confirmation.tpl":691,"../../../components/modals/export-map/export-map-download.tpl":692,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],694:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./overlay.tpl');

module.exports = CoreView.extend({
  initialize: function (opts) {
    if (!opts.overlayModel) throw new Error('overlayModel is required');
    this.overlayModel = opts.overlayModel;
    this._initBinds();
  },

  render: function () {
    this.$el.empty();
    this.$el.append(template({
      visible: !this.overlayModel.get('visible') ? 'is-hidden' : ''
    }));
    return this;
  },

  _initBinds: function () {
    this.listenTo(this.overlayModel, 'change:visible', this.render);
    this.add_related_model(this.overlayModel);
  }
});

},{"./overlay.tpl":695,"backbone/core-view":1127}],695:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Disable-overlay '+
((__t=( visible ))==null?'':_.escape(__t))+
'"></div>';
}
return __p;
};

},{"underscore":"underscore"}],696:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--grid u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="24px" height="25px" viewbox="521 436 24 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <path d="M524.5,440 L540.5,440 L540.5,460 L524.5,460 L524.5,440 Z M528.5,437 L536.5,437 L536.5,440 L528.5,440 L528.5,437 Z M522,440 L544,440 L522,440 Z M528.5,443.5 L528.5,455.5 L528.5,443.5 Z M532.5,443.5 L532.5,455.5 L532.5,443.5 Z M536.5,443.5 L536.5,455.5 L536.5,443.5 Z" id="Shape" stroke="#F19243" stroke-width="1" fill="none"/>\n      </svg>\n    </div>\n    <div>\n      <h2 class=" CDB-Text CDB-Size-huge is-light u-bSpace--xl">\n     '+
((__t=( _t('editor.maps.delete.title', { name: name }) ))==null?'':_.escape(__t))+
'</h2>\n      <p class="CDB-Text CDB-Size-large u-altTextColor">'+
((__t=( _t('editor.maps.delete.desc') ))==null?'':_.escape(__t))+
'</p>\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('editor.maps.delete.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('editor.maps.delete.confirm') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],697:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var template = require('./editor-header.tpl');
var moment = require('moment');
var ConfirmationView = require('../components/modals/confirmation/modal-confirmation-view');
var EditMetadataView = require('../components/modals/map-metadata/map-metadata-view');
var templateConfirmation = require('./delete-map-confirmation.tpl');
var ExportView = require('./components/modals/export-map/modal-export-map-view');
var ExportMapModel = require('../data/export-map-definition-model.js');
var removeMap = require('./map-operations/remove-map');
var renameMap = require('./map-operations/rename-map');
var InlineEditorView = require('../components/inline-editor/inline-editor-view');
var templateInlineEditor = require('./inline-editor.tpl');
var CreationModalView = require('../components/modals/creation/modal-creation-view');
var VisDefinitionModel = require('../data/vis-definition-model');
var errorParser = require('../helpers/error-parser');
var ShareWith = require('../components/modals/publish/share-with-view');
var ContextMenuFactory = require('../components/context-menu-factory-view');

module.exports = CoreView.extend({
  events: {
    'click .js-privacy': '_onClickPrivacy'
  },

  initialize: function (opts) {
    if (!opts.editorModel) throw new Error('editorModel is required');
    if (!opts.modals) throw new Error('modals is required');
    if (!opts.visDefinitionModel) throw new Error('visDefinitionModel is required');
    if (!opts.privacyCollection) throw new Error('privacyCollection is required');
    if (!opts.onClickPrivacy) throw new Error('onClickPrivacy is required');
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.userModel) throw new Error('userModel is required');

    this._userModel = opts.userModel;
    this._editorModel = opts.editorModel;
    this._configModel = opts.configModel;
    this._modals = opts.modals;
    this._visDefinitionModel = opts.visDefinitionModel;
    this._title = this._visDefinitionModel.get('name');
    this._privacyCollection = opts.privacyCollection;
    this._mapcapsCollection = opts.mapcapsCollection;

    _.bind(this._changeStyle, this);
    this._bindEvents();
  },

  render: function () {
    var model = this._privacyCollection.searchByPrivacy(this._visDefinitionModel.get('privacy'));
    var published = this._mapcapsCollection.length > 0
                    ? _t('editor.published', { when: moment(this._mapcapsCollection.first().get('created_at')).fromNow() })
                    : _t('editor.unpublished');
    this.$el.html(
      template({
        title: this._title,
        privacy: model.get('privacy'),
        cssClass: model.get('cssClass'),
        avatar: this._userModel.get('avatar_url'),
        isSimple: !this._userModel.isInsideOrg(),
        published: published
      })
    );

    this._initViews();
    return this;
  },

  _initViews: function () {
    var self = this;
    this._inlineEditor = new InlineEditorView({
      template: templateInlineEditor,
      renderOptions: {
        name: self._visDefinitionModel.get('name')
      },
      onEdit: self._renameMap.bind(self)
    });

    this.$('.js-header').append(this._inlineEditor.render().el);
    this.addView(this._inlineEditor);

    var shareWith = new ShareWith({
      visDefinitionModel: this._visDefinitionModel,
      userModel: this._userModel,
      action: this._onClickPrivacy.bind(this),
      separationClass: 'u-rSpace--m'
    });

    this.$('.js-share-users').append(shareWith.render().el);
    this.addView(shareWith);

    var menuItems = [{
      label: _t('editor.maps.options.rename'),
      val: 'rename-map',
      action: this._onRenameMap.bind(this)
    }, {
      label: _t('editor.maps.options.duplicate'),
      val: 'duplicate-map',
      action: this._duplicateMap.bind(this)
    }, {
      label: _t('editor.maps.options.edit-metadata'),
      val: 'metadata-map',
      action: this._editMetadata.bind(this)
    }, {
      label: _t('editor.maps.options.export-map'),
      val: 'export-map',
      action: this._exportMap.bind(this)
    }, {
      label: _t('editor.maps.options.export-image'),
      val: 'export-image',
      action: this._exportImage.bind(this)
    }, {
      label: _t('editor.maps.options.remove'),
      val: 'delete-map',
      destructive: true,
      action: this._confirmDeleteLayer.bind(this)
    }];

    this._contextMenuFactory = new ContextMenuFactory({
      menuItems: menuItems
    });

    this.$('.js-context-menu').append(this._contextMenuFactory.render().el);
    this.addView(this._contextMenuFactory);
  },

  _bindEvents: function () {
    this.listenTo(this._visDefinitionModel, 'change:privacy change:name', this.render);
    this.add_related_model(this._visDefinitionModel);

    this.listenTo(this._editorModel, 'change:edition', this._changeStyle);
    this.add_related_model(this._editorModel);

    this._mapcapsCollection.on('add reset', this.render, this);
    this._mapcapsCollection.on('change:status', this.render, this);
    this.add_related_model(this._mapcapsCollection);
  },

  _renameMap: function () {
    var newName = this._inlineEditor.getValue();

    if (newName !== '' && newName !== this._visDefinitionModel.get('name')) {
      // Speed!
      this._onRenameSuccess(newName);

      renameMap({
        newName: newName,
        visDefinitionModel: this._visDefinitionModel,
        onError: this._onRenameError.bind(this)
      });
    }
  },

  _onRenameMap: function () {
    this._inlineEditor.edit();
  },

  _duplicateMap: function () {
    var self = this;
    var mapName = this._visDefinitionModel.get('name');

    this._modals.create(function (modalModel) {
      return new CreationModalView({
        modalModel: modalModel,
        loadingTitle: _t('editor.maps.duplicate.loading', { name: mapName }),
        errorTitle: _t('editor.maps.duplicate.error', { name: mapName }),
        runAction: function (opts) {
          var newVisModel = new VisDefinitionModel({
            name: mapName
          }, {
            configModel: self._configModel
          });

          newVisModel.save({
            source_visualization_id: self._visDefinitionModel.get('id')
          }, {
            success: function (visModel) {
              window.location = visModel.builderURL();
            },
            error: function (mdl, e) {
              opts.error && opts.error(errorParser(e));
            }
          });
        }
      });
    });
  },

  _confirmDeleteLayer: function () {
    var self = this;
    var mapName = this._visDefinitionModel.get('name');

    this._modals.create(function (modalModel) {
      return new ConfirmationView({
        modalModel: modalModel,
        template: templateConfirmation,
        loadingTitle: _t('editor.maps.delete.loading', {name: mapName}),
        renderOpts: {
          name: mapName
        },
        runAction: function () {
          removeMap({
            onSuccess: self._onSuccessDestroyMap.bind(self, modalModel),
            onError: self._onErrorDestroyMap.bind(self, modalModel),
            visDefinitionModel: self._visDefinitionModel
          });
        }
      });
    });
  },

  _exportMap: function () {
    var mapName = this._visDefinitionModel.get('name');
    var visID = this._visDefinitionModel.get('id');

    var exportMapModel = new ExportMapModel({
      visualization_id: visID
    }, {
      configModel: this._configModel
    });

    this._modals.create(function (modalModel) {
      return new ExportView({
        modalModel: modalModel,
        exportMapModel: exportMapModel,
        renderOpts: {
          name: mapName
        }
      });
    });
  },

  _exportImage: function () {
    this.trigger('export-image', this);
  },

  _editMetadata: function () {
    var self = this;

    this._modals.create(function (modalModel) {
      return new EditMetadataView({
        modalModel: modalModel,
        visDefinitionModel: self._visDefinitionModel
      });
    });
  },

  _onSuccessDestroyMap: function (modal) {
    this.options.onRemoveMap && this.options.onRemoveMap();
  },

  _onErrorDestroyMap: function (modal) {
    modal.destroy();
  },

  _onRenameSuccess: function (newName) {
    this.$('.js-title').text(newName).show();
    this._inlineEditor.hide();
  },

  _onRenameError: function (oldName) {
    this.$('.js-title').text(oldName).show();
    this._inlineEditor.hide();
  },

  _changeStyle: function (m) {
    this._getTitle().toggleClass('is-dark', m.isEditing());
  },

  _getTitle: function () {
    return this.$('.Editor-HeaderInfo');
  },

  _onClickPrivacy: function () {
    this.options.onClickPrivacy && this.options.onClickPrivacy();
  }
});

},{"../components/context-menu-factory-view":37,"../components/inline-editor/inline-editor-view":223,"../components/modals/confirmation/modal-confirmation-view":404,"../components/modals/creation/modal-creation-view":405,"../components/modals/map-metadata/map-metadata-view":415,"../components/modals/publish/share-with-view":439,"../data/export-map-definition-model.js":625,"../data/vis-definition-model":675,"../helpers/error-parser":1090,"./components/modals/export-map/modal-export-map-view":693,"./delete-map-confirmation.tpl":696,"./editor-header.tpl":698,"./inline-editor.tpl":722,"./map-operations/remove-map":1003,"./map-operations/rename-map":1004,"backbone/core-view":1127,"moment":"moment","underscore":"underscore"}],698:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfoEditor">\n  <div class="Editor-HeaderInfo-inner Editor-HeaderInfo-inner--wide">\n    <div class="Editor-HeaderInfo-title u-bSpace--m js-context-menu">\n      <div class="Editor-HeaderInfo-titleText u-bSpace js-header">\n      </div>\n    </div>\n    <div class="u-bSpace--xl u-flex u-alignCenter">\n      <button class="u-rSpace--m u-actionTextColor js-privacy">\n        <i class="Tag Tag-fill Tag-fill--'+
((__t=( cssClass ))==null?'':_.escape(__t))+
' CDB-Text CDB-Size-small u-upperCase">'+
((__t=( privacy ))==null?'':_.escape(__t))+
'</i>\n      </button>\n      ';
 if (!isSimple) { 
__p+='\n      <div class="js-share-users"></div>\n      ';
 } 
__p+='\n      <p class="Editor-HeaderInfo-publishDate u-ellipsis CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( published ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],699:[function(require,module,exports){
module.exports = [{
  keywords: 'buffer-size',
  type: 'Map'
}, {
  keywords: 'marker-fill marker-width marker-fill-opacity marker-opacity marker-line-color marker-line-width marker-line-opacity marker-comp-op marker-allow-overlap marker-file marker-type marker-height marker-width marker-transform marker-placement marker-ignore-placement marker-spacing marker-avoid-edges point-file point-opacity point-comp-op point-allow-overlap point-placement point-ignore-placement point-transform',
  type: 'Points'
}, {
  keywords: 'line-color line-width line-opacity line-comp-op line-pattern-file line-join line-cap line-dasharray line-dash-offset line-offset line-simplify line-simplify-algorithm line-smooth line-clip',
  type: 'Lines'
}, {
  keywords: 'polygon-fill polygon-opacity polygon-comp-op polygon-pattern-file polygon-pattern-alignment polygon-pattern-opacity polygon-smooth polygon-simplify polygon-simplify-algorithm polygon-gamma polygon-gamma-method polygon-geometry-transform polygon-clip',
  type: 'Polygons'
}, {
  keywords: 'text-name text-face-name text-size text-fill text-opacity text-comp-op text-halo-radius text-halo-fill text-halo-rasterizer text-allow-overlap text-transform text-placement text-placement-type text-dx text-dy text-wrap-width text-wrap-before text-character-spacing text-line-spacing text-min-distance text-avoid-edges text-orientation text-vertical-alignment',
  type: 'Text'
}, {
  keywords: 'building-fill building-fill-opacity building-height',
  type: 'Building'
}, {
  keywords: 'shield-name shield-face-name shield-size shield-file shield-fill shield-opacity shield-text-opacity shield-allow-overlap shield-placements shield-placement-type shield-dy shield-dx shield-text-dx shield-text-dy shield-min-distance shield-avoid-edges',
  type: 'Shield'
}, {
  keywords: 'image-filters comp-op opacity',
  type: ''
}];

},{}],700:[function(require,module,exports){
var _ = require('underscore');
var TableNameUtils = require('../../helpers/table-name-utils');

var memo = {};

var OPTIONAL_OPTS = [
  'querySchemaModel',
  'layerDefinitionModel',
  'tokens'
];

var defaults = {
  tableName: true,
  columnsName: true,
  keywords: true
};

module.exports = {
  init: function (opts) {
    if (!opts) throw new Error('options are required for hints');

    this.options = _.defaults(
      _.pick(opts, ['tableName', 'columnsName', 'keywords'])
      , defaults
    );

    _.each(OPTIONAL_OPTS, function (item) {
      this['_' + item] = opts[item];
    }, this);
  },

  hints: function () {
    // array of objects {text, type}
    return this.hints;
  },

  reset: function () {
    this.hints = _.union(this._getTableName(), this._getColumns(), this._getKeywords());
    return this;
  },

  _getKeywords: function () {
    if (this.options.keywords) {
      return this._tokens && this._memo(this._tokens);
    } else {
      return [];
    }
  },

  _getColumns: function () {
    if (!this.options.columnsName) {
      return [];
    }

    var columns = this._querySchemaModel.columnsCollection;
    return columns.map(function (mdl) {
      var columnName = mdl.get('name');
      return {
        text: columnName,
        type: 'Column_name'
      };
    });
  },

  _getTableName: function () {
    if (!this.options.tableName) {
      return [];
    }

    var tableName = this._layerDefinitionModel.getTableName();
    tableName = TableNameUtils.getUnqualifiedName(tableName);
    return [{
      text: tableName,
      type: 'Table_name'
    }];
  },

  _memo: function (str, type) {
    if (str in memo) {
      return memo[str];
    } else {
      return (memo[str] = this._make(str, type));
    }
  },

  _make: function (str, type) {
    return _.chain(str).map(function (set) {
      return set.keywords.split(' ').map(function (item) {
        return {
          text: item,
          type: set.type
        };
      });
    }).flatten().value();
  }
};

},{"../../helpers/table-name-utils":1101,"underscore":"underscore"}],701:[function(require,module,exports){
module.exports = [{
  keywords: 'alter and as asc between by count create delete desc distinct drop from group having in insert into is join like not on or order select set table union update values where limit',
  type: 'Sql'
}, {
  keywords: 'ST_GeometryType ST_polygon ST_multipolygon ST_multilinestring ST_linestring ST_multipoint ST_point',
  type: 'Postgis'
}];

},{}],702:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var checkAndBuildOpts = require('../helpers/required-opts');
var EditorView = require('./editor-view');
var AnalysesService = require('./layers/layer-content-views/analyses/analyses-service');
var StackLayoutView = require('../components/stack-layout/stack-layout-view');
var BasemapContentView = require('./layers/basemap-content-view');
var LayerContentView = require('./layers/layer-content-view');
var EditFeatureContentView = require('./layers/edit-feature-content-view');
var WidgetsFormContentView = require('./widgets/widgets-form/widgets-form-content-view');
var Notifier = require('../components/notifier/notifier');
var WidgetsService = require('./widgets/widgets-service');

var REQUIRED_OPTS = [
  'userActions',
  'basemaps',
  'visDefinitionModel',
  'layerDefinitionsCollection',
  'analysisDefinitionNodesCollection',
  'legendDefinitionsCollection',
  'widgetDefinitionsCollection',
  'mapcapsCollection',
  'privacyCollection',
  'modals',
  'onboardings',
  'userModel',
  'configModel',
  'editorModel',
  'pollingModel',
  'mapDefinitionModel',
  'mapModeModel',
  'stateDefinitionModel',
  'onboardingNotification'
];

module.exports = CoreView.extend({
  className: 'MapEditor Editor-panel',

  events: {
    'click .js-add-analysis': '_onAddAnalysisClicked',
    'click .js-georeference': '_onGeoreferenceClicked'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._initBinds();
  },

  render: function () {
    var self = this;

    var stackViewCollection = new Backbone.Collection([{
      createStackView: function (stackLayoutModel, opts) {
        var selectedTabItem = opts[0] || 'layers';

        return new EditorView({
          className: 'Editor-content',
          modals: self._modals,
          userModel: self._userModel,
          userActions: self._userActions,
          configModel: self._configModel,
          editorModel: self._editorModel,
          pollingModel: self._pollingModel,
          mapDefinitionModel: self._mapDefinitionModel,
          visDefinitionModel: self._visDefinitionModel,
          layerDefinitionsCollection: self._layerDefinitionsCollection,
          analysisDefinitionNodesCollection: self._analysisDefinitionNodesCollection,
          widgetDefinitionsCollection: self._widgetDefinitionsCollection,
          mapcapsCollection: self._mapcapsCollection,
          privacyCollection: self._privacyCollection,
          mapStackLayoutModel: stackLayoutModel,
          selectedTabItem: selectedTabItem,
          mapModeModel: self._mapModeModel,
          stateDefinitionModel: self._stateDefinitionModel
        });
      }
    }, {
      createStackView: function (stackLayoutModel, opts) {
        var viewType = opts[1];

        switch (viewType) {
          case 'basemaps':
            return new BasemapContentView({
              className: 'Editor-content',
              basemaps: self._basemaps,
              layerDefinitionsCollection: self._layerDefinitionsCollection,
              stackLayoutModel: stackLayoutModel,
              customBaselayersCollection: self._userModel.layers,
              modals: self._modals,
              configModel: self._configModel
            });
          case 'layer-content':
            var layerDefinitionModel = opts[0];
            var selectedTabItem = opts[2];
            var analysisPayload = opts[3];

            return new LayerContentView({
              className: 'Editor-content',
              userActions: self._userActions,
              userModel: self._userModel,
              layerDefinitionModel: layerDefinitionModel,
              mapDefinitionModel: self._mapDefinitionModel,
              widgetDefinitionsCollection: self._widgetDefinitionsCollection,
              layerDefinitionsCollection: self._layerDefinitionsCollection,
              analysisDefinitionNodesCollection: self._analysisDefinitionNodesCollection,
              legendDefinitionsCollection: self._legendDefinitionsCollection,
              analysis: self._analysis,
              modals: self._modals,
              onboardings: self._onboardings,
              stackLayoutModel: stackLayoutModel,
              analysisPayload: analysisPayload,
              configModel: self._configModel,
              editorModel: self._editorModel,
              mapModeModel: self._mapModeModel,
              stateDefinitionModel: self._stateDefinitionModel,
              onboardingNotification: self._onboardingNotification,
              visDefinitionModel: self._visDefinitionModel,
              selectedTabItem: selectedTabItem
            });
          case 'widget-content':
            var widgetDefinitionModel = opts[0];
            var stackLayoutPrevStep = opts[1];

            return new WidgetsFormContentView({
              className: 'Editor-content',
              modals: self._modals,
              userModel: self._userModel,
              configModel: self._configModel,
              userActions: self._userActions,
              widgetDefinitionModel: widgetDefinitionModel,
              layerDefinitionsCollection: self._layerDefinitionsCollection,
              analysisDefinitionNodesCollection: self._analysisDefinitionNodesCollection,
              stackLayoutPrevStep: stackLayoutPrevStep,
              stackLayoutModel: stackLayoutModel
            });
          case 'element-content':
            console.log(viewType + 'view is not implemented yet');
            break;
          default:
            console.log(viewType + 'view doesn\'t exist');
        }
      }
    }, {
      createStackView: function (stackLayoutModel, opts) {
        var layerDefinitionModel = opts[0];
        var isValidGeometry = opts[1];

        return new EditFeatureContentView({
          layerDefinitionModel: layerDefinitionModel,
          configModel: self._configModel,
          stackLayoutModel: stackLayoutModel,
          mapModeModel: self._mapModeModel,
          editorModel: self._editorModel,
          model: new Backbone.Model({
            hasChanges: false,
            isValidAttributes: true,
            isValidGeometry: isValidGeometry
          }),
          modals: self._modals
        });
      }
    }]);

    this._stackLayoutView = new StackLayoutView({
      className: 'Editor-content',
      collection: stackViewCollection
    });

    this.$el.append(this._stackLayoutView.render().$el);
    this.addView(this._stackLayoutView);

    var notifierView = Notifier.getView();
    this.$el.append(notifierView.render().el);
    this.addView(notifierView);

    this._setServices();

    return this;
  },

  _setServices: function () {
    AnalysesService.setStackLayoutView(this._stackLayoutView);

    WidgetsService.setStackLayoutBehaviour(
      this._stackLayoutView.model,
      {
        position: 1,
        arguments: 'widget-content'
      }, {
        position: 0,
        arguments: 'widgets'
      }
    );
  },

  _initBinds: function () {
    this._editorModel.on('change:edition', this._changeStyle, this);
    this.add_related_model(this._editorModel);

    this._mapModeModel.on('change:mode', this._onMapModeChanged, this);
    this.add_related_model(this._mapModeModel);
  },

  _onMapModeChanged: function (mapModeModel) {
    var stackLayoutModel = this._stackLayoutView.model;

    if (mapModeModel.isEditingFeatureMode() || mapModeModel.isDrawingFeatureMode()) {
      var feature = mapModeModel.getFeatureDefinition();
      stackLayoutModel.goToStep(2, feature.getLayerDefinition(), !feature.isNew());
    } else {
      stackLayoutModel.goBack();
    }
  },

  _changeStyle: function () {
    this.$el.toggleClass('is-dark', this._editorModel.isEditing());
  },

  _onAddAnalysisClicked: function () {
    AnalysesService.addAnalysis();
  },

  _onGeoreferenceClicked: function () {
    AnalysesService.addGeoreferenceAnalysis();
  }

});

},{"../components/notifier/notifier":475,"../components/stack-layout/stack-layout-view":533,"../helpers/required-opts":1097,"./editor-view":709,"./layers/basemap-content-view":733,"./layers/edit-feature-content-view":770,"./layers/layer-content-view":792,"./layers/layer-content-views/analyses/analyses-service":800,"./widgets/widgets-form/widgets-form-content-view":1078,"./widgets/widgets-service":1085,"backbone":"backbone","backbone/core-view":1127}],703:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<i class="CDB-IconFont CDB-IconFont-'+
((__t=( icon ))==null?'':_.escape(__t))+
' EditorMenu-navigationIcon"></i>\n';
}
return __p;
};

},{"underscore":"underscore"}],704:[function(require,module,exports){
var $ = require('jquery');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var createTextLabelsTabPane = require('../components/tab-pane/create-text-labels-tab-pane');
var AddWidgetsView = require('../components/modals/add-widgets/add-widgets-view');
var AddLayerView = require('../components/modals/add-layer/add-layer-view');
var AddLayerModel = require('../components/modals/add-layer/add-layer-model');
var StackLayoutView = require('../components/stack-layout/stack-layout-view');
var Header = require('./editor-header.js');
var EditorTabPaneTemplate = require('./editor-tab-pane.tpl');
var EditorWidgetsView = require('./widgets/widgets-view');
var LayersView = require('./layers/layers-view');
var ScrollView = require('../components/scroll/scroll-view');
var PanelWithOptionsView = require('../components/view-options/panel-with-options-view');
var ShareButtonView = require('./layers/share-button-view');
var PublishView = require('../components/modals/publish/publish-view');
var checkAndBuildOpts = require('../helpers/required-opts');

var REQUIRED_OPTS = [
  'userActions',
  'modals',
  'configModel',
  'userModel',
  'editorModel',
  'pollingModel',
  'analysisDefinitionNodesCollection',
  'layerDefinitionsCollection',
  'privacyCollection',
  'widgetDefinitionsCollection',
  'mapcapsCollection',
  'visDefinitionModel',
  'mapStackLayoutModel',
  'stateDefinitionModel',
  'selectedTabItem'
];

module.exports = CoreView.extend({

  className: 'Editor-content',

  events: {
    'click .js-add': '_addItem'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._initModels();
    this._initBinds();
  },

  render: function () {
    var self = this;

    this.clearSubViews();
    this.$el.empty();

    var tabPaneTabs = [{
      name: 'layers',
      label: _t('editor.tab-pane.layers.title-label'),
      selected: this._selectedTabItem === 'layers',
      createContentView: function () {
        var layersStackViewCollection = new Backbone.Collection([{
          createStackView: function (stackLayoutModel, opts) {
            return new PanelWithOptionsView({
              className: 'Editor-content js-editorPanelContent',
              editorModel: self._editorModel,
              createContentView: function () {
                return new ScrollView({
                  createContentView: function () {
                    return new LayersView({
                      modals: self._modals,
                      userModel: self._userModel,
                      editorModel: self._editorModel,
                      configModel: self._configModel,
                      userActions: self._userActions,
                      layerDefinitionsCollection: self._layerDefinitionsCollection,
                      analysisDefinitionNodesCollection: self._analysisDefinitionNodesCollection,
                      stackLayoutModel: self._mapStackLayoutModel,
                      stateDefinitionModel: self._stateDefinitionModel,
                      widgetDefinitionsCollection: self._widgetDefinitionsCollection,
                      visDefinitionModel: self._visDefinitionModel
                    });
                  }
                });
              },
              createActionView: function () {
                return new ShareButtonView({
                  visDefinitionModel: self._visDefinitionModel,
                  onClickAction: self._share.bind(self)
                });
              }
            });
          }
        }]);

        return new StackLayoutView({
          className: 'Editor-content',
          collection: layersStackViewCollection
        });
      }
    }, {
      name: 'widgets',
      label: _t('editor.tab-pane.widgets.title-label'),
      selected: this._selectedTabItem === 'widgets',
      createContentView: function () {
        var widgetsStackViewCollection = new Backbone.Collection([{
          createStackView: function (stackLayoutModel, opts) {
            return new PanelWithOptionsView({
              className: 'Editor-content',
              editorModel: self._editorModel,
              createContentView: function () {
                return new ScrollView({
                  createContentView: function () {
                    return new EditorWidgetsView({
                      userActions: self._userActions,
                      modals: self._modals,
                      layerDefinitionsCollection: self._layerDefinitionsCollection,
                      widgetDefinitionsCollection: self._widgetDefinitionsCollection,
                      stackLayoutModel: self._mapStackLayoutModel
                    });
                  }
                });
              },
              createActionView: function () {
                return new ShareButtonView({
                  visDefinitionModel: self._visDefinitionModel,
                  onClickAction: self._share.bind(self)
                });
              }
            });
          }
        }]);

        return new StackLayoutView({
          className: 'Editor-content',
          collection: widgetsStackViewCollection
        });
      }
    }];

    var header = new Header({
      editorModel: self._editorModel,
      mapcapsCollection: self._mapcapsCollection,
      modals: self._modals,
      visDefinitionModel: self._visDefinitionModel,
      privacyCollection: self._privacyCollection,
      onClickPrivacy: self._share.bind(self),
      onRemoveMap: self._onRemoveMap.bind(self),
      configModel: self._configModel,
      userModel: self._userModel
    });

    header.bind('export-image', this._onExportImage, this);

    this.$el.append(header.render().$el);
    this.addView(header);

    var tabPaneOptions = {
      tabPaneOptions: {
        template: EditorTabPaneTemplate,
        tabPaneItemOptions: {
          tagName: 'li',
          className: 'CDB-NavMenu-item'
        }
      },
      tabPaneItemLabelOptions: {
        tagName: 'button',
        className: 'CDB-NavMenu-link u-upperCase'
      }
    };

    this._mapTabPaneView = createTextLabelsTabPane(tabPaneTabs, tabPaneOptions);
    this._mapTabPaneView.collection.bind('change:selected', this._updateAddButtonState, this);

    this.$el.append(this._mapTabPaneView.render().$el);
    this.addView(this._mapTabPaneView);

    this._updateAddButtonState();

    return this;
  },

  _initModels: function () {
    this._updatedModel = new Backbone.Model({
      date: ''
    });
  },

  _initBinds: function () {
    this.listenTo(this._widgetDefinitionsCollection, 'reset remove add', this._updateAddButtonState);
    this.listenTo(this._editorModel, 'change:edition', this._changeStyle);
    this.listenTo(this._layerDefinitionsCollection, 'reset remove add', this._updateAddButtonState);
    this.listenTo(this._layerDefinitionsCollection, 'add', function () {
      this._visDefinitionModel.fetch();
    });
  },

  _onExportImage: function () {
    this.trigger('export-image', this);
  },

  _onRemoveMap: function () {
    window.location = this._userModel.get('base_url');
  },

  _hideAddButton: function () {
    this.$('.js-add').addClass('is-hidden');
  },

  _showAddButton: function () {
    this.$('.js-add').removeClass('is-hidden');
  },

  _updateAddButtonState: function () {
    this._hideAddButton();

    switch (this._mapTabPaneView.getSelectedTabPaneName()) {
      case 'widgets':
        if (this._widgetDefinitionsCollection.size()) {
          this._showAddButton();
        }
        break;
      case 'layers':
        if (this._layerDefinitionsCollection.size()) {
          this._showAddButton();
        }
        break;
      case 'elements':
        // TODO: trigger element creation
        break;
    }
  },

  _addItem: function () {
    switch (this._mapTabPaneView.getSelectedTabPaneName()) {
      case 'layers': return this._addLayer();
      case 'widgets': return this._addWidget();
    }
  },

  _addLayer: function () {
    var self = this;
    var modal = this._modals.create(function (modalModel) {
      var addLayerModel = new AddLayerModel({}, {
        userModel: self._userModel,
        userActions: self._userActions,
        configModel: self._configModel,
        pollingModel: self._pollingModel
      });

      return new AddLayerView({
        modalModel: modalModel,
        configModel: self._configModel,
        userModel: self._userModel,
        createModel: addLayerModel,
        pollingModel: self._pollingModel
      });
    });
    modal.show();
  },

  _addWidget: function () {
    var self = this;

    this._modals.create(function (modalModel) {
      return new AddWidgetsView({
        modalModel: modalModel,
        userModel: self._userModel,
        userActions: self._userActions,
        configModel: self._configModel,
        analysisDefinitionNodesCollection: self._analysisDefinitionNodesCollection,
        layerDefinitionsCollection: self._layerDefinitionsCollection,
        widgetDefinitionsCollection: self._widgetDefinitionsCollection
      });
    });
  },

  _share: function () {
    var self = this;

    this._modals.create(function (modalModel) {
      return new PublishView({
        mapcapsCollection: self._mapcapsCollection,
        modalModel: modalModel,
        visDefinitionModel: self._visDefinitionModel,
        privacyCollection: self._privacyCollection,
        userModel: self._userModel,
        configModel: self._configModel
      });
    });
  },

  _changeStyle: function (m) {
    this.$el.toggleClass('is-dark');
    this._mapTabPaneView.changeStyleMenu(m);
  },

  _setUpdateFromCreation: function () {
    this._updatedModel.set({date: this._visDefinitionModel.get('created_at')});
  },

  _setUpdateFromMapcap: function (mapcaps) {
    this._updatedModel.set({date: mapcaps[0].created_at});
  },

  _getMapcaps: function () {
    var updateFromCreation = this._setUpdateFromCreation.bind(this);
    var updateFromMapcap = this._setUpdateFromMapcap.bind(this);
    var url = this._visDefinitionModel.mapcapsURL();
    var data = {
      api_key: this._configModel.get('api_key')
    };

    $.get(url, data)
      .done(function (data) {
        if (data.length > 0) {
          updateFromMapcap(data);
        } else {
          updateFromCreation();
        }
      })
      .fail(function () {
        updateFromCreation();
      });
  }
});

},{"../components/modals/add-layer/add-layer-model":297,"../components/modals/add-layer/add-layer-view":298,"../components/modals/add-widgets/add-widgets-view":371,"../components/modals/publish/publish-view":428,"../components/scroll/scroll-view":530,"../components/stack-layout/stack-layout-view":533,"../components/tab-pane/create-text-labels-tab-pane":537,"../components/view-options/panel-with-options-view":595,"../helpers/required-opts":1097,"./editor-header.js":697,"./editor-tab-pane.tpl":708,"./layers/layers-view":990,"./layers/share-button-view":998,"./widgets/widgets-view":1086,"backbone":"backbone","backbone/core-view":1127,"jquery":"jquery"}],705:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="EditorMenu js-editorMenu">\n  <a class="EditorMenu-logo" href="'+
((__t=( url ))==null?'':_.escape(__t))+
'">\n    <svg width="32px" height="32px" viewBox="762 -58 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n      <g class="imago" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(762.000000, -58.000000)">\n        <circle class="Halo" fill="#FFFFFF" opacity="0.2" cx="16" cy="16" r="16"></circle>\n        <circle class="point" fill="#FFFFFF" cx="16" cy="16" r="5"></circle>\n        <g class="arrow" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(11.000000, 16.000000)">\n          <rect id="Rectangle-32" fill="#1181FB" x="0" y="0" width="10" height="1"></rect>\n          <rect class="arrowTop" fill="#1181FB" x="0" y="0" width="6" height="1"></rect>\n          <rect class="arrowBottom" fill="#1181FB" x="0" y="0" width="6" height="1"></rect>\n        </g>\n      </g>\n    </svg>\n  </a>\n  <ul class="EditorMenu-navigation js-menu"></ul>\n</div>\n<div class="Editor-panelWrapper js-editorPanel">\n  <div class="js-content"></div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],706:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var OptionsView = require('./settings/preview/preview-view');
var ScrollView = require('../components/scroll/scroll-view');
var Header = require('./editor-header.js');
var PublishView = require('../components/modals/publish/publish-view');
var ShareButtonView = require('./layers/share-button-view');
var PanelWithOptionsView = require('../components/view-options/panel-with-options-view');
var checkAndBuildOpts = require('../helpers/required-opts');

var REQUIRED_OPTS = [
  'configModel',
  'editorModel',
  'mapDefinitionModel',
  'mapcapsCollection',
  'modals',
  'overlaysCollection',
  'privacyCollection',
  'settingsCollection',
  'userModel',
  'visDefinitionModel'
];

module.exports = CoreView.extend({

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this._editorModel.set('edition', false);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    var header = new Header({
      userModel: this._userModel,
      editorModel: this._editorModel,
      configModel: this._configModel,
      mapcapsCollection: this._mapcapsCollection,
      modals: this._modals,
      visDefinitionModel: this._visDefinitionModel,
      privacyCollection: this._privacyCollection,
      onClickPrivacy: this._share.bind(this),
      onRemoveMap: this._onRemoveMap.bind(this)
    });

    header.bind('export-image', function () {
      this.trigger('export-image', this);
    }, this);

    this.$el.append(header.render().$el);
    this.addView(header);

    var view = new PanelWithOptionsView({
      className: 'Editor-content',
      editorModel: this._editorModel,
      createContentView: function () {
        return new ScrollView({
          createContentView: function () {
            return new OptionsView({
              mapDefinitionModel: this._mapDefinitionModel,
              settingsCollection: this._settingsCollection,
              overlaysCollection: this._overlaysCollection
            });
          }.bind(this)
        });
      }.bind(this),
      createActionView: function () {
        return new ShareButtonView({
          visDefinitionModel: this._visDefinitionModel,
          onClickAction: this._share.bind(this)
        });
      }.bind(this)
    });

    this.$el.append(view.render().$el);
    this.addView(view);

    return this;
  },

  _share: function () {
    this._modals.create(function (modalModel) {
      return new PublishView({
        mapcapsCollection: this._mapcapsCollection,
        modalModel: modalModel,
        visDefinitionModel: this._visDefinitionModel,
        privacyCollection: this._privacyCollection,
        userModel: this._userModel,
        configModel: this._configModel
      });
    }.bind(this));
  },

  _onRemoveMap: function () {
    window.location = this._userModel.get('base_url');
  }
});

},{"../components/modals/publish/publish-view":428,"../components/scroll/scroll-view":530,"../components/view-options/panel-with-options-view":595,"../helpers/required-opts":1097,"./editor-header.js":697,"./layers/share-button-view":998,"./settings/preview/preview-view":1011,"backbone/core-view":1127}],707:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var EditorSettingsPane = require('./editor-settings-pane');
var ExportImagePane = require('./export-image-pane/export-image-pane');
var StackLayoutView = require('../components/stack-layout/stack-layout-view');
var Notifier = require('../components/notifier/notifier');

var checkAndBuildOpts = require('../helpers/required-opts');
var REQUIRED_OPTS = [
  'configModel',
  'editorModel',
  'mapcapsCollection',
  'mapDefinitionModel',
  'modals',
  'overlaysCollection',
  'privacyCollection',
  'settingsCollection',
  'visDefinitionModel',
  'userModel',
  'stateDefinitionModel'
];

module.exports = CoreView.extend({
  className: 'Editor-panel',

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this._editorModel.set('edition', false);
  },

  render: function () {
    this.clearSubViews();
    this._generateStackLayoutView();

    var notifierView = Notifier.getView();
    this.$el.append(notifierView.render().el);
    this.addView(notifierView);

    return this;
  },

  _generateStackLayoutView: function () {
    var stackViewCollection = new Backbone.Collection([{
      createStackView: function (stackLayoutModel, opts) {
        return this._createEditorSettingsView(stackLayoutModel, opts).bind(this);
      }.bind(this)
    }]);

    stackViewCollection.push({
      createStackView: function (stackLayoutModel, opts) {
        return this._createExportImageView(stackLayoutModel, opts).bind(this);
      }.bind(this)
    });

    this._stackLayoutView = new StackLayoutView({
      className: 'Editor-content',
      collection: stackViewCollection
    });
    this.addView(this._stackLayoutView);
    this.$el.append(this._stackLayoutView.render().$el);
  },

  _createEditorSettingsView: function (stackLayoutModel, opts) {
    var view = new EditorSettingsPane({
      className: 'Editor-content',
      configModel: this._configModel,
      editorModel: this._editorModel,
      mapcapsCollection: this._mapcapsCollection,
      mapDefinitionModel: this._mapDefinitionModel,
      modals: this._modals,
      overlaysCollection: this._overlaysCollection,
      privacyCollection: this._privacyCollection,
      settingsCollection: this._settingsCollection,
      userModel: this._userModel,
      visDefinitionModel: this._visDefinitionModel
    });

    view.bind('export-image', function () {
      this._stackLayoutView.model.goToStep(1);
    }, this);

    return view;
  },

  _createExportImageView: function (stackLayoutModel, opts) {
    var view = new ExportImagePane({
      className: 'Editor-content',
      canvasClassName: 'CDB-Map',
      configModel: this._configModel,
      stackLayoutModel: stackLayoutModel,
      userModel: this._userModel,
      visDefinitionModel: this._visDefinitionModel,
      stateDefinitionModel: this._stateDefinitionModel,
      mapDefinitionModel: this._mapDefinitionModel,
      editorModel: this._editorModel
    });

    return view;
  }
});

},{"../components/notifier/notifier":475,"../components/stack-layout/stack-layout-view":533,"../helpers/required-opts":1097,"./editor-settings-pane":706,"./export-image-pane/export-image-pane":713,"backbone":"backbone","backbone/core-view":1127}],708:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<nav class="CDB-NavMenu js-theme">\n  <ul class="CDB-NavMenu-inner CDB-Text is-semibold CDB-Size-medium js-menu"></ul>\n  <button class="Editor-buttonNavigation CDB-Button CDB-Button--small CDB-Button--primary js-add">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small u-upperCase">\n      '+
((__t=( _t('editor.button_add') ))==null?'':_.escape(__t))+
'\n    </span>\n  </button>\n</nav>\n<div class="Editor-content js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],709:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var Backbone = require('backbone');
var EditorPane = require('./editor-pane');
var ExportImagePane = require('./export-image-pane/export-image-pane');
var checkAndBuildOpts = require('../helpers/required-opts');
var StackLayoutView = require('../components/stack-layout/stack-layout-view');

var REQUIRED_OPTS = [
  'userActions',
  'modals',
  'configModel',
  'userModel',
  'editorModel',
  'pollingModel',
  'analysisDefinitionNodesCollection',
  'layerDefinitionsCollection',
  'privacyCollection',
  'widgetDefinitionsCollection',
  'mapcapsCollection',
  'mapDefinitionModel',
  'visDefinitionModel',
  'mapStackLayoutModel',
  'stateDefinitionModel',
  'selectedTabItem'
];

module.exports = CoreView.extend({

  className: 'Editor-content',

  events: {
    'click .js-add': '_addItem'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
  },

  render: function () {
    this.clearSubViews();
    this._generateStackLayoutView();
    return this;
  },

  _generateStackLayoutView: function () {
    var stackViewCollection = new Backbone.Collection([{
      createStackView: function (stackLayoutModel, opts) {
        return this._createEditorView(stackLayoutModel, opts).bind(this);
      }.bind(this)
    }]);

    stackViewCollection.push({
      createStackView: function (stackLayoutModel, opts) {
        return this._createExportImageView(stackLayoutModel, opts).bind(this);
      }.bind(this)
    });

    this._stackLayoutView = new StackLayoutView({
      className: 'Editor-content',
      collection: stackViewCollection
    });

    this.addView(this._stackLayoutView);
    this.$el.append(this._stackLayoutView.render().$el);
  },

  _createEditorView: function (stackLayoutModel, opts) {
    var view = new EditorPane({
      analysisDefinitionNodesCollection: this._analysisDefinitionNodesCollection,
      configModel: this._configModel,
      editorModel: this._editorModel,
      layerDefinitionsCollection: this._layerDefinitionsCollection,
      mapStackLayoutModel: this._mapStackLayoutModel,
      mapcapsCollection: this._mapcapsCollection,
      modals: this._modals,
      pollingModel: this._pollingModel,
      privacyCollection: this._privacyCollection,
      stateDefinitionModel: this._stateDefinitionModel,
      userActions: this._userActions,
      userModel: this._userModel,
      visDefinitionModel: this._visDefinitionModel,
      widgetDefinitionsCollection: this._widgetDefinitionsCollection,
      selectedTabItem: this._selectedTabItem
    });

    view.bind('export-image', function () {
      this._stackLayoutView.model.goToStep(1);
    }, this);

    return view;
  },

  _createExportImageView: function (stackLayoutModel, opts) {
    var view = new ExportImagePane({
      visDefinitionModel: this._visDefinitionModel,
      canvasClassName: 'CDB-Map',
      configModel: this._configModel,
      stackLayoutModel: stackLayoutModel,
      userModel: this._userModel,
      mapDefinitionModel: this._mapDefinitionModel,
      stateDefinitionModel: this._stateDefinitionModel,
      editorModel: this._editorModel
    });

    return view;
  }
});

},{"../components/stack-layout/stack-layout-view":533,"../helpers/required-opts":1097,"./editor-pane":704,"./export-image-pane/export-image-pane":713,"backbone":"backbone","backbone/core-view":1127}],710:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var checkAndBuildOpts = require('../../helpers/required-opts');
var REQUIRED_OPTS = [
  'userModel',
  'hasGoogleBasemap'
];

var DIMENSION_LIMIT = 8192;
var GOOGLE_DIMENSION_LIMIT = 640;
var GOOGLE_DIMENSION_LIMIT_PREMIUM = 2048;

var OPTIONS = [{
  type: 'png',
  label: '.png',
  className: 'track-ImageExport track-typePNG'
}, {
  type: 'jpg',
  label: '.jpg',
  className: 'track-ImageExport track-typeJPG'
}];

module.exports = Backbone.Model.extend({
  defaults: {
    type: 'none',
    title: ''
  },

  initialize: function (attrs, opts) {
    checkAndBuildOpts(attrs, REQUIRED_OPTS, this);

    this.schema = this._generateSchema();
    this._setSchema();
    this.on('change:format change:width change:height', this._setSchema, this);
  },

  _setSchema: function () {
    this.schema = this._generateSchema();
  },

  _generateSchema: function () {
    return {
      width: {
        type: 'Number',
        title: _t('editor.export-image.properties.width') + ' (px)',
        validators: ['required', this._validateDimension.bind(this)],
        showSlider: false,
        editorAttrs: {
          className: 'track-ImageExport track-inputWidth',
          placeholder: _t('editor.export-image.properties.width')
        }
      },
      height: {
        type: 'Number',
        title: _t('editor.export-image.properties.height') + ' (px)',
        validators: ['required', this._validateDimension.bind(this)],
        showSlider: false,
        editorAttrs: {
          className: 'track-ImageExport track-inputHeight',
          placeholder: _t('editor.export-image.properties.height')
        }
      },
      format: {
        type: 'Radio',
        title: _t('editor.export-image.properties.format'),
        options: _.map(OPTIONS, function (d) {
          return {
            val: d.type,
            label: d.label,
            className: d.className
          };
        }, this)
      }
    };
  },

  _validateDimension: function (value, formValues) {
    var numericValue = +value;

    var limit = DIMENSION_LIMIT;
    var googleMapsKey;

    if (this._hasGoogleBasemap) {
      limit = GOOGLE_DIMENSION_LIMIT;
      googleMapsKey = this._userModel.get('google_maps_key');

      if (googleMapsKey.indexOf('signature') !== -1) {
        limit = GOOGLE_DIMENSION_LIMIT_PREMIUM;
      }
    }

    if (_.isNumber(numericValue) && numericValue >= 1 && numericValue <= limit) {
      return null; // valid dimension
    }

    return {
      message: _t('editor.export-image.invalid-dimension', { limit: limit })
    };
  },

  setErrors: function (errors) {
    // we don't want to set these errors as part as attributes
    // then we manually check if we should trigger the custom event
    var shouldTrigger = errors !== this._validationErrors;
    this._validationErrors = errors;
    shouldTrigger && this.trigger('change:errors');
  },

  canExport: function () {
    return _.isUndefined(this._validationErrors);
  },

  toJSON: function () {
    return _.extend(
      this.attributes,
      {
        type: this.get('type')
      }
    );
  }
});

},{"../../helpers/required-opts":1097,"backbone":"backbone","underscore":"underscore"}],711:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var template = require('./export-image-form.tpl');
require('../../components/form-components/index');
var checkAndBuildOpts = require('../../helpers/required-opts');
var REQUIRED_OPTS = [
  'formModel'
];

module.exports = CoreView.extend({
  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
  },

  render: function () {
    this.clearSubViews();
    this._removeFormView();
    this._renderForm();
    this._initBinds();
    return this;
  },

  _renderForm: function () {
    this.clearSubViews();
    this._removeFormView();

    this._formView = new Backbone.Form({
      template: template,
      model: this._formModel
    });

    this.$('form').on('submit', function (e) {
      e.preventDefault();
    });

    this.$el.append(this._formView.render().$el);
  },

  _initBinds: function () {
    this.listenTo(this._formView, 'change', this._updateChanges);
    this.listenTo(this._formModel, 'change:width change:height', this._updateSchema);
  },

  _updateSchema: function () {
    this._formView.fields.width.setValue(this._formModel.get('width'));
    this._formView.fields.height.setValue(this._formModel.get('height'));
    this._updateChanges();
  },

  _updateChanges: function () {
    var errors = this._formView.commit({validate: true});
    this._formView.model.setErrors(errors);
  },

  _removeFormView: function () {
    this._formView && this._formView.remove();
  },

  clean: function () {
    this.$('form').off('submit');
    this._removeFormView();
    CoreView.prototype.clean.call(this);
  }
});

},{"../../components/form-components/index":211,"../../helpers/required-opts":1097,"./export-image-form.tpl":712,"backbone":"backbone","backbone/core-view":1127}],712:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-bSpace--xl">\n  <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">1</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="width,height">\n    <div class="Editor-HeaderInfo-title u-bSpace--m">\n      <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.export-image.properties.size') ))==null?'':_.escape(__t))+
'</h2>\n    </div>\n    <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.export-image.properties.size-subtitle') ))==null?'':_.escape(__t))+
'</p>\n  </div>\n</div>\n<div class="u-flex u-bSpace--xl">\n  <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="format">\n    <div class="Editor-HeaderInfo-title u-bSpace--m">\n      <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.export-image.properties.format') ))==null?'':_.escape(__t))+
'</h2>\n    </div>\n    <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.export-image.properties.format-subtitle') ))==null?'':_.escape(__t))+
'</p>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],713:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var FooterView = require('./footer/footer-view');
var ExportImageFormView = require('./export-image-form-view.js');
var ExportImageFormModel = require('./export-image-form-model');
var ExportImageWidget = require('./export-image-widget');
var template = require('./export-image-pane.tpl');
var Utils = require('../../helpers/utils');
var Notifier = require('../../components/notifier/notifier');
var browser = require('../../helpers/browser-detect');

var Infobox = require('../../components/infobox/infobox-factory');
var InfoboxView = require('../../components/infobox/infobox-view');
var InfoboxModel = require('../../components/infobox/infobox-model');
var InfoboxCollection = require('../../components/infobox/infobox-collection');

var DEFAULT_EXPORT_FORMAT = 'png';
var DEFAULT_EXPORT_WIDTH = 300;
var DEFAULT_EXPORT_HEIGHT = 200;

var CARTO_ATTRIBUTION = '@CARTO';
var ATTRIBUTION_WIDTH = 15;
var ATTRIBUTION_HEIGHT = 16;

var NOTIFICATION_ID = 'exportImageNotification';
var LOGO_PATH = '/unversioned/images/carto.png';
var GMAPS_STATIC_MAP_ENDPOINT = 'https://maps.googleapis.com/maps/api/staticmap';

var checkAndBuildOpts = require('../../helpers/required-opts');
var REQUIRED_OPTS = [
  'canvasClassName',
  'configModel',
  'stackLayoutModel',
  'userModel',
  'visDefinitionModel',
  'stateDefinitionModel',
  'mapDefinitionModel',
  'editorModel'
];

module.exports = CoreView.extend({
  className: 'Editor-content',

  events: {
    'click .js-back': '_goStepBack'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._canvasModel = new Backbone.Model();
    this._$map = $('.' + this._canvasClassName);

    var width = DEFAULT_EXPORT_WIDTH;
    var height = DEFAULT_EXPORT_HEIGHT;

    var x = Math.ceil(this._$map.width() / 2 - (width / 2));
    var y = Math.ceil(this._$map.height() / 2 - (height / 2));

    this._exportImageFormModel = new ExportImageFormModel({
      userModel: this._userModel,
      hasGoogleBasemap: this._hasGoogleMapsBasemap(),
      format: DEFAULT_EXPORT_FORMAT,
      x: x,
      y: y,
      width: width,
      height: height
    });
  },

  _addErrorNotification: function (error) {
    Notifier.addNotification({
      id: NOTIFICATION_ID,
      status: 'error',
      closable: true,
      button: false,
      delay: Notifier.DEFAULT_DELAY,
      info: error + ' ' + _t('editor.maps.export-image.errors.try-again')
    });
  },

  render: function () {
    this.clearSubViews();

    this.$el.append(
      template({
        title: _t('editor.maps.export-image.title')
      })
    );

    this._createWidget();
    this._createForm();
    this._createDisclaimer();
    this._createFooter();

    return this;
  },

  _createForm: function () {
    this._exportImageFormView = new ExportImageFormView({
      formModel: this._exportImageFormModel,
      canvasModel: this._exportImageFormModel
    });

    this.$('.js-content').append(this._exportImageFormView.render().$el);
    this.addView(this._exportImageFormView);
  },

  _createDisclaimer: function () {
    var infoboxSstates = [{
      state: 'disclaimer',
      createContentView: function () {
        return Infobox.createWithAction({
          type: 'warning',
          title: _t('editor.maps.export-image.disclaimer.title'),
          body: _t('editor.maps.export-image.disclaimer.body')
        });
      }
    }];

    this._infoboxModel = new InfoboxModel({
      state: 'disclaimer'
    });

    this._infoboxCollection = new InfoboxCollection(infoboxSstates);

    this._infoboxView = new InfoboxView({
      infoboxModel: this._infoboxModel,
      infoboxCollection: this._infoboxCollection
    });

    this.$('.js-disclaimer').append(this._infoboxView.render().el);
    this.addView(this._infoboxView);
  },

  _createFooter: function () {
    this._footerView = new FooterView({
      configModel: this._configModel,
      userModel: this._userModel,
      formModel: this._exportImageFormModel
    });

    this.addView(this._footerView);
    this._footerView.bind('finish', this._exportImage, this);
    this.$('.js-footer').append(this._footerView.render().el);
  },

  _createWidget: function () {
    this._exportImageWidget = new ExportImageWidget({
      mapViewClass: 'CDB-Map-wrapper',
      dashboardCanvasClass: 'CDB-Dashboard-canvas',
      model: this._exportImageFormModel,
      stateDefinitionModel: this._stateDefinitionModel,
      mapDefinitionModel: this._mapDefinitionModel
    });

    this.addView(this._exportImageWidget);
    this._$map.prepend(this._exportImageWidget.render().$el);
  },

  _getStaticMapURL: function () {
    var getStaticImageURL = this._mapDefinitionModel.getStaticImageURLTemplate();
    var imageMapMetadata = this._mapDefinitionModel.getImageExportMetadata();
    return getStaticImageURL({
      zoom: imageMapMetadata.zoom,
      width: this._exportImageFormModel.get('width'),
      height: this._exportImageFormModel.get('height'),
      lat: this._exportImageFormModel.get('lat'),
      lng: this._exportImageFormModel.get('lng'),
      format: 'png' // we always use 'png' to allow merging layers
    });
  },

  _getStaticStyles: function (styles) {
    if (!styles) {
      return;
    }

    var result = [];
    var propertyname;
    var propertyval;
    var style = '';

    JSON.parse(styles).forEach(function (s) {
      style = '';
      if (s.stylers && s.stylers.length > 0) {
        style += (s.hasOwnProperty('featureType') ? 'feature:' + s.featureType : 'feature:all') + '|';
        style += (s.hasOwnProperty('elementType') ? 'element:' + s.elementType : 'element:all') + '|';

        s.stylers.forEach(function (val) {
          propertyname = Object.keys(val)[0];
          propertyval = val[propertyname].toString().replace('#', '0x');
          style += propertyname + ':' + propertyval + '|';
        });
      }

      if (style) {
        result.push('style=' + style);
      }
    });

    return result.join('&');
  },

  _removeNotification: function () {
    if (Notifier.getNotification(NOTIFICATION_ID)) {
      Notifier.removeNotification(NOTIFICATION_ID);
    }
  },

  _exportImage: function () {
    var self = this;

    this._removeNotification();

    var def = $.Deferred();

    var logo = function () {
      return self._loadLogo();
    };

    var basemap = function () {
      if (self._hasGoogleMapsBasemap()) {
        return self._loadBasemap(self._getGMapBasemapURL());
      }
    };

    var image = function () {
      return self._onLoadImage(self._downloadImage.bind(self));
    };

    var attribution = function () {
      return self._loadAttribution();
    };

    def.then(logo)
    .then(basemap)
    .then(attribution)
    .then(image)
    .fail(this._onFail.bind(this));

    def.resolve();
  },

  _onFail: function (error) {
    this._footerView.stopLoader();
    this._addErrorNotification(error);
  },

  _downloadImage: function (canvas) {
    var browserInfo = browser();
    var imageFormat = this._exportImageFormModel.get('format');
    var fileName = this._visDefinitionModel.get('name') + '.' + imageFormat;

    if (canvas.msToBlob) {
      var image = canvas.msToBlob();
      window.navigator.msSaveBlob(
        new Blob([image], { type: 'image/' + imageFormat }), // eslint-disable-line
        fileName
      );
    } else {
      var dataUri = canvas.toDataURL('image/' + imageFormat);
      var link = document.createElement('a');
      document.body.appendChild(link);

      link.download = fileName;
      link.href = dataUri;

      if (browserInfo.name !== 'Safari') {
        link.target = '_blank';
      } else {
        dataUri.replace(/^data:image\/[^;]/, 'data:application/octet-stream');
      }

      link.click();

      document.body.removeChild(link);
    }

    this._footerView.stopLoader();
  },

  _hasGoogleMapsBasemap: function () {
    var imageMapMetadata = this._mapDefinitionModel.getImageExportMetadata();
    return imageMapMetadata.provider === 'googlemaps';
  },

  _onLoadImage: function (callback) {
    var self = this;
    var url = this._getStaticMapURL();

    var basemap = this._basemap;

    var width = +this._exportImageFormModel.get('width');
    var height = +this._exportImageFormModel.get('height');

    var image = new Image(); // eslint-disable-line

    image.setAttribute('crossOrigin', 'anonymous');

    image.onload = function () {
      var canvas = document.createElement('canvas');
      var ctx = canvas.getContext('2d');

      canvas.width = this.naturalWidth;
      canvas.height = this.naturalHeight;

      if (basemap) {
        ctx.drawImage(basemap, 0, 0);
      }

      ctx.drawImage(this, 0, 0);

      self._drawLogo(ctx, width, height);
      self._drawAttribution(ctx, width, height);

      callback(canvas);
    };

    image.onerror = function (e) {
      self._onFail(_t('editor.maps.export-image.errors.error-image'));
    };

    image.src = url;
  },

  _drawLogo: function (ctx, width, height) {
    if (this._logo) {
      var left = (width / 2) - (this._logo.width / 2);
      var top = height - this._logo.height - 5;

      ctx.drawImage(this._logo, left, top);
    }
  },

  _drawAttribution: function (ctx, width, height) {
    if (this._attribution) {
      var left = width - this._attribution.width - 3;
      var top = height - this._attribution.height;

      if (this._hasGoogleMapsBasemap()) {
        var attributionWidth = this._$map.find('.gm-style-cc').width();

        if (attributionWidth >= width / 2) {
          top = top - ATTRIBUTION_HEIGHT / 2;
        }

        top = height - this._attribution.height - ATTRIBUTION_HEIGHT;
      }

      ctx.drawImage(this._attribution, left, top);
    }
  },

  _getDimensionString: function () {
    var width = this._exportImageFormModel.get('width');
    var height = this._exportImageFormModel.get('height');

    return width + 'x' + height;
  },

  _getCenterString: function () {
    var lat = +this._exportImageFormModel.get('lat').toFixed(6);
    var lng = +this._exportImageFormModel.get('lng').toFixed(6);

    return lat + ',' + lng;
  },

  _getGMapBasemapURL: function () {
    var visMetadata = this._mapDefinitionModel.getImageExportMetadata();
    var params = {
      center: this._getCenterString().replace(',', ';'), // we'll replace it below with a comma
      zoom: visMetadata.zoom,
      size: this._getDimensionString(),
      mapType: visMetadata.mapType,
      rnd: Math.random(1000)
    };

    var flattenedParams = _.pairs(params).join('&').replace(/,/g, '=').replace(/;/g, ',');
    var style = this._getStaticStyles(visMetadata.style);
    var key = this._userModel.get('google_maps_key');

    return GMAPS_STATIC_MAP_ENDPOINT + '?' + flattenedParams + '&style=' + style + '&' + key;
  },

  _loadAttribution: function () {
    var self = this;
    var visMetadata = this._mapDefinitionModel.getImageExportMetadata();
    var deferred = $.Deferred();

    var image = new Image(); // eslint-disable-line
    var canvas = document.createElement('canvas');
    var ctx = canvas.getContext('2d');

    var text = this._hasGoogleMapsBasemap() ? CARTO_ATTRIBUTION : Utils.stripHTML(visMetadata.attribution.join(' '));
    var dimension = ctx.measureText(text);
    var width = dimension.width;

    ctx.font = '11px';
    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
    ctx.fillRect(-ATTRIBUTION_WIDTH, 0, width + ATTRIBUTION_WIDTH + 2, ATTRIBUTION_HEIGHT - 3);

    ctx.fillStyle = '#333';
    ctx.fillText(text, 0, 10);

    image.onload = function () {
      self._attribution = this;
      deferred.resolve();
    };

    image.onerror = function () {
      deferred.reject(_t('editor.maps.export-image.errors.error-attribution'));
    };

    image.width = width;
    image.height = ATTRIBUTION_HEIGHT - 3;
    image.src = canvas.toDataURL();

    return deferred.promise();
  },

  _loadLogo: function () {
    var self = this;

    var image = new Image(); // eslint-disable-line
    image.setAttribute('crossOrigin', 'anonymous');

    var deferred = $.Deferred();

    image.onload = function () {
      self._logo = this;
      deferred.resolve();
    };

    image.onerror = function () {
      deferred.reject(_t('editor.maps.export-image.errors.error-image'));
    };

    image.src = this._configModel.get('app_assets_base_url') + LOGO_PATH;

    return deferred.promise();
  },

  _loadBasemap: function (url) {
    var self = this;
    var deferred = $.Deferred();
    var image = new Image(); // eslint-disable-line

    image.setAttribute('crossOrigin', 'anonymous');

    image.onload = function () {
      self._basemap = this;
      deferred.resolve();
    };

    image.onerror = function () {
      deferred.reject(_t('editor.maps.export-image.errors.error-basemap'));
    };

    image.src = url;
    return deferred.promise();
  },

  _goStepBack: function () {
    this._stackLayoutModel.prevStep();
  }
});

},{"../../components/infobox/infobox-collection":215,"../../components/infobox/infobox-factory":216,"../../components/infobox/infobox-model":219,"../../components/infobox/infobox-view":221,"../../components/notifier/notifier":475,"../../helpers/browser-detect":1088,"../../helpers/required-opts":1097,"../../helpers/utils":1102,"./export-image-form-model":710,"./export-image-form-view.js":711,"./export-image-pane.tpl":714,"./export-image-widget":715,"./footer/footer-view":717,"backbone":"backbone","backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],714:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfoEditor Editor-HeaderInfo--noMargin">\n  <div class="u-rSpace--xl u-actionTextColor Editor-HeaderInfoEditorShape">\n    <button class="js-back">\n      <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n    </button>\n  </div>\n  <div class="CDB-Text CDB-Size-huge is-light u-ellipsis">'+
((__t=( title ))==null?'':_.escape(__t))+
'</div>\n</div>\n\n<div class="Editor-content js-content"></div>\n<div class="js-disclaimer"></div>\n<div class="Options-bar Options-bar--right u-flex js-footer"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],715:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');
var CoreView = require('backbone/core-view');
var template = require('./export-image-widget.tpl');
var checkAndBuildOpts = require('../../helpers/required-opts');

var TRACK_CONTEXT_CLASS = 'track-ImageExport';

var REQUIRED_OPTS = [
  'mapViewClass',
  'dashboardCanvasClass',
  'stateDefinitionModel',
  'mapDefinitionModel'
];

module.exports = CoreView.extend({
  className: 'ExportImageView',

  events: {
    'mouseenter .js-canvas': '_onEnter',
    'mouseleave .js-canvas': '_onLeave'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._$dashBoardCanvas = $('.' + this._dashboardCanvasClass);

    this._initBinds();
  },

  render: function () {
    this.$el.append(template(this.model.attributes));
    this._initViews();

    return this;
  },

  _initViews: function () {
    this._setupCanvas();
    this._updateHelpers();

    var x = +this.model.get('x');
    var y = +this.model.get('y');
    var width = +this.model.get('width');
    var height = +this.model.get('height');

    this._updateCoordinates(x, y, width, height);
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:x change:y change:width change:height', this._updateHelpers);
    this.listenTo(this._stateDefinitionModel, 'change:json', this._onChangeMap);

    this._resize = _.debounce(this._onResizeWindow.bind(this), 20);
    $(window).on('resize', this._resize);

    this.listenTo(this._stateDefinitionModel, 'change', this._updateCanvasCoordinates);
  },

  _onEnter: function () {
    _.debounce(this.$el.addClass('is-top'), 50);
  },

  _onLeave: function () {
    _.debounce(this.$el.removeClass('is-top'), 50);
  },

  _onResizeWindow: function (e) {
    if (e.target === window) {
      var latLngToPixel = this._mapDefinitionModel.latLngToPixel;

      var coordinates = latLngToPixel({
        lat: this.model.get('lat'),
        lng: this.model.get('lng')
      });

      var width = this.model.get('width');
      var height = this.model.get('height');

      this.model.set({
        x: coordinates.x - width / 2,
        y: coordinates.y - height / 2
      });

      this._updateCanvasCoordinates();
      this._updateHelpers();
    }
  },

  _setupCanvas: function () {
    this.$('.js-canvas').resizable({
      resize: this._onResize.bind(this),
      handles: 'n, e, s, w, ne, se, sw, nw',
      containment: this._$dashBoardCanvas
    });

    this.$('.js-canvas').draggable({
      drag: this._updateCanvasCoordinates.bind(this),
      stop: this._updateCanvasCoordinates.bind(this),
      containment: this._$dashBoardCanvas
    });

    this._setupTracks();

    this.$('.js-canvas').css({
      top: +this.model.get('x'),
      left: +this.model.get('y'),
      width: +this.model.get('width'),
      height: +this.model.get('height')
    });
  },

  _updateHelpers: function () {
    var x = +this.model.get('x');
    var y = +this.model.get('y');
    var width = +this.model.get('width');
    var height = +this.model.get('height');

    var size = this._mapDefinitionModel.getMapViewSize();
    var canvasWidth = size.x;
    var canvasHeight = size.y;

    var bottom = y + height + 1;
    var right = x + width + 1;

    this.$('.js-canvas').css({
      top: y,
      left: x,
      height: height,
      width: width
    });

    if (x >= 0 && y >= 0) {
      this.$('.js-helper-north').css({ top: 0, width: right, height: y + 1 });
      this.$('.js-helper-west').css({ left: 0, top: y + 1, width: x + 1, height: height });
      this.$('.js-helper-south').css({ top: bottom, left: 0, width: canvasWidth, height: canvasHeight - height - y });
      this.$('.js-helper-east').css({ left: right, top: 0, width: canvasWidth - width - x - 1, height: bottom });
    }

    if (right + 1 >= canvasWidth) {
      this.$('.js-helper-east').css('width', 0);
    }
    if (x <= 0) {
      this.$('.js-helper-west').css('width', 0);
    }
    if (bottom + 1 >= canvasHeight) {
      this.$('.js-helper-south').css('height', 0);
    }
    if (y <= 0) {
      this.$('.js-helper-north').css('height', 0);
    }
  },

  _updateCanvasCoordinates: function () {
    var width = this.$('.js-canvas').width();
    var height = this.$('.js-canvas').height();
    var x = this.$('.js-canvas').position().left;
    var y = this.$('.js-canvas').position().top;

    this._updateCoordinates(x, y, width, height);
  },

  _onChangeMap: function () {
    var coordinates = this._calcCenter();

    this.model.set({
      lat: coordinates.lat,
      lng: coordinates.lng
    });
  },

  _onResize: function (e, ui) {
    var width = ui.helper.width();
    var height = ui.helper.height();
    var x = ui.helper.position().left;
    var y = ui.helper.position().top;

    this._updateCoordinates(x, y, width, height);
  },

  _updateCoordinates: function (x, y, width, height) {
    var coordinates = this._calcCenter();

    this.model.set({
      x: x,
      y: y,
      width: width,
      height: height,
      lat: coordinates.lat,
      lng: coordinates.lng
    });
  },

  _calcCenter: function () {
    var x = this.model.get('x') + this.model.get('width') / 2;
    var y = this.model.get('y') + this.model.get('height') / 2;
    var pixelToLatLng = this._mapDefinitionModel.pixelToLatLng;
    return pixelToLatLng({ x: x, y: y });
  },

  _setupTracks: function () {
    this.$('.js-canvas .ui-resizable-nw').addClass(TRACK_CONTEXT_CLASS + ' ' + 'track-nodeTopLeft');
    this.$('.js-canvas .ui-resizable-n').addClass(TRACK_CONTEXT_CLASS + ' ' + 'track-nodeTopCenter');
    this.$('.js-canvas .ui-resizable-ne').addClass(TRACK_CONTEXT_CLASS + ' ' + 'track-nodeTopRight');
    this.$('.js-canvas .ui-resizable-w').addClass(TRACK_CONTEXT_CLASS + ' ' + 'track-nodeMiddleLeft');
    this.$('.js-canvas .ui-resizable-e').addClass(TRACK_CONTEXT_CLASS + ' ' + 'track-nodeMiddleCenter');
    this.$('.js-canvas .ui-resizable-sw').addClass(TRACK_CONTEXT_CLASS + ' ' + 'track-nodeBottomLeft');
    this.$('.js-canvas .ui-resizable-s').addClass(TRACK_CONTEXT_CLASS + ' ' + 'track-nodeBottomCenter');
    this.$('.js-canvas .ui-resizable-se').addClass(TRACK_CONTEXT_CLASS + ' ' + 'track-nodeBottomRight');
  },

  clean: function () {
    $(window).off('resize', this._resize);
    CoreView.prototype.clean.apply(this);
  }
});

},{"../../helpers/required-opts":1097,"./export-image-widget.tpl":716,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],716:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ExportHelper ExportHelper--north js-export-helper js-helper-north"></div>\n<div class="ExportHelper ExportHelper--west  js-export-helper js-helper-west"></div>\n<div class="ExportHelper ExportHelper--south js-export-helper js-helper-south"></div>\n<div class="ExportHelper ExportHelper--east  js-export-helper js-helper-east"></div>\n<div class="CanvasExport js-canvas"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],717:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var template = require('./footer.tpl');
var checkAndBuildOpts = require('../../../helpers/required-opts');

var LOADING = 'loading';

var REQUIRED_OPTS = [
  'userModel',
  'configModel',
  'formModel'
];

module.exports = CoreView.extend({
  className: 'Editor-FooterInfoEditor',

  events: {
    'click .js-ok': '_finish'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this.model = new Backbone.Model({ state: '' });
    this.listenTo(this.model, 'change:state', this.render);
    this.listenTo(this._formModel, 'change:errors', this.render);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template({
      isLoading: this._isLoading(),
      isDisabled: !(this._formModel.canExport() && !this._isLoading())
    }));

    return this;
  },

  stopLoader: function (e) {
    this.model.unset('state');
  },

  _isLoading: function () {
    return this.model.get('state') === LOADING;
  },

  _finish: function (e) {
    this.killEvent(e);
    this.model.set('state', LOADING);
    this.trigger('finish', this);
  }
});

},{"../../../helpers/required-opts":1097,"./footer.tpl":718,"backbone":"backbone","backbone/core-view":1127}],718:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button class="CDB-Button CDB-Button--primary js-ok track-ImageExport track-export\n  ';
 if (isLoading || isDisabled) { 
__p+=' is-disabled ';
 } 
__p+='\n  "\n  ';
 if (isDisabled) { 
__p+=' disabled ';
 } 
__p+='>\n  <div class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small u-upperCase u-flex">\n    ';
 if (isLoading) { 
__p+='\n    <div class="CDB-LoaderIcon CDB-LoaderIcon--small u-iBlock">\n      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n      </svg>\n    </div>\n     '+
((__t=( _t('editor.maps.export-image.generating') ))==null?'':_.escape(__t))+
'\n    ';
 } else { 
__p+='\n     '+
((__t=( _t('editor.maps.export-image.export') ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  </div>\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],719:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var ViewFactory = require('../../components/view-factory');
var template = require('./feedback-button.tpl');
var TipsyTooltipView = require('../../components/tipsy-tooltip-view');
var feedbackModalTemplate = require('./feedback-modal.tpl');

module.exports = CoreView.extend({

  tagName: 'button',
  className: 'EditorMenu-feedback typeform-share button js-feedback',

  events: {
    'click': '_onClick'
  },

  initialize: function (opts) {
    if (!opts.modals) throw new Error('modals is required');
    this._modals = opts.modals;
  },

  render: function () {
    this.clearSubViews();
    this.el.setAttribute('data-mode', '1');
    this.el.setAttribute('target', '_blank');

    this.$el.append(template());

    var tooltip = new TipsyTooltipView({
      el: this.el,
      gravity: 'w',
      title: function () {
        return _t('feedback');
      }
    });
    this.addView(tooltip);

    return this;
  },

  _onClick: function () {
    this._modals.once('destroyedModal', this.clean, this);
    this._modals.create(function (modalModel) {
      return ViewFactory.createByTemplate(feedbackModalTemplate, null, {
        className: 'Editor-feedbackModal'
      });
    });
  }
});

},{"../../components/tipsy-tooltip-view":589,"../../components/view-factory":594,"./feedback-button.tpl":720,"./feedback-modal.tpl":721,"backbone/core-view":1127}],720:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="18px" height="16px" viewBox="-1 -1 18 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n <g id="feedback" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n   <path d="M16,11 L8,11 L5,14 L5,11 L0,11 L0,0 L16,0 L16,11 Z M7.29289322,10.2928932 L7.58578644,10 L8,10 L15,10.0047607 L15.0084229,1 L1,0.993103027 L1,10 L5,10 L6,10 L6,11 L6,11.5374756 L7.29289322,10.2928932 Z" id="Combined-Shape" fill="#FFFFFF "></path>\n   <rect id="Rectangle-25" fill="#FFFFFF " x="4" y="3" width="8" height="1"></rect>\n   <rect id="Rectangle-25" fill="#FFFFFF " x="4" y="5" width="8" height="1"></rect>\n   <rect id="Rectangle-25" fill="#FFFFFF " x="4" y="7" width="5" height="1"></rect>\n </g>\n</svg>\n';
}
return __p;
};

},{"underscore":"underscore"}],721:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="typeform-widget" data-url="https://cartohq.typeform.com/to/t7Dk8K" data-text="CARTO Builder" style="width:100%;height:100%;"></div>\n<script>(function(){var qs,js,q,s,d=document,gi=d.getElementById,ce=d.createElement,gt=d.getElementsByTagName,id=\'typef_orm\',b=\'https://s3-eu-west-1.amazonaws.com/share.typeform.com/\';if(!gi.call(d,id)){js=ce.call(d,\'script\');js.id=id;js.src=b+\'widget.js\';q=gt.call(d,\'script\')[0];q.parentNode.insertBefore(js,q)}})()</script>\n';
}
return __p;
};

},{"underscore":"underscore"}],722:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h2 class="Inline-editor">\n  <div class="CDB-Text CDB-Size-huge is-light u-ellipsis js-title Inline-editor-text">'+
((__t=( name ))==null?'':_.escape(__t))+
'</div>\n  <input type="text" name="text" class="Inline-editor-input Inline-editor-input--small CDB-Text CDB-InputText js-input" value="'+
((__t=( name ))==null?'':_.escape(__t))+
'" readonly>\n</h2>';
}
return __p;
};

},{"underscore":"underscore"}],723:[function(require,module,exports){
var $ = require('jquery');
var cdb = require('cartodb.js');
var CoreView = require('backbone/core-view');
var TipsyTooltipView = require('../../../components/tipsy-tooltip-view.js');
var NotificationErrorMessageHandler = require('../notification-error-message-handler');

module.exports = CoreView.extend({
  initialize: function (opts) {
    if (!opts.analysisNode) throw new Error('analysisNode is required');
    if (!opts.element) throw new Error('element is required');
    if (!opts.triggerSelector) throw new Error('triggerSelector is required');

    this.analysisNode = opts.analysisNode;
    this.$el = opts.element;
    this.selector = opts.triggerSelector;

    this.$el.on('mouseover', this.selector, this._showTooltip.bind(this));
    this.$el.on('mouseout', this.selector, this._destroyTooltip.bind(this));
    this.$el.on('mouseleave', this.selector, this._destroyTooltip.bind(this));
  },

  _showTooltip: function (e) {
    var status = this.analysisNode.get('status');

    if (status === 'failed') {
      var message = NotificationErrorMessageHandler.extractErrorFromAnalysisNode(this.analysisNode);

      this.tooltip = this._createTooltip({
        $el: $(e.target),
        msg: message.message
      });

      this.tooltip.showTipsy();
    }
  },

  _createTooltip: function (opts) {
    return new TipsyTooltipView({
      el: opts.$el,
      title: function () {
        return opts.msg;
      }
    });
  },

  _destroyTooltip: function () {
    if (this.tooltip) {
      this.tooltip.hideTipsy();
      this.tooltip.destroyTipsy();
      delete this.tooltip;
    }
  },

  clean: function () {
    this.$el.off('mouseover', this.selector);
    this.$el.off('mouseout', this.selector);
    this.$el.off('mouseleave', this.selector);

    this._destroyTooltip();
    cdb.core.View.prototype.clean.call(this);
  }
});

},{"../../../components/tipsy-tooltip-view.js":589,"../notification-error-message-handler":992,"backbone/core-view":1127,"cartodb.js":"cartodb.js","jquery":"jquery"}],724:[function(require,module,exports){
var _ = require('underscore');
var Notifier = require('../../../components/notifier/notifier');
var NotificationErrorMessageHandler = require('../notification-error-message-handler');

var DEFAULT_DELAY = Notifier.DEFAULT_DELAY;
var STATUS_READY = 'ready';
var STATUS_PENDING = 'pending';
var STATUS_RUNNING = 'running';
var STATUS_WAITING = 'waiting';
var STATUS_FAILED = 'failed';

var AnalysisNotifications = {

  track: function (analysisNode, layerDefModel) {
    analysisNode.on('change:status', this._addStatusChangedNotification, this);
    analysisNode.on('change:error', this._onErrorChanged, this);
    analysisNode.once('destroy', this._addRemovedNotification, this);
    this._layerDefModel = layerDefModel;

    if (analysisNode.get('status') && analysisNode.get('status') !== STATUS_READY) {
      this._addStatusChangedNotification(analysisNode);
    }
  },

  _addRemovedNotification: function (analysisNode) {
    if (analysisNode.get('avoidNotification') === true) {
      return;
    }

    var nodeId = analysisNode.get('id');
    var notificationAttrs = {
      status: 'success',
      info: _t('notifications.analysis.removed', {
        nodeId: nodeId.toUpperCase()
      }),
      closable: true,
      delay: DEFAULT_DELAY
    };
    this._addOrUpdateNotification(analysisNode.cid, notificationAttrs);
  },

  _addStatusChangedNotification: function (analysisNode) {
    var status = analysisNode.get('status');
    if (status === STATUS_WAITING || status === STATUS_PENDING) {
      this._addAnalysisWaitingNotification(analysisNode);
    }
    if (status === STATUS_RUNNING) {
      this._addAnalysisRunningNotification(analysisNode);
    }
    if (status === STATUS_READY) {
      this._addAnalysisReadyNotification(analysisNode);
    }
    if (status === STATUS_FAILED) {
      this._addAnalysisFailedNotification(analysisNode);
    }
  },

  _addAnalysisWaitingNotification: function (analysisNode) {
    var notificationAttrs = {
      status: 'loading',
      info: _t('notifications.analysis.waiting', {
        nodeId: analysisNode.get('id').toUpperCase()
      })
    };
    this._addOrUpdateNotification(analysisNode.cid, notificationAttrs);
  },

  _addAnalysisRunningNotification: function (analysisNode) {
    var notificationAttrs = {
      status: 'loading',
      info: _t('notifications.analysis.running', {
        nodeId: analysisNode.get('id').toUpperCase()
      })
    };
    this._addOrUpdateNotification(analysisNode.cid, notificationAttrs);
  },

  _addAnalysisReadyNotification: function (analysisNode) {
    var notificationAttrs = {
      status: 'success',
      info: _t('notifications.analysis.completed', {
        nodeId: analysisNode.get('id').toUpperCase()
      }),
      closable: true,
      delay: DEFAULT_DELAY
    };
    this._addOrUpdateNotification(analysisNode.cid, notificationAttrs);
  },

  _addAnalysisFailedNotification: function (analysisNode) {
    var message = NotificationErrorMessageHandler.extractErrorFromAnalysisNode(analysisNode, this._layerDefModel);

    var notificationAttrs = {
      status: message.type,
      info: message.message,
      closable: true,
      autoclosable: false
    };

    this._addOrUpdateNotification(analysisNode.cid, notificationAttrs);
  },

  _addOrUpdateNotification: function (notificationId, notificationAttrs) {
    var notification = this._getNotification(notificationId);
    if (notification) {
      notification.set(notificationAttrs);
    } else {
      this._addNotification(notificationId, notificationAttrs);
    }
  },

  _addNotification: function (notificationId, notificationAttrs) {
    notificationAttrs = _.extend({
      id: notificationId
    }, notificationAttrs);
    Notifier.addNotification(notificationAttrs);
  },

  _getNotification: function (notificationId) {
    return Notifier.getNotification(notificationId);
  },

  _onErrorChanged: function (analysisNode, error) {
    if (error) {
      this._addAnalysisFailedNotification(analysisNode);
    }
  }
};

module.exports = AnalysisNotifications;

},{"../../../components/notifier/notifier":475,"../notification-error-message-handler":992,"underscore":"underscore"}],725:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var SourceLayerAnalysisView = require('./source-layer-analysis-view');
var DefaultLayerAnalysisView = require('./default-layer-analysis-view');
var template = require('./composite-layer-analysis-view.tpl');

/**
 * View for an analysis node which have two source nodes as input.
 * The primary source node is rendered separately, this view renders the own node + the secondary one.
 *  _____________         ___________________
 * |  own node  | ------ |  secondary node  |
 * |____________|        |__________________|
 *       |
 *  ________________
 * |  primary node  |
 * |________________|
 *
 * this.model is expected to be a analysis-definition-node-nodel
 */
module.exports = CoreView.extend({

  tagName: 'li',
  className: 'Editor-ListAnalysis-item',

  initialize: function (opts) {
    if (!opts.analysisDefinitionNodesCollection) throw new Error('analysisDefinitionNodesCollection is required');
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');

    this._analysisDefinitionNodesCollection = opts.analysisDefinitionNodesCollection;
    this._layerDefinitionModel = opts.layerDefinitionModel;
  },

  render: function () {
    this.clearSubViews();

    this.$el.html(template());

    this._renderOwnNode();
    this._renderSecondaryNode();

    return this;
  },

  _renderOwnNode: function () {
    var view = new DefaultLayerAnalysisView({
      tagName: 'div',
      model: this.model,
      analysisNode: this._analysisDefinitionNodesCollection.get(this.model.id),
      layerDefinitionModel: this._layerDefinitionModel
    });
    this.addView(view);
    this.$('.js-primary-source').append(view.render().el);
  },

  _renderSecondaryNode: function () {
    var nodeDefModel = this.model.getSecondarySource();
    var layerDefModel = this._layerDefinitionModel.collection.findOwnerOfAnalysisNode(nodeDefModel);

    if (nodeDefModel) {
      var view = nodeDefModel.get('type') === 'source'
        ? new SourceLayerAnalysisView({
          model: nodeDefModel,
          analysisNode: this._analysisDefinitionNodesCollection.get(nodeDefModel.id),
          layerDefinitionModel: this._layerDefinitionModel,
          showId: !!(layerDefModel && this._isOwnedByOtherLayer(layerDefModel))
        })
        : new DefaultLayerAnalysisView({
          tagName: 'div',
          model: nodeDefModel,
          analysisNode: this._analysisDefinitionNodesCollection.get(nodeDefModel.id),
          layerDefinitionModel: layerDefModel
        });

      this.addView(view);
      this.$('.js-secondary-source').append(view.render().el);
    }
  },

  _isOwnedByOtherLayer: function (layerDefModel) {
    return layerDefModel !== this._layerDefinitionModel;
  }

});

},{"./composite-layer-analysis-view.tpl":726,"./default-layer-analysis-view":727,"./source-layer-analysis-view":731,"backbone/core-view":1127}],726:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="Editor-ListAnalysis-inner">\n  <li class="Editor-ListAnalysis-innerItem js-primary-source"></li>\n  <li class="Editor-ListAnalysis-innerItem js-secondary-source"></li>\n</ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],727:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var nodeIds = require('../../../value-objects/analysis-node-ids');
var layerColors = require('../../../data/layer-colors');
var template = require('./default-layer-analysis-view.tpl');
var Analyses = require('../../../data/analyses');
var AnalysisTooltip = require('./analyses-tooltip-error');

/**
 * View for an analysis node with a single input
 *
 * this.model is expected to be a analysis-definition-node-nodel
 */
module.exports = CoreView.extend({

  tagName: 'li',
  className: 'Editor-ListAnalysis-item Editor-ListAnalysis-layer CDB-Text is-semibold CDB-Size-small js-analysis-node',

  events: {
    'mouseenter': '_onMouseEnter',
    'mouseleave': '_onMouseLeave'
  },

  initialize: function (opts) {
    if (!opts.analysisNode) throw new Error('analysisNode is required');

    this._analysisNode = opts.analysisNode;
    this._analysisNode.on('change:status', this.render, this);
    this.add_related_model(this._analysisNode);

    this._analysisTooltip = new AnalysisTooltip({
      analysisNode: this._analysisNode,
      element: this.$el,
      triggerSelector: '.Editor-ListAnalysis-itemError'
    });
    this.addView(this._analysisTooltip);

    this._stateModel = new Backbone.Model({
      highlighted: false
    });

    this._initBinds();
  },

  _initBinds: function () {
    this._stateModel.on('change:highlighted', this._toggleHover, this);
    this.add_related_model(this._stateModel);
  },

  render: function () {
    var status = this._analysisNode.get('status');

    this.$el.html(template({
      id: this.model.id,
      bgColor: this._bgColor(),
      isDone: status === 'ready' || status === 'failed',
      title: Analyses.title(this.model),
      hasError: status === 'failed'
    }));
    this.$el.toggleClass('has-error', status === 'failed');

    this.el.dataset.analysisNodeId = this.model.id;

    return this;
  },

  _bgColor: function () {
    var letter = nodeIds.letter(this._analysisNode.id);
    return layerColors.getColorForLetter(letter);
  },

  _onMouseEnter: function () {
    this._stateModel.set('highlighted', true);
  },

  _onMouseLeave: function () {
    this._stateModel.set('highlighted', false);
  },

  _toggleHover: function () {
    var $layer = this.$el.closest('.js-layer');
    var $title = $layer.find('.js-Editor-ListLayer-titleText');

    $title.toggleClass('is-hover', this._stateModel.get('highlighted'));
  }
});

},{"../../../data/analyses":599,"../../../data/layer-colors":633,"../../../value-objects/analysis-node-ids":1119,"./analyses-tooltip-error":723,"./default-layer-analysis-view.tpl":728,"backbone":"backbone","backbone/core-view":1127}],728:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-ListAnalysis-itemInfo u-rSpace--m CDB-Text is-semibold CDB-Size-small u-upperCase" style="background: '+
((__t=( bgColor ))==null?'':_.escape(__t))+
'; color: #fff">\n  ';
 if (isDone) { 
__p+='\n    <span class="CDB-Text u-rSpace">\n      '+
((__t=( id ))==null?'':_.escape(__t))+
'\n    </span>\n    <i class="CDB-IconFont CDB-IconFont-ray CDB-Size-medium"></i>\n  ';
 } else { 
__p+='\n    <div class="CDB-LoaderIcon">\n      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n      </svg>\n    </div>\n  ';
 } 
__p+='\n</div>\n<p class="Editor-ListAnalysis-title CDB-Text CDB-Size-small u-secondaryTextColor u-ellipsis" title="'+
((__t=( title ))==null?'':_.escape(__t))+
'">'+
((__t=( title ))==null?'':_.escape(__t))+
'</p>\n\n';
 if (hasError) { 
__p+='\n<div class="Editor-ListAnalysis-itemError"></div>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],729:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var nodeIds = require('../../../value-objects/analysis-node-ids');
var layerColors = require('../../../data/layer-colors');
var analyses = require('../../../data/analyses');
var template = require('./ref-layer-analysis-view.tpl');

/**
 * View for an analysis node that belongs to another layer
 *
 * this.model is expected to be a analysis-definition-node-nodel
 */
module.exports = CoreView.extend({

  tagName: 'li',
  className: 'Editor-ListAnalysis-item Editor-ListAnalysis-layer CDB-Text is-semibold CDB-Size-small js-analysis-node',

  events: {
    'mouseenter': '_onMouseEnter',
    'mouseleave': '_onMouseLeave'
  },

  initialize: function (opts) {
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
    if (!opts.analysisNode) throw new Error('analysisNode is required');

    this._layerDefinitionModel = opts.layerDefinitionModel;
    this._analysisNode = opts.analysisNode;

    this._stateModel = new Backbone.Model({
      highlighted: false
    });

    this._initBinds();
  },

  _initBinds: function () {
    this.listenTo(this._analysisNode, 'change:status', this.render);
    this.add_related_model(this._analysisNode);

    this.listenTo(this._layerDefinitionModel, 'change', this.render);
    this.add_related_model(this._layerDefinitionModel);

    this.listenTo(this._stateModel, 'change:highlighted', this._toggleHover);
    this.add_related_model(this._stateModel);
  },

  render: function () {
    var status = this._analysisNode.get('status');

    this.$el.html(template({
      id: this.model.id,
      layerName: this._layerDefinitionModel.getName(),
      bgColor: this._bgColor(),
      isDone: status === 'ready' || status === 'failed',
      title: analyses.title(this.model)
    }));
    this.$el.toggleClass('has-error', status === 'failed');

    this.el.dataset.analysisNodeId = this.model.id;

    return this;
  },

  _bgColor: function () {
    var letter = nodeIds.letter(this._analysisNode.id);
    return layerColors.getColorForLetter(letter);
  },

  _onMouseEnter: function () {
    this._stateModel.set('highlighted', true);
  },

  _onMouseLeave: function () {
    this._stateModel.set('highlighted', false);
  },

  _toggleHover: function () {
    var $layer = this.$el.closest('.js-layer');
    var $title = $layer.find('.js-Editor-ListLayer-titleText');

    $title.toggleClass('is-hover', this._stateModel.get('highlighted'));
  }
});

},{"../../../data/analyses":599,"../../../data/layer-colors":633,"../../../value-objects/analysis-node-ids":1119,"./ref-layer-analysis-view.tpl":730,"backbone":"backbone","backbone/core-view":1127}],730:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-ListAnalysis-itemInfo u-rSpace--m CDB-Text is-semibold CDB-Size-small u-upperCase" style="background: '+
((__t=( bgColor ))==null?'':_.escape(__t))+
'; color: #fff">\n  ';
 if (isDone) { 
__p+='\n    <span class="CDB-Text u-rSpace">\n      '+
((__t=( id ))==null?'':_.escape(__t))+
'\n    </span>\n    <i class="CDB-IconFont CDB-IconFont-ray CDB-Size-medium"></i>\n  ';
 } else { 
__p+='\n    <div class="CDB-LoaderIcon">\n      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n      </svg>\n    </div>\n  ';
 } 
__p+='\n</div>\n<p class="Editor-ListAnalysis-title CDB-Text CDB-Size-small u-secondaryTextColor u-ellipsis u-flex" title="'+
((__t=( title ))==null?'':_.escape(__t))+
'">\n  '+
((__t=( title ))==null?'':_.escape(__t))+
' <span class="u-altTextColor u-lSpace u-ellipsis">'+
((__t=( layerName ))==null?'':_.escape(__t))+
'</span>\n</p>\n';
}
return __p;
};

},{"underscore":"underscore"}],731:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var template = require('./source-layer-analysis-view.tpl');
var TipsyTooltipView = require('../../../components/tipsy-tooltip-view');
var moment = require('moment');

/**
 * View for a analysis source (i.e. SQL query).
 *
 * this.model is expected to be a analysis-definition-node-model and belong to the given layer-definition-model
 */
module.exports = CoreView.extend({

  tagName: 'li',
  className: 'Editor-ListAnalysis-item Editor-ListAnalysis-layer js-base is-base',

  events: {
    'mouseenter': '_onMouseEnter',
    'mouseleave': '_onMouseLeave'
  },

  initialize: function (opts) {
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
    if (!opts.analysisNode) throw new Error('analysisNode is required');

    this._layerDefinitionModel = opts.layerDefinitionModel;
    this._analysisNode = opts.analysisNode;
    this._tableNodeModel = this._analysisNode.getTableModel();
    this._stateModel = new Backbone.Model({
      highlighted: false
    });

    this._initBinds();
  },

  options: {
    showId: true
  },

  render: function () {
    var isSync = this._tableNodeModel && this._tableNodeModel.isSync();
    var syncData = {};

    if (isSync) {
      var syncModel = this._tableNodeModel.getSyncModel();
      var runAt = syncModel.get('run_at');

      syncData = {
        ranAt: moment(syncModel.get('ran_at') || new Date()).fromNow(),
        runAt: moment(runAt).fromNow(),
        state: syncModel.get('state'),
        errorCode: syncModel.get('error_code'),
        errorMessage: syncModel.get('error_message')
      };

      // Due to the time we need to polling, we have to display to the user
      // that the sync will be in a moment
      if (!runAt || (new Date(runAt) <= new Date())) {
        syncData.runAt = _t('dataset.sync.in-a-moment');
      }
    }

    var isCustomQueryApplied = this._analysisNode.isCustomQueryApplied();
    this.$el.html(template(_.extend({
      id: this.options.showId
        ? this.model.id
        : '',
      tableName: this.model.get('table_name'),
      customQueryApplied: isCustomQueryApplied,
      isSync: isSync
    }, syncData)));

    if (isSync) {
      var tooltip = new TipsyTooltipView({
        el: this.$('.js-sync'),
        gravity: 's',
        offset: 0,
        title: function () {
          return (syncData.errorCode || syncData.errorMessage) ? _t('dataset.sync.error-code', { errorCode: syncData.errorCode }) + ':' + syncData.errorMessage : $(this).data('tooltip');
        }
      });
      this.addView(tooltip);
    }

    return this;
  },

  _initBinds: function () {
    this._stateModel.on('change:highlighted', this._toggleHover, this);
    this.add_related_model(this._stateModel);
    this._tableNodeModel.on('change:synchronization', this.render, this);
    this.add_related_model(this._tableNodeModel);
  },

  _onMouseEnter: function () {
    this._stateModel.set('highlighted', true);
  },

  _onMouseLeave: function () {
    this._stateModel.set('highlighted', false);
  },

  _toggleHover: function () {
    var $layer = this.$el.closest('.js-layer');
    var $title = $layer.find('.js-Editor-ListLayer-titleText');

    $title.toggleClass('is-hover', this._stateModel.get('highlighted'));
  }

});

},{"../../../components/tipsy-tooltip-view":589,"./source-layer-analysis-view.tpl":732,"backbone":"backbone","backbone/core-view":1127,"jquery":"jquery","moment":"moment","underscore":"underscore"}],732:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-ListAnalysis-itemInfo u-rSpace--m CDB-Text is-semibold CDB-Size-small u-altTextColor">\n  '+
((__t=( id ))==null?'':_.escape(__t))+
'\n  <div class="CDB-Shape Editor-ListAnalysis-itemInfoIcon">\n    <ul class="CDB-Shape-Dataset is-small is-grey">\n      <li class="CDB-Shape-DatasetItem"></li>\n      <li class="CDB-Shape-DatasetItem"></li>\n    </ul>\n  </div>\n</div>\n<p class="CDB-Text CDB-Size-small u-secondaryTextColor Editor-ListAnalysis-itemInfoDataset u-ellipsis">\n  '+
((__t=( tableName ))==null?'':_.escape(__t))+
'\n</p>\n';
 if (isSync) { 
__p+='\n  <span class="Editor-ListAnalysis-itemInfoIcon">\n    <div class="u-flex u-alignCenter CDB-Text CDB-Size-small u-altTextColor SyncInfo-message--'+
((__t=( state ))==null?'':_.escape(__t))+
' js-sync" data-tooltip="';
 if (errorCode || errorMessage) { 
__p+=''+
((__t=( _t('dataset.sync.sync-failed') ))==null?'':_.escape(__t))+
'';
 } else { 
__p+=''+
((__t=( ranAt ))==null?'':_.escape(__t))+
'';
 } 
__p+='">\n      <i class="CDB-IconFont CDB-IconFont-wifi"></i>\n    </div>\n  </span>\n';
 } 
__p+='\n';
 if (customQueryApplied) { 
__p+='\n  <span class="Editor-ListAnalysis-itemInfoIcon Tag Tag--outline Tag-outline--dark CDB-Text CDB-Size-small">\n    SQL\n  </span>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],733:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var CarouselCollection = require('../../components/custom-carousel/custom-carousel-collection');
var template = require('./basemap-content.tpl');
var BasemapHeaderView = require('./basemap-content-views/basemap-header-view');
var BasemapModelFactory = require('./basemap-content-views/basemap-model-factory');
var BasemapsCollection = require('./basemap-content-views/basemaps-collection');
var BasemapInnerView = require('./basemap-content-views/basemap-inner-view');
var ScrollView = require('../../components/scroll/scroll-view');
var Notifier = require('../../components/notifier/notifier');

var NOTIFICATION_ID = 'basemapNotification';

var BASEMAP_ICONS = {
  gmaps: require('./basemap-content-views/basemap-icons/basemap-gmaps.tpl'),
  carto: require('./basemap-content-views/basemap-icons/basemap-carto.tpl'),
  stamen: require('./basemap-content-views/basemap-icons/basemap-stamen.tpl'),
  color: require('./basemap-content-views/basemap-icons/basemap-color.tpl'),
  mapbox: require('./basemap-content-views/basemap-icons/basemap-mapbox.tpl'),
  custom: require('./basemap-content-views/basemap-icons/basemap-custom.tpl'),
  here: require('./basemap-content-views/basemap-icons/basemap-here.tpl'),
  wms: require('./basemap-content-views/basemap-icons/basemap-wms.tpl'),
  tilejson: require('./basemap-content-views/basemap-icons/basemap-tilejson.tpl'),
  nasa: require('./basemap-content-views/basemap-icons/basemap-nasa.tpl')
};

module.exports = CoreView.extend({

  events: {
    'click .js-back': '_onClickBack'
  },

  initialize: function (opts) {
    if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
    if (!opts.stackLayoutModel) throw new Error('StackLayoutModel is required');
    if (!opts.customBaselayersCollection) throw new Error('customBaselayersCollection is required');
    if (!opts.basemaps) throw new Error('basemaps is required');
    if (!opts.modals) throw new Error('modals is required');
    if (!opts.configModel) throw new Error('configModel is required');

    this._layerDefinitionsCollection = opts.layerDefinitionsCollection;
    this._stackLayoutModel = opts.stackLayoutModel;
    this._customBaselayersCollection = opts.customBaselayersCollection;
    this._modals = opts.modals;
    this._configModel = opts.configModel;

    this._baseLayer = this._layerDefinitionsCollection.getBaseLayer();

    this.model = new Backbone.Model({
      disabled: false
    });

    this._basemapModelFactory = new BasemapModelFactory(this._layerDefinitionsCollection, this._configModel);

    this._initCollections(opts.basemaps);
    this._initBinds();
  },

  _initCollections: function (basemaps) {
    this._basemapsCollection = new BasemapsCollection();
    var basemapModel;

    // Basemaps defined in app_config.yml
    _(basemaps).each(function (categoryBasemaps, category) {
      _.map(categoryBasemaps, function (basemap) {
        basemapModel = this._basemapModelFactory.createBasemapModel(category, basemap);
        this._basemapsCollection.add(basemapModel);
      }, this);
    }, this);

    // userlayers basemaps
    this._customBaselayersCollection.each(function (customBaseLayerDefinitionModel) {
      var category = customBaseLayerDefinitionModel.get('category') || 'Custom';
      basemapModel = this._basemapModelFactory.createBasemapModel(category, customBaseLayerDefinitionModel.attributes);
      this._basemapsCollection.add(basemapModel);
    }, this);

    // Plain color or image basemap
    basemapModel = this._basemapModelFactory.createBasemapModel('Color', {
      color: this._baseLayer.get('color') || '',
      image: this._baseLayer.get('image') || '',
      selected: this._baseLayer.get('className') === 'plain'
    });
    this._basemapsCollection.add(basemapModel);

    this._categoriesCollection = new CarouselCollection(
      _.map(this._basemapsCollection.getCategories(), function (category) {
        return {
          selected: this._getBaseLayerCategory() === category,
          val: category,
          label: category,
          template: function () {
            var template = this._getTemplateForCategory(category.toLowerCase());
            return template();
          }.bind(this)
        };
      }, this)
    );
  },

  _getTemplateForCategory: function (categoryName) {
    var template = BASEMAP_ICONS[categoryName.toLowerCase()];
    if (!template) {
      template = function () {
        return categoryName;
      };
    }
    return template;
  },

  _onChangingBaseLayer: function () {
    this.model.set('disabled', true);

    if (Notifier.getNotification(NOTIFICATION_ID)) {
      Notifier.removeNotification(NOTIFICATION_ID);
    }

    this.notification = Notifier.addNotification({
      id: NOTIFICATION_ID,
      status: 'loading',
      info: _t('editor.layers.basemap.saving.loading'),
      closable: false
    });
  },

  _onBaseLayerChanged: function () {
    this.model.set('disabled', false);

    this.notification.set({
      status: 'success',
      info: _t('editor.layers.basemap.saving.success'),
      closable: true
    });
  },

  _onBaseLayerFailed: function () {
    this.model.set('disabled', false);

    this.notification.set({
      status: 'error',
      info: _t('editor.layers.basemap.saving.error'),
      closable: true
    });
  },

  _initBinds: function () {
    this.model.bind('change:disabled', function () {
      this.$('.js-basemapContent').toggleClass('is-disabled', this.model.get('disabled'));
    }, this);

    this._basemapsCollection.bind('change:category', function (mdl) {
      var userLayersMdl = this._customBaselayersCollection.get(mdl.get('id'));
      userLayersMdl.set('category', mdl.get('category'));
      userLayersMdl.save();
    }, this);
    this._basemapsCollection.bind('remove', function (mdl) {
      var userLayersMdl = this._customBaselayersCollection.get(mdl.get('id'));
      userLayersMdl.destroy();
    }, this);
    this._basemapsCollection.bind('add', this._onAddBasemap, this);
    this.add_related_model(this._basemapsCollection);

    this._layerDefinitionsCollection.bind('changingBaseLayer', this._onChangingBaseLayer, this);
    this._layerDefinitionsCollection.bind('baseLayerChanged', this._onBaseLayerChanged, this);
    this._layerDefinitionsCollection.bind('baseLayerFailed', this._onBaseLayerFailed, this);
    this._layerDefinitionsCollection.bind('change', function () {
      this._renderHeader();

      this._baseLayer = this._layerDefinitionsCollection.getBaseLayer();
      this._updateSelectedCategory(this._baseLayer.get('category'));
    }, this);
    this.add_related_model(this._layerDefinitionsCollection);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());

    this._initViews();
    return this;
  },

  _updateSelectedCategory: function (category) {
    var newCategory = this._categoriesCollection.findWhere({ val: category });
    newCategory && newCategory.set({ selected: true });
  },

  _onChangeSelectedCategory: function (mdl, isSelected) {
    if (isSelected) {
      this._renderContent();
    }
  },

  _getBaseLayerCategory: function () {
    var category = this._basemapsCollection.getDefaultCategory();

    if (this._baseLayer.get('category')) {
      category = this._baseLayer.get('category');
    } else if (this._baseLayer.get('type') === 'Plain') {
      category = 'Color';
    } else if (this._customBaselayersCollection.hasCustomBaseLayer(this._baseLayer.get('className'))) {
      category = 'Custom';
    }

    return category;
  },

  _initViews: function () {
    this._renderHeader();
    this._renderContent();
  },

  _renderContent: function () {
    var self = this;

    if (this._contentView) {
      this.removeView(this._contentView);
      this._contentView.clean();
    }

    this._contentView = new ScrollView({
      createContentView: function () {
        return new BasemapInnerView({
          model: self.model,
          categoriesCollection: self._categoriesCollection,
          layerDefinitionsCollection: self._layerDefinitionsCollection,
          basemapsCollection: self._basemapsCollection,
          customBaselayersCollection: self._customBaselayersCollection,
          modals: self._modals
        });
      }
    });
    this.addView(this._contentView);
    this.$('.js-basemapContent').html(this._contentView.render().el);
  },

  _renderHeader: function () {
    if (this._headerView) {
      this.removeView(this._headerView);
      this._headerView.clean();
    }

    this._headerView = new BasemapHeaderView({
      model: this._layerDefinitionsCollection.getBaseLayer(),
      category: this._getBaseLayerCategory()
    });
    this.addView(this._headerView);
    this.$('.js-basemapHeader').html(this._headerView.render().el);
  },

  _onAddBasemap: function (mdl) {
    this._basemapsCollection.updateSelected(mdl.getValue());
  },

  _onClickBack: function () {
    this._stackLayoutModel.prevStep('layers');
  }

});

},{"../../components/custom-carousel/custom-carousel-collection":40,"../../components/notifier/notifier":475,"../../components/scroll/scroll-view":530,"./basemap-content-views/basemap-header-view":740,"./basemap-content-views/basemap-icons/basemap-carto.tpl":742,"./basemap-content-views/basemap-icons/basemap-color.tpl":743,"./basemap-content-views/basemap-icons/basemap-custom.tpl":744,"./basemap-content-views/basemap-icons/basemap-gmaps.tpl":745,"./basemap-content-views/basemap-icons/basemap-here.tpl":746,"./basemap-content-views/basemap-icons/basemap-mapbox.tpl":747,"./basemap-content-views/basemap-icons/basemap-nasa.tpl":748,"./basemap-content-views/basemap-icons/basemap-stamen.tpl":749,"./basemap-content-views/basemap-icons/basemap-tilejson.tpl":750,"./basemap-content-views/basemap-icons/basemap-wms.tpl":751,"./basemap-content-views/basemap-inner-view":752,"./basemap-content-views/basemap-model-factory":754,"./basemap-content-views/basemaps-collection":766,"./basemap-content.tpl":767,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],734:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-selector">\n  <div class="Editor-HeaderInfo-title u-bSpace--m">\n    <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.basemap.category.title-label') ))==null?'':_.escape(__t))+
'</h2>\n  </div>\n  <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m js-highlight">'+
((__t=( _t('editor.layers.basemap.category.select-category') ))==null?'':_.escape(__t))+
'</p>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],735:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./basemap-categories.tpl');
var CarouselFormView = require('../../../components/carousel-form-view');

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.categoriesCollection) throw new Error('categoriesCollection is required');

    this._categoriesCollection = opts.categoriesCollection;
  },

  render: function () {
    this.clearSubViews();

    this.$el.html(template());

    this._renderCarousel();

    return this;
  },

  _renderCarousel: function () {
    var view = new CarouselFormView({
      collection: this._categoriesCollection,
      template: require('./basemap-carousel.tpl')
    });
    this.addView(view);
    this.$('.js-select').append(view.render().el);
  }

});

},{"../../../components/carousel-form-view":23,"./basemap-carousel.tpl":734,"./basemap-categories.tpl":736,"backbone/core-view":1127}],736:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfo">\n  <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">1</div>\n  <div class="Editor-HeaderInfo-inner CDB-Text js-select"></div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],737:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var DEBOUNCE_TIME = 650;

module.exports = Backbone.Model.extend({

  initialize: function (attrs, opts) {
    if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
    if (!opts.basemapsCollection) throw new Error('basemapsCollection is required');

    this._layerDefinitionsCollection = opts.layerDefinitionsCollection;
    this._basemapsCollection = opts.basemapsCollection;
    this._disabled = opts.disabled;

    this._generateSchema();
    this._initBinds();
  },

  _initBinds: function () {
    this._onChange = this._onChange.bind(this);
    this.bind('change', _.debounce(this._onChange, DEBOUNCE_TIME), this);
  },

  _onChange: function () {
    if (this.hasChanged('color')) {
      var color = this.get('color').color.fixed;
      this._updatePlainBasemap(color);
    }
  },

  _updatePlainBasemap: function (color) {
    var plainBasemap = this._basemapsCollection.find(function (mdl) {
      return mdl.get('className') === 'plain';
    });
    var isAlreadySelected = plainBasemap.get('selected');

    plainBasemap.set({
      color: color,
      image: '',
      maxZoom: 32
    });

    if (isAlreadySelected) {
      this._layerDefinitionsCollection.setBaseLayer(plainBasemap.toJSON());
    } else {
      this._basemapsCollection.updateSelected(plainBasemap.getValue());
    }
  },

  _generateSchema: function () {
    this.schema = {
      color: {
        type: 'Fill',
        title: _t('editor.layers.basemap.style.color'),
        options: [],
        editorAttrs: {
          color: {
            hidePanes: ['value'],
            disableOpacity: true
          },
          disabled: this._disabled
        },
        validators: ['required']
      }
    };
  }

});

},{"backbone":"backbone","underscore":"underscore"}],738:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var template = require('./basemap-form.tpl');
var BasemapFormModel = require('./basemap-form-model');

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
    if (!opts.basemapsCollection) throw new Error('basemapsCollection is required');

    this._layerDefinitionsCollection = opts.layerDefinitionsCollection;
    this._basemapsCollection = opts.basemapsCollection;
    this._disabled = opts.disabled;
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());

    this._generateForms();

    return this;
  },

  _generateForms: function () {
    if (this._formView) {
      this._formView.remove();
    }

    var color = {
      color: {
        fixed: '',
        opacity: 1
      }
    };

    if (typeof this.model.get('color') === 'string') {
      color.color.fixed = this.model.get('color');
    }

    this._formModel = new BasemapFormModel({
      color: color,
      image: this.model.get('image') || ''
    }, {
      basemapsCollection: this._basemapsCollection,
      layerDefinitionsCollection: this._layerDefinitionsCollection,
      disabled: this._disabled
    });

    this._formView = new Backbone.Form({
      model: this._formModel
    });

    this._formView.bind('change', function () {
      this.commit();
    });

    this.$('.js-form').append(this._formView.render().$el);
  },

  clean: function () {
    if (this._formView) {
      this._formView.remove();
    }
  }

});

},{"./basemap-form-model":737,"./basemap-form.tpl":739,"backbone":"backbone","backbone/core-view":1127}],739:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-selector">\n  <div class="Editor-HeaderInfo-title u-bSpace--m">\n    <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.infowindow.style.title-label') ))==null?'':_.escape(__t))+
'</h2>\n  </div>\n  <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m js-highlight">'+
((__t=( _t('editor.layers.infowindow.style.select-style') ))==null?'':_.escape(__t))+
'</p>\n</div>\n\n<div class="js-form"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],740:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./basemap-header.tpl');

var DEFAULT_NAME = _t('editor.layers.basemap.custom-basemap');

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.category) throw new Error('category is required');

    this.category = opts.category;
  },

  render: function () {
    this.$el.html(
      template({
        title: _t('editor.layers.basemap.title-label'),
        description: this._getName()
      })
    );
    return this;
  },

  _getName: function () {
    var name = this.model.getName();

    if (!name) {
      name = DEFAULT_NAME;
    } else {
      name = this.model.getName().replace(/_/g, '') + ' ' + _t('editor.layers.basemap.by') + ' ' + this.category;
    }

    return name;
  }

});

},{"./basemap-header.tpl":741,"backbone/core-view":1127}],741:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfo u-alignStart">\n  <button class="u-rSpace--xl u-actionTextColor js-back Editor-HeaderInfoEditorShape">\n    <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n  </button>\n  <div class="Editor-HeaderInfo-inner">\n    <div class="Editor-HeaderInfo-title u-bSpace">\n      <h2 class="Editor-HeaderInfo-titleText CDB-Text CDB-Size-huge is-light u-ellipsis">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h2>\n    </div>\n    <p class="Editor-HeaderInfo-description CDB-Text CDB-Size-medium u-altTextColor u-iBlock">'+
((__t=( description ))==null?'':_.escape(__t))+
'</p>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],742:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFgAAAA4CAYAAAB5YT9uAAAAAXNSR0IArs4c6QAAB51JREFUeAHtW+tv21QUP3HeTtykTdt1a9d1GxNIwBAggRD/O1+RkPgAQhogNq2dlnVdm+Yd23lxfm5v5zqO48dtfTX1SpGvr69Pzv35+ryd+f3Pv+akYGuevKfPHx/Q7s62NO6mpkVjy6JSbS0xTXs8ppFpUrVcpsl0Ru1ej3IZjcp6mfRy6Yp+7qqnWKdULEoFF8vLloo0nUxp0O5QpV5LtOIJ08lqWRrwQ0O7t9lg2hPK5q5Dev0s0V/Ku3kyndJGrS6PoItSoaqTeXziGonXBY8VfmBuQN19QVUTHZWO/eGA9h/cU4mlBV5mDLAfoN6JSgIMJt1yzMt0knO8xrlCMQkJ514tm6X3p2cr6SgHMF697cb6SsbjThictkjfSCZ/8d9r1QrlsznqD4aOslvGj3IAdwd92ttRWzwIMMvlImmaRqPhhaIT4+6jckoun9WokM+7eYzchxjATvW2DGv9yuaGdzj2ebl0YY6Zl5aEHyH1AM4nZ0konzWJNrQfeBizLJsKheUbQikRcd7p0MGDB8vWEmkcdm5Xgjm26k+LxQLZ1tixgf3mKgNwq9Nm02yH6hK8LCwUTsVtgbzBSrPTHRC8O9GGI9PpJn8fBcWYx5OzU+fO/d37tCNRPoIoQL6tBpBbrQ6bgDma2BMa2ZZjaqYOsFGt0nrNoINdOaLBCygUm58L650n4xwgQyaXWGxow4xDMnURUS6W6LzTlbE+XxrGdsPXovCdLGEQMjmbuQAX5FIHGEwUJFgOoBPU7P4w6LK0a3hbII8HLIPRTx3gdq9LTx7uSVugHyGYa2a/T4Oz86Xa3u++OGOd3oAgKkSYNXWAs1qGhMHuXtAqF9Q9N0wfIJdY1vs5IGHuDzMHPNuTsSOHMR/2eOpKTmMl5G0IZMN4T+rReekKB8Q7LvO8qusEOSxa6jt4NltMqHR6fengYsEQEUkD7QI4v2O1orPsHV2zh1MF2LJt2mpcD6y3zjv07+sjP/4TjUHhTNkRuEnbuNsfOOLO/ealCnCn31uwf9+dfqAJg+H2ihIhyzdbrNWH522pgR4/nuBgIIzpbqnLYAStNzluMGID3bbH1O0NnWSnexe4GY7Tt60RGVubcW5deQ/ejHanxwotS9m8tuDUZNLMKk9nYzI5UGJaphO4/vn7b6UrNwAwZu0uI5PsRRu0YfNWDd3RGfDi+iwm6mytCIWa6g7OanmqlPHTWXbp1B8OaadyfadhEYJZ7wLDnI/Z4Nc48yC7IZhjjiyqrVWu+IP1kON4do8fKJT3xnotfUdDLFzn4HWbd4Nor982nZzX4btjMRTraPNikUmW2aAfEGSHQ+F9+DhHRLBmVOiMrRb5jzbmSs7aLVZ4uwRgm+8/UI89r7379xwR0qp2nN0Qk7TU2+BMQAljdwa1C6ANSlUGuxlEshPp+qpe4dfswvlAAP6n7567p0XuQ8TAe5OV3YAZuQpcN5OpmmluRgBq3Vi7AhfXZvOpe0qsPnZSiUOipqSIXY4DU1FMSGUA9kMvw7Ve2IFJG2SwfZlhQH0atH3chmoeuPJhmzIyOCzDcechmyxydJpRdcypRoj6C2GKzeczyrOVgIoev+DUMr7U3sGUWdDSyxayahyiQshhxAyQ2oE8xS+oweSCKQZwx7zzda6edAdzgu7FNWV3MJTeei1YU69anLiOXWiyt4VYROGytLRmGM5lXIM5RRw2ZaFP7l0NUYBqTOfhVBkqjxss6AcdlQUYydAfnn8VxHvoa7AiEEXzC/QAPAEqlJd7R6NyR1wL/WeeicqYaR6+uKh56tjCMsy0m3KVvTz7nSsrg2G2ZS/tYT/Gw45h995EHCLs/ysLMBYwntiJzDRYDTJr0cKC6p6nNMAWhy+n88WMh3sBy/pQXlBokLFpNqUBbtTXY6eOhlxlk2dzLO2mNMBDzm/FbfNZuBL/uPTD3qc0wBnYpjEbzLLbKjYJYlFpgEvF5XW3QYvCNdi81jD+G7CKftjrygKMip/He7th1+E7D2Ii7aYswPCq8BXlTbQOf5V5Wy1dGyZglQZbAElMLDwgwNh8eUimPaLpdO4kV/FFZo5NNxGLCGBByiUlAe4NBlwQ+LFeuM3BclQrbnF4EaWhq4AXaScgtFY1qFS4eBOQXEUu7bD5mgacYP3i8cFKWklRVjIWgUDPj998TW+Oj+kEiUPOCussLpCnE1kOBOPzXIvw9OHDqxQOdu0fL/7hHZon1B0HNcQ6ulz48uWzJze6m5UEGF/aF7n4r2bUrqWQ/AA7ar6lCsdoSwwo6isa9WifaUGZbnIC87NH+37kE48pCXDUVb08OqT6mhEZXPE/qJErFgr07NGu8/U8PgGQVVmkpAwWCw97fLr/yAlvhp3vnQdw8ZXTyNpaqC3zzo16rqyZFnUhItUf9T73fJTNym6fDMAygBFl/zJoCRp3AF8iATHx3+FRpJS8ADHoeAfwJTqwkbv9Ef3y62+RCkuCwD3jmuRPQskFLTLKNVgO+DByyEGiQi16oAmAvnrTpDzXCc/nGcepuQPY9QSEooQrHaX9ze44ihcL+SIZlY8V7nB27kSEB8ntjQa9ePnKM7r8FG457Gg4OG5wxR3/AwJZx54EdH2PAAAAAElFTkSuQmCC" />';
}
return __p;
};

},{"underscore":"underscore"}],743:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="23px" height="25px" viewBox="1383 664 23 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g id="color" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(1383.000000, 664.000000)">\n        <path d="M19.04725,12.691 C19.12525,12.504 19.08225,12.289 18.93925,12.146 L9.93925,3.146 C9.84125,3.049 9.71325,3 9.58525,3 L9.58525,2.5 C9.58525,1.122 8.46325,0 7.08525,0 C5.70725,0 4.58525,1.122 4.58525,2.5 L4.58525,7.793 L0.73125,11.647 C-0.24375,12.622 -0.24375,14.208 0.73125,15.183 L5.40325,19.854 C5.87525,20.326 6.50325,20.586 7.17125,20.586 C7.83925,20.586 8.46625,20.326 8.93925,19.854 L15.79225,13 L18.58525,13 C18.78725,13 18.97025,12.878 19.04725,12.691 L19.04725,12.691 Z M5.58525,2.5 C5.58525,1.673 6.25825,1 7.08525,1 C7.91225,1 8.58525,1.673 8.58525,2.5 L8.58525,3.793 L5.58525,6.793 L5.58525,2.5 L5.58525,2.5 Z M15.58525,12 C15.45225,12 15.32525,12.053 15.23125,12.146 L8.23125,19.146 C7.66525,19.712 6.67625,19.712 6.11025,19.146 L1.43825,14.475 C0.85325,13.89 0.85325,12.938 1.43825,12.353 L5.38925,8.401 C5.42025,8.377 5.44725,8.351 5.47125,8.32 L8.58525,5.207 L8.58525,10.5 C8.58525,10.776 8.80925,11 9.08525,11 C9.36125,11 9.58525,10.776 9.58525,10.5 L9.58525,4.207 L17.37825,12 L15.58525,12 L15.58525,12 Z" id="Shape" fill="#AAAAAA"></path>\n        <path d="M20.01225,15.241 C19.83125,14.942 19.33825,14.942 19.15825,15.241 C18.89425,15.674 16.58525,19.522 16.58525,21 C16.58525,22.654 17.93125,24 19.58525,24 C21.23925,24 22.58525,22.654 22.58525,21 C22.58525,19.522 20.27625,15.674 20.01225,15.241 L20.01225,15.241 Z M19.58525,23 C18.48225,23 17.58525,22.103 17.58525,21 C17.58525,20.225 18.68125,18.061 19.58525,16.485 C20.48925,18.061 21.58525,20.225 21.58525,21 C21.58525,22.103 20.68825,23 19.58525,23 L19.58525,23 Z" id="Shape" fill="#AAAAAA"></path>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],744:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="22px" height="24px" viewBox="966 769 22 24" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <path d="M973.5,791.5 L966.5,786.5 L966.5,770.5 L973.5,775.5 L980.5,770.5 L987.5,775.5 L987.5,791.5 L980.5,786.5 L973.5,791.5 Z M973.5,775.5 L973.5,791.5 L973.5,775.5 Z M980.5,786.5 L980.5,770.531 L980.5,786.5 Z" id="Shape" stroke="#AAAAAA" stroke-width="1" fill="none"></path>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],745:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text CDB-Size-small u-upperCase u-altTextColor">Google maps</p>';
}
return __p;
};

},{"underscore":"underscore"}],746:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFgAAAA4CAYAAAB5YT9uAAAAAXNSR0IArs4c6QAAFuFJREFUeAHVnHlw3dV1x89bJD3tq/Uky5YxAowx2BgabKCFEJhQpswAmWb6R5tJykySJm3TpNOmZdopkE6bTDvTkK0kKdmmnZBOoaFpAw5tEnANttm8ETBxjFfZkqztaX3v6emp53N+78hXwisQoZ6Z97u/u/zu8r3nnnvOuVeKfW5LYUYWiBqqEufV0oeuKMyWn57Xy2w2J6lUhRTyOSkURcYzwxKvqLDyjQ0NkoiJ8A3lCoWCjI6NyY7tr8n6DauktqZGpgpTVrYyVWn1zDakL/4taWNj41a2tqpS9h3fL6lYo5TLlMTLK2Q4NyDlVUmpKqY0rcLapxz9gSazk5KMXhfXs6I0D7lcTpI6EEBKxsXeC4VpyQz022AYAFTUchBgAebQ8LDFAbq6skLGtRigdl2yzEC+4earrSwT5GD6hHmcCnhnIvLa5ujEpKxMd0kymZTsxJjVn0otlbJ4TFJVNdrHrNTUVFtfyaRu2l6UAOemRa6u6ZPMYE7qm5qMO21EpQecOj05IbEy5djpglRUphT8lOUCSFmyzIAgAS5mcjRBVqzskNGRMek+0mvvnk8IIGGc9/HJaOLqdXKYOACDMpNZqW9skPrSiiGtoqza2uI9nLhFCTCdzFY0S2v7jHUaAKGcDszBHFeuTcxMS6q+YRZMuAiCkyDnRlZBQVcB1NczLCu7OiLQgzLkeXnenVgFEc2dAOqEXHTxLRROFGmLFuA1LQXtfCQrnDtr6uptEAO9vSYiampqFdzE7LKEexETIVAsfSdESkWqXOrrlCNVTlaUQPF8wEKmSzxp9cKxuSldTkoVZSf3D1bQ8Ik+aVjSankObtguGbZ6rMQifFSVJ6yDYyMZyY6PSyye0MGn7D1RWaUytdaWLQAjF0fHRiPRoOIA2Q2AhXzWRAcigvhL2/fK9Teul2EZkoZ4o9UfggMMWf9O65wsH5bGZNrQcU4lAlczySO2F1TaipkPrn2kD6TToiPf5AZ6jstUcUZa2pcaxwJ0qrraNjVkIprDQP+AAR1XuQsHZ/MFA9N28JJcZoDjqkXksnkTDTXFRqlQLnRwLV/l7eDouGGBiLENKhaT/nyPpc1/wMXl1bWSG482vFnuLxVk5VD/gomI8rJ563F+j4P42nQke5vb2o1TyIJjk8o5dBxZPEu6yQEmomFSAc4MjcjP9hyQwpQCPT0tRR05IbT6ss453EsaWgmrwHb9WCRXTSxoWm2sVWrLxUBmUlgplEWMwMWsLq9DitHEOqDUZ1qQlViAR1zmKbJnaPOiurzmJmYHQFFkIFxCxxEVrvcCLO8obKhrqfK4gYu+W6zS3V4aJKOwlmt9sVRScjIhQzPKycUKaUmkJaH1AqjLWNoAxJBayttsYmfTVUYz0awuOJn0bDbS2V3mm+ailZyziKiIzwi/N0vZSK8/58+dU6tVS0DZZ+BObHbN6bRxLeBCAI3qRPn33LpBnnlqt4wMjRu4zQpQpehyVlDS0iFLKjoNXK8PgKifH8s6FB3+jsiA253jAZA2mVT6Stw1CFfn0DTigHbiZ9t0Rk/utt5wGOYnRmTzV+87a7nwmzf7jiI/NjQgeeU3liWylYGFg+edTQwOQnVjcK46Mdg733eDHNs7Iql8jXWDSemoWyGTZdGydkAdVApRp6c7sMQhQudgAHVrrb65xUQUZUhHXPX19JomYsCPD/fJ9n/5B7nxY/dLbedqyp2WThx4VWaQZ+fM93OrGp6YlrOZy3d1DthHuWrdsHTh904ctfZayhpmOYwCDBjQ2M1TOkgIUCIREjFLorwo2cm8zNQNSTKvMlQ5qiynqp6q1SGAIYie7vV5HnEDDDms4+/tHZTnX9ghQ5kRqdANNpGIS9fKZbJyZadWHll7z7+wS5I1zWn59Xu+JIQsYzg6FrRyqqWdKqM5UbBnJFfUUZWI9PpUJL9UPKmM8hxRk1JxOllUPB+NoaNyXK5uUw7RMpnBCaluaJKO1IpZjqI74UA93n/8mKSXLp0FnjLkIQ3hsPql6j/4xQHZuORqS2MDYvliofly9qH6t95jb8/bcu70/K1bn5Ply1bIjTddZ+ohm2vfRI/MpIoSU3lcX98sIyq+koB06MUfyyW/eqfa1FXSf/A1OfLcT2VKd8r69k5Z/q6bJV4ZKfhUPnz8kBx98Slrp33dddK2ap0BTcJxTX9x/x4pT9XKqg03yZIVXYLZG5vKykubfyida66Vnz/zuFpVWblow7tl2arLrZ7yYl5FwqjpuvqInCSskpK1ZIX0EYKBCof65kCEIZyK5VbXVC0Dh4Zl39G9srLtIpXlBdNZATesy+snpB7Pc3BJ9wlBZGXU1zE9XZR1V622dMqlUmquM6twkSo51FOtalx8upCXV598TIqTo5JR8J596LNS075C2i/fKHkFYmo82kRoBNr56NelRtWnZHW9bPmnv5Ge13YZxz//8Bdk75YnZWnXFQpwpWz60r3Su/9V49ypXFZ2/eC7svkbn5OG9FL7/keaP9LfZxOwd6LR9NvWtrQg03CgZIaGZwfq4NE+74iF1vZ2onMoBIbV0FTWKkn1VwwcUf1W1SjAMUut9FUIZlgRHA7Heuh5phvrhhjXX2EqLwMnBj3LwoQaQ7EhBViJ7yFX2ywy0ntcKuuaZOU1N0tSN4/lV2609FBMXHHHh4xrLWM6Jwef2ySNLW1yeOez8v77HpS6lsh8zKuw3/mT78utXSfl+jV3fVA6r7jaPj26Y7sce223rNx4i8WRpwwYAwJi43IACCFCA1cnIqSQ0/wdLq7VQhuvvVq2bH5WNv90l1x741pbzng2Ejq+cEJc9yUNbsUjh9OovvakE8f706LayuVXrJUtW7ZJc3ODLFveIcs6tE8zMzLTKKoYRvJ+ulicu121r16v1kmdPP7XH5Gnv3Kv7Nv8mBRUDQmpcekFJqtJq13aJaPHeyQ7qBNT22jgIhKgTq1r9PCBKFJ6pi+81DiWaFlVSsFE351LDA6wMSacCxi0/yjNQFHiXdEnzcHiHY3DQl2xcPLGjVeZH/jV3a+bIcJKpg5+cCmhawjEIQwJB/dUba9bv1ree9tN0rykWY4e6Zb/eGyT7N11aBZc788sB6OmYj7e+Pv3y9hArwwdOSB7n/xXGVNZt/quj1mjPBJqfkY8ppvY5JhNSIXK7mmVsw4u5SZGhhTFSl5nKZZImLnBBhfSBy73GqNUuAcOdn3SywIEei5cPFNUjaS52UBmQiAGBfCIF9OJcdZoHPmYUxN6eGhMrtnY5NVZedqgXojvpyoyMqkdbIxHq8SB8nybjNLewCS0XBVpN3t27JLde/bKmrWXSqPme51xNXyMUAxyo1r50AnTKBAPbWveJZMTc2Xw8Vd3CNoCZQ9u/W9ZesV6aevssjr2bXlc0AqQ3cjjzis3mLYQtXD6p3Ocl0AGh0RnvcOu+6I9uC4K4HBz77FjyvWRrxYH+ew3yrEH9nfL6vUXz1Y7HziPF3SZn468Pi/r5ZDrKy++SCa0zWHVJsj31TfLwRQeOnZQXvzeP9p35eqxyqtTe8MHP+X1WPj6M0/IjkceVBAnFcDrZOWG22SmrFxu+vCfy+ZvPyC7N/27cXPrqstk3W/89hxVbU5FQWTfJ74mk+oEh2LLl0jnve8XNjy4D8Bsh1aucJEwo5smecZ9KlLIh+rrIznOe1G5mJWApQXXZ4Yn1A+sjgUlN0gsMu+B+QyQgOSAUiQElfR9r+2T9g7dsNUxxETvffkVqdLjoiXNUR9c64g9sP2NZ3KICKi6odU0BDY5131Jh3sRFWyEvgGma9WmV9GXG+qTWEWN1NZWzdF1+Q6iTKgTE19zz19IvjtaKeUdDbLioY+bPhnPxrSulIGESKhpbDZQsZQQIQA6nxwUJsPkuAK8a8dBVakulnQ6Eg+IwpD8G9IcyDDN0z2NiXvxuR0yMHBydaNVvPumG6Szs90mhlW56fH/kaQDFDaYrIvkT05nRvgpzSmXqo+UeQR3iXpHo40lVdNsjpNQHofvFA8NkAtrIheh10OIsg7VNUZuxUwmMm9dJuOHgHzAvM/nOHPSq1Nm584DtsEtaWqg2Bu4lzocVPLDOokDFBugO4TIR/be8t6bTAx0Hz6uKyguKZ00Vop/zze3vPfdc9U0KnyrxERkS6cAXteZzOPXx6pleVNa6kqFK5enJd1wUsdFFJhPWFUj77zXSzgf2DCeU/ECAQjkomF+PR4PgbYP+EaBcvJyxHFA4QtecUG7KQf0k801Gde2dGJ7i4fUKq56+wH2zoQhgKeCI5cwj/cjf/oJS0KbCAHifXhgwLQFCrCZOEj2gT7CQYcAoZ5B7mSPYiefbEIuJz01rMs3KdcyANrrZ0UhftBU6A/fERIHZKiiscrCUjfs/Zf2mCNeztBKCK4Xwxym00P9/Rb6wAlZvh738oRurR0+0KOnx5E4CfN5ZwKsDp00uNHJQSTuExCmubhCTM2fbOKkA7QMFGVa940FAZjO4knjdyZ66nDUnd5st3HLcLFPhoq91unGlhbrOP5fgIWzcJIThgA4F7KzDw6OStvSlll1LmwbMIzLdTmbJqB1hhPs4Hp95Dm4rndTH+lh+6SxicIYyUxSYgt5s4fGzySPyQ8pvNlDOoNF5438v5FqNp+LGCzyEELF2/T4c3L7nTdYnIcDx7vf2nEZ7UA5qJQhjTgh2gvc6VpIWC4sG74vOMA0/lZBHhsaVMtsShJqkEyr1WWA6+0a5CTLHhBRpSZGRuT48UgmXr5ulXGsGyf0IwSbuAPMu4MXpsHBfoXAZbNrGd4u3zrx7RxDwzMWfagmtyp7s/cS0Hkz6pnDZGcHHxvJSkIPQ9NqrFTV1cnWp3fL/sqDNqy2dHSsFDmV5urD4bgBx0FmRbBS0GbUwjKQyXNwCX2yABrwnRYc4PPhXjrpg/QBu4hgM3HuQibyM8uNYyTl5EZ1e7LZcRlv3foL5NDBfpnU041Jdea0t+ekuTVtAPlh6qnaAiw/82OVYBVOqXx10PgW5xDgOgczcZnRyDVKnQu2ydEYNF9HjlJP/4Q76DxAA67t0mrBObh86e+4EZtbmu0wMqwRTl57pTr/9V5Ex4q0nuOpWyDTa5cIfQJpw8lclxoBXGQu536oZYBMuW1bX1QX6DbpV+0GcOkjhEzH5xxtmgXL88mwAgvxQGULze6ztYlcdWUfSwmuxJfrBEAOsKfZoLUcdGJwWF7ZdcDeGxrVhNeLfJmiggUwkwWbNMvUB9cBkLEsceQt5jkyOxMbkK62LnnggW/Ik0/+r1y6aoXeJJqUo4e75b77/0x+ZcPakvyP5DoriZVDuKAAn694cMPDAWDgeMzwpDnNB9fTAYYT3j0v7ZeOZc2y6tIL7NYPHKbH1RHpPGVjkbVXVZOS0RNqkk9k9fhq2m5uZqpHJBfPqtc1Ji/s3SE/euIn8pmv/Yl0pFulEFdHVIaztzrjakQDnJtRLmZCqmIXmAW5YACfL7gg8M8vJwVVDS5laeKq5I6aL+sIpYiDQ6Api447MTqpg04ZuMaJxX41Xyvs+J5vu0cOKcdGEEyMKVc3qijAvIa7lcuZiKpktZDX09ujjq8ySTc2aT8KMqVuzVR90oyJntxRmc5Pyw8e2yMHXj8kra1N8r7fVHVOxdWCy2AH5VxC7gizgyN7ARcyK6n0MaCGwJLsVhx31LY+87I62NfYMgfwzvoVpS9VBuvynZopyFh+1H5wMBdTADyR1IqVUnpdBXDJW3vlZXprKCYP3PdN2b3zFamp1CuyWa5RFaQx0SZf//x3ZcdLu+X6X9soWfVufeqP/sqYYsH04DfDwU1lU7Kxoc9ADQ0KQD2V7O2f7pW8Dljvq8jL247YTUqz1hQsODjckFxnJp+6qbM31zMLbmW+wcqzcWWU87kddKB3vzzy8H/J7u2vmkZy623vkQ9/9HdU1+6VP/zYPfK9R/RAGP+wyv+7f/eP5SMf/cDCyODz2dSMdUqPwaky0xqcS+eLhrAs79Pq2uZk98RwdNrr4GJ5JVXMQMhKgIYIqdtVLe6gOalL3ziwTP3RVQm1GlVc1DVWy90f/y1p/mSbcusuefAr31FpktBLhZfaZ5/8g7/0z2VQfcU9x0YXCuCTLr/ZHpzjy+hMn1QWIh9z+Ml80Ilzmsvd3+HuMWlqjbxZzvnkM0EOLnU5uP5OPvI7NBSyenpSmYy4ObwMc+1118jhQ92yddvzqkVcJZWV5fLlr37OJpD62Ez5LYgMPl/dlw46cUY2Gu9/w8bm+WHIOdzUUF7vAo9La5ceCqhYQEcFuLNyf4nDmQA/Wea9QkEiBHh0X/dzIAZeeH6nHtcvl9WrV1k3Nj3xYzuJRkzY6tG7GIteBl93sXKwykO4isG5LHVg4ULSM4ODEtcLL9Bgn/KxHj52reo0fRQRcSaAmYTIdI44/Jvf+r709+upuFJLS6N8+O675OevHZTP/u0XpKenTze9Ot38RuQi1Yfvvf/TgoGzfdtu+bu/f1BvOSnHq8lerueUD3378wsjIuho6Ko81w3vssoekRG9/5sbVqsquoxCXYXSxgQXDZSArdcLL2xcpGXr9EKM+oK5XgpNqArlf5LAhEAOuKl0JS6NcvTCtYKb0b9GcqJs1yUXyLe+83mz3jg5rtMLKViNXt+GjWvl0UcflKO64UHL2qPD0wXTg72zhOdyy5JyW0aWy11NGb0zV6lLVE+X1WOG/Y+VlVNgucfGLXhAda2A72r1UsvoyES0TDXu4JI3n1j+DhJA+ntYjjSfELiVX0j+HSGuT+r08u8IwGHnzvSOJZfNJmVcVa96debAbRCOHcBmWXsacrdeZR/6LVeeIGQyJqsDQBpO/IZ4qwEZpjsglEEsOPl7CHxY1suR5j4JTyNc1ADTQbghpX+mCvnuzmDgZPdRkJfTm5MONhe22zua9L6fngirjguhI3PnISTnTEJ+XgaZGxLthQB73nzZTX/4eb2Ue0cAfrN6sQ/sVIOFe21Aph4l5Lrrr7T4t/f4EDtKny8187sUeQNwzuGeT3iq9kh3QHkPKZwQbz3M/6W/n+mE+VSNhwP0zhM6xyIqzImjH8Px6M4N+hdCJ8GdW6un335ZtyT1T7UQGXCvv88tPTdGu05wcLiKPO4cTPi2qGmhVhBqC96R+WFYfn7em4mHZ3cO3vnU40D7NwAeUjipng54+I0dYJ9sJhhi44XeEsCnAupsAJ/qG+vJO/y4c82xOT0IQXaudRAp6Ho5Mt5UQ92IMTAg4q6vv2lLbrECZSN8Gx8OLhxr5q8iBpdi7QEuoAOm/ZWpvls5QFex1at/hXreAAPs6cD9/8q9zMdjPzvpxId7AdZFA6BBgAaY3NtwR1KUE/3NHMBzjAToTEb6fP3BpwOWRt6Kv8E7+U6HgOyiAVD5OQcTunzFY9ebVSszoBzg66bnRFlON86bg72C+eG5Xo+a/91ijzv30k9/xzEP2YmIIgg34xTiL/6d4GLSzklNOxPnUuHZRIM3GpZDFz5fdc3rWejQufjYZLc1zakHJxlZnE96pxvRcWT8kNTpKQeOeQgRYeqjxU7xOBuofBICdooqzpjk11zPpZ0zVvQ2Z6LmoVG4qKB6OJdNjeOl/FBRl35GuTMldfoPkg71d+vfnRT0PkpMkstr9O87JmdN9X2jlafm4HOxtN4KuCEm1LPYuDkEl77CwWbI6KnG0088LT/8z+02BP6MoqxML/jpYSj0xS9/Rv94My3/9otIXSPtDXrw2Qb7dgFL46ejxcDVfppNH32z83/Owb9E6Ci/UH7vI5+W22+/We6441Z5+JVI2nK7Kvwbnv8DhIvVBPHl9tUAAAAASUVORK5CYII=" />';
}
return __p;
};

},{"underscore":"underscore"}],747:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text CDB-Size-small u-upperCase u-altTextColor">Mapbox</p>';
}
return __p;
};

},{"underscore":"underscore"}],748:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text CDB-Size-small u-upperCase u-altTextColor">nasa</p>';
}
return __p;
};

},{"underscore":"underscore"}],749:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFgAAAA3CAYAAACIN427AAAAAXNSR0IArs4c6QAALs1JREFUeAFNnFmMrel1ltee56HmqjN3t9t92u223Z3YcQgWYFBsUIhCCLmIUC7ghgskkAL3RtxwgSIFReQiIMQFFyChKCiRAIGQCDgeSLvb7bZjd58+Q52h5trzPPA8X3UFdndpn9r7/79hfWu9613DX5l/+MHz9WK9isl8FqPpLKazWcz48T0iG5VKNRr1ehSLRX7LRCaTiXqjEsvlKsbjUcwnsyjkclGt1iKzjpjMprFYzKNSa3B/xGgyiWK5FI1Gg/En8ez0LBa5YgynoyitljFajON5fxin60wMSszDvJ/LLOLtGMdv/sJXY/zOf4tH//sPo11bRX1vIwqspdNdRjZTjGqjGYVCKZbcWyiXWW6eNY1jnclGPp+PUiEfOda2WsxiwjpW83lks9lYThdpP363WCz4mbGfZSx9Z/5sJqJRKaf95JBNOVeIOZ8Pe91YzhdRypeiubUTC+Y6Pz+NfKmY5usN+jEaDWK1WjF3MUqlUuQVgpMquOl0Gp1eL24c3EDg05gvVnyXixED9Rh8vVxHvpCJ3mUg+FJstreivrXJwhcMPOLafOxutINzQLBzBs5wXSvOLjrx4Ucfxng6j3J7I1q3ttOG+oPLGM/ZOKtolqqRY+GZxTSWLPJLX/5slGIaH3/8o6gyZ4F1HF90o7LOsfhGnJ92YrHMxEuv7ESwmX5/EGs21m63EXYlZuyl3+2kddVYa7PZjAWHf3l5GdusWyGoSL67f4U9Wy9joZKgCGuUZDmbhwJu1Rtp/ut7psNhsOkY8j4cDaPMfJPpMAb8riLl8tko5laRW04UfCGGEzSR03WSaqMepWqFzVUU/dVCxpMYrdexYNBAcx1gNupHj8VllmiwWjGZxozf16sFcs0z4RhtZsGBpiPYLNpUXGdjyqE9PbmMyWoWVU5isVqHJ3/OIa7y1cgO+7HZPYtXb/98zAdPY3RxEu2Yp8OeZHJRzBcjk8vHwc2bUSqW0+ExRNRYd5a9nJ+fx2yxjI2NDayqmjRUxVEBivlc1LC0sdqMxqq9Cq1QYFwsNJ/LJGFHfxlsJGn9YjKODBNUEeIaGWS5pnt6gfb22dk6KqVClIvrGPWxnNk4cqtS5JAb+pve8yvMFAuLXLEQjVKZTa/j8OlhMutivsykTM6GNjc3k9oXssu4ubsZ/d5FTIYTFoQ2YyJ1Fr5AeGqFp6rmaxVrPlOrDu7ciuFgHA/PL+Kj0/Moo1Wlcg7zXsclm1ixWfAhVgiiXspHA+EfHz6JGptv5WuRr3D427uRa7RieNSLvYOtyJWr8ezZYQwGoyijFIVSjkOdR7fbTea5tYW1tFox6F1p8qIobKjt/bQvzoXdBgcyT4LGRJMQt7a22TOWWixF9xxIY22DwSCmQ8wfK8hlEe1ilMaoAEXF/DrqrC+W2cguxzEdTSPLvTmharZcJM3NoRkrNExoeP3+60zLxGNweYA58CrlOBXBiRU9+OhBtBs1Bi4kzJtwTS5bYHGZGLOAFe8TFl1Eg7Z2tsHbWYKIbm8YC4TS2m3EAOyeDVksi7rZ2o0xMHCCpkXnNN68eSs2Yxn950+iXa9FGS2pNtDuGzfRRDC+UI7j49N06Ddv30OA3RiMxpFHo++9/hkWfoWXFxcXkeegtcgcQppxeGL0BockPvoa8ll/0I3heHCFwcjjgms3W200V+0uoIlotifBPRnGy+bU2A7z9tPcWkoeBW3WqkkZx+I5FjxALvmtnS0mmYBNF5hxMXbaOwlbOh0H6KUFbrZbUUa46+U8ZkDBGqSYDJdMLnazAMz/GsdrTPTw8GlUmFTL6IOnCjPPQvcO9mPVrkd/3onbxVasfjiOWq4VTy9OY9nk+0YpVtlJ/O2ffStKhx/FORqca7DJzXYc9y9j4/gsHvzkUTRYY6WxgQnjiDNDrKfJIVRxzNOYnp0kOFghjwoWqSCFvzkOzAPfAU+PHj2PBZ9Vq+XY3N5KB3hycpIwWKwuYpYLDlv4KBXBVyBsiAYXgai2++LzcrMYszJkAJ+BouLoS0BlBuiZRx6IzGLpNeSW2//rv/INGUEFr7nCgSjYDGa75BSxhCjkM1EGu3I6Aj7H6qPd3Ig6C63VwGs2UAIiKpVKFPm3HvXOnbvR3Ny4Mn/NE0HkELCw0WdB75w8jFG3H+WzSezWNnFlGcbI4Tyfx9c+dSd+/bVXovz04yj2zgIgjn7mCsMXnTHYh3bt3ACHizFlXL27h8viY4bQxMkaWs8yExNSuNcsJofFTdD07fbmldMCRcXiGQzKVw0NTJqLmWbZKCqVtDeP4ErApHCZZXwF6NyD4ZjDg5HAkgoolvP3UcrVGrhjXNeUV0BrAD2peb6S8EkzKkN7GghNx1eEf2kaed493ZkwwClqNjNYwBxYkerNXSwmpkOpQKEYnEXX0BLoFIs4O7+MixdP4tObu7GeLuNgvxo3dvehHGjJAuc2KcavfeUvBEcT73//nVgc/hg8O42Nl27EG5/9bFwOTpOm1qFqE9YvJVzrQ9i0rwVzq8VajuuTmilgX2Uw8Zop1dA2NIYbGINrpGleN2HeMZpakfIhuAXQtuY9j7BVoBm+YsYBSQ212hzQBcdFjpkrJ8wYI3zAAnmgoZFHJnlvHMMSBPF8nkmAADmhHreC5ywBA57EAtVfzpdpIfVqHcHn0XT4KNiuF/Y1Z7MzNF+qssJJLFb8SI59MYYLv4GjWtSLyUFuVZocHBCAVufHw/jC3dvxOh54fPwgilCcV+6/HINLHFnvNB4/eBTZaTa2NvfShgps0MNTe1WOJGTY0AyhjKFZKo7K4eceuALXulQcFUhtdO8yjDX78LWAhs4RUGaJk2bdOt4FWLpmrwXgpsKYXMT/yIdD3kDjjQUcY8i1KmEZiMmh8VPm1Gnm9ZACuZAwGkzA3wELrsUSKuaipGrpxcAThDBhsAKgo1NTuL683x/sCaEidBxmn4VNoWlZzEyzPMfhwO+ixeEMIfqFNZutIOgJBzvpxW5hHb/69hdiYzWIx+9+O8qZSbQ3dqN957NRe/oEmFlHC9jJgolHR0dpg86tALUe1zpg7bKYRquJgLJJmAp5zJrV1CLXVDj87mUnabT3+/lsNkmHUUWI2VIFOeB7uG8FO1iivWr3Ao0XJioItd/tcbAZ7oHacRBLvhNO/LdWUoQFDeHlGkleerUSv/D6ZcxY83PRBQYrIuQCVwlx2RWUCpqTQYBXQcWV4D19oyYFvMoAE3x/Cb5yYzRbGwhp48qJ6iiYtDAGeqotZi5EBuvIMfdWJRNv7e7Eawx59t57MXn2KBaj4/h+93G8fPcOVlRmsfmob+zEZacfW7t7ia8rVAWaLxfT/HLfLOudY54Kzn24tgobUJEUlGv3HkXidzkszUMw2hvIedmPXB6poS3zpJ1TaOeoT1TLAZThyyuEOwa3V/NPBGrsgHUwHWMTDzB+oAiVOuxCiRvartDQEjglEfeCxGG5Q43NIjTVvYRQyg3NrJ6+956VgQUbyCEsNcmDqnFIU75j/sRJR2M9rY4Uh6iwgMUpVOQQ09+pZWNvPYk3dzdigWPrvv+9qGemsbHfiimbPCPaG/WALuBh7xaWwtzSMoAsCU1zFw6qhPQ5nTHCKuGw/exaqAq6hAIs3CtBj0xByFK4lQohPQdliDuEH8+xLvFzRVAlI3CPjjMBeuZo+gL5FBH0GiEnT8qYmAtOFweIEsgkMh4qPw3oYH7NAK26TkivvEhOTgHn0EajmRUnZYwu8U4nCIb1OpcpmmIFf2YSWRxHjskk133w3BPuAQ1yYBlEuUq4CU8VR3ILokfg6MX5i9isbEazsIr7G63of/Ct2IYxlFocRBVsztQ5MAOVA4RBLmNZhMtrOWge+LTGy+axtLKahVCvX2KiNLGEYA0q/N1ILTl0GBOqHF0CJUNdLc9QWo02YKoUyU+gEApTCpqp52BSxAdDAwtggnnmjCvuO55jTzm0JVQ3RcAc9JrPCszH0iPz9999tB5+EgnVagA0J7HRbkaPaMhw11hc7dV0agzewuzHozngbgJlmMxQWpKSJbyvEfLO3j6JnWkM+DG2z2MZK063zzyd7gANgS4tCL+Lg5gfP4x//qt/M94c9eL7v/vbaHMvDl7G+dW4rJJH0cDSNYyk2I5pTsswiiJIwaG5Vh2qFpSUgt91fHL1MYfrmkrAXhIsQhFStMwJQi+jUPrfYZ8gA+hSWfKMo3PLMMfcvaMsVwmgOVDXSof0HPzf3ttjHVcRo9qtpnqACVo5sOnsKgTfhSHla5z+ZrOdBDPBPEbkGEqY2giHNgY3xeEtBm/CLefgyzlEvtXciUw1w2bKCdDVHB2Fp7nkQHqdLtkDcX1BngOuKCXk9I30FEYBR+KhTufjaMF/N9n0Bg767s5G7LOeVWGKFlejw/fHZxexVS3F3s1dwlSiyD/9MPYIPBSujEDhKTSh4vyMPASWk0JUfQibFoulbgrbw9gEHjpkq9rRgtUU0zUzhLKENibsRZPVaLhFgoj1isMDBo0KZR1q7vW/G8CFc2sFarH47u9q8iWJKZ1hXo3sYPInJEmKaNr29hZ0bB4tgog6JjNG0HNozwyn5QnJmU9PjxHpJylBuKCDTuHDVwIm9IYn1iu1qGHGRRxEB2Gi2wiEcBcMXZE1w+VFebCOOxtN0kpYw/kJ6cDT6BQIZcl76PkrzUZ8emM/Jp11vHj0MDJkwT7301+IJenNBWtK2AicmS5V0C0iJwVqeCzdWrFWIaRF6jQDNsos/P727dsps2Z0NiQwWDKXTr1MJOvhJMrKGApO2NDRn5wc408uookjzbO/AkrovpPlsgYjPyQEXOEP+JlxX89I+IwQ0QvrnIzRy5QFbEBzSghuhSnjumIK1xuS5apxgqbuxlNMCLXUwSWPSUTkRDqNAgmiqSoLPopdaqxONFElTjnDYiYssA81q2CW92/eCtI2sUCr1jiWOT/vvf9eVHfamJdhKUmo4k5sHdyNJc7TkH6TdWT43ANVa8T+a+3yXQELEbIGsbnBYbPJFO72gYQCOKvimNI0313f2EwBRefiLDpnp0nY9Ro5bwS2xgqEnTZp1gE5izrXm3f2QNbseUEgItQYgGVxbE20+vT0FKeKn+D7vILRlNokNzwxX2WckYPNMe8cXLAG3ciIxbw0TbNUCtgITlxT0L7LJEx6rInZjXRmeOqxThTTLGLOXBFThJ5hg/VWPQ7mq/jiSy+TOVuBz710QFKg3d2DqGxyT4kM3ZyFr8kn4ERGBAJjYKfEXGbFNHk1V0GqJFqY6xDr1dg82rggpL3AaSEqHLZsaJ2c2wQM14Gbf5kzx5rv1jjAROuAKaPULmzF8fb2OGD23MY3eYAvXjy/8k1cb0KoKMTw77nY7/ogFtscWh255m/sHUQPgu7gOdKH4tqw30uLdrIyGLlUA9GUucykwUa4foHzAVmT0N2Y5mpu10BDPJpCdQYwiCHYbI4jh8kUCU4k5aMVkRtVixxCaxHtzQYXcfTwEXlhHCvJnu32Tor0ytlGbNU34vSkEz/88ffQ4FrceuVVuHAHMzSyQhBqDj8qSsJ3NrsqoFnMr3UpfJWiyPzux9xuhSSPGjYDZoy4TvAZS3C6inLs7eymgMoiwvXLcRxbnD89PUF7yTvw7xEsZAEUVQzDkYWMbMX8E76zcDDlAPMuQILuAoeYTR/hmoYUIkrg7grhOoFCNCPmYlcchhrhKftSuFOSzUtOMws2qVVZDsAN1Qo1TBLCjTdnKARP7pcIzw22sZTbhSrR0SLu33sl1ttQrVU/fvz4Q7QTp0pq8mJwRhpwI75CjkI/cAquDQg2TBWmXDVaoom6frmu5mzAVABCFliSVilkaKVq4wRndnx8nLC1SYDQBnbGlV5ckP4c4JQGl100kuoG6YMyh9JoN3DcCxL5ZyhiD8zux639g6SQYxRtDszgtVkL/FeoQB4ZZHoBZpeA3bwUK+VTYQwFBLO/S64ArdP8ZQMmLhos5NaNfU4xgA5ibDQxURkk5gENoWuerkkWoaGIM8uThStiok7qS496hid+0r2MDydEYyxoSX74+Rd+OmqX/Th68DTyQ0Li3mHs3NpKQYs4V29uUYFYxsMPfxKrZjm22Fw5S6rSpDYLus5DJL7LWjJopB58H7NuHuzFmvWeneA80XqFbRg76PRwskveL2EVUCwEqulbvRjDd6Vm3cvz2N7cToo2GBCdQdsa4O8mDvMEiJBBmGVslBq8w8/R1hlzzdHio2dPEgzdvH0TDZ5JoMkDU1tTE0+eP7vyxGhfidC4DjfOogmn553EIDSx6RjvqPD4PGkt2pqzMIhZTqnFnRHrl3AsWaxADLzE+/bw2KBBbOFAZ5j66dFJHMIini1ycbe+Hw+eXsTtdTdutitEjuPoYr69BdhINaNU3ow2+d5JFW9NzquMRUgvh6QLDRbqBErbJJGuw+BStQCVAj8p7ZgsL2v6cNcSjguJJWzsXp7FJcypu+wk3i+GZxBYHeYiXbsKecmeoTxtaFd2BrVkrhyYXcWKKzo5LKJzchQrILEB66qgXDKSg+2NGEEtx52zyMtvTVx3OxeYmeEjHh1N8GZPrdMxsc6A3KDJrzmEKhtUewwNF1yXwUmYPcvOwVihmcWmMgynqVZbtmlSNnITEzS78+I4bh3cJPO0jMfDVfzsQS52738+Dv/oB2TbNqPbP4tchWwVGlTduIVj4vDg54vVBAghUc4cMysb4J/cfLDsQZ/aOKLtP2MLphp1OkKZNE5LHQMvFg2q7KNdb5E1WyWlEjpMs/rufxXgRJgbYm0PH5CXBmKEyjlWKlxukXRa4CSdf4ns1lj5BBKwRh6G11eQCrtgvITBbtzBWV0aOJ0mnwkTUiEzRwo3CV9nxmAW8YUMvqIOpQZf5QHWOLFNStpd8RwN0+ll+MygQzO+4PMmkU8Gjc+WV/FfvvvN+PTPfTn+4l/9+Xh3/JN41HnIZuCfDFwcCQFgDNraLOM8cYBTsLZcIxDAiZTKTfDRaGwsCklxEh+Vz874XGtzL5a6lhyMTmkGL++hoVVgTMjwe1OfCtTyVB6WY05mb2cnUbbu+SkWBb/lszl0tQPMNYGJlYIln1InaCIPis9hnyyhgP+yGq1wjGpzX/w7f+8bBhiJP/KlzswipQJ1YrNrZvoVso6EC/hB4JyqJuUC/ch3naA43gVvryq3nCCfufgiZirPduJLBHIIRBj2Pnz4AKUkF/zKnXj99VciU4avciij8Souj4j2qGJUdZhlvH4BdsKhtxDsuD/CeTIua7bImvkkSjTKQl3RTDbJupAXU6LHaKg4Kb7KX6vwY9estq0QjtVyrWHONT24tvGAWutYhtCOlWADq6giVBPzExQIU0+CtV9iyX4U8op37x+C57mv/oN//A3r+jqLDLiqs1Ko4tmSRSl4hTtiE2pzEcEX8ZpyPx2ai3T2FCmBS35mKamOY6zCn7Ps0LKKAtchKuAcC3Qp5EqjtdVi4WNKSaNobjdif+dONA4OSDtSY7vEgZ5TjCTvkSUbNy+zCbymZaPTo+NEhyYIyI3kOWxL60ahKVWJYIzcFIDCNqgQ9kCoJBiFphDGZNH+LGOGhk5wdGqp2i73r0Jb3eOY36fwaeGmhYNbIGgVroCDM1oEAphLOVBaQkacR1K8vBQtoYPqjdCSN8WchYxr4m547CRqol0+NqAAEOmahFtca1hqXlmMHk1JSLOQJbhsUmRGjkOYaFFGKmKGh6fd+NIXX4qnsAc1qgm2/vjyKGrPzmJ+62bcqr8at9++HXe278fF938YYxyv4WuuVSDqIuF9hgP7ZE1VqJTZtGJSBPIc7OEK1lwja0JJDPVlRmouS2KdcnW1FaEjFOEtw8EZieYRWBV4kE3IEloEYIbBExTOspcphBKkYFm3Gm9xE9/Df3OEqsBV9iU0tIasaqQh8joC+xkm66vOHM1YrlcC6IskjX25mevEhoJeskAXLhanF2wiaTK/+12K9PjeYueYhM2Ikrh55dNTDo1F9VhAkCgaEs6qgUV7Gpq78ZjUW/fRs7jdLMXPUBr69J1XYqdYi+n7ZOK6zwmjMVs8dgHI2ATGalRHagjAFOgUAY4I55c4ViSJ44GfAw0GAL5YNvuwmLuEfm0mQY+n5Cy0Kq6xVGaK0kDLiz2AKTCloxI+RvSAGECIr1MsODlYFCqDAmXxJ+5/zUGtmHNBWV/j8ZU3bpZuiUXYbyLkmtiNGzfSZP7bk5E/SuMuKVw20MSkuQjU0zf3KR77mZknD02vrAcy2lKr7JeQ5vT5boMw8sMf/TjKhJ/2Y3z3ne8DAwNaBihVjS9JyPfib/3M2/Hr9z8XN2grKN2gDrfqxOV0EL3xGXkTwnqwV7ZjY4jrN6lvtq5OOLvkENYZsmquDcsxI7jOkp9lh4BM6iczqZO0l/De9XltCevc2qKNgVStghZuLAsVSlkCjhbaafoSuFNTwRod9XoNTAqbyMAxHNN7tThhljqgiXYIOqDhRVY0NtCKGqQ6RUBpIwjHnCkvb/Z00+L5zpNb0D7l5qzTuVizSAMGLzFGhkUZ8YjN+4ShDRY9InTeJWs3ZJwiFOynXn2DKJLGwIuTOIEDZ2hF+o/fez/eoly0DZ8ubpKBe05NDvN88OgIujWloWWPtRi1WbiELsES5OxrxrdRRc3U8WBmqYwlPXOtOsUywYXVcBXimh2ZB1aRUrMKeq8SWUVOVR72MaIraUaetwaXtgvKl8L0pdzsLLItQfjRsR/Aux0vv0vklnrJBHy0wA+VvkIUl9RaF++/fTmAm3IDfpc0GUg3iOArjG2dio46ypSeRLPllRqqaT5DSdSbcnYVbKRziNRj5+Q8OiM8PNx3994mHT5HQMcl3ZZ0S3L5khzF8xeH+AA6LJm73iL/xsH1ic5cg+uxtmhgZK+Ce0A/sQ7slEWlijgC1jGbAhjCclLegOukfeKmwldpFLidSh6EyqJlykW1UjF4lTQ/UqdRhfVKQ5XFlM8dP0+McMn4c6ii96eanIOqmZpaEiiT+m6/gAI0vWdRz5c0xpyx0DHE615hGLjMhtyYJW2rviWcDn1QSXuEHsfzlQU3l2jeCLzLoV0NFlLf3o7MJdVk4Ofk2ZOIO7SxgqsE5STuYQGkNge0Kq3INt2+c5NghmSLcIQWZqdsgvVnwXbfDXutl7Fn2AG1Re5P36Mg6ogBiDmUDMLXqaU1M5bm717dz7Vm6mJGcnksZAF2G/GqZjJeKpFksdkzWjzlPn3PGOzP4jiLKM8SbU73iIvEV+kEFbCnKGVzsuUSusEA4q8nn+AAUHdRvq6iOReGtjBKzlPmc8NWy9tiUJ/x9cxmluYIuQpreYjGmiYsFzkQHMfZaT9eXJJztpuWe+lOoReFxg02AMoRxfkN1yZyv06JnhJwIYx5+HMO22p2AQHLdBTkko3O3CyCFzJWmJjtAz3WRGdputY9uD/DfnO57kv/UUU5lMMMiBnIsXFySQmBAS20jYJ58O6HDloCH+iogQh+R8VLKQIgE4HB39moIXI6SU5JwTqp6m0rlL/jH1kxq+IGnaNc+dqkrg5CBwkEAPrec9XQfBW0uNAipmt535So4yS+ygITXaL/YUHOOVdDk0mcFOrl6Bx1Ypcoby9LM926E104bx2t7IOBtqcaOZVRQw89z6FO4MlCmsrioSsw16VQLI76b72+c+tXpG12BGlVhvQeSpPgxR7kIde5N1/KwJ/FkoNingr5EIVqZ88ChXGfOvNUTWbv1h512spvidJ5D3isICjo8CFqmBaYkhoIxjL4/9NaTMyJUQ+rxC7e2p0m5edpQ3wuDj0/O0vaa7+u418J+eogPWF/H0DwxxPMHmHk2+R261gI5t5h87XN3djLDWPfLmU49Jyqyx4aW6zZ3ILXB860mClzO5ZaXJwR6cGEtBoFZVGzBjZbDLAz3QqGnTmpZG9QxXb7ON/RhQGVfgW2g3Dci07acVUErXmkhfK7exYCOxd0oANF8L6E5bblqjvVViNdXwUGbfSecVh5HZoanDwhk/hyoQ7oTxIqBqqTuxbwxNwvxpuDDbi4dGK8m0m6wm6Lp1CUT0LwZDZols1xlyTZkSYeH6fUyMXJxXl89OJJPJ9gTgevxufvvhydpw+iQopww8WA02tytPUb8F1yACME7FqMMoUAN+1B5q2mAAd24BjVudakoWC9FueejEJ1fmhRCk50Xu7fViuvWdI+oCV4nzldqybCDjekYKlAQ4c0LdXuZBIcpDkWo0stKW+Z37AeH7HA2kZ96oOeliaSnBxmp8BKZTXPRgoBQQegFsL71FRM3Q4e4Dp9ltqHWMT8E5jhUOPeyy/FGVpM/JIEoJab5lOjBlwwgpUUGLNKmnGfGt+a/uDsBc9qLDJxRDK8iVOZkYtGXZi/EF0cTa9PHQ1cG2aIxkjUlOiTWLMOUBPnZycoTdAJZniOAwgZkBy3/dZqt/Bkr90SOtmFkUjFDihLmW9OSsNC18wp1cwgsA1CeJWiyPav8hgwHL5bU7pSDjk4cMJ47lNGshijuTEdTfaEdCrnrBcmotDr5gu4yBqVA0ivqlYfmChhMVrthUKAWqmjGJM30BVLWzSHGqxAE7EWZjNcAe0qkExJURWtntbjdKBMFLv0CH909BRW0I3qqgn37UUPLtyo70SWPPKS/ogmGjEl8zbDgoi10exb8Xz4DDyeASF0YXKAg0UvNje2wU6E0Z0QYGyRtH+c6FofTFZJDijvn5ENKzSIGglkrJJMwc2tg5149Pxp1KmmTKFkhx99TJp0h07PnXj80U+IDun6pMBQwDGOx9C7PAwBB3t6yt5QlCGPD6iUVSrkfn7Sox8avq5zr9fa8fTFixRP2IWUv64IKGRPc0oOWByVOfiZ2meaUQHLDbehVLbzu+BLsM2nbBSuz01wtokPv2ACvXwF4WuaZ2fnyRSLJHmalGBMovggybAziSPqbXPal/Yb2/EZhL9FKjJ/9Czqo33WgxJjiuc0CO6zngrdPi2CFXYXK/jmArh5+uKMFOSSam83jp4/J9LskK/djFdeeSm6Jm0ogT350aO4efuGHC0pS6paoOGPz56khr6b+9uUsWZxfPI07t29RSUaDKc3YkLwY6IqT7tXk2rKwmQ3EHRK37K1xhkbbxPcmH1s8e7+u2hxk70zEesHLqxhCQtqqe86uGsuqAaLTeKUGi2MlCkYrkdXCWpzGHpQJWEyR56IDRG2XhUbuZmDwcrBJZx2old2aH7+82/EBRDQ7cCjB1Q8uGhydgJ8cJjradzKLuIGXT1SvnyF/CwVimaTlll4tSFu53kX6GENMIAJWGcDdIf8SWt3mzJ7Pk4RbHtIuIsPqAFDm3TDV7PQtynMA9hpkalr0oCYe3WThr9BPKfPo7nVIAd8kGqSJyhUQ63BxxD7kf2DtrLHGdoP94i9l17CNTAv+8XYCP9pRWC+HNYqv09PNLGnFRaXMFhB6ix8Tw4OzRXsFXhiBzqHT7R5gtb1WZR5XzNvRfvNcBbiF26Qd+J2yukKXwg1jXmdKHJMQ9Z3vvPtNC75uajT0+aTTZkmJRme51pRlMzSI7HB4wR0IMScsku7Tj9GzQSO9TUoW+k21WCwF4bQJGkkVP0Y07770p24dXMH6Ciz4QtKO/Q7gM0v37gZTz5+iFMmVWnICbedYeaNGxsEC9C7MQLexSp4JODF4UmUslgaOF6rbLAjLJM8hhy3BtSUm3QczfrsQyy+enYQ20evzJ9zD1V4nwcUw6ccUv6S007OC4lLqdRStdDPzH0q2Gv48ACM2GpzYn4Ep/A9EDvNTTbrzU2AmHfQ0ZhosXlvgmDsSahwGBWep9jYrLFAcG0EBeNAptwzxQFRh8CMJ/Hq/l68XIMGoi0fvvcu9TAiSvIlLQ7i2fBRcBZ8Y/YLTCRYKRdZ+4p62YQ0Jti8Cx6edoax6hLKU86iRSjKaHoLrRWz/U5KdvYUiKDL/q23PxMXYPtPHr5P0NDmuTy6L2mgGWGpZtiyWebndMoKGPpXtrfOQ2JvbXIWZX6UkQ+9nEPhXnvtM4mZqGS0Tl1liYQAYULt88kb/y1NU4A6N7X5CiLonAEXVYREZzBZWCKpQUJhHJkTcULpBG1OMdIxf+wJG/F5uuUqnBKMY5lgIO/QG58x87k3g+MCWl5GmzNAxgUYu8cgUxI8wUaKmuG4i8+WJgJFcNACD9S8efcGs9LWdXwU52jU9sYOAsCmwO7Hx895jGEPFgKMkd1bAxkNYKdW4YHICpZAR2eFiskeWJxZ85DOOdo3JM8xJLBCe03wLMh/dvonFH8PwfdPUSbEiSMTK8k9hGofiJg8IkFk15IBiYqaV6AKRe305XvSVG72XSH6kzSV6CUPSzBcVFMVtGZSRUhOJglHqRNlM/Nkl6G9BTXIuqGseD6Cu0p5rH1BoOCO1NRIQ56DyQU2mcH5UIqLDAewprC209qJ0sWMTV9ifvYqUDyFXBTgrBvQoyVV30z3JPHq08PHMTzlGTxqfoHTCVjCHDYzJIUZW+3osb78nGMgasvyKG+ZyQddKNVHj+MOB7S1tReHj08QMlFdrpagq8k4NaLLAZBzQSV6yaNngyfPUlKdi8hDkP7kQR+0BHZyI7EPyeMCOml2LW+/gC8xWCHKGOxKvw4OpCM+hGhIqLMz+vF5tDUmPSZxIkxcH4o1BP89JCsnO9nc3UqHYBlmTrbMpjhbZNdGbQQGy9FVZSRPOchs2O7BdlQWO1GlmrvBZuW77Rv3UtPHKU9fjgsz1rIfhzxeW+H+W9tbRGf1uED4yyEN3U/Po0oP2Shbjvee8sDMrZdoGGzGza/95VjyZNHt7bsgKrQRx3r8wfvxrf/xezEFRt585XNAyzDe+eP/I0LFvTufQ7uBKHIdPv0EaQTLeUASp9Cmn3kFtC3sy0DBKpVC7MIiqOOzZ/mwqQWSWyiSzCTzLx5frq8xVmflS4iQSVju8SU2+5OwmunqtLvOMQcF7o95YPmzmi2cWAnxWqMtm/6ux/B9hPkvLWDyXZ6+h/QwDdxypoaziRxQkYHWffWVl+Lrt/diE4uY8czc0wc/iKdHDxHIUewADahePHv8MN64fz+1pH744U+A2lasEcphfxTnjLn75tvx2l/6KzEqbcX7/VP6kSvxaRzkJuvYBu+3aD/pf/xuvPeH/yHuIKDx6YvYarThtrIkODAWVN8goOHaLF34jz/+Qexv3wDLoXLkTS54du+UAmkRDd9AmXIWUvE7DVoIXtjscsYjcb97MqG6/EmUxlBqoAljtblLt48xtULTcYnXdRpHfAhbfPYQNHtpmPiM5Sf2IVu4OhBsGbHncXh5NMH/xKqHTw7h0zSCgL1aENmMqEKTZqS5urCGGodwj/G+BOd9a78ZsEruXER3RY5g1osaCZ8+Duq73/lWokRa2YdPHkUW5zYEo3v83P2pn4n1/o341uNn8b3D4xiYeWvTN4Ef2MVvfOXVe/Hl3Xa8BRTlLx7H6oN34uk734kiDrlPRaNAoLIFL7/oU2EGTqo18h1wMv3NcFwCUj4Fx+VxBr7vEDTJMooIuImMLgmYbGBEfSLz248u12boFZjN02KpVQiFbs0t4S+arJYrRCnRk8MXiaJdO8FrKocc0vVe64+Cn0PulzgbHyRf0k3pg4P7bcwfjlkGuz3xLlp7ztPqrJuyDT0GsJIsiz5AC9+4dStutBO/CHrRYRqUrb7/w7hLU0qHQGcBlp/S5vTh46exybUNhPrRER07GN/HFFcfn9NETsP43t1XOdxcPCaKHC3OaDocxFs4r9/4a1+Lt8nmZX3o8YPvxX/+3d9ifTzAAjt57UtvUT05BU8xIyJXqxznPajimHbZJg8zsj7ElvrsDNCsUhfgxvsId00EOoCtpIT7dfLCU1ArU55Tp4WAUxmeNlI1+vjsNGF0GU2Zz694sxrvSyFfv6vBOjF5oTmNMtqQg9wblBB1Rhaln3VIMtFI0qA8NUGrJpaZSFEW6nQ3iutCDJHa5YOPsRJ62C6O4/m0iwNaxAFBw80t/lwBDnfJDoWdY7qKVs/JPTyDrpXpYYaeFes349VX7pLf5fkPMHrSn2I59+Ix1xZqmfiD//VNei/+fXzjl38pvszTo7FzGjkw/qJzGLnpRbQ+MNeLUsHDO1jxCVEnni8qW/vJsfnQeRuScJMeOH2Y3aQj+u56J1BflKtVhUf/zmGPHmOiOJRfiqFzq3OT7+nBbo1C7eZdwfljdJTwGsEo4GuNVchqvIXD1DOM5qrB1vx8V6N9xi5PRFU3gcTZjAlFR2jIDKfSxRMPdZ6wlTqH04KKZeXRBBRGeR346BgB14Ec2wdOoEeXOGUMg/UBc9I88honZxexS8qzVWoiVB6yvESTeBSgybrzrXJcNBdxfEmbAHmVGtm8rxAB/qOv/bm4RxT54Pf+bVz+yX+P7eUFHfpTghZwnSxen+LmI8a5c/8NWrXIA2PVC5TOP2dgd48huW2//oWCRr1NugEWQgqApz39yyUkcDBLHVYqAyEkYUNss+bkd74Mq7fIRXQpgCb2YDj5/72EFzNXh9AlX6b6UjoRuLBLyKxTTazGfCy/+9dSgEsyazg9zNTM2AJO6qYUyHJgfZCoiJBwANM4RfBHhKQDNHpnCw7L9Ke0sk7JEfgUaZsngpokdN544w7Y2I8nz56TXzjlAcSgIQ+Oizauipk4fE60BiU4Y60P0OzbuUr8waPj+PpeJT71i78Yf/hHvx+trFm6HulPCl9UWxbA2nkP6sWfUsjgjGv06jURbq1ANMvhesg+D+B+//jbf0zTIo5v71Zk/vURlSSErFcXBtLJICjLIArYKO2CvxySSksISm23gipGmxdQexX2NUT4eRMLsFnFlxruuGbrfIg6B4PQ6xpB2t9lCnPBGMfQvx7amSMQGNLWWlzkeeqTyA9NyKMhY7C6g6b7PPEMR2Q1wV4F593BZA3bTxDmBRRvc28LBiSNws3ADgZEaU/PT7CMCVSRKnVmMz56RmUEk4YOxBZPxn+2tIh/+ktfjT8Pzv/pv/lncfk//1PcouR6CyH1skDi5r049kknPHl5DB2kgdxHHnTmZuks42OYBDYl/nrARfzXP/pmTKGZmd98cLoWZ5OmAQUKzGjLl7QrRSsI/xoKdIDitAmW6w5zf1eI3pvaALgfn5Cgxc/8zuaTDFqZhzcSZKaqbJH8r7zbR2+bO5sxQYgmgYYkgYo8artLUNHE+4ufj8lBXCLUHMmmyYxQl6SOOYARZm6C25eMJEWYaLuhbYZe/gycO0fURoWOZD89c30aztdbOOuN+BPYDHgYDa3nyY/id379V+Lr3LN7+N34V3/3l2OHAOZNHkTPt2/Gans/tt/8clzgK5qwigKRnZ3xF4TMYEGqNba4pu1TqK+9AR/F0dy8F5nfOuojuyssvdZEE9IGCmqjJ2Q6ThwWSsRYHwdQqNdaa5ZfzPYzBavmS4f8zPuMFq0ycHxkxngYG0FpKXCbNMdcmMJStCJDjy26M8cQeTvZndMch1azInqUL6+gc1YhtKAabagqx5jyjMpgZGmE+e4HP+B5tt1Udn/49FGaUz+yS8m/vML7E/C8AP/f/SGeDOioo5FfwgP/y7/x9XhtPYiz3/930f8Wf5DpO78fb7z5ZjzH8S1xyK995gsxPRnE1s2X4wGQ+u2PH8XdL/1clHdukWx6PbZf8g+CgHs4YsK3yPzTj4+A4U86dFioAlFQCje11DOIAtMELaG4UTXcsNiX1/k3FxRmevyfw2qiFR6QyT5fKYHEu9cpDEtHjqHDdG6x1EO2B8ED7dMXZpuTuQyFbp9bCYw1T52OgH/rK7QMgcjalwdk+F4F2sbjqxyIHUQeRJfqguOavz56wYOECGqOZU1xxifAxJIETvfF03gZfP/NX/sFYIK0x/AkvvlPfiOyL35IgmhMA3eVbN8oHj7+EY87fCVWBC9nJK6Kr96PG1/8OTJz91mb+T/+DA8OkeWlhyn/L2wDeLbycE5IAAAAAElFTkSuQmCC" />';
}
return __p;
};

},{"underscore":"underscore"}],750:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text CDB-Size-small u-upperCase u-altTextColor">tilejson</p>';
}
return __p;
};

},{"underscore":"underscore"}],751:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text CDB-Size-small u-upperCase u-altTextColor">wms/wmts</p>';
}
return __p;
};

},{"underscore":"underscore"}],752:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var BasemapCategoriesView = require('./basemap-categories-view');
var BasemapSelectView = require('./basemap-select-view');
var template = require('./basemap-inner.tpl');

module.exports = CoreView.extend({

  className: 'Editor-inner',

  initialize: function (opts) {
    if (!opts.categoriesCollection) throw new Error('categoriesCollection is required');
    if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
    if (!opts.basemapsCollection) throw new Error('basemapsCollection is required');
    if (!opts.customBaselayersCollection) throw new Error('customBaselayersCollection is required');
    if (!opts.modals) throw new Error('modals is required');

    this._categoriesCollection = opts.categoriesCollection;
    this._layerDefinitionsCollection = opts.layerDefinitionsCollection;
    this._basemapsCollection = opts.basemapsCollection;
    this._customBaselayersCollection = opts.customBaselayersCollection;
    this._modals = opts.modals;

    this._initBinds();
  },

  _initBinds: function () {
    this.model.bind('change:disabled', function () {
      this._renderSelect();
    }, this);

    this._basemapsCollection.bind('add remove', function () {
      this._renderSelect();
    }, this);
    this.add_related_model(this._basemapsCollection);

    this._categoriesCollection.bind('change:selected', this._renderSelect, this);
    this.add_related_model(this._categoriesCollection);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());

    this._initViews();
    return this;
  },

  _initViews: function () {
    this._renderCategories();
    this._renderSelect();
  },

  _renderCategories: function () {
    if (this._categoriesView) {
      this.removeView(this._categoriesView);
      this._categoriesView.clean();
    }

    this._categoriesView = new BasemapCategoriesView({
      categoriesCollection: this._categoriesCollection
    });

    this.addView(this._categoriesView);
    this.$('.js-basemapCategory').html(this._categoriesView.render().el);
  },

  _renderSelect: function () {
    if (this._selectView) {
      this.removeView(this._selectView);
      this._selectView.clean();
    }

    this._selectView = new BasemapSelectView({
      layerDefinitionsCollection: this._layerDefinitionsCollection,
      basemapsCollection: this._basemapsCollection,
      customBaselayersCollection: this._customBaselayersCollection,
      selectedCategoryVal: this._categoriesCollection.getSelectedValue(),
      modals: this._modals,
      disabled: this.model.get('disabled')
    });
    this.addView(this._selectView);
    this.$('.js-basemapSelect').html(this._selectView.render().el);
  }

});

},{"./basemap-categories-view":735,"./basemap-inner.tpl":753,"./basemap-select-view":764,"backbone/core-view":1127}],753:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-basemapCategory"></div>\n<div class="js-basemapSelect"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],754:[function(require,module,exports){
var _ = require('underscore');
var basemapProvidersAndCategories = require('../../../data/basemap-providers-and-categories');
var mosaicThumbnail = require('../../../components/mosaic/mosaic-thumbnail.tpl');
var BasemapModel = require('./basemap-model');

var DEFAULT_SUBDOMAIN = 'a';
var DEFAULT_X_POSITION = 30;
var DEFAULT_Y_POSISTION = 24;
var DEFAULT_ZOOM = 6;

// 'CartoDB', 'Stamen', 'Here'

var BASEMAP_CONFIG_TO_BASEMAP_ATTR_MAPPINGS = {
  'url': 'urlTemplate'
};

var createLeafletBasemapModel = function (category, basemap, baseLayerDefinition, assetsBaseURL) {
  var value;
  var currentValue;
  var label;
  var imageURL;

  var basemapAttrs = {};
  _.each(basemap, function (value, key) {
    key = BASEMAP_CONFIG_TO_BASEMAP_ATTR_MAPPINGS[key] || key;
    basemapAttrs[key] = value;
  });

  var type = basemapProvidersAndCategories.getLayerType(category);
  value = basemap.className;
  currentValue = baseLayerDefinition.get('className');
  label = basemap.name;
  imageURL = lowerXYZ(basemap.url, basemap.subdomains);

  _.extend(basemapAttrs, {
    type: type,
    name: basemap.name,
    category: category,
    selected: currentValue === value,
    val: value,
    label: label,
    template: function () {
      return mosaicThumbnail({
        imgURL: imageURL
      });
    }
  });

  return new BasemapModel(basemapAttrs);
};

var lowerXYZ = function (urlTemplate, subdomains) {
  return urlTemplate
    .replace('{s}', getSubdomain(subdomains))
    .replace('{z}', DEFAULT_ZOOM)
    .replace('{x}', DEFAULT_X_POSITION)
    .replace('{y}', DEFAULT_Y_POSISTION);
};

var getSubdomain = function (subdomains) {
  return (subdomains && subdomains.length) ? subdomains[0] : DEFAULT_SUBDOMAIN;
};

// Google Maps

var createGoogleMapsBasemapModel = function (category, basemapAttrs, baseLayerDefinition, assetsBaseURL) {
  var value;
  var currentValue;
  var label;
  var imageURL;

  var type = basemapProvidersAndCategories.getLayerType(category);
  var generateValue = function (baseType, baseName) {
    var value = baseType;
    if (baseName) {
      value = value + '_' + baseName;
    }
    return value;
  };
  value = generateValue(basemapAttrs.baseType, basemapAttrs.baseName);
  currentValue = generateValue(baseLayerDefinition.get('baseType'), baseLayerDefinition.get('baseName'));
  label = basemapAttrs.name.replace('GMaps ', '');
  imageURL = [
    assetsBaseURL,
    'unversioned/images/google-maps-basemap-icons',
    value + '.jpg'
  ].join('/');

  _.extend(basemapAttrs, {
    type: type,
    name: basemapAttrs.name,
    category: category,
    selected: currentValue === value,
    val: value,
    label: label,
    template: function () {
      return mosaicThumbnail({
        imgURL: imageURL
      });
    }
  });

  return new BasemapModel(basemapAttrs);
};

// Custom

var createCustomBasemapModel = function (category, customBaseLayerAttrs, baseLayerDefinition, configModel) {
  var name = customBaseLayerAttrs.name ? customBaseLayerAttrs.name : 'Custom basemap ' + customBaseLayerAttrs.order;
  var className = customBaseLayerAttrs.className;
  var urlTemplate = customBaseLayerAttrs.urlTemplate;

  return new BasemapModel({
    id: customBaseLayerAttrs.id,
    urlTemplate: urlTemplate,
    minZoom: customBaseLayerAttrs.minZoom || 0,
    maxZoom: customBaseLayerAttrs.maxZoom || 21,
    name: name,
    className: className,
    attribution: customBaseLayerAttrs.attribution,
    category: category || 'Custom',
    tms: customBaseLayerAttrs.tms,
    selected: baseLayerDefinition.get('className') === className,
    val: className,
    label: name,
    template: function (imgURL) {
      return mosaicThumbnail({
        imgURL: imgURL
      });
    }
  });
};

// Color

var createColorBasemapModel = function (category, basemapAttrs, baseLayerDefinition, configModel) {
  return new BasemapModel({
    default: false,
    color: basemapAttrs.color || '',
    image: basemapAttrs.image || '',
    maxZoom: 32,
    className: 'plain',
    category: 'Color',
    type: 'Plain',
    selected: baseLayerDefinition.get('className') === 'plain',
    val: 'plain',
    label: 'plain',
    template: function () {
      return 'plain';
    }
  });
};

//  Factory

var CATEGORY_CARTODB = 'CARTO';
var CATEGORY_STAMEN = 'Stamen';
var CATEGORY_HERE = 'Here';
var CATEGORY_GMAPS = 'GMaps';
var CATEGORY_CUSTOM = 'Custom';
var CATEGORY_NASA = 'NASA';
var CATEGORY_TILEJSON = 'TileJSON';
var CATEGORY_MAPBOX = 'Mapbox';
var CATEGORY_WMS = 'WMS';
var CATEGORY_COLOR = 'Color';

var CREATE_METHODS = {};
CREATE_METHODS[CATEGORY_CARTODB] = createLeafletBasemapModel;
CREATE_METHODS[CATEGORY_STAMEN] = createLeafletBasemapModel;
CREATE_METHODS[CATEGORY_HERE] = createLeafletBasemapModel;
CREATE_METHODS[CATEGORY_GMAPS] = createGoogleMapsBasemapModel;
CREATE_METHODS[CATEGORY_CUSTOM] = createCustomBasemapModel;
CREATE_METHODS[CATEGORY_NASA] = createCustomBasemapModel;
CREATE_METHODS[CATEGORY_TILEJSON] = createCustomBasemapModel;
CREATE_METHODS[CATEGORY_MAPBOX] = createCustomBasemapModel;
CREATE_METHODS[CATEGORY_WMS] = createCustomBasemapModel;
CREATE_METHODS[CATEGORY_COLOR] = createColorBasemapModel;

var BasemapModelFactory = function (layerDefinitionsCollection, configModel) {
  if (!layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
  if (!configModel) throw new Error('configModel is required');

  this._layerDefinitionsCollection = layerDefinitionsCollection;
  this._configModel = configModel;
};

BasemapModelFactory.prototype.createBasemapModel = function (basemapCategory, basemapAttrs) {
  var baseLayer = this._layerDefinitionsCollection.getBaseLayer();
  var assetsBaseURL = this._configModel.get('app_assets_base_url');

  var createMethod = CREATE_METHODS[basemapCategory];
  if (!createMethod) {
    throw new Error("Can't create basemapModel for basemap of type: " + basemapCategory);
  }
  return createMethod(basemapCategory, basemapAttrs, baseLayer, assetsBaseURL);
};

module.exports = BasemapModelFactory;

},{"../../../components/mosaic/mosaic-thumbnail.tpl":462,"../../../data/basemap-providers-and-categories":614,"./basemap-model":755,"underscore":"underscore"}],755:[function(require,module,exports){
var Backbone = require('backbone');

module.exports = Backbone.Model.extend({

  defaults: {
    default: false,
    minZoom: 0,
    maxZoom: 21,
    name: '',
    category: 'Custom',
    type: 'Tiled',
    selected: false,
    val: '',
    label: '',
    template: function () {
      return '';
    }
  },

  getName: function () {
    return this.get('label') || this.getValue();
  },

  getValue: function () {
    return this.get('val');
  }

});

},{"backbone":"backbone"}],756:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('../../../components/mosaic/mosaic-item.tpl');
var AddBasemapView = require('../../../components/modals/add-basemap/add-basemap-view');
var AddBasemapModel = require('../../../components/modals/add-basemap/add-basemap-model');

module.exports = CoreView.extend({

  className: 'Mosaic-item Mosaic-item--dashed',

  tagName: 'li',

  events: {
    'mouseenter': '_onMouseEnter',
    'mouseleave': '_onMouseLeave',
    'click': '_onClick'
  },

  initialize: function (opts) {
    if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
    if (!opts.modals) throw new Error('modals is required');
    if (!opts.basemapsCollection) throw new Error('basemapsCollection is required');
    if (!opts.customBaselayersCollection) throw new Error('customBaselayersCollection is required');
    if (!opts.mosaicModel) throw new Error('mosaicModel is required');

    this._layerDefinitionsCollection = opts.layerDefinitionsCollection;
    this._basemapsCollection = opts.basemapsCollection;
    this._customBaselayersCollection = opts.customBaselayersCollection;
    this._modals = opts.modals;
    this._currentTab = opts.currentTab;
    this._mosaicModel = opts.mosaicModel;

    this.add_related_model(this._mosaicModel);
  },

  render: function () {
    this.$el.html(
      template({
        name: this.model.getName(),
        template: this.model.get('template')()
      })
    );
    return this;
  },

  _onMouseEnter: function () {
    this._mosaicModel.set('highlightedAdd', true);
  },

  _onMouseLeave: function () {
    this._mosaicModel.set('highlightedAdd', false);
  },

  _onClick: function () {
    var self = this;

    var modal = this._modals.create(function (modalModel) {
      var addBasemapModel = new AddBasemapModel({}, {
        layerDefinitionsCollection: self._layerDefinitionsCollection,
        basemapsCollection: self._basemapsCollection,
        customBaselayersCollection: self._customBaselayersCollection,
        currentTab: self._currentTab
      });

      return new AddBasemapView({
        modalModel: modalModel,
        createModel: addBasemapModel
      });
    });
    modal.show();
  }

});

},{"../../../components/modals/add-basemap/add-basemap-model":268,"../../../components/modals/add-basemap/add-basemap-view":269,"../../../components/mosaic/mosaic-item.tpl":461,"backbone/core-view":1127}],757:[function(require,module,exports){
var BasemapMosaicView = require('./basemap-mosaic-view');
var BasemapMosaicModel = require('./basemap-mosaic-model');
var MosaicFormView = require('../../../components/mosaic-form-view');

/**
 *  Mosaic form view
 */

module.exports = MosaicFormView.extend({

  initialize: function (opts) {
    if (!opts.collection) throw new Error('Mosaic collection is required');
    if (!opts.template) throw new Error('template is required');
    if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
    if (!opts.basemapsCollection) throw new Error('basemapsCollection is required');
    if (!opts.customBaselayersCollection) throw new Error('customBaselayersCollection is required');
    if (!opts.modals) throw new Error('modals is required');

    this.template = opts.template;
    this._layerDefinitionsCollection = opts.layerDefinitionsCollection;
    this._basemapsCollection = opts.basemapsCollection;
    this._customBaselayersCollection = opts.customBaselayersCollection;
    this._modals = opts.modals;
    this._disabled = opts.disabled;
    this._currentTab = opts.currentTab;

    this._initBinds();
  },

  _initViews: function () {
    this.mosaic = new BasemapMosaicView({
      model: new BasemapMosaicModel(),
      collection: this.collection,
      layerDefinitionsCollection: this._layerDefinitionsCollection,
      basemapsCollection: this._basemapsCollection,
      customBaselayersCollection: this._customBaselayersCollection,
      modals: this._modals,
      disabled: this._disabled,
      currentTab: this._currentTab
    });
    this.mosaic.model.bind('change:highlightedAdd', this._onChangeHighlighted, this);

    if (!this.$('.js-selector').length) throw new Error('HTML element with js-selector class is required');

    this.$('.js-selector').append(this.mosaic.render().el);
    this.addView(this.mosaic);
  },

  _onChangeHighlighted: function () {
    var item = this.collection.getHighlighted() || this.mosaic.model.getHighlighted() || this.collection.getSelected();
    if (item) {
      var $el = this.$('.js-highlight');
      if ($el) {
        $el.text(item.getName());
      }
    }
  }

});

},{"../../../components/mosaic-form-view":457,"./basemap-mosaic-model":759,"./basemap-mosaic-view":762}],758:[function(require,module,exports){
/* global Image */

var template = require('../../../components/mosaic/mosaic-item.tpl');
var MosaicItemView = require('../../../components/mosaic/mosaic-item-view');
var BasemapMosaicRemoveView = require('./basemap-mosaic-remove-view');

var DEFAULT_SUBDOMAIN = 'a';
var DEFAULT_X_POSITION = 30;
var DEFAULT_Y_POSISTION = 24;
var DEFAULT_ZOOM = 6;
var DEFAULT_IMG = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAAXNSR0IArs4c6QAAAZ9JREFUWAntWUtugzAUNKbAJl1EYtcz9Ba5UE6SC+UWPUN3SNlkw78zVhJRCeIXbCup6ic5gP08Ho/x40ESBauq6iNJkgPKDpdb1j3RTuM4HlH2ZVl+JySXpukXygaksiViRVEsNd3qu65Tfd/frpdO8jxXEGO2GcTUMAxtXddnYH1qKqe1fof3IrlZpECVJA6xMgiyMdzws0N5CzTealiIlpGbBsKz77nZSYAc67ck+NIWCbouj1cFL/eNK6df/UW7FztKMT7ZTOJDDMQ5RUyJGYK2IMyBm6ax4nFQGxZBEIStWFcH2TSu3pZjiCX2StDCf1VzJLhKtkmnqOBEjFWn/0tBaaB+REoTqJkJ2wxJpM3FtPvGMgQlabrkCUEcCcF7Kf9UBT5xvN6DIZbYK8Hp7H2dR4KuSkYFo4KPKBAiYTWBmoHznvEdQpKm82ljw+I4DObElJghaJu59AWHA9qw6CMlR9+4i6mCi0UFXdRj3z+hIL8Ju040VP+TBrkjtn0bagQH3JbcSHB/+WDNCgc8r11bZOdncjPfWV/5b4gfOaaYLUG/QVoAAAAASUVORK5CYII=';
var DEFAULT_NAME = _t('editor.layers.basemap.custom-basemap');

module.exports = MosaicItemView.extend({

  initialize: function (opts) {
    if (!opts.basemapsCollection) throw new Error('basemapsCollection is required');

    this._basemapsCollection = opts.basemapsCollection;
    this._disabled = opts.disabled;

    this._initBinds();
  },

  render: function () {
    this.$el.html(
      template({
        name: this._getName(),
        template: this.model.get('template')(this._getImageURL())
      })
    );
    this.$el.addClass('js-' + this.model.getValue());
    this.$el.toggleClass('is-selected', !!this.model.get('selected'));

    this._initViews();

    return this;
  },

  _initViews: function () {
    var basemapMosaicRemoveView = new BasemapMosaicRemoveView({
      model: this.model,
      basemapsCollection: this._basemapsCollection
    });
    this.addView(basemapMosaicRemoveView);
    this.$el.append(basemapMosaicRemoveView.render().el);
  },

  _getImageURL: function () {
    var self = this;
    var url = this._lowerXYZ();

    var image = new Image();
    image.onerror = function () {
      self.$('.js-thumbnailImg').attr('src', DEFAULT_IMG);
    };
    image.src = url;

    return url;
  },

  _getSubdomain: function () {
    var subdomains = this.model.get('subdomains'); // eg: 'abcd' or '1234'

    return (subdomains && subdomains.length) ? subdomains[0] : DEFAULT_SUBDOMAIN;
  },

  _lowerXYZ: function () {
    return this.model.get('urlTemplate')
      .replace('{s}', this._getSubdomain())
      .replace('{z}', DEFAULT_ZOOM)
      .replace('{x}', DEFAULT_X_POSITION)
      .replace('{y}', DEFAULT_Y_POSISTION);
  },

  _getName: function () {
    var name = this.model.getName();

    if (!name) {
      name = this.model.get('order') ? DEFAULT_NAME + ' ' + this.model.get('order') : DEFAULT_NAME;
    } else {
      name.replace(/_/g, '');
    }

    return name;
  }

});

},{"../../../components/mosaic/mosaic-item-view":460,"../../../components/mosaic/mosaic-item.tpl":461,"./basemap-mosaic-remove-view":760}],759:[function(require,module,exports){
var Backbone = require('backbone');

/*
 *  List item model
 *
 */

module.exports = Backbone.Model.extend({

  defaults: {
    highlightedAdd: false
  },

  getHighlighted: function () {
    return this.get('highlightedAdd') && this;
  },

  getName: function () {
    return 'Add';
  }

});

},{"backbone":"backbone"}],760:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./basemap-mosaic-remove.tpl');
var CustomListCollection = require('../../../components/custom-list/custom-list-collection');
var ContextMenuView = require('../../../components/context-menu/context-menu-view');

module.exports = CoreView.extend({

  tagName: 'span',
  className: 'Mosaic-remove CDB-Shape-threePoints is-white is-small js-Mosaic-remove',

  events: {
    'click': '_onToggleContextMenuClicked'
  },

  initialize: function (opts) {
    if (!opts.basemapsCollection) throw new Error('basemapsCollection is required');

    this._basemapsCollection = opts.basemapsCollection;
  },

  render: function () {
    this.$el.html(template());

    return this;
  },

  _hasContextMenu: function () {
    return this._menuView;
  },

  _hideContextMenu: function () {
    this.removeView(this._menuView);
    this._menuView.clean();
    delete this._menuView;
  },

  _showContextMenu: function (position) {
    this._menuItems = new CustomListCollection([{
      label: _t('editor.layers.basemap.remove-baselayer'),
      val: 'remove-baselayer',
      destructive: true
    }]);

    var triggerElementID = 'context-menu-trigger-' + this.model.cid;
    this.$('.js-Mosaic-remove').attr('id', triggerElementID);
    this._menuView = new ContextMenuView({
      collection: this._menuItems,
      triggerElementID: triggerElementID,
      position: position
    });

    this._menuItems.bind('change:selected', function (menuItem) {
      if (menuItem.get('val') === 'remove-baselayer') {
        this._deleteBaselayer();
      }
    }, this);
    this.add_related_model(this._menuItems);

    this._menuView.model.bind('change:visible', function (model, isContextMenuVisible) {
      if (this._hasContextMenu() && !isContextMenuVisible) {
        this._hideContextMenu();
      }
    }, this);

    this._menuView.show();
    this.addView(this._menuView);
  },

  _deleteBaselayer: function () {
    this._basemapsCollection.remove(this.model);
  },

  _onToggleContextMenuClicked: function (e) {
    this.killEvent(e);

    if (this._hasContextMenu()) {
      this._hideContextMenu();
    } else {
      this._showContextMenu({
        x: e.pageX + 215, // CustomList--small width
        y: e.pageY
      });
    }
  }

});

},{"../../../components/context-menu/context-menu-view":39,"../../../components/custom-list/custom-list-collection":47,"./basemap-mosaic-remove.tpl":761,"backbone/core-view":1127}],761:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Shape-threePointsItem"></div>\n<div class="CDB-Shape-threePointsItem"></div>\n<div class="CDB-Shape-threePointsItem"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],762:[function(require,module,exports){
var template = require('../../../components/mosaic/mosaic.tpl');
var MosaicView = require('../../../components/mosaic/mosaic-view');
var MosaicItemModel = require('../../../components/mosaic/mosaic-item-model');
var BasemapMosaicItemView = require('./basemap-mosaic-item-view');
var MosaicAddItemView = require('./basemap-mosaic-add-item-view');

module.exports = MosaicView.extend({

  initialize: function (opts) {
    if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
    if (!opts.basemapsCollection) throw new Error('basemapsCollection is required');
    if (!opts.customBaselayersCollection) throw new Error('customBaselayersCollection is required');
    if (!opts.modals) throw new Error('modals is required');

    this._layerDefinitionsCollection = opts.layerDefinitionsCollection;
    this._basemapsCollection = opts.basemapsCollection;
    this._customBaselayersCollection = opts.customBaselayersCollection;
    this._modals = opts.modals;
    this._disabled = opts.disabled;
    this._currentTab = opts.currentTab;
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());
    this._renderList();
    this._createAddItem();
    return this;
  },

  _createItem: function (mdl) {
    var view = new BasemapMosaicItemView({
      model: mdl,
      disabled: this._disabled,
      basemapsCollection: this._basemapsCollection
    });
    this.$('.js-mosaic').append(view.render().el);
    this.addView(view);
  },

  _createAddItem: function () {
    var view = new MosaicAddItemView({
      model: new MosaicItemModel({
        label: 'Add',
        val: 'add',
        template: function () {
          return '<div class="Mosaic-button">+</div>';
        }
      }),
      layerDefinitionsCollection: this._layerDefinitionsCollection,
      basemapsCollection: this._basemapsCollection,
      customBaselayersCollection: this._customBaselayersCollection,
      mosaicModel: this.model,
      modals: this._modals,
      currentTab: this._currentTab
    });
    this.$('.js-mosaic').append(view.render().el);
    this.addView(view);
  }

});

},{"../../../components/mosaic/mosaic-item-model":459,"../../../components/mosaic/mosaic-view":463,"../../../components/mosaic/mosaic.tpl":464,"./basemap-mosaic-add-item-view":756,"./basemap-mosaic-item-view":758}],763:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-selector">\n  <div class="Editor-HeaderInfo-title u-bSpace--m">\n    <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.basemap.style.title-label') ))==null?'':_.escape(__t))+
'</h2>\n  </div>\n  <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m js-highlight">'+
((__t=( _t('editor.layers.basemap.style.select-style') ))==null?'':_.escape(__t))+
'</p>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],764:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./basemap-select.tpl');
var MosaicFormView = require('../../../components/mosaic-form-view');
var BasemapFormView = require('./basemap-form-view');
var MosaicCollection = require('../../../components/mosaic/mosaic-collection');
var BasemapMosaicFormView = require('./basemap-mosaic-form-view');
var checkAndBuildOpts = require('../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'layerDefinitionsCollection',
  'basemapsCollection',
  'customBaselayersCollection',
  'selectedCategoryVal',
  'modals'
];

module.exports = CoreView.extend({

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._baseLayer = this._layerDefinitionsCollection.getBaseLayer();
    this._disabled = opts.disabled;

    this._initCollection();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());

    var category = this._selectedCategoryVal.toLowerCase();

    switch (category) {
      case 'color':
        this._renderForm();
        break;
      case 'custom':
        this._renderCustomMosaic();
        break;
      case 'nasa':
      case 'tilejson':
      case 'mapbox':
      case 'wms':
        this._renderCustomMosaic(category);
        break;
      default:
        this._renderMosaic();
    }

    return this;
  },

  _initCollection: function () {
    this._filteredBasemapsCollection = new MosaicCollection(
      this._basemapsCollection.findByCategory(this._selectedCategoryVal)
    );
  },

  _initBinds: function () {
    this._filteredBasemapsCollection.bind('change:selected', function (mdl) {
      if (mdl.get('selected')) {
        var value = mdl.getValue();

        this._changeBasemap(value);
      }
    }, this);
    this.add_related_model(this._filteredBasemapsCollection);
  },

  _changeBasemap: function (value) {
    var basemap = this._basemapsCollection.getByValue(value);

    this._layerDefinitionsCollection.setBaseLayer(basemap.toJSON());
  },

  _renderMosaic: function () {
    var view = new MosaicFormView({
      collection: this._filteredBasemapsCollection,
      template: require('./basemap-mosaic.tpl'),
      disabled: this._disabled
    });
    this.addView(view);
    this.$('.js-select').append(view.render().el);
  },

  _renderCustomMosaic: function (category) {
    var view = new BasemapMosaicFormView({
      collection: this._filteredBasemapsCollection,
      template: require('./basemap-mosaic.tpl'),
      layerDefinitionsCollection: this._layerDefinitionsCollection,
      basemapsCollection: this._basemapsCollection,
      customBaselayersCollection: this._customBaselayersCollection,
      modals: this._modals,
      disabled: this._disabled,
      currentTab: category
    });
    this.addView(view);
    this.$('.js-select').append(view.render().el);
  },

  _renderForm: function () {
    var view = new BasemapFormView({
      model: this._baseLayer,
      basemapsCollection: this._basemapsCollection,
      layerDefinitionsCollection: this._layerDefinitionsCollection,
      disabled: this._disabled
    });
    this.addView(view);
    this.$('.js-select').append(view.render().el);
  }

});

},{"../../../components/mosaic-form-view":457,"../../../components/mosaic/mosaic-collection":458,"../../../helpers/required-opts":1097,"./basemap-form-view":738,"./basemap-mosaic-form-view":757,"./basemap-mosaic.tpl":763,"./basemap-select.tpl":765,"backbone/core-view":1127}],765:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfo">\n  <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n  <div class="Editor-HeaderInfo-inner CDB-Text js-select"></div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],766:[function(require,module,exports){
var Backbone = require('backbone');
var BasemapModel = require('./basemap-model');
var _ = require('underscore');

/*
 *  Basemap collection, extends Mosaic collection
 */

module.exports = Backbone.Collection.extend({

  model: BasemapModel,

  initialize: function () {
    this._initBinds();
  },

  _initBinds: function () {
    this.bind('change:selected', this._onSelectedChange, this);
  },

  _onSelectedChange: function (changedModel, isSelected) {
    if (isSelected) {
      this.each(function (m) {
        if (m.cid !== changedModel.cid && m.get('selected')) {
          m.set('selected', false);
        }
      });
    }
  },

  findByCategory: function (category) {
    return this.where({ category: category });
  },

  getDefaultCategory: function () {
    var defaultCategory = this.findWhere({ default: true });
    defaultCategory = defaultCategory || this.first();

    return defaultCategory.get('category');
  },

  getCategories: function () {
    var categories = this.chain()
      .map(function (model) { return model.get('category'); })
      .concat('Custom')
      .concat('NASA')
      .concat('TileJSON')
      .concat('Mapbox')
      .concat('WMS')
      .uniq()
      .value();

    return categories;
  },

  getSelected: function () {
    return this.findWhere({ selected: true });
  },

  updateSelected: function (value) {
    var newSelected = this.getByValue(value);
    newSelected.set({ selected: true });
  },

  updateCategory: function (value, category) {
    var newCategory = this.getByValue(value);
    newCategory.set({ category: category });
  },

  getByValue: function (value) {
    return _.first(this.where({ val: value }));
  },

  getThumbnailImage: function (urlTemplate, subdomains) {
    return this._lowerXYZ(urlTemplate, subdomains);
  }

});

},{"./basemap-model":755,"backbone":"backbone","underscore":"underscore"}],767:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-basemapHeader"></div>\n<div class="js-basemapContent Editor-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],768:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="u-flex u-alignCenter Editor-contextSwitcher js-mapTableView\n  ';
 if (context === 'table') { 
__p+='in-table';
 } 
__p+='\n  ';
 if (isThereOtherWidgets && context === 'map') { 
__p+='is-moved';
 } 
__p+='\n  ';
 if (isThereTimeSeries && context === 'map') { 
__p+='\n    has-timeSeries\n    ';
 if (isThereAnimatedTimeSeries) { 
__p+='\n      has-timeSeries--animated\n    ';
 } 
__p+='\n  ';
 } 
__p+='\n  ">\n  <li class="Editor-contextSwitcherItem">\n    <div class="Editor-contextSwitcherButton js-showTable\n        ';
 if (context === 'table') { 
__p+='is-selected';
 } 
__p+='\n      ">\n      <svg width="11px" height="10px" viewBox="505 436 11 10" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <g id="Group" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(505.000000, 436.000000)">\n          <path d="M3,0 L3,10 L0,10 L0,0 L3,0 Z M1,1 L1,9 L2,9 L2,1 L1,1 Z" id="Combined-Shape" class="Editor-contextSwitcherMedia" ></path>\n          <path d="M7,0 L7,10 L4,10 L4,0 L7,0 Z M5,1 L5,9 L6,9 L6,1 L5,1 Z" id="Combined-Shape-Copy" class="Editor-contextSwitcherMedia" ></path>\n          <path d="M11,0 L11,10 L8,10 L8,0 L11,0 Z M9,1 L9,9 L10,9 L10,1 L9,1 Z" id="Combined-Shape-Copy-2" class="Editor-contextSwitcherMedia" ></path>\n        </g>\n      </svg>\n    </div>\n  </li>\n  <li class="Editor-contextSwitcherItem">\n    <div class="Editor-contextSwitcherButton js-showMap\n        ';
 if (context === 'map') { 
__p+='is-selected';
 } 
__p+='\n      ">\n      <svg width="9px" height="12px" viewBox="538 435 9 12" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <path d="M547,438.913043 C547,441.07513 542.5,447 542.5,447 C542.5,447 538,441.07513 538,438.913043 C538,436.752 540.0142,435 542.5,435 C544.9852,435 547,436.752 547,438.913043 Z M543.908614,443.22687 C544.16716,442.824347 544.408524,442.43401 544.629457,442.059548 C545.498835,440.586034 546,439.426635 546,438.913043 C546,437.337768 544.461567,436 542.5,436 C540.538058,436 539,437.337565 539,438.913043 C539,439.426635 539.501165,440.586034 540.370543,442.059548 C540.591476,442.43401 540.83284,442.824347 541.091386,443.22687 C541.539951,443.925227 542.019537,444.628807 542.501367,445.306148 C542.537557,445.357022 543.426358,443.97768 543.908614,443.22687 Z" id="Combined-Shape" stroke="none" class="Editor-contextSwitcherMedia" fill-rule="evenodd"></path>\n      </svg>\n    </div>\n  </li>\n</ul>\n\n<div class="EditOverlay js-editOverlay is-hidden"><p class="EditOverlay-inner CDB-Text CDB-Size-medium u-whiteTextColor js-editOverlay-text"></p></div>\n\n<ul class="u-flex u-alignRight Editor-contextSwitcher Editor-contextSwitcher--geom js-mapTableView js-newGeometryView\n';
 if (context === 'table') { 
__p+='in-table';
 } 
__p+='\n';
 if (isThereOtherWidgets && context === 'map') { 
__p+='is-moved';
 } 
__p+='\n';
 if (isThereTimeSeries && context === 'map') { 
__p+='\n  has-timeSeries\n  ';
 if (isThereAnimatedTimeSeries) { 
__p+='\n    has-timeSeries--animated\n  ';
 } 
__p+='\n';
 } 
__p+='\n"\n';
 if (isReadOnly || !isVisible) { 
__p+='data-tooltip="'+
((__t=( _t('editor.edit-feature.geometry-disabled') ))==null?'':_.escape(__t))+
'"';
 } 
__p+='\n>\n  ';
 if (queryGeometryModel === 'point' || !queryGeometryModel) { 
__p+='\n    <li class="Editor-contextSwitcherItem js-newGeometryItem ';
 if (isReadOnly || !isVisible) { 
__p+='is-disabled';
 } 
__p+='">\n      <div class="Editor-contextSwitcherButton js-newGeometry" data-feature-type=\'point\'>\n        <svg width="12" height="12" viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n          <defs>\n            <path d="M0 2h3v1H0V2zm0-2h3v1H0V0zm2 1h1v1H2V1zM0 1h1v1H0V1z" id="a"/>\n            <path d="M0 2h3v1H0V2zm0-2h3v1H0V0zm2 1h1v1H2V1zM0 1h1v1H0V1z" id="c"/>\n            <path d="M0 2h3v1H0V2zm0-2h3v1H0V0zm2 1h1v1H2V1zM0 1h1v1H0V1z" id="e"/>\n          </defs>\n          <g fill="none" fill-rule="evenodd">\n            <path fill="#FFF" d="M4 3h3v1H4v3H3V4H0V3h3V0h1"/>\n            <g transform="rotate(180 2.5 6)">\n              <mask id="b" fill="#fff">\n                <use xlink:href="#a"/>\n              </mask>\n              <path d="M0 2h3v1H0V2zm0-2h3v1H0V0zm2 1h1v1H2V1zM0 1h1v1H0V1z" mask="url(#b)" stroke="#FFF" stroke-width="2"/>\n            </g>\n            <g transform="rotate(180 6 6)">\n              <mask id="d" fill="#fff">\n                <use xlink:href="#c"/>\n              </mask>\n              <path d="M0 2h3v1H0V2zm0-2h3v1H0V0zm2 1h1v1H2V1zM0 1h1v1H0V1z" mask="url(#d)" stroke="#FFF" stroke-width="2"/>\n            </g>\n            <g transform="rotate(180 6 2.5)">\n              <mask id="f" fill="#fff">\n                <use xlink:href="#e"/>\n              </mask>\n              <path d="M0 2h3v1H0V2zm0-2h3v1H0V0zm2 1h1v1H2V1zM0 1h1v1H0V1z" mask="url(#f)" stroke="#FFF" stroke-width="2"/>\n            </g>\n          </g>\n        </svg>\n      </div>\n    </li>\n  ';
 } 
__p+='\n  ';
 if (queryGeometryModel === 'line' || !queryGeometryModel) { 
__p+='\n    <li class="Editor-contextSwitcherItem js-newGeometryItem ';
 if (isReadOnly || !isVisible) { 
__p+='is-disabled';
 } 
__p+='">\n      <div class="Editor-contextSwitcherButton js-newGeometry" data-feature-type=\'line\'>\n        <svg width="14" height="14" viewBox="0 0 14 14" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n          <defs>\n            <path d="M0 2h3v1H0V2zm0-2h3v1H0V0zm2 1h1v1H2V1zM0 1h1v1H0V1z" id="a"/>\n            <path d="M0 2h3v1H0V2zm0-2h3v1H0V0zm2 1h1v1H2V1zM0 1h1v1H0V1z" id="c"/>\n          </defs>\n          <g fill="none" fill-rule="evenodd">\n            <path fill="#FFF" d="M11.5 5l-.707-.707-6.354 6.853.705.708"/>\n            <g transform="translate(11 2)">\n              <mask id="b" fill="#fff">\n                <use xlink:href="#a"/>\n              </mask>\n              <path d="M0 2h3v1H0V2zm0-2h3v1H0V0zm2 1h1v1H2V1zM0 1h1v1H0V1z" mask="url(#b)" stroke="#FFF" stroke-width="2"/>\n            </g>\n            <g transform="translate(2 11)">\n              <mask id="d" fill="#fff">\n                <use xlink:href="#c"/>\n              </mask>\n              <path d="M0 2h3v1H0V2zm0-2h3v1H0V0zm2 1h1v1H2V1zM0 1h1v1H0V1z" mask="url(#d)" stroke="#FFF" stroke-width="2"/>\n            </g>\n            <path fill="#FFF" d="M3 4H0V3h3V0h1v3h3v1H4v3H3"/>\n          </g>\n        </svg>\n      </div>\n    </li>\n  ';
 } 
__p+='\n  ';
 if (queryGeometryModel === 'polygon' || !queryGeometryModel) { 
__p+='\n    <li class="Editor-contextSwitcherItem js-newGeometryItem ';
 if (isReadOnly || !isVisible) { 
__p+='is-disabled';
 } 
__p+='">\n      <div class="Editor-contextSwitcherButton js-newGeometry" data-feature-type=\'polygon\'>\n        <svg width="14" height="14" viewBox="0 0 14 14" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n          <defs>\n            <path d="M0 2h3v1H0V2zm0-2h3v1H0V0zm2 1h1v1H2V1zM0 1h1v1H0V1z" id="a"/>\n            <path d="M0 2h3v1H0V2zm0-2h3v1H0V0zm2 1h1v1H2V1zM0 1h1v1H0V1z" id="c"/>\n            <path d="M0 2h3v1H0V2zm0-2h3v1H0V0zm2 1h1v1H2V1zM0 1h1v1H0V1z" id="e"/>\n          </defs>\n          <g fill="none" fill-rule="evenodd">\n            <path d="M13 11.5V5h-1v7h1m-.5-7.5l-.707-.707-7.647 7.353-.353.354.707.707.354-.353M4 3h3v1H4v3H3V4H0V3h3V0h1" fill="#FFF"/>\n            <path fill="#FFF" d="M4.5 13H12v-1H4v1"/>\n            <g transform="rotate(180 7 7)">\n              <mask id="b" fill="#fff">\n                <use xlink:href="#a"/>\n              </mask>\n              <path d="M0 2h3v1H0V2zm0-2h3v1H0V0zm2 1h1v1H2V1zM0 1h1v1H0V1z" stroke="#FFF" stroke-width="2" mask="url(#b)"/>\n            </g>\n            <g transform="rotate(180 7 2.5)">\n              <mask id="d" fill="#fff">\n                <use xlink:href="#c"/>\n              </mask>\n              <path d="M0 2h3v1H0V2zm0-2h3v1H0V0zm2 1h1v1H2V1zM0 1h1v1H0V1z" stroke="#FFF" stroke-width="2" mask="url(#d)"/>\n            </g>\n            <g transform="rotate(180 2.5 7)">\n              <mask id="f" fill="#fff">\n                <use xlink:href="#e"/>\n              </mask>\n              <path d="M0 2h3v1H0V2zm0-2h3v1H0V0zm2 1h1v1H2V1zM0 1h1v1H0V1z" stroke="#FFF" stroke-width="2" mask="url(#f)"/>\n            </g>\n          </g>\n        </svg>\n      </div>\n    </li>\n  ';
 } 
__p+='\n</ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],769:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--grid u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="24px" height="25px" viewbox="521 436 24 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n            <path d="M524.5,440 L540.5,440 L540.5,460 L524.5,460 L524.5,440 Z M528.5,437 L536.5,437 L536.5,440 L528.5,440 L528.5,437 Z M522,440 L544,440 L522,440 Z M528.5,443.5 L528.5,455.5 L528.5,443.5 Z M532.5,443.5 L532.5,455.5 L532.5,443.5 Z M536.5,443.5 L536.5,455.5 L536.5,443.5 Z" id="Shape" stroke="#F19243" stroke-width="1" fill="none"/>\n      </svg>\n    </div>\n    <div>\n      <h2 class=" CDB-Text CDB-Size-huge is-light u-bSpace--xl">'+
((__t=( _t('editor.layers.delete.title', { layerName: layerName }) ))==null?'':_.escape(__t))+
'</h2>\n      <p class="CDB-Text CDB-Size-large u-altTextColor">'+
((__t=( _t('editor.layers.delete.desc', { layerVisName: layerVisName }) ))==null?'':__t)+
'</p>\n      <ul class="Modal-listText">\n        ';
 if (affectedItemsMessages.length > 0) { 
__p+='\n          <li class="Modal-listTextItem">\n            <p class="CDB-Text CDB-Size-large">\n              '+
((__t=( _t('editor.layers.delete.affected-items') ))==null?'':__t)+
'\n              ';
 for (var i = 0; i < affectedItemsMessages.length; i++) { 
__p+='\n                  <span class="CDB-Text is-semibold">'+
((__t=( affectedItemsMessages[i] ))==null?'':_.escape(__t))+
'</span>\n                  ';
 if (i < (affectedItemsMessages.length - 2)) { 
__p+='\n                    ,\n                  ';
 } else if (i == (affectedItemsMessages.length - 2)) { 
__p+='\n                    '+
((__t=( _t('editor.layers.delete.and') ))==null?'':__t)+
'\n                  ';
 } 
__p+='\n              ';
 } 
__p+='\n              .</p>\n          </li>\n        ';
 } 
__p+='\n        <li class="Modal-listTextItem">\n          <p class="CDB-Text CDB-Size-large">'+
((__t=( _t('editor.layers.delete.link-to-export') ))==null?'':__t)+
'</p>\n        </li>\n      </ul>\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('editor.layers.delete.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('editor.layers.delete.confirm') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],770:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');
var CoreView = require('backbone/core-view');
var template = require('./edit-feature-content.tpl');
var EditFeatureActionView = require('./edit-feature-content-views/edit-feature-action-view');
var EditFeatureControlView = require('./edit-feature-content-views/edit-feature-control-view');
var EditFeatureHeaderView = require('./edit-feature-content-views/edit-feature-header-view');
var VisTableModel = require('../../data/visualization-table-model');
var EditFeatureInnerView = require('./edit-feature-content-views/edit-feature-inner-view');
var PanelWithOptionsView = require('../../components/view-options/panel-with-options-view');
var ScrollView = require('../../components/scroll/scroll-view');
var Notifier = require('../../components/notifier/notifier');
var EditFeatureGeometryFormModel = require('./edit-feature-content-views/edit-feature-geometry-form-model');
var EditFeatureGeometryPointFormModel = require('./edit-feature-content-views/edit-feature-geometry-point-form-model');
var EditFeatureAttributesFormModel = require('./edit-feature-content-views/edit-feature-attributes-form-model');

var NOTIFICATION_ID = 'editFeatureNotification';
var NOTIFICATION_ERROR_TEMPLATE = _.template("<span class='u-errorTextColor'><%- title %></span>");

var REQUIRED_OPTS = [
  'stackLayoutModel',
  'layerDefinitionModel',
  'configModel',
  'mapModeModel',
  'editorModel',
  'modals'
];

module.exports = CoreView.extend({

  className: 'Editor-content',

  events: {
    'click .js-back': 'clean'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this._featureModel = this._mapModeModel.getFeatureDefinition();
    this._tableName = '';
    this._url = '';

    this._editorModel.set({
      edition: false
    });

    this._getTable();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());

    this._initViews();

    return this;
  },

  _initBinds: function () {
    if (this._querySchemaModel.get('status') !== 'fetched') {
      // status can be: fetched, unavailable, fetching
      this._querySchemaModel.bind('change:status', this.render, this);
      this._querySchemaModel.fetch();
    }
    this._featureModel.bind('updateFeature', this._updateForms, this);
    this._featureModel.bind('destroyFeature', this._onDestroyFeature, this);
    this._featureModel.bind('destroyFeatureSuccess', this._onDestroyFeatureSuccess, this);
    this._featureModel.bind('destroyFeatureFailed', this._onDestroyFeatureFailed, this);
    this._featureModel.bind('addFeature', this._onAddFeature, this);
    this._featureModel.bind('saveFeature', this._onSaveFeature, this);
    this._featureModel.bind('saveFeatureSuccess', this._onSaveFeatureSuccess, this);
    this._featureModel.bind('saveFeatureFailed', this._onSaveFeatureFailed, this);

    this.add_related_model(this._featureModel);
  },

  _initViews: function () {
    if (this._featureModel.isNew()) {
      this._addRow();
    } else {
      this._renderInfo();
    }
  },

  _updateForms: function () {
    this._updateGeometry();
    this._attributesFormModel.trigger('updateFeature');
  },

  _updateGeometry: function () {
    var geojson = null;

    try {
      geojson = JSON.parse(this._featureModel.get('the_geom'));
    } catch (err) {
      // if the geom is not a valid json value
    }

    var attrs;

    if (this._featureModel.isPoint()) {
      attrs = {
        lng: geojson && geojson.coordinates[0],
        lat: geojson && geojson.coordinates[1]
      };
    } else {
      attrs = {
        the_geom: this._featureModel.get('the_geom')
      };
    }

    this._geometryFormModel.set(attrs);
    this._geometryFormModel.trigger('updateFeature', attrs);
  },

  _addRow: function () {
    this._renderInfo();
  },

  _renderInfo: function () {
    this._renderHeader();
    this._renderContent();
  },

  _renderHeader: function () {
    if (this._headerView) {
      this.removeView(this._headerView);
      this._headerView.clean();
    }

    this._headerView = new EditFeatureHeaderView({
      url: this._url,
      tableName: this._tableName,
      model: this._featureModel,
      modals: this._modals,
      isNew: this._featureModel.isNew(),
      backAction: this.clean.bind(this)
    });
    this.addView(this._headerView);
    this.$('.js-editFeatureHeader').html(this._headerView.render().el);
  },

  _renderContent: function () {
    var self = this;

    if (this._contentView) {
      this.removeView(this._contentView);
      this._contentView.clean();
    }

    var geojson = null;

    try {
      geojson = JSON.parse(this._featureModel.get('the_geom'));
    } catch (err) {
      // if the geom is not a valid json value
    }

    if (this._featureModel.isPoint()) {
      this._geometryFormModel = new EditFeatureGeometryPointFormModel({
        lng: geojson && geojson.coordinates[0],
        lat: geojson && geojson.coordinates[1]
      }, {
        featureModel: this._featureModel
      });
    } else {
      this._geometryFormModel = new EditFeatureGeometryFormModel({
        the_geom: this._featureModel.get('the_geom')
      }, {
        featureModel: this._featureModel
      });
    }

    this._attributesFormModel = new EditFeatureAttributesFormModel(this._featureModel.toJSON(), {
      featureModel: this._featureModel,
      columnsCollection: this._sourceNode.querySchemaModel.columnsCollection,
      configModel: this._configModel,
      nodeDefModel: this._layerDefinitionModel.getAnalysisDefinitionNodeModel()
    });

    this._contentView = new PanelWithOptionsView({
      className: 'Editor-content',
      editorModel: self._editorModel,
      createContentView: function () {
        return new ScrollView({
          createContentView: function () {
            return new EditFeatureInnerView({
              featureModel: self._featureModel,
              geometryFormModel: self._geometryFormModel,
              attributesFormModel: self._attributesFormModel
            });
          }
        });
      },
      createControlView: function () {
        return new EditFeatureControlView();
      },
      createActionView: function () {
        return new EditFeatureActionView({
          model: self.model,
          featureModel: self._featureModel,
          geometryFormModel: self._geometryFormModel,
          attributesFormModel: self._attributesFormModel
        });
      }
    });
    this.addView(this._contentView);
    this.$('.js-editFeatureContent').html(this._contentView.render().el);
  },

  _onDestroyFeature: function () {
    if (Notifier.getNotification(NOTIFICATION_ID)) {
      Notifier.removeNotification(NOTIFICATION_ID);
    }

    this.notification = Notifier.addNotification({
      id: NOTIFICATION_ID,
      status: 'loading',
      info: _t('notifications.edit-feature.destroy.loading'),
      closable: false
    });
  },

  _onDestroyFeatureSuccess: function () {
    this._onUpdateFeature('destroy');

    this.notification.set({
      status: 'success',
      info: _t('notifications.edit-feature.destroy.success'),
      closable: true
    });
  },

  _onDestroyFeatureFailed: function (mdl, error) {
    this.notification.set({
      status: 'error',
      info: NOTIFICATION_ERROR_TEMPLATE({
        title: _t('notifications.edit-feature.destroy.error')
      }),
      closable: true
    });
  },

  _onAddFeature: function () {
    if (Notifier.getNotification(NOTIFICATION_ID)) {
      Notifier.removeNotification(NOTIFICATION_ID);
    }

    this.notification = Notifier.addNotification({
      id: NOTIFICATION_ID,
      status: 'loading',
      info: _t('notifications.edit-feature.adding'),
      closable: false
    });
  },

  _onSaveFeature: function () {
    if (Notifier.getNotification(NOTIFICATION_ID)) {
      Notifier.removeNotification(NOTIFICATION_ID);
    }

    this.notification = Notifier.addNotification({
      id: NOTIFICATION_ID,
      status: 'loading',
      info: _t('notifications.edit-feature.save.loading'),
      closable: false
    });
  },

  _onSaveFeatureSuccess: function (op) {
    this._onUpdateFeature(op);
    this.render();

    this.notification.set({
      status: 'success',
      info: _t('notifications.edit-feature.save.success'),
      closable: true
    });
  },

  _onSaveFeatureFailed: function (mdl, error) {
    this.notification.set({
      status: 'error',
      info: NOTIFICATION_ERROR_TEMPLATE({
        title: _t('notifications.edit-feature.save.error')
      }),
      closable: true
    });
  },

  _onUpdateFeature: function (operation) {
    if (operation !== 'save' || !this._queryGeometryModel.hasValue()) {
      this._queryGeometryModel.resetFetch();
    }

    if (operation === 'add' || operation === 'destroy') {
      this._rowsCollection.resetFetch();
    }
  },

  _getTable: function () {
    this._sourceNode = this._getSourceNode();

    if (this._sourceNode) {
      var tableName = this._sourceNode.get('table_name');
      this._visTableModel = new VisTableModel({
        id: tableName,
        table: {
          name: tableName
        }
      }, {
        configModel: this._configModel
      });

      this._querySchemaModel = this._sourceNode.querySchemaModel;
      this._queryGeometryModel = this._sourceNode.queryGeometryModel;
      this._rowsCollection = this._sourceNode.queryRowsCollection;
    }

    if (this._visTableModel) {
      var tableModel = this._visTableModel.getTableModel();
      this._tableName = tableModel.getUnquotedName();
      this._url = this._visTableModel && this._visTableModel.datasetURL();
    }
  },

  _getSourceNode: function () {
    var node = this._layerDefinitionModel.getAnalysisDefinitionNodeModel();
    var source;
    if (node.get('type') === 'source') {
      source = node;
    } else {
      var primarySource = node.getPrimarySource();
      if (primarySource && primarySource.get('type') === 'source') {
        source = primarySource;
      }
    }

    return source;
  },

  _destroyContextOverlay: function () {
    $('.js-editOverlay').fadeOut(200, function () {
      $('.js-editOverlay').remove();
    });
  },

  clean: function () {
    this._destroyContextOverlay();
    this._mapModeModel.enterViewingMode();
    CoreView.prototype.clean.apply(this);
  }
});

},{"../../components/notifier/notifier":475,"../../components/scroll/scroll-view":530,"../../components/view-options/panel-with-options-view":595,"../../data/visualization-table-model":677,"./edit-feature-content-views/edit-feature-action-view":772,"./edit-feature-content-views/edit-feature-attributes-form-model":774,"./edit-feature-content-views/edit-feature-control-view":777,"./edit-feature-content-views/edit-feature-geometry-form-model":779,"./edit-feature-content-views/edit-feature-geometry-point-form-model":782,"./edit-feature-content-views/edit-feature-header-view":783,"./edit-feature-content-views/edit-feature-inner-view":785,"./edit-feature-content.tpl":786,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],771:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--grid u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="24px" height="25px" viewbox="521 436 24 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <path d="M524.5,440 L540.5,440 L540.5,460 L524.5,460 L524.5,440 Z M528.5,437 L536.5,437 L536.5,440 L528.5,440 L528.5,437 Z M522,440 L544,440 L522,440 Z M528.5,443.5 L528.5,455.5 L528.5,443.5 Z M532.5,443.5 L532.5,455.5 L532.5,443.5 Z M536.5,443.5 L536.5,455.5 L536.5,443.5 Z" id="Shape" stroke="#F19243" stroke-width="1" fill="none"/>\n      </svg>\n    </div>\n    <div>\n      <h2 class=" CDB-Text CDB-Size-huge is-light u-bSpace--xl">'+
((__t=( _t('components.modals.edit-feature.delete.title') ))==null?'':_.escape(__t))+
'</h2>\n      <p class="CDB-Text CDB-Size-large u-altTextColor">'+
((__t=( _t('components.modals.edit-feature.delete.desc') ))==null?'':_.escape(__t))+
'</p>\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.modals.edit-feature.delete.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.modals.edit-feature.delete.confirm') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],772:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./edit-feature-action.tpl');

/**
 * View representing the apply button for a form
 */
module.exports = CoreView.extend({

  events: {
    'click .js-save': '_onSaveClicked'
  },

  initialize: function (opts) {
    if (!opts.featureModel) throw new Error('featureModel is required');
    if (!opts.geometryFormModel) throw new Error('geometryFormModel is required');
    if (!opts.attributesFormModel) throw new Error('attributesFormModel is required');

    this._featureModel = opts.featureModel;
    this._geometryFormModel = opts.geometryFormModel;
    this._attributesFormModel = opts.attributesFormModel;

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();

    this.$el.html(template({
      label: this._featureModel.isNew() ? _t('editor.edit-feature.add') : _t('editor.edit-feature.save'),
      isDisabled: !this._canSave()
    }));

    return this;
  },

  _initBinds: function () {
    this.model.on('change', this.render, this);
    this._featureModel.on('change', function () {
      this.model.set('hasChanges', true);
    }, this);
    this.add_related_model(this._featureModel);
    this._geometryFormModel.bind('validate', function (isValid) {
      this.model.set('isValidGeometry', !isValid);
    }, this);
    this.add_related_model(this._geometryFormModel);
    this._attributesFormModel.bind('validate', function (isValid) {
      this.model.set('isValidAttributes', !isValid);
    }, this);
    this.add_related_model(this._attributesFormModel);
  },

  _canSave: function () {
    var hasChanges = this.model.get('hasChanges');
    var isValidGeometry = this.model.get('isValidGeometry');
    var isValidAttributes = this.model.get('isValidAttributes');

    return isValidGeometry && isValidAttributes && hasChanges;
  },

  _onSaveClicked: function () {
    if (this._canSave()) {
      this._saveFeature();
    }
  },

  _saveFeature: function () {
    var self = this;

    var op = this._featureModel.isNew() ? 'add' : 'save';
    var ev = op + 'Feature';
    this._featureModel.trigger(ev);

    this._featureModel.save({
      success: function () {
        self._featureModel.trigger('saveFeatureSuccess', op);
        self.model.set('hasChanges', false);
      },
      error: function () {
        self._featureModel.trigger('saveFeatureFailed');
      }
    });
  }

});

},{"./edit-feature-action.tpl":773,"backbone/core-view":1127}],773:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button class="CDB-Button CDB-Button--primary js-save ';
 if (isDisabled) { 
__p+='is-disabled';
 } 
__p+='">\n  <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small u-upperCase">\n    '+
((__t=( label ))==null?'':_.escape(__t))+
'\n  </span>\n</button>';
}
return __p;
};

},{"underscore":"underscore"}],774:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var ColumnRowData = require('../../../data/column-row-data');

var FIELDTYPE_TO_FORMTYPE = {
  string: 'Text',
  boolean: 'Radio',
  number: 'Number',
  date: 'DateTime',
  geometry: 'Text'
};

var BLACKLISTED_COLUMNS = ['created_at', 'the_geom', 'the_geom_webmercator', 'updated_at'];

module.exports = Backbone.Model.extend({

  initialize: function (attrs, opts) {
    if (!opts.featureModel) throw new Error('featureModel is required');
    if (!opts.columnsCollection) throw new Error('columnsCollection is required');
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.nodeDefModel) throw new Error('nodeDefModel is required');

    this._featureModel = opts.featureModel;
    this._columnsCollection = opts.columnsCollection;
    this._configModel = opts.configModel;
    this._nodeDefModel = opts.nodeDefModel;

    this._generateSchema();
    this._initBinds();
  },

  _initBinds: function () {
    this.bind('change', this._onChange, this);
  },

  _onChange: function () {
    _.each(this.changed, function (val, key) {
      this._featureModel.set(key, val);
    }, this);
  },

  _getInputType: function (columnRowData) {
    var rows = columnRowData.getRows();
    return rows && rows.length ? 'Suggest' : 'Text';
  },

  _getSupportedColumnType: function (columnType) {
    var supportedColumnType = _.find(_.keys(FIELDTYPE_TO_FORMTYPE), function (fieldType) {
      return fieldType === columnType;
    });

    return supportedColumnType || 'string';
  },

  _generateSchema: function () {
    var self = this;

    this.schema = {};

    this._columnsCollection.each(function (mdl) {
      var columnName = mdl.get('name');
      var columnType = this._getSupportedColumnType(mdl.get('type'));

      if (!_.contains(BLACKLISTED_COLUMNS, columnName)) {
        // default field type
        this.schema[columnName] = {
          type: FIELDTYPE_TO_FORMTYPE[columnType]
        };

        if (columnType === 'date') {
          this.schema[columnName].dialogMode = 'float';
        }

        if (columnType === 'string') {
          var columnRowData = new ColumnRowData({
            column: columnName
          }, {
            nodeDefModel: this._nodeDefModel,
            configModel: this._configModel
          });
          columnRowData.bind('columnsFetched', function (rows) {
            var type = self._getInputType(this);
            if (self.schema[columnName].type !== type) {
              self.schema[columnName].type = type;
              if (type === 'Suggest') {
                self.schema[columnName].dialogMode = 'float';
              }
              self.schema[columnName].editorAttrs = {
                showSearch: true,
                allowFreeTextInput: true,
                collectionData: rows
              };

              self._onChangeSchema();
            }
          });
          columnRowData.fetch();
        }

        if (columnType === 'number') {
          this.schema[columnName].isFormatted = true;
          this.schema[columnName].showSlider = false;
        }

        if (columnType === 'boolean') {
          this.schema[columnName].options = [
            {
              label: _t('form-components.editors.radio.true'),
              val: true
            }, {
              label: _t('form-components.editors.radio.false'),
              val: false
            }, {
              label: _t('form-components.editors.radio.null'),
              val: null
            }
          ];
        }

        if (columnName === 'cartodb_id') {
          this.schema[columnName].isFormatted = false;
          this.schema[columnName].editorAttrs = {
            disabled: true
          };
        }
      }
    }, this);
  },

  _onChangeSchema: function () {
    this.trigger('changeSchema');
  }

});

},{"../../../data/column-row-data":617,"backbone":"backbone","underscore":"underscore"}],775:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var template = require('./edit-feature-attributes-form.tpl');

module.exports = CoreView.extend({

  render: function () {
    this.clearSubViews();
    this.$el.html(template());

    this._generateForms();

    this.model.bind('changeSchema', this._generateForms, this);

    return this;
  },

  _generateForms: function () {
    var self = this;

    if (this._formView) {
      this._formView.remove();
    }

    this._formView = new Backbone.Form({
      model: this.model
    });

    this._formView.bind('change', function () {
      var validate = this.validate();
      self.model.trigger('validate', !!validate);

      if (!validate) {
        this.commit();
      }
    });

    this.$('.js-form').append(this._formView.render().$el);
  },

  clean: function () {
    if (this._formView) {
      this._formView.remove();
    }
  }

});

},{"./edit-feature-attributes-form.tpl":776,"backbone":"backbone","backbone/core-view":1127}],776:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfo">\n  <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n\n  <div class="Editor-HeaderInfo-inner CDB-Text">\n    <div class="Editor-HeaderInfo-title u-bSpace--m">\n      <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.edit-feature.attributes') ))==null?'':_.escape(__t))+
'</h2>\n    </div>\n    <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.edit-feature.attributes-columns') ))==null?'':_.escape(__t))+
'</p>\n    <div class="js-form"></div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],777:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./edit-feature-control.tpl');

module.exports = CoreView.extend({

  render: function () {
    this.$el.html(template());

    return this;
  }

});

},{"./edit-feature-control.tpl":778,"backbone/core-view":1127}],778:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button class="CDB-Button u-upperCase js-back">\n  <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small u-actionTextColor">'+
((__t=( _t('editor.edit-feature.cancel') ))==null?'':_.escape(__t))+
'</span>\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],779:[function(require,module,exports){
var Backbone = require('backbone');

module.exports = Backbone.Model.extend({

  initialize: function (attrs, opts) {
    if (!opts.featureModel) throw new Error('featureModel is required');

    this._featureModel = opts.featureModel;

    this._generateSchema();
  },

  _generateSchema: function () {
    this.schema = {};

    this.schema.the_geom = {
      type: 'Text',
      validators: ['required'],
      editorAttrs: {
        disabled: true
      },
      hasCopyButton: this._featureModel.has('the_geom')
    };
  }

});

},{"backbone":"backbone"}],780:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./edit-feature-geometry-form.tpl');

module.exports = CoreView.extend({

  render: function () {
    this.clearSubViews();
    this.$el.html(template());

    this._generateForms();

    return this;
  },

  _generateForms: function () {
    if (this._formView) {
      this._formView.remove();
    }

    this._formView = new Backbone.Form({
      model: this.model
    });

    this._formView.bind('change', this._validateForm, this);

    this.model.bind('updateFeature', function (attrs) {
      _.each(attrs, function (value, key) {
        this._formView.fields[key].editor.setValue(value);
      }, this);
      this._validateForm();
    }, this);

    this.$('.js-form').append(this._formView.render().$el);
  },

  _validateForm: function () {
    var validate = this._formView.validate();
    this.model.trigger('validate', !!validate);

    if (!validate) {
      this._formView.commit();
    }
  },

  clean: function () {
    if (this._formView) {
      this._formView.remove();
    }
  }

});

},{"./edit-feature-geometry-form.tpl":781,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],781:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfo">\n  <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">1</div>\n  <div class="Editor-HeaderInfo-inner CDB-Text">\n    <div class="Editor-HeaderInfo-title u-bSpace--m">\n      <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.edit-feature.geometry') ))==null?'':_.escape(__t))+
'</h2>\n    </div>\n    <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.edit-feature.geometry-edit') ))==null?'':_.escape(__t))+
'</p>\n    <div class="js-form"></div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],782:[function(require,module,exports){
var _ = require('underscore');
var EditFeatureGeometryFormModel = require('./edit-feature-geometry-form-model');

var formatCoordinate = function (coordinate) {
  if (isValidCoordinate(coordinate)) {
    return parseFloat(parseFloat(coordinate).toFixed(8));
  }
};

var isValidCoordinate = function (coordinate) {
  return _.isNumber(coordinate) || _.isString(coordinate);
};

var getCoordinatesFromGeoJSON = function (geoJSON) {
  if (geoJSON && geoJSON.coordinates && geoJSON.coordinates.length === 2) {
    return geoJSON.coordinates;
  }
};

var MIN_LAT = -90;
var MAX_LAT = 90;

var MIN_LNG = -180;
var MAX_LNG = 180;

module.exports = EditFeatureGeometryFormModel.extend({

  initialize: function () {
    EditFeatureGeometryFormModel.prototype.initialize.apply(this, arguments);

    this._initBinds();
  },

  _initBinds: function () {
    this.bind('change:lat', this._onLatLngChange, this);
    this.bind('change:lng', this._onLatLngChange, this);
  },

  _onLatLngChange: function () {
    var newGeoJSON = this._toGeoJSON();
    var currentGeoJSON = {};

    if (this._featureModel.get('the_geom')) {
      currentGeoJSON = JSON.parse(this._featureModel.get('the_geom'));
    }

    // Only set `the_geom` if there's new geoJSON
    if (!_.isEqual(newGeoJSON, currentGeoJSON)) {
      this._featureModel.set('the_geom', JSON.stringify(newGeoJSON));
    }
  },

  _toGeoJSON: function () {
    var latitude = this._getLatitude();
    var longitude = this._getLongitude();
    if (isValidCoordinate(latitude) && isValidCoordinate(longitude)) {
      return {
        'type': 'Point',
        'coordinates': [ longitude, latitude ]
      };
    }
  },

  _getLatitude: function () {
    if (this.has('lat')) {
      return formatCoordinate(this.get('lat'));
    }

    var geoJSON = JSON.parse(this._featureModel.get('the_geom'));
    var geoJSONCoordinates = getCoordinatesFromGeoJSON(geoJSON);
    var latitudeFromGeoJSON = geoJSONCoordinates && geoJSONCoordinates[1];
    if (latitudeFromGeoJSON) {
      return formatCoordinate(latitudeFromGeoJSON);
    }
  },

  _getLongitude: function () {
    if (this.has('lng')) {
      return formatCoordinate(this.get('lng'));
    }

    var geoJSON = JSON.parse(this._featureModel.get('the_geom'));
    var geoJSONCoordinates = getCoordinatesFromGeoJSON(geoJSON);
    var longitudeFromGeoJSON = geoJSONCoordinates && geoJSONCoordinates[1];
    if (longitudeFromGeoJSON) {
      return formatCoordinate(longitudeFromGeoJSON);
    }
  },

  _validateLatitude: function (value, formValues) {
    var numericValue = +value;

    var error = {
      type: 'lat',
      message: _t('editor.edit-feature.valid-lat')
    };

    if (_.isNumber(numericValue) && numericValue >= MIN_LAT && numericValue <= MAX_LAT) {
      return null; // valid latitude
    }

    if (_.isNumber(numericValue) && (numericValue > MAX_LAT || numericValue < MIN_LAT)) {
      error.message = _t('editor.edit-feature.out-of-bounds-lat');
    }

    return error;
  },

  _validateLongitude: function (value, formValues) {
    var numericValue = +value;

    var error = {
      type: 'lng',
      message: _t('editor.edit-feature.valid-lng')
    };

    if (_.isNumber(numericValue) && numericValue >= MIN_LNG && numericValue <= MAX_LNG) {
      return null; // valid longitude
    }

    if (_.isNumber(numericValue) && (numericValue > MAX_LNG || numericValue < MIN_LNG)) {
      error.message = _t('editor.edit-feature.out-of-bounds-lng');
    }

    return error;
  },

  _generateSchema: function () {
    this.schema = {};

    this.schema.lng = {
      type: 'Number',
      validators: ['required', this._validateLongitude],
      showSlider: false
    };

    this.schema.lat = {
      type: 'Number',
      validators: ['required', this._validateLatitude],
      showSlider: false
    };
  }

});

},{"./edit-feature-geometry-form-model":779,"underscore":"underscore"}],783:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./edit-feature-header.tpl');
var ContextMenuFactory = require('../../../components/context-menu-factory-view');
var ConfirmationView = require('../../../components/modals/confirmation/modal-confirmation-view');
var templateConfirmation = require('./delete-feature-confirmation.tpl');

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.url) throw new Error('url is required');
    if (!opts.tableName) throw new Error('tableName is required');
    if (!opts.modals) throw new Error('modals is required');
    if (opts.isNew === undefined) throw new Error('isNew is required');
    if (!opts.backAction) throw new Error('backAction is required');

    this._url = opts.url;
    this._tableName = opts.tableName;
    this._modals = opts.modals;
    this._isNew = opts.isNew;
    this._backAction = opts.backAction;
  },

  render: function () {
    this.clearSubViews();

    var featureType = this.model.getFeatureType();

    this.$el.html(
      template({
        url: this._url,
        tableName: this._tableName,
        featureType: featureType ? _t('editor.edit-feature.features.' + featureType) : _t('editor.edit-feature.features.geometry')
      })
    );

    if (!this._isNew) {
      this._initViews();
    }

    return this;
  },

  _initViews: function () {
    var menuItems = [{
      label: _t('editor.edit-feature.delete', { featureType: _t('editor.edit-feature.features.' + this.model.getFeatureType()) }),
      val: 'delete-feature',
      destructive: true,
      action: this._confirmDeleteFeature.bind(this)
    }];

    this._contextMenuFactory = new ContextMenuFactory({
      menuItems: menuItems
    });

    this.$('.js-context-menu').append(this._contextMenuFactory.render().el);
    this.addView(this._contextMenuFactory);
  },

  _confirmDeleteFeature: function () {
    var self = this;

    this._modals.create(function (modalModel) {
      return new ConfirmationView({
        modalModel: modalModel,
        template: templateConfirmation,
        runAction: self._destroyFeature.bind(self)
      });
    });
  },

  _destroyFeature: function () {
    var self = this;

    this.model.trigger('destroyFeature');

    this.model.destroy({
      success: function () {
        self.model.trigger('destroyFeatureSuccess');
        self._backAction();
      },
      error: function () {
        self.model.trigger('destroyFeatureFailed');
      }
    });
  }

});

},{"../../../components/context-menu-factory-view":37,"../../../components/modals/confirmation/modal-confirmation-view":404,"./delete-feature-confirmation.tpl":771,"./edit-feature-header.tpl":784,"backbone/core-view":1127}],784:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfoEditor">\n  <div class="u-rSpace--xl u-actionTextColor js-back Editor-HeaderInfoEditorShape">\n    <button>\n      <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n    </button>\n  </div>\n\n  <div class="Editor-HeaderInfo-inner u-ellipsis">\n    <div class="Editor-HeaderInfo-title u-bSpace">\n      <h2 class="Inline-editor">\n        <div class="CDB-Text CDB-Size-huge is-light u-ellipsis">'+
((__t=( _t('editor.edit-feature.edit', { featureType: featureType }) ))==null?'':_.escape(__t))+
'</div>\n      </h2>\n    </div>\n    <div class="u-flex u-ellipsis">\n      <p class="Editor-headerLayerName CDB-Text CDB-Size-medium u-ellipsis">\n        <a href="'+
((__t=( url ))==null?'':_.escape(__t))+
'" target="_blank" title="'+
((__t=( tableName ))==null?'':_.escape(__t))+
'" class="Editor-headerLayerName">'+
((__t=( tableName ))==null?'':_.escape(__t))+
'</a>\n      </p>\n    </div>\n  </div>\n  <div class="u-flex u-tSpace-xl js-context-menu"></div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],785:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var EditFeatureGeometryFormView = require('./edit-feature-geometry-form-view');
var EditFeatureAttributesFormView = require('./edit-feature-attributes-form-view');

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.featureModel) throw new Error('featureModel is required');
    if (!opts.geometryFormModel) throw new Error('geometryFormModel is required');
    if (!opts.attributesFormModel) throw new Error('attributesFormModel is required');

    this._featureModel = opts.featureModel;
    this._geometryFormModel = opts.geometryFormModel;
    this._attributesFormModel = opts.attributesFormModel;
  },

  render: function () {
    if (this._editFeatureGeometryFormView) {
      this._editFeatureGeometryFormView.clean();
    }

    if (this._editFeatureAttributesFormView) {
      this._editFeatureAttributesFormView.clean();
    }

    this.clearSubViews();

    this.$el.empty();

    this._editFeatureGeometryFormView = new EditFeatureGeometryFormView({
      model: this._geometryFormModel
    });

    this.addView(this._editFeatureGeometryFormView);
    this.$el.append(this._editFeatureGeometryFormView.render().el);

    this._editFeatureAttributesFormView = new EditFeatureAttributesFormView({
      model: this._attributesFormModel
    });

    this.addView(this._editFeatureAttributesFormView);
    this.$el.append(this._editFeatureAttributesFormView.render().el);

    return this;
  }

});

},{"./edit-feature-attributes-form-view":775,"./edit-feature-geometry-form-view":780,"backbone/core-view":1127}],786:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-editFeatureHeader"></div>\n<div class="Editor-content js-editFeatureContent"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],787:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h2 class="Editor-HeaderInfo-titleText Inline-editor" title="'+
((__t=( alias ))==null?'':_.escape(__t))+
'">\n  <div class="CDB-Text CDB-Size-huge is-light u-ellipsis js-title Inline-editor-text">'+
((__t=( alias ))==null?'':_.escape(__t))+
'</div>\n  <input type="text" name="text" class="Inline-editor-input Inline-editor-input--small CDB-Text CDB-InputText js-input" value="'+
((__t=( alias ))==null?'':_.escape(__t))+
'" readonly>\n</h2>';
}
return __p;
};

},{"underscore":"underscore"}],788:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var LayerAnalysisDraggableView = require('./layer-analysis-draggable-view');

/**
 * View of analyses within a layer
 * this.model is the layer-definition-model
 */
module.exports = CoreView.extend({

  tagName: 'ul',

  options: {
    sortableSelector: ''
  },

  initialize: function (opts) {
    if (!this.options.sortableSelector) throw new Error('sortableSelector is required');
    if (!opts.layerAnalysisViewFactory) throw new Error('layerAnalysisViewFactory is required');

    this._layerAnalysisViewFactory = opts.layerAnalysisViewFactory;
  },

  render: function () {
    this.clearSubViews();

    var nodeDefModel = this.model.getAnalysisDefinitionNodeModel();
    this._renderNode(nodeDefModel);

    return this;
  },

  /**
   * @param {Object} current instance of a analysis-layer-node-model
   */
  _renderNode: function (current) {
    this._createNodeView(current);

    var next = current.getPrimarySource();
    if (next && this.model.isOwnerOfAnalysisNode(current)) {
      this._renderNode(next);
    }
  },

  _createNodeView: function (current) {
    var view = this._layerAnalysisViewFactory.createView(current, this.model);
    this.addView(view);
    this.$el.append(view.render().el);
    this._attachDraggableToNodeView(view, current);
  },

  _attachDraggableToNodeView: function (nodeView, nodeDefModel) {
    if (!this.model.isOwnerOfAnalysisNode(nodeDefModel)) return;

    var draggableView = new LayerAnalysisDraggableView({
      model: nodeDefModel,
      getNextLetter: this.model.collection.nextLetter.bind(this.model.collection),
      $nodeViewElement: nodeView.$el,
      sortableSelector: this.options.sortableSelector
    });
    this.addView(draggableView);
  }

});

},{"./layer-analysis-draggable-view":789,"backbone/core-view":1127}],789:[function(require,module,exports){
require('jquery-ui');
var CoreView = require('backbone/core-view');
var template = require('./layer-analysis-draggable.tpl');
var analyses = require('../../data/analyses');
var layerColors = require('../../data/layer-colors');

/**
 * Attach draggable behavior to an analysis node
 * Implemented as a view to hook into Backbone's lifecycle handling, but really it's just attaching the behavior to the
 * provided $nodeViewElement
 */
module.exports = CoreView.extend({
  options: {
    getNextLetter: function () { return 'x'; },
    sortableSelector: '',
    $nodeViewElement: null
  },

  initialize: function () {
    if (!this.options.sortableSelector) throw new Error('sortableSelector is required');
    if (!this.options.$nodeViewElement) throw new Error('$nodeViewElement is required');

    this.options.$nodeViewElement.draggable({
      appendTo: this.options.sortableSelector,
      connectToSortable: this.options.sortableSelector,
      cursor: 'move',
      axis: 'y',
      cursorAt: { top: 40 },
      helper: this._createHelper.bind(this)
    });
  },

  _createHelper: function () {
    var nextLetter = this.options.getNextLetter();
    return template({
      nodeId: this.model.id,
      nextLetter: nextLetter,
      nextBgColor: layerColors.getColorForLetter(nextLetter),
      title: analyses.title(this.model)
    });
  },

  clean: function () {
    if (this.options.$nodeViewElement && this.options.$nodeViewElement.data('ui-draggable')) {
      this.options.$nodeViewElement.draggable('destroy');
    }

    this.options.$nodeViewElement = null; // remove DOM reference to avoid memory leak
    CoreView.prototype.clean.apply(this, arguments);
  }

});

},{"../../data/analyses":599,"../../data/layer-colors":633,"./layer-analysis-draggable.tpl":790,"backbone/core-view":1127,"jquery-ui":1128}],790:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<li class="Editor-newLayerContainer" data-analysis-node-id="'+
((__t=( nodeId ))==null?'':_.escape(__t))+
'" style="width: 294px;">\n  <div class="Editor-ListLayer-item">\n    <div class="Editor-ListLayer-itemHeader">\n      <div class="Editor-ListLayer-media u-rSpace--m" style="background: '+
((__t=( nextBgColor ))==null?'':_.escape(__t))+
'; color: #fff">\n        <p class="CDB-Text CDB-Size-large is-semibold u-upperCase">'+
((__t=( nextLetter ))==null?'':_.escape(__t))+
'</p>\n      </div>\n      <div class="Editor-ListLayer-inner">\n        <div class="Editor-ListLayer-title">\n          <h2 class="Editor-ListLayer-titleText CDB-Text CDB-Size-large u-ellipsis">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h2>\n        </div>\n        <button class="CDB-Text CDB-Size-small u-actionTextColor u-upperCase">'+
((__t=( _t('editor.layers.layer.add-analysis') ))==null?'':_.escape(__t))+
'</button>\n      </div>\n    </div>\n  </div>\n  <div class="Editor-layerInfo CDB-Text CDB-Size-small u-whiteTextColor">\n    Created new layer based on ['+
((__t=( nodeId ))==null?'':_.escape(__t))+
']\n  </div>\n</li>\n';
}
return __p;
};

},{"underscore":"underscore"}],791:[function(require,module,exports){
var RefLayerAnalysisView = require('./analysis-views/ref-layer-analysis-view');
var DefaultLayerAnalysisView = require('./analysis-views/default-layer-analysis-view');
var SourceLayerAnalysisView = require('./analysis-views/source-layer-analysis-view');
var CompositeLayerAnalysisView = require('./analysis-views/composite-layer-analysis-view');

var LayerAnalysisViewFactory = function (analysisDefinitionNodesCollection) {
  this._analysisDefinitionNodesCollection = analysisDefinitionNodesCollection;
};

/**
 * @param {Object} nodeDefModel - an analysis-definition-node-model
 * @param {Object} layerDefinitionModel
 * @param {String} [tagName = 'li']
 * @return {Object} instance of CoreView
 * @throws {Error} if node model can not be found, or view can not be found for the given mode
 */
LayerAnalysisViewFactory.prototype.createView = function (nodeDefModel, layerDefinitionModel) {
  if (!nodeDefModel) throw new Error('nodeDefModel is required');
  if (!layerDefinitionModel) throw new Error('layerDefinitionModel is required');

  var analysisNode = this._analysisDefinitionNodesCollection.get(nodeDefModel.id);
  var sourcesCount = nodeDefModel.sourceIds().length;

  var ownerLayer = layerDefinitionModel.collection.findOwnerOfAnalysisNode(nodeDefModel);
  if (ownerLayer !== layerDefinitionModel) {
    sourcesCount = null; // to force default ref view
  }

  switch (sourcesCount) {
    case 2:
      return new CompositeLayerAnalysisView({
        model: nodeDefModel,
        analysisDefinitionNodesCollection: this._analysisDefinitionNodesCollection,
        layerDefinitionModel: layerDefinitionModel
      });
    case 0:
      return new SourceLayerAnalysisView({
        model: nodeDefModel,
        analysisNode: analysisNode,
        layerDefinitionModel: layerDefinitionModel
      });
    case 1:
      return new DefaultLayerAnalysisView({
        model: nodeDefModel,
        analysisNode: analysisNode,
        layerDefinitionModel: layerDefinitionModel
      });
    default:
      return new RefLayerAnalysisView({
        model: nodeDefModel,
        analysisNode: analysisNode,
        layerDefinitionModel: ownerLayer || layerDefinitionModel // use same layer model as fallback
      });
  }
};

module.exports = LayerAnalysisViewFactory;

},{"./analysis-views/composite-layer-analysis-view":725,"./analysis-views/default-layer-analysis-view":727,"./analysis-views/ref-layer-analysis-view":729,"./analysis-views/source-layer-analysis-view":731}],792:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var createTextLabelsTabPane = require('../../components/tab-pane/create-text-labels-tab-pane');
var TabPaneTemplate = require('./layer-tab-pane.tpl');
var LayerHeaderView = require('./layer-header-view.js');
var LayerContentAnalysesView = require('./layer-content-views/analyses/analyses-view');
var StyleView = require('../style/style-view');
var InfowindowsView = require('./layer-content-views/infowindow/infowindows-view');
var TablesCollection = require('../../data/tables-collection');
var AnalysisSourceOptionsModel = require('./layer-content-views/analyses/analysis-source-options-model');
var AnalysisFormsCollection = require('./layer-content-views/analyses/analysis-forms-collection');
var TableManager = require('../../components/table/table-manager');
var changeViewButtons = require('./change-view-buttons.tpl');
var DataView = require('./layer-content-views/data/data-view');
var LegendsView = require('./layer-content-views/legend/legends-view');
var FeatureDefinitionModel = require('../../data/feature-definition-model');
var AnalysesService = require('./layer-content-views/analyses/analyses-service');
var checkAndBuildOpts = require('../../helpers/required-opts');
var TipsyTooltipView = require('../../components/tipsy-tooltip-view');

var REQUIRED_OPTS = [
  'userActions',
  'analysisDefinitionNodesCollection',
  'layerDefinitionsCollection',
  'layerDefinitionModel',
  'widgetDefinitionsCollection',
  'legendDefinitionsCollection',
  'stackLayoutModel',
  'modals',
  'onboardings',
  'configModel',
  'editorModel',
  'userModel',
  'mapDefinitionModel',
  'mapModeModel',
  'visDefinitionModel',
  'stateDefinitionModel',
  'onboardingNotification'
];

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_onClickBack',
    'click .js-fix-sql': '_onClickFixSQL'
  },

  options: {
    selectedTabItem: null,
    analysisPayload: null // id or a new analysis node attrs (may not be complete)
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this.model = new Backbone.Model({
      context: 'map' // map or table
    });

    this._styleViewId = null;

    AnalysesService.setLayerId(this._layerDefinitionModel.get('id'));

    this._initBinds();
  },

  render: function () {
    this._unbindEvents();
    this.clearSubViews();
    this._destroyTable();
    this.$el.empty();

    var self = this;
    var selectedTabItem = this.options.selectedTabItem;
    var analysisPayload = this.options.analysisPayload;
    var analysisDefinitionNodeModel = this._getAnalysisDefinitionNodeModel();
    var tableNodeModel = analysisDefinitionNodeModel.isSourceType() && analysisDefinitionNodeModel.getTableModel();

    var tabPaneTabs = [{
      label: _t('editor.layers.menu-tab-pane-labels.data'),
      name: 'data',
      selected: (!selectedTabItem || selectedTabItem === 'data'),
      createContentView: function () {
        return new DataView({
          className: 'Editor-content',
          widgetDefinitionsCollection: self._widgetDefinitionsCollection,
          layerDefinitionModel: self._layerDefinitionModel,
          stackLayoutModel: self._stackLayoutModel,
          userActions: self._userActions,
          configModel: self._configModel,
          editorModel: self._editorModel,
          userModel: self._userModel,
          onboardings: self._onboardings,
          onboardingNotification: self._onboardingNotification
        });
      }
    }, {
      label: _t('editor.layers.menu-tab-pane-labels.analyses'),
      name: 'analyses',
      selected: (selectedTabItem && selectedTabItem === 'analyses') && !!analysisPayload,
      createContentView: function () {
        var analysisSourceOptionsModel = new AnalysisSourceOptionsModel(null, {
          analysisDefinitionNodesCollection: self._analysisDefinitionNodesCollection,
          layerDefinitionsCollection: self._layerDefinitionsCollection,
          tablesCollection: new TablesCollection(null, {
            configModel: self._configModel
          })
        });
        analysisSourceOptionsModel.fetch();

        var analysisFormsCollection = new AnalysisFormsCollection(null, {
          userActions: self._userActions,
          configModel: self._configModel,
          layerDefinitionModel: self._layerDefinitionModel,
          analysisSourceOptionsModel: analysisSourceOptionsModel
        });
        analysisFormsCollection.resetByLayerDefinition();

        // e.g. when selected from layers view
        var selectedNodeId;
        if (_.isString(analysisPayload)) {
          selectedNodeId = analysisPayload;
        } else if (_.isObject(analysisPayload)) {
          // payload passed after continue when an option was selected in add-analysis-view
          selectedNodeId = analysisPayload.id;
          analysisFormsCollection.addHead(analysisPayload);
        } else {
          selectedNodeId = self._layerDefinitionModel.get('source');
        }

        // remove payload once we have used it, to not have it being invoked again when switching tabs
        selectedTabItem = null;
        analysisPayload = null;

        return new LayerContentAnalysesView({
          className: 'Editor-content',
          userActions: self._userActions,
          analysisDefinitionNodesCollection: self._analysisDefinitionNodesCollection,
          editorModel: self._editorModel,
          userModel: self._userModel,
          analysisFormsCollection: analysisFormsCollection,
          configModel: self._configModel,
          layerDefinitionModel: self._layerDefinitionModel,
          stackLayoutModel: self._stackLayoutModel,
          selectedNodeId: selectedNodeId,
          onboardings: self._onboardings,
          onboardingNotification: self._onboardingNotification
        });
      }
    }, {
      label: _t('editor.layers.menu-tab-pane-labels.style'),
      name: 'style',
      selected: selectedTabItem && selectedTabItem === 'style',
      createContentView: function () {
        // remove payload once we have used it, to not have it being invoked again when switching tabs
        selectedTabItem = null;

        var styleView = new StyleView({
          className: 'Editor-content',
          configModel: self._configModel,
          userModel: self._userModel,
          userActions: self._userActions,
          analysisDefinitionsCollection: self.analysisDefinitionsCollection,
          queryGeometryModel: self._getQueryGeometryModel(),
          querySchemaModel: self._getQuerySchemaModel(),
          queryRowsCollection: self._getQueryRowsCollection(),
          layerDefinitionsCollection: self._layerDefinitionsCollection,
          layerDefinitionModel: self._layerDefinitionModel,
          editorModel: self._editorModel,
          modals: self._modals,
          onboardings: self._onboardings,
          onboardingNotification: self._onboardingNotification
        });

        self._styleViewId = styleView.cid;
        return styleView;
      }
    }, {
      label: _t('editor.layers.menu-tab-pane-labels.infowindow'),
      name: 'infowindow',
      createContentView: function () {
        var nodeDefModel = self._layerDefinitionModel.getAnalysisDefinitionNodeModel();
        return new InfowindowsView({
          className: 'Editor-content',
          userActions: self._userActions,
          layerDefinitionModel: self._layerDefinitionModel,
          queryGeometryModel: nodeDefModel.queryGeometryModel,
          querySchemaModel: nodeDefModel.querySchemaModel,
          queryRowsCollection: nodeDefModel.queryRowsCollection,
          configModel: self._configModel,
          editorModel: self._editorModel
        });
      }
    }, {
      label: _t('editor.layers.menu-tab-pane-labels.legends'),
      name: 'legends',
      createContentView: function () {
        var nodeDefModel = self._layerDefinitionModel.getAnalysisDefinitionNodeModel();
        return new LegendsView({
          className: 'Editor-content',
          mapDefinitionModel: self._mapDefinitionModel,
          userActions: self._userActions,
          layerDefinitionModel: self._layerDefinitionModel,
          queryGeometryModel: nodeDefModel.queryGeometryModel,
          querySchemaModel: nodeDefModel.querySchemaModel,
          queryRowsCollection: nodeDefModel.queryRowsCollection,
          legendDefinitionsCollection: self._legendDefinitionsCollection,
          editorModel: self._editorModel,
          userModel: self._userModel,
          configModel: self._configModel,
          modals: self._modals
        });
      }
    }];

    var layerHeaderView = new LayerHeaderView({
      layerDefinitionsCollection: this._layerDefinitionsCollection,
      layerDefinitionModel: this._layerDefinitionModel,
      userActions: this._userActions,
      configModel: this._configModel,
      modals: this._modals,
      tableNodeModel: tableNodeModel,
      editorModel: this._editorModel,
      stateDefinitionModel: this._stateDefinitionModel,
      visDefinitionModel: this._visDefinitionModel,
      userModel: this._userModel,
      widgetDefinitionsCollection: this._widgetDefinitionsCollection
    });

    this.addView(layerHeaderView);
    this.$el.append(layerHeaderView.render().$el);

    var tabPaneOptions = {
      tabPaneOptions: {
        template: TabPaneTemplate,
        tabPaneItemOptions: {
          tagName: 'li',
          className: 'CDB-NavMenu-item'
        }
      },
      tabPaneItemLabelOptions: {
        tagName: 'button',
        className: 'CDB-NavMenu-link u-upperCase'
      }
    };

    this._layerTabPaneView = createTextLabelsTabPane(tabPaneTabs, tabPaneOptions);
    this._bindEvents();
    this.$el.append(this._layerTabPaneView.render().el);
    this.addView(this._layerTabPaneView);

    this._layerTabPaneView.$el.addClass('js-editorPanelContent');
    this._renderContextButtons();

    return this;
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:context', this._renderContextButtons);

    this.listenTo(this._layerDefinitionModel, 'remove', this._onClickBack);
    this.listenTo(this._layerDefinitionModel, 'change:source', function () {
      if (this.model.get('context') === 'table') {
        this._initTable();
      }

      this._renderContextButtons();
    }.bind(this));
    this.listenTo(this._layerDefinitionModel, 'change:visible', this._renderContextButtons);

    this.listenTo(this._editorModel, 'change:edition', this._changeStyle);

    this.listenTo(this._widgetDefinitionsCollection, 'add remove', this._renderContextButtons);

    this.listenTo(this._getQuerySchemaModel(), 'change:query', this._renderContextButtons);

    this.listenTo(this._onboardings, 'style', function () {
      this._layerTabPaneView.collection.select('name', 'style');
    });

    // Fetch geometry type if there isn't one yet
    var queryGeometryModel = this._getQueryGeometryModel();
    if (queryGeometryModel.shouldFetch()) {
      queryGeometryModel.once('change:simple_geom', function (mdl, simpleGeom) {
        // Reset styles form in order to prevent a sync problem with styles
        if (mdl.hasValue()) {
          this._layerDefinitionModel.styleModel.setDefaultPropertiesByType('simple', simpleGeom, true);
          this.render();
        }
        this._renderContextButtons();
      }, this);
      this.add_related_model(queryGeometryModel);
      queryGeometryModel.fetch();
    }
  },

  _destroyTable: function () {
    if (this._tableView) {
      TableManager.destroy(this._tableView);
      delete this._tableView;
    }
  },

  _initTable: function () {
    if (this._tableView) {
      this._destroyTable();
    }

    this._tableView = TableManager.create({
      analysisDefinitionNodeModel: this._getAnalysisDefinitionNodeModel(),
      configModel: this._configModel,
      modals: this._modals,
      userModel: this._userModel
    });

    $('.js-editor .CDB-Dashboard-canvas').append(this._tableView.render().el);
  },

  _renderContextButtons: function () {
    this._destroyContextButtons();

    var analysisDefinitionNodeModel = this._getAnalysisDefinitionNodeModel();
    var isReadOnly = analysisDefinitionNodeModel.isReadOnly();
    var isVisible = this._layerDefinitionModel.get('visible');
    var queryGeometryModel = this._getQueryGeometryModel();

    $('.CDB-Dashboard-canvas').append(
      changeViewButtons({
        context: this.model.get('context'),
        isThereOtherWidgets: this._widgetDefinitionsCollection.isThereOtherWidgets(),
        isThereTimeSeries: this._widgetDefinitionsCollection.isThereTimeSeries(),
        isThereAnimatedTimeSeries: this._widgetDefinitionsCollection.isThereTimeSeries({ animated: true }),
        queryGeometryModel: queryGeometryModel.get('simple_geom'),
        isSourceType: analysisDefinitionNodeModel.isSourceType(),
        isVisible: isVisible,
        isReadOnly: isReadOnly
      })
    );
    $('.js-showMap').bind('click', this._onMapClick.bind(this));
    $('.js-showTable').bind('click', this._onTableClick.bind(this));
    $('.js-newGeometry').bind('click', this._onClickNewGeometry.bind(this));

    if (isReadOnly || !isVisible) {
      var tooltip = new TipsyTooltipView({
        el: $('.js-newGeometryView'),
        title: function () {
          return $(this).data('tooltip');
        }
      });
      this.addView(tooltip);
    }
  },

  _destroyContextButtons: function () {
    $('.js-mapTableView').remove();
    $('.js-newGeometryView').remove();
  },

  _onMapClick: function (ev) {
    var currentContext = this.model.get('context');
    if (currentContext !== 'map') {
      this._destroyTable();
      this.model.set('context', 'map');
    }
  },

  _onTableClick: function (ev) {
    var currentContext = this.model.get('context');
    if (currentContext !== 'table') {
      this._initTable();
      this.model.set('context', 'table');
    }
  },

  _unbindEvents: function () {
    if (this._layerTabPaneView && this._layerTabPaneView.collection) {
      this._layerTabPaneView.collection.off('change:selected', this._quitEditing, this);
    }
  },

  _bindEvents: function () {
    this._layerTabPaneView.collection.on('change:selected', this._quitEditing, this);
    this.add_related_model(this._layerTabPaneView.collection);
  },

  _onClickBack: function () {
    this._editorModel.set({ edition: false });
    this._stackLayoutModel.prevStep('layers');
  },

  _onClickNewGeometry: function (ev) {
    var $target = $(ev.target).closest('.js-newGeometry');
    var featureType = $target.data('feature-type');

    if ($target.closest('.js-newGeometryItem').hasClass('is-disabled')) return false;

    var editOverlayText = _t('editor.edit-feature.overlay-text', { featureType: _t('editor.edit-feature.features.' + featureType) });

    $('.js-editOverlay-text').html(editOverlayText);
    $('.js-editOverlay').fadeIn(200, function () {
      $('.js-editOverlay').removeClass('is-hidden');
    });

    var feature = this._newFeatureDefinitionModel({ featureType: featureType });
    this._mapModeModel.enterDrawingFeatureMode(feature);
  },

  _newFeatureDefinitionModel: function (opts) {
    return new FeatureDefinitionModel({}, {
      configModel: this._configModel,
      layerDefinitionModel: this._layerDefinitionModel,
      userModel: this._userModel,
      featureType: opts.featureType
    });
  },

  _onClickFixSQL: function () {
    this._editorModel.set({edition: false}, {silent: true});
    this._layerTabPaneView.getTabPane('data').set({selected: true});
  },

  _changeStyle: function () {
    this._layerTabPaneView.changeStyleMenu(this._editorModel);
  },

  _quitEditing: function () {
    if (this._layerTabPaneView.getSelectedTabPaneName() !== 'style' &&
        this._layerTabPaneView.getSelectedTabPaneName() !== 'infowindow' &&
        this._layerTabPaneView.getSelectedTabPaneName() !== 'legends') {
      this._editorModel.set({ edition: false });
    }
  },

  _getAnalysisDefinitionNodeModel: function () {
    return this._layerDefinitionModel.getAnalysisDefinitionNodeModel();
  },

  _getQueryGeometryModel: function () {
    return this._getAnalysisDefinitionNodeModel().queryGeometryModel;
  },

  _getQuerySchemaModel: function () {
    return this._getAnalysisDefinitionNodeModel().querySchemaModel;
  },

  _getQueryRowsCollection: function () {
    return this._getAnalysisDefinitionNodeModel().queryRowsCollection;
  },

  clean: function () {
    this._destroyContextButtons();
    this._destroyTable();
    CoreView.prototype.clean.apply(this);
  }
});

},{"../../components/tab-pane/create-text-labels-tab-pane":537,"../../components/table/table-manager":586,"../../components/tipsy-tooltip-view":589,"../../data/feature-definition-model":626,"../../data/tables-collection":666,"../../helpers/required-opts":1097,"../style/style-view":1052,"./change-view-buttons.tpl":768,"./layer-content-views/analyses/analyses-service":800,"./layer-content-views/analyses/analyses-view":802,"./layer-content-views/analyses/analysis-forms-collection":875,"./layer-content-views/analyses/analysis-source-options-model":877,"./layer-content-views/data/data-view":891,"./layer-content-views/infowindow/infowindows-view":926,"./layer-content-views/legend/legends-view":967,"./layer-header-view.js":971,"./layer-tab-pane.tpl":973,"backbone":"backbone","backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],793:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h2 class="CDB-Text CDB-Size-huge is-light u-secondaryTextColor">'+
((__t=( _t('editor.layers.analysis-form.placeholder-text') ))==null?'':_.escape(__t))+
'</h2>\n<div class="BlockList-item is-dashed no-hover is-space u-tSpace-xl">\n  <ul class="HorizontalBlockList">\n    <li class="HorizontalBlockList-item"></li>\n    <li class="HorizontalBlockList-item"></li>\n  </ul>\n\n  <button class="CDB-Button CDB-Button--primary js-add-analysis">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('editor.layers.layer.add-analysis') ))==null?'':_.escape(__t))+
'</span>\n  </button>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],794:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');
var cdb = require('cartodb.js');
var errorParse = require('../../../../../helpers/error-parser');

var ENOUGH_QUOTA_QUERY = _.template("select cdb_dataservices_client.cdb_enough_quota('<%= analysis %>', <%= rows %>);");

module.exports = {
  init: function (configModel) {
    this.SQL = new cdb.SQL({
      user: configModel.get('user_name'),
      sql_api_template: configModel.get('sql_api_template'),
      api_key: configModel.get('api_key')
    });
  },

  fetch: function (service, rows) {
    var query = ENOUGH_QUOTA_QUERY({
      analysis: service,
      rows: rows
    });

    if (!this.deferred || this.deferred.state() !== 'pending') {
      var deferred = $.Deferred();
      this.deferred = deferred;

      var errorCallback = function (err) {
        deferred.reject(errorParse(err));
      };

      var successCallback = function (data) {
        // response is something like:
        // {"rows":[{"cdb_enough_quota":false}],"time":0.024,"fields":{"cdb_enough_quota":{"type":"boolean"}},"total_rows":1}
        deferred.resolve(data.rows[0].cdb_enough_quota);
      };

      this.SQL.execute(query, null, {
        success: successCallback,
        error: errorCallback
      });
    }

    return this.deferred.promise();
  }
};

},{"../../../../../helpers/error-parser":1090,"cartodb.js":"cartodb.js","jquery":"jquery","underscore":"underscore"}],795:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');
var cdb = require('cartodb.js');
var errorParse = require('../../../../../helpers/error-parser');

var ESTIMATION_QUOTA_QUERY = _.template('SELECT CDB_EstimateRowCount($$<%= query %>;$$)  AS row_count;');

module.exports = {
  init: function (configModel) {
    this.SQL = new cdb.SQL({
      user: configModel.get('user_name'),
      sql_api_template: configModel.get('sql_api_template'),
      api_key: configModel.get('api_key')
    });
  },

  fetch: function (query) {
    var estimationQuery = ESTIMATION_QUOTA_QUERY({
      query: query
    });

    if (!this.deferred || this.deferred.state() !== 'pending') {
      var deferred = $.Deferred();
      this.deferred = deferred;

      var parseResponse = function (response) {
        return response.rows[0].row_count;
      };

      var errorCallback = function (err) {
        deferred.reject(errorParse(err));
      };

      var successCallback = function (data) {
        deferred.resolve(parseResponse(data));
      };

      this.SQL.execute(estimationQuery, null, {
        success: successCallback,
        error: errorCallback
      });
    }

    return this.deferred.promise();
  }
};

},{"../../../../../helpers/error-parser":1090,"cartodb.js":"cartodb.js","jquery":"jquery","underscore":"underscore"}],796:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var cdb = require('cartodb.js');
var errorParse = require('../../../../../helpers/error-parser');

var SERVICE_QUOTA_QUERY = 'select * from cdb_dataservices_client.cdb_service_quota_info();';

var QuotaInfo = Backbone.Collection.extend({
  initialize: function (models, options) {
    if (!options || !options.configModel) throw new Error('configModel is required');

    var configModel = options.configModel;
    this.SQL = new cdb.SQL({
      user: configModel.get('user_name'),
      sql_api_template: configModel.get('sql_api_template'),
      api_key: configModel.get('api_key')
    });

    this._state = 'unfetched';
    this._ready = 'notready';
  },

  fetch: function (options) {
    this._success = options && options.success;
    this._error = options && options.error;

    if (!this.isFetching()) {
      this._state = 'fetching';
      this.SQL.execute(SERVICE_QUOTA_QUERY, null, {
        success: function (data) {
          this._state = 'fetched';
          this._ready = 'ready';
          this._onFetchSuccess(data);
          this._success && this._success();
        }.bind(this),
        error: function (err) {
          this._state = 'error';
          this._error && this._error(errorParse(err));
        }.bind(this)
      });
    }
  },

  _onFetchSuccess: function (data) {
    var models = data.rows;
    _.each(models, function (model) {
      var m = this.getService(model.service);
      m ? m.set(model) : this.add(model);
    }, this);
  },

  getService: function (service) {
    return this.findWhere({service: service});
  },

  isFetching: function () {
    return this.getState() === 'fetching';
  },

  isReady: function () {
    return this._ready === 'ready';
  },

  needsCheck: function () {
    var state = this.getState();
    return state === 'unfetched' || state === 'fetching';
  },

  getState: function () {
    return this._state;
  }
});

var collection;

module.exports = {
  get: function (configModel) {
    if (collection === undefined) {
      collection = new QuotaInfo([], {
        configModel: configModel
      });
    }
    return collection;
  }
};

},{"../../../../../helpers/error-parser":1090,"backbone":"backbone","cartodb.js":"cartodb.js","underscore":"underscore"}],797:[function(require,module,exports){
var _ = require('underscore');

/**
 *  Control which analysis requires quota
 */

var unity = function (input) {
  return input;
};

var routingAnalysisQuota = {
  name: _t('editor.layers.analysis-form.quota.analysis-type.routing'),
  api: 'routing',
  user: 'mapzen_routing',
  needsQuota: true,
  transform: unity
};

var ANALYSES_WITH_QUOTA_MAP = {
  'trade-area': {
    name: _t('editor.layers.analysis-form.quota.analysis-type.trade-area'),
    api: 'isolines',
    user: 'here_isolines',
    transform: function (input, formModel) {
      // the isoline analysis consume N rows x M tracts
      return input * formModel.get('isolines');
    },
    needsQuota: function (quotaInfo) {
      var info = quotaInfo.getService('isolines');
      var provider = info && info.get('provider');
      return !!provider;
    }
  },
  'georeference-street-address': {
    name: _t('editor.layers.analysis-form.quota.analysis-type.georeference-street-address'),
    api: 'hires_geocoder',
    user: 'geocoding',
    transform: unity,
    needsQuota: function (quotaInfo) {
      var info = quotaInfo.getService('hires_geocoder');
      var provider = info && info.get('provider');
      return provider !== 'google';
    }
  },
  'data-observatory-measure': {
    name: _t('editor.layers.analysis-form.quota.analysis-type.data-observatory-measure'),
    api: 'observatory',
    user: 'obs_general',
    needsQuota: true,
    transform: unity
  },
  'routing-sequential': routingAnalysisQuota,
  'routing-to-layer-all-to-all': routingAnalysisQuota,
  'routing-to-single-point': routingAnalysisQuota
};

module.exports = {
  requiresQuota: function (type, quotaInfo) {
    if (ANALYSES_WITH_QUOTA_MAP[type] !== undefined) {
      var needsQuota = ANALYSES_WITH_QUOTA_MAP[type].needsQuota;
      if (_.isFunction(needsQuota)) {
        return needsQuota(quotaInfo);
      } else {
        return needsQuota;
      }
    }
    return false;
  },

  transformInput: function (type, input, formModel) {
    if (ANALYSES_WITH_QUOTA_MAP[type] !== undefined) {
      var transform = ANALYSES_WITH_QUOTA_MAP[type].transform;
      return transform(input, formModel);
    }
    return input;
  },

  getAnalysisName: function (type) {
    if (ANALYSES_WITH_QUOTA_MAP[type]) {
      return ANALYSES_WITH_QUOTA_MAP[type].name;
    }
    return null;
  },

  getServiceName: function (type) {
    if (ANALYSES_WITH_QUOTA_MAP[type]) {
      return ANALYSES_WITH_QUOTA_MAP[type].api;
    }
    return null;
  },

  getUserDataName: function (type) {
    if (ANALYSES_WITH_QUOTA_MAP[type]) {
      return ANALYSES_WITH_QUOTA_MAP[type].user;
    }
    return null;
  }

};

},{"underscore":"underscore"}],798:[function(require,module,exports){
var _ = require('underscore');
var AnalysesQuotaOptions = require('./analyses-quota-options');
var CONTACT_LINK_TEMPLATE = _.template("<a href='mailto:<%- mail %>'><%- contact %></a>");

function getOwnerEmail (userModel) {
  return userModel._organizationModel && userModel._organizationModel.get('admin_email');
}

function getEmail (configModel, userModel) {
  var isSaas = configModel.get('cartodb_com_hosted') === false;
  var insideOrganization = userModel.isInsideOrg();
  var ownerOrganization = userModel.isOrgOwner();
  var email = _t('editor.layers.analysis-form.quota.emails.support');

  if (isSaas) {
    if (insideOrganization) {
      email = ownerOrganization ? _t('editor.layers.analysis-form.quota.emails.support') : getOwnerEmail(userModel);
    } else {
      email = _t('editor.layers.analysis-form.quota.emails.saas');
    }
  }

  return email;
}

function getMessage (configModel, userModel, notAssignedQuota) {
  var insideOrganization = userModel.isInsideOrg();
  var ownerOrganization = userModel.isOrgOwner();
  var message;

  if (notAssignedQuota) {
    if (insideOrganization && !ownerOrganization) {
      message = _t('editor.layers.analysis-form.quota.contact-message.no-quota-assigned.organization');
    } else {
      message = _t('editor.layers.analysis-form.quota.contact-message.no-quota-assigned.regular');
    }
  } else {
    if (insideOrganization && !ownerOrganization) {
      message = _t('editor.layers.analysis-form.quota.contact-message.no-credits.organization');
    } else {
      message = _t('editor.layers.analysis-form.quota.contact-message.no-credits.regular');
    }
  }

  return message;
}

var getNoCreditMessage = function (quota, type, configModel, userModel) {
  var link;
  var message;

  link = CONTACT_LINK_TEMPLATE({
    mail: getEmail(configModel, userModel),
    contact: getMessage(configModel, userModel, quota.totalQuota === 0)
  });

  if (quota.totalQuota === 0) {
    message = _t('editor.layers.analysis-form.quota.no-quota-assigned-body', {
      analysis: AnalysesQuotaOptions.getAnalysisName(type),
      contact: link
    });
  } else {
    message = _t('editor.layers.analysis-form.quota.no-credits-body', {
      contact: link
    });
  }

  return message;
};

module.exports = {
  make: function (data, configModel, userModel) {
    var blockPrice = (data.quotaInfo.blockPrice / 100);
    var estimation = data.estimation;
    var blockSize = data.quotaInfo.blockSize;
    var body = '';
    var type = '';
    var link;

    if (data.quotaInfo.hardLimit) {
      if (data.creditsLeft > 0) {
        if (data.quotaInfo.enoughQuota) {
          // You need to use approximately xxx of your credits.
          body = _t('editor.layers.analysis-form.quota.enough-quota', {
            credits: estimation
          });
          type = 'success';
        } else {
          // We're sorry the current quota is insufficient to enrich your data. Rows will be set to null and analysis may not complete. Please contact us to extend your quota for this function.
          link = CONTACT_LINK_TEMPLATE({
            mail: getEmail(configModel, userModel),
            contact: getMessage(configModel, userModel, false)
          });

          body = _t('editor.layers.analysis-form.quota.hard-limit-not-enough-quota', {
            contact: link
          });
          type = 'alert';
        }
      } else {
        // To get access to the [service] you will need more credits. Your current quota is not enough. Contact us.
        body = getNoCreditMessage(data.quotaInfo, data.type, configModel, userModel);
        type = 'alert';
      }
    } else {
      if (data.creditsLeft > 0) {
        // enoughQuota wil be true when soft_limit, becuase in this case, the api asume true
        if (data.creditsLeft >= estimation) {
          // You need to use some of your credits for this (data.estimation)
          body = _t('editor.layers.analysis-form.quota.enough-quota', {
            credits: estimation
          });
          type = 'success';
        } else {
          // Using this analysis component may incur extra fees depending on your account quota. Please review your current quota and/or request a larger allocation.
          body = _t('editor.layers.analysis-form.quota.soft-limit-enough-quota', {
            credits: estimation,
            blockSize: blockSize,
            blockPrice: blockPrice
          });
          type = 'alert';
        }
      } else {
        if (data.quotaInfo.totalQuota === 0) {
          body = getNoCreditMessage(data.quotaInfo, data.type, configModel, userModel);
        } else {
          // Using this analysis component may incur extra fees depending on your account quota. Please review your current quota and/or request a larger allocation.
          body = _t('editor.layers.analysis-form.quota.soft-limit-enough-quota', {
            credits: estimation,
            blockSize: blockSize,
            blockPrice: blockPrice
          });
        }
        type = 'alert';
      }
    }

    return {
      type: type,
      body: body
    };
  }
};


},{"./analyses-quota-options":797,"underscore":"underscore"}],799:[function(require,module,exports){
var _ = require('underscore');
var AnalysesQuotaOptions = require('./analyses-quota-options');
/**
 *  Provide info about quota
 *  It handles the source of data: api and user model
 */

var QUOTA_DEFAULTS = {
  totalQuota: 0,
  usedQuota: 0,
  blockSize: 1000,
  blockPrice: 0,
  enoughQuota: true
};

module.exports = function (type, userModel, quotaInfo, enoughQuota) {
  var apiData = quotaInfo.getService(AnalysesQuotaOptions.getServiceName(type)) || {};
  var userData = userModel.get(AnalysesQuotaOptions.getUserDataName(type)) || {};

  // Remove null | undefined | falsy values
  userData = _.pick(userData, _.identity);
  return _.defaults(
    {
      blockSize: userData.block_size,
      blockPrice: userData.block_price
    },
    {
      totalQuota: apiData.get('monthly_quota'),
      usedQuota: apiData.get('used_quota'),
      hardLimit: !apiData.get('soft_limit')
    },
    {
      enoughQuota: enoughQuota
    },
    QUOTA_DEFAULTS
  );
};

},{"./analyses-quota-options":797,"underscore":"underscore"}],800:[function(require,module,exports){
// Make common analyses actions available whin editor context
var checkAndBuildOpts = require('../../../../helpers/required-opts');
var AddAnalysisView = require('../../../../components/modals/add-analysis/add-analysis-view');
var nodeIds = require('../../../../value-objects/analysis-node-ids');

var REQUIRED_OPTS = [
  'onboardings',
  'layerDefinitionsCollection',
  'modals',
  'userModel',
  'configModel'
];

module.exports = (function () {
  return {
    init: function (opts) {
      checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    },

    setLayerId: function (layerId) {
      var layerDefinitionModel = this._layerDefinitionsCollection.get(layerId);
      if (!layerDefinitionModel) {
        throw new Error('no layer-definition found for id' + layerId + ', available layer ids are: ' + this._layerDefinitionsCollection.pluck('id') + ')');
      }

      this._layerId = layerId;
    },

    setStackLayoutView: function (stackLayoutView) {
      if (!stackLayoutView) {
        throw new Error('stackLayoutView is required');
      }

      this._stackLayoutView = stackLayoutView;
    },

    addGeoreferenceAnalysis: function () {
      var layerDefinitionModel = this._layerDefinitionsCollection.get(this._layerId);

      var letter = layerDefinitionModel.get('letter');
      var sourceId = layerDefinitionModel.get('source');

      this._stackLayoutView.model.goToStep(1, layerDefinitionModel, 'layer-content', 'analyses', {
        source: sourceId,
        id: letter === nodeIds.letter(sourceId)
          ? nodeIds.next(sourceId)
          : letter + '1',
        type: 'georeference-long-lat'
      });
    },

    addAnalysis: function () {
      this._onboardings.destroy();

      var layerDefinitionModel = this._layerDefinitionsCollection.get(this._layerId);

      this._modals.create(function (modalModel) {
        return new AddAnalysisView({
          userModel: this._userModel,
          configModel: this._configModel,
          modalModel: modalModel,
          layerDefinitionModel: layerDefinitionModel
        });
      }.bind(this));
      this._modals.onDestroyOnce(function (analysisFormAttrs) {
        if (analysisFormAttrs) {
          // A analysis option was seleted, redirect to layer-content view with new attrs
          this._stackLayoutView.model.goToStep(1, layerDefinitionModel, 'layer-content', 'analyses', analysisFormAttrs);
        }
      }, this);
    }
  };
})();

},{"../../../../components/modals/add-analysis/add-analysis-view":235,"../../../../helpers/required-opts":1097,"../../../../value-objects/analysis-node-ids":1119}],801:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h2 class="CDB-Text CDB-Size-huge is-light u-secondaryTextColor">\n  '+
((__t=( body ))==null?'':__t)+
'\n</h2>\n';
}
return __p;
};

},{"underscore":"underscore"}],802:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var Infobox = require('../../../../components/infobox/infobox-factory');
var InfoboxModel = require('../../../../components/infobox/infobox-model');
var InfoboxCollection = require('../../../../components/infobox/infobox-collection');
var PanelWithOptionsView = require('../../../../components/view-options/panel-with-options-view');
var panelTemplate = require('./panel-with-options.tpl');
var LayerContentAnalysesView = require('./layer-content-analyses-view');
var OnboardingLauncher = require('../../../../components/onboardings/generic/generic-onboarding-launcher');
var OnboardingView = require('../../../../components/onboardings/layers/analysis-onboarding/analysis-onboarding-view');
var layerOnboardingKey = require('../../../../components/onboardings/layers/layer-onboarding-key');
var checkAndBuildOpts = require('../../../../helpers/required-opts');
var fetchAllQueryObjectsIfNecessary = require('../../../../helpers/fetch-all-query-objects');
var AnalysesService = require('./analyses-service.js');

var REQUIRED_OPTS = [
  'userActions',
  'analysisFormsCollection',
  'layerDefinitionModel',
  'analysisDefinitionNodesCollection',
  'configModel',
  'userModel',
  'editorModel',
  'stackLayoutModel',
  'onboardings',
  'onboardingNotification'
];

module.exports = CoreView.extend({

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._selectedNodeId = opts.selectedNodeId;

    this._infoboxModel = new InfoboxModel({
      state: ''
    });

    this._overlayModel = new Backbone.Model({
      visible: this._isLayerHidden()
    });

    this._onboardingLauncher = new OnboardingLauncher({
      view: OnboardingView,
      onboardingNotification: this._onboardingNotification,
      notificationKey: layerOnboardingKey,
      onboardings: this._onboardings
    }, {
      editorModel: this._editorModel,
      selector: 'LayerOnboarding'
    });

    this._getQueryAndCheckState();

    this._initBinds();
  },

  render: function () {
    this._launchOnboarding();
    this.clearSubViews();
    this.$el.empty();

    var self = this;
    var infoboxSstates = [
      {
        state: 'georeference',
        createContentView: function () {
          var name = this._layerDefinitionModel ? this._layerDefinitionModel.getTableName() : '';
          var body = [_t('editor.tab-pane.layers.georeference.body', { name: name }),
                      _t('editor.layers.georeference.manually-add')].join(' ');

          return Infobox.createWithAction({
            type: 'alert',
            title: _t('editor.tab-pane.layers.georeference.title'),
            body: body,
            mainAction: {
              label: _t('editor.layers.georeference.georeference-button')
            }
          });
        },
        mainAction: self._onGeoreferenceClicked.bind(self)
      }, {
        state: 'layer-hidden',
        createContentView: function () {
          return Infobox.createWithAction({
            type: 'alert',
            title: _t('editor.style.messages.layer-hidden.title'),
            body: _t('editor.style.messages.layer-hidden.body'),
            mainAction: {
              label: _t('editor.style.messages.layer-hidden.show')
            }
          });
        },
        mainAction: self._showHiddenLayer.bind(self)
      }
    ];

    var infoboxCollection = new InfoboxCollection(infoboxSstates);

    var panelWithOptionsView = new PanelWithOptionsView({
      template: panelTemplate,
      className: 'Editor-content',
      editorModel: self._editorModel,
      infoboxModel: self._infoboxModel,
      infoboxCollection: infoboxCollection,
      createContentView: function () {
        return new LayerContentAnalysesView({
          className: 'Editor-content',
          userActions: self._userActions,
          analysisDefinitionNodesCollection: self._analysisDefinitionNodesCollection,
          userModel: self._userModel,
          analysisFormsCollection: self._analysisFormsCollection,
          configModel: self._configModel,
          layerDefinitionModel: self._layerDefinitionModel,
          stackLayoutModel: self._stackLayoutModel,
          selectedNodeId: self._selectedNodeId,
          overlayModel: self._overlayModel
        });
      }
    });

    this.$el.append(panelWithOptionsView.render().el);
    this.addView(panelWithOptionsView);
    return this;
  },

  _initBinds: function () {
    // Only when there is no nodes we should check if node can be georeferenced
    this.listenTo(this._analysisFormsCollection, 'reset remove', this._getQueryAndCheckState);
  },

  _getQueryAndCheckState: function () {
    var setStateAndRender = function () {
      this._infoboxState();
      this.render();
    }.bind(this);

    if (!this._analysisFormsCollection.isEmpty()) {
      setStateAndRender();
      return;
    }

    var analysisDefinitionNodeModel = this._layerDefinitionModel.getAnalysisDefinitionNodeModel();

    fetchAllQueryObjectsIfNecessary(
      {
        queryRowsCollection: analysisDefinitionNodeModel.queryRowsCollection,
        queryGeometryModel: analysisDefinitionNodeModel.queryGeometryModel,
        querySchemaModel: analysisDefinitionNodeModel.querySchemaModel
      },
      setStateAndRender
    );
  },

  _launchOnboarding: function () {
    if (this._onboardingNotification.getKey(layerOnboardingKey)) {
      return;
    }

    if (this._analysisFormsCollection.isEmpty()) {
      this._onboardingLauncher.launch();
    }
  },

  _infoboxState: function () {
    if (this._isLayerHidden()) {
      this._infoboxModel.set({state: 'layer-hidden'});
      this._overlayModel.set({visible: true});
    } else if (this._layerDefinitionModel.canBeGeoreferenced() && this._analysisFormsCollection.isEmpty()) {
      this._infoboxModel.set({state: 'georeference'});
      this._overlayModel.set({visible: false});
    } else {
      this._infoboxModel.set({state: ''});
      this._overlayModel.set({visible: false});
    }
  },

  _showHiddenLayer: function () {
    this._layerDefinitionModel.toggleVisible();
    this._userActions.saveLayer(this._layerDefinitionModel);

    this._infoboxState();
  },

  _isLayerHidden: function () {
    return this._layerDefinitionModel.get('visible') === false;
  },

  _onGeoreferenceClicked: function () {
    AnalysesService.addGeoreferenceAnalysis();
  }
});

},{"../../../../components/infobox/infobox-collection":215,"../../../../components/infobox/infobox-factory":216,"../../../../components/infobox/infobox-model":219,"../../../../components/onboardings/generic/generic-onboarding-launcher":501,"../../../../components/onboardings/layers/analysis-onboarding/analysis-onboarding-view":503,"../../../../components/onboardings/layers/layer-onboarding-key":507,"../../../../components/view-options/panel-with-options-view":595,"../../../../helpers/fetch-all-query-objects":1092,"../../../../helpers/required-opts":1097,"./analyses-service.js":800,"./layer-content-analyses-view":881,"./panel-with-options.tpl":882,"backbone":"backbone","backbone/core-view":1127}],803:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./analyses-workflow-item.tpl');
var nodeIds = require('../../../../value-objects/analysis-node-ids');
var layerColors = require('../../../../data/layer-colors');
var AnalysisTooltip = require('../../analysis-views/analyses-tooltip-error');

module.exports = CoreView.extend({

  tagName: 'li',
  className: 'HorizontalBlockList-item',

  events: {
    'click': '_onNodeClick'
  },

  initialize: function (opts) {
    if (!opts.analysisNode && !opts.formModel) throw new Error('analysisNode or formModel is required');
    if (!opts.viewModel) throw new Error('viewModel is required');

    this._isNew = !opts.analysisNode;
    this._analysisNode = opts.analysisNode || opts.formModel; // if form model represents a new node there is no analysis yet; use form model as fallback
    this._viewModel = opts.viewModel;

    this._analysisNode.on('change:status', this.render, this);
    this.add_related_model(this._analysisNode);

    this._analysisTooltip = new AnalysisTooltip({
      analysisNode: this._analysisNode,
      element: this.$el,
      triggerSelector: '.Editor-ListAnalysis-itemError'
    });

    this.addView(this._analysisTooltip);
  },

  render: function () {
    var status = this._analysisNode.get('status');
    var isDone = this._isNew || status === 'ready' || status === 'failed';
    var isSelected = this._analysisNode.id === this._viewModel.get('selectedNodeId');
    var letter = nodeIds.letter(this._analysisNode.id);
    var bgColor = layerColors.getColorForLetter(letter);

    this.$el.html(
      template({
        isNew: this._isNew,
        isDone: isDone,
        bgColor: bgColor,
        isSelected: isSelected,
        nodeId: this._analysisNode.id,
        hasError: status === 'failed'
      })
    );

    this.$el.css({
      background: isSelected ? bgColor : '',
      border: isSelected ? '1px solid ' + bgColor : ''
    });
    this.$el.toggleClass('is-selected', isSelected);
    this.$el.toggleClass('has-error', status === 'failed');

    return this;
  },

  _onNodeClick: function () {
    this._viewModel.set('selectedNodeId', this._analysisNode.id);
  }
});

},{"../../../../data/layer-colors":633,"../../../../value-objects/analysis-node-ids":1119,"../../analysis-views/analyses-tooltip-error":723,"./analyses-workflow-item.tpl":804,"backbone/core-view":1127}],804:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (isDone) { 
__p+='\n  <div class="HorizontalBlockList-item-actionBlock CDB-Text CDB-Size-small u-upperCase">\n    <span class="HorizontalBlockList-item-text">\n      '+
((__t=( nodeId ))==null?'':_.escape(__t))+
'\n    </span>\n    ';
 if (!isNew) { 
__p+='\n      <i class="CDB-IconFont CDB-IconFont-ray CDB-Size-medium HorizontalBlockList-item-icon"></i>\n    ';
 } 
__p+='\n  </div>\n';
 } else { 
__p+='\n  ';
 if (isSelected) { 
__p+='\n    <div class="CDB-LoaderIcon">\n      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n      </svg>\n    </div>\n  ';
 } else { 
__p+='\n    <div class="CDB-LoaderIcon is-dark">\n      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n      </svg>\n    </div>\n  ';
 } 
__p+='\n';
 } 
__p+='\n\n';
 if (hasError) { 
__p+='\n<div class="Editor-ListAnalysis-itemError"></div>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],805:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var AnalysesWorkflowItemView = require('./analyses-workflow-item-view');
var template = require('./analyses-workflow-list.tpl');

module.exports = CoreView.extend({

  className: 'HorizontalBlockList u-tSpace',
  tagName: 'ul',

  initialize: function (opts) {
    if (!opts.analysisDefinitionNodesCollection) throw new Error('analysisDefinitionNodesCollection is required');
    if (!opts.analysisFormsCollection) throw new Error('analysisFormsCollection is required');
    if (!opts.model) throw new Error('model is required');
    if (!opts.layerId) throw new Error('layerId is required');

    this._analysisDefinitionNodesCollection = opts.analysisDefinitionNodesCollection;
    this.analysis = opts.analysis;
    this.analysisFormsCollection = opts.analysisFormsCollection;
    this._layerId = opts.layerId;
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template({
      layerId: this._layerId
    }));

    this.analysisFormsCollection.each(this._renderWorkflowItem, this);
    return this;
  },

  _renderWorkflowItem: function (formModel) {
    var view = new AnalysesWorkflowItemView({
      analysisNode: this._analysisDefinitionNodesCollection.get(formModel.id),
      formModel: formModel,
      viewModel: this.model,
      layerId: this._layerId
    });
    this.$el.append(view.render().el);
    this.addView(view);
  }
});

},{"./analyses-workflow-item-view":803,"./analyses-workflow-list.tpl":806,"backbone/core-view":1127}],806:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<li class="HorizontalBlockList-item is-add">\n  <div class="HorizontalBlockList-item-actionBlock js-add-analysis" data-layer-id="'+
((__t=( layerId ))==null?'':_.escape(__t))+
'">\n    <div class="CDB-Shape">\n      <div class="CDB-Shape-add is-blue is-small"></div>\n    </div>\n  </div>\n</li>\n';
}
return __p;
};

},{"underscore":"underscore"}],807:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./analyses-workflow.tpl');
var ListView = require('./analyses-workflow-list-view');
var ScrollView = require('../../../../components/scroll/scroll-view');

module.exports = CoreView.extend({

  events: {
    'click .js-delete': '_deleteAnalysis'
  },

  initialize: function (opts) {
    if (!opts.analysisDefinitionNodesCollection) throw new Error('analysisDefinitionNodesCollection is required');
    if (!opts.analysisFormsCollection) throw new Error('analysisFormsCollection is required');
    if (!opts.viewModel) throw new Error('viewModel is required');
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');

    this._analysisDefinitionNodesCollection = opts.analysisDefinitionNodesCollection;
    this.analysisFormsCollection = opts.analysisFormsCollection;
    this.viewModel = opts.viewModel;
    this._layerDefinitionModel = opts.layerDefinitionModel;
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(this._html());
    this._renderAnalysesView();
    return this;
  },

  _html: function () {
    return template({
      canDelete: this._canDeleteSelectedNode(),
      deleteLabel: !this._nodeDefModel()
        ? _t('editor.layers.layer.cancel-delete-analysis')
        : _t('editor.layers.layer.delete'),
      selectedNodeId: this.viewModel.get('selectedNodeId'),
      layerAnalysisCount: this._layerDefinitionModel.getNumberOfAnalyses()
    });
  },

  _renderAnalysesView: function () {
    var self = this;
    var view = new ScrollView({
      type: 'horizontal',
      createContentView: function () {
        return new ListView({
          analysisDefinitionNodesCollection: self._analysisDefinitionNodesCollection,
          analysisFormsCollection: self.analysisFormsCollection,
          model: self.viewModel,
          layerId: self._layerDefinitionModel.id
        });
      }
    });

    this.$('.js-content').append(view.render().el);
    this.addView(view);
  },

  _deleteAnalysis: function () {
    if (this._canDeleteSelectedNode()) {
      this.analysisFormsCollection.deleteNode(this.viewModel.get('selectedNodeId'));
    }
  },

  _canDeleteSelectedNode: function () {
    var nodeDefModel = this._nodeDefModel();
    return !nodeDefModel || nodeDefModel.canBeDeletedByUser();
  },

  _nodeDefModel: function () {
    var nodeId = this.viewModel.get('selectedNodeId');
    return this._layerDefinitionModel.findAnalysisDefinitionNodeModel(nodeId);
  }

});

},{"../../../../components/scroll/scroll-view":530,"./analyses-workflow-list-view":805,"./analyses-workflow.tpl":808,"backbone/core-view":1127}],808:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfo">\n  <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">1</div>\n  <div class="Editor-HeaderInfo-inner CDB-Text js-content">\n    <div class="Editor-HeaderInfo-title u-bSpace--m">\n      <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">\n        '+
((__t=( _t('editor.layers.analysis-form.workflow') ))==null?'':_.escape(__t))+
'\n        <span class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large u-altTextColor">('+
((__t=( layerAnalysisCount ))==null?'':_.escape(__t))+
')</span>\n      </h2>\n    </div>\n    <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--xl">\n      '+
((__t=( _t('editor.layers.layer.analysis') ))==null?'':_.escape(__t))+
' '+
((__t=( selectedNodeId ))==null?'':_.escape(__t))+
'\n      ';
 if (canDelete) { 
__p+='\n        <button class="js-delete u-actionTextColor u-upperCase">'+
((__t=( deleteLabel ))==null?'':_.escape(__t))+
'</button>\n      ';
 } 
__p+='\n    </p>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],809:[function(require,module,exports){
var CoreView = require('backbone/core-view');

module.exports = CoreView.extend({
  initialize: function (opts) {
    this.template = opts.template;
    this.model = opts.model;
    this._initBinds();
  },

  render: function () {
    var html = this.template(this.model.attributes);

    this.clearSubViews();
    this.$el.empty();
    this.$el.append(html);
    return this;
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:isDisabled', this.render);
  }
});

},{"backbone/core-view":1127}],810:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var template = require('./analysis-controls.tpl');
var InfoboxFactory = require('../../../../components/infobox/infobox-factory');
var InfoboxModel = require('../../../../components/infobox/infobox-model');
var InfoboxCollection = require('../../../../components/infobox/infobox-collection');
var AnalysesQuotaPresenter = require('./analyses-quota/analyses-quota-presenter');
var AnalysesQuotaOptions = require('./analyses-quota/analyses-quota-options');
var AnalysesQuotaProvider = require('./analyses-quota/analyses-quota-provider');
var AnalysesQuotaEstimation = require('./analyses-quota/analyses-quota-estimation-input');
var AnalysesQuotaEnough = require('./analyses-quota/analyses-quota-enough');
var checkAndBuildOpts = require('../../../../helpers/required-opts');
var AnalysisButtonView = require('./analysis-button-view');
var AnalysisQuotaView = require('./analysis-quota-view');

var REQUIRED_OPTS = [
  'formModel',
  'userActions',
  'userModel',
  'stackLayoutModel',
  'configModel',
  'querySchemaModel',
  'quotaInfo'
];

/**
 * View representing the apply button for a form
 */
module.exports = CoreView.extend({
  className: 'Options-bar Options-bar--right u-flex',

  events: {
    'click .js-save': '_onSaveClicked'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this._analysisNode = opts.analysisNode;

    AnalysesQuotaEstimation.init(opts.configModel);
    AnalysesQuotaEnough.init(opts.configModel);

    this._viewModel = new Backbone.Model({
      isNewAnalysis: !opts.analysisNode,
      hasChanges: !opts.analysisNode,
      type: this._formModel.get('type')
    });

    this._infoboxModel = new InfoboxModel({
      state: this._quotaInfo.getState(),
      visible: true
    });

    this._initBinds();

    if (!opts.analysisNode) {
      this._fetchQuotaIfNeeded();
    }

    this.render = this.render.bind(this);
    this._onFormModelChanged = this._onFormModelChanged.bind(this);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    var type = this._formModel.get('type');
    var isValid = this._formModel.isValid();

    // If no dataservice, requiresQuota returns false because the model doesn't exist and it's converted to boolean
    var requiresQuota = AnalysesQuotaOptions.requiresQuota(type, this._quotaInfo);
    var view;

    if (this._isAnalysisDone() && !this._hasChanges()) {
      view = this._createButtonView();
    } else {
      // If the analysis doesn't require quota, let's not wait or check the fetching state
      if (!requiresQuota || !isValid) {
        view = this._createButtonView();
      } else {
        view = this._createQuotaView();
      }
    }

    this.addView(view);
    this.$el.append(view.render().el);
    this._setTrackingClass();

    return this;
  },

  _setTrackingClass: function () {
    this.$('.js-save').addClass('track-' + this._formModel.get('type') + '-analysis track-apply');
  },

  _initBinds: function () {
    this.listenTo(this._formModel, 'change', this._onFormModelChanged);

    if (this._analysisNode) {
      this.listenTo(this._analysisNode, 'change:status', function () {
        var isAnalysisDone = this._isAnalysisDone();
        if (isAnalysisDone) {
          this.render();
        }
      });
    }
  },

  _onFormModelChanged: function () {
    var isAnalysisDone = this._isAnalysisDone();
    var isDone = this._viewModel.get('isNewAnalysis') || isAnalysisDone;
    var canSave = this._formModel.isValid() && isDone;

    this._viewModel.set({
      hasChanges: true,
      type: this._formModel.get('type'),
      isDisabled: !canSave
    });

    this.render();
    this._fetchQuotaIfNeeded();
  },

  _fetchQuotaIfNeeded: function () {
    var type = this._formModel.get('type');
    var isValid = this._formModel.isValid();
    var quota = this._quotaInfo;
    if ((quota.needsCheck() || AnalysesQuotaOptions.requiresQuota(type, quota)) && isValid) {
      this._fetchQuota();
    }
  },

  _fetchQuota: function () {
    this._infoboxModel.set('state', 'fetching');

    this._quotaInfo.fetch({
      success: function () {
        this._buildQuotaViewInfo();
      }.bind(this),
      error: function (error) {
        this._viewModel.set({error: error});
        this._infoboxModel.set('state', 'error');
      }.bind(this)
    });
  },

  _createButtonView: function () {
    var label = this._formModel.get('persisted')
        ? _t('editor.layers.analysis-form.apply-btn')
        : _t('editor.layers.analysis-form.create-btn');

    this._viewModel.set({
      label: label,
      isDisabled: !this._canSave()
    });

    return new AnalysisButtonView({
      template: template,
      model: this._viewModel
    });
  },

  _buildQuotaViewInfo: function () {
    var formModel = this._formModel;
    var userModel = this._userModel;
    var type = formModel.get('type');
    var service = AnalysesQuotaOptions.getServiceName(type);
    var query = this._querySchemaModel.get('query');
    var quotaData = this._quotaInfo;

    this.payload = {};
    this.payload.type = type;

    var errorCallback = function (error) {
      this._viewModel.set('error', error);
      this._infoboxModel.set('state', 'error');
    }.bind(this);

    var checkEnoughQuota = function (data) {
      // Apply transformation to the input
      // for example isolines takes tracts in in order to calculate estimation
      var rows = AnalysesQuotaOptions.transformInput(type, data, formModel);
      this.payload.estimation = rows;
      // with the input, we calculate wether the quota is enough
      return AnalysesQuotaEnough.fetch(service, rows);
    }.bind(this);

    var buildPayload = function (enoughQuota) {
      var payload = this.payload;
      // then we can get the full set of data
      payload.quotaInfo = AnalysesQuotaProvider(type, userModel, quotaData, enoughQuota);
      payload.creditsLeft = payload.quotaInfo.totalQuota - payload.quotaInfo.usedQuota;
      payload.canRunAnalysis = ((enoughQuota && payload.quotaInfo.totalQuota > 0) ||
                               (payload.quotaInfo.hardLimit === false && payload.quotaInfo.totalQuota > 0));

      // finally we are ready to show the information
      this._infoboxModel.set('state', 'ready');
    }.bind(this);

    var dsReady = quotaData.isReady();

    // Only checks api if analysis belongs to a service with quota
    if (service !== null && dsReady) {
      if (formModel.isValid()) {
        // get the estimation for this analysis
        AnalysesQuotaEstimation.fetch(query)
          .then(checkEnoughQuota, errorCallback)
          .then(buildPayload, errorCallback);
      } else {
        // to render the simple button view.
        this.render();
      }
    } else if (!dsReady) {
      errorCallback(_t('editor.layers.analysis-form.quota.quota-dataservice-down'));
    }
  },

  _createQuotaView: function () {
    var states = [
      {
        state: 'fetching',
        createContentView: function () {
          return InfoboxFactory.createLoading({
            body: _t('editor.layers.analysis-form.quota.loading')
          });
        }
      },
      {
        state: 'ready',
        createContentView: function () {
          var payload = this.payload;
          var confirmLabel = _t('editor.layers.analysis-form.confirm-analysis');
          var quotaMessage = '';

          if (payload.creditsLeft > 0) {
            quotaMessage = _t('editor.layers.analysis-form.quota.credits-left-message', {
              smart_count: payload.creditsLeft
            });
          } else {
            quotaMessage = _t('editor.layers.analysis-form.quota.no-credits-message');
          }
          payload.quotaInfo.quotaMessage = quotaMessage;

          var dataInfobox = _.extend(AnalysesQuotaPresenter.make(payload, this._configModel, this._userModel), {
            title: _t('editor.layers.analysis-form.quota.title'),
            mainAction: {
              label: confirmLabel,
              type: 'primary',
              disabled: !this._canSave() || !payload.canRunAnalysis
            },
            quota: payload.quotaInfo
          });

          return InfoboxFactory.createQuota(dataInfobox);
        }.bind(this),
        mainAction: function () {
          var payload = this.payload;
          if (this._canSave() && payload.canRunAnalysis) {
            this._saveAnalysis();
          }
        }.bind(this),
        closeAction: function () {
          this._stackLayoutModel.prevStep('layers');
        }.bind(this)
      },
      {
        state: 'error',
        createContentView: function () {
          return InfoboxFactory.createWithAction({
            title: _t('editor.layers.analysis-form.quota.title'),
            type: 'error',
            body: _t('editor.layers.analysis-form.quota.quota-fetch-error', {
              error: this._viewModel.get('error')
            }),
            mainAction: {
              label: _t('editor.layers.analysis-form.quota.cancel')
            }
          });
        }.bind(this),
        mainAction: function () {
          this._stackLayoutModel.prevStep('layers');
        }.bind(this)
      }
    ];

    return new AnalysisQuotaView({
      className: 'Infobox-wrapper',
      infoboxModel: this._infoboxModel,
      infoboxCollection: new InfoboxCollection(states)
    });
  },

  _canSave: function () {
    var isAnalysisDone = this._isAnalysisDone();
    var isDone = this._viewModel.get('isNewAnalysis') || isAnalysisDone;
    var hasChanges = this._viewModel.get('hasChanges');
    return this._formModel.isValid() && isDone && hasChanges;
  },

  _onSaveClicked: function () {
    if (this._canSave()) {
      this._saveAnalysis();
    }
  },

  _hasChanges: function () {
    return this._viewModel.get('hasChanges') === true;
  },

  _isAnalysisDone: function () {
    return this._analysisNode && (this._analysisNode.isDone() || this._analysisNode.hasFailed());
  },

  _saveAnalysis: function () {
    this._infoboxModel.set('state', 'idle');
    this._userActions.saveAnalysis(this._formModel);
    this._viewModel.set('hasChanges', false);
    this.render();
  }
});

},{"../../../../components/infobox/infobox-collection":215,"../../../../components/infobox/infobox-factory":216,"../../../../components/infobox/infobox-model":219,"../../../../helpers/required-opts":1097,"./analyses-quota/analyses-quota-enough":794,"./analyses-quota/analyses-quota-estimation-input":795,"./analyses-quota/analyses-quota-options":797,"./analyses-quota/analyses-quota-presenter":798,"./analyses-quota/analyses-quota-provider":799,"./analysis-button-view":809,"./analysis-controls.tpl":811,"./analysis-quota-view":876,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],811:[function(require,module,exports){
arguments[4][773][0].apply(exports,arguments)
},{"dup":773,"underscore":"underscore"}],812:[function(require,module,exports){
var _ = require('underscore');
var BaseAnalysisFormModel = require('./base-analysis-form-model');
var template = require('./aggregate-intersection-form.tpl');
var ColumnOptions = require('../column-options');
var AGGREGATE_FORMAT_FIELDS_NAMES = [
  'type',
  'aggregate_column',
  'aggregate_function'
];

/**
 * Form model for the aggregate intersection analysis
 */
module.exports = BaseAnalysisFormModel.extend({
  parse: function (attrs) {
    if (!attrs.aggregate_column) {
      attrs.aggregate_column = 'cartodb_id';
    }
    if (!attrs.aggregate_function) {
      attrs.aggregate_function = 'count';
    }
    attrs.aggregate = {
      operator: attrs.aggregate_function,
      attribute: attrs.aggregate_function === 'count' ? '' : attrs.aggregate_column
    };
    return attrs;
  },

  initialize: function () {
    BaseAnalysisFormModel.prototype.initialize.apply(this, arguments);

    this._columnOptions = new ColumnOptions({}, {
      configModel: this._configModel
    });

    this.listenTo(this._analysisSourceOptionsModel, 'change:fetching', this._setSchema);
    this.listenTo(this._columnOptions, 'columnsFetched', this._setSchema);

    this.on('change:aggregate', this._onChangeAggregate, this);
    this.on('change:target', this._onChangeTarget, this);

    this._setSchema();
    this._fetchColumns();
  },

  _formatAttrs: function (formAttrs) {
    var customFormattedFormAttrs = _.pick(formAttrs, ['id', 'source', 'target'].concat(AGGREGATE_FORMAT_FIELDS_NAMES));
    return BaseAnalysisFormModel.prototype._formatAttrs.call(this, customFormattedFormAttrs);
  },

  getTemplate: function () {
    return template;
  },

  getTemplateData: function () {
    return {
      dataFields: 'aggregate'
    };
  },

  _filterSchemaFieldsByType: function (schema) {
    // Always include the source and target fields in addition to the type-specific fields
    return _.pick(schema, ['source', 'target', 'aggregate']);
  },

  /**
   * @override {BaseAnalysisFormModel._setSchema}
   */
  _setSchema: function () {
    BaseAnalysisFormModel.prototype._setSchema.call(this, this._filterSchemaFieldsByType({
      source: this._primarySourceSchemaItem(_t('editor.layers.analysis-form.base-layer')),
      target: {
        type: 'NodeDataset',
        title: _t('editor.layers.analysis-form.intersection-layer'),
        options: this._getSourceOptionsForSource({
          sourceAttrName: 'target'
        }),
        validators: ['required'],
        dialogMode: 'float',
        editorAttrs: {
          disabled: this._isSourceDisabled('target')
        }
      },
      aggregate: {
        type: 'Operators',
        title: _t('editor.layers.analysis-form.operation'),
        dialogMode: 'float',
        options: this._columnOptions.filterByType('number')
      }
    }));
  },

  _onChangeAggregate: function () {
    var aggregate = this.get('aggregate');
    this.set({
      aggregate_column: aggregate.attribute || 'cartodb_id',
      aggregate_function: aggregate.operator
    });
  },

  _onChangeTarget: function () {
    this.set('aggregate', {
      operator: 'count',
      attribute: ''
    });
    this._analysisSourceOptionsModel.createSourceNodeUnlessExisting(this.get('target'));
    this._fetchColumns();
  },

  _fetchColumns: function () {
    var target = this.get('target');
    var nodeDefModel = this._layerDefinitionModel.findAnalysisDefinitionNodeModel(target);

    if (nodeDefModel) {
      this._columnOptions.setNode(nodeDefModel);
    } else if (target) {
      this._columnOptions.setDataset(target);
    }
  },

  _isSourceDisabled: function (sourceAttrName) {
    return this._isPrimarySource(sourceAttrName) || this._isFetchingOptions();
  }
});

},{"../column-options":879,"./aggregate-intersection-form.tpl":813,"./base-analysis-form-model":820,"underscore":"underscore"}],813:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="source,target">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('analyses.aggregate-intersection.title') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.input-layer') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">3</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="'+
((__t=( dataFields ))==null?'':_.escape(__t))+
'">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.analysis-form.measure-by') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--xl">'+
((__t=( _t('editor.layers.analysis-form.filter-aggregate') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],814:[function(require,module,exports){
var _ = require('underscore');
var DistanceConverter = require('../../../../../value-objects/distance-converter');

var DEFAULT_DISTANCE = 'meters';

module.exports = {
  type: 'buffer',
  label: _t('editor.layers.analysis-form.distance'),
  parametersDataFields: 'type,distance,radius,isolines,dissolved',

  parse: function (nodeAttrs) {
    var formAttrs = _.extend({}, nodeAttrs);

    try {
      formAttrs.radius = DistanceConverter.toDistance(nodeAttrs.radius, nodeAttrs.distance);
      formAttrs.distance = nodeAttrs.distance || DEFAULT_DISTANCE;
      formAttrs.dissolved = nodeAttrs.dissolved === undefined ? false : nodeAttrs.dissolved;
      formAttrs.isolines = nodeAttrs.isolines || 1;
    } catch (err) {
      formAttrs.radius = 100;
      formAttrs.isolines = 1;
      formAttrs.distance = DEFAULT_DISTANCE;
      formAttrs.dissolved = false;
    }

    return formAttrs;
  },

  formatAttrs: function (formAttrs) {
    return _.defaults(
      {
        radius: DistanceConverter.toMeters(formAttrs.radius, formAttrs.distance)
      },
      formAttrs
    );
  }
};

},{"../../../../../value-objects/distance-converter":1120,"underscore":"underscore"}],815:[function(require,module,exports){
var _ = require('underscore');
var BaseAnalysisFormModel = require('./base-analysis-form-model');
var template = require('./area-of-influence-form.tpl');
var DistanceConverter = require('../../../../../value-objects/distance-converter');

var AREA_OF_INFLUENCE_TYPES = require('./area-of-influence-types');
var TYPE_TO_META_MAP = {};
AREA_OF_INFLUENCE_TYPES.map(function (d) {
  TYPE_TO_META_MAP[d.type] = d;
});

module.exports = BaseAnalysisFormModel.extend({

  parse: function (attrs) {
    return _.defaults(
      _.pick(attrs, 'id', 'source'), // maintain default attrs
      this._typeDef(attrs.type).parse(attrs)
    );
  },

  initialize: function () {
    BaseAnalysisFormModel.prototype.initialize.apply(this, arguments);

    this._setSchema();

    this.on('change:type', this._onTypeChanged, this);
    this.on('change:distance', this._onDistanceChanged, this);
    this.on('change:kind', this._onKindChanged, this);
  },

  getTemplate: function () {
    return template;
  },

  getTemplateData: function () {
    return {parametersDataFields: this._typeDef().parametersDataFields};
  },

  /**
   * @override {BaseAnalysisFormModel.updateNodeDefinition}
   */
  updateNodeDefinition: function (nodeDefModel) {
    var attrs = this._formatAttrs(this.attributes);
    nodeDefModel.clear({silent: true});
    nodeDefModel.set(attrs);
  },

  _formatAttrs: function (formAttrs) {
    var customFormattedFormAttrs = this._typeDef().formatAttrs(formAttrs);
    return BaseAnalysisFormModel.prototype._formatAttrs.call(this, customFormattedFormAttrs);
  },

  /**
   * @override {BaseAnalysisFormModel._setSchema}
   */
  _setSchema: function () {
    BaseAnalysisFormModel.prototype._setSchema.call(this,
      this._filterSchemaFieldsByType({
        source: this._primarySourceSchemaItem(),
        type: {
          type: 'Radio',
          text: _t('editor.layers.analysis-form.type'),
          options: AREA_OF_INFLUENCE_TYPES.map(function (d) {
            var isAnalysisTypeEnabled = this._analyses.isAnalysisValidByType(d.type, this._configModel);
            var canChangeToType = this._canChangeToType(d.type);
            var isDisabled = !isAnalysisTypeEnabled || !canChangeToType;
            var helpMessage = !isAnalysisTypeEnabled ? _t('editor.layers.analysis-form.disabled-by-config') : _t('editor.layers.analysis-form.valid-type');

            return {
              val: d.type,
              label: d.label,
              disabled: isDisabled,
              help: isDisabled ? helpMessage : ''
            };
          }, this)
        },
        distance: {
          type: 'Radio',
          title: _t('editor.layers.analysis-form.units'),
          options: _.map(DistanceConverter.OPTIONS, function (d) {
            return {
              val: d.distance,
              label: this._distanceLabel(d.distance)
            };
          }, this)
        },
        radius: {
          type: 'Number',
          label: _t('editor.layers.analysis-form.radius'),
          validators: ['required', this._radiusInterval()]
        },
        kind: {
          type: 'Select',
          title: _t('editor.layers.analysis-form.by'),
          dialogMode: 'float',
          options: [
            {
              val: 'walk',
              label: _t('editor.layers.analysis-form.by-walk')
            }, {
              val: 'car',
              label: _t('editor.layers.analysis-form.by-car')
            }
          ]
        },
        isolines: {
          type: 'Number',
          title: _t('editor.layers.analysis-form.tracts'),
          help: _t('editor.layers.analysis-form.tracts-help'),
          validators: ['required', {
            type: 'interval',
            min: 1,
            max: 4
          }]
        },
        time: {
          type: 'Number',
          title: _t('editor.layers.analysis-form.time-seconds'),
          validators: ['required', this._timeInterval()]
        },
        dissolved: {
          type: 'Radio',
          title: _t('editor.layers.analysis-form.boundaries'),
          options: [
            {
              val: 'false',
              label: _t('editor.layers.analysis-form.intact'),
              help: _t('editor.layers.analysis-form.intact-help')
            }, {
              val: 'true',
              label: _t('editor.layers.analysis-form.dissolved'),
              help: _t('editor.layers.analysis-form.dissolved-help')
            }
          ]
        }
      })
    );
  },

  _canChangeToType: function (type) {
    if (type === this.get('type')) return true;

    var source = this._layerDefinitionModel.findAnalysisDefinitionNodeModel(this.get('source'));
    return source.isValidAsInputForType(type);
  },

  _filterSchemaFieldsByType: function (schema) {
    // Always include the source field in addition to the type-specific fields
    var fields = ['source'].concat(this._typeDef().parametersDataFields.split(','));
    return _.pick(schema, fields);
  },

  _onTypeChanged: function () {
    this._replaceAttrs();
    this._setSchema();
  },

  _onDistanceChanged: function () {
    this._fitParamToRange('radius', this._radiusInterval());
    this._setSchema();
  },

  _onKindChanged: function () {
    this._fitParamToRange('time', this._timeInterval());
    this._setSchema();
  },

  _fitParamToRange: function (paramName, range) {
    var val = this.get(paramName);
    if (val < range.min) {
      val = range.min;
    } else if (val > range.max) {
      val = range.max;
    }
    this.set(paramName, val, {silent: true});
  },

  _replaceAttrs: function () {
    var attrs = this.parse(this.attributes);
    this.clear({silent: true});
    this.set('type', attrs.type, {silent: true}); // re-set type to avoid change:type event to trigger again
    this.set(attrs);
  },

  _typeDef: function (type) {
    type = type || this.get('type');
    return TYPE_TO_META_MAP[type];
  },

  _radiusInterval: function () {
    switch (this.get('distance')) {
      case 'meters':
        return {
          type: 'interval',
          min: 10,
          max: 10000
        };
      case 'kilometers':
      case 'miles':
        return {
          type: 'interval',
          min: 0.5,
          max: 100,
          step: 0.5
        };
      default:
        return {
          type: 'interval',
          min: 1,
          max: 100
        };
    }
  },

  _timeInterval: function () {
    switch (this.get('kind')) {
      case 'car':
        return {
          type: 'interval',
          min: 60,
          max: 14400,
          step: 10
        };
      case 'walk':
      default:
        return {
          type: 'interval',
          min: 60,
          max: 3600
        };
    }
  },

  _distanceLabel: function (distance) {
    switch (distance) {
      case 'meters':
        return _t('editor.layers.analysis-form.meters');
      case 'kilometers':
        return _t('editor.layers.analysis-form.kilometers');
      case 'miles':
        return _t('editor.layers.analysis-form.miles');
      default:
        return '';
    }
  }

});

},{"../../../../../value-objects/distance-converter":1120,"./area-of-influence-form.tpl":816,"./area-of-influence-types":818,"./base-analysis-form-model":820,"underscore":"underscore"}],816:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('analyses.area-of-influence.title') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.reference-layer-pluralize', { smart_count: 1 }) ))==null?'':_.escape(__t))+
'</p>\n      <div class="u-tSpace-xl CDB-Text CDB-Fieldset">\n        <p class="CDB-Legend u-upperCase u-iBlock CDB-Text is-semibold CDB-Size-small u-rSpace--m">'+
((__t=( _t('editor.layers.analysis-form.input') ))==null?'':_.escape(__t))+
'</p>\n        <div class="Editor-formInput u-ellipsis" data-editors="source"></div>\n      </div>\n    </div>\n  </div>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">3</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="'+
((__t=( parametersDataFields ))==null?'':_.escape(__t))+
'">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.analysis-form.parameters') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--xl">'+
((__t=( _t('editor.layers.analysis-form.parameters-description') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],817:[function(require,module,exports){
module.exports = {
  type: 'trade-area',
  label: _t('editor.layers.analysis-form.time'),
  parametersDataFields: 'type,kind,time,isolines,dissolved',

  parse: function (nodeAttrs) {
    return {
      type: 'trade-area',
      kind: nodeAttrs.kind || 'walk',
      isolines: nodeAttrs.isolines || 1,
      time: nodeAttrs.time || 100,
      dissolved: nodeAttrs.dissolved === 'true' || nodeAttrs.dissolved === true
    };
  },

  formatAttrs: function (formAttrs) {
    return formAttrs;
  }
};

},{}],818:[function(require,module,exports){
module.exports = [
  require('./area-of-influence-buffer'),
  require('./area-of-influence-trade-area')
];

},{"./area-of-influence-buffer":814,"./area-of-influence-trade-area":817}],819:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='WITH dep_fns AS (\n    SELECT oid, proname, proargnames, proargtypes FROM pg_catalog.pg_proc WHERE proname ~* \'^dep_ext_\'\n),\nfns_argstypes AS (SELECT oid, array_agg((\n        SELECT\n        CASE\n            WHEN typcategory = \'A\' THEN \'array\'\n            WHEN typcategory = \'N\' THEN \'number\'\n            WHEN typcategory = \'S\' THEN \'string\'\n            WHEN typcategory = \'B\' THEN \'boolean\'\n        ELSE \'unknown\' END\n        FROM pg_catalog.pg_type\n        WHERE argtype = pg_catalog.pg_type.oid\n    )) as argtypes\n    FROM (\n        SELECT pg_proc.oid, unnest(pg_proc.proargtypes) as argtype\n        FROM pg_catalog.pg_proc, dep_fns\n        WHERE pg_proc.oid = dep_fns.oid\n    ) _q\n    group by oid\n),\nfns_meta AS (\n    SELECT\n        dep_fns.proname,\n        dep_fns.proargnames,\n        fns_argstypes.argtypes,\n        CASE WHEN fns_argstypes.argtypes[6] = \'array\' THEN\n            -- [whether it has a secondary node or not, where the extra parameters start, where to stop]\n            ARRAY[1,7,array_length(argtypes,1)]\n        ELSE\n            ARRAY[0,5,array_length(argtypes,1)]\n        END as p\n    FROM dep_fns, fns_argstypes\n    WHERE dep_fns.oid = fns_argstypes.oid\n)\nSELECT\n    proname as fn_name,\n    proargnames[p[2]:p[3]] as params_names,\n    argtypes[p[2]:p[3]] as params_types,\n    p[1]::boolean as has_secondary_node\nFROM fns_meta\n';
}
return __p;
};

},{"underscore":"underscore"}],820:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var camshaftReference = require('../../../../../data/camshaft-reference');
var layerColors = require('../../../../../data/layer-colors');

/**
 * Base model for all analysis form models.
 */
module.exports = Backbone.Model.extend({

  initialize: function (attrs, opts) {
    if (!opts.analyses) throw new Error('analyses is required');
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
    if (!opts.analysisSourceOptionsModel) throw new Error('analysisSourceOptionsModel is required');

    this._analyses = opts.analyses;
    this._configModel = opts.configModel;
    this._layerDefinitionModel = opts.layerDefinitionModel;
    this._analysisSourceOptionsModel = opts.analysisSourceOptionsModel;

    this.schema = {};
  },

  isNew: function () {
    return true; // so one can call .destroy() on it to clean up bindings etc. and have it removed from its collection
  },

  getTemplate: function () {
    return undefined; // override to return custom template
  },

  getTemplateData: function () {
    return undefined; // override to return custom template data
  },

  _getSourceOption: function () {
    var sourceNodeDefModel = this._layerDefinitionModel.findAnalysisDefinitionNodeModel(this.get('source'));
    return sourceNodeDefModel && [{
      val: sourceNodeDefModel.id,
      type: 'node',
      nodeTitle: this._analyses.title(sourceNodeDefModel),
      layerName: this._layerDefinitionModel.getName(),
      color: layerColors.getColorForLetter(sourceNodeDefModel.letter())
    }];
  },

  _primarySourceSchemaItem: function (customLabel) {
    return {
      type: 'NodeDataset',
      title: customLabel || _t('editor.layers.analysis-form.source'),
      dialogMode: 'float',
      options: this._getSourceOption(),
      editorAttrs: {disabled: true}
    };
  },

  setFormValidationErrors: function (errors) {
    this._formValidationErrors = errors;
    this.trigger('change', this);
  },

  validate: function () {
    var errors = _.extend(
      {},
      camshaftReference.validate(this.attributes),
      this._formValidationErrors
    );

    if (!_.isEmpty(errors)) {
      return errors;
    }
  },

  /**
   * @override {Backbone.Model.prototype.set} Maintain persisted attr if model is clear'ed
   */
  set: function (key, val, options) {
    if (key == null) return this;

    var attrs;
    if (typeof key === 'object') {
      attrs = key;
      options = val;
    } else {
      (attrs = {})[key] = val;
    }

    options || (options = {});

    var persisted = attrs.persisted || this.get('persisted');

    Backbone.Model.prototype.set.call(this, attrs, options);

    if (persisted !== undefined) {
      Backbone.Model.prototype.set.call(this, 'persisted', persisted, {silent: true});
    }

    return this;
  },

  updateNodeDefinition: function (nodeDefModel) {
    var nodeAttrs = this._formatAttrs(this.attributes);
    nodeDefModel.set(nodeAttrs);
  },

  /**
   * @deprecated use updateNodeDefinition instead
   */
  _updateNodeDefinition: function () {
    this.updateNodeDefinition.apply(this, arguments);
  },

  createNodeDefinition: function (userActions) {
    var nodeAttrs = this._formatAttrs(this.attributes);
    this.set('persisted', true);
    return userActions.createAnalysisNode(nodeAttrs, this._layerDefinitionModel);
  },

  _formatAttrs: function (formAttrs) {
    return _.omit(camshaftReference.parse(formAttrs), 'persisted');
  },

  _setSchema: function (schema) {
    this.schema = schema;
    this.trigger('changeSchema', this);
  },

  _isPrimarySource: function (sourceAttrName) {
    return sourceAttrName === this.get('primary_source_name');
  },

  _isFetchingOptions: function () {
    return this._analysisSourceOptionsModel.get('fetching');
  },

  _getSourceOptionsForSource: function (options) {
    options = options || {};
    var sourceAttrName = null;
    var requiredSimpleGeometryType = '*';
    var ignorePrimarySource = false;
    var includeSourceNode = options.includeSourceNode || false;

    // options validation and defaults
    if (options.sourceAttrName === void 0) {
      throw new Error('sourceAttrName is required.');
    } else {
      sourceAttrName = options.sourceAttrName;
    }

    if (options.requiredSimpleGeometryType !== void 0) {
      requiredSimpleGeometryType = options.requiredSimpleGeometryType;
    }

    if (options.ignorePrimarySource) {
      ignorePrimarySource = true;
    }

    var currentSource = this.get(sourceAttrName);

    if (!ignorePrimarySource && this._isPrimarySource(sourceAttrName)) {
      return [currentSource];
    }
    if (this._isFetchingOptions()) {
      return [{
        val: currentSource,
        label: _t('editor.layers.analysis-form.loading'),
        isLoading: true
      }];
    } else {
      // fetched
      var sourceId = this._layerDefinitionModel.get('source');
      return this._analysisSourceOptionsModel
        .getSelectOptions(requiredSimpleGeometryType)
        .filter(function (d) {
          return (
            (includeSourceNode ? true : d.val !== sourceId) &&
            (options.onlyNodes ? d.type === 'node' : true)
          );
        });
    }
  }
});

},{"../../../../../data/camshaft-reference":615,"../../../../../data/layer-colors":633,"backbone":"backbone","underscore":"underscore"}],821:[function(require,module,exports){
var _ = require('underscore');
var BaseAnalysisFormModel = require('./base-analysis-form-model');
var template = require('./centroid-form.tpl');
var ColumnOptions = require('../column-options');

var FORMAT_FIELD_NAMES = 'category_column,aggregation,aggregation_column,weight_column';
var PARAMETERS_DATA_FIELDS = 'source,category,weight';

/**
 * Form model for a centroid and weighted-centroid analysis
 * It has a rather complicated schema, that depends on several data points and state.
 * https://github.com/CartoDB/camshaft/blob/master/reference/versions/0.38.0/reference.json
 */

module.exports = BaseAnalysisFormModel.extend({
  parse: function (attrs) {
    var operator = {
      operator: attrs.aggregation || 'count',
      attribute: attrs.aggregation === 'count' ? '' : attrs.aggregation_column
    };

    var aggregate_value = (!!attrs.aggregation_column || !!attrs.aggregation) ? operator : '';

    return _.extend(attrs, {
      category: attrs.category_column || '',
      weight: attrs.weight_column || '',
      aggregate: aggregate_value
    });
  },

  initialize: function () {
    BaseAnalysisFormModel.prototype.initialize.apply(this, arguments);

    this._columnOptions = new ColumnOptions({}, {
      configModel: this._configModel,
      nodeDefModel: this._layerDefinitionModel.findAnalysisDefinitionNodeModel(this.get('source'))
    });

    this.listenTo(this._columnOptions, 'columnsFetched', this._setSchema);

    this.on('change:category', this._onChangeCategory, this);
    this.on('change:aggregate', this._updateAggregation, this);
    this.on('change:weight', this._onChangeWeight, this);
    this.on('change:type', this._setSchema, this);

    this._updateAggregation();

    this._setSchema();
  },

  updateNodeDefinition: function (nodeDefModel) {
    var attrs = this._formatAttrs(this.attributes);
    nodeDefModel.clear({silent: true});
    nodeDefModel.set(attrs);
  },

  _getFormatFieldNames: function () {
    var fields = FORMAT_FIELD_NAMES.split(',');

    if (this.get('aggregate') === '') {
      fields = _.difference(fields, ['aggregation', 'aggregation_column']);
    }

    return fields.join(',');
  },

  _formatAttrs: function (formAttrs) {
    var customFormattedFormAttrs = _.pick(formAttrs, ['id', 'source', 'type'].concat(this._getFormatFieldNames().split(',')));

    return BaseAnalysisFormModel.prototype._formatAttrs.call(this, customFormattedFormAttrs);
  },

  getTemplate: function () {
    return template;
  },

  getTemplateData: function () {
    return {
      parametersDataFields: PARAMETERS_DATA_FIELDS
    };
  },

  /*
  /**
   * @override {BaseAnalysisFormModel._setSchema}
   */
  _setSchema: function () {
    var operator = {
      operator: this.get('aggregation'),
      attribute: this.get('aggregation_column')
    };

    BaseAnalysisFormModel.prototype._setSchema.call(this, {
      source: this._primarySourceSchemaItem(),

      category: {
        type: 'EnablerEditor',
        title: '',
        label: _t('editor.layers.analysis-form.categorize-by'),
        help: _t('editor.layers.analysis-form.categorize-by-help'),
        editor: {
          type: 'Select',
          options: this._columnOptions.all(),
          dialogMode: 'float',
          label: _t('editor.layers.analysis-form.column')
        }
      },

      weight: {
        type: 'EnablerEditor',
        title: '',
        label: _t('editor.layers.analysis-form.weighted-by'),
        help: _t('editor.layers.analysis-form.weighted-by-help'),
        validators: ['required'],
        editor: {
          type: 'Select',
          options: this._columnOptions.filterByType('number'),
          dialogMode: 'float',
          label: _t('editor.layers.analysis-form.column')
        }
      },

      aggregate: {
        type: 'EnablerEditor',
        title: '',
        label: _t('editor.layers.analysis-form.aggregate-by'),
        help: _t('editor.layers.analysis-form.aggregate-by-help'),
        defaultValue: operator,
        editor: {
          type: 'Operators',
          options: this._columnOptions.filterByType('number'),
          dialogMode: 'float',
          label: _t('editor.layers.analysis-form.column')
        }
      }
    });
  },

  _onChangeWeight: function () {
    if (this.get('weight') !== '') {
      this.set('type', 'weighted-centroid');
      this.set('weight_column', this.get('weight'));
    } else {
      this.set('type', 'centroid');
      this.unset('weight_column');
    }
    this._setSchema();
  },

  _onChangeCategory: function () {
    // category_column is optional but if we send it empty,
    // it has influence in the final result
    if (this.get('category') === '') {
      this.unset('category_column');
    } else {
      this.set('category_column', this.get('category'));
    }
    this._setSchema();
  },

  _updateAggregation: function () {
    var aggregate = this.get('aggregate');
    if (aggregate === '') {
      this.set({
        aggregation: 'count',
        aggregation_column: ''
      });
    } else {
      this.set({
        aggregation_column: aggregate.attribute,
        aggregation: aggregate.operator
      });
    }

    this._setSchema();
  }
});

},{"../column-options":879,"./base-analysis-form-model":820,"./centroid-form.tpl":822,"underscore":"underscore"}],822:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="'+
((__t=( parametersDataFields ))==null?'':__t)+
'">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('analyses.centroid.title') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.input-layer') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">3</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="aggregate">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.analysis-form.value-aggregation') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--xl">'+
((__t=( _t('editor.layers.analysis-form.value-aggregation-centroids') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],823:[function(require,module,exports){
var BaseAnalysisFormModel = require('./base-analysis-form-model');
var ColumnOptions = require('../column-options');
var template = require('./closest-form.tpl');

var MAX_RESPONSES = 32;

module.exports = BaseAnalysisFormModel.extend({
  parse: function (attrs) {
    if (!attrs.responses) {
      attrs.responses = 1;
    }

    return attrs;
  },

  initialize: function () {
    BaseAnalysisFormModel.prototype.initialize.apply(this, arguments);

    this._resetColumnOptions();
    this._initBinds();
    this._setSchema();
    this._fetchColumns();
  },

  _initBinds: function () {
    this.listenTo(this._analysisSourceOptionsModel, 'change:fetching', this._onSourceOptionsFetched);
    this.on('change:target', this._onChangeTarget, this);
  },

  getTemplate: function () {
    return template;
  },

  getTemplateData: function () {
    return {};
  },

  _resetColumnOptions: function () {
    this._columnOptions = new ColumnOptions({}, {
      configModel: this._configModel
    });
    this.listenTo(this._columnOptions, 'columnsFetched', this._onColumnsFetched);
  },

  _onSourceOptionsFetched: function () {
    this._setSchema();
  },

  _setSchema: function () {
    BaseAnalysisFormModel.prototype._setSchema.call(this, {
      source: this._primarySourceSchemaItem(_t('editor.layers.analysis-form.find-nearest.input')),
      target: {
        type: 'NodeDataset',
        title: _t('editor.layers.analysis-form.find-nearest.target'),
        options: this._getSourceOptionsForSource({
          sourceAttrName: 'target',
          includeSourceNode: true
        }),
        dialogMode: 'float',
        validators: ['required'],
        editorAttrs: {
          disabled: this._isSourceDisabled('target')
        }
      },
      category: {
        type: 'EnablerEditor',
        title: '',
        label: _t('editor.layers.analysis-form.find-nearest.categorized'),
        help: _t('editor.layers.analysis-form.find-nearest.categorized-help'),
        editor: {
          type: 'Select',
          options: this._columnOptions.filterByType('string'),
          dialogMode: 'float',
          editorAttrs: {
            showLabel: false
          }
        }
      },
      responses: {
        type: 'Number',
        title: _t('editor.layers.analysis-form.find-nearest.max-results'),
        value: 1,
        validators: ['required', {
          type: 'interval',
          min: 1,
          max: MAX_RESPONSES
        }]
      }
    });
  },

  _isSourceDisabled: function (sourceAttrName) {
    return this._isPrimarySource(sourceAttrName) || this._isFetchingOptions();
  },

  _onChangeTarget: function () {
    this.set('category', '');
    this._setSchema();

    this._analysisSourceOptionsModel.createSourceNodeUnlessExisting(this.get('target'));
    this._fetchColumns();
  },

  _fetchColumns: function () {
    var target = this.get('target');

    var nodeDefModel = this._layerDefinitionModel.findAnalysisDefinitionNodeModel(target);

    if (nodeDefModel) {
      this._columnOptions.setNode(nodeDefModel);
    } else if (target) {
      this._columnOptions.setDataset(target);
    }
  },

  _onColumnsFetched: function () {
    this._setSchema();
  }
});

},{"../column-options":879,"./base-analysis-form-model":820,"./closest-form.tpl":824}],824:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="source,target">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.analysis-form.find-nearest.title') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.find-nearest.criteria') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">3</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="responses,category">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.analysis-form.find-nearest.define-params') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.find-nearest.define-params-desc') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],825:[function(require,module,exports){
var _ = require('underscore');
var BaseAnalysisFormModel = require('./base-analysis-form-model');
var template = require('./connect-with-lines.tpl');
var ColumnOptions = require('../column-options');

var CONNECT_WITH_LINES = require('./connect-with-lines-types');

var TYPE_TO_META_MAP = {};
CONNECT_WITH_LINES.map(function (d) {
  TYPE_TO_META_MAP[d.type] = d;
});

/**
 * Form model for a convex hull analysis
 */
module.exports = BaseAnalysisFormModel.extend({
  defaults: {
    closest: true,
    order_type: 'asc'
  },

  parse: function (attrs) {
    return _.defaults(
      _.pick(attrs, 'id', 'source'), // maintain default attrs
      this._typeDef(attrs.type).parse(attrs)
    );
  },

  validate: function () {
    var errors = BaseAnalysisFormModel.prototype.validate.apply(this, arguments);

    if (errors && errors.target_column) {
      if (!this._hasSecondGeometry()) {
        errors.target_column = _t('editor.layers.analysis-form.second-geom-required');
      }
    }

    return errors;
  },

  initialize: function () {
    BaseAnalysisFormModel.prototype.initialize.apply(this, arguments);

    this._columnOptions = new ColumnOptions({}, {
      configModel: this._configModel,
      nodeDefModel: this._layerDefinitionModel.findAnalysisDefinitionNodeModel(this.get('source'))
    });

    this._targetColumnOptions = new ColumnOptions({}, {
      configModel: this._configModel,
      nodeDefModel: this._layerDefinitionModel.findAnalysisDefinitionNodeModel(this.get('source'))
    });

    this.listenTo(this._columnOptions, 'columnsFetched', this._setSchema);
    this.listenTo(this._targetColumnOptions, 'columnsFetched', this._setSchema);
    this.listenTo(this._analysisSourceOptionsModel, 'change:fetching', this._setSchema);

    this.on('change:target', this._onChangeTarget, this);
    this.on('change:type', this._onTypeChanged, this);
    this.on('change:group', this._setSchema, this);

    this._setSchema();
    this._fetchColumns();
  },

  _onTypeChanged: function () {
    this._replaceAttrs();
    this._setSchema();
  },

  _replaceAttrs: function () {
    var attrs = this.parse(this.attributes);
    this.clear({ silent: true });
    this.set('type', attrs.type, { silent: true }); // re-set type to avoid change:type event to trigger again
    this.set(_.extend(attrs, this.defaults));
  },

  updateNodeDefinition: function (nodeDefModel) {
    var attrs = this._formatAttrs(this.attributes);
    nodeDefModel.clear({ silent: true });
    nodeDefModel.set(attrs);
  },

  _formatAttrs: function (formAttrs) {
    var customFormattedFormAttrs = this._typeDef().formatAttrs(formAttrs, this._columnOptions);
    return BaseAnalysisFormModel.prototype._formatAttrs.call(this, customFormattedFormAttrs);
  },

  getTemplate: function () {
    return template;
  },

  getTemplateData: function () {
    return {
      type: this.get('type'),
      group: this.get('group'),
      parametersDataFields: this._typeDef().parametersDataFields
    };
  },

  _filterSchemaFieldsByType: function (schema) {
    // Always include the source field in addition to the type-specific fields
    var fields = ['source', 'type'].concat(this._typeDef().parametersDataSchema.split(','));
    return _.pick(schema, fields);
  },

  /**
   * @override {BaseAnalysisFormModel._setSchema}
   */
  _setSchema: function () {
    BaseAnalysisFormModel.prototype._setSchema.call(this, this._filterSchemaFieldsByType({
      source: this._primarySourceSchemaItem(),
      type: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.type'),
        dialogMode: 'float',
        options: CONNECT_WITH_LINES.map(function (d) {
          return {
            val: d.type,
            label: d.label
          };
        }, this)
      },
      source_column: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.source'),
        dialogMode: 'float',
        options: this._getColumnOptions('source_column', ['string', 'number'])
      },
      target: {
        type: 'NodeDataset',
        title: _t('editor.layers.analysis-form.target'),
        options: this._getSourceOptionsForSource('target', 'point'),
        dialogMode: 'float',
        editorAttrs: {
          disabled: this._isSourceDisabled('target')
        },
        validators: ['required']
      },
      target_column: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.target-column'),
        dialogMode: 'float',
        options: this._getColumnOptionsForTarget()
      },
      target_source_column: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.target-column'),
        options: this._getTargetSourceColumnOptions('target_source_column'),
        dialogMode: 'float',
        editorAttrs: {
          disabled: this._isTargetColumnDisabled()
        }
      },
      destination_longitude: {
        type: 'Text',
        title: _t('editor.layers.analysis-form.longitude'),
        validators: ['required'],
        editorAttrs: {
          placeholder: _t('editor.layers.analysis-form.enter-longitude')
        }
      },
      destination_latitude: {
        type: 'Text',
        title: _t('editor.layers.analysis-form.latitude'),
        validators: ['required'],
        editorAttrs: {
          placeholder: _t('editor.layers.analysis-form.enter-latitude')
        }
      },
      closest: {
        type: 'Radio',
        title: 'closest',
        options: [
          { label: _t('editor.layers.analysis-form.to-closest'), val: 'true' },
          { label: _t('editor.layers.analysis-form.all-to-all'), val: 'false' }
        ]
      },
      group: {
        type: 'Enabler',
        label: _t('editor.layers.analysis-form.group-by'),
        title: '',
        editorAttrs: {
          reversed: true
        }
      },
      category_column: {
        type: 'EnablerEditor',
        title: '',
        label: _t('editor.layers.analysis-form.group-by'),
        editor: {
          type: 'Select',
          options: this._columnOptions.all(),
          dialogMode: 'float',
          editorAttrs: {
            showLabel: false
          }
        }
      },
      order_column: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.order-by'),
        options: this._columnOptions.filterByType(['date', 'number']),
        dialogMode: 'float',
        validators: ['required']
      },
      order_type: {
        type: 'Radio',
        title: _t('editor.layers.analysis-form.order'),
        options: [
          { label: _t('editor.layers.analysis-form.asc'), val: 'asc' },
          { label: _t('editor.layers.analysis-form.desc'), val: 'desc' }
        ]
      }
    }));
  },

  _onChangeTarget: function () {
    this.set('target_source_column', '');
    this._analysisSourceOptionsModel.createSourceNodeUnlessExisting(this.get('target'));
    this._fetchColumns();
  },

  _fetchColumns: function () {
    var target = this.get('target');
    var nodeDefModel = this._layerDefinitionModel.findAnalysisDefinitionNodeModel(target);

    if (nodeDefModel) {
      this._targetColumnOptions.setNode(nodeDefModel);
    } else if (target) {
      this._targetColumnOptions.setDataset(target);
    }
  },

  _getColumnOptionsForTarget: function () {
    var columns = this._getColumnOptions('target_column', 'geometry');

    return _.reject(columns, function (column) {
      return (column.val === 'the_geom' || column.val === 'the_geom_webmercator');
    }, this);
  },

  _getColumnOptions: function (attr, attrType) {
    var opts = this._columnOptions.filterByType(attrType);

    if (this._columnOptions.get('columnsFetched') && this.get(attr)) {
      var attrExists = false;
      var value = this.get(attr);

      var customValue = {
        val: value,
        label: '"' + value + '"'
      };

      if (opts && opts.length) {
        attrExists = _.find(opts, function (attr) {
          return attr.val === customValue.val;
        });
      }

      if (!attrExists) {
        opts.push(customValue);
        opts = _.sortBy(opts, function (d) {
          return d.val;
        });
      }
    }

    return opts;
  },

  _getTargetSourceColumnOptions: function (attr) {
    var opts = this._targetColumnOptions.all();

    if (this._targetColumnOptions.get('columnsFetched') && this.get(attr)) {
      var attrExists = false;
      var value = this.get(attr);

      var customValue = {
        val: value,
        label: '"' + value + '"'
      };

      if (opts && opts.length) {
        attrExists = _.find(opts, function (attr) {
          return attr.val === customValue.val;
        });
      }

      if (!attrExists) {
        opts.push(customValue);
        opts = _.sortBy(opts, function (d) {
          return d.val;
        });
      }
    }
    return opts;
  },

  _typeDef: function (type) {
    type = type || this.get('type');
    return TYPE_TO_META_MAP[type];
  },

  _getSourceOptionsForSource: function (sourceAttrName, requiredSimpleGeometryType) {
    var currentSource = this.get(sourceAttrName);

    if (this._isFetchingOptions()) {
      return [{
        val: currentSource,
        label: _t('editor.layers.analysis-form.loading'),
        isLoading: true
      }];
    } else {
      // fetched
      var source = this._getSourceOption()[0];
      return this._analysisSourceOptionsModel
      .getSelectOptions(requiredSimpleGeometryType)
      .filter(function (d) {
        return d.val !== source.val && d.val !== source.layerName;
      });
    }
  },

  _hasSecondGeometry: function () {
    return this._getColumnOptionsForTarget().length;
  },

  _isTargetColumnDisabled: function () {
    return !this._targetColumnOptions.get('columnsFetched');
  },

  _isSourceDisabled: function (sourceAttrName) {
    return this._isPrimarySource(sourceAttrName) || this._isFetchingOptions();
  }
});

},{"../column-options":879,"./base-analysis-form-model":820,"./connect-with-lines-types":826,"./connect-with-lines.tpl":827,"underscore":"underscore"}],826:[function(require,module,exports){
module.exports = [
  require('./connect-with-lines/line-to-single-point'),
  require('./connect-with-lines/line-to-column'),
  require('./connect-with-lines/line-source-to-target'),
  require('./connect-with-lines/line-sequential')
];

},{"./connect-with-lines/line-sequential":828,"./connect-with-lines/line-source-to-target":829,"./connect-with-lines/line-to-column":830,"./connect-with-lines/line-to-single-point":831}],827:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form>\n  <div class="Editor-HeaderInfo Editor-HeaderInfo--noMargin">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">3</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="'+
((__t=( parametersDataFields ))==null?'':__t)+
'">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('analyses.connect-with-lines.title') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--xl">'+
((__t=( _t('editor.layers.analysis-form.define-reference-and-target') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n\n  ';
 if (type == 'line-sequential') { 
__p+='\n    <div class="Editor-HeaderInfo">\n      <div class="Editor-HeaderPad u-rSpace--m"></div>\n        <div class="Editor-checker" data-fields="category_column"></div>\n      </div>\n    </div>\n  ';
 } 
__p+='\n\n  ';
 if (type == 'line-source-to-target') { 
__p+='\n    <div class="Editor-HeaderInfo">\n      <div class="Editor-HeaderPad u-rSpace--m"></div>\n      <div class="Editor-HeaderInfo-inner CDB-Text">\n\n        <div class="Editor-checker Editor-checker--slim u-flex u-alignCenter" data-fields="group"></div>\n\n        ';
 if (group) { 
__p+='\n          <div class="Editor-formInner--nested">\n            <div class="CDB-Text Editor-formInner Editor-formInner--noMargin">\n              <p class="CDB-Legend u-upperCase u-iBlock CDB-Text is-semibold CDB-Size-small u-rSpace--m">'+
((__t=( _t('editor.layers.analysis-form.source-col') ))==null?'':_.escape(__t))+
'</p>\n              <div class="Editor-formInput" data-editors="source_column"></div>\n            </div>\n\n            <div class="CDB-Text Editor-formInner">\n              <p class="CDB-Legend u-upperCase u-iBlock CDB-Text is-semibold CDB-Size-small u-rSpace--m">'+
((__t=( _t('editor.layers.analysis-form.target-col') ))==null?'':_.escape(__t))+
'</p>\n              <div class="Editor-formInput" data-editors="target_source_column"></div>\n            </div>\n          </div>\n        ';
 } 
__p+='\n      </div>\n    </div>\n  ';
 } 
__p+='\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],828:[function(require,module,exports){
var _ = require('underscore');

module.exports = {
  type: 'line-sequential',
  label: _t('editor.layers.analysis-form.line-sequential'),
  parametersDataFields: 'source,type,order_column,order_type',
  parametersDataSchema: 'order_column,order_type,category_column',

  parse: function (nodeAttrs) {
    return {
      type: 'line-sequential',
      order_column: nodeAttrs.order_column,
      category_column: nodeAttrs.category_column,
      order_type: nodeAttrs.order_type
    };
  },

  formatAttrs: function (formAttrs, columnOptions) {
    if (!formAttrs.category_column) {
      formAttrs = _.omit(formAttrs, 'category_column');
    }
    return formAttrs;
  }
};

},{"underscore":"underscore"}],829:[function(require,module,exports){
var _ = require('underscore');

module.exports = {
  type: 'line-source-to-target',
  label: _t('editor.layers.analysis-form.line-source-to-target'),
  parametersDataFields: 'source,type,target,closest',
  parametersDataSchema: 'target,closest,group,source_column,target_source_column',

  parse: function (nodeAttrs) {
    return {
      type: 'line-source-to-target',
      target: nodeAttrs.target,
      closest: nodeAttrs.closest,
      source_column: nodeAttrs.source_column,
      group: nodeAttrs.target_column && nodeAttrs.source_column,
      target_source_column: nodeAttrs.target_column
    };
  },

  formatAttrs: function (formAttrs, columnOptions) {
    formAttrs.target_column = formAttrs.target_source_column;

    if (!formAttrs.group) {
      formAttrs = _.omit(formAttrs, ['source_column', 'target_column']);
    }

    formAttrs = _.omit(formAttrs, ['target_source_column', 'group']);
    return formAttrs;
  }
};

},{"underscore":"underscore"}],830:[function(require,module,exports){
module.exports = {
  type: 'line-to-column',
  label: _t('editor.layers.analysis-form.line-to-column'),

  parametersDataFields: 'source,type,target_column',
  parametersDataSchema: 'target_column',

  parse: function (nodeAttrs, options) {
    return {
      type: 'line-to-column',
      target_column: nodeAttrs.target_column
    };
  },

  formatAttrs: function (formAttrs, columnOptions) {
    return formAttrs;
  }
};

},{}],831:[function(require,module,exports){
module.exports = {
  type: 'line-to-single-point',
  label: _t('editor.layers.analysis-form.line-to-single-point'),

  parametersDataFields: 'source,type,destination_longitude,destination_latitude',
  parametersDataSchema: 'destination_longitude,destination_latitude',

  parse: function (nodeAttrs) {
    return {
      type: 'line-to-single-point',
      destination_longitude: nodeAttrs.destination_longitude,
      destination_latitude: nodeAttrs.destination_latitude
    };
  },

  formatAttrs: function (formAttrs, columnOptions) {
    return formAttrs;
  }
};

},{}],832:[function(require,module,exports){
var BaseAnalysisFormModel = require('./base-analysis-form-model');
var template = require('./data-observatory-measure.tpl');
var DataObservartoryMetadata = require('../data-observatory-metadata');
var Utils = require('../../../../../helpers/utils');

module.exports = BaseAnalysisFormModel.extend({
  initialize: function () {
    BaseAnalysisFormModel.prototype.initialize.apply(this, arguments);

    this.nodeDefModel = this._layerDefinitionModel.findAnalysisDefinitionNodeModel(this.get('source'));

    this.doMetadata = new DataObservartoryMetadata(null, {
      configModel: this._configModel,
      geometryType: null
    });

    // check if the geometry type is available, if not wait until it's finished
    if (this.nodeDefModel.queryGeometryModel.isFetched()) {
      this._fetchDOMetadata();
    } else {
      this.nodeDefModel.queryGeometryModel.once('change:status', this._fetchDOMetadata, this);
    }
    this._setSchema();
  },

  _formatAttrs: function (formAttrs) {
    formAttrs.final_column = Utils.sanitizeString(formAttrs.final_column);
    return BaseAnalysisFormModel.prototype._formatAttrs.call(this, formAttrs);
  },

  _fetchDOMetadata: function () {
    var simpleGeometryType = this.nodeDefModel.queryGeometryModel.get('simple_geom') || 'point';
    this.doMetadata.setGeometryType(simpleGeometryType);
    this.listenTo(this.doMetadata, 'sync', this._setSchema);
    this.on('change:area', this._areaChanged, this);
    this.on('change:measurement', this._measurementChanged, this);
    this.on('change:segments', this._setSegment, this);
    this.doMetadata.fetch();
  },

  _areaChanged: function () {
    this.set({ measurement: '', segments: '' }, { silent: true });
    this._setSchema();
  },

  _measurementChanged: function () {
    this.set({ segments: '' }, { silent: true });
    this._setSchema();
  },

  _normalizeSegment: function (s) {
    return s.replace(/\./g, '_', /\-/g, '_');
  },

  _setSegment: function () {
    var s = this.doMetadata.segment(this.get('area'), this.get('measurement'), this.get('segments'));
    if (s) {
      this.set('segment_name', s);
    }
  },

  getTemplate: function () {
    return template;
  },

  /**
   * @override {BaseAnalysisFormModel._setSchema}
   */
  _setSchema: function () {
    var areas = this.doMetadata.areas();
    var schema = {
      source: this._primarySourceSchemaItem(),
      area: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.data-observatory-measurement-area'),
        // remove Global for the moment since it only includes Boundaries
        options: areas.length === 0 ? _t('editor.layers.analysis-form.loading') : areas.filter(function (f) { return f !== 'Global'; }).sort(),
        dialogMode: 'float',
        editorAttrs: {
          disabled: areas.length === 0
        }
      },
      final_column: {
        title: _t('editor.layers.analysis-form.data-observatory-measurement-column'),
        type: 'Text',
        help: _t('editor.layers.analysis-form.data-observatory-measurement-column-help'),
        validators: ['required']
      },
      measurement: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.data-observatory-measurement-measurement'),
        options: this.doMetadata.measurement(this.get('area')).sort(),
        dialogMode: 'float'
      },
      segments: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.data-observatory-measurement-segments'),
        options: this.doMetadata.columns(this.get('area'), this.get('measurement')).sort(),
        dialogMode: 'float'
      }
    };

    BaseAnalysisFormModel.prototype._setSchema.call(this, schema);
  }

});

},{"../../../../../helpers/utils":1102,"../data-observatory-metadata":880,"./base-analysis-form-model":820,"./data-observatory-measure.tpl":833}],833:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="source,final_column">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('analyses.data-observatory-measure.title') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.data-observatory-measurement-desc') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">3</div>\n        <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="area,measurement,segments">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.analysis-form.parameters') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.data-observatory-measurement-refine') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],834:[function(require,module,exports){
var _ = require('underscore');
var cdb = require('cartodb.js');
var BaseAnalysisFormModel = require('./base-analysis-form-model');
var checkAndBuildOpts = require('../../../../../helpers/required-opts');
var availableFunctionsQuery = require('./available-functions.tpl');
var template = require('./deprecated-sql-function.tpl');
var track = require('../../../../../helpers/errorTracking.js');

var REQUIRED_OPTS = [
  'configModel'
];

module.exports = BaseAnalysisFormModel.extend({
  initialize: function (attrs, opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this._SQL = new cdb.SQL({
      user: this._configModel.get('user_name'),
      sql_api_template: this._configModel.get('sql_api_template'),
      api_key: this._configModel.get('api_key')
    });

    BaseAnalysisFormModel.prototype.initialize.apply(this, arguments);

    this.set('fetchStatus', 'unfetched');
    this._functionsInfo = [];

    this._setSchema();
    this._initBinds();
    this._fetchAvailableFunctions();
  },

  _initBinds: function () {
    this.listenTo(this, 'change:fetchStatus', this._onFetchStatusChanged);
    this.listenTo(this, 'change:function_name', this._onFunctionSelected);
    this.listenTo(this._analysisSourceOptionsModel, 'change:fetching', this._onSourceOptionsFetched);
  },

  validate: function (attrs, options) {
    this.set('primary_source', this.get('source'));
    this._serializeFunctionArgs();

    return BaseAnalysisFormModel.prototype.validate.call(this, attrs, options);
  },

  getTemplate: function () {
    return template;
  },

  getTemplateData: function () {
    var fields = [];
    var data = {
      fields: ''
    };
    var selectedFunction = this._getSelectedFunction();
    if (selectedFunction) {
      if (selectedFunction.hasSecondaryNode) {
        fields.push('secondary_source');
      }

      _.reduce(selectedFunction.params, function (memo, value, key) {
        memo.push(key);
        return memo;
      }, fields, this);
    }
    data.fields = fields.join(',');

    return data;
  },

  _buildSchema: function () {
    var schema = {};
    var selectedFunction = this._getSelectedFunction();

    // Source
    schema.source = this._primarySourceSchemaItem(_t('editor.layers.analysis-form.deprecated-sql-function.input'));

    // Function
    schema.function_name = {
      type: 'Select',
      title: _t('editor.layers.analysis-form.deprecated-sql-function.function'),
      options: this._parseFunctionOptions(),
      dialogMode: 'float',
      editorAttrs: this._getSelectFunctionAttrs()
    };

    if (selectedFunction) {
      if (selectedFunction.hasSecondaryNode) {
        schema.secondary_source = {
          type: 'NodeDataset',
          title: _t('editor.layers.analysis-form.deprecated-sql-function.target'),
          options: this._getSourceOptionsForSource({
            sourceAttrName: 'secondary_source'
          }),
          dialogMode: 'float',
          editorAttrs: {
            disabled: this._isSourceDisabled('secondary_source')
          },
          validators: ['required']
        };
      }

      _.each(selectedFunction.params, function (value, key) {
        this._addParamToSchema(key, selectedFunction.params[key], schema);
      }, this);
    }

    return schema;
  },

  _setSchema: function () {
    BaseAnalysisFormModel.prototype._setSchema.call(this, this._buildSchema());
  },

  _addParamToSchema: function (key, type, schema) {
    var item = null;
    var initialValue = null;

    switch (type) {
      case 'string': {
        item = {
          type: 'Text',
          title: key,
          validators: ['required']
        };
        initialValue = '';
        break;
      }
      case 'number': {
        item = {
          type: 'Number',
          title: key,
          showSlider: false,
          validators: ['required']
        };
        initialValue = 0;
        break;
      }
      case 'boolean': {
        item = {
          type: 'Radio',
          title: key,
          options: [
            {val: 'true', label: 'true'},
            {val: 'false', label: 'false'}
          ]
        };
        initialValue = true;
        break;
      }
    }
    if (item) {
      schema[key] = item;
      if (!this.has(key)) {
        this.set(key, initialValue);
      }
    }
  },

  _onSourceOptionsFetched: function () {
    this._setSchema();
  },

  _onFetchStatusChanged: function () {
    this._setSchema();
  },

  _onFunctionSelected: function () {
    this._setSchema();
  },

  _getSelectedFunction: function () {
    var functionName = this.get('function_name');
    if (functionName) {
      return _.first(_.filter(this._functionsInfo, function (info) {
        return info.functionName === functionName;
      }, this));
    }
    return null;
  },

  _fetchAvailableFunctions: function () {
    var query = availableFunctionsQuery();
    this.set('fetchStatus', 'fetching');

    this._SQL.execute(query, null, {
      success: function (metadata) {
        this._functionsInfo = this._parseFunctionsMetadata(metadata);
        this.set('fetchStatus', 'fetched');
      }.bind(this),
      error: function (errors) {
        this.set('fetchStatus', 'error');
        if (errors && errors.responseJSON) {
          track(errors.responseJSON);
        }
      }.bind(this)
    });
  },

  _parseFunctionsMetadata: function (metadata) {
    if (!metadata || !metadata.rows) {
      return [];
    }

    return _.map(metadata.rows, function (data) {
      var info = {};
      info.functionName = this._capitalizeFunctionName(data.fn_name);
      info.hasSecondaryNode = data.has_secondary_node;
      info.params = {};
      for (var i = 0; i < data.params_names.length; i++) {
        info.params[data.params_names[i]] = data.params_types[i];
      }
      return info;
    }, this);
  },

  _capitalizeFunctionName: function (name) {
    var depExtRegex = /^dep_ext/i;
    return name && name.replace(depExtRegex, 'DEP_EXT');
  },

  _getSelectFunctionAttrs: function () {
    var fetchStatus = this.get('fetchStatus');
    var status = {
      disabled: true
    };

    switch (fetchStatus) {
      case 'unfetched':
        break;
      case 'fetching':
        status = {
          disabled: true,
          loading: true
        };
        break;
      case 'fetched': {
        status = {};
        if (this._functionsInfo.length > 0) {
          status.placeholder = _t('editor.layers.analysis-form.deprecated-sql-function.choose-function-small');
        }
        break;
      }
      case 'error': {
        status = {
          disabled: true,
          placeholder: 'error'
        };
        break;
      }
    }

    return status;
  },

  _parseFunctionOptions: function () {
    return _.map(this._functionsInfo, function (info) {
      return {
        val: info.functionName,
        label: info.functionName
      };
    }, this);
  },

  _serializeFunctionArgs: function () {
    var values = [];
    var selectedFunction = this._getSelectedFunction();
    if (selectedFunction) {
      values = _.reduce(selectedFunction.params, function (memo, value, key) {
        memo.push(this.get(key));
        return memo;
      }, [], this);

      this.set('function_args', values);
    }
  },

  _isPrimarySource: function (sourceAttrName) {
    return sourceAttrName === this.get('source');
  },

  _isSourceDisabled: function (sourceAttrName) {
    return this._isPrimarySource(sourceAttrName) || this._isFetchingOptions();
  }
});

},{"../../../../../helpers/errorTracking.js":1091,"../../../../../helpers/required-opts":1097,"./available-functions.tpl":819,"./base-analysis-form-model":820,"./deprecated-sql-function.tpl":835,"cartodb.js":"cartodb.js","underscore":"underscore"}],835:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="source,function_name">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.analysis-form.deprecated-sql-function.title') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.deprecated-sql-function.choose-function') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n\n  ';
 if (fields) { 
__p+='\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">3</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="'+
((__t=( fields ))==null?'':__t)+
'">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.analysis-form.deprecated-sql-function.params') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.deprecated-sql-function.define-params') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n  ';
 } 
__p+='\n\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],836:[function(require,module,exports){
var _ = require('underscore');
var camshaftReference = require('../../../../../data/camshaft-reference');
var BaseAnalysisFormModel = require('./base-analysis-form-model');

var ARRAY_SPLIT_COMBO = ',';

/**
 * A fallback form model in case the type is not supported (yet).
 */
module.exports = BaseAnalysisFormModel.extend({

  initialize: function () {
    BaseAnalysisFormModel.prototype.initialize.apply(this, arguments);

    this.listenTo(this._analysisSourceOptionsModel, 'change:fetching', this._updateSchema);

    this._updateSchema();
  },

  getTemplate: function () {
    return undefined;
  },

  getTemplateData: function () {
    return {};
  },

  /**
   * @override {BaseAnalysisFormModel._formatAttrs}
   */
  _formatAttrs: function () {
    var attrs = BaseAnalysisFormModel.prototype._formatAttrs.apply(this, arguments);

    var params = camshaftReference.paramsForType(this.get('type'));
    for (var name in params) {
      var param = params[name];
      if (param.type === 'array') {
        if (!_.isString(attrs[name]) || attrs[name].trim() === '') {
          attrs[name] = null;
        } else {
          attrs[name] = attrs[name]
            .split(ARRAY_SPLIT_COMBO)
            .map(function (val) {
              return val.trim();
            });
        }
      }
    }

    return attrs;
  },

  _updateSchema: function () {
    var schema = {
      type: {
        type: 'Text',
        title: 'Type',
        editorAttrs: {disabled: true}
      }
    };
    var params = camshaftReference.paramsForType(this.get('type'));

    var sourceCount = _.reduce(Object.keys(params), function (memo, name) {
      if (params[name].type === 'node') {
        memo++;
      }
      return memo;
    }, 0);

    Object.keys(params)
      .forEach(function (name) {
        var param = params[name];
        var label = name + ' (' + param.type + ')';
        var validators = [];
        var isRequired = !param.optional;

        if (isRequired) {
          label += '*';
          validators.push('required');
        }

        switch (param.type) {
          case 'node':
            schema[name] = sourceCount === 1
              ? {
                type: 'Select',
                text: label,
                options: [ this.get('source') ],
                dialogMode: 'float',
                editorAttrs: { disabled: true }
              }
              : {
                type: 'Select',
                dialogMode: 'float',
                title: label,
                options: this._getSourceOptionsForSource({
                  sourceAttrName: 'target',
                  ignorePrimarySource: true
                })
              };
            break;
          case 'string':
            var fieldDef;

            // If is meant to represent a column try to get columns if possible
            if (/column/.test(name) && sourceCount === 1) {
              var nodeDefModel = this._layerDefinitionModel.findAnalysisDefinitionNodeModel(this.get('source'));
              if (nodeDefModel && nodeDefModel.querySchemaModel.columnsCollection.length > 0) {
                fieldDef = {
                  type: 'Text',
                  title: label,
                  validators: validators
                };
              }
            }

            if (!fieldDef) {
              fieldDef = {
                type: 'Text',
                title: label,
                validators: validators
              };
            }

            schema[name] = fieldDef;
            break;
          case 'enum':
            schema[name] = {
              type: 'Select',
              title: label,
              options: param.values.map(function (val) {
                return {
                  val: val,
                  label: val
                };
              }),
              dialogMode: 'float',
              validators: validators
            };
            break;
          case 'number':
            schema[name] = {
              type: 'Text',
              label: label,
              validators: validators
            };
            break;
          case 'boolean':
            schema[name] = {
              type: 'Radio',
              text: label,
              options: [
                {val: 'true', label: 'true'},
                {val: 'false', label: 'false'}
              ],
              validators: validators
            };
            break;
          case 'array':
            schema[name] = {
              type: 'Text',
              title: label,
              validators: validators,
              help: 'Separate values by "' + ARRAY_SPLIT_COMBO + '"'
            };
            break;
          default:
            return null;
        }
      }, this);

    this._setSchema(schema);
  }
});

},{"../../../../../data/camshaft-reference":615,"./base-analysis-form-model":820,"underscore":"underscore"}],837:[function(require,module,exports){
var BaseAnalysisFormModel = require('./base-analysis-form-model');
var template = require('./filter-by-node-column.tpl');
var ColumnOptions = require('../column-options');

/**
 * Form model for a centroid and weighted-centroid analysis
 * It has a rather complicated schema, that depends on several data points and state.
 */
module.exports = BaseAnalysisFormModel.extend({
  initialize: function () {
    BaseAnalysisFormModel.prototype.initialize.apply(this, arguments);

    var nodeDefModel = this._layerDefinitionModel.findAnalysisDefinitionNodeModel(this.get('source'));
    this._columnOptions = new ColumnOptions({}, {
      configModel: this._configModel,
      nodeDefModel: nodeDefModel
    });

    this._filterColumnOptions = new ColumnOptions({}, {
      configModel: this._configModel
    });

    this.listenTo(this._columnOptions, 'columnsFetched', this._setSchema);
    this.listenTo(this._filterColumnOptions, 'columnsFetched', this._setSchema);
    this.listenTo(this._analysisSourceOptionsModel, 'change:fetching', this._setSchema);
    this.on('change:filter_source', this._onFilterSourceChange, this);
    this._onFilterSourceChange();
    this._setSchema();
  },

  _onFilterSourceChange: function () {
    var nodeDefModel = this._layerDefinitionModel.findAnalysisDefinitionNodeModel(this.get('filter_source'));
    if (nodeDefModel) {
      this._filterColumnOptions.setNode(nodeDefModel);
      this._setSchema();
    }
  },

  getTemplate: function () {
    return template;
  },

  /**
   * @override {BaseAnalysisFormModel._setSchema}
   */
  _setSchema: function () {
    var schema = {
      source: this._primarySourceSchemaItem(),
      filter_source: {
        type: 'NodeDataset',
        title: _t('editor.layers.analysis-form.linked-layer'),
        dialogMode: 'float',
        editorAttrs: {
          disabled: this._isFetchingOptions()
        },
        options: this._getSourceOptionsForSource({
          sourceAttrName: 'filter_source',
          ignorePrimarySource: true,
          onlyNodes: true
        })
      },
      column: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.source-column'),
        dialogMode: 'float',
        options: this._columnOptions.all()
      },
      filter_column: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.filter-column'),
        dialogMode: 'float',
        validators: ['required', this._validateFilterColumn.bind(this)],
        options: this._filterColumnOptions.all()
      }
    };

    BaseAnalysisFormModel.prototype._setSchema.call(this, schema);
  },

  _validateFilterColumn: function (value, formValues) {
    var filterColumnValue = formValues.filter_column;
    var columnValue = formValues.column;

    // if we don't have both fields we don't validate
    if (filterColumnValue === void 0 || columnValue === void 0) return null;

    var error = {
      message: _t('editor.layers.analysis-form.should-match')
    };

    var filterColumn = this._filterColumnOptions.findColumn(filterColumnValue);
    var filterColumnType = filterColumn && filterColumn.type;

    var column = this._columnOptions.findColumn(columnValue);
    var columnType = column && column.type;

    if (filterColumnType === columnType) {
      return null; // types match
    }

    return error;
  }
});

},{"../column-options":879,"./base-analysis-form-model":820,"./filter-by-node-column.tpl":838}],838:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="source,filter_source">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('analyses.filter-by-node-column.title') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.link-layer-desc') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">3</div>\n        <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="column,filter_column">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.analysis-form.key-columns') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--xl">'+
((__t=( _t('editor.layers.analysis-form.key-columns-desc') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n</form>\n\n';
}
return __p;
};

},{"underscore":"underscore"}],839:[function(require,module,exports){
var _ = require('underscore');

var PARAMS_FOR_IS_EQUAL = 'kind,text';

module.exports = {
  type: 'filter-category',
  label: 'Filter category',
  parametersDataFields: 'text,accept_reject',
  filterDataFields: 'accept,reject',

  parse: function (nodeAttrs) {
    var formAttrs = _.extend({}, nodeAttrs);

    formAttrs.type = 'filter-category';
    formAttrs.column = nodeAttrs.column || '';

    if (nodeAttrs.accept) {
      formAttrs.text = nodeAttrs.accept.join(',');
    } else if (nodeAttrs.reject) {
      formAttrs.text = nodeAttrs.reject.join(',');
    }

    formAttrs.accept_reject = (nodeAttrs.accept || !(nodeAttrs.accept || nodeAttrs.reject)) ? 'accept' : 'reject';

    return formAttrs;
  },

  formatAttrs: function (formAttrs) {
    var attrs = ['id', 'type', 'source', 'column'];
    var isFromIsEqualToKind = formAttrs.kind === 'is-equal-to';
    var text;

    if (isFromIsEqualToKind) {
      text = [+formAttrs.text];
    } else if (formAttrs.text) {
      text = formAttrs.text.split(',');
    }

    if (formAttrs.accept_reject === 'accept' || isFromIsEqualToKind) {
      formAttrs.accept = text;
    } else if (formAttrs.accept_reject === 'reject') {
      formAttrs.reject = text;
    }

    if (isFromIsEqualToKind) {
      return _.pick(formAttrs, attrs.concat(['kind', 'accept']));
    } else {
      return _.pick(formAttrs, attrs.concat(formAttrs.accept_reject));
    }
  },

  getParameters: function (kind) {
    var params = this.parametersDataFields;

    if (kind === 'is-equal-to') {
      params = PARAMS_FOR_IS_EQUAL;
    }

    return params;
  }
};

},{"underscore":"underscore"}],840:[function(require,module,exports){
var _ = require('underscore');
var BaseAnalysisFormModel = require('./base-analysis-form-model');
var template = require('./filter-form.tpl');
var ColumnData = require('../column-data');
var ColumnRowData = require('../../../../../data/column-row-data');
var ColumnOptions = require('../column-options');

var FILTER_TYPES = require('./filter-types');
var TYPE_TO_META_MAP = {};

FILTER_TYPES.map(function (d) {
  TYPE_TO_META_MAP[d.type] = d;
});

var FILTER_RANGE_KINDS = [
  { val: 'between', label: _t('editor.layers.filter-options.between') },
  { val: 'is-equal-to', label: _t('editor.layers.filter-options.is-equal-to') },
  { val: 'is-greater-than', label: _t('editor.layers.filter-options.is-greater-than') },
  { val: 'is-less-than', label: _t('editor.layers.filter-options.is-less-than') }
];

var LESS_GREATER_KINDS = ['is-greater-than', 'is-less-than'];

module.exports = BaseAnalysisFormModel.extend({

  defaults: {
    accept_reject: 'accept'
  },

  parse: function (attrs) {
    return _.defaults(
      _.pick(attrs, 'id', 'source', 'column'), // maintain default attrs
      this._typeDef(attrs.type).parse(attrs)
    );
  },

  initialize: function () {
    BaseAnalysisFormModel.prototype.initialize.apply(this, arguments);

    var nodeDefModel = this._layerDefinitionModel.findAnalysisDefinitionNodeModel(this.get('source'));

    this._columnData = new ColumnData({
      column: this.get('column')
    }, {
      nodeDefModel: nodeDefModel,
      configModel: this._configModel
    });

    this._columnRowData = new ColumnRowData({
      column: this.get('column')
    }, {
      nodeDefModel: nodeDefModel,
      configModel: this._configModel
    });

    this._columnOptions = new ColumnOptions({}, {
      configModel: this._configModel,
      nodeDefModel: nodeDefModel
    });

    this.on('change:kind change:column', this._updateSchema, this);
    this.on('change:histogram_stats', this._setSchema, this);

    this.listenTo(this._columnOptions, 'columnsFetched', this._setSchema);
    this.listenTo(this._columnRowData, 'columnsFetched', this._setSchema);
    this.listenTo(this._columnData, 'columnsFetched', this._storeHistogramStats);

    this._columnData.fetch();
    this._columnRowData.fetch();
    this._setSchema();
  },

  getTemplate: function () {
    return template;
  },

  getTemplateData: function () {
    return {
      column: this.get('column'),
      histogram_stats: this.get('histogram_stats'),
      parametersDataFields: this._typeDef().getParameters(this.get('kind'))
    };
  },

  _formatAttrs: function (formAttrs) {
    var customFormattedFormAttrs = this._typeDef().formatAttrs(formAttrs);
    return BaseAnalysisFormModel.prototype._formatAttrs.call(this, customFormattedFormAttrs);
  },

  /**
   * @override {BaseAnalysisFormModel.updateNodeDefinition}
   */
  updateNodeDefinition: function (nodeDefModel) {
    var attrs = this._formatAttrs(this.attributes);
    nodeDefModel.clear({ silent: true });
    nodeDefModel.set(attrs);
  },

  _setSchema: function () {
    BaseAnalysisFormModel.prototype._setSchema.call(this, this._filterSchemaFieldsByType({
      source: this._primarySourceSchemaItem(_t('editor.layers.analysis-form.input')),
      column: {
        type: 'Select',
        text: _t('editor.layers.analysis-form.column'),
        options: this._columnOptions.filterByType(['string', 'number']),
        dialogMode: 'float',
        validators: ['required']
      },
      kind: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.filter'),
        dialogMode: 'float',
        options: this._getKindOptions(),
        editorAttrs: {
          showSearch: false
        }
      },
      min: {
        type: 'Text',
        title: this._getMinLabel(),
        validators: ['required'],
        editorAttrs: {
          placeholder: 'Write min value'
        }
      },
      max: {
        type: 'Text',
        title: this._getMaxLabel(),
        validators: ['required'],
        editorAttrs: {
          placeholder: 'Write max value'
        }
      },
      text: {
        type: this._getInputType(),
        title: _t('editor.layers.analysis-form.input'),
        validators: ['required'],
        options: _.map(this._columnRowData.getRows(), function (d) {
          return { label: d, val: d };
        }),
        dialogMode: 'float',
        editorAttrs: {
          showSearch: true,
          allowFreeTextInput: true
        }
      },
      accept_reject: {
        type: 'Radio',
        title: _t('editor.layers.analysis-form.result'),
        options: [
          { label: _t('editor.layers.analysis-form.show'), val: 'accept' },
          { label: _t('editor.layers.analysis-form.hide'), val: 'reject' }
        ],
        validators: ['required']
      }
    }));

    this._generateHistogram();
    this._generateHistogramStats();
  },

  _getInputType: function () {
    var rows = this._columnRowData.getRows();
    return rows && rows.length ? 'Select' : 'Text';
  },

  _getMinLabel: function () {
    return _.contains(LESS_GREATER_KINDS, this.get('kind')) ? _t('editor.layers.analysis-form.value') : _t('editor.layers.analysis-form.min');
  },

  _getMaxLabel: function () {
    return _.contains(LESS_GREATER_KINDS, this.get('kind')) ? _t('editor.layers.analysis-form.value') : _t('editor.layers.analysis-form.max');
  },

  _getSourceColumns: function () {
    var nodeDefModel = this._layerDefinitionModel.findAnalysisDefinitionNodeModel(this.get('source'));

    var sourceColumns = nodeDefModel.querySchemaModel.columnsCollection.map(function (columnModel) {
      var columnName = columnModel.get('name');
      return {
        val: columnName,
        label: columnName,
        type: columnModel.get('type')
      };
    });

    return sourceColumns;
  },

  _filterSchemaFieldsByType: function (schema) {
    // Always include the source and column fields in addition to the type-specific fields
    var kind = this.get('kind');
    var fields = ['source', 'column'].concat(this._typeDef().getParameters(kind).split(','));
    return _.pick(schema, fields);
  },

  _updateSchema: function () {
    this._columnData.set('column', this.get('column'));
    this._columnRowData.set('column', this.get('column'));

    this._setType();
    this._setSchema();
  },

  _getSelectedColumnType: function () {
    var columns = this._getSourceColumns();
    var columnType = null;

    for (var i in columns) {
      if (columns[i]['label'] === this.get('column')) {
        columnType = columns[i]['type'];
      }
    }

    return columnType;
  },

  _getKindOptions: function () {
    if (this.get('type') !== 'filter-category' || this.get('kind') === 'is-equal-to') {
      return FILTER_RANGE_KINDS;
    }
  },

  _setType: function () {
    var columnType = this._getSelectedColumnType();
    var kind = this.get('kind');
    var attrs = {
      type: 'filter-range'
    };

    if (columnType === 'number' && kind === 'is-equal-to') {
      attrs.type = 'filter-category';
      attrs.accept_reject = 'accept';
    } else if (columnType === 'string') {
      attrs.kind = null;
      attrs.type = 'filter-category';
    }

    this.set(attrs);
  },

  _getColumnType: function (columnName) {
    var nodeDefModel = this._layerDefinitionModel.findAnalysisDefinitionNodeModel(this.get('source'));
    var column = nodeDefModel.querySchemaModel.columnsCollection.find(function (c) {
      return c.get('name') === columnName;
    }, this);

    return column && column.get('type');
  },

  _generateHistogramStats: function (data) {
    if (data) {
      this.trigger('onColData', this);
    }
  },

  _storeHistogramStats: function (data) {
    if (data && this._getSelectedColumnType() === 'number') {
      this.set('histogram_stats', data.attributes);
    } else {
      this.set('histogram_stats', null);
    }
  },

  _generateHistogram: function () {
    var type;
    var tableName = this._getSourceOption()[0].layerName;
    var columnName = this.get('column');

    if (columnName) {
      type = this._getColumnType(columnName);
    }

    if (tableName && columnName && type === 'number') {
      this.trigger('generateHistogram', { columnName: columnName, tableName: tableName });
    }
  },

  _typeDef: function (type) {
    type = type || this.get('type');
    return TYPE_TO_META_MAP[type];
  }
});

},{"../../../../../data/column-row-data":617,"../column-data":878,"../column-options":879,"./base-analysis-form-model":820,"./filter-form.tpl":841,"./filter-types":845,"underscore":"underscore"}],841:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('analyses.filter.title') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.select-column') ))==null?'':_.escape(__t))+
'</p>\n      <div class="u-tSpace-xl CDB-Text CDB-Fieldset">\n        <p class="CDB-Legend u-upperCase u-iBlock CDB-Text is-semibold CDB-Size-small u-rSpace--m">'+
((__t=( _t('editor.layers.analysis-form.input') ))==null?'':_.escape(__t))+
'</p>\n        <div class="Editor-formInput u-ellipsis" data-editors="source"></div>\n      </div>\n      <div class="u-tSpace-xl CDB-Text CDB-Fieldset">\n        <p class="CDB-Legend u-upperCase u-iBlock CDB-Text is-semibold CDB-Size-small u-rSpace--m">'+
((__t=( _t('editor.layers.analysis-form.column') ))==null?'':_.escape(__t))+
'</p>\n        <div class="Editor-formInput" data-editors="column"></div>\n      </div>\n      ';
 if (histogram_stats) { 
__p+='\n      <div class="u-tSpace-xl CDB-Text CDB-Fieldset ">\n        <p class="CDB-Legend u-upperCase u-iBlock CDB-Text is-semibold CDB-Size-small u-rSpace--m"></p>\n        <div class="Analysis-Histogram js-histogram">\n          <ul class="Analysis-HistogramInfo u-flex CDB-Text CDB-Size-small u-secondaryTextColor u-upperCase">\n            <li class="u-rSpace"><span class="js-min"></span> '+
((__t=( _t('editor.layers.analysis-form.min') ))==null?'':_.escape(__t))+
'</li>\n            <li><span class="js-max"></span> '+
((__t=( _t('editor.layers.analysis-form.max') ))==null?'':_.escape(__t))+
'</li>\n          </ul>\n          <div class="Analysis-HistogramChart js-histogramChart"></div>\n        </div>\n      </div>\n      ';
 } 
__p+='\n    </div>\n  </div>\n  ';
 if (column) { 
__p+='\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">3</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="'+
((__t=( parametersDataFields ))==null?'':_.escape(__t))+
'">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.analysis-form.parameters') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--xl">'+
((__t=( _t('editor.layers.analysis-form.parameters-description') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n  ';
 } 
__p+='\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],842:[function(require,module,exports){
var _ = require('underscore');
var BaseAnalysisFormModel = require('./base-analysis-form-model');
var template = require('./filter-intersection-form.tpl');
var ColumnOptions = require('../column-options');

/**
 *  Filter points in polygon model
 */
module.exports = BaseAnalysisFormModel.extend({

  initialize: function () {
    BaseAnalysisFormModel.prototype.initialize.apply(this, arguments);

    this._columnOptions = new ColumnOptions({}, {
      configModel: this._configModel
    });

    this.listenTo(this._analysisSourceOptionsModel, 'change:fetching', this._setSchema);
    this.listenTo(this._columnOptions, 'columnsFetched', this._setSchema);

    this.on('change:target', this._onChangeTarget, this);

    this._setSchema();
    this._fetchColumns();
  },

  _formatAttrs: function (formAttrs) {
    var customFormattedFormAttrs = _.pick(formAttrs, ['id', 'source', 'target', 'type']);
    return BaseAnalysisFormModel.prototype._formatAttrs.call(this, customFormattedFormAttrs);
  },

  getTemplate: function () {
    return template;
  },

  getTemplateData: function () {
    return {};
  },

  _filterSchemaFieldsByType: function (schema) {
    // Always include the source and target fields in addition to the type-specific fields
    return _.pick(schema, ['source', 'target', 'type']);
  },

  /**
   * @override {BaseAnalysisFormModel._setSchema}
   */
  _setSchema: function () {
    BaseAnalysisFormModel.prototype._setSchema.call(this, this._filterSchemaFieldsByType({
      source: this._primarySourceSchemaItem(_t('editor.layers.analysis-form.base-layer')),
      target: {
        type: 'NodeDataset',
        title: _t('editor.layers.analysis-form.filtering-layer'),
        options: this._getSourceOptionsForSource({
          sourceAttrName: 'target',
          requiredSimpleGeometryType: 'point'
        }),
        dialogMode: 'float',
        validators: ['required'],
        editorAttrs: {
          disabled: this._isSourceDisabled('target')
        }
      }
    }));
  },

  _onChangeTarget: function () {
    this._analysisSourceOptionsModel.createSourceNodeUnlessExisting(this.get('target'));
    this._fetchColumns();
  },

  _fetchColumns: function () {
    var target = this.get('target');

    var nodeDefModel = this._layerDefinitionModel.findAnalysisDefinitionNodeModel(target);

    if (nodeDefModel) {
      this._columnOptions.setNode(nodeDefModel);
    } else if (target) {
      this._columnOptions.setDataset(target);
    }
  },

  _isSourceDisabled: function (sourceAttrName) {
    return this._isPrimarySource(sourceAttrName) || this._isFetchingOptions();
  }
});

},{"../column-options":879,"./base-analysis-form-model":820,"./filter-intersection-form.tpl":843,"underscore":"underscore"}],843:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="source,target">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('analyses.filter-intersection.title') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.input-layer') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],844:[function(require,module,exports){
var _ = require('underscore');

var PARAMETERS_FOR_KIND = {
  'between': 'kind,min,max',
  'is-equal-to': 'kind,text',
  'is-less-than': 'kind,max',
  'is-greater-than': 'kind,min'
};

module.exports = {
  type: 'filter-range',
  label: 'Filter range', // TODO: localize?

  parse: function (nodeAttrs) {
    var formAttrs = _.extend({}, nodeAttrs);

    formAttrs.type = 'filter-range';
    formAttrs.kind = nodeAttrs.kind || 'between';
    formAttrs.column = nodeAttrs.column || '';
    formAttrs.min = nodeAttrs.min != null ? nodeAttrs.min : 0;
    formAttrs.max = nodeAttrs.max != null ? nodeAttrs.max : 50;

    return formAttrs;
  },

  getParameters: function (kind) {
    if (!kind) {
      kind = 'is-equal-to';
    }
    return PARAMETERS_FOR_KIND[kind];
  },

  formatAttrs: function (formAttrs) {
    var attrs = this.getParameters(formAttrs.kind);
    return _.pick(formAttrs, ['id', 'type', 'source', 'column'].concat(attrs.split(',')));
  }
};

},{"underscore":"underscore"}],845:[function(require,module,exports){
module.exports = [
  require('./filter-category'),
  require('./filter-range')
];

},{"./filter-category":839,"./filter-range":844}],846:[function(require,module,exports){
module.exports = {
  type: 'georeference-admin-region',
  label: _t('editor.layers.analysis-form.georeference.admin-region'),
  fieldAttrs: {
    admin_region_column: {
      showSearch: true
    },
    country: {
      showSearch: true,
      allowFreeTextInput: true
    }
  },

  validatorFor: {
    admin_region_column: ['required']
  },

  parametersDataFields: 'admin_region_column,country',

  getParameters: function () {
    var params = this.parametersDataFields;

    return params;
  },

  parse: function (nodeAttrs) {
    return {
      type: 'georeference-admin-region',
      admin_region_column: nodeAttrs.admin_region_column,
      country: nodeAttrs.country || nodeAttrs.country_column
    };
  },

  formatAttrs: function (formAttrs, columnOptions) {
    if (formAttrs.country && columnOptions.findColumn(formAttrs.country, 'string')) {
      formAttrs.country_column = formAttrs.country;
      delete formAttrs.country;
    } else {
      delete formAttrs.country_column;
    }
    return formAttrs;
  }
};

},{}],847:[function(require,module,exports){
var _ = require('underscore');

module.exports = {
  type: 'georeference-city',
  label: _t('editor.layers.analysis-form.georeference.city'),
  fieldAttrs: {
    city_column: {
      showSearch: true
    },
    admin_region: {
      showSearch: true,
      allowFreeTextInput: true
    },
    country: {
      showSearch: true,
      allowFreeTextInput: true
    }
  },

  validatorFor: {
    city_column: ['required']
  },

  parametersDataFields: 'city_column,admin_region,country',

  getParameters: function () {
    var params = this.parametersDataFields;

    return params;
  },

  parse: function (nodeAttrs) {
    return {
      type: 'georeference-city',
      city_column: nodeAttrs.city_column,
      admin_region: nodeAttrs.admin_region || nodeAttrs.admin_region_column,
      country: nodeAttrs.country || nodeAttrs.country_column
    };
  },

  formatAttrs: function (formAttrs, columnOptions) {
    _.each(['country', 'admin_region'], function (attr) {
      if (formAttrs[attr] && columnOptions.findColumn(formAttrs[attr], 'string')) {
        formAttrs[attr + '_column'] = formAttrs[attr];
        delete formAttrs[attr];
      } else {
        delete formAttrs[attr + '_column'];
      }
    }, this);

    return formAttrs;
  }
};

},{"underscore":"underscore"}],848:[function(require,module,exports){
module.exports = {
  type: 'georeference-country',
  label: _t('editor.layers.analysis-form.georeference.country'),
  fieldAttrs: {
    country_column: {
      showSearch: true
    }
  },

  validatorFor: {
    country_column: ['required']
  },

  parametersDataFields: 'country_column',

  getParameters: function () {
    var params = this.parametersDataFields;

    return params;
  },

  parse: function (nodeAttrs) {
    return {
      type: 'georeference-country',
      country_column: nodeAttrs.country_column || nodeAttrs.country
    };
  },

  formatAttrs: function (formAttrs) {
    return formAttrs;
  }
};

},{}],849:[function(require,module,exports){
var _ = require('underscore');
var BaseAnalysisFormModel = require('./base-analysis-form-model');
var template = require('./georeference-form.tpl');
var ColumnOptions = require('../column-options');
var GEOREFERENCE_TYPES = require('./georeference-types');

var TYPE_TO_META_MAP = {};
GEOREFERENCE_TYPES.map(function (d) {
  TYPE_TO_META_MAP[d.type] = d;
});

/**
 * Form model for a georeference analysis
 * It has a rather complicated schema, that depends on several data points and state.
 */
module.exports = BaseAnalysisFormModel.extend({
  parse: function (attrs) {
    return _.defaults(
      _.pick(attrs, 'id', 'source', 'context'), // maintain default attrs
      this._typeDef(attrs.type).parse(attrs)
    );
  },

  initialize: function () {
    BaseAnalysisFormModel.prototype.initialize.apply(this, arguments);

    this._columnOptions = new ColumnOptions({}, {
      configModel: this._configModel,
      nodeDefModel: this._layerDefinitionModel.findAnalysisDefinitionNodeModel(this.get('source'))
    });

    this.listenTo(this._columnOptions, 'columnsFetched', this._setSchema);
    this.on('change:type change:context', this._onTypeChanged, this);

    this._setSchema();
  },

  updateNodeDefinition: function (nodeDefModel) {
    var attrs = this._formatAttrs(this.attributes);
    nodeDefModel.clear({silent: true});
    nodeDefModel.set(attrs);
  },

  _formatAttrs: function (formAttrs) {
    var customFormattedFormAttrs = this._typeDef().formatAttrs(formAttrs, this._columnOptions);
    return BaseAnalysisFormModel.prototype._formatAttrs.call(this, customFormattedFormAttrs);
  },

  getTemplate: function () {
    return template;
  },

  getTemplateData: function () {
    return {parametersDataFields: this._typeDef().getParameters(this.get('context'))};
  },

  _filterSchemaFieldsByType: function (schema) {
    // Always include the source field in addition to the type-specific fields
    // If the model has a context attribute it will be used to filter the fields
    var context = this.get('context');
    var fields = ['source', 'type'].concat(this._typeDef().getParameters(context).split(','));

    return _.pick(schema, fields);
  },

  /*
  /**
   * @override {BaseAnalysisFormModel._setSchema}
   */
  _setSchema: function () {
    BaseAnalysisFormModel.prototype._setSchema.call(this, this._filterSchemaFieldsByType({
      type: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.type'),
        options: _.compact(
          GEOREFERENCE_TYPES.map(function (d) {
            if (!this._analyses.isAnalysisValidByType(d.type, this._configModel)) {
              return false;
            }

            return {
              val: d.type,
              label: d.label
            };
          }, this)
        ),
        dialogMode: 'float'
      },
      context: {
        type: 'Toggle',
        title: '',
        label: '',
        options: [
          {
            val: 'advance',
            label: _t('editor.layers.analysis-form.georeference.advance'),
            help: _t('editor.layers.analysis-form.georeference.street-address-help'),
            selected: false
          }, {
            val: 'normal',
            label: _t('editor.layers.analysis-form.georeference.normal'),
            selected: true
          }
        ]
      },
      source: {
        type: 'NodeDataset',
        text: _t('editor.layers.analysis-form.source'),
        options: this._getSourceOption(),
        dialogMode: 'float',
        editorAttrs: { disabled: true }
      },
      latitude: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.latitude'),
        options: this._columnOptions.filterByType(['string', 'number']),
        dialogMode: 'float',
        validators: this._getFieldValidator('latitude'),
        placeholder: _t('editor.layers.analysis-form.georeference.select-latitude'),
        searchPlaceholder: _t('editor.layers.analysis-form.search-by-column-name')
      },
      longitude: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.longitude'),
        options: this._columnOptions.filterByType(['string', 'number']),
        dialogMode: 'float',
        validators: this._getFieldValidator('longitude'),
        placeholder: _t('editor.layers.analysis-form.georeference.select-longitude'),
        searchPlaceholder: _t('editor.layers.analysis-form.search-by-column-name')
      },
      admin_region: {
        type: 'EnablerEditor',
        title: '',
        label: _t('editor.layers.analysis-form.admin-region'),
        help: _t('editor.layers.analysis-form.georeference.admin-region-extended-help'),
        validators: this._getFieldValidator('admin_region'),
        editor: {
          type: 'Select',
          options: this._getColumnOptions('admin_region', 'string'),
          dialogMode: 'float',
          editorAttrs: this._getFieldAttrs('admin_region'),
          placeholder: _t('editor.layers.analysis-form.georeference.select-admin'),
          searchPlaceholder: _t('editor.layers.analysis-form.georeference.enter-region-name')
        }
      },
      admin_region_column: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.admin-region'),
        options: this._columnOptions.filterByType('string'),
        dialogMode: 'float',
        help: _t('editor.layers.analysis-form.georeference.admin-region-help'),
        validators: this._getFieldValidator('admin_region'),
        editorAttrs: this._getFieldAttrs('admin_region'),
        placeholder: _t('editor.layers.analysis-form.georeference.select-admin'),
        searchPlaceholder: _t('editor.layers.analysis-form.search-by-column-name')
      },
      country_column: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.country'),
        options: this._columnOptions.filterByType('string'),
        dialogMode: 'float',
        help: _t('editor.layers.analysis-form.georeference.country-help'),
        validators: this._getFieldValidator('country_column'),
        editorAttrs: this._getFieldAttrs('country_column'),
        placeholder: _t('editor.layers.analysis-form.georeference.select-a-country'),
        searchPlaceholder: _t('editor.layers.analysis-form.search-by-column-name')
      },
      city: {
        type: 'EnablerEditor',
        title: '',
        label: _t('editor.layers.analysis-form.city'),
        help: _t('editor.layers.analysis-form.georeference.city-extended-help'),
        validators: this._getFieldValidator('city'),
        editor: {
          type: 'Select',
          options: this._getColumnOptions('city', 'string'),
          dialogMode: 'float',
          editorAttrs: this._getFieldAttrs('city'),
          placeholder: _t('editor.layers.analysis-form.georeference.select-city'),
          searchPlaceholder: _t('editor.layers.analysis-form.georeference.enter-city-name')
        }
      },
      city_column: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.city'),
        options: this._columnOptions.filterByType('string'),
        dialogMode: 'float',
        help: _t('editor.layers.analysis-form.georeference.city-help'),
        validators: this._getFieldValidator('city_column'),
        editorAttrs: this._getFieldAttrs('city_column'),
        placeholder: _t('editor.layers.analysis-form.georeference.select-city'),
        searchPlaceholder: _t('editor.layers.analysis-form.search-by-column-name')
      },
      postal_code_column: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.postal-code'),
        options: this._columnOptions.filterByType(['string', 'number']),
        dialogMode: 'float',
        help: _t('editor.layers.analysis-form.georeference.postal-code-help'),
        validators: this._getFieldValidator('postal_code_column'),
        placeholder: _t('editor.layers.analysis-form.georeference.select-postal-code'),
        searchPlaceholder: _t('editor.layers.analysis-form.search-by-column-name')
      },
      ip_address: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.georeference.ip-address-column'),
        options: this._columnOptions.filterByType('string'),
        dialogMode: 'float',
        help: _t('editor.layers.analysis-form.georeference.ip-address-help'),
        validators: this._getFieldValidator('ip_address'),
        placeholder: _t('editor.layers.analysis-form.georeference.select-ip'),
        searchPlaceholder: _t('editor.layers.analysis-form.search-by-column-name')
      },
      street_address_template: {
        type: 'CodeEditor',
        title: '',
        label: '',
        tokens: this._getColumnHints(this._columnOptions.filterByType(['string', 'number'])),
        validators: this._getFieldValidator('street_address_template'),
        placeholder: '{{street_number}} {{street_name}}, {{postal_code}} {{country}}'
      },
      street_address_column: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.georeference.street-address-column'),
        options: this._columnOptions.filterByType('string'),
        dialogMode: 'float',
        help: _t('editor.layers.analysis-form.georeference.street-address-column-help'),
        validators: this._getFieldValidator('street_address_column'),
        placeholder: _t('editor.layers.analysis-form.georeference.select-street-address'),
        searchPlaceholder: _t('editor.layers.analysis-form.search-by-column-name')
      },
      state: {
        type: 'EnablerEditor',
        title: '',
        label: _t('editor.layers.analysis-form.state'),
        help: _t('editor.layers.analysis-form.georeference.state-help'),
        validators: this._getFieldValidator('state'),
        editor: {
          type: 'Select',
          options: this._getColumnOptions('state', 'string'),
          dialogMode: 'float',
          editorAttrs: this._getFieldAttrs('state'),
          placeholder: _t('editor.layers.analysis-form.georeference.select-state'),
          searchPlaceholder: _t('editor.layers.analysis-form.georeference.enter-state-name')
        }
      },
      country: {
        type: 'EnablerEditor',
        title: '',
        label: _t('editor.layers.analysis-form.country'),
        help: _t('editor.layers.analysis-form.georeference.country-extended-help'),
        validators: this._getFieldValidator('country'),
        editor: {
          type: 'Select',
          options: this._getColumnOptions('country', 'string'),
          dialogMode: 'float',
          editorAttrs: this._getFieldAttrs('country'),
          placeholder: _t('editor.layers.analysis-form.georeference.select-country'),
          searchPlaceholder: _t('editor.layers.analysis-form.georeference.enter-country-name')
        }
      }
    }));
  },

  _onTypeChanged: function () {
    this._replaceAttrs();
    this._setSchema();
  },

  _replaceAttrs: function () {
    var attrs = this.parse(this.attributes);
    this.clear({silent: true});
    this.set({
      type: attrs.type,
      context: attrs.context
    }, { silent: true }); // re-set type to avoid change:type change:context event to trigger again
    this.set(attrs);
  },

  _typeDef: function (type) {
    type = type || this.get('type');
    return TYPE_TO_META_MAP[type];
  },

  _getFieldAttrs: function (fieldName) {
    return this._typeDef() && this._typeDef().fieldAttrs[fieldName];
  },

  _getFieldValidator: function (fieldName) {
    return this._typeDef() && this._typeDef().validatorFor[fieldName] || null;
  },

  _getColumnHints: function (columns) {
    if (!columns) {
      return [];
    }

    return [{
      keywords: columns.map(function (column) { return column.val; }).join(' '),
      type: 'Column_name'
    }];
  },

  _getColumnOptions: function (attr, attrType) {
    var opts = this._columnOptions.filterByType(attrType);

    if (this._columnOptions.get('columnsFetched') && this.get(attr)) {
      var attrExists = false;
      var value = this.get(attr);

      var customValue = {
        val: value,
        label: '"' + value + '"'
      };

      if (opts && opts.length) {
        attrExists = _.find(opts, function (attr) {
          return attr.val === customValue.val;
        });
      }

      if (!attrExists) {
        opts.push(customValue);
        opts = _.sortBy(opts, function (d) {
          return d.val;
        });
      }
    }
    return opts;
  }
});

},{"../column-options":879,"./base-analysis-form-model":820,"./georeference-form.tpl":850,"./georeference-types":855,"underscore":"underscore"}],850:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('analyses.georeference.title') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.select-type') ))==null?'':_.escape(__t))+
'</p>\n      <div class="u-tSpace-xl CDB-Text CDB-Fieldset">\n        <p class="CDB-Legend u-upperCase u-iBlock CDB-Text is-semibold CDB-Size-small u-rSpace--m">'+
((__t=( _t('editor.layers.analysis-form.input') ))==null?'':_.escape(__t))+
'</p>\n        <div class="Editor-formInput u-ellipsis" data-editors="source"></div>\n      </div>\n      <div class="u-tSpace-xl CDB-Text CDB-Fieldset">\n        <p class="CDB-Legend u-upperCase u-iBlock CDB-Text is-semibold CDB-Size-small u-rSpace--m">'+
((__t=( _t('editor.layers.analysis-form.type') ))==null?'':_.escape(__t))+
'</p>\n        <div class="Editor-formInput" data-editors="type"></div>\n      </div>\n    </div>\n  </div>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">3</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="'+
((__t=( parametersDataFields ))==null?'':__t)+
'">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.analysis-form.parameters') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--xl">'+
((__t=( _t('editor.layers.analysis-form.tune-analysis') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],851:[function(require,module,exports){
module.exports = {
  type: 'georeference-ip-address',
  label: _t('editor.layers.analysis-form.georeference.ip-address'),
  fieldAttrs: {
    ip_address: {
      showSearch: true
    }
  },

  validatorFor: {
    ip_address: ['required']
  },

  parametersDataFields: 'ip_address',

  getParameters: function () {
    var params = this.parametersDataFields;

    return params;
  },

  parse: function (nodeAttrs) {
    return {
      type: 'georeference-ip-address',
      ip_address: nodeAttrs.ip_address
    };
  },

  formatAttrs: function (formAttrs) {
    return formAttrs;
  }
};

},{}],852:[function(require,module,exports){
module.exports = {
  type: 'georeference-long-lat',
  label: _t('editor.layers.analysis-form.georeference.long-lat'),
  parametersDataFields: 'latitude,longitude',
  fieldAttrs: {
    latitude: {
      showSearch: true
    },
    longitude: {
      showSearch: true
    }
  },

  validatorFor: {
    latitudde: ['required'],
    longitude: ['required']
  },

  parse: function (nodeAttrs) {
    return {
      type: 'georeference-long-lat',
      latitude: nodeAttrs.latitude,
      longitude: nodeAttrs.longitude
    };
  },

  getParameters: function () {
    var params = this.parametersDataFields;

    return params;
  },

  formatAttrs: function (formAttrs) {
    return formAttrs;
  }
};


},{}],853:[function(require,module,exports){
module.exports = {
  type: 'georeference-postal-code',
  label: _t('editor.layers.analysis-form.georeference.postal-code'),
  fieldAttrs: {
    postal_code_column: {
      showSearch: true
    },
    country: {
      showSearch: true,
      allowFreeTextInput: true
    }
  },

  validatorFor: {
    city_column: ['required']
  },

  parametersDataFields: 'postal_code_column,country',

  getParameters: function () {
    var params = this.parametersDataFields;

    return params;
  },

  parse: function (nodeAttrs) {
    return {
      type: 'georeference-postal-code',
      postal_code_column: nodeAttrs.postal_code_column,
      country: nodeAttrs.country || nodeAttrs.country_column
    };
  },

  formatAttrs: function (formAttrs, columnOptions) {
    if (formAttrs.country && columnOptions.findColumn(formAttrs.country, 'string')) {
      formAttrs.country_column = formAttrs.country;
      delete formAttrs.country;
    } else {
      delete formAttrs.country_column;
    }
    return formAttrs;
  }
};

},{}],854:[function(require,module,exports){
var _ = require('underscore');

var PARAMETERS_FOR_CONTEXT = {
  'normal': 'street_address_column,context,city,state,country',
  'advance': 'street_address_template,context,city,state,country'
};

module.exports = {
  type: 'georeference-street-address',
  label: _t('editor.layers.analysis-form.georeference.street-address'),
  fieldAttrs: {
    street_address_column: {
      showSearch: true
    },
    city: {
      showSearch: true,
      allowFreeTextInput: true
    },
    state: {
      showSearch: true,
      allowFreeTextInput: true
    },
    country: {
      showSearch: true,
      allowFreeTextInput: true
    }
  },

  validatorFor: {
    street_address_column: ['required'],
    street_address_template: ['required']
  },

  parse: function (nodeAttrs) {
    var attrs = {
      type: 'georeference-street-address',
      city: nodeAttrs.city || nodeAttrs.city_column || '',
      state: nodeAttrs.state || nodeAttrs.state_column || '',
      country: nodeAttrs.country || nodeAttrs.country_column || ''
    };

    if (nodeAttrs.context === 'advance') {
      attrs.street_address_template = nodeAttrs.street_address_column && this._wrapInBraces(nodeAttrs.street_address_column) || nodeAttrs.street_address_template || '';
    } else {
      attrs.street_address_column = nodeAttrs.street_address_column || '';
    }

    return attrs;
  },

  _wrapInBraces: function (fragments) {
    return ['{{', fragments, '}}'].join('');
  },

  getParameters: function (context) {
    if (!context) {
      context = 'normal';
    }
    return PARAMETERS_FOR_CONTEXT[context];
  },

  formatAttrs: function (formAttrs, columnOptions) {
    _.each(['city', 'state', 'country'], function (attr) {
      if (formAttrs[attr] && columnOptions.findColumn(formAttrs[attr], 'string')) {
        formAttrs[attr + '_column'] = formAttrs[attr];
        delete formAttrs[attr];
      } else {
        delete formAttrs[attr + '_column'];
      }
    }, this);

    return formAttrs;
  }
};

},{"underscore":"underscore"}],855:[function(require,module,exports){
module.exports = [
  require('./georeference-long-lat-model'),
  require('./georeference-city-model'),
  require('./georeference-country-model'),
  require('./georeference-admin-region-model'),
  require('./georeference-postal-code-model'),
  require('./georeference-ip-address-model'),
  require('./georeference-street-address-model')
];

},{"./georeference-admin-region-model":846,"./georeference-city-model":847,"./georeference-country-model":848,"./georeference-ip-address-model":851,"./georeference-long-lat-model":852,"./georeference-postal-code-model":853,"./georeference-street-address-model":854}],856:[function(require,module,exports){
var _ = require('underscore');
var BaseAnalysisFormModel = require('./base-analysis-form-model');
var template = require('./group-points.tpl');
var ColumnOptions = require('../column-options');

var ANALYSES_TYPES = require('./group-points-types');

var TYPE_TO_META_MAP = {};
ANALYSES_TYPES.map(function (d) {
  TYPE_TO_META_MAP[d.type] = d;
});

module.exports = BaseAnalysisFormModel.extend({
  parse: function (attrs) {
    return _.defaults(
      _.pick(attrs, 'id', 'source'), // maintain default attrs
      this._typeDef(attrs.type).parse(attrs)
    );
  },

  initialize: function () {
    BaseAnalysisFormModel.prototype.initialize.apply(this, arguments);

    this._columnOptions = new ColumnOptions({}, {
      configModel: this._configModel,
      nodeDefModel: this._layerDefinitionModel.findAnalysisDefinitionNodeModel(this.get('source'))
    });

    this.listenTo(this._columnOptions, 'columnsFetched', this._setSchema);
    this.on('change:aggregate', this._updateAggregation, this);
    this.on('change:type', this._onTypeChanged, this);

    this._updateAggregation();
    this._setSchema();
  },

  _updateAggregation: function () {
    var aggregate = this.get('aggregate');

    if (aggregate === '') {
      this.set({aggregation: 'count', aggregation_column: ''});
    } else {
      this.set({aggregation_column: aggregate.attribute, aggregation: aggregate.operator});
    }

    this._setSchema();
  },

  _onTypeChanged: function () {
    this._replaceAttrs();
    this._setSchema();
  },

  _replaceAttrs: function () {
    var attrs = this.parse(this.attributes);
    this.clear({ silent: true });
    this.set('type', attrs.type, { silent: true }); // re-set type to avoid change:type event to trigger again
    this.set(_.extend(attrs, this.defaults));
  },

  updateNodeDefinition: function (nodeDefModel) {
    var attrs = this._formatAttrs(this.attributes);
    nodeDefModel.clear({ silent: true });
    nodeDefModel.set(attrs);
  },

  _formatAttrs: function (formAttrs) {
    var customFormattedFormAttrs = this._typeDef().formatAttrs(formAttrs, this._columnOptions);
    return BaseAnalysisFormModel.prototype._formatAttrs.call(this, customFormattedFormAttrs);
  },

  getTemplate: function () {
    return template;
  },

  getTemplateData: function () {
    return {
      parametersDataFields: this._typeDef().parametersDataFields
    };
  },

  _filterSchemaFieldsByType: function (schema) {
    // Always include the source field in addition to the type-specific fields
    var fields = ['source', 'type', 'aggregate'].concat(this._typeDef().parametersDataFields.split(','));
    return _.pick(schema, fields);
  },

  /**
   * @override {BaseAnalysisFormModel._setSchema}
   */
  _setSchema: function () {
    BaseAnalysisFormModel.prototype._setSchema.call(this, this._filterSchemaFieldsByType({
      source: this._primarySourceSchemaItem(),
      type: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.method'),
        options: ANALYSES_TYPES.map(function (d) {
          return {
            val: d.type,
            label: d.label
          };
        }, this),
        dialogMode: 'float'
      },
      target_percentage: {
        type: 'Number',
        title: _t('editor.layers.analysis-form.target-percent'),
        help: _t('editor.layers.analysis-form.target-percent-help'),
        validators: ['required', {
          type: 'interval',
          min: 0,
          max: 100
        }]
      },
      allow_holes: {
        type: 'Radio',
        title: _t('editor.layers.analysis-form.allow-holes'),
        options: [
          { val: false, label: _t('editor.layers.analysis-form.no') },
          { val: true, label: _t('editor.layers.analysis-form.yes') }
        ]
      },
      category_column: {
        type: 'EnablerEditor',
        title: '',
        label: _t('editor.layers.analysis-form.group-by'),
        editor: {
          type: 'Select',
          options: this._columnOptions.all(),
          dialogMode: 'float',
          editorAttrs: {
            showLabel: false
          }
        }
      },
      aggregate: {
        type: 'Operators',
        title: _t('editor.layers.analysis-form.operation'),
        options: this._columnOptions.filterByType('number'),
        dialogMode: 'float'
      }
    }));
  },

  _getColumnOptions: function (attr, attrType) {
    var opts = this._columnOptions.filterByType(attrType);

    if (this._columnOptions.get('columnsFetched') && this.get(attr)) {
      var attrExists = false;
      var value = this.get(attr);

      var customValue = {
        val: value,
        label: '"' + value + '"'
      };

      if (opts && opts.length) {
        attrExists = _.find(opts, function (attr) {
          return attr.val === customValue.val;
        });
      }

      if (!attrExists) {
        opts.push(customValue);
        opts = _.sortBy(opts, function (d) {
          return d.val;
        });
      }
    }
    return opts;
  },

  _typeDef: function (type) {
    type = type || this.get('type');
    return TYPE_TO_META_MAP[type];
  }
});

},{"../column-options":879,"./base-analysis-form-model":820,"./group-points-types":857,"./group-points.tpl":858,"underscore":"underscore"}],857:[function(require,module,exports){
module.exports = [
  require('./group-points/convex-hull'),
  require('./group-points/concave-hull'),
  require('./group-points/bounding-circle'),
  require('./group-points/bounding-box')
];

},{"./group-points/bounding-box":859,"./group-points/bounding-circle":860,"./group-points/concave-hull":861,"./group-points/convex-hull":862}],858:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="'+
((__t=( parametersDataFields ))==null?'':__t)+
'">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('analyses.group-points.title') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.input-layer') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">3</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="aggregate">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.analysis-form.value-aggregation') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--xl">'+
((__t=( _t('editor.layers.analysis-form.value-aggregation-desc') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],859:[function(require,module,exports){
var _ = require('underscore');

module.exports = {
  type: 'bounding-box',
  label: _t('editor.layers.analysis-form.bounding-box'),
  parametersDataFields: 'source,type,category_column',

  parse: function (nodeAttrs) {
    if (!nodeAttrs.aggregation_column) {
      nodeAttrs.aggregation_column = 'cartodb_id';
    }
    if (!nodeAttrs.aggregation) {
      nodeAttrs.aggregation = 'count';
    }
    var aggregate = {
      operator: nodeAttrs.aggregation,
      attribute: nodeAttrs.aggregation === 'count' ? '' : nodeAttrs.aggregation_column
    };

    return {
      type: 'bounding-box',
      category_column: nodeAttrs.category_column,
      aggregate: aggregate
    };
  },

  formatAttrs: function (formAttrs) {
    formAttrs = _.omit(formAttrs, 'aggregate');

    if (!formAttrs.aggregation_column) {
      formAttrs = _.omit(formAttrs, 'aggregation_column');
    }

    if (!formAttrs.category_column) {
      formAttrs = _.omit(formAttrs, 'category_column');
    }

    return formAttrs;
  }
};

},{"underscore":"underscore"}],860:[function(require,module,exports){
var _ = require('underscore');

module.exports = {
  type: 'bounding-circle',
  label: _t('editor.layers.analysis-form.bounding-circle'),
  parametersDataFields: 'source,type,category_column',

  parse: function (nodeAttrs) {
    if (!nodeAttrs.aggregation_column) {
      nodeAttrs.aggregation_column = 'cartodb_id';
    }
    if (!nodeAttrs.aggregation) {
      nodeAttrs.aggregation = 'count';
    }
    var aggregate = {
      operator: nodeAttrs.aggregation,
      attribute: nodeAttrs.aggregation === 'count' ? '' : nodeAttrs.aggregation_column
    };
    return {
      type: 'bounding-circle',
      category_column: nodeAttrs.category_column,
      aggregate: aggregate
    };
  },

  formatAttrs: function (formAttrs) {
    formAttrs = _.omit(formAttrs, 'aggregate');

    if (!formAttrs.aggregation_column) {
      formAttrs = _.omit(formAttrs, 'aggregation_column');
    }

    if (!formAttrs.category_column) {
      formAttrs = _.omit(formAttrs, 'category_column');
    }

    return formAttrs;
  }
};


},{"underscore":"underscore"}],861:[function(require,module,exports){
var _ = require('underscore');

module.exports = {
  type: 'concave-hull',
  label: _t('editor.layers.analysis-form.concave-hull'),
  parametersDataFields: 'source,type,target_percentage,allow_holes,category_column',

  parse: function (nodeAttrs) {
    if (!nodeAttrs.aggregation_column) {
      nodeAttrs.aggregation_column = 'cartodb_id';
    }
    if (!nodeAttrs.aggregation) {
      nodeAttrs.aggregation = 'count';
    }

    var aggregate = {
      operator: nodeAttrs.aggregation,
      attribute: nodeAttrs.aggregation === 'count' ? '' : nodeAttrs.aggregation_column
    };

    var target_percentage = 70;

    if (nodeAttrs.target_percent === 0) {
      target_percentage = 0;
    } else if (nodeAttrs.target_percent) {
      target_percentage = nodeAttrs.target_percent * 100;
    }

    return {
      type: 'concave-hull',
      target_percentage: target_percentage,
      category_column: nodeAttrs.category_column,
      aggregate: aggregate
    };
  },

  formatAttrs: function (formAttrs) {
    formAttrs = _.omit(formAttrs, 'aggregate');

    formAttrs.target_percent = formAttrs.target_percentage / 100;
    formAttrs = _.omit(formAttrs, 'target_percentage');

    if (!formAttrs.aggregation_column) {
      formAttrs = _.omit(formAttrs, 'aggregation_column');
    }

    if (!formAttrs.allow_holes) {
      formAttrs = _.omit(formAttrs, 'allow_holes');
    }

    if (!formAttrs.category_column) {
      formAttrs = _.omit(formAttrs, 'category_column');
    }

    return formAttrs;
  }
};


},{"underscore":"underscore"}],862:[function(require,module,exports){
var _ = require('underscore');

module.exports = {
  type: 'convex-hull',
  label: _t('editor.layers.analysis-form.convex-hull'),
  parametersDataFields: 'source,type,category_column',

  parse: function (nodeAttrs) {
    if (!nodeAttrs.aggregation_column) {
      nodeAttrs.aggregation_column = 'cartodb_id';
    }
    if (!nodeAttrs.aggregation) {
      nodeAttrs.aggregation = 'count';
    }
    var aggregate = {
      operator: nodeAttrs.aggregation,
      attribute: nodeAttrs.aggregation === 'count' ? '' : nodeAttrs.aggregation_column
    };
    return {
      type: 'convex-hull',
      category_column: nodeAttrs.category_column,
      aggregate: aggregate
    };
  },

  formatAttrs: function (formAttrs) {
    formAttrs = _.omit(formAttrs, 'aggregate');

    if (!formAttrs.aggregation_column) {
      formAttrs = _.omit(formAttrs, 'aggregation_column');
    }

    if (!formAttrs.category_column) {
      formAttrs = _.omit(formAttrs, 'category_column');
    }

    return formAttrs;
  }
};

},{"underscore":"underscore"}],863:[function(require,module,exports){
var BaseAnalysisFormModel = require('./base-analysis-form-model');
var template = require('./kmeans-form.tpl');

/**
 * Form model for a means analysis
 * It has a rather complicated schema, that depends on several data points and state.
 */
module.exports = BaseAnalysisFormModel.extend({
  defaults: {
    clusters: 2
  },

  initialize: function () {
    BaseAnalysisFormModel.prototype.initialize.apply(this, arguments);

    this._setSchema();
  },

  getTemplate: function () {
    return template;
  },

  /**
   * @override {BaseAnalysisFormModel._setSchema}
   */
  _setSchema: function () {
    BaseAnalysisFormModel.prototype._setSchema.call(this, {
      source: this._primarySourceSchemaItem(),
      clusters: {
        type: 'Number',
        title: _t('editor.layers.analysis-form.clusters-num'),
        validators: ['required', {
          type: 'interval',
          min: 2,
          max: 16
        }]
      }
    });
  }
});

},{"./base-analysis-form-model":820,"./kmeans-form.tpl":864}],864:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="source">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('analyses.kmeans.title') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.input-layer') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">3</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="clusters">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.analysis-form.parameters') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--xl">'+
((__t=( _t('editor.layers.analysis-form.tune-clusters') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],865:[function(require,module,exports){
var _ = require('underscore');
var BaseAnalysisFormModel = require('./base-analysis-form-model');
var template = require('./merge-form.tpl');
var ColumnOptions = require('../column-options');

var MERGE_FIELDS = 'join_operator,left_source_column,right_source_column,source_geometry_selector,left_source_columns,right_source_columns';

/**
 * Form model for the merge analysis
 */
module.exports = BaseAnalysisFormModel.extend({
  defaults: {
    join_operator: 'inner',
    source_geometry: 'left_source',
    right_source_columns: []
  },

  parse: function (attrs) {
    if (attrs.source_geometry === 'left_source' || !attrs.source_geometry) {
      attrs.source_geometry_selector = attrs.left_source;
    } else {
      attrs.source_geometry_selector = attrs.right_source;
    }

    return attrs;
  },

  initialize: function () {
    BaseAnalysisFormModel.prototype.initialize.apply(this, arguments);

    this.on('change', this._onChange, this);

    this._leftColumnOptions = new ColumnOptions({}, {
      configModel: this._configModel
    });

    this._rightColumnOptions = new ColumnOptions({}, {
      configModel: this._configModel
    });

    this.listenTo(this._analysisSourceOptionsModel, 'change:fetching', this._setSchema);

    this.listenTo(this._leftColumnOptions, 'columnsFetched', this._setSchema);
    this.listenTo(this._rightColumnOptions, 'columnsFetched', this._setSchema);

    this.on('change:type', this._setSchema, this);
    this.on('change:right_source', this._onChangeRightSource, this);
    this.on('change:join_operator, change:right_source, change:left_source_column, change:right_source_column', this._setSchema, this);

    this._setSchema();
    this._fetchLeftColumns();
    this._fetchRightColumns();
  },

  _getFormFieldNames: function () {
    return MERGE_FIELDS;
  },

  _getFormatFieldNames: function () {
    return MERGE_FIELDS;
  },

  _formatAttrs: function (formAttrs) {
    var customFormattedFormAttrs = _.pick(formAttrs, ['id', 'type', 'left_source', 'right_source'].concat(this._getFormatFieldNames().split(',')));

    if (this.get('left_source') === this.get('source_geometry_selector')) {
      customFormattedFormAttrs.source_geometry = 'left_source';
    } else {
      customFormattedFormAttrs.source_geometry = 'right_source';
    }

    if (!formAttrs.left_source_columns) {
      customFormattedFormAttrs.left_source_columns = [];
    }

    if (!formAttrs.right_source_columns) {
      customFormattedFormAttrs.right_source_columns = [];
    }

    return BaseAnalysisFormModel.prototype._formatAttrs.call(this, customFormattedFormAttrs);
  },

  getTemplate: function () {
    return template;
  },

  getTemplateData: function () {
    return {
      right_source: this.get('right_source'),
      hasLeftAndRightSourceColumns: this.get('left_source_column') && this.get('right_source_column')
    };
  },

  _filterSchemaFieldsByType: function (schema) {
    // Always include the source and target fields in addition to the type-specific fields
    return _.pick(schema, ['left_source', 'right_source'].concat(this._getFormFieldNames().split(',')));
  },

  _onChangeRightSource: function () {
    this._fetchRightColumns();
    this.unset('right_source_column');
    this.set('right_source_columns', []);
  },

  _getLeftSourceLabel: function () {
    var source = this._getSourceOption()[0];
    if (source) {
      return source.layerName;
    }
  },

  _getRightSourceLabel: function () {
    var source = this._getSourceOptionsForSourceId(this.get('right_source'), 'right_source', '*');
    if (source) {
      return source.label;
    }
  },

  /**
   * @override {BaseAnalysisFormModel._setSchema}
   */
  _setSchema: function () {
    BaseAnalysisFormModel.prototype._setSchema.call(this, this._filterSchemaFieldsByType({
      left_source: this._primarySourceSchemaItem(_t('editor.layers.analysis-form.input-num', { num: 1 })),
      right_source: {
        type: 'NodeDataset',
        title: _t('editor.layers.analysis-form.input-num', { num: 2 }),
        options: this._getSourceOptionsForSource('right_source', '*'),
        dialogMode: 'float',
        validators: ['required'],
        editorAttrs: {
          disabled: this._isSourceDisabled('right_source')
        }
      },
      join_operator: {
        type: 'Radio',
        title: _t('editor.layers.analysis-form.join-type'),
        options: [
          { label: _t('editor.layers.analysis-form.left'), val: 'left', help: _t('editor.layers.analysis-form.merge-type.left') },
          { label: _t('editor.layers.analysis-form.inner'), val: 'inner', help: _t('editor.layers.analysis-form.merge-type.inner') }
        ],
        validators: ['required']
      },
      left_source_column: {
        type: 'Select',
        title: this._getLeftSourceLabel(),
        options: this._leftColumnOptions.all(),
        dialogMode: 'float',
        validators: ['required']
      },
      right_source_column: {
        type: 'Select',
        title: this._getRightSourceLabel(),
        options: this._rightColumnOptions.all(),
        dialogMode: 'float',
        validators: ['required', this._validateRightSourceColumn.bind(this)]
      },
      source_geometry_selector: {
        type: 'NodeDataset',
        title: _t('editor.layers.analysis-form.geometry-from'),
        options: this._getSourcesSelector(),
        dialogMode: 'float',
        editorAttrs: {
          disabled: this._isSourceDisabled('right_source')
        }
      },
      left_source_columns: {
        type: 'MultiSelect',
        title: this._getLeftSourceLabel(),
        options: this._leftColumnOptions.filterByType(['string', 'number', 'date', 'boolean']),
        dialogMode: 'float'
      },
      right_source_columns: {
        type: 'MultiSelect',
        title: this._getRightSourceLabel(),
        options: this._rightColumnOptions.filterByType(['string', 'number', 'date', 'boolean']),
        dialogMode: 'float'
      }
    }));
  },

  _validateRightSourceColumn: function (value, formValues) {
    var leftColumnValue = formValues.left_source_column;
    var rightColumnValue = formValues.right_source_column;

    // if we don't have both fields we don't validate
    if (leftColumnValue === void 0 || rightColumnValue === void 0) return null;

    var error = {
      message: _t('editor.layers.analysis-form.should-match')
    };

    var leftColumn = this._leftColumnOptions.findColumn(leftColumnValue);
    var leftColumnType = leftColumn && leftColumn.type;

    var rightColumn = this._rightColumnOptions.findColumn(rightColumnValue);
    var rightColumnType = rightColumn && rightColumn.type;

    if (leftColumnType === rightColumnType) {
      return null; // types match
    }

    return error;
  },

  _fetchColumns: function (sourceName, columnOptions) {
    var source = this.get(sourceName);

    var nodeDefModel = this._layerDefinitionModel.findAnalysisDefinitionNodeModel(source);

    if (nodeDefModel) {
      columnOptions.setNode(nodeDefModel);
    } else if (source) {
      columnOptions.setDataset(source);
    }
  },

  _fetchLeftColumns: function () {
    this._fetchColumns('left_source', this._leftColumnOptions);
  },

  _fetchRightColumns: function () {
    this._fetchColumns('right_source', this._rightColumnOptions);
  },

  _isSourceDisabled: function (sourceAttrName) {
    return this._isPrimarySource(sourceAttrName) || this._isFetchingOptions();
  },

  _getSourcesSelector: function () {
    return _.compact([this._getSourceOption()[0], this._getRightSource()]);
  },

  _getRightSource: function () {
    if (this.get('right_source')) {
      var source = this._getSourceOptionsForSourceId(this.get('right_source'), 'right_source', '*');
      if (source) {
        return {
          val: this.get('right_source'),
          type: source.type,
          nodeTitle: this._analyses.title(source),
          layerName: source.layerName,
          color: source.color
        };
      }
    }
  },

  _getSourceOptionsForSourceId: function (sourceId, sourceAttrName, requiredSimpleGeometryType) {
    return this._analysisSourceOptionsModel
    .getSelectOptions(requiredSimpleGeometryType)
    .find(function (d) {
      // Can't select own layer as source, so exclude it
      return d.val === sourceId;
    });
  },

  _getSourceOptionsForSource: function (sourceAttrName, requiredSimpleGeometryType) {
    var currentSource = this.get(sourceAttrName);

    if (this._isFetchingOptions()) {
      return [{
        val: currentSource,
        label: _t('editor.layers.analysis-form.loading'),
        isLoading: true
      }];
    } else {
      // fetched
      var source = this._getSourceOption()[0];
      return this._analysisSourceOptionsModel
      .getSelectOptions(requiredSimpleGeometryType)
      .filter(function (d) {
        return d.val !== source.val && d.val !== source.layerName;
      });
    }
  },

  _getSourceOption: function () {
    var leftSourceId = this.get('left_source');
    var nodeDefModel = this._layerDefinitionModel.findAnalysisDefinitionNodeModel(leftSourceId);
    return [{
      val: leftSourceId,
      type: 'node',
      nodeTitle: this._analyses.title(nodeDefModel),
      layerName: this._layerDefinitionModel.getName(),
      color: this._layerDefinitionModel.get('color')
    }];
  },

  _onChange: function () {
    var changedSourceId = this.changed.left_source || this.changed.right_source;
    if (changedSourceId) {
      this._analysisSourceOptionsModel.createSourceNodeUnlessExisting(changedSourceId);
    }
  }
});

},{"../column-options":879,"./base-analysis-form-model":820,"./merge-form.tpl":866,"underscore":"underscore"}],866:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="left_source,right_source,join_operator">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('analyses.merge.title') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.define-two-layers') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n  ';
 if (right_source) { 
__p+='\n    <div class="Editor-HeaderInfo">\n      <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">3</div>\n      <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="left_source_column,right_source_column">\n        <div class="Editor-HeaderInfo-title u-bSpace--m">\n          <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.analysis-form.foreign-keys') ))==null?'':_.escape(__t))+
'</h2>\n        </div>\n        <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--xl">'+
((__t=( _t('editor.layers.analysis-form.no-coincidence') ))==null?'':_.escape(__t))+
'</p>\n      </div>\n    </div>\n    ';
 if (hasLeftAndRightSourceColumns) { 
__p+='\n      <div class="Editor-HeaderInfo">\n        <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">4</div>\n        <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="source_geometry_selector,left_source_columns,right_source_columns">\n          <div class="Editor-HeaderInfo-title u-bSpace--m">\n            <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.analysis-form.columns') ))==null?'':_.escape(__t))+
'</h2>\n          </div>\n          <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--xl">'+
((__t=( _t('editor.layers.analysis-form.keep-columns') ))==null?'':_.escape(__t))+
'</p>\n        </div>\n      </div>\n    ';
 } 
__p+='\n  ';
 } 
__p+='\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],867:[function(require,module,exports){
var BaseAnalysisFormModel = require('./base-analysis-form-model');
var template = require('./moran-form.tpl');
var ColumnOptions = require('../column-options');

/**
 * Form model for a moran analysis
 * It has a rather complicated schema, that depends on several data points and state.
 */
module.exports = BaseAnalysisFormModel.extend({
  defaults: {
    significance: 0.05,
    neighbours: 5,
    permutations: 99,
    w_type: 'knn'
  },

  initialize: function () {
    BaseAnalysisFormModel.prototype.initialize.apply(this, arguments);

    this._columnOptions = new ColumnOptions({}, {
      configModel: this._configModel,
      nodeDefModel: this._layerDefinitionModel.findAnalysisDefinitionNodeModel(this.get('source'))
    });

    this.listenTo(this._columnOptions, 'columnsFetched', this._setSchema);

    this._setSchema();
  },

  getTemplate: function () {
    return template;
  },

  /*
  /**
   * @override {BaseAnalysisFormModel._setSchema}
   */
  _setSchema: function () {
    var schema = {
      source: this._primarySourceSchemaItem(),
      numerator_column: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.numerator'),
        options: this._columnOptions.filterByType('number'),
        dialogMode: 'float',
        help: _t('editor.layers.analysis-form.numerator-help')
      },
      denominator_column: {
        type: 'EnablerEditor',
        title: '',
        label: _t('editor.layers.analysis-form.denominator'),
        help: _t('editor.layers.analysis-form.denominator-help'),
        editor: {
          type: 'Select',
          title: _t('editor.layers.analysis-form.denominator'),
          options: this._columnOptions.filterByType('number'),
          dialogMode: 'float'
        }
      },
      significance: {
        type: 'Number',
        title: _t('editor.layers.analysis-form.significance'),
        help: _t('editor.layers.analysis-form.significance-help'),
        validators: ['required', {
          type: 'interval',
          min: 0,
          max: 1,
          step: 0.05
        }]
      },
      neighbours: {
        type: 'Number',
        title: _t('editor.layers.analysis-form.neighbors'),
        help: _t('editor.layers.analysis-form.neighbors-help'),
        validators: ['required', {
          type: 'interval',
          min: 1,
          max: 100
        }]
      }
      // hidden as per https://github.com/CartoDB/cartodb/pull/7893#issuecomment-226803659
      /*
      permutations: {
        type: 'Number',
        title: _t('editor.layers.analysis-form.permutations'),
        validators: ['required', {
          type: 'interval',
          min: 1,
          max: 100
        }]
      },
      w_type: {
        type: 'Select',
        title: _t('editor.layers.analysis-form.weight-type'),
        options: ['knn', 'queen'],
        validators: []
      }
      */
    };
    BaseAnalysisFormModel.prototype._setSchema.call(this, schema);
  },

  updateNodeDefinition: function (nodeDefModel) {
    var nodeAttrs = this._formatAttrs(this.attributes);
    // It could happen that denominator_column is not present, and if we use `set`
    // instead of the thing below, it could keep returning that attribute for the analysis
    nodeDefModel.attributes = nodeAttrs;
  }
});

},{"../column-options":879,"./base-analysis-form-model":820,"./moran-form.tpl":868}],868:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="source">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('analyses.moran-cluster.title') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.input-layer') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">3</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="numerator_column,denominator_column,significance,neighbours">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.analysis-form.parameters') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--xl">'+
((__t=( _t('editor.layers.analysis-form.define-columns') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],869:[function(require,module,exports){
var BaseAnalysisFormModel = require('./base-analysis-form-model');
var template = require('./sampling-form.tpl');
var _ = require('underscore');

var DEFAULT_PERCENT = 10;

/**
 * Form model for a sampling
 */
module.exports = BaseAnalysisFormModel.extend({

  initialize: function () {
    BaseAnalysisFormModel.prototype.initialize.apply(this, arguments);
    this.bind('change:percent', function () {
      this.set('sampling', +this.get('percent') / 100);
    }, this);
    this._setSchema();
  },

  parse: function (attrs) {
    return _.defaults(attrs, {
      percent: DEFAULT_PERCENT,
      sampling: DEFAULT_PERCENT / 100
    });
  },

  getTemplate: function () {
    return template;
  },

  /**
   * @override {BaseAnalysisFormModel._setSchema}
   */
  _setSchema: function () {
    var schema = {
      source: this._primarySourceSchemaItem(),
      percent: {
        type: 'Number',
        title: _t('editor.layers.analysis-form.sampling-rate'),
        validators: ['required', {
          type: 'interval',
          min: 0,
          max: 100,
          step: 1
        }]
      }
    };

    BaseAnalysisFormModel.prototype._setSchema.call(this, schema);
  }
});

},{"./base-analysis-form-model":820,"./sampling-form.tpl":870,"underscore":"underscore"}],870:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="source,percent">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('analyses.sampling.title') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.sampling-desc') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n</form>\n\n';
}
return __p;
};

},{"underscore":"underscore"}],871:[function(require,module,exports){
var BaseAnalysisFormModel = require('./base-analysis-form-model');
var template = require('./spatial-markov-trend.tpl');
var ColumnOptions = require('../column-options');

module.exports = BaseAnalysisFormModel.extend({
  initialize: function () {
    BaseAnalysisFormModel.prototype.initialize.apply(this, arguments);
    var nodeDefModel = this._layerDefinitionModel.findAnalysisDefinitionNodeModel(this.get('source'));
    this._columnOptions = new ColumnOptions({}, {
      configModel: this._configModel,
      nodeDefModel: nodeDefModel
    });
    this.listenTo(this._columnOptions, 'columnsFetched', this._setSchema);
    this._setSchema();
  },

  getTemplate: function () {
    return template;
  },

  /**
   * @override {BaseAnalysisFormModel._setSchema}
   */
  _setSchema: function () {
    var schema = {
      source: this._primarySourceSchemaItem(),
      time_columns: {
        type: 'MultiSelect',
        title: _t('editor.layers.analysis-form.spatial-markov-trend-time-columns'),
        options: this._columnOptions.filterByType(['string', 'number']),
        dialogMode: 'float',
        help: _t('editor.layers.analysis-form.spatial-markov-trend-time-columns-help'),
        editorAttrs: {
          showSearch: true
        }
      }
    };

    BaseAnalysisFormModel.prototype._setSchema.call(this, schema);
  }

});

},{"../column-options":879,"./base-analysis-form-model":820,"./spatial-markov-trend.tpl":872}],872:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<form>\n  <div class="Editor-HeaderInfo">\n    <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n    <div class="Editor-HeaderInfo-inner CDB-Text" data-fields="source,time_columns">\n      <div class="Editor-HeaderInfo-title u-bSpace--m">\n        <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('analyses.spatial-markov-trend.title') ))==null?'':_.escape(__t))+
'</h2>\n      </div>\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.layers.analysis-form.spatial-markov-trend-desc') ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n</form>\n\n';
}
return __p;
};

},{"underscore":"underscore"}],873:[function(require,module,exports){
var _ = require('underscore');
var BaseAnalysisFormModel = require('./base-analysis-form-model');

/**
 * A fallback form model in case the type is not supported (yet).
 */
module.exports = BaseAnalysisFormModel.extend({

  validate: function () {
    return true; // always fail, should not be able to save an unknown node
  },

  getTemplate: function () {
    return _.template('<form>Unknown analysis type <%- type %></form>');
  },

  getTemplateData: function () {
    return {type: this.get('type') || ''};
  },

  // Don't allow to update or create an unknown type
  updateNodeDefinition: function () {},
  createNodeDefinition: function () {}

});

},{"./base-analysis-form-model":820,"underscore":"underscore"}],874:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var TableStats = require('../../../../components/modals/add-widgets/tablestats');
var Utils = require('../../../../helpers/utils');
require('../../../../components/form-components/index');

var CHECK_FORM_VALIDATION_TOO = {validate: true};

/**
 * This view is required because a schema change require the Backbone.Form object to be re-created to update the view as expected.
 */
module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.formModel) throw new Error('formModel is required');
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;
    this._userModel = opts.userModel;
    this._formModel = opts.formModel;

    this.tableStats = new TableStats({
      configModel: this._configModel,
      userModel: this._userModel
    });

    this._formModel.on('changeSchema', this.render, this);
    this._formModel.on('generateHistogram', this._generateHistogram, this);
    this._formModel.on('change:histogram_stats', this._showHistogramStats, this);

    this.add_related_model(this._formModel);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    this._formView = new Backbone.Form({
      model: this._formModel,
      trackingClass: 'track-' + this._formModel.get('type') + '-analysis',
      template: this._formModel.getTemplate(),
      templateData: this._formModel.getTemplateData()
    });

    this._formView.bind('change', this._onChangeAnalysisFormView, this);
    this.$el.append(this._formView.render().el);

    return this;
  },

  _onChangeAnalysisFormView: function (data) {
    var formId = this._formView.cid;
    this._formView.model.setFormValidationErrors(undefined);
    var formValue = this._formView.getValue();
    this._formView.model.set(formValue); // <-- This can trigger change events and their callbacks will be run. That could provoke some 'race conditions'.
    this._showAnalysisFormErrors(formId); // To avoid race condition of running this function against a new form view.
  },

  _showAnalysisFormErrors: function (formId) {
    if (this._formView.cid === formId && this._formView.$el) {
      var formValidationErrors = this._formView.commit(CHECK_FORM_VALIDATION_TOO);
      this._formView.model.setFormValidationErrors(formValidationErrors);
    }
  },

  _generateHistogram: function (data) {
    this.tableStats.graphFor(data.tableName, data.columnName, this._drawHistogram.bind(this));
  },

  _showHistogramStats: function () {
    var stats = this._formModel.get('histogram_stats');

    if (!stats || !_.isNumber(stats.max) || !_.isNumber(stats.min)) {
      this.$('.js-histogram').hide();
      return;
    }

    var max = stats.max < 10000 ? Utils.formatNumber(stats.max) : Utils.readizableNumber(stats.max);
    var min = stats.min < 10000 ? Utils.formatNumber(stats.min) : Utils.readizableNumber(stats.min);

    this.$('.js-max').html(max);
    this.$('.js-min').html(min);
    this.$('.js-histogram').show();
  },

  _drawHistogram: function (graph) {
    var stats = this._formModel.get('histogram_stats');

    if (!stats || !_.isNumber(stats.max) || !_.isNumber(stats.min)) {
      return;
    }

    this.$('.js-histogramChart').html(graph.getHistogram({
      color: '#9DE0AD',
      width: 158,
      height: 20,
      bins: 20
    }));

    this._showHistogramStats();
  },

  /**
   * @override CoreView.prototype.clearSubViews
   */
  clearSubViews: function () {
    if (this._formView) {
      this._formView.remove(); // the Backbone.Form equivalent to "view.clean()"
    }

    return CoreView.prototype.clearSubViews.apply(this, arguments);
  }

});

},{"../../../../components/form-components/index":211,"../../../../components/modals/add-widgets/tablestats":394,"../../../../helpers/utils":1102,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],875:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var Analyses = require('../../../../data/analyses');

module.exports = Backbone.Collection.extend({

  initialize: function (models, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
    if (!opts.analysisSourceOptionsModel) throw new Error('analysisSourceOptionsModel is required');
    if (!opts.userActions) throw new Error('userActions is required');

    this._configModel = opts.configModel;
    this._layerDefinitionModel = opts.layerDefinitionModel;
    this._analysisSourceOptionsModel = opts.analysisSourceOptionsModel;
    this._userActions = opts.userActions;
  },

  model: function (attrs, opts) {
    var self = opts.collection;

    var FormModel = Analyses.findFormModelByType(attrs.type);

    return new FormModel(attrs, {
      configModel: self._configModel,
      analyses: Analyses,
      layerDefinitionModel: self._layerDefinitionModel,
      analysisSourceOptionsModel: self._analysisSourceOptionsModel,
      collection: self,
      parse: true
    });
  },

  resetByLayerDefinition: function () {
    var current = this._layerDefinitionModel.getAnalysisDefinitionNodeModel();
    if (current) {
      var attrsList = [];
      this._walkAnalysisChain(current, this._layerDefinitionModel, function (nodeDefModel) {
        var attrs = _.extend({persisted: true}, nodeDefModel.attributes);
        attrsList.push(attrs);
      });
      this.reset(attrsList);
    }
  },

  addHead: function (attrs) {
    this.remove(attrs.id); // if having the same id it's because the existing node is a temporary one,
    return this.add(attrs, {at: 0}); // so replace it with the new attrs
  },

  deleteNode: function (nodeId) {
    var nodeDefModel = this._layerDefinitionModel.findAnalysisDefinitionNodeModel(nodeId);
    if (nodeDefModel) {
      this._userActions.deleteAnalysisNode(nodeId);
    } else {
      this.remove(nodeId);
    }
  },

  _walkAnalysisChain: function (current, layerDefModel, visitorFn) {
    if (!current.hasPrimarySource()) return;

    visitorFn.call(this, current);

    var next = current.getPrimarySource();
    if (layerDefModel.isOwnerOfAnalysisNode(next)) {
      this._walkAnalysisChain(next, layerDefModel, visitorFn);
    }
  }
});

},{"../../../../data/analyses":599,"backbone":"backbone","underscore":"underscore"}],876:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var InfoboxView = require('../../../../components/infobox/infobox-view');
var checkAndBuildOpts = require('../../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'infoboxModel',
  'infoboxCollection'
];

module.exports = CoreView.extend({
  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initViews: function () {
    var view = new InfoboxView({
      infoboxModel: this._infoboxModel,
      infoboxCollection: this._infoboxCollection
    });
    this.addView(view);
    this.$el.append(view.render().el);
  }
});

},{"../../../../components/infobox/infobox-view":221,"../../../../helpers/required-opts":1097,"backbone/core-view":1127}],877:[function(require,module,exports){
var _ = require('underscore');
var queueAsync = require('queue-async');
var Backbone = require('backbone');
var analyses = require('../../../../data/analyses');

/**
 * Analysis source options are not trivial to get and requires some coordination of events.
 *
 * It's intended to be fetched
 */
module.exports = Backbone.Model.extend({

  defaults: {
    fetching: false,
    nodes_options: []
  },

  initialize: function (attrs, opts) {
    if (!opts.analysisDefinitionNodesCollection) throw new Error('analysisDefinitionNodesCollection is required');
    if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
    if (!opts.tablesCollection) throw new Error('tablesCollection is required');

    this._analysisDefinitionNodesCollection = opts.analysisDefinitionNodesCollection;
    this._layerDefinitionsCollection = opts.layerDefinitionsCollection;
    this._tablesCollection = opts.tablesCollection;
  },

  fetch: function () {
    this.set({
      fetching: true,
      nodes_options: []
    });

    var queue = queueAsync();

    this._fetchTables(queue);
    this._createOptionsFromNodes(queue);

    queue.awaitAll(function () {
      this.set('fetching', false);
    }.bind(this));
  },

  /**
   * @param {String, Array<String>} requiredSimpleGeometryTypes
   */
  getSelectOptions: function (requiredSimpleGeometryTypes) {
    if (this.get('fetching')) return [];

    if (_.isString(requiredSimpleGeometryTypes)) {
      requiredSimpleGeometryTypes = [requiredSimpleGeometryTypes];
    }

    return _.flatten([
      this.get('nodes_options')
        .filter(function (d) {
          return this._isValidGeometry(requiredSimpleGeometryTypes, d.simpleGeometryType);
        }, this)
        .map(function (d) {
          var node = this._analysisDefinitionNodesCollection.get(d.val);
          var layer = this._layerDefinitionsCollection.findOwnerOfAnalysisNode(node);

          return _.extend({
            layerName: layer && layer.getName(),
            nodeTitle: analyses.title(node),
            color: layer && layer.get('color'),
            type: 'node'
          }, d);
        }, this),
      this._getTablesSelectOptions(requiredSimpleGeometryTypes)
    ]);
  },

  /**
   * @param {String} val val from select option
   */
  createSourceNodeUnlessExisting: function (val) {
    var tableModel = this._tablesCollection.get(val);

    // If there is no table with given val as id, then it must be a layer source which already exist, so nothing to do
    if (tableModel) {
      var tableName = tableModel.get('name');
      this._analysisDefinitionNodesCollection.createSourceNode({
        id: tableName, // to avoid duplicats
        tableName: tableName
      });
    }
  },

  _isValidGeometry: function (requiredSimpleGeometryTypes, simpleGeometryType) {
    return _.contains(requiredSimpleGeometryTypes, simpleGeometryType) || requiredSimpleGeometryTypes[0] === '*';
  },

  _fetchTables: function (queue) {
    queue.defer(function (cb) {
      this._tablesCollection.fetch({
        data: {
          show_likes: false,
          show_liked: false,
          show_stats: false,
          show_table_size_and_row_count: false,
          show_permission: false,
          show_synchronization: false,
          show_uses_builder_features: false,
          load_totals: false,
          per_page: 1000
        }
      });
      this._tablesCollection.once('sync error', function () {
        cb();
      });
    }.bind(this));
  },

  _createOptionsFromNodes: function (queue) {
    var self = this;

    this._analysisDefinitionNodesCollection
      .each(function (nodeDefModel) {
        var queryGeometryModel = nodeDefModel.queryGeometryModel;

        queue.defer(function (cb) {
          if (queryGeometryModel.isFetched()) {
            self._appendNodeOption(nodeDefModel);
            return cb();
          }

          if (!queryGeometryModel.canFetch()) {
            return cb();
          }

          var onStatusChange = function () {
            if (queryGeometryModel.get('status') === 'fetching') return;
            queryGeometryModel.off('change:status', onStatusChange);
            self._appendNodeOption(nodeDefModel);
            cb();
          };
          queryGeometryModel.on('change:status', onStatusChange);
          queryGeometryModel.fetch();
        });
      });
  },

  _appendNodeOption: function (nodeDefModel) {
    var geom = nodeDefModel.queryGeometryModel.get('simple_geom');
    // If a node doesn't belong to a layer, we should not append it as a node option
    // It could be an intersection node, for example.
    var belongsToLayer = this._layerDefinitionsCollection.findOwnerOfAnalysisNode(nodeDefModel);

    if (!geom || !belongsToLayer) return;

    this.get('nodes_options')
      .push({
        simpleGeometryType: geom,
        val: nodeDefModel.id,
        label: nodeDefModel.id
      });
  },

  _getTablesSelectOptions: function (requiredSimpleGeometryTypes) {
    return this._tablesCollection.reduce(function (memo, m) {
      var simpleGeometryType = m.getGeometryType()[0];

      if (this._isValidGeometry(requiredSimpleGeometryTypes, simpleGeometryType)) {
        memo.push({
          val: m.id,
          label: m.get('name'),
          type: 'dataset'
        });
      }

      return memo;
    }, [], this);
  }

});

},{"../../../../data/analyses":599,"backbone":"backbone","queue-async":"queue-async","underscore":"underscore"}],878:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CDB = require('cartodb.js');
var queryTemplate = _.template('SELECT min(<%= column %>) as min, max(<%= column %>) as max FROM (<%= sql %>) _table_sql');

module.exports = Backbone.Model.extend({
  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel param is required');
    if (!opts.nodeDefModel) throw new Error('nodeDefModel param is required');

    this._nodeDefModel = opts.nodeDefModel;

    this._SQL = new CDB.SQL({
      user: opts.configModel.get('user_name'),
      sql_api_template: opts.configModel.get('sql_api_template'),
      api_key: opts.configModel.get('api_key')
    });

    this._query = opts.nodeDefModel.querySchemaModel.get('query');

    this.on('change:column', this.fetch, this);
  },

  _onQueryDone: function (r) {
    if (_.size(r.rows) > 0) {
      this.trigger('columnsFetched', _.first(r.rows));
    }
  },

  fetch: function () {
    if (this.get('column') && this._query) {
      this._SQL.execute(
        queryTemplate({
          sql: this._query,
          column: this.get('column')
        }),
        null,
        {
          extra_params: ['page', 'rows_per_page'],
          page: 0,
          rows_per_page: 40,
          success: this._onQueryDone.bind(this),
          error: function () {
            // TODO: what happens if fails?
          }
        }
      );
    }
  }
});

},{"backbone":"backbone","cartodb.js":"cartodb.js","underscore":"underscore"}],879:[function(require,module,exports){
var _ = require('underscore');
var CDB = require('cartodb.js');
var Backbone = require('backbone');
var tableQueryTemplate = _.template('SELECT * FROM <%= tableName %>');

module.exports = Backbone.Model.extend({
  defaults: {
    columnsFetched: false
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._columnOptions = [];

    this._SQL = new CDB.SQL({
      user: opts.configModel.get('user_name'),
      sql_api_template: opts.configModel.get('sql_api_template'),
      api_key: opts.configModel.get('api_key')
    });

    if (opts.nodeDefModel) {
      this.setNode(opts.nodeDefModel);
    }
  },

  _fetch: function () {
    if (this._query) {
      this.set('columnsFetched', false);
      this._SQL.execute(
        this._query,
        null,
        {
          extra_params: ['page', 'rows_per_page'],
          page: 0,
          rows_per_page: 40,
          success: this._onQueryDone.bind(this),
          error: function () {
            // TODO: what happens if fails?
          }
        }
      );
    }
  },

  setDataset: function (tableName) {
    this._columnOptions = [];
    this._query = tableQueryTemplate({ tableName: tableName });
    this._fetch();
  },

  setNode: function (nodeDefModel) {
    this._columnOptions = [];
    this._query = nodeDefModel.querySchemaModel.get('query');
    this._fetch();
  },

  findColumn: function (columnName, columnType) {
    return _.find(this.filterByType(columnType), function (column) {
      return column.val === columnName;
    }, this);
  },

  all: function () {
    return this.filterByType();
  },

  filterByType: function (columnType) {
    if (!_.size(this._columnOptions)) {
      return [];
    }

    var columns = _.map(this._columnOptions, function (value, key) {
      var columnName = key;
      return {
        val: columnName,
        label: columnName,
        type: value.type
      };
    });

    if (_.isArray(columnType)) {
      columns = columns.filter(function (column) {
        return _.contains(columnType, column.type);
      });
    } else if (columnType) {
      columns = columns.filter(function (column) {
        return column.type === columnType;
      });
    }
    return columns;
  },

  _onQueryDone: function (r) {
    this._columnOptions = r.fields;
    this.set('columnsFetched', true);
    this.trigger('columnsFetched');
  }
});

},{"backbone":"backbone","cartodb.js":"cartodb.js","underscore":"underscore"}],880:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var cdb = require('cartodb.js');

function getQueryForGeometryType (geometryType) {
  if (geometryType === 'polygon') {
    return "select * from obs_legacybuildermetadata('sum')";
  } else {
    return 'select * from obs_legacybuildermetadata()';
  }
}

/**
 * this class fetches information from observatory metadata
 */
module.exports = Backbone.Model.extend({
  initialize: function (attrs, opts) {
    this._configModel = opts.configModel;
    this._geometryType = opts.geometryType;
  },

  sync: function (method, model, options) {
    var sql = new cdb.SQL({
      user: this._configModel.get('user_name'),
      sql_api_template: this._configModel.get('sql_api_template'),
      api_key: this._configModel.get('api_key')
    });
    sql.execute(getQueryForGeometryType(this._geometryType)).done(function (data) {
      options.success && options.success(data);
    }).error(function (errors) {
      // console.log("errors:" + errors);
    });
  },

  setGeometryType: function (geometryType) {
    this._geometryType = geometryType;
  },

  parse: function (attrs) {
    var a = {};
    _.each(attrs.rows, function (r) {
      var sub = {};
      _.each(r.subsection, function (s) {
        var cols = {};
        _.each(s.f1.columns, function (c) {
          cols[c.f1.name] = c.f1.id;
        });
        sub[s.f1.name] = cols;
      });
      a[r.name] = sub;
    });
    return a;
  },

  measurement: function (area) {
    var subsection = this.get(area);
    if (subsection) {
      return _.keys(subsection);
    }
    return [];
  },

  columns: function (area, subsectionName) {
    var subsection = this.get(area);
    if (subsection) {
      return _.keys(subsection[subsectionName] || {});
    }
    return [];
  },

  segment: function (area, subsectionName, column) {
    var subsection = this.get(area);
    if (subsection) {
      return subsection[subsectionName][column];
    }
    return null;
  },

  areas: function () {
    return _.keys(this.attributes);
  }
});

},{"backbone":"backbone","cartodb.js":"cartodb.js","underscore":"underscore"}],881:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var ScrollView = require('../../../../components/scroll/scroll-view');
var ViewFactory = require('../../../../components/view-factory');
var analysisPlaceholderTemplate = require('../analyses/analyses-placeholder.tpl');
var analysisSQLErrorTemplate = require('../analyses/analyses-sql-error.tpl');
var AnalysisFormView = require('../analyses/analysis-form-view');
var AnalysesWorkflowView = require('../analyses/analyses-workflow-view');
var AnalysisControlsView = require('../analyses/analysis-controls-view');
var QuerySanity = require('../../query-sanity-check');
var actionErrorTemplate = require('../../sql-error-action.tpl');
var OverlayView = require('../../../components/overlay/overlay-view');
var AnalysesQuotaInfo = require('./analyses-quota/analyses-quota-info');

var STATES = {
  ready: 'ready',
  loading: 'loading',
  fetched: 'fetched',
  error: 'error'
};

/**
 * LayerContentAnalysesView:
 *   ├── ScrollView
 *   |   └── ListView:
 *   |       ├── WorkflowView
 *   |       └── FormTypeView
 *   └── ControlsView
 */
module.exports = CoreView.extend({

  options: {
    selectedNodeId: false // or an id, e.g. 'a1'
  },

  initialize: function (opts) {
    if (!opts.userActions) throw new Error('userActions is required');
    if (!opts.analysisFormsCollection) throw new Error('analysisFormsCollection is required');
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
    if (!opts.analysisDefinitionNodesCollection) throw new Error('analysisDefinitionNodesCollection is required');
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.stackLayoutModel) throw new Error('stackLayoutModel is required');
    if (!opts.overlayModel) throw new Error('overlayModel is required');

    this._userActions = opts.userActions;
    this._stackLayoutModel = opts.stackLayoutModel;
    this._userModel = opts.userModel;
    this._analysisFormsCollection = opts.analysisFormsCollection;
    this._layerDefinitionModel = opts.layerDefinitionModel;
    this._analysisDefinitionNodesCollection = opts.analysisDefinitionNodesCollection;
    this._configModel = opts.configModel;
    this._overlayModel = opts.overlayModel;

    this._viewModel = new Backbone.Model({selectedNodeId: this.options.selectedNodeId});
    this._querySchemaModel = this._layerDefinitionModel.getAnalysisDefinitionNodeModel().querySchemaModel;

    this._quotaInfo = AnalysesQuotaInfo.get(opts.configModel);

    this.modelView = new Backbone.Model({
      state: this._getInitialState()
    });

    this._initBinds();

    QuerySanity.track(this, this.render.bind(this));
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    if (this._hasError()) {
      this.$el.html(
        analysisSQLErrorTemplate({
          body: _t('editor.error-query.body', {
            action: actionErrorTemplate({
              label: _t('editor.error-query.label')
            })
          })
        })
      );
    } else {
      if (this._analysisFormsCollection.isEmpty()) {
        this.$el.html(analysisPlaceholderTemplate());
      } else {
        var formModel = this._formModel();
        this._renderScrollableListView(formModel);
        this._renderControlsView(formModel);
      }
    }
    this._renderOverlay();
    return this;
  },

  clean: function () {
    CoreView.prototype.clean.apply(this);
    this._selectedNodeId(null, {silent: true});
  },

  _renderOverlay: function () {
    var view = new OverlayView({
      overlayModel: this._overlayModel
    });
    this.addView(view);
    this.$el.append(view.render().el);
  },

  _getInitialState: function () {
    return STATES.loading;
  },

  _hasError: function () {
    return this.modelView.get('state') === STATES.error;
  },

  _initBinds: function () {
    // Init listeners
    this._viewModel.on('change:selectedNodeId', this.render, this);
    this.add_related_model(this._viewModel);

    this._layerDefinitionModel.on('change:source', this._onLayerDefSourceChanged, this);
    this.add_related_model(this._layerDefinitionModel);

    this._analysisFormsCollection.on('add', this._onFormModelAdded, this);
    this._analysisFormsCollection.on('remove', this._onFormModelRemoved, this);
    this.add_related_model(this._analysisFormsCollection);
  },

  _renderScrollableListView: function (formModel) {
    var self = this;

    var view = new ScrollView({
      createContentView: function () {
        return ViewFactory.createListView([
          function () {
            return new AnalysesWorkflowView({
              analysisDefinitionNodesCollection: self._analysisDefinitionNodesCollection,
              layerDefinitionModel: self._layerDefinitionModel,
              analysisFormsCollection: self._analysisFormsCollection,
              viewModel: self._viewModel
            });
          },
          function () {
            return new AnalysisFormView({
              formModel: formModel,
              configModel: self._configModel,
              userModel: self._userModel
            });
          }
        ]);
      }
    });
    this.$el.append(view.render().el);
    this.addView(view);
  },

  _renderControlsView: function (formModel) {
    var analysisNode = this._analysisDefinitionNodesCollection.get(formModel.id);

    var view = new AnalysisControlsView({
      configModel: this._configModel,
      analysisNode: analysisNode,
      userActions: this._userActions,
      userModel: this._userModel,
      stackLayoutModel: this._stackLayoutModel,
      formModel: formModel,
      quotaInfo: this._quotaInfo,
      querySchemaModel: this._getQuerySchemaModelForEstimation()
    });
    this.addView(view);
    this.$el.append(view.render().el);
  },

  _formModel: function () {
    return this._analysisFormsCollection.get(this._selectedNodeId()) || this._analysisFormsCollection.first();
  },

  _getQuerySchemaModelForEstimation: function () {
    var node = this._analysisDefinitionNodesCollection.get(this._selectedNodeId());
    var index;

    if (!node) {
      node = this._layerDefinitionModel.getAnalysisDefinitionNodeModel();
    } else {
      index = this._analysisDefinitionNodesCollection.indexOf(node);
      node = this._analysisDefinitionNodesCollection.at(index - 1);
    }

    return node.querySchemaModel;
  },

  _selectedNodeId: function (id, options) {
    if (!this._viewModel) {
      return;
    }

    if (id === undefined) {
      return this._viewModel.get('selectedNodeId');
    } else {
      this._viewModel.set('selectedNodeId', id, options);
    }
  },

  _onLayerDefSourceChanged: function () {
    // When reset, the parent view is rendered again, creating a new instance of this one
    // calling here this._renderWithDefaultNodeSelected(); will cause a race condition
    // ending up in two instance of this being rendered
    this._analysisFormsCollection.resetByLayerDefinition();
  },

  _onFormModelAdded: function () {
    this._renderWithDefaultNodeSelected();
  },

  _onFormModelRemoved: function () {
    this._renderWithDefaultNodeSelected();
  },

  _renderWithDefaultNodeSelected: function () {
    var selectedNodeId = this._analysisFormsCollection.pluck('id')[0];
    this._selectedNodeId(selectedNodeId, {silent: true});
    this.render();
  }

});

},{"../../../../components/scroll/scroll-view":530,"../../../../components/view-factory":594,"../../../components/overlay/overlay-view":694,"../../query-sanity-check":997,"../../sql-error-action.tpl":1000,"../analyses/analyses-placeholder.tpl":793,"../analyses/analyses-sql-error.tpl":801,"../analyses/analyses-workflow-view":807,"../analyses/analysis-controls-view":810,"../analyses/analysis-form-view":874,"./analyses-quota/analyses-quota-info":796,"backbone":"backbone","backbone/core-view":1127}],882:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-content js-content"></div>\n<div class="js-info"></div>';
}
return __p;
};

},{"underscore":"underscore"}],883:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="CodeMirror-error">\n  <li class="CodeMirror-errorMessage u-lSpace--xl u-rSpace--xl">\n    '+
((__t=( _t('components.codemirror.syntax-error') ))==null?'':_.escape(__t))+
': <span>'+
((__t=( message ))==null?'':_.escape(__t))+
'</span>\n  </li>\n  <li class="CodeMirror-errorDocs">\n    <a href="https://carto.com/docs/carto-engine/sql-api/" target="_black">'+
((__t=( _t('components.codemirror.docs') ))==null?'':_.escape(__t))+
'</a>\n  </li>\n</ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],884:[function(require,module,exports){
var _ = require('underscore');

var BLACKLISTED_COLUMNS = ['created_at', 'the_geom', 'the_geom_webmercator', 'updated_at'];

module.exports = function (nodeDefModel, layerDefinitionModel) {
  var tuplesItems = {};

  if (!layerDefinitionModel) return tuplesItems; // e.g. if the node is one of those temporary tables

  var querySchemaModel = nodeDefModel.querySchemaModel;
  if (!querySchemaModel) return tuplesItems;

  querySchemaModel.columnsCollection.each(function (m) {
    var columnName = m.get('name');

    if (!_.contains(BLACKLISTED_COLUMNS, columnName)) {
      var key = columnName + '-' + m.get('type');
      var tuples = tuplesItems[key] = tuplesItems[key] || [];
      tuples.push({
        analysisDefinitionNodeModel: nodeDefModel,
        layerDefinitionModel: layerDefinitionModel,
        columnModel: m
      });
    }
  });

  return tuplesItems;
};

},{"underscore":"underscore"}],885:[function(require,module,exports){
var $ = require('jquery');
var Backbone = require('backbone');
var createTuplesItems = require('./create-tuples-items');
var widgetsTypes = require('./widgets-types');

module.exports = Backbone.Model.extend({
  defaults: {
    render: false
  },

  initialize: function (attrs, opts) {
    if (!opts.layerDefinitionModel) { throw new Error('layerDefinitionModel is required'); }
    if (!opts.widgetDefinitionsCollection) { throw new Error('widgetDefinitionsCollection is required'); }
    if (!opts.tableStats) { throw new Error('tablestats is required'); }

    this._layerDefinitionModel = opts.layerDefinitionModel;
    this._analysisDefinitionNode = this._layerDefinitionModel.getAnalysisDefinitionNodeModel();
    this._widgetDefinitionsCollection = opts.widgetDefinitionsCollection;
    this._tableStats = opts.tableStats;
    this._columnsCollection = new Backbone.Collection();
  },

  getCollection: function () {
    return this._columnsCollection;
  },

  createColumnCollection: function () {
    var tuplesItems = createTuplesItems(this._analysisDefinitionNode, this._layerDefinitionModel);
    var models = widgetsTypes(tuplesItems);
    this._columnsCollection.reset(models);
    this._generateGraphs();
  },

  _generateGraphs: function () {
    var self = this;

    var promises = this._columnsCollection.map(function (stat) {
      var table = stat.get('table');
      var column = stat.get('name');
      var deferred = new $.Deferred();

      self._locateWidget(stat);

      self._tableStats.graphFor(table, column, function (graph) {
        if (graph.stats) {
          stat.set({graph: graph});
        }
        deferred.resolve();
      });

      return deferred.promise();
    }, this);

    $.when.apply($, promises).done(function () {
      self.set({render: self._columnsCollection.length > 0});
    });
  },

  findWidget: function (model) {
    var type = model.get('type');
    var column = model.get('name');

    return this._widgetDefinitionsCollection.findWhere({
      type: type,
      source: model.analysisDefinitionNodeModel().id,
      column: column
    });
  },

  _locateWidget: function (model) {
    var widget = this.findWidget(model);

    if (widget) {
      model.set({
        selected: true,
        widget: widget
      }, {silent: true});
    }
  },

  getColumnsWithWidgetAndGraph: function () {
    return this._columnsCollection.filter(function (model) {
      return !!model.get('widget') && !!model.get('graph');
    });
  },

  getColumnsWithWidget: function () {
    return this._columnsCollection.filter(function (model) {
      return !!model.get('widget') && !model.get('graph');
    });
  },

  getColumnsWithGraph: function () {
    return this._columnsCollection.filter(function (model) {
      return !!model.get('graph') && !model.get('widget');
    });
  },

  getColumnsWithoutGraph: function () {
    return this._columnsCollection.filter(function (model) {
      return !model.get('graph') && !model.get('widget');
    });
  }
});

},{"./create-tuples-items":884,"./widgets-types":897,"backbone":"backbone","jquery":"jquery"}],886:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h2 class="CDB-Text CDB-Size-huge is-light u-secondaryTextColor">\n  '+
((__t=( body ))==null?'':__t)+
'\n</h2>';
}
return __p;
};

},{"underscore":"underscore"}],887:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (renderLoading) { 
__p+='\n<div class="Data-loaderContainer">\n  <div class="CDB-Loader is-visible"></div>\n</div>\n';
 } 
__p+='\n\n<div class="FormPlaceholder-paragraph u-tSpace-m u-flex">\n  <div class="FormPlaceholder-step u-rSpace--m"></div>\n  <div class="FormPlaceholder-inner">\n    <span class="FormPlaceholder-label FormPlaceholder-size--med u-tSpace-xl"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--med u-tSpace-xl"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--med"></span>\n    <span class="FormPlaceholder-label FormPlaceholder-size--short u-tSpace-xl"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--long u-tSpace-xl"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--long"></span>\n  </div>\n</div>\n\n<div class="FormPlaceholder-paragraph u-tSpace-m u-flex">\n  <div class="FormPlaceholder-step u-rSpace--m"></div>\n  <div class="FormPlaceholder-inner">\n    <span class="FormPlaceholder-label FormPlaceholder-size--med u-tSpace-xl"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--med u-tSpace-xl"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--med"></span>\n    <span class="FormPlaceholder-label FormPlaceholder-size--short u-tSpace-xl"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--long u-tSpace-xl"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--long"></span>\n  </div>\n</div>\n\n<div class="FormPlaceholder-paragraph u-tSpace-m u-flex">\n  <div class="FormPlaceholder-step u-rSpace--m"></div>\n  <div class="FormPlaceholder-inner">\n    <span class="FormPlaceholder-label FormPlaceholder-size--med u-tSpace-xl"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--med u-tSpace-xl"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--med"></span>\n    <span class="FormPlaceholder-label FormPlaceholder-size--short u-tSpace-xl"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--long u-tSpace-xl"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--long"></span>\n  </div>\n</div>\n\n<div class="FormPlaceholder-paragraph u-tSpace-m u-flex">\n  <div class="FormPlaceholder-step u-rSpace--m"></div>\n  <div class="FormPlaceholder-inner">\n    <span class="FormPlaceholder-label FormPlaceholder-size--med u-tSpace-xl"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--med u-tSpace-xl"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--med"></span>\n    <span class="FormPlaceholder-label FormPlaceholder-size--short u-tSpace-xl"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--long u-tSpace-xl"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--long"></span>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],888:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var StatView = require('./stat-view');
var dataNotReadyTemplate = require('./data-content-not-ready.tpl');
var dataErrorTemplate = require('./data-content-error.tpl');
var actionErrorTemplate = require('../../sql-error-action.tpl');
var QuerySanity = require('../../query-sanity-check');
var OverlayView = require('../../../components/overlay/overlay-view');
var checkAndBuildOpts = require('../../../../helpers/required-opts');

var STATES = {
  ready: 'ready',
  loading: 'loading',
  nogeometry: 'no-geometry',
  error: 'error'
};

var REQUIRED_OPTS = [
  'columnsModel',
  'infoboxModel',
  'overlayModel',
  'queryGeometryModel',
  'querySchemaModel',
  'stackLayoutModel',
  'userActions',
  'widgetDefinitionsCollection'
];

module.exports = CoreView.extend({
  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._columnsCollection = this._columnsModel.getCollection();

    this.modelView = new Backbone.Model({
      state: this._getInitialState(),
      renderLoading: true
    });

    this._initBinds();
    QuerySanity.track(this, this.render.bind(this));
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    if (this._hasError()) {
      this._showError();
    } else if (this._hasNoGeometryData()) {
      this._showNoGeometryData();
    } else if (this._isLoading()) {
      this._showLoading();
    } else if (this._isReady()) {
      this._renderStats();
    }

    this._renderOverlay();
    return this;
  },

  _renderOverlay: function () {
    var view = new OverlayView({
      overlayModel: this._overlayModel
    });
    this.addView(view);
    this.$el.append(view.render().el);
  },

  _showLoading: function () {
    this.$el.empty();
    this.$el.append(
      dataNotReadyTemplate({
        renderLoading: this.modelView.get('renderLoading')
      })
    );
  },

  _showError: function () {
    this.$el.append(
      dataErrorTemplate({
        body: _t('editor.error-query.body', {
          action: actionErrorTemplate({
            label: _t('editor.error-query.label')
          })
        })
      })
    );
  },

  _showNoGeometryData: function () {
    this.$el.append(
      dataErrorTemplate({
        body: _t('editor.data.no-geometry-data')
      })
    );
  },

  _getInitialState: function () {
    return this._columnsReady() ? STATES.ready : STATES.loading;
  },

  _hasError: function () {
    return this.modelView.get('state') === STATES.error;
  },

  _isLoading: function () {
    return this.modelView.get('state') === STATES.loading;
  },

  _isReady: function () {
    return this.modelView.get('state') === STATES.ready;
  },

  _columnsReady: function () {
    return this._columnsModel.get('render') === true;
  },

  _hasNoGeometryData: function () {
    return this.modelView.get('state') === STATES.nogeometry;
  },

  _initBinds: function () {
    this.listenTo(this.modelView, 'change:state', this.render);
    this.listenTo(this._queryGeometryModel, 'change:status', this._checkGeometry);
    this.listenTo(this._queryGeometryModel, 'change:simple_geom', this.render);
    this.listenTo(this._columnsModel, 'change:render', this._handleStats);
    this.listenTo(this._columnsCollection, 'change:selected', this._handleWidget);
  },

  _checkGeometry: function (m, status) {
    var hasGeometryData;
    if (status === 'fetched') {
      hasGeometryData = this._queryGeometryModel.hasValue();
      !hasGeometryData && this.modelView.set({state: STATES.nogeometry});
    }
  },

  _handleWidget: function (model) {
    var m, candidate;
    if (model.get('selected') === true) {
      candidate = this._columnsModel.findWidget(model);
      if (!candidate) {
        m = this._userActions.saveWidgetOption(model);
        model.set({widget: m});

        // uncheck previous date column
        if (model.get('type') === 'time-series') {
          this._normalizeTimeSeriesColumn(model);
        }
      } else {
        model.set({widget: candidate});
      }
    } else {
      m = model.get('widget');
      m && m.destroy();
    }
  },

  _normalizeTimeSeriesColumn: function (lastModel) {
    var existingDefModel = this._columnsCollection.findWhere(function (m) {
      return m.get('type') === 'time-series' && m.get('selected') === true && m.cid !== lastModel.cid;
    });

    existingDefModel && existingDefModel.set({
      selected: false,
      widget: null
    });
  },

  _handleStats: function () {
    if (this._columnsReady()) {
      // we force render because the state could be ready already
      this.modelView.set({
        state: STATES.ready,
        renderLoading: true
      }, {
        silent: true
      });
      this.render();
    } else {
      // if there are not stats, we hide loading and show placeholder
      this.modelView.set({
        state: STATES.loading,
        renderLoading: false
      });
    }
  },

  _renderStats: function () {
    if (!this._columnsReady()) {
      return;
    }
    var withWidgetAndGraph = this._columnsModel.getColumnsWithWidgetAndGraph();
    var withWidget = this._columnsModel.getColumnsWithWidget();
    var withGraph = this._columnsModel.getColumnsWithGraph();
    var withoutGraph = this._columnsModel.getColumnsWithoutGraph();
    var all;
    if (withWidgetAndGraph.length === 0 && withWidget.length === 0 &&
      withGraph.length === 0 && withoutGraph.length === 0) {
      this._infoboxModel.set({
        state: 'no-data',
        renderLoading: false
      });
      this._showLoading();
    } else {
      this.$el.empty();
      all = _.union(withWidgetAndGraph, withWidget, withGraph, withoutGraph);
      this._renderColumns(all);
    }
  },

  _renderColumns: function (stats) {
    _.each(stats, function (stat, index) {
      var view = new StatView({
        stackLayoutModel: this._stackLayoutModel,
        statModel: stat
      });

      this.addView(view);
      this.$el.append(view.render().el);
    }, this);
  }
});

},{"../../../../helpers/required-opts":1097,"../../../components/overlay/overlay-view":694,"../../query-sanity-check":997,"../../sql-error-action.tpl":1000,"./data-content-error.tpl":886,"./data-content-not-ready.tpl":887,"./stat-view":895,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],889:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var UndoManager = require('../../../../data/undo-manager.js');

/**
 *  Data SQL Undo-redo model
 */
module.exports = Backbone.Model.extend({

  defaults: {
    content: ''
  },

  initialize: function (attrs, opts) {
    this._history = this._generateHistory(opts && opts.history);

    UndoManager.init(this, {
      track: true,
      history: this._history
    });
  },

  _generateHistory: function (history) {
    if (history && history.length) {
      var data = _.reduce(history, function (memo, sql) {
        memo.push({
          content: sql
        });
        return memo;
      }, [], this);
      return data;
    }

    return false;
  },

  getHistory: function () {
    return _.pluck(
      this.getUndoHistory(),
      'content'
    );
  }
});

},{"../../../../data/undo-manager.js":667,"backbone":"backbone","underscore":"underscore"}],890:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var CodeMirrorView = require('../../../../components/code-mirror/code-mirror-view');
var ErrorTemplate = require('./code-mirror-error.tpl');
var FactoryHints = require('../../../editor-hints/factory-hints');
var SQLHints = require('../../../editor-hints/sql-hints');

module.exports = CoreView.extend({

  className: 'Editor-dataContentSQL Editor-content',

  initialize: function (opts) {
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
    if (!opts.querySchemaModel) throw new Error('querySchemaModel is required');
    if (!opts.codemirrorModel) throw new Error('codemirrorModel is required');
    if (!opts.onApplyEvent) throw new Error('onApplyEvent');

    this._layerDefinitionModel = opts.layerDefinitionModel;
    this._querySchemaModel = opts.querySchemaModel;
    this._codemirrorModel = opts.codemirrorModel;

    this._initBinds();

    FactoryHints.init({
      querySchemaModel: this._querySchemaModel,
      layerDefinitionModel: this._layerDefinitionModel,
      tokens: SQLHints
    });
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this._querySchemaModel.on('change:query', this._onQueryChanged, this);
    this.add_related_model(this._querySchemaModel);
  },

  _onQueryChanged: function (mdl, status) {
    if (status === 'fetched') {
      this.codeMirrorView.updateHints(SQLHints.reset().hints);
    }
  },

  _initViews: function () {
    var hints = FactoryHints.reset().hints;
    this.codeMirrorView = new CodeMirrorView({
      model: this._codemirrorModel,
      hints: hints,
      mode: 'text/x-pgsql',
      tip: _t('editor.data.code-mirror.tip'),
      errorTemplate: ErrorTemplate
    });

    this.codeMirrorView.bind('codeSaved', this._triggerCodeSaved, this);
    this.addView(this.codeMirrorView);
    this.$el.append(this.codeMirrorView.render().el);
  },

  _updateEditorContent: function () {
    this.codeMirrorView.setContent(this._layerDefinitionModel.get('sql'));
  },

  _triggerCodeSaved: function (code, view) {
    this.options.onApplyEvent && this.options.onApplyEvent();
  }
});

},{"../../../../components/code-mirror/code-mirror-view":27,"../../../editor-hints/factory-hints":700,"../../../editor-hints/sql-hints":701,"./code-mirror-error.tpl":883,"backbone/core-view":1127}],891:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var PanelWithOptionsView = require('../../../../components/view-options/panel-with-options-view');
var ScrollView = require('../../../../components/scroll/scroll-view');
var DatasetBaseView = require('../../../../components/dataset/dataset-base-view');
var DataContentView = require('./data-content-view');
var DataSQLView = require('./data-sql-view');
var TabPaneView = require('../../../../components/tab-pane/tab-pane-view');
var TabPaneCollection = require('../../../../components/tab-pane/tab-pane-collection');
var Toggler = require('../../../../components/toggler/toggler-view');
var UndoButtons = require('../../../../components/undo-redo/undo-redo-view');
var Infobox = require('../../../../components/infobox/infobox-factory');
var InfoboxModel = require('../../../../components/infobox/infobox-model');
var InfoboxCollection = require('../../../../components/infobox/infobox-collection');
var TableStats = require('../../../../components/modals/add-widgets/tablestats');
var DataColumnsModel = require('./data-columns-model');
var SQLNotifications = require('../../../../sql-notifications');
var MetricsTracker = require('../../../../components/metrics/metrics-tracker');
var OnboardingLauncher = require('../../../../components/onboardings/generic/generic-onboarding-launcher');
var OnboardingView = require('../../../../components/onboardings/layers/data-onboarding/data-onboarding-view');
var layerOnboardingKey = require('../../../../components/onboardings/layers/layer-onboarding-key');
var checkAndBuildOpts = require('../../../../helpers/required-opts');
var AnalysesService = require('../analyses/analyses-service.js');

var REQUIRED_OPTS = [
  'widgetDefinitionsCollection',
  'stackLayoutModel',
  'userActions',
  'layerDefinitionModel',
  'userModel',
  'onboardings',
  'onboardingNotification'
];

module.exports = DatasetBaseView.extend({

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this._nodeModel = opts.layerDefinitionModel.getAnalysisDefinitionNodeModel();
    this._querySchemaModel = this._nodeModel.querySchemaModel;
    this._queryGeometryModel = this._nodeModel.queryGeometryModel;

    DatasetBaseView.prototype.initialize.call(this, {
      layerDefinitionModel: opts.layerDefinitionModel,
      editorModel: opts.editorModel,
      configModel: opts.configModel,
      querySchemaModel: this._querySchemaModel
    });

    var canBeGeoreferenced = this._layerDefinitionModel.canBeGeoreferenced() ? 'georeference' : '';

    this._infoboxModel = new InfoboxModel({
      state: this._isLayerHidden() ? 'layer-hidden' : canBeGeoreferenced
    });

    this._overlayModel = new Backbone.Model({
      visible: this._isLayerHidden()
    });

    this._tableStats = new TableStats({
      configModel: this._configModel,
      userModel: this._userModel
    });

    this._columnsModel = new DataColumnsModel({}, {
      layerDefinitionModel: this._layerDefinitionModel,
      widgetDefinitionsCollection: this._widgetDefinitionsCollection,
      tableStats: this._tableStats
    });

    SQLNotifications.track(this);

    this._parseSQL = this._internalParseSQL.bind(this, this._afterAlterDataSuccess);

    this._onboardingLauncher = new OnboardingLauncher({
      view: OnboardingView,
      onboardingNotification: this._onboardingNotification,
      notificationKey: layerOnboardingKey,
      onboardings: this._onboardings
    }, {
      editorModel: this._editorModel,
      selector: 'LayerOnboarding'
    });

    this._configPanes();
    this._initBinds();
    this._initData();
  },

  render: function () {
    this._launchOnboarding();
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _launchOnboarding: function () {
    if (this._onboardingNotification.getKey(layerOnboardingKey)) {
      return;
    }

    if (!this._editorModel.isEditing()) {
      this._onboardingLauncher.launch({
        numberOfWidgets: this._widgetDefinitionsCollection.length,
        hasTimeSeries: this._widgetDefinitionsCollection.isThereTimeSeries(),
        hasAnimatedTimeSeries: this._widgetDefinitionsCollection.isThereTimeSeries({ animated: true })
      });
    }
  },

  _initData: function () {
    if (this._hasFetchedQuerySchema()) {
      this._onQuerySchemaStatusChange();
    }
  },

  _redirectIfErrors: function () {
    var errors = this._querySchemaModel.get('query_errors');
    if (errors && errors.length > 0) {
      this._showErrors();
      this._editorModel.set({
        edition: true
      });
    }
  },

  _onQuerySchemaChange: function () {
    if (this._hasFetchedQuerySchema()) {
      this._codemirrorModel.set({content: this._querySchemaModel.get('query')});
    }
  },

  _onQuerySchemaStatusChange: function () {
    if (this._hasFetchedQuerySchema()) {
      this._columnsModel.createColumnCollection();
    }
  },

  _hasFetchedQuerySchema: function () {
    return this._querySchemaModel.isFetched();
  },

  _initBinds: function () {
    this.listenTo(this._editorModel, 'change:edition', this._onChangeEdition);

    this.listenTo(this._querySchemaModel, 'change:query', this._onQuerySchemaChange);
    this.listenTo(this._querySchemaModel, 'change:status', this._onQuerySchemaStatusChange);
    this.listenTo(this._querySchemaModel, 'change:query_errors', this._showErrors);

    this.listenTo(this._sqlModel, 'undo redo', function () {
      this._codemirrorModel.set('content', this._sqlModel.get('content'));
    }.bind(this));

    this.listenTo(this._layerDefinitionModel, 'change:visible', this._infoboxState);
  },

  _runQuery: function (query, callback) {
    this._querySchemaModel.set({
      query: query,
      status: 'unfetched'
    });

    this._queryGeometryModel.set({
      query: query
    });

    SQLNotifications.showNotification({
      status: 'loading',
      info: _t('notifications.sql.applying'),
      closable: false
    });

    var saveSQL = _.after(2, callback);
    this._querySchemaModel.fetch({ success: saveSQL });
    this._queryGeometryModel.fetch({ complete: saveSQL });
  },

  _saveSQL: function () {
    var query = this._codemirrorModel.get('content');

    this._sqlModel.set('content', query);
    this._userActions.saveAnalysisSourceQuery(query, this._nodeModel, this._layerDefinitionModel);
    this._querySchemaModel.set('query_errors', []);

    SQLNotifications.showNotification({
      status: 'success',
      info: _t('notifications.sql.success'),
      closable: true
    });

    this._checkClearButton();

    MetricsTracker.track('Applied sql', {
      node_id: this._nodeModel.get('id'),
      sql: this._nodeModel.get('query')
    });
  },

  _isQueryAlreadyApplied: function (query) {
    var history = this._sqlModel.getUndoHistory();
    var last = _.last(history);
    return last && last.content && last.content.toLowerCase() === query.toLowerCase();
  },

  _updateVisNotification: function () {
    SQLNotifications.showNotification({
      status: 'success',
      info: _t('notifications.sql.success'),
      closable: true
    });
  },

  _defaultSQL: function () {
    return this._nodeModel.getDefaultQuery();
  },

  _afterAlterDataSuccess: function () {
    var originalQuery = this._defaultSQL();
    this._userActions.saveAnalysisSourceQuery(originalQuery, this._nodeModel, this._layerDefinitionModel);
  },

  _hasAnalysisApplied: function () {
    return this._nodeModel.get('type') !== 'source';
  },

  _onChangeEdition: function () {
    this._infoboxState();

    var edition = this._editorModel.get('edition');
    var index = edition ? 1 : 0;
    this._collectionPane.at(index).set({ selected: true });
  },

  _configPanes: function () {
    var self = this;
    var tabPaneTabs = [{
      selected: !this._editorModel.get('edition'),
      createContentView: function () {
        return new ScrollView({
          createContentView: function () {
            return new DataContentView({
              className: 'Editor-content',
              stackLayoutModel: self._stackLayoutModel,
              widgetDefinitionsCollection: self._widgetDefinitionsCollection,
              columnsModel: self._columnsModel,
              querySchemaModel: self._querySchemaModel,
              queryGeometryModel: self._queryGeometryModel,
              userActions: self._userActions,
              infoboxModel: self._infoboxModel,
              overlayModel: self._overlayModel
            });
          }
        });
      },
      createActionView: function () {
        return new CoreView();
      }
    }, {
      selected: this._editorModel.get('edition'),
      createContentView: function () {
        return new DataSQLView({
          layerDefinitionModel: self._layerDefinitionModel,
          querySchemaModel: self._querySchemaModel,
          codemirrorModel: self._codemirrorModel,
          onApplyEvent: self._parseSQL
        });
      },
      createActionView: function () {
        var isAnalysis = self._hasAnalysisApplied();
        if (!isAnalysis) {
          self._checkClearButton();
          return new UndoButtons({
            trackModel: self._sqlModel,
            editorModel: self._editorModel,
            clearModel: self._clearSQLModel,
            applyButton: true,
            clearButton: true,
            onApplyClick: self._parseSQL,
            onClearClick: self._clearSQL.bind(self)
          });
        }
      }
    }];

    this._collectionPane = new TabPaneCollection(tabPaneTabs);
  },

  _confirmReadOnly: function () {
    this._infoboxModel.set({state: ''});
  },

  _initViews: function () {
    var self = this;

    var infoboxSstates = [
      {
        state: 'georeference',
        createContentView: function () {
          var name = this._layerDefinitionModel ? this._layerDefinitionModel.getTableName() : '';
          var body = [_t('editor.tab-pane.layers.georeference.body', { name: name }),
                      _t('editor.layers.georeference.manually-add')].join(' ');

          return Infobox.createWithAction({
            type: 'alert',
            title: _t('editor.tab-pane.layers.georeference.title'),
            body: body,
            mainAction: {
              label: _t('editor.layers.georeference.georeference-button')
            }
          });
        },
        mainAction: self._onGeoreferenceClicked.bind(self)
      }, {
        state: 'readonly',
        createContentView: function () {
          return Infobox.createWithAction({
            type: 'code',
            title: _t('editor.data.messages.sql-readonly.title'),
            body: _t('editor.data.messages.sql-readonly.body'),
            mainAction: {
              label: _t('editor.data.messages.sql-readonly.accept')
            }
          });
        },
        mainAction: self._confirmReadOnly.bind(self)
      }, {
        state: 'layer-hidden',
        createContentView: function () {
          return Infobox.createWithAction({
            type: 'alert',
            title: _t('editor.style.messages.layer-hidden.title'),
            body: _t('editor.style.messages.layer-hidden.body'),
            mainAction: {
              label: _t('editor.style.messages.layer-hidden.show')
            }
          });
        },
        mainAction: self._showHiddenLayer.bind(self)
      }, {
        state: 'no-data',
        createContentView: function () {
          return Infobox.createInfo({
            type: 'alert',
            title: _t('editor.data.messages.empty-data.title'),
            body: _t('editor.data.messages.empty-data.body')
          });
        }
      }
    ];

    var infoboxCollection = new InfoboxCollection(infoboxSstates);

    var panelWithOptionsView = new PanelWithOptionsView({
      className: 'Editor-content',
      editorModel: self._editorModel,
      infoboxModel: self._infoboxModel,
      infoboxCollection: infoboxCollection,
      createContentView: function () {
        return new TabPaneView({
          collection: self._collectionPane
        });
      },
      createControlView: function () {
        return new Toggler({
          editorModel: self._editorModel,
          labels: [_t('editor.data.data-toggle.values'), _t('editor.data.data-toggle.cartocss')]
        });
      },
      createActionView: function () {
        return new TabPaneView({
          collection: self._collectionPane,
          createContentKey: 'createActionView'
        });
      }
    });

    this.$el.append(panelWithOptionsView.render().el);
    this.addView(panelWithOptionsView);

    // TOFIX
    // If there are errors in the SQL, open the sql editor by default
    // we defer it to not interfere with the high order tabpane item selection
    setTimeout(this._redirectIfErrors.bind(this), 0);
  },

  _infoboxState: function () {
    var edition = this._editorModel.get('edition');
    var isAnalysis = this._hasAnalysisApplied();

    if (edition && isAnalysis) {
      this._codemirrorModel.set({readonly: true});
      this._infoboxModel.set({state: 'readonly'});
    } else if (!edition && this._isLayerHidden()) {
      this._infoboxModel.set({state: 'layer-hidden'});
      this._overlayModel.set({visible: true});
    } else if (!edition && this._layerDefinitionModel.canBeGeoreferenced()) {
      this._infoboxModel.set({state: 'georeference'});
      this._overlayModel.set({visible: false});
    } else {
      this._codemirrorModel.set({readonly: false});
      this._infoboxModel.set({state: ''});
      this._overlayModel.set({visible: false});
    }
  },

  _showHiddenLayer: function () {
    var savingOptions = {
      shouldPreserveAutoStyle: true
    };
    this._layerDefinitionModel.toggleVisible();
    this._userActions.saveLayer(this._layerDefinitionModel, savingOptions);
  },

  _isLayerHidden: function () {
    return this._layerDefinitionModel.get('visible') === false;
  },

  _onGeoreferenceClicked: function () {
    AnalysesService.addGeoreferenceAnalysis();
  }
});

},{"../../../../components/dataset/dataset-base-view":60,"../../../../components/infobox/infobox-collection":215,"../../../../components/infobox/infobox-factory":216,"../../../../components/infobox/infobox-model":219,"../../../../components/metrics/metrics-tracker":233,"../../../../components/modals/add-widgets/tablestats":394,"../../../../components/onboardings/generic/generic-onboarding-launcher":501,"../../../../components/onboardings/layers/data-onboarding/data-onboarding-view":505,"../../../../components/onboardings/layers/layer-onboarding-key":507,"../../../../components/scroll/scroll-view":530,"../../../../components/tab-pane/tab-pane-collection":538,"../../../../components/tab-pane/tab-pane-view":549,"../../../../components/toggler/toggler-view":590,"../../../../components/undo-redo/undo-redo-view":592,"../../../../components/view-options/panel-with-options-view":595,"../../../../helpers/required-opts":1097,"../../../../sql-notifications":1118,"../analyses/analyses-service.js":800,"./data-columns-model":885,"./data-content-view":888,"./data-sql-view":890,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],892:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="u-flex CDB-Text CDB-Size-small u-upperCase u-bSpace u-secondaryTextColor">\n  <li class=\'u-rSpace--m js-null\'></li>\n  <li class=\'js-percent\'></li>\n</ul>\n<div class="js-category-stat"></div>';
}
return __p;
};

},{"underscore":"underscore"}],893:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h4 class="CDB-Text CDB-Size-huge js-formula-stat"></h4>';
}
return __p;
};

},{"underscore":"underscore"}],894:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Text CDB-Size-small u-upperCase u-bSpace u-secondaryTextColor js-histogram-numbers"></div>\n<div class="js-histogram-stat"></div>';
}
return __p;
};

},{"underscore":"underscore"}],895:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./stat.tpl');
var utils = require('../../../../helpers/utils');
var templateCategory = require('./stat-category.tpl');
var templateHistogram = require('./stat-histogram.tpl');
var templateFormula = require('./stat-formula.tpl');

module.exports = CoreView.extend({
  className: 'StatsList',

  events: {
    'click .js-checkbox': '_onSelect',
    'click .js-style': '_onEdit'
  },

  initialize: function (opts) {
    if (!opts.statModel) throw new Error('statModel is required');
    if (!opts.stackLayoutModel) throw new Error('StackLayoutModel is required');

    this._statModel = opts.statModel;
    this._stackLayoutModel = opts.stackLayoutModel;
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this._statModel.on('change:selected', this.render, this);
    this.add_related_model(this._statModel);
  },

  _initViews: function () {
    var graph = this._statModel.get('graph');
    var type = this._statModel.get('type');

    this._renderTemplate();

    if (graph) {
      // No graph for formula
      if (type === 'histogram') {
        this._showHistogram(graph);
      } else if (type === 'category') {
        this._showCategory(graph);
      } else if (type === 'formula') {
        this._showFormula(graph);
      }
    }
  },

  _renderTemplate: function () {
    this.$el.append(template({
      column: this._statModel.get('title'),
      type: this._statModel.get('column'),
      graph: this._statModel.get('type'),
      isSelected: this._statModel.get('selected')
    }));
  },

  _onSelect: function () {
    this._statModel.set('selected', !this._statModel.get('selected'));
  },

  _onEdit: function (e) {
    e.preventDefault();
    this._stackLayoutModel.goToStep(1, this._statModel.get('widget'), 'widget-content');
  },

  _showCategory: function (graph) {
    if (graph.stats && graph.stats.freqs) {
      this.$('.js-stat').append(templateCategory());
      this.$('.js-category-stat').append(graph.getCategory({
        color: '#9DE0AD',
        width: 262,
        height: 10
      }));

      this.$('.js-null').text(utils.formatDecimalPositions(graph.getNullsPercentage() * 100) + _t('editor.data.stats.null'));
      if (this.options.statModel.attributes.column !== 'boolean') {
        this.$('.js-percent').text(utils.formatDecimalPositions(graph.getPercentageInTopCategories() * 100) + _t('editor.data.stats.top-cat'));
      } else {
        var numOfTrues = graph.getTrues();
        if (utils.isNumeric(numOfTrues)) {
          this.$('.js-percent').text(utils.formatDecimalPositions(numOfTrues * 100) + _t('editor.data.stats.trues'));
        }
      }
    }
  },

  _showHistogram: function (graph) {
    if (graph.stats) {
      this.$('.js-stat').append(templateHistogram());
      this.$('.js-histogram-stat').append(graph.getHistogram({
        color: '#9DE0AD',
        width: 262,
        height: 20,
        bins: 20
      }));
      this.$('.js-histogram-numbers').text(graph.getNullsPercentage() + _t('editor.data.stats.null'));
    }
  },

  _showFormula: function (graph) {
    var aggregation;
    if (graph.stats) {
      aggregation = graph.getCount();
      if (_.isNumber(aggregation)) {
        this.$('.js-stat').append(templateFormula());
        this.$('.js-formula-stat').text(aggregation.toFixed().toString().replace(/\B(?=(\d{3})+(?!\d))/g, ','));
      }
    }
  }
});

},{"../../../../helpers/utils":1102,"./stat-category.tpl":892,"./stat-formula.tpl":893,"./stat-histogram.tpl":894,"./stat.tpl":896,"backbone/core-view":1127,"underscore":"underscore"}],896:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="StatsList-item">\n  <div class="u-rSpace--m">\n    <input class="CDB-Checkbox js-checkbox" type="checkbox" ';
 if (isSelected) { 
__p+='checked="checked"';
 } 
__p+=' />\n    <span class="u-iBlock CDB-Checkbox-face"></span>\n  </div>\n\n  <div class="WidgetList-inner js-inner">\n    <div class="StatsList-header u-flex u-justifySpace u-alignCenter u-bSpace--m">\n      <h3 class="u-ellipsis CDB-Text CDB-Size-medium">'+
((__t=( _t('editor.data.stats.add-widget') ))==null?'':_.escape(__t))+
'</h3>\n      ';
 if (isSelected) { 
__p+='\n      <button class="StatsList-style CDB-Text CDB-Size-small js-style u-actionTextColor">\n        <div class="StatsList-arrow CDB-Shape-Arrow is-blue u-iBlock  u-rSpace--m"></div> '+
((__t=( _t('editor.data.stats.edit') ))==null?'':_.escape(__t))+
'\n      </button>\n      ';
 } 
__p+='\n    </div>\n    <div class="u-flex u-alignCenter u-bSpace">\n      <h2 class="js-title u-ellipsis CDB-Text CDB-Size-large u-rSpace--m">'+
((__t=( column ))==null?'':_.escape(__t))+
'</h2>\n      <div class="StatsList-tag Tag Tag--outline Tag-outline--grey CDB-Text CDB-Size-small u-upperCase">'+
((__t=( type ))==null?'':_.escape(__t))+
'</div>\n    </div>\n    <div class="js-stat"></div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],897:[function(require,module,exports){
var _ = require('underscore');
var FormulaOptionModel = require('../../../../components/modals/add-widgets/formula/formula-option-model');
var CategoryOptionModel = require('../../../../components/modals/add-widgets/category/category-option-model');
var HistogramOptionModel = require('../../../../components/modals/add-widgets/histogram/histogram-option-model');
var TimeSeriesOptionModel = require('../../../../components/modals/add-widgets/time-series/time-series-option-model');

var CARTODB_ID = 'cartodb_id';

module.exports = function (tuplesItems) {
  return _.reduce(tuplesItems, function (memo, tuples) {
    var columnModel = tuples[0].columnModel;
    var layerDef = tuples[0].layerDefinitionModel;
    var table = layerDef.getTableName();
    var type = columnModel.get('type');
    var columnName = columnModel.get('name');
    var m;
    var node;
    var geometry = _t('editor.data.stats.geometry-fallback');

    if (columnName === CARTODB_ID) {
      node = layerDef.getAnalysisDefinitionNodeModel();
      if (node && node.queryGeometryModel) {
        geometry = node.queryGeometryModel.get('simple_geom');
      }

      m = new FormulaOptionModel({
        tuples: tuples,
        table: table,
        title: _t('editor.data.stats.number-of', {
          geometry: geometry
        }),
        column: columnModel.get('type'),
        operation: 'count',
        name: columnName
      });
      memo.push(m);
    } else if (type === 'string' || type === 'boolean') {
      m = new CategoryOptionModel({
        tuples: tuples,
        table: table,
        title: columnName,
        name: columnName,
        column: columnModel.get('type'),
        aggregation: 'count' // or sum
      });
      memo.push(m);
    } else if (columnModel.get('type') === 'number') {
      m = new HistogramOptionModel({
        tuples: tuples,
        table: table,
        title: columnName,
        name: columnName,
        column: columnModel.get('type'),
        bins: 10
      });
      memo.push(m);
    } else if (columnModel.get('type') === 'date') {
      m = new TimeSeriesOptionModel({
        tuples: tuples,
        table: table,
        title: columnName,
        name: columnName,
        column: columnModel.get('type'),
        bins: 256
      });
      memo.push(m);
    }
    return memo;
  }, []);
};

},{"../../../../components/modals/add-widgets/category/category-option-model":375,"../../../../components/modals/add-widgets/formula/formula-option-model":381,"../../../../components/modals/add-widgets/histogram/histogram-option-model":386,"../../../../components/modals/add-widgets/time-series/time-series-option-model":398,"underscore":"underscore"}],898:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="CodeMirror-error">\n  <li class="CodeMirror-errorMessage u-lSpace--xl u-rSpace--xl">\n    '+
((__t=( _t('components.codemirror.syntax-error') ))==null?'':_.escape(__t))+
'. '+
((__t=( _t('components.codemirror.line') ))==null?'':_.escape(__t))+
' '+
((__t=( line ))==null?'':_.escape(__t))+
': <span>'+
((__t=( message ))==null?'':_.escape(__t))+
'</span>\n  </li>\n</ul>';
}
return __p;
};

},{"underscore":"underscore"}],899:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h2 class="CDB-Text CDB-Size-huge is-light u-secondaryTextColor">'+
((__t=( _t('editor.layers.infowindow.placeholder-geometry') ))==null?'':_.escape(__t))+
' '+
((__t=( _t('editor.layers.georeference.manually-add') ))==null?'':_.escape(__t))+
'</h2>\n<div class="BlockList-item is-dashed no-hover is-space u-tSpace-xl">\n  <ul class="HorizontalBlockList">\n    <li class="HorizontalBlockList-item"></li>\n    <li class="HorizontalBlockList-item"></li>\n  </ul>\n\n  <button class="CDB-Button CDB-Button--primary js-georeference">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('editor.layers.georeference.georeference-button') ))==null?'':_.escape(__t))+
'</span>\n  </button>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],900:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./infowindow-apply-button.tpl');

module.exports = CoreView.extend({
  events: {
    'click .js-apply': '_onApplyClick'
  },

  initialize: function (opts) {
    if (!opts.onApplyClick) throw new Error('onApplyClick is required');
  },

  render: function () {
    this.$el.html(template());
    return this;
  },

  _onApplyClick: function () {
    this.options.onApplyClick();
  }
});

},{"./infowindow-apply-button.tpl":901,"backbone/core-view":1127}],901:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button class="u-lSpace--xl CDB-Button CDB-Button--primary CDB-Button--small js-apply">\n  <span class="CDB-Text is-semibold CDB-Size-small">'+
((__t=( _t("editor.infowindow.apply") ))==null?'':_.escape(__t))+
'</span>\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],902:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-selector">\n  <div class="Editor-HeaderInfo-title u-bSpace--m">\n    <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.layers.infowindow.style.title-label') ))==null?'':_.escape(__t))+
'</h2>\n  </div>\n  <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m js-highlight">'+
((__t=( _t('editor.layers.infowindow.style.select-style') ))==null?'':_.escape(__t))+
'</p>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],903:[function(require,module,exports){
var InfowindowView = require('./infowindow-view');

/**
 * Select for an Infowindow style type.
 */
module.exports = InfowindowView.extend({

  _initTemplates: function () {
    this._templates = [
      {
        value: '',
        infowindowIcon: require('./infowindow-icons/infowindow-none.tpl'),
        label: _t('editor.layers.infowindow.style.none')
      }, {
        value: 'infowindow_light',
        infowindowIcon: require('./infowindow-icons/infowindow-light.tpl'),
        label: _t('editor.layers.infowindow.style.infowindow_light')
      }, {
        value: 'infowindow_dark',
        infowindowIcon: require('./infowindow-icons/infowindow-dark.tpl'),
        label: _t('editor.layers.infowindow.style.infowindow_dark')
      }, {
        value: 'infowindow_color',
        infowindowIcon: require('./infowindow-icons/infowindow-color.tpl'),
        label: _t('editor.layers.infowindow.style.infowindow_color')
      }, {
        value: 'infowindow_header_with_image',
        infowindowIcon: require('./infowindow-icons/infowindow-image.tpl'),
        label: _t('editor.layers.infowindow.style.infowindow_header_with_image')
      }
    ];
  }

});

},{"./infowindow-icons/infowindow-color.tpl":916,"./infowindow-icons/infowindow-dark.tpl":917,"./infowindow-icons/infowindow-image.tpl":918,"./infowindow-icons/infowindow-light.tpl":919,"./infowindow-icons/infowindow-none.tpl":920,"./infowindow-view":925}],904:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var InfowindowSelectView = require('./infowindow-select-view');
var InfowindowItemsView = require('./infowindow-items-view');
var CarouselCollection = require('../../../../components/custom-carousel/custom-carousel-collection');
var loadingTemplate = require('../../panel-loading-template.tpl');
var OverlayView = require('../../../components/overlay/overlay-view');

/**
 * Select for an Infowindow select type.
 */
module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.querySchemaModel) throw new Error('querySchemaModel is required');
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
    if (!opts.templates) throw new Error('templates is required');
    if (!opts.overlayModel) throw new Error('overlayModel is required');
    if (!opts.editorModel) throw new Error('editorModel is required');

    this._querySchemaModel = opts.querySchemaModel;
    this._layerDefinitionModel = opts.layerDefinitionModel;
    this._overlayModel = opts.overlayModel;
    this._templates = opts.templates;
    this._editorModel = opts.editorModel;

    this._initCollection();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    if (this._querySchemaModel.get('status') === 'fetched') {
      this._initViews();
    } else {
      this._renderStateless();
    }
    this._renderOverlay();

    return this;
  },

  _renderStateless: function () {
    this.$el.append(
      loadingTemplate()
    );
  },

  _renderOverlay: function () {
    var view = new OverlayView({
      overlayModel: this._overlayModel
    });
    this.addView(view);
    this.$el.append(view.render().el);
  },

  _initCollection: function () {
    this._templatesCollection = new CarouselCollection(
      _.map(this._templates, function (template) {
        return {
          selected: this.model.get('template_name') === template.value,
          val: template.value,
          label: template.label,
          template: function () {
            return (template.infowindowIcon && template.infowindowIcon()) || template.value;
          }
        };
      }, this)
    );
  },

  _initBinds: function () {
    this.model.bind('change:template_name', this._renderItems, this);
    this.model.bind('change:template', this._updateEditor, this);

    if (this._querySchemaModel.get('status') !== 'fetched') {
      // status can be: fetched, unavailable, fetching
      this._querySchemaModel.bind('change:status', this.render, this);
      this._querySchemaModel.fetch();
    }
  },

  _updateEditor: function () {
    this._editorModel.set('disabled', !this.model.hasTemplate());
  },

  _initViews: function () {
    var selectView = new InfowindowSelectView({
      model: this.model,
      templatesCollection: this._templatesCollection
    });
    this.addView(selectView);
    this.$el.append(selectView.render().el);

    this._renderItems();
  },

  _renderItems: function () {
    if (this._itemsView) {
      this.removeView(this._itemsView);
      this._itemsView.clean();
    }

    this._itemsView = new InfowindowItemsView({
      model: this.model,
      querySchemaModel: this._querySchemaModel,
      layerDefinitionModel: this._layerDefinitionModel,
      hasValidTemplate: !!this._checkValidTemplate()
    });
    this.addView(this._itemsView);
    this.$el.append(this._itemsView.render().el);
  },

  _checkValidTemplate: function () {
    var template = this._templatesCollection.find(function (mdl) {
      return this.model.get('template_name') === mdl.get('val');
    }, this);

    return template && template.get('val') !== '';
  }

});

},{"../../../../components/custom-carousel/custom-carousel-collection":40,"../../../components/overlay/overlay-view":694,"../../panel-loading-template.tpl":996,"./infowindow-items-view":921,"./infowindow-select-view":923,"backbone/core-view":1127,"underscore":"underscore"}],905:[function(require,module,exports){
var template = require('./infowindow-description.tpl');
var CoreView = require('backbone/core-view');

module.exports = CoreView.extend({

  events: {
    'click .js-toggle': '_toggle'
  },

  initialize: function (opts) {
    if (typeof opts.namesCount === 'undefined') throw new Error('namesCount has to be defined');

    this._namesCount = opts.namesCount;
  },

  render: function () {
    var totalFields = this._namesCount;
    var selectedFields = this.model.fieldCount();

    this.$el.html(
      template({
        allSelected: selectedFields && (selectedFields === totalFields),
        noneSelected: !selectedFields,
        selectedFields: selectedFields
      })
    );

    return this;
  },

  _toggle: function () {
    this.trigger('toggle');
  }
});

},{"./infowindow-description.tpl":906,"backbone/core-view":1127}],906:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifySpace u-alignCenter">\n  <p class="CDB-Text is-semibold CDB-Size-small u-upperCase js-textInfo">\n    ';
 if (noneSelected) { 
__p+='\n      None selected\n    ';
 } else { 
__p+='\n      '+
((__t=( allSelected ? "All selected" : selectedFields + " selected" ))==null?'':_.escape(__t))+
'\n    ';
 }
__p+='\n  </p>\n \n  <button class="CDB-Text CDB-Size-small u-upperCase u-actionTextColor js-toggle">';
 if (allSelected) { 
__p+='none';
 } else { 
__p+='all';
 } 
__p+='</button>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],907:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var template = require('./infowindow-field.tpl');

/**
 * View for an individual column model.
 */
module.exports = CoreView.extend({

  tagName: 'li',

  className: 'js-field Infowindow-listFieldItem',

  events: {
    'click .js-checkbox': 'toggle',
    'keyup .js-input': '_onKeyUp',
    'blur .js-input': '_onBlur'
  },

  initialize: function (opts) {
    if (!opts.layerInfowindowModel) throw new Error('layerInfowindowModel is required');

    this._layerInfowindowModel = opts.layerInfowindowModel;

    this.fieldName = opts.field.name;
    this.fieldTitle = opts.field.title;
    this.position = opts.position;

    this._layerInfowindowModel.bind('change:fields', this.render, this);

    this.model = new Backbone.Model({
      title: this._layerInfowindowModel.getAlternativeName(this.fieldName) || this.fieldName,
      selected: !!this._layerInfowindowModel.containsField(this.fieldName)
    });
    this.model.bind('change:title', this._updateTitle, this);
    this.model.bind('change:selected', this._updateSelected, this);
  },

  _onBlur: function (e) {
    var value = this.$el.find('.js-input').val();
    value = this._stripHTML(value);

    this.model.set('title', value);
  },

  _updateTitle: function () {
    var value = this.model.get('title');
    value = this._stripHTML(value);
    this._layerInfowindowModel.setAlternativeName(this.fieldName, value);

    var isBlank = this._isBlank(value);
    this._layerInfowindowModel.setFieldProperty(this.fieldName, 'title', !isBlank);
  },

  _onKeyUp: function (e) {
    if (e.keyCode === 13) { // Enter
      var value = this.$el.find('.js-input').val();
      value = this._stripHTML(value);

      this.model.set('title', value);
    // } else if (e.keyCode === 27) { // Esc
    //   this._close();
    }
  },

  _isBlank: function (str) {
    return (!str || /^\s*$/.test(str));
  },

  _stripHTML: function (input, allowed) {
    allowed = (((allowed || '') + '').toLowerCase().match(/<[a-z][a-z0-9]*>/g) || []).join('');
    var tags = /<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;
    if (!input || (typeof input !== 'string')) return '';
    return input.replace(tags, function ($0, $1) {
      return allowed.indexOf('<' + $1.toLowerCase() + '>') > -1 ? $0 : '';
    });
  },

  render: function () {
    this.$el.html(template({
      name: this.fieldName,
      title: this._layerInfowindowModel.getFieldProperty(this.fieldName, 'title'),
      alternativeName: this._layerInfowindowModel.getAlternativeName(this.fieldName),
      isSelected: !!this._layerInfowindowModel.containsField(this.fieldName)
    }));
    this.$el.attr('data-view-cid', this.cid);

    return this;
  },

  toggle: function (e) {
    e && e.preventDefault();

    this.model.set('selected', !this.model.get('selected'));

    return false;
  },

  _updateSelected: function (e) {
    if (!this._layerInfowindowModel.containsField(this.fieldName)) {
      this._layerInfowindowModel.addField(this.fieldName, this.position);
    } else {
      this.model.set('title', null);
      this._layerInfowindowModel.removeField(this.fieldName);
    }
  }

});

},{"./infowindow-field.tpl":908,"backbone":"backbone","backbone/core-view":1127}],908:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Text CDB-Fieldset u-tSpace--m">\n  <div class="CDB-Legend CDB-Legend--big u-ellipsis CDB-Text CDB-Size-medium u-rSpace--m">\n    <div class="Infowindow-listFieldsOrder CDB-Shape u-iblock u-malign">\n      <div class="CDB-Shape-rectsHandle is-small">\n        <div class="CDB-Shape-rectsHandleItem CDB-Shape-rectsHandleItem--grey is-first"></div>\n        <div class="CDB-Shape-rectsHandleItem CDB-Shape-rectsHandleItem--grey is-second"></div>\n        <div class="CDB-Shape-rectsHandleItem CDB-Shape-rectsHandleItem--grey is-third"></div>\n      </div>\n    </div>\n    <input class="CDB-Checkbox js-checkbox" type="checkbox" ';
 if (isSelected) { 
__p+='checked="checked"';
 } 
__p+='">\n    <span class="u-iBlock CDB-Checkbox-face u-rSpace"></span>\n    <label class="u-rSpace--m" title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">'+
((__t=( name ))==null?'':_.escape(__t))+
'</label>\n  </div>\n  <input type="text" name="text" placeholder=\'"'+
((__t=( name ))==null?'':_.escape(__t))+
'"\' value="';
 if (!isSelected) { 
__p+=''+
((__t=( name ))==null?'':_.escape(__t))+
'';
 } else { 
__p+='';
 if (title) { 
__p+='';
 if (alternativeName) { 
__p+=''+
((__t=( alternativeName ))==null?'':_.escape(__t))+
'';
 } else { 
__p+=''+
((__t=( name ))==null?'':_.escape(__t))+
'';
 } 
__p+='';
 } 
__p+='';
 } 
__p+='" class="CDB-InputText js-input" ';
 if (!isSelected) { 
__p+='disabled';
 } 
__p+='>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],909:[function(require,module,exports){
var FieldView = require('./infowindow-field-view.js');
var InfowindowDescriptionView = require('./infowindow-description-view.js');
var template = require('./infowindow-fields.tpl');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var $ = require('jquery');
require('jquery-ui');

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.querySchemaModel) throw new Error('querySchemaModel is required');
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');

    this._querySchemaModel = opts.querySchemaModel;
    this._layerDefinitionModel = opts.layerDefinitionModel;

    // An internal collection to keep track of the columns and their order
    this._sortedFields = new Backbone.Collection();
    this._sortedFields.comparator = function (model) {
      return model.get('position');
    };

    this._initBinds();
  },

  _initBinds: function () {
    this.model.bind('remove:fields', this._renderDescription, this);
    this.model.bind('add:fields', this._renderDescription, this);
  },

  render: function () {
    this._destroySortable();
    this.clearSubViews();

    this.$el.html(template());

    this._renderDescription();
    this._renderFields();
    this._initSortable();
    this._renderSelectAll();
    this._storeSortedFields();

    return this;
  },

  _renderDescription: function () {
    if (this._fieldsDescriptionView) {
      this.removeView(this._fieldsDescriptionView);
      this._fieldsDescriptionView.clean();
    }

    this._fieldsDescriptionView = new InfowindowDescriptionView({
      model: this.model,
      namesCount: this._getColumnNames().length
    });

    this._fieldsDescriptionView.bind('toggle', this.manageAll, this);

    this.addView(this._fieldsDescriptionView);
    this.$('.js-description').append(this._fieldsDescriptionView.render().el);

    this._renderSelectAll();
  },

  _renderSelectAll: function () {
    this.selectedAll = this._allFieldsSelected();
  },

  _allFieldsSelected: function () {
    var self = this;

    var selectedAll = true;

    _.each(this._getColumnNames(), function (field) {
      if (!self.model.containsField(field)) {
        selectedAll = false;
      }
    });

    return selectedAll;
  },

  manageAll: function (e) {
    if (!this.selectedAll) {
      this._selectAll();
    } else {
      this._unselectAll();
    }
  },

  _selectAll: function () {
    var self = this;

    var names = this._sortedFields.map(function (w) { return w.get('name'); });
    var promises = [];

    _.each(names, function (f) {
      if (!self.model.containsField(f)) {
        promises.push(self.model._addField(f));
      }
    });

    $.when.apply($, promises).then(function () {
      self.model.sortFields();
      self.model.trigger('add:fields');
      self.model.trigger('change:fields', self.model, self.model.get('fields'));
      self.model.trigger('change', self.model);

      self._toggleSelectAll();
    });
  },

  _unselectAll: function () {
    this.model.clearFields();
    this.model.trigger('change:fields');
    this._toggleSelectAll();
  },

  _toggleSelectAll: function () {
    this.selectedAll = !this.selectedAll;
    this._renderDescription();
  },

  _initSortable: function () {
    this.$('.js-fields').sortable({
      axis: 'y',
      items: '> li',
      opacity: 0.8,
      update: this._onSortableFinish.bind(this),
      forcePlaceholderSize: false
    });
  },

  _destroySortable: function () {
    if (this.$('.js-fields').data('ui-sortable')) {
      this.$('.js-fields').sortable('destroy');
    }
  },

  _onSortableFinish: function () {
    var self = this;
    this._sortedFields.reset([]);

    this.$('.js-fields > .js-field').each(function (index, item) {
      var view = self._subviews[$(item).data('view-cid')];

      self.model.setFieldProperty(view.fieldName, 'position', index);
      view.position = index;

      self._sortedFields.add({
        name: view.fieldName,
        position: index
      });
    });
  },

  _getSortedColumnNames: function () {
    var self = this;
    var names = this._getColumnNames();

    if (self.model.fieldCount() > 0) {
      names.sort(function (a, b) {
        var pos_a = self.model.getFieldPos(a);
        var pos_b = self.model.getFieldPos(b);
        return pos_a - pos_b;
      });
    }
    return names;
  },

  _storeSortedFields: function () {
    var self = this;

    this._sortedFields.reset([]);

    var names = this._getSortedColumnNames();
    _(names).each(function (name, position) {
      self._sortedFields.add({
        name: name,
        position: position
      });
    });
  },

  _getColumnNames: function () {
    var self = this;

    var filteredColumns = this._querySchemaModel.columnsCollection.filter(function (c) {
      return !_.contains(self.model.SYSTEM_COLUMNS, c.get('name'));
    });

    var columnNames = [];

    _.each(filteredColumns, function (m) {
      columnNames.push(m.get('name'));
    });

    return columnNames;
  },

  _renderFields: function () {
    var self = this;

    var names = this._getSortedColumnNames();

    _(names).each(function (f, i) {
      var title = self.model.getFieldProperty(f, 'title');

      var view = new FieldView({
        layerInfowindowModel: self.model,
        field: { name: f, title: title },
        position: self.model.getFieldPos(f)
      });

      self.addView(view);
      self.$('.js-fields').append(view.render().el);
    });
  },

  clean: function () {
    this._destroySortable();
    CoreView.prototype.clean.apply(this);
  }
});

},{"./infowindow-description-view.js":905,"./infowindow-field-view.js":907,"./infowindow-fields.tpl":910,"backbone":"backbone","backbone/core-view":1127,"jquery":"jquery","jquery-ui":1128,"underscore":"underscore"}],910:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-description"></div>\n<ul class="js-fields Infowindow-listFields"></ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],911:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var DEBOUNCE_TIME = 350;

module.exports = Backbone.Model.extend({

  initialize: function (attrs, opts) {
    if (!opts.layerInfowindowModel) throw new Error('layerInfowindowModel is required');
    this._layerInfowindowModel = opts.layerInfowindowModel;

    this._generateSchema();
    this._initBinds();
  },

  _initBinds: function () {
    this.bind('change', _.debounce(this._onChange.bind(this), DEBOUNCE_TIME), this);
  },

  _onChange: function () {
    var self = this;

    _.each(this.changed, function (val, key) {
      // if the attr doesn't exist in the infowindowModel it will be created, BOOM
      self._layerInfowindowModel.set(key, val);
    });
  },

  _generateSchema: function () {
    this.schema = {};

    var type = this._layerInfowindowModel.get('template_name');

    if (type !== '' && type !== 'none') {
      if (this._layerInfowindowModel.has('width')) {
        this.schema.width = {
          type: 'Number',
          title: _t('editor.layers.infowindow.style.window-size'),
          validators: ['required', {
            type: 'interval',
            min: 200,
            max: 400
          }]
        };
      }
    }

    if (type === 'infowindow_color') {
      this.schema.headerColor = {
        type: 'Fill',
        title: _t('editor.layers.infowindow.style.header-color'),
        options: [],
        dialogMode: 'float',
        editorAttrs: {
          color: {
            hidePanes: ['value']
          }
        },
        validators: ['required']
      };
    }
  }

});

},{"backbone":"backbone","underscore":"underscore"}],912:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var template = require('./infowindow-form.tpl');
var InfowindowFormModel = require('./infowindow-form-model');

module.exports = CoreView.extend({

  render: function () {
    this.clearSubViews();
    this.$el.html(template());

    this._generateForms();
    this._initBinds();

    return this;
  },

  _initBinds: function () {
    this.model.bind('change:template_name', this._generateForms, this);
  },

  _generateForms: function () {
    if (this._formView) {
      this._formView.remove();
    }

    this._formModel = new InfowindowFormModel({
      width: this.model.get('width'),
      headerColor: this.model.get('headerColor')
    }, {
      layerInfowindowModel: this.model
    });

    this._formView = new Backbone.Form({
      model: this._formModel
    });

    this._formView.bind('change', function () {
      this.commit();
    });

    this.$('.js-form').append(this._formView.render().$el);
  },

  clean: function () {
    if (this._formView) {
      this._formView.remove();
    }
  }
});

},{"./infowindow-form-model":911,"./infowindow-form.tpl":913,"backbone":"backbone","backbone/core-view":1127}],913:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-form"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],914:[function(require,module,exports){
var InfowindowView = require('./infowindow-view');

/**
 * Select for an Infowindow style type.
 */
module.exports = InfowindowView.extend({

  _initTemplates: function () {
    this._templates = [
      {
        value: '',
        infowindowIcon: require('./tooltip-icons/tooltip-none.tpl'),
        label: _t('editor.layers.infowindow.style.none')
      }, {
        value: 'tooltip_light',
        infowindowIcon: require('./tooltip-icons/tooltip-light.tpl'),
        label: _t('editor.layers.infowindow.style.infowindow_light')
      }, {
        value: 'tooltip_dark',
        infowindowIcon: require('./tooltip-icons/tooltip-dark.tpl'),
        label: _t('editor.layers.infowindow.style.infowindow_dark')
      }
    ];
  }

});

},{"./infowindow-view":925,"./tooltip-icons/tooltip-dark.tpl":929,"./tooltip-icons/tooltip-light.tpl":930,"./tooltip-icons/tooltip-none.tpl":931}],915:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var CodeMirrorView = require('../../../../components/code-mirror/code-mirror-view');
var ErrorTemplate = require('./code-mirror-error.tpl');

module.exports = CoreView.extend({

  className: 'Editor-content',

  initialize: function (opts) {
    if (!opts.codemirrorModel) throw new Error('codemirrorModel is required');
    if (!opts.onApplyEvent) throw new Error('onApplyEvent');

    this._codemirrorModel = opts.codemirrorModel;
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initViews: function () {
    this.codeMirrorView = new CodeMirrorView({
      model: this._codemirrorModel,
      tip: _t('editor.infowindow.code-mirror.save'),
      errorTemplate: ErrorTemplate
    });

    this.codeMirrorView.bind('codeSaved', this._triggerCodeSaved, this);
    this.addView(this.codeMirrorView);
    this.$el.append(this.codeMirrorView.render().el);
  },

  _triggerCodeSaved: function (code, view) {
    this.options.onApplyEvent && this.options.onApplyEvent();
  }

});

},{"../../../../components/code-mirror/code-mirror-view":27,"./code-mirror-error.tpl":898,"backbone/core-view":1127}],916:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="58px" height="38px" viewBox="608 430 58 38" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g id="PopUp" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(608.000000, 431.000000)">\n        <path d="M1,2.00174332 C1,0.89621101 1.90230818,0 2.99306965,0 L55.0069304,0 C56.1076723,0 57,0.889261723 57,2.00174332 L57,29.9982567 C57,31.103789 56.1032859,32 55.0073354,32 L18.4262695,32 L9,36 L9,32 L2.99810135,32 C1.89458045,32 1,31.1107383 1,29.9982567 L1,2.00174332 L1,2.00174332 Z" id="Rectangle-2087" stroke="#EEEEEE" fill="#FFFFFF"></path>\n        <path d="M15,4.35207426e-14 L10.3214747,12 L1,12 L1,3.48144531 C1,3.48144531 0.787841764,1.33203125 1.49902344,0.666015625 C2.21020511,4.35207426e-14 3.82543945,4.35207426e-14 3.82543945,4.35207426e-14 L15,4.35207426e-14 Z" id="Rectangle-678" fill="#9AE0AA"></path>\n        <polygon id="Rectangle-678" fill="#F4F1DE" points="27 0 22.3214747 12 9 12 13.6785253 0"></polygon>\n        <polygon id="Rectangle-678" fill="#E37E62" points="39 0 34.3214747 12 21 12 25.6785253 0"></polygon>\n        <polygon id="Rectangle-678" fill="#3D3D5B" points="51 0 46.3214747 12 33 12 37.6785253 0"></polygon>\n        <path d="M54.2199707,0 C54.2199707,0 56.0734097,0.047231609 56.5109863,0.508300759 C57.0344286,1.05984554 57.1030273,3.0378418 57.1030273,3.0378418 L57.1030273,12 L46,12 L50.6785253,0 L54.2199707,0 Z" id="Rectangle-678" fill="#F2CF8F"></path>\n        <rect id="Rectangle-678" fill="#FFFFFF" opacity="0.32" x="7" y="4" width="36" height="4"></rect>\n        <rect id="Rectangle-679" fill="#DDDDDD" x="6" y="17" width="45" height="2"></rect>\n        <rect id="Rectangle-680" fill="#DDDDDD" x="6" y="21" width="26" height="2"></rect>\n        <rect id="Rectangle-680" fill="#DDDDDD" x="6" y="25" width="19" height="2"></rect>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],917:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="56px" height="36px" viewBox="512 431 56 36" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g id="PopUp" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(512.000000, 431.000000)">\n        <path d="M0,2.00174332 C0,0.89621101 0.902308181,0 1.99306965,0 L54.0069304,0 C55.1076723,0 56,0.889261723 56,2.00174332 L56,29.9982567 C56,31.103789 55.1032859,32 54.0073354,32 L17.4262695,32 L8,36 L8,32 L1.99810135,32 C0.894580447,32 0,31.1107383 0,29.9982567 L0,2.00174332 L0,2.00174332 Z" id="Rectangle-2087" fill="#2E3C43"></path>\n        <rect id="Rectangle-679" fill="#636D72" x="5" y="15" width="45" height="2"></rect>\n        <rect id="Rectangle-680" fill="#636D72" x="5" y="19" width="26" height="2"></rect>\n        <rect id="Rectangle-680" fill="#636D72" x="5" y="23" width="19" height="2"></rect>\n        <rect id="Rectangle-680" fill="#636D72" x="5" y="11" width="26" height="2"></rect>\n        <rect id="Rectangle-680" fill="#636D72" x="5" y="7" width="36" height="2"></rect>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],918:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="58px" height="38px" viewBox="688 430 58 38" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g id="IMG" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(689.000000, 431.000000)">\n        <path d="M0,2.00174332 C0,0.89621101 0.902308181,0 1.99306965,0 L54.0069304,0 C55.1076723,0 56,0.889261723 56,2.00174332 L56,29.9982567 C56,31.103789 55.1032859,32 54.0073354,32 L17.4262695,32 L8,36 L8,32 L1.99810135,32 C0.894580447,32 0,31.1107383 0,29.9982567 L0,2.00174332 L0,2.00174332 Z" id="Rectangle-2087" stroke="#EEEEEE" fill="#FFFFFF"></path>\n        <path d="M54.0069304,0 C55.1076723,0 56,0.901950359 56,2.0085302 L56,12 L0,12 L0,2.0085302 C0,0.899249601 0.902308181,0 1.99306965,0 L54.0069304,0 Z" id="Rectangle-678" fill="#CBCED0"></path>\n        <rect id="Rectangle-678" fill="#FFFFFF" opacity="0.32" x="6" y="4" width="28" height="4"></rect>\n        <rect id="Rectangle-679" fill="#DDDDDD" x="5" y="17" width="45" height="2"></rect>\n        <rect id="Rectangle-680" fill="#DDDDDD" x="5" y="21" width="26" height="2"></rect>\n        <rect id="Rectangle-680" fill="#DDDDDD" x="5" y="25" width="19" height="2"></rect>\n        <path d="M43.6,6 L46,8 L49.6,2 L52,10 L40,10 L43.6,6 Z M41,4 C41.5522847,4 42,3.55228475 42,3 C42,2.44771525 41.5522847,2 41,2 C40.4477153,2 40,2.44771525 40,3 C40,3.55228475 40.4477153,4 41,4 Z" id="Rectangle-5896" fill="#FFFFFF"></path>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],919:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="58px" height="38px" viewBox="429 431 58 38" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g id="PopUp-Copy" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(430.000000, 432.000000)">\n        <path d="M0,2.00174332 C0,0.89621101 0.902308181,0 1.99306965,0 L54.0069304,0 C55.1076723,0 56,0.889261723 56,2.00174332 L56,29.9982567 C56,31.103789 55.1032859,32 54.0073354,32 L17.4262695,32 L8,36 L8,32 L1.99810135,32 C0.894580447,32 0,31.1107383 0,29.9982567 L0,2.00174332 L0,2.00174332 Z" id="Rectangle-2087" stroke="#EEEEEE" fill="#FFFFFF"></path>\n        <rect id="Rectangle-679" fill="#DDDDDD" x="4" y="14" width="45" height="2"></rect>\n        <rect id="Rectangle-680" fill="#DDDDDD" x="4" y="18" width="26" height="2"></rect>\n        <rect id="Rectangle-680" fill="#DDDDDD" x="4" y="22" width="19" height="2"></rect>\n        <rect id="Rectangle-680" fill="#DDDDDD" x="4" y="10" width="26" height="2"></rect>\n        <rect id="Rectangle-680" fill="#DDDDDD" x="4" y="6" width="36" height="2"></rect>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],920:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text CDB-Size-small u-altTextColor u-upperCase">None</p>';
}
return __p;
};

},{"underscore":"underscore"}],921:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./infowindow-items.tpl');
var InfowindowFieldsView = require('./infowindow-fields-view');

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.querySchemaModel) throw new Error('querySchemaModel is required');
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
    if (typeof opts.hasValidTemplate === 'undefined') throw new Error('hasValidTemplate has to be defined');
    this._querySchemaModel = opts.querySchemaModel;
    this._layerDefinitionModel = opts.layerDefinitionModel;
    this._hasValidTemplate = opts.hasValidTemplate;
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    if (this._hasValidTemplate) {
      this._initViews();
    }

    return this;
  },

  _initViews: function () {
    this.$el.html(template({
      title: _t('editor.layers.infowindow.items.title-label')
    }));

    if (this._infowindowFieldsView) {
      this.removeView(this._infowindowFieldsView);
      this._infowindowFieldsView.clean();
    }

    this._infowindowFieldsView = new InfowindowFieldsView({
      model: this.model,
      querySchemaModel: this._querySchemaModel,
      layerDefinitionModel: this._layerDefinitionModel
    });

    this.$('.js-content').append(this._infowindowFieldsView.render().$el);
    this.addView(this._infowindowFieldsView);

    return this;
  }
});

},{"./infowindow-fields-view":909,"./infowindow-items.tpl":922,"backbone/core-view":1127}],922:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfo">\n  <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n\n  <div class="Editor-HeaderInfo-Inner CDB-Text">\n    <div class="Editor-HeaderInfo-Title u-bSpace--m">\n      <h2 class="Editor-HeaderInfo-TitleText CDB-Text CDB-Size-large">'+
((__t=( _t('editor.layers.infowindow.items.title-label') ))==null?'':_.escape(__t))+
'</h2>\n    </div>\n\n    <div class="js-content"></div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],923:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./infowindow-select.tpl');
var CarouselFormView = require('../../../../components/carousel-form-view');
var InfowindowFormView = require('./infowindow-form-view');

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.templatesCollection) throw new Error('templatesCollection is required');
    this._templatesCollection = opts.templatesCollection;

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();

    this.$el.html(template());

    this._renderCarousel();
    this._renderForm();

    return this;
  },

  _initBinds: function () {
    this.model.bind('change:headerColor', this._onColorChange, this);
  },

  _onColorChange: function () {
    this._setTemplate(this.model.get('template_name'));
  },

  _checkValidTemplate: function () {
    var template = this._templatesCollection.find(function (mdl) {
      return this.model.get('template_name') === mdl.get('val');
    }, this);

    return template && template.get('val') !== '';
  },

  _setNoneTemplate: function () {
    var noneTemplate = this._templatesCollection.find(function (mdl) {
      return mdl.get('val') === '';
    }, this);

    noneTemplate.set('selected', true);
  },

  _setTemplate: function (template_name) {
    this.model.setTemplate(template_name);
  },

  _renderCarousel: function () {
    if (!this._checkValidTemplate()) {
      this._setNoneTemplate();
    }

    this._templatesCollection.bind('change:selected', function (mdl) {
      if (mdl.get('selected')) {
        var value = mdl.getValue();
        this._setTemplate(value);
      }
    }, this);
    this.add_related_model(this._templatesCollection);

    var view = new CarouselFormView({
      collection: this._templatesCollection,
      template: require('./infowindow-carousel.tpl')
    });
    this.addView(view);
    this.$('.js-select').append(view.render().el);
  },

  _renderForm: function () {
    if (this._infowindowFormView) {
      this.removeView(this._infowindowFormView);
      this._infowindowFormView.clean();
    }

    this._infowindowFormView = new InfowindowFormView({
      model: this.model
    });
    this.addView(this._infowindowFormView);
    this.$('.js-select').append(this._infowindowFormView.render().el);
  }

});

},{"../../../../components/carousel-form-view":23,"./infowindow-carousel.tpl":902,"./infowindow-form-view":912,"./infowindow-select.tpl":924,"backbone/core-view":1127}],924:[function(require,module,exports){
arguments[4][736][0].apply(exports,arguments)
},{"dup":736,"underscore":"underscore"}],925:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var PanelWithOptionsView = require('../../../../components/view-options/panel-with-options-view');
var InfoWindowHTMLView = require('./infowindow-html-view');
var InfowindowContentView = require('./infowindow-content-view');
var ScrollView = require('../../../../components/scroll/scroll-view');
var TabPaneView = require('../../../../components/tab-pane/tab-pane-view');
var TabPaneCollection = require('../../../../components/tab-pane/tab-pane-collection');
var Toggler = require('../../../../components/toggler/toggler-view');
var ApplyView = require('./infowindow-apply-button-view');
var Infobox = require('../../../../components/infobox/infobox-factory');
var InfoboxModel = require('../../../../components/infobox/infobox-model');
var InfoboxCollection = require('../../../../components/infobox/infobox-collection');

var cdb = require('cartodb.js');

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
    if (!opts.userActions) throw new Error('userActions is required');
    if (!opts.editorModel) throw new Error('editorModel is required');

    this._layerDefinitionModel = opts.layerDefinitionModel;
    this._userActions = opts.userActions;
    this._editorModel = opts.editorModel;

    this._initModels();
    this._initBinds();
    this._configPanes();
    this._initTemplates();
  },

  _initModels: function () {
    var content;
    if (this.model.isCustomTemplate()) {
      content = this.model.get('template');
    } else {
      content = this._getTemplateContent();
    }

    this._codemirrorModel = new Backbone.Model({
      content: content
    });

    this._infoboxModel = new InfoboxModel({
      state: this._isLayerHidden() ? 'layer-hidden' : ''
    });

    this._overlayModel = new Backbone.Model({
      visible: this._isLayerHidden()
    });

    // Set edition attribute in case custom html is applied and
    // in case none template is applied
    this._editorModel.set({
      edition: this.model.isCustomTemplate(),
      disabled: !this.model.hasTemplate() && !this.model.isCustomTemplate()
    });
  },

  _setContent: function () {
    if (this._editorModel.get('edition')) {
      return;
    }

    var html_value = this._getTemplateContent();
    this._codemirrorModel.set({
      content: html_value
    });
  },

  _initBinds: function () {
    this.model.bind('change', this._onChange.bind(this), this.model);

    this.listenTo(this._editorModel, 'change:edition', this._onChangeEdition);
    this.add_related_model(this._editorModel);

    this.listenTo(this._layerDefinitionModel, 'change:visible', this._infoboxState);
    this.add_related_model(this._layerDefinitionModel);
  },

  _saveInfowindowHTML: function () {
    var content = this._codemirrorModel.get('content');
    // Parse
    var errors = this._getErrors(content);

    if (errors.length === 0) {
      this._clearErrors();

      // Save old fields
      if (!this.model.get('old_fields')) {
        this.model.saveFields();
      }

      // Save old template name
      if (!this.model.get('old_template_name')) {
        this.model.set('old_template_name', this.model.get('template_name'));
      }

      // new custom template
      this.model.set({
        template: content,
        template_name: ''
      });

      this._userActions.saveLayer(this._layerDefinitionModel);
    } else {
      this._parseErrors(errors);
    }
  },

  _getErrors: function (content) {
    try {
      var template = new cdb.core.Template({
        template: content,
        type: 'mustache'
      });
      template.compile()();
      if (content === '') {
        return [{
          line: 1,
          message: _t('editor.infowindow.code-mirror.errors.empty')
        }];
      } else {
        return [];
      }
    } catch (e) {
      return e;
    }
  },

  _showErrors: function (model) {
    var errors = this._querySchemaModel.get('query_errors');
    this._codemirrorModel.set('errors', this._parseErrors(errors));
  },

  _parseErrors: function (errors) {
    return errors.map(function (error) {
      return {
        line: error.line,
        message: error.message.split('\n\n')[1]
      };
    });
  },

  _clearErrors: function () {
    this._codemirrorModel.set({errors: []});
  },

  _getTemplateContent: function () {
    var fields = [];
    var alternative_names = this.model.get('alternative_names');

    _.each(this.model.get('fields'), function (field, i) {
      var f = _.clone(field);
      f.position = i;
      if (alternative_names && alternative_names[f.name]) {
        f.alternative_name = alternative_names[f.name];
      }
      fields.push(f);
    });

    var tmpl = new cdb.core.Template({
      template: this.model.getTemplate(),
      type: 'mustache'
    });

    return tmpl.render({content: { fields: fields }});
  },

  _configPanes: function () {
    var self = this;

    var tabPaneTabs = [{
      selected: !self.model.isCustomTemplate(),
      createContentView: function () {
        return new ScrollView({
          createContentView: function () {
            return new InfowindowContentView(_.extend(self.options, {
              templates: self._templates,
              overlayModel: self._overlayModel
            }));
          }
        });
      },
      createActionView: function () {
        return new CoreView();
      }
    }, {
      selected: self.model.isCustomTemplate(),
      createContentView: function () {
        return new InfoWindowHTMLView({
          onApplyEvent: self._saveInfowindowHTML.bind(self),
          codemirrorModel: self._codemirrorModel
        });
      },
      createActionView: function () {
        return new ApplyView({
          onApplyClick: self._saveInfowindowHTML.bind(self)
        });
      }
    }];

    this._collectionPane = new TabPaneCollection(tabPaneTabs);
  },

  _onChange: function () {
    this._userActions.saveLayer(this._layerDefinitionModel);
    this._setContent();
  },

  _onChangeEdition: function () {
    this._infoboxState();

    var edition = this._editorModel.get('edition');
    var index = edition ? 1 : 0;
    this._collectionPane.at(index).set({ selected: true });
  },

  _cancelHTML: function () {
    this.model.setDefault();
    this._infoboxModel.set({state: ''});
    this._overlayModel.set({visible: false});
  },

  _isLayerHidden: function () {
    return this._layerDefinitionModel.get('visible') === false;
  },

  _infoboxState: function () {
    var edition = this._editorModel.get('edition');
    var html_custom = this.model.isCustomTemplate();

    if (!edition && html_custom) {
      this._infoboxModel.set({state: 'confirm'});
      this._overlayModel.set({visible: true});
    } else if (!edition && this._isLayerHidden()) {
      this._infoboxModel.set({state: 'layer-hidden'});
      this._overlayModel.set({visible: true});
    } else {
      this._infoboxModel.set({state: ''});
      this._overlayModel.set({visible: false});
    }
  },

  _showHiddenLayer: function () {
    var savingOptions = {
      shouldPreserveAutoStyle: true
    };
    this._layerDefinitionModel.toggleVisible();
    this._userActions.saveLayer(this._layerDefinitionModel, savingOptions);
  },

  render: function () {
    this.clearSubViews();

    var self = this;

    var infoboxSstates = [
      {
        state: 'confirm',
        createContentView: function () {
          return Infobox.createWithAction({
            type: 'alert',
            title: _t('editor.infowindow.messages.custom-html-applied.title'),
            body: _t('editor.infowindow.messages.custom-html-applied.body'),
            mainAction: {
              label: _t('editor.infowindow.messages.custom-html-applied.accept')
            }
          });
        },
        mainAction: self._cancelHTML.bind(self)
      }, {
        state: 'layer-hidden',
        createContentView: function () {
          return Infobox.createWithAction({
            type: 'alert',
            title: _t('editor.infowindow.messages.layer-hidden.title'),
            body: _t('editor.infowindow.messages.layer-hidden.body'),
            mainAction: {
              label: _t('editor.infowindow.messages.layer-hidden.show')
            }
          });
        },
        mainAction: self._showHiddenLayer.bind(self)
      }
    ];

    var infoboxCollection = new InfoboxCollection(infoboxSstates);

    var panelWithOptionsView = new PanelWithOptionsView({
      className: 'Editor-content',
      editorModel: self._editorModel,
      infoboxModel: self._infoboxModel,
      infoboxCollection: infoboxCollection,
      createContentView: function () {
        return new TabPaneView({
          collection: self._collectionPane
        });
      },
      createControlView: function () {
        return new Toggler({
          editorModel: self._editorModel,
          labels: [_t('editor.infowindow.html-toggle.values'), _t('editor.infowindow.html-toggle.html')],
          isDisableable: true
        });
      },
      createActionView: function () {
        return new TabPaneView({
          collection: self._collectionPane,
          createContentKey: 'createActionView'
        });
      }
    });

    this.$el.append(panelWithOptionsView.render().el);
    this.addView(panelWithOptionsView);

    return this;
  },

  clean: function () {
    this.model.unbind('change', null, this.model);
    CoreView.prototype.clean.apply(this);
  }

});

},{"../../../../components/infobox/infobox-collection":215,"../../../../components/infobox/infobox-factory":216,"../../../../components/infobox/infobox-model":219,"../../../../components/scroll/scroll-view":530,"../../../../components/tab-pane/tab-pane-collection":538,"../../../../components/tab-pane/tab-pane-view":549,"../../../../components/toggler/toggler-view":590,"../../../../components/view-options/panel-with-options-view":595,"./infowindow-apply-button-view":900,"./infowindow-content-view":904,"./infowindow-html-view":915,"backbone":"backbone","backbone/core-view":1127,"cartodb.js":"cartodb.js","underscore":"underscore"}],926:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var InfowindowView = require('./infowindow-click-view');
var TooltipView = require('./infowindow-hover-view');
var createTextLabelsTabPane = require('../../../../components/tab-pane/create-text-labels-tab-pane');
var TabPaneTemplate = require('../../../tab-pane-submenu.tpl');
var popupPlaceholderTemplate = require('./popups-placeholder.tpl');
var georeferencePlaceholderTemplate = require('./georeference-placeholder.tpl');
var loadingTemplate = require('../../panel-loading-template.tpl');
var checkAndBuildOpts = require('../../../../helpers/required-opts');
var Infobox = require('../../../../components/infobox/infobox-factory');
var InfoboxModel = require('../../../../components/infobox/infobox-model');
var InfoboxCollection = require('../../../../components/infobox/infobox-collection');
var PanelWithOptionsView = require('../../../../components/view-options/panel-with-options-view');
var ViewFactory = require('../../../../components/view-factory');
var panelTemplate = require('./panel-with-options.tpl');
var OverlayView = require('../../../components/overlay/overlay-view');
var fetchAllQueryObjectsIfNecessary = require('../../../../helpers/fetch-all-query-objects');

var REQUIRED_OPTS = [
  'configModel',
  'userActions',
  'layerDefinitionModel',
  'queryGeometryModel',
  'querySchemaModel',
  'queryRowsCollection',
  'editorModel'
];

module.exports = CoreView.extend({

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this.render = this.render.bind(this);

    this._layerInfowindowModel = this._layerDefinitionModel.infowindowModel;
    this._layerTooltipModel = this._layerDefinitionModel.tooltipModel;

    this._initModels();
    this._initBinds();

    this._fetchAllQueryObjectsIfNecessary();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    if (this._queryGeometryModel.isFetching()) {
      this._renderLoading();
    } else if (this._layerInfowindowModel && this._hasColumns() && this._canAddInfowindow() && this._queryGeometryModel.hasValue()) {
      this._initViews();
      this._bindEvents();
    } else {
      this._renderPlaceholder();
    }

    this._renderOverlay();
    return this;
  },

  _renderOverlay: function () {
    var view = new OverlayView({
      overlayModel: this._overlayModel
    });
    this.addView(view);
    this.$('.js-content').append(view.render().el);
  },

  _initModels: function () {
    this._infoboxModel = new InfoboxModel({
      state: this._isLayerHidden() ? 'layer-hidden' : ''
    });

    this._overlayModel = new Backbone.Model({
      visible: this._isLayerHidden()
    });

    this._editorModel.set({
      edition: false
    });
  },

  _isLayerHidden: function () {
    return this._layerDefinitionModel.get('visible') === false;
  },

  _initBinds: function () {
    this.listenTo(this._querySchemaModel, 'change:status', this._onStatusChanged);
    this.listenTo(this._queryGeometryModel, 'change:status', this._onStatusChanged);
    this.listenTo(this._queryRowsCollection.statusModel, 'change:status', this._onStatusChanged);
    this.listenTo(this._editorModel, 'change:edition', this._changeStyle);
  },

  _fetchAllQueryObjectsIfNecessary: function () {
    fetchAllQueryObjectsIfNecessary({
      queryRowsCollection: this._queryRowsCollection,
      queryGeometryModel: this._queryGeometryModel,
      querySchemaModel: this._querySchemaModel
    });
  },

  _onStatusChanged: function () {
    fetchAllQueryObjectsIfNecessary({
      queryRowsCollection: this._queryRowsCollection,
      queryGeometryModel: this._queryGeometryModel,
      querySchemaModel: this._querySchemaModel
    }, this.render);
  },

  _hasColumns: function () {
    if (!this._querySchemaModel.isFetched()) return false;

    var columns = this._querySchemaModel.columnsCollection.models;

    var filteredColumns = _(columns).filter(function (c) {
      return !_.contains(this._layerInfowindowModel.SYSTEM_COLUMNS, c.get('name'));
    }, this);

    return filteredColumns.length;
  },

  _canAddInfowindow: function () {
    var styleModel = this._layerDefinitionModel.styleModel;
    return styleModel && !styleModel.isAggregatedType() && !styleModel.isAnimation();
  },

  _renderPlaceholder: function () {
    if (this._layerInfowindowModel && !this._hasColumns()) {
      this.$el.append(popupPlaceholderTemplate({
        placeholder: _t('editor.layers.infowindow.placeholder-columns-text')
      }));
    } else if (!this._queryGeometryModel.hasValue()) {
      if (this._layerDefinitionModel.canBeGeoreferenced()) {
        this._renderGeoreferencePlaceholder();
      } else {
        this.$el.append(popupPlaceholderTemplate({
          placeholder: _t('editor.layers.infowindow.placeholder-geometry')
        }));
      }
    } else {
      this.$el.append(popupPlaceholderTemplate({
        placeholder: _t('editor.layers.infowindow.placeholder-interactivity-text')
      }));
    }
  },

  _renderGeoreferencePlaceholder: function () {
    var self = this;

    var infoboxSstates = [
      {
        state: 'layer-hidden',
        createContentView: function () {
          return Infobox.createWithAction({
            type: 'alert',
            title: _t('editor.infowindow.messages.layer-hidden.title'),
            body: _t('editor.infowindow.messages.layer-hidden.body'),
            mainAction: {
              label: _t('editor.infowindow.messages.layer-hidden.show')
            }
          });
        },
        mainAction: self._showHiddenLayer.bind(self)
      }
    ];

    var infoboxCollection = new InfoboxCollection(infoboxSstates);

    var panelWithOptionsView = new PanelWithOptionsView({
      template: panelTemplate,
      className: 'Editor-content',
      editorModel: self._editorModel,
      infoboxModel: self._infoboxModel,
      infoboxCollection: infoboxCollection,
      createContentView: function () {
        return ViewFactory.createByHTML(georeferencePlaceholderTemplate());
      }
    });

    this.$el.append(panelWithOptionsView.render().el);
    this.addView(panelWithOptionsView);
  },

  _renderLoading: function () {
    this.$el.append(loadingTemplate());
  },

  _initViews: function () {
    var self = this;

    var clickTemplate = _t('editor.layers.infowindow.style.none');
    var hoverTemplate = _t('editor.layers.tooltip.style.none');

    if (this._layerInfowindowModel.isCustomTemplate()) {
      clickTemplate = _t('editor.layers.infowindow.style.custom');
    } else if (this._layerInfowindowModel.hasTemplate()) {
      clickTemplate = _t('editor.layers.infowindow.style.' + this._layerInfowindowModel.get('template_name'));
    }

    if (this._layerTooltipModel.isCustomTemplate()) {
      hoverTemplate = _t('editor.layers.tooltip.style.custom');
    } else if (this._layerTooltipModel.hasTemplate()) {
      hoverTemplate = _t('editor.layers.tooltip.style.' + this._layerTooltipModel.get('template_name'));
    }

    var tabPaneTabs = [{
      name: 'click',
      label: _t('editor.layers.infowindow-menu-tab-pane-labels.click'),
      createContentView: function () {
        return new InfowindowView({
          model: self._layerInfowindowModel,
          className: 'Editor-content',
          querySchemaModel: self._querySchemaModel,
          userActions: self._userActions,
          editorModel: self._editorModel,
          layerDefinitionModel: self._layerDefinitionModel
        });
      },
      selectedChild: clickTemplate
    }, {
      name: 'hover',
      label: _t('editor.layers.infowindow-menu-tab-pane-labels.hover'),
      createContentView: function () {
        return new TooltipView({
          className: 'Editor-content',
          querySchemaModel: self._querySchemaModel,
          userActions: self._userActions,
          editorModel: self._editorModel,
          model: self._layerTooltipModel,
          layerDefinitionModel: self._layerDefinitionModel
        });
      },
      selectedChild: hoverTemplate
    }];

    var tabPaneOptions = {
      tabPaneOptions: {
        template: TabPaneTemplate,
        tabPaneItemOptions: {
          tagName: 'li',
          className: 'CDB-NavSubmenu-item'
        }
      },
      tabPaneItemLabelOptions: {
        tagName: 'button',
        className: 'CDB-NavSubmenu-link u-upperCase'
      }
    };

    this._layerTabPaneView = createTextLabelsTabPane(tabPaneTabs, tabPaneOptions);
    this.$el.append(this._layerTabPaneView.render().$el);
    this.addView(this._layerTabPaneView);
  },

  _changeStyle: function (m) {
    this._layerTabPaneView && this._layerTabPaneView.changeStyleMenu(m);
  },

  _updateSelectedChild: function () {
    var selectedChild;
    var selectedChildTxt;

    switch (this._layerTabPaneView.getSelectedTabPaneName()) {
      case 'click':
        selectedChild = this._layerInfowindowModel.get('template_name');
        selectedChildTxt = _t('editor.layers.infowindow.style.none');

        if (this._layerInfowindowModel.isCustomTemplate()) {
          selectedChildTxt = _t('editor.layers.infowindow.style.custom');
        } else if (this._layerInfowindowModel.hasTemplate()) {
          selectedChildTxt = _t('editor.layers.infowindow.style.' + selectedChild);
        }

        break;
      case 'hover':
        selectedChild = this._layerTooltipModel.get('template_name');
        selectedChildTxt = _t('editor.layers.tooltip.style.none');

        if (this._layerTooltipModel.isCustomTemplate()) {
          selectedChildTxt = _t('editor.layers.tooltip.style.custom');
        } else if (this._layerTooltipModel.hasTemplate()) {
          selectedChildTxt = _t('editor.layers.tooltip.style.' + selectedChild);
        }

        break;
    }

    this._layerTabPaneView.$('.js-menu .CDB-NavSubmenu-item.is-selected .js-NavSubmenu-status').html(selectedChildTxt);
    this._layerTabPaneView.$('.js-list .Carousel-item').removeClass('is-selected');
    this._layerTabPaneView.$('.js-list .Carousel-item.js-' + selectedChild).addClass('is-selected');
  },

  _bindEvents: function () {
    this._layerInfowindowModel.on('change:template', this._onChangeTemplate, this);
    this.add_related_model(this._layerInfowindowModel);
    this._layerTooltipModel.on('change:template', this._onChangeTemplate, this);
    this.add_related_model(this._layerTooltipModel);
  },

  _onChangeTemplate: function () {
    this._updateSelectedChild();
  },

  _showHiddenLayer: function () {
    var savingOptions = {
      shouldPreserveAutoStyle: true
    };
    this._layerDefinitionModel.toggleVisible();
    this._userActions.saveLayer(this._layerDefinitionModel, savingOptions);
  }
});

},{"../../../../components/infobox/infobox-collection":215,"../../../../components/infobox/infobox-factory":216,"../../../../components/infobox/infobox-model":219,"../../../../components/tab-pane/create-text-labels-tab-pane":537,"../../../../components/view-factory":594,"../../../../components/view-options/panel-with-options-view":595,"../../../../helpers/fetch-all-query-objects":1092,"../../../../helpers/required-opts":1097,"../../../components/overlay/overlay-view":694,"../../../tab-pane-submenu.tpl":1054,"../../panel-loading-template.tpl":996,"./georeference-placeholder.tpl":899,"./infowindow-click-view":903,"./infowindow-hover-view":914,"./panel-with-options.tpl":927,"./popups-placeholder.tpl":928,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],927:[function(require,module,exports){
arguments[4][882][0].apply(exports,arguments)
},{"dup":882,"underscore":"underscore"}],928:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h2 class="CDB-Text CDB-Size-huge is-light u-secondaryTextColor">'+
((__t=( placeholder ))==null?'':_.escape(__t))+
'</h2>\n';
}
return __p;
};

},{"underscore":"underscore"}],929:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="58px" height="32px" viewBox="494 496 58 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g id="PopUp-Copy-3" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(494.000000, 496.000000)">\n        <path d="M2.99306965,0 L55.0069304,0 C56.1076723,0 57,0.889261723 57,2.00174332 L57,29.9982567 C57,31.103789 56.1032859,32 55.0073354,32 L18.4262695,32 L9,32 L0.998101354,32 L1,2.00174332 C1,0.89621101 1.90230818,0 2.99306965,0 Z" id="Rectangle-2087" fill="#2E3C43"></path>\n        <rect id="Rectangle-679" fill="#636D72" x="6" y="15" width="45" height="2"></rect>\n        <rect id="Rectangle-680" fill="#636D72" x="6" y="19" width="26" height="2"></rect>\n        <rect id="Rectangle-680" fill="#636D72" x="6" y="23" width="19" height="2"></rect>\n        <rect id="Rectangle-680" fill="#636D72" x="6" y="11" width="26" height="2"></rect>\n        <rect id="Rectangle-680" fill="#636D72" x="6" y="7" width="36" height="2"></rect>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],930:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="58px" height="34px" viewBox="429 496 58 34" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g id="PopUp-Copy-2" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(429.000000, 497.000000)">\n        <path d="M2.99306965,0 L55.0069304,0 C56.1076723,0 57,0.889261723 57,2.00174332 L57,29.9982567 C57,31.103789 56.1032859,32 55.0073354,32 L18.4262695,32 L9,32 L0.998101354,32 L1,2.00174332 C1,0.89621101 1.90230818,0 2.99306965,0 Z" id="Rectangle-2087" stroke="#EEEEEE" fill="#FFFFFF"></path>\n        <rect id="Rectangle-679" fill="#DDDDDD" x="5" y="14" width="45" height="2"></rect>\n        <rect id="Rectangle-680" fill="#DDDDDD" x="5" y="18" width="26" height="2"></rect>\n        <rect id="Rectangle-680" fill="#DDDDDD" x="5" y="22" width="19" height="2"></rect>\n        <rect id="Rectangle-680" fill="#DDDDDD" x="5" y="10" width="26" height="2"></rect>\n        <rect id="Rectangle-680" fill="#DDDDDD" x="5" y="6" width="36" height="2"></rect>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],931:[function(require,module,exports){
arguments[4][920][0].apply(exports,arguments)
},{"dup":920,"underscore":"underscore"}],932:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./apply-button.tpl');

module.exports = CoreView.extend({
  events: {
    'click .js-apply': '_onApplyClick'
  },

  initialize: function (opts) {
    if (!opts.onApplyClick) throw new Error('onApplyClick is required');
  },

  render: function () {
    this.$el.html(template());
    return this;
  },

  _onApplyClick: function () {
    this.options.onApplyClick();
  }
});

},{"./apply-button.tpl":933,"backbone/core-view":1127}],933:[function(require,module,exports){
arguments[4][901][0].apply(exports,arguments)
},{"dup":901,"underscore":"underscore"}],934:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="42px" height="18px" viewBox="7 7 42 18" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g id="Group" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(7.000000, 7.000000)">\n        <rect id="Rectangle-680" fill="#DDDDDD" x="0" y="0" width="11" height="2"></rect>\n        <rect id="Rectangle-680" fill="#DDDDDD" x="0" y="4" width="9" height="2"></rect>\n        <rect id="Rectangle-680" fill="#DDDDDD" x="0" y="8" width="16" height="2"></rect>\n        <rect id="Rectangle-680" fill="#DDDDDD" x="0" y="12" width="13" height="2"></rect>\n        <rect id="Rectangle-680" fill="#DDDDDD" x="0" y="16" width="16" height="2"></rect>\n        <ellipse id="Oval-1585" fill-opacity="0.2" fill="#9DE0AD" cx="33" cy="9" rx="9" ry="9"></ellipse>\n        <ellipse id="Oval-1585" fill-opacity="0.4" fill="#9DE0AD" cx="33" cy="11" rx="7" ry="7"></ellipse>\n        <ellipse id="Oval-1585" fill-opacity="0.5" fill="#9DE0AD" cx="33" cy="13" rx="5" ry="5"></ellipse>\n        <ellipse id="Oval-1585" fill-opacity="0.8" fill="#9DE0AD" cx="33" cy="15" rx="3" ry="3"></ellipse>\n        <ellipse id="Oval-1585" fill="#9DE0AD" cx="33" cy="17" rx="1" ry="1"></ellipse>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],935:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="56px" height="32px" viewBox="529 429 56 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <defs>\n    <rect id="path-1" x="0" y="0" width="56" height="32" rx="2"></rect>\n    <mask id="mask-2" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="56" height="32" fill="white">\n        <use xlink:href="#path-1"></use>\n    </mask>\n  </defs>\n  <g id="category" transform="translate(529.000000, 429.000000)">\n    <use id="Rectangle-2" stroke="#EEEEEE" mask="url(#mask-2)" stroke-width="2" fill="#FFFFFF" xlink:href="#path-1"></use>\n    <rect id="Rectangle-679" fill="#DDDDDD" x="7" y="15" width="23" height="2"></rect>\n    <rect id="Rectangle-680" fill="#DDDDDD" x="7" y="19" width="13" height="2"></rect>\n    <rect id="Rectangle-680" fill="#DDDDDD" x="7" y="23" width="10" height="2"></rect>\n    <rect id="Rectangle-680" fill="#DDDDDD" x="7" y="11" width="13" height="2"></rect>\n    <rect id="Rectangle-680" fill="#DDDDDD" x="7" y="7" width="19" height="2"></rect>\n    <rect id="Rectangle-680" fill="#9CE0AC" x="45" y="7" width="3" height="2"></rect>\n    <rect id="Rectangle-680" fill="#F4F1DE" x="45" y="11" width="3" height="2"></rect>\n    <rect id="Rectangle-680" fill="#E17C60" x="45" y="15" width="3" height="2"></rect>\n    <rect id="Rectangle-680" fill="#3D3F5B" x="45" y="19" width="3" height="2"></rect>\n    <rect id="Rectangle-680" fill="#F2CD8F" x="45" y="23" width="3" height="2"></rect>\n  </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],936:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="56px" height="32px" viewBox="529 429 56 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <defs>\n    <rect id="path-1" x="0" y="0" width="56" height="32" rx="2"></rect>\n    <mask id="mask-2" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="56" height="32" fill="white">\n        <use xlink:href="#path-1"></use>\n    </mask>\n  </defs>\n  <g id="category" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(529.000000, 429.000000)">\n    <use id="Rectangle-2" stroke="#EEEEEE" mask="url(#mask-2)" stroke-width="2" fill="#FFFFFF" xlink:href="#path-1"></use>\n    <rect id="Rectangle-679" fill="#DDDDDD" x="14" y="15" width="23" height="2"></rect>\n    <rect id="Rectangle-680" fill="#DDDDDD" x="14" y="19" width="13" height="2"></rect>\n    <rect id="Rectangle-680" fill="#DDDDDD" x="14" y="23" width="10" height="2"></rect>\n    <rect id="Rectangle-680" fill="#DDDDDD" x="14" y="11" width="13" height="2"></rect>\n    <rect id="Rectangle-680" fill="#DDDDDD" x="14" y="7" width="19" height="2"></rect>\n    <rect id="Rectangle-680" fill="#9CE0AC" x="7" y="7" width="3" height="2"></rect>\n    <rect id="Rectangle-680" fill="#F4F1DE" x="7" y="11" width="3" height="2"></rect>\n    <rect id="Rectangle-680" fill="#E17C60" x="7" y="15" width="3" height="2"></rect>\n    <rect id="Rectangle-680" fill="#3D3F5B" x="7" y="19" width="3" height="2"></rect>\n    <rect id="Rectangle-680" fill="#F2CD8F" x="7" y="23" width="3" height="2"></rect>\n  </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],937:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="54px" height="24px" viewBox="519 458 54 24" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <defs>\n    <linearGradient x1="90.736547%" y1="49.7500002%" x2="9.63471511%" y2="49.7500002%" id="linearGradient-1">\n      <stop stop-color="#C11F22" offset="0%"></stop>\n      <stop stop-color="#F53F15" offset="23.9588524%"></stop>\n      <stop stop-color="#FF9030" offset="49.5142003%"></stop>\n      <stop stop-color="#FFCF52" offset="75.4982561%"></stop>\n      <stop stop-color="#FFFEAE" offset="100%"></stop>\n    </linearGradient>\n  </defs>\n  <g id="color" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(519.000000, 458.000000)">\n    <rect id="bg" fill="#FFFFFF" x="0" y="0" width="54" height="23" rx="2"></rect>\n    <path d="M1,20.9991358 C1,21.5484057 1.45096651,22 2.00209026,22 L51.9979097,22 C52.5538814,22 53,21.5535154 53,20.9991358 L53,2.00086422 C53,1.45159429 52.5490335,1 51.9979097,1 L2.00209026,1 C1.44611861,1 1,1.44648455 1,2.00086422 L1,20.9991358 Z M2.00209026,0 L51.9979097,0 C53.1036337,0 54,0.901627257 54,2.00086422 L54,20.9991358 C54,22.1041826 53.1077828,23 51.9979097,23 L2.00209026,23 C0.896366344,23 0,22.0983727 0,20.9991358 L0,2.00086422 C0,0.895817426 0.892217249,0 2.00209026,0 Z" id="Rectangle-2087-Copy" fill="#EEEEEE"></path>\n    <rect id="Rectangle-680" fill="url(#linearGradient-1)" x="6" y="12" width="42" height="5"></rect>\n    <rect id="Rectangle-680" fill="#DDDDDD" x="6" y="6" width="6" height="2"></rect>\n    <rect id="Rectangle-680" fill="#DDDDDD" x="42" y="6" width="6" height="2"></rect>\n  </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],938:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text CDB-Size-small u-upperCase u-altTextColor">None</p>';
}
return __p;
};

},{"underscore":"underscore"}],939:[function(require,module,exports){
arguments[4][898][0].apply(exports,arguments)
},{"dup":898,"underscore":"underscore"}],940:[function(require,module,exports){
var _ = require('underscore');

module.exports = [
  {
    value: 'none',
    legendIcon: require('../carousel-icons/none.tpl'),
    label: _t('editor.legend.types.none')
  }, {
    value: 'category',
    legendIcon: require('../carousel-icons/category.tpl'),
    label: _t('editor.legend.types.category'),
    isStyleCompatible: function (styleModel) {
      var type = styleModel.get('type');
      var fill = styleModel.get('fill');
      var stroke = styleModel.get('stroke');
      var color;

      if (!fill && !stroke || _.isEmpty(fill) && _.isEmpty(stroke)) return false;

      color = fill && fill.color || stroke && stroke.color;
      return (type === 'animation') ||
             color && color.quantification === 'category' ||
             color && color.attribute && color.attribute_type && color.attribute_type === 'string';
    }
  }, {
    value: 'choropleth',
    legendIcon: require('../carousel-icons/gradient.tpl'),
    label: _t('editor.legend.types.gradient'),
    isStyleCompatible: function (styleModel) {
      var type = styleModel.get('type');
      var fill = styleModel.get('fill');
      var stroke = styleModel.get('stroke');
      var color;

      if (type === 'animation' || type === 'heatmap') return false;
      if (!fill && !stroke || _.isEmpty(fill) && _.isEmpty(stroke)) return false;

      color = fill && fill.color || stroke && stroke.color;

      if (color && color.quantification === 'category') return false;

      return color && color.attribute && (color.attribute_type === undefined || color.attribute_type && color.attribute_type !== 'string');
    }
  }, {
    value: 'custom_choropleth',
    legendIcon: require('../carousel-icons/gradient.tpl'),
    label: _t('editor.legend.types.gradient'),
    isStyleCompatible: function (styleModel) {
      var type = styleModel.get('type');
      var fill = styleModel.get('fill');
      var stroke = styleModel.get('stroke');
      var color;

      if (!fill && !stroke || _.isEmpty(fill) && _.isEmpty(stroke)) return false;

      color = fill && fill.color || stroke && stroke.color;
      return type === 'heatmap' && color && color.attribute && (color.attribute_type === undefined || color.attribute_type && color.attribute_type !== 'string');
    }
  }, {
    value: 'custom',
    legendIcon: require('../carousel-icons/custom.tpl'),
    label: _t('editor.legend.types.custom')
  }
];

},{"../carousel-icons/category.tpl":935,"../carousel-icons/custom.tpl":936,"../carousel-icons/gradient.tpl":937,"../carousel-icons/none.tpl":938,"underscore":"underscore"}],941:[function(require,module,exports){
var LegendTypes = require('./legend-color-types');
var LegendTypeBaseView = require('../legend-base-type-view');

module.exports = LegendTypeBaseView.extend({
  initialize: function (opts) {
    this.legendTypes = LegendTypes;
    LegendTypeBaseView.prototype.initialize.call(this, opts);
  }
});

},{"../legend-base-type-view":955,"./legend-color-types":940}],942:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul>\n  ';
 for(var i in items) { 
__p+='\n    <li class="Legend-categoryListItem u-flex u-justifySpace u-alignCenter">\n      <p class="Legend-categoryTitle CDB-Text CDB-Size-small u-upperCase u-ellipsis" title="'+
((__t=( items[i].title ))==null?'':__t)+
'">'+
((__t=( items[i].title ))==null?'':__t)+
'</p>\n      ';
 if (items[i].color) { 
__p+='\n        <span class="Legend-categoryCircle" style="opacity:1; background: '+
((__t=( items[i].color ))==null?'':__t)+
';"></span>\n      ';
 } else if (items[i].icon) { 
__p+='\n        <span class="Legend-categoryIcon js-image-container" data-icon="'+
((__t=( items[i].icon ))==null?'':__t)+
'" ';
 if (items[i].color) { 
__p+='data-color="'+
((__t=( items[i].color ))==null?'':__t)+
'"';
 } 
__p+='></span>\n      ';
 } 
__p+='\n    </li>\n  ';
 } 
__p+='\n</ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],943:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

/*
  Base model form legend.
 */
module.exports = Backbone.Model.extend({
  defaults: {
    type: 'none',
    title: ''
  },

  initialize: function (attrs, opts) {
    if (!opts.legendDefinitionModel) throw new Error('legendDefinitionModel is required');
    this.legendDefinitionModel = opts.legendDefinitionModel;

    this.schema = this._generateSchema();
  },

  _generateSchema: function () {
    return {
      title: {
        type: 'EnablerEditor',
        title: '',
        label: _t('editor.legend.legend-form.title'),
        defaultValue: this._titlePlaceholder,
        editor: {
          type: 'Text',
          editorAttrs: {
            placeholder: this._titlePlaceholder
          }
        }
      }
    };
  },

  toJSON: function () {
    return _.extend(
      this.attributes,
      {
        type: this.get('type')
      }
    );
  }
});

},{"backbone":"backbone","underscore":"underscore"}],944:[function(require,module,exports){
var _ = require('underscore');
var LegendBaseDefModel = require('./legend-base-definition-form-model');
var LegendColorHelper = require('./legend-color-helper');

module.exports = LegendBaseDefModel.extend({
  defaults: _.extend({}, LegendBaseDefModel.prototype.defaults,
    {
      type: 'bubble',
      fillColor: null
    }
  ),

  initialize: function (attrs, opts) {
    this._titlePlaceholder = _t('editor.legend.legend-form.by-size');
    LegendBaseDefModel.prototype.initialize.call(this, attrs, opts);

    this.on('change:fill', function () {
      this.set('fillColor', this.get('fill').color.fixed);
    }, this);

    this._initialColor();
  },

  toJSON: function () {
    return _.extend(
      {},
      _.omit(this.attributes, 'fill')
    );
  },

  _initialColor: function () {
    var color = this.legendDefinitionModel.get('fillColor');
    var fill = LegendColorHelper.getBubbles(color);
    this.set({fill: fill});
  },

  _generateSchema: function () {
    var schema = LegendBaseDefModel.prototype._generateSchema.call(this);
    return _.extend(
      schema,
      {
        fill: {
          type: 'Fill',
          title: _t('editor.legend.legend-form.fill'),
          options: [],
          dialogMode: 'float',
          editorAttrs: {
            color: {
              hidePanes: ['value']
            }
          }
        },
        topLabel: {
          type: 'EnablerEditor',
          title: '',
          label: _t('editor.legend.legend-form.top-label'),
          editor: {
            type: 'Text',
            editorAttrs: {
              placeholder: _t('editor.legend.legend-form.custom-label-placeholder')
            }
          }
        },
        bottomLabel: {
          type: 'EnablerEditor',
          title: '',
          label: _t('editor.legend.legend-form.bottom-label'),
          editor: {
            type: 'Text',
            editorAttrs: {
              placeholder: _t('editor.legend.legend-form.custom-label-placeholder')
            }
          }
        }
      }
    );
  }
});

},{"./legend-base-definition-form-model":943,"./legend-color-helper":947,"underscore":"underscore"}],945:[function(require,module,exports){
var _ = require('underscore');
var LegendBaseDefModel = require('./legend-base-definition-form-model');

module.exports = LegendBaseDefModel.extend({
  defaults: _.extend({}, LegendBaseDefModel.prototype.defaults,
    {
      type: 'category'
    }
  ),

  initialize: function (attrs, opts) {
    this._titlePlaceholder = _t('editor.legend.legend-form.by-color');
    LegendBaseDefModel.prototype.initialize.call(this, attrs, opts);
  }
});

},{"./legend-base-definition-form-model":943,"underscore":"underscore"}],946:[function(require,module,exports){
var _ = require('underscore');
var LegendBaseDefModel = require('./legend-base-definition-form-model');

module.exports = LegendBaseDefModel.extend({
  defaults: _.extend({}, LegendBaseDefModel.prototype.defaults,
    {
      type: 'choropleth',
      prefix: '',
      suffix: '',
      leftLabel: '',
      rightLabel: ''
    }
  ),

  initialize: function (attrs, opts) {
    this._titlePlaceholder = _t('editor.legend.legend-form.by-color');
    LegendBaseDefModel.prototype.initialize.call(this, attrs, opts);
  },

  _generateSchema: function () {
    var schema = LegendBaseDefModel.prototype._generateSchema.call(this);
    return _.extend(
      schema,
      {
        leftLabel: {
          type: 'EnablerEditor',
          title: '',
          label: _t('editor.legend.legend-form.left-label'),
          editor: {
            type: 'Text',
            editorAttrs: {
              placeholder: _t('editor.legend.legend-form.custom-label-placeholder')
            }
          }
        },
        rightLabel: {
          type: 'EnablerEditor',
          title: '',
          label: _t('editor.legend.legend-form.right-label'),
          editor: {
            type: 'Text',
            editorAttrs: {
              placeholder: _t('editor.legend.legend-form.custom-label-placeholder')
            }
          }
        },
        suffix: {
          type: 'EnablerEditor',
          title: '',
          label: _t('editor.legend.legend-form.suffix'),
          editor: {
            type: 'Text'
          }
        },
        prefix: {
          type: 'EnablerEditor',
          title: '',
          label: _t('editor.legend.legend-form.prefix'),
          editor: {
            type: 'Text'
          }
        }
      }
    );
  }
});

},{"./legend-base-definition-form-model":943,"underscore":"underscore"}],947:[function(require,module,exports){
var _ = require('underscore');

function buildSwatch (color, name, icon) {
  if (_.isString(color)) {
    color = {
      fixed: color,
      opacity: 1,
      image: icon
    };
  }

  return {
    fill: {
      color: color
    },
    title: name
  };
}

function _unquote (c) {
  return c && c.replace && c.replace(/^"(.+(?="$))"$/, '$1');
}

function simpleColor (color) {
  return [buildSwatch(color, '', color.image || '')];
}

function collectionColor (color) {
  var range = color.range.length;
  return _.range(range).map(function (v, index) {
    // if style attribute is number there is no domain (choropleth)
    return buildSwatch(
      color.range[index],
      color.domain && _unquote(color.domain[index]) || '',
      color.images && color.images[index]);
  });
}

module.exports = {
  buildSwatch: buildSwatch,
  getCategories: function (color) {
    if (color.fixed !== undefined) {
      return simpleColor(color);
    } else if (color.attribute) {
      return collectionColor(color);
    }
  },

  unquoteColor: _unquote,
  getBubbles: function (color) {
    return _.omit(_.first(this.getCategories(color)), 'title').fill;
  }
};

},{"underscore":"underscore"}],948:[function(require,module,exports){
var _ = require('underscore');

function rotateCollection (array) {
  var first = _.first(array);
  array = _.rest(array);
  return array.concat([first]);
}

var COLORS = [
  '#66B79E',
  '#E65176',
  '#528995',
  '#FF710F',
  '#305482',
  '#CCD859',
  '#565175',
  '#FFB927',
  '#3EBCAE',
  '#E54C1F'
];

module.exports = {
  getNextColor: function () {
    COLORS = rotateCollection(COLORS);
    return _.first(COLORS);
  },

  getColors: function () {
    return COLORS;
  },

  setColors: function (collection) {
    COLORS = collection;
  }
};

},{"underscore":"underscore"}],949:[function(require,module,exports){
var _ = require('underscore');
var LegendBaseDefModel = require('./legend-choropleth-definition-form-model');

module.exports = LegendBaseDefModel.extend({
  defaults: _.extend({}, LegendBaseDefModel.prototype.defaults,
    {
      type: 'custom_choropleth'
    }
  )
});

},{"./legend-choropleth-definition-form-model":946,"underscore":"underscore"}],950:[function(require,module,exports){
var _ = require('underscore');
var LegendBaseDefModel = require('./legend-base-definition-form-model');
var NestedCategory = require('./legend-nested-category-definition-form-model');
var templateItem = require('./legend-list-item.tpl');
var templateList = require('./legend-list.tpl');
var LegendColorHelper = require('./legend-color-helper');

module.exports = LegendBaseDefModel.extend({
  defaults: _.extend({}, LegendBaseDefModel.prototype.defaults,
    {
      type: 'custom',
      items: []
    }
  ),

  initialize: function (attrs, opts) {
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.modals) throw new Error('configModel is required');

    this._userModel = opts.userModel;
    this._configModel = opts.configModel;
    this._modals = opts.modals;

    this._titlePlaceholder = _t('editor.legend.legend-form.by-color');
    LegendBaseDefModel.prototype.initialize.call(this, attrs, opts);

    this._initialItems();
  },

  _initialItems: function () {
    var items;
    var categories = this.legendDefinitionModel.get('items');
    items = categories.map(function (v, index) {
      return LegendColorHelper.buildSwatch(v.color, v.title, v.icon);
    });
    this.set({items: items});
  },

  _generateSchema: function () {
    var schema = LegendBaseDefModel.prototype._generateSchema.call(this);
    return _.extend(
      schema,
      {
        items: {
          type: 'SortableList',
          itemType: 'CategoryModel',
          model: NestedCategory,
          title: '',
          itemTemplate: templateItem,
          listTemplate: templateList,
          editorAttrs: {
            className: 'u-flex',
            userModel: this._userModel,
            configModel: this._configModel,
            modals: this._modals
          }
        }
      }
    );
  },

  toJSON: function () {
    return _.extend(
      {},
      _.omit(this.attributes, 'items'),
      {
        items: this.get('items').map(function (item) {
          return {
            title: item.title,
            color: item.fill.color.fixed,
            image: item.fill.color.image
          };
        })
      }
    );
  }
});

},{"./legend-base-definition-form-model":943,"./legend-color-helper":947,"./legend-list-item.tpl":951,"./legend-list.tpl":952,"./legend-nested-category-definition-form-model":953,"underscore":"underscore"}],951:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="LegendItem js-sortable">\n  <div class="LegendItem-listFieldsOrder CDB-Shape">\n    <div class="CDB-Shape-rectsHandle is-small">\n      <div class="CDB-Shape-rectsHandleItem CDB-Shape-rectsHandleItem--grey is-first"></div>\n      <div class="CDB-Shape-rectsHandleItem CDB-Shape-rectsHandleItem--grey is-second"></div>\n      <div class="CDB-Shape-rectsHandleItem CDB-Shape-rectsHandleItem--grey is-third"></div>\n    </div>\n  </div>\n  <div data-editor class="u-grow">\n  </div>\n  <button class="LegendItem-deteleButton" type="button" data-action="remove">\n    <svg width="8px" height="8px" viewBox="435 377 8 8" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n      <path d="M436,380 L442,380 L442,384.000193 C442,384.552371 441.549025,385 441.009222,385 L436.990778,385 C436.443586,385 436,384.556283 436,384.000193 L436,380 Z M435,378 L443,378 L443,379 L435,379 L435,378 Z M437,377 L441,377 L441,378 L437,378 L437,377 Z" id="Delete" stroke="none" fill="#AAAAAA" fill-rule="evenodd"></path>\n    </svg>\n  </button>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],952:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-grow  LegendItems-container">\n  <div data-items class="u-bSpace--xl">\n\n  </div>\n  <div class="u-flex u-justifyEnd" style="width: 100%;"> <!-- We need a fucking u-full helper -->\n    <button class="CDB-Text CDB-Size-small u-actionTextColor u-upperCase" type="button" data-action="add">\n      '+
((__t=( _t('editor.legend.legend-form.add') ))==null?'':_.escape(__t))+
'\n    </button>\n  </div>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],953:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var LegendColors = require('./legend-color-range');

var defaultFill = {
  color: {
    fixed: '#fabada',
    opacity: 0.9
  }
};

module.exports = Backbone.Model.extend({
  schema: {
    fill: {
      type: 'Fill',
      title: '',
      options: [],
      dialogMode: 'float',
      editorAttrs: {
        color: {
          hidePanes: ['value'],
          imageEnabled: true
        },
        className: 'LegendItem-inner'
      }
    },
    title: {
      type: 'Text',
      title: '',
      editorAttrs: {
        className: 'LegendItem-inner',
        placeholder: _t('editor.legend.legend-form.untitled')
      }
    }
  },

  initialize: function (attrs, opts) {
    this._userModel = opts.userModel;
    this._configModel = opts.configModel;
    this._modals = opts.modals;

    this._setOptions();

    var fill = _.clone(defaultFill);
    if (attrs.fill === undefined) {
      fill.color.fixed = LegendColors.getNextColor();
      this.set({fill: fill}, {silent: true});
    }
  },

  _setOptions: function () {
    this.schema.fill.editorAttrs.userModel = this._userModel;
    this.schema.fill.editorAttrs.configModel = this._configModel;
    this.schema.fill.editorAttrs.modals = this._modals;
  }
});

},{"./legend-color-range":948,"backbone":"backbone","underscore":"underscore"}],954:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h2 class="CDB-Text CDB-Size-huge is-light u-secondaryTextColor">'+
((__t=( _t('editor.legend.no-geometry-data') ))==null?'':_.escape(__t))+
' '+
((__t=( _t('editor.layers.georeference.manually-add') ))==null?'':_.escape(__t))+
'</h2>\n<div class="BlockList-item is-dashed no-hover is-space u-tSpace-xl">\n  <ul class="HorizontalBlockList">\n    <li class="HorizontalBlockList-item"></li>\n    <li class="HorizontalBlockList-item"></li>\n  </ul>\n\n  <button class="CDB-Button CDB-Button--primary js-georeference">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('editor.layers.georeference.georeference-button') ))==null?'':_.escape(__t))+
'</span>\n  </button>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],955:[function(require,module,exports){
var cdb = require('cartodb.js');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var PanelWithOptionsView = require('../../../../components/view-options/panel-with-options-view');
var LegendContentView = require('./legend-content-view');
var LegendEditorView = require('./legend-editor-view');
var ScrollView = require('../../../../components/scroll/scroll-view');
var TabPaneView = require('../../../../components/tab-pane/tab-pane-view');
var TabPaneCollection = require('../../../../components/tab-pane/tab-pane-collection');
var Toggler = require('../../../../components/toggler/toggler-view');
var ApplyView = require('./apply-button-view');
var Infobox = require('../../../../components/infobox/infobox-factory');
var InfoboxModel = require('../../../../components/infobox/infobox-model');
var InfoboxCollection = require('../../../../components/infobox/infobox-collection');
var LegendDefinitionModel = require('../../../../data/legends/legend-base-definition-model');
var LegendFactory = require('./legend-factory');
var htmlTemplate = require('./color/legend-custom-template.tpl');

var REQUIRED_OPTS = [
  'mapDefinitionModel',
  'layerDefinitionModel',
  'editorModel',
  'modelView',
  'legendDefinitionsCollection',
  'type',
  'userActions',
  'userModel',
  'configModel',
  'modals'
];

var PLACEHOLDER = '[[Legend]]';
var HTML_TEMPLATE = _.template('<%= preSnippet %>\r\n<%- placeholder %>\r\n<%= postSnippet %>');

module.exports = CoreView.extend({
  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    // this.legendTypes is defined in the subview
    this._legendDefinitionModel = this._getUserLegend(this.legendTypes);

    this._codemirrorModel = new Backbone.Model({
      content: this._getEditorContent()
    });

    this._editorModel.set({
      edition: this._legendDefinitionModel.hasCustomHtml(),
      disabled: this._isToggleDisable() // if there is an sql error or none style is selected, set to true
    });

    this._infoboxModel = new InfoboxModel({
      state: ''
    });

    this._overlayModel = new Backbone.Model({
      visible: this._isLayerHidden() || this._legendDefinitionModel.hasCustomHtml()
    });

    this._infoboxState();
    this._configPanes();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _getEditorContent: function () {
    var content;
    var type = this._legendDefinitionModel.get('type');

    if (type === 'custom') {
      if (this._legendDefinitionModel.hasCustomHtml()) {
        content = this._legendDefinitionModel.get('html');
      } else {
        content = '';
      }
    } else {
      content = this._getReadOnlyContent();
    }

    return content;
  },

  _getReadOnlyContent: function () {
    var content = HTML_TEMPLATE({
      preSnippet: this._legendDefinitionModel.get('preHTMLSnippet') || _t('editor.legend.code-mirror.pre-html'),
      placeholder: PLACEHOLDER,
      postSnippet: this._legendDefinitionModel.get('postHTMLSnippet') || _t('editor.legend.code-mirror.post-html')
    });

    return content;
  },

  _getCustomContent: function () {
    var items;
    var result = this._legendDefinitionModel.get('html');
    if (result === '') {
      items = this._legendDefinitionModel.get('items');
      result = htmlTemplate({items: items});
    }
    return result;
  },

  _handleEditorContent: function (expertMode) {
    var type = this._legendDefinitionModel.get('type');
    if (expertMode) {
      this._codemirrorModel.set({content: type === 'custom' ? this._getCustomContent() : this._getReadOnlyContent()});
    }
  },

  _getUserLegend: function (types) {
    var self = this;
    var values = _.map(types, function (type) { return type.value; });
    var selected = this._legendDefinitionsCollection.find(function (legendDefModel) {
      return values.indexOf(legendDefModel.get('type')) !== -1 && legendDefModel.layerDefinitionModel.id === self._layerDefinitionModel.id;
    });

    if (selected === undefined) {
      selected = new LegendDefinitionModel(null, {
        layerDefinitionModel: this._layerDefinitionModel,
        configModel: this._legendDefinitionsCollection.configModel,
        vizId: this._legendDefinitionsCollection.vizId
      });
    }

    return selected;
  },

  _isToggleDisable: function () {
    return this._modelView.get('state') === 'error' || this._legendDefinitionModel.get('type') === 'none' || this._areLegendsDisabled();
  },

  _isLayerHidden: function () {
    return this._layerDefinitionModel.get('visible') === false;
  },

  _initBinds: function () {
    this.listenTo(this._editorModel, 'change:edition', this._onChangeEdition);
    this.add_related_model(this._editorModel);

    this.listenTo(this._modelView, 'change:state', this._infoboxState);
    this.add_related_model(this._modelView);

    this.listenTo(this._layerDefinitionModel, 'change:visible', this._infoboxState);
    this.add_related_model(this._layerDefinitionModel);

    this.listenTo(this._mapDefinitionModel, 'change:legends', this._infoboxState);
    this.add_related_model(this._mapDefinitionModel);
  },

  _onChangeState: function () {
    var isDisabled = this._modelView.get('state') === 'error';
    this._editorModel.set({disabled: isDisabled});
  },

  _onChangeEdition: function () {
    this._infoboxState();

    var edition = this._editorModel.get('edition');
    this._handleEditorContent(edition);

    var index = edition ? 1 : 0;
    this._collectionPane.at(index).set({ selected: true });
  },

  _initViews: function () {
    var self = this;

    var infoboxSstates = [
      {
        state: 'html-legend',
        createContentView: function () {
          return Infobox.createWithAction({
            type: 'alert',
            title: _t('editor.legend.messages.custom-legend.title'),
            body: _t('editor.legend.messages.custom-legend.body'),
            mainAction: {
              label: _t('editor.legend.messages.custom-legend.accept')
            }
          });
        },
        mainAction: self._deleteCustomHtmlLegend.bind(self)
      }, {
        state: 'layer-hidden',
        createContentView: function () {
          return Infobox.createWithAction({
            type: 'alert',
            title: _t('editor.legend.messages.layer-hidden.title'),
            body: _t('editor.legend.messages.layer-hidden.body'),
            mainAction: {
              label: _t('editor.legend.messages.layer-hidden.show')
            }
          });
        },
        mainAction: self._showHiddenLayer.bind(self)
      }, {
        state: 'legends-disabled',
        createContentView: function () {
          return Infobox.createWithAction({
            type: 'alert',
            title: _t('editor.legend.messages.legends-disabled.title'),
            body: _t('editor.legend.messages.legends-disabled.body'),
            mainAction: {
              label: _t('editor.legend.messages.legends-disabled.show')
            }
          });
        },
        mainAction: self._enableLegends.bind(self)
      }
    ];

    var infoboxCollection = new InfoboxCollection(infoboxSstates);

    var panelWithOptionsView = new PanelWithOptionsView({
      className: 'Editor-content',
      editorModel: self._editorModel,
      infoboxModel: self._infoboxModel,
      infoboxCollection: infoboxCollection,
      createContentView: function () {
        return new TabPaneView({
          collection: self._collectionPane
        });
      },
      createControlView: function () {
        return new Toggler({
          editorModel: self._editorModel,
          labels: [_t('editor.legend.data-toggle.values'), _t('editor.legend.data-toggle.html')],
          isDisableable: true
        });
      },
      createActionView: function () {
        return new TabPaneView({
          collection: self._collectionPane,
          createContentKey: 'createActionView'
        });
      }
    });

    this.$el.append(panelWithOptionsView.render().el);
    this.addView(panelWithOptionsView);
  },

  _showHiddenLayer: function () {
    var savingOptions = {
      shouldPreserveAutoStyle: true
    };
    this._layerDefinitionModel.toggleVisible();
    this._userActions.saveLayer(this._layerDefinitionModel, savingOptions);
  },

  _deleteCustomHtmlLegend: function () {
    var type = this._legendDefinitionModel.get('type');
    this._legendDefinitionModel && this._legendDefinitionModel.set({
      html: ''
    });
    LegendFactory.createLegend(this._layerDefinitionModel, type);
    this._infoboxState();
  },

  _saveLegendHTML: function () {
    var content = this._codemirrorModel.get('content');
    var type = this._legendDefinitionModel.get('type');
    var parts;

    if (type === 'custom') {
      this._legendDefinitionModel && this._legendDefinitionModel.set({
        html: content
      });
    } else {
      parts = content.split(PLACEHOLDER).map(function (part) {
        return cdb.core.sanitize.html(part);
      });

      this._legendDefinitionModel && this._legendDefinitionModel.set({
        preHTMLSnippet: parts[0],
        postHTMLSnippet: parts[1]
      });
    }

    LegendFactory.createLegend(this._layerDefinitionModel, type);
  },

  _infoboxState: function () {
    var edition = this._editorModel.get('edition');

    if (!edition && this._areLegendsDisabled()) {
      this._infoboxModel.set({state: 'legends-disabled'});
      this._overlayModel.set({visible: true});
    } else if (!edition && this._legendDefinitionModel.hasCustomHtml()) {
      this._infoboxModel.set({state: 'html-legend'});
      this._overlayModel.set({visible: true});
    } else if (!edition && this._isLayerHidden()) {
      this._infoboxModel.set({state: 'layer-hidden'});
      this._overlayModel.set({visible: true});
    } else {
      this._infoboxModel.set({state: ''});
      this._overlayModel.set({visible: false});
    }
  },

  _areLegendsDisabled: function () {
    return this._mapDefinitionModel.get('legends') === false;
  },

  _enableLegends: function () {
    this._mapDefinitionModel.save({legends: true});
  },

  // we need to update the reference to the model
  _updateLegend: function (newLegendDefModel) {
    this._legendDefinitionModel = newLegendDefModel;
  },

  _configPanes: function () {
    var self = this;
    var tabPaneTabs = [{
      selected: !self._legendDefinitionModel.hasCustomHtml(),
      createContentView: function () {
        return new ScrollView({
          createContentView: function () {
            return new LegendContentView({
              className: 'Editor-content',
              overlayModel: self._overlayModel,
              editorModel: self._editorModel,
              legendTypes: self.legendTypes,
              layerDefinitionModel: self._layerDefinitionModel,
              legendDefinitionModel: self._getUserLegend(self.legendTypes),
              legendDefinitionsCollection: self._legendDefinitionsCollection,
              updateLegend: self._updateLegend.bind(self),
              type: self._type,
              userModel: self._userModel,
              configModel: self._configModel,
              modals: self._modals
            });
          }
        });
      },
      createActionView: function () {
        return new CoreView();
      }
    }, {
      selected: self._legendDefinitionModel.hasCustomHtml(),
      createContentView: function () {
        return new LegendEditorView({
          isCustom: self._legendDefinitionModel.get('type') === 'custom',
          codemirrorModel: self._codemirrorModel,
          onApplyEvent: self._saveLegendHTML.bind(self)
        });
      },
      createActionView: function () {
        return new ApplyView({
          onApplyClick: self._saveLegendHTML.bind(self)
        });
      }
    }];

    this._collectionPane = new TabPaneCollection(tabPaneTabs);
  }
});

},{"../../../../components/infobox/infobox-collection":215,"../../../../components/infobox/infobox-factory":216,"../../../../components/infobox/infobox-model":219,"../../../../components/scroll/scroll-view":530,"../../../../components/tab-pane/tab-pane-collection":538,"../../../../components/tab-pane/tab-pane-view":549,"../../../../components/toggler/toggler-view":590,"../../../../components/view-options/panel-with-options-view":595,"../../../../data/legends/legend-base-definition-model":638,"./apply-button-view":932,"./color/legend-custom-template.tpl":942,"./legend-content-view":958,"./legend-editor-view":960,"./legend-factory":961,"backbone":"backbone","backbone/core-view":1127,"cartodb.js":"cartodb.js","underscore":"underscore"}],956:[function(require,module,exports){
var map = {};

module.exports = {
  add: function (model) {
    var key = model.layerDefinitionModel.id + ':' + model.get('type');
    map[key] = model;
  },

  find: function (layerDefModel, type) {
    var key = layerDefModel.id + ':' + type;
    return map[key];
  },

  remove: function (model) {
    var key = model.layerDefinitionModel.id + ':' + model.get('type');
    delete map[key];
  }
};

},{}],957:[function(require,module,exports){
arguments[4][886][0].apply(exports,arguments)
},{"dup":886,"underscore":"underscore"}],958:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var CarouselFormView = require('../../../../components/carousel-form-view');
var CarouselCollection = require('../../../../components/custom-carousel/custom-carousel-collection');
var OverlayView = require('../../../../editor/components/overlay/overlay-view');
var FormView = require('./legend-properties-form');

var CustomFormModel = require('./form/legend-custom-definition-form-model');
var CategoryFormModel = require('./form/legend-category-definition-form-model');
var BubbleFormModel = require('./form/legend-bubble-definition-form-model');
var ChoroplethFormModel = require('./form/legend-choropleth-definition-form-model');
var CustomChoroplethFormModel = require('./form/legend-custom-choropleth-definition-form-model');

var template = require('./legend-content.tpl');
var LegendFactory = require('./legend-factory');

var DEBOUNCE_TIME = 350;

var REQUIRED_OPTS = [
  'editorModel',
  'legendTypes',
  'updateLegend',
  'overlayModel',
  'layerDefinitionModel',
  'legendDefinitionModel',
  'legendDefinitionsCollection',
  'type',
  'userModel',
  'configModel',
  'modals'
];

var LEGEND_MODEL_TYPE = {
  bubble: BubbleFormModel,
  custom: CustomFormModel,
  category: CategoryFormModel,
  choropleth: ChoroplethFormModel,
  custom_choropleth: CustomChoroplethFormModel
};

module.exports = CoreView.extend({

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    var type = this._legendDefinitionModel.get('type');

    this._onDebouncedChange = _.debounce(this._updateChanges.bind(this), DEBOUNCE_TIME);

    this._createFormModel(type);

    var styleModel = this._layerDefinitionModel.styleModel;
    this._carouselCollection = new CarouselCollection(
      _.chain(this._legendTypes).filter(function (legend) {
        return legend.isStyleCompatible ? legend.isStyleCompatible(styleModel) : true;
      }, this).map(function (legend) {
        return {
          selected: type === legend.value,
          val: legend.value,
          label: legend.label,
          template: function () {
            return (legend.legendIcon && legend.legendIcon()) || legend.value;
          }
        };
      }, this).value()
    );

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this.$el.html(template());
    this._initViews();
    return this;
  },

  _createFormModel: function (type) {
    var Klass;
    var attrs;

    if (this._formModel) {
      this._unBindFormModel(this._formModel);
      delete this._formModel;
    }

    if (type && type !== 'none') {
      Klass = LEGEND_MODEL_TYPE[type];
      attrs = this._pickAttrs(this._legendDefinitionModel);
      this._formModel = new Klass(attrs, {
        legendDefinitionModel: this._legendDefinitionModel,
        userModel: this._userModel,
        configModel: this._configModel,
        modals: this._modals
      });

      this._bindFormModel(this._formModel);
    }
  },

  _pickAttrs: function (legendDefinitionModel) {
    var attrs = _.pick(legendDefinitionModel.attributes, 'title', 'prefix', 'suffix', 'leftLabel', 'rightLabel', 'topLabel', 'bottomLabel', 'items');
    return attrs;
  },

  _initBinds: function () {
    this._carouselCollection.on('change:selected', this._onCarouselChange, this);
    this.add_related_model(this._carouselCollection);
  },

  _onCarouselChange: function (mdl) {
    var type = mdl.getValue();

    if (mdl.get('selected') === true) {
      this._updateLegendModel(type);
      this._createFormModel(type);
      this._renderForm(type);
      this._updateToggle(type);
    }

    // Remove legend
    if (mdl.get('selected') === false && type !== 'none') {
      LegendFactory.removeLegend(this._layerDefinitionModel, type);
    }
  },

  _initViews: function () {
    var type = this._legendDefinitionModel.get('type');
    this._renderCarousel();
    this._renderForm(type);
    this._renderOverlay();
    this._updateToggle(type);
  },

  _renderOverlay: function () {
    var view = new OverlayView({
      overlayModel: this._overlayModel
    });
    this.addView(view);
    this.$el.append(view.render().el);
  },

  _updateLegendModel: function (type) {
    if (type && type !== 'none') {
      LegendFactory.enableLegend(this._type);
      this._legendDefinitionModel = LegendFactory.createLegend(this._layerDefinitionModel, type);
      this._updateLegend(this._legendDefinitionModel);
    } else {
      LegendFactory.disableLegend(this._type);
      this._updateLegend(null);
      delete this._legendDefinitionModel;
    }
  },

  _renderForm: function (type) {
    this._removeForm();

    if (type && type !== 'none') {
      this._addForm();
    }
  },

  _addForm: function () {
    this._formView = new FormView({
      formModel: this._formModel
    });
    this.addView(this._formView);
    this.$('.js-form').html(this._formView.render().el);
  },

  _removeForm: function () {
    if (this._formView) {
      this.removeView(this._formView);
      this._formView.clean();
    }
  },

  _updateToggle: function (type) {
    var isDisabled = type === 'none';
    this._editorModel.set({disabled: isDisabled});
  },

  _renderCarousel: function () {
    var view = new CarouselFormView({
      collection: this._carouselCollection,
      template: require('./legend-form-types.tpl')
    });
    this.addView(view);
    this.$('.js-carousel').html(view.render().el);
  },

  _bindFormModel: function (model) {
    if (model) {
      model.on('change', this._onDebouncedChange, this);
      this.add_related_model(model);
    }
  },

  _unBindFormModel: function (model) {
    model && model.off('change', this._onDebouncedChange, this);
  },

  _updateChanges: function () {
    if (this._legendDefinitionModel) {
      this._legendDefinitionModel.setAttributes(this._formModel.toJSON());
      LegendFactory.createLegend(this._layerDefinitionModel, this._legendDefinitionModel.get('type'));
    }
  }
});

},{"../../../../components/carousel-form-view":23,"../../../../components/custom-carousel/custom-carousel-collection":40,"../../../../editor/components/overlay/overlay-view":694,"./form/legend-bubble-definition-form-model":944,"./form/legend-category-definition-form-model":945,"./form/legend-choropleth-definition-form-model":946,"./form/legend-custom-choropleth-definition-form-model":949,"./form/legend-custom-definition-form-model":950,"./legend-content.tpl":959,"./legend-factory":961,"./legend-form-types.tpl":962,"./legend-properties-form":964,"backbone/core-view":1127,"underscore":"underscore"}],959:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-carousel"></div>\n<div class="js-form"></div>';
}
return __p;
};

},{"underscore":"underscore"}],960:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var CodeMirrorView = require('../../../../components/code-mirror/code-mirror-view');
var ErrorTemplate = require('./code-mirror-error.tpl');

var REQUIRED_OPTS = [
  'codemirrorModel',
  'onApplyEvent',
  'isCustom'
];

var PLACEHOLDER = '[[Legend]]';

module.exports = CoreView.extend({

  className: 'Editor-content',

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initViews: function () {
    this.codeMirrorView = new CodeMirrorView({
      model: this._codemirrorModel,
      tip: _t('editor.legend.code-mirror.save'),
      errorTemplate: ErrorTemplate
    });

    this.codeMirrorView.bind('codeSaved', this._triggerCodeSaved, this);
    this.addView(this.codeMirrorView);
    this.$el.append(this.codeMirrorView.render().el);

    if (!this._isCustom) {
      this._markReadOnly();
    }
  },

  _markReadOnly: function () {
    var cursor = this.codeMirrorView.search(PLACEHOLDER);
    this.codeMirrorView.markReadOnly(cursor.from, cursor.to);
  },

  _triggerCodeSaved: function (code, view) {
    this.options.onApplyEvent && this.options.onApplyEvent();
  }
});

},{"../../../../components/code-mirror/code-mirror-view":27,"./code-mirror-error.tpl":939,"backbone/core-view":1127,"underscore":"underscore"}],961:[function(require,module,exports){
var _ = require('underscore');
var CategoryModel = require('../../../../data/legends/legend-category-definition-model');
var BubbleModel = require('../../../../data/legends/legend-bubble-definition-model');
var ChoroplethModel = require('../../../../data/legends/legend-choropleth-definition-model');
var CustomChoroplethModel = require('../../../../data/legends/legend-custom-choropleth-definition-model');
var CustomhModel = require('../../../../data/legends/legend-custom-definition-model');
var Validations = require('./legend-validations');
var Buffer = require('./legend-buffer');

var LEGEND_MODEL_TYPE = {
  'bubble': BubbleModel,
  'category': CategoryModel,
  'choropleth': ChoroplethModel,
  'custom_choropleth': CustomChoroplethModel,
  'custom': CustomhModel
};

var manager = (function () {
  return {
    init: function (legendDefinitionsCollection) {
      if (!legendDefinitionsCollection) {
        throw new Error('legendDefinitionsCollection is required');
      }
      this.legendDefinitionsCollection = legendDefinitionsCollection;
    },

    getLegendsCollection: function () {
      return this.legendDefinitionsCollection;
    },

    add: function (model, callback) {
      var self = this;
      model.save(null, {
        success: function (model) {
          Buffer.remove(model);
          self.legendDefinitionsCollection.add(model);
        },
        complete: function () {
          callback && callback();
        }
      });
    },

    save: function (model, callback) {
      model.save(null, {complete: function (model) {
        callback && callback();
      }});
    },

    remove: function (model, callback) {
      var self = this;
      model.destroy({
        success: function (model) {
          self.legendDefinitionsCollection.remove(model);
        },
        complete: function () {
          callback && callback();
        }
      });
    },

    createLegend: function (layerDefModel, type, attrs, callback) {
      var model = this.legendDefinitionsCollection.findByLayerDefModelAndType(layerDefModel, type);
      var inQueue = Buffer.find(layerDefModel, type);
      var Klass;
      var validation = Validations[type];
      var isValid = validation(layerDefModel.styleModel);
      attrs = attrs || {};

      if (inQueue) {
        return inQueue;
      }

      if (!model) {
        Klass = LEGEND_MODEL_TYPE[type];
        model = new Klass(attrs, {
          layerDefinitionModel: layerDefModel,
          configModel: this.legendDefinitionsCollection.configModel,
          vizId: this.legendDefinitionsCollection.vizId,
          parse: true
        });

        if (isValid) {
          Buffer.add(model);
          this.add(model, callback);
        }
      } else {
        if (!isValid) {
          this.remove(model, callback);
        } else {
          model.set(attrs);
          this.save(model, callback);
        }
      }

      return model;
    },

    removeLegend: function (layerDefModel, type, cb) {
      var legend = this.legendDefinitionsCollection.findByLayerDefModelAndType(layerDefModel, type);
      if (legend) {
        this.remove(legend, cb);
      } else {
        cb && cb();
      }
      return legend;
    },

    find: function (layerDefModel, type) {
      return this.legendDefinitionsCollection.findByLayerDefModelAndType(layerDefModel, type);
    },

    removeAllLegend: function (layerDefModel) {
      var legends = this.legendDefinitionsCollection.findByLayerDefModel(layerDefModel);
      _.each(legends, function (legend) {
        legend.get('type') !== 'custom' && this.remove(legend);
      }, this);
    },

    hasMigratedLegend: function (layerDefModel) {
      var legend = this.legendDefinitionsCollection.findByLayerDefModelAndType(layerDefModel, 'html');
      return !!legend;
    },

    disableLegend: function (type) {
      this[type] = false;
    },

    enableLegend: function (type) {
      this[type] = true;
    },

    // By default, it's undefined so we are removing this condition from the equation
    isEnabledType: function (type) {
      return this[type] === undefined ? true : !!this[type];
    }
  };
})();

module.exports = manager;

},{"../../../../data/legends/legend-bubble-definition-model":639,"../../../../data/legends/legend-category-definition-model":640,"../../../../data/legends/legend-choropleth-definition-model":641,"../../../../data/legends/legend-custom-choropleth-definition-model":642,"../../../../data/legends/legend-custom-definition-model":643,"./legend-buffer":956,"./legend-validations":966,"underscore":"underscore"}],962:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-bSpace--xl">\n  <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">1</div>\n  <div class="Editor-HeaderInfo-inner CDB-Text">\n    <div class="Editor-HeaderInfo-title u-bSpace--m">\n      <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.legend.legend-form.type.title') ))==null?'':_.escape(__t))+
'</h2>\n    </div>\n    <div class="js-selector u-bSpace--xl">\n      <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m js-highlight">'+
((__t=( name ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],963:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h2 class="CDB-Text CDB-Size-huge is-light u-secondaryTextColor">\n  '+
((__t=( _t('editor.legend.no-geometry-data') ))==null?'':_.escape(__t))+
'\n</h2>\n';
}
return __p;
};

},{"underscore":"underscore"}],964:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var template = require('./legend-properties-form.tpl');
require('../../../../components/form-components/index');

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.formModel) throw new Error('formModel is required');
    this._formModel = opts.formModel;
  },

  render: function () {
    this.clearSubViews();
    this._removeFormView();
    this.$el.html(template());
    this._initViews();
    return this;
  },

  _initViews: function () {
    this._formView = new Backbone.Form({
      model: this._formModel
    });

    this._formView.on('change', this._updateChanges, this);
    this.add_related_model(this._formView);

    this.$('.js-propertiesForm').append(this._formView.render().el);

    this.$('form').on('submit', function (e) {
      e.preventDefault();
    });
  },

  _updateChanges: function () {
    this._formView.commit();
  },

  _removeFormView: function () {
    this._formView && this._formView.remove();
  },

  clean: function () {
    this.$('form').off('submit');
    this._removeFormView();
    CoreView.prototype.clean.call(this);
  }

});

},{"../../../../components/form-components/index":211,"./legend-properties-form.tpl":965,"backbone":"backbone","backbone/core-view":1127}],965:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-bSpace--xl">\n  <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n  <div class="Editor-HeaderInfo-inner CDB-Text js-selector">\n    <div class="Editor-HeaderInfo-title u-bSpace--m">\n      <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.legend.legend-form.properties.title') ))==null?'':_.escape(__t))+
'</h2>\n    </div>\n    <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.legend.legend-form.properties.subtitle') ))==null?'':_.escape(__t))+
'</p>\n    <div class="js-propertiesForm"></div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],966:[function(require,module,exports){
var _ = require('underscore');

var noOp = function () {
  return true;
};

var getStyleAttrs = function (styleModel) {
  var fill = styleModel.get('fill');
  var stroke = styleModel.get('stroke');
  if (!fill && !stroke || _.isEmpty(fill) && _.isEmpty(stroke)) return false;

  return {
    fill: fill,
    stroke: stroke
  };
};

var validateColorRange = function (styleModel) {
  var attributes = getStyleAttrs(styleModel);
  if (!attributes) return false;

  var color = attributes.fill && attributes.fill.color || attributes.stroke && attributes.stroke.color;
  return color.range && color.range.length > 0;
};

var validateSizeRange = function (styleModel) {
  var attributes = getStyleAttrs(styleModel);
  if (!attributes) return false;

  var size = attributes.fill && attributes.fill.size || attributes.stroke && attributes.stroke.size;
  return size.range && size.range.length > 0;
};

var validateRangeAndDomain = function (styleModel) {
  var attributes = getStyleAttrs(styleModel);
  if (!attributes) return false;

  var color = attributes.fill && attributes.fill.color || attributes.stroke && attributes.stroke.color;
  return color.range && color.range.length > 0 && color.domain && color.domain.length > 0 && color.range && color.range.length > 0;
};

var validations = {
  bubble: validateSizeRange,
  category: validateRangeAndDomain,
  choropleth: validateColorRange,
  custom_choropleth: validateColorRange,
  custom: noOp
};

module.exports = validations;

},{"underscore":"underscore"}],967:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var LegendColorView = require('./color/legend-color-view');
var LegendSizeView = require('./size/legend-size-view');
var createTextLabelsTabPane = require('../../../../components/tab-pane/create-text-labels-tab-pane');
var TabPaneTemplate = require('../../../tab-pane-submenu.tpl');
var sqlErrorTemplate = require('./legend-content-sql-error.tpl');
var actionErrorTemplate = require('../../sql-error-action.tpl');
var loadingTemplate = require('../../panel-loading-template.tpl');
var legendNoGeometryTemplate = require('./legend-no-geometry-template.tpl');
var QuerySanity = require('../../query-sanity-check');
var georeferencePlaceholderTemplate = require('./georeference-placeholder.tpl');
var checkAndBuildOpts = require('../../../../helpers/required-opts');
var Infobox = require('../../../../components/infobox/infobox-factory');
var InfoboxModel = require('../../../../components/infobox/infobox-model');
var InfoboxCollection = require('../../../../components/infobox/infobox-collection');
var PanelWithOptionsView = require('../../../../components/view-options/panel-with-options-view');
var ViewFactory = require('../../../../components/view-factory');
var panelTemplate = require('./panel-with-options.tpl');
var OverlayView = require('../../../components/overlay/overlay-view');
var fetchAllQueryObjectsIfNecessary = require('../../../../helpers/fetch-all-query-objects');

var STATES = {
  ready: 'ready',
  loading: 'loading',
  fetched: 'fetched',
  error: 'error'
};

var REQUIRED_OPTS = [
  'mapDefinitionModel',
  'userActions',
  'layerDefinitionModel',
  'queryGeometryModel',
  'querySchemaModel',
  'queryRowsCollection',
  'legendDefinitionsCollection',
  'editorModel',
  'userModel',
  'configModel',
  'modals'
];

module.exports = CoreView.extend({

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this.render = this.render.bind(this);

    this._layerInfowindowModel = this._layerDefinitionModel.infowindowModel;
    this._layerTooltipModel = this._layerDefinitionModel.tooltipModel;

    this._initModels();
    this._initBinds();

    this._fetchAllQueryObjectsIfNecessary();

    // In order to handle sql errors
    QuerySanity.track(this, this._onQueryChanged.bind(this));
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    if (this._queryGeometryModel.isFetching()) {
      this._renderLoading();
    } else if (this._hasError()) {
      this._renderError();
    } else if (this._queryGeometryModel.hasValue()) {
      this._initViews();
    } else {
      if (this._layerDefinitionModel.canBeGeoreferenced()) {
        this._renderGeoreferencePlaceholder();
      } else {
        this._renderEmptyGeometry();
      }
    }

    this._renderOverlay();
    return this;
  },

  _renderOverlay: function () {
    var view = new OverlayView({
      overlayModel: this._overlayModel
    });
    this.addView(view);
    this.$('.js-content').append(view.render().el);
  },

  _initModels: function () {
    this._infoboxModel = new InfoboxModel({
      state: this._isLayerHidden() ? 'layer-hidden' : ''
    });

    this._overlayModel = new Backbone.Model({
      visible: this._isLayerHidden()
    });

    this.modelView = new Backbone.Model({
      state: this._getInitialState()
    });
  },

  _isLayerHidden: function () {
    return this._layerDefinitionModel.get('visible') === false;
  },

  _initBinds: function () {
    this.listenTo(this._querySchemaModel, 'change:status', this._onStatusChanged);
    this.listenTo(this._queryGeometryModel, 'change:status', this._onStatusChanged);
    this.listenTo(this._queryRowsCollection.statusModel, 'change:status', this._onStatusChanged);
    this.listenTo(this._editorModel, 'change:edition', this._changeStyle);
    this.listenTo(this._queryGeometryModel, 'change:status', this._onGeometryChanged);
    this.listenTo(this._editorModel, 'change:edition', this._changeStyle);
  },

  _fetchAllQueryObjectsIfNecessary: function () {
    fetchAllQueryObjectsIfNecessary({
      queryRowsCollection: this._queryRowsCollection,
      queryGeometryModel: this._queryGeometryModel,
      querySchemaModel: this._querySchemaModel
    });
  },

  _onStatusChanged: function () {
    fetchAllQueryObjectsIfNecessary({
      queryRowsCollection: this._queryRowsCollection,
      queryGeometryModel: this._queryGeometryModel,
      querySchemaModel: this._querySchemaModel
    }, this.render);
  },

  _onQueryChanged: function () {
    if (this._hasError()) {
      this.render();
    }
  },

  _getInitialState: function () {
    return STATES.ready;
  },

  _hasError: function () {
    return this.modelView.get('state') === STATES.error;
  },

  _renderError: function () {
    this.$el.append(
      sqlErrorTemplate({
        body: _t('editor.error-query.body', {
          action: actionErrorTemplate({
            label: _t('editor.error-query.label')
          })
        })
      })
    );
  },

  _renderGeoreferencePlaceholder: function () {
    var self = this;

    var infoboxSstates = [
      {
        state: 'layer-hidden',
        createContentView: function () {
          return Infobox.createWithAction({
            type: 'alert',
            title: _t('editor.infowindow.messages.layer-hidden.title'),
            body: _t('editor.infowindow.messages.layer-hidden.body'),
            mainAction: {
              label: _t('editor.infowindow.messages.layer-hidden.show')
            }
          });
        },
        mainAction: self._showHiddenLayer.bind(self)
      }
    ];

    var infoboxCollection = new InfoboxCollection(infoboxSstates);

    var panelWithOptionsView = new PanelWithOptionsView({
      template: panelTemplate,
      className: 'Editor-content',
      editorModel: self._editorModel,
      infoboxModel: self._infoboxModel,
      infoboxCollection: infoboxCollection,
      createContentView: function () {
        return ViewFactory.createByHTML(georeferencePlaceholderTemplate());
      }
    });

    this.$el.append(panelWithOptionsView.render().el);
    this.addView(panelWithOptionsView);
  },

  _renderEmptyGeometry: function () {
    this.$el.append(legendNoGeometryTemplate());
  },

  _renderLoading: function () {
    this.$el.append(loadingTemplate());
  },

  _initViews: function () {
    var self = this;

    var tabPaneTabs = [{
      name: 'color',
      label: _t('editor.legend.menu-tab-pane-labels.color'),
      createContentView: function () {
        return new LegendColorView({
          className: 'Editor-content',
          mapDefinitionModel: self._mapDefinitionModel,
          editorModel: self._editorModel,
          userActions: self._userActions,
          modelView: self.modelView,
          layerDefinitionModel: self._layerDefinitionModel,
          legendDefinitionsCollection: self._legendDefinitionsCollection,
          type: 'color',
          userModel: self._userModel,
          configModel: self._configModel,
          modals: self._modals
        });
      }
    }, {
      name: 'size',
      label: _t('editor.legend.menu-tab-pane-labels.size'),
      createContentView: function () {
        return new LegendSizeView({
          className: 'Editor-content',
          mapDefinitionModel: self._mapDefinitionModel,
          editorModel: self._editorModel,
          userActions: self._userActions,
          userModel: self._userModel,
          configModel: self._configModel,
          modals: self._modals,
          modelView: self.modelView,
          layerDefinitionModel: self._layerDefinitionModel,
          legendDefinitionsCollection: self._legendDefinitionsCollection,
          type: 'size'
        });
      }
    }];

    var tabPaneOptions = {
      tabPaneOptions: {
        template: TabPaneTemplate,
        tabPaneItemOptions: {
          tagName: 'li',
          className: 'CDB-NavSubmenu-item'
        }
      },
      tabPaneItemLabelOptions: {
        tagName: 'button',
        className: 'CDB-NavSubmenu-link u-upperCase'
      }
    };

    this._layerTabPaneView = createTextLabelsTabPane(tabPaneTabs, tabPaneOptions);
    this.$el.append(this._layerTabPaneView.render().$el);
    this.addView(this._layerTabPaneView);
    this._changeStyle(this._editorModel);
  },

  _changeStyle: function (m) {
    this._layerTabPaneView.changeStyleMenu(m);
  },

  _showHiddenLayer: function () {
    var savingOptions = {
      shouldPreserveAutoStyle: true
    };
    this._layerDefinitionModel.toggleVisible();
    this._userActions.saveLayer(this._layerDefinitionModel, savingOptions);
  }
});

},{"../../../../components/infobox/infobox-collection":215,"../../../../components/infobox/infobox-factory":216,"../../../../components/infobox/infobox-model":219,"../../../../components/tab-pane/create-text-labels-tab-pane":537,"../../../../components/view-factory":594,"../../../../components/view-options/panel-with-options-view":595,"../../../../helpers/fetch-all-query-objects":1092,"../../../../helpers/required-opts":1097,"../../../components/overlay/overlay-view":694,"../../../tab-pane-submenu.tpl":1054,"../../panel-loading-template.tpl":996,"../../query-sanity-check":997,"../../sql-error-action.tpl":1000,"./color/legend-color-view":941,"./georeference-placeholder.tpl":954,"./legend-content-sql-error.tpl":957,"./legend-no-geometry-template.tpl":963,"./panel-with-options.tpl":968,"./size/legend-size-view":970,"backbone":"backbone","backbone/core-view":1127}],968:[function(require,module,exports){
arguments[4][882][0].apply(exports,arguments)
},{"dup":882,"underscore":"underscore"}],969:[function(require,module,exports){
var _ = require('underscore');

module.exports = [
  {
    value: 'none',
    legendIcon: require('../carousel-icons/none.tpl'),
    label: _t('editor.legend.types.none')
  }, {
    value: 'bubble',
    legendIcon: require('../carousel-icons/bubble.tpl'),
    label: _t('editor.legend.types.bubble'),
    isStyleCompatible: function (styleModel) {
      var fill = styleModel.get('fill');
      var stroke = styleModel.get('stroke');
      var size;

      if (!fill && !stroke || _.isEmpty(fill) && _.isEmpty(stroke)) return false;

      size = fill && fill.size || stroke && stroke.size;
      return size && size.attribute !== undefined;
    }
  }
];

},{"../carousel-icons/bubble.tpl":934,"../carousel-icons/none.tpl":938,"underscore":"underscore"}],970:[function(require,module,exports){
var LegendTypes = require('./legend-size-types');
var LegendTypeBaseView = require('../legend-base-type-view');

module.exports = LegendTypeBaseView.extend({
  initialize: function (opts) {
    this.legendTypes = LegendTypes;
    LegendTypeBaseView.prototype.initialize.call(this, opts);
  }
});

},{"../legend-base-type-view":955,"./legend-size-types":969}],971:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var Backbone = require('backbone');
var template = require('./layer-header.tpl');
var SyncInfoView = require('./sync-info/sync-info-view');
var ContextMenuView = require('../../components/context-menu/context-menu-view');
var CustomListCollection = require('../../components/custom-list/custom-list-collection');
var VisTableModel = require('../../data/visualization-table-model');
var renameLayer = require('./operations/rename-layer');
var DeleteLayerConfirmationView = require('../../components/modals/remove-layer/delete-layer-confirmation-view');
var InlineEditorView = require('../../components/inline-editor/inline-editor-view');
var ModalExportDataView = require('../../components/modals/export-data/modal-export-data-view');
var templateInlineEditor = require('./inline-editor.tpl');
var layerColors = require('../../data/layer-colors');
var zoomToData = require('../map-operations/zoom-to-data');
var TipsyTooltipView = require('../../components/tipsy-tooltip-view');
var checkAndBuildOpts = require('../../helpers/required-opts');

var REQUIRED_OPTS = [
  'modals',
  'userActions',
  'layerDefinitionModel',
  'layerDefinitionsCollection',
  'configModel',
  'stateDefinitionModel',
  'editorModel',
  'userModel',
  'visDefinitionModel',
  'widgetDefinitionsCollection'
];

module.exports = CoreView.extend({
  className: 'js-editorPanelHeader',

  events: {
    'click .js-toggle-menu': '_onToggleContextMenuClicked',
    'click .js-zoom': '_onZoomClicked',
    'blur .js-input': '_hideRenameInput',
    'keyup .js-input': '_onKeyUpInput'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._tableNodeModel = opts.tableNodeModel;
    this._sourceNode = this._getSourceNode();
    this._topQueryGeometryModel = null;

    if (this._sourceNode) {
      var tableName = this._sourceNode.get('table_name');
      this._visTableModel = new VisTableModel({
        id: tableName,
        table: {
          name: tableName
        }
      }, {
        configModel: this._configModel
      });
    }

    this._uiModel = new Backbone.Model({
      zoomVisible: this._isQueryGeometryVisible()
    });

    this._changeStyle = this._changeStyle.bind(this);
    this._bindEvents();
    this._onSourceChanged();
  },

  render: function () {
    this.clearSubViews();

    var tableName = '';
    var url = '';

    if (this._visTableModel) {
      var tableModel = this._visTableModel.getTableModel();
      tableName = tableModel.getUnquotedName();
      url = this._visTableModel && this._visTableModel.datasetURL();
    }

    var letter = this._layerDefinitionModel.get('letter');

    this.$el.html(
      template({
        letter: letter,
        bgColor: layerColors.getColorForLetter(letter),
        isTableSource: !!this._sourceNode,
        url: url,
        tableName: tableName,
        title: this._layerDefinitionModel.getTableName().replace(/_/gi, ' '),
        alias: this._layerDefinitionModel.getName()
      })
    );

    var tooltip = new TipsyTooltipView({
      el: this._getZoom(),
      gravity: 'w',
      title: function () {
        return _t('editor.layers.options.center-map');
      }
    });
    this.addView(tooltip);

    this._showOrHideZoomVisibility();
    this._initViews();
    return this;
  },

  _initViews: function () {
    this._addSyncInfo();

    this._inlineEditor = new InlineEditorView({
      template: templateInlineEditor,
      renderOptions: {
        alias: this._layerDefinitionModel.getName()
      },
      onEdit: this._renameLayer.bind(this)
    });
    this.addView(this._inlineEditor);

    this.$('.js-header').append(this._inlineEditor.render().el);
  },

  _addSyncInfo: function () {
    var nodeModel = this._layerDefinitionModel.getAnalysisDefinitionNodeModel();
    if (nodeModel && nodeModel.tableModel && nodeModel.tableModel.isSync()) {
      this._createSyncInfo(nodeModel.tableModel);
    }
  },

  _createSyncInfo: function (tableModel) {
    var syncModel = tableModel.getSyncModel();
    this._syncInfoView = new SyncInfoView({
      modals: this._modals,
      syncModel: tableModel._syncModel,
      tableModel: tableModel,
      userModel: this._userModel
    });

    this.addView(this._syncInfoView);
    this.$el.prepend(this._syncInfoView.render().el);

    syncModel.bind('destroy', this._destroySyncInfo, this);
    this.add_related_model(syncModel);
  },

  _destroySyncInfo: function () {
    this.removeView(this._syncInfoView);
    this._syncInfoView.clean();
    delete this._syncInfoView;
  },

  _bindEvents: function () {
    if (this._tableNodeModel) {
      this._tableNodeModel.bind('change:synchronization', this.render, this);
      this.add_related_model(this._tableNodeModel);
    }
    this._layerDefinitionModel.bind('change:source', this.render, this);
    this._layerDefinitionModel.bind('change:source', this._onSourceChanged, this);
    this._editorModel.on('change:edition', this._changeStyle, this);
    this._uiModel.on('change:zoomVisible', this._showOrHideZoomVisibility, this);
    this.add_related_model(this._editorModel);
    this.add_related_model(this._layerDefinitionModel);
  },

  _getSourceNode: function () {
    var node = this._layerDefinitionModel.getAnalysisDefinitionNodeModel();
    var source;
    if (node.get('type') === 'source') {
      source = node;
    } else {
      var primarySource = node.getPrimarySource();
      if (primarySource && primarySource.get('type') === 'source') {
        source = primarySource;
      }
    }

    return source;
  },

  _onSourceChanged: function () {
    var nodeModel = this._layerDefinitionModel.getAnalysisDefinitionNodeModel();
    if (this._topQueryGeometryModel !== null) {
      this._topQueryGeometryModel.unbind('change:simple_geom');
    }
    this._topQueryGeometryModel = nodeModel.queryGeometryModel.bind('change:simple_geom', this._checkIfGeometryVisible, this);
    this._checkIfGeometryVisible();
  },

  _isQueryGeometryVisible: function () {
    var nodeModel = this._layerDefinitionModel.getAnalysisDefinitionNodeModel();
    return !!nodeModel.queryGeometryModel.get('simple_geom');
  },

  _checkIfGeometryVisible: function () {
    this._uiModel.set('zoomVisible', this._isQueryGeometryVisible());
  },

  _changeStyle: function () {
    var editing = this._editorModel.isEditing();
    this._getTitle().toggleClass('u-whiteTextColor', editing);
    this._getIcon().toggleClass('is-white', editing);
    this._getInlineEditor().toggleClass('u-mainTextColor', editing);
    this._getLink().toggleClass('u-altTextColor', editing);
    this._getBack().toggleClass('u-whiteTextColor', editing);
    this._getToggleMenu().toggleClass('is-white', editing);
    this._getZoom().toggleClass('is-white', editing);
  },

  _getInlineEditor: function () {
    return this.$('.Inline-editor-input');
  },

  _getTitle: function () {
    return this.$('.Editor-HeaderInfo-titleText');
  },

  _getIcon: function () {
    return this.$('.CDB-Shape-Dataset');
  },

  _getLink: function () {
    return this.$('.CDB-Text a');
  },

  _getBack: function () {
    return this.$('.js-back');
  },

  _getToggleMenu: function () {
    return this.$('.CDB-Shape-threePoints');
  },

  _getZoom: function () {
    return this.$('.js-zoom');
  },

  _onToggleContextMenuClicked: function (event) {
    if (this._hasContextMenu()) {
      this._hideContextMenu();
    } else {
      this._showContextMenu({
        x: event.pageX,
        y: event.pageY
      });
    }
  },

  _hasContextMenu: function () {
    return this._menuView != null;
  },

  _showContextMenu: function (position) {
    var menuItems = new CustomListCollection([{
      label: _t('editor.layers.options.rename'),
      val: 'rename-layer'
    }, {
      label: this._layerHidden() ? _t('editor.layers.options.show') : _t('editor.layers.options.hide'),
      val: 'toggle-layer'
    }, {
      label: _t('editor.layers.options.export'),
      val: 'export-data'
    }]);
    if (this._layerDefinitionModel.canBeDeletedByUser()) {
      menuItems.add({
        label: _t('editor.layers.options.delete'),
        val: 'delete-layer',
        destructive: true
      });
    }

    var triggerElementID = 'context-menu-trigger-' + this._layerDefinitionModel.cid;
    this.$('.js-toggle-menu').attr('id', triggerElementID);
    this._menuView = new ContextMenuView({
      collection: menuItems,
      triggerElementID: triggerElementID,
      position: position
    });

    menuItems.bind('change:selected', function (menuItem) {
      if (menuItem.get('val') === 'delete-layer') {
        this._confirmDeleteLayer();
      }
      if (menuItem.get('val') === 'rename-layer') {
        this._inlineEditor.edit();
      }
      if (menuItem.get('val') === 'toggle-layer') {
        var savingOptions = {
          shouldPreserveAutoStyle: true
        };
        this._layerDefinitionModel.toggleVisible();
        this._userActions.saveLayer(this._layerDefinitionModel, savingOptions);
      }
      if (menuItem.get('val') === 'export-data') {
        this._exportLayer();
      }
    }, this);

    this._menuView.model.bind('change:visible', function (model, isContextMenuVisible) {
      if (this._hasContextMenu() && !isContextMenuVisible) {
        this._hideContextMenu();
      }
    }, this);

    this._menuView.show();
    this.addView(this._menuView);
  },

  _confirmDeleteLayer: function () {
    this._modals.create(function (modalModel) {
      var deleteLayerConfirmationView = new DeleteLayerConfirmationView({
        userActions: this._userActions,
        modals: this._modals,
        layerModel: this._layerDefinitionModel,
        modalModel: modalModel,
        visDefinitionModel: this._visDefinitionModel,
        widgetDefinitionsCollection: this._widgetDefinitionsCollection
      });

      return deleteLayerConfirmationView;
    }.bind(this));
  },

  _hideContextMenu: function () {
    this.removeView(this._menuView);
    this._menuView.clean();
    delete this._menuView;
  },

  _exportLayer: function () {
    var nodeDefModel = this._layerDefinitionModel.getAnalysisDefinitionNodeModel();
    var queryGeometryModel = nodeDefModel.queryGeometryModel;

    this._modals.create(function (modalModel) {
      return new ModalExportDataView({
        modalModel: modalModel,
        queryGeometryModel: queryGeometryModel,
        configModel: this._configModel,
        fileName: this._layerDefinitionModel.getName()
      });
    }.bind(this));
  },

  _renameLayer: function () {
    var newName = this._inlineEditor.getValue();

    if (newName !== '') {
      // Optimistic
      this._onSaveSuccess(newName);

      renameLayer({
        newName: newName,
        userActions: this._userActions,
        layerDefinitionsCollection: this._layerDefinitionsCollection,
        layerDefinitionModel: this._layerDefinitionModel,
        onError: this._onSaveError.bind(this)
      });
    }
  },

  _onSaveSuccess: function (newName) {
    this.$('.js-title').text(newName).show();
    this._inlineEditor.hide();
  },

  _onSaveError: function (oldName) {
    this.$('.js-title').text(oldName).show();
    this._inlineEditor.hide();
  },

  _layerHidden: function () {
    return this._layerDefinitionModel.get('visible') === false;
  },

  _onZoomClicked: function () {
    var nodeModel = this._layerDefinitionModel.getAnalysisDefinitionNodeModel();
    var query = nodeModel.querySchemaModel.get('query');
    zoomToData(this._configModel, this._stateDefinitionModel, query);
  },

  _showOrHideZoomVisibility: function () {
    this._getZoom().toggle(this._isQueryGeometryVisible());
  }
});

},{"../../components/context-menu/context-menu-view":39,"../../components/custom-list/custom-list-collection":47,"../../components/inline-editor/inline-editor-view":223,"../../components/modals/export-data/modal-export-data-view":408,"../../components/modals/remove-layer/delete-layer-confirmation-view":453,"../../components/tipsy-tooltip-view":589,"../../data/layer-colors":633,"../../data/visualization-table-model":677,"../../helpers/required-opts":1097,"../map-operations/zoom-to-data":1005,"./inline-editor.tpl":787,"./layer-header.tpl":972,"./operations/rename-layer":995,"./sync-info/sync-info-view":1001,"backbone":"backbone","backbone/core-view":1127}],972:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfoEditor">\n  <div class="u-rSpace--xl u-actionTextColor js-back Editor-HeaderInfoEditorShape">\n    <button>\n      <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n    </button>\n  </div>\n\n  <div class="Editor-HeaderInfo-inner u-ellipsis">\n    <div class="Editor-HeaderInfo-title u-bSpace js-header">\n      <span class="SelectorLayer-letter CDB-Text CDB-Size-small u-whiteTextColor u-tSpace--m u-rSpace--m u-upperCase" style="background-color: '+
((__t=( bgColor ))==null?'':_.escape(__t))+
';">\n        '+
((__t=( letter ))==null?'':_.escape(__t))+
'\n      </span>\n    </div>\n    <div class="u-flex u-ellipsis">\n      ';
 if (isTableSource) { 
__p+='\n        <div class="CDB-Shape CDB-Size-medium u-rSpace">\n          <ul class="CDB-Shape-Dataset is-small is-grey">\n            <li class="CDB-Shape-DatasetItem"></li>\n            <li class="CDB-Shape-DatasetItem"></li>\n          </ul>\n        </div>\n        <p class="CDB-Text CDB-Size-medium u-ellipsis">\n          <a href="'+
((__t=( url ))==null?'':_.escape(__t))+
'" target="_blank" title="'+
((__t=( tableName ))==null?'':_.escape(__t))+
'" class="Editor-headerLayerName">'+
((__t=( tableName ))==null?'':_.escape(__t))+
'</a>\n        </p>\n      ';
 } 
__p+='\n    </div>\n  </div>\n\n  <ul class="u-flex u-tSpace-xl">\n    <li class="u-rSpace">\n      <button class="Editor-HeaderInfo-zoom CDB-Shape js-zoom">\n        <svg width="16px" height="15px" viewBox="287 30 16 15" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n          <g id="Icon" stroke="none" stroke-width="1" fill-rule="evenodd" transform="translate(288.000000, 30.000000)">\n            <circle id="Oval" cx="7.5" cy="7.5" r="0.5"></circle>\n            <path d="M7,0 L8,0 L8,5 L7,5 L7,0 Z M6,3 L7,3 L7,4 L6,4 L6,3 Z M8,3 L9,3 L9,4 L8,4 L8,3 Z M9,2 L10,2 L10,3 L9,3 L9,2 Z M5,2 L6,2 L6,3 L5,3 L5,2 Z" id="Combined-Shape"></path>\n            <path d="M7,10 L8,10 L8,15 L7,15 L7,10 Z M6,13 L7,13 L7,14 L6,14 L6,13 Z M8,13 L9,13 L9,14 L8,14 L8,13 Z M9,12 L10,12 L10,13 L9,13 L9,12 Z M5,12 L6,12 L6,13 L5,13 L5,12 Z" id="Combined-Shape" transform="translate(7.500000, 12.500000) scale(1, -1) translate(-7.500000, -12.500000) "></path>\n            <path d="M12,5 L13,5 L13,10 L12,10 L12,5 Z M11,8 L12,8 L12,9 L11,9 L11,8 Z M13,8 L14,8 L14,9 L13,9 L13,8 Z M14,7 L15,7 L15,8 L14,8 L14,7 Z M10,7 L11,7 L11,8 L10,8 L10,7 Z" id="Combined-Shape" transform="translate(12.500000, 7.500000) scale(1, -1) rotate(90.000000) translate(-12.500000, -7.500000) "></path>\n            <path d="M2,5 L3,5 L3,10 L2,10 L2,5 Z M1,8 L2,8 L2,9 L1,9 L1,8 Z M3,8 L4,8 L4,9 L3,9 L3,8 Z M4,7 L5,7 L5,8 L4,8 L4,7 Z M0,7 L1,7 L1,8 L0,8 L0,7 Z" id="Combined-Shape" transform="translate(2.500000, 7.500000) scale(-1, -1) rotate(90.000000) translate(-2.500000, -7.500000) "></path>\n          </g>\n        </svg>\n      </button>\n    </li>\n    <li class="CDB-Shape">\n      <button class="CDB-Shape-threePoints is-blue is-small js-toggle-menu">\n        <div class="CDB-Shape-threePointsItem"></div>\n        <div class="CDB-Shape-threePointsItem"></div>\n        <div class="CDB-Shape-threePointsItem"></div>\n      </button>\n    </li>\n  </ul>\n\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],973:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<nav class="CDB-NavMenu js-theme">\n  <ul class="CDB-NavMenu-inner CDB-Text is-semibold CDB-Size-medium js-menu"></ul>\n</nav>\n<div class="Editor-content js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],974:[function(require,module,exports){
var _ = require('underscore');
var layerTypesAndKinds = require('../../data/layer-types-and-kinds');
var BaseTiledLayerView = require('./layer-views/base-tiled-layer-view');
var PlainColorLayerView = require('./layer-views/plain-color-layer-view');
var BackgroundImageLayerView = require('./layer-views/background-image-layer-view');
var GoogleMapsBaseLayerView = require('./layer-views/google-maps-base-layer-view');
var DataLayerView = require('./layer-views/data-layer-view');
var LabelsLayerView = require('./layer-views/labels-layer-view');
var LayerAnalysesView = require('./layer-analyses-view');
var LayerAnalysisViewFactory = require('./layer-analysis-view-factory');
var checkAndBuildOpts = require('../../helpers/required-opts');

var REQUIRED_OPTS = [
  'stackLayoutModel',
  'userActions',
  'layerDefinitionsCollection',
  'analysisDefinitionNodesCollection',
  'modals',
  'configModel',
  'sortableSelector',
  'stateDefinitionModel',
  'visDefinitionModel',
  'widgetDefinitionsCollection'
];

var LayerViewFactory = function (opts) {
  opts = opts || {};
  checkAndBuildOpts(opts, REQUIRED_OPTS, this);
};

LayerViewFactory.prototype.createLayerView = function (layerDefinitionModel) {
  var layerViewOptions = {
    model: layerDefinitionModel,
    stackLayoutModel: this._stackLayoutModel,
    modals: this._modals,
    stateDefinitionModel: this._stateDefinitionModel,
    configModel: this._configModel
  };

  if (layerDefinitionModel.isDataLayer()) {
    layerViewOptions = _.extend(layerViewOptions, {
      userActions: this._userActions,
      layerDefinitionsCollection: this._layerDefinitionsCollection,
      newAnalysesView: this._newAnalysesView.bind(this),
      widgetDefinitionsCollection: this._widgetDefinitionsCollection,
      visDefinitionModel: this._visDefinitionModel,
      analysisDefinitionNodesCollection: this._analysisDefinitionNodesCollection
    });
  }

  var LayerViewClass = this._getLayerViewClass(layerDefinitionModel);
  return new LayerViewClass(layerViewOptions);
};

LayerViewFactory.prototype._getLayerViewClass = function (layerDefinitionModel) {
  // Base layers
  if (this._isTiledBaseLayer(layerDefinitionModel)) {
    return BaseTiledLayerView;
  }
  if (this._isPlainColorBaseLayer(layerDefinitionModel)) {
    return PlainColorLayerView;
  }
  if (this._isBackgroundImageBaseLayer(layerDefinitionModel)) {
    return BackgroundImageLayerView;
  }
  if (this._isGoogleMapsBaseLayer(layerDefinitionModel)) {
    return GoogleMapsBaseLayerView;
  }

  // Data layers
  if (layerDefinitionModel.isDataLayer()) {
    return DataLayerView;
  }

  // Labels layer
  if (this._isLabelsLayer(layerDefinitionModel)) {
    return LabelsLayerView;
  }

  throw new Error('No layer view for type "' + layerDefinitionModel.get('type') + '" just yet.');
};

LayerViewFactory.prototype._isBaseLayer = function (layerDefinitionModel) {
  return layerDefinitionModel.get('order') === 0;
};

LayerViewFactory.prototype._isTiledBaseLayer = function (layerDefinitionModel) {
  var layerType = layerDefinitionModel.get('type');
  return layerTypesAndKinds.isTiledType(layerType) &&
    this._isBaseLayer(layerDefinitionModel);
};

LayerViewFactory.prototype._isPlainColorBaseLayer = function (layerDefinitionModel) {
  var layerType = layerDefinitionModel.get('type');
  return layerTypesAndKinds.isPlainType(layerType) &&
    this._isBaseLayer(layerDefinitionModel) &&
      layerDefinitionModel.get('color');
};

LayerViewFactory.prototype._isBackgroundImageBaseLayer = function (layerDefinitionModel) {
  var layerType = layerDefinitionModel.get('type');
  return layerTypesAndKinds.isPlainType(layerType) &&
    this._isBaseLayer(layerDefinitionModel) &&
      layerDefinitionModel.get('image');
};

LayerViewFactory.prototype._isGoogleMapsBaseLayer = function (layerDefinitionModel) {
  var layerType = layerDefinitionModel.get('type');
  return layerTypesAndKinds.isGMapsBase(layerType) &&
    this._isBaseLayer(layerDefinitionModel);
};

LayerViewFactory.prototype._isLabelsLayer = function (layerDefinitionModel) {
  var layerType = layerDefinitionModel.get('type');
  return layerTypesAndKinds.isTiledType(layerType) &&
    !this._isBaseLayer(layerDefinitionModel);
};

LayerViewFactory.prototype._newAnalysesView = function (el, layerDefinitionModel) {
  var layerAnalysisViewFactory = new LayerAnalysisViewFactory(this._analysisDefinitionNodesCollection);
  return new LayerAnalysesView({
    el: el,
    model: layerDefinitionModel,
    layerAnalysisViewFactory: layerAnalysisViewFactory,
    sortableSelector: this._sortableSelector
  });
};

module.exports = LayerViewFactory;

},{"../../data/layer-types-and-kinds":637,"../../helpers/required-opts":1097,"./layer-analyses-view":788,"./layer-analysis-view-factory":791,"./layer-views/background-image-layer-view":975,"./layer-views/base-tiled-layer-view":977,"./layer-views/data-layer-view":978,"./layer-views/google-maps-base-layer-view":984,"./layer-views/labels-layer-view":987,"./layer-views/plain-color-layer-view":988,"underscore":"underscore"}],975:[function(require,module,exports){
var _ = require('underscore');
var BaseLayerViewBase = require('./base-layer-view-base');
var template = require('./image-thumbnail-layer.tpl');

module.exports = BaseLayerViewBase.extend({
  _getCompiledTemplate: function () {
    return template({
      title: this._getImageFileName(),
      desc: _t('editor.layers.image.title-label'),
      imgURL: this.model.get('image')
    });
  },

  _getImageFileName: function () {
    var imageURL = this.model.get('image');
    var fileNameWithParameters = _.last(imageURL.split('/'));
    var fileName = fileNameWithParameters.split('?')[0];
    return fileName;
  }
});

},{"./base-layer-view-base":976,"./image-thumbnail-layer.tpl":985,"underscore":"underscore"}],976:[function(require,module,exports){
var CoreView = require('backbone/core-view');

/**
 * Base view for all base layer views.
 */
module.exports = CoreView.extend({

  tagName: 'li',

  className: 'BlockList-item js-layer ui-state-disabled',

  events: {
    'click': '_onEditBasemap'
  },

  initialize: function (opts) {
    if (!opts.stackLayoutModel) throw new Error('stackLayoutModel is required');

    this._stackLayoutModel = opts.stackLayoutModel;

    this.listenTo(this.model, 'change', this.render);
  },

  render: function () {
    this.$el.html(this._getCompiledTemplate());

    return this;
  },

  _getCompiledTemplate: function () {
    throw new Error('subclasses of BasemapLayerViewBase must implement _getCompiledTemplate');
  },

  _onEditBasemap: function (e) {
    e.stopPropagation();

    this._stackLayoutModel.nextStep(this.model, 'basemaps');
  }
});

},{"backbone/core-view":1127}],977:[function(require,module,exports){
/* global Image */

var BaseLayerViewBase = require('./base-layer-view-base');
var template = require('./image-thumbnail-layer.tpl');

var DEFAULT_SUBDOMAIN = 'a';
var DEFAULT_X_POSITION = 30;
var DEFAULT_Y_POSISTION = 24;
var DEFAULT_ZOOM = 6;
var DEFAULT_IMG = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAAXNSR0IArs4c6QAAAZ9JREFUWAntWUtugzAUNKbAJl1EYtcz9Ba5UE6SC+UWPUN3SNlkw78zVhJRCeIXbCup6ic5gP08Ho/x40ESBauq6iNJkgPKDpdb1j3RTuM4HlH2ZVl+JySXpukXygaksiViRVEsNd3qu65Tfd/frpdO8jxXEGO2GcTUMAxtXddnYH1qKqe1fof3IrlZpECVJA6xMgiyMdzws0N5CzTealiIlpGbBsKz77nZSYAc67ck+NIWCbouj1cFL/eNK6df/UW7FztKMT7ZTOJDDMQ5RUyJGYK2IMyBm6ax4nFQGxZBEIStWFcH2TSu3pZjiCX2StDCf1VzJLhKtkmnqOBEjFWn/0tBaaB+REoTqJkJ2wxJpM3FtPvGMgQlabrkCUEcCcF7Kf9UBT5xvN6DIZbYK8Hp7H2dR4KuSkYFo4KPKBAiYTWBmoHznvEdQpKm82ljw+I4DObElJghaJu59AWHA9qw6CMlR9+4i6mCi0UFXdRj3z+hIL8Ju040VP+TBrkjtn0bagQH3JbcSHB/+WDNCgc8r11bZOdncjPfWV/5b4gfOaaYLUG/QVoAAAAASUVORK5CYII=';
var DEFAULT_NAME = _t('editor.layers.basemap.custom-basemap');

module.exports = BaseLayerViewBase.extend({

  _getCompiledTemplate: function () {
    var title = this.model.getName() || DEFAULT_NAME;
    var desc = _t('editor.layers.basemap.title-label');

    return template({
      title: title,
      desc: title === desc ? '' : desc,
      imgURL: this._getImageURL()
    });
  },

  _getImageURL: function () {
    var self = this;
    var url = this._lowerXYZ();

    var image = new Image();
    image.onerror = function () {
      self.$('.js-thumbnailImg').attr('src', DEFAULT_IMG);
    };
    image.src = url;

    return url;
  },

  _getSubdomain: function () {
    var subdomains = this.model.get('subdomains'); // eg: 'abcd' or '1234'

    return (subdomains && subdomains.length) ? subdomains[0] : DEFAULT_SUBDOMAIN;
  },

  _lowerXYZ: function () {
    return this.model.get('urlTemplate')
      .replace('{s}', this._getSubdomain())
      .replace('{z}', DEFAULT_ZOOM)
      .replace('{x}', DEFAULT_X_POSITION)
      .replace('{y}', DEFAULT_Y_POSISTION);
  }
});

},{"./base-layer-view-base":976,"./image-thumbnail-layer.tpl":985}],978:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');
var CoreView = require('backbone/core-view');
var template = require('./data-layer.tpl');
var ContextMenuView = require('../../../components/context-menu/context-menu-view');
var CustomListCollection = require('../../../components/custom-list/custom-list-collection');
var renameLayer = require('../operations/rename-layer');
var DeleteLayerConfirmationView = require('../../../components/modals/remove-layer/delete-layer-confirmation-view');
var ModalExportDataView = require('../../../components/modals/export-data/modal-export-data-view');
var InlineEditorView = require('../../../components/inline-editor/inline-editor-view');
var TipsyTooltipView = require('../../../components/tipsy-tooltip-view');
var zoomToData = require('../../map-operations/zoom-to-data');
var templateInlineEditor = require('./inline-editor.tpl');
var geometryNoneTemplate = require('./geometry-none.tpl');
var geometryPointsTemplate = require('./geometry-points.tpl');
var geometryLinesTemplate = require('./geometry-lines.tpl');
var geometryPolygonsTemplate = require('./geometry-polygons.tpl');
var checkAndBuildOpts = require('../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'userActions',
  'stackLayoutModel',
  'layerDefinitionsCollection',
  'modals',
  'configModel',
  'stateDefinitionModel',
  'widgetDefinitionsCollection',
  'visDefinitionModel',
  'analysisDefinitionNodesCollection'
];

module.exports = CoreView.extend({

  tagName: 'li',
  className: 'Editor-ListLayer-item js-layer',

  events: {
    'click': '_onEditLayer',
    'click .js-base': '_onClickSource',
    'click .js-title': '_onClickTitle',
    'click .js-toggle-menu': '_onToggleContextMenuClicked',
    'click .js-toggle': '_onToggleLayerClicked',
    'click .js-analysis-node': '_onAnalysisNodeClicked'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    if (!_.isFunction(opts.newAnalysesView)) throw new Error('newAnalysesView is required as a function');

    this._newAnalysesView = opts.newAnalysesView;
    this._styleModel = this.model.styleModel;

    var nodeDefModel = this.model.getAnalysisDefinitionNodeModel();

    this._queryGeometryModel = nodeDefModel.queryGeometryModel;

    this._bindEvents();

    if (this._queryGeometryModel.shouldFetch()) {
      this._queryGeometryModel.fetch();
    }
  },

  render: function () {
    this.clearSubViews();

    var m = this.model;
    var self = this;
    var isTorque = m.isTorqueLayer();
    var isAnimation = this._styleModel.isAnimation();
    var geometryTemplate = this._getGeometryTemplate(this._queryGeometryModel.get('simple_geom'));

    this.$el.html(template({
      layerId: m.id,
      title: m.getName(),
      color: m.get('color'),
      isVisible: m.get('visible'),
      isAnimated: isAnimation,
      isTorque: isTorque,
      hasError: this._hasError(),
      isCollapsed: this._isCollapsed(),
      numberOfAnalyses: m.getNumberOfAnalyses(),
      numberOfWidgets: this._widgetDefinitionsCollection.widgetsOwnedByLayer(m.id),
      hasGeom: this._queryGeometryHasGeom()
    }));

    this._inlineEditor = new InlineEditorView({
      template: templateInlineEditor,
      renderOptions: {
        title: m.getName()
      },
      onClick: self._onEditLayer.bind(self),
      onEdit: self._renameLayer.bind(self)
    });
    this.addView(this._inlineEditor);

    this.$('.js-thumbnail').append(geometryTemplate({
      letter: m.get('letter')
    }));
    this.$('.js-header').append(this._inlineEditor.render().el);

    this.$el.toggleClass('is-unavailable', m.isNew());
    this.$el.toggleClass('js-sortable-item', !isTorque);
    this.$el.toggleClass('is-animated', isTorque);
    this.$('.js-thumbnail').toggleClass('is-hidden', this._isHidden());
    this.$('.js-title').toggleClass('is-hidden', this._isHidden());
    this.$('.js-analyses-widgets-info').toggleClass('is-hidden', this._isHidden());

    if (isTorque) {
      var torqueTooltip = new TipsyTooltipView({
        el: this.$('.js-torqueIcon'),
        gravity: 's',
        offset: 0,
        title: function () {
          return $(this).data('tooltip');
        }
      });
      this.addView(torqueTooltip);
    }

    if (!this._queryGeometryHasGeom()) {
      var georeferenceTooltip = new TipsyTooltipView({
        el: this.$('.js-georeferenceIcon'),
        gravity: 's',
        offset: 0,
        title: function () {
          return $(this).data('tooltip');
        }
      });
      this.addView(georeferenceTooltip);
    }

    this._toggleClickEventsOnCapturePhase('remove'); // remove any if rendered previously
    if (m.isNew()) {
      this._toggleClickEventsOnCapturePhase('add');
    }

    if (m.get('source')) {
      var analysesView = this._newAnalysesView(this.$('.js-analyses'), m);
      this.addView(analysesView);
      analysesView.render();
    }

    if (this._hasError()) {
      var errorTooltip = new TipsyTooltipView({
        el: this.$('.js-error'),
        gravity: 's',
        offset: 0,
        title: function () {
          return this.model.get('error') && this.model.get('error').message;
        }.bind(this)
      });
      this.addView(errorTooltip);
    }

    return this;
  },

  _bindEvents: function () {
    this.listenTo(this.model, 'change', this.render);
    this.listenToOnce(this.model, 'destroy', this._onDestroy);
    this.listenTo(this.model, 'change:collapsed', this.render);
    this.listenTo(this._queryGeometryModel, 'change:simple_geom', this.render);
  },

  _getGeometryTemplate: function (geometry) {
    switch (geometry) {
      case 'line':
        return geometryLinesTemplate;
      case 'point':
        return geometryPointsTemplate;
      case 'polygon':
        return geometryPolygonsTemplate;
      default:
        return geometryNoneTemplate;
    }
  },

  _isHidden: function () {
    return !this.model.get('visible');
  },

  _hasError: function () {
    return !!this.model.get('error');
  },

  _isCollapsed: function () {
    return !!this.model.get('collapsed');
  },

  _onClickTitle: function (event) {
    // event is handled with inlineEditor
    event.stopPropagation();
  },

  _onAnalysisNodeClicked: function (event) {
    event.stopPropagation();

    var nodeId = event.currentTarget && event.currentTarget.dataset.analysisNodeId;
    if (!nodeId) throw new Error('missing data-analysis-node-id on element to edit analysis node, the element was: ' + event.currentTarget.outerHTML);

    var nodeDefModel = this._analysisDefinitionNodesCollection.get(nodeId);
    var layerDefModel = this._layerDefinitionsCollection.findOwnerOfAnalysisNode(nodeDefModel);
    if (!layerDefModel) throw new Error('no owning layer found for node ' + nodeId);

    this._stackLayoutModel.nextStep(layerDefModel, 'layer-content', 'analyses', nodeId);
  },

  _onClickSource: function (event) {
    event.stopPropagation();

    this._stackLayoutModel.nextStep(this.model, 'layer-content');
  },

  _onEditLayer: function (event) {
    event && event.stopPropagation();

    this._stackLayoutModel.nextStep(this.model, 'layer-content', 'style');
  },

  _onToggleCollapsedLayer: function () {
    this.model.toggleCollapse();
  },

  _onToggleLayerClicked: function (event) {
    event.stopPropagation();

    var savingOptions = {
      shouldPreserveAutoStyle: true
    };

    this.model.toggleVisible();
    this._userActions.saveLayer(this.model, savingOptions);
  },

  _onToggleContextMenuClicked: function (event) {
    event.stopPropagation();

    if (this._hasContextMenu()) {
      this._hideContextMenu();
    } else {
      this._showContextMenu({
        x: event.pageX,
        y: event.pageY
      });
    }
  },

  _hasContextMenu: function () {
    return this._menuView;
  },

  _hideContextMenu: function () {
    this.removeView(this._menuView);
    this._menuView.clean();
    delete this._menuView;
  },

  _showContextMenu: function (position) {
    var menuItems = new CustomListCollection([{
      label: this._isCollapsed() ? _t('editor.layers.options.expand') : _t('editor.layers.options.collapse'),
      val: 'collapse-expand-layer'
    }, {
      label: _t('editor.layers.options.rename'),
      val: 'rename-layer'
    }, {
      label: _t('editor.layers.options.export'),
      val: 'export-data'
    }, {
      label: _t('editor.layers.options.edit'),
      val: 'edit-layer'
    }]);
    if (this._queryGeometryHasGeom()) {
      menuItems.add({
        label: _t('editor.layers.options.center-map'),
        val: 'center-map'
      });
    }
    if (this.model.canBeDeletedByUser()) {
      menuItems.add({
        label: _t('editor.layers.options.delete'),
        val: 'delete-layer',
        destructive: true
      });
    }

    var triggerElementID = 'context-menu-trigger-' + this.model.cid;
    this.$('.js-toggle-menu').attr('id', triggerElementID);
    this._menuView = new ContextMenuView({
      collection: menuItems,
      triggerElementID: triggerElementID,
      position: position
    });

    menuItems.bind('change:selected', function (menuItem) {
      var selectedItem = menuItem.get('val');
      if (selectedItem === 'delete-layer') {
        this._confirmDeleteLayer();
      }
      if (selectedItem === 'collapse-expand-layer') {
        this._onToggleCollapsedLayer();
      }
      if (selectedItem === 'rename-layer') {
        this._inlineEditor.edit();
      }
      if (selectedItem === 'export-data') {
        this._exportLayer();
      }
      if (selectedItem === 'edit-layer') {
        this._onEditLayer();
      }
      if (selectedItem === 'center-map') {
        this._centerMap();
      }
    }, this);

    this._menuView.model.bind('change:visible', function (model, isContextMenuVisible) {
      if (this._hasContextMenu() && !isContextMenuVisible) {
        this._hideContextMenu();
      }
    }, this);

    this._menuView.show();
    this.addView(this._menuView);
  },

  _exportLayer: function () {
    var nodeDefModel = this.model.getAnalysisDefinitionNodeModel();
    var queryGeometryModel = nodeDefModel.queryGeometryModel;

    this._modals.create(function (modalModel) {
      return new ModalExportDataView({
        modalModel: modalModel,
        queryGeometryModel: queryGeometryModel,
        configModel: this._configModel,
        fileName: this.model.getName()
      });
    }.bind(this));
  },

  _confirmDeleteLayer: function () {
    this._modals.create(function (modalModel) {
      var deleteLayerConfirmationView = new DeleteLayerConfirmationView({
        userActions: this._userActions,
        modals: this._modals,
        layerModel: this.model,
        modalModel: modalModel,
        visDefinitionModel: this._visDefinitionModel,
        widgetDefinitionsCollection: this._widgetDefinitionsCollection
      });

      return deleteLayerConfirmationView;
    }.bind(this));
  },

  _renameLayer: function () {
    var newName = this._inlineEditor.getValue();

    if (newName !== '') {
      // Optimistic
      this._onSaveSuccess(newName);

      renameLayer({
        newName: newName,
        userActions: this._userActions,
        layerDefinitionsCollection: this._layerDefinitionsCollection,
        layerDefinitionModel: this.model,
        onError: this._onSaveError.bind(this)
      });
    }
  },

  _onSaveSuccess: function (newName) {
    this.$('.js-title').text(newName).show();
    this._inlineEditor.hide();
  },

  _onSaveError: function (oldName) {
    this.$('.js-title').text(oldName).show();
    this._inlineEditor.hide();
  },

  _onDestroy: function () {
    this.clean();
  },

  _disableEventsOnCapturePhase: function (evt) {
    evt.stopPropagation();
    evt.preventDefault();
  },

  _toggleClickEventsOnCapturePhase: function (str) {
    var addOrRemove = str === 'add'
      ? 'add'
      : 'remove';
    this.el[addOrRemove + 'EventListener']('click', this._disableEventsOnCapturePhase, true);
  },

  _centerMap: function () {
    var nodeModel = this.model.getAnalysisDefinitionNodeModel();
    var query = nodeModel.querySchemaModel.get('query');
    zoomToData(this._configModel, this._stateDefinitionModel, query);
  },

  _queryGeometryHasGeom: function () {
    return !!this._queryGeometryModel.hasValue();
  },

  clean: function () {
    this._toggleClickEventsOnCapturePhase('remove');
    CoreView.prototype.clean.apply(this);
  }
});

},{"../../../components/context-menu/context-menu-view":39,"../../../components/custom-list/custom-list-collection":47,"../../../components/inline-editor/inline-editor-view":223,"../../../components/modals/export-data/modal-export-data-view":408,"../../../components/modals/remove-layer/delete-layer-confirmation-view":453,"../../../components/tipsy-tooltip-view":589,"../../../helpers/required-opts":1097,"../../map-operations/zoom-to-data":1005,"../operations/rename-layer":995,"./data-layer.tpl":979,"./geometry-lines.tpl":980,"./geometry-none.tpl":981,"./geometry-points.tpl":982,"./geometry-polygons.tpl":983,"./inline-editor.tpl":986,"backbone/core-view":1127,"jquery":"jquery","underscore":"underscore"}],979:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (hasError) { 
__p+='\n  <div class="Editor-ListLayer-itemError js-error"></div>\n';
 } 
__p+='\n\n';
 if (!isTorque) { 
__p+='\n  <div class="Editor-ListLayer-dragIcon">\n    <div class="CDB-Shape">\n      <div class="CDB-Shape-rectsHandle is-small">\n        <div class="CDB-Shape-rectsHandleItem CDB-Shape-rectsHandleItem--grey is-first"></div>\n        <div class="CDB-Shape-rectsHandleItem CDB-Shape-rectsHandleItem--grey is-second"></div>\n        <div class="CDB-Shape-rectsHandleItem CDB-Shape-rectsHandleItem--grey is-third"></div>\n      </div>\n    </div>\n  </div>\n';
 } 
__p+='\n<div class="Editor-ListLayer-itemHeader">\n  <div class="Editor-ListLayer-media u-rSpace--m js-thumbnail" style="background: '+
((__t=( color ))==null?'':_.escape(__t))+
'; color: #fff">\n  </div>\n  <div class="Editor-ListLayer-inner">\n    <div class="Editor-ListLayer-title">\n      <div class="Editor-ListLayer-titleText js-Editor-ListLayer-titleText js-header"></div>\n      <ul class="Editor-HeaderInfo-actions">\n        ';
 if (isTorque) { 
__p+='\n          <li class="Editor-HeaderInfo-actionsItem u-rSpace">\n            ';
 if (isAnimated) { 
__p+='\n              <svg class="js-torqueIcon" width="19px" height="8px" viewBox="222 24 19 8" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" data-tooltip="'+
((__t=( _t('editor.layers.layer.animated') ))==null?'':_.escape(__t))+
'">\n                <g id="Animated-Icon" opacity="0.6" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(222.000000, 24.000000)">\n                  <rect id="Rectangle-649" fill="#2E3C43" x="11" y="0" width="8" height="8" rx="4"></rect>\n                  <rect id="Rectangle-649" fill="#2E3C43" opacity="0.5" x="5" y="0" width="8" height="8" rx="4"></rect>\n                  <rect id="Rectangle-649" fill="#2E3C43" opacity="0.2" x="0" y="0" width="8" height="8" rx="4"></rect>\n                </g>\n              </svg>\n            ';
 } else { 
__p+='\n              <svg class="js-torqueIcon" width="31px" height="17px" viewBox="563 512 31 17" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" data-tooltip="'+
((__t=( _t('editor.layers.layer.heatmap') ))==null?'':_.escape(__t))+
'">\n                <g id="Group" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(563.000000, 512.000000)">\n                  <ellipse id="Oval-120" fill="#E6E8E8" transform="translate(27.020000, 12.197917) rotate(-90.000000) translate(-27.020000, -12.197917) " cx="27.02" cy="12.1979167" rx="3.875" ry="3.84"></ellipse>\n                  <path d="M26.93,13.0729167 C27.3442136,13.0729167 27.68,12.7371302 27.68,12.3229167 C27.68,11.9087031 27.3442136,11.5729167 26.93,11.5729167 C26.5157864,11.5729167 26.18,11.9087031 26.18,12.3229167 C26.18,12.7371302 26.5157864,13.0729167 26.93,13.0729167 Z" id="Oval-120-Copy-2" fill="#828A8F" opacity="0.8" transform="translate(26.930000, 12.322917) rotate(-90.000000) translate(-26.930000, -12.322917) "></path>\n                  <ellipse id="Oval-120" fill="#E6E8E8" transform="translate(8.140000, 8.000000) rotate(-90.000000) translate(-8.140000, -8.000000) " cx="8.14" cy="8" rx="7.75" ry="7.68"></ellipse>\n                  <path d="M7.96,10.75 C9.34071187,10.75 10.46,9.63071187 10.46,8.25 C10.46,6.86928813 9.34071187,5.75 7.96,5.75 C6.57928813,5.75 5.46,6.86928813 5.46,8.25 C5.46,9.63071187 6.57928813,10.75 7.96,10.75 Z" id="Oval-120-Copy-2" fill="#828A8F" transform="translate(7.960000, 8.250000) rotate(-90.000000) translate(-7.960000, -8.250000) "></path>\n                  <path d="M15.1403347,6.71285923 C15.4606435,9.05621552 17.487459,10.8625 19.94,10.8625 C22.6151293,10.8625 24.78375,8.7134668 24.78375,6.0625 C24.78375,3.4115332 22.6151293,1.2625 19.94,1.2625 C17.2648707,1.2625 15.09625,3.4115332 15.09625,6.0625 C15.09625,6.28307774 15.1112641,6.50018043 15.1403347,6.71285923 Z" id="Oval-120" fill="#E6E8E8" transform="translate(19.940000, 6.062500) rotate(-90.000000) translate(-19.940000, -6.062500) "></path>\n                  <path d="M20.64,7.90625 C21.4684271,7.90625 22.14,7.23467712 22.14,6.40625 C22.14,5.57782288 21.4684271,4.90625 20.64,4.90625 C19.8115729,4.90625 19.14,5.57782288 19.14,6.40625 C19.14,7.23467712 19.8115729,7.90625 20.64,7.90625 Z" id="Oval-120-Copy-2" fill="#828A8F" opacity="0.8" transform="translate(20.640000, 6.406250) rotate(-90.000000) translate(-20.640000, -6.406250) "></path>\n                  <path d="M13.5625,2.88 C13.5625,2.88 16.1458333,5.12 18.0833333,2.56 C17.4375,4.16 17.1145833,5.44 17.1145833,5.44 L16.46875,6.72 L14.2083333,4.8 L13.5625,2.88 Z" id="Path-494" fill="#E6E8E8"></path>\n                  <path d="M22.3894032,6.40571996 C22.3894032,6.40571996 24.9727365,8.64571996 26.9102365,6.08571996 C26.2644032,7.68571996 25.9414865,8.96571996 25.9414865,8.96571996 L25.2956532,10.24572 L23.0352365,8.32571996 L22.3894032,6.40571996 Z" id="Path-494" fill="#E6E8E8" transform="translate(24.649820, 8.165720) rotate(52.000000) translate(-24.649820, -8.165720) "></path>\n                  <path d="M20.6462245,8.51753488 C20.6462245,8.51753488 23.9604656,11.3038091 25.8979656,8.74380905 C25.2521323,10.3438091 25.078218,11.598674 25.078218,11.598674 L24.4323847,12.878674 L21.1028976,9.87517984 L20.6462245,8.51753488 Z" id="Path-494" fill="#E6E8E8" transform="translate(23.272095, 10.698104) rotate(-135.000000) translate(-23.272095, -10.698104) "></path>\n                  <path d="M18.2927779,9.85808612 C18.2927779,9.85808612 15.6067281,8.91370489 14.3461002,11.8663856 C14.5856745,10.1576712 14.5893391,8.83757209 14.5893391,8.83757209 L14.4253034,7.30493626 L14.7514729,5.70339822 L18.2927779,9.85808612" id="Path-494" fill="#E6E8E8"></path>\n                  <path d="" id="Path-499" stroke="#979797" stroke-width="0.64"></path>\n                  <polygon id="Path-500" fill="#828A8F" points="9.94618849 9.56 11.6875 7.72609277 9.6875 6.56"></polygon>\n                </g>\n              </svg>\n            ';
 } 
__p+='\n          </li>\n        ';
 } 
__p+='\n        <li class="Editor-HeaderInfo-actionsItem CDB-Shape">\n          ';
 if (!hasGeom) { 
__p+='\n            <svg class="js-georeferenceIcon" xmlns="http://www.w3.org/2000/svg" width="14" height="12" viewBox="0 0 14 12" data-tooltip="'+
((__t=( _t('editor.layers.georeference.visualize') ))==null?'':_.escape(__t))+
'"><path fill="#FFB300" fill-rule="evenodd" d="M5.012 1.48C6.11-.444 7.887-.45 8.988 1.48l4.526 7.92c.82 1.436.15 2.6-1.523 2.6H2.01C.346 12-.333 10.83.485 9.4l4.526-7.92zM1.354 9.895C.917 10.66 1.116 11 2.01 11h9.98c.903 0 1.097-.333.656-1.104L8.12 1.976C7.404.72 6.596.722 5.88 1.975l-4.526 7.92zM6 9h2v1H6V9zm0-5h2v4H6V4z"/></svg>\n          ';
 } else { 
__p+='\n            <button class="js-toggle">\n              ';
 if (isVisible) { 
__p+='\n                <i class="CDB-IconFont CDB-IconFont-view u-actionTextColor"></i>\n              ';
 } else { 
__p+='\n                <i class="CDB-IconFont CDB-IconFont-hide u-actionTextColor"></i>\n              ';
 } 
__p+='\n            </button>\n          ';
 } 
__p+='\n        </li>\n        <li class="Editor-HeaderInfo-actionsItem CDB-Shape">\n          <button class="CDB-Shape-threePoints is-blue is-small js-toggle-menu">\n            <div class="CDB-Shape-threePointsItem"></div>\n            <div class="CDB-Shape-threePointsItem"></div>\n            <div class="CDB-Shape-threePointsItem"></div>\n          </button>\n        </li>\n      </ul>\n    </div>\n    <div class="u-flex Editor-ListLayer-info js-analyses-widgets-info">\n      <span class="CDB-Text CDB-Size-small u-secondaryTextColor u-upperCase u-rSpace--m">\n        '+
((__t=( _t('editor.layers.layer.analyses-count', { smart_count: numberOfAnalyses }) ))==null?'':_.escape(__t))+
'\n      </span>\n      <span class="CDB-Text CDB-Size-small u-secondaryTextColor u-upperCase">\n        '+
((__t=( _t('editor.layers.layer.widgets-count', { smart_count: numberOfWidgets }) ))==null?'':_.escape(__t))+
'\n      </span>\n    </div>\n  </div>\n</div>\n<ul class="Editor-ListAnalysis js-analyses '+
((__t=( isVisible ? '' : 'is-hidden' ))==null?'':_.escape(__t))+
'  '+
((__t=( isCollapsed ? 'is-collapsed' : '' ))==null?'':_.escape(__t))+
'"></ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],980:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text CDB-Size-large is-semibold u-upperCase">'+
((__t=( letter ))==null?'':_.escape(__t))+
' <svg width="12px" height="12px" viewBox="0 0 12 12" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <path d="M8.30379432,3.06016671 C8.11128812,2.75281724 8,2.38940498 8,2 C8,0.8954305 8.8954305,0 10,0 C11.1045695,0 12,0.8954305 12,2 C12,3.1045695 11.1045695,4 10,4 C9.70653076,4 9.42782451,3.93679216 9.17675238,3.82324762 L3.82324762,9.17675238 C3.93679216,9.42782451 4,9.70653076 4,10 C4,11.1045695 3.1045695,12 2,12 C0.8954305,12 0,11.1045695 0,10 C0,8.8954305 0.8954305,8 2,8 C2.38940498,8 2.75281724,8.11128812 3.06016671,8.30379432 L8.30379432,3.06016671 Z" stroke="none" fill="#FFFFFF" fill-rule="evenodd"></path>\n</svg></p>';
}
return __p;
};

},{"underscore":"underscore"}],981:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text CDB-Size-large is-semibold u-upperCase">'+
((__t=( letter ))==null?'':_.escape(__t))+
'</p>';
}
return __p;
};

},{"underscore":"underscore"}],982:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text CDB-Size-large is-semibold u-upperCase">'+
((__t=( letter ))==null?'':_.escape(__t))+
' <svg width="12px" height="12px" viewBox="589 382 12 12" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(589.000000, 382.000000)">\n    <circle fill="#FFFFFF" cx="2" cy="2" r="2"></circle>\n    <circle fill="#FFFFFF" cx="2" cy="10" r="2"></circle>\n    <circle fill="#FFFFFF" cx="10" cy="10" r="2"></circle>\n  </g>\n</svg></p>';
}
return __p;
};

},{"underscore":"underscore"}],983:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text CDB-Size-large is-semibold u-upperCase">'+
((__t=( letter ))==null?'':_.escape(__t))+
' <svg width="12px" height="12px" viewBox="589 382 12 12" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(589.000000, 382.000000)">\n    <path d="M1,2 L1,2 L2,1 L2,11 L1,10 L11,10 L10,11 L10,1 L11,2 L1,2 Z M1,1 L11,1 L11,11 L1,11 L1,1 L1,1 Z" id="Rectangle-2" fill="#FFFFFF"></path>\n    <circle fill="#FFFFFF" cx="2" cy="2" r="2"></circle>\n    <circle fill="#FFFFFF" cx="10" cy="2" r="2"></circle>\n    <circle fill="#FFFFFF" cx="2" cy="10" r="2"></circle>\n    <circle fill="#FFFFFF" cx="10" cy="10" r="2"></circle>\n  </g>\n</svg></p>';
}
return __p;
};

},{"underscore":"underscore"}],984:[function(require,module,exports){
var BaseLayerViewBase = require('./base-layer-view-base');
var template = require('./image-thumbnail-layer.tpl');

module.exports = BaseLayerViewBase.extend({
  initialize: function (opts) {
    BaseLayerViewBase.prototype.initialize.apply(this, arguments);

    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;
  },

  _getCompiledTemplate: function () {
    return template({
      title: this._getTitle(),
      desc: _t('editor.layers.gmaps.title-label'),
      imgURL: this._getImageURL()
    });
  },

  _getImageURL: function () {
    var imageName = this.model.get('baseType');
    if (this.model.get('baseName')) {
      imageName = imageName + '_' + this.model.get('baseName');
    }
    var imageURL = [
      this._configModel.get('app_assets_base_url'),
      'unversioned/images/google-maps-basemap-icons',
      imageName + '.jpg'
    ].join('/');
    return imageURL;
  },

  _getTitle: function () {
    return this.model.get('name').replace('GMaps ', '');
  }
});

},{"./base-layer-view-base":976,"./image-thumbnail-layer.tpl":985}],985:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="BlockList-media u-rSpace--xl js-thumbnail">\n  <img src="'+
((__t=( imgURL ))==null?'':_.escape(__t))+
'" class="BlockList-mediaImg js-thumbnailImg" />\n</div>\n<div class="BlockList-inner">\n  <div class="BlockList-title u-bSpace">\n    <h2 class="BlockList-titleText CDB-Text CDB-Size-large u-ellipsis js-title">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h2>\n  </div>\n  <p class="CDB-Text CDB-Size-medium u-secondaryTextColor">'+
((__t=( desc ))==null?'':_.escape(__t))+
'</p>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],986:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h2 class="Inline-editor">\n  <div class="CDB-Text CDB-Size-large u-ellipsis js-title Inline-editor-text">'+
((__t=( title ))==null?'':_.escape(__t))+
'</div>\n  <input type="text" name="text" class="Inline-editor-input Inline-editor-input--small CDB-Text CDB-InputText js-input" value="'+
((__t=( title ))==null?'':_.escape(__t))+
'" readonly>\n</h2>';
}
return __p;
};

},{"underscore":"underscore"}],987:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./image-thumbnail-layer.tpl');

module.exports = CoreView.extend({

  tagName: 'li',

  className: 'BlockList-item BlockList-item--noAction js-layer ui-state-disabled',

  initialize: function (opts) {
    this.listenTo(this.model, 'change', this.render);
  },

  render: function () {
    var desc = _t('editor.layers.labels.title-label');
    var title = this.model.getName() || desc;

    this.$el.html(template({
      title: title,
      desc: title === desc ? '' : desc,
      imgURL: this._getImageURL()
    }));

    return this;
  },

  _getImageURL: function () {
    return this.model.get('urlTemplate')
      .replace('{s}', 'a')
      .replace('{z}', 6)
      .replace('{x}', 30)
      .replace('{y}', 24);
  }
});


},{"./image-thumbnail-layer.tpl":985,"backbone/core-view":1127}],988:[function(require,module,exports){
var BaseLayerViewBase = require('./base-layer-view-base');
var template = require('./plain-color-layer.tpl');

module.exports = BaseLayerViewBase.extend({
  _getCompiledTemplate: function () {
    var desc = _t('editor.layers.color.title-label');
    var title = this.model.get('color') || desc;

    return template({
      title: title,
      desc: title === desc ? '' : desc,
      color: this.model.get('color')
    });
  }
});

},{"./base-layer-view-base":976,"./plain-color-layer.tpl":989}],989:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="BlockList-media u-rSpace--xl js-thumbnail" style="background-color: '+
((__t=( color ))==null?'':_.escape(__t))+
'">\n</div>\n<div class="BlockList-inner">\n  <div class="BlockList-title u-bSpace">\n    <h2 class="BlockList-titleText CDB-Text CDB-Size-large u-ellipsis js-title">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h2>\n  </div>\n  <p class="CDB-Text CDB-Size-medium u-secondaryTextColor">'+
((__t=( desc ))==null?'':_.escape(__t))+
'</p>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],990:[function(require,module,exports){
require('jquery-ui');
var _ = require('underscore');
var $ = require('jquery');
var CoreView = require('backbone/core-view');
var Notifier = require('../../components/notifier/notifier');
var template = require('./layers.tpl');
var LayerViewFactory = require('./layer-view-factory');
var checkAndBuildOpts = require('../../helpers/required-opts');

var SORTABLE_SELECTOR = '.js-layers';
var SORTABLE_ITEMS_SELECTOR = '.js-layer.js-sortable-item';

var REQUIRED_OPTS = [
  'stackLayoutModel',
  'analysisDefinitionNodesCollection',
  'layerDefinitionsCollection',
  'modals',
  'userModel',
  'configModel',
  'editorModel',
  'userActions',
  'stateDefinitionModel',
  'visDefinitionModel',
  'widgetDefinitionsCollection'
];

/**
 * View to render layer definitions list
 */
module.exports = CoreView.extend({

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._layerViewFactory = new LayerViewFactory({
      stackLayoutModel: this._stackLayoutModel,
      userActions: this._userActions,
      layerDefinitionsCollection: this._layerDefinitionsCollection,
      analysisDefinitionNodesCollection: opts.analysisDefinitionNodesCollection,
      modals: opts.modals,
      configModel: opts.configModel,
      sortableSelector: SORTABLE_SELECTOR,
      stateDefinitionModel: this._stateDefinitionModel,
      visDefinitionModel: this._visDefinitionModel,
      widgetDefinitionsCollection: this._widgetDefinitionsCollection
    });

    this._initBinds();
  },

  _initBinds: function () {
    this.listenTo(this._layerDefinitionsCollection, 'add remove change:id', this.render);
    this.listenTo(this._layerDefinitionsCollection, 'add', this._createNotification);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template);

    _.each(this._layerDefinitionsCollection.toArray().reverse(), this._addLayerView, this);
    this._initSortable();

    return this;
  },

  _createNotification: function (m) {
    Notifier.addNotification({
      status: 'success',
      info: _t('notifications.layer.added', {
        name: m.getName()
      }),
      closable: true,
      delay: Notifier.DEFAULT_DELAY
    });
  },

  _addLayerView: function (m) {
    var view = this._layerViewFactory.createLayerView(m);
    view.$el.data('layerId', m.id);
    this.addView(view);
    this.$(SORTABLE_SELECTOR).append(view.render().el);
  },

  _initSortable: function () {
    this.$(SORTABLE_SELECTOR).sortable({
      axis: 'y',
      items: SORTABLE_ITEMS_SELECTOR,
      placeholder: 'Editor-ListLayer-item Editor-ListLayer-item--placeholder',
      containment: SORTABLE_SELECTOR,
      forceHelperSize: true,
      forcePlaceholderSize: true,
      start: this._preventPlaceholderAfterBasemap.bind(this),
      beforeStop: this._dontAllowToMoveItemAfterBasemap.bind(this),
      update: this._onSortableUpdate.bind(this)
    });
  },

  _preventPlaceholderAfterBasemap: function (evt, ui) {
    var $placeholder = $(ui.placeholder);
    if ($placeholder.is(':last-child')) {
      $placeholder.remove();
      return;
    }
  },

  _dontAllowToMoveItemAfterBasemap: function (evt, ui) {
    this._stopUpdate = $(ui.placeholder).is(':last-child');
  },

  _onSortableUpdate: function (event, ui) {
    if (this._stopUpdate) {
      this.$(SORTABLE_SELECTOR).sortable('cancel');
      this._stopUpdate = false;
      return;
    }

    var $draggedLayerElement = ui.item;
    var numberOfLayers = $draggedLayerElement.parent().children('.js-layer').length;
    var newPosition = numberOfLayers - $draggedLayerElement.index();

    var layerId = $draggedLayerElement.data('layerId');
    if (layerId) {
      var layerDefinitionModel = this._layerDefinitionsCollection.get(layerId);
      this._userActions.moveLayer({
        from: layerDefinitionModel.get('order'),
        to: newPosition - 1 // -1 to compensate for the move of dragged-element
      });
      return;
    }

    var analysisNodeId = $draggedLayerElement.data('analysis-node-id');
    if (analysisNodeId) {
      try {
        this._userActions.createLayerForAnalysisNode(analysisNodeId, {at: newPosition});
      } catch (err) {
        if (/max/.test(err.message)) {
          $draggedLayerElement.remove();
          Notifier.addNotification({
            status: 'warning',
            info: _t('editor.layers.drag-n-drop-analysis.upgrade-max-layers-err', {
              a_start: '<a href="https://carto.com/pricing/">',
              a_end: '</a>',
              userMaxLayers: err.userMaxLayers
            }),
            closable: true,
            delay: Notifier.DEFAULT_DELAY
          });
        } else {
          throw err; // unknown err, let it bubble up
        }
      }
    }
  },

  _destroySortable: function () {
    if (this.$(SORTABLE_SELECTOR).data('ui-sortable')) {
      this.$(SORTABLE_SELECTOR).sortable('destroy');
    }
  },

  clean: function () {
    this._destroySortable();
    CoreView.prototype.clean.apply(this);
  }
});

},{"../../components/notifier/notifier":475,"../../helpers/required-opts":1097,"./layer-view-factory":974,"./layers.tpl":991,"backbone/core-view":1127,"jquery":"jquery","jquery-ui":1128,"underscore":"underscore"}],991:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="Editor-ListLayer js-layers"></ul>\n<div class="Editor-dropArea js-drop"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],992:[function(require,module,exports){
var _ = require('underscore');
var Messages = require('./notification-error-messages.json');
var Utils = require('../../../../javascripts/cartodb3/helpers/utils');

var CONTACT_LINK_TEMPLATE;
var SAMPLE_LINK_TEMPLATE;

var getBodyAttributes = function (errorType, layerDefModel) {
  var bodyAttrs = {};
  if (errorType === 'timeout') {
    // if layerDefModel is defined, hen use html code
    // this happens for notification, but not for tooltip errors where we don't want html
    if (layerDefModel != null) {
      CONTACT_LINK_TEMPLATE = _.template("<a href='mailto:<%- mail %>'><%- contact %></a>")({
        contact: _t('notifications.analysis.contact.label'),
        mail: _t('notifications.analysis.contact.mail')
      });

      SAMPLE_LINK_TEMPLATE = _.template("<button class='js-add-analysis u-actionTextColor' data-layer-id='<%- layerId %>'><%- sample %></button>")({
        sample: _t('notifications.analysis.sample'),
        layerId: layerDefModel && layerDefModel.get('id') || ''
      });
    } else {
      CONTACT_LINK_TEMPLATE = _t('notifications.analysis.contact.label');
      SAMPLE_LINK_TEMPLATE = _t('notifications.analysis.sample');
    }

    bodyAttrs = {
      sample: SAMPLE_LINK_TEMPLATE,
      contact: CONTACT_LINK_TEMPLATE
    };
  }

  return bodyAttrs;
};

module.exports = {
  extractErrorFromAnalysisNode: function (analysisNode, layerDefModel) {
    var errorType = 'error';
    var message = _t('notifications.analysis.failed', {
      nodeId: analysisNode.get('id').toUpperCase()
    });

    var error = analysisNode.get('error');

    if ((error && error.message) || analysisNode.get('error_message')) {
      var errorMessage = (error && error.message) || analysisNode.get('error_message');
      var extractedError = this.extractError(errorMessage, layerDefModel);
      message += ': ' + extractedError.message;
      errorType = extractedError.type;
    }

    return { message: message, type: errorType };
  },

  extractError: function (errorMessage, layerDefModel) {
    var errorType;
    var matched = false;
    var message;
    var i = 0;

    while (!matched && i < Messages.messages.length) {
      var m = Messages.messages[i];
      var errorMessageType = m.replaceWith;
      var regExp = new RegExp(m.match);
      var match = errorMessage.match(regExp);
      var body;

      errorMessage = Utils.removeNewLines(errorMessage);

      if (match) {
        if (errorMessageType) {
          body = _t('notifications.analysis.errors.' + errorMessageType, getBodyAttributes(errorMessageType, layerDefModel));
          message = errorMessage.replace(regExp, body);
        } else {
          message = match[1];
        }
        matched = true;
        errorType = m.errorType;
      }
      i++;
    }

    return { message: message || errorMessage, type: errorType || 'error' };
  }
};

},{"../../../../javascripts/cartodb3/helpers/utils":1102,"./notification-error-messages.json":993,"underscore":"underscore"}],993:[function(require,module,exports){
module.exports={
  "messages": [
    {
      "match": "Exception: (.*)$"
    },
    {
      "match": "REMOTE ERROR: .*Error: (.*?)$"
    },
    {
      "match": "ERROR: transform: (couldn't project point .*?)in executeQuery"
    },
    {
      "match": "RuntimeError: Execution of function interrupted by signal",
      "replaceWith": "timeout"
    },
    {
      "match": "canceling statement due to statement timeout.*",
      "replaceWith": "timeout"
    },
    {
      "match": "^.*?PQconnectPoll: FATAL: no pg_hba.conf entry for host.*",
      "replaceWith": "connect-poll"
    },
    {
      "match": "^.*?column \"the_geom_webmercator\" does not exist.*",
      "replaceWith": "without-geom-webmercator",
      "errorType": "warning"
    },
    {
      "match": "ERROR: (column .*? does not exist)"
    }
  ]
}

},{}],994:[function(require,module,exports){
var Notifier = require('../../../components/notifier/notifier');
var errorParser = require('../../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
  if (!opts.userActions) throw new Error('userActions is required');

  var layerDefinitionModel = opts.layerDefinitionModel;

  var name = layerDefinitionModel.getName();
  var notification = Notifier.addNotification({
    status: 'loading',
    info: _t('editor.layers.delete.loading', {name: name}),
    closable: false
  });

  opts.userActions.deleteLayer(layerDefinitionModel.id)
    .done(function () {
      notification.set({
        status: 'success',
        info: _t('editor.layers.delete.success', {name: name}),
        closable: true
      });
    })
    .fail(function (e) {
      notification.set({
        status: 'error',
        info: _t('editor.layers.delete.error', {name: name, error: errorParser(e)}),
        closable: true
      });
    });
};

},{"../../../components/notifier/notifier":475,"../../../helpers/error-parser":1090}],995:[function(require,module,exports){
var Notifier = require('../../../components/notifier/notifier');
var errorParser = require('../../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.userActions) throw new Error('userActions is required');
  if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
  if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
  if (!opts.newName) throw new Error('newName is required');

  var layerDefinitionModel = opts.layerDefinitionModel;
  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;
  var newName = opts.newName;
  var oldName = layerDefinitionModel.getName();

  var notification = Notifier.addNotification({
    status: 'loading',
    info: _t('editor.layers.rename.loading'),
    closable: false
  });

  layerDefinitionModel.set('table_name_alias', newName);

  opts.userActions.saveLayer(layerDefinitionModel)
    .done(function () {
      successCallback && successCallback(newName);
      notification.set({
        status: 'success',
        info: _t('editor.layers.rename.success', {name: newName}),
        closable: true
      });
    })
    .fail(function (e) {
      errorCallback && errorCallback(oldName);
      notification.set({
        status: 'error',
        info: _t('editor.layers.rename.error', {name: oldName, error: errorParser(e)}),
        closable: true
      });
    });
};

},{"../../../components/notifier/notifier":475,"../../../helpers/error-parser":1090}],996:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="FormPlaceholder-paragraph u-tSpace-m u-flex">\n  <div class="FormPlaceholder-paragraphLoader">\n    <div class="CDB-Loader is-visible"></div>\n  </div>\n</div>\n\n<div class="FormPlaceholder-paragraph u-tSpace-m u-flex">\n  <div class="FormPlaceholder-step u-rSpace--m"></div>\n  <div class="FormPlaceholder-inner">\n    <span class="FormPlaceholder-title FormPlaceholder-size--med u-tSpace--m"></span>\n  </div>\n</div>\n<div class="FormPlaceholder-paragraph u-flex">\n  <div class="FormPlaceholder-step u-rSpace--m"></div>\n  <div class="FormPlaceholder-inner">\n    <span class="FormPlaceholder-title FormPlaceholder-size--med u-tSpace--m"></span>\n    <span class="FormPlaceholder-label FormPlaceholder-size--short u-tSpace-xl"></span>\n    <ul class="FormPlaceholder-carousel u-flex FormPlaceholder-size--long">\n      <li class="FormPlaceholder-carouselItem"></li>\n      <li class="FormPlaceholder-carouselItem"></li>\n      <li class="FormPlaceholder-carouselItem"></li>\n    </ul>\n  </div>\n</div>\n<div class="FormPlaceholder-paragraph u-flex">\n  <div class="FormPlaceholder-step u-rSpace--m"></div>\n  <div class="FormPlaceholder-inner">\n    <span class="FormPlaceholder-title FormPlaceholder-size--short u-tSpace--m"></span>\n    <span class="FormPlaceholder-label FormPlaceholder-size--med u-tSpace-xl"></span>\n    <ul class="FormPlaceholder-fields">\n      <li class="FormPlaceholder-fieldsItem u-flex u-justifySpace">\n        <span class="FormPlaceholder-label FormPlaceholder-size--short"></span>\n        <span class="FormPlaceholder-input FormPlaceholder-size--med"></span>\n      </li>\n      <li class="FormPlaceholder-fieldsItem u-flex u-justifySpace">\n        <span class="FormPlaceholder-label FormPlaceholder-size--shorter"></span>\n        <span class="FormPlaceholder-input FormPlaceholder-size--med"></span>\n      </li>\n    </ul>\n  </div>\n</div>\n<div class="FormPlaceholder-paragraph u-flex">\n  <div class="FormPlaceholder-step u-rSpace--m"></div>\n  <div class="FormPlaceholder-inner">\n    <span class="FormPlaceholder-title FormPlaceholder-size--short u-tSpace--m"></span>\n    <span class="FormPlaceholder-label FormPlaceholder-size--med u-tSpace-xl"></span>\n    <ul class="FormPlaceholder-fields">\n      <li class="FormPlaceholder-fieldsItem u-flex u-justifySpace">\n        <span class="FormPlaceholder-label FormPlaceholder-size--short"></span>\n        <span class="FormPlaceholder-input FormPlaceholder-size--med"></span>\n      </li>\n      <li class="FormPlaceholder-fieldsItem u-flex u-justifySpace">\n        <span class="FormPlaceholder-label FormPlaceholder-size--shorter"></span>\n        <span class="FormPlaceholder-input FormPlaceholder-size--med"></span>\n      </li>\n      <li class="FormPlaceholder-fieldsItem u-flex u-justifySpace">\n        <span class="FormPlaceholder-label FormPlaceholder-size--shorter"></span>\n        <span class="FormPlaceholder-input FormPlaceholder-size--med"></span>\n      </li>\n      <li class="FormPlaceholder-fieldsItem u-flex u-justifySpace">\n        <span class="FormPlaceholder-label FormPlaceholder-size--short"></span>\n        <span class="FormPlaceholder-input FormPlaceholder-size--med"></span>\n      </li>\n      <li class="FormPlaceholder-fieldsItem u-flex u-justifySpace">\n        <span class="FormPlaceholder-label FormPlaceholder-size--short"></span>\n        <span class="FormPlaceholder-input FormPlaceholder-size--med"></span>\n      </li>\n    </ul>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],997:[function(require,module,exports){
var STATES = {
  ready: 'ready',
  loading: 'loading',
  fetched: 'fetched',
  error: 'error'
};

module.exports = {
  track: function (view, callback) {
    if (view.modelView === undefined) throw new Error('modelView is required');
    if (view._querySchemaModel === undefined) throw new Error('querySchemaModel is required');

    this.modelView = view.modelView;
    this.querySchemaModel = view._querySchemaModel;

    this.querySchemaModel.on('change:query_errors change:status', this._setState, this);
    view.add_related_model(this.querySchemaModel);

    this.modelView.on('change:state', callback);
    view.add_related_model(this.modelView);

    if (this.querySchemaModel.shouldFetch() && !this._hasErrors()) {
      this.querySchemaModel.fetch();
    }

    this._setState();
  },

  _setState: function () {
    if (this._hasErrors()) {
      this.modelView.set({state: STATES.error});
    } else {
      if (this.querySchemaModel.isFetched()) {
        this.modelView.set({state: STATES.ready});
      } else {
        this.modelView.set({state: STATES.loading});
      }
    }
  },

  _hasErrors: function () {
    var errors = this.querySchemaModel.get('query_errors');
    return (errors && errors.length > 0);
  }
};

},{}],998:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./share-button.tpl');
var _ = require('underscore');

var REQUIRED_OPTS = [
  'onClickAction',
  'visDefinitionModel'
];

module.exports = CoreView.extend({

  events: {
    'click .js-button': '_clickHandler'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template({
      hasChanges: this._visDefinitionModel.get('visChanges') > 0
    }));
    return this;
  },

  _initBinds: function () {
    this._visDefinitionModel.on('change:visChanges', this.render, this);
    this.add_related_model(this._visDefinitionModel);
  },

  _clickHandler: function () {
    this._onClickAction && this._onClickAction();
  }
});

},{"./share-button.tpl":999,"backbone/core-view":1127,"underscore":"underscore"}],999:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (hasChanges) { 
__p+='\n<span class="CDB-Text CDB-Size-small u-rSpace--m u-altTextColor">'+
((__t=( _t('editor.unpublished-changes') ))==null?'':_.escape(__t))+
'</span>\n';
 } 
__p+='\n<button class="CDB-Button CDB-Button--primary js-button">\n  <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small">'+
((__t=( _t('editor.button_share') ))==null?'':_.escape(__t))+
'</span>\n</button>';
}
return __p;
};

},{"underscore":"underscore"}],1000:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button class=\'CDB-Text u-actionTextColor js-fix-sql\'>'+
((__t=( label ))==null?'':_.escape(__t))+
'</button>';
}
return __p;
};

},{"underscore":"underscore"}],1001:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./sync-info.tpl');
var moment = require('moment');
var TipsyTooltipView = require('../../../components/tipsy-tooltip-view');
var SyncOptionsModalView = require('../../../components/modals/sync-options/sync-options-modal-view');
var checkAndBuildOpts = require('../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'modals',
  'syncModel',
  'tableModel',
  'userModel'
];

module.exports = CoreView.extend({

  className: 'SyncInfo SyncInfo--separator',

  events: {
    'click .js-options': '_openSyncOptions'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
  },

  render: function () {
    var runAt = this._syncModel.get('run_at');

    var d = {
      canSyncNow: this._syncModel.canSyncNow(),
      fromExternalSource: this._syncModel.get('from_external_source'),
      ranAt: moment(this._syncModel.get('ran_at') || new Date()).fromNow(),
      runAt: moment(runAt).fromNow(),
      state: this._syncModel.get('state'),
      errorCode: this._syncModel.get('error_code'),
      errorMessage: this._syncModel.get('error_message'),
      isOwner: this._tableModel.isOwner(this._userModel)
    };

    // Due to the time we need to polling, we have to display to the user
    // that the sync will be in a moment
    if (!runAt || (new Date(runAt) <= new Date())) {
      d.runAt = _t('dataset.sync.in-a-moment');
    }

    this.$el.html(template(d));

    if (d.errorCode || d.errorMessage) {
      var tooltip = new TipsyTooltipView({
        el: this.$('.js-tooltip'),
        title: function () {
          return _t('dataset.sync.error-code', { errorCode: d.errorCode }) + ':' + d.errorMessage;
        }
      });
      this.addView(tooltip);
    }

    return this;
  },

  _openSyncOptions: function () {
    var self = this;
    this._modals.create(function (modalModel) {
      return new SyncOptionsModalView({
        syncModel: self._syncModel,
        modalModel: modalModel,
        tableName: self._tableModel.getUnquotedName()
      });
    });
  }

});

},{"../../../components/modals/sync-options/sync-options-modal-view":454,"../../../components/tipsy-tooltip-view":589,"../../../helpers/required-opts":1097,"./sync-info.tpl":1002,"backbone/core-view":1127,"moment":"moment"}],1002:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-alignCenter u-justifySpace">\n  <div class="u-flex u-alignCenter CDB-Text CDB-Size-small u-altTextColor SyncInfo-message--'+
((__t=( state ))==null?'':_.escape(__t))+
' js-state">\n    <i class="CDB-IconFont CDB-IconFont-wifi"></i>\n    <p class="u-upperCase is-semibold u-lSpace">\n      ';
 if (errorCode || errorMessage) { 
__p+='\n        '+
((__t=( _t('dataset.sync.sync-failed') ))==null?'':_.escape(__t))+
'\n      ';
 } else { 
__p+='\n        '+
((__t=( ranAt ))==null?'':_.escape(__t))+
'\n      ';
 } 
__p+='\n    </p>\n  </div>\n  ';
 if (isOwner) { 
__p+='\n    <button class="CDB-Text CDB-Size-small u-upperCase js-options SyncInfo-viewOptions">'+
((__t=( _t('dataset.sync.view-options') ))==null?'':_.escape(__t))+
'</button>\n  ';
 } 
__p+='\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],1003:[function(require,module,exports){
var Notifier = require('../../components/notifier/notifier');
var errorParser = require('../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.visDefinitionModel) throw new Error('visDefinitionModel is required');

  var visDefinitionModel = opts.visDefinitionModel;
  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;
  var name = visDefinitionModel.get('name');

  visDefinitionModel.destroy({
    wait: true,
    success: function (mdl, attrs) {
      successCallback && successCallback(mdl, attrs);
    },
    error: function (mdl, e) {
      errorCallback && errorCallback(mdl, e);
      Notifier.addNotification({
        status: 'error',
        info: _t('editor.maps.delete.error', {name: name, error: errorParser(e)}),
        closable: true
      });
    }
  });
};

},{"../../components/notifier/notifier":475,"../../helpers/error-parser":1090}],1004:[function(require,module,exports){
var Notifier = require('../../components/notifier/notifier');
var errorParser = require('../../helpers/error-parser');
var TITLE_SUFIX = require('../../components/modals/visualization-title-suffix-metadata');

module.exports = function (opts) {
  if (!opts.visDefinitionModel) throw new Error('visDefinitionModel is required');
  if (!opts.newName) throw new Error('newName is required');

  var visDefinitionModel = opts.visDefinitionModel;
  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;
  var newName = opts.newName;
  var oldName = visDefinitionModel.get('name');

  var notification = Notifier.addNotification({
    status: 'loading',
    info: _t('editor.maps.rename.loading'),
    closable: false
  });

  visDefinitionModel.save({
    name: newName
  }, {
    wait: true,
    success: function (mdl, e) {
      successCallback && successCallback(newName);
      document.title = newName + TITLE_SUFIX;
      notification.set({
        status: 'success',
        info: _t('editor.maps.rename.success', {name: newName}),
        closable: true
      });
    },
    error: function (mdl, e) {
      errorCallback && errorCallback(oldName);
      notification.set({
        status: 'error',
        info: _t('editor.maps.rename.error', {name: oldName, error: errorParser(e)}),
        closable: true
      });
    }
  });
};

},{"../../components/modals/visualization-title-suffix-metadata":456,"../../components/notifier/notifier":475,"../../helpers/error-parser":1090}],1005:[function(require,module,exports){
var cdb = require('cartodb.js');
var Notifier = require('../../components/notifier/notifier');

var ongoingQuery = false;

module.exports = function zoomToData (configModel, stateModel, query) {
  if (!configModel) throw new Error('configModel is required');
  if (!stateModel) throw new Error('stateModel is required');
  if (!query) throw new Error('query is required');

  var queryLauncher = new cdb.SQL({
    user: configModel.get('user_name'),
    sql_api_template: configModel.get('sql_api_template'),
    api_key: configModel.get('api_key')
  });
  var notification = null;

  if (!ongoingQuery) {
    ongoingQuery = true;

    notification = Notifier.addNotification({
      status: 'loading',
      info: _t('editor.layers.notifier.center-map.loading'),
      closable: false
    });

    queryLauncher.getBounds(query)
      .done(function (bounds) {
        ongoingQuery = false;
        stateModel.setBounds(bounds);
        notification.set({
          status: 'success',
          info: _t('editor.layers.notifier.center-map.success'),
          closable: true
        });
      })
      .error(function () {
        ongoingQuery = false;
        notification.set({
          status: 'error',
          info: _t('editor.layers.notifier.center-map.error'),
          closable: true
        });
      });
  }
};

},{"../../components/notifier/notifier":475,"cartodb.js":"cartodb.js"}],1006:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-formInner CDB-Text CDB-Size-small u-upperCase ';
 if (disabled) { 
__p+='u-altTextColor';
 } 
__p+=' u-upperCase">\n  <div class="u-flex u-alignCenter">\n    <div class="u-iBlock u-rSpace--m">\n      <input class="CDB-Checkbox js-input" type="checkbox" name="" value="" ';
 if (checked) { 
__p+='checked';
 } 
__p+=' ';
 if (disabled) { 
__p+='disabled';
 } 
__p+='>\n      <span class="u-iBlock CDB-Checkbox-face"></span>\n    </div>\n    <span class="';
 if (help) { 
__p+=' js-help is-underlined';
 } 
__p+='" ';
 if (help) { 
__p+=' data-tooltip="'+
((__t=( help ))==null?'':_.escape(__t))+
'"';
 } 
__p+=' >'+
((__t=( title ))==null?'':_.escape(__t))+
'</span>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],1007:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="FormPlaceholder-paragraph u-tSpace-m u-flex">\n  <div class="FormPlaceholder-step u-rSpace--m"></div>\n  <div class="FormPlaceholder-inner">\n    <span class="FormPlaceholder-title FormPlaceholder-size--long u-bSpace"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--med u-bSpace--xl"></span>\n\n    <span class="FormPlaceholder-title FormPlaceholder-size--med"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--med u-bSpace--m"></span>\n\n    <span class="FormPlaceholder-title FormPlaceholder-size--med"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--med u-bSpace--m"></span>\n\n    <span class="FormPlaceholder-title FormPlaceholder-size--med"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--med u-bSpace--m"></span>\n\n    <span class="FormPlaceholder-title FormPlaceholder-size--med"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--med u-bSpace--m"></span>\n\n    <span class="FormPlaceholder-title FormPlaceholder-size--med"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--med u-bSpace--m"></span>\n\n    <span class="FormPlaceholder-title FormPlaceholder-size--med"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--med u-bSpace--m"></span>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],1008:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var enablerTemplate = require('./enabler.tpl');
require('../../../components/form-components/index');

var REQUIRED_OPTS = [
  'model'
];

module.exports = CoreView.extend({
  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    // For enabler compatibility
    this.model.set(this.model.get('setting'), this.model.get('active'), {silent: true});
  },

  render: function () {
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initViews: function () {
    this._enablerView = new Backbone.Form.editors.Enabler({
      template: enablerTemplate,
      model: this.model,
      title: this.model.get('label'),
      disabled: this.model.get('disabled'),
      help: '',
      key: this.model.get('setting')
    });

    this.$el.append(this._enablerView.render().$el);
  }
});

},{"../../../components/form-components/index":211,"./enabler.tpl":1006,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],1009:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var OptionsItemView = require('./preview-options-item-view');
var template = require('./preview-options.tpl');
var templateNotReady = require('./options-not-ready.tpl');

var REQUIRED_OPTS = [
  'mapDefinitionModel',
  'settingsCollection',
  'overlaysCollection'
];

module.exports = CoreView.extend({
  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();

    if (!this._overlaysCollection.hasFetched()) {
      this.$el.html(templateNotReady());
    } else {
      this.$el.html(template());
      this._initViews();
    }

    return this;
  },

  _initBinds: function () {
    this._settingsCollection.on('change', this._onChangeOptions, this);
    this.add_related_model(this._settingsCollection);
  },

  _onChangeOptions: function (m) {
    var handler = m.get('related');
    var property = m.get('setting');
    var value = m.get('enabler');

    if (handler === 'overlays') {
      this._overlayHandler(property, value);
    }

    if (handler === 'map') {
      this._mapHandler(property, value);
    }
  },

  _initViews: function () {
    this._settingsCollection.each(this._renderSetting, this);
  },

  _renderSetting: function (model) {
    var view = new OptionsItemView({
      model: model
    });

    this.$('.js-settings').append(view.render().$el);
    this.addView(view);
  },

  _overlayHandler: function (property, value) {
    if (value === false) {
      this._overlaysCollection.removeOverlay(property);
    } else {
      this._overlaysCollection.createOverlay(property);
    }
  },

  _mapHandler: function (property, value) {
    var payload = {};
    payload[property] = value;
    this._mapDefinitionModel.set(payload);
    this._mapDefinitionModel.save();
  }
});

},{"./options-not-ready.tpl":1007,"./preview-options-item-view":1008,"./preview-options.tpl":1010,"backbone/core-view":1127,"underscore":"underscore"}],1010:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfo">\n  <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">1</div>\n  <div class="Editor-HeaderInfo-inner CDB-Text">\n    <div class="Editor-HeaderInfo-title u-bSpace--m">\n      <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.settings.preview.options.title') ))==null?'':_.escape(__t))+
'</h2>\n    </div>\n    <p class="CDB-Text u-upperCase CDB-Size-small u-altTextColor u-bSpace--xl">'+
((__t=( _t('editor.settings.preview.options.subtitle') ))==null?'':_.escape(__t))+
'</p>\n    <div class="u-flex u-justifySpace">\n      <div class="js-settings Options-form"></div>\n    </div>\n\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],1011:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var OptionsView = require('./preview-options-view');

var REQUIRED_OPTS = [
  'mapDefinitionModel',
  'settingsCollection',
  'overlaysCollection'
];

module.exports = CoreView.extend({

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._renderOptions();
    return this;
  },

  _renderOptions: function () {
    var view = new OptionsView({
      mapDefinitionModel: this._mapDefinitionModel,
      settingsCollection: this._settingsCollection,
      overlaysCollection: this._overlaysCollection
    });

    this.$el.append(view.render().el);
    this.addView(view);
  }
});

},{"./preview-options-view":1009,"backbone/core-view":1127,"underscore":"underscore"}],1012:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h2 class="CDB-Text CDB-Size-huge is-light u-secondaryTextColor">'+
((__t=( _t('editor.style.style-form.properties.placeholder-text') ))==null?'':_.escape(__t))+
' '+
((__t=( _t('editor.layers.georeference.manually-add') ))==null?'':_.escape(__t))+
'</h2>\n<div class="BlockList-item is-dashed no-hover is-space u-tSpace-xl">\n  <ul class="HorizontalBlockList">\n    <li class="HorizontalBlockList-item"></li>\n    <li class="HorizontalBlockList-item"></li>\n  </ul>\n\n  <button class="CDB-Button CDB-Button--primary js-georeference">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('editor.layers.georeference.georeference-button') ))==null?'':_.escape(__t))+
'</span>\n  </button>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],1013:[function(require,module,exports){
var Backbone = require('backbone');
var UndoManager = require('../../data/undo-manager.js');
var _ = require('underscore');

/**
 *  CartoCSS Undo-redo model
 */
module.exports = Backbone.Model.extend({

  defaults: {
    content: ''
  },

  initialize: function (attrs, opts) {
    this._history = this._generateHistory(opts && opts.history);

    UndoManager.init(this, {
      track: true,
      history: this._history
    });
  },

  _generateHistory: function (history) {
    if (history && history.length) {
      var data = _.reduce(history, function (memo, cartocss) {
        memo.push({
          content: cartocss
        });
        return memo;
      }, [], this);
      return data;
    }

    return false;
  },

  getHistory: function () {
    return _.pluck(
      this.getUndoHistory(),
      'content'
    );
  }
});

},{"../../data/undo-manager.js":667,"backbone":"backbone","underscore":"underscore"}],1014:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var CodeMirrorView = require('../../components/code-mirror/code-mirror-view');
var FactoryHints = require('../editor-hints/factory-hints');
var CSSHints = require('../editor-hints/css-hints');

module.exports = CoreView.extend({

  className: 'Editor-styleContentCartoCSS Editor-content',

  initialize: function (opts) {
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
    if (!opts.styleModel) throw new Error('styleModel is required');
    if (!opts.codemirrorModel) throw new Error('codemirrorModel is required');
    if (!opts.editorModel) throw new Error('editorModel is required');
    if (!opts.querySchemaModel) throw new Error('querySchemaModel is required');
    if (!opts.onApplyEvent) throw new Error('onApplyEvent');

    this._layerDefinitionModel = opts.layerDefinitionModel;
    this._styleModel = this._layerDefinitionModel.styleModel;
    this._codemirrorModel = opts.codemirrorModel;
    this._editorModel = opts.editorModel;
    this._querySchemaModel = opts.querySchemaModel;

    this._initBinds();

    FactoryHints.init({
      querySchemaModel: this._querySchemaModel,
      layerDefinitionModel: this._layerDefinitionModel,
      tokens: CSSHints
    });
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this._layerDefinitionModel.bind('change:cartocss', this._updateEditorContent, this);
    this.add_related_model(this._layerDefinitionModel);
  },

  _initViews: function () {
    var hints = FactoryHints.reset().hints;
    this.codeMirrorView = new CodeMirrorView({
      model: this._codemirrorModel,
      addons: ['color-picker'],
      hints: hints,
      tip: _t('editor.style.code-mirror.save')
    });
    this.codeMirrorView.bind('codeSaved', this._triggerCodeSaved, this);
    this.addView(this.codeMirrorView);
    this.$el.append(this.codeMirrorView.render().el);
  },

  _updateEditorContent: function () {
    if (this._editorModel.get('edition') === false) {
      this.codeMirrorView.setContent(this._layerDefinitionModel.get('cartocss'));
    }
  },

  _triggerCodeSaved: function (code, view) {
    this.options.onApplyEvent && this.options.onApplyEvent();
  }

});

},{"../../components/code-mirror/code-mirror-view":27,"../editor-hints/css-hints":699,"../editor-hints/factory-hints":700,"backbone/core-view":1127}],1015:[function(require,module,exports){
arguments[4][886][0].apply(exports,arguments)
},{"dup":886,"underscore":"underscore"}],1016:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var StyleFormView = require('./style-form/style-form-view');
var StylesFactory = require('./styles-factory');
var CarouselFormView = require('../../components/carousel-form-view');
var CarouselCollection = require('../../components/custom-carousel/custom-carousel-collection');
var styleFormNotReadyTemplate = require('../layers/panel-loading-template.tpl');
var styleFormPlaceholderTemplate = require('./style-form-placeholder.tpl');
var georeferencePlaceholderTemplate = require('./georeference-placeholder.tpl');
var styleSQLErrorTemplate = require('./style-content-sql-error.tpl');
var OverlayView = require('../components/overlay/overlay-view');
var Notifier = require('../../components/notifier/notifier');
var QuerySanity = require('../layers/query-sanity-check');
var actionErrorTemplate = require('../layers/sql-error-action.tpl');
var MetricsTracker = require('../../components/metrics/metrics-tracker');
var checkAndBuildOpts = require('../../helpers/required-opts');
var fetchAllQueryObjectsIfNecessary = require('../../helpers/fetch-all-query-objects');

var STATES = {
  ready: 'ready',
  loading: 'loading',
  fetched: 'fetched',
  error: 'error'
};

var REQUIRED_OPTS = [
  'configModel',
  'layerDefinitionsCollection',
  'userModel',
  'layerDefinitionModel',
  'userActions',
  'styleModel',
  'overlayModel',
  'queryGeometryModel',
  'querySchemaModel',
  'queryRowsCollection',
  'freezeTorgeAggregation',
  'editorModel',
  'modals'
];

module.exports = CoreView.extend({

  className: 'Editor-styleContent',

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this.render = this.render.bind(this);

    this._initModels();
    this._initBinds();
    this._fetchAllQueryObjectsIfNecessary();

    QuerySanity.track(this, this.render);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    if (this._hasError()) {
      this._renderError();
    } else if (this._isLoading()) {
      this._renderStateless();
    } else if (this._isReady()) {
      if (this._queryGeometryModel.hasValue()) {
        if (this._queryGeometryModel.get('simple_geom') === 'point') {
          this._renderCarousel();
        }

        this._renderForm();
        this._renderOverlay();
      } else {
        if (this._layerDefinitionModel.canBeGeoreferenced()) {
          this.$el.html(georeferencePlaceholderTemplate());
          this._renderOverlay();
        } else {
          this.$el.html(styleFormPlaceholderTemplate());
        }
      }
    }

    return this;
  },

  _hasError: function () {
    return this.modelView.get('state') === STATES.error;
  },

  _isLoading: function () {
    return this.modelView.get('state') === STATES.loading ||
      !this._querySchemaModel.isFetched() ||
      !this._queryGeometryModel.isFetched() ||
      !this._queryRowsCollection.isFetched();
  },

  _isReady: function () {
    return this.modelView.get('state') === STATES.ready &&
      this._querySchemaModel.isFetched() &&
      this._queryGeometryModel.isFetched() &&
      this._queryRowsCollection.isFetched();
  },

  _getInitialState: function () {
    return STATES.loading;
  },

  _initModels: function () {
    this.modelView = new Backbone.Model({
      state: STATES.loading
    });

    this._carouselCollection = new CarouselCollection(
      _.map(StylesFactory.getStyleTypes(this._styleModel.get('type'), this._queryGeometryModel.get('simple_geom')), function (type) {
        return {
          selected: this._styleModel.get('type') === type.value,
          val: type.value,
          label: type.label,
          template: function () {
            return (type.iconTemplate && type.iconTemplate()) || type.value;
          }
        };
      }, this)
    );
  },

  _initBinds: function () {
    this.listenTo(this._layerDefinitionModel, 'change:autoStyle', this._onAutoStyleChanged);
    this.listenTo(this.modelView, 'change:state', this._checkEditorModel);
    this.listenTo(this._carouselCollection, 'change:selected', this._onSelectAggregation);

    // Render everything when there is an undo/redo action
    this.listenTo(this._styleModel, 'undo redo', this.render);
    this.listenTo(this._styleModel, 'change', this._onStyleChanged);

    this.listenTo(this._querySchemaModel, 'change:status', this._onStatusChanged);
    this.listenTo(this._queryGeometryModel, 'change:status', this._onStatusChanged);
    this.listenTo(this._queryRowsCollection.statusModel, 'change:status', this._onStatusChanged);
  },

  _fetchAllQueryObjectsIfNecessary: function () {
    fetchAllQueryObjectsIfNecessary({
      queryRowsCollection: this._queryRowsCollection,
      queryGeometryModel: this._queryGeometryModel,
      querySchemaModel: this._querySchemaModel
    });
  },

  _onAutoStyleChanged: function (layerDefModel) {
    var isAutoStyleApplied = layerDefModel.get('autoStyle');
    if (!isAutoStyleApplied) {
      this.render();
    } else {
      this._styleModel.unbind('change', this._onStyleChanged, this);
      this._styleModel.once('change', function () {
        this.render();
        this._styleModel.bind('change', this._onStyleChanged, this);
      }, this);
    }
  },

  _onStatusChanged: function () {
    fetchAllQueryObjectsIfNecessary({
      queryRowsCollection: this._queryRowsCollection,
      queryGeometryModel: this._queryGeometryModel,
      querySchemaModel: this._querySchemaModel
    }, this.render);

    this._checkEditorModel();
  },

  _checkEditorModel: function () {
    var hasGeometry = this._queryGeometryModel.hasValue();
    this._editorModel.set({ disabled: this._hasError() || !hasGeometry });
  },

  _renderError: function () {
    this.$el.append(
      styleSQLErrorTemplate({
        body: _t('editor.error-query.body', {
          action: actionErrorTemplate({
            label: _t('editor.error-query.label')
          })
        })
      })
    );
  },

  _renderStateless: function () {
    this.$el.append(
      styleFormNotReadyTemplate()
    );
  },

  _renderOverlay: function () {
    var view = new OverlayView({
      overlayModel: this._overlayModel
    });
    this.addView(view);
    this.$el.append(view.render().el);
  },

  _renderCarousel: function () {
    var view = new CarouselFormView({
      collection: this._carouselCollection,
      template: require('./style-form-types.tpl')
    });
    view.$el.addClass('js-aggregationTypes');
    this.addView(view);
    this.$el.append(view.render().el);
  },

  _onSelectAggregation: function (mdl) {
    var alreadyTorqueLayer = this._layerDefinitionsCollection.isThereAnyTorqueLayer();
    var isTorqueLayer = this._layerDefinitionModel.get('type') === 'torque';

    var styleType;
    var isTorqueType;
    var currentGeometryType;

    if (mdl.get('selected')) {
      styleType = mdl.getValue();
      currentGeometryType = this._queryGeometryModel.get('simple_geom');

      isTorqueType = (styleType === 'heatmap' || styleType === 'animation');

      if (alreadyTorqueLayer && !isTorqueLayer && isTorqueType) {
        this._freezeTorgeAggregation(styleType, currentGeometryType);
      } else {
        var setDefaultProperties = function () {
          this._styleModel.setDefaultPropertiesByType(styleType, currentGeometryType);
        }.bind(this);

        // If an animated or a heatmap style is selected, we should move the layer to the
        // top, but if it is in the most high position, we shouldn't do anything
        if (isTorqueType && !this._layerDefinitionsCollection.isDataLayerOnTop(this._layerDefinitionModel)) {
          this._moveTorqueLayerToTop(setDefaultProperties);
        } else {
          setDefaultProperties();
        }
      }
    }
  },

  _moveTorqueLayerToTop: function (callback) {
    var notification = Notifier.addNotification({
      status: 'loading',
      info: _t('editor.layers.moveTorqueLayer.loading'),
      closable: true
    });

    this._layerDefinitionsCollection.once('layerMoved', function () {
      callback && callback();
      notification.set({
        status: 'success',
        info: _t('editor.layers.moveTorqueLayer.success'),
        delay: Notifier.DEFAULT_DELAY
      });
    }, this);

    this._userActions.moveLayer({
      from: this._layerDefinitionModel.get('order'),
      to: this._layerDefinitionsCollection.getTopDataLayerIndex()
    });
  },

  _renderForm: function () {
    this._styleForm = new StyleFormView({
      layerDefinitionsCollection: this._layerDefinitionsCollection,
      layerDefinitionModel: this._layerDefinitionModel,
      styleModel: this._styleModel,
      configModel: this._configModel,
      userModel: this._userModel,
      queryGeometryModel: this._queryGeometryModel,
      querySchemaModel: this._querySchemaModel,
      modals: this._modals
    });
    this.$el.append(this._styleForm.render().el);
    this.addView(this._styleForm);
  },

  _onStyleChanged: function () {
    this._styleModel.attributes.autogenerated = false;
    this._layerDefinitionModel.save();

    MetricsTracker.track('Modified Style Form', {
      layer_id: this._layerDefinitionModel.get('id'),
      cartocss: this._layerDefinitionModel.get('cartocss'),
      style_properties: this._layerDefinitionModel.get('style_properties')
    });
  }
});

},{"../../components/carousel-form-view":23,"../../components/custom-carousel/custom-carousel-collection":40,"../../components/metrics/metrics-tracker":233,"../../components/notifier/notifier":475,"../../helpers/fetch-all-query-objects":1092,"../../helpers/required-opts":1097,"../components/overlay/overlay-view":694,"../layers/panel-loading-template.tpl":996,"../layers/query-sanity-check":997,"../layers/sql-error-action.tpl":1000,"./georeference-placeholder.tpl":1012,"./style-content-sql-error.tpl":1015,"./style-form-placeholder.tpl":1026,"./style-form-types.tpl":1027,"./style-form/style-form-view":1034,"./styles-factory":1053,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],1017:[function(require,module,exports){
var _ = require('underscore');
var camshaftReference = require('../../data/camshaft-reference');
var Utils = require('../../helpers/utils');
var InputColorCategories = require('../../components/form-components/editors/fill/input-color/input-categories/input-color-categories.js');

var CONFIG = {
  GENERIC_STYLE: camshaftReference.getDefaultCartoCSSForType(),
  DEFAULT_HEATMAP_COLORS: ['blue', 'cyan', 'lightgreen', 'yellow', 'orange', 'red']
};

// utilities
function _null () { return ''; }

function makeCartoCSS (obj, prefix) {
  var css = '';
  prefix = prefix || '';
  for (var k in obj) {
    css += prefix + k + ': ' + obj[k] + ';\n';
  }
  return css;
}

function makeColorRamp (props, isTorqueCategory) {
  var attribute = isTorqueCategory ? 'value' : props.attribute;
  var c = ['ramp([' + attribute + ']'];

  if (props.range) {
    if (_.isArray(props.range)) {
      c.push('(' + props.range.join(', ') + ')');
    } else {
      // colorramp name
      c.push(props.range);
      if (props.bins) {
        c.push(props.bins);
      }
    }
  }
  if (props.domain) {
    if (isTorqueCategory) {
      c.push('(' + _.map(props.domain, function (val, i) {
        return i + 1;
      }).join(', ') + ')');
    } else if (props.static) {
      // It comes from an autostyle, so we have to set the categories explicitly
      var parsedDomain = _.filter(props.domain, function (name) {
        return name !== '"Other"';
      });
      c.push('(' + parsedDomain.join(', ') + ')');
    } else {
      c.push('(' +
        _.filter(
          _.map(props.domain, function (val, i) {
            return val;
          }), function (val) {
          return !_.isUndefined(val);
        }).join(', ') +
        ')'
      );
      c.push('"="');
    }
  }
  if (props.quantification) {
    c.push(props.quantification.toLowerCase());
  }

  if (isTorqueCategory) {
    c.push('"="');
  }

  return c.join(', ') + ')';
}

function makeWidthRamp (props) {
  var c = ['ramp([' + props.attribute + ']'];

  if (props.range) {
    var min = props.range[0];
    var max = props.range[1];

    c.push('range(' + min + ', ' + max + ')');
  }

  if (props.quantification) {
    var quantification = props.quantification.toLowerCase();

    if (props.bins) {
      c.push(quantification + '(' + props.bins + ')');
    } else {
      c.push(quantification);
    }
  }

  return c.join(', ') + ')';
}

// size
function pointSize (props) {
  var css = {};
  if (props.fixed !== undefined) {
    css['marker-width'] = props.fixed;
  } else if (props.attribute) {
    css['marker-width'] = makeWidthRamp(props);
  } else {
    // throw new Error('size should contain a fixed value or an attribute')
  }
  return css;
}

function blending (b, geometryType, animatedType) {
  var css = {};
  var property = geometryType + '-comp-op';
  if (b !== 'none' && b !== undefined && animatedType !== 'heatmap') {
    if (animatedType === 'simple') {
      property = 'comp-op';
    }
    css[property] = b;
  }
  return css;
}

// fill
function pointFill (props, animationType) {
  var css = {};
  var color = (props && props.color) || {};
  var isTorqueCategory = animationType && !color.fixed;
  var markerFillOpacity = color.opacity;

  if (props.size) {
    css = pointSize(props.size);
  }
  if (color) {
    if (color.fixed !== undefined) {
      css['marker-fill'] = color.fixed;
    } else if (color.attribute) {
      css['marker-fill'] = makeColorRamp(color, isTorqueCategory);
    }
    if (color.operation) {
      css['marker-comp-op'] = color.operation;
    }

    css['marker-fill-opacity'] = markerFillOpacity != null ? markerFillOpacity : 1;

    if (hasImagesSelected(props.images) || hasImagesSelected(color.images)) {
      css['marker-file'] = markerFill(props.images || color.images, color);
    } else if (props.image || color.image) {
      var url = props.image;

      if (color.image) {
        url = 'url(\'' + color.image + '\')';
      }

      css['marker-file'] = url;
    }
  }
  if (!animationType) {
    css['marker-allow-overlap'] = true;
  }
  return css;
}

function hasImagesSelected (images) {
  if (!images) return false;
  if (!_.isArray(images)) return false;

  return _.some(images, function (image) {
    return image !== '';
  });
}

function getFalsyCategory (category) {
  return category === 0 ? '0' : "''";
}

function markerFill (images, color) {
  if (!_.isArray(images) || !color || !color.attribute) {
    return;
  }

  var columnName = '[' + color.attribute + ']';
  var filesUrls = [];
  var categoryNames = [];

  _.each(images, function (image, index) {
    if (image !== '') {
      var urlFormat = 'url(\'' + image + '\')';
      filesUrls.push(urlFormat);
      if (!_.isUndefined(color.domain[index])) {
        var category = color.domain[index] || getFalsyCategory(color.domain[index]);
        categoryNames.push(category);
      }
    }
  });

  return 'ramp(' + columnName + ', (' + filesUrls.join(', ') + '), (' + categoryNames.join(', ') + '), "="' + ')';
}

function polygonFill (props) {
  var css = {};
  if (props.color) {
    if (props.color.fixed !== undefined) {
      css['polygon-fill'] = props.color.fixed;
    } else if (props.color.attribute) {
      css['polygon-fill'] = makeColorRamp(props.color);
    }
    if (props.color.operation) {
      css['polygon-comp-op'] = props.color.operation;
    }
    if (_.isNumber(props.color.opacity)) {
      css['polygon-opacity'] = props.color.opacity;
    }
  }

  return css;
}

// stroke
function pointStroke (props, animationType) {
  var css = {};

  if (animationType === 'heatmap') {
    return css;
  }

  if (props.size) {
    css['marker-line-width'] = props.size.fixed;
  }
  if (props.color) {
    if (props.color.fixed !== undefined) {
      css['marker-line-color'] = props.color.fixed;
    } else if (props.color.attribute) {
      css['marker-line-color'] = makeColorRamp(props.color);
    }
    if (_.isNumber(props.color.opacity)) {
      css['marker-line-opacity'] = props.color.opacity;
    }
  }
  return css;
}

function polygonStroke (props) {
  var css = {};
  if (props.size) {
    if (props.size.fixed !== undefined) {
      css['line-width'] = props.size.fixed;
    } else if (props.size.attribute) {
      css['line-width'] = makeWidthRamp(props.size);
    }
  }
  if (props.color) {
    if (props.color.fixed) {
      css['line-color'] = props.color.fixed;
    } else if (props.color.attribute) {
      css['line-color'] = makeColorRamp(props.color);
    }
    if (_.isNumber(props.color.opacity)) {
      css['line-opacity'] = props.color.opacity;
    }
  }
  return css;
}

function isValidAttribute (attr) {
  return attr && attr !== '';
}

function pointAnimated (props) {
  var css = {};
  if (isValidAttribute(props.attribute)) {
    css['-torque-frame-count'] = props.steps;
    css['-torque-animation-duration'] = props.duration;
    css['-torque-time-attribute'] = '"' + props.attribute + '"';
    if (props.isCategory) {
      css['-torque-aggregation-function'] = '"CDB_Math_Mode(value)"';
    } else {
      css['-torque-aggregation-function'] = '"count(1)"';
    }
    css['-torque-resolution'] = props.resolution;
    css['-torque-data-aggregation'] = props.overlap ? 'cumulative' : 'linear';
  }
  return css;
}

function _labels (props) {
  var css = {};
  if (isValidAttribute(props.attribute)) {
    css['text-name'] = '[' + props.attribute + ']';
    css['text-face-name'] = "'" + props.font + "'";
    if (props.fill) {
      css['text-size'] = props.fill.size.fixed;

      if (props.fill.color.opacity != null && props.fill.color.opacity < 1) {
        css['text-fill'] = Utils.hexToRGBA(props.fill.color.fixed, props.fill.color.opacity);
      } else {
        css['text-fill'] = props.fill.color.fixed;
      }
    }
    css['text-label-position-tolerance'] = 0;
    if (props.halo) {
      css['text-halo-radius'] = props.halo.size.fixed;

      if (props.halo.color.opacity != null && props.halo.color.opacity < 1) {
        css['text-halo-fill'] = Utils.hexToRGBA(props.halo.color.fixed, props.halo.color.opacity);
      } else {
        css['text-halo-fill'] = props.halo.color.fixed;
      }
    }
    css['text-dy'] = props.offset === undefined ? -10 : props.offset;
    css['text-allow-overlap'] = props.overlap === undefined ? true : props.overlap;
    css['text-placement'] = 'point';
    css['text-placement-type'] = 'dummy';
  }
  return css;
}

function imageFilters (props) {
  var css = {};
  if (props.ramp) {
    css['image-filters'] = 'colorize-alpha(' + props.ramp.join(',') + ')';
  }
  return css;
}

var cartocssFactory = {
  animated: {
    point: pointAnimated,
    line: _null,
    polygon: _null
  },

  trails: {
    point: trails,
    line: _null,
    polygon: _null
  },

  fill: {
    point: pointFill,
    line: _null,
    polygon: polygonFill
  },

  stroke: {
    point: pointStroke,
    line: polygonStroke,
    polygon: polygonStroke
  },

  labels: {
    point: _labels,
    line: _labels,
    polygon: _labels
  },

  imageFilters: {
    point: imageFilters,
    line: imageFilters,
    polygon: imageFilters
  },

  blending: {
    point: function (attrs, animationType) { return blending(attrs, 'marker', animationType); },
    line: function (attrs) { return blending(attrs, 'line'); },
    polygon: function (attrs) { return blending(attrs, 'polygon'); }
  }
};

var heatmapConversion = function (style, animated, configModel) {
  // modify the size
  style.fill = _.clone(style.fill);
  var ramp = style.fill.color.range;
  style.fill.size = style.fill.size || { fixed: 35 };

  style.fill.image = 'url(' + configModel.get('app_assets_base_url') + '/unversioned/images/alphamarker.png)';

  style.fill.color = {
    fixed: style.fill.color.fixed || 'white',
    opacity: style.fill.color.opacity
  };

  // switch to torque
  // add image filters
  if (ramp !== undefined) {
    style.imageFilters = {
      ramp: _.isArray(ramp) ? ramp : CONFIG.DEFAULT_HEATMAP_COLORS
    };
  }
  return style;
};

var styleConversion = {
  animation: function (style, configModel) {
    if (style.style === 'heatmap') {
      return heatmapConversion(style, true, configModel);
    }
  },

  heatmap: function (style, configModel) {
    return heatmapConversion(style, false, configModel);
  }
};

function renderBlock (block, geometryType, animationType) {
  var css = {};
  for (var k in block) {
    var f = cartocssFactory[k];
    if (f) {
      css = _.extend(css, f[geometryType](block[k], animationType));
    }
  }
  return makeCartoCSS(css, '  ');
}

function isTypeTorque (type) {
  return type === 'animation' || type === 'heatmap';
}

function isCategoryType (styleDef, geometryType) {
  if (geometryType === 'line') {
    var stroke = styleDef.stroke;
    return stroke && stroke.color && stroke.color.fixed == null;
  } else {
    var fill = styleDef.fill;
    return fill && fill.color && fill.color.fixed == null;
  }
}

function generateCartoCSS (style, geometryType, configModel) {
  var css = '';
  var styleDef = style.properties;
  var isAnimatable = isTypeTorque(style.type);
  var isCategory = isCategoryType(styleDef, geometryType);
  var animationType = style.type === 'animation' && styleDef.style;

  if (geometryType === 'point' && isAnimatable) {
    css += 'Map {\n';
    css += renderBlock({
      animated: _.extend({}, styleDef.animated, { isCategory: isCategory })
    }, geometryType);
    css += '}\n';
  }

  css += '#layer {\n';
  css += renderBlock(_.omit(styleDef, 'animated', 'labels'), geometryType, animationType);
  css += '}';

  // labels
  if (styleDef.labels && styleDef.labels.enabled && styleDef.labels.enabled !== 'false') {
    css += '\n#layer::labels {\n';
    css += renderBlock({ labels: styleDef.labels }, geometryType);
    css += '}';
  }

  if (isAnimatable && styleDef.animated.trails && styleDef.animated.trails > 0) {
    css += cartocssFactory.trails[geometryType](styleDef);
  }

  return css;
}

function trails (def) {
  var baseWidth = def.fill.size && parseInt(def.fill.size.fixed, 10);
  var baseOpacity = def.fill.color.opacity != null ? def.fill.color.opacity : 1;
  if (!baseWidth) return '';
  return '\n' +
    _.range(1, parseInt(def.animated.trails, 10) + 1)
      .map(function (t) {
        return '#layer[frame-offset=' + t + '] {\n' +
          makeCartoCSS({ 'marker-width': baseWidth + 2 * t }, '  ') +
          makeCartoCSS({ 'marker-fill-opacity': baseOpacity / (2 * t) }, '  ') +
          '}';
      }
    ).join('\n');
}

function aggToSQL (agg) {
  if (agg.operator.toLowerCase() === 'count') {
    return 'count(1)';
  }
  return agg.operator + '(' + agg.attribute + ')';
}

function regionTableMap (level) {
  var map = {
    'countries': 'aggregation.agg_admin0',
    'provinces': 'aggregation.agg_admin1'
  };
  return map[level];
}

function hexabins (style, mapContext) {
  var aggregation = style.properties.aggregation;
  var sql = 'WITH hgrid AS (SELECT CDB_HexagonGrid(ST_Expand(!bbox!, CDB_XYZ_Resolution(<%= z %>) * <%= size %>), CDB_XYZ_Resolution(<%= z %>) * <%= size %>) as cell) SELECT hgrid.cell as the_geom_webmercator, <%= agg %> as agg_value, count(1)/power( <%= size %> * CDB_XYZ_Resolution(<%= z %>), 2 ) as agg_value_density, row_number() over () as cartodb_id FROM hgrid, <%= table %> i where ST_Intersects(i.the_geom_webmercator, hgrid.cell) GROUP BY hgrid.cell';
  return _.template(sql)({
    table: '(<%= sql %>)',
    size: aggregation.size,
    agg: aggToSQL(aggregation.value),
    z: mapContext.zoom
  });
}

function squares (style, mapContext) {
  var aggregation = style.properties.aggregation;
  var sql = 'WITH hgrid AS (SELECT CDB_RectangleGrid ( ST_Expand(!bbox!, CDB_XYZ_Resolution(<%= z %>) * <%= size %>), CDB_XYZ_Resolution(<%= z %>) * <%= size %>, CDB_XYZ_Resolution(<%= z %>) * <%= size %>) as cell) SELECT hgrid.cell as the_geom_webmercator, <%= agg %> as agg_value, <%= agg %> /power( <%= size %> * CDB_XYZ_Resolution(<%= z %>), 2 ) as agg_value_density, row_number() over () as cartodb_id FROM hgrid, <%= table %> i where ST_Intersects(i.the_geom_webmercator, hgrid.cell) GROUP BY hgrid.cell';
  return _.template(sql)({
    table: '(<%= sql %>)',
    size: aggregation.size,
    agg: aggToSQL(aggregation.value),
    z: mapContext.zoom
  });
}

function regions (style) {
  var aggregation = style.properties.aggregation;
  // TODO: add !bbox! tokens to help postgres with FDW join
  // I tested this on postgres 9.6, the planner seems to be doing weird, it takes
  // 7 seconds to query a simple tile with no join, I hope 9.5 works much better
  // Maybe using a CTE with the FDW table improves the thing
  // Normalize also by area using the real area (not projected one). Using the_geom_webmercator for that instead of the_geom
  // to avoid extra data going through the network in the FDW
  // use 2.6e-06 as minimum area (tile size at zoom level 31)
  var sql = [
    'SELECT _poly.*, _merge.points_agg/GREATEST(0.0000026, ST_Area((ST_Transform(the_geom, 4326))::geography)) as agg_value_density, _merge.points_agg as agg_value FROM <%= aggr_dataset %> _poly, lateral (',
    'SELECT <%= agg %> points_agg FROM (<%= table %>) _point where ST_Contains(_poly.the_geom_webmercator, _point.the_geom_webmercator) ) _merge'].join('\n');
  return _.template(sql)({
    table: '<%= sql %>',
    aggr_dataset: regionTableMap(aggregation.dataset),
    agg: aggToSQL(aggregation.value)
  });
}

function animation (style, mapContext) {
  var color = style.properties.fill.color;
  var columnType = color.attribute_type;
  var columnName = color.attribute;
  var hasOthers = color.range && color.range.length > InputColorCategories.MAX_VALUES;
  var categoryCount = color.domain && color.domain.length;

  var s = ['select *, (CASE'];

  if (color.fixed != null || color.domain == null) {
    return null;
  }

  function _normalizeValue (v) {
    return v.replace(/\n/g, '\\n').replace(/\"/g, '\\"').replace();
  }

  for (var i = 0, l = categoryCount; i < l; i++) {
    var categoryName = color.domain[i];
    var categoryPos = i + 1;
    var value;

    if (columnType !== 'string' || categoryName === null) {
      value = categoryName;
    } else {
      value = "'" + _normalizeValue(categoryName.replace(/(^")|("$)/g, '')) + "'";
    }

    if (value != null) {
      s.push('WHEN "' + columnName + '" = ' + value + ' THEN ' + categoryPos);
    } else {
      s.push('WHEN "' + columnName + '" is NULL THEN ' + categoryPos);
    }
  }

  if (hasOthers) {
    s.push(' ELSE ' + (categoryCount + 1));
  }

  s.push(' END) as value FROM (<%= sql %>) __wrapped');
  return s.join(' ');
}

var SQLFactory = {
  hexabins: hexabins,
  squares: squares,
  regions: regions,
  animation: animation
};

function generateSQL (style, geometryType, mapContext) {
  if (SQLFactory[style.type] === undefined) {
    return null;
  }

  if (style.type !== 'animation' && style.properties.aggregation === undefined) {
    throw new Error('aggregation properties not available');
  }

  var fn = SQLFactory[style.type];
  if (fn === undefined) {
    throw new Error("can't generate SQL for aggregation " + style.type);
  }
  return fn(style, mapContext);
}

var AggregatedFactory = {
  simple: {
    geometryType: {
      point: 'point',
      line: 'line',
      polygon: 'polygon'
    }
  },
  hexabins: {
    geometryType: {
      point: 'polygon',
      line: null,
      polygon: null
    }
  },
  squares: {
    geometryType: {
      point: 'polygon',
      line: null,
      polygon: null
    }
  },
  regions: {
    geometryType: {
      point: 'polygon',
      line: null,
      polygon: null
    }
  }
};

/**
 * given a styleDefinition object and the geometry type generates the query wrapper and the
 */
function generateStyle (style, geometryType, mapContext, configModel) {
  if (style.type === 'none') {
    return {
      cartoCSS: CONFIG.GENERIC_STYLE,
      sql: null,
      layerType: 'CartoDB'
    };
  }

  if (style.type !== 'simple' && geometryType !== 'point') {
    throw new Error('aggregated styling does not work with ' + geometryType);
  }

  // pre style conversion
  // some styles need some conversion, for example aggregated based on
  // torque need to move from aggregation to animated properties
  var conversion = styleConversion[style.type];
  var properties;
  if (conversion) {
    properties = conversion(style.properties, configModel);
    if (properties) {
      style.properties = properties;
    }
  }

  // override geometryType for aggregated styles
  var geometryMapping = AggregatedFactory[style.type];
  if (geometryMapping) {
    geometryType = geometryMapping.geometryType[geometryType];
  }

  if (!geometryType) {
    throw new Error('geometry type not supported for ' + style.type);
  }

  var layerType = style.type === 'heatmap' || style.type === 'animation' ? 'torque' : 'CartoDB';

  return {
    cartoCSS: generateCartoCSS(style, geometryType, configModel),
    sql: generateSQL(style, geometryType, mapContext),
    layerType: layerType
  };
}

module.exports = {
  configure: function (cfg) {
    _.extend(CONFIG, cfg);
  },
  generateStyle: generateStyle,
  GENERIC_STYLE: CONFIG.GENERIC_STYLE
};

},{"../../components/form-components/editors/fill/input-color/input-categories/input-color-categories.js":139,"../../data/camshaft-reference":615,"../../helpers/utils":1102,"underscore":"underscore"}],1018:[function(require,module,exports){
var _ = require('underscore');
var SimpleStyleDefaults = require('./simple-style-defaults');

module.exports = _.defaults({

  generateAttributes: function (geometryType) {
    return _.extend(
      this._getStyleTypeAttrs(),
      this._getFillAttrs(geometryType),
      this._getStrokeAttrs(geometryType),
      {
        blending: 'lighter'
      },
      this._getAggrAttrs(geometryType),
      this._getAnimatedAttrs(geometryType)
    );
  },

  _getStyleTypeAttrs: function () {
    return {
      style: 'simple'
    };
  },

  _getAnimatedAttrs: function (geometryType) {
    return {
      animated: {
        attribute: null,
        overlap: false,
        duration: 30,
        steps: 256,
        trails: 2,
        resolution: 4
      }
    };
  },

  _getAggrAttrs: function (geometryType) {
    return {
      aggregation: {}
    };
  }
}, SimpleStyleDefaults);

},{"./simple-style-defaults":1022,"underscore":"underscore"}],1019:[function(require,module,exports){
var _ = require('underscore');
var SimpleStyleDefaults = require('./simple-style-defaults');
var rampList = require('cartocolor');

module.exports = _.defaults({

  generateAttributes: function (geometryType) {
    return _.extend(
      this._getFillAttrs(geometryType),
      this._getAggrAttrs(),
      this._getAnimatedAttrs(),
      this._getLabelsAttrs()
    );
  },

  _getFillAttrs: function (geometryType) {
    var attrs = {
      fill: {
        'size': {
          fixed: 45
        },
        'color': {
          attribute: 'cartodb_id',
          range: rampList.ag_Sunset[7],
          bins: 6
        }
      }
    };

    return attrs;
  },

  _getAggrAttrs: function () {
    return {
      aggregation: {}
    };
  },

  _getAnimatedAttrs: function (geometryType) {
    return {
      animated: {
        attribute: 'cartodb_id',
        overlap: false,
        duration: 30,
        steps: 1,
        trails: 0,
        resolution: 4
      }
    };
  },

  _getLabelsAttrs: function () {
    return {
      labels: {}
    };
  }

}, SimpleStyleDefaults);

},{"./simple-style-defaults":1022,"cartocolor":"cartocolor","underscore":"underscore"}],1020:[function(require,module,exports){
var _ = require('underscore');
var SimpleStyleDefaults = require('./simple-style-defaults');
var DefaultFormValues = require('../../../data/default-form-styles.json');
var Utils = require('../../../helpers/utils');
var rampList = require('cartocolor');

module.exports = _.defaults({

  _getAggrAttrs: function (geometryType) {
    return {
      aggregation: {
        size: 10,
        value: {
          operator: 'count',
          attribute: ''
        }
      }
    };
  },

  _getStrokeAttrs: function (geometryType) {
    var strokeAttrs = DefaultFormValues['stroke'];
    return {
      stroke: Utils.cloneObject(strokeAttrs)
    };
  },

  _getFillAttrs: function (geometryType) {
    var colors = rampList['ag_GrnYl'][5];
    return {
      fill: {
        'color': {
          attribute: 'agg_value',
          bins: '5',
          quantification: 'quantiles',
          // TODO: flip the ramp when basemap is black
          // range: rampList.ag_GrnYl[5].reverse()
          range: Utils.cloneObject(colors)
        }
      }
    };
  }

}, SimpleStyleDefaults);

},{"../../../data/default-form-styles.json":622,"../../../helpers/utils":1102,"./simple-style-defaults":1022,"cartocolor":"cartocolor","underscore":"underscore"}],1021:[function(require,module,exports){
var _ = require('underscore');
var SimpleStyleDefaults = require('./simple-style-defaults');
var rampList = require('cartocolor');

module.exports = _.defaults({
  _getAggrAttrs: function (geometryType) {
    return {
      aggregation: {
        dataset: 'countries',
        change: 'manual',
        value: {
          operator: 'count',
          attribute: ''
        }
      }
    };
  },

  _getFillAttrs: function (geometryType) {
    return {
      fill: {
        'color': {
          attribute: 'agg_value_density',
          bins: '5',
          quantification: 'quantiles',
          range: _.clone(rampList.Emrld[5])
        }
      }
    };
  }

}, SimpleStyleDefaults);

},{"./simple-style-defaults":1022,"cartocolor":"cartocolor","underscore":"underscore"}],1022:[function(require,module,exports){
var _ = require('underscore');
var StyleDefaults = require('./style-defaults');
var DefaultCartography = require('../../../data/default-cartography.json');
var DefaultFormValues = require('../../../data/default-form-styles.json');
var Utils = require('../../../helpers/utils');

module.exports = _.defaults({

  generateAttributes: function (geometryType) {
    return _.extend(
      {},
      this._getFillAttrs(geometryType),
      this._getStrokeAttrs(geometryType),
      {
        blending: DefaultFormValues['blending']
      },
      this._getAggrAttrs(geometryType),
      this._getLabelsAttrs()
    );
  },

  _getFillAttrs: function (geometryType) {
    var fillAttrs = DefaultCartography['simple'][geometryType]['fill'];
    return {
      fill: Utils.cloneObject(fillAttrs)
    };
  },

  _getStrokeAttrs: function (geometryType) {
    var strokeAttrs = DefaultCartography['simple'][geometryType]['stroke'];
    return {
      stroke: Utils.cloneObject(strokeAttrs)
    };
  },

  _getAggrAttrs: function () {
    var aggrAttrs = DefaultFormValues['aggregation'];
    return {
      aggregation: Utils.cloneObject(aggrAttrs)
    };
  },

  _getLabelsAttrs: function () {
    var labelsAttrs = DefaultFormValues['labels'];
    return {
      labels: Utils.cloneObject(labelsAttrs)
    };
  }
}, StyleDefaults);

},{"../../../data/default-cartography.json":621,"../../../data/default-form-styles.json":622,"../../../helpers/utils":1102,"./style-defaults":1024,"underscore":"underscore"}],1023:[function(require,module,exports){
var _ = require('underscore');
var HexabinsAggregationDefaults = require('./hexabins-aggregation-style-defaults');

module.exports = _.defaults({

  _getAggrAttrs: function (geometryType) {
    return {
      aggregation: {
        size: 12,
        value: {
          operator: 'count',
          attribute: ''
        }
      }
    };
  }

}, HexabinsAggregationDefaults);

},{"./hexabins-aggregation-style-defaults":1020,"underscore":"underscore"}],1024:[function(require,module,exports){
module.exports = {
  generateAttributes: function (geometryType) {
    return {
      fill: null,
      stroke: null,
      blending: null,
      aggregation: {},
      labels: {}
    };
  }
};

},{}],1025:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var StylesFactory = require('./styles-factory');
var UndoManager = require('../../data/undo-manager');

module.exports = Backbone.Model.extend({

  parse: function (r) {
    r = r || {};
    return _.extend(
      {
        type: r.type,
        autogenerated: r && r.autogenerated
      },
      r.properties
    );
  },

  initialize: function (attrs, opts) {
    if (!this.get('type')) {
      this.setDefaultPropertiesByType('simple', 'point');
    }

    UndoManager.init(this, { track: true });
  },

  resetPropertiesFromAutoStyle: function () {
    if (this._stylesPreAutoStyle) {
      delete this.attributes.autoStyle;
      this.set(this._stylesPreAutoStyle);
      this.removeStylesPreAutoStyle();
    }
  },

  removeStylesPreAutoStyle: function () {
    delete this._stylesPreAutoStyle;
  },

  setPropertiesFromAutoStyle: function (params) {
    if (!params.definition) throw new Error('definition is required');
    if (!params.geometryType) throw new Error('geometryType is required');
    if (!params.widgetId) throw new Error('widgetId is required');

    if (!this._stylesPreAutoStyle) {
      this._stylesPreAutoStyle = JSON.parse(JSON.stringify(this.attributes));
    }

    // In order to trigger a proper change at the end of this function, we have
    // to make a clear change in the attributes, like delete the autoStyle property.
    delete this.attributes.autoStyle;

    var extendAutoStyleProperties = function (attribute, newProperties) {
      var properties = this.get(attribute);
      // Check domain quotes
      if (newProperties.color && newProperties.color.domain) {
        var quotedDomain = _.compact(
          _.map(newProperties.color.domain, function (name) {
            if (name && name !== true) {
              return '"' + name.toString().replace(/"/g, '\\"').replace(/\n/g, '\\n') + '"';
            } else {
              return name;
            }
          })
        );
        newProperties.color.static = true;
        newProperties.color.domain = quotedDomain;
        newProperties.color.quantification = 'category';
        newProperties.color.attribute_type = 'string';
      } else {
        newProperties.color.bins = newProperties.color.range.length;
        newProperties.color.quantification = 'quantiles';
        newProperties.color.attribute_type = 'number';
      }

      properties = _.extend(
        properties,
        newProperties
      );

      return properties;
    }.bind(this);

    var currentAttrs = JSON.parse(JSON.stringify(this.attributes));
    if (params.geometryType === 'line') {
      currentAttrs.stroke = extendAutoStyleProperties('stroke', params.definition[params.geometryType]);
    } else {
      currentAttrs.fill = extendAutoStyleProperties('fill', params.definition[params.geometryType]);
    }

    this.set(
      _.extend(
        {
          type: 'simple',
          autoStyle: params.widgetId
        },
        currentAttrs
      )
    );
  },

  setDefaultPropertiesByType: function (styleType, geometryType, silently) {
    // Get default aggregation and properties from factory and apply them
    this.set(
      _.extend(
        {
          type: styleType
        },
        StylesFactory.getDefaultStyleAttrsByType(styleType, geometryType)
      ), {
        silently: !!silently
      }
    );

    // Although we want to make the change silently, we have several places listening
    // for style changes, so we trigger this custom event
    if (silently) {
      this.trigger('style:update');
    }
  },

  setFill: function (type) {
    var simpleFill = StylesFactory.getDefaultStyleAttrsByType(type, 'point');
    this.set('fill', simpleFill.fill);
  },

  applyLastState: function () {
    this._undoManager.stopTracking();
    this.trigger('change');
    this._undoManager.startTracking();
  },

  resetStyles: function () {
    this.setDefaultPropertiesByType('none', '');
  },

  // Backend will migrate current wizard properties to style properties,
  // providing a flag which indicates if it is generated by them
  isAutogenerated: function () {
    return this.get('autogenerated');
  },

  isAggregatedType: function () {
    return _.contains(StylesFactory.getAggregationTypes(), this.get('type'));
  },

  isAnimation: function () {
    return this.get('type') === 'animation';
  },

  hasNoneStyles: function () {
    return this.get('type') === 'none';
  },

  canApplyAutoStyle: function () {
    return this.get('type') === 'simple';
  },

  getColumnsUsedForStyle: function () {
    var columns = [];
    // Fill (size and color)
    var fill = this.get('fill');
    if (fill && fill.color && fill.color.attribute) {
      columns.push({
        name: fill.color.attribute,
        type: fill.color.attribute_type || 'string'
      });
    }
    if (fill && fill.size && fill.size.attribute) {
      columns.push({
        name: fill.size.attribute,
        type: 'number'
      });
    }

    // Stroke (size and color)
    var stroke = this.get('stroke');
    if (stroke && stroke.color && stroke.color.attribute) {
      columns.push({
        name: stroke.color.attribute,
        type: stroke.color.attribute_type || 'string'
      });
    }
    if (stroke && stroke.size && stroke.size.attribute) {
      columns.push({
        name: stroke.size.attribute,
        type: 'number'
      });
    }

    // Labels
    var labels = this.get('labels');
    if (labels && labels.attribute && labels.enabled) {
      columns.push({
        name: labels.attribute
      });
    }

    // Aggregation
    var aggregation = this.get('aggregation');
    if (aggregation && aggregation.value && aggregation.value.attribute) {
      columns.push({
        name: aggregation.value.attribute,
        type: aggregation.value.attribute_type || 'string'
      });
    }

    return columns;
  },

  // Unflatten attributes
  toJSON: function () {
    return {
      type: this.get('type'),
      properties: _.omit(this.attributes, 'type', 'autogenerated')
    };
  }
});

},{"../../data/undo-manager":667,"./styles-factory":1053,"backbone":"backbone","underscore":"underscore"}],1026:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h2 class="CDB-Text CDB-Size-huge is-light u-secondaryTextColor js-styleNoGeom">'+
((__t=( _t('editor.style.style-form.properties.placeholder-text') ))==null?'':_.escape(__t))+
'</h2>\n';
}
return __p;
};

},{"underscore":"underscore"}],1027:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfo">\n  <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">1</div>\n  <div class="Editor-HeaderInfo-inner CDB-Text js-selector">\n    <div class="Editor-HeaderInfo-title u-bSpace--m">\n      <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.style.style-form.type.title-label') ))==null?'':_.escape(__t))+
'</h2>\n    </div>\n    <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m js-highlight">'+
((__t=( name ))==null?'':_.escape(__t))+
'</p>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],1028:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h2 class="CDB-Text CDB-Size-huge is-light u-secondaryTextColor">\n  '+
((__t=( _t('editor.style.messages.none') ))==null?'':_.escape(__t))+
'\n</h2>\n';
}
return __p;
};

},{"underscore":"underscore"}],1029:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
require('../../../../components/form-components/index');
var StyleShapeFormModel = require('./style-aggregation-properties-form-model');
var template = require('./style-aggregation-form.tpl');

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.querySchemaModel) throw new Error('querySchemaModel is required');
    if (!opts.queryGeometryModel) throw new Error('queryGeometryModel is required');
    if (!opts.styleModel) throw new Error('styleModel is required');
    if (!opts.modals) throw new Error('modals is required');
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.userModel) throw new Error('userModel is required');

    this._queryGeometryModel = opts.queryGeometryModel;
    this._querySchemaModel = opts.querySchemaModel;
    this._styleModel = opts.styleModel;
    this._configModel = opts.configModel;
    this._userModel = opts.userModel;
    this._modals = opts.modals;
  },

  render: function () {
    this.clearSubViews();
    this._removeFormView();
    this.$el.html(template());
    this._initViews();
    return this;
  },

  _initViews: function () {
    this._aggrFormModel = new StyleShapeFormModel(
      this._styleModel.get('aggregation'),
      {
        queryGeometryModel: this._queryGeometryModel,
        querySchemaModel: this._querySchemaModel,
        styleModel: this._styleModel,
        configModel: this._configModel,
        userModel: this._userModel,
        modals: this._modals
      }
    );

    this._aggrFormView = new Backbone.Form({
      model: this._aggrFormModel
    });

    this._aggrFormView.bind('change', function () {
      this.commit();
    });

    this.$('.js-aggregationForm').append(this._aggrFormView.render().el);
  },

  _removeFormView: function () {
    if (this._aggrFormView) {
      this._aggrFormView.remove();
    }
  },

  clean: function () {
    this._removeFormView();
    CoreView.prototype.clean.call(this);
  }

});

},{"../../../../components/form-components/index":211,"./style-aggregation-form.tpl":1030,"./style-aggregation-properties-form-model":1031,"backbone":"backbone","backbone/core-view":1127}],1030:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfo js-aggregationOptions">\n  <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n  <div class="Editor-HeaderInfo-inner CDB-Text js-selector">\n    <div class="Editor-HeaderInfo-title u-bSpace--m">\n      <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.style.style-form.aggregation.title-label') ))==null?'':_.escape(__t))+
'</h2>\n    </div>\n    <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m js-highlight">'+
((__t=( _t('editor.style.style-form.aggregation.desc') ))==null?'':_.escape(__t))+
'</p>\n    <div class="js-aggregationForm"></div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],1031:[function(require,module,exports){
var _ = require('underscore');
var StyleFormDefaultModel = require('../style-form-default-model');

module.exports = StyleFormDefaultModel.extend({

  _FORM_NAME: 'aggregation',

  _onChange: function () {
    this._styleModel.set('aggregation', _.clone(this.attributes));
  }

});

},{"../style-form-default-model":1033,"underscore":"underscore"}],1032:[function(require,module,exports){
var _ = require('underscore');
var FONTS_LIST = [
  'DejaVu Sans Book',
  'unifont Medium',
  'Open Sans Regular',
  'Lato Regular',
  'Lato Bold',
  'Lato Bold Italic',
  'Graduate Regular',
  'Gravitas One Regular',
  'Old Standard TT Regular',
  'Old Standard TT Italic',
  'Old Standard TT Bold'
];

// Depending the type of the style, if could provide different schema values
function getOptionsByStyleType (params) {
  if (!params.querySchemaModel) throw new Error('querySchemaModel is required');
  var optionsArray = getSchemaColumns(params.querySchemaModel, params.filterFunction);

  switch (params.styleType) {
    case 'heatmap':
      optionsArray = [{
        val: 'cartodb_id',
        label: 'cartodb_id',
        type: 'number'
      }];
      break;
    case 'regions':
      optionsArray = [{
        val: 'agg_value',
        label: 'agg_value',
        type: 'number'
      }, {
        val: 'agg_value_density',
        label: 'agg_value_density',
        type: 'number'
      }];
      break;
    case 'hexabins':
    case 'squares':
      optionsArray = [{
        val: 'agg_value',
        label: 'agg_value',
        type: 'number'
      }];
      break;
    case 'animation':
      if (params.animationType === 'heatmap') {
        optionsArray = [{
          val: 'cartodb_id',
          label: 'cartodb_id',
          type: 'number'
        }];
      }
      break;
    default:
      // Nothing
  }

  return optionsArray;
}

// Provide an array of columns from the current schema
function getSchemaColumns (querySchemaModel, filterFunction) {
  if (!querySchemaModel) throw new Error('querySchemaModel is required');

  var columnsCollection = querySchemaModel.columnsCollection;
  if (filterFunction) {
    columnsCollection = columnsCollection.filter(filterFunction);
  }
  return columnsCollection
    .map(function (m) {
      var columnName = m.get('name');
      return {
        val: columnName,
        label: columnName,
        type: m.get('type')
      };
    });
}

function generateSelectByStyleType (params) {
  if (!params.componentName) throw new Error('componentName is required');
  if (!params.querySchemaModel) throw new Error('querySchemaModel is required');
  if (!params.styleType) throw new Error('styleType is required');

  var queryStatus = params.querySchemaModel.get('status');
  var isDisabled = queryStatus !== 'fetched';
  var helpMessage = _t('editor.style.components.' + params.componentName + '.' + queryStatus);

  return {
    type: 'Select',
    title: _t('editor.style.components.' + params.componentName + '.label'),
    help: isDisabled ? helpMessage : '',
    options: getOptionsByStyleType({
      querySchemaModel: params.querySchemaModel,
      filterFunction: params.filterFunction,
      styleType: params.styleType
    }),
    dialogMode: 'float',
    editorAttrs: { disabled: isDisabled },
    validators: ['required']
  };
}

function generateSelectWithSchemaColumns (componentName, querySchemaModel, filterFunction) {
  var queryStatus = querySchemaModel.get('status');
  var isDisabled = queryStatus !== 'fetched';
  var helpMessage = _t('editor.style.components.' + componentName + '.' + queryStatus);

  return {
    type: 'Select',
    title: _t('editor.style.components.' + componentName + '.label'),
    help: isDisabled ? helpMessage : '',
    options: getSchemaColumns(querySchemaModel, filterFunction),
    editorAttrs: { disabled: isDisabled },
    dialogMode: 'float',
    validators: ['required']
  };
}

function generateSimpleStroke (params) {
  if (!params.querySchemaModel) throw new Error('querySchemaModel is required');
  if (!params.configModel) throw new Error('configModel is required');
  if (!params.userModel) throw new Error('userModel is required');
  if (!params.modals) throw new Error('modals is required');

  return {
    type: 'Fill',
    title: _t('editor.style.components.stroke.label'),
    options: [],
    query: params.querySchemaModel.get('query'),
    configModel: params.configModel,
    userModel: params.userModel,
    modals: params.modals,
    dialogMode: 'float',
    editorAttrs: {
      size: {
        min: 0,
        max: 10,
        step: 0.5,
        hidePanes: ['value']
      },
      color: {
        hidePanes: ['value']
      }
    },
    validators: ['required']
  };
}

function generateLineStroke (params) {
  if (!params.querySchemaModel) throw new Error('querySchemaModel is required');
  if (!params.configModel) throw new Error('configModel is required');
  if (!params.styleType) throw new Error('styleType is required');
  if (!params.userModel) throw new Error('userModel is required');
  if (!params.modals) throw new Error('modals is required');

  var queryStatus = params.querySchemaModel.get('status');
  var isDisabled = queryStatus !== 'fetched';
  var helpMessage = _t('editor.style.components.stroke.' + queryStatus);

  return {
    type: 'Fill',
    title: _t('editor.style.components.stroke.label'),
    help: isDisabled ? helpMessage : '',
    options: getOptionsByStyleType({
      querySchemaModel: params.querySchemaModel,
      styleType: params.styleType
    }),
    query: params.querySchemaModel.get('query'),
    configModel: params.configModel,
    userModel: params.userModel,
    modals: params.modals,
    dialogMode: 'float',
    editorAttrs: {
      min: 0,
      max: 50,
      disabled: isDisabled
    },
    validators: ['required']
  };
}

/*
 *  Dictionary that contains all the necessary components
 *  for the styles form
 */

module.exports = {
  'fill': function (params) {
    var editorAttrs = {
      size: {
        min: 1,
        max: 45,
        step: 0.5
      }
    };
    var options = getOptionsByStyleType({
      querySchemaModel: params.querySchemaModel,
      styleType: params.styleType,
      animationType: params.animationType
    });
    var isPointGeometry = params.queryGeometryModel && params.queryGeometryModel.get('simple_geom') === 'point';

    if (params.styleType === 'heatmap') {
      editorAttrs.size.hidePanes = ['value'];
      editorAttrs.color = {
        hidePanes: ['fixed']
      };
    } else if (params.styleType === 'simple' && isPointGeometry && !params.isAutoStyleApplied) {
      editorAttrs.color = {
        imageEnabled: true
      };
    }

    if (params.styleType === 'animation') {
      editorAttrs.size.hidePanes = ['value'];

      if (params.animationType === 'simple') {
        editorAttrs.color = {
          categorizeColumns: true
        };
      } else {
        editorAttrs.color = {
          hidePanes: ['fixed']
        };
      }
    }

    return {
      type: 'Fill',
      title: _t('editor.style.components.fill'),
      options: options,
      query: params.querySchemaModel.get('query'),
      configModel: params.configModel,
      userModel: params.userModel,
      validators: ['required'],
      editorAttrs: editorAttrs,
      modals: params.modals,
      dialogMode: 'float'
    };
  },

  'stroke': function (params) {
    if (params.queryGeometryModel.get('simple_geom') === 'line') {
      return generateLineStroke({
        querySchemaModel: params.querySchemaModel,
        styleType: params.styleType,
        configModel: params.configModel,
        userModel: params.userModel,
        modals: params.modals
      });
    } else {
      return generateSimpleStroke({
        querySchemaModel: params.querySchemaModel,
        configModel: params.configModel,
        userModel: params.userModel,
        modals: params.modals
      });
    }
  },

  'blending': function (params) {
    var animationOptions = ['lighter', 'multiply', 'source-over', 'xor'];
    var simpleOptions = ['none', 'multiply', 'screen', 'overlay', 'darken', 'lighten',
      'color-dodge', 'color-burn', 'xor', 'src-over'];
    var labelTranslate = 'editor.style.components.blending.options';

    var generateBlendingOptions = function (options) {
      return _.reduce(options, function (memo, option) {
        memo.push({
          val: option,
          label: _t(labelTranslate + '.' + option)
        });
        return memo;
      }, []);
    };

    return {
      type: 'Select',
      title: _t('editor.style.components.blending.label'),
      options: generateBlendingOptions(params.styleType === 'animation' ? animationOptions : simpleOptions),
      dialogMode: 'float'
    };
  },

  'style': function () {
    return {
      type: 'Radio',
      title: _t('editor.style.components.type.label'),
      options: [
        {
          val: 'simple',
          label: _t('editor.style.components.type.options.points')
        }, {
          val: 'heatmap',
          label: _t('editor.style.components.type.options.heatmap')
        }
      ]
    };
  },

  'aggregation-size': function () {
    return {
      type: 'Number',
      title: _t('editor.style.components.aggregation-size.label'),
      help: _t('editor.style.components.aggregation-size.help'),
      validators: ['required', {
        type: 'interval',
        min: 10,
        max: 100
      }]
    };
  },

  'aggregation-dataset': function () {
    return {
      type: 'Select',
      title: _t('editor.style.components.aggregation-dataset'),
      dialogMode: 'float',
      options: [
        {
          val: 'countries'
        }, {
          val: 'provinces'
        }
      ]
    };
  },

  'aggregation-value': function (params) {
    return {
      type: 'Operators',
      title: _t('editor.style.components.aggregation-value'),
      options: getSchemaColumns(params.querySchemaModel),
      dialogMode: 'float'
    };
  },

  'labels-enabled': function () {
    return {
      type: 'Hidden'
    };
  },

  'labels-attribute': function (params) {
    var filterFunction = function (item) {
      var columnName = item.get('name');
      var columnType = item.get('type');
      return (columnName !== 'the_geom' && columnName !== 'the_geom_webmercator' && columnType !== 'date');
    };
    return generateSelectByStyleType({
      componentName: 'labels-attribute',
      querySchemaModel: params.querySchemaModel,
      styleType: params.styleType,
      filterFunction: filterFunction
    });
  },

  'labels-fill': function () {
    return {
      type: 'Fill',
      title: _t('editor.style.components.labels-fill'),
      options: [],
      dialogMode: 'float',
      editorAttrs: {
        size: {
          min: 6,
          max: 24,
          hidePanes: ['value']
        },
        color: {
          hidePanes: ['value']
        }
      },
      validators: ['required']
    };
  },

  'labels-halo': function () {
    return {
      type: 'Fill',
      title: _t('editor.style.components.labels-halo'),
      options: [],
      dialogMode: 'float',
      editorAttrs: {
        size: {
          hidePanes: ['value']
        },
        color: {
          hidePanes: ['value']
        }
      },
      validators: ['required']
    };
  },

  'labels-font': function () {
    return {
      type: 'Select',
      dialogMode: 'float',
      options: FONTS_LIST
    };
  },

  'labels-offset': function () {
    return {
      type: 'Number',
      title: _t('editor.style.components.labels-offset'),
      validators: ['required', {
        type: 'interval',
        min: -15,
        max: 15
      }]
    };
  },

  'labels-overlap': function () {
    return {
      type: 'Radio',
      title: _t('editor.style.components.labels-overlap.label'),
      options: [
        {
          val: 'true',
          label: _t('editor.style.components.labels-overlap.options.true')
        }, {
          val: 'false',
          label: _t('editor.style.components.labels-overlap.options.false')
        }
      ]
    };
  },

  'labels-placement': function () {
    var placements = ['point', 'line', 'vertex', 'interior'];
    var translateLabel = 'editor.style.components.labels-placement.options';

    return {
      type: 'Select',
      title: _t('editor.style.components.labels-placement.label'),
      dialogMode: 'float',
      options: _.reduce(placements, function (memo, type) {
        memo.push({
          val: type,
          label: _t(translateLabel + '.' + type)
        });
        return memo;
      }, []),
      editorAttrs: {
        showSearch: false
      }
    };
  },

  'animated-enabled': function () {
    return {
      type: 'Hidden'
    };
  },

  'animated-attribute': function (params) {
    var filterFunction = function (item) {
      var columnType = item.get('type');
      if (columnType && (columnType === 'number' || columnType === 'date')) {
        return true;
      }
      return false;
    };

    if (params.styleType === 'heatmap') {
      return generateSelectWithSchemaColumns({
        componentName: 'animated-attribute',
        querySchemaModel: params.querySchemaModel,
        filterFunction: filterFunction
      });
    } else {
      return generateSelectByStyleType({
        componentName: 'animated-attribute',
        querySchemaModel: params.querySchemaModel,
        filterFunction: filterFunction,
        styleType: params.styleType
      });
    }
  },

  'animated-overlap': function () {
    return {
      type: 'Radio',
      title: _t('editor.style.components.animated-overlap.label'),
      options: [
        {
          val: 'false',
          label: _t('editor.style.components.animated-overlap.options.false')
        }, {
          val: 'true',
          label: _t('editor.style.components.animated-overlap.options.true')
        }
      ]
    };
  },

  'animated-duration': function () {
    return {
      type: 'Number',
      title: _t('editor.style.components.animated-duration'),
      validators: ['required', {
        type: 'interval',
        min: 0,
        max: 60
      }]
    };
  },

  'animated-steps': function () {
    return {
      type: 'Number',
      title: _t('editor.style.components.animated-steps'),
      validators: ['required', {
        type: 'interval',
        min: 1,
        max: 1024,
        step: 4
      }]
    };
  },

  'animated-trails': function () {
    return {
      type: 'Number',
      title: _t('editor.style.components.animated-trails'),
      validators: ['required', {
        type: 'interval',
        min: 0,
        max: 30
      }]
    };
  },

  'animated-resolution': function () {
    return {
      type: 'Number',
      title: _t('editor.style.components.animated-resolution'),
      validators: ['required', {
        type: 'interval',
        min: 1,
        max: 16
      }]
    };
  }
};

},{"underscore":"underscore"}],1033:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var StyleFormComponents = require('./style-form-components-dictionary');
var DEBOUNCE_TIME = 350;

module.exports = Backbone.Model.extend({

  _FORM_NAME: '',

  initialize: function (attrs, opts) {
    if (!opts.styleModel) throw new Error('Style model is required');
    if (!opts.modals) throw new Error('modals is required');
    this._styleModel = opts.styleModel;
    this._querySchemaModel = opts.querySchemaModel;
    this._queryGeometryModel = opts.queryGeometryModel;
    this._configModel = opts.configModel;
    this._userModel = opts.userModel;
    this._modals = opts.modals;
    this.schema = this._generateSchema();
    this._initBinds();
  },

  _initBinds: function () {
    this.bind('change', _.debounce(this._onChange.bind(this), DEBOUNCE_TIME), this);
  },

  _onChange: function () {
    throw new Error('_onChange should be defined');
  },

  _generateSchema: function () {
    var querySchemaModel = this._querySchemaModel;
    var queryGeometryModel = this._queryGeometryModel;
    var configModel = this._configModel;
    var userModel = this._userModel;
    var modals = this._modals;
    var styleType = this._styleModel.get('type');
    var isAutoStyleApplied = this._styleModel.has('autoStyle');
    var animationType = this._styleModel.get('style');
    var formName = this._FORM_NAME ? (this._FORM_NAME + '-') : '';

    return _.reduce(this.attributes, function (memo, value, key) {
      var d = StyleFormComponents[formName + key];
      if (d) {
        memo[key] = d({
          styleType: styleType,
          isAutoStyleApplied: isAutoStyleApplied,
          animationType: animationType,
          querySchemaModel: querySchemaModel,
          queryGeometryModel: queryGeometryModel,
          modals: modals,
          userModel: userModel,
          configModel: configModel
        });
      }
      return memo;
    }, {});
  }

});

},{"./style-form-components-dictionary":1032,"backbone":"backbone","underscore":"underscore"}],1034:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var StylePropertiesFormView = require('./style-properties-form/style-properties-form-view');
var StyleAggregationFormView = require('./style-aggregation-form/style-aggregation-form-view');
var noneFormMessage = require('./none-form-message.tpl');

module.exports = CoreView.extend({

  className: 'Editor-formView',

  initialize: function (opts) {
    if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
    if (!opts.querySchemaModel) throw new Error('querySchemaModel is required');
    if (!opts.queryGeometryModel) throw new Error('queryGeometryModel is required');
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.styleModel) throw new Error('styleModel is required');
    if (!opts.modals) throw new Error('modals is required');

    this._querySchemaModel = opts.querySchemaModel;
    this._queryGeometryModel = opts.queryGeometryModel;
    this._configModel = opts.configModel;
    this._userModel = opts.userModel;
    this._layerDefinitionsCollection = opts.layerDefinitionsCollection;
    this._layerDefinitionModel = opts.layerDefinitionModel;
    this._styleModel = opts.styleModel;
    this._modals = opts.modals;

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    if (this._styleModel.get('type') === 'none') {
      this._renderNoneMessage();
    } else {
      this._initFormViews();
    }
    return this;
  },

  _initBinds: function () {
    this._styleModel.bind('change:type', this.render, this);
    this.add_related_model(this._styleModel);
  },

  _renderNoneMessage: function () {
    this.$el.append(noneFormMessage());
  },

  _initFormViews: function () {
    if (this._styleModel.isAggregatedType()) {
      var aggregationFormView = new StyleAggregationFormView({
        styleModel: this._styleModel,
        queryGeometryModel: this._queryGeometryModel,
        querySchemaModel: this._querySchemaModel,
        configModel: this._configModel,
        userModel: this._userModel,
        modals: this._modals
      });

      this.addView(aggregationFormView);
      this.$el.append(aggregationFormView.render().el);
    }

    var propertiesFormView = new StylePropertiesFormView({
      styleModel: this._styleModel,
      layerDefinitionsCollection: this._layerDefinitionsCollection,
      configModel: this._configModel,
      userModel: this._userModel,
      layerDefinitionModel: this._layerDefinitionModel,
      queryGeometryModel: this._queryGeometryModel,
      querySchemaModel: this._querySchemaModel,
      modals: this._modals
    });

    this.addView(propertiesFormView);
    this.$el.append(propertiesFormView.render().el);
  }
});

},{"./none-form-message.tpl":1028,"./style-aggregation-form/style-aggregation-form-view":1029,"./style-properties-form/style-properties-form-view":1039,"backbone/core-view":1127}],1035:[function(require,module,exports){
var _ = require('underscore');
var StyleFormDefaultModel = require('../style-form-default-model');
var StyleFormComponents = require('../style-form-components-dictionary');

module.exports = StyleFormDefaultModel.extend({

  _FORM_NAME: 'animated',

  parse: function (r, opts) {
    var querySchema = opts.querySchemaModel;
    var columnAnimatable = querySchema.columnsCollection.findWhere(function (colModel) {
      return colModel.get('type') === 'number' || colModel.get('type') === 'date';
    });

    return _.extend(
      r,
      {
        attribute: r.attribute || (columnAnimatable && columnAnimatable.get('name')),
        overlap: r.overlap && r.overlap.toString()
      }
    );
  },

  _onChange: function () {
    var animatedData = _.extend(
      {},
      this.attributes,
      {
        overlap: this.get('overlap') === 'true'
      }
    );

    // Don't update style model if there is no attribute selected
    if (!animatedData.attribute) {
      return false;
    }

    this._styleModel.set('animated', animatedData);
  },

  _generateSchema: function () {
    var styleType = this._styleModel.get('type');

    if (styleType === 'heatmap') {
      return {
        resolution: StyleFormComponents['animated-resolution']()
      };
    } else {
      return StyleFormDefaultModel.prototype._generateSchema.call(this);
    }
  }
});

},{"../style-form-components-dictionary":1032,"../style-form-default-model":1033,"underscore":"underscore"}],1036:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
require('../../../../components/form-components/index');
var StyleAnimatedFormModel = require('./style-animated-properties-form-model');

module.exports = CoreView.extend({
  initialize: function (opts) {
    if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
    if (!opts.querySchemaModel) throw new Error('querySchemaModel is required');
    if (!opts.queryGeometryModel) throw new Error('queryGeometryModel is required');
    if (!opts.styleModel) throw new Error('styleModel is required');
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.modals) throw new Error('modals is required');

    this._userModel = opts.userModel;
    this._modals = opts.modals;

    this._querySchemaModel = opts.querySchemaModel;
    this._queryGeometryModel = opts.queryGeometryModel;
    this._layerDefinitionsCollection = opts.layerDefinitionsCollection;
    this._layerDefinitionModel = opts.layerDefinitionModel;
    this._styleModel = opts.styleModel;

    this._animatedFormModel = new StyleAnimatedFormModel(
      this._styleModel.get('animated'),
      {
        parse: true,
        querySchemaModel: this._querySchemaModel,
        queryGeometryModel: this._queryGeometryModel,
        styleModel: this._styleModel,
        userModel: this._userModel,
        modals: this._modals
      }
    );
  },

  render: function () {
    this.clearSubViews();
    this._genAnimatedFormView();
    return this;
  },

  _genAnimatedFormView: function () {
    this._animatedFormView = new Backbone.Form({
      model: this._animatedFormModel
    });

    this._animatedFormView.bind('change', function () {
      this.commit();
    });

    this.$el.append(this._animatedFormView.render().el);
  },

  _removeAnimatedFormView: function () {
    if (this._animatedFormView) {
      this._animatedFormView.remove();
      this._animatedFormView.$el.empty();
    }
  },

  clean: function () {
    this._removeAnimatedFormView();
    CoreView.prototype.clean.call(this);
  }
});

},{"../../../../components/form-components/index":211,"./style-animated-properties-form-model":1035,"backbone":"backbone","backbone/core-view":1127}],1037:[function(require,module,exports){
var _ = require('underscore');
var StyleFormDefaultModel = require('../style-form-default-model');

module.exports = StyleFormDefaultModel.extend({

  _FORM_NAME: 'labels',

  _onChange: function () {
    var labelsData = _.extend(
      {},
      this.attributes
    );

    // Don't update style model if there is no attribute selected
    if (labelsData.enabled && !labelsData.attribute) {
      return false;
    }

    this._styleModel.set('labels', labelsData);
  }
});

},{"../style-form-default-model":1033,"underscore":"underscore"}],1038:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
require('../../../../components/form-components/index');
var StyleLabelsFormModel = require('./style-labels-properties-form-model');

module.exports = CoreView.extend({

  className: 'u-tSpace-xl',

  initialize: function (opts) {
    if (!opts.queryGeometryModel) throw new Error('queryGeometryModel is required');
    if (!opts.querySchemaModel) throw new Error('querySchemaModel is required');
    if (!opts.styleModel) throw new Error('styleModel is required');
    if (!opts.modals) throw new Error('modals is required');
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.userModel) throw new Error('userModel is required');

    this._queryGeometryModel = opts.queryGeometryModel;
    this._querySchemaModel = opts.querySchemaModel;
    this._styleModel = opts.styleModel;
    this._configModel = opts.configModel;
    this._userModel = opts.userModel;
    this._modals = opts.modals;

    this._labelsFormModel = new StyleLabelsFormModel(
      this._styleModel.get('labels'),
      {
        parse: true,
        queryGeometryModel: this._queryGeometryModel,
        querySchemaModel: this._querySchemaModel,
        styleModel: this._styleModel,
        configModel: this._configModel,
        userModel: this._userModel,
        modals: this._modals
      }
    );

    this._enablerModel = new Backbone.Model({
      enabler: this._styleModel.get('labels').enabled
    });

    this._initBinds();
  },

  render: function () {
    this.$el.empty();
    this._initLabelsEnablerView();
    return this;
  },

  _initBinds: function () {
    this._styleModel.bind('change:type', function () {
      var isAnimatedEnabled = this._styleModel.get('type') === 'animation';
      if (isAnimatedEnabled) {
        this._enablerView.setValue(false);
      }
    }, this);
    this.add_related_model(this._styleModel);
  },

  _initLabelsEnablerView: function () {
    var helpMessage = _t('editor.style.components.labels-enabled.not-with-animated');
    var isAnimatedVisible = this._queryGeometryModel.get('simple_geom') === 'point';

    this._enablerView = new Backbone.Form.editors.Enabler({
      model: this._enablerModel,
      title: _t('editor.style.components.labels-enabled.label'),
      help: isAnimatedVisible ? helpMessage : '',
      key: 'enabler'
    });

    this._enablerModel.bind('change', this._setLabelsFormView, this);
    this.add_related_model(this._enablerModel);
    this.$el.append(this._enablerView.render().el);

    this._setLabelsFormView();
  },

  _setLabelsFormView: function () {
    var isEnabled = this._enablerModel.get('enabler');
    this._updateFormModel();
    if (isEnabled) {
      this._genLabelsFormView();
    } else {
      this._removeLabelsFormView();
    }
  },

  _updateFormModel: function () {
    this._labelsFormModel.set('enabled', this._enablerModel.get('enabler'));
  },

  _genLabelsFormView: function () {
    this._labelsFormView = new Backbone.Form({
      className: 'Editor-formInner--nested',
      model: this._labelsFormModel
    });

    this._labelsFormView.bind('change', function () {
      this.commit();
    });

    this.$el.append(this._labelsFormView.render().el);
  },

  _removeLabelsFormView: function () {
    if (this._labelsFormView) {
      this._labelsFormView.remove();
      this._labelsFormView.$el.empty();
    }
  },

  clean: function () {
    this._removeLabelsFormView();
    CoreView.prototype.clean.call(this);
  }
});

},{"../../../../components/form-components/index":211,"./style-labels-properties-form-model":1037,"backbone":"backbone","backbone/core-view":1127}],1039:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var StyleLabelsPropertiesFormView = require('./style-labels-properties-form-view');
var StyleAnimatedPropertiesFormView = require('./style-animated-properties-form-view');
var StyleShapePropertiesFormView = require('./style-shape-properties-form-view');
var StyleNotAnimatableView = require('./style-unanimatable-view');
var template = require('./style-properties-form.tpl');

var TYPES = {
  HEATMAP: 'heatmap',
  ANIMATION: 'animation'
};

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
    if (!opts.querySchemaModel) throw new Error('querySchemaModel is required');
    if (!opts.queryGeometryModel) throw new Error('queryGeometryModel is required');
    if (!opts.styleModel) throw new Error('styleModel is required');
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
    if (!opts.modals) throw new Error('modals is required');

    this._layerDefinitionsCollection = opts.layerDefinitionsCollection;
    this._layerDefinitionModel = opts.layerDefinitionModel;
    this._querySchemaModel = opts.querySchemaModel;
    this._queryGeometryModel = opts.queryGeometryModel;
    this._styleModel = opts.styleModel;
    this._configModel = opts.configModel;
    this._userModel = opts.userModel;
    this._modals = opts.modals;
  },

  render: function () {
    this.clearSubViews();
    var stepNumber = this._styleModel.isAggregatedType() ? 3 : 2;
    var simpleGeometry = this._queryGeometryModel.get('simple_geom');

    if (simpleGeometry !== 'point') {
      stepNumber--;
    }

    this.$el.html(
      template({
        stepNumber: stepNumber,
        simpleGeometry: simpleGeometry
      })
    );
    this._initViews();
    return this;
  },

  _initViews: function () {
    var styleType = this._styleModel.get('type');
    var animatedFormView;
    var shapeFormView;
    var labelsFormView;

    if (this._isUnanimatable()) {
      shapeFormView = new StyleNotAnimatableView({
        layerDefinitionModel: this._layerDefinitionModel,
        userModel: this._userModel,
        configModel: this._configModel,
        modals: this._modals
      });
      this.addView(shapeFormView);
      this.$('.js-propertiesForm').append(shapeFormView.render().el);
    } else {
      shapeFormView = new StyleShapePropertiesFormView({
        styleModel: this._styleModel,
        queryGeometryModel: this._queryGeometryModel,
        querySchemaModel: this._querySchemaModel,
        configModel: this._configModel,
        userModel: this._userModel,
        modals: this._modals
      });
      this.addView(shapeFormView);
      this.$('.js-propertiesForm').append(shapeFormView.render().el);

      if (styleType !== TYPES.HEATMAP && styleType !== TYPES.ANIMATION) {
        labelsFormView = new StyleLabelsPropertiesFormView({
          styleModel: this._styleModel,
          queryGeometryModel: this._queryGeometryModel,
          querySchemaModel: this._querySchemaModel,
          configModel: this._configModel,
          userModel: this._userModel,
          modals: this._modals
        });
        this.addView(labelsFormView);
        this.$('.js-propertiesForm').append(labelsFormView.render().el);
      }

      if (this._queryGeometryModel.get('simple_geom') === 'point' && (styleType === TYPES.ANIMATION || styleType === TYPES.HEATMAP)) {
        animatedFormView = new StyleAnimatedPropertiesFormView({
          layerDefinitionsCollection: this._layerDefinitionsCollection,
          layerDefinitionModel: this._layerDefinitionModel,
          styleModel: this._styleModel,
          queryGeometryModel: this._queryGeometryModel,
          querySchemaModel: this._querySchemaModel,
          userModel: this._userModel,
          configModel: this._configModel,
          modals: this._modals
        });

        this.addView(animatedFormView);
        this.$('.js-propertiesForm').append(animatedFormView.render().el);
      }
    }
  },

  _isUnanimatable: function () {
    return this._querySchemaModel.columnsCollection.filter(function (colModel) {
      return colModel.get('type') === 'number' || colModel.get('type') === 'date';
    }).length === 0 && this._styleModel.get('type') === 'animated';
  }
});

},{"./style-animated-properties-form-view":1036,"./style-labels-properties-form-view":1038,"./style-properties-form.tpl":1040,"./style-shape-properties-form-view":1042,"./style-unanimatable-view":1043,"backbone/core-view":1127}],1040:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfo js-styleProperties">\n  <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">'+
((__t=( stepNumber ))==null?'':_.escape(__t))+
'</div>\n  <div class="Editor-HeaderInfo-inner CDB-Text js-selector">\n    <div class="Editor-HeaderInfo-title u-bSpace--m">\n      <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">\n        '+
((__t=( _t('editor.style.style-form.properties.title-label-' + simpleGeometry) ))==null?'':_.escape(__t))+
'\n      </h2>\n    </div>\n    <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m js-highlight">'+
((__t=( _t('editor.style.style-form.properties.desc') ))==null?'':_.escape(__t))+
'</p>\n    <div class="js-propertiesForm"></div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],1041:[function(require,module,exports){
var _ = require('underscore');
var StylesFactory = require('../../styles-factory');
var StyleFormDefaultModel = require('../style-form-default-model');

var TYPES = {
  HEATMAP: 'heatmap',
  ANIMATION: 'animation'
};

module.exports = StyleFormDefaultModel.extend({

  parse: function (r) {
    var geom = r.geom;
    var attrs = {
      style: r.style,
      fill: r.fill,
      stroke: r.stroke,
      blending: r.blending
    };
    var isAggregatedType = _.contains(StylesFactory.getAggregationTypes(), r.type);

    if (isAggregatedType || geom === 'polygon') {
      if (attrs.fill.size) {
        attrs.fill = _.omit(attrs.fill, 'size');
      }
    }

    if (geom === 'line') {
      attrs = _.omit(attrs, 'fill');
    }

    if (r.type === TYPES.HEATMAP || (r.type === TYPES.ANIMATION && r.style === 'heatmap')) {
      attrs = _.omit(attrs, 'stroke', 'blending');
    }

    if (r.type !== TYPES.ANIMATION) {
      attrs = _.omit(attrs, 'style');
    }

    return attrs;
  },

  _onChange: function () {
    this._styleModel.set(_.clone(this.attributes));
  }

});

},{"../../styles-factory":1053,"../style-form-default-model":1033,"underscore":"underscore"}],1042:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
require('../../../../components/form-components/index');
var StyleShapeFormModel = require('./style-shape-properties-form-model');

module.exports = CoreView.extend({

  className: 'u-tSpace--m',

  initialize: function (opts) {
    if (!opts.queryGeometryModel) throw new Error('queryGeometryModel is required');
    if (!opts.querySchemaModel) throw new Error('querySchemaModel is required');
    if (!opts.styleModel) throw new Error('styleModel is required');
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.modals) throw new Error('modals is required');

    this._queryGeometryModel = opts.queryGeometryModel;
    this._querySchemaModel = opts.querySchemaModel;
    this._styleModel = opts.styleModel;
    this._configModel = opts.configModel;
    this._userModel = opts.userModel;
    this._modals = opts.modals;
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this._removeFormView();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this._styleModel.bind('change:style', function () {
      var style = this._styleModel.get('style');
      this._styleModel.setFill(style);
      this.render();
    }, this);
    this.add_related_model(this._styleModel);
  },

  _initViews: function () {
    this._shapeFormModel = new StyleShapeFormModel(
      {
        type: this._styleModel.get('type'),
        geom: this._queryGeometryModel.get('simple_geom'),
        style: this._styleModel.get('style'),
        fill: this._styleModel.get('fill'),
        stroke: this._styleModel.get('stroke'),
        blending: this._styleModel.get('blending')
      },
      {
        parse: true,
        queryGeometryModel: this._queryGeometryModel,
        querySchemaModel: this._querySchemaModel,
        configModel: this._configModel,
        userModel: this._userModel,
        modals: this._modals,
        styleModel: this._styleModel
      }
    );

    this._shapeFormView = new Backbone.Form({
      model: this._shapeFormModel
    });

    this._shapeFormView.bind('change', function () {
      this.commit();
    });

    this.$el.append(this._shapeFormView.render().el);
  },

  _removeFormView: function () {
    if (this._shapeFormView) {
      this._shapeFormView.remove();
    }
  },

  clean: function () {
    this._removeFormView();
    CoreView.prototype.clean.call(this);
  }
});

},{"../../../../components/form-components/index":211,"./style-shape-properties-form-model":1041,"backbone":"backbone","backbone/core-view":1127}],1043:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var template = require('./style-unanimatable.tpl');
var VisTableModel = require('../../../../data/visualization-table-model');
var linkTemplate = _.template('<a href="<%- url %>" target="_blank" title="<%- tableName %>"><%- label %></a>');

var REQUIRED_OPTS = [
  'layerDefinitionModel',
  'configModel'
];

module.exports = CoreView.extend({
  initialize: function (opts) {
    var tableName;

    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this._sourceNode = this._getSourceNode();

    if (this._sourceNode) {
      tableName = this._sourceNode.get('table_name');
      this._visTableModel = new VisTableModel({
        id: tableName,
        table: {
          name: tableName
        }
      }, {
        configModel: this._configModel
      });
    }
  },

  render: function () {
    var desc = this._getDescTemplate();

    this.clearSubViews();
    this.$el.html(template({
      title: _t('editor.style.style-form.unanimatable.desc'),
      desc: desc
    }));
    return this;
  },

  _getDescTemplate: function () {
    var tableName = '';
    var url = '';
    var tableModel;

    if (this._visTableModel) {
      tableModel = this._visTableModel.getTableModel();
      tableName = tableModel.getUnquotedName();
      url = this._visTableModel && this._visTableModel.datasetURL();
    }

    var linkHTML = linkTemplate({
      url: url,
      tableName: tableName,
      label: _t('editor.style.style-form.unanimatable.label')
    });

    return _t('editor.style.style-form.unanimatable.body', {
      link: linkHTML
    });
  },

  _getSourceNode: function () {
    var node = this._layerDefinitionModel.getAnalysisDefinitionNodeModel();
    var source;
    var primarySource;
    if (node.get('type') === 'source') {
      source = node;
    } else {
      primarySource = node.getPrimarySource();
      if (primarySource && primarySource.get('type') === 'source') {
        source = primarySource;
      }
    }

    return source;
  }
});

},{"../../../../data/visualization-table-model":677,"./style-unanimatable.tpl":1044,"backbone/core-view":1127,"underscore":"underscore"}],1044:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h2 class="CDB-Text CDB-Size-huge is-light u-secondaryTextColor">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h2>\n<p class="CDB-Text u-tSpace--m CDB-Size-medium u-altTextColor">'+
((__t=( desc ))==null?'':__t)+
'</p>\n';
}
return __p;
};

},{"underscore":"underscore"}],1045:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="56px" height="16px" viewBox="718 455 56 16">\n    <g id="animated" transform="translate(718.000000, 455.000000)" class="Style-fill">\n        <rect id="Rectangle-649" x="40" y="0" width="16" height="16" rx="8"></rect>\n        <rect id="Rectangle-649" opacity="0.8" x="30" y="0" width="16" height="16" rx="8"></rect>\n        <rect id="Rectangle-649" opacity="0.6" x="20" y="0" width="16" height="16" rx="8"></rect>\n        <rect id="Rectangle-649" opacity="0.4" x="10" y="0" width="16" height="16" rx="8"></rect>\n        <rect id="Rectangle-649" opacity="0.2" x="0" y="0" width="16" height="16" rx="8"></rect>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],1046:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="56px" height="25px" viewBox="0 0 56 25">\n    <g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n        <g id="Aggregation-/-Heatmap" transform="translate(-15.000000, -16.000000)">\n            <g id="Group-7">\n                <g transform="translate(15.000000, 16.000000)">\n                    <g id="Group-2" style="mix-blend-mode: luminosity;" transform="translate(28.000000, 12.500000) rotate(-90.000000) translate(-28.000000, -12.500000) translate(15.500000, -15.500000)" class="Style-fill">\n                        <g id="heat-copy-2" transform="translate(0.000000, 36.000000)">\n                            <circle id="Oval-120" opacity="0.4" cx="6" cy="6" r="6"></circle>\n                            <circle id="Oval-120-Copy" opacity="0.6" cx="6.5" cy="5.5" r="4.03333333"></circle>\n                            <path d="M6.5,8.06666667 C7.91753086,8.06666667 9.06666667,6.91753086 9.06666667,5.5 C9.06666667,4.08246914 7.91753086,2.93333333 6.5,2.93333333 C5.08246914,2.93333333 3.93333333,4.08246914 3.93333333,5.5 C3.93333333,6.91753086 5.08246914,8.06666667 6.5,8.06666667 Z" id="Oval-120-Copy-2" opacity="0.8"></path>\n                            <circle id="Oval-120-Copy-3" cx="6.5" cy="5.5" r="1.1"></circle>\n                        </g>\n                        <g id="heat-copy-2" transform="translate(13.000000, 48.000000)">\n                            <circle id="Oval-120" opacity="0.4" cx="4" cy="4" r="4"></circle>\n                            <circle id="Oval-120-Copy" opacity="0.6" cx="4" cy="4" r="2.93333333"></circle>\n                            <path d="M4,5.86666667 C5.03093153,5.86666667 5.86666667,5.03093153 5.86666667,4 C5.86666667,2.96906847 5.03093153,2.13333333 4,2.13333333 C2.96906847,2.13333333 2.13333333,2.96906847 2.13333333,4 C2.13333333,5.03093153 2.96906847,5.86666667 4,5.86666667 Z" id="Oval-120-Copy-2" opacity="0.8"></path>\n                            <circle id="Oval-120-Copy-3" cx="4" cy="4" r="0.8"></circle>\n                        </g>\n                        <g id="heat-copy-3" transform="translate(0.500000, 0.500000)">\n                            <circle id="Oval-120" opacity="0.4" cx="12" cy="12" r="12"></circle>\n                            <ellipse id="Oval-120-Copy" opacity="0.6" cx="12" cy="12" rx="8.8" ry="8.8"></ellipse>\n                            <path d="M12,17.6 C15.0927946,17.6 17.6,15.0927946 17.6,12 C17.6,8.9072054 15.0927946,6.4 12,6.4 C8.9072054,6.4 6.4,8.9072054 6.4,12 C6.4,15.0927946 8.9072054,17.6 12,17.6 Z" id="Oval-120-Copy-2" opacity="0.8"></path>\n                            <circle id="Oval-120-Copy-3" cx="12" cy="12" r="2.4"></circle>\n                        </g>\n                        <g id="heat" transform="translate(8.000000, 25.000000)">\n                            <path d="M0.0682602115,8.5161863 C0.564222232,12.1776805 3.7025171,15 7.5,15 C11.6421356,15 15,11.6421356 15,7.5 C15,3.35786438 11.6421356,0 7.5,0 C3.35786438,0 0,3.35786438 0,7.5 C0,7.84465272 0.0232475903,8.18387567 0.0682602115,8.5161863 Z" id="Oval-120" opacity="0.4"></path>\n                            <circle id="Oval-120-Copy" opacity="0.6" cx="7.5" cy="7.5" r="5.5"></circle>\n                            <path d="M7.5,11 C9.43299662,11 11,9.43299662 11,7.5 C11,5.56700338 9.43299662,4 7.5,4 C5.56700338,4 4,5.56700338 4,7.5 C4,9.43299662 5.56700338,11 7.5,11 Z" id="Oval-120-Copy-2" opacity="0.8"></path>\n                            <circle id="Oval-120-Copy-3" cx="7.5" cy="7.5" r="1.5"></circle>\n                        </g>\n                    </g>\n                    <g id="Group-8" style="mix-blend-mode: luminosity;" transform="translate(15.000000, 4.000000)">\n                        <path opacity="0.4" d="M6,0.5 C6,0.5 10,4 13,0 C12,2.5 11.5,4.5 11.5,4.5 L10.5,6.5 L7,3.5 L6,0.5 Z" id="Path-494" class="Style-fill"></path>\n                        <path opacity="0.4" d="M21.2158501,6.00893743 C21.2158501,6.00893743 25.2158501,9.50893743 28.2158501,5.50893743 C27.2158501,8.00893743 26.7158501,10.0089374 26.7158501,10.0089374 L25.7158501,12.0089374 L22.2158501,9.00893743 L21.2158501,6.00893743 Z" id="Path-494" class="Style-fill" transform="translate(24.715850, 8.758937) rotate(52.000000) translate(-24.715850, -8.758937) "></path>\n                        <path opacity="0.4" d="M16.9683476,9.30864826 C16.9683476,9.30864826 22.1000758,13.6622016 25.1000758,9.66220164 C24.1000758,12.1622016 23.8307892,14.1229281 23.8307892,14.1229281 L22.8307892,16.1229281 L17.6754544,11.4299685 L16.9683476,9.30864826 Z" id="Path-494" class="Style-fill" transform="translate(21.034212, 12.715788) rotate(-135.000000) translate(-21.034212, -12.715788) "></path>\n                        <path opacity="0.4" d="M6.01244045,6.22463473 C6.01244045,6.22463473 9.69418934,8.6717337 12.6941893,4.6717337 C11.6941893,7.1717337 11.1941893,9.1717337 11.1941893,9.1717337 L10.8665273,11.557349 L9.7765744,13.8621271 L6.01244045,6.22463473 Z" id="Path-494" class="Style-fill" transform="translate(9.353315, 9.266930) rotate(-194.000000) translate(-9.353315, -9.266930) "></path>\n                        <path opacity="0.6" d="M6,7.5 C5.85295664,5.882523 3.5,2.5 3.5,2.5 C3.5,2.5 6.5,5 9,5 C11.5,5 14.5,1 14.5,1 C14.5,1 12.5,4.25504557 12.5,6 C12.5,7.25504557 14.5,10 14.5,10 C14.5,10 12,8 9.5,8 C7,8 4.5,13.5 4.5,13.5 C4.5,13.5 6.18628997,9.54918967 6,7.5 Z" id="Path-497" class="Style-fill"></path>\n                        <path opacity="0.6" d="M19.7830175,9.69012543 C19.6894445,8.07264843 16.7664559,5.429802 16.7664559,5.429802 C16.7664559,5.429802 20.2086087,8.27970692 21.7995178,8.27970692 C23.3904269,8.27970692 26.4566805,5.77970692 26.4566805,5.77970692 C26.4566805,5.77970692 24.4742142,8.43779004 24.4742142,10.1827445 C24.4742142,11.43779 25.8285796,12.5099091 25.8285796,12.5099091 C25.8285796,12.5099091 23.7086087,11.2797069 22.1176996,11.2797069 C20.5267905,11.2797069 17.9729009,15.2555074 17.9729009,15.2555074 C17.9729009,15.2555074 19.9015657,11.7393151 19.7830175,9.69012543 Z" id="Path-497" class="Style-fill" transform="translate(21.611568, 10.342655) rotate(52.000000) translate(-21.611568, -10.342655) "></path>\n                        <path id="Path-499" stroke="#979797"></path>\n                        <polygon id="Path-500" class="Style-fill" points="0.5 12.5 5 7.5 1 4"></polygon>\n                    </g>\n                </g>\n            </g>\n        </g>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],1047:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="52px" height="23px" viewBox="0 0 52 23">\n    <g id="Symbols">\n        <g id="Aggregation-/-Hexabins" transform="translate(-15.000000, -17.000000)" class="Style-fill">\n            <g id="Hexabins">\n                <g transform="translate(15.000000, 17.000000)">\n                    <polygon id="Polygon-1-Copy-4" points="23 11 28 14 28 20 23 23 18 20 18 14"></polygon>\n                    <polygon id="Polygon-1-Copy-8" points="17 0 22 3 22 9 17 12 12 9 12 3"></polygon>\n                    <polygon id="Polygon-1-Copy-8" points="5 0 10 3 10 9 5 12 -1.15463195e-13 9 3.85466323e-09 3"></polygon>\n                    <polygon id="Polygon-1-Copy-13" points="29 0 34 3 34 9 29 12 24 9 24 3"></polygon>\n                    <polygon id="Polygon-1-Copy-15" points="41 0 46 3 46 9 41 12 36 9 36 3"></polygon>\n                    <polygon id="Polygon-1-Copy-14" points="35 11 40 14 40 20 35 23 30 20 30 14"></polygon>\n                    <polygon id="Polygon-1-Copy-14" points="47 11 52 14 52 20 47 23 42 20 42 14"></polygon>\n                </g>\n            </g>\n        </g>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],1048:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="56px" height="24px" viewBox="16 16 56 24">\n    <g id="points" transform="translate(16.000000, 16.000000)"  class="Style-fill">\n        <path d="M6,10 C8.209139,10 10,8.209139 10,6 C10,3.790861 8.209139,2 6,2 C3.790861,2 2,3.790861 2,6 C2,8.209139 3.790861,10 6,10 Z" id="Oval-59"></path>\n        <path d="M52,8 C54.209139,8 56,6.209139 56,4 C56,1.790861 54.209139,0 52,0 C49.790861,0 48,1.790861 48,4 C48,6.209139 49.790861,8 52,8 Z" id="Oval-59-Copy-2"></path>\n        <path d="M52,22 C54.209139,22 56,20.209139 56,18 C56,15.790861 54.209139,14 52,14 C49.790861,14 48,15.790861 48,18 C48,20.209139 49.790861,22 52,22 Z" id="Oval-59-Copy-3"></path>\n        <path d="M4,24 C6.209139,24 8,22.209139 8,20 C8,17.790861 6.209139,16 4,16 C1.790861,16 0,17.790861 0,20 C0,22.209139 1.790861,24 4,24 Z" id="Oval-59-Copy"></path>\n        <path d="M28,8 C30.209139,8 32,6.209139 32,4 C32,1.790861 30.209139,0 28,0 C25.790861,0 24,1.790861 24,4 C24,6.209139 25.790861,8 28,8 Z" id="Oval-59-Copy-4"></path>\n        <path d="M24,20 C26.209139,20 28,18.209139 28,16 C28,13.790861 26.209139,12 24,12 C21.790861,12 20,13.790861 20,16 C20,18.209139 21.790861,20 24,20 Z" id="Oval-59-Copy-4"></path>\n        <path d="M16,16 C18.209139,16 20,14.209139 20,12 C20,9.790861 18.209139,8 16,8 C13.790861,8 12,9.790861 12,12 C12,14.209139 13.790861,16 16,16 Z" id="Oval-59-Copy-4"></path>\n        <path d="M44,12 C46.209139,12 48,10.209139 48,8 C48,5.790861 46.209139,4 44,4 C41.790861,4 40,5.790861 40,8 C40,10.209139 41.790861,12 44,12 Z" id="Oval-59-Copy-4"></path>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],1049:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="56px" height="24px" viewBox="0 0 56 24">\n    <g id="Symbols">\n        <g id="Aggregation-/-Admin-Regions" transform="translate(-16.000000, -16.000000)" class="Style-fill">\n            <g id="regions">\n                <g transform="translate(16.000000, 16.000000)">\n                    <polygon id="Rectangle-649" points="9 8 1 0 27 0 27 17 36 17 36.0065918 23.9934082 25 24 9 16"></polygon>\n                    <polygon id="Rectangle-649" points="0 2 7 9 7 17 21 24 0 24 0 15"></polygon>\n                    <polygon id="Rectangle-649" points="29 0 50 0 50 6 56 6 56 24 48 24 38 24 38 15 29 15"></polygon>\n                    <rect id="Rectangle-1933" x="52" y="0" width="4" height="4"></rect>\n                </g>\n            </g>\n        </g>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],1050:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="58px" height="28px" viewBox="0 0 58 28">\n    <g id="Symbols">\n        <g id="Aggregation-/-Squares" transform="translate(-15.000000, -14.000000)" class="Style-fill">\n            <g id="squares">\n                <g transform="translate(15.000000, 14.000000)">\n                    <rect id="Rectangle-847-Copy-2" x="10" y="0" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-5" x="30" y="20" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-12" x="40" y="20" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-13" x="40" y="10" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-8" x="20" y="10" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-6" x="30" y="10" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-9" x="20" y="20" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-10" x="10" y="10" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-10" x="0" y="10" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-10" x="50" y="20" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-11" x="20" y="0" width="8" height="8" rx="1"></rect>\n                </g>\n            </g>\n        </g>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],1051:[function(require,module,exports){
var StyleGenerator = require('./style-converter');
var _ = require('underscore');

/**
 * this class manages the changes in layerdef styles and generate the proper cartocss and sql
 */
function StyleManager (layerDefinitionsCollection, map, configModel) {
  this.layerDefinitionsCollection = layerDefinitionsCollection;
  this.map = map;
  this._configModel = configModel;
  this._initBinds();
}

StyleManager.prototype = {
  _initBinds: function () {
    var self = this;

    function _generate (layerDef) {
      return function () {
        self.generate(layerDef);
      };
    }

    function _bind (layerDef) {
      if (layerDef && layerDef.styleModel) {
        layerDef.styleModel.bind('change', _generate(layerDef), this);
        layerDef.bind('change:autoStyle', _generate(layerDef), this);
      }
    }

    function _unbind (layerDef) {
      if (layerDef.styleModel) {
        layerDef.styleModel.unbind('change', _generate(layerDef), this);
        layerDef.unbind('change:autoStyle', _generate(layerDef), this);
      }
    }

    function _bindAll () {
      this.layerDefinitionsCollection.each(_bind, this);
    }

    this.layerDefinitionsCollection.bind('reset', _bindAll, this);
    this.layerDefinitionsCollection.bind('add', _bind, this);
    this.layerDefinitionsCollection.bind('remove', _unbind, this);

    _bindAll.call(this);
  },

  generate: function (layerDef) {
    var isAutoStyleApplied = layerDef.get('autoStyle');
    var stylesChanged = layerDef.styleModel.changed;

    if (isAutoStyleApplied) {
      return;
    }

    if (stylesChanged.type && _.size(stylesChanged) === 1) {
      return;
    }

    var simpleGeometryType = layerDef.getAnalysisDefinitionNodeModel().queryGeometryModel.get('simple_geom') || 'point';
    var generated = StyleGenerator.generateStyle(
      layerDef.styleModel.toJSON(),
      simpleGeometryType,
      {
        zoom: this.map.get('zoom')
      },
      this._configModel
    );

    var properties = {
      cartocss: generated.cartoCSS,
      sql_wrap: generated.sql,
      type: generated.layerType
    };

    if (layerDef.get('previousCartoCSSCustom')) {
      properties = _.extend(properties, {
        cartocss: layerDef.get('previousCartoCSS'),
        cartocss_custom: layerDef.get('previousCartoCSSCustom'),
        previousCartoCSSCustom: false
      });
    }

    layerDef.set(properties);
  }
};

module.exports = StyleManager;

},{"./style-converter":1017,"underscore":"underscore"}],1052:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var PanelWithOptionsView = require('../../components/view-options/panel-with-options-view');
var StyleContentView = require('./style-content-view');
var StyleCartoCSSView = require('./style-cartocss-view');
var ScrollView = require('../../components/scroll/scroll-view');
var TabPaneView = require('../../components/tab-pane/tab-pane-view');
var TabPaneCollection = require('../../components/tab-pane/tab-pane-collection');
var Toggler = require('../../components/toggler/toggler-view');
var UndoButtons = require('../../components/undo-redo/undo-redo-view');
var ParserCSS = require('../../helpers/parser-css');
var Infobox = require('../../components/infobox/infobox-factory');
var InfoboxModel = require('../../components/infobox/infobox-model');
var InfoboxCollection = require('../../components/infobox/infobox-collection');
var Notifier = require('../../components/notifier/notifier');
var CartoCSSNotifications = require('../../cartocss-notifications');
var MetricsTracker = require('../../components/metrics/metrics-tracker');
var OnboardingLauncher = require('../../components/onboardings/generic/generic-onboarding-launcher');
var OnboardingView = require('../../components/onboardings/layers/style-onboarding/style-onboarding-view');
var layerOnboardingKey = require('../../components/onboardings/layers/layer-onboarding-key');
var checkAndBuildOpts = require('../../helpers/required-opts');

var REQUIRED_OPTS = [
  'layerDefinitionsCollection',
  'layerDefinitionModel',
  'userActions',
  'queryGeometryModel',
  'querySchemaModel',
  'queryRowsCollection',
  'modals',
  'editorModel',
  'configModel',
  'userModel',
  'onboardings',
  'onboardingNotification'
];

module.exports = CoreView.extend({

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this._styleModel = this._layerDefinitionModel.styleModel;
    this._cartocssModel = this._layerDefinitionModel.cartocssModel;
    this._codemirrorModel = new Backbone.Model({
      content: this._layerDefinitionModel.get('cartocss')
    });

    // Set edition attribute in case custom cartocss is applied
    this._editorModel.set({
      edition: !!this._layerDefinitionModel.get('cartocss_custom'),
      disabled: false
    });

    this._infoboxModel = new InfoboxModel({
      state: this._isLayerHidden() ? 'layer-hidden' : ''
    });

    this._overlayModel = new Backbone.Model({
      visible: this._isLayerHidden()
    });

    this._appendMapsAPIError();

    CartoCSSNotifications.track(this);

    this._onboardingLauncher = new OnboardingLauncher({
      view: OnboardingView,
      onboardingNotification: this._onboardingNotification,
      notificationKey: layerOnboardingKey,
      onboardings: this._onboardings
    }, {
      editorModel: this._editorModel,
      selector: 'LayerOnboarding'
    });

    this._configPanes();
    this._initBinds();
  },

  render: function () {
    this._launchOnboarding();
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _launchOnboarding: function () {
    if (this._onboardingNotification.getKey(layerOnboardingKey)) {
      return;
    }

    var launchOnboarding = function () {
      if (!this._editorModel.isEditing() && !this._layerDefinitionModel.canBeGeoreferenced() && this._queryGeometryModel.hasValue()) {
        this._onboardingLauncher.launch({
          geom: this._queryGeometryModel.get('simple_geom'),
          type: this._styleModel.get('type')
        });
      }
    }.bind(this);

    if (!this._queryRowsCollection.isFetched()) {
      // It will be fetched by style-content view
      this._queryRowsCollection.statusModel.bind('change:status', function () {
        if (this._queryRowsCollection.isFetched()) {
          launchOnboarding();
          this._queryRowsCollection.statusModel.unbind(null, null, this);
        }
      }, this);
    } else {
      launchOnboarding();
    }
  },

  _initBinds: function () {
    this.listenTo(this._layerDefinitionModel, 'change:error', this._appendMapsAPIError);
    this.listenTo(this._layerDefinitionModel, 'change:cartocss', function () {
      this._codemirrorModel.set('content', this._layerDefinitionModel.get('cartocss'));
    }, this);
    this.listenTo(this._layerDefinitionModel, 'change:visible', this._infoboxState);
    this.listenTo(this._layerDefinitionModel, 'change:autoStyle', this._infoboxState);
    this.listenTo(this._editorModel, 'change:edition', this._onChangeEdition);
    this.listenTo(this._querySchemaModel, 'change:query_errors', this._updateEditor);
    this.listenTo(this._styleModel, 'change', function () {
      this._codemirrorModel.set('content', this._layerDefinitionModel.get('cartocss'));
    }.bind(this));
    this.listenTo(this._cartocssModel, 'undo redo', function () {
      this._codemirrorModel.set('content', this._cartocssModel.get('content'));
    }.bind(this));
  },

  _appendMapsAPIError: function () {
    var error = this._layerDefinitionModel.get('error');
    if (error) {
      if (error.type === 'turbo-carto') {
        var newErrors = _.clone(this._codemirrorModel.get('errors')) || [];
        newErrors.push({ line: error.line, message: error.message });
        this._codemirrorModel.set('errors', newErrors);
      }
    }
  },

  _updateEditor: function (model) {
    var errors = this._querySchemaModel.get('query_errors');
    var hasErrors = errors && errors.length > 0;
    this._editorModel.set('disabled', hasErrors);
  },

  _saveCartoCSS: function () {
    var content = this._codemirrorModel.get('content');
    var parser = new ParserCSS(content);
    var errors = parser.errors();

    if (!content) {
      return false;
    }

    this._codemirrorModel.set('errors', parser.parseError(errors));

    if (errors.length === 0) {
      this._cartocssModel.set('content', content);

      // Disable auto-style before saving, in order to not reset styles
      this._layerDefinitionModel.set('autoStyle', false);

      this._layerDefinitionModel.save({
        cartocss_custom: true,
        cartocss: content
      });

      CartoCSSNotifications.showSuccessNotification();

      MetricsTracker.track('Applied Cartocss', {
        layer_id: this._layerDefinitionModel.get('id'),
        cartocss: this._layerDefinitionModel.get('cartocss')
      });
    } else {
      this._editorModel.get('edition') === false && CartoCSSNotifications.showErrorNotification(parser.parseError(errors));
    }
  },

  _cancelClearStyles: function () {
    this._infoboxModel.set({state: ''});
    this._overlayModel.set({visible: false});

    this._editorModel.set({
      edition: true
    });
  },

  _clearCustomStyles: function () {
    this._layerDefinitionModel.set('cartocss_custom', false);
    this._styleModel.applyLastState();
    this._infoboxModel.set({state: ''});
    this._overlayModel.set({visible: false});
    this.render();
  },

  _cancelTorqueAggregation: function () {
    this._styleModel.applyLastState();
    this._infoboxModel.set({state: ''});
    this._overlayModel.set({visible: false});
    this.render();
  },

  _applyTorqueAggregation: function () {
    if (this._layerDefinitionsCollection.isThereAnyTorqueLayer()) {
      var torqueLayer = this._layerDefinitionsCollection.findWhere({ type: 'torque' });
      torqueLayer.styleModel.setDefaultPropertiesByType('simple', 'point');
    }

    this._infoboxModel.set({state: 'unfreeze'});
  },

  _onChangeEdition: function () {
    this._infoboxState();

    var edition = this._editorModel.get('edition');
    var index = edition ? 1 : 0;
    this._collectionPane.at(index).set({ selected: true });
  },

  _freezeTorgeAggregation: function (styleType, currentGeometryType) {
    this._infoboxModel.set({state: 'torque-exists'});
    this._overlayModel.set({visible: true});

    // Apply the previously selected style
    this._infoboxModel.once('change:state', function (mdl, state) {
      if (state === 'unfreeze') {
        this._moveTorqueLayerToTop(function () {
          this._overlayModel.set({visible: false});
          this._styleModel.setDefaultPropertiesByType(styleType, currentGeometryType);
        }.bind(this));
        this._infoboxModel.set({state: ''});
      }
    }, this);
  },

  _moveTorqueLayerToTop: function (callback) {
    var notification = Notifier.addNotification({
      status: 'loading',
      info: _t('editor.layers.moveTorqueLayer.loading'),
      closable: true
    });

    this._layerDefinitionsCollection.once('layerMoved', function () {
      callback && callback();
      notification.set({
        status: 'success',
        info: _t('editor.layers.moveTorqueLayer.success'),
        delay: Notifier.DEFAULT_DELAY
      });
    }, this);

    this._userActions.moveLayer({
      from: this._layerDefinitionModel.get('order'),
      to: this._layerDefinitionsCollection.getTopDataLayerIndex()
    });
  },

  _configPanes: function () {
    var self = this;
    var tabPaneTabs = [{
      selected: !this._layerDefinitionModel.get('cartocss_custom'),
      createContentView: function () {
        return new ScrollView({
          createContentView: function () {
            return new StyleContentView({
              className: 'Editor-content',
              userActions: self._userActions,
              layerDefinitionsCollection: self._layerDefinitionsCollection,
              layerDefinitionModel: self._layerDefinitionModel,
              styleModel: self._styleModel,
              modals: self._modals,
              configModel: self._configModel,
              userModel: self._userModel,
              queryGeometryModel: self._queryGeometryModel,
              querySchemaModel: self._querySchemaModel,
              queryRowsCollection: self._queryRowsCollection,
              editorModel: self._editorModel,
              overlayModel: self._overlayModel,
              freezeTorgeAggregation: self._freezeTorgeAggregation.bind(self)
            });
          }
        });
      },
      createActionView: function () {
        return new UndoButtons({
          trackModel: self._styleModel,
          editorModel: self._editorModel,
          applyButton: false
        });
      }
    }, {
      selected: this._layerDefinitionModel.get('cartocss_custom'),
      createContentView: function () {
        return new StyleCartoCSSView({
          layerDefinitionModel: self._layerDefinitionModel,
          querySchemaModel: self._querySchemaModel,
          styleModel: self._styleModel,
          editorModel: self._editorModel,
          codemirrorModel: self._codemirrorModel,
          onApplyEvent: self._saveCartoCSS.bind(self)
        });
      },
      createActionView: function () {
        return new UndoButtons({
          trackModel: self._cartocssModel,
          editorModel: self._editorModel,
          applyButton: true,
          onApplyClick: self._saveCartoCSS.bind(self)
        });
      }
    }];

    this._collectionPane = new TabPaneCollection(tabPaneTabs);
  },

  _isLayerHidden: function () {
    return this._layerDefinitionModel.get('visible') === false;
  },

  _infoboxState: function () {
    var edition = this._editorModel.get('edition');
    var cartocss_custom = this._layerDefinitionModel.get('cartocss_custom');
    var isAutoStyleApplied = this._layerDefinitionModel.get('autoStyle');

    if (!edition && cartocss_custom && !isAutoStyleApplied) {
      this._infoboxModel.set({state: 'confirm'});
      this._overlayModel.set({visible: true});
    } else if (!edition && this._isLayerHidden()) {
      this._infoboxModel.set({state: 'layer-hidden'});
      this._overlayModel.set({visible: true});
    } else {
      this._infoboxModel.set({state: ''});
      this._overlayModel.set({visible: false});
    }
  },

  _showHiddenLayer: function () {
    var savingOptions = {
      shouldPreserveAutoStyle: true
    };
    this._layerDefinitionModel.toggleVisible();
    this._userActions.saveLayer(this._layerDefinitionModel, savingOptions);
  },

  _initViews: function () {
    var self = this;

    var infoboxSstates = [
      {
        state: 'confirm',
        createContentView: function () {
          return Infobox.createWithAction({
            type: 'alert',
            closable: false,
            title: _t('editor.style.messages.cartocss-applied.title'),
            body: _t('editor.style.messages.cartocss-applied.body'),
            mainAction: {
              label: _t('editor.style.messages.cartocss-applied.clear')
            },
            secondAction: {
              label: _t('editor.style.messages.cartocss-applied.continue')
            }
          });
        },
        mainAction: self._clearCustomStyles.bind(self),
        secondAction: self._cancelClearStyles.bind(self)
      }, {
        state: 'layer-hidden',
        createContentView: function () {
          return Infobox.createWithAction({
            type: 'alert',
            title: _t('editor.style.messages.layer-hidden.title'),
            body: _t('editor.style.messages.layer-hidden.body'),
            mainAction: {
              label: _t('editor.style.messages.layer-hidden.show')
            }
          });
        },
        mainAction: self._showHiddenLayer.bind(self)
      }, {
        state: 'torque-exists',
        createContentView: function () {
          return Infobox.createWithAction({
            type: 'alert',
            closable: false,
            title: _t('editor.style.messages.torque-exists.title'),
            body: _t('editor.style.messages.torque-exists.body'),
            mainAction: {
              label: _t('editor.style.messages.torque-exists.continue')
            }
          });
        },
        closeAction: self._cancelTorqueAggregation.bind(self),
        mainAction: self._applyTorqueAggregation.bind(self)
      }
    ];

    var infoboxCollection = new InfoboxCollection(infoboxSstates);

    var panelWithOptionsView = new PanelWithOptionsView({
      className: 'Editor-content',
      editorModel: self._editorModel,
      infoboxModel: self._infoboxModel,
      infoboxCollection: infoboxCollection,
      createContentView: function () {
        return new TabPaneView({
          collection: self._collectionPane
        });
      },
      createControlView: function () {
        return new Toggler({
          editorModel: self._editorModel,
          labels: [_t('editor.style.style-toggle.values'), _t('editor.style.style-toggle.cartocss')],
          isDisableable: true
        });
      },
      createActionView: function () {
        return new TabPaneView({
          collection: self._collectionPane,
          createContentKey: 'createActionView'
        });
      }
    });

    this.$el.append(panelWithOptionsView.render().el);
    this.addView(panelWithOptionsView);
  }
});

},{"../../cartocss-notifications":1,"../../components/infobox/infobox-collection":215,"../../components/infobox/infobox-factory":216,"../../components/infobox/infobox-model":219,"../../components/metrics/metrics-tracker":233,"../../components/notifier/notifier":475,"../../components/onboardings/generic/generic-onboarding-launcher":501,"../../components/onboardings/layers/layer-onboarding-key":507,"../../components/onboardings/layers/style-onboarding/style-onboarding-view":508,"../../components/scroll/scroll-view":530,"../../components/tab-pane/tab-pane-collection":538,"../../components/tab-pane/tab-pane-view":549,"../../components/toggler/toggler-view":590,"../../components/undo-redo/undo-redo-view":592,"../../components/view-options/panel-with-options-view":595,"../../helpers/parser-css":1095,"../../helpers/required-opts":1097,"./style-cartocss-view":1014,"./style-content-view":1016,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],1053:[function(require,module,exports){
var _ = require('underscore');
var StyleDefaults = require('./style-defaults/style-defaults');
var SimpleStyleDefaults = require('./style-defaults/simple-style-defaults');
var HeatmapDefaults = require('./style-defaults/heatmap-style-defaults');
var AnimationDefaults = require('./style-defaults/animation-style-defaults');
var SquareAggregationDefaults = require('./style-defaults/squares-aggregation-style-defaults');
var HexabinsAggregationDefaults = require('./style-defaults/hexabins-aggregation-style-defaults');
var RegionsAggregationDefaults = require('./style-defaults/regions-aggregation-style-defaults');

var STYLE_MAP = {
  'none': {
    labelTranslationKey: 'editor.style.types.none',
    checkIfValid: function (geometryType) {
      return !geometryType;
    },
    defaultStyles: StyleDefaults
  },
  'simple': {
    labelTranslationKey: 'editor.style.types.simple',
    iconTemplate: require('./style-icons/points.tpl'),
    checkIfValid: function (geometryType) {
      return !!geometryType;
    },
    defaultStyles: SimpleStyleDefaults
  },
  'squares': {
    labelTranslationKey: 'editor.style.types.squares',
    iconTemplate: require('./style-icons/squares.tpl'),
    checkIfValid: function (geometryType) {
      return geometryType === 'point';
    },
    defaultStyles: SquareAggregationDefaults
  },
  'hexabins': {
    labelTranslationKey: 'editor.style.types.hexabins',
    iconTemplate: require('./style-icons/hexabins.tpl'),
    checkIfValid: function (geometryType) {
      return geometryType === 'point';
    },
    defaultStyles: HexabinsAggregationDefaults
  },
  'regions': {
    labelTranslationKey: 'editor.style.types.regions',
    iconTemplate: require('./style-icons/regions.tpl'),
    checkIfValid: function (geometryType) {
      return geometryType === 'point';
    },
    defaultStyles: RegionsAggregationDefaults
  },
  'animation': {
    labelTranslationKey: 'editor.style.types.animation',
    iconTemplate: require('./style-icons/animated.tpl'),
    checkIfValid: function (geometryType) {
      return geometryType === 'point';
    },
    defaultStyles: AnimationDefaults
  },
  'heatmap': {
    labelTranslationKey: 'editor.style.types.heatmap',
    iconTemplate: require('./style-icons/heatmap.tpl'),
    checkIfValid: function (geometryType) {
      return geometryType === 'point';
    },
    defaultStyles: HeatmapDefaults
  }
};

module.exports = {
  getDefaultStyleAttrsByType: function (styleType, geometryType) {
    var StyleDefaultsKlass = STYLE_MAP[styleType].defaultStyles;
    return StyleDefaultsKlass.generateAttributes(geometryType);
  },

  getStyleTypes: function (currentType, geometryType) {
    return _.reduce(STYLE_MAP, function (memo, val, key) {
      if (currentType === key || (val.checkIfValid ? val.checkIfValid(geometryType) : true)) {
        memo.push({
          value: key,
          label: _t(val.labelTranslationKey),
          iconTemplate: val.iconTemplate
        });
      }
      return memo;
    }, []);
  },

  getFormTemplateByType: function (styleType) {
    return STYLE_MAP[styleType].formTemplate;
  },

  getAggregationTypes: function () {
    return ['squares', 'hexabins', 'regions'];
  }
};

},{"./style-defaults/animation-style-defaults":1018,"./style-defaults/heatmap-style-defaults":1019,"./style-defaults/hexabins-aggregation-style-defaults":1020,"./style-defaults/regions-aggregation-style-defaults":1021,"./style-defaults/simple-style-defaults":1022,"./style-defaults/squares-aggregation-style-defaults":1023,"./style-defaults/style-defaults":1024,"./style-icons/animated.tpl":1045,"./style-icons/heatmap.tpl":1046,"./style-icons/hexabins.tpl":1047,"./style-icons/points.tpl":1048,"./style-icons/regions.tpl":1049,"./style-icons/squares.tpl":1050,"underscore":"underscore"}],1054:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<nav class="CDB-NavMenu js-theme">\n  <ul class="CDB-NavSubmenu CDB-NavSubmenu--outside CDB-Size-small CDB-Text is-semibold js-menu"></ul>\n</nav>\n<div class="Editor-content js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],1055:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--grid u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="24px" height="25px" viewbox="521 436 24 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n            <path d="M524.5,440 L540.5,440 L540.5,460 L524.5,460 L524.5,440 Z M528.5,437 L536.5,437 L536.5,440 L528.5,440 L528.5,437 Z M522,440 L544,440 L522,440 Z M528.5,443.5 L528.5,455.5 L528.5,443.5 Z M532.5,443.5 L532.5,455.5 L532.5,443.5 Z M536.5,443.5 L536.5,455.5 L536.5,443.5 Z" id="Shape" stroke="#F19243" stroke-width="1" fill="none"/>\n      </svg>\n    </div>\n    <div>\n      <h2 class=" CDB-Text CDB-Size-huge is-light u-bSpace--xl">\n        '+
((__t=( _t('editor.widgets.delete.title', { name: name }) ))==null?'':_.escape(__t))+
'\n      </h2>\n      <p class="CDB-Text CDB-Size-large u-altTextColor">'+
((__t=( _t('editor.widgets.delete.desc') ))==null?'':_.escape(__t))+
'</p>\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('editor.widgets.delete.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('editor.widgets.delete.confirm') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],1056:[function(require,module,exports){
arguments[4][986][0].apply(exports,arguments)
},{"dup":986,"underscore":"underscore"}],1057:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="56px" height="32px" viewBox="498 425 56 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g id="Bolean" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(498.000000, 425.000000)">\n        <rect id="Rectangle-17" fill="#FFFFFF" x="0" y="0" width="56" height="32" rx="4"></rect>\n        <path d="M1,2.00174332 L1,2.00174332 L1,29.9982567 C1,30.5564876 1.4426521,31 1.99306965,31 L54.0069304,31 C54.5486548,31 55,30.5482532 55,29.9982567 L55,2.00174332 C55,1.44351239 54.5573479,1 54.0069304,1 L1.99306965,1 C1.45134516,1 1,1.4517468 1,2.00174332 L1,2.00174332 Z M0,2.00174332 C0,0.89621101 0.902308181,0 1.99306965,0 L54.0069304,0 C55.1076723,0 56,0.889261723 56,2.00174332 L56,29.9982567 C56,31.103789 55.0976918,32 54.0069304,32 L1.99306965,32 C0.892327676,32 0,31.1107383 0,29.9982567 L0,2.00174332 L0,2.00174332 Z" id="Rectangle-774" fill="#EEEEEE"></path>\n        <rect id="Rectangle-1876" fill="#EEEEEE" x="8" y="6" width="16" height="3"></rect>\n        <rect id="Rectangle-1876" fill="#EEEEEE" x="8" y="15" width="40" height="2" rx="1"></rect>\n        <rect id="Rectangle-1876-Copy" fill="#9DE0AD" x="8" y="15" width="31" height="2" rx="1"></rect>\n        <rect id="Rectangle-1876" fill="#EEEEEE" x="8" y="22" width="40" height="2" rx="1"></rect>\n        <rect id="Rectangle-1876-Copy" fill="#9DE0AD" x="8" y="22" width="11" height="2" rx="1"></rect>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],1058:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="56px" height="32px" viewBox="0 0 56 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g id="Graf" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n        <rect id="Rectangle-17" fill="#FFFFFF" x="0" y="0" width="56" height="32" rx="4"></rect>\n        <path d="M1,2.00174332 L1,2.00174332 L1,29.9982567 C1,30.5564876 1.4426521,31 1.99306965,31 L54.0069304,31 C54.5486548,31 55,30.5482532 55,29.9982567 L55,2.00174332 C55,1.44351239 54.5573479,1 54.0069304,1 L1.99306965,1 C1.45134516,1 1,1.4517468 1,2.00174332 L1,2.00174332 Z M0,2.00174332 C0,0.89621101 0.902308181,0 1.99306965,0 L54.0069304,0 C55.1076723,0 56,0.889261723 56,2.00174332 L56,29.9982567 C56,31.103789 55.0976918,32 54.0069304,32 L1.99306965,32 C0.892327676,32 0,31.1107383 0,29.9982567 L0,2.00174332 L0,2.00174332 Z" id="Rectangle-774" fill="#EEEEEE"></path>\n        <rect id="Rectangle-1876" fill="#EEEEEE" x="8" y="6" width="16" height="3"></rect>\n        <rect id="Rectangle-53" fill="#9DE0AD" x="8" y="19" width="40" height="7"></rect>\n        <rect id="Rectangle-1876" fill="#EEEEEE" x="8" y="14" width="16" height="2"></rect>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],1059:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="56px" height="32px" viewBox="498 425 56 32" version="1.1" mlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g id="Bars" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(498.000000, 425.000000)">\n        <rect id="Rectangle-17" fill="#FFFFFF" x="0" y="0" width="56" height="32" rx="4"></rect>\n        <path d="M1,2.00174332 L1,2.00174332 L1,29.9982567 C1,30.5564876 1.4426521,31 1.99306965,31 L54.0069304,31 C54.5486548,31 55,30.5482532 55,29.9982567 L55,2.00174332 C55,1.44351239 54.5573479,1 54.0069304,1 L1.99306965,1 C1.45134516,1 1,1.4517468 1,2.00174332 L1,2.00174332 Z M0,2.00174332 C0,0.89621101 0.902308181,0 1.99306965,0 L54.0069304,0 C55.1076723,0 56,0.889261723 56,2.00174332 L56,29.9982567 C56,31.103789 55.0976918,32 54.0069304,32 L1.99306965,32 C0.892327676,32 0,31.1107383 0,29.9982567 L0,2.00174332 L0,2.00174332 Z" id="Rectangle-774" fill="#EEEEEE"></path>\n        <rect id="Bar" fill="#9DE0AD" transform="translate(36.000000, 23.000000) scale(-1, 1) translate(-36.000000, -23.000000) " x="35" y="22" width="2" height="2"></rect>\n        <rect id="Bar-Copy-6" fill="#9DE0AD" transform="translate(39.000000, 22.000000) scale(-1, 1) translate(-39.000000, -22.000000) " x="38" y="20" width="2" height="4"></rect>\n        <rect id="Bar-Copy-7" fill="#9DE0AD" transform="translate(42.000000, 21.500000) scale(-1, 1) translate(-42.000000, -21.500000) " x="41" y="19" width="2" height="5"></rect>\n        <rect id="Bar-Copy-8" fill="#9DE0AD" transform="translate(45.000000, 20.000000) scale(-1, 1) translate(-45.000000, -20.000000) " x="44" y="16" width="2" height="8"></rect>\n        <rect id="Bar-Copy-9" fill="#9DE0AD" transform="translate(48.000000, 21.500000) scale(-1, 1) translate(-48.000000, -21.500000) " x="47" y="19" width="2" height="5"></rect>\n        <rect id="Bar-Copy-2" fill="#9DE0AD" transform="translate(33.000000, 21.000000) scale(-1, 1) translate(-33.000000, -21.000000) " x="32" y="18" width="2" height="6"></rect>\n        <rect id="Bar-Copy-3" fill="#9DE0AD" transform="translate(30.000000, 22.500000) scale(-1, 1) translate(-30.000000, -22.500000) " x="29" y="21" width="2" height="3"></rect>\n        <rect id="Bar-Copy-4" fill="#9DE0AD" transform="translate(27.000000, 22.000000) scale(-1, 1) translate(-27.000000, -22.000000) " x="26" y="20" width="2" height="4"></rect>\n        <polygon id="Bar-Copy-5" fill="#9DE0AD" transform="translate(24.000000, 20.500000) scale(-1, 1) translate(-24.000000, -20.500000) " points="23 17 25 17 25 24 23 24"></polygon>\n        <rect id="Bar" fill="#9DE0AD" x="8" y="21" width="2" height="3"></rect>\n        <rect id="Bar-Copy-2" fill="#9DE0AD" x="11" y="15" width="2" height="9"></rect>\n        <rect id="Bar-Copy-3" fill="#9DE0AD" x="14" y="16" width="2" height="8"></rect>\n        <rect id="Bar-Copy-4" fill="#9DE0AD" x="17" y="19" width="2" height="5"></rect>\n        <polygon id="Bar-Copy-5" fill="#9DE0AD" points="20 16 22 16 22 24 20 24"></polygon>\n        <rect id="Rectangle-1876" fill="#EEEEEE" x="7" y="7" width="16" height="3"></rect>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],1060:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="20px" height="18px" viewBox="10 11 20 18" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g id="Group" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(10.000000, 11.000000)">\n        <rect id="Bar" fill="#A4DAB1" x="0" y="2" width="13" height="2"></rect>\n        <rect id="Bar" fill="#A4DAB1" x="0" y="9" width="10" height="2"></rect>\n        <rect id="Bar" fill="#A4DAB1" x="0" y="16" width="12" height="2"></rect>\n        <rect id="Bar" fill="#DDDDDD" x="0" y="7" width="7" height="1"></rect>\n        <rect id="Bar" fill="#DDDDDD" x="0" y="14" width="5" height="1"></rect>\n        <rect id="Bar" fill="#EEEEEE" x="13" y="2" width="7" height="2"></rect>\n        <rect id="Bar" fill="#EEEEEE" x="10" y="9" width="10" height="2"></rect>\n        <rect id="Bar" fill="#EEEEEE" x="12" y="16" width="8" height="2"></rect>\n        <rect id="Bar" fill="#DDDDDD" x="0" y="0" width="5" height="1"></rect>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],1061:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="20px" height="8px" viewBox="0 0 20 8" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g id="Group" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n        <rect id="Bar-Copy-2" fill="#9DE0AD" x="0" y="4" width="20" height="4"></rect>\n        <rect id="Bar-Copy-3" fill="#DDDDDD" x="0" y="0" width="9" height="2"></rect>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],1062:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="20px" height="18px" viewBox="10 11 20 18" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g id="Bars" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(10.000000, 11.000000)">\n        <rect id="Bar" fill="#A4DAB1" x="0" y="10" width="2" height="8"></rect>\n        <rect id="Bar" fill="#A4DAB1" x="3" y="6" width="2" height="12"></rect>\n        <rect id="Bar" fill="#A4DAB1" x="6" y="2" width="2" height="16"></rect>\n        <rect id="Bar" fill="#A4DAB1" x="9" y="0" width="2" height="18"></rect>\n        <rect id="Bar" fill="#A4DAB1" x="12" y="2" width="2" height="16"></rect>\n        <rect id="Bar" fill="#A4DAB1" x="15" y="5" width="2" height="13"></rect>\n        <rect id="Bar" fill="#A4DAB1" x="18" y="8" width="2" height="10"></rect>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],1063:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="21px" height="18px" viewBox="10 11 21 18" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g id="Group-2" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(10.000000, 11.000000)">\n        <g id="Bars" transform="translate(0.000000, 8.000000)">\n            <rect id="Bar" fill="#F2CC8F" x="4" y="0" width="1" height="10"></rect>\n            <rect id="Bar" fill="#F2CC8F" x="6" y="1" width="1" height="9"></rect>\n            <rect id="Bar-Copy" fill="#F2CC8F" x="0" y="5" width="1" height="5"></rect>\n            <rect id="Bar" fill="#F2CC8F" x="8" y="2" width="1" height="8"></rect>\n            <rect id="Bar" fill="#F2CC8F" x="10" y="3" width="1" height="7"></rect>\n            <rect id="Bar" fill="#EEEEEE" x="12" y="4" width="1" height="6"></rect>\n            <rect id="Bar" fill="#EEEEEE" x="14" y="5" width="1" height="5"></rect>\n            <rect id="Bar" fill="#EEEEEE" x="16" y="6" width="1" height="4"></rect>\n            <rect id="Bar-Copy" fill="#F2CC8F" x="2" y="3" width="1" height="7"></rect>\n            <rect id="Bar" fill="#EEEEEE" x="18" y="7" width="1" height="3"></rect>\n            <rect id="Bar" fill="#EEEEEE" x="20" y="7" width="1" height="3"></rect>\n        </g>\n        <polygon id="Rectangle-316" fill="#979EA1" points="0 5 0 0 4 2.5"></polygon>\n        <rect id="Rectangle-1876" fill="#DDDDDD" x="8" y="1" width="12" height="3"></rect>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],1064:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="56px" height="32px" viewBox="539 370 56 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g id="Time-Series" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(539.000000, 370.000000)">\n        <rect id="Rectangle-17" fill="#FFFFFF" x="0" y="0" width="56" height="32" rx="4"></rect>\n        <path d="M1,2.00174332 L1,2.00174332 L1,29.9982567 C1,30.5564876 1.4426521,31 1.99306965,31 L54.0069304,31 C54.5486548,31 55,30.5482532 55,29.9982567 L55,2.00174332 C55,1.44351239 54.5573479,1 54.0069304,1 L1.99306965,1 C1.45134516,1 1,1.4517468 1,2.00174332 L1,2.00174332 Z M0,2.00174332 C0,0.89621101 0.902308181,0 1.99306965,0 L54.0069304,0 C55.1076723,0 56,0.889261723 56,2.00174332 L56,29.9982567 C56,31.103789 55.0976918,32 54.0069304,32 L1.99306965,32 C0.892327676,32 0,31.1107383 0,29.9982567 L0,2.00174332 L0,2.00174332 Z" id="Rectangle-774" fill="#EEEEEE"></path>\n        <rect id="Bar" fill="#DDDDDD" opacity="0.5" transform="translate(34.000000, 23.500000) scale(-1, 1) translate(-34.000000, -23.500000) " x="33" y="22" width="2" height="3"></rect>\n        <rect id="Bar-Copy-6" fill="#DDDDDD" opacity="0.5" transform="translate(37.000000, 24.000000) scale(-1, 1) translate(-37.000000, -24.000000) " x="36" y="23" width="2" height="2"></rect>\n        <rect id="Bar-Copy-7" fill="#DDDDDD" opacity="0.5" transform="translate(40.000000, 24.000000) scale(-1, 1) translate(-40.000000, -24.000000) " x="39" y="23" width="2" height="2"></rect>\n        <rect id="Bar-Copy-8" fill="#DDDDDD" opacity="0.5" transform="translate(43.000000, 24.500000) scale(-1, 1) translate(-43.000000, -24.500000) " x="42" y="24" width="2" height="1"></rect>\n        <rect id="Bar-Copy-9" fill="#DDDDDD" opacity="0.5" transform="translate(46.000000, 24.500000) scale(-1, 1) translate(-46.000000, -24.500000) " x="45" y="24" width="2" height="1"></rect>\n        <rect id="Bar-Copy-2" fill="#DDDDDD" opacity="0.5" transform="translate(31.000000, 23.500000) scale(-1, 1) translate(-31.000000, -23.500000) " x="30" y="22" width="2" height="3"></rect>\n        <rect id="Bar-Copy-3" fill="#DDDDDD" opacity="0.5" transform="translate(28.000000, 23.000000) scale(-1, 1) translate(-28.000000, -23.000000) " x="27" y="21" width="2" height="4"></rect>\n        <rect id="Bar-Copy-4" fill="#F2CC8F" transform="translate(25.000000, 23.000000) scale(-1, 1) translate(-25.000000, -23.000000) " x="24" y="21" width="2" height="4"></rect>\n        <polygon id="Bar-Copy-5" fill="#F2CC8F" transform="translate(22.000000, 22.500000) scale(-1, 1) translate(-22.000000, -22.500000) " points="21 20 23 20 23 25 21 25"></polygon>\n        <rect id="Bar-Copy-2" fill="#F2CC8F" x="9" y="24" width="2" height="1"></rect>\n        <rect id="Bar-Copy-3" fill="#F2CC8F" x="12" y="21" width="2" height="4"></rect>\n        <rect id="Bar-Copy-4" fill="#F2CC8F" x="15" y="18" width="2" height="7"></rect>\n        <polygon id="Bar-Copy-5" fill="#F2CC8F" points="18 19 20 19 20 25 18 25"></polygon>\n        <polygon id="Rectangle-316" fill="#979EA1" points="9 10 9 5 13 7.5"></polygon>\n        <rect id="Rectangle-1876" fill="#EEEEEE" x="16" y="6" width="16" height="3"></rect>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],1065:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./widget-view.tpl');
var ContextMenuFactory = require('../../components/context-menu-factory-view');
var InlineEditorView = require('../../components/inline-editor/inline-editor-view');
var templateInlineEditor = require('./inline-editor.tpl');
var WidgetsService = require('./widgets-service');

var widgetIconTemplateMap = {
  category: require('./widget-icon-layer-category.tpl'),
  histogram: require('./widget-icon-layer-histogram.tpl'),
  formula: require('./widget-icon-layer-formula.tpl'),
  'time-series': require('./widget-icon-layer-timeSeries.tpl')
};

/**
 * View for an individual widget definition model.
 */
module.exports = CoreView.extend({

  tagName: 'li',

  className: 'BlockList-item js-widgetItem',

  initialize: function (opts) {
    if (!opts.layer) throw new Error('layer is required');
    if (!opts.userActions) throw new Error('userActions is required');

    this.layer = opts.layer;
    this._userActions = opts.userActions;
    this.stackLayoutModel = opts.stackLayoutModel;

    this.listenTo(this.model, 'change', this.render);
    this.listenToOnce(this.model, 'destroy', this._onDestroy);
  },

  render: function () {
    var widgetType = this.model.get('type');
    var source = this.model.get('source');
    var sourceColor = this.layer.get('color');

    this.$el.html(template({
      widgetType: widgetType,
      layerName: this.layer.getName(),
      source: source,
      sourceColor: sourceColor
    }));
    this.$el.attr('data-model-cid', this.model.cid);

    this._initViews();

    return this;
  },

  _initViews: function () {
    var widgetType = this.model.get('type');

    this._inlineEditor = new InlineEditorView({
      template: templateInlineEditor,
      renderOptions: {
        title: this.model.get('title')
      },
      onClick: this._onEditWidget.bind(this),
      onEdit: this._renameWidget.bind(this)
    });

    this.$('.js-header').append(this._inlineEditor.render().el);
    this.addView(this._inlineEditor);

    var iconTemplate = widgetIconTemplateMap[widgetType];

    if (!iconTemplate) {
      console.log(widgetType + ' widget template not defined');
    } else {
      this.$('.js-widgetIcon').append(iconTemplate());
    }

    var menuItems = [{
      label: _t('editor.widgets.options.rename'),
      val: 'rename-widget',
      action: this._onRenameWidget.bind(this)
    }, {
      label: _t('editor.widgets.options.edit'),
      val: 'edit-widget',
      action: this._onEditWidget.bind(this)
    }, {
      label: _t('editor.widgets.options.remove'),
      val: 'delete-widget',
      destructive: true,
      action: this._confirmDeleteWidget.bind(this)
    }];

    this._contextMenuFactory = new ContextMenuFactory({
      menuItems: menuItems
    });

    this.$('.js-context-menu').append(this._contextMenuFactory.render().el);
    this.addView(this._contextMenuFactory);
  },

  _onRenameWidget: function () {
    this._inlineEditor.edit();
  },

  _renameWidget: function () {
    var newName = this._inlineEditor.getValue();

    if (newName !== '' && newName !== this.model.get('title')) {
      this.$('.js-title').text(newName).show();
      this._inlineEditor.hide();
      this.model.set({title: newName});
      this._userActions.saveWidget(this.model);
    }
  },

  _confirmDeleteWidget: function () {
    WidgetsService.removeWidget(this.model);
  },

  _onEditWidget: function () {
    WidgetsService.editWidget(this.model);
  },

  _onDestroy: function () {
    this.clean();
  }
});

},{"../../components/context-menu-factory-view":37,"../../components/inline-editor/inline-editor-view":223,"./inline-editor.tpl":1056,"./widget-icon-layer-category.tpl":1060,"./widget-icon-layer-formula.tpl":1061,"./widget-icon-layer-histogram.tpl":1062,"./widget-icon-layer-timeSeries.tpl":1063,"./widget-view.tpl":1066,"./widgets-service":1085,"backbone/core-view":1127}],1066:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="BlockList-media u-rSpace--m js-widgetIcon">\n</div>\n<div class="BlockList-inner u-ellipsis">\n  <div class="BlockList-title u-bSpace js-context-menu">\n    <div class="BlockList-titleText js-header"></div>\n  </div>\n  <div class="u-flex">\n    <span\n      class="SelectorLayer-letter CDB-Text CDB-Size-small u-whiteTextColor u-rSpace u-upperCase"\n      style="background-color: '+
((__t=( sourceColor ))==null?'':_.escape(__t))+
';">'+
((__t=( source ))==null?'':_.escape(__t))+
'</span>\n    <p class="CDB-Text CDB-Size-medium u-altTextColor u-ellipsis">'+
((__t=( layerName ))==null?'':_.escape(__t))+
'</p>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],1067:[function(require,module,exports){
arguments[4][886][0].apply(exports,arguments)
},{"dup":886,"underscore":"underscore"}],1068:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="FormPlaceholder-widget u-tSpace-m u-flex">\n  <div class="FormPlaceholder-widgetIcon u-rSpace--m"></div>\n  <div class="FormPlaceholder-widgetInner">\n    <span class="FormPlaceholder-title FormPlaceholder-size--long"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--long"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--med u-tSpace-xl"></span>\n  </div>\n</div>\n\n<div class="FormPlaceholder-widget u-tSpace-m u-flex">\n  <div class="FormPlaceholder-widgetIcon u-rSpace--m"></div>\n  <div class="FormPlaceholder-widgetInner">\n    <span class="FormPlaceholder-title FormPlaceholder-size--med"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--med"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--long u-tSpace-xl"></span>\n  </div>\n</div>\n\n<div class="FormPlaceholder-widget u-tSpace-m u-flex">\n  <div class="FormPlaceholder-widgetIcon u-rSpace--m"></div>\n  <div class="FormPlaceholder-widgetInner">\n    <span class="FormPlaceholder-title FormPlaceholder-size--med"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--med"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--short u-tSpace-xl"></span>\n  </div>\n</div>\n\n<div class="FormPlaceholder-widget u-tSpace-m u-flex">\n  <div class="FormPlaceholder-widgetIcon u-rSpace--m"></div>\n  <div class="FormPlaceholder-widgetInner">\n    <span class="FormPlaceholder-title FormPlaceholder-size--long"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--long"></span>\n    <span class="FormPlaceholder-title FormPlaceholder-size--short u-tSpace-xl"></span>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],1069:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h2 class="Inline-editor">\n  <div class="CDB-Text CDB-Size-huge is-light u-ellipsis js-title Inline-editor-text">'+
((__t=( title ))==null?'':_.escape(__t))+
'</div>\n  <input type="text" name="text" class="Inline-editor-input Inline-editor-input--small CDB-Text CDB-InputText js-input" value="'+
((__t=( title ))==null?'':_.escape(__t))+
'" readonly>\n</h2>';
}
return __p;
};

},{"underscore":"underscore"}],1070:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var WidgetDefinitionModel = require('../../../../data/widget-definition-model');

module.exports = Backbone.Model.extend({

  initialize: function (attrs, options) {
    var o = [
      {
        val: true,
        label: _t('editor.widgets.widgets-form.style.yes')
      }, {
        val: false,
        label: _t('editor.widgets.widgets-form.style.no')
      }
    ];
    this.schema = {
      sync_on_bbox_change: {
        type: 'Radio',
        title: _t('editor.widgets.widgets-form.style.sync_on_bbox_change'),
        options: o
      }
    };
  },

  _addAllStyleSchemaAttributes: function () {
    var customType = this.get('type') === 'category' ? 'categories' : 'ramp';
    var styleAttrs = {
      widget_style_definition: {
        type: 'Fill',
        title: _t('editor.widgets.widgets-form.style.fill'),
        options: [],
        configModel: this._configModel,
        modals: this._modals,
        userModel: this._userModel,
        dialogMode: 'float',
        editorAttrs: {
          color: {
            hidePanes: ['value'],
            disableOpacity: true
          }
        }
      }
    };

    if (this.get('auto_style_allowed')) {
      var editorAttrs = {
        color: {
          hidePanes: ['fixed']
        }
      };

      if (customType === 'categories') {
        editorAttrs.color.hideTabs = ['bins', 'quantification'];
      }

      styleAttrs = _.extend(styleAttrs, {
        auto_style_definition: {
          type: 'EnablerEditor',
          title: '',
          label: _t('editor.widgets.widgets-form.style.custom-' + customType),
          help: _t('editor.widgets.widgets-form.style.custom-help'),
          editor: {
            type: 'Fill',
            title: '',
            options: [this.get('column')],
            dialogMode: 'float',
            query: 'query',
            configModel: this._configModel,
            modals: this._modals,
            userModel: this._userModel,
            editorAttrs: editorAttrs
          }
        }
      });
    } else {
      styleAttrs = _.extend(styleAttrs, {
        auto_style_definition: {
          type: 'Text',
          title: _t('editor.widgets.widgets-form.style.custom-' + customType),
          help: _t('editor.widgets.widgets-form.style.custom-disabled'),
          disabled: true
        }
      });
    }

    this.schema = _.extend(this.schema, styleAttrs);
  },

  parse: function (r) {
    var attrs = _.defaults(
      {
        sync_on_bbox_change: r.sync_on_bbox_change ? 'true' : ''
      },
      r
    );
    return attrs;
  },

  changeWidgetDefinitionModel: function (widgetDefinitionModel) {
    var attrs = _.defaults(
      {
        sync_on_bbox_change: this.get('sync_on_bbox_change') === 'true'
      },
      this.attributes
    );

    if (attrs.auto_style_definition !== '' && _.isEmpty(attrs.auto_style_definition)) {
      attrs.auto_style_definition = WidgetDefinitionModel.getDefaultAutoStyle(widgetDefinitionModel.get('type'), widgetDefinitionModel.get('column'));
    }

    widgetDefinitionModel.set(attrs);
  }

});

},{"../../../../data/widget-definition-model":680,"backbone":"backbone","underscore":"underscore"}],1071:[function(require,module,exports){
var _ = require('underscore');
var WidgetsFormBaseSchema = require('./widgets-form-base-schema-model');
var checkAndBuildOpts = require('../../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'columnOptionsFactory',
  'modals',
  'configModel',
  'userModel'
];

module.exports = WidgetsFormBaseSchema.extend({

  defaults: {
    schema: {},
    aggregate: {
      attribute: '',
      operator: 'count'
    }
  },

  initialize: function (attrs, opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this.on('change:aggregate', this._updateAggregation, this);
    this.on('change:column', this.updateSchema, this);

    this._updateAggregation();

    WidgetsFormBaseSchema.prototype.initialize.apply(this, arguments);
  },

  getFields: function () {
    var fields = ['column', 'aggregate', 'prefix', 'suffix'];

    return {
      data: fields.join(','),
      style: ['sync_on_bbox_change', 'widget_style_definition', 'auto_style_definition']
    };
  },

  _updateAggregation: function () {
    var aggregate = this.get('aggregate');
    if (aggregate === undefined) {
      this.set({
        aggregation: 'count',
        aggregation_column: ''
      });
    } else {
      this.set({
        aggregation_column: aggregate.attribute,
        aggregation: aggregate.operator
      });
    }

    this.updateSchema();
  },

  updateSchema: function () {
    var columnOptions = this._columnOptionsFactory.create(this.get('column'));
    var helpMsg = this._columnOptionsFactory.unavailableColumnsHelpMessage();
    var aggregationOptions = _.filter(columnOptions, function (column) {
      return column.type === 'number';
    });

    this.schema = _.extend(this.schema, {
      column: {
        type: 'Select',
        title: _t('editor.widgets.widgets-form.data.aggregate-by'),
        options: columnOptions,
        help: helpMsg,
        dialogMode: 'float',
        editorAttrs: {
          disabled: this._columnOptionsFactory.areColumnsUnavailable()
        }
      },
      aggregate: {
        type: 'Operators',
        title: _t('editor.widgets.widgets-form.data.operation'),
        options: aggregationOptions,
        dialogMode: 'float',
        editorAttrs: {
          showSearch: false
        }
      },
      suffix: {
        type: 'EnablerEditor',
        title: '',
        label: _t('editor.widgets.widgets-form.data.suffix'),
        editor: {
          type: 'Text'
        }
      },
      prefix: {
        type: 'EnablerEditor',
        title: '',
        label: _t('editor.widgets.widgets-form.data.prefix'),
        editor: {
          type: 'Text'
        }
      }
    });

    this._addAllStyleSchemaAttributes();
  },

  canSave: function () {
    var aggregation = this.get('aggregation');
    var aggregationColumn = this.get('aggregation_column');
    var canSave = false;

    if (aggregation === 'count') {
      canSave = true;
    } else {
      canSave = !!(aggregation && aggregationColumn);
    }

    return canSave;
  }

});

},{"../../../../helpers/required-opts":1097,"./widgets-form-base-schema-model":1070,"underscore":"underscore"}],1072:[function(require,module,exports){
var _ = require('underscore');
var WidgetsFormBaseSchema = require('./widgets-form-base-schema-model');

module.exports = WidgetsFormBaseSchema.extend({

  defaults: {
    schema: {}
  },

  initialize: function (attrs, opts) {
    if (!opts.columnOptionsFactory) throw new Error('columnOptionsFactory is required');
    this._columnOptionsFactory = opts.columnOptionsFactory;

    WidgetsFormBaseSchema.prototype.initialize.apply(this, arguments);
  },

  getFields: function () {
    return {
      data: 'column,operation,prefix,suffix,description',
      style: 'sync_on_bbox_change'
    };
  },

  updateSchema: function () {
    var columnOptions = this._columnOptionsFactory.create(this.get('column'), this._isNumberType);

    this.schema = _.extend(this.schema, {
      column: {
        type: 'Select',
        title: _t('editor.widgets.widgets-form.data.column'),
        help: this._columnOptionsFactory.unavailableColumnsHelpMessage(),
        options: columnOptions,
        dialogMode: 'float',
        editorAttrs: {
          disabled: this._columnOptionsFactory.areColumnsUnavailable()
        }
      },
      operation: {
        type: 'Select',
        title: _t('editor.widgets.widgets-form.data.operation'),
        dialogMode: 'float',
        options: ['min', 'max', 'count', 'avg', 'sum']
      },
      suffix: {
        type: 'EnablerEditor',
        title: '',
        label: _t('editor.widgets.widgets-form.data.suffix'),
        editor: {
          type: 'Text'
        }
      },
      prefix: {
        type: 'EnablerEditor',
        title: '',
        label: _t('editor.widgets.widgets-form.data.prefix'),
        editor: {
          type: 'Text'
        }
      },
      description: {
        type: 'EnablerEditor',
        title: '',
        label: _t('editor.widgets.widgets-form.style.description'),
        editor: {
          type: 'TextArea'
        }
      }
    });
  },

  canSave: function () {
    return !!this.get('column');
  },

  _isNumberType: function (m) {
    return m.get('type') === 'number';
  }

});

},{"./widgets-form-base-schema-model":1070,"underscore":"underscore"}],1073:[function(require,module,exports){
var _ = require('underscore');
var WidgetsFormBaseSchema = require('./widgets-form-base-schema-model');
var checkAndBuildOpts = require('../../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'columnOptionsFactory',
  'modals',
  'configModel',
  'userModel'
];

module.exports = WidgetsFormBaseSchema.extend({

  initialize: function (attrs, opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    WidgetsFormBaseSchema.prototype.initialize.apply(this, arguments);
  },

  getFields: function () {
    return {
      data: ['column', 'bins'],
      style: ['sync_on_bbox_change', 'widget_style_definition', 'auto_style_definition']
    };
  },

  updateSchema: function () {
    var columnOptions = this._columnOptionsFactory.create(this.get('column'), this._isNumberType);
    var helpMsg = this._columnOptionsFactory.unavailableColumnsHelpMessage();

    this.schema = _.extend(this.schema, {
      column: {
        title: _t('editor.widgets.widgets-form.data.column'),
        type: 'Select',
        help: helpMsg,
        options: columnOptions,
        dialogMode: 'float',
        editorAttrs: {
          disabled: this._columnOptionsFactory.areColumnsUnavailable()
        }
      },
      bins: {
        title: _t('editor.widgets.widgets-form.data.bins'),
        type: 'Number',
        validators: ['required', {
          type: 'interval',
          min: 2,
          max: 30
        }]
      }
    });

    this._addAllStyleSchemaAttributes();
  },

  canSave: function () {
    return !!this.get('column');
  },

  _isNumberType: function (m) {
    return m.get('type') === 'number';
  }

});

},{"../../../../helpers/required-opts":1097,"./widgets-form-base-schema-model":1070,"underscore":"underscore"}],1074:[function(require,module,exports){
var _ = require('underscore');
var WidgetsFormBaseSchema = require('./widgets-form-base-schema-model');
var checkAndBuildOpts = require('../../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'columnOptionsFactory'
];

module.exports = WidgetsFormBaseSchema.extend({

  initialize: function (attrs, opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    WidgetsFormBaseSchema.prototype.initialize.apply(this, arguments);
  },

  getFields: function () {
    return {
      data: ['column', 'bins'],
      style: ['sync_on_bbox_change', 'widget_style_definition']
    };
  },

  updateSchema: function () {
    var columnOptions = this._columnOptionsFactory.create(this.get('column'), this._isDateType);
    var helpMsg = this._columnOptionsFactory.unavailableColumnsHelpMessage();

    this.schema = _.extend(this.schema, {
      column: {
        title: _t('editor.widgets.widgets-form.data.column'),
        type: 'Select',
        help: helpMsg,
        options: columnOptions,
        dialogMode: 'float',
        editorAttrs: {
          disabled: this._columnOptionsFactory.areColumnsUnavailable()
        }
      },
      bins: {
        title: _t('editor.widgets.widgets-form.data.bins'),
        type: 'Number',
        validators: ['required', {
          type: 'interval',
          min: 0,
          max: 256
        }]
      },
      widget_style_definition: {
        type: 'Fill',
        title: _t('editor.widgets.widgets-form.style.fill'),
        options: [],
        dialogMode: 'float',
        editorAttrs: {
          color: {
            hidePanes: ['value'],
            disableOpacity: true
          }
        }
      }
    });
  },

  canSave: function () {
    return this.get('column');
  },

  _isDateType: function (m) {
    return m.get('type') === 'date' || m.get('type') === 'number';
  }

});

},{"../../../../helpers/required-opts":1097,"./widgets-form-base-schema-model":1070,"underscore":"underscore"}],1075:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./widget-header.tpl');
var InlineEditorView = require('../../../components/inline-editor/inline-editor-view');
var templateInlineEditor = require('./inline-editor.tpl');
var ContextMenuFactory = require('../../../components/context-menu-factory-view');
var WidgetsService = require('../widgets-service');

module.exports = CoreView.extend({
  events: {
    'click .js-toggle-menu': '_onToggleContextMenuClicked'
  },

  initialize: function (opts) {
    if (!this.model) throw new Error('model is required');
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');
    if (!opts.userActions) throw new Error('userActions is required');
    if (!opts.stackLayoutModel) throw new Error('stackLayoutModel is required');

    this._layerDefinitionModel = opts.layerDefinitionModel;
    this._userActions = opts.userActions;
    this._stackLayoutModel = opts.stackLayoutModel;
  },

  render: function () {
    var widgetTitle = this.model.get('title');

    this.$el.html(
      template({
        title: widgetTitle,
        source: this.model.get('source'),
        sourceColor: this._layerDefinitionModel.get('color'),
        layerName: this._layerDefinitionModel.getName()
      })
    );

    this._initViews();
    return this;
  },

  _initViews: function () {
    var widgetTitle = this.model.get('title');

    this._inlineEditor = new InlineEditorView({
      template: templateInlineEditor,
      renderOptions: {
        title: widgetTitle
      },
      onEdit: this._renameWidget.bind(this)
    });

    this.$('.js-header').append(this._inlineEditor.render().el);
    this.addView(this._inlineEditor);

    var menuItems = [{
      label: _t('editor.widgets.options.rename'),
      val: 'rename-widget',
      action: this._onRenameWidget.bind(this)
    }, {
      label: _t('editor.widgets.options.remove'),
      val: 'delete-widget',
      destructive: true,
      action: this._confirmDeleteWidget.bind(this)
    }];

    this._contextMenuFactory = new ContextMenuFactory({
      menuItems: menuItems
    });

    this.$('.js-context-menu').append(this._contextMenuFactory.render().el);
    this.addView(this._contextMenuFactory);
  },

  _onRenameWidget: function () {
    this._inlineEditor.edit();
  },

  _renameWidget: function () {
    var newName = this._inlineEditor.getValue();

    if (newName !== '' && newName !== this.model.get('title')) {
      this.model.set({title: newName});
      this._userActions.saveWidget(this.model);
      this.$('.js-title').text(newName).show();
      this._inlineEditor.hide();
    }
  },

  _confirmDeleteWidget: function () {
    WidgetsService.removeWidget(this.model);
  },

  _onDeleteWidget: function (modal) {
    modal.destroy();
    this._stackLayoutModel.prevStep('widgets');
    this.model.destroy();
  }
});

},{"../../../components/context-menu-factory-view":37,"../../../components/inline-editor/inline-editor-view":223,"../widgets-service":1085,"./inline-editor.tpl":1069,"./widget-header.tpl":1076,"backbone/core-view":1127}],1076:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfoEditor">\n  <div class="u-rSpace--xl u-actionTextColor js-back Editor-HeaderInfoEditorShape">\n    <button>\n      <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n    </button>\n  </div>\n  <div class="Editor-HeaderInfo-inner">\n    <div class="Editor-HeaderInfo-title js-context-menu">\n      <div class="Editor-HeaderInfo-titleText js-header"></div>\n    </div>\n\n    <div class="u-flex">\n      <span class="SelectorLayer-letter CDB-Text CDB-Size-small u-whiteTextColor u-rSpace u-upperCase"\n        style="background-color: '+
((__t=( sourceColor ))==null?'':_.escape(__t))+
';">'+
((__t=( source ))==null?'':_.escape(__t))+
'</span>\n      <p class="CDB-Text CDB-Size-medium u-altTextColor u-ellipsis">'+
((__t=( layerName ))==null?'':_.escape(__t))+
'</p>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],1077:[function(require,module,exports){
/**
 * Object to generate column options for a current state of a query schema model
 */
var F = function (querySchemaModel) {
  this._querySchemaModel = querySchemaModel;
};

F.prototype.areColumnsUnavailable = function () {
  var status = this._querySchemaModel.get('status');
  return status === 'fetching' || status === 'unavailable';
};

F.prototype.unavailableColumnsHelpMessage = function () {
  if (this._querySchemaModel.get('status') === 'unavailable') {
    return _t('editor.widgets.widgets-form.data.columns-unavailable');
  }
};

F.prototype.create = function (currentVal, columnFilter) {
  columnFilter = columnFilter || function () {
    return true;
  };

  switch (this._querySchemaModel.get('status')) {
    case 'fetching':
      return [{val: _t('editor.widgets.widgets-form.data.loading')}];
    case 'unavailable':
      return [{val: currentVal}];
    default:
      return this._querySchemaModel
        .columnsCollection
        .filter(columnFilter)
        .map(function (m) {
          var columnName = m.get('name');
          return {
            val: columnName,
            label: columnName,
            type: m.get('type')
          };
        });
  }
};

module.exports = F;

},{}],1078:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var WidgetsFormView = require('./widgets-form-view');
var WidgetHeaderView = require('./widget-header.js');
var ScrollView = require('../../../components/scroll/scroll-view');
var checkAndBuildOpts = require('../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'userActions',
  'widgetDefinitionModel',
  'modals',
  'analysisDefinitionNodesCollection',
  'layerDefinitionsCollection',
  'stackLayoutModel',
  'configModel',
  'userModel'
];

/**
 * View to render all necessary for the widget form
 */

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_goBack'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this._widgetDefinitionModel.bind('destroy', this._goBack, this);
    this.add_related_model(this._widgetDefinitionModel);
  },

  _initViews: function () {
    var self = this;
    var nodeId = self._widgetDefinitionModel.get('source');
    var analysisDefinitionNodeModel = self._analysisDefinitionNodesCollection.get(nodeId);

    var header = new WidgetHeaderView({
      layerDefinitionModel: this._layerDefinitionsCollection.get(this._widgetDefinitionModel.get('layer_id')),
      model: this._widgetDefinitionModel,
      modals: this._modals,
      userActions: this._userActions,
      stackLayoutModel: this._stackLayoutModel
    });
    this.$el.append(header.render().$el);
    this.addView(header);

    var view = new ScrollView({
      createContentView: function () {
        return new WidgetsFormView({
          userActions: self._userActions,
          widgetDefinitionModel: self._widgetDefinitionModel,
          querySchemaModel: analysisDefinitionNodeModel.querySchemaModel,
          modals: self._modals,
          configModel: self._configModel,
          userModel: self._userModel
        });
      }
    });

    this.$el.append(view.render().$el);
    this.addView(view);
  },

  _goBack: function () {
    if (this._stackLayoutPrevStep) {
      this._stackLayoutPrevStep();
    } else {
      this._stackLayoutModel.prevStep('widgets');
    }
  }

});

},{"../../../components/scroll/scroll-view":530,"../../../helpers/required-opts":1097,"./widget-header.js":1075,"./widgets-form-view":1083,"backbone/core-view":1127}],1079:[function(require,module,exports){
var _ = require('underscore');
var WidgetsFormColumnOptionsFactory = require('./widgets-form-column-options-factory');

var dataMap = {
  category: {
    labelTranslationKey: 'editor.widgets.widgets-form.type.category',
    iconTemplate: require('../widget-icon-category.tpl'),
    Class: require('./schema/widgets-form-category-schema-model')
  },
  formula: {
    labelTranslationKey: 'editor.widgets.widgets-form.type.formula',
    iconTemplate: require('../widget-icon-formula.tpl'),
    Class: require('./schema/widgets-form-formula-schema-model'),
    checkIfValid: function (querySchemaModel) {
      return querySchemaModel.columnsCollection.any(function (m) {
        return m.get('type') === 'number';
      });
    }
  },
  histogram: {
    labelTranslationKey: 'editor.widgets.widgets-form.type.histogram',
    iconTemplate: require('../widget-icon-histogram.tpl'),
    Class: require('./schema/widgets-form-histogram-schema-model'),
    checkIfValid: function (querySchemaModel) {
      return querySchemaModel.columnsCollection.any(function (m) {
        return m.get('type') === 'number';
      });
    }
  },
  'time-series': {
    labelTranslationKey: 'editor.widgets.widgets-form.type.time_series',
    iconTemplate: require('../widget-icon-timeSeries.tpl'),
    Class: require('./schema/widgets-form-time-series-schema-model'),
    checkIfValid: function (querySchemaModel) {
      return querySchemaModel.columnsCollection.any(function (m) {
        return m.get('type') === 'date' || m.get('type') === 'number';
      });
    }
  }
};

module.exports = {

  createWidgetFormModel: function (options) {
    var widgetDefinitionModel = options.widgetDefinitionModel;
    var widgetType = widgetDefinitionModel.get('type');
    var Klass = dataMap[widgetType].Class;
    return new Klass(widgetDefinitionModel.attributes, {
      parse: true, // in case the raw attributes needs to be adapted to the expected form types, e.g. timestamp => Date
      widgetDefinitionModel: widgetDefinitionModel,
      columnOptionsFactory: new WidgetsFormColumnOptionsFactory(options.querySchemaModel),
      userModel: options.userModel,
      modals: options.modals,
      configModel: options.configModel
    });
  },

  getDataTypes: function (querySchemaModel) {
    return _.reduce(dataMap, function (memo, val, key) {
      if (val.checkIfValid ? val.checkIfValid(querySchemaModel) : true) {
        memo.push({
          iconTemplate: val.iconTemplate,
          value: key,
          label: _t(val.labelTranslationKey)
        });
      }
      return memo;
    }, []);
  }

};

},{"../widget-icon-category.tpl":1057,"../widget-icon-formula.tpl":1058,"../widget-icon-histogram.tpl":1059,"../widget-icon-timeSeries.tpl":1064,"./schema/widgets-form-category-schema-model":1071,"./schema/widgets-form-formula-schema-model":1072,"./schema/widgets-form-histogram-schema-model":1073,"./schema/widgets-form-time-series-schema-model":1074,"./widgets-form-column-options-factory":1077,"underscore":"underscore"}],1080:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var WidgetFormFactory = require('./widgets-form-factory');
var template = require('./widgets-form-fields.tpl');
require('../../../components/form-components/index');
var checkAndBuildOpts = require('../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'userActions',
  'widgetDefinitionModel',
  'querySchemaModel',
  'modals',
  'configModel',
  'userModel'
];

/**
 *  View of form to edit a widget definition's data
 *
 */
module.exports = CoreView.extend({

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    var widgetOptions = {
      widgetDefinitionModel: this._widgetDefinitionModel,
      querySchemaModel: this._querySchemaModel,
      modals: this._modals,
      userModel: this._userModel,
      configModel: this._configModel
    };

    this._widgetFormModel = WidgetFormFactory.createWidgetFormModel(widgetOptions);
    this._widgetFormModel.updateSchema();

    this._debounceSaveWidget = _.debounce(this._saveWidget.bind(this), 500);

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this._removeForm();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this._widgetFormModel.bind('change:aggregation', this.render, this);
    this._widgetFormModel.bind('change:column', this.render, this);
    this._widgetFormModel.bind('change', this._onFormChange, this);
    this.add_related_model(this._widgetFormModel);

    this._widgetDefinitionModel.on('change:title', function (model, title) {
      this._widgetFormModel.set({title: title}, {silent: true}); // silent to avoid sending the form
    }, this);
    this._widgetDefinitionModel.bind('change:auto_style_definition', this._onAutoStyleChanged, this);
    this.add_related_model(this._widgetDefinitionModel);
  },

  _initViews: function () {
    var model = this._widgetFormModel;
    var fields = model.getFields();

    this._widgetFormView = new Backbone.Form({
      template: template,
      templateData: {
        dataFields: fields.data,
        styleFields: fields.style
      },
      model: model
    });

    this._widgetFormView.bind('change', function () {
      this.commit();
    });

    this.$el.append(this._widgetFormView.render().$el);

    return this;
  },

  _removeForm: function () {
    // Backbone.Form removes the view with the following method
    this._widgetFormView && this._widgetFormView.remove();
  },

  _onFormChange: function () {
    if (this._widgetFormModel.canSave()) {
      this._widgetFormModel.changeWidgetDefinitionModel(this._widgetDefinitionModel);
      this._debounceSaveWidget();
    }
  },

  _onAutoStyleChanged: function (widgetDefModel, changedAttrs) {
    var previousAutoStyleDefinition = widgetDefModel.previous('auto_style_definition');
    if (previousAutoStyleDefinition === '' && _.isEmpty(previousAutoStyleDefinition)) {
      this._widgetFormModel.set({
        auto_style_definition: widgetDefModel.get('auto_style_definition')
      }, {
        silent: true
      });

      if (!_.isEmpty(changedAttrs)) {
        this.render();
      }
    }
  },

  _saveWidget: function () {
    this._userActions.saveWidget(this._widgetDefinitionModel);
  },

  clean: function () {
    this._removeForm();
    CoreView.prototype.clean.call(this);
  }

});

},{"../../../components/form-components/index":211,"../../../helpers/required-opts":1097,"./widgets-form-factory":1079,"./widgets-form-fields.tpl":1081,"backbone":"backbone","backbone/core-view":1127,"underscore":"underscore"}],1081:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfo">\n  <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">2</div>\n\n  <div class="Editor-HeaderInfo-inner CDB-Text">\n    <div class="Editor-HeaderInfo-title u-bSpace--m">\n      <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.widgets.widgets-form.data.title-label') ))==null?'':_.escape(__t))+
'</h2>\n    </div>\n    <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.widgets.widgets-form.data.description') ))==null?'':_.escape(__t))+
'</p>\n\n    <div data-fields="'+
((__t=( dataFields ))==null?'':_.escape(__t))+
'"></div>\n\n  </div>\n</div>\n\n<div class="CDB-HeaderInfo">\n  <div class="CDB-HeaderNumeration CDB-Text is-semibold u-rSpace--m">3</div>\n\n  <div class="Editor-HeaderInfo-inner CDB-Text">\n    <div class="Editor-HeaderInfo-title u-bSpace--m">\n      <h2 class="CDB-Text CDB-HeaderInfo-TitleText CDB-Size-large">'+
((__t=( _t('editor.widgets.widgets-form.style.title-label') ))==null?'':_.escape(__t))+
'</h2>\n    </div>\n    <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m">'+
((__t=( _t('editor.widgets.widgets-form.style.define') ))==null?'':_.escape(__t))+
'</p>\n\n    <div data-fields="'+
((__t=( styleFields ))==null?'':_.escape(__t))+
'"></div>\n\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],1082:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfo">\n  <div class="Editor-HeaderNumeration CDB-Text is-semibold u-rSpace--m">1</div>\n  <div class="Editor-HeaderInfo-inner CDB-Text js-selector">\n    <div class="Editor-HeaderInfo-title u-bSpace--m">\n      <h2 class="CDB-Text CDB-HeaderInfo-titleText CDB-Size-large">'+
((__t=( _t('editor.widgets.widgets-form.type.title-label') ))==null?'':_.escape(__t))+
'</h2>\n    </div>\n    <p class="CDB-Text u-upperCase CDB-FontSize-small u-altTextColor u-bSpace--m js-highlight">'+
((__t=( _t('editor.widgets.widgets-form.type.description') ))==null?'':_.escape(__t))+
'</p>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],1083:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var CarouselFormView = require('../../../components/carousel-form-view');
var CarouselCollection = require('../../../components/custom-carousel/custom-carousel-collection');
var WidgetFormFactory = require('./widgets-form-factory');
var WidgetsFormFieldsView = require('./widgets-form-fields-view');
var checkAndBuildOpts = require('../../../helpers/required-opts');
var loadingTemplate = require('../../layers/panel-loading-template.tpl');

var REQUIRED_OPTS = [
  'userActions',
  'widgetDefinitionModel',
  'modals',
  'querySchemaModel',
  'configModel',
  'userModel'
];

module.exports = CoreView.extend({

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this._initBinds();

    if (this._querySchemaModel.shouldFetch()) {
      this._querySchemaModel.fetch();
    }
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    if (!this._querySchemaModel.isFetched()) {
      this.$el.html(loadingTemplate());
    } else {
      this._renderCarousel();
      this._renderForm();
    }

    return this;
  },

  _initBinds: function () {
    this.listenTo(this._widgetDefinitionModel, 'change:type', this._renderForm);
    this.listenTo(this._querySchemaModel, 'change:status', this.render);
  },

  _renderCarousel: function () {
    var carouselCollection = new CarouselCollection(
      _.map(WidgetFormFactory.getDataTypes(this._querySchemaModel), function (type) {
        return {
          selected: this._widgetDefinitionModel.get('type') === type.value,
          val: type.value,
          label: type.label,
          template: function () {
            return (type.iconTemplate && type.iconTemplate({ makeItBig: true })) || type.value;
          }
        };
      }, this)
    );

    carouselCollection.bind('change:selected', function (mdl) {
      if (mdl.get('selected')) {
        this._widgetDefinitionModel.changeType(mdl.getValue());
        this._userActions.saveWidget(this._widgetDefinitionModel);
      }
    }, this);

    var view = new CarouselFormView({
      collection: carouselCollection,
      template: require('./widgets-form-types.tpl')
    });
    this.addView(view);
    this.$el.append(view.render().el);
  },

  _renderForm: function () {
    if (this._formView) {
      this.removeView(this._formView);
      this._formView.clean();
    }
    this._formView = new WidgetsFormFieldsView({
      userActions: this._userActions,
      widgetDefinitionModel: this._widgetDefinitionModel,
      querySchemaModel: this._querySchemaModel,
      modals: this._modals,
      userModel: this._userModel,
      configModel: this._configModel
    });
    this.addView(this._formView);
    this.$el.append(this._formView.render().el);
  }
});

},{"../../../components/carousel-form-view":23,"../../../components/custom-carousel/custom-carousel-collection":40,"../../../helpers/required-opts":1097,"../../layers/panel-loading-template.tpl":996,"./widgets-form-factory":1079,"./widgets-form-fields-view":1080,"./widgets-form-types.tpl":1082,"backbone/core-view":1127,"underscore":"underscore"}],1084:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<h2 class="CDB-Text CDB-Size-huge is-light u-secondaryTextColor">'+
((__t=( _t('editor.widgets.widgets-form.placeholder-text') ))==null?'':_.escape(__t))+
'</h2>\n<div class="BlockList-item is-dashed no-hover is-space u-tSpace-xl">\n  <div class="WidgetPlaceHolder">\n    <div class="WidgetPlaceHolder-media"></div>\n    <div class="WidgetPlaceHolder-txt">\n        <h2 class="WidgetPlaceHolder-title"></h2>\n        <p class="WidgetPlaceHolder-text"></p>\n    </div>\n  </div>\n  <button class="CDB-Button CDB-Button--primary js-add">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small u-upperCase">'+
((__t=( _t('editor.widgets.widgets-view.add_widget') ))==null?'':_.escape(__t))+
'</span>\n  </button>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],1085:[function(require,module,exports){
var removeWidgetConfirmationTemplate = require('./delete-widget-confirmation.tpl');
var ConfirmationView = require('../../components/modals/confirmation/modal-confirmation-view');

var service = (function () {
  return {
    init: function (opts) {
      if (!opts.widgetDefinitionsCollection) throw new Error('widgetDefinitionsCollection is required');
      if (!opts.analysisDefinitionNodesCollection) throw new Error('analysisDefinitionNodesCollection');
      if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
      if (!opts.userActions) throw new Error('userActions is required');
      if (!opts.modals) throw new Error('modals is required');

      this._modals = opts.modals;
      this._userActions = opts.userActions;
      this._layerDefinitionsCollection = opts.layerDefinitionsCollection;
      this._widgetDefinitionsCollection = opts.widgetDefinitionsCollection;
      this._analysisDefinitionNodesCollection = opts.analysisDefinitionNodesCollection;
    },

    setStackLayoutBehaviour: function (stackLayoutModel, nextStepProps, backStepProps) {
      this._stackLayoutModel = stackLayoutModel;
      this._nextStepProps = nextStepProps;
      this._backStepProps = backStepProps;
    },

    removeWidget: function (widgetDefModel, callback) {
      var widgetName = widgetDefModel.get('title');

      if (widgetDefModel) {
        this._modals.create(function (modalModel) {
          return new ConfirmationView({
            modalModel: modalModel,
            template: removeWidgetConfirmationTemplate,
            loadingTitle: _t('editor.widgets.delete.loading', {name: widgetName}),
            renderOpts: {
              name: widgetName
            },
            runAction: function () {
              modalModel.destroy();
              widgetDefModel.destroy();
              callback && callback();
            }
          });
        });
      }
    },

    editWidget: function (widgetDefModel) {
      if (!this._stackLayoutModel) {
        return;
      }

      this._stackLayoutModel.goToStep(
        this._nextStepProps.position,
        widgetDefModel,
        this._nextStepProps.arguments,
        function () {
          this._stackLayoutModel.goToStep(
            this._backStepProps.position,
            this._backStepProps.arguments
          );
        }.bind(this)
      );
    }
  };
})();

module.exports = service;

},{"../../components/modals/confirmation/modal-confirmation-view":404,"./delete-widget-confirmation.tpl":1055}],1086:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var EditorWidgetView = require('./widget-view');
var template = require('./widgets-view.tpl');
var widgetPlaceholderTemplate = require('./widgets-placeholder.tpl');
var widgetsErrorTemplate = require('./widgets-content-error.tpl');
var widgetsNotReadyTemplate = require('./widgets-content-not-ready.tpl');

require('jquery-ui');

/**
 * View to render widgets definitions overview
 */
module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.userActions) throw new Error('userActions is required');
    if (!opts.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
    if (!opts.widgetDefinitionsCollection) throw new Error('widgetDefinitionsCollection is required');
    if (!opts.stackLayoutModel) throw new Error('stackLayoutModel is required');
    if (!opts.modals) throw new Error('modals is required');

    this._userActions = opts.userActions;
    this._modals = opts.modals;
    this._layerDefinitionsCollection = opts.layerDefinitionsCollection;
    this._widgetDefinitionsCollection = opts.widgetDefinitionsCollection;
    this.stackLayoutModel = opts.stackLayoutModel;

    this._widgetDefinitionsCollection.on('add', this._goToWidget, this);
    this._widgetDefinitionsCollection.on('destroy', this.render, this);
    this.add_related_model(this._widgetDefinitionsCollection);

    this.viewModel = new Backbone.Model({
      state: 'loading'
    });

    this.viewModel.on('change:state', this.render, this);
    this.add_related_model(this.viewModel);

    var callback = this._onAllQueryGeometryLoaded.bind(this);
    this._layerDefinitionsCollection.loadAllQueryGeometryModels(callback);
  },

  render: function () {
    this._destroySortable();
    this.clearSubViews();
    this.$el.empty();

    if (this._isLoading()) {
      this.$el.append(widgetsNotReadyTemplate());
    } else {
      if (!this._anyGeometryData()) {
        this._showNoGeometryData();
      } else {
        if (this._widgetDefinitionsCollection.size() > 0) {
          this.$el.append(template);
          _.each(this._widgetDefinitionsCollection.sortBy('order'), this._addWidgetItem, this);
          this._initSortable();
        } else {
          this.$el.append(widgetPlaceholderTemplate());
        }
      }
    }

    return this;
  },

  _showNoGeometryData: function () {
    this.$el.append(
      widgetsErrorTemplate({
        body: _t('editor.widgets.no-geometry-data')
      })
    );
  },

  _onAllQueryGeometryLoaded: function () {
    this.viewModel.set({state: 'ready'});
  },

  _isLoading: function () {
    return this.viewModel.get('state') === 'loading';
  },

  _isReady: function () {
    return this.viewModel.get('state') === 'ready';
  },

  _anyGeometryData: function () {
    return this._layerDefinitionsCollection.isThereAnyGeometryData();
  },

  _initSortable: function () {
    this.$('.js-widgets').sortable({
      axis: 'y',
      items: '> li.BlockList-item',
      opacity: 0.8,
      update: this._onSortableFinish.bind(this),
      forcePlaceholderSize: false
    }).disableSelection();
  },

  _destroySortable: function () {
    if (this.$('.js-widgets').data('ui-sortable')) {
      this.$('.js-widgets').sortable('destroy');
    }
  },

  _onSortableFinish: function () {
    var self = this;
    this.$('.js-widgets > .js-widgetItem').each(function (index, item) {
      var modelCid = $(item).data('model-cid');
      var widgetDefModel = self._widgetDefinitionsCollection.get(modelCid);
      widgetDefModel.set('order', index);
      self._userActions.saveWidget(widgetDefModel);
    });
  },

  _goToWidget: function (widgetModel) {
    this.stackLayoutModel.nextStep(widgetModel, 'widget-content');
  },

  _addWidgetItem: function (m) {
    var view = new EditorWidgetView({
      model: m,
      layer: this._layerDefinitionsCollection.get(m.get('layer_id')),
      modals: this._modals,
      userActions: this._userActions,
      stackLayoutModel: this.stackLayoutModel
    });
    this.addView(view);
    this.$('.js-widgets').append(view.render().el);
  },

  clean: function () {
    this._destroySortable();
    CoreView.prototype.clean.apply(this);
  }
});

},{"./widget-view":1065,"./widgets-content-error.tpl":1067,"./widgets-content-not-ready.tpl":1068,"./widgets-placeholder.tpl":1084,"./widgets-view.tpl":1087,"backbone":"backbone","backbone/core-view":1127,"jquery":"jquery","jquery-ui":1128,"underscore":"underscore"}],1087:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="BlockList js-widgets"></ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],1088:[function(require,module,exports){
/**
 * Just provide info about the current browser
 */

module.exports = function () {
  var ua = navigator.userAgent;
  var tem;
  var M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
  if (/trident/i.test(M[1])) {
    tem = /\brv[ :]+(\d+)/g.exec(ua) || [];
    return {
      name: 'IE ',
      version: (tem[1] || '')
    };
  }
  if (M[1] === 'Chrome') {
    tem = ua.match(/\bOPR\/(\d+)/);
    if (tem != null) {
      return {
        name: 'Opera',
        version: tem[1]
      };
    }
  }
  M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
  if ((tem = ua.match(/version\/(\d+)/i)) != null) {
    M.splice(1, 1, tem[1]);
  }

  return {
    name: M[0],
    version: M[1]
  };
};

},{}],1089:[function(require,module,exports){
module.exports = [
  'aliceblue', 'antiquewhite', 'aqua', 'aquamarine', 'azure', 'beige',
  'bisque', 'black', 'blanchedalmond', 'blue', 'blueviolet', 'brown',
  'burlywood', 'cadetblue', 'chartreuse', 'chocolate', 'coral', 'cornflowerblue',
  'cornsilk', 'crimson', 'cyan', 'darkblue', 'darkcyan', 'darkgoldenrod',
  'darkgray', 'darkgreen', 'darkkhaki', 'darkmagenta', 'darkolivegreen',
  'darkorange', 'darkorchid', 'darkred', 'darksalmon', 'darkseagreen',
  'darkslateblue', 'darkslategray', 'darkturquoise', 'darkviolet',
  'deeppink', 'deepskyblue', 'dimgray', 'dodgerblue', 'firebrick',
  'floralwhite', 'forestgreen', 'fuchsia', 'gainsboro', 'ghostwhite',
  'gold', 'goldenrod', 'gray', 'grey', 'green', 'greenyellow', 'honeydew',
  'hotpink', 'indianred', 'indigo', 'ivory', 'khaki', 'lavender',
  'lavenderblush', 'lawngreen', 'lemonchiffon', 'lightblue', 'lightcoral',
  'lightcyan', 'lightgoldenrodyellow', 'lightgray', 'lightgreen', 'lightpink',
  'lightsalmon', 'lightseagreen', 'lightskyblue', 'lightslategray',
  'lightsteelblue', 'lightyellow', 'lime', 'limegreen', 'linen', 'magenta',
  'maroon', 'mediumaquamarine', 'mediumblue', 'mediumorchid', 'mediumpurple',
  'mediumseagreen', 'mediumslateblue', 'mediumspringgreen', 'mediumturquoise',
  'mediumvioletred', 'midnightblue', 'mintcream', 'mistyrose', 'moccasin',
  'navajowhite', 'navy', 'oldlace', 'olive', 'olivedrab', 'orange', 'orangered',
  'orchid', 'palegoldenrod', 'palegreen', 'paleturquoise', 'palevioletred',
  'papayawhip', 'peachpuff', 'peru', 'pink', 'plum', 'powderblue',
  'purple', 'red', 'rosybrown', 'royalblue', 'saddlebrown', 'salmon',
  'sandybrown', 'seagreen', 'seashell', 'sienna', 'silver', 'skyblue',
  'slateblue', 'slategray', 'snow', 'springgreen', 'steelblue', 'tan',
  'teal', 'thistle', 'tomato', 'turquoise', 'violet', 'wheat', 'white',
  'whitesmoke', 'yellow', 'yellowgreen'
];

},{}],1090:[function(require,module,exports){
var _ = require('underscore');
var DEFAULT_ERROR_MSG = '';

/**
 *  Return error message when backend request fails
 *  It tries to get responseText > errors and error arrays, if not gets `statusText`.
 */

module.exports = function (e) {
  if (!e) { throw new Error('error is required'); }

  try {
    var responseText = e.responseText && e.responseText.trim() && JSON.parse(e.responseText);
    var errorMessage = e.statusText || DEFAULT_ERROR_MSG;

    if (responseText) {
      var errors = _.compact(
        _.map(['errors', 'error'], function (type) {
          return responseText[type] && responseText[type].join(', ');
        })
      );
      errorMessage = errors.join(', ');
    }

    return errorMessage;
  } catch (err) {
    return DEFAULT_ERROR_MSG;
  }
};

},{"underscore":"underscore"}],1091:[function(require,module,exports){
var track = function (error) {
  if (window.trackJs) {
    window.trackJs.track(error);
  }
};

module.exports = track;

},{}],1092:[function(require,module,exports){
/**
 *  Fetch all query objects (querySchemaModel, queryGeometryModel, queryRowsCollection)
 *  if necessary
 */

module.exports = function (params, callback) {
  if (!params) throw new Error('all query objects are required');
  if (!params.querySchemaModel) throw new Error('querySchemaModel is required');
  if (!params.queryGeometryModel) throw new Error('queryGeometryModel is required');
  if (!params.queryRowsCollection) throw new Error('queryRowsCollection is required');

  var allFetched = function () {
    return params.querySchemaModel.isFetched() &&
           params.queryGeometryModel.isFetched() &&
           params.queryRowsCollection.isFetched();
  };

  var checkQueryRowsCollectionFetch = function () {
    if (params.queryRowsCollection.shouldFetch()) {
      var opts = {};
      if (callback) {
        opts.success = callback;
      }
      params.queryRowsCollection.fetch(opts);
    } else {
      // we need to check if all are fetched because shouldFetch include the fetching state
      allFetched() && callback && callback();
    }
  };

  var rows = params.queryRowsCollection.size();

  // we need to check if besides queryGeometryModel, there is any row, because the user could have deleted them
  if (params.queryGeometryModel.shouldFetch() || (rows === 0 && params.queryRowsCollection.shouldFetch())) {
    params.queryGeometryModel.fetch();
  }

  if (params.querySchemaModel.shouldFetch()) {
    params.querySchemaModel.fetch({
      success: checkQueryRowsCollectionFetch
    });
  } else {
    checkQueryRowsCollectionFetch();
  }
};

},{}],1093:[function(require,module,exports){
var _ = require('underscore');
var DEFAULT_VALUES = {
  top: 0,
  left: 0
};
var MIN_GAP = 10;
var MIN_HEIGHT = 205;
var MIN_WIDTH = 244;

/**
 * Would you like to know where to open a context menu?
 * Just provide:
 * @param {Object} options.parentView               Parent element view
 * @param {Number} options.posX                     Position X of the context menu
 * @param {Number} options.posY                     Position Y of the context menu
 * @param {Number} options.elementWidth (optional)  Context menu width
 * @param {Number} options.elementHeight (optional) Context menu height
 * @param {Number} options.offsetX (optional)       Context menu offsetX
 * @param {Number} options.offsetY (optional)       Context menu offsetY
 *
 * By default, it will try to positionate to the right (inside) and to
 * the top (below).
 */

var MagicPositioner = function (params) {
  if (!params.parentView) throw new Error('parentView within params is required');
  if (!_.isNumber(params.posX)) throw new Error('posX within params is required');
  if (!_.isNumber(params.posY)) throw new Error('posY within params is required');

  var $parentView = params.parentView;
  var parentViewHeight = $parentView.outerHeight();
  var parentViewWidth = $parentView.outerWidth();
  var posX = params.posX;
  var posY = params.posY;
  var offsetX = params.offsetX || 0;
  var offsetY = params.offsetY || 0;
  var elementWidth = params.elementWidth || MIN_WIDTH;
  var elementHeight = params.elementHeight || MIN_HEIGHT;
  var cssProps = DEFAULT_VALUES;

  if ((posX - elementWidth) > MIN_GAP) {
    cssProps.left = 'auto';
    cssProps.right = (parentViewWidth - posX + offsetX) + 'px';
  } else if ((posX + elementWidth) > elementWidth) {
    cssProps.right = 'auto';
    cssProps.left = (posX + offsetX) + 'px';
  }

  if ((posY + elementHeight) < parentViewHeight) {
    cssProps.bottom = 'auto';
    cssProps.top = (posY + offsetY) + 'px';
  } else if ((posY + elementHeight) > parentViewHeight) {
    cssProps.top = 'auto';
    cssProps.bottom = (parentViewHeight - posY + offsetY) + 'px';
  }

  return cssProps;
};

module.exports = MagicPositioner;

},{"underscore":"underscore"}],1094:[function(require,module,exports){
var $ = require('jquery');

/**
 * Check if Linux user used right/middle click at the time of the event
 *
 * @param ev {Event}
 * @returns {boolean}
 */
function isLinuxMiddleOrRightClick (ev) {
  return ev.which === 2 || ev.which === 3;
}

/**
 * Check if Mac user used CMD key at the time of the event Mac user used CMD key at the time of the event.
 *
 * @param ev {Event}
 * @returns {boolean}
 */
function isMacCmdKeyPressed (ev) {
  return ev.metaKey;
}

function isCtrlKeyPressed (ev) {
  return ev.ctrlKey;
}

/**
 * Click handler for a cartodb.js view, to navigate event target's href URL through the view's router.navigate method.
 *
 * The default behavior is:
 * Unless cmd/ctrl keys are pressed it will cancel the default link behavior and instead navigate to the URL set in the
 * target's href attribute.
 *
 * Prerequisities:
 *  - view has a this.router instance.
 *
 * Example of how to use:
 *   - In a template:
 *     <a href="/some/uri" id="#my-link" ...
 *     <a href="/special/uri" id="#my-special-link" ...
 *
 *   - In the view file:
 *     var navigateThroughRouter = require('--/--/common/view_helpers/navigateThroughRouter');
 *     module.exports = new CoreView.extend({
 *       events: {
 *         'click a#my-link': navigateThroughRouter
 *         'click a#my-special-link': this._myCustomRoute
 *       }
 *
 *       _myCustomRoute: function(ev) {
 *         // Here you can do you custom logic before/after the routing, e.g.:
 *         console.log('before changing route');
 *         navigateThroughRouter.apply(this, arguments);
 *         console.log('after changing route');
 *       }
 *
 * @param ev {Event}
 */
module.exports = function (ev) {
  // We always kill the default behaviour of the event, since container around view might have other click behavior.
  // In case of a cmd/ctrl click by an user.
  this.killEvent(ev);
  var url = $(ev.target).closest('a').attr('href');

  if (!url) {
    return false;
  }

  if (!isLinuxMiddleOrRightClick(ev) && !isMacCmdKeyPressed(ev)) {
    var routerModel = (this.routerModel || this.options.routerModel);
    if (!routerModel) {
      throw new Error('routerModel is required');
    }

    routerModel.navigate(url, { trigger: true });
  } else if (isCtrlKeyPressed(ev) || isMacCmdKeyPressed(ev)) {
    window.open(url, '_blank');
  }
};

},{"jquery":"jquery"}],1095:[function(require,module,exports){
var cdb = require('cartodb.js');
var carto = require('carto');
var torque = require('torque.js');
var _ = require('underscore');

var CartoParser = function (cartocss) {
  this.parse_env = null;
  this.ruleset = null;
  if (cartocss) {
    this.parse(cartocss);
  }
};

CartoParser.prototype = {
  // value due to torque
  RESERVED_VARIABLES: ['mapnik-geometry-type', 'points_density', 'points_count', 'src', 'value', 'agg_value', 'agg_value_density'],

  parse: function (cartocss) {
    this.parse_env = {
      validation_data: false,
      frames: [],
      errors: [],
      error: function (obj) {
        obj.line = carto.Parser().extractErrorLine(cartocss, obj.index);
        this.errors.push(obj);
      }
    };

    var self = this;
    var ruleset = null;
    var defs = null;

    try {
      // set default reference
      carto.tree.Reference.setData(carto.default_reference.version.latest);
      ruleset = (new carto.Parser(this.parse_env)).parse(cartocss);
    } catch (e) {
      // add the style.mss string to match the response from the server
      this.parse_env.errors = this.parseError(['style\.mss' + e.message]);
      return;
    }

    if (ruleset) {
      var existing = {};
      var mapDef;
      var symbolizers;
      var i;
      var j;
      var r;

      this.definitions = defs = ruleset.toList(this.parse_env);

      for (i in defs) {
        if (defs[i].elements.length > 0) {
          if (defs[i].elements[0].value === 'Map') {
            mapDef = defs.splice(i, 1)[0];
          }
        }
      }

      symbolizers = torque.cartocss_reference.version.latest.layer;

      if (mapDef) {
        mapDef.rules.forEach(function (r) {
          var key = r.name;
          var type;
          var element;

          if (!(key in symbolizers)) {
            self.parse_env.error({
              message: 'Rule ' + key + ' not allowed for Map.',
              index: r.index
            });
          } else {
            type = symbolizers[r.name].type;
            element = r.value.value[0].value[0];
            if (!self._checkValidType(element, type)) {
              self.parse_env.error({
                message: 'Expected type ' + type + '.',
                index: r.index
              });
            }
          }
        });
      }

      defs = carto.inheritDefinitions(defs, this.parse_env);
      defs = carto.sortStyles(defs, this.parse_env);

      for (i in defs) {
        for (j in defs[i]) {
          r = defs[i][j];
          if (r && r.toXML) {
            r.toXML(this.parse_env, existing);
          }
        }
      }

      // toList uses parse_env.errors.message to put messages
      if (this.parse_env.errors.message) {
        _(this.parse_env.errors.message.split('\n')).each(function (m) {
          self.parse_env.errors.push(m);
        });
      }
    }

    this.ruleset = ruleset;
    return this;
  },

  _checkValidType: function (e, type) {
    if (['number', 'float'].indexOf(type) > -1) {
      return typeof e.value === 'number';
    } else if (type === 'string') {
      return e.value !== 'undefined' && typeof e.value === 'string';
    } else if (type.constructor === Array) {
      return type.indexOf(e.value) > -1 || e.value === 'linear';
    } else if (type === 'color') {
      return this._checkValidColor(e);
    }
    return true;
  },

  _checkValidColor: function (e) {
    var expectedArguments = {rgb: 3, hsl: 3, rgba: 4, hsla: 4};
    return typeof e.rgb !== 'undefined' || expectedArguments[e.name] === e.args;
  },

  /**
   * gets an array of parse errors from windshaft
   * and returns an array of {line:1, error: 'string'] with user friendly
   * strings. Parses errors in format:
   *
   *  'style.mss:7:2 Invalid code: asdasdasda'
   */
  parseError: function (errors) {
    var parsedErrors = [];
    var i;
    var g;
    var err;

    for (i in errors) {
      err = errors[i];
      if (err && err.length > 0) {
        g = err.match(/.*:(\d+):(\d+)\s*(.*)/);
        if (g) {
          parsedErrors.push({
            line: parseInt(g[1], 10),
            message: g[3]
          });
        } else {
          parsedErrors.push({
            line: null,
            message: err
          });
        }
      }
    }

    // sort by line
    parsedErrors.sort(function (a, b) { return a.line - b.line; });
    parsedErrors = _.uniq(parsedErrors, true, function (a) { return a.line + a.message; });
    return parsedErrors;
  },

  /**
   * return the error list, empty if there were no errors
   */
  errors: function () {
    return this.parse_env ? this.parse_env.errors : [];
  },

  _colorsFromRule: function (rule) {
    function searchRecursiveByType (v, t) {
      var res = [];
      var i;
      var r;
      for (i in v) {
        if (v[i] instanceof t) {
          res.push(v[i]);
        } else if (typeof v[i] === 'object') {
          r = searchRecursiveByType(v[i], t);
          if (r.length) {
            res = res.concat(r);
          }
        }
      }
      return res;
    }
    return searchRecursiveByType(rule.ev(this.parse_env), carto.tree.Color);
  },

  _varsFromRule: function (rule) {
    function searchRecursiveByType (v, t) {
      var res = [];
      var i;
      var r;

      for (i in v) {
        if (v[i] instanceof t) {
          res.push(v[i]);
        } else if (typeof v[i] === 'object') {
          r = searchRecursiveByType(v[i], t);
          if (r.length) {
            res = res.concat(r);
          }
        }
      }
      return res;
    }
    return searchRecursiveByType(rule, carto.tree.Field);
  },

  /**
   * Extract information from the carto using the provided method.
   * */
  _extract: function (method, extractVariables) {
    var self = this;
    var columns = [];
    var definitions;
    var def;
    var d;
    var r;
    var f;
    var k;
    var rule;
    var columnList;
    var filter;
    var filter_key;

    if (this.ruleset) {
      definitions = this.ruleset.toList(this.parse_env);
      for (d in definitions) {
        def = definitions[d];

        if (def.filters) {
          // extract from rules
          for (r in def.rules) {
            rule = def.rules[r];
            columnList = method(this, rule);
            columns = columns.concat(columnList);
          }

          if (extractVariables) {
            for (f in def.filters) {
              filter = def.filters[f];
              for (k in filter) {
                filter_key = filter[k];
                if (filter_key.key && filter_key.key.value) {
                  columns.push(filter_key.key.value);
                }
              }
            }
          }
        }
      }

      return _.reject(_.uniq(columns), function (v) {
        return _.contains(self.RESERVED_VARIABLES, v);
      });
    }
  },

  /**
   * return a list of colors used in cartocss
   */
  colorsUsed: function (opt) {
    // extraction method
    var method = function (self, rule) {
      return _.map(self._colorsFromRule(rule), function (f) {
        return f.rgb;
      });
    };

    var colors = this._extract(method, false);

    if (opt && opt.mode === 'hex') {
      colors = _.map(colors, function (color) {
        return cdb.Utils.rgbToHex(color[0], color[1], color[2]);
      });
    }

    return colors;
  },

  /**
   * return a list of variables used in cartocss
   */
  variablesUsed: function () {
    // extraction method
    var method = function (self, rule) {
      return _.map(self._varsFromRule(rule), function (f) {
        return f.value;
      });
    };

    return this._extract(method, true);
  },

  /**
   * returns the default layer
   */
  getDefaultRules: function () {
    var rules = [];
    var i;
    var def;
    var rulesMap = {};

    for (i = 0; i < this.definitions.length; ++i) {
      def = this.definitions[i];
      // all zooms and default attachment so we don't get conditional variables
      if (def.zoom === 8388607 && _.size(def.filters.filters) === 0 && def.attachment === '__default__') {
        rules = rules.concat(def.rules);
      }
    }

    for (i in rules) {
      var rule = rules[i];
      rulesMap[rule.name] = rule;
    }
    return rulesMap;
  },

  getRuleByName: function (definition, ruleName) {
    if (!definition._rulesByName) {
      var rulesMap = definition._rulesByName = {};
      for (var r in definition.rules) {
        var rule = definition.rules[r];
        rulesMap[rule.name] = rule;
      }
    }
    return definition._rulesByName[ruleName];
  }
};

module.exports = CartoParser;

},{"carto":"carto","cartodb.js":"cartodb.js","torque.js":"torque.js","underscore":"underscore"}],1096:[function(require,module,exports){
// Get coordinates from a GeoJSON

module.exports = function (geometry) {
  try {
    var geojson = JSON.parse(geometry);
    return geojson.coordinates.join(', ');
  } catch (e) {
    return false;
  }
};

},{}],1097:[function(require,module,exports){
var _ = require('underscore');

module.exports = function checkAndBuildRequiredOpts (actualOpts, requiredOpts, context) {
  if (requiredOpts === void 0) {
    throw new Error('Opts are required');
  }

  _.each(requiredOpts, function (item) {
    if (actualOpts[item] === void 0) throw new Error(item + ' is required');
    context['_' + item] = actualOpts[item];
  }, context);
};

},{"underscore":"underscore"}],1098:[function(require,module,exports){
/*  Check and perform a reset of the styles due to a change over a node definition model (if possible).
 *
 *  In order to use and test this function in any view, we have removed this code
 *  from user-actions Class.
 *
 *  forceStyleUpdate: it will reset the styles in any case, no matter the schema or the geometry.
 *  resetQueryReady:  set as false ready property for query-schema-model and query-geometry-model
 *                    in order to wait for a node change before checking if reset styles is necessary.
 *
 */

module.exports = function (nodeDefModel, layerDefModel, forceStyleUpdate, resetQueryReady) {
  if (!nodeDefModel) throw new Error('nodeDefModel is required');
  if (!layerDefModel) throw new Error('layerDefModel is required');

  var CHANGE_READY = 'change:ready';
  var onQueryGeometryAndSchemaReady;
  var styleModel = layerDefModel.styleModel;
  var queryGeometryModel = nodeDefModel.queryGeometryModel;
  var querySchemaModel = nodeDefModel.querySchemaModel;

  onQueryGeometryAndSchemaReady = function () {
    if (queryGeometryModel.get('ready') && querySchemaModel.get('ready')) {
      queryGeometryModel.unbind(CHANGE_READY, onQueryGeometryAndSchemaReady);
      querySchemaModel.unbind(CHANGE_READY, onQueryGeometryAndSchemaReady);
    } else {
      return; // wait until ready
    }

    var CHANGE_STATUS = 'change:status';
    var saveDefaultStylesIfStillRelevant;

    saveDefaultStylesIfStillRelevant = function () {
      var unbindNodeChangeStatus = function () {
        queryGeometryModel.unbind(CHANGE_STATUS, saveDefaultStylesIfStillRelevant);
        querySchemaModel.unbind(CHANGE_STATUS, saveDefaultStylesIfStillRelevant);
      };

      var applyStylesAndSave = function () {
        var simpleGeometryType = queryGeometryModel.get('simple_geom');
        if (simpleGeometryType) {
          styleModel.setDefaultPropertiesByType('simple', simpleGeometryType);
        } else {
          styleModel.setDefaultPropertiesByType('none'); // fallback if there is no known geometry
        }
        layerDefModel.save();
      };

      var styleTypeApplied = styleModel.get('type');

      if (queryGeometryModel.isFetching() || querySchemaModel.isFetching()) { // Wait until fetched
        return;
      } else if (!queryGeometryModel.isFetching() && !queryGeometryModel.isFetched() &&
        !querySchemaModel.isFetching() && !querySchemaModel.isFetched()) { // Node status has been resetted
        unbindNodeChangeStatus();
        return;
      } else { // Fetched!
        unbindNodeChangeStatus();
      }

      // If the geometry doesn't change and all columns used for style-def-model are still present + the styles are not custom
      // we can reset the style form with the geometry provided
      var haveDifferentSchema = querySchemaModel.hasDifferentSchemaThan(styleModel.getColumnsUsedForStyle());
      if (
          styleTypeApplied !== 'none' &&
          !forceStyleUpdate && (
            (!queryGeometryModel.hasChanged('simple_geom') && !haveDifferentSchema) ||
            layerDefModel.get('cartocss_custom')
          )
        ) {
        return;
      }

      if ( // Only apply changes if:
        (
          layerDefModel.collection.contains(layerDefModel) && // layer still exist
          layerDefModel.get('source') === nodeDefModel.id // node is still the head of layer
        ) || forceStyleUpdate // we force the style update
      ) {
        applyStylesAndSave();
      }
    };

    saveDefaultStylesIfStillRelevant();

    if (!queryGeometryModel.isFetched()) {
      queryGeometryModel.bind(CHANGE_STATUS, saveDefaultStylesIfStillRelevant);
    }

    if (!querySchemaModel.isFetched()) {
      querySchemaModel.bind(CHANGE_STATUS, saveDefaultStylesIfStillRelevant);
    }
  };

  if (resetQueryReady) {
    queryGeometryModel.set('ready', false);
    querySchemaModel.set('ready', false);
  }

  queryGeometryModel.bind(CHANGE_READY, onQueryGeometryAndSchemaReady);
  querySchemaModel.bind(CHANGE_READY, onQueryGeometryAndSchemaReady);
  onQueryGeometryAndSchemaReady();
};

},{}],1099:[function(require,module,exports){
/**
 *  Checks properties from a SQL
 */

var TableNameUtils = require('./table-name-utils');

module.exports = {
  isSameQuery: function (originalQuery, customQuery) {
    if (originalQuery == null || customQuery == null) { // eslint-disable-line
      throw new Error('Needed parameters not provided');
    }

    var parseQuery = function (query) {
      return query
        .toLowerCase()
        .replace(/\"/g, '') // Remove quoted things like "pepe".tableName
        .replace(/;/g, '');
    };

    return parseQuery(originalQuery) === parseQuery(customQuery);
  },

  // return true if the sql query alters table schema in some way
  altersSchema: function (sql) {
    if (!sql) {
      return false;
    }

    // Remove all line breaks in order to prevent
    // search pattern problems
    sql = this._removeLineBreaks(sql.trim());

    return sql.search(/alter\s+[\w\."]+\s+/i) !== -1 ||
      sql.search(/drop\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/^vacuum\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/^create\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/^reindex\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/^grant\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/^revoke\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/^cluster\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/^comment\s+on\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/^explain\s+[\w\.\"]+/i) !== -1;
  },

  // return true if the sql query alters table data
  altersData: function (sql) {
    if (!sql) {
      return false;
    }

    // Remove all line breaks in order to prevent
    // search pattern problems
    sql = this._removeLineBreaks(sql.trim());

    return this.altersSchema(sql) ||
      sql.search(/^refresh\s+materialized\s+view\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/^truncate\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/insert\s+into/i) !== -1 ||
      sql.search(/update\s+[\w\.\-"]+\s+.*set/i) !== -1 ||
      sql.search(/delete\s+from/i) !== -1;
  },

  _removeLineBreaks: function (sql) {
    return sql.replace(/\r?\n|\r/g, ' ');
  },

  getDefaultSQL: function (tableName, userName, inOrganization) {
    return this.getDefaultSQLFromTableName(TableNameUtils.getQualifiedTableName(tableName, userName, inOrganization));
  },

  getDefaultSQLFromTableName: function (tableName) {
    return 'SELECT * FROM ' + tableName;
  }
};

},{"./table-name-utils":1101}],1100:[function(require,module,exports){
module.exports = function () {
  var stylesWithoutAutostyles;

  return function (layerDefModel) {
    var isAutoStyleActive = !!layerDefModel.get('autoStyle');

    if (!isAutoStyleActive) {
      stylesWithoutAutostyles = {
        previousCartoCSS: layerDefModel.get('cartocss'),
        previousCartoCSSCustom: layerDefModel.attributes.cartocss_custom
      };
    }

    return stylesWithoutAutostyles;
  };
};

},{}],1101:[function(require,module,exports){
/**
 *  Functions to work with SQL table names
 */

module.exports = {
  getUnqualifiedName: function (tablename) {
    if (!tablename) return null;
    var tk = tablename.split('.');
    if (tk.length === 2) {
      return this._getUnquotedName(tk[1]);
    }
    return this._getUnquotedName(tablename);
  },

  getUsername: function (tablename) {
    if (!tablename) return null;
    var tk = tablename.split('.');
    if (tk.length === 2) {
      return this._getUnquotedName(tk[0]);
    }
    return '';
  },

  _getUnquotedName: function (tablename) {
    return tablename && tablename.replace(/"/g, '');
  },

  _quoteIfNeeded: function (name) {
    var VALID_IDENTIFIER = /^[a-zA-Z_][a-zA-Z0-9_$]*$/;
    name = this._getUnquotedName(name);
    if (!VALID_IDENTIFIER.test(name)) {
      name = '"' + name + '"';
    }
    return name;
  },

  getQualifiedTableName: function (tableName, userName, inOrganization) {
    var schemaPrefix = (inOrganization && userName) ? this._quoteIfNeeded(userName) + '.' : '';
    return schemaPrefix + this._quoteIfNeeded(this.getUnqualifiedName(tableName));
  },

  isSameTableName: function (firstTableName, secondTableName, ownerUsername) {
    var firstParts = this._getTableNameParts(firstTableName, ownerUsername);
    var secondParts = this._getTableNameParts(secondTableName, ownerUsername);

    return firstParts[0] === secondParts[0] && firstParts[1] === secondParts[1];
  },

  _getTableNameParts: function (tableName, ownerUsername) {
    var table = this.getUnqualifiedName(tableName);
    var username = this.getUsername(tableName) || ownerUsername;

    return [username, table];
  }
};

},{}],1102:[function(require,module,exports){
var _ = require('underscore');
var cdb = require('cartodb.js');

/*
 *  Util functions
 */

module.exports = {
  /*
   *  Simple regex to check if string is an url/ftp
   *  input ->  string with input text (example: 'https://carto.com')
   *
   *  return -> true
   */
  isURL: function (input) {
    var urlregex = /^((http|https|ftp)\:\/\/)/g;
    if (input) {
      return urlregex.test(input);
    } else {
      return false;
    }
  },

  /*
   *  check if string is blank (i.e.: str === "")
   *  input ->  string with input text
   *
   * @return a boolean
   */
  isBlank: function (str) {
    return (!str || /^\s*$/.test(str));
  },
  /*
   *  Transform bytes to a readable format, like MB, GB
   *  input ->  34234244
   *
   *  return -> 3 MB
   */
  readablizeBytes: function (bytes, round) {
    if (!bytes || isNaN(bytes)) {
      return 0;
    }
    var s = ['bytes', 'kB', 'MB', 'GB', 'TB', 'PB'];
    var e = Math.floor(Math.log(bytes) / Math.log(1024));
    var value = (bytes / Math.pow(1024, Math.floor(e))).toFixed(2);

    if (round) {
      value = parseInt(value, 10);
    }

    return value + ' ' + s[e];
  },

  /**
   *  Convert long numbers to
   *  readizable numbers.
   *
   */
  readizableNumber: function (num) {
    if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'G';
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num;
  },

  /*
   * formatNumber: adds thousands separators
   * @return a string
   *
   */
  formatNumber: function (x) {
    if (!x) return '0';
    var parts = x.toString().split('.');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    return parts.join('.');
  },

  /**
   * Similar to _.result, but also allows passing arbitrary arguments to the property if it's function.
   * This makes code more terse  when one just wants to use a value if it's available, no if-checks required.
   *
   * @example Expected output
   *   model.set('something', 'yay');
   *   cdb.Utils.result(model, 'get', 'something') // => 'yay'
   *   cdb.Utils.result(model, 'nonexisting', 'else') // => undefined
   *   cdb.Utils.result(undefinedVar, 'get') // => null
   *
   * @example Of usage
   *  return cdb.Utils.result(model, 'get', 'mightNotExist') === 'OK'
   *
   * @param {*} maybeFn
   * @return {*} Result from called maybeFn if a function, null otherwise
   */
  result: function (object, property) {
    if (object == null) return null;
    var value = object[property];
    return _.isFunction(value) ? value.apply(object, Array.prototype.slice.call(arguments, 2)) : value;
  },

  /**
   *  Get the extension of a string
   *
   */
  getFileExtension: function (str) {
    if (!str) return '';
    return str.substr(str.lastIndexOf('.') + 1);
  },

  /**
   *  Add leading zeros to numbers
   *
   */
  pad: function (num, size) {
    var s = num + '';
    while (s.length < size) s = '0' + s;
    return s;
  },

  formatDate: function (opts) {
    if (!opts.time) throw new Error();
    if (opts.month === undefined) throw new Error();
    if (opts.year === undefined) throw new Error();
    if (!opts.day) throw new Error();

    // Month in Date format should be specified as an index
    var month = parseInt(opts.month + 1, 10);
    var padZero = function (digit) {
      digit = String(digit);
      if (digit < 10 && digit.length === 1) {
        return '0' + digit;
      }
      return digit;
    };

    return '' +
      opts.year + '-' +
      padZero(month) + '-' +
      padZero(opts.day) + 'T' +
      opts.time + 'Z';
      // Not adding any info about timezone
  },

  /*
   * rgbToHex
   *
   */
  rgbToHex: function (r, g, b) {
    function componentToHex (c) {
      var hex = c.toString(16);
      return hex.length === 1 ? '0' + hex : hex;
    }

    return '#' + componentToHex(r) + componentToHex(g) + componentToHex(b);
  },

  /*
   *  Returns true if the hex color passed as an input is valid
   *  input -> hex (#FF00FF)
   *  output -> true
   *
   * @return a boolean
   */
  isValidHex: function (hex) {
    return !!hex.match(/(^#?[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i);
  },

  /*
   *  Transforms an hex color into its RGB representation
   *  input ->  hex (#FF00FF)
   *  output ->  { r: 255, g: 0, b: 255 }
   *
   * @return a hash
   */
  hexToRGB: function (hex) {
    if (!hex) {
      hex = '#FFFFFF';
    }

    var shortRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;

    hex = hex.replace(shortRegex, function (m, r, g, b) {
      return r + r + g + g + b + b;
    });

    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);

    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : null;
  },
  /*
   *  Transforms an hex color an a opacity value to a rgba string
   *  input ->  hex (#FF00FF) and opacity (0.4)
   *  output -> 'rgba(255,0,255,0.4)'
   *
   * @return a string
   */
  hexToRGBA: function (hex, opacity) {
    function roundToTwo (num) {
      return +(Math.round(num + 'e+2') + 'e-2');
    }

    var rgb = this.hexToRGB(hex);
    opacity = opacity != null ? roundToTwo(opacity) : 1;
    if (rgb) {
      return 'rgba(' + [rgb.r, rgb.g, rgb.b, opacity].join(', ') + ')';
    } else {
      return hex;
    }
  },

  /*
   *  Strip html tags from a value.
   *  input ->  string with input text (example: '<a href="#whoknows">Jamon</a> </br> <p>Vamos</p>')
   *  allowed -> allowed html tags in the result (example: '<a>')
   *
   *  return -> '<a href="#whoknows">Jamon</a> Vamos'
   */
  stripHTML: function (input, allowed) {
    allowed = (((allowed || '') + '').toLowerCase().match(/<[a-z][a-z0-9]*>/g) || []).join('');
    var tags = /<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;
    if (!input || (typeof input !== 'string')) return '';
    return input.replace(tags, function ($0, $1) {
      return allowed.indexOf('<' + $1.toLowerCase() + '>') > -1 ? $0 : '';
    });
  },

  /**
   *  Remove all non-common characters like spaces, quotes, accents, etc. and
   *  joins strings with underscore symbols
   *
   */
  sanitizeString: function (str) {
    return str.replace(/[^a-z0-9\s]/gi, '').replace(/[_\s]/g, '_');
  },

  /**
   *  Returns true is value is a valid number. Based on jQuery isNumeric
   */
  isNumeric: function (value) {
    return !isNaN(parseFloat(value)) && isFinite(value);
  },

  /**
   * Formats a number that to include up to 2 decimal positions if less than 10
   * and up to 1 if greater than 10.
   */
  formatDecimalPositions: function (value) {
    // we are using here the unary operator because parseInt fails to handle exponential number
    var converted = +value;
    var p = 0;
    var abs_v;

    if (isNaN(converted) || converted === 0) {
      return value;
    }

    abs_v = Math.abs(converted);

    if (abs_v > 10) {
      p = 1;
    } else if (abs_v > 0.01) {
      p = Math.min(Math.ceil(Math.abs(Math.log(abs_v) / Math.log(10))) + 2, 2);
    }

    value = value.toFixed(p);
    var m = value.match(/(\.0+)$/);
    if (m) {
      value = value.replace(m[0], '');
    }

    return value;
  },

  /**
   *  Remove new lines from string
   *
   */
  removeNewLines: function (str) {
    return str.replace(/(\r\n|\n|\r)/gm, '');
  },

  /**
   * Returns true if the string ends with provided suffix
   */
  endsWith: function (str, suffix) {
    return str.indexOf(suffix, str.length - suffix.length) !== -1;
  },

  cloneObject: function (obj) {
    if (!obj) {
      return obj;
    }
    return JSON.parse(JSON.stringify(obj));
  },

  /**
   *  Capitalize first letter of string
   *
   */
  capitalize: function (str) {
    if (!str) {
      return str;
    }
    return str.charAt(0).toUpperCase() + str.slice(1);
  },

  sanitizeHtml: function (text) {
    return cdb.core.sanitize.sanitize(text || '');
  }
};

},{"cartodb.js":"cartodb.js","underscore":"underscore"}],1103:[function(require,module,exports){
var Backbone = require('backbone');

var VIEWING_MODE = 'viewing';
var DRAWING_FEATURE_MODE = 'drawing';
var EDITING_FEATURE_MODE = 'editing';

var MapMode = Backbone.Model.extend({
  defaults: {
    mode: VIEWING_MODE
  },

  enterViewingMode: function () {
    delete this._featureDefinition;
    this.set('mode', VIEWING_MODE);
  },

  enterDrawingFeatureMode: function (feature) {
    this._featureDefinition = feature;
    this.set('mode', DRAWING_FEATURE_MODE);
  },

  enterEditingFeatureMode: function (feature) {
    this._featureDefinition = feature;
    this.set('mode', EDITING_FEATURE_MODE);
  },

  getFeatureDefinition: function () {
    return this._featureDefinition;
  },

  isViewingMode: function () {
    return this._isMode(VIEWING_MODE);
  },

  isDrawingFeatureMode: function () {
    return this._isMode(DRAWING_FEATURE_MODE);
  },

  isEditingFeatureMode: function () {
    return this._isMode(EDITING_FEATURE_MODE);
  },

  _isMode: function (mode) {
    return this.get('mode') === mode;
  }
});

module.exports = MapMode;

},{"backbone":"backbone"}],1104:[function(require,module,exports){
module.exports = "<div class=\"CDB-infowindow CDB-infowindow--light js-infowindow\">\n  <div class=\"CDB-infowindow-close js-close\"></div>\n  <div class=\"CDB-infowindow-container\">\n    <div class=\"CDB-infowindow-header CDB-infowindow-headerBg CDB-infowindow-headerBg--light js-header\" style=\"background: #35AAE5;\">\n      {{#loading}}…{{/loading}}\n      <ul class=\"CDB-infowindow-list\">\n        {{#content.fields}}\n          {{^index}}\n            <li class=\"CDB-infowindow-listItem\">\n              {{#title}}<h5 class=\"CDB-infowindow-subtitle\">{{title}}</h5>{{/title}}\n              {{#value}}<h4 class=\"CDB-infowindow-title {{#type}}{{ type }}{{/type}}\">{{{ value }}}</h4>{{/value}}\n            </li>\n            {{^value}}{{/value}}\n          {{/index}}\n        {{/content.fields}}\n      </ul>\n    </div>\n    <div class=\"CDB-infowindow-inner js-inner\">\n      {{#loading}}\n        <div class=\"CDB-Loader js-loader is-visible\"></div>\n      {{/loading}}\n      <ul class=\"CDB-infowindow-list js-content\">\n        {{#content.fields}}\n          {{#index}}\n            <li class=\"CDB-infowindow-listItem\">\n              {{#title}}\n                <h5 class=\"CDB-infowindow-subtitle\">{{title}}</h5>\n              {{/title}}\n              {{#value}}\n                <h4 class=\"CDB-infowindow-title\">{{{ value }}}</h4>\n              {{/value}}\n              {{^value}}\n                <h4 class=\"CDB-infowindow-title\">NULL</h4>\n              {{/value}}\n            </li>\n          {{/index}}\n        {{/content.fields}}\n      </ul>\n    </div>\n    <div class=\"CDB-hook\">\n      <div class=\"CDB-hook-inner\"></div>\n    </div>\n  </div>\n</div>\n";

},{}],1105:[function(require,module,exports){
module.exports = "<div class=\"CDB-infowindow CDB-infowindow--dark js-infowindow\" style=\"background:#2E3C43\">\n  <div class=\"CDB-infowindow-close js-close\"></div>\n  <div class=\"CDB-infowindow-container\">\n    <div class=\"CDB-infowindow-bg\">\n      <div class=\"CDB-infowindow-inner\">\n        {{#loading}}\n          <div class=\"CDB-Loader js-loader is-visible\"></div>\n        {{/loading}}\n        <ul class=\"CDB-infowindow-list js-content\">\n          {{#content.fields}}\n          <li class=\"CDB-infowindow-listItem\">\n            {{#title}}<h5 class=\"CDB-infowindow-subtitle\">{{title}}</h5>{{/title}}\n            {{#value}}<h4 class=\"CDB-infowindow-title\">{{{ value }}}</h4>{{/value}}\n            {{^value}}<h4 class=\"CDB-infowindow-title\">null</h4>{{/value}}\n          </li>\n          {{/content.fields}}\n        </ul>\n      </div>\n    </div>\n    <div class=\"CDB-hook\">\n      <div class=\"CDB-hook-inner\"></div>\n    </div>\n  </div>\n</div>\n";

},{}],1106:[function(require,module,exports){
module.exports = "<div class=\"CDB-infowindow CDB-infowindow--light js-infowindow\" data-cover=\"true\">\n  <div class=\"CDB-infowindow-close js-close\"></div>\n  <div class=\"CDB-infowindow-container\">\n    <div class=\"CDB-infowindow-header CDB-infowindow-headerMedia js-header js-cover\">\n      {{#loading}}<div class=\"CDB-Loader js-loader\"></div>{{/loading}}\n      <div class=\"CDB-infowindow-mediaTitle\">\n        {{#content.fields.1}}\n          {{#value}}\n            <h4 class=\"CDB-infowindow-title\">\n              <span>{{{ value }}}</span>\n            </h4>\n          {{/value}}\n        {{/content.fields.1}}\n      </div>\n    </div>\n    <div class=\"CDB-infowindow-inner js-inner\">\n      {{#loading}}<div class=\"CDB-Loader js-loader\"></div>{{/loading}}\n      <div class=\"CDB-infowindow-list js-content\">\n        {{#content.fields}}\n          {{#index}}\n            <div class=\"CDB-infowindow-listItem CDB-infowindow-listItem--order{{index}}\">\n              {{#title}}<h5 class=\"CDB-infowindow-subtitle\">{{title}}</h5>{{/title}}\n              {{#value}}<h4 class=\"CDB-infowindow-title\">{{{ value }}}</h4>{{/value}}\n              {{^value}}<h4 class=\"CDB-infowindow-title\">null</h4>{{/value}}\n            </div>\n          {{/index}}\n        {{/content.fields}}\n      </div>\n    </div>\n    <div class=\"CDB-hook\">\n      <div class=\"CDB-hook-inner\"></div>\n    </div>\n  </div>\n</div>\n";

},{}],1107:[function(require,module,exports){
module.exports = "<div class=\"CDB-infowindow CDB-infowindow--light js-infowindow\">\n  <div class=\"CDB-infowindow-close js-close\"></div>\n  <div class=\"CDB-infowindow-container\">\n    <div class=\"CDB-infowindow-bg\">\n      <div class=\"CDB-infowindow-inner\">\n        {{#loading}}\n          <div class=\"CDB-Loader js-loader is-visible\"></div>\n        {{/loading}}\n        <ul class=\"CDB-infowindow-list js-content\">\n          {{#content.fields}}\n          <li class=\"CDB-infowindow-listItem\">\n            {{#title}}<h5 class=\"CDB-infowindow-subtitle\">{{title}}</h5>{{/title}}\n            {{#value}}<h4 class=\"CDB-infowindow-title\">{{{ value }}}</h4>{{/value}}\n            {{^value}}<h4 class=\"CDB-infowindow-title\">null</h4>{{/value}}\n          </li>\n          {{/content.fields}}\n        </ul>\n      </div>\n    </div>\n    <div class=\"CDB-hook\">\n      <div class=\"CDB-hook-inner\"></div>\n    </div>\n  </div>\n</div>\n";

},{}],1108:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-infowindow Infowindow-none js-infowindow">\n  <div class="CDB-infowindow-close js-close"></div>\n  <div class="CDB-infowindow-container">\n    <div class="CDB-infowindow-bg">\n      <div class="CDB-infowindow-inner">\n        <ul class="CDB-infowindow-list">\n          <li class="CDB-infowindow-listItem">\n            <h5 class="CDB-infowindow-subtitle">'+
((__t=( subtitle ))==null?'':_.escape(__t))+
'</h5>\n            <h4 class="CDB-infowindow-title">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h4>\n          </li>\n        </ul>\n      </div>\n    </div>\n    <div class="CDB-hook">\n      <div class="CDB-hook-inner"></div>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],1109:[function(require,module,exports){
module.exports = "<div class=\"CDB-infowindow CDB-infowindow--light js-infowindow\">\n  <div class=\"CDB-infowindow-close js-close\"></div>\n  <div class=\"CDB-infowindow-container\">\n    <div class=\"CDB-infowindow-header CDB-infowindow-headerBg CDB-infowindow-headerBg--light js-header\" style=\"background: #35AAE5;\">\n      {{#loading}}…{{/loading}}\n      <ul class=\"CDB-infowindow-list\">\n        {{#content.fields}}\n          {{^position}}\n        <li class=\"CDB-infowindow-listItem\">\n          {{#title}}\n            {{#alternative_name}}\n          <h5 class=\"CDB-infowindow-subtitle\">{{{alternative_name}}}</h5>\n            {{/alternative_name}}\n            {{^alternative_name}}\n          <h5 class=\"CDB-infowindow-subtitle\">{{{name}}}</h5>\n            {{/alternative_name}}\n          {{/title}}\n          {{#name}}\n          <h4 class=\"CDB-infowindow-title {{#type}}{{=<% %>=}}{{<%={{ }}=%>{{{ type }}}{{=<% %>=}}}}<%={{ }}=%>{{/type}}\">\n            {{=<% %>=}}{{<%={{ }}=%>{{{ name }}}{{=<% %>=}}}}<%={{ }}=%>\n          </h4>\n          {{/name}}\n        </li>\n          {{/position}}\n        {{/content.fields}}\n      </ul>\n    </div>\n    <div class=\"CDB-infowindow-inner js-inner\">\n      {{#loading}}\n        <div class=\"CDB-Loader js-loader is-visible\"></div>\n      {{/loading}}\n      <ul class=\"CDB-infowindow-list js-content\">\n        {{#content.fields}}\n          {{#position}}\n        <li class=\"CDB-infowindow-listItem\">\n          {{#title}}\n            {{#alternative_name}}\n          <h5 class=\"CDB-infowindow-subtitle\">{{{alternative_name}}}</h5>\n            {{/alternative_name}}\n            {{^alternative_name}}\n          <h5 class=\"CDB-infowindow-subtitle\">{{{name}}}</h5>\n            {{/alternative_name}}\n          {{/title}}\n          <h4 class=\"CDB-infowindow-title\">{{=<% %>=}}{{<%={{ }}=%>{{{ name }}}{{=<% %>=}}}}<%={{ }}=%></h4>\n        </li>\n          {{/position}}\n        {{/content.fields}}\n      </ul>\n    </div>\n    <div class=\"CDB-hook\">\n      <div class=\"CDB-hook-inner\"></div>\n    </div>\n  </div>\n</div>\n";

},{}],1110:[function(require,module,exports){
module.exports = "<div class=\"CDB-infowindow CDB-infowindow--dark js-infowindow\" style=\"background:#2E3C43\">\n  <div class=\"CDB-infowindow-close js-close\"></div>\n  <div class=\"CDB-infowindow-container\">\n    <div class=\"CDB-infowindow-bg\">\n      <div class=\"CDB-infowindow-inner\">\n        {{#loading}}\n          <div class=\"CDB-Loader js-loader is-visible\"></div>\n        {{/loading}}\n        <ul class=\"CDB-infowindow-list js-content\">\n          {{#content.fields}}\n          <li class=\"CDB-infowindow-listItem\">\n            {{#title}}\n              {{#alternative_name}}\n              <h5 class=\"CDB-infowindow-subtitle\">{{alternative_name}}</h5>\n              {{/alternative_name}}\n              {{^alternative_name}}\n              <h5 class=\"CDB-infowindow-subtitle\">{{name}}</h5>\n              {{/alternative_name}}\n            {{/title}}\n            <h4 class=\"CDB-infowindow-title\">{{=<% %>=}}{{<%={{ }}=%>{{{ name }}}{{=<% %>=}}}}<%={{ }}=%></h4>\n          </li>\n          {{/content.fields}}\n        </ul>\n      </div>\n    </div>\n    <div class=\"CDB-hook\">\n      <div class=\"CDB-hook-inner\"></div>\n    </div>\n  </div>\n</div>\n";

},{}],1111:[function(require,module,exports){
module.exports = "<div class=\"CDB-infowindow CDB-infowindow--light js-infowindow\" data-cover=\"true\">\n  <div class=\"CDB-infowindow-close js-close\"></div>\n  <div class=\"CDB-infowindow-container\">\n    <div class=\"CDB-infowindow-header CDB-infowindow-headerMedia js-header js-cover\">\n      {{#loading}}<div class=\"CDB-Loader js-loader\"></div>{{/loading}}\n      <div class=\"CDB-infowindow-mediaTitle\">\n        {{#content.fields.1}}\n        <h4 class=\"CDB-infowindow-title\">\n          <span>{{=<% %>=}}{{<%={{ }}=%>{{{ name }}}{{=<% %>=}}}}<%={{ }}=%></span>\n        </h4>\n        {{/content.fields.1}}\n      </div>\n    </div>\n    <div class=\"CDB-infowindow-inner js-inner\">\n      {{#loading}}<div class=\"CDB-Loader js-loader\"></div>{{/loading}}\n      <div class=\"CDB-infowindow-list js-content\">\n        {{#content.fields}}\n          {{#position}}\n        <div class=\"CDB-infowindow-listItem CDB-infowindow-listItem--order{{position}}\">\n            {{#title}}\n              {{#alternative_name}}\n          <h5 class=\"CDB-infowindow-subtitle\">{{{alternative_name}}}</h5>\n              {{/alternative_name}}\n              {{^alternative_name}}\n          <h5 class=\"CDB-infowindow-subtitle\">{{{name}}}</h5>\n              {{/alternative_name}}\n            {{/title}}\n          <h4 class=\"CDB-infowindow-title\">{{=<% %>=}}{{<%={{ }}=%>{{{ name }}}{{=<% %>=}}}}<%={{ }}=%></h4>\n        </div>\n          {{/position}}\n        {{/content.fields}}\n      </div>\n    </div>\n    <div class=\"CDB-hook\">\n      <div class=\"CDB-hook-inner\"></div>\n    </div>\n  </div>\n</div>\n";

},{}],1112:[function(require,module,exports){
module.exports = "<div class=\"CDB-infowindow CDB-infowindow--light js-infowindow\">\n  <div class=\"CDB-infowindow-close js-close\"></div>\n  <div class=\"CDB-infowindow-container\">\n    <div class=\"CDB-infowindow-bg\">\n      <div class=\"CDB-infowindow-inner\">\n        {{#loading}}\n          <div class=\"CDB-Loader js-loader is-visible\"></div>\n        {{/loading}}\n        <ul class=\"CDB-infowindow-list js-content\">\n          {{#content.fields}}\n          <li class=\"CDB-infowindow-listItem\">\n            {{#title}}\n              {{#alternative_name}}\n              <h5 class=\"CDB-infowindow-subtitle\">{{alternative_name}}</h5>\n              {{/alternative_name}}\n              {{^alternative_name}}\n              <h5 class=\"CDB-infowindow-subtitle\">{{name}}</h5>\n              {{/alternative_name}}\n            {{/title}}\n            <h4 class=\"CDB-infowindow-title\">{{=<% %>=}}{{<%={{ }}=%>{{{ name }}}{{=<% %>=}}}}<%={{ }}=%></h4>\n          </li>\n          {{/content.fields}}\n        </ul>\n      </div>\n    </div>\n    <div class=\"CDB-hook\">\n      <div class=\"CDB-hook-inner\"></div>\n    </div>\n  </div>\n</div>\n";

},{}],1113:[function(require,module,exports){
module.exports = "<div class=\"CDB-Tooltip CDB-Tooltip--isDark\">\n  <ul class=\"CDB-Tooltip-list\">\n    {{#fields}}\n      <li class=\"CDB-Tooltip-listItem\">\n        {{#title}}\n          <h3 class=\"CDB-Tooltip-listTitle\">{{{ title }}}</h3>\n        {{/title}}\n        <h4 class=\"CDB-Tooltip-listText\">{{{ value }}}</h4>\n      </li>\n    {{/fields}}\n  </ul>\n</div>\n";

},{}],1114:[function(require,module,exports){
module.exports = "<div class=\"CDB-Tooltip CDB-Tooltip--isLight\">\n  <ul class=\"CDB-Tooltip-list\">\n    {{#fields}}\n      <li class=\"CDB-Tooltip-listItem\">\n        {{#title}}\n          <h3 class=\"CDB-Tooltip-listTitle\">{{{ title }}}</h3>\n        {{/title}}\n        <h4 class=\"CDB-Tooltip-listText\">{{{ value }}}</h4>\n      </li>\n    {{/fields}}\n  </ul>\n</div>\n";

},{}],1115:[function(require,module,exports){
module.exports = "<div class=\"CDB-Tooltip CDB-Tooltip--isDark\">\n  <ul class=\"CDB-Tooltip-list\">\n    {{#content.fields}}\n      <li class=\"CDB-Tooltip-listItem\">\n        {{#title}}\n          <h3 class=\"CDB-Tooltip-listTitle\">{{{ name }}}</h3>\n        {{/title}}\n        <h4 class=\"CDB-Tooltip-listText\">{{=<% %>=}}{{<%={{ }}=%>{{{ name }}}{{=<% %>=}}}}<%={{ }}=%></h4>\n      </li>\n    {{/content.fields}}\n  </ul>\n</div>\n";

},{}],1116:[function(require,module,exports){
module.exports = "<div class=\"CDB-Tooltip CDB-Tooltip--isLight\">\n  <ul class=\"CDB-Tooltip-list\">\n    {{#content.fields}}\n      <li class=\"CDB-Tooltip-listItem\">\n        {{#title}}\n          <h3 class=\"CDB-Tooltip-listTitle\">{{{ name }}}</h3>\n        {{/title}}\n        <h4 class=\"CDB-Tooltip-listText\">{{=<% %>=}}{{<%={{ }}=%>{{{ name }}}{{=<% %>=}}}}<%={{ }}=%></h4>\n      </li>\n    {{/content.fields}}\n  </ul>\n</div>\n";

},{}],1117:[function(require,module,exports){
/*
 *  Track geometry changes that happens in any Node definition model
 */

module.exports = {
  track: function (params) {
    if (!params) throw new Error('several parameters required');
    if (!params.layerDefinitionsCollection) throw new Error('layerDefinitionsCollection is required');
    if (!params.analysisDefinitionNodesCollection) throw new Error('analysisDefinitionNodesCollection is required');
    if (!params.analysisDefinitionsCollection) throw new Error('analysisDefinitionsCollection is required');

    this._layerDefinitionsCollection = params.layerDefinitionsCollection;
    this._analysisDefinitionsCollection = params.analysisDefinitionsCollection;

    params.analysisDefinitionNodesCollection.bind('change:simple_geom', this._onNodeGeometryChange, this);
  },

  _onNodeGeometryChange: function (nodeDefModel) {
    if (nodeDefModel.get('table_name')) { // If it is a source node, no save
      return;
    }
    var layerDefModel = this._layerDefinitionsCollection.findWhere({ source: nodeDefModel.get('id') });
    if (layerDefModel) {
      this._analysisDefinitionsCollection.saveAnalysisForLayer(layerDefModel);
    }
  }
};

},{}],1118:[function(require,module,exports){
var _ = require('underscore');
var Notifier = require('./components/notifier/notifier');

var NOTIFICATION_ERROR_TEMPLATE = _.template("<span class='CDB-Text u-errorTextColor'><%- title %></span>");
var NOTIFICATION_PREFIX = 'sql-notifications';

var SQLNotifications = {
  track: function (view) {
    // In order to not bloat the notification center we will create
    // only one notification, and update it along the way
    this._notificationId = NOTIFICATION_PREFIX;
  },

  removeNotification: function () {
    Notifier.removeNotification(this._notificationId);
  },

  showNotification: function (attrs) {
    this._addOrUpdateNotification(this._notificationId, attrs);
  },

  showErrorNotification: function (errors) {
    var notificationAttrs = {
      status: 'error',
      info: _t('notifications.sql.error.body', {
        body: NOTIFICATION_ERROR_TEMPLATE({
          title: _t('notifications.sql.error.title')
        }),
        error: this._transformErrors(errors)
      }),
      closable: false
    };

    this._addOrUpdateNotification(this._notificationId, notificationAttrs);
  },

  _transformErrors: function (errors) {
    return _.map(errors, function (err) {
      return err.message;
    }, this).join('. ');
  },

  _addOrUpdateNotification: function (notificationId, notificationAttrs) {
    var notification = this._getNotification(notificationId);
    if (notification) {
      notification.set(notificationAttrs);
    } else {
      this._addNotification(notificationId, notificationAttrs);
    }
  },

  _addNotification: function (notificationId, notificationAttrs) {
    notificationAttrs = _.extend({
      id: notificationId
    }, notificationAttrs);
    Notifier.addNotification(notificationAttrs);
  },

  _getNotification: function (notificationId) {
    return Notifier.getNotification(notificationId);
  }
};

module.exports = SQLNotifications;

},{"./components/notifier/notifier":475,"underscore":"underscore"}],1119:[function(require,module,exports){
var _ = require('underscore');

var SOURCE_ID_REGEX = /^([a-z]+)(\d*)$/; // matches a string with one or more letters + numbers, e.g. 'b2'

var newId = function (id, seqChange) {
  if (!id || !id.match) throw new Error('invalid id');

  var matches = id.match(SOURCE_ID_REGEX);
  matches[2] = matches[2] || -1;

  if (matches && matches.length === 3) {
    // letter + next number
    var letter = matches[1];
    var seq = parseInt(matches[2], 10) + seqChange;
    return letter + Math.max(seq, 0);
  } else {
    throw new Error('invalid id');
  }
};

/**
 * Encapsulates logic related to the nodes' IDs.
 */
module.exports = {

  /**
   * Get next id in sequence of given source id.
   * @param {String} id, e.g. 'c2'
   * @return {String} e.g. 'c3'
   */
  next: function (id) {
    return newId(id, 1);
  },

  prev: function (id) {
    return newId(id, -1);
  },

  /**
   * Get the letter representation.
   * @param {String, Object} sourceId or backbone model that have id. e.g. 'c2'
   * @return {String} e.g. 'c' or an empty string if there is no letter in the given id
   */
  letter: function (sourceId) {
    if (!sourceId || !_.isString(sourceId)) return '';
    var match = sourceId.match(/^([a-z]+)/);
    return _.isArray(match) && match[0] || '';
  },

  /**
   * Get the sequence representation.
   * @param {String, Object} sourceId or backbone model that have id. e.g. 'c2'
   * @return {Number} e.g. 2 or undefined if there is no sequence
   */
  sequence: function (sourceId) {
    if (!sourceId || !_.isString(sourceId)) return;
    var match = sourceId.match(/(\d+$)/);
    return _.isArray(match) && match[0] || undefined;
  },

  changeLetter: function (id, newLetter) {
    var seq = id.match(/(\d+)$/)[0];
    return newLetter + seq;
  }

};

},{"underscore":"underscore"}],1120:[function(require,module,exports){
var _ = require('underscore');

/**
 * Value object to calcualte distances
 */
module.exports = {
  OPTIONS: [
    {
      distance: 'meters',
      metersPerDistance: 1
    }, {
      distance: 'kilometers',
      metersPerDistance: 1000
    }, {
      distance: 'miles',
      metersPerDistance: 1609.34
    }
  ],

  /**
   * @param {Number} val - e.g. 3
   * @param {String} distance - e.g. 'kilometers'
   * @param {Float} e.g. 3000
   */
  toMeters: function (val, distance) {
    val = parseFloat(val);
    if (isNaN(val)) throw new Error('val (1st arg) is required, expected a parseable number or float');

    var option = _.find(this.OPTIONS, function (d) {
      return d.distance === distance;
    });
    if (!option) throw new Error(distance + ' (2nd arg) is not a valid distance value, expects one of ' + _.pluck(this.OPTIONS, 'distance').join(', '));

    return val * option.metersPerDistance;
  },

  toDistance: function (meters, distance) {
    meters = parseFloat(meters);
    if (isNaN(meters)) throw new Error('meters (1st arg) is required');

    var option = _.find(this.OPTIONS, function (d) {
      return d.distance === distance;
    });
    if (!option) throw new Error(distance + ' (2nd arg) is not a valid distance value, expects one of ' + _.pluck(this.OPTIONS, 'distance').join(', '));

    return meters / option.metersPerDistance;
  }
};

},{"underscore":"underscore"}],1121:[function(require,module,exports){
var _ = require('underscore');
var Notifier = require('./components/notifier/notifier');

var NOTIFICATION_ID = 'visNotification';
var NOTIFICATION_TEMPLATE = _.template("<span class='CDB-Text is-semibold u-errorTextColor'><%= title %></span>&nbsp;<%= body %>");
var ERROR_NOTIFICATION_TEMPLATE = _.template('<%- message %> <%- body %>');

var VisNotifications = {

  track: function (vis) {
    vis.on('change:error', this._toggleVisErrorNotification, this);
    this._toggleVisErrorNotification(vis);
  },

  _toggleVisErrorNotification: function (vis) {
    var error = vis.get('error');
    if (error) {
      this._showVisErrorNotification(error.message);
    } else {
      this._hideVisErrorNotification();
    }
  },

  _showVisErrorNotification: function (message) {
    Notifier.addNotification(this._getNotificationAttrs(message));
  },

  _hideVisErrorNotification: function () {
    if (Notifier.getNotification(NOTIFICATION_ID)) {
      Notifier.removeNotification(NOTIFICATION_ID);
    }
  },

  _getNotificationAttrs: function (message) {
    var body = _t('notifications.vis.failed.body');
    if (message) {
      body = ERROR_NOTIFICATION_TEMPLATE({
        message: this._period(message),
        body: body
      });
    }

    return {
      id: NOTIFICATION_ID,
      status: 'error',
      info: NOTIFICATION_TEMPLATE({
        title: _t('notifications.vis.failed.title'),
        body: body
      }),
      closable: false
    };
  },

  _period: function (text) {
    if (text && !/\.$/.test(text)) {
      return text + '.';
    }
    return text;
  }
};

module.exports = VisNotifications;

},{"./components/notifier/notifier":475,"underscore":"underscore"}],1122:[function(require,module,exports){
var _ = require('underscore');
var Notifier = require('./components/notifier/notifier');
var errorParser = require('./helpers/error-parser');

var NOTIFICATION_ERROR_TEMPLATE = _.template("<span class='u-errorTextColor'><%- title %></span>");

var WidgetsNotifications = {

  track: function (widgetsCollection) {
    this._widgetDefinitionsCollection = widgetsCollection;
    this._widgetDefinitionsCollection.on('success', this._showAddNotification, this);
    this._widgetDefinitionsCollection.on('destroy', this._showRemoveNotification, this);
    this._widgetDefinitionsCollection.on('error', this._showErrorNotification, this);
    this._widgetDefinitionsCollection.on('loading', this._showLoadingNotification, this);
    this._widgetDefinitionsCollection.on('updating', this._showUpdatingNotification, this);
  },

  _showLoadingNotification: function (widgetOptionModel) {
    var notificationId = widgetOptionModel.cid;
    var notificationAttrs = {
      status: 'loading',
      info: _t('notifications.widgets.loading'),
      closable: false
    };

    this._addNotification(notificationId, notificationAttrs);
  },

  _showUpdatingNotification: function (widgetOptionModel) {
    var notificationId = widgetOptionModel.cid;
    var notificationAttrs = {
      status: 'loading',
      info: _t('notifications.widgets.updating'),
      closable: false
    };

    this._addNotification(notificationId, notificationAttrs);
  },

  _showRemoveNotification: function (widgetModel) {
    if (widgetModel.get('avoidNotification') === true) {
      return;
    }

    var notificationAttrs = {
      status: 'success',
      info: _t('notifications.widgets.delete'),
      closable: true,
      delay: Notifier.DEFAULT_DELAY
    };
    this._addNotification(widgetModel.cid, notificationAttrs);
  },

  _showAddNotification: function (widgetOptionModel) {
    var notificationId = widgetOptionModel.cid;
    var notificationAttrs = {
      status: 'success',
      info: _t('notifications.widgets.success'),
      closable: true
    };
    this._addOrUpdateNotification(notificationId, notificationAttrs);
  },

  _showErrorNotification: function (widgetOptionModel, error) {
    var notificationId = widgetOptionModel.cid;
    var notificationAttrs = {
      status: 'error',
      info: _t('notifications.widgets.error.body', {
        body: NOTIFICATION_ERROR_TEMPLATE({
          title: _t('notifications.widgets.error.title')
        }),
        error: errorParser(error)
      }),
      closable: true
    };
    this._addOrUpdateNotification(notificationId, notificationAttrs);
  },

  _addOrUpdateNotification: function (notificationId, notificationAttrs) {
    var notification = this._getNotification(notificationId);
    if (notification) {
      notification.set(notificationAttrs);
    } else {
      this._addNotification(notificationId, notificationAttrs);
    }
  },

  _addNotification: function (notificationId, notificationAttrs) {
    notificationAttrs = _.extend({
      id: notificationId
    }, notificationAttrs);
    Notifier.addNotification(notificationAttrs);
  },

  _getNotification: function (notificationId) {
    return Notifier.getNotification(notificationId);
  }
};

module.exports = WidgetsNotifications;

},{"./components/notifier/notifier":475,"./helpers/error-parser":1090,"underscore":"underscore"}],1123:[function(require,module,exports){
module.exports={
  "feedback": "Give us feedback!",
  "user": {
    "you": "You"
  },
  "months": {
    "january": "January",
    "february": "February",
    "march": "March",
    "april": "April",
    "may": "May",
    "june": "June",
    "july": "July",
    "august": "August",
    "september": "September",
    "october": "October",
    "november": "November",
    "december": "December"
  },
  "assets": {
    "maki-icons": {
      "disclaimer": "<a href='https://github.com/mapbox/maki' target='_blank'>Maki Icons</a>, an open source project by <a href='http://mapbox.com' target='_blank'>Mapbox</a>"
    }
  },
  "operators": {
    "count": "COUNT",
    "sum": "SUM",
    "avg": "AVG",
    "min": "MIN",
    "max": "MAX"
  },
  "builder-activated-notification": {
    "message": "CARTO Builder has been activated in your account. <a href='https://carto.com/learn/guides' class='onboardingNotification-link'>Learn more</a> about it and let us know what you think or <a href='mailto:builder-support@carto.com' class='onboardingNotification-link'>contact us</a>. Happy mapping!"
  },
  "builder-onboarding": {
    "title": "Welcome to Builder,",
    "description": "Discover the new and exciting analyses you can perform with location intelligence.",
    "take-tour": "Take a tour",
    "edit-map": "Edit your map",
    "toolbar": {
      "title": "Toolbar",
      "description": "The toolbar provides options to access your dashboard, edit your map, and configure its settings."
    },
    "configurator": {
      "title": "Edit pane",
      "description": "Manage all the components of your map: add layers and widgets, import datasets, customize analyses, and change styles."
    },
    "map": {
      "title": "Map",
      "description": "Your map reflects changes instantly."
    },
    "widgets": {
      "title": "Widgets pane",
      "description": "The widgets you add to your map appear directly on your visualization."
    },
    "skip": "skip",
    "next": "next"
  },
  "data-onboarding": {
    "title": "Welcome to the layer pane",
    "description": "Analyze, style, and enhance your data with pop-ups and&nbsp;legends.",
    "take-tour": "Take the tour",
    "edit-layer": "Edit layer",
    "layer-options": {
      "title": "Layer options",
      "description": "Layers can be renamed by double-clicking on the layer name, centered by clicking in the crosshair, and exported through their contextual menu."
    },
    "data-tab": {
      "title": "Data tab",
      "description": "Style, add analysis, pop-ups, and legends to layers. To further explore your data, add widgets."
    },
    "sql-editor": {
      "title": "SQL View",
      "description": "Data layers can be edited and processed by using the SQL view at the bottom of the screen."
    },
    "add-geometry": {
      "title": "Add geometries and switch to dataset view",
      "description": "You can switch between map or data view. In map view, you can add points, lines, and polygons.",
      "edit-layer": "Edit layer"
    },
    "exit": "Exit tour",
    "next": "Next"
  },
  "analysis-onboarding": {
    "title": "The Art of Analysis",
    "description": "Build reproducible workflows for analyzing and explaining your data. Analyses turn your maps into Location Intelligence apps.",
    "description-list": {
      "item1": "Different analyses can be chained",
      "item2": "Analyses are dynamic. When the data changes, the analysis is&nbsp;refreshed.",
      "item3": "The original data is not modified by the analysis workflow.",
      "item4": "Some analysis queries add calculated results to columns in your dataset."
    },
    "done": "Done",
    "add-analysis": "Add analysis",
    "never-show-message": "Don't show me this again."
  },
  "style-onboarding": {
    "title": "Style this map!",
    "description": "Apply aggregation styling to maps and define options by geometry attributes or by a column value.",
    "aggregation": {
      "title": "How would you like to aggregate your data?",
      "description": "Map types are called \"Aggregation\". Add Torque, Heatmap, and other aggregation styles to data."
    },
    "style": {
      "title": "Make it beautiful!",
      "description": "Use these options to style your data in beautiful ways. For example, you can create thematic maps by altering the FILL option by value.",
      "short-description": "Use these options to style your data in beautiful ways."
    },
    "cartocss": {
      "title": "Dress it up with CartoCSS",
      "description": "Further style data by using the CartoCSS view at the bottom of the screen."
    },
    "take-tour": "Take the tour",
    "style-layer": "Style layer",
    "never-show-message": "Don't show me this again.",
    "exit": "Exit tour",
    "next": "Next"
  },
  "analyses-onboarding": {
    "placeholders": {
      "layer-name": "NAME OF THE LAYER",
      "clusters": "CLUSTERS",
      "method": "METHOD",
      "percentage": "PERCENTAGE"
    },
    "done": "Done",
    "finished": "has finished",
    "style-analysis": "Style this analysis",
    "read-more": "Read more in documentation",
    "learn-more": "Learn more",
    "never-show-message": "Don't show me this again.",
    "no-new-columns": "No new columns were created.",
    "geometries-updated": "The geometries in your table were updated",
    "new-column-added": "A new column has been added to your dataset.",
    "new-columns-created": "New columns have been created as a new dataset.",
    "new-column-included": "A new column has been included with your original data.",
    "new-columns-included": "New columns has been included with your original data.",
    "new-columns-included-based-on-input": "New columns have been included with your original data based on the columns chosen for the input.",
    "sampling": {
      "title": "Subsample of rows",
      "description": "A sample of your original table was randomly selected to give approximately a percentage of the rows from your input dataset."
    },
    "merge": {
      "title": "Join columns from 2nd layer",
      "description": "This analysis performed a columnar JOIN in order to get columns from two different tables."
    },
    "intersection": {
      "title": "Filter points in polygons",
      "description": "This analysis performs a spatial intersection, returning only the rows from the target layer which intersect with geometries in the source layer.",
      "source-cartodb-id": "This number represents the cartodb_id of the source geometry"
    },
    "area-of-influence": {
      "title": "Create areas of influence",
      "description": "Area of influence creates polygons according to the parameters set by the user.",
      "the-geom": "This column was updated to show the area of influence requested."
    },
    "aggregate-intersection": {
      "title": "Intersect second layer",
      "description": "This operation performs a spatial intersection and aggregates the geometry values from the target layer that intersect with the geometry of the source layer.",
      "count-vals-density": "This column is added if COUNT was chosen as the aggregation operation",
      "extra-column": "This column is added if {operation_type} is chosen with column {column_name}"
    },
    "filter": {
      "title": "Row filtering",
      "description": "Row filtering allows you to quickly narrow down the total data you display on a map or input into an analysis node."
    },
    "filter-by-node-column": {
      "title": "Filter by layer",
      "description": "Filter by layer allows you to filter the data in your layer by propagating the filters in the attached layer. Now if you filter on widgets added to the first node, the results in the second node would be also filtered."
    },
    "spatial-markov-trend": {
      "trend": "The normalized trend for each geometry",
      "trend_up": "The probability that a geometry's value will move to a higher class",
      "trend_down": "The probability that a geometry's value will move to a lower class",
      "volatility": "A measure of the potential for a geometry to possess values in other classes",
      "description": "Trends and volatility are calculated based on the time series data input. Trends calculated from inputs with a longer history are more precise. Inputs for the time column should equally spaced (e.g., all one week/month/year apart)."
    },
    "moran": {
      "title": "Detect outliers and clusters",
      "description": "Detect outliers and clusters finds areas in your data where clusters of high values or low values exist, as well as areas which are dissimilar from their neighbors.",
      "quads": "Classification of the geometry from the analysis",
      "significance": "The statistical significance of the geometry's classification of one of four quadrant types.",
      "moran": "The local statistic calculated from the Moran's I analysis for each geometry/value in the dataset.",
      "rowid": "The original row id of the geometry (cartodb_id)."
    },
    "kmeans": {
      "title": "Calculating point clusters",
      "cluster-no": "A numeric identifier for each cluster in your dataset. Values start at 1 and go up to the %{clusters} clusters you requested (or max rows if less).",
      "description": "Point clustering is uses k-means to calculate a predefined number of clusters from your data."
    },
    "data-observatory-measure": {
      "title": "Enrich from the Data Observatory",
      "custom-column": "This column contains the data requested from the Data Observatory",
      "description": "The Data Observatory enrichment is the result of the geometry location and the measure requested."
    },
    "connect-with-lines": {
      "title": "Connect with lines",
      "description": "Create lines from point datasets using a variety of methods",
      "the-geom": "This column was updated to be lines according to the method chosen.",
      "line-sequential": "This analysis creates a line by connecting all points in the dataset in a specified order",
      "line-source-to-target": "Link a source point to a target point based on a shared attribute",
      "line-to-column": "Create lines from a point to to a geometry stored in another column",
      "line-to-single-point": "Connect the coordinate from latitude and longitude columns to the point geometry (`the_geom`) in your dataset."
    },
    "group-points": {
      "title": "Group points into polygons",
      "the-geom": "This column was updated to polygons encompassing the input points.",
      "category": "This will be the category over which the polygons were calculated",
      "description": "Group points into polygons to create new polygons."
    },
    "georeference": {
      "title": "Georeference",
      "the-geom": "This column, which stores the geographic information in your dataset, has been updated to reflect the boundaries or locations from the inputs specified.",
      "description": "Georeferencing data is a service that uses information from many sources to get the geographical information associated with latitude/longitude columns, city names, postal codes, administrative boundaries, IP addresses, or street addresses."
    },
    "centroid": {
      "title": "Calculating centroids from geometries",
      "description": "Centroids are calculated from all, groups, or singular geometries. Using the optional parameters of Category, Aggregate, and Weight you can change how they are calculated and what information the result will contain. ",
      "the-geom": "Point geometries representing the centroid(s) of your input data.",
      "aggregated-value": "Stores the aggregate value for each centroid.",
      "non-aggregated-value": "Contains the count of features considered for each centroid",
      "category": "Stores the category value for each centroid from the source dataset"
    },
    "closest": {
      "description": "Find nearest analysis locates the closest points between two tables.",
      "source_cdb_id": "This column has been created with the related points id from the source table.",
      "the-geom": "This column has been updated with the target table geometries.",
      "title": "Find nearest"
    }
  },
  "analyses": {
    "connect-with-lines": {
      "title": "Connect with lines",
      "short-title": "Connect with lines"
    },
    "georeference": {
      "title": "Georeference",
      "short-title": "Georeference"
    },
    "data-observatory-measure": {
      "title": "Enrich from Data Observatory",
      "short-title": "Data observatory",
      "age-and-gender": "Age and Gender",
      "boundaries": "Boundaries",
      "education": "Education",
      "employment": "Employment",
      "families": "Families",
      "housing": "Housing",
      "income": "Income",
      "language": "Language",
      "migration": "Migration",
      "nationality": "Nationality",
      "population-segments": "Population segments",
      "race-and-ethnicity": "Race and Ethnicity",
      "religion": "Religion",
      "transportation": "Transportation",
      "filters": "Filters"
    },
    "merge": {
      "title": "Join columns from 2nd layer",
      "short-title": "Join columns"
    },
    "filter-by-node-column": {
      "title": "Filter by layer",
      "short-title": "Filter by layer"
    },
    "centroid": {
      "title": "Centroid from geometries",
      "short-title": "Centroid"
    },
    "group-points": {
      "title": "Group points into polygons",
      "short-title": "Group points"
    },
    "convex-hull": {
      "title": "Convex Hull",
      "short-title": "Convex Hull"
    },
    "concave-hull": {
      "title": "Concave Hull",
      "short-title": "Concave Hull"
    },
    "bounding-box": {
      "title": "Bounding Box",
      "short-title": "Bounding Box"
    },
    "bounding-circle": {
      "title": "Bounding Circle",
      "short-title": "Bounding Circle"
    },
    "area-of-influence": {
      "title": "Create areas of influence",
      "short-title": "AOI"
    },
    "filter-intersection": {
      "title": "Filter points in polygons",
      "short-title": "Filter points in polygons"
    },
    "aggregate-intersection": {
      "title": "Aggregate intersection",
      "short-title": "Aggregate intersection"
    },
    "filter": {
      "title": "Filter by column value",
      "short-title": "Filter"
    },
    "sampling": {
      "title": "Subsample percent of rows",
      "short-title": "Sampling"
    },
    "kmeans": {
      "title": "Calculate clusters of points",
      "short-title": "Clusters"
    },
    "moran-cluster": {
      "title": "Detect outliers and clusters",
      "short-title": "Outliers & clusters"
    },
    "spatial-markov-trend": {
      "title": "Predict trends and volatility",
      "short-title": "Trends"
    },
    "source": "Source",
    "routing": {
      "short-title": "Routing"
    }
  },
  "analysis-category": {
    "all": "All",
    "analyze-predict": "Analyze and predict",
    "create-clean": "Create and clean",
    "data-transformation": "Transform"
  },
  "form-components": {
    "editors": {
      "radio": {
        "true": "True",
        "false": "False",
        "null": "Null"
      },
      "fill": {
        "customize": "Custom color set",
        "quantification": {
          "title": "Quantification",
          "methods": {
            "jenks": "Jenks",
            "equal": "Equal Interval",
            "headtails": "Heads/Tails",
            "quantiles": "Quantiles",
            "category": "Category"
          }
        },
        "bins": "Buckets",
        "input-color": {
          "solid": "Solid",
          "value": "By value",
          "img": "Img"
        },
        "input-number": {
          "fixed": "Fixed",
          "value": "By value"
        },
        "input-ramp": {
          "buckets": "bucket |||| buckets"
        },
        "input-categories": {
          "null": "null",
          "others": "Others"
        },
        "image": {
          "recently-title": "Most used",
          "none": "None",
          "show-all": "Show full collections"
        }
      }
    }
  },
  "data": {
    "import-model": {
      "error-title": "There was an error",
      "error-starting-import": "Unfortunately, there was an error starting the import"
    },
    "upload-model": {
      "invalid-import": "Invalid import",
      "one-file": "Unfortunately, only one file is allowed per upload",
      "file-defined": "File name should be defined",
      "file-extension": "Unfortunately, this file extension is not allowed",
      "file-size": "Unfortunately, the size of the file is bigger than your remaining quota",
      "visualization-id": "The remote visualization id was not specified",
      "remote-file-size": "Unfortunately, the size of the remote dataset is bigger than your remaining quota",
      "url-invalid": "Unfortunately, the URL provided is not valid",
      "error-happened": "There was an error",
      "connection-error": "Unfortunately, there was a connection error",
      "twitter-dates-invalid": "Twitter dates are not valid",
      "twitter-dates-empty": "Twitter dates are empty",
      "twitter-categories-invalid": "Twitter categories are not valid",
      "twitter-data": "Twitter data is empty",
      "dataset-copy-undefined": "Dataset copy is not defined",
      "query-undefined": "Query is not provided"
    },
    "analysis-definition-node-model": {
      "validation": {
        "missing-required": "Required",
        "invalid-source": "Invalid source",
        "invalid-value": "Invalid value",
        "invalid-enum": "Invalid value, must be any of %{expectedValues}"
      }
    }
  },
  "components": {
    "geocoding": {
      "geocoding-error-details": {
        "close": "close",
        "description": "There was a problem georeferencing your data",
        "title": "Geocoding Error",
        "try-again": "Please try again and if the problem persists, <a href='mailto:support@carto.com?subject=Geocoding error with id:%{id}'>contact us</a> with the following code:",
        "view-dataset": "view dataset"
      },
      "geocoding-success-detail": {
        "amount-charged": "<strong>$%{price}</strong> will be charged to your account",
        "credits-consumed": "You have consumed all your credits during this billing cycle, price is $%{price} / 1,000 extra credits.",
        "description": "We've successfully geocoded <%- realRowsFormatted %> <%- geometryType %> of <%- processableRowsFormatted %>. |||| We've successfully geocoded <%- realRowsFormatted %> <%- geometryType %>s of <%- processableRowsFormatted %>.",
        "explanation": "Rows that are not geocoded could have errors in their column values, or don’t exist in our data. Try geocoding again and check the 'override all values' to try again.",
        "no-extra-charge": "No extra charges have been done",
        "remainingQuotaFormatted": "You still have %{remainingQuotaFormatted} credits left for this month.",
        "title": "Data geocoded",
        "try-again": "Unsuccessful rows don't count against your quota, so we encourage you to take a look and try again.",
        "view-dataset": "view dataset"
      },
      "geocoding-no-result-details": {
        "close": "close",
        "description": "These rows contained empty values or perhaps we just didn't know what the values meant. We encourage you to take a look and try again.",
        "title": "No rows were georeferenced",
        "view-dataset": "view dataset"
      }
    },
    "background-importer": {
      "background-importer-item": {
        "completed": "completed",
        "error-connecting": "<span class='u-errorTextColor'>Error connecting</span> %{name}",
        "from": "from",
        "show": "show"
      },
      "warnings-details": {
        "continue-btn": "Continue",
        "find-connected-datasets": "You can find all the connected datasets under the datasets section.",
        "no-more-datasets": "No more than %{maxTablesPerImport} datasets can be imported from a single file.",
        "unable-to-import-datasets": "Unable to import all datasets in file"
      },
      "partial-import-details": {
        "find-connected-datasets": "You can find all the connected datasets under the datasets section.",
        "continue-btn": "Continue",
        "too-many-datasets": "NOTE: The file you uploaded contained too many datasets. No more than %{maxTablesPerImport} datasets can be imported from a single file.",
        "unable-to-import-as-layers": "Unable to add all imported datasets as layers",
        "upgrade-your-account": "<a href='https://carto.com/pricing/'>Upgrade your account</a> to add more than %{userMaxLayers} layers to your maps."
      },
      "connector-warning-details": {
        "continue-btn": "Continue",
        "too-many-rows": "You may have reached the maximum limit.",
        "unable-to-import-all-rows": "For a database connector import, the number of rows allowed is %{maxRowsPerConnectorImport}. Some of your data may not be imported."
      },
      "error-details": {
        "check-errors": "Check errors",
        "check-url": "Check that the URL you provided is OK",
        "close": "close",
        "dont-panic": "Don’t panic, here's some info that might help",
        "remote-server-code": "The remote server returned a <span class='ErrorDetails-itemTextStrong'>%{httpResponseCode}</span> code.",
        "send-us-the-error-code": "Persisting error? Please <a href='mailto:support@carto.com'>send us</a> the following code",
        "unknown-error": "An unknown error has happened"
      },
      "upgrade-errors": {
        "8001": {
          "description": "Remove some of your datasets to gain available space or upgrade your account",
          "info": "Keep your data and get a larger quota by upgrading your plan",
          "title": "Your quota has run out"
        },
        "8005": {
          "description": "Remove any layer or upgrade your account",
          "info": "Keep your maps and get more layer count quota by upgrading your plan",
          "title": "You have reached your layer count limit"
        },
        "upgrade": "upgrade"
      },
      "twitter-import-details": {
        "new-type-created": "We've created a new dataset containing a total of %{datasetTotalRowsFormatted}<br/>tweet%{tweetPlural} with your search terms",
        "credit-left": "You still have %{availableTweetsFormatted} credit left for this billing cycle.",
        "credits-left": "You still have %{availableTweetsFormatted} credits left for this billing cycle.",
        "no-more-credits": "You have consumed all your credits during this billing cycle (price is $%{blockPriceFormatted}/%{blockSizeFormatted} extra credits).",
        "twitter-import-title": "Your Twitter dataset is created",
        "tweet-cost": {
          "free": "No extra charges have been applied",
          "paid": "$%{tweetsCostFormatted} will be charged to your account"
        },
        "errors": {
          "no-results": "Your search query was correct but returned no results, \n please try with a different set of parameters before running it again"
        }
      },
      "background-geocoding-item": {
        "geocoded": "%{realRowsFormatted}/%{processableRowsFormatted} row geocoded… |||| %{realRowsFormatted}/%{processableRowsFormatted} rows geocoded…",
        "geocoded-by-lat-lng": "Geocoded by latitude and longitude",
        "geocoding": "Geocoding %{tableName} dataset…",
        "show": "show",
        "rows-geocoded": {
          "without-dataset": "%{realRowsFormatted} row geocoded |||| %{realRowsFormatted} rows geocoded",
          "in-dataset": "%{realRowsFormatted} row geocoded in %{tableName} dataset|||| %{realRowsFormatted} rows geocoded in %{tableName} dataset"
        },
        "errors": {
          "no-rows-geocoded": {
            "without-dataset": "No rows geocoded",
            "in-dataset": "No rows geocoded in %{tableName} dataset"
          },
          "geocoding-layer": "Ouch! There was an error geocoding %{tableName} layer"
        }
      },
      "background-import-limit": {
        "hurry": "In a hurry? <a href='%{upgradeUrl}'>Upgrade your account</a> to import several files at a time",
        "one-file": "Unfortunately, you can only import up to %{importQuota} files at the same time"
      },
      "free-trial": "Get a %{days} day free trial",
      "connecting": "Connecting",
      "dataset": "dataset…",
      "geocoding": "Geocoding",
      "working": "Working…"
    },
    "likes-pluralize": "like |||| likes",
    "custom-list": {
      "placeholder": "Search by %{typeLabel}",
      "no-items": "There are no %{typeLabel} items",
      "no-results": "No %{typeLabel} results found with '%{query}'",
      "add-custom-result": "Add custom value"
    },
    "datepicker": {
      "dates-placeholder": "Choose your dates",
      "get-last": "Get last",
      "hour": "hour",
      "min": "min",
      "from": "from",
      "to": "to",
      "or": "or",
      "days-pluralize": "1 day |||| %{smart_count} days",
      "weeks-pluralize": "1 week |||| %{smart_count} weeks",
      "hours-pluralize": "hour week |||| %{smart_count} hours",
      "gmt-convertion": "Date will be converted to GMT +0",
      "invalid-date": "Invalid date"
    },
    "taglist": {
      "none": "No tags",
      "placeholder": "Add tags"
    },
    "pagination-search": {
      "filter": {
        "search": "Search",
        "placeholder": "Search by username or email"
      },
      "loading": {
        "title": "Loading..."
      },
      "error": {
        "title": "Error",
        "desc": "Oops there was an error."
      },
      "no-results": {
        "title": "Oh! No results",
        "desc": "Unfortunately we could not find anything with these parameters"
      }
    },
    "modals": {
      "editor-vis-warning": {
        "title": "You are about to open an Editor map with the new Builder",
        "explanation": "Builder offers an easy-to-use and intuitive drag and drop functionality to analyze and visualize your data. However, some of the old Editor features, such as overlays, are not currently available in Builder.",
        "question": "Opening your map in Builder may cause the loss of any feature not supported yet. Are you sure you want to continue?",
        "go-back": "No, go back to dashboard",
        "open": "Yes, open with Builder",
        "duplicate": "duplicate and open with Builder",
        "opening-title": "Opening %{name} with Builder"
      },
      "add-basemap": {
        "modal-title": "Add a custom basemap",
        "modal-desc": "Select from these great resources",
        "adding-basemap": "Adding new basemap…",
        "add-basemap-error": "Could not add basemap",
        "add-btn": "Add basemap",
        "cancel-btn": "Cancel",
        "validating": "Validating…",
        "saving": "Saving layer…",
        "fetching": "Fetching layers…",
        "get-layers": "Get layers",
        "xyz": {
          "insert": "Insert your XYZ URL",
          "enter": "Enter a URL",
          "not-valid": "Insert a valid XYZ URL",
          "eg": "E.g.",
          "tms": "TMS",
          "couldnt-validate": "We couldn't validate this. If you're sure it contains data click \"add basemap\""
        },
        "mapbox": {
          "insert": "Insert your Mapbox URL",
          "enter": "Enter your map ID/URL",
          "enter-token": "Enter your access token",
          "error": "Error retrieving your basemap. Please check your access token.",
          "invalid": "This URL is not valid."
        },
        "wms": {
          "insert": "Insert your WMS/WMTS URL",
          "invalid": "The URL is either invalid or contains unsupported projections",
          "see-docs": "see docs",
          "oh-no": "Oh! No results",
          "unfortunately": "Unfortunately, we couldn't find a layer that matched your search term",
          "tables-pluralize": "table |||| tables",
          "placeholder": "%{layersFoundCount} %{layersFoundCountPluralize} found, %{layersAvailableCount} %{layersAvailableCountPluralize} available"
        },
        "tilejson": {
          "insert": "Insert your TileJSON URL",
          "invalid": "Invalid URL, please make sure it is correct"
        },
        "nasa": {
          "select": "Select a date from which you want a NASA Worldview basemap",
          "day": "Day",
          "night": "Night",
          "cant-select": "You can't select a date in night mode"
        }
      },
      "export-data": {
        "title": "Export data",
        "desc": "Select the preferred file format",
        "no-geometry": "To download any geospatial format like SHP, KML or GeoJSON don't forget to select the_geom on your query.",
        "loading": {
          "geometry": "Checking geometries...",
          "preparing": "Preparing content..."
        },
        "errors": {
          "title": "There was an error",
          "geometry-error": "We can't read data geometries",
          "unknown": "An error occurred"
        },
        "cancel": "Cancel",
        "download": "Download"
      },
      "maps-metadata": {
        "modal-title": "Map metadata",
        "modal-desc": "Edit the attributes of your map",
        "back-btn": "GO BACK",
        "save-btn": "Save",
        "cancel-btn": "Cancel",
        "form": {
          "name": "Map Name",
          "name-placeholder": "Type your name here",
          "description": "Description",
          "description-placeholder": "Type your description here",
          "tags": "Tags",
          "markdown": "Markdown supported"
        },
        "validation": {
          "error": {
            "name": "Name can't be blank"
          }
        },
        "error": {
          "title": "We couldn't save your data",
          "subtitle": "We had an error trying to save your data: <span class='CDB-Text is-semibold'>%{error}</span>"
        },
        "loading": "Saving your data...",
        "success": "<span class='CDB-Text is-semibold'>Metadata</span> for %{name} map <span class='CDB-Text is-semibold'>was saved</span>."
      },
      "dataset-metadata": {
        "modal-title": "Dataset metadata",
        "modal-desc": "Edit the attributes of your dataset",
        "back-btn": "GO BACK",
        "save-btn": "Save",
        "cancel-btn": "Cancel",
        "form": {
          "name": "Dataset Name",
          "name-placeholder": "Type your name here",
          "description": "Description",
          "description-placeholder": "Type your description here",
          "attributions": "Attributions",
          "attributions-placeholder": "Type your attributions here",
          "tags": "Tags",
          "source": "Source",
          "source-placeholder": "Enter the source of the data",
          "license": "License",
          "markdown": "Markdown supported"
        },
        "validation": {
          "error": {
            "name": "Name can't be blank"
          }
        },
        "error": {
          "title": "We couldn't save your data",
          "subtitle": "We had an error trying to save your data: <span class='CDB-Text is-semibold'>%{error}</span>"
        },
        "loading": "Saving your data...",
        "success": "<span class='CDB-Text is-semibold'>Metadata</span> for %{name} dataset <span class='CDB-Text is-semibold'>was saved</span>."
      },
      "publish": {
        "done-btn": "Done",
        "update-btn": "Update",
        "publish-btn": "Publish",
        "publishing-btn": "Publishing",
        "updating-btn": "Updating",
        "menu": {
          "share": "Share with colleagues",
          "publish": "publish"
        },
        "privacy": {
          "privacy": "privacy",
          "cta": {
            "title": "Want some privacy?",
            "desc-trial": "Check our plans with 14 days trial",
            "desc-notrial": "Upgrade your account!"
          },
          "public": {
            "type": "PUBLIC",
            "title": "Public",
            "body": "Everyone can view your table and download it"
          },
          "link": {
            "type": "LINK",
            "title": "Only accessible with link",
            "body": "Only the people with a shared link can view the data"
          },
          "password": {
            "type": "PASSWORD",
            "title": "Password",
            "body": "Set a password and share only with specific people",
            "placeholder": "Type your password"
          },
          "private": {
            "type": "PRIVATE",
            "title": "Private",
            "body": "Nobody can access this dataset"
          },
          "error": {
            "title": "We couldn't save your data",
            "subtitle": "We had an internal error trying to save your data. We recommend you try again."
          },
          "upgrade": {
            "title": "Interested in sharing within your organization?",
            "desc": "%{contact} to try one of our Enterprise plans",
            "contact": "Contact us",
            "mail": "sales@carto.com"
          },
          "loading": "Saving your data..."
        },
        "share": {
          "published": "Published %{when}",
          "unpublished": "Never published.",
          "last-published": "Last updated %{date}",
          "unpublished-header": "Click on Publish to start sharing your map on the web",
          "unpublished-subheader": "From the moment you click on publish, you will need to use this window to update your changes on the public version.",
          "upgradeLabel": "Upgrade",
          "upgradeLink": "https://carto.com/pricing/#pricing-standard",
          "upgrade": "%{upgradeLink} to share with your colleagues?",
          "private": "PRIVATE",
          "get-link": {
            "title": "Get the link",
            "body": "Send to your friends, coworkers, or post it in your social networks.",
            "link": "",
            "copy": "COPY",
            "select": "SELECT",
            "private": {
              "body": "Your map is %{private} Change privacy to get the link"
            }
          },
          "embed": {
            "title": "Embed it",
            "body": "Insert your map into your blog, website, or simple application.",
            "link": "Get a simple URL.",
            "copy": "COPY",
            "select": "SELECT",
            "private": {
              "body": "Your map is %{private} Change privacy to embed map"
            }
          },
          "cartodbjs": {
            "title": "CARTO.js",
            "body": "Add your map to your applications using this URL.",
            "link": "Read more.",
            "copy": "COPY",
            "select": "SELECT"
          },
          "mobile-sdk": {
            "title": "CARTO Mobile SDK",
            "body": "Add your map to your native mobile applications using this line of code.",
            "link": "Read more.",
            "copy": "COPY",
            "select": "SELECT"
          },
          "error": {
            "title": "We couldn't save your data",
            "subtitle": "We had an internal error trying to save your data. We recommend you try again."
          },
          "loading": "Saving your data...",
          "organization": {
            "title": "Default settings for your Organization",
            "desc": "New users will have this permission"
          },
          "role": {
            "viewer": "Viewer",
            "builder": "Builder"
          },
          "tooltip": {
            "group": "Access is inherited from group %{name}",
            "org": "Access is inherited from organization"
          },
          "toggle": {
            "read": "Read",
            "write": "Write"
          },
          "add-people": "Add people"
        }
      },
      "assets-picker": {
        "browse": "Browse",
        "delete-image": "Delete image",
        "delete-images": "Delete images",
        "deselect-all": "Deselect all",
        "drag-and-drop": "Drag & drop your file",
        "error-desc": "Please, go back and try again. If the problem persists contact us at <a href='mailto:support@carto.com'>support@carto.com</a>",
        "go-back": "Go back",
        "incorrect-url": "Error. Your URL doesn’t look correct.",
        "loading": "Loading…",
        "or": "or",
        "select-all": "Select all",
        "submit": "submit",
        "upload-desc": "Paste a URL or select a file like JPG, GIF, PNG, SVG",
        "upload-file-url": "Upload a file or a URL"
      },
      "add-asset": {
        "icons": "Icons",
        "modal-desc": "or just use our nice selection",
        "modal-title": "Select marker image",
        "set-image": "Set image",
        "upload-file": "Upload file",
        "upload-asset": "Upload asset",
        "upload-image": "Upload your image",
        "your-uploads": "Your uploads",
        "organization-uploads": "Organization uploads"
      },
      "add-analysis": {
        "modal-title": "Add a new analysis",
        "modal-desc": "Select the analysis you want to add",
        "loading-title": "Loading options",
        "add-btn": "Add analysis",
        "disabled-option-desc": "Your layer's geometries are %{simpleGeometryType} and this analysis needs %{requiredInputGeometries}",
        "unknown-geometry-type": "unknown",
        "info-analysis": "Info about analysis",
        "option-types": {
          "connect-with-lines": {
            "title": "Connect with lines",
            "desc": "Create lines from point datasets using a variety of methods"
          },
          "group-points": {
            "title": "Group points into polygons",
            "desc": "Aggregate points into polygons such as convex hulls or bounding boxes."
          },
          "aggregate-intersection": {
            "title": "Intersect second layer",
            "desc": "Intersect with a second layer and calculate aggregations on the fly."
          },
          "area-of-influence": {
            "title": "Create areas of influence",
            "desc": "Use travel time (e.g. walking or driving) or distance to calculate areas of influence from points."
          },
          "georeference": {
            "title": "Georeference",
            "desc": "Use street addresses, city names, or other location text to generate point geometries."
          },
          "filter-intersection": {
            "title": "Filter points in polygons",
            "desc": "Filter points intersecting your polygons layer, and augment those with your polygons columns."
          },
          "filter": {
            "title": "Filter by column value",
            "desc": "Keep or discard rows according to a custom criteria."
          },
          "merge": {
            "title": "Join columns from 2nd layer",
            "desc": "Join columns from a second layer by linking a shared value found in both datasets."
          },
          "moran-cluster": {
            "title": "Detect outliers and clusters",
            "desc": "Use Moran's I to find high (HL) and low (LH) outliers and high (HH) and low (LL) clusters.",
            "high-low": "High-Low (HL)",
            "high-high": "High-High (HH)",
            "low-high": "Low-High (LH)",
            "low-low": "Low-Low (LL)"
          },
          "kmeans": {
            "title": "Calculate clusters of points",
            "desc": "Spatially separate a layer of points into a specified number (N) of groups."
          },
          "centroid": {
            "title": "Find centroid of geometries",
            "desc": "Calculate a direct or weighted centroid based on all rows of a layer or by categories."
          },
          "filter-by-node-column": {
            "title": "Filter by layer",
            "desc": "Filter your layer depending on a second layer such that widgets will effect both."
          },
          "sampling": {
            "title": "Subsample percent of rows",
            "desc": "Subsample the rows in a dataset based on a specified percent."
          },
          "spatial-markov-trend": {
            "title": "Predict trends and volatility",
            "desc": "Predict probability of upward and downward trends using spatial Markov chains."
          },
          "data-observatory-measure": {
            "title": "Enrich from Data Observatory",
            "desc": "Add a new column with contextual demographic and economic measures."
          },
          "deprecated-sql-function": {
            "title": "SQL Function",
            "desc": "Run your custom SQL function"
          }
        }
      },
      "add-widgets": {
        "modal-title": "Add new widgets",
        "modal-desc": "Select the widgets you want to add",
        "continue-btn": "Continue",
        "loading-title": "Loading columns",
        "tab-pane": {
          "histogram-label": "Histogram",
          "category-label": "Category",
          "formula-label": "Formula",
          "time-series-label": "Time-series"
        },
        "percentage-in-top-cats": "% in top 10 cat",
        "time-series-no-option-title": "None",
        "time-series-no-option-desc": "This option won't show your time-series widget"
      },
      "add-layer": {
        "modal-title": "Add a new layer",
        "modal-desc": "Select an existing dataset or connect a new one",
        "navigation": {
          "search": "Search",
          "search-placeholder": "by name, description, or :tag",
          "connect-dataset": "Connect dataset",
          "shared-with-you": "Shared with you",
          "data-library": "Data library",
          "create-empty-map": "Create empty map",
          "create-empty-dataset": "Create empty dataset",
          "create-empty-addLayer": "Add an empty layer",
          "dataset-pluralize": "Dataset |||| Datasets"
        },
        "create-loading-title": "Creating an empty dataset…",
        "adding-new-layer": "Adding new layer…",
        "add-layer-error": "Could not add layer",
        "imports": {
          "ask-for-demo": "ask for demo",
          "connector": "connector",
          "demo-email-title": "I am interested in the %{name} connector",
          "demo-email-desc": "Hi, I am interested in testing the %{name} connector. Please contact me to schedule a demo of this feature.",
          "tab-options-error": {
            "no-key": "%{name} key is not specified and the panel can't be enabled",
            "not-allowed": "%{name} data source is not available for your plan. Please upgrade.",
            "limits-reached": "You've reached the limits for your account. Please upgrade.",
            "no-credits": "You've reached the available %{name} credits for your account this month."
          },
          "member-pluralize": "member |||| members",
          "item-pluralize": "item |||| items",
          "form-import": {
            "browse": "Browse",
            "drag-and-drop": "Drag & drop your file",
            "error-desc": "Error. Your URL doesn’t look correct.",
            "format": "Format",
            "or": "or",
            "title": "Enter a URL",
            "desc": "Paste a URL and start the import",
            "submit": "submit"
          },
          "header-import": {
            "import-url": "Import your data from a %{brand} URL",
            "file-selected": "File selected",
            "paste-url": "Paste a URL %{fileEnabled} ",
            "select-a-file": "or select a file like CSV, XLS, ZIP, KML, GPX,",
            "see-all-formats": "see all formats",
            "sync-enabled": "Keep it synchronized with the source",
            "sync-disabled": "Sync options are not available",
            "type-selected": "%{brand} selected",
            "type-import": "%{brand} import",
            "upload-file-url": "Upload a file or a URL |||| Upload a URL"
          },
          "service-import": {
            "and": "and",
            "account-connected": "Account connected",
            "connect-with": "Connect with %{title}",
            "choose": "Choose",
            "connect": "Connect",
            "found-in": "%{size} %{pluralize} found in %{title}",
            "item-selected": "Item selected",
            "many-more-formats": "many more formats",
            "no-results-title": "Oouch! There are no results",
            "no-results-desc": "We haven't found any valid file from your account",
            "state-idle-login": "Login to your account and select any item.",
            "state-error": "We are sorry that you can’t connect to your %{title} account. Be sure you have any pop-up blockers deactivated for this website.",
            "state-token": "Checking Token.",
            "state-oauth": "Requesting oAuth.",
            "state-retrieving": "A list of your %{title} files will be displayed in a moment.",
            "state-selected-sync": "You can choose when to sync the file.",
            "state-selected-instagram": "A map containing all your georeferenced photos will be created",
            "state-selected-no-sync": "Sync options are not available.",
            "supported": "supported",
            "try-again": "Try again"
          },
          "selected-state": {
            "sync-my-data": "Sync my data",
            "never": "Never",
            "every-hour": "Every hour",
            "every-day": "Every day",
            "every-week": "Every week",
            "every-month": "Every month",
            "free-trial": "%{days} day free trial",
            "more-features": "more features",
            "upgrade-desc": "Upgrade your account to get sync options and %{features}",
            "upgrade": "upgrade"
          },
          "twitter": {
            "category": "Category",
            "credits-consumed": "Twitter credits for this period consumed - %{extraTweets} will be charged",
            "credits-left": "%{per}% of your %{remainingFormatted} Twitter credits left",
            "credits-no-limit": "No limits - %{extraTweets} will be charged",
            "extra-tweets": "extra tweets",
            "fallback-title": "Enable the %{brand} connector",
            "fallback-desc": "The %{brand} connector allows you to map %{brand} data activity related to your brand, event, or any term you may be interested in.",
            "from-to": "From / to",
            "terms-desc": "Enter up to four search terms using the category fields.",
            "terms-placeholder": "Insert your terms separated by commas",
            "title": "Twitter trends",
            "twitter-gmt": "Time is in GMT+0",
            "use": "Use",
            "your-gmt": "You are in GMT"
          },
          "arcgis": {
            "fallback-desc": "Enable the %{brand} connector in your account to connect your %{brand} data to CARTO and mantain it in sync with the source.",
            "input-placeholder": "Paste your %{brand} table URL here",
            "url-desc": "To retrieve a particular layer, add the layer index at the end of the URL",
            "import-data": "Import your data from a %{brand} instance",
            "sync-options": "Sync options only available for a layer"
          },
          "instagram": {
            "fallback-desc": "Enable the %{brand} connector to map your photos or videos from your account in CARTO."
          },
          "box": {
            "fallback-desc": "Enable the %{brand} connector in your account to map your %{brand} files in CARTO or mantain your CARTO maps in sync with your Box data."
          },
          "mailchimp": {
            "campaign-selected": "%{brand} campaign selected",
            "fallback-desc": "Enable the %{brand} connector in your account to map your user lists from %{brand} in CARTO or mantain your CARTO maps in sync with your %{brand} data.",
            "map-campaign": "Map your %{brand} campaigns",
            "state-idle": "Connect your %{brand} account to select any of your campaigns.",
            "state-error": "We are sorry, there has been an error while connecting to your %{brand} account. Just in case it helps, be sure you have the pop-up blocker deactivated for this website.",
            "state-token": "Checking %{brand} token.",
            "state-oauth": "Requesting oAuth.",
            "state-retrieving": "A list of your %{brand} campaigns will be displayed in a moment.",
            "state-selected": "Campaign selected."
          },
          "salesforce": {
            "fallback-desc": "Enable the %{brand} connector in your account to map your user lists from %{brand} in CARTO or mantain your CARTO maps in sync with your %{brand} data.",
            "input-placeholder": "Paste your %{brand} URL here"
          }
        },
        "datasets": {
          "item": {
            "sync-failed": "Sync failed, the last attempt was",
            "syncing": "Syncing",
            "synced": "Synced",
            "read": "read",
            "from": "from",
            "by": "by",
            "no-description": "No description",
            "rows-pluralize": "row |||| rows",
            "tags-more": "and %{tagsCount} more",
            "no-tags": "No tags"
          },
          "loading": "Loading",
          "searching": "Searching",
          "error": {
            "title": "Ouch! There has been an error loading your datasets",
            "desc": "If the problem persists contact us at"
          },
          "no-datasets": {
            "title": "You have not connected any datasets yet",
            "desc": "You can %{connectDataset} or %{search} in all our data library",
            "connect-datasets": "connect datasets",
            "search": "search"
          },
          "no-results": {
            "desc": "There are no results in this page",
            "found": "found",
            "there-are-no": "There are no",
            "no-fun": "No %{type}, no fun"
          }
        },
        "footer": {
          "guessing-desc": "Let CARTO automatically guess data types and content on import.",
          "twitter-desc": "To get access to historical data (older than 30 days) you need to",
          "contact-team": "contact our team",
          "privacy-upgrade": "You cannot change the privacy of your new datasets. Click here to upgrade your account.",
          "privacy-change": "Your new dataset will be %{privacy}",
          "privacy-click": "Click to change it to %{nextPrivacy}",
          "privacy-change-banned": "You cannot change the privacy of your new datasets.",
          "add-layer": "Add layer"
        }
      },
      "edit-feature": {
        "confirmation": {
          "title": "This geometry is too big to edit from the web",
          "desc": "Editing this geometry could freeze or crash your browser, and you could lose your work. We encourage you to edit this feature through the API.",
          "cancel": "Cancel",
          "continue": "Ok, continue"
        },
        "delete": {
          "title": "You are about to delete a feature",
          "desc": "Are you sure you want to delete it?",
          "cancel": "Cancel",
          "confirm": "Ok, delete it"
        }
      }
    },
    "error": {
      "default-title": "Oops, there was a problem",
      "default-desc": "Reload the page again. If the problem persists contact us at <a href='mailto:support@carto.com'>support@carto.com</a>"
    },
    "backbone-forms": {
      "select": {
        "placeholder": "Select a %{keyAttr}",
        "loading": "loading…",
        "empty": "No values",
        "selected": "%{count} selected"
      },
      "operators": {
        "count-message": "If you select 'COUNT' all columns are selected"
      },
      "interval-error": "Value must be between %{minValue} and %{maxValue}",
      "copy-button": "COPY",
      "data-observatory": {
        "dropdown": {
          "measurement": {
            "search": "Search...",
            "type": "measurements"
          },
          "filter": {
            "header": "Filter measurements by",
            "type": "filters"
          }
        }
      }
    },
    "codemirror": {
      "no-errors": "No errors",
      "docs": "DOCS",
      "syntax-error": "Syntax error",
      "line": "Line"
    },
    "undo-redo": {
      "clear": "CLEAR",
      "apply": "APPLY"
    },
    "table": {
      "columns": {
        "change-type": {
          "confirm": "ok, change it",
          "cancel": "Cancel",
          "desc": "Maps using this column will be affected and unconvertible data will be lost. Are you sure?",
          "error": "There was an error changing %{columnName} column: %{error}",
          "loading": "Changing %{columnName} column...",
          "title": "%{columnName} column will change to %{newType}",
          "success": "Column %{columnName} changed to %{newType}"
        },
        "create": {
          "loading": "Adding new column...",
          "error": "Error adding new column: %{error}",
          "success": "%{columnName} column added"
        },
        "destroy": {
          "cancel": "Cancel",
          "confirm": "Ok, delete it",
          "desc": "Maps using this column will be affected, are you sure you want to delete it?",
          "error": "Error deleting %{columnName} column: %{error}",
          "loading": "Removing your column %{columnName}...",
          "success": "%{columnName} column deleted",
          "title": "You are about to delete %{columnName} column "
        },
        "rename": {
          "cancel": "Cancel",
          "confirm": "ok, rename it",
          "desc": "Maps using this column will be affected, are you sure you want to rename it?",
          "error": "Error renaming column %{columnName} to %{newName}: %{error}",
          "loading": "Renaming your column %{columnName} to %{newName}...",
          "success": "Column %{columnName} renamed to %{newName}",
          "title": "You are about to rename column %{columnName} to %{newName}"
        },
        "options": {
          "order": "Order",
          "rename": "Rename column",
          "change": "Change data type",
          "create": "Add new column",
          "delete": "Delete this column..."
        },
        "types": {
          "boolean": "Boolean",
          "date": "Date",
          "number": "Number",
          "string": "String"
        }
      },
      "rows": {
        "loading": {
          "title": "Loading rows..."
        },
        "error": {
          "title": "There was an error...",
          "desc": "It was not possible to obtain any results, check the query applied"
        },
        "result": {
          "no-page-title": "Ouch! Sorry",
          "no-page-desc": "This page %{page} doesn't contain any results...",
          "no-results-title": "There is no data",
          "no-results-desc": "",
          "no-results-button": ""
        },
        "options": {
          "copy": "Copy cell value",
          "create": "Add new row",
          "edit": "Edit this cell",
          "delete": "Delete this row..."
        },
        "create": {
          "loading": "Adding new row...",
          "error": "Error adding new row: %{error}",
          "success": "New row added"
        },
        "edit": {
          "loading": "Editing %{attribute} with cartodb_id %{cartodbId}...",
          "error": "Error editing %{attribute} with cartodb_id %{cartodbId}: %{error}",
          "success": "Edited %{attribute} with cartodb_id %{cartodbId}"
        },
        "destroy": {
          "cancel": "Cancel",
          "confirm": "ok, delete",
          "desc": "Are you sure you want to delete it?",
          "error": "Error deleting row with cartodb_id %{cartodb_id}: %{error}",
          "loading": "Removing your row with cartodb_id %{cartodb_id}...",
          "success": "Row with cartodb_id %{cartodb_id} deleted",
          "title": "You are about to delete row with cartodb_id %{cartodb_id}"
        },
        "paginator": {
          "error": "There was an error with pagination: %{error}",
          "to": "to"
        }
      }
    }
  },
  "dataset": {
    "sql": "SQL",
    "data": "Metadata",
    "updated": "Updated %{ago}",
    "read": "Read",
    "options": {
      "add-row": "Add row",
      "add-column": "Add column",
      "export": "Export"
    },
    "preview-map": {
      "preview": "preview",
      "back": "back"
    },
    "create-map": {
      "title": "Create map",
      "loading": "Creating a map from %{tableName}",
      "error": "There was an error creating the map"
    },
    "delete": {
      "option": "Delete dataset...",
      "cancel": "Cancel",
      "confirm": "Ok, delete it",
      "desc": "The deleted dataset cannot be recovered, be sure before proceeding. We recommend you to export your dataset before deleting it.",
      "error": "Error deleting %{tableName}: %{error}",
      "loading": "Deleting your dataset %{tableName}...",
      "title": "You are about to delete the %{tableName} dataset",
      "affected-vis-count": "%{smart_count} map affected |||| %{smart_count} maps affected",
      "affected-vis-count-extended": "%{affectedVisCount} maps affected, some of them are",
      "affected-entities-count": "%{smart_count} user will lose access |||| %{smart_count} users will lose access",
      "affected-entities-count-extended": "%{affectedEntitiesCount} users will lose access, some of them are",
      "whole-organization-affected": "All users from your organization will be affected"
    },
    "metadata": {
      "option": "Edit metadata",
      "error": "There was an error edititng metadata of your dataset %{name}",
      "loading": "Editing metadata of your dataset %{name}..."
    },
    "duplicate": {
      "option": "Duplicate dataset",
      "query": "applied query",
      "customOption": "Create Dataset from query",
      "error": "There was an error duplicating %{name}",
      "loading": "Duplicating your dataset %{name}..."
    },
    "lock": {
      "option": "Lock dataset",
      "error": "There was an error locking %{tableName}",
      "loading": "Locking your dataset %{tableName}..."
    },
    "rename": {
      "option": "Rename dataset",
      "cancel": "Cancel",
      "confirm": "ok, rename it",
      "desc": "If you are accessing this dataset via API, don't forget to use the new name in your API calls afterwards.",
      "error": "Error renaming %{tableName}: %{error}",
      "loading": "Renaming your dataset %{tableName}...",
      "success": "Dataset %{tableName} renamed",
      "title": "Renaming %{tableName} will affect your API calls, maps, analyses, ..."
    },
    "sync": {
      "in-a-moment": "in a few moments",
      "synced": "Synced %{ranAt}",
      "syncing": "Syncing",
      "loading": "Syncing dataset %{tableName}",
      "sync-failed": "Sync failed",
      "next": "Next will be %{runAt}",
      "error-code": "Error code %{errorCode}",
      "sync-now": "Sync now",
      "view-options": "View options",
      "disabled": "You will be able to sync manually %{gap} minutes after your last synchronization",
      "title": "Sync dataset options",
      "desc": "Your dataset is in sync with a %{service} file: <br/>%{url}",
      "label": "Sync my data",
      "error": "There was an error setting the interval",
      "confirm": "Save",
      "cancel": "Cancel"
    },
    "unlock": {
      "cancel": "back to dashboard",
      "confirm": "ok, unlock it",
      "desc": "That means you need to unlock it before doing anything. Are you sure?",
      "error": "Error unlocking %{tableName}: %{error}",
      "loading": "Unlocking your dataset %{tableName}...",
      "success": "Dataset %{tableName} unlocked",
      "title": "Your dataset %{tableName} is locked."
    }
  },
  "editor": {
    "map": "map",
    "map_name": "%{name} map",
    "published": "Published %{when}",
    "unpublished": "Map not published yet",
    "map_pluralize": "%{smart_count} map |||| %{smart_count} maps",
    "button_add": "Add",
    "button_share": "SHARE",
    "unpublished-changes": "Unpublished changes",
    "error-query": {
      "body": "Errors found in your SQL query. %{action} before continuing.",
      "label": "Fix them"
    },
    "settings": {
      "menu-tab-pane-labels": {
        "preview": "Preview",
        "snapshots": "Snapshots"
      },
      "preview": {
        "mode": {
          "title": "Mode"
        },
        "options": {
          "title": "Map Options",
          "subtitle": "Components that are shown in the map",
          "description": {
            "title": "Components",
            "subtitle": "Change map elements"
          },
          "elements": {
            "search": "Search box",
            "zoom": "Zoom controls",
            "fullscreen": "Fullscreen",
            "scrollwheel": "Scroll wheel zoom",
            "layer_selector": "Layer selector",
            "logo": "CARTO Logo",
            "widgets": "Widgets column",
            "legends": "Legends",
            "dashboard_menu": "Show toolbar"
          }
        }
      }
    },
    "maps": {
      "options": {
        "duplicate": "Duplicate",
        "edit-metadata": "Edit metadata…",
        "export-image": "Export image…",
        "export-map": "Download map…",
        "remove": "Delete map…",
        "rename": "Rename"
      },
      "duplicate": {
        "error": "There was an error duplicating %{name}",
        "loading": "Duplicating your map %{name}..."
      },
      "delete": {
        "confirm": "Ok, delete it",
        "cancel": "Cancel",
        "desc": "The deleted map cannot be recovered, be sure before proceeding.",
        "title": "You are about to delete map %{name}",
        "error": "Error deleting map %{name}: %{error}",
        "loading": "Removing the map %{name}...",
        "success": "Map %{name} deleted"
      },
      "export-image": {
        "title": "Export as image",
        "export": "Export",
        "generating": "Generating",
        "disclaimer": {
          "title": "Disclaimer",
          "body": "Legends and widgets won't be exported as part of the image"
        },
        "download": "Download",
        "errors": {
          "try-again": "Please, try again. If the problem persists, contact support",
          "error-attribution": "Error generating attribution.",
          "error-basemap": "Error loading basemap.",
          "error-image": "Error generating image."
        }
      },
      "export": {
        "confirmation": {
          "confirm": "Download",
          "cancel": "Cancel",
          "desc": "This map, and the connected data, will be downloaded as a .carto file",
          "title": "Download \"%{name}\""
        },
        "download": {
          "confirm": "Download",
          "tip": "Tip: Allow pop-ups from CARTO in your web browser.",
          "desc": "Click Download to begin the .carto file download.",
          "title": "Ready to Download"
        },
        "error": {
          "title": "An error occured while exporting your map",
          "desc": "Please try again. If the problem persists, please contact support"
        }
      },
      "rename": {
        "loading": "Renaming map...",
        "success": "Map renamed to %{name}",
        "error": "Error renaming map %{name}: %{error}"
      }
    },
    "tab-pane": {
      "layers": {
        "title-label": "Layers",
        "georeference": {
          "title": "Layer not georeferenced",
          "body": "The layer <span class='CDB-Text is-semibold'>%{name}</span> include non-georeferenced data."
        }
      },
      "elements": {
        "title-label": "Elements"
      },
      "widgets": {
        "title-label": "Widgets"
      }
    },
    "elements": {
      "message": "Unfortunately, map overlays are not available yet, but they will be very soon. Stay tuned!"
    },
    "layers": {
      "options": {
        "rename": "Rename",
        "delete": "Delete layer…",
        "collapse": "Collapse",
        "expand": "Expand",
        "export": "Export data",
        "hide": "Hide layer",
        "show": "Show layer",
        "edit": "Edit layer",
        "center-map": "Center map on layer"
      },
      "drag-n-drop-analysis": {
        "upgrade-max-layers-err": "%{a_start}Upgrade your account%{a_end} to add more than %{userMaxLayers} layers to your maps."
      },
      "rename": {
        "loading": "Renaming layer…",
        "success": "Layer renamed to %{name}",
        "error": "<span class='u-errorTextColor'>Error renaming layer</span> %{name}: %{error}"
      },
      "moveTorqueLayer": {
        "loading": "Moving torque layer to first position...",
        "success": "Layer moved",
        "error": "Error moving the layer..."
      },
      "delete": {
        "confirm": "Ok, delete it",
        "cancel": "Cancel",
        "desc": "<span class='CDB-Text u-mainTextColor is-semibold'>%{layerVisName}</span> will be affected, are you sure you want to delete it?",
        "title": "You are about to delete the layer %{layerName}",
        "error": "<span class='u-errorTextColor'>Error deleting layer</span>: %{error}",
        "loading": "Removing layer…",
        "success": "Layer deleted correctly.",
        "widgets": "one widget |||| %{smart_count} widgets",
        "analyses": "one analysis |||| %{smart_count} analyses",
        "layers": "one layer |||| %{smart_count} layers",
        "affected-items": "Deleting this layer affects",
        "and": "and",
        "link-to-export": "Before deleting the layer, you can <a href='#' data-event='exportMapAction'>export as .CARTO file</a>"
      },
      "layer": {
        "animated": "Animated",
        "heatmap": "Pixel",
        "analysis": "Analysis",
        "add-analysis": "Add analysis",
        "analyses-count": "%{smart_count} Analysis |||| %{smart_count} Analyses",
        "widgets-count": "%{smart_count} Widget |||| %{smart_count} Widgets",
        "add-layer": "Add layer",
        "delete": "Delete",
        "cancel-delete-analysis": "Cancel"
      },
      "basemap": {
        "remove-baselayer": "Remove baselayer",
        "custom-basemap": "Custom basemap",
        "title-label": "Basemap",
        "by": "by",
        "category": {
          "title-label": "Source",
          "select-category": "Select source"
        },
        "style": {
          "title-label": "Style",
          "select-style": "Select style",
          "color": "Color"
        },
        "saving": {
          "loading": "Saving new basemap...",
          "error": "Error saving new basemap.",
          "success": "Basemap saved successfully."
        }
      },
      "labels": {
        "title-label": "Labels"
      },
      "color": {
        "title-label": "Color"
      },
      "image": {
        "title-label": "Image"
      },
      "gmaps": {
        "title-label": "Google Maps"
      },
      "menu-tab-pane-labels": {
        "data": "Data",
        "analyses": "Analysis",
        "style": "Style",
        "infowindow": "Pop-up",
        "legends": "Legend"
      },
      "infowindow-menu-tab-pane-labels": {
        "click": "Click",
        "hover": "Hover"
      },
      "analysis-form": {
        "merge-type": {
          "left": "Returns all rows from #1, with the matching rows in #2 or NULL when there is no match.",
          "inner": "Returns the result of #1 intersecting #2 (i.e. the inner part of a Venn diagram intersection)"
        },
        "admin-region": "Admin. Region",
        "aggregate": "Aggregate",
        "aggregate-by": "Aggregate by",
        "aggregate-by-help": "Will calculate aggregate values for each centroid",
        "aggregate-column": "Aggregate column",
        "all-to-all": "All to all",
        "allow-holes": "Allow holes",
        "apply-btn": "Apply",
        "asc": "ASC",
        "bicycle": "Bicycle",
        "boundaries": "Boundaries",
        "bounding-box": "Bounding Box",
        "bounding-circle": "Bounding Circle",
        "by": "By",
        "by-bike": "bike",
        "by-car": "car",
        "by-walk": "walk",
        "car": "Car",
        "categorize-by": "Categorize by",
        "categorize-by-help": "If selected a centroid will be found for each category",
        "category-column": "Category column",
        "city": "City",
        "clusters-num": "# of clusters",
        "column": "Column",
        "columns": "Columns",
        "concave-hull": "Concave Hull",
        "confirm-analysis": "Confirm",
        "convex-hull": "Convex Hull",
        "country": "Country",
        "create-btn": "Apply",
        "data-observatory-measurement-area": "Country",
        "data-observatory-measurement-column": "New col. name",
        "data-observatory-measurement-column-help": "Adds a new column to your layer to store result",
        "data-observatory-measurement-desc": "enrich your data",
        "data-observatory-measurement-measurement": "Measurement",
        "data-observatory-measurement-refine": "Choose a measure",
        "data-observatory-measurement-segments": "Segments",
        "define-columns": "Define column to find similarities with",
        "define-reference-and-target": "Define reference and target layers",
        "define-two-layers": "Define two layers",
        "denominator": "Denominator",
        "denominator-help": "A column to normalize the target column",
        "deprecated-sql-function": {
          "choose-function": "Choose the function to run on this node",
          "choose-function-small": "Choose function",
          "define-params": "define your parameters below",
          "function": "function",
          "input": "input",
          "params": "Your Function's Parameters",
          "target": "target node",
          "title": "SQL Function"
        },
        "desc": "DESC",
        "direction": "Direction",
        "disabled-by-config": "This analysis type is disabled",
        "dissolved": "Dissolved",
        "dissolved-help": "Combine polygons tracts which have equal ranges",
        "distance": "Distance",
        "enter-latitude": "Enter latitude",
        "enter-longitude": "Enter longitude",
        "filter": "Filter",
        "filter-aggregate": "Aggregate your results",
        "filter-column": "Filter column",
        "foreign-keys": "Foreign Keys",
        "geometry-from": "Geometry from",
        "georeference": {
          "postal-code-help": "Select a column with postal codes",
          "admin-region-help": "Select a column with region names",
          "admin-region-extended-help": "Specify an admin. region or select a column with region names",
          "admin-region": "Admin. Regions",
          "city-help": "Select a column with city names",
          "city-extended-help": "Specify a city or select a column with city names",
          "city": "Cities",
          "country-help": "Select a column with country names",
          "country-extended-help": "Specify a country or select a column with country names",
          "country": "Countries",
          "enter-city-name": "Or enter city name",
          "enter-country-name": "Or enter country name",
          "enter-region-name": "Or enter region name",
          "enter-state-name": "Or enter state name",
          "ip-address-column": "IP Address",
          "ip-address-help": "Select a column with IP addresses",
          "ip-address": "IP Addresses",
          "long-lat": "Longitude and Latitude",
          "postal-code": "Postal Codes",
          "select-a-country": "Select a country column",
          "select-admin": "Select a region column",
          "select-city": "Select a city column",
          "select-country": "Select country column",
          "select-ip": "Select an IP column",
          "select-latitude": "Select a latitude column",
          "select-longitude": "Select a longitude column",
          "select-postal-code": "Select a postal code column",
          "select-state": "Select state column",
          "select-street-address": "Select an address column",
          "state-help": "Specify a state or select a column with state names",
          "street-address-column": "Street Address",
          "street-address-column-help": "Select a column with street addresses",
          "street-address-help": "Use columns or free text to compose your address schema. <a href='https://carto.com/learn/guides/analysis/geocode-street-addresses-into-point-geometries' target='_blank'>More info.</a>",
          "street-address": "Street Addresses",
          "advance": "Advanced mode",
          "normal": "Normal mode"
        },
        "group-by": "Group by",
        "hide": "Hide",
        "inner": "Inner",
        "input": "Input",
        "input-layer": "Define your input layer",
        "input-num": "Input #%{num}",
        "intact": "Intact",
        "intact-help": "Keep all polygon tracts as individual polygons",
        "join-type": "Join Type",
        "keep-columns": "Select the columns you want to keep",
        "key-columns": "Key columns",
        "key-columns-desc": "Choose similar columns to relate them",
        "kilometers": "km",
        "latitude": "Latitude",
        "left": "Left",
        "line-sequential": "Sequential",
        "line-source-to-target": "To Source",
        "line-to-column": "To Column",
        "line-to-single-point": "To Single Point",
        "link-layer": "Link to col.",
        "link-layer-desc": "Specify a second layer to filter by",
        "linked-layer": "Filter by layer",
        "loading": "loading…",
        "longitude": "Longitude",
        "max": "Max",
        "measure-by": "Measure by",
        "meters": "m",
        "method": "Method",
        "miles": "mi",
        "min": "Min",
        "mode": "Mode",
        "find-nearest": {
          "categorized": "Per group",
          "categorized-help": "Calculate results per each category of the chosen column",
          "criteria": "Select the target point layer",
          "define-params": "Define your parameters",
          "define-params-desc": "Define and categorize the number of results",
          "input": "input",
          "max-results": "max results",
          "modal-desc": "Find nearest analysis locates the closest points between two tables.",
          "modal-title": "Find nearest",
          "target": "target",
          "title": "Find nearest"
        },
        "neighbors": "Neighbors",
        "neighbors-help": "Define the local neighborhood as this many nearest-neighbors",
        "no": "No",
        "no-coincidence": "When no coincidence no row will be added",
        "should-match": "Column types should match",
        "numerator": "Target column",
        "numerator-help": "Measure spatial autocorrelation of this column",
        "operation": "Operation",
        "order": "Order",
        "order-by": "Order by",
        "order-results": "Order your results",
        "parameters": "Parameters",
        "parameters-description": "Tune your analysis",
        "permutations": "Permutations",
        "placeholder-text": "You have not added any analysis yet. Add an analysis to discover new things.",
        "points_source": "Point source",
        "polygons_source": "Polygon source",
        "postal-code": "Postal Code",
        "quota": {
          "title": "confirm your analysis",
          "loading": "Obtaining your quotas...",
          "credits-left-body": "This might incur into an extra cost. Extra credits will be charged at $%{blockPrice}/%{blockSize}.",
          "credits-left-message": "%{smart_count} credit left |||| %{smart_count} credits left",
          "enough-quota": "You need to use approximately %{credits} of your credits.",
          "hard-limit-not-enough-quota": "We're sorry the current quota is insufficient to enrich your data. Rows will be set to null and analysis may not complete. Please %{contact} us to extend your quota for this function.",
          "soft-limit-enough-quota": "We're sorry the current quota is insufficient to enrich your data. This might need about %{credits} extra credits. Extra credits will be charged at $%{blockPrice}/%{blockSize}.",
          "no-quota-assigned-body": "To get access to the %{analysis} function, %{contact}.",
          "no-credits-body": "You have consumed all your credits during this billing cycle. %{contact} to get some more.",
          "no-credits-message": "No credits available",
          "contact-message": {
            "no-credits": {
              "regular": "Contact us",
              "organization": "Contact your organization admin"
            },
            "no-quota-assigned": {
              "regular": "contact our team",
              "organization": "contact your organization admin"
            }
          },
          "emails": {
            "support": "support@carto.com",
            "saas": "sales@carto.com"
          },
          "quota-error-title": "Error",
          "quota-fetch-error": "There was an error obtaining your quota: %{error}.",
          "quota-dataservice-down": "Dataservices API unreacheable.",
          "cancel": "Cancel",
          "confirm": "confirm",
          "analysis-type": {
            "routing": "Routing",
            "trade-area": "Trade area",
            "georeference-street-address": "Georeference street address",
            "data-observatory-measure": "Data Observatory"
          }
        },
        "public_transport": "Public transport",
        "radius": "Distance",
        "reference-layer-pluralize": "Define your reference layer |||| Define your reference layers",
        "result": "Result",
        "right": "Right",
        "sampling": "Sampling",
        "sampling-desc": "Select a sample of the data",
        "sampling-rate": "% of data ",
        "search-by-column-name": "Search by column name",
        "second-geom-required": "This analysis requires a second geometry column",
        "select-column": "Select a column",
        "select-type": "Select data type",
        "setup-analysis": "Setup analysis",
        "show": "Show",
        "significance": "Significance",
        "significance-help": "Filter outliers and clusters to this significance. Smaller numbers are more significant.",
        "source": "Source",
        "source-col": "Source col.",
        "source-column": "Source column",
        "spatial-markov-trend-desc": "select a column for each time period",
        "spatial-markov-trend-time-columns": "Input columns",
        "spatial-markov-trend-time-columns-help": "Each column should contain values for a time period",
        "state": "State",
        "target": "Target",
        "target-layer": "Target layer",
        "intersection-layer": "Intersect layer",
        "filtering-layer": "Filtering layer",
        "base-layer": "Base layer",
        "target-col": "Target col.",
        "target-column": "Target column",
        "target-percent": "Target percent",
        "target-percent-help": "Convex hull lookalike",
        "time": "Time",
        "time-seconds": "Time (Seconds)",
        "to-closest": "To closest",
        "top-range": "Top range",
        "tracts": "Tracts",
        "tracts-help": "Number of AOIs evenly spaced between 0 and RADIUS",
        "tune-analysis": "Tune your analysis",
        "tune-centroid": "Tune your centroid",
        "tune-clusters": "Tune your clusters",
        "units": "Units",
        "type": "Type",
        "value": "Value",
        "value-aggregation": "Value aggregation",
        "value-aggregation-desc": "Aggregate the desired value in your polygon(s)",
        "value-aggregation-centroids": "Aggregate the desired value in your centroid(s)",
        "valid-type": "This kind of data is not valid for this type",
        "walk": "Walk",
        "weight": "Weight",
        "weight-column": "Weight column",
        "weight-type": "Weight type",
        "weighted-by": "Weighted by",
        "weighted-by-help": "Weights contribution by a value for each point",
        "workflow": "Your workflow",
        "write-max-value": "Write max value",
        "write-min-value": "Write min value",
        "yes": "Yes"
      },
      "infowindow": {
        "select-fields": "Select fields",
        "no-fields": "You haven’t selected any fields to be shown in the popup.",
        "placeholder-interactivity-text": "Popups are disabled because interactivity is not available for this layer.",
        "placeholder-columns-text": "Popups are disabled because there are no columns available for this layer.",
        "placeholder-geometry": "There's no geometry in your data to add a popup.",
        "style": {
          "title-label": "Style",
          "select-style": "Select style",
          "window-size": "Window size",
          "header-color": "Header color",
          "none": "None",
          "custom": "Custom",
          "infowindow_light": "Light",
          "infowindow_dark": "Dark",
          "infowindow_color": "Color",
          "infowindow_header_with_image": "Image"
        },
        "items": {
          "title-label": "Show items",
          "description": "Add items"
        }
      },
      "tooltip": {
        "style": {
          "none": "None",
          "custom": "Custom",
          "tooltip_light": "Light",
          "tooltip_dark": "Dark"
        },
        "items": {
          "title-label": "Show items",
          "description": "Add items"
        }
      },
      "filter-options": {
        "top": "Top",
        "bottom": "Bottom",
        "between": "Between",
        "is-equal-to": "Is equal to",
        "is-greater-than": "Is greater than",
        "is-less-than": "Is less than"
      },
      "notifier": {
        "center-map": {
          "loading": "Calculating coordinates...",
          "success": "Map centered",
          "error": "Error centering map"
        }
      },
      "georeference": {
        "manually-add": "Please georeference or manually add data to visualize.",
        "georeference-button": "Georeference",
        "visualize": "Layer doesn't have geometry"
      }
    },
    "data": {
      "no-geometry-data": "Your dataset doesn't contain any geometry data.",
      "stats": {
        "add-widget": "Add as a widget",
        "edit": "EDIT",
        "top-cat": "% in top 10 cat.",
        "trues": "% true",
        "null": "% null",
        "number-of": "%{geometry} count",
        "geometry-fallback": "features"
      },
      "data-toggle": {
        "values": "VALUES",
        "cartocss": "SQL"
      },
      "code-mirror": {
        "tip": "CMD + S to apply your query. CTRL + Space to autocomplete."
      },
      "notifier": {
        "sql-alter-loading": "Modifying table…",
        "sql-alter-error": "Error in SQL query.",
        "sql-alter-success": "Modification applied.",
        "sql-applying": "Applying query…",
        "sql-error": "Error in SQL query.",
        "sql-success": "SQL query applied."
      },
      "messages": {
        "sql-readonly": {
          "title": "SQL READ-ONLY",
          "body": "You just applied an analysis to this layer. The SQL is now read- only.",
          "accept": "CLOSE"
        },
        "empty-data": {
          "title": "NO DATA AVAILABLE",
          "body": "There is no data available to be displayed."
        }
      }
    },
    "infowindow": {
      "apply": "APPLY",
      "html-toggle": {
        "values": "VALUES",
        "html": "HTML"
      },
      "code-mirror": {
        "save": "CMD + S to apply your html.",
        "errors": {
          "empty": "Template can't be empty."
        }
      },
      "messages": {
        "custom-html-applied": {
          "title": "CUSTOM HTML APPLIED",
          "body": "You just applied custom html with HTML editor. You can continue and clean all html.",
          "accept": "CONTINUE"
        },
        "layer-hidden": {
          "title": "LAYER HIDDEN",
          "body": "This layer is hidden, changes will not be shown until you make it visible.",
          "show": "SHOW"
        }
      }
    },
    "export-image": {
      "invalid-dimension": "Invalid dimension (%{limit}x%{limit}px)",
      "properties": {
        "width": "width",
        "height": "height",
        "size": "Size",
        "size-subtitle": "Manually enter the image size",
        "format": "Format",
        "format-subtitle": "Choose a lossless (PNG) or lossy (JPG) format",
        "options": "Options",
        "options-subtitle": "Configure display options"
      }
    },
    "legend": {
      "no-geometry-data": "There's no geometry in your data to add a legend.",
      "data-toggle": {
        "values": "VALUES",
        "html": "HTML"
      },
      "code-mirror": {
        "save": "CMD + S to apply your html.",
        "errors": {
          "empty": "Template can't be empty."
        },
        "pre-html": "<!-- insert your custom html code above this line -->",
        "post-html": "<!-- insert your custom html code below this line -->"
      },
      "menu-tab-pane-labels": {
        "color": "color",
        "size": "size"
      },
      "messages": {
        "custom-legend": {
          "title": "CUSTOM LEGEND APPLIED",
          "body": "You just applied custom html with HTML editor. You can continue and clean all html.",
          "accept": "Delete custom html"
        },
        "layer-hidden": {
          "title": "LAYER HIDDEN",
          "body": "This layer is hidden. Changes won't be shown until you make it visible.",
          "show": "SHOW"
        },
        "legends-disabled": {
          "title": "LEGENDS DISABLED",
          "body": "The legends setting is disabled. Changes made will not be shown until you enable legends.",
          "show": "ENABLE"
        }
      },
      "types": {
        "none": "none",
        "category": "category",
        "gradient": "gradient",
        "bubble": "bubble",
        "custom": "custom"
      },
      "legend-form": {
        "type": {
          "title": "Select Style"
        },
        "properties": {
          "title": "Creating your legend",
          "subtitle": "Add items"
        },
        "add": "Add item",
        "title": "Title",
        "fill": "Fill",
        "by-size": "By Size",
        "by-color": "By Color",
        "untitled": "Untitled",
        "prefix": "Prefix",
        "suffix": "Suffix",
        "left-label": "Left Label",
        "right-label": "Right Label",
        "top-label": "Top Label",
        "bottom-label": "Bottom Label",
        "custom-label-placeholder": "Override dynamic value"
      },
      "pixel-title": "Amount"
    },
    "style": {
      "types": {
        "none": "-",
        "simple": "none",
        "hexabins": "hexbins",
        "squares": "squares",
        "regions": "Adm. Regions",
        "heatmap": "pixel",
        "animation": "animated"
      },
      "style-form": {
        "type": {
          "title-label": "Aggregation"
        },
        "aggregation": {
          "title-label": "Aggregation Options",
          "desc": "Configure how the aggregation works"
        },
        "properties": {
          "title-label-point": "Style",
          "title-label-line": "Lines style",
          "title-label-polygon": "Polygons style",
          "placeholder-text": "There's no geometry in your data that could be styled.",
          "georeference": "Georeference",
          "desc": "Change the visualization"
        },
        "unanimatable": {
          "desc": "Not any numeric or date column found in your data.",
          "body": "You can change your column's type in the %{link}.",
          "label": "table view"
        }
      },
      "code-mirror": {
        "save": "CMD + S to apply your styles."
      },
      "style-toggle": {
        "values": "VALUES",
        "cartocss": "CARTOCSS"
      },
      "messages": {
        "fetched": "Schema fetched, select a style",
        "fetching": "Schema is being fetched, when it is done, different styles will be avaiable",
        "unavailable": "There was a problem getting schema, try to reload",
        "none": "Your styles were reset, choose new styles for your layer, or go back to your previous style.",
        "cartocss-applied": {
          "title": "CARTOCSS APPLIED",
          "body": "You just applied styles with CartoCSS. You can continue or clear all styles.",
          "continue": "CONTINUE",
          "clear": "CLEAR"
        },
        "layer-hidden": {
          "title": "LAYER HIDDEN",
          "body": "This layer is hidden, changes won't be shown until you make it visible.",
          "show": "SHOW"
        },
        "torque-exists": {
          "title": "TORQUE LAYER",
          "body": "There is already a torque layer in the layers collection. If you continue, this layer will use the default style.",
          "continue": "CONTINUE",
          "cancel": "CANCEL"
        }
      },
      "components": {
        "fill": "Fill",
        "stroke": {
          "label": "Stroke",
          "fetching": "Loading node schema...",
          "unavailable": "Error getting node schema",
          "error": "There was an error fetching node schema..."
        },
        "blending": {
          "label": "Blending",
          "options": {
            "none": "none",
            "darken": "darken",
            "lighten": "lighten",
            "lighter": "lighter",
            "color-dodge": "color-dodge",
            "color-burn": "color-burn",
            "multiply": "multiply",
            "screen": "screen",
            "overlay": "overlay",
            "src-over": "src-over",
            "source-over": "source-over",
            "xor": "xor"
          }
        },
        "type": {
          "label": "Type",
          "options": {
            "heatmap": "Heatmap",
            "points": "Points"
          }
        },
        "aggregation-value": "Operation",
        "aggregation-size": {
          "label": "Size",
          "help": "In pixels"
        },
        "aggregation-dataset": "Admin. level",
        "labels-enabled": {
          "label": "labels",
          "not-with-animated": "It won't be available with animations"
        },
        "labels-attribute": {
          "label": "column",
          "fetching": "Loading node schema...",
          "unavailable": "Error getting node schema",
          "error": "There was an error fetching node schema..."
        },
        "labels-font": "font",
        "labels-offset": "offset",
        "labels-fill": "size/color",
        "labels-overlap": {
          "label": "overlap",
          "options": {
            "true": "True",
            "false": "False"
          }
        },
        "labels-halo": "halo",
        "labels-placement": {
          "label": "placement",
          "options": {
            "point": "point",
            "line": "line",
            "vertex": "vertex",
            "interior": "interior"
          }
        },
        "animated-enabled": {
          "label": "animated",
          "already-one-torque": "There is already a torque layer in your map",
          "not-with-labels": "It won't be available with labels"
        },
        "animated-attribute": {
          "label": "column",
          "fetching": "Loading node schema...",
          "unavailable": "Error getting node schema",
          "error": "There was an error fetching node schema..."
        },
        "animated-overlap": {
          "label": "overlap",
          "options": {
            "true": "Accum.",
            "false": "None"
          }
        },
        "animated-trails": "trails",
        "animated-resolution": "resolution",
        "animated-steps": "steps",
        "animated-duration": "duration"
      }
    },
    "widgets": {
      "no-geometry-data": "Your dataset lacks geometry data, it is not possible to add a widget.",
      "options": {
        "remove": "Delete...",
        "rename": "Rename",
        "edit": "Edit"
      },
      "delete": {
        "confirm": "Ok, delete it",
        "cancel": "Cancel",
        "desc": "The widget cannot be recovered, be sure before proceeding.",
        "title": "You are about to delete the widget %{name}",
        "error": "Error deleting widget %{name}: %{error}",
        "loading": "Removing the widget %{name}...",
        "success": "Widget %{name} deleted"
      },
      "widgets-view": {
        "add_widget": "Add widget"
      },
      "widgets-types": {
        "histogram": "Histogram",
        "category": "Category",
        "formula": "Formula",
        "time-series": "Time series"
      },
      "widgets-form": {
        "placeholder-text": "You have not added any widgets yet. Add widgets to discover new things.",
        "type": {
          "title-label": "Type",
          "description": "Choose the widget type",
          "category": "Category",
          "formula": "Formula",
          "histogram": "Histogram",
          "time_series": "Time Series"
        },
        "data": {
          "columns-unavailable": "No columns available",
          "aggregation": "Aggregation",
          "aggregation_column": "Aggregation Column",
          "bins": "Buckets",
          "column": "Column",
          "description": "Configure your values",
          "end": "End",
          "loading": "loading…",
          "operation": "Operation",
          "prefix": "Prefix",
          "start": "Start",
          "suffix": "Suffix",
          "title": "Title",
          "title-label": "Data",
          "value": "Value",
          "aggregate-by": "aggregate by",
          "operation-column": "operation column"
        },
        "style": {
          "custom-categories": "Custom categ.",
          "custom-disabled": "If an aggregated style is applied, auto style is disabled",
          "custom-help": "Represent the widget's values with custom colors in the map",
          "custom-ramp": "Custom ramp",
          "define": "Define how your widget interacts with the data",
          "description": "Description",
          "fill": "Fill",
          "no": "No",
          "sync_on_bbox_change": "Dynamic",
          "sync_on_data_change": "Unfiltered",
          "title-label": "Behavior",
          "yes": "Yes"
        }
      }
    },
    "edit-feature": {
      "features": {
        "point": "point",
        "line": "line",
        "polygon": "polygon"
      },
      "loading-state": "Requesting feature data...",
      "error-state": "There was an error requesting feature data",
      "overlay-text": "Start clicking on the map to draw your %{featureType}",
      "add": "Add",
      "save": "Save",
      "attributes": "Attributes",
      "attributes-columns": "Change column names and type in table mode",
      "cancel": "Cancel",
      "geometry": "Geometry",
      "geometry-edit": "You can also edit it on the map",
      "geometry-disabled": "Not available for hidden or read only layers",
      "out-of-bounds-lng": "Longitude is out of bounds [-180, 180]",
      "out-of-bounds-lat": "Latitude is out of bounds [-90, 90]",
      "valid-lng": "Must be a valid longitude",
      "valid-lat": "Must be a valid latitude",
      "valid": "Only numbers allowed",
      "delete": "Delete %{featureType}",
      "edit": "Edit %{featureType}",
      "analysis": "layers with analysis nodes",
      "custom-sql": "layers with custom SQL applied",
      "sync": "read only layers",
      "disabled": "Feature editing is disabled in %{disabledLayerType}. To edit the data, export this layer and import it as a new layer."
    }
  },
  "notifications": {
    "vis": {
      "failed": {
        "title": "This map couldn't be rendered",
        "body": "Please refresh the page and contact us if the error persists"
      }
    },
    "analysis": {
      "waiting": "Analysis %{nodeId} enqueued...",
      "running": "Analysis %{nodeId} running...",
      "completed": "Analysis %{nodeId} completed",
      "failed": "Analysis %{nodeId} failed",
      "removed": "Analysis %{nodeId} deleted",
      "contact": {
        "label": "contact us",
        "mail": "support@carto.com"
      },
      "sample": "sample",
      "errors": {
        "timeout": "Your analysis has taken too long. Try to %{sample} your data or %{contact} for further assistance",
        "without-geom-webmercator": "The column \"the_geom_webmercator\" does not exist"
      }
    },
    "widgets": {
      "delete": "Widget deleted correctly.",
      "success": "Widget successfully added",
      "error": {
        "title": "Error adding widget:",
        "body": "%{body} %{error}"
      },
      "loading": "Adding widget…",
      "updating": "Updating widget…",
      "restoring": "Restoring widgets…",
      "restored": "Widgets restored"
    },
    "layer": {
      "error": "Layer error: %{error}",
      "added": "Layer added successfully"
    },
    "cartocss": {
      "error": {
        "body": "%{body} %{error}",
        "title": "Error in CartoCSS styles:"
      },
      "success": "CartoCSS applied"
    },
    "sql": {
      "alter-loading": "Modifying table…",
      "alter-success": "Modification applied",
      "applying": "Applying query…",
      "error": {
        "body": "%{body} %{error}",
        "title": "Error in SQL query:"
      },
      "success": "SQL query applied"
    },
    "edit-feature": {
      "edit": {
        "loading": "Requesting geometry data...",
        "error": "There was an error requesting geometry data"
      },
      "error": {
        "body": "%{body} %{error}"
      },
      "destroy": {
        "loading": "Deleting geometry…",
        "error": "Error deleting geometry",
        "success": "Geometry deleted correctly"
      },
      "save": {
        "loading": "Saving geometry…",
        "error": "Error saving geometry",
        "success": "Geometry successfully saved"
      },
      "adding": "Adding geometry…"
    }
  }
}

},{}],1124:[function(require,module,exports){
module.exports={
  "editor": {
    "map": "mapa",
    "map_name": "%{name} mapa",
    "map_pluralize": "%{smart_count} mapa |||| %{smart_count} mapas"
  }
}

},{}],1125:[function(require,module,exports){
module.exports = {
  en: require('./en.json'),
  sw: require('./sw.json'),
  es: require('./es.json')
};

},{"./en.json":1123,"./es.json":1124,"./sw.json":1126}],1126:[function(require,module,exports){
module.exports={
  "editor": {
    "map": "karta",
    "map_name": "%{name} karta",
    "map_pluralize": "%{smart_count} karta |||| %{smart_count} kartor"
  }
}

},{}],1127:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');

/**
 * NOTE! Migrated as-is from https://github.com/CartoDB/cartodb.js/blob/470399abb12b40d5476ab6bbfd792d95aa819f50/src/core/view.js 2016-06-03
 * Base View for all CartoDB views.
 * DO NOT USE Backbone.View directly
 */
var View = Backbone.View.extend({
  classLabel: 'cdb.core.View',

  constructor: function (options) {
    this.options = _.defaults(options, this.options);
    this._models = [];
    this._subviews = {};
    Backbone.View.call(this, options);
    View.viewCount++;
    View.views[this.cid] = this;
    this._created_at = new Date();
  },

  add_related_model: function (m) {
    if (!m) throw new Error('added non valid model');
    this._models.push(m);
  },

  addView: function (v) {
    this._subviews[v.cid] = v;
    v._parent = this;
  },

  removeView: function (v) {
    delete this._subviews[v.cid];
  },

  clearSubViews: function () {
    _(this._subviews).each(function (v) {
      v.clean();
    });
    this._subviews = {};
  },

  /**
   * this methid clean removes the view
   * and clean and events associated. call it when
   * the view is not going to be used anymore
   */
  clean: function () {
    this.trigger('clean');
    this.clearSubViews();
    // remove from parent
    if (this._parent) {
      this._parent.removeView(this);
      this._parent = null;
    }
    this.remove();
    this.allOff();
    View.viewCount--;
    delete View.views[this.cid];
    return this;
  },

  /**
   * Remove all event listeners on related models
   */
  allOff: function () {
    this.off();

    if (this.model && this.model.off) this.model.off(null, null, this);

    var self = this;
    _(this._models).each(function (m) {
      m.off(null, null, self);
    });
    this._models = [];
  },

  show: function () {
    this.$el.show();
  },

  hide: function () {
    this.$el.hide();
  },

  /**
  * Listen for an event on another object and triggers on itself, with the same name or a new one
  * @method retrigger
  * @param ev {String} event who triggers the action
  * @param obj {Object} object where the event happens
  * @param obj {Object} [optional] name of the retriggered event
  */
  retrigger: function (ev, obj, retrigEvent) {
    if (!retrigEvent) {
      retrigEvent = ev;
    }
    var self = this;
    obj.bind && obj.bind(ev, function () {
      self.trigger(retrigEvent);
    }, self);
    // add it as related model//object
    this.add_related_model(obj);
  },
  /**
  * Captures an event and prevents the default behaviour and stops it from bubbling
  * @method killEvent
  * @param event {Event}
  */
  killEvent: function (ev) {
    if (ev && ev.preventDefault) {
      ev.preventDefault();
    }
    if (ev && ev.stopPropagation) {
      ev.stopPropagation();
    }
  },

  /**
  * Remove all the tipsy tooltips from the document
  * @method cleanTooltips
  */
  cleanTooltips: function () {
    this.$('.tipsy').remove();
  }

}, {
  viewCount: 0,
  views: {},

  /**
   * when a view with events is inherit and you want to add more events
   * this helper can be used:
   * var MyView = new core.View({
   *  events: View.extendEvents({
   *      'click': 'fn'
   *  })
   * })
   */
  extendEvents: function (newEvents) {
    return function () {
      return _.extend(newEvents, this.constructor.__super__.events);
    };
  },

  /**
   * search for views in a view and check if they are added as subviews
   */
  runChecker: function () {
    _.each(View.views, function (view) {
      _.each(view, function (prop, k) {
        if (k !== '_parent' &&
          view.hasOwnProperty(k) &&
          prop instanceof View &&
          view._subviews[prop.cid] === undefined) {
          console.log('=========');
          console.log('untracked view: ');
          console.log(prop.el);
          console.log('parent');
          console.log(view.el);
          console.log(' ');
        }
      });
    });
  }
});

module.exports = View;

},{"backbone":"backbone","underscore":"underscore"}],1128:[function(require,module,exports){
/*! jQuery UI - v1.11.4 - 2015-03-11
* http://jqueryui.com
* Includes: core.js, widget.js, mouse.js, position.js, accordion.js, autocomplete.js, button.js, datepicker.js, dialog.js, draggable.js, droppable.js, effect.js, effect-blind.js, effect-bounce.js, effect-clip.js, effect-drop.js, effect-explode.js, effect-fade.js, effect-fold.js, effect-highlight.js, effect-puff.js, effect-pulsate.js, effect-scale.js, effect-shake.js, effect-size.js, effect-slide.js, effect-transfer.js, menu.js, progressbar.js, resizable.js, selectable.js, selectmenu.js, slider.js, sortable.js, spinner.js, tabs.js, tooltip.js
* Copyright 2015 jQuery Foundation and other contributors; Licensed MIT */

(function( factory ) {
	if ( typeof define === "function" && define.amd ) {

		// AMD. Register as an anonymous module.
		define([ "jquery" ], factory );
	} else {

		// Browser globals
		factory( jQuery );
	}
}(function( $ ) {
/*!
 * jQuery UI Core 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/category/ui-core/
 */


// $.ui might exist from components with no dependencies, e.g., $.ui.position
$.ui = $.ui || {};

$.extend( $.ui, {
	version: "1.11.4",

	keyCode: {
		BACKSPACE: 8,
		COMMA: 188,
		DELETE: 46,
		DOWN: 40,
		END: 35,
		ENTER: 13,
		ESCAPE: 27,
		HOME: 36,
		LEFT: 37,
		PAGE_DOWN: 34,
		PAGE_UP: 33,
		PERIOD: 190,
		RIGHT: 39,
		SPACE: 32,
		TAB: 9,
		UP: 38
	}
});

// plugins
$.fn.extend({
	scrollParent: function( includeHidden ) {
		var position = this.css( "position" ),
			excludeStaticParent = position === "absolute",
			overflowRegex = includeHidden ? /(auto|scroll|hidden)/ : /(auto|scroll)/,
			scrollParent = this.parents().filter( function() {
				var parent = $( this );
				if ( excludeStaticParent && parent.css( "position" ) === "static" ) {
					return false;
				}
				return overflowRegex.test( parent.css( "overflow" ) + parent.css( "overflow-y" ) + parent.css( "overflow-x" ) );
			}).eq( 0 );

		return position === "fixed" || !scrollParent.length ? $( this[ 0 ].ownerDocument || document ) : scrollParent;
	},

	uniqueId: (function() {
		var uuid = 0;

		return function() {
			return this.each(function() {
				if ( !this.id ) {
					this.id = "ui-id-" + ( ++uuid );
				}
			});
		};
	})(),

	removeUniqueId: function() {
		return this.each(function() {
			if ( /^ui-id-\d+$/.test( this.id ) ) {
				$( this ).removeAttr( "id" );
			}
		});
	}
});

// selectors
function focusable( element, isTabIndexNotNaN ) {
	var map, mapName, img,
		nodeName = element.nodeName.toLowerCase();
	if ( "area" === nodeName ) {
		map = element.parentNode;
		mapName = map.name;
		if ( !element.href || !mapName || map.nodeName.toLowerCase() !== "map" ) {
			return false;
		}
		img = $( "img[usemap='#" + mapName + "']" )[ 0 ];
		return !!img && visible( img );
	}
	return ( /^(input|select|textarea|button|object)$/.test( nodeName ) ?
		!element.disabled :
		"a" === nodeName ?
			element.href || isTabIndexNotNaN :
			isTabIndexNotNaN) &&
		// the element and all of its ancestors must be visible
		visible( element );
}

function visible( element ) {
	return $.expr.filters.visible( element ) &&
		!$( element ).parents().addBack().filter(function() {
			return $.css( this, "visibility" ) === "hidden";
		}).length;
}

$.extend( $.expr[ ":" ], {
	data: $.expr.createPseudo ?
		$.expr.createPseudo(function( dataName ) {
			return function( elem ) {
				return !!$.data( elem, dataName );
			};
		}) :
		// support: jQuery <1.8
		function( elem, i, match ) {
			return !!$.data( elem, match[ 3 ] );
		},

	focusable: function( element ) {
		return focusable( element, !isNaN( $.attr( element, "tabindex" ) ) );
	},

	tabbable: function( element ) {
		var tabIndex = $.attr( element, "tabindex" ),
			isTabIndexNaN = isNaN( tabIndex );
		return ( isTabIndexNaN || tabIndex >= 0 ) && focusable( element, !isTabIndexNaN );
	}
});

// support: jQuery <1.8
if ( !$( "<a>" ).outerWidth( 1 ).jquery ) {
	$.each( [ "Width", "Height" ], function( i, name ) {
		var side = name === "Width" ? [ "Left", "Right" ] : [ "Top", "Bottom" ],
			type = name.toLowerCase(),
			orig = {
				innerWidth: $.fn.innerWidth,
				innerHeight: $.fn.innerHeight,
				outerWidth: $.fn.outerWidth,
				outerHeight: $.fn.outerHeight
			};

		function reduce( elem, size, border, margin ) {
			$.each( side, function() {
				size -= parseFloat( $.css( elem, "padding" + this ) ) || 0;
				if ( border ) {
					size -= parseFloat( $.css( elem, "border" + this + "Width" ) ) || 0;
				}
				if ( margin ) {
					size -= parseFloat( $.css( elem, "margin" + this ) ) || 0;
				}
			});
			return size;
		}

		$.fn[ "inner" + name ] = function( size ) {
			if ( size === undefined ) {
				return orig[ "inner" + name ].call( this );
			}

			return this.each(function() {
				$( this ).css( type, reduce( this, size ) + "px" );
			});
		};

		$.fn[ "outer" + name] = function( size, margin ) {
			if ( typeof size !== "number" ) {
				return orig[ "outer" + name ].call( this, size );
			}

			return this.each(function() {
				$( this).css( type, reduce( this, size, true, margin ) + "px" );
			});
		};
	});
}

// support: jQuery <1.8
if ( !$.fn.addBack ) {
	$.fn.addBack = function( selector ) {
		return this.add( selector == null ?
			this.prevObject : this.prevObject.filter( selector )
		);
	};
}

// support: jQuery 1.6.1, 1.6.2 (http://bugs.jquery.com/ticket/9413)
if ( $( "<a>" ).data( "a-b", "a" ).removeData( "a-b" ).data( "a-b" ) ) {
	$.fn.removeData = (function( removeData ) {
		return function( key ) {
			if ( arguments.length ) {
				return removeData.call( this, $.camelCase( key ) );
			} else {
				return removeData.call( this );
			}
		};
	})( $.fn.removeData );
}

// deprecated
$.ui.ie = !!/msie [\w.]+/.exec( navigator.userAgent.toLowerCase() );

$.fn.extend({
	focus: (function( orig ) {
		return function( delay, fn ) {
			return typeof delay === "number" ?
				this.each(function() {
					var elem = this;
					setTimeout(function() {
						$( elem ).focus();
						if ( fn ) {
							fn.call( elem );
						}
					}, delay );
				}) :
				orig.apply( this, arguments );
		};
	})( $.fn.focus ),

	disableSelection: (function() {
		var eventType = "onselectstart" in document.createElement( "div" ) ?
			"selectstart" :
			"mousedown";

		return function() {
			return this.bind( eventType + ".ui-disableSelection", function( event ) {
				event.preventDefault();
			});
		};
	})(),

	enableSelection: function() {
		return this.unbind( ".ui-disableSelection" );
	},

	zIndex: function( zIndex ) {
		if ( zIndex !== undefined ) {
			return this.css( "zIndex", zIndex );
		}

		if ( this.length ) {
			var elem = $( this[ 0 ] ), position, value;
			while ( elem.length && elem[ 0 ] !== document ) {
				// Ignore z-index if position is set to a value where z-index is ignored by the browser
				// This makes behavior of this function consistent across browsers
				// WebKit always returns auto if the element is positioned
				position = elem.css( "position" );
				if ( position === "absolute" || position === "relative" || position === "fixed" ) {
					// IE returns 0 when zIndex is not specified
					// other browsers return a string
					// we ignore the case of nested elements with an explicit value of 0
					// <div style="z-index: -10;"><div style="z-index: 0;"></div></div>
					value = parseInt( elem.css( "zIndex" ), 10 );
					if ( !isNaN( value ) && value !== 0 ) {
						return value;
					}
				}
				elem = elem.parent();
			}
		}

		return 0;
	}
});

// $.ui.plugin is deprecated. Use $.widget() extensions instead.
$.ui.plugin = {
	add: function( module, option, set ) {
		var i,
			proto = $.ui[ module ].prototype;
		for ( i in set ) {
			proto.plugins[ i ] = proto.plugins[ i ] || [];
			proto.plugins[ i ].push( [ option, set[ i ] ] );
		}
	},
	call: function( instance, name, args, allowDisconnected ) {
		var i,
			set = instance.plugins[ name ];

		if ( !set ) {
			return;
		}

		if ( !allowDisconnected && ( !instance.element[ 0 ].parentNode || instance.element[ 0 ].parentNode.nodeType === 11 ) ) {
			return;
		}

		for ( i = 0; i < set.length; i++ ) {
			if ( instance.options[ set[ i ][ 0 ] ] ) {
				set[ i ][ 1 ].apply( instance.element, args );
			}
		}
	}
};


/*!
 * jQuery UI Widget 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/jQuery.widget/
 */


var widget_uuid = 0,
	widget_slice = Array.prototype.slice;

$.cleanData = (function( orig ) {
	return function( elems ) {
		var events, elem, i;
		for ( i = 0; (elem = elems[i]) != null; i++ ) {
			try {

				// Only trigger remove when necessary to save time
				events = $._data( elem, "events" );
				if ( events && events.remove ) {
					$( elem ).triggerHandler( "remove" );
				}

			// http://bugs.jquery.com/ticket/8235
			} catch ( e ) {}
		}
		orig( elems );
	};
})( $.cleanData );

$.widget = function( name, base, prototype ) {
	var fullName, existingConstructor, constructor, basePrototype,
		// proxiedPrototype allows the provided prototype to remain unmodified
		// so that it can be used as a mixin for multiple widgets (#8876)
		proxiedPrototype = {},
		namespace = name.split( "." )[ 0 ];

	name = name.split( "." )[ 1 ];
	fullName = namespace + "-" + name;

	if ( !prototype ) {
		prototype = base;
		base = $.Widget;
	}

	// create selector for plugin
	$.expr[ ":" ][ fullName.toLowerCase() ] = function( elem ) {
		return !!$.data( elem, fullName );
	};

	$[ namespace ] = $[ namespace ] || {};
	existingConstructor = $[ namespace ][ name ];
	constructor = $[ namespace ][ name ] = function( options, element ) {
		// allow instantiation without "new" keyword
		if ( !this._createWidget ) {
			return new constructor( options, element );
		}

		// allow instantiation without initializing for simple inheritance
		// must use "new" keyword (the code above always passes args)
		if ( arguments.length ) {
			this._createWidget( options, element );
		}
	};
	// extend with the existing constructor to carry over any static properties
	$.extend( constructor, existingConstructor, {
		version: prototype.version,
		// copy the object used to create the prototype in case we need to
		// redefine the widget later
		_proto: $.extend( {}, prototype ),
		// track widgets that inherit from this widget in case this widget is
		// redefined after a widget inherits from it
		_childConstructors: []
	});

	basePrototype = new base();
	// we need to make the options hash a property directly on the new instance
	// otherwise we'll modify the options hash on the prototype that we're
	// inheriting from
	basePrototype.options = $.widget.extend( {}, basePrototype.options );
	$.each( prototype, function( prop, value ) {
		if ( !$.isFunction( value ) ) {
			proxiedPrototype[ prop ] = value;
			return;
		}
		proxiedPrototype[ prop ] = (function() {
			var _super = function() {
					return base.prototype[ prop ].apply( this, arguments );
				},
				_superApply = function( args ) {
					return base.prototype[ prop ].apply( this, args );
				};
			return function() {
				var __super = this._super,
					__superApply = this._superApply,
					returnValue;

				this._super = _super;
				this._superApply = _superApply;

				returnValue = value.apply( this, arguments );

				this._super = __super;
				this._superApply = __superApply;

				return returnValue;
			};
		})();
	});
	constructor.prototype = $.widget.extend( basePrototype, {
		// TODO: remove support for widgetEventPrefix
		// always use the name + a colon as the prefix, e.g., draggable:start
		// don't prefix for widgets that aren't DOM-based
		widgetEventPrefix: existingConstructor ? (basePrototype.widgetEventPrefix || name) : name
	}, proxiedPrototype, {
		constructor: constructor,
		namespace: namespace,
		widgetName: name,
		widgetFullName: fullName
	});

	// If this widget is being redefined then we need to find all widgets that
	// are inheriting from it and redefine all of them so that they inherit from
	// the new version of this widget. We're essentially trying to replace one
	// level in the prototype chain.
	if ( existingConstructor ) {
		$.each( existingConstructor._childConstructors, function( i, child ) {
			var childPrototype = child.prototype;

			// redefine the child widget using the same prototype that was
			// originally used, but inherit from the new version of the base
			$.widget( childPrototype.namespace + "." + childPrototype.widgetName, constructor, child._proto );
		});
		// remove the list of existing child constructors from the old constructor
		// so the old child constructors can be garbage collected
		delete existingConstructor._childConstructors;
	} else {
		base._childConstructors.push( constructor );
	}

	$.widget.bridge( name, constructor );

	return constructor;
};

$.widget.extend = function( target ) {
	var input = widget_slice.call( arguments, 1 ),
		inputIndex = 0,
		inputLength = input.length,
		key,
		value;
	for ( ; inputIndex < inputLength; inputIndex++ ) {
		for ( key in input[ inputIndex ] ) {
			value = input[ inputIndex ][ key ];
			if ( input[ inputIndex ].hasOwnProperty( key ) && value !== undefined ) {
				// Clone objects
				if ( $.isPlainObject( value ) ) {
					target[ key ] = $.isPlainObject( target[ key ] ) ?
						$.widget.extend( {}, target[ key ], value ) :
						// Don't extend strings, arrays, etc. with objects
						$.widget.extend( {}, value );
				// Copy everything else by reference
				} else {
					target[ key ] = value;
				}
			}
		}
	}
	return target;
};

$.widget.bridge = function( name, object ) {
	var fullName = object.prototype.widgetFullName || name;
	$.fn[ name ] = function( options ) {
		var isMethodCall = typeof options === "string",
			args = widget_slice.call( arguments, 1 ),
			returnValue = this;

		if ( isMethodCall ) {
			this.each(function() {
				var methodValue,
					instance = $.data( this, fullName );
				if ( options === "instance" ) {
					returnValue = instance;
					return false;
				}
				if ( !instance ) {
					return $.error( "cannot call methods on " + name + " prior to initialization; " +
						"attempted to call method '" + options + "'" );
				}
				if ( !$.isFunction( instance[options] ) || options.charAt( 0 ) === "_" ) {
					return $.error( "no such method '" + options + "' for " + name + " widget instance" );
				}
				methodValue = instance[ options ].apply( instance, args );
				if ( methodValue !== instance && methodValue !== undefined ) {
					returnValue = methodValue && methodValue.jquery ?
						returnValue.pushStack( methodValue.get() ) :
						methodValue;
					return false;
				}
			});
		} else {

			// Allow multiple hashes to be passed on init
			if ( args.length ) {
				options = $.widget.extend.apply( null, [ options ].concat(args) );
			}

			this.each(function() {
				var instance = $.data( this, fullName );
				if ( instance ) {
					instance.option( options || {} );
					if ( instance._init ) {
						instance._init();
					}
				} else {
					$.data( this, fullName, new object( options, this ) );
				}
			});
		}

		return returnValue;
	};
};

$.Widget = function( /* options, element */ ) {};
$.Widget._childConstructors = [];

$.Widget.prototype = {
	widgetName: "widget",
	widgetEventPrefix: "",
	defaultElement: "<div>",
	options: {
		disabled: false,

		// callbacks
		create: null
	},
	_createWidget: function( options, element ) {
		element = $( element || this.defaultElement || this )[ 0 ];
		this.element = $( element );
		this.uuid = widget_uuid++;
		this.eventNamespace = "." + this.widgetName + this.uuid;

		this.bindings = $();
		this.hoverable = $();
		this.focusable = $();

		if ( element !== this ) {
			$.data( element, this.widgetFullName, this );
			this._on( true, this.element, {
				remove: function( event ) {
					if ( event.target === element ) {
						this.destroy();
					}
				}
			});
			this.document = $( element.style ?
				// element within the document
				element.ownerDocument :
				// element is window or document
				element.document || element );
			this.window = $( this.document[0].defaultView || this.document[0].parentWindow );
		}

		this.options = $.widget.extend( {},
			this.options,
			this._getCreateOptions(),
			options );

		this._create();
		this._trigger( "create", null, this._getCreateEventData() );
		this._init();
	},
	_getCreateOptions: $.noop,
	_getCreateEventData: $.noop,
	_create: $.noop,
	_init: $.noop,

	destroy: function() {
		this._destroy();
		// we can probably remove the unbind calls in 2.0
		// all event bindings should go through this._on()
		this.element
			.unbind( this.eventNamespace )
			.removeData( this.widgetFullName )
			// support: jquery <1.6.3
			// http://bugs.jquery.com/ticket/9413
			.removeData( $.camelCase( this.widgetFullName ) );
		this.widget()
			.unbind( this.eventNamespace )
			.removeAttr( "aria-disabled" )
			.removeClass(
				this.widgetFullName + "-disabled " +
				"ui-state-disabled" );

		// clean up events and states
		this.bindings.unbind( this.eventNamespace );
		this.hoverable.removeClass( "ui-state-hover" );
		this.focusable.removeClass( "ui-state-focus" );
	},
	_destroy: $.noop,

	widget: function() {
		return this.element;
	},

	option: function( key, value ) {
		var options = key,
			parts,
			curOption,
			i;

		if ( arguments.length === 0 ) {
			// don't return a reference to the internal hash
			return $.widget.extend( {}, this.options );
		}

		if ( typeof key === "string" ) {
			// handle nested keys, e.g., "foo.bar" => { foo: { bar: ___ } }
			options = {};
			parts = key.split( "." );
			key = parts.shift();
			if ( parts.length ) {
				curOption = options[ key ] = $.widget.extend( {}, this.options[ key ] );
				for ( i = 0; i < parts.length - 1; i++ ) {
					curOption[ parts[ i ] ] = curOption[ parts[ i ] ] || {};
					curOption = curOption[ parts[ i ] ];
				}
				key = parts.pop();
				if ( arguments.length === 1 ) {
					return curOption[ key ] === undefined ? null : curOption[ key ];
				}
				curOption[ key ] = value;
			} else {
				if ( arguments.length === 1 ) {
					return this.options[ key ] === undefined ? null : this.options[ key ];
				}
				options[ key ] = value;
			}
		}

		this._setOptions( options );

		return this;
	},
	_setOptions: function( options ) {
		var key;

		for ( key in options ) {
			this._setOption( key, options[ key ] );
		}

		return this;
	},
	_setOption: function( key, value ) {
		this.options[ key ] = value;

		if ( key === "disabled" ) {
			this.widget()
				.toggleClass( this.widgetFullName + "-disabled", !!value );

			// If the widget is becoming disabled, then nothing is interactive
			if ( value ) {
				this.hoverable.removeClass( "ui-state-hover" );
				this.focusable.removeClass( "ui-state-focus" );
			}
		}

		return this;
	},

	enable: function() {
		return this._setOptions({ disabled: false });
	},
	disable: function() {
		return this._setOptions({ disabled: true });
	},

	_on: function( suppressDisabledCheck, element, handlers ) {
		var delegateElement,
			instance = this;

		// no suppressDisabledCheck flag, shuffle arguments
		if ( typeof suppressDisabledCheck !== "boolean" ) {
			handlers = element;
			element = suppressDisabledCheck;
			suppressDisabledCheck = false;
		}

		// no element argument, shuffle and use this.element
		if ( !handlers ) {
			handlers = element;
			element = this.element;
			delegateElement = this.widget();
		} else {
			element = delegateElement = $( element );
			this.bindings = this.bindings.add( element );
		}

		$.each( handlers, function( event, handler ) {
			function handlerProxy() {
				// allow widgets to customize the disabled handling
				// - disabled as an array instead of boolean
				// - disabled class as method for disabling individual parts
				if ( !suppressDisabledCheck &&
						( instance.options.disabled === true ||
							$( this ).hasClass( "ui-state-disabled" ) ) ) {
					return;
				}
				return ( typeof handler === "string" ? instance[ handler ] : handler )
					.apply( instance, arguments );
			}

			// copy the guid so direct unbinding works
			if ( typeof handler !== "string" ) {
				handlerProxy.guid = handler.guid =
					handler.guid || handlerProxy.guid || $.guid++;
			}

			var match = event.match( /^([\w:-]*)\s*(.*)$/ ),
				eventName = match[1] + instance.eventNamespace,
				selector = match[2];
			if ( selector ) {
				delegateElement.delegate( selector, eventName, handlerProxy );
			} else {
				element.bind( eventName, handlerProxy );
			}
		});
	},

	_off: function( element, eventName ) {
		eventName = (eventName || "").split( " " ).join( this.eventNamespace + " " ) +
			this.eventNamespace;
		element.unbind( eventName ).undelegate( eventName );

		// Clear the stack to avoid memory leaks (#10056)
		this.bindings = $( this.bindings.not( element ).get() );
		this.focusable = $( this.focusable.not( element ).get() );
		this.hoverable = $( this.hoverable.not( element ).get() );
	},

	_delay: function( handler, delay ) {
		function handlerProxy() {
			return ( typeof handler === "string" ? instance[ handler ] : handler )
				.apply( instance, arguments );
		}
		var instance = this;
		return setTimeout( handlerProxy, delay || 0 );
	},

	_hoverable: function( element ) {
		this.hoverable = this.hoverable.add( element );
		this._on( element, {
			mouseenter: function( event ) {
				$( event.currentTarget ).addClass( "ui-state-hover" );
			},
			mouseleave: function( event ) {
				$( event.currentTarget ).removeClass( "ui-state-hover" );
			}
		});
	},

	_focusable: function( element ) {
		this.focusable = this.focusable.add( element );
		this._on( element, {
			focusin: function( event ) {
				$( event.currentTarget ).addClass( "ui-state-focus" );
			},
			focusout: function( event ) {
				$( event.currentTarget ).removeClass( "ui-state-focus" );
			}
		});
	},

	_trigger: function( type, event, data ) {
		var prop, orig,
			callback = this.options[ type ];

		data = data || {};
		event = $.Event( event );
		event.type = ( type === this.widgetEventPrefix ?
			type :
			this.widgetEventPrefix + type ).toLowerCase();
		// the original event may come from any element
		// so we need to reset the target on the new event
		event.target = this.element[ 0 ];

		// copy original event properties over to the new event
		orig = event.originalEvent;
		if ( orig ) {
			for ( prop in orig ) {
				if ( !( prop in event ) ) {
					event[ prop ] = orig[ prop ];
				}
			}
		}

		this.element.trigger( event, data );
		return !( $.isFunction( callback ) &&
			callback.apply( this.element[0], [ event ].concat( data ) ) === false ||
			event.isDefaultPrevented() );
	}
};

$.each( { show: "fadeIn", hide: "fadeOut" }, function( method, defaultEffect ) {
	$.Widget.prototype[ "_" + method ] = function( element, options, callback ) {
		if ( typeof options === "string" ) {
			options = { effect: options };
		}
		var hasOptions,
			effectName = !options ?
				method :
				options === true || typeof options === "number" ?
					defaultEffect :
					options.effect || defaultEffect;
		options = options || {};
		if ( typeof options === "number" ) {
			options = { duration: options };
		}
		hasOptions = !$.isEmptyObject( options );
		options.complete = callback;
		if ( options.delay ) {
			element.delay( options.delay );
		}
		if ( hasOptions && $.effects && $.effects.effect[ effectName ] ) {
			element[ method ]( options );
		} else if ( effectName !== method && element[ effectName ] ) {
			element[ effectName ]( options.duration, options.easing, callback );
		} else {
			element.queue(function( next ) {
				$( this )[ method ]();
				if ( callback ) {
					callback.call( element[ 0 ] );
				}
				next();
			});
		}
	};
});

var widget = $.widget;


/*!
 * jQuery UI Mouse 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/mouse/
 */


var mouseHandled = false;
$( document ).mouseup( function() {
	mouseHandled = false;
});

var mouse = $.widget("ui.mouse", {
	version: "1.11.4",
	options: {
		cancel: "input,textarea,button,select,option",
		distance: 1,
		delay: 0
	},
	_mouseInit: function() {
		var that = this;

		this.element
			.bind("mousedown." + this.widgetName, function(event) {
				return that._mouseDown(event);
			})
			.bind("click." + this.widgetName, function(event) {
				if (true === $.data(event.target, that.widgetName + ".preventClickEvent")) {
					$.removeData(event.target, that.widgetName + ".preventClickEvent");
					event.stopImmediatePropagation();
					return false;
				}
			});

		this.started = false;
	},

	// TODO: make sure destroying one instance of mouse doesn't mess with
	// other instances of mouse
	_mouseDestroy: function() {
		this.element.unbind("." + this.widgetName);
		if ( this._mouseMoveDelegate ) {
			this.document
				.unbind("mousemove." + this.widgetName, this._mouseMoveDelegate)
				.unbind("mouseup." + this.widgetName, this._mouseUpDelegate);
		}
	},

	_mouseDown: function(event) {
		// don't let more than one widget handle mouseStart
		if ( mouseHandled ) {
			return;
		}

		this._mouseMoved = false;

		// we may have missed mouseup (out of window)
		(this._mouseStarted && this._mouseUp(event));

		this._mouseDownEvent = event;

		var that = this,
			btnIsLeft = (event.which === 1),
			// event.target.nodeName works around a bug in IE 8 with
			// disabled inputs (#7620)
			elIsCancel = (typeof this.options.cancel === "string" && event.target.nodeName ? $(event.target).closest(this.options.cancel).length : false);
		if (!btnIsLeft || elIsCancel || !this._mouseCapture(event)) {
			return true;
		}

		this.mouseDelayMet = !this.options.delay;
		if (!this.mouseDelayMet) {
			this._mouseDelayTimer = setTimeout(function() {
				that.mouseDelayMet = true;
			}, this.options.delay);
		}

		if (this._mouseDistanceMet(event) && this._mouseDelayMet(event)) {
			this._mouseStarted = (this._mouseStart(event) !== false);
			if (!this._mouseStarted) {
				event.preventDefault();
				return true;
			}
		}

		// Click event may never have fired (Gecko & Opera)
		if (true === $.data(event.target, this.widgetName + ".preventClickEvent")) {
			$.removeData(event.target, this.widgetName + ".preventClickEvent");
		}

		// these delegates are required to keep context
		this._mouseMoveDelegate = function(event) {
			return that._mouseMove(event);
		};
		this._mouseUpDelegate = function(event) {
			return that._mouseUp(event);
		};

		this.document
			.bind( "mousemove." + this.widgetName, this._mouseMoveDelegate )
			.bind( "mouseup." + this.widgetName, this._mouseUpDelegate );

		event.preventDefault();

		mouseHandled = true;
		return true;
	},

	_mouseMove: function(event) {
		// Only check for mouseups outside the document if you've moved inside the document
		// at least once. This prevents the firing of mouseup in the case of IE<9, which will
		// fire a mousemove event if content is placed under the cursor. See #7778
		// Support: IE <9
		if ( this._mouseMoved ) {
			// IE mouseup check - mouseup happened when mouse was out of window
			if ($.ui.ie && ( !document.documentMode || document.documentMode < 9 ) && !event.button) {
				return this._mouseUp(event);

			// Iframe mouseup check - mouseup occurred in another document
			} else if ( !event.which ) {
				return this._mouseUp( event );
			}
		}

		if ( event.which || event.button ) {
			this._mouseMoved = true;
		}

		if (this._mouseStarted) {
			this._mouseDrag(event);
			return event.preventDefault();
		}

		if (this._mouseDistanceMet(event) && this._mouseDelayMet(event)) {
			this._mouseStarted =
				(this._mouseStart(this._mouseDownEvent, event) !== false);
			(this._mouseStarted ? this._mouseDrag(event) : this._mouseUp(event));
		}

		return !this._mouseStarted;
	},

	_mouseUp: function(event) {
		this.document
			.unbind( "mousemove." + this.widgetName, this._mouseMoveDelegate )
			.unbind( "mouseup." + this.widgetName, this._mouseUpDelegate );

		if (this._mouseStarted) {
			this._mouseStarted = false;

			if (event.target === this._mouseDownEvent.target) {
				$.data(event.target, this.widgetName + ".preventClickEvent", true);
			}

			this._mouseStop(event);
		}

		mouseHandled = false;
		return false;
	},

	_mouseDistanceMet: function(event) {
		return (Math.max(
				Math.abs(this._mouseDownEvent.pageX - event.pageX),
				Math.abs(this._mouseDownEvent.pageY - event.pageY)
			) >= this.options.distance
		);
	},

	_mouseDelayMet: function(/* event */) {
		return this.mouseDelayMet;
	},

	// These are placeholder methods, to be overriden by extending plugin
	_mouseStart: function(/* event */) {},
	_mouseDrag: function(/* event */) {},
	_mouseStop: function(/* event */) {},
	_mouseCapture: function(/* event */) { return true; }
});


/*!
 * jQuery UI Position 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/position/
 */

(function() {

$.ui = $.ui || {};

var cachedScrollbarWidth, supportsOffsetFractions,
	max = Math.max,
	abs = Math.abs,
	round = Math.round,
	rhorizontal = /left|center|right/,
	rvertical = /top|center|bottom/,
	roffset = /[\+\-]\d+(\.[\d]+)?%?/,
	rposition = /^\w+/,
	rpercent = /%$/,
	_position = $.fn.position;

function getOffsets( offsets, width, height ) {
	return [
		parseFloat( offsets[ 0 ] ) * ( rpercent.test( offsets[ 0 ] ) ? width / 100 : 1 ),
		parseFloat( offsets[ 1 ] ) * ( rpercent.test( offsets[ 1 ] ) ? height / 100 : 1 )
	];
}

function parseCss( element, property ) {
	return parseInt( $.css( element, property ), 10 ) || 0;
}

function getDimensions( elem ) {
	var raw = elem[0];
	if ( raw.nodeType === 9 ) {
		return {
			width: elem.width(),
			height: elem.height(),
			offset: { top: 0, left: 0 }
		};
	}
	if ( $.isWindow( raw ) ) {
		return {
			width: elem.width(),
			height: elem.height(),
			offset: { top: elem.scrollTop(), left: elem.scrollLeft() }
		};
	}
	if ( raw.preventDefault ) {
		return {
			width: 0,
			height: 0,
			offset: { top: raw.pageY, left: raw.pageX }
		};
	}
	return {
		width: elem.outerWidth(),
		height: elem.outerHeight(),
		offset: elem.offset()
	};
}

$.position = {
	scrollbarWidth: function() {
		if ( cachedScrollbarWidth !== undefined ) {
			return cachedScrollbarWidth;
		}
		var w1, w2,
			div = $( "<div style='display:block;position:absolute;width:50px;height:50px;overflow:hidden;'><div style='height:100px;width:auto;'></div></div>" ),
			innerDiv = div.children()[0];

		$( "body" ).append( div );
		w1 = innerDiv.offsetWidth;
		div.css( "overflow", "scroll" );

		w2 = innerDiv.offsetWidth;

		if ( w1 === w2 ) {
			w2 = div[0].clientWidth;
		}

		div.remove();

		return (cachedScrollbarWidth = w1 - w2);
	},
	getScrollInfo: function( within ) {
		var overflowX = within.isWindow || within.isDocument ? "" :
				within.element.css( "overflow-x" ),
			overflowY = within.isWindow || within.isDocument ? "" :
				within.element.css( "overflow-y" ),
			hasOverflowX = overflowX === "scroll" ||
				( overflowX === "auto" && within.width < within.element[0].scrollWidth ),
			hasOverflowY = overflowY === "scroll" ||
				( overflowY === "auto" && within.height < within.element[0].scrollHeight );
		return {
			width: hasOverflowY ? $.position.scrollbarWidth() : 0,
			height: hasOverflowX ? $.position.scrollbarWidth() : 0
		};
	},
	getWithinInfo: function( element ) {
		var withinElement = $( element || window ),
			isWindow = $.isWindow( withinElement[0] ),
			isDocument = !!withinElement[ 0 ] && withinElement[ 0 ].nodeType === 9;
		return {
			element: withinElement,
			isWindow: isWindow,
			isDocument: isDocument,
			offset: withinElement.offset() || { left: 0, top: 0 },
			scrollLeft: withinElement.scrollLeft(),
			scrollTop: withinElement.scrollTop(),

			// support: jQuery 1.6.x
			// jQuery 1.6 doesn't support .outerWidth/Height() on documents or windows
			width: isWindow || isDocument ? withinElement.width() : withinElement.outerWidth(),
			height: isWindow || isDocument ? withinElement.height() : withinElement.outerHeight()
		};
	}
};

$.fn.position = function( options ) {
	if ( !options || !options.of ) {
		return _position.apply( this, arguments );
	}

	// make a copy, we don't want to modify arguments
	options = $.extend( {}, options );

	var atOffset, targetWidth, targetHeight, targetOffset, basePosition, dimensions,
		target = $( options.of ),
		within = $.position.getWithinInfo( options.within ),
		scrollInfo = $.position.getScrollInfo( within ),
		collision = ( options.collision || "flip" ).split( " " ),
		offsets = {};

	dimensions = getDimensions( target );
	if ( target[0].preventDefault ) {
		// force left top to allow flipping
		options.at = "left top";
	}
	targetWidth = dimensions.width;
	targetHeight = dimensions.height;
	targetOffset = dimensions.offset;
	// clone to reuse original targetOffset later
	basePosition = $.extend( {}, targetOffset );

	// force my and at to have valid horizontal and vertical positions
	// if a value is missing or invalid, it will be converted to center
	$.each( [ "my", "at" ], function() {
		var pos = ( options[ this ] || "" ).split( " " ),
			horizontalOffset,
			verticalOffset;

		if ( pos.length === 1) {
			pos = rhorizontal.test( pos[ 0 ] ) ?
				pos.concat( [ "center" ] ) :
				rvertical.test( pos[ 0 ] ) ?
					[ "center" ].concat( pos ) :
					[ "center", "center" ];
		}
		pos[ 0 ] = rhorizontal.test( pos[ 0 ] ) ? pos[ 0 ] : "center";
		pos[ 1 ] = rvertical.test( pos[ 1 ] ) ? pos[ 1 ] : "center";

		// calculate offsets
		horizontalOffset = roffset.exec( pos[ 0 ] );
		verticalOffset = roffset.exec( pos[ 1 ] );
		offsets[ this ] = [
			horizontalOffset ? horizontalOffset[ 0 ] : 0,
			verticalOffset ? verticalOffset[ 0 ] : 0
		];

		// reduce to just the positions without the offsets
		options[ this ] = [
			rposition.exec( pos[ 0 ] )[ 0 ],
			rposition.exec( pos[ 1 ] )[ 0 ]
		];
	});

	// normalize collision option
	if ( collision.length === 1 ) {
		collision[ 1 ] = collision[ 0 ];
	}

	if ( options.at[ 0 ] === "right" ) {
		basePosition.left += targetWidth;
	} else if ( options.at[ 0 ] === "center" ) {
		basePosition.left += targetWidth / 2;
	}

	if ( options.at[ 1 ] === "bottom" ) {
		basePosition.top += targetHeight;
	} else if ( options.at[ 1 ] === "center" ) {
		basePosition.top += targetHeight / 2;
	}

	atOffset = getOffsets( offsets.at, targetWidth, targetHeight );
	basePosition.left += atOffset[ 0 ];
	basePosition.top += atOffset[ 1 ];

	return this.each(function() {
		var collisionPosition, using,
			elem = $( this ),
			elemWidth = elem.outerWidth(),
			elemHeight = elem.outerHeight(),
			marginLeft = parseCss( this, "marginLeft" ),
			marginTop = parseCss( this, "marginTop" ),
			collisionWidth = elemWidth + marginLeft + parseCss( this, "marginRight" ) + scrollInfo.width,
			collisionHeight = elemHeight + marginTop + parseCss( this, "marginBottom" ) + scrollInfo.height,
			position = $.extend( {}, basePosition ),
			myOffset = getOffsets( offsets.my, elem.outerWidth(), elem.outerHeight() );

		if ( options.my[ 0 ] === "right" ) {
			position.left -= elemWidth;
		} else if ( options.my[ 0 ] === "center" ) {
			position.left -= elemWidth / 2;
		}

		if ( options.my[ 1 ] === "bottom" ) {
			position.top -= elemHeight;
		} else if ( options.my[ 1 ] === "center" ) {
			position.top -= elemHeight / 2;
		}

		position.left += myOffset[ 0 ];
		position.top += myOffset[ 1 ];

		// if the browser doesn't support fractions, then round for consistent results
		if ( !supportsOffsetFractions ) {
			position.left = round( position.left );
			position.top = round( position.top );
		}

		collisionPosition = {
			marginLeft: marginLeft,
			marginTop: marginTop
		};

		$.each( [ "left", "top" ], function( i, dir ) {
			if ( $.ui.position[ collision[ i ] ] ) {
				$.ui.position[ collision[ i ] ][ dir ]( position, {
					targetWidth: targetWidth,
					targetHeight: targetHeight,
					elemWidth: elemWidth,
					elemHeight: elemHeight,
					collisionPosition: collisionPosition,
					collisionWidth: collisionWidth,
					collisionHeight: collisionHeight,
					offset: [ atOffset[ 0 ] + myOffset[ 0 ], atOffset [ 1 ] + myOffset[ 1 ] ],
					my: options.my,
					at: options.at,
					within: within,
					elem: elem
				});
			}
		});

		if ( options.using ) {
			// adds feedback as second argument to using callback, if present
			using = function( props ) {
				var left = targetOffset.left - position.left,
					right = left + targetWidth - elemWidth,
					top = targetOffset.top - position.top,
					bottom = top + targetHeight - elemHeight,
					feedback = {
						target: {
							element: target,
							left: targetOffset.left,
							top: targetOffset.top,
							width: targetWidth,
							height: targetHeight
						},
						element: {
							element: elem,
							left: position.left,
							top: position.top,
							width: elemWidth,
							height: elemHeight
						},
						horizontal: right < 0 ? "left" : left > 0 ? "right" : "center",
						vertical: bottom < 0 ? "top" : top > 0 ? "bottom" : "middle"
					};
				if ( targetWidth < elemWidth && abs( left + right ) < targetWidth ) {
					feedback.horizontal = "center";
				}
				if ( targetHeight < elemHeight && abs( top + bottom ) < targetHeight ) {
					feedback.vertical = "middle";
				}
				if ( max( abs( left ), abs( right ) ) > max( abs( top ), abs( bottom ) ) ) {
					feedback.important = "horizontal";
				} else {
					feedback.important = "vertical";
				}
				options.using.call( this, props, feedback );
			};
		}

		elem.offset( $.extend( position, { using: using } ) );
	});
};

$.ui.position = {
	fit: {
		left: function( position, data ) {
			var within = data.within,
				withinOffset = within.isWindow ? within.scrollLeft : within.offset.left,
				outerWidth = within.width,
				collisionPosLeft = position.left - data.collisionPosition.marginLeft,
				overLeft = withinOffset - collisionPosLeft,
				overRight = collisionPosLeft + data.collisionWidth - outerWidth - withinOffset,
				newOverRight;

			// element is wider than within
			if ( data.collisionWidth > outerWidth ) {
				// element is initially over the left side of within
				if ( overLeft > 0 && overRight <= 0 ) {
					newOverRight = position.left + overLeft + data.collisionWidth - outerWidth - withinOffset;
					position.left += overLeft - newOverRight;
				// element is initially over right side of within
				} else if ( overRight > 0 && overLeft <= 0 ) {
					position.left = withinOffset;
				// element is initially over both left and right sides of within
				} else {
					if ( overLeft > overRight ) {
						position.left = withinOffset + outerWidth - data.collisionWidth;
					} else {
						position.left = withinOffset;
					}
				}
			// too far left -> align with left edge
			} else if ( overLeft > 0 ) {
				position.left += overLeft;
			// too far right -> align with right edge
			} else if ( overRight > 0 ) {
				position.left -= overRight;
			// adjust based on position and margin
			} else {
				position.left = max( position.left - collisionPosLeft, position.left );
			}
		},
		top: function( position, data ) {
			var within = data.within,
				withinOffset = within.isWindow ? within.scrollTop : within.offset.top,
				outerHeight = data.within.height,
				collisionPosTop = position.top - data.collisionPosition.marginTop,
				overTop = withinOffset - collisionPosTop,
				overBottom = collisionPosTop + data.collisionHeight - outerHeight - withinOffset,
				newOverBottom;

			// element is taller than within
			if ( data.collisionHeight > outerHeight ) {
				// element is initially over the top of within
				if ( overTop > 0 && overBottom <= 0 ) {
					newOverBottom = position.top + overTop + data.collisionHeight - outerHeight - withinOffset;
					position.top += overTop - newOverBottom;
				// element is initially over bottom of within
				} else if ( overBottom > 0 && overTop <= 0 ) {
					position.top = withinOffset;
				// element is initially over both top and bottom of within
				} else {
					if ( overTop > overBottom ) {
						position.top = withinOffset + outerHeight - data.collisionHeight;
					} else {
						position.top = withinOffset;
					}
				}
			// too far up -> align with top
			} else if ( overTop > 0 ) {
				position.top += overTop;
			// too far down -> align with bottom edge
			} else if ( overBottom > 0 ) {
				position.top -= overBottom;
			// adjust based on position and margin
			} else {
				position.top = max( position.top - collisionPosTop, position.top );
			}
		}
	},
	flip: {
		left: function( position, data ) {
			var within = data.within,
				withinOffset = within.offset.left + within.scrollLeft,
				outerWidth = within.width,
				offsetLeft = within.isWindow ? within.scrollLeft : within.offset.left,
				collisionPosLeft = position.left - data.collisionPosition.marginLeft,
				overLeft = collisionPosLeft - offsetLeft,
				overRight = collisionPosLeft + data.collisionWidth - outerWidth - offsetLeft,
				myOffset = data.my[ 0 ] === "left" ?
					-data.elemWidth :
					data.my[ 0 ] === "right" ?
						data.elemWidth :
						0,
				atOffset = data.at[ 0 ] === "left" ?
					data.targetWidth :
					data.at[ 0 ] === "right" ?
						-data.targetWidth :
						0,
				offset = -2 * data.offset[ 0 ],
				newOverRight,
				newOverLeft;

			if ( overLeft < 0 ) {
				newOverRight = position.left + myOffset + atOffset + offset + data.collisionWidth - outerWidth - withinOffset;
				if ( newOverRight < 0 || newOverRight < abs( overLeft ) ) {
					position.left += myOffset + atOffset + offset;
				}
			} else if ( overRight > 0 ) {
				newOverLeft = position.left - data.collisionPosition.marginLeft + myOffset + atOffset + offset - offsetLeft;
				if ( newOverLeft > 0 || abs( newOverLeft ) < overRight ) {
					position.left += myOffset + atOffset + offset;
				}
			}
		},
		top: function( position, data ) {
			var within = data.within,
				withinOffset = within.offset.top + within.scrollTop,
				outerHeight = within.height,
				offsetTop = within.isWindow ? within.scrollTop : within.offset.top,
				collisionPosTop = position.top - data.collisionPosition.marginTop,
				overTop = collisionPosTop - offsetTop,
				overBottom = collisionPosTop + data.collisionHeight - outerHeight - offsetTop,
				top = data.my[ 1 ] === "top",
				myOffset = top ?
					-data.elemHeight :
					data.my[ 1 ] === "bottom" ?
						data.elemHeight :
						0,
				atOffset = data.at[ 1 ] === "top" ?
					data.targetHeight :
					data.at[ 1 ] === "bottom" ?
						-data.targetHeight :
						0,
				offset = -2 * data.offset[ 1 ],
				newOverTop,
				newOverBottom;
			if ( overTop < 0 ) {
				newOverBottom = position.top + myOffset + atOffset + offset + data.collisionHeight - outerHeight - withinOffset;
				if ( newOverBottom < 0 || newOverBottom < abs( overTop ) ) {
					position.top += myOffset + atOffset + offset;
				}
			} else if ( overBottom > 0 ) {
				newOverTop = position.top - data.collisionPosition.marginTop + myOffset + atOffset + offset - offsetTop;
				if ( newOverTop > 0 || abs( newOverTop ) < overBottom ) {
					position.top += myOffset + atOffset + offset;
				}
			}
		}
	},
	flipfit: {
		left: function() {
			$.ui.position.flip.left.apply( this, arguments );
			$.ui.position.fit.left.apply( this, arguments );
		},
		top: function() {
			$.ui.position.flip.top.apply( this, arguments );
			$.ui.position.fit.top.apply( this, arguments );
		}
	}
};

// fraction support test
(function() {
	var testElement, testElementParent, testElementStyle, offsetLeft, i,
		body = document.getElementsByTagName( "body" )[ 0 ],
		div = document.createElement( "div" );

	//Create a "fake body" for testing based on method used in jQuery.support
	testElement = document.createElement( body ? "div" : "body" );
	testElementStyle = {
		visibility: "hidden",
		width: 0,
		height: 0,
		border: 0,
		margin: 0,
		background: "none"
	};
	if ( body ) {
		$.extend( testElementStyle, {
			position: "absolute",
			left: "-1000px",
			top: "-1000px"
		});
	}
	for ( i in testElementStyle ) {
		testElement.style[ i ] = testElementStyle[ i ];
	}
	testElement.appendChild( div );
	testElementParent = body || document.documentElement;
	testElementParent.insertBefore( testElement, testElementParent.firstChild );

	div.style.cssText = "position: absolute; left: 10.7432222px;";

	offsetLeft = $( div ).offset().left;
	supportsOffsetFractions = offsetLeft > 10 && offsetLeft < 11;

	testElement.innerHTML = "";
	testElementParent.removeChild( testElement );
})();

})();

var position = $.ui.position;


/*!
 * jQuery UI Accordion 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/accordion/
 */


var accordion = $.widget( "ui.accordion", {
	version: "1.11.4",
	options: {
		active: 0,
		animate: {},
		collapsible: false,
		event: "click",
		header: "> li > :first-child,> :not(li):even",
		heightStyle: "auto",
		icons: {
			activeHeader: "ui-icon-triangle-1-s",
			header: "ui-icon-triangle-1-e"
		},

		// callbacks
		activate: null,
		beforeActivate: null
	},

	hideProps: {
		borderTopWidth: "hide",
		borderBottomWidth: "hide",
		paddingTop: "hide",
		paddingBottom: "hide",
		height: "hide"
	},

	showProps: {
		borderTopWidth: "show",
		borderBottomWidth: "show",
		paddingTop: "show",
		paddingBottom: "show",
		height: "show"
	},

	_create: function() {
		var options = this.options;
		this.prevShow = this.prevHide = $();
		this.element.addClass( "ui-accordion ui-widget ui-helper-reset" )
			// ARIA
			.attr( "role", "tablist" );

		// don't allow collapsible: false and active: false / null
		if ( !options.collapsible && (options.active === false || options.active == null) ) {
			options.active = 0;
		}

		this._processPanels();
		// handle negative values
		if ( options.active < 0 ) {
			options.active += this.headers.length;
		}
		this._refresh();
	},

	_getCreateEventData: function() {
		return {
			header: this.active,
			panel: !this.active.length ? $() : this.active.next()
		};
	},

	_createIcons: function() {
		var icons = this.options.icons;
		if ( icons ) {
			$( "<span>" )
				.addClass( "ui-accordion-header-icon ui-icon " + icons.header )
				.prependTo( this.headers );
			this.active.children( ".ui-accordion-header-icon" )
				.removeClass( icons.header )
				.addClass( icons.activeHeader );
			this.headers.addClass( "ui-accordion-icons" );
		}
	},

	_destroyIcons: function() {
		this.headers
			.removeClass( "ui-accordion-icons" )
			.children( ".ui-accordion-header-icon" )
				.remove();
	},

	_destroy: function() {
		var contents;

		// clean up main element
		this.element
			.removeClass( "ui-accordion ui-widget ui-helper-reset" )
			.removeAttr( "role" );

		// clean up headers
		this.headers
			.removeClass( "ui-accordion-header ui-accordion-header-active ui-state-default " +
				"ui-corner-all ui-state-active ui-state-disabled ui-corner-top" )
			.removeAttr( "role" )
			.removeAttr( "aria-expanded" )
			.removeAttr( "aria-selected" )
			.removeAttr( "aria-controls" )
			.removeAttr( "tabIndex" )
			.removeUniqueId();

		this._destroyIcons();

		// clean up content panels
		contents = this.headers.next()
			.removeClass( "ui-helper-reset ui-widget-content ui-corner-bottom " +
				"ui-accordion-content ui-accordion-content-active ui-state-disabled" )
			.css( "display", "" )
			.removeAttr( "role" )
			.removeAttr( "aria-hidden" )
			.removeAttr( "aria-labelledby" )
			.removeUniqueId();

		if ( this.options.heightStyle !== "content" ) {
			contents.css( "height", "" );
		}
	},

	_setOption: function( key, value ) {
		if ( key === "active" ) {
			// _activate() will handle invalid values and update this.options
			this._activate( value );
			return;
		}

		if ( key === "event" ) {
			if ( this.options.event ) {
				this._off( this.headers, this.options.event );
			}
			this._setupEvents( value );
		}

		this._super( key, value );

		// setting collapsible: false while collapsed; open first panel
		if ( key === "collapsible" && !value && this.options.active === false ) {
			this._activate( 0 );
		}

		if ( key === "icons" ) {
			this._destroyIcons();
			if ( value ) {
				this._createIcons();
			}
		}

		// #5332 - opacity doesn't cascade to positioned elements in IE
		// so we need to add the disabled class to the headers and panels
		if ( key === "disabled" ) {
			this.element
				.toggleClass( "ui-state-disabled", !!value )
				.attr( "aria-disabled", value );
			this.headers.add( this.headers.next() )
				.toggleClass( "ui-state-disabled", !!value );
		}
	},

	_keydown: function( event ) {
		if ( event.altKey || event.ctrlKey ) {
			return;
		}

		var keyCode = $.ui.keyCode,
			length = this.headers.length,
			currentIndex = this.headers.index( event.target ),
			toFocus = false;

		switch ( event.keyCode ) {
			case keyCode.RIGHT:
			case keyCode.DOWN:
				toFocus = this.headers[ ( currentIndex + 1 ) % length ];
				break;
			case keyCode.LEFT:
			case keyCode.UP:
				toFocus = this.headers[ ( currentIndex - 1 + length ) % length ];
				break;
			case keyCode.SPACE:
			case keyCode.ENTER:
				this._eventHandler( event );
				break;
			case keyCode.HOME:
				toFocus = this.headers[ 0 ];
				break;
			case keyCode.END:
				toFocus = this.headers[ length - 1 ];
				break;
		}

		if ( toFocus ) {
			$( event.target ).attr( "tabIndex", -1 );
			$( toFocus ).attr( "tabIndex", 0 );
			toFocus.focus();
			event.preventDefault();
		}
	},

	_panelKeyDown: function( event ) {
		if ( event.keyCode === $.ui.keyCode.UP && event.ctrlKey ) {
			$( event.currentTarget ).prev().focus();
		}
	},

	refresh: function() {
		var options = this.options;
		this._processPanels();

		// was collapsed or no panel
		if ( ( options.active === false && options.collapsible === true ) || !this.headers.length ) {
			options.active = false;
			this.active = $();
		// active false only when collapsible is true
		} else if ( options.active === false ) {
			this._activate( 0 );
		// was active, but active panel is gone
		} else if ( this.active.length && !$.contains( this.element[ 0 ], this.active[ 0 ] ) ) {
			// all remaining panel are disabled
			if ( this.headers.length === this.headers.find(".ui-state-disabled").length ) {
				options.active = false;
				this.active = $();
			// activate previous panel
			} else {
				this._activate( Math.max( 0, options.active - 1 ) );
			}
		// was active, active panel still exists
		} else {
			// make sure active index is correct
			options.active = this.headers.index( this.active );
		}

		this._destroyIcons();

		this._refresh();
	},

	_processPanels: function() {
		var prevHeaders = this.headers,
			prevPanels = this.panels;

		this.headers = this.element.find( this.options.header )
			.addClass( "ui-accordion-header ui-state-default ui-corner-all" );

		this.panels = this.headers.next()
			.addClass( "ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom" )
			.filter( ":not(.ui-accordion-content-active)" )
			.hide();

		// Avoid memory leaks (#10056)
		if ( prevPanels ) {
			this._off( prevHeaders.not( this.headers ) );
			this._off( prevPanels.not( this.panels ) );
		}
	},

	_refresh: function() {
		var maxHeight,
			options = this.options,
			heightStyle = options.heightStyle,
			parent = this.element.parent();

		this.active = this._findActive( options.active )
			.addClass( "ui-accordion-header-active ui-state-active ui-corner-top" )
			.removeClass( "ui-corner-all" );
		this.active.next()
			.addClass( "ui-accordion-content-active" )
			.show();

		this.headers
			.attr( "role", "tab" )
			.each(function() {
				var header = $( this ),
					headerId = header.uniqueId().attr( "id" ),
					panel = header.next(),
					panelId = panel.uniqueId().attr( "id" );
				header.attr( "aria-controls", panelId );
				panel.attr( "aria-labelledby", headerId );
			})
			.next()
				.attr( "role", "tabpanel" );

		this.headers
			.not( this.active )
			.attr({
				"aria-selected": "false",
				"aria-expanded": "false",
				tabIndex: -1
			})
			.next()
				.attr({
					"aria-hidden": "true"
				})
				.hide();

		// make sure at least one header is in the tab order
		if ( !this.active.length ) {
			this.headers.eq( 0 ).attr( "tabIndex", 0 );
		} else {
			this.active.attr({
				"aria-selected": "true",
				"aria-expanded": "true",
				tabIndex: 0
			})
			.next()
				.attr({
					"aria-hidden": "false"
				});
		}

		this._createIcons();

		this._setupEvents( options.event );

		if ( heightStyle === "fill" ) {
			maxHeight = parent.height();
			this.element.siblings( ":visible" ).each(function() {
				var elem = $( this ),
					position = elem.css( "position" );

				if ( position === "absolute" || position === "fixed" ) {
					return;
				}
				maxHeight -= elem.outerHeight( true );
			});

			this.headers.each(function() {
				maxHeight -= $( this ).outerHeight( true );
			});

			this.headers.next()
				.each(function() {
					$( this ).height( Math.max( 0, maxHeight -
						$( this ).innerHeight() + $( this ).height() ) );
				})
				.css( "overflow", "auto" );
		} else if ( heightStyle === "auto" ) {
			maxHeight = 0;
			this.headers.next()
				.each(function() {
					maxHeight = Math.max( maxHeight, $( this ).css( "height", "" ).height() );
				})
				.height( maxHeight );
		}
	},

	_activate: function( index ) {
		var active = this._findActive( index )[ 0 ];

		// trying to activate the already active panel
		if ( active === this.active[ 0 ] ) {
			return;
		}

		// trying to collapse, simulate a click on the currently active header
		active = active || this.active[ 0 ];

		this._eventHandler({
			target: active,
			currentTarget: active,
			preventDefault: $.noop
		});
	},

	_findActive: function( selector ) {
		return typeof selector === "number" ? this.headers.eq( selector ) : $();
	},

	_setupEvents: function( event ) {
		var events = {
			keydown: "_keydown"
		};
		if ( event ) {
			$.each( event.split( " " ), function( index, eventName ) {
				events[ eventName ] = "_eventHandler";
			});
		}

		this._off( this.headers.add( this.headers.next() ) );
		this._on( this.headers, events );
		this._on( this.headers.next(), { keydown: "_panelKeyDown" });
		this._hoverable( this.headers );
		this._focusable( this.headers );
	},

	_eventHandler: function( event ) {
		var options = this.options,
			active = this.active,
			clicked = $( event.currentTarget ),
			clickedIsActive = clicked[ 0 ] === active[ 0 ],
			collapsing = clickedIsActive && options.collapsible,
			toShow = collapsing ? $() : clicked.next(),
			toHide = active.next(),
			eventData = {
				oldHeader: active,
				oldPanel: toHide,
				newHeader: collapsing ? $() : clicked,
				newPanel: toShow
			};

		event.preventDefault();

		if (
				// click on active header, but not collapsible
				( clickedIsActive && !options.collapsible ) ||
				// allow canceling activation
				( this._trigger( "beforeActivate", event, eventData ) === false ) ) {
			return;
		}

		options.active = collapsing ? false : this.headers.index( clicked );

		// when the call to ._toggle() comes after the class changes
		// it causes a very odd bug in IE 8 (see #6720)
		this.active = clickedIsActive ? $() : clicked;
		this._toggle( eventData );

		// switch classes
		// corner classes on the previously active header stay after the animation
		active.removeClass( "ui-accordion-header-active ui-state-active" );
		if ( options.icons ) {
			active.children( ".ui-accordion-header-icon" )
				.removeClass( options.icons.activeHeader )
				.addClass( options.icons.header );
		}

		if ( !clickedIsActive ) {
			clicked
				.removeClass( "ui-corner-all" )
				.addClass( "ui-accordion-header-active ui-state-active ui-corner-top" );
			if ( options.icons ) {
				clicked.children( ".ui-accordion-header-icon" )
					.removeClass( options.icons.header )
					.addClass( options.icons.activeHeader );
			}

			clicked
				.next()
				.addClass( "ui-accordion-content-active" );
		}
	},

	_toggle: function( data ) {
		var toShow = data.newPanel,
			toHide = this.prevShow.length ? this.prevShow : data.oldPanel;

		// handle activating a panel during the animation for another activation
		this.prevShow.add( this.prevHide ).stop( true, true );
		this.prevShow = toShow;
		this.prevHide = toHide;

		if ( this.options.animate ) {
			this._animate( toShow, toHide, data );
		} else {
			toHide.hide();
			toShow.show();
			this._toggleComplete( data );
		}

		toHide.attr({
			"aria-hidden": "true"
		});
		toHide.prev().attr({
			"aria-selected": "false",
			"aria-expanded": "false"
		});
		// if we're switching panels, remove the old header from the tab order
		// if we're opening from collapsed state, remove the previous header from the tab order
		// if we're collapsing, then keep the collapsing header in the tab order
		if ( toShow.length && toHide.length ) {
			toHide.prev().attr({
				"tabIndex": -1,
				"aria-expanded": "false"
			});
		} else if ( toShow.length ) {
			this.headers.filter(function() {
				return parseInt( $( this ).attr( "tabIndex" ), 10 ) === 0;
			})
			.attr( "tabIndex", -1 );
		}

		toShow
			.attr( "aria-hidden", "false" )
			.prev()
				.attr({
					"aria-selected": "true",
					"aria-expanded": "true",
					tabIndex: 0
				});
	},

	_animate: function( toShow, toHide, data ) {
		var total, easing, duration,
			that = this,
			adjust = 0,
			boxSizing = toShow.css( "box-sizing" ),
			down = toShow.length &&
				( !toHide.length || ( toShow.index() < toHide.index() ) ),
			animate = this.options.animate || {},
			options = down && animate.down || animate,
			complete = function() {
				that._toggleComplete( data );
			};

		if ( typeof options === "number" ) {
			duration = options;
		}
		if ( typeof options === "string" ) {
			easing = options;
		}
		// fall back from options to animation in case of partial down settings
		easing = easing || options.easing || animate.easing;
		duration = duration || options.duration || animate.duration;

		if ( !toHide.length ) {
			return toShow.animate( this.showProps, duration, easing, complete );
		}
		if ( !toShow.length ) {
			return toHide.animate( this.hideProps, duration, easing, complete );
		}

		total = toShow.show().outerHeight();
		toHide.animate( this.hideProps, {
			duration: duration,
			easing: easing,
			step: function( now, fx ) {
				fx.now = Math.round( now );
			}
		});
		toShow
			.hide()
			.animate( this.showProps, {
				duration: duration,
				easing: easing,
				complete: complete,
				step: function( now, fx ) {
					fx.now = Math.round( now );
					if ( fx.prop !== "height" ) {
						if ( boxSizing === "content-box" ) {
							adjust += fx.now;
						}
					} else if ( that.options.heightStyle !== "content" ) {
						fx.now = Math.round( total - toHide.outerHeight() - adjust );
						adjust = 0;
					}
				}
			});
	},

	_toggleComplete: function( data ) {
		var toHide = data.oldPanel;

		toHide
			.removeClass( "ui-accordion-content-active" )
			.prev()
				.removeClass( "ui-corner-top" )
				.addClass( "ui-corner-all" );

		// Work around for rendering bug in IE (#5421)
		if ( toHide.length ) {
			toHide.parent()[ 0 ].className = toHide.parent()[ 0 ].className;
		}
		this._trigger( "activate", null, data );
	}
});


/*!
 * jQuery UI Menu 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/menu/
 */


var menu = $.widget( "ui.menu", {
	version: "1.11.4",
	defaultElement: "<ul>",
	delay: 300,
	options: {
		icons: {
			submenu: "ui-icon-carat-1-e"
		},
		items: "> *",
		menus: "ul",
		position: {
			my: "left-1 top",
			at: "right top"
		},
		role: "menu",

		// callbacks
		blur: null,
		focus: null,
		select: null
	},

	_create: function() {
		this.activeMenu = this.element;

		// Flag used to prevent firing of the click handler
		// as the event bubbles up through nested menus
		this.mouseHandled = false;
		this.element
			.uniqueId()
			.addClass( "ui-menu ui-widget ui-widget-content" )
			.toggleClass( "ui-menu-icons", !!this.element.find( ".ui-icon" ).length )
			.attr({
				role: this.options.role,
				tabIndex: 0
			});

		if ( this.options.disabled ) {
			this.element
				.addClass( "ui-state-disabled" )
				.attr( "aria-disabled", "true" );
		}

		this._on({
			// Prevent focus from sticking to links inside menu after clicking
			// them (focus should always stay on UL during navigation).
			"mousedown .ui-menu-item": function( event ) {
				event.preventDefault();
			},
			"click .ui-menu-item": function( event ) {
				var target = $( event.target );
				if ( !this.mouseHandled && target.not( ".ui-state-disabled" ).length ) {
					this.select( event );

					// Only set the mouseHandled flag if the event will bubble, see #9469.
					if ( !event.isPropagationStopped() ) {
						this.mouseHandled = true;
					}

					// Open submenu on click
					if ( target.has( ".ui-menu" ).length ) {
						this.expand( event );
					} else if ( !this.element.is( ":focus" ) && $( this.document[ 0 ].activeElement ).closest( ".ui-menu" ).length ) {

						// Redirect focus to the menu
						this.element.trigger( "focus", [ true ] );

						// If the active item is on the top level, let it stay active.
						// Otherwise, blur the active item since it is no longer visible.
						if ( this.active && this.active.parents( ".ui-menu" ).length === 1 ) {
							clearTimeout( this.timer );
						}
					}
				}
			},
			"mouseenter .ui-menu-item": function( event ) {
				// Ignore mouse events while typeahead is active, see #10458.
				// Prevents focusing the wrong item when typeahead causes a scroll while the mouse
				// is over an item in the menu
				if ( this.previousFilter ) {
					return;
				}
				var target = $( event.currentTarget );
				// Remove ui-state-active class from siblings of the newly focused menu item
				// to avoid a jump caused by adjacent elements both having a class with a border
				target.siblings( ".ui-state-active" ).removeClass( "ui-state-active" );
				this.focus( event, target );
			},
			mouseleave: "collapseAll",
			"mouseleave .ui-menu": "collapseAll",
			focus: function( event, keepActiveItem ) {
				// If there's already an active item, keep it active
				// If not, activate the first item
				var item = this.active || this.element.find( this.options.items ).eq( 0 );

				if ( !keepActiveItem ) {
					this.focus( event, item );
				}
			},
			blur: function( event ) {
				this._delay(function() {
					if ( !$.contains( this.element[0], this.document[0].activeElement ) ) {
						this.collapseAll( event );
					}
				});
			},
			keydown: "_keydown"
		});

		this.refresh();

		// Clicks outside of a menu collapse any open menus
		this._on( this.document, {
			click: function( event ) {
				if ( this._closeOnDocumentClick( event ) ) {
					this.collapseAll( event );
				}

				// Reset the mouseHandled flag
				this.mouseHandled = false;
			}
		});
	},

	_destroy: function() {
		// Destroy (sub)menus
		this.element
			.removeAttr( "aria-activedescendant" )
			.find( ".ui-menu" ).addBack()
				.removeClass( "ui-menu ui-widget ui-widget-content ui-menu-icons ui-front" )
				.removeAttr( "role" )
				.removeAttr( "tabIndex" )
				.removeAttr( "aria-labelledby" )
				.removeAttr( "aria-expanded" )
				.removeAttr( "aria-hidden" )
				.removeAttr( "aria-disabled" )
				.removeUniqueId()
				.show();

		// Destroy menu items
		this.element.find( ".ui-menu-item" )
			.removeClass( "ui-menu-item" )
			.removeAttr( "role" )
			.removeAttr( "aria-disabled" )
			.removeUniqueId()
			.removeClass( "ui-state-hover" )
			.removeAttr( "tabIndex" )
			.removeAttr( "role" )
			.removeAttr( "aria-haspopup" )
			.children().each( function() {
				var elem = $( this );
				if ( elem.data( "ui-menu-submenu-carat" ) ) {
					elem.remove();
				}
			});

		// Destroy menu dividers
		this.element.find( ".ui-menu-divider" ).removeClass( "ui-menu-divider ui-widget-content" );
	},

	_keydown: function( event ) {
		var match, prev, character, skip,
			preventDefault = true;

		switch ( event.keyCode ) {
		case $.ui.keyCode.PAGE_UP:
			this.previousPage( event );
			break;
		case $.ui.keyCode.PAGE_DOWN:
			this.nextPage( event );
			break;
		case $.ui.keyCode.HOME:
			this._move( "first", "first", event );
			break;
		case $.ui.keyCode.END:
			this._move( "last", "last", event );
			break;
		case $.ui.keyCode.UP:
			this.previous( event );
			break;
		case $.ui.keyCode.DOWN:
			this.next( event );
			break;
		case $.ui.keyCode.LEFT:
			this.collapse( event );
			break;
		case $.ui.keyCode.RIGHT:
			if ( this.active && !this.active.is( ".ui-state-disabled" ) ) {
				this.expand( event );
			}
			break;
		case $.ui.keyCode.ENTER:
		case $.ui.keyCode.SPACE:
			this._activate( event );
			break;
		case $.ui.keyCode.ESCAPE:
			this.collapse( event );
			break;
		default:
			preventDefault = false;
			prev = this.previousFilter || "";
			character = String.fromCharCode( event.keyCode );
			skip = false;

			clearTimeout( this.filterTimer );

			if ( character === prev ) {
				skip = true;
			} else {
				character = prev + character;
			}

			match = this._filterMenuItems( character );
			match = skip && match.index( this.active.next() ) !== -1 ?
				this.active.nextAll( ".ui-menu-item" ) :
				match;

			// If no matches on the current filter, reset to the last character pressed
			// to move down the menu to the first item that starts with that character
			if ( !match.length ) {
				character = String.fromCharCode( event.keyCode );
				match = this._filterMenuItems( character );
			}

			if ( match.length ) {
				this.focus( event, match );
				this.previousFilter = character;
				this.filterTimer = this._delay(function() {
					delete this.previousFilter;
				}, 1000 );
			} else {
				delete this.previousFilter;
			}
		}

		if ( preventDefault ) {
			event.preventDefault();
		}
	},

	_activate: function( event ) {
		if ( !this.active.is( ".ui-state-disabled" ) ) {
			if ( this.active.is( "[aria-haspopup='true']" ) ) {
				this.expand( event );
			} else {
				this.select( event );
			}
		}
	},

	refresh: function() {
		var menus, items,
			that = this,
			icon = this.options.icons.submenu,
			submenus = this.element.find( this.options.menus );

		this.element.toggleClass( "ui-menu-icons", !!this.element.find( ".ui-icon" ).length );

		// Initialize nested menus
		submenus.filter( ":not(.ui-menu)" )
			.addClass( "ui-menu ui-widget ui-widget-content ui-front" )
			.hide()
			.attr({
				role: this.options.role,
				"aria-hidden": "true",
				"aria-expanded": "false"
			})
			.each(function() {
				var menu = $( this ),
					item = menu.parent(),
					submenuCarat = $( "<span>" )
						.addClass( "ui-menu-icon ui-icon " + icon )
						.data( "ui-menu-submenu-carat", true );

				item
					.attr( "aria-haspopup", "true" )
					.prepend( submenuCarat );
				menu.attr( "aria-labelledby", item.attr( "id" ) );
			});

		menus = submenus.add( this.element );
		items = menus.find( this.options.items );

		// Initialize menu-items containing spaces and/or dashes only as dividers
		items.not( ".ui-menu-item" ).each(function() {
			var item = $( this );
			if ( that._isDivider( item ) ) {
				item.addClass( "ui-widget-content ui-menu-divider" );
			}
		});

		// Don't refresh list items that are already adapted
		items.not( ".ui-menu-item, .ui-menu-divider" )
			.addClass( "ui-menu-item" )
			.uniqueId()
			.attr({
				tabIndex: -1,
				role: this._itemRole()
			});

		// Add aria-disabled attribute to any disabled menu item
		items.filter( ".ui-state-disabled" ).attr( "aria-disabled", "true" );

		// If the active item has been removed, blur the menu
		if ( this.active && !$.contains( this.element[ 0 ], this.active[ 0 ] ) ) {
			this.blur();
		}
	},

	_itemRole: function() {
		return {
			menu: "menuitem",
			listbox: "option"
		}[ this.options.role ];
	},

	_setOption: function( key, value ) {
		if ( key === "icons" ) {
			this.element.find( ".ui-menu-icon" )
				.removeClass( this.options.icons.submenu )
				.addClass( value.submenu );
		}
		if ( key === "disabled" ) {
			this.element
				.toggleClass( "ui-state-disabled", !!value )
				.attr( "aria-disabled", value );
		}
		this._super( key, value );
	},

	focus: function( event, item ) {
		var nested, focused;
		this.blur( event, event && event.type === "focus" );

		this._scrollIntoView( item );

		this.active = item.first();
		focused = this.active.addClass( "ui-state-focus" ).removeClass( "ui-state-active" );
		// Only update aria-activedescendant if there's a role
		// otherwise we assume focus is managed elsewhere
		if ( this.options.role ) {
			this.element.attr( "aria-activedescendant", focused.attr( "id" ) );
		}

		// Highlight active parent menu item, if any
		this.active
			.parent()
			.closest( ".ui-menu-item" )
			.addClass( "ui-state-active" );

		if ( event && event.type === "keydown" ) {
			this._close();
		} else {
			this.timer = this._delay(function() {
				this._close();
			}, this.delay );
		}

		nested = item.children( ".ui-menu" );
		if ( nested.length && event && ( /^mouse/.test( event.type ) ) ) {
			this._startOpening(nested);
		}
		this.activeMenu = item.parent();

		this._trigger( "focus", event, { item: item } );
	},

	_scrollIntoView: function( item ) {
		var borderTop, paddingTop, offset, scroll, elementHeight, itemHeight;
		if ( this._hasScroll() ) {
			borderTop = parseFloat( $.css( this.activeMenu[0], "borderTopWidth" ) ) || 0;
			paddingTop = parseFloat( $.css( this.activeMenu[0], "paddingTop" ) ) || 0;
			offset = item.offset().top - this.activeMenu.offset().top - borderTop - paddingTop;
			scroll = this.activeMenu.scrollTop();
			elementHeight = this.activeMenu.height();
			itemHeight = item.outerHeight();

			if ( offset < 0 ) {
				this.activeMenu.scrollTop( scroll + offset );
			} else if ( offset + itemHeight > elementHeight ) {
				this.activeMenu.scrollTop( scroll + offset - elementHeight + itemHeight );
			}
		}
	},

	blur: function( event, fromFocus ) {
		if ( !fromFocus ) {
			clearTimeout( this.timer );
		}

		if ( !this.active ) {
			return;
		}

		this.active.removeClass( "ui-state-focus" );
		this.active = null;

		this._trigger( "blur", event, { item: this.active } );
	},

	_startOpening: function( submenu ) {
		clearTimeout( this.timer );

		// Don't open if already open fixes a Firefox bug that caused a .5 pixel
		// shift in the submenu position when mousing over the carat icon
		if ( submenu.attr( "aria-hidden" ) !== "true" ) {
			return;
		}

		this.timer = this._delay(function() {
			this._close();
			this._open( submenu );
		}, this.delay );
	},

	_open: function( submenu ) {
		var position = $.extend({
			of: this.active
		}, this.options.position );

		clearTimeout( this.timer );
		this.element.find( ".ui-menu" ).not( submenu.parents( ".ui-menu" ) )
			.hide()
			.attr( "aria-hidden", "true" );

		submenu
			.show()
			.removeAttr( "aria-hidden" )
			.attr( "aria-expanded", "true" )
			.position( position );
	},

	collapseAll: function( event, all ) {
		clearTimeout( this.timer );
		this.timer = this._delay(function() {
			// If we were passed an event, look for the submenu that contains the event
			var currentMenu = all ? this.element :
				$( event && event.target ).closest( this.element.find( ".ui-menu" ) );

			// If we found no valid submenu ancestor, use the main menu to close all sub menus anyway
			if ( !currentMenu.length ) {
				currentMenu = this.element;
			}

			this._close( currentMenu );

			this.blur( event );
			this.activeMenu = currentMenu;
		}, this.delay );
	},

	// With no arguments, closes the currently active menu - if nothing is active
	// it closes all menus.  If passed an argument, it will search for menus BELOW
	_close: function( startMenu ) {
		if ( !startMenu ) {
			startMenu = this.active ? this.active.parent() : this.element;
		}

		startMenu
			.find( ".ui-menu" )
				.hide()
				.attr( "aria-hidden", "true" )
				.attr( "aria-expanded", "false" )
			.end()
			.find( ".ui-state-active" ).not( ".ui-state-focus" )
				.removeClass( "ui-state-active" );
	},

	_closeOnDocumentClick: function( event ) {
		return !$( event.target ).closest( ".ui-menu" ).length;
	},

	_isDivider: function( item ) {

		// Match hyphen, em dash, en dash
		return !/[^\-\u2014\u2013\s]/.test( item.text() );
	},

	collapse: function( event ) {
		var newItem = this.active &&
			this.active.parent().closest( ".ui-menu-item", this.element );
		if ( newItem && newItem.length ) {
			this._close();
			this.focus( event, newItem );
		}
	},

	expand: function( event ) {
		var newItem = this.active &&
			this.active
				.children( ".ui-menu " )
				.find( this.options.items )
				.first();

		if ( newItem && newItem.length ) {
			this._open( newItem.parent() );

			// Delay so Firefox will not hide activedescendant change in expanding submenu from AT
			this._delay(function() {
				this.focus( event, newItem );
			});
		}
	},

	next: function( event ) {
		this._move( "next", "first", event );
	},

	previous: function( event ) {
		this._move( "prev", "last", event );
	},

	isFirstItem: function() {
		return this.active && !this.active.prevAll( ".ui-menu-item" ).length;
	},

	isLastItem: function() {
		return this.active && !this.active.nextAll( ".ui-menu-item" ).length;
	},

	_move: function( direction, filter, event ) {
		var next;
		if ( this.active ) {
			if ( direction === "first" || direction === "last" ) {
				next = this.active
					[ direction === "first" ? "prevAll" : "nextAll" ]( ".ui-menu-item" )
					.eq( -1 );
			} else {
				next = this.active
					[ direction + "All" ]( ".ui-menu-item" )
					.eq( 0 );
			}
		}
		if ( !next || !next.length || !this.active ) {
			next = this.activeMenu.find( this.options.items )[ filter ]();
		}

		this.focus( event, next );
	},

	nextPage: function( event ) {
		var item, base, height;

		if ( !this.active ) {
			this.next( event );
			return;
		}
		if ( this.isLastItem() ) {
			return;
		}
		if ( this._hasScroll() ) {
			base = this.active.offset().top;
			height = this.element.height();
			this.active.nextAll( ".ui-menu-item" ).each(function() {
				item = $( this );
				return item.offset().top - base - height < 0;
			});

			this.focus( event, item );
		} else {
			this.focus( event, this.activeMenu.find( this.options.items )
				[ !this.active ? "first" : "last" ]() );
		}
	},

	previousPage: function( event ) {
		var item, base, height;
		if ( !this.active ) {
			this.next( event );
			return;
		}
		if ( this.isFirstItem() ) {
			return;
		}
		if ( this._hasScroll() ) {
			base = this.active.offset().top;
			height = this.element.height();
			this.active.prevAll( ".ui-menu-item" ).each(function() {
				item = $( this );
				return item.offset().top - base + height > 0;
			});

			this.focus( event, item );
		} else {
			this.focus( event, this.activeMenu.find( this.options.items ).first() );
		}
	},

	_hasScroll: function() {
		return this.element.outerHeight() < this.element.prop( "scrollHeight" );
	},

	select: function( event ) {
		// TODO: It should never be possible to not have an active item at this
		// point, but the tests don't trigger mouseenter before click.
		this.active = this.active || $( event.target ).closest( ".ui-menu-item" );
		var ui = { item: this.active };
		if ( !this.active.has( ".ui-menu" ).length ) {
			this.collapseAll( event, true );
		}
		this._trigger( "select", event, ui );
	},

	_filterMenuItems: function(character) {
		var escapedCharacter = character.replace( /[\-\[\]{}()*+?.,\\\^$|#\s]/g, "\\$&" ),
			regex = new RegExp( "^" + escapedCharacter, "i" );

		return this.activeMenu
			.find( this.options.items )

			// Only match on items, not dividers or other content (#10571)
			.filter( ".ui-menu-item" )
			.filter(function() {
				return regex.test( $.trim( $( this ).text() ) );
			});
	}
});


/*!
 * jQuery UI Autocomplete 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/autocomplete/
 */


$.widget( "ui.autocomplete", {
	version: "1.11.4",
	defaultElement: "<input>",
	options: {
		appendTo: null,
		autoFocus: false,
		delay: 300,
		minLength: 1,
		position: {
			my: "left top",
			at: "left bottom",
			collision: "none"
		},
		source: null,

		// callbacks
		change: null,
		close: null,
		focus: null,
		open: null,
		response: null,
		search: null,
		select: null
	},

	requestIndex: 0,
	pending: 0,

	_create: function() {
		// Some browsers only repeat keydown events, not keypress events,
		// so we use the suppressKeyPress flag to determine if we've already
		// handled the keydown event. #7269
		// Unfortunately the code for & in keypress is the same as the up arrow,
		// so we use the suppressKeyPressRepeat flag to avoid handling keypress
		// events when we know the keydown event was used to modify the
		// search term. #7799
		var suppressKeyPress, suppressKeyPressRepeat, suppressInput,
			nodeName = this.element[ 0 ].nodeName.toLowerCase(),
			isTextarea = nodeName === "textarea",
			isInput = nodeName === "input";

		this.isMultiLine =
			// Textareas are always multi-line
			isTextarea ? true :
			// Inputs are always single-line, even if inside a contentEditable element
			// IE also treats inputs as contentEditable
			isInput ? false :
			// All other element types are determined by whether or not they're contentEditable
			this.element.prop( "isContentEditable" );

		this.valueMethod = this.element[ isTextarea || isInput ? "val" : "text" ];
		this.isNewMenu = true;

		this.element
			.addClass( "ui-autocomplete-input" )
			.attr( "autocomplete", "off" );

		this._on( this.element, {
			keydown: function( event ) {
				if ( this.element.prop( "readOnly" ) ) {
					suppressKeyPress = true;
					suppressInput = true;
					suppressKeyPressRepeat = true;
					return;
				}

				suppressKeyPress = false;
				suppressInput = false;
				suppressKeyPressRepeat = false;
				var keyCode = $.ui.keyCode;
				switch ( event.keyCode ) {
				case keyCode.PAGE_UP:
					suppressKeyPress = true;
					this._move( "previousPage", event );
					break;
				case keyCode.PAGE_DOWN:
					suppressKeyPress = true;
					this._move( "nextPage", event );
					break;
				case keyCode.UP:
					suppressKeyPress = true;
					this._keyEvent( "previous", event );
					break;
				case keyCode.DOWN:
					suppressKeyPress = true;
					this._keyEvent( "next", event );
					break;
				case keyCode.ENTER:
					// when menu is open and has focus
					if ( this.menu.active ) {
						// #6055 - Opera still allows the keypress to occur
						// which causes forms to submit
						suppressKeyPress = true;
						event.preventDefault();
						this.menu.select( event );
					}
					break;
				case keyCode.TAB:
					if ( this.menu.active ) {
						this.menu.select( event );
					}
					break;
				case keyCode.ESCAPE:
					if ( this.menu.element.is( ":visible" ) ) {
						if ( !this.isMultiLine ) {
							this._value( this.term );
						}
						this.close( event );
						// Different browsers have different default behavior for escape
						// Single press can mean undo or clear
						// Double press in IE means clear the whole form
						event.preventDefault();
					}
					break;
				default:
					suppressKeyPressRepeat = true;
					// search timeout should be triggered before the input value is changed
					this._searchTimeout( event );
					break;
				}
			},
			keypress: function( event ) {
				if ( suppressKeyPress ) {
					suppressKeyPress = false;
					if ( !this.isMultiLine || this.menu.element.is( ":visible" ) ) {
						event.preventDefault();
					}
					return;
				}
				if ( suppressKeyPressRepeat ) {
					return;
				}

				// replicate some key handlers to allow them to repeat in Firefox and Opera
				var keyCode = $.ui.keyCode;
				switch ( event.keyCode ) {
				case keyCode.PAGE_UP:
					this._move( "previousPage", event );
					break;
				case keyCode.PAGE_DOWN:
					this._move( "nextPage", event );
					break;
				case keyCode.UP:
					this._keyEvent( "previous", event );
					break;
				case keyCode.DOWN:
					this._keyEvent( "next", event );
					break;
				}
			},
			input: function( event ) {
				if ( suppressInput ) {
					suppressInput = false;
					event.preventDefault();
					return;
				}
				this._searchTimeout( event );
			},
			focus: function() {
				this.selectedItem = null;
				this.previous = this._value();
			},
			blur: function( event ) {
				if ( this.cancelBlur ) {
					delete this.cancelBlur;
					return;
				}

				clearTimeout( this.searching );
				this.close( event );
				this._change( event );
			}
		});

		this._initSource();
		this.menu = $( "<ul>" )
			.addClass( "ui-autocomplete ui-front" )
			.appendTo( this._appendTo() )
			.menu({
				// disable ARIA support, the live region takes care of that
				role: null
			})
			.hide()
			.menu( "instance" );

		this._on( this.menu.element, {
			mousedown: function( event ) {
				// prevent moving focus out of the text field
				event.preventDefault();

				// IE doesn't prevent moving focus even with event.preventDefault()
				// so we set a flag to know when we should ignore the blur event
				this.cancelBlur = true;
				this._delay(function() {
					delete this.cancelBlur;
				});

				// clicking on the scrollbar causes focus to shift to the body
				// but we can't detect a mouseup or a click immediately afterward
				// so we have to track the next mousedown and close the menu if
				// the user clicks somewhere outside of the autocomplete
				var menuElement = this.menu.element[ 0 ];
				if ( !$( event.target ).closest( ".ui-menu-item" ).length ) {
					this._delay(function() {
						var that = this;
						this.document.one( "mousedown", function( event ) {
							if ( event.target !== that.element[ 0 ] &&
									event.target !== menuElement &&
									!$.contains( menuElement, event.target ) ) {
								that.close();
							}
						});
					});
				}
			},
			menufocus: function( event, ui ) {
				var label, item;
				// support: Firefox
				// Prevent accidental activation of menu items in Firefox (#7024 #9118)
				if ( this.isNewMenu ) {
					this.isNewMenu = false;
					if ( event.originalEvent && /^mouse/.test( event.originalEvent.type ) ) {
						this.menu.blur();

						this.document.one( "mousemove", function() {
							$( event.target ).trigger( event.originalEvent );
						});

						return;
					}
				}

				item = ui.item.data( "ui-autocomplete-item" );
				if ( false !== this._trigger( "focus", event, { item: item } ) ) {
					// use value to match what will end up in the input, if it was a key event
					if ( event.originalEvent && /^key/.test( event.originalEvent.type ) ) {
						this._value( item.value );
					}
				}

				// Announce the value in the liveRegion
				label = ui.item.attr( "aria-label" ) || item.value;
				if ( label && $.trim( label ).length ) {
					this.liveRegion.children().hide();
					$( "<div>" ).text( label ).appendTo( this.liveRegion );
				}
			},
			menuselect: function( event, ui ) {
				var item = ui.item.data( "ui-autocomplete-item" ),
					previous = this.previous;

				// only trigger when focus was lost (click on menu)
				if ( this.element[ 0 ] !== this.document[ 0 ].activeElement ) {
					this.element.focus();
					this.previous = previous;
					// #6109 - IE triggers two focus events and the second
					// is asynchronous, so we need to reset the previous
					// term synchronously and asynchronously :-(
					this._delay(function() {
						this.previous = previous;
						this.selectedItem = item;
					});
				}

				if ( false !== this._trigger( "select", event, { item: item } ) ) {
					this._value( item.value );
				}
				// reset the term after the select event
				// this allows custom select handling to work properly
				this.term = this._value();

				this.close( event );
				this.selectedItem = item;
			}
		});

		this.liveRegion = $( "<span>", {
				role: "status",
				"aria-live": "assertive",
				"aria-relevant": "additions"
			})
			.addClass( "ui-helper-hidden-accessible" )
			.appendTo( this.document[ 0 ].body );

		// turning off autocomplete prevents the browser from remembering the
		// value when navigating through history, so we re-enable autocomplete
		// if the page is unloaded before the widget is destroyed. #7790
		this._on( this.window, {
			beforeunload: function() {
				this.element.removeAttr( "autocomplete" );
			}
		});
	},

	_destroy: function() {
		clearTimeout( this.searching );
		this.element
			.removeClass( "ui-autocomplete-input" )
			.removeAttr( "autocomplete" );
		this.menu.element.remove();
		this.liveRegion.remove();
	},

	_setOption: function( key, value ) {
		this._super( key, value );
		if ( key === "source" ) {
			this._initSource();
		}
		if ( key === "appendTo" ) {
			this.menu.element.appendTo( this._appendTo() );
		}
		if ( key === "disabled" && value && this.xhr ) {
			this.xhr.abort();
		}
	},

	_appendTo: function() {
		var element = this.options.appendTo;

		if ( element ) {
			element = element.jquery || element.nodeType ?
				$( element ) :
				this.document.find( element ).eq( 0 );
		}

		if ( !element || !element[ 0 ] ) {
			element = this.element.closest( ".ui-front" );
		}

		if ( !element.length ) {
			element = this.document[ 0 ].body;
		}

		return element;
	},

	_initSource: function() {
		var array, url,
			that = this;
		if ( $.isArray( this.options.source ) ) {
			array = this.options.source;
			this.source = function( request, response ) {
				response( $.ui.autocomplete.filter( array, request.term ) );
			};
		} else if ( typeof this.options.source === "string" ) {
			url = this.options.source;
			this.source = function( request, response ) {
				if ( that.xhr ) {
					that.xhr.abort();
				}
				that.xhr = $.ajax({
					url: url,
					data: request,
					dataType: "json",
					success: function( data ) {
						response( data );
					},
					error: function() {
						response([]);
					}
				});
			};
		} else {
			this.source = this.options.source;
		}
	},

	_searchTimeout: function( event ) {
		clearTimeout( this.searching );
		this.searching = this._delay(function() {

			// Search if the value has changed, or if the user retypes the same value (see #7434)
			var equalValues = this.term === this._value(),
				menuVisible = this.menu.element.is( ":visible" ),
				modifierKey = event.altKey || event.ctrlKey || event.metaKey || event.shiftKey;

			if ( !equalValues || ( equalValues && !menuVisible && !modifierKey ) ) {
				this.selectedItem = null;
				this.search( null, event );
			}
		}, this.options.delay );
	},

	search: function( value, event ) {
		value = value != null ? value : this._value();

		// always save the actual value, not the one passed as an argument
		this.term = this._value();

		if ( value.length < this.options.minLength ) {
			return this.close( event );
		}

		if ( this._trigger( "search", event ) === false ) {
			return;
		}

		return this._search( value );
	},

	_search: function( value ) {
		this.pending++;
		this.element.addClass( "ui-autocomplete-loading" );
		this.cancelSearch = false;

		this.source( { term: value }, this._response() );
	},

	_response: function() {
		var index = ++this.requestIndex;

		return $.proxy(function( content ) {
			if ( index === this.requestIndex ) {
				this.__response( content );
			}

			this.pending--;
			if ( !this.pending ) {
				this.element.removeClass( "ui-autocomplete-loading" );
			}
		}, this );
	},

	__response: function( content ) {
		if ( content ) {
			content = this._normalize( content );
		}
		this._trigger( "response", null, { content: content } );
		if ( !this.options.disabled && content && content.length && !this.cancelSearch ) {
			this._suggest( content );
			this._trigger( "open" );
		} else {
			// use ._close() instead of .close() so we don't cancel future searches
			this._close();
		}
	},

	close: function( event ) {
		this.cancelSearch = true;
		this._close( event );
	},

	_close: function( event ) {
		if ( this.menu.element.is( ":visible" ) ) {
			this.menu.element.hide();
			this.menu.blur();
			this.isNewMenu = true;
			this._trigger( "close", event );
		}
	},

	_change: function( event ) {
		if ( this.previous !== this._value() ) {
			this._trigger( "change", event, { item: this.selectedItem } );
		}
	},

	_normalize: function( items ) {
		// assume all items have the right format when the first item is complete
		if ( items.length && items[ 0 ].label && items[ 0 ].value ) {
			return items;
		}
		return $.map( items, function( item ) {
			if ( typeof item === "string" ) {
				return {
					label: item,
					value: item
				};
			}
			return $.extend( {}, item, {
				label: item.label || item.value,
				value: item.value || item.label
			});
		});
	},

	_suggest: function( items ) {
		var ul = this.menu.element.empty();
		this._renderMenu( ul, items );
		this.isNewMenu = true;
		this.menu.refresh();

		// size and position menu
		ul.show();
		this._resizeMenu();
		ul.position( $.extend({
			of: this.element
		}, this.options.position ) );

		if ( this.options.autoFocus ) {
			this.menu.next();
		}
	},

	_resizeMenu: function() {
		var ul = this.menu.element;
		ul.outerWidth( Math.max(
			// Firefox wraps long text (possibly a rounding bug)
			// so we add 1px to avoid the wrapping (#7513)
			ul.width( "" ).outerWidth() + 1,
			this.element.outerWidth()
		) );
	},

	_renderMenu: function( ul, items ) {
		var that = this;
		$.each( items, function( index, item ) {
			that._renderItemData( ul, item );
		});
	},

	_renderItemData: function( ul, item ) {
		return this._renderItem( ul, item ).data( "ui-autocomplete-item", item );
	},

	_renderItem: function( ul, item ) {
		return $( "<li>" ).text( item.label ).appendTo( ul );
	},

	_move: function( direction, event ) {
		if ( !this.menu.element.is( ":visible" ) ) {
			this.search( null, event );
			return;
		}
		if ( this.menu.isFirstItem() && /^previous/.test( direction ) ||
				this.menu.isLastItem() && /^next/.test( direction ) ) {

			if ( !this.isMultiLine ) {
				this._value( this.term );
			}

			this.menu.blur();
			return;
		}
		this.menu[ direction ]( event );
	},

	widget: function() {
		return this.menu.element;
	},

	_value: function() {
		return this.valueMethod.apply( this.element, arguments );
	},

	_keyEvent: function( keyEvent, event ) {
		if ( !this.isMultiLine || this.menu.element.is( ":visible" ) ) {
			this._move( keyEvent, event );

			// prevents moving cursor to beginning/end of the text field in some browsers
			event.preventDefault();
		}
	}
});

$.extend( $.ui.autocomplete, {
	escapeRegex: function( value ) {
		return value.replace( /[\-\[\]{}()*+?.,\\\^$|#\s]/g, "\\$&" );
	},
	filter: function( array, term ) {
		var matcher = new RegExp( $.ui.autocomplete.escapeRegex( term ), "i" );
		return $.grep( array, function( value ) {
			return matcher.test( value.label || value.value || value );
		});
	}
});

// live region extension, adding a `messages` option
// NOTE: This is an experimental API. We are still investigating
// a full solution for string manipulation and internationalization.
$.widget( "ui.autocomplete", $.ui.autocomplete, {
	options: {
		messages: {
			noResults: "No search results.",
			results: function( amount ) {
				return amount + ( amount > 1 ? " results are" : " result is" ) +
					" available, use up and down arrow keys to navigate.";
			}
		}
	},

	__response: function( content ) {
		var message;
		this._superApply( arguments );
		if ( this.options.disabled || this.cancelSearch ) {
			return;
		}
		if ( content && content.length ) {
			message = this.options.messages.results( content.length );
		} else {
			message = this.options.messages.noResults;
		}
		this.liveRegion.children().hide();
		$( "<div>" ).text( message ).appendTo( this.liveRegion );
	}
});

var autocomplete = $.ui.autocomplete;


/*!
 * jQuery UI Button 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/button/
 */


var lastActive,
	baseClasses = "ui-button ui-widget ui-state-default ui-corner-all",
	typeClasses = "ui-button-icons-only ui-button-icon-only ui-button-text-icons ui-button-text-icon-primary ui-button-text-icon-secondary ui-button-text-only",
	formResetHandler = function() {
		var form = $( this );
		setTimeout(function() {
			form.find( ":ui-button" ).button( "refresh" );
		}, 1 );
	},
	radioGroup = function( radio ) {
		var name = radio.name,
			form = radio.form,
			radios = $( [] );
		if ( name ) {
			name = name.replace( /'/g, "\\'" );
			if ( form ) {
				radios = $( form ).find( "[name='" + name + "'][type=radio]" );
			} else {
				radios = $( "[name='" + name + "'][type=radio]", radio.ownerDocument )
					.filter(function() {
						return !this.form;
					});
			}
		}
		return radios;
	};

$.widget( "ui.button", {
	version: "1.11.4",
	defaultElement: "<button>",
	options: {
		disabled: null,
		text: true,
		label: null,
		icons: {
			primary: null,
			secondary: null
		}
	},
	_create: function() {
		this.element.closest( "form" )
			.unbind( "reset" + this.eventNamespace )
			.bind( "reset" + this.eventNamespace, formResetHandler );

		if ( typeof this.options.disabled !== "boolean" ) {
			this.options.disabled = !!this.element.prop( "disabled" );
		} else {
			this.element.prop( "disabled", this.options.disabled );
		}

		this._determineButtonType();
		this.hasTitle = !!this.buttonElement.attr( "title" );

		var that = this,
			options = this.options,
			toggleButton = this.type === "checkbox" || this.type === "radio",
			activeClass = !toggleButton ? "ui-state-active" : "";

		if ( options.label === null ) {
			options.label = (this.type === "input" ? this.buttonElement.val() : this.buttonElement.html());
		}

		this._hoverable( this.buttonElement );

		this.buttonElement
			.addClass( baseClasses )
			.attr( "role", "button" )
			.bind( "mouseenter" + this.eventNamespace, function() {
				if ( options.disabled ) {
					return;
				}
				if ( this === lastActive ) {
					$( this ).addClass( "ui-state-active" );
				}
			})
			.bind( "mouseleave" + this.eventNamespace, function() {
				if ( options.disabled ) {
					return;
				}
				$( this ).removeClass( activeClass );
			})
			.bind( "click" + this.eventNamespace, function( event ) {
				if ( options.disabled ) {
					event.preventDefault();
					event.stopImmediatePropagation();
				}
			});

		// Can't use _focusable() because the element that receives focus
		// and the element that gets the ui-state-focus class are different
		this._on({
			focus: function() {
				this.buttonElement.addClass( "ui-state-focus" );
			},
			blur: function() {
				this.buttonElement.removeClass( "ui-state-focus" );
			}
		});

		if ( toggleButton ) {
			this.element.bind( "change" + this.eventNamespace, function() {
				that.refresh();
			});
		}

		if ( this.type === "checkbox" ) {
			this.buttonElement.bind( "click" + this.eventNamespace, function() {
				if ( options.disabled ) {
					return false;
				}
			});
		} else if ( this.type === "radio" ) {
			this.buttonElement.bind( "click" + this.eventNamespace, function() {
				if ( options.disabled ) {
					return false;
				}
				$( this ).addClass( "ui-state-active" );
				that.buttonElement.attr( "aria-pressed", "true" );

				var radio = that.element[ 0 ];
				radioGroup( radio )
					.not( radio )
					.map(function() {
						return $( this ).button( "widget" )[ 0 ];
					})
					.removeClass( "ui-state-active" )
					.attr( "aria-pressed", "false" );
			});
		} else {
			this.buttonElement
				.bind( "mousedown" + this.eventNamespace, function() {
					if ( options.disabled ) {
						return false;
					}
					$( this ).addClass( "ui-state-active" );
					lastActive = this;
					that.document.one( "mouseup", function() {
						lastActive = null;
					});
				})
				.bind( "mouseup" + this.eventNamespace, function() {
					if ( options.disabled ) {
						return false;
					}
					$( this ).removeClass( "ui-state-active" );
				})
				.bind( "keydown" + this.eventNamespace, function(event) {
					if ( options.disabled ) {
						return false;
					}
					if ( event.keyCode === $.ui.keyCode.SPACE || event.keyCode === $.ui.keyCode.ENTER ) {
						$( this ).addClass( "ui-state-active" );
					}
				})
				// see #8559, we bind to blur here in case the button element loses
				// focus between keydown and keyup, it would be left in an "active" state
				.bind( "keyup" + this.eventNamespace + " blur" + this.eventNamespace, function() {
					$( this ).removeClass( "ui-state-active" );
				});

			if ( this.buttonElement.is("a") ) {
				this.buttonElement.keyup(function(event) {
					if ( event.keyCode === $.ui.keyCode.SPACE ) {
						// TODO pass through original event correctly (just as 2nd argument doesn't work)
						$( this ).click();
					}
				});
			}
		}

		this._setOption( "disabled", options.disabled );
		this._resetButton();
	},

	_determineButtonType: function() {
		var ancestor, labelSelector, checked;

		if ( this.element.is("[type=checkbox]") ) {
			this.type = "checkbox";
		} else if ( this.element.is("[type=radio]") ) {
			this.type = "radio";
		} else if ( this.element.is("input") ) {
			this.type = "input";
		} else {
			this.type = "button";
		}

		if ( this.type === "checkbox" || this.type === "radio" ) {
			// we don't search against the document in case the element
			// is disconnected from the DOM
			ancestor = this.element.parents().last();
			labelSelector = "label[for='" + this.element.attr("id") + "']";
			this.buttonElement = ancestor.find( labelSelector );
			if ( !this.buttonElement.length ) {
				ancestor = ancestor.length ? ancestor.siblings() : this.element.siblings();
				this.buttonElement = ancestor.filter( labelSelector );
				if ( !this.buttonElement.length ) {
					this.buttonElement = ancestor.find( labelSelector );
				}
			}
			this.element.addClass( "ui-helper-hidden-accessible" );

			checked = this.element.is( ":checked" );
			if ( checked ) {
				this.buttonElement.addClass( "ui-state-active" );
			}
			this.buttonElement.prop( "aria-pressed", checked );
		} else {
			this.buttonElement = this.element;
		}
	},

	widget: function() {
		return this.buttonElement;
	},

	_destroy: function() {
		this.element
			.removeClass( "ui-helper-hidden-accessible" );
		this.buttonElement
			.removeClass( baseClasses + " ui-state-active " + typeClasses )
			.removeAttr( "role" )
			.removeAttr( "aria-pressed" )
			.html( this.buttonElement.find(".ui-button-text").html() );

		if ( !this.hasTitle ) {
			this.buttonElement.removeAttr( "title" );
		}
	},

	_setOption: function( key, value ) {
		this._super( key, value );
		if ( key === "disabled" ) {
			this.widget().toggleClass( "ui-state-disabled", !!value );
			this.element.prop( "disabled", !!value );
			if ( value ) {
				if ( this.type === "checkbox" || this.type === "radio" ) {
					this.buttonElement.removeClass( "ui-state-focus" );
				} else {
					this.buttonElement.removeClass( "ui-state-focus ui-state-active" );
				}
			}
			return;
		}
		this._resetButton();
	},

	refresh: function() {
		//See #8237 & #8828
		var isDisabled = this.element.is( "input, button" ) ? this.element.is( ":disabled" ) : this.element.hasClass( "ui-button-disabled" );

		if ( isDisabled !== this.options.disabled ) {
			this._setOption( "disabled", isDisabled );
		}
		if ( this.type === "radio" ) {
			radioGroup( this.element[0] ).each(function() {
				if ( $( this ).is( ":checked" ) ) {
					$( this ).button( "widget" )
						.addClass( "ui-state-active" )
						.attr( "aria-pressed", "true" );
				} else {
					$( this ).button( "widget" )
						.removeClass( "ui-state-active" )
						.attr( "aria-pressed", "false" );
				}
			});
		} else if ( this.type === "checkbox" ) {
			if ( this.element.is( ":checked" ) ) {
				this.buttonElement
					.addClass( "ui-state-active" )
					.attr( "aria-pressed", "true" );
			} else {
				this.buttonElement
					.removeClass( "ui-state-active" )
					.attr( "aria-pressed", "false" );
			}
		}
	},

	_resetButton: function() {
		if ( this.type === "input" ) {
			if ( this.options.label ) {
				this.element.val( this.options.label );
			}
			return;
		}
		var buttonElement = this.buttonElement.removeClass( typeClasses ),
			buttonText = $( "<span></span>", this.document[0] )
				.addClass( "ui-button-text" )
				.html( this.options.label )
				.appendTo( buttonElement.empty() )
				.text(),
			icons = this.options.icons,
			multipleIcons = icons.primary && icons.secondary,
			buttonClasses = [];

		if ( icons.primary || icons.secondary ) {
			if ( this.options.text ) {
				buttonClasses.push( "ui-button-text-icon" + ( multipleIcons ? "s" : ( icons.primary ? "-primary" : "-secondary" ) ) );
			}

			if ( icons.primary ) {
				buttonElement.prepend( "<span class='ui-button-icon-primary ui-icon " + icons.primary + "'></span>" );
			}

			if ( icons.secondary ) {
				buttonElement.append( "<span class='ui-button-icon-secondary ui-icon " + icons.secondary + "'></span>" );
			}

			if ( !this.options.text ) {
				buttonClasses.push( multipleIcons ? "ui-button-icons-only" : "ui-button-icon-only" );

				if ( !this.hasTitle ) {
					buttonElement.attr( "title", $.trim( buttonText ) );
				}
			}
		} else {
			buttonClasses.push( "ui-button-text-only" );
		}
		buttonElement.addClass( buttonClasses.join( " " ) );
	}
});

$.widget( "ui.buttonset", {
	version: "1.11.4",
	options: {
		items: "button, input[type=button], input[type=submit], input[type=reset], input[type=checkbox], input[type=radio], a, :data(ui-button)"
	},

	_create: function() {
		this.element.addClass( "ui-buttonset" );
	},

	_init: function() {
		this.refresh();
	},

	_setOption: function( key, value ) {
		if ( key === "disabled" ) {
			this.buttons.button( "option", key, value );
		}

		this._super( key, value );
	},

	refresh: function() {
		var rtl = this.element.css( "direction" ) === "rtl",
			allButtons = this.element.find( this.options.items ),
			existingButtons = allButtons.filter( ":ui-button" );

		// Initialize new buttons
		allButtons.not( ":ui-button" ).button();

		// Refresh existing buttons
		existingButtons.button( "refresh" );

		this.buttons = allButtons
			.map(function() {
				return $( this ).button( "widget" )[ 0 ];
			})
				.removeClass( "ui-corner-all ui-corner-left ui-corner-right" )
				.filter( ":first" )
					.addClass( rtl ? "ui-corner-right" : "ui-corner-left" )
				.end()
				.filter( ":last" )
					.addClass( rtl ? "ui-corner-left" : "ui-corner-right" )
				.end()
			.end();
	},

	_destroy: function() {
		this.element.removeClass( "ui-buttonset" );
		this.buttons
			.map(function() {
				return $( this ).button( "widget" )[ 0 ];
			})
				.removeClass( "ui-corner-left ui-corner-right" )
			.end()
			.button( "destroy" );
	}
});

var button = $.ui.button;


/*!
 * jQuery UI Datepicker 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/datepicker/
 */


$.extend($.ui, { datepicker: { version: "1.11.4" } });

var datepicker_instActive;

function datepicker_getZindex( elem ) {
	var position, value;
	while ( elem.length && elem[ 0 ] !== document ) {
		// Ignore z-index if position is set to a value where z-index is ignored by the browser
		// This makes behavior of this function consistent across browsers
		// WebKit always returns auto if the element is positioned
		position = elem.css( "position" );
		if ( position === "absolute" || position === "relative" || position === "fixed" ) {
			// IE returns 0 when zIndex is not specified
			// other browsers return a string
			// we ignore the case of nested elements with an explicit value of 0
			// <div style="z-index: -10;"><div style="z-index: 0;"></div></div>
			value = parseInt( elem.css( "zIndex" ), 10 );
			if ( !isNaN( value ) && value !== 0 ) {
				return value;
			}
		}
		elem = elem.parent();
	}

	return 0;
}
/* Date picker manager.
   Use the singleton instance of this class, $.datepicker, to interact with the date picker.
   Settings for (groups of) date pickers are maintained in an instance object,
   allowing multiple different settings on the same page. */

function Datepicker() {
	this._curInst = null; // The current instance in use
	this._keyEvent = false; // If the last event was a key event
	this._disabledInputs = []; // List of date picker inputs that have been disabled
	this._datepickerShowing = false; // True if the popup picker is showing , false if not
	this._inDialog = false; // True if showing within a "dialog", false if not
	this._mainDivId = "ui-datepicker-div"; // The ID of the main datepicker division
	this._inlineClass = "ui-datepicker-inline"; // The name of the inline marker class
	this._appendClass = "ui-datepicker-append"; // The name of the append marker class
	this._triggerClass = "ui-datepicker-trigger"; // The name of the trigger marker class
	this._dialogClass = "ui-datepicker-dialog"; // The name of the dialog marker class
	this._disableClass = "ui-datepicker-disabled"; // The name of the disabled covering marker class
	this._unselectableClass = "ui-datepicker-unselectable"; // The name of the unselectable cell marker class
	this._currentClass = "ui-datepicker-current-day"; // The name of the current day marker class
	this._dayOverClass = "ui-datepicker-days-cell-over"; // The name of the day hover marker class
	this.regional = []; // Available regional settings, indexed by language code
	this.regional[""] = { // Default regional settings
		closeText: "Done", // Display text for close link
		prevText: "Prev", // Display text for previous month link
		nextText: "Next", // Display text for next month link
		currentText: "Today", // Display text for current month link
		monthNames: ["January","February","March","April","May","June",
			"July","August","September","October","November","December"], // Names of months for drop-down and formatting
		monthNamesShort: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"], // For formatting
		dayNames: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"], // For formatting
		dayNamesShort: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"], // For formatting
		dayNamesMin: ["Su","Mo","Tu","We","Th","Fr","Sa"], // Column headings for days starting at Sunday
		weekHeader: "Wk", // Column header for week of the year
		dateFormat: "mm/dd/yy", // See format options on parseDate
		firstDay: 0, // The first day of the week, Sun = 0, Mon = 1, ...
		isRTL: false, // True if right-to-left language, false if left-to-right
		showMonthAfterYear: false, // True if the year select precedes month, false for month then year
		yearSuffix: "" // Additional text to append to the year in the month headers
	};
	this._defaults = { // Global defaults for all the date picker instances
		showOn: "focus", // "focus" for popup on focus,
			// "button" for trigger button, or "both" for either
		showAnim: "fadeIn", // Name of jQuery animation for popup
		showOptions: {}, // Options for enhanced animations
		defaultDate: null, // Used when field is blank: actual date,
			// +/-number for offset from today, null for today
		appendText: "", // Display text following the input box, e.g. showing the format
		buttonText: "...", // Text for trigger button
		buttonImage: "", // URL for trigger button image
		buttonImageOnly: false, // True if the image appears alone, false if it appears on a button
		hideIfNoPrevNext: false, // True to hide next/previous month links
			// if not applicable, false to just disable them
		navigationAsDateFormat: false, // True if date formatting applied to prev/today/next links
		gotoCurrent: false, // True if today link goes back to current selection instead
		changeMonth: false, // True if month can be selected directly, false if only prev/next
		changeYear: false, // True if year can be selected directly, false if only prev/next
		yearRange: "c-10:c+10", // Range of years to display in drop-down,
			// either relative to today's year (-nn:+nn), relative to currently displayed year
			// (c-nn:c+nn), absolute (nnnn:nnnn), or a combination of the above (nnnn:-n)
		showOtherMonths: false, // True to show dates in other months, false to leave blank
		selectOtherMonths: false, // True to allow selection of dates in other months, false for unselectable
		showWeek: false, // True to show week of the year, false to not show it
		calculateWeek: this.iso8601Week, // How to calculate the week of the year,
			// takes a Date and returns the number of the week for it
		shortYearCutoff: "+10", // Short year values < this are in the current century,
			// > this are in the previous century,
			// string value starting with "+" for current year + value
		minDate: null, // The earliest selectable date, or null for no limit
		maxDate: null, // The latest selectable date, or null for no limit
		duration: "fast", // Duration of display/closure
		beforeShowDay: null, // Function that takes a date and returns an array with
			// [0] = true if selectable, false if not, [1] = custom CSS class name(s) or "",
			// [2] = cell title (optional), e.g. $.datepicker.noWeekends
		beforeShow: null, // Function that takes an input field and
			// returns a set of custom settings for the date picker
		onSelect: null, // Define a callback function when a date is selected
		onChangeMonthYear: null, // Define a callback function when the month or year is changed
		onClose: null, // Define a callback function when the datepicker is closed
		numberOfMonths: 1, // Number of months to show at a time
		showCurrentAtPos: 0, // The position in multipe months at which to show the current month (starting at 0)
		stepMonths: 1, // Number of months to step back/forward
		stepBigMonths: 12, // Number of months to step back/forward for the big links
		altField: "", // Selector for an alternate field to store selected dates into
		altFormat: "", // The date format to use for the alternate field
		constrainInput: true, // The input is constrained by the current date format
		showButtonPanel: false, // True to show button panel, false to not show it
		autoSize: false, // True to size the input for the date format, false to leave as is
		disabled: false // The initial disabled state
	};
	$.extend(this._defaults, this.regional[""]);
	this.regional.en = $.extend( true, {}, this.regional[ "" ]);
	this.regional[ "en-US" ] = $.extend( true, {}, this.regional.en );
	this.dpDiv = datepicker_bindHover($("<div id='" + this._mainDivId + "' class='ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all'></div>"));
}

$.extend(Datepicker.prototype, {
	/* Class name added to elements to indicate already configured with a date picker. */
	markerClassName: "hasDatepicker",

	//Keep track of the maximum number of rows displayed (see #7043)
	maxRows: 4,

	// TODO rename to "widget" when switching to widget factory
	_widgetDatepicker: function() {
		return this.dpDiv;
	},

	/* Override the default settings for all instances of the date picker.
	 * @param  settings  object - the new settings to use as defaults (anonymous object)
	 * @return the manager object
	 */
	setDefaults: function(settings) {
		datepicker_extendRemove(this._defaults, settings || {});
		return this;
	},

	/* Attach the date picker to a jQuery selection.
	 * @param  target	element - the target input field or division or span
	 * @param  settings  object - the new settings to use for this date picker instance (anonymous)
	 */
	_attachDatepicker: function(target, settings) {
		var nodeName, inline, inst;
		nodeName = target.nodeName.toLowerCase();
		inline = (nodeName === "div" || nodeName === "span");
		if (!target.id) {
			this.uuid += 1;
			target.id = "dp" + this.uuid;
		}
		inst = this._newInst($(target), inline);
		inst.settings = $.extend({}, settings || {});
		if (nodeName === "input") {
			this._connectDatepicker(target, inst);
		} else if (inline) {
			this._inlineDatepicker(target, inst);
		}
	},

	/* Create a new instance object. */
	_newInst: function(target, inline) {
		var id = target[0].id.replace(/([^A-Za-z0-9_\-])/g, "\\\\$1"); // escape jQuery meta chars
		return {id: id, input: target, // associated target
			selectedDay: 0, selectedMonth: 0, selectedYear: 0, // current selection
			drawMonth: 0, drawYear: 0, // month being drawn
			inline: inline, // is datepicker inline or not
			dpDiv: (!inline ? this.dpDiv : // presentation div
			datepicker_bindHover($("<div class='" + this._inlineClass + " ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all'></div>")))};
	},

	/* Attach the date picker to an input field. */
	_connectDatepicker: function(target, inst) {
		var input = $(target);
		inst.append = $([]);
		inst.trigger = $([]);
		if (input.hasClass(this.markerClassName)) {
			return;
		}
		this._attachments(input, inst);
		input.addClass(this.markerClassName).keydown(this._doKeyDown).
			keypress(this._doKeyPress).keyup(this._doKeyUp);
		this._autoSize(inst);
		$.data(target, "datepicker", inst);
		//If disabled option is true, disable the datepicker once it has been attached to the input (see ticket #5665)
		if( inst.settings.disabled ) {
			this._disableDatepicker( target );
		}
	},

	/* Make attachments based on settings. */
	_attachments: function(input, inst) {
		var showOn, buttonText, buttonImage,
			appendText = this._get(inst, "appendText"),
			isRTL = this._get(inst, "isRTL");

		if (inst.append) {
			inst.append.remove();
		}
		if (appendText) {
			inst.append = $("<span class='" + this._appendClass + "'>" + appendText + "</span>");
			input[isRTL ? "before" : "after"](inst.append);
		}

		input.unbind("focus", this._showDatepicker);

		if (inst.trigger) {
			inst.trigger.remove();
		}

		showOn = this._get(inst, "showOn");
		if (showOn === "focus" || showOn === "both") { // pop-up date picker when in the marked field
			input.focus(this._showDatepicker);
		}
		if (showOn === "button" || showOn === "both") { // pop-up date picker when button clicked
			buttonText = this._get(inst, "buttonText");
			buttonImage = this._get(inst, "buttonImage");
			inst.trigger = $(this._get(inst, "buttonImageOnly") ?
				$("<img/>").addClass(this._triggerClass).
					attr({ src: buttonImage, alt: buttonText, title: buttonText }) :
				$("<button type='button'></button>").addClass(this._triggerClass).
					html(!buttonImage ? buttonText : $("<img/>").attr(
					{ src:buttonImage, alt:buttonText, title:buttonText })));
			input[isRTL ? "before" : "after"](inst.trigger);
			inst.trigger.click(function() {
				if ($.datepicker._datepickerShowing && $.datepicker._lastInput === input[0]) {
					$.datepicker._hideDatepicker();
				} else if ($.datepicker._datepickerShowing && $.datepicker._lastInput !== input[0]) {
					$.datepicker._hideDatepicker();
					$.datepicker._showDatepicker(input[0]);
				} else {
					$.datepicker._showDatepicker(input[0]);
				}
				return false;
			});
		}
	},

	/* Apply the maximum length for the date format. */
	_autoSize: function(inst) {
		if (this._get(inst, "autoSize") && !inst.inline) {
			var findMax, max, maxI, i,
				date = new Date(2009, 12 - 1, 20), // Ensure double digits
				dateFormat = this._get(inst, "dateFormat");

			if (dateFormat.match(/[DM]/)) {
				findMax = function(names) {
					max = 0;
					maxI = 0;
					for (i = 0; i < names.length; i++) {
						if (names[i].length > max) {
							max = names[i].length;
							maxI = i;
						}
					}
					return maxI;
				};
				date.setMonth(findMax(this._get(inst, (dateFormat.match(/MM/) ?
					"monthNames" : "monthNamesShort"))));
				date.setDate(findMax(this._get(inst, (dateFormat.match(/DD/) ?
					"dayNames" : "dayNamesShort"))) + 20 - date.getDay());
			}
			inst.input.attr("size", this._formatDate(inst, date).length);
		}
	},

	/* Attach an inline date picker to a div. */
	_inlineDatepicker: function(target, inst) {
		var divSpan = $(target);
		if (divSpan.hasClass(this.markerClassName)) {
			return;
		}
		divSpan.addClass(this.markerClassName).append(inst.dpDiv);
		$.data(target, "datepicker", inst);
		this._setDate(inst, this._getDefaultDate(inst), true);
		this._updateDatepicker(inst);
		this._updateAlternate(inst);
		//If disabled option is true, disable the datepicker before showing it (see ticket #5665)
		if( inst.settings.disabled ) {
			this._disableDatepicker( target );
		}
		// Set display:block in place of inst.dpDiv.show() which won't work on disconnected elements
		// http://bugs.jqueryui.com/ticket/7552 - A Datepicker created on a detached div has zero height
		inst.dpDiv.css( "display", "block" );
	},

	/* Pop-up the date picker in a "dialog" box.
	 * @param  input element - ignored
	 * @param  date	string or Date - the initial date to display
	 * @param  onSelect  function - the function to call when a date is selected
	 * @param  settings  object - update the dialog date picker instance's settings (anonymous object)
	 * @param  pos int[2] - coordinates for the dialog's position within the screen or
	 *					event - with x/y coordinates or
	 *					leave empty for default (screen centre)
	 * @return the manager object
	 */
	_dialogDatepicker: function(input, date, onSelect, settings, pos) {
		var id, browserWidth, browserHeight, scrollX, scrollY,
			inst = this._dialogInst; // internal instance

		if (!inst) {
			this.uuid += 1;
			id = "dp" + this.uuid;
			this._dialogInput = $("<input type='text' id='" + id +
				"' style='position: absolute; top: -100px; width: 0px;'/>");
			this._dialogInput.keydown(this._doKeyDown);
			$("body").append(this._dialogInput);
			inst = this._dialogInst = this._newInst(this._dialogInput, false);
			inst.settings = {};
			$.data(this._dialogInput[0], "datepicker", inst);
		}
		datepicker_extendRemove(inst.settings, settings || {});
		date = (date && date.constructor === Date ? this._formatDate(inst, date) : date);
		this._dialogInput.val(date);

		this._pos = (pos ? (pos.length ? pos : [pos.pageX, pos.pageY]) : null);
		if (!this._pos) {
			browserWidth = document.documentElement.clientWidth;
			browserHeight = document.documentElement.clientHeight;
			scrollX = document.documentElement.scrollLeft || document.body.scrollLeft;
			scrollY = document.documentElement.scrollTop || document.body.scrollTop;
			this._pos = // should use actual width/height below
				[(browserWidth / 2) - 100 + scrollX, (browserHeight / 2) - 150 + scrollY];
		}

		// move input on screen for focus, but hidden behind dialog
		this._dialogInput.css("left", (this._pos[0] + 20) + "px").css("top", this._pos[1] + "px");
		inst.settings.onSelect = onSelect;
		this._inDialog = true;
		this.dpDiv.addClass(this._dialogClass);
		this._showDatepicker(this._dialogInput[0]);
		if ($.blockUI) {
			$.blockUI(this.dpDiv);
		}
		$.data(this._dialogInput[0], "datepicker", inst);
		return this;
	},

	/* Detach a datepicker from its control.
	 * @param  target	element - the target input field or division or span
	 */
	_destroyDatepicker: function(target) {
		var nodeName,
			$target = $(target),
			inst = $.data(target, "datepicker");

		if (!$target.hasClass(this.markerClassName)) {
			return;
		}

		nodeName = target.nodeName.toLowerCase();
		$.removeData(target, "datepicker");
		if (nodeName === "input") {
			inst.append.remove();
			inst.trigger.remove();
			$target.removeClass(this.markerClassName).
				unbind("focus", this._showDatepicker).
				unbind("keydown", this._doKeyDown).
				unbind("keypress", this._doKeyPress).
				unbind("keyup", this._doKeyUp);
		} else if (nodeName === "div" || nodeName === "span") {
			$target.removeClass(this.markerClassName).empty();
		}

		if ( datepicker_instActive === inst ) {
			datepicker_instActive = null;
		}
	},

	/* Enable the date picker to a jQuery selection.
	 * @param  target	element - the target input field or division or span
	 */
	_enableDatepicker: function(target) {
		var nodeName, inline,
			$target = $(target),
			inst = $.data(target, "datepicker");

		if (!$target.hasClass(this.markerClassName)) {
			return;
		}

		nodeName = target.nodeName.toLowerCase();
		if (nodeName === "input") {
			target.disabled = false;
			inst.trigger.filter("button").
				each(function() { this.disabled = false; }).end().
				filter("img").css({opacity: "1.0", cursor: ""});
		} else if (nodeName === "div" || nodeName === "span") {
			inline = $target.children("." + this._inlineClass);
			inline.children().removeClass("ui-state-disabled");
			inline.find("select.ui-datepicker-month, select.ui-datepicker-year").
				prop("disabled", false);
		}
		this._disabledInputs = $.map(this._disabledInputs,
			function(value) { return (value === target ? null : value); }); // delete entry
	},

	/* Disable the date picker to a jQuery selection.
	 * @param  target	element - the target input field or division or span
	 */
	_disableDatepicker: function(target) {
		var nodeName, inline,
			$target = $(target),
			inst = $.data(target, "datepicker");

		if (!$target.hasClass(this.markerClassName)) {
			return;
		}

		nodeName = target.nodeName.toLowerCase();
		if (nodeName === "input") {
			target.disabled = true;
			inst.trigger.filter("button").
				each(function() { this.disabled = true; }).end().
				filter("img").css({opacity: "0.5", cursor: "default"});
		} else if (nodeName === "div" || nodeName === "span") {
			inline = $target.children("." + this._inlineClass);
			inline.children().addClass("ui-state-disabled");
			inline.find("select.ui-datepicker-month, select.ui-datepicker-year").
				prop("disabled", true);
		}
		this._disabledInputs = $.map(this._disabledInputs,
			function(value) { return (value === target ? null : value); }); // delete entry
		this._disabledInputs[this._disabledInputs.length] = target;
	},

	/* Is the first field in a jQuery collection disabled as a datepicker?
	 * @param  target	element - the target input field or division or span
	 * @return boolean - true if disabled, false if enabled
	 */
	_isDisabledDatepicker: function(target) {
		if (!target) {
			return false;
		}
		for (var i = 0; i < this._disabledInputs.length; i++) {
			if (this._disabledInputs[i] === target) {
				return true;
			}
		}
		return false;
	},

	/* Retrieve the instance data for the target control.
	 * @param  target  element - the target input field or division or span
	 * @return  object - the associated instance data
	 * @throws  error if a jQuery problem getting data
	 */
	_getInst: function(target) {
		try {
			return $.data(target, "datepicker");
		}
		catch (err) {
			throw "Missing instance data for this datepicker";
		}
	},

	/* Update or retrieve the settings for a date picker attached to an input field or division.
	 * @param  target  element - the target input field or division or span
	 * @param  name	object - the new settings to update or
	 *				string - the name of the setting to change or retrieve,
	 *				when retrieving also "all" for all instance settings or
	 *				"defaults" for all global defaults
	 * @param  value   any - the new value for the setting
	 *				(omit if above is an object or to retrieve a value)
	 */
	_optionDatepicker: function(target, name, value) {
		var settings, date, minDate, maxDate,
			inst = this._getInst(target);

		if (arguments.length === 2 && typeof name === "string") {
			return (name === "defaults" ? $.extend({}, $.datepicker._defaults) :
				(inst ? (name === "all" ? $.extend({}, inst.settings) :
				this._get(inst, name)) : null));
		}

		settings = name || {};
		if (typeof name === "string") {
			settings = {};
			settings[name] = value;
		}

		if (inst) {
			if (this._curInst === inst) {
				this._hideDatepicker();
			}

			date = this._getDateDatepicker(target, true);
			minDate = this._getMinMaxDate(inst, "min");
			maxDate = this._getMinMaxDate(inst, "max");
			datepicker_extendRemove(inst.settings, settings);
			// reformat the old minDate/maxDate values if dateFormat changes and a new minDate/maxDate isn't provided
			if (minDate !== null && settings.dateFormat !== undefined && settings.minDate === undefined) {
				inst.settings.minDate = this._formatDate(inst, minDate);
			}
			if (maxDate !== null && settings.dateFormat !== undefined && settings.maxDate === undefined) {
				inst.settings.maxDate = this._formatDate(inst, maxDate);
			}
			if ( "disabled" in settings ) {
				if ( settings.disabled ) {
					this._disableDatepicker(target);
				} else {
					this._enableDatepicker(target);
				}
			}
			this._attachments($(target), inst);
			this._autoSize(inst);
			this._setDate(inst, date);
			this._updateAlternate(inst);
			this._updateDatepicker(inst);
		}
	},

	// change method deprecated
	_changeDatepicker: function(target, name, value) {
		this._optionDatepicker(target, name, value);
	},

	/* Redraw the date picker attached to an input field or division.
	 * @param  target  element - the target input field or division or span
	 */
	_refreshDatepicker: function(target) {
		var inst = this._getInst(target);
		if (inst) {
			this._updateDatepicker(inst);
		}
	},

	/* Set the dates for a jQuery selection.
	 * @param  target element - the target input field or division or span
	 * @param  date	Date - the new date
	 */
	_setDateDatepicker: function(target, date) {
		var inst = this._getInst(target);
		if (inst) {
			this._setDate(inst, date);
			this._updateDatepicker(inst);
			this._updateAlternate(inst);
		}
	},

	/* Get the date(s) for the first entry in a jQuery selection.
	 * @param  target element - the target input field or division or span
	 * @param  noDefault boolean - true if no default date is to be used
	 * @return Date - the current date
	 */
	_getDateDatepicker: function(target, noDefault) {
		var inst = this._getInst(target);
		if (inst && !inst.inline) {
			this._setDateFromField(inst, noDefault);
		}
		return (inst ? this._getDate(inst) : null);
	},

	/* Handle keystrokes. */
	_doKeyDown: function(event) {
		var onSelect, dateStr, sel,
			inst = $.datepicker._getInst(event.target),
			handled = true,
			isRTL = inst.dpDiv.is(".ui-datepicker-rtl");

		inst._keyEvent = true;
		if ($.datepicker._datepickerShowing) {
			switch (event.keyCode) {
				case 9: $.datepicker._hideDatepicker();
						handled = false;
						break; // hide on tab out
				case 13: sel = $("td." + $.datepicker._dayOverClass + ":not(." +
									$.datepicker._currentClass + ")", inst.dpDiv);
						if (sel[0]) {
							$.datepicker._selectDay(event.target, inst.selectedMonth, inst.selectedYear, sel[0]);
						}

						onSelect = $.datepicker._get(inst, "onSelect");
						if (onSelect) {
							dateStr = $.datepicker._formatDate(inst);

							// trigger custom callback
							onSelect.apply((inst.input ? inst.input[0] : null), [dateStr, inst]);
						} else {
							$.datepicker._hideDatepicker();
						}

						return false; // don't submit the form
				case 27: $.datepicker._hideDatepicker();
						break; // hide on escape
				case 33: $.datepicker._adjustDate(event.target, (event.ctrlKey ?
							-$.datepicker._get(inst, "stepBigMonths") :
							-$.datepicker._get(inst, "stepMonths")), "M");
						break; // previous month/year on page up/+ ctrl
				case 34: $.datepicker._adjustDate(event.target, (event.ctrlKey ?
							+$.datepicker._get(inst, "stepBigMonths") :
							+$.datepicker._get(inst, "stepMonths")), "M");
						break; // next month/year on page down/+ ctrl
				case 35: if (event.ctrlKey || event.metaKey) {
							$.datepicker._clearDate(event.target);
						}
						handled = event.ctrlKey || event.metaKey;
						break; // clear on ctrl or command +end
				case 36: if (event.ctrlKey || event.metaKey) {
							$.datepicker._gotoToday(event.target);
						}
						handled = event.ctrlKey || event.metaKey;
						break; // current on ctrl or command +home
				case 37: if (event.ctrlKey || event.metaKey) {
							$.datepicker._adjustDate(event.target, (isRTL ? +1 : -1), "D");
						}
						handled = event.ctrlKey || event.metaKey;
						// -1 day on ctrl or command +left
						if (event.originalEvent.altKey) {
							$.datepicker._adjustDate(event.target, (event.ctrlKey ?
								-$.datepicker._get(inst, "stepBigMonths") :
								-$.datepicker._get(inst, "stepMonths")), "M");
						}
						// next month/year on alt +left on Mac
						break;
				case 38: if (event.ctrlKey || event.metaKey) {
							$.datepicker._adjustDate(event.target, -7, "D");
						}
						handled = event.ctrlKey || event.metaKey;
						break; // -1 week on ctrl or command +up
				case 39: if (event.ctrlKey || event.metaKey) {
							$.datepicker._adjustDate(event.target, (isRTL ? -1 : +1), "D");
						}
						handled = event.ctrlKey || event.metaKey;
						// +1 day on ctrl or command +right
						if (event.originalEvent.altKey) {
							$.datepicker._adjustDate(event.target, (event.ctrlKey ?
								+$.datepicker._get(inst, "stepBigMonths") :
								+$.datepicker._get(inst, "stepMonths")), "M");
						}
						// next month/year on alt +right
						break;
				case 40: if (event.ctrlKey || event.metaKey) {
							$.datepicker._adjustDate(event.target, +7, "D");
						}
						handled = event.ctrlKey || event.metaKey;
						break; // +1 week on ctrl or command +down
				default: handled = false;
			}
		} else if (event.keyCode === 36 && event.ctrlKey) { // display the date picker on ctrl+home
			$.datepicker._showDatepicker(this);
		} else {
			handled = false;
		}

		if (handled) {
			event.preventDefault();
			event.stopPropagation();
		}
	},

	/* Filter entered characters - based on date format. */
	_doKeyPress: function(event) {
		var chars, chr,
			inst = $.datepicker._getInst(event.target);

		if ($.datepicker._get(inst, "constrainInput")) {
			chars = $.datepicker._possibleChars($.datepicker._get(inst, "dateFormat"));
			chr = String.fromCharCode(event.charCode == null ? event.keyCode : event.charCode);
			return event.ctrlKey || event.metaKey || (chr < " " || !chars || chars.indexOf(chr) > -1);
		}
	},

	/* Synchronise manual entry and field/alternate field. */
	_doKeyUp: function(event) {
		var date,
			inst = $.datepicker._getInst(event.target);

		if (inst.input.val() !== inst.lastVal) {
			try {
				date = $.datepicker.parseDate($.datepicker._get(inst, "dateFormat"),
					(inst.input ? inst.input.val() : null),
					$.datepicker._getFormatConfig(inst));

				if (date) { // only if valid
					$.datepicker._setDateFromField(inst);
					$.datepicker._updateAlternate(inst);
					$.datepicker._updateDatepicker(inst);
				}
			}
			catch (err) {
			}
		}
		return true;
	},

	/* Pop-up the date picker for a given input field.
	 * If false returned from beforeShow event handler do not show.
	 * @param  input  element - the input field attached to the date picker or
	 *					event - if triggered by focus
	 */
	_showDatepicker: function(input) {
		input = input.target || input;
		if (input.nodeName.toLowerCase() !== "input") { // find from button/image trigger
			input = $("input", input.parentNode)[0];
		}

		if ($.datepicker._isDisabledDatepicker(input) || $.datepicker._lastInput === input) { // already here
			return;
		}

		var inst, beforeShow, beforeShowSettings, isFixed,
			offset, showAnim, duration;

		inst = $.datepicker._getInst(input);
		if ($.datepicker._curInst && $.datepicker._curInst !== inst) {
			$.datepicker._curInst.dpDiv.stop(true, true);
			if ( inst && $.datepicker._datepickerShowing ) {
				$.datepicker._hideDatepicker( $.datepicker._curInst.input[0] );
			}
		}

		beforeShow = $.datepicker._get(inst, "beforeShow");
		beforeShowSettings = beforeShow ? beforeShow.apply(input, [input, inst]) : {};
		if(beforeShowSettings === false){
			return;
		}
		datepicker_extendRemove(inst.settings, beforeShowSettings);

		inst.lastVal = null;
		$.datepicker._lastInput = input;
		$.datepicker._setDateFromField(inst);

		if ($.datepicker._inDialog) { // hide cursor
			input.value = "";
		}
		if (!$.datepicker._pos) { // position below input
			$.datepicker._pos = $.datepicker._findPos(input);
			$.datepicker._pos[1] += input.offsetHeight; // add the height
		}

		isFixed = false;
		$(input).parents().each(function() {
			isFixed |= $(this).css("position") === "fixed";
			return !isFixed;
		});

		offset = {left: $.datepicker._pos[0], top: $.datepicker._pos[1]};
		$.datepicker._pos = null;
		//to avoid flashes on Firefox
		inst.dpDiv.empty();
		// determine sizing offscreen
		inst.dpDiv.css({position: "absolute", display: "block", top: "-1000px"});
		$.datepicker._updateDatepicker(inst);
		// fix width for dynamic number of date pickers
		// and adjust position before showing
		offset = $.datepicker._checkOffset(inst, offset, isFixed);
		inst.dpDiv.css({position: ($.datepicker._inDialog && $.blockUI ?
			"static" : (isFixed ? "fixed" : "absolute")), display: "none",
			left: offset.left + "px", top: offset.top + "px"});

		if (!inst.inline) {
			showAnim = $.datepicker._get(inst, "showAnim");
			duration = $.datepicker._get(inst, "duration");
			inst.dpDiv.css( "z-index", datepicker_getZindex( $( input ) ) + 1 );
			$.datepicker._datepickerShowing = true;

			if ( $.effects && $.effects.effect[ showAnim ] ) {
				inst.dpDiv.show(showAnim, $.datepicker._get(inst, "showOptions"), duration);
			} else {
				inst.dpDiv[showAnim || "show"](showAnim ? duration : null);
			}

			if ( $.datepicker._shouldFocusInput( inst ) ) {
				inst.input.focus();
			}

			$.datepicker._curInst = inst;
		}
	},

	/* Generate the date picker content. */
	_updateDatepicker: function(inst) {
		this.maxRows = 4; //Reset the max number of rows being displayed (see #7043)
		datepicker_instActive = inst; // for delegate hover events
		inst.dpDiv.empty().append(this._generateHTML(inst));
		this._attachHandlers(inst);

		var origyearshtml,
			numMonths = this._getNumberOfMonths(inst),
			cols = numMonths[1],
			width = 17,
			activeCell = inst.dpDiv.find( "." + this._dayOverClass + " a" );

		if ( activeCell.length > 0 ) {
			datepicker_handleMouseover.apply( activeCell.get( 0 ) );
		}

		inst.dpDiv.removeClass("ui-datepicker-multi-2 ui-datepicker-multi-3 ui-datepicker-multi-4").width("");
		if (cols > 1) {
			inst.dpDiv.addClass("ui-datepicker-multi-" + cols).css("width", (width * cols) + "em");
		}
		inst.dpDiv[(numMonths[0] !== 1 || numMonths[1] !== 1 ? "add" : "remove") +
			"Class"]("ui-datepicker-multi");
		inst.dpDiv[(this._get(inst, "isRTL") ? "add" : "remove") +
			"Class"]("ui-datepicker-rtl");

		if (inst === $.datepicker._curInst && $.datepicker._datepickerShowing && $.datepicker._shouldFocusInput( inst ) ) {
			inst.input.focus();
		}

		// deffered render of the years select (to avoid flashes on Firefox)
		if( inst.yearshtml ){
			origyearshtml = inst.yearshtml;
			setTimeout(function(){
				//assure that inst.yearshtml didn't change.
				if( origyearshtml === inst.yearshtml && inst.yearshtml ){
					inst.dpDiv.find("select.ui-datepicker-year:first").replaceWith(inst.yearshtml);
				}
				origyearshtml = inst.yearshtml = null;
			}, 0);
		}
	},

	// #6694 - don't focus the input if it's already focused
	// this breaks the change event in IE
	// Support: IE and jQuery <1.9
	_shouldFocusInput: function( inst ) {
		return inst.input && inst.input.is( ":visible" ) && !inst.input.is( ":disabled" ) && !inst.input.is( ":focus" );
	},

	/* Check positioning to remain on screen. */
	_checkOffset: function(inst, offset, isFixed) {
		var dpWidth = inst.dpDiv.outerWidth(),
			dpHeight = inst.dpDiv.outerHeight(),
			inputWidth = inst.input ? inst.input.outerWidth() : 0,
			inputHeight = inst.input ? inst.input.outerHeight() : 0,
			viewWidth = document.documentElement.clientWidth + (isFixed ? 0 : $(document).scrollLeft()),
			viewHeight = document.documentElement.clientHeight + (isFixed ? 0 : $(document).scrollTop());

		offset.left -= (this._get(inst, "isRTL") ? (dpWidth - inputWidth) : 0);
		offset.left -= (isFixed && offset.left === inst.input.offset().left) ? $(document).scrollLeft() : 0;
		offset.top -= (isFixed && offset.top === (inst.input.offset().top + inputHeight)) ? $(document).scrollTop() : 0;

		// now check if datepicker is showing outside window viewport - move to a better place if so.
		offset.left -= Math.min(offset.left, (offset.left + dpWidth > viewWidth && viewWidth > dpWidth) ?
			Math.abs(offset.left + dpWidth - viewWidth) : 0);
		offset.top -= Math.min(offset.top, (offset.top + dpHeight > viewHeight && viewHeight > dpHeight) ?
			Math.abs(dpHeight + inputHeight) : 0);

		return offset;
	},

	/* Find an object's position on the screen. */
	_findPos: function(obj) {
		var position,
			inst = this._getInst(obj),
			isRTL = this._get(inst, "isRTL");

		while (obj && (obj.type === "hidden" || obj.nodeType !== 1 || $.expr.filters.hidden(obj))) {
			obj = obj[isRTL ? "previousSibling" : "nextSibling"];
		}

		position = $(obj).offset();
		return [position.left, position.top];
	},

	/* Hide the date picker from view.
	 * @param  input  element - the input field attached to the date picker
	 */
	_hideDatepicker: function(input) {
		var showAnim, duration, postProcess, onClose,
			inst = this._curInst;

		if (!inst || (input && inst !== $.data(input, "datepicker"))) {
			return;
		}

		if (this._datepickerShowing) {
			showAnim = this._get(inst, "showAnim");
			duration = this._get(inst, "duration");
			postProcess = function() {
				$.datepicker._tidyDialog(inst);
			};

			// DEPRECATED: after BC for 1.8.x $.effects[ showAnim ] is not needed
			if ( $.effects && ( $.effects.effect[ showAnim ] || $.effects[ showAnim ] ) ) {
				inst.dpDiv.hide(showAnim, $.datepicker._get(inst, "showOptions"), duration, postProcess);
			} else {
				inst.dpDiv[(showAnim === "slideDown" ? "slideUp" :
					(showAnim === "fadeIn" ? "fadeOut" : "hide"))]((showAnim ? duration : null), postProcess);
			}

			if (!showAnim) {
				postProcess();
			}
			this._datepickerShowing = false;

			onClose = this._get(inst, "onClose");
			if (onClose) {
				onClose.apply((inst.input ? inst.input[0] : null), [(inst.input ? inst.input.val() : ""), inst]);
			}

			this._lastInput = null;
			if (this._inDialog) {
				this._dialogInput.css({ position: "absolute", left: "0", top: "-100px" });
				if ($.blockUI) {
					$.unblockUI();
					$("body").append(this.dpDiv);
				}
			}
			this._inDialog = false;
		}
	},

	/* Tidy up after a dialog display. */
	_tidyDialog: function(inst) {
		inst.dpDiv.removeClass(this._dialogClass).unbind(".ui-datepicker-calendar");
	},

	/* Close date picker if clicked elsewhere. */
	_checkExternalClick: function(event) {
		if (!$.datepicker._curInst) {
			return;
		}

		var $target = $(event.target),
			inst = $.datepicker._getInst($target[0]);

		if ( ( ( $target[0].id !== $.datepicker._mainDivId &&
				$target.parents("#" + $.datepicker._mainDivId).length === 0 &&
				!$target.hasClass($.datepicker.markerClassName) &&
				!$target.closest("." + $.datepicker._triggerClass).length &&
				$.datepicker._datepickerShowing && !($.datepicker._inDialog && $.blockUI) ) ) ||
			( $target.hasClass($.datepicker.markerClassName) && $.datepicker._curInst !== inst ) ) {
				$.datepicker._hideDatepicker();
		}
	},

	/* Adjust one of the date sub-fields. */
	_adjustDate: function(id, offset, period) {
		var target = $(id),
			inst = this._getInst(target[0]);

		if (this._isDisabledDatepicker(target[0])) {
			return;
		}
		this._adjustInstDate(inst, offset +
			(period === "M" ? this._get(inst, "showCurrentAtPos") : 0), // undo positioning
			period);
		this._updateDatepicker(inst);
	},

	/* Action for current link. */
	_gotoToday: function(id) {
		var date,
			target = $(id),
			inst = this._getInst(target[0]);

		if (this._get(inst, "gotoCurrent") && inst.currentDay) {
			inst.selectedDay = inst.currentDay;
			inst.drawMonth = inst.selectedMonth = inst.currentMonth;
			inst.drawYear = inst.selectedYear = inst.currentYear;
		} else {
			date = new Date();
			inst.selectedDay = date.getDate();
			inst.drawMonth = inst.selectedMonth = date.getMonth();
			inst.drawYear = inst.selectedYear = date.getFullYear();
		}
		this._notifyChange(inst);
		this._adjustDate(target);
	},

	/* Action for selecting a new month/year. */
	_selectMonthYear: function(id, select, period) {
		var target = $(id),
			inst = this._getInst(target[0]);

		inst["selected" + (period === "M" ? "Month" : "Year")] =
		inst["draw" + (period === "M" ? "Month" : "Year")] =
			parseInt(select.options[select.selectedIndex].value,10);

		this._notifyChange(inst);
		this._adjustDate(target);
	},

	/* Action for selecting a day. */
	_selectDay: function(id, month, year, td) {
		var inst,
			target = $(id);

		if ($(td).hasClass(this._unselectableClass) || this._isDisabledDatepicker(target[0])) {
			return;
		}

		inst = this._getInst(target[0]);
		inst.selectedDay = inst.currentDay = $("a", td).html();
		inst.selectedMonth = inst.currentMonth = month;
		inst.selectedYear = inst.currentYear = year;
		this._selectDate(id, this._formatDate(inst,
			inst.currentDay, inst.currentMonth, inst.currentYear));
	},

	/* Erase the input field and hide the date picker. */
	_clearDate: function(id) {
		var target = $(id);
		this._selectDate(target, "");
	},

	/* Update the input field with the selected date. */
	_selectDate: function(id, dateStr) {
		var onSelect,
			target = $(id),
			inst = this._getInst(target[0]);

		dateStr = (dateStr != null ? dateStr : this._formatDate(inst));
		if (inst.input) {
			inst.input.val(dateStr);
		}
		this._updateAlternate(inst);

		onSelect = this._get(inst, "onSelect");
		if (onSelect) {
			onSelect.apply((inst.input ? inst.input[0] : null), [dateStr, inst]);  // trigger custom callback
		} else if (inst.input) {
			inst.input.trigger("change"); // fire the change event
		}

		if (inst.inline){
			this._updateDatepicker(inst);
		} else {
			this._hideDatepicker();
			this._lastInput = inst.input[0];
			if (typeof(inst.input[0]) !== "object") {
				inst.input.focus(); // restore focus
			}
			this._lastInput = null;
		}
	},

	/* Update any alternate field to synchronise with the main field. */
	_updateAlternate: function(inst) {
		var altFormat, date, dateStr,
			altField = this._get(inst, "altField");

		if (altField) { // update alternate field too
			altFormat = this._get(inst, "altFormat") || this._get(inst, "dateFormat");
			date = this._getDate(inst);
			dateStr = this.formatDate(altFormat, date, this._getFormatConfig(inst));
			$(altField).each(function() { $(this).val(dateStr); });
		}
	},

	/* Set as beforeShowDay function to prevent selection of weekends.
	 * @param  date  Date - the date to customise
	 * @return [boolean, string] - is this date selectable?, what is its CSS class?
	 */
	noWeekends: function(date) {
		var day = date.getDay();
		return [(day > 0 && day < 6), ""];
	},

	/* Set as calculateWeek to determine the week of the year based on the ISO 8601 definition.
	 * @param  date  Date - the date to get the week for
	 * @return  number - the number of the week within the year that contains this date
	 */
	iso8601Week: function(date) {
		var time,
			checkDate = new Date(date.getTime());

		// Find Thursday of this week starting on Monday
		checkDate.setDate(checkDate.getDate() + 4 - (checkDate.getDay() || 7));

		time = checkDate.getTime();
		checkDate.setMonth(0); // Compare with Jan 1
		checkDate.setDate(1);
		return Math.floor(Math.round((time - checkDate) / 86400000) / 7) + 1;
	},

	/* Parse a string value into a date object.
	 * See formatDate below for the possible formats.
	 *
	 * @param  format string - the expected format of the date
	 * @param  value string - the date in the above format
	 * @param  settings Object - attributes include:
	 *					shortYearCutoff  number - the cutoff year for determining the century (optional)
	 *					dayNamesShort	string[7] - abbreviated names of the days from Sunday (optional)
	 *					dayNames		string[7] - names of the days from Sunday (optional)
	 *					monthNamesShort string[12] - abbreviated names of the months (optional)
	 *					monthNames		string[12] - names of the months (optional)
	 * @return  Date - the extracted date value or null if value is blank
	 */
	parseDate: function (format, value, settings) {
		if (format == null || value == null) {
			throw "Invalid arguments";
		}

		value = (typeof value === "object" ? value.toString() : value + "");
		if (value === "") {
			return null;
		}

		var iFormat, dim, extra,
			iValue = 0,
			shortYearCutoffTemp = (settings ? settings.shortYearCutoff : null) || this._defaults.shortYearCutoff,
			shortYearCutoff = (typeof shortYearCutoffTemp !== "string" ? shortYearCutoffTemp :
				new Date().getFullYear() % 100 + parseInt(shortYearCutoffTemp, 10)),
			dayNamesShort = (settings ? settings.dayNamesShort : null) || this._defaults.dayNamesShort,
			dayNames = (settings ? settings.dayNames : null) || this._defaults.dayNames,
			monthNamesShort = (settings ? settings.monthNamesShort : null) || this._defaults.monthNamesShort,
			monthNames = (settings ? settings.monthNames : null) || this._defaults.monthNames,
			year = -1,
			month = -1,
			day = -1,
			doy = -1,
			literal = false,
			date,
			// Check whether a format character is doubled
			lookAhead = function(match) {
				var matches = (iFormat + 1 < format.length && format.charAt(iFormat + 1) === match);
				if (matches) {
					iFormat++;
				}
				return matches;
			},
			// Extract a number from the string value
			getNumber = function(match) {
				var isDoubled = lookAhead(match),
					size = (match === "@" ? 14 : (match === "!" ? 20 :
					(match === "y" && isDoubled ? 4 : (match === "o" ? 3 : 2)))),
					minSize = (match === "y" ? size : 1),
					digits = new RegExp("^\\d{" + minSize + "," + size + "}"),
					num = value.substring(iValue).match(digits);
				if (!num) {
					throw "Missing number at position " + iValue;
				}
				iValue += num[0].length;
				return parseInt(num[0], 10);
			},
			// Extract a name from the string value and convert to an index
			getName = function(match, shortNames, longNames) {
				var index = -1,
					names = $.map(lookAhead(match) ? longNames : shortNames, function (v, k) {
						return [ [k, v] ];
					}).sort(function (a, b) {
						return -(a[1].length - b[1].length);
					});

				$.each(names, function (i, pair) {
					var name = pair[1];
					if (value.substr(iValue, name.length).toLowerCase() === name.toLowerCase()) {
						index = pair[0];
						iValue += name.length;
						return false;
					}
				});
				if (index !== -1) {
					return index + 1;
				} else {
					throw "Unknown name at position " + iValue;
				}
			},
			// Confirm that a literal character matches the string value
			checkLiteral = function() {
				if (value.charAt(iValue) !== format.charAt(iFormat)) {
					throw "Unexpected literal at position " + iValue;
				}
				iValue++;
			};

		for (iFormat = 0; iFormat < format.length; iFormat++) {
			if (literal) {
				if (format.charAt(iFormat) === "'" && !lookAhead("'")) {
					literal = false;
				} else {
					checkLiteral();
				}
			} else {
				switch (format.charAt(iFormat)) {
					case "d":
						day = getNumber("d");
						break;
					case "D":
						getName("D", dayNamesShort, dayNames);
						break;
					case "o":
						doy = getNumber("o");
						break;
					case "m":
						month = getNumber("m");
						break;
					case "M":
						month = getName("M", monthNamesShort, monthNames);
						break;
					case "y":
						year = getNumber("y");
						break;
					case "@":
						date = new Date(getNumber("@"));
						year = date.getFullYear();
						month = date.getMonth() + 1;
						day = date.getDate();
						break;
					case "!":
						date = new Date((getNumber("!") - this._ticksTo1970) / 10000);
						year = date.getFullYear();
						month = date.getMonth() + 1;
						day = date.getDate();
						break;
					case "'":
						if (lookAhead("'")){
							checkLiteral();
						} else {
							literal = true;
						}
						break;
					default:
						checkLiteral();
				}
			}
		}

		if (iValue < value.length){
			extra = value.substr(iValue);
			if (!/^\s+/.test(extra)) {
				throw "Extra/unparsed characters found in date: " + extra;
			}
		}

		if (year === -1) {
			year = new Date().getFullYear();
		} else if (year < 100) {
			year += new Date().getFullYear() - new Date().getFullYear() % 100 +
				(year <= shortYearCutoff ? 0 : -100);
		}

		if (doy > -1) {
			month = 1;
			day = doy;
			do {
				dim = this._getDaysInMonth(year, month - 1);
				if (day <= dim) {
					break;
				}
				month++;
				day -= dim;
			} while (true);
		}

		date = this._daylightSavingAdjust(new Date(year, month - 1, day));
		if (date.getFullYear() !== year || date.getMonth() + 1 !== month || date.getDate() !== day) {
			throw "Invalid date"; // E.g. 31/02/00
		}
		return date;
	},

	/* Standard date formats. */
	ATOM: "yy-mm-dd", // RFC 3339 (ISO 8601)
	COOKIE: "D, dd M yy",
	ISO_8601: "yy-mm-dd",
	RFC_822: "D, d M y",
	RFC_850: "DD, dd-M-y",
	RFC_1036: "D, d M y",
	RFC_1123: "D, d M yy",
	RFC_2822: "D, d M yy",
	RSS: "D, d M y", // RFC 822
	TICKS: "!",
	TIMESTAMP: "@",
	W3C: "yy-mm-dd", // ISO 8601

	_ticksTo1970: (((1970 - 1) * 365 + Math.floor(1970 / 4) - Math.floor(1970 / 100) +
		Math.floor(1970 / 400)) * 24 * 60 * 60 * 10000000),

	/* Format a date object into a string value.
	 * The format can be combinations of the following:
	 * d  - day of month (no leading zero)
	 * dd - day of month (two digit)
	 * o  - day of year (no leading zeros)
	 * oo - day of year (three digit)
	 * D  - day name short
	 * DD - day name long
	 * m  - month of year (no leading zero)
	 * mm - month of year (two digit)
	 * M  - month name short
	 * MM - month name long
	 * y  - year (two digit)
	 * yy - year (four digit)
	 * @ - Unix timestamp (ms since 01/01/1970)
	 * ! - Windows ticks (100ns since 01/01/0001)
	 * "..." - literal text
	 * '' - single quote
	 *
	 * @param  format string - the desired format of the date
	 * @param  date Date - the date value to format
	 * @param  settings Object - attributes include:
	 *					dayNamesShort	string[7] - abbreviated names of the days from Sunday (optional)
	 *					dayNames		string[7] - names of the days from Sunday (optional)
	 *					monthNamesShort string[12] - abbreviated names of the months (optional)
	 *					monthNames		string[12] - names of the months (optional)
	 * @return  string - the date in the above format
	 */
	formatDate: function (format, date, settings) {
		if (!date) {
			return "";
		}

		var iFormat,
			dayNamesShort = (settings ? settings.dayNamesShort : null) || this._defaults.dayNamesShort,
			dayNames = (settings ? settings.dayNames : null) || this._defaults.dayNames,
			monthNamesShort = (settings ? settings.monthNamesShort : null) || this._defaults.monthNamesShort,
			monthNames = (settings ? settings.monthNames : null) || this._defaults.monthNames,
			// Check whether a format character is doubled
			lookAhead = function(match) {
				var matches = (iFormat + 1 < format.length && format.charAt(iFormat + 1) === match);
				if (matches) {
					iFormat++;
				}
				return matches;
			},
			// Format a number, with leading zero if necessary
			formatNumber = function(match, value, len) {
				var num = "" + value;
				if (lookAhead(match)) {
					while (num.length < len) {
						num = "0" + num;
					}
				}
				return num;
			},
			// Format a name, short or long as requested
			formatName = function(match, value, shortNames, longNames) {
				return (lookAhead(match) ? longNames[value] : shortNames[value]);
			},
			output = "",
			literal = false;

		if (date) {
			for (iFormat = 0; iFormat < format.length; iFormat++) {
				if (literal) {
					if (format.charAt(iFormat) === "'" && !lookAhead("'")) {
						literal = false;
					} else {
						output += format.charAt(iFormat);
					}
				} else {
					switch (format.charAt(iFormat)) {
						case "d":
							output += formatNumber("d", date.getDate(), 2);
							break;
						case "D":
							output += formatName("D", date.getDay(), dayNamesShort, dayNames);
							break;
						case "o":
							output += formatNumber("o",
								Math.round((new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime() - new Date(date.getFullYear(), 0, 0).getTime()) / 86400000), 3);
							break;
						case "m":
							output += formatNumber("m", date.getMonth() + 1, 2);
							break;
						case "M":
							output += formatName("M", date.getMonth(), monthNamesShort, monthNames);
							break;
						case "y":
							output += (lookAhead("y") ? date.getFullYear() :
								(date.getYear() % 100 < 10 ? "0" : "") + date.getYear() % 100);
							break;
						case "@":
							output += date.getTime();
							break;
						case "!":
							output += date.getTime() * 10000 + this._ticksTo1970;
							break;
						case "'":
							if (lookAhead("'")) {
								output += "'";
							} else {
								literal = true;
							}
							break;
						default:
							output += format.charAt(iFormat);
					}
				}
			}
		}
		return output;
	},

	/* Extract all possible characters from the date format. */
	_possibleChars: function (format) {
		var iFormat,
			chars = "",
			literal = false,
			// Check whether a format character is doubled
			lookAhead = function(match) {
				var matches = (iFormat + 1 < format.length && format.charAt(iFormat + 1) === match);
				if (matches) {
					iFormat++;
				}
				return matches;
			};

		for (iFormat = 0; iFormat < format.length; iFormat++) {
			if (literal) {
				if (format.charAt(iFormat) === "'" && !lookAhead("'")) {
					literal = false;
				} else {
					chars += format.charAt(iFormat);
				}
			} else {
				switch (format.charAt(iFormat)) {
					case "d": case "m": case "y": case "@":
						chars += "0123456789";
						break;
					case "D": case "M":
						return null; // Accept anything
					case "'":
						if (lookAhead("'")) {
							chars += "'";
						} else {
							literal = true;
						}
						break;
					default:
						chars += format.charAt(iFormat);
				}
			}
		}
		return chars;
	},

	/* Get a setting value, defaulting if necessary. */
	_get: function(inst, name) {
		return inst.settings[name] !== undefined ?
			inst.settings[name] : this._defaults[name];
	},

	/* Parse existing date and initialise date picker. */
	_setDateFromField: function(inst, noDefault) {
		if (inst.input.val() === inst.lastVal) {
			return;
		}

		var dateFormat = this._get(inst, "dateFormat"),
			dates = inst.lastVal = inst.input ? inst.input.val() : null,
			defaultDate = this._getDefaultDate(inst),
			date = defaultDate,
			settings = this._getFormatConfig(inst);

		try {
			date = this.parseDate(dateFormat, dates, settings) || defaultDate;
		} catch (event) {
			dates = (noDefault ? "" : dates);
		}
		inst.selectedDay = date.getDate();
		inst.drawMonth = inst.selectedMonth = date.getMonth();
		inst.drawYear = inst.selectedYear = date.getFullYear();
		inst.currentDay = (dates ? date.getDate() : 0);
		inst.currentMonth = (dates ? date.getMonth() : 0);
		inst.currentYear = (dates ? date.getFullYear() : 0);
		this._adjustInstDate(inst);
	},

	/* Retrieve the default date shown on opening. */
	_getDefaultDate: function(inst) {
		return this._restrictMinMax(inst,
			this._determineDate(inst, this._get(inst, "defaultDate"), new Date()));
	},

	/* A date may be specified as an exact value or a relative one. */
	_determineDate: function(inst, date, defaultDate) {
		var offsetNumeric = function(offset) {
				var date = new Date();
				date.setDate(date.getDate() + offset);
				return date;
			},
			offsetString = function(offset) {
				try {
					return $.datepicker.parseDate($.datepicker._get(inst, "dateFormat"),
						offset, $.datepicker._getFormatConfig(inst));
				}
				catch (e) {
					// Ignore
				}

				var date = (offset.toLowerCase().match(/^c/) ?
					$.datepicker._getDate(inst) : null) || new Date(),
					year = date.getFullYear(),
					month = date.getMonth(),
					day = date.getDate(),
					pattern = /([+\-]?[0-9]+)\s*(d|D|w|W|m|M|y|Y)?/g,
					matches = pattern.exec(offset);

				while (matches) {
					switch (matches[2] || "d") {
						case "d" : case "D" :
							day += parseInt(matches[1],10); break;
						case "w" : case "W" :
							day += parseInt(matches[1],10) * 7; break;
						case "m" : case "M" :
							month += parseInt(matches[1],10);
							day = Math.min(day, $.datepicker._getDaysInMonth(year, month));
							break;
						case "y": case "Y" :
							year += parseInt(matches[1],10);
							day = Math.min(day, $.datepicker._getDaysInMonth(year, month));
							break;
					}
					matches = pattern.exec(offset);
				}
				return new Date(year, month, day);
			},
			newDate = (date == null || date === "" ? defaultDate : (typeof date === "string" ? offsetString(date) :
				(typeof date === "number" ? (isNaN(date) ? defaultDate : offsetNumeric(date)) : new Date(date.getTime()))));

		newDate = (newDate && newDate.toString() === "Invalid Date" ? defaultDate : newDate);
		if (newDate) {
			newDate.setHours(0);
			newDate.setMinutes(0);
			newDate.setSeconds(0);
			newDate.setMilliseconds(0);
		}
		return this._daylightSavingAdjust(newDate);
	},

	/* Handle switch to/from daylight saving.
	 * Hours may be non-zero on daylight saving cut-over:
	 * > 12 when midnight changeover, but then cannot generate
	 * midnight datetime, so jump to 1AM, otherwise reset.
	 * @param  date  (Date) the date to check
	 * @return  (Date) the corrected date
	 */
	_daylightSavingAdjust: function(date) {
		if (!date) {
			return null;
		}
		date.setHours(date.getHours() > 12 ? date.getHours() + 2 : 0);
		return date;
	},

	/* Set the date(s) directly. */
	_setDate: function(inst, date, noChange) {
		var clear = !date,
			origMonth = inst.selectedMonth,
			origYear = inst.selectedYear,
			newDate = this._restrictMinMax(inst, this._determineDate(inst, date, new Date()));

		inst.selectedDay = inst.currentDay = newDate.getDate();
		inst.drawMonth = inst.selectedMonth = inst.currentMonth = newDate.getMonth();
		inst.drawYear = inst.selectedYear = inst.currentYear = newDate.getFullYear();
		if ((origMonth !== inst.selectedMonth || origYear !== inst.selectedYear) && !noChange) {
			this._notifyChange(inst);
		}
		this._adjustInstDate(inst);
		if (inst.input) {
			inst.input.val(clear ? "" : this._formatDate(inst));
		}
	},

	/* Retrieve the date(s) directly. */
	_getDate: function(inst) {
		var startDate = (!inst.currentYear || (inst.input && inst.input.val() === "") ? null :
			this._daylightSavingAdjust(new Date(
			inst.currentYear, inst.currentMonth, inst.currentDay)));
			return startDate;
	},

	/* Attach the onxxx handlers.  These are declared statically so
	 * they work with static code transformers like Caja.
	 */
	_attachHandlers: function(inst) {
		var stepMonths = this._get(inst, "stepMonths"),
			id = "#" + inst.id.replace( /\\\\/g, "\\" );
		inst.dpDiv.find("[data-handler]").map(function () {
			var handler = {
				prev: function () {
					$.datepicker._adjustDate(id, -stepMonths, "M");
				},
				next: function () {
					$.datepicker._adjustDate(id, +stepMonths, "M");
				},
				hide: function () {
					$.datepicker._hideDatepicker();
				},
				today: function () {
					$.datepicker._gotoToday(id);
				},
				selectDay: function () {
					$.datepicker._selectDay(id, +this.getAttribute("data-month"), +this.getAttribute("data-year"), this);
					return false;
				},
				selectMonth: function () {
					$.datepicker._selectMonthYear(id, this, "M");
					return false;
				},
				selectYear: function () {
					$.datepicker._selectMonthYear(id, this, "Y");
					return false;
				}
			};
			$(this).bind(this.getAttribute("data-event"), handler[this.getAttribute("data-handler")]);
		});
	},

	/* Generate the HTML for the current state of the date picker. */
	_generateHTML: function(inst) {
		var maxDraw, prevText, prev, nextText, next, currentText, gotoDate,
			controls, buttonPanel, firstDay, showWeek, dayNames, dayNamesMin,
			monthNames, monthNamesShort, beforeShowDay, showOtherMonths,
			selectOtherMonths, defaultDate, html, dow, row, group, col, selectedDate,
			cornerClass, calender, thead, day, daysInMonth, leadDays, curRows, numRows,
			printDate, dRow, tbody, daySettings, otherMonth, unselectable,
			tempDate = new Date(),
			today = this._daylightSavingAdjust(
				new Date(tempDate.getFullYear(), tempDate.getMonth(), tempDate.getDate())), // clear time
			isRTL = this._get(inst, "isRTL"),
			showButtonPanel = this._get(inst, "showButtonPanel"),
			hideIfNoPrevNext = this._get(inst, "hideIfNoPrevNext"),
			navigationAsDateFormat = this._get(inst, "navigationAsDateFormat"),
			numMonths = this._getNumberOfMonths(inst),
			showCurrentAtPos = this._get(inst, "showCurrentAtPos"),
			stepMonths = this._get(inst, "stepMonths"),
			isMultiMonth = (numMonths[0] !== 1 || numMonths[1] !== 1),
			currentDate = this._daylightSavingAdjust((!inst.currentDay ? new Date(9999, 9, 9) :
				new Date(inst.currentYear, inst.currentMonth, inst.currentDay))),
			minDate = this._getMinMaxDate(inst, "min"),
			maxDate = this._getMinMaxDate(inst, "max"),
			drawMonth = inst.drawMonth - showCurrentAtPos,
			drawYear = inst.drawYear;

		if (drawMonth < 0) {
			drawMonth += 12;
			drawYear--;
		}
		if (maxDate) {
			maxDraw = this._daylightSavingAdjust(new Date(maxDate.getFullYear(),
				maxDate.getMonth() - (numMonths[0] * numMonths[1]) + 1, maxDate.getDate()));
			maxDraw = (minDate && maxDraw < minDate ? minDate : maxDraw);
			while (this._daylightSavingAdjust(new Date(drawYear, drawMonth, 1)) > maxDraw) {
				drawMonth--;
				if (drawMonth < 0) {
					drawMonth = 11;
					drawYear--;
				}
			}
		}
		inst.drawMonth = drawMonth;
		inst.drawYear = drawYear;

		prevText = this._get(inst, "prevText");
		prevText = (!navigationAsDateFormat ? prevText : this.formatDate(prevText,
			this._daylightSavingAdjust(new Date(drawYear, drawMonth - stepMonths, 1)),
			this._getFormatConfig(inst)));

		prev = (this._canAdjustMonth(inst, -1, drawYear, drawMonth) ?
			"<a class='ui-datepicker-prev ui-corner-all' data-handler='prev' data-event='click'" +
			" title='" + prevText + "'><span class='ui-icon ui-icon-circle-triangle-" + ( isRTL ? "e" : "w") + "'>" + prevText + "</span></a>" :
			(hideIfNoPrevNext ? "" : "<a class='ui-datepicker-prev ui-corner-all ui-state-disabled' title='"+ prevText +"'><span class='ui-icon ui-icon-circle-triangle-" + ( isRTL ? "e" : "w") + "'>" + prevText + "</span></a>"));

		nextText = this._get(inst, "nextText");
		nextText = (!navigationAsDateFormat ? nextText : this.formatDate(nextText,
			this._daylightSavingAdjust(new Date(drawYear, drawMonth + stepMonths, 1)),
			this._getFormatConfig(inst)));

		next = (this._canAdjustMonth(inst, +1, drawYear, drawMonth) ?
			"<a class='ui-datepicker-next ui-corner-all' data-handler='next' data-event='click'" +
			" title='" + nextText + "'><span class='ui-icon ui-icon-circle-triangle-" + ( isRTL ? "w" : "e") + "'>" + nextText + "</span></a>" :
			(hideIfNoPrevNext ? "" : "<a class='ui-datepicker-next ui-corner-all ui-state-disabled' title='"+ nextText + "'><span class='ui-icon ui-icon-circle-triangle-" + ( isRTL ? "w" : "e") + "'>" + nextText + "</span></a>"));

		currentText = this._get(inst, "currentText");
		gotoDate = (this._get(inst, "gotoCurrent") && inst.currentDay ? currentDate : today);
		currentText = (!navigationAsDateFormat ? currentText :
			this.formatDate(currentText, gotoDate, this._getFormatConfig(inst)));

		controls = (!inst.inline ? "<button type='button' class='ui-datepicker-close ui-state-default ui-priority-primary ui-corner-all' data-handler='hide' data-event='click'>" +
			this._get(inst, "closeText") + "</button>" : "");

		buttonPanel = (showButtonPanel) ? "<div class='ui-datepicker-buttonpane ui-widget-content'>" + (isRTL ? controls : "") +
			(this._isInRange(inst, gotoDate) ? "<button type='button' class='ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all' data-handler='today' data-event='click'" +
			">" + currentText + "</button>" : "") + (isRTL ? "" : controls) + "</div>" : "";

		firstDay = parseInt(this._get(inst, "firstDay"),10);
		firstDay = (isNaN(firstDay) ? 0 : firstDay);

		showWeek = this._get(inst, "showWeek");
		dayNames = this._get(inst, "dayNames");
		dayNamesMin = this._get(inst, "dayNamesMin");
		monthNames = this._get(inst, "monthNames");
		monthNamesShort = this._get(inst, "monthNamesShort");
		beforeShowDay = this._get(inst, "beforeShowDay");
		showOtherMonths = this._get(inst, "showOtherMonths");
		selectOtherMonths = this._get(inst, "selectOtherMonths");
		defaultDate = this._getDefaultDate(inst);
		html = "";
		dow;
		for (row = 0; row < numMonths[0]; row++) {
			group = "";
			this.maxRows = 4;
			for (col = 0; col < numMonths[1]; col++) {
				selectedDate = this._daylightSavingAdjust(new Date(drawYear, drawMonth, inst.selectedDay));
				cornerClass = " ui-corner-all";
				calender = "";
				if (isMultiMonth) {
					calender += "<div class='ui-datepicker-group";
					if (numMonths[1] > 1) {
						switch (col) {
							case 0: calender += " ui-datepicker-group-first";
								cornerClass = " ui-corner-" + (isRTL ? "right" : "left"); break;
							case numMonths[1]-1: calender += " ui-datepicker-group-last";
								cornerClass = " ui-corner-" + (isRTL ? "left" : "right"); break;
							default: calender += " ui-datepicker-group-middle"; cornerClass = ""; break;
						}
					}
					calender += "'>";
				}
				calender += "<div class='ui-datepicker-header ui-widget-header ui-helper-clearfix" + cornerClass + "'>" +
					(/all|left/.test(cornerClass) && row === 0 ? (isRTL ? next : prev) : "") +
					(/all|right/.test(cornerClass) && row === 0 ? (isRTL ? prev : next) : "") +
					this._generateMonthYearHeader(inst, drawMonth, drawYear, minDate, maxDate,
					row > 0 || col > 0, monthNames, monthNamesShort) + // draw month headers
					"</div><table class='ui-datepicker-calendar'><thead>" +
					"<tr>";
				thead = (showWeek ? "<th class='ui-datepicker-week-col'>" + this._get(inst, "weekHeader") + "</th>" : "");
				for (dow = 0; dow < 7; dow++) { // days of the week
					day = (dow + firstDay) % 7;
					thead += "<th scope='col'" + ((dow + firstDay + 6) % 7 >= 5 ? " class='ui-datepicker-week-end'" : "") + ">" +
						"<span title='" + dayNames[day] + "'>" + dayNamesMin[day] + "</span></th>";
				}
				calender += thead + "</tr></thead><tbody>";
				daysInMonth = this._getDaysInMonth(drawYear, drawMonth);
				if (drawYear === inst.selectedYear && drawMonth === inst.selectedMonth) {
					inst.selectedDay = Math.min(inst.selectedDay, daysInMonth);
				}
				leadDays = (this._getFirstDayOfMonth(drawYear, drawMonth) - firstDay + 7) % 7;
				curRows = Math.ceil((leadDays + daysInMonth) / 7); // calculate the number of rows to generate
				numRows = (isMultiMonth ? this.maxRows > curRows ? this.maxRows : curRows : curRows); //If multiple months, use the higher number of rows (see #7043)
				this.maxRows = numRows;
				printDate = this._daylightSavingAdjust(new Date(drawYear, drawMonth, 1 - leadDays));
				for (dRow = 0; dRow < numRows; dRow++) { // create date picker rows
					calender += "<tr>";
					tbody = (!showWeek ? "" : "<td class='ui-datepicker-week-col'>" +
						this._get(inst, "calculateWeek")(printDate) + "</td>");
					for (dow = 0; dow < 7; dow++) { // create date picker days
						daySettings = (beforeShowDay ?
							beforeShowDay.apply((inst.input ? inst.input[0] : null), [printDate]) : [true, ""]);
						otherMonth = (printDate.getMonth() !== drawMonth);
						unselectable = (otherMonth && !selectOtherMonths) || !daySettings[0] ||
							(minDate && printDate < minDate) || (maxDate && printDate > maxDate);
						tbody += "<td class='" +
							((dow + firstDay + 6) % 7 >= 5 ? " ui-datepicker-week-end" : "") + // highlight weekends
							(otherMonth ? " ui-datepicker-other-month" : "") + // highlight days from other months
							((printDate.getTime() === selectedDate.getTime() && drawMonth === inst.selectedMonth && inst._keyEvent) || // user pressed key
							(defaultDate.getTime() === printDate.getTime() && defaultDate.getTime() === selectedDate.getTime()) ?
							// or defaultDate is current printedDate and defaultDate is selectedDate
							" " + this._dayOverClass : "") + // highlight selected day
							(unselectable ? " " + this._unselectableClass + " ui-state-disabled": "") +  // highlight unselectable days
							(otherMonth && !showOtherMonths ? "" : " " + daySettings[1] + // highlight custom dates
							(printDate.getTime() === currentDate.getTime() ? " " + this._currentClass : "") + // highlight selected day
							(printDate.getTime() === today.getTime() ? " ui-datepicker-today" : "")) + "'" + // highlight today (if different)
							((!otherMonth || showOtherMonths) && daySettings[2] ? " title='" + daySettings[2].replace(/'/g, "&#39;") + "'" : "") + // cell title
							(unselectable ? "" : " data-handler='selectDay' data-event='click' data-month='" + printDate.getMonth() + "' data-year='" + printDate.getFullYear() + "'") + ">" + // actions
							(otherMonth && !showOtherMonths ? "&#xa0;" : // display for other months
							(unselectable ? "<span class='ui-state-default'>" + printDate.getDate() + "</span>" : "<a class='ui-state-default" +
							(printDate.getTime() === today.getTime() ? " ui-state-highlight" : "") +
							(printDate.getTime() === currentDate.getTime() ? " ui-state-active" : "") + // highlight selected day
							(otherMonth ? " ui-priority-secondary" : "") + // distinguish dates from other months
							"' href='#'>" + printDate.getDate() + "</a>")) + "</td>"; // display selectable date
						printDate.setDate(printDate.getDate() + 1);
						printDate = this._daylightSavingAdjust(printDate);
					}
					calender += tbody + "</tr>";
				}
				drawMonth++;
				if (drawMonth > 11) {
					drawMonth = 0;
					drawYear++;
				}
				calender += "</tbody></table>" + (isMultiMonth ? "</div>" +
							((numMonths[0] > 0 && col === numMonths[1]-1) ? "<div class='ui-datepicker-row-break'></div>" : "") : "");
				group += calender;
			}
			html += group;
		}
		html += buttonPanel;
		inst._keyEvent = false;
		return html;
	},

	/* Generate the month and year header. */
	_generateMonthYearHeader: function(inst, drawMonth, drawYear, minDate, maxDate,
			secondary, monthNames, monthNamesShort) {

		var inMinYear, inMaxYear, month, years, thisYear, determineYear, year, endYear,
			changeMonth = this._get(inst, "changeMonth"),
			changeYear = this._get(inst, "changeYear"),
			showMonthAfterYear = this._get(inst, "showMonthAfterYear"),
			html = "<div class='ui-datepicker-title'>",
			monthHtml = "";

		// month selection
		if (secondary || !changeMonth) {
			monthHtml += "<span class='ui-datepicker-month'>" + monthNames[drawMonth] + "</span>";
		} else {
			inMinYear = (minDate && minDate.getFullYear() === drawYear);
			inMaxYear = (maxDate && maxDate.getFullYear() === drawYear);
			monthHtml += "<select class='ui-datepicker-month' data-handler='selectMonth' data-event='change'>";
			for ( month = 0; month < 12; month++) {
				if ((!inMinYear || month >= minDate.getMonth()) && (!inMaxYear || month <= maxDate.getMonth())) {
					monthHtml += "<option value='" + month + "'" +
						(month === drawMonth ? " selected='selected'" : "") +
						">" + monthNamesShort[month] + "</option>";
				}
			}
			monthHtml += "</select>";
		}

		if (!showMonthAfterYear) {
			html += monthHtml + (secondary || !(changeMonth && changeYear) ? "&#xa0;" : "");
		}

		// year selection
		if ( !inst.yearshtml ) {
			inst.yearshtml = "";
			if (secondary || !changeYear) {
				html += "<span class='ui-datepicker-year'>" + drawYear + "</span>";
			} else {
				// determine range of years to display
				years = this._get(inst, "yearRange").split(":");
				thisYear = new Date().getFullYear();
				determineYear = function(value) {
					var year = (value.match(/c[+\-].*/) ? drawYear + parseInt(value.substring(1), 10) :
						(value.match(/[+\-].*/) ? thisYear + parseInt(value, 10) :
						parseInt(value, 10)));
					return (isNaN(year) ? thisYear : year);
				};
				year = determineYear(years[0]);
				endYear = Math.max(year, determineYear(years[1] || ""));
				year = (minDate ? Math.max(year, minDate.getFullYear()) : year);
				endYear = (maxDate ? Math.min(endYear, maxDate.getFullYear()) : endYear);
				inst.yearshtml += "<select class='ui-datepicker-year' data-handler='selectYear' data-event='change'>";
				for (; year <= endYear; year++) {
					inst.yearshtml += "<option value='" + year + "'" +
						(year === drawYear ? " selected='selected'" : "") +
						">" + year + "</option>";
				}
				inst.yearshtml += "</select>";

				html += inst.yearshtml;
				inst.yearshtml = null;
			}
		}

		html += this._get(inst, "yearSuffix");
		if (showMonthAfterYear) {
			html += (secondary || !(changeMonth && changeYear) ? "&#xa0;" : "") + monthHtml;
		}
		html += "</div>"; // Close datepicker_header
		return html;
	},

	/* Adjust one of the date sub-fields. */
	_adjustInstDate: function(inst, offset, period) {
		var year = inst.drawYear + (period === "Y" ? offset : 0),
			month = inst.drawMonth + (period === "M" ? offset : 0),
			day = Math.min(inst.selectedDay, this._getDaysInMonth(year, month)) + (period === "D" ? offset : 0),
			date = this._restrictMinMax(inst, this._daylightSavingAdjust(new Date(year, month, day)));

		inst.selectedDay = date.getDate();
		inst.drawMonth = inst.selectedMonth = date.getMonth();
		inst.drawYear = inst.selectedYear = date.getFullYear();
		if (period === "M" || period === "Y") {
			this._notifyChange(inst);
		}
	},

	/* Ensure a date is within any min/max bounds. */
	_restrictMinMax: function(inst, date) {
		var minDate = this._getMinMaxDate(inst, "min"),
			maxDate = this._getMinMaxDate(inst, "max"),
			newDate = (minDate && date < minDate ? minDate : date);
		return (maxDate && newDate > maxDate ? maxDate : newDate);
	},

	/* Notify change of month/year. */
	_notifyChange: function(inst) {
		var onChange = this._get(inst, "onChangeMonthYear");
		if (onChange) {
			onChange.apply((inst.input ? inst.input[0] : null),
				[inst.selectedYear, inst.selectedMonth + 1, inst]);
		}
	},

	/* Determine the number of months to show. */
	_getNumberOfMonths: function(inst) {
		var numMonths = this._get(inst, "numberOfMonths");
		return (numMonths == null ? [1, 1] : (typeof numMonths === "number" ? [1, numMonths] : numMonths));
	},

	/* Determine the current maximum date - ensure no time components are set. */
	_getMinMaxDate: function(inst, minMax) {
		return this._determineDate(inst, this._get(inst, minMax + "Date"), null);
	},

	/* Find the number of days in a given month. */
	_getDaysInMonth: function(year, month) {
		return 32 - this._daylightSavingAdjust(new Date(year, month, 32)).getDate();
	},

	/* Find the day of the week of the first of a month. */
	_getFirstDayOfMonth: function(year, month) {
		return new Date(year, month, 1).getDay();
	},

	/* Determines if we should allow a "next/prev" month display change. */
	_canAdjustMonth: function(inst, offset, curYear, curMonth) {
		var numMonths = this._getNumberOfMonths(inst),
			date = this._daylightSavingAdjust(new Date(curYear,
			curMonth + (offset < 0 ? offset : numMonths[0] * numMonths[1]), 1));

		if (offset < 0) {
			date.setDate(this._getDaysInMonth(date.getFullYear(), date.getMonth()));
		}
		return this._isInRange(inst, date);
	},

	/* Is the given date in the accepted range? */
	_isInRange: function(inst, date) {
		var yearSplit, currentYear,
			minDate = this._getMinMaxDate(inst, "min"),
			maxDate = this._getMinMaxDate(inst, "max"),
			minYear = null,
			maxYear = null,
			years = this._get(inst, "yearRange");
			if (years){
				yearSplit = years.split(":");
				currentYear = new Date().getFullYear();
				minYear = parseInt(yearSplit[0], 10);
				maxYear = parseInt(yearSplit[1], 10);
				if ( yearSplit[0].match(/[+\-].*/) ) {
					minYear += currentYear;
				}
				if ( yearSplit[1].match(/[+\-].*/) ) {
					maxYear += currentYear;
				}
			}

		return ((!minDate || date.getTime() >= minDate.getTime()) &&
			(!maxDate || date.getTime() <= maxDate.getTime()) &&
			(!minYear || date.getFullYear() >= minYear) &&
			(!maxYear || date.getFullYear() <= maxYear));
	},

	/* Provide the configuration settings for formatting/parsing. */
	_getFormatConfig: function(inst) {
		var shortYearCutoff = this._get(inst, "shortYearCutoff");
		shortYearCutoff = (typeof shortYearCutoff !== "string" ? shortYearCutoff :
			new Date().getFullYear() % 100 + parseInt(shortYearCutoff, 10));
		return {shortYearCutoff: shortYearCutoff,
			dayNamesShort: this._get(inst, "dayNamesShort"), dayNames: this._get(inst, "dayNames"),
			monthNamesShort: this._get(inst, "monthNamesShort"), monthNames: this._get(inst, "monthNames")};
	},

	/* Format the given date for display. */
	_formatDate: function(inst, day, month, year) {
		if (!day) {
			inst.currentDay = inst.selectedDay;
			inst.currentMonth = inst.selectedMonth;
			inst.currentYear = inst.selectedYear;
		}
		var date = (day ? (typeof day === "object" ? day :
			this._daylightSavingAdjust(new Date(year, month, day))) :
			this._daylightSavingAdjust(new Date(inst.currentYear, inst.currentMonth, inst.currentDay)));
		return this.formatDate(this._get(inst, "dateFormat"), date, this._getFormatConfig(inst));
	}
});

/*
 * Bind hover events for datepicker elements.
 * Done via delegate so the binding only occurs once in the lifetime of the parent div.
 * Global datepicker_instActive, set by _updateDatepicker allows the handlers to find their way back to the active picker.
 */
function datepicker_bindHover(dpDiv) {
	var selector = "button, .ui-datepicker-prev, .ui-datepicker-next, .ui-datepicker-calendar td a";
	return dpDiv.delegate(selector, "mouseout", function() {
			$(this).removeClass("ui-state-hover");
			if (this.className.indexOf("ui-datepicker-prev") !== -1) {
				$(this).removeClass("ui-datepicker-prev-hover");
			}
			if (this.className.indexOf("ui-datepicker-next") !== -1) {
				$(this).removeClass("ui-datepicker-next-hover");
			}
		})
		.delegate( selector, "mouseover", datepicker_handleMouseover );
}

function datepicker_handleMouseover() {
	if (!$.datepicker._isDisabledDatepicker( datepicker_instActive.inline? datepicker_instActive.dpDiv.parent()[0] : datepicker_instActive.input[0])) {
		$(this).parents(".ui-datepicker-calendar").find("a").removeClass("ui-state-hover");
		$(this).addClass("ui-state-hover");
		if (this.className.indexOf("ui-datepicker-prev") !== -1) {
			$(this).addClass("ui-datepicker-prev-hover");
		}
		if (this.className.indexOf("ui-datepicker-next") !== -1) {
			$(this).addClass("ui-datepicker-next-hover");
		}
	}
}

/* jQuery extend now ignores nulls! */
function datepicker_extendRemove(target, props) {
	$.extend(target, props);
	for (var name in props) {
		if (props[name] == null) {
			target[name] = props[name];
		}
	}
	return target;
}

/* Invoke the datepicker functionality.
   @param  options  string - a command, optionally followed by additional parameters or
					Object - settings for attaching new datepicker functionality
   @return  jQuery object */
$.fn.datepicker = function(options){

	/* Verify an empty collection wasn't passed - Fixes #6976 */
	if ( !this.length ) {
		return this;
	}

	/* Initialise the date picker. */
	if (!$.datepicker.initialized) {
		$(document).mousedown($.datepicker._checkExternalClick);
		$.datepicker.initialized = true;
	}

	/* Append datepicker main container to body if not exist. */
	if ($("#"+$.datepicker._mainDivId).length === 0) {
		$("body").append($.datepicker.dpDiv);
	}

	var otherArgs = Array.prototype.slice.call(arguments, 1);
	if (typeof options === "string" && (options === "isDisabled" || options === "getDate" || options === "widget")) {
		return $.datepicker["_" + options + "Datepicker"].
			apply($.datepicker, [this[0]].concat(otherArgs));
	}
	if (options === "option" && arguments.length === 2 && typeof arguments[1] === "string") {
		return $.datepicker["_" + options + "Datepicker"].
			apply($.datepicker, [this[0]].concat(otherArgs));
	}
	return this.each(function() {
		typeof options === "string" ?
			$.datepicker["_" + options + "Datepicker"].
				apply($.datepicker, [this].concat(otherArgs)) :
			$.datepicker._attachDatepicker(this, options);
	});
};

$.datepicker = new Datepicker(); // singleton instance
$.datepicker.initialized = false;
$.datepicker.uuid = new Date().getTime();
$.datepicker.version = "1.11.4";

var datepicker = $.datepicker;


/*!
 * jQuery UI Draggable 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/draggable/
 */


$.widget("ui.draggable", $.ui.mouse, {
	version: "1.11.4",
	widgetEventPrefix: "drag",
	options: {
		addClasses: true,
		appendTo: "parent",
		axis: false,
		connectToSortable: false,
		containment: false,
		cursor: "auto",
		cursorAt: false,
		grid: false,
		handle: false,
		helper: "original",
		iframeFix: false,
		opacity: false,
		refreshPositions: false,
		revert: false,
		revertDuration: 500,
		scope: "default",
		scroll: true,
		scrollSensitivity: 20,
		scrollSpeed: 20,
		snap: false,
		snapMode: "both",
		snapTolerance: 20,
		stack: false,
		zIndex: false,

		// callbacks
		drag: null,
		start: null,
		stop: null
	},
	_create: function() {

		if ( this.options.helper === "original" ) {
			this._setPositionRelative();
		}
		if (this.options.addClasses){
			this.element.addClass("ui-draggable");
		}
		if (this.options.disabled){
			this.element.addClass("ui-draggable-disabled");
		}
		this._setHandleClassName();

		this._mouseInit();
	},

	_setOption: function( key, value ) {
		this._super( key, value );
		if ( key === "handle" ) {
			this._removeHandleClassName();
			this._setHandleClassName();
		}
	},

	_destroy: function() {
		if ( ( this.helper || this.element ).is( ".ui-draggable-dragging" ) ) {
			this.destroyOnClear = true;
			return;
		}
		this.element.removeClass( "ui-draggable ui-draggable-dragging ui-draggable-disabled" );
		this._removeHandleClassName();
		this._mouseDestroy();
	},

	_mouseCapture: function(event) {
		var o = this.options;

		this._blurActiveElement( event );

		// among others, prevent a drag on a resizable-handle
		if (this.helper || o.disabled || $(event.target).closest(".ui-resizable-handle").length > 0) {
			return false;
		}

		//Quit if we're not on a valid handle
		this.handle = this._getHandle(event);
		if (!this.handle) {
			return false;
		}

		this._blockFrames( o.iframeFix === true ? "iframe" : o.iframeFix );

		return true;

	},

	_blockFrames: function( selector ) {
		this.iframeBlocks = this.document.find( selector ).map(function() {
			var iframe = $( this );

			return $( "<div>" )
				.css( "position", "absolute" )
				.appendTo( iframe.parent() )
				.outerWidth( iframe.outerWidth() )
				.outerHeight( iframe.outerHeight() )
				.offset( iframe.offset() )[ 0 ];
		});
	},

	_unblockFrames: function() {
		if ( this.iframeBlocks ) {
			this.iframeBlocks.remove();
			delete this.iframeBlocks;
		}
	},

	_blurActiveElement: function( event ) {
		var document = this.document[ 0 ];

		// Only need to blur if the event occurred on the draggable itself, see #10527
		if ( !this.handleElement.is( event.target ) ) {
			return;
		}

		// support: IE9
		// IE9 throws an "Unspecified error" accessing document.activeElement from an <iframe>
		try {

			// Support: IE9, IE10
			// If the <body> is blurred, IE will switch windows, see #9520
			if ( document.activeElement && document.activeElement.nodeName.toLowerCase() !== "body" ) {

				// Blur any element that currently has focus, see #4261
				$( document.activeElement ).blur();
			}
		} catch ( error ) {}
	},

	_mouseStart: function(event) {

		var o = this.options;

		//Create and append the visible helper
		this.helper = this._createHelper(event);

		this.helper.addClass("ui-draggable-dragging");

		//Cache the helper size
		this._cacheHelperProportions();

		//If ddmanager is used for droppables, set the global draggable
		if ($.ui.ddmanager) {
			$.ui.ddmanager.current = this;
		}

		/*
		 * - Position generation -
		 * This block generates everything position related - it's the core of draggables.
		 */

		//Cache the margins of the original element
		this._cacheMargins();

		//Store the helper's css position
		this.cssPosition = this.helper.css( "position" );
		this.scrollParent = this.helper.scrollParent( true );
		this.offsetParent = this.helper.offsetParent();
		this.hasFixedAncestor = this.helper.parents().filter(function() {
				return $( this ).css( "position" ) === "fixed";
			}).length > 0;

		//The element's absolute position on the page minus margins
		this.positionAbs = this.element.offset();
		this._refreshOffsets( event );

		//Generate the original position
		this.originalPosition = this.position = this._generatePosition( event, false );
		this.originalPageX = event.pageX;
		this.originalPageY = event.pageY;

		//Adjust the mouse offset relative to the helper if "cursorAt" is supplied
		(o.cursorAt && this._adjustOffsetFromHelper(o.cursorAt));

		//Set a containment if given in the options
		this._setContainment();

		//Trigger event + callbacks
		if (this._trigger("start", event) === false) {
			this._clear();
			return false;
		}

		//Recache the helper size
		this._cacheHelperProportions();

		//Prepare the droppable offsets
		if ($.ui.ddmanager && !o.dropBehaviour) {
			$.ui.ddmanager.prepareOffsets(this, event);
		}

		// Reset helper's right/bottom css if they're set and set explicit width/height instead
		// as this prevents resizing of elements with right/bottom set (see #7772)
		this._normalizeRightBottom();

		this._mouseDrag(event, true); //Execute the drag once - this causes the helper not to be visible before getting its correct position

		//If the ddmanager is used for droppables, inform the manager that dragging has started (see #5003)
		if ( $.ui.ddmanager ) {
			$.ui.ddmanager.dragStart(this, event);
		}

		return true;
	},

	_refreshOffsets: function( event ) {
		this.offset = {
			top: this.positionAbs.top - this.margins.top,
			left: this.positionAbs.left - this.margins.left,
			scroll: false,
			parent: this._getParentOffset(),
			relative: this._getRelativeOffset()
		};

		this.offset.click = {
			left: event.pageX - this.offset.left,
			top: event.pageY - this.offset.top
		};
	},

	_mouseDrag: function(event, noPropagation) {
		// reset any necessary cached properties (see #5009)
		if ( this.hasFixedAncestor ) {
			this.offset.parent = this._getParentOffset();
		}

		//Compute the helpers position
		this.position = this._generatePosition( event, true );
		this.positionAbs = this._convertPositionTo("absolute");

		//Call plugins and callbacks and use the resulting position if something is returned
		if (!noPropagation) {
			var ui = this._uiHash();
			if (this._trigger("drag", event, ui) === false) {
				this._mouseUp({});
				return false;
			}
			this.position = ui.position;
		}

		this.helper[ 0 ].style.left = this.position.left + "px";
		this.helper[ 0 ].style.top = this.position.top + "px";

		if ($.ui.ddmanager) {
			$.ui.ddmanager.drag(this, event);
		}

		return false;
	},

	_mouseStop: function(event) {

		//If we are using droppables, inform the manager about the drop
		var that = this,
			dropped = false;
		if ($.ui.ddmanager && !this.options.dropBehaviour) {
			dropped = $.ui.ddmanager.drop(this, event);
		}

		//if a drop comes from outside (a sortable)
		if (this.dropped) {
			dropped = this.dropped;
			this.dropped = false;
		}

		if ((this.options.revert === "invalid" && !dropped) || (this.options.revert === "valid" && dropped) || this.options.revert === true || ($.isFunction(this.options.revert) && this.options.revert.call(this.element, dropped))) {
			$(this.helper).animate(this.originalPosition, parseInt(this.options.revertDuration, 10), function() {
				if (that._trigger("stop", event) !== false) {
					that._clear();
				}
			});
		} else {
			if (this._trigger("stop", event) !== false) {
				this._clear();
			}
		}

		return false;
	},

	_mouseUp: function( event ) {
		this._unblockFrames();

		//If the ddmanager is used for droppables, inform the manager that dragging has stopped (see #5003)
		if ( $.ui.ddmanager ) {
			$.ui.ddmanager.dragStop(this, event);
		}

		// Only need to focus if the event occurred on the draggable itself, see #10527
		if ( this.handleElement.is( event.target ) ) {
			// The interaction is over; whether or not the click resulted in a drag, focus the element
			this.element.focus();
		}

		return $.ui.mouse.prototype._mouseUp.call(this, event);
	},

	cancel: function() {

		if (this.helper.is(".ui-draggable-dragging")) {
			this._mouseUp({});
		} else {
			this._clear();
		}

		return this;

	},

	_getHandle: function(event) {
		return this.options.handle ?
			!!$( event.target ).closest( this.element.find( this.options.handle ) ).length :
			true;
	},

	_setHandleClassName: function() {
		this.handleElement = this.options.handle ?
			this.element.find( this.options.handle ) : this.element;
		this.handleElement.addClass( "ui-draggable-handle" );
	},

	_removeHandleClassName: function() {
		this.handleElement.removeClass( "ui-draggable-handle" );
	},

	_createHelper: function(event) {

		var o = this.options,
			helperIsFunction = $.isFunction( o.helper ),
			helper = helperIsFunction ?
				$( o.helper.apply( this.element[ 0 ], [ event ] ) ) :
				( o.helper === "clone" ?
					this.element.clone().removeAttr( "id" ) :
					this.element );

		if (!helper.parents("body").length) {
			helper.appendTo((o.appendTo === "parent" ? this.element[0].parentNode : o.appendTo));
		}

		// http://bugs.jqueryui.com/ticket/9446
		// a helper function can return the original element
		// which wouldn't have been set to relative in _create
		if ( helperIsFunction && helper[ 0 ] === this.element[ 0 ] ) {
			this._setPositionRelative();
		}

		if (helper[0] !== this.element[0] && !(/(fixed|absolute)/).test(helper.css("position"))) {
			helper.css("position", "absolute");
		}

		return helper;

	},

	_setPositionRelative: function() {
		if ( !( /^(?:r|a|f)/ ).test( this.element.css( "position" ) ) ) {
			this.element[ 0 ].style.position = "relative";
		}
	},

	_adjustOffsetFromHelper: function(obj) {
		if (typeof obj === "string") {
			obj = obj.split(" ");
		}
		if ($.isArray(obj)) {
			obj = { left: +obj[0], top: +obj[1] || 0 };
		}
		if ("left" in obj) {
			this.offset.click.left = obj.left + this.margins.left;
		}
		if ("right" in obj) {
			this.offset.click.left = this.helperProportions.width - obj.right + this.margins.left;
		}
		if ("top" in obj) {
			this.offset.click.top = obj.top + this.margins.top;
		}
		if ("bottom" in obj) {
			this.offset.click.top = this.helperProportions.height - obj.bottom + this.margins.top;
		}
	},

	_isRootNode: function( element ) {
		return ( /(html|body)/i ).test( element.tagName ) || element === this.document[ 0 ];
	},

	_getParentOffset: function() {

		//Get the offsetParent and cache its position
		var po = this.offsetParent.offset(),
			document = this.document[ 0 ];

		// This is a special case where we need to modify a offset calculated on start, since the following happened:
		// 1. The position of the helper is absolute, so it's position is calculated based on the next positioned parent
		// 2. The actual offset parent is a child of the scroll parent, and the scroll parent isn't the document, which means that
		//    the scroll is included in the initial calculation of the offset of the parent, and never recalculated upon drag
		if (this.cssPosition === "absolute" && this.scrollParent[0] !== document && $.contains(this.scrollParent[0], this.offsetParent[0])) {
			po.left += this.scrollParent.scrollLeft();
			po.top += this.scrollParent.scrollTop();
		}

		if ( this._isRootNode( this.offsetParent[ 0 ] ) ) {
			po = { top: 0, left: 0 };
		}

		return {
			top: po.top + (parseInt(this.offsetParent.css("borderTopWidth"), 10) || 0),
			left: po.left + (parseInt(this.offsetParent.css("borderLeftWidth"), 10) || 0)
		};

	},

	_getRelativeOffset: function() {
		if ( this.cssPosition !== "relative" ) {
			return { top: 0, left: 0 };
		}

		var p = this.element.position(),
			scrollIsRootNode = this._isRootNode( this.scrollParent[ 0 ] );

		return {
			top: p.top - ( parseInt(this.helper.css( "top" ), 10) || 0 ) + ( !scrollIsRootNode ? this.scrollParent.scrollTop() : 0 ),
			left: p.left - ( parseInt(this.helper.css( "left" ), 10) || 0 ) + ( !scrollIsRootNode ? this.scrollParent.scrollLeft() : 0 )
		};

	},

	_cacheMargins: function() {
		this.margins = {
			left: (parseInt(this.element.css("marginLeft"), 10) || 0),
			top: (parseInt(this.element.css("marginTop"), 10) || 0),
			right: (parseInt(this.element.css("marginRight"), 10) || 0),
			bottom: (parseInt(this.element.css("marginBottom"), 10) || 0)
		};
	},

	_cacheHelperProportions: function() {
		this.helperProportions = {
			width: this.helper.outerWidth(),
			height: this.helper.outerHeight()
		};
	},

	_setContainment: function() {

		var isUserScrollable, c, ce,
			o = this.options,
			document = this.document[ 0 ];

		this.relativeContainer = null;

		if ( !o.containment ) {
			this.containment = null;
			return;
		}

		if ( o.containment === "window" ) {
			this.containment = [
				$( window ).scrollLeft() - this.offset.relative.left - this.offset.parent.left,
				$( window ).scrollTop() - this.offset.relative.top - this.offset.parent.top,
				$( window ).scrollLeft() + $( window ).width() - this.helperProportions.width - this.margins.left,
				$( window ).scrollTop() + ( $( window ).height() || document.body.parentNode.scrollHeight ) - this.helperProportions.height - this.margins.top
			];
			return;
		}

		if ( o.containment === "document") {
			this.containment = [
				0,
				0,
				$( document ).width() - this.helperProportions.width - this.margins.left,
				( $( document ).height() || document.body.parentNode.scrollHeight ) - this.helperProportions.height - this.margins.top
			];
			return;
		}

		if ( o.containment.constructor === Array ) {
			this.containment = o.containment;
			return;
		}

		if ( o.containment === "parent" ) {
			o.containment = this.helper[ 0 ].parentNode;
		}

		c = $( o.containment );
		ce = c[ 0 ];

		if ( !ce ) {
			return;
		}

		isUserScrollable = /(scroll|auto)/.test( c.css( "overflow" ) );

		this.containment = [
			( parseInt( c.css( "borderLeftWidth" ), 10 ) || 0 ) + ( parseInt( c.css( "paddingLeft" ), 10 ) || 0 ),
			( parseInt( c.css( "borderTopWidth" ), 10 ) || 0 ) + ( parseInt( c.css( "paddingTop" ), 10 ) || 0 ),
			( isUserScrollable ? Math.max( ce.scrollWidth, ce.offsetWidth ) : ce.offsetWidth ) -
				( parseInt( c.css( "borderRightWidth" ), 10 ) || 0 ) -
				( parseInt( c.css( "paddingRight" ), 10 ) || 0 ) -
				this.helperProportions.width -
				this.margins.left -
				this.margins.right,
			( isUserScrollable ? Math.max( ce.scrollHeight, ce.offsetHeight ) : ce.offsetHeight ) -
				( parseInt( c.css( "borderBottomWidth" ), 10 ) || 0 ) -
				( parseInt( c.css( "paddingBottom" ), 10 ) || 0 ) -
				this.helperProportions.height -
				this.margins.top -
				this.margins.bottom
		];
		this.relativeContainer = c;
	},

	_convertPositionTo: function(d, pos) {

		if (!pos) {
			pos = this.position;
		}

		var mod = d === "absolute" ? 1 : -1,
			scrollIsRootNode = this._isRootNode( this.scrollParent[ 0 ] );

		return {
			top: (
				pos.top	+																// The absolute mouse position
				this.offset.relative.top * mod +										// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.top * mod -										// The offsetParent's offset without borders (offset + border)
				( ( this.cssPosition === "fixed" ? -this.offset.scroll.top : ( scrollIsRootNode ? 0 : this.offset.scroll.top ) ) * mod)
			),
			left: (
				pos.left +																// The absolute mouse position
				this.offset.relative.left * mod +										// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.left * mod	-										// The offsetParent's offset without borders (offset + border)
				( ( this.cssPosition === "fixed" ? -this.offset.scroll.left : ( scrollIsRootNode ? 0 : this.offset.scroll.left ) ) * mod)
			)
		};

	},

	_generatePosition: function( event, constrainPosition ) {

		var containment, co, top, left,
			o = this.options,
			scrollIsRootNode = this._isRootNode( this.scrollParent[ 0 ] ),
			pageX = event.pageX,
			pageY = event.pageY;

		// Cache the scroll
		if ( !scrollIsRootNode || !this.offset.scroll ) {
			this.offset.scroll = {
				top: this.scrollParent.scrollTop(),
				left: this.scrollParent.scrollLeft()
			};
		}

		/*
		 * - Position constraining -
		 * Constrain the position to a mix of grid, containment.
		 */

		// If we are not dragging yet, we won't check for options
		if ( constrainPosition ) {
			if ( this.containment ) {
				if ( this.relativeContainer ){
					co = this.relativeContainer.offset();
					containment = [
						this.containment[ 0 ] + co.left,
						this.containment[ 1 ] + co.top,
						this.containment[ 2 ] + co.left,
						this.containment[ 3 ] + co.top
					];
				} else {
					containment = this.containment;
				}

				if (event.pageX - this.offset.click.left < containment[0]) {
					pageX = containment[0] + this.offset.click.left;
				}
				if (event.pageY - this.offset.click.top < containment[1]) {
					pageY = containment[1] + this.offset.click.top;
				}
				if (event.pageX - this.offset.click.left > containment[2]) {
					pageX = containment[2] + this.offset.click.left;
				}
				if (event.pageY - this.offset.click.top > containment[3]) {
					pageY = containment[3] + this.offset.click.top;
				}
			}

			if (o.grid) {
				//Check for grid elements set to 0 to prevent divide by 0 error causing invalid argument errors in IE (see ticket #6950)
				top = o.grid[1] ? this.originalPageY + Math.round((pageY - this.originalPageY) / o.grid[1]) * o.grid[1] : this.originalPageY;
				pageY = containment ? ((top - this.offset.click.top >= containment[1] || top - this.offset.click.top > containment[3]) ? top : ((top - this.offset.click.top >= containment[1]) ? top - o.grid[1] : top + o.grid[1])) : top;

				left = o.grid[0] ? this.originalPageX + Math.round((pageX - this.originalPageX) / o.grid[0]) * o.grid[0] : this.originalPageX;
				pageX = containment ? ((left - this.offset.click.left >= containment[0] || left - this.offset.click.left > containment[2]) ? left : ((left - this.offset.click.left >= containment[0]) ? left - o.grid[0] : left + o.grid[0])) : left;
			}

			if ( o.axis === "y" ) {
				pageX = this.originalPageX;
			}

			if ( o.axis === "x" ) {
				pageY = this.originalPageY;
			}
		}

		return {
			top: (
				pageY -																	// The absolute mouse position
				this.offset.click.top	-												// Click offset (relative to the element)
				this.offset.relative.top -												// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.top +												// The offsetParent's offset without borders (offset + border)
				( this.cssPosition === "fixed" ? -this.offset.scroll.top : ( scrollIsRootNode ? 0 : this.offset.scroll.top ) )
			),
			left: (
				pageX -																	// The absolute mouse position
				this.offset.click.left -												// Click offset (relative to the element)
				this.offset.relative.left -												// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.left +												// The offsetParent's offset without borders (offset + border)
				( this.cssPosition === "fixed" ? -this.offset.scroll.left : ( scrollIsRootNode ? 0 : this.offset.scroll.left ) )
			)
		};

	},

	_clear: function() {
		this.helper.removeClass("ui-draggable-dragging");
		if (this.helper[0] !== this.element[0] && !this.cancelHelperRemoval) {
			this.helper.remove();
		}
		this.helper = null;
		this.cancelHelperRemoval = false;
		if ( this.destroyOnClear ) {
			this.destroy();
		}
	},

	_normalizeRightBottom: function() {
		if ( this.options.axis !== "y" && this.helper.css( "right" ) !== "auto" ) {
			this.helper.width( this.helper.width() );
			this.helper.css( "right", "auto" );
		}
		if ( this.options.axis !== "x" && this.helper.css( "bottom" ) !== "auto" ) {
			this.helper.height( this.helper.height() );
			this.helper.css( "bottom", "auto" );
		}
	},

	// From now on bulk stuff - mainly helpers

	_trigger: function( type, event, ui ) {
		ui = ui || this._uiHash();
		$.ui.plugin.call( this, type, [ event, ui, this ], true );

		// Absolute position and offset (see #6884 ) have to be recalculated after plugins
		if ( /^(drag|start|stop)/.test( type ) ) {
			this.positionAbs = this._convertPositionTo( "absolute" );
			ui.offset = this.positionAbs;
		}
		return $.Widget.prototype._trigger.call( this, type, event, ui );
	},

	plugins: {},

	_uiHash: function() {
		return {
			helper: this.helper,
			position: this.position,
			originalPosition: this.originalPosition,
			offset: this.positionAbs
		};
	}

});

$.ui.plugin.add( "draggable", "connectToSortable", {
	start: function( event, ui, draggable ) {
		var uiSortable = $.extend( {}, ui, {
			item: draggable.element
		});

		draggable.sortables = [];
		$( draggable.options.connectToSortable ).each(function() {
			var sortable = $( this ).sortable( "instance" );

			if ( sortable && !sortable.options.disabled ) {
				draggable.sortables.push( sortable );

				// refreshPositions is called at drag start to refresh the containerCache
				// which is used in drag. This ensures it's initialized and synchronized
				// with any changes that might have happened on the page since initialization.
				sortable.refreshPositions();
				sortable._trigger("activate", event, uiSortable);
			}
		});
	},
	stop: function( event, ui, draggable ) {
		var uiSortable = $.extend( {}, ui, {
			item: draggable.element
		});

		draggable.cancelHelperRemoval = false;

		$.each( draggable.sortables, function() {
			var sortable = this;

			if ( sortable.isOver ) {
				sortable.isOver = 0;

				// Allow this sortable to handle removing the helper
				draggable.cancelHelperRemoval = true;
				sortable.cancelHelperRemoval = false;

				// Use _storedCSS To restore properties in the sortable,
				// as this also handles revert (#9675) since the draggable
				// may have modified them in unexpected ways (#8809)
				sortable._storedCSS = {
					position: sortable.placeholder.css( "position" ),
					top: sortable.placeholder.css( "top" ),
					left: sortable.placeholder.css( "left" )
				};

				sortable._mouseStop(event);

				// Once drag has ended, the sortable should return to using
				// its original helper, not the shared helper from draggable
				sortable.options.helper = sortable.options._helper;
			} else {
				// Prevent this Sortable from removing the helper.
				// However, don't set the draggable to remove the helper
				// either as another connected Sortable may yet handle the removal.
				sortable.cancelHelperRemoval = true;

				sortable._trigger( "deactivate", event, uiSortable );
			}
		});
	},
	drag: function( event, ui, draggable ) {
		$.each( draggable.sortables, function() {
			var innermostIntersecting = false,
				sortable = this;

			// Copy over variables that sortable's _intersectsWith uses
			sortable.positionAbs = draggable.positionAbs;
			sortable.helperProportions = draggable.helperProportions;
			sortable.offset.click = draggable.offset.click;

			if ( sortable._intersectsWith( sortable.containerCache ) ) {
				innermostIntersecting = true;

				$.each( draggable.sortables, function() {
					// Copy over variables that sortable's _intersectsWith uses
					this.positionAbs = draggable.positionAbs;
					this.helperProportions = draggable.helperProportions;
					this.offset.click = draggable.offset.click;

					if ( this !== sortable &&
							this._intersectsWith( this.containerCache ) &&
							$.contains( sortable.element[ 0 ], this.element[ 0 ] ) ) {
						innermostIntersecting = false;
					}

					return innermostIntersecting;
				});
			}

			if ( innermostIntersecting ) {
				// If it intersects, we use a little isOver variable and set it once,
				// so that the move-in stuff gets fired only once.
				if ( !sortable.isOver ) {
					sortable.isOver = 1;

					// Store draggable's parent in case we need to reappend to it later.
					draggable._parent = ui.helper.parent();

					sortable.currentItem = ui.helper
						.appendTo( sortable.element )
						.data( "ui-sortable-item", true );

					// Store helper option to later restore it
					sortable.options._helper = sortable.options.helper;

					sortable.options.helper = function() {
						return ui.helper[ 0 ];
					};

					// Fire the start events of the sortable with our passed browser event,
					// and our own helper (so it doesn't create a new one)
					event.target = sortable.currentItem[ 0 ];
					sortable._mouseCapture( event, true );
					sortable._mouseStart( event, true, true );

					// Because the browser event is way off the new appended portlet,
					// modify necessary variables to reflect the changes
					sortable.offset.click.top = draggable.offset.click.top;
					sortable.offset.click.left = draggable.offset.click.left;
					sortable.offset.parent.left -= draggable.offset.parent.left -
						sortable.offset.parent.left;
					sortable.offset.parent.top -= draggable.offset.parent.top -
						sortable.offset.parent.top;

					draggable._trigger( "toSortable", event );

					// Inform draggable that the helper is in a valid drop zone,
					// used solely in the revert option to handle "valid/invalid".
					draggable.dropped = sortable.element;

					// Need to refreshPositions of all sortables in the case that
					// adding to one sortable changes the location of the other sortables (#9675)
					$.each( draggable.sortables, function() {
						this.refreshPositions();
					});

					// hack so receive/update callbacks work (mostly)
					draggable.currentItem = draggable.element;
					sortable.fromOutside = draggable;
				}

				if ( sortable.currentItem ) {
					sortable._mouseDrag( event );
					// Copy the sortable's position because the draggable's can potentially reflect
					// a relative position, while sortable is always absolute, which the dragged
					// element has now become. (#8809)
					ui.position = sortable.position;
				}
			} else {
				// If it doesn't intersect with the sortable, and it intersected before,
				// we fake the drag stop of the sortable, but make sure it doesn't remove
				// the helper by using cancelHelperRemoval.
				if ( sortable.isOver ) {

					sortable.isOver = 0;
					sortable.cancelHelperRemoval = true;

					// Calling sortable's mouseStop would trigger a revert,
					// so revert must be temporarily false until after mouseStop is called.
					sortable.options._revert = sortable.options.revert;
					sortable.options.revert = false;

					sortable._trigger( "out", event, sortable._uiHash( sortable ) );
					sortable._mouseStop( event, true );

					// restore sortable behaviors that were modfied
					// when the draggable entered the sortable area (#9481)
					sortable.options.revert = sortable.options._revert;
					sortable.options.helper = sortable.options._helper;

					if ( sortable.placeholder ) {
						sortable.placeholder.remove();
					}

					// Restore and recalculate the draggable's offset considering the sortable
					// may have modified them in unexpected ways. (#8809, #10669)
					ui.helper.appendTo( draggable._parent );
					draggable._refreshOffsets( event );
					ui.position = draggable._generatePosition( event, true );

					draggable._trigger( "fromSortable", event );

					// Inform draggable that the helper is no longer in a valid drop zone
					draggable.dropped = false;

					// Need to refreshPositions of all sortables just in case removing
					// from one sortable changes the location of other sortables (#9675)
					$.each( draggable.sortables, function() {
						this.refreshPositions();
					});
				}
			}
		});
	}
});

$.ui.plugin.add("draggable", "cursor", {
	start: function( event, ui, instance ) {
		var t = $( "body" ),
			o = instance.options;

		if (t.css("cursor")) {
			o._cursor = t.css("cursor");
		}
		t.css("cursor", o.cursor);
	},
	stop: function( event, ui, instance ) {
		var o = instance.options;
		if (o._cursor) {
			$("body").css("cursor", o._cursor);
		}
	}
});

$.ui.plugin.add("draggable", "opacity", {
	start: function( event, ui, instance ) {
		var t = $( ui.helper ),
			o = instance.options;
		if (t.css("opacity")) {
			o._opacity = t.css("opacity");
		}
		t.css("opacity", o.opacity);
	},
	stop: function( event, ui, instance ) {
		var o = instance.options;
		if (o._opacity) {
			$(ui.helper).css("opacity", o._opacity);
		}
	}
});

$.ui.plugin.add("draggable", "scroll", {
	start: function( event, ui, i ) {
		if ( !i.scrollParentNotHidden ) {
			i.scrollParentNotHidden = i.helper.scrollParent( false );
		}

		if ( i.scrollParentNotHidden[ 0 ] !== i.document[ 0 ] && i.scrollParentNotHidden[ 0 ].tagName !== "HTML" ) {
			i.overflowOffset = i.scrollParentNotHidden.offset();
		}
	},
	drag: function( event, ui, i  ) {

		var o = i.options,
			scrolled = false,
			scrollParent = i.scrollParentNotHidden[ 0 ],
			document = i.document[ 0 ];

		if ( scrollParent !== document && scrollParent.tagName !== "HTML" ) {
			if ( !o.axis || o.axis !== "x" ) {
				if ( ( i.overflowOffset.top + scrollParent.offsetHeight ) - event.pageY < o.scrollSensitivity ) {
					scrollParent.scrollTop = scrolled = scrollParent.scrollTop + o.scrollSpeed;
				} else if ( event.pageY - i.overflowOffset.top < o.scrollSensitivity ) {
					scrollParent.scrollTop = scrolled = scrollParent.scrollTop - o.scrollSpeed;
				}
			}

			if ( !o.axis || o.axis !== "y" ) {
				if ( ( i.overflowOffset.left + scrollParent.offsetWidth ) - event.pageX < o.scrollSensitivity ) {
					scrollParent.scrollLeft = scrolled = scrollParent.scrollLeft + o.scrollSpeed;
				} else if ( event.pageX - i.overflowOffset.left < o.scrollSensitivity ) {
					scrollParent.scrollLeft = scrolled = scrollParent.scrollLeft - o.scrollSpeed;
				}
			}

		} else {

			if (!o.axis || o.axis !== "x") {
				if (event.pageY - $(document).scrollTop() < o.scrollSensitivity) {
					scrolled = $(document).scrollTop($(document).scrollTop() - o.scrollSpeed);
				} else if ($(window).height() - (event.pageY - $(document).scrollTop()) < o.scrollSensitivity) {
					scrolled = $(document).scrollTop($(document).scrollTop() + o.scrollSpeed);
				}
			}

			if (!o.axis || o.axis !== "y") {
				if (event.pageX - $(document).scrollLeft() < o.scrollSensitivity) {
					scrolled = $(document).scrollLeft($(document).scrollLeft() - o.scrollSpeed);
				} else if ($(window).width() - (event.pageX - $(document).scrollLeft()) < o.scrollSensitivity) {
					scrolled = $(document).scrollLeft($(document).scrollLeft() + o.scrollSpeed);
				}
			}

		}

		if (scrolled !== false && $.ui.ddmanager && !o.dropBehaviour) {
			$.ui.ddmanager.prepareOffsets(i, event);
		}

	}
});

$.ui.plugin.add("draggable", "snap", {
	start: function( event, ui, i ) {

		var o = i.options;

		i.snapElements = [];

		$(o.snap.constructor !== String ? ( o.snap.items || ":data(ui-draggable)" ) : o.snap).each(function() {
			var $t = $(this),
				$o = $t.offset();
			if (this !== i.element[0]) {
				i.snapElements.push({
					item: this,
					width: $t.outerWidth(), height: $t.outerHeight(),
					top: $o.top, left: $o.left
				});
			}
		});

	},
	drag: function( event, ui, inst ) {

		var ts, bs, ls, rs, l, r, t, b, i, first,
			o = inst.options,
			d = o.snapTolerance,
			x1 = ui.offset.left, x2 = x1 + inst.helperProportions.width,
			y1 = ui.offset.top, y2 = y1 + inst.helperProportions.height;

		for (i = inst.snapElements.length - 1; i >= 0; i--){

			l = inst.snapElements[i].left - inst.margins.left;
			r = l + inst.snapElements[i].width;
			t = inst.snapElements[i].top - inst.margins.top;
			b = t + inst.snapElements[i].height;

			if ( x2 < l - d || x1 > r + d || y2 < t - d || y1 > b + d || !$.contains( inst.snapElements[ i ].item.ownerDocument, inst.snapElements[ i ].item ) ) {
				if (inst.snapElements[i].snapping) {
					(inst.options.snap.release && inst.options.snap.release.call(inst.element, event, $.extend(inst._uiHash(), { snapItem: inst.snapElements[i].item })));
				}
				inst.snapElements[i].snapping = false;
				continue;
			}

			if (o.snapMode !== "inner") {
				ts = Math.abs(t - y2) <= d;
				bs = Math.abs(b - y1) <= d;
				ls = Math.abs(l - x2) <= d;
				rs = Math.abs(r - x1) <= d;
				if (ts) {
					ui.position.top = inst._convertPositionTo("relative", { top: t - inst.helperProportions.height, left: 0 }).top;
				}
				if (bs) {
					ui.position.top = inst._convertPositionTo("relative", { top: b, left: 0 }).top;
				}
				if (ls) {
					ui.position.left = inst._convertPositionTo("relative", { top: 0, left: l - inst.helperProportions.width }).left;
				}
				if (rs) {
					ui.position.left = inst._convertPositionTo("relative", { top: 0, left: r }).left;
				}
			}

			first = (ts || bs || ls || rs);

			if (o.snapMode !== "outer") {
				ts = Math.abs(t - y1) <= d;
				bs = Math.abs(b - y2) <= d;
				ls = Math.abs(l - x1) <= d;
				rs = Math.abs(r - x2) <= d;
				if (ts) {
					ui.position.top = inst._convertPositionTo("relative", { top: t, left: 0 }).top;
				}
				if (bs) {
					ui.position.top = inst._convertPositionTo("relative", { top: b - inst.helperProportions.height, left: 0 }).top;
				}
				if (ls) {
					ui.position.left = inst._convertPositionTo("relative", { top: 0, left: l }).left;
				}
				if (rs) {
					ui.position.left = inst._convertPositionTo("relative", { top: 0, left: r - inst.helperProportions.width }).left;
				}
			}

			if (!inst.snapElements[i].snapping && (ts || bs || ls || rs || first)) {
				(inst.options.snap.snap && inst.options.snap.snap.call(inst.element, event, $.extend(inst._uiHash(), { snapItem: inst.snapElements[i].item })));
			}
			inst.snapElements[i].snapping = (ts || bs || ls || rs || first);

		}

	}
});

$.ui.plugin.add("draggable", "stack", {
	start: function( event, ui, instance ) {
		var min,
			o = instance.options,
			group = $.makeArray($(o.stack)).sort(function(a, b) {
				return (parseInt($(a).css("zIndex"), 10) || 0) - (parseInt($(b).css("zIndex"), 10) || 0);
			});

		if (!group.length) { return; }

		min = parseInt($(group[0]).css("zIndex"), 10) || 0;
		$(group).each(function(i) {
			$(this).css("zIndex", min + i);
		});
		this.css("zIndex", (min + group.length));
	}
});

$.ui.plugin.add("draggable", "zIndex", {
	start: function( event, ui, instance ) {
		var t = $( ui.helper ),
			o = instance.options;

		if (t.css("zIndex")) {
			o._zIndex = t.css("zIndex");
		}
		t.css("zIndex", o.zIndex);
	},
	stop: function( event, ui, instance ) {
		var o = instance.options;

		if (o._zIndex) {
			$(ui.helper).css("zIndex", o._zIndex);
		}
	}
});

var draggable = $.ui.draggable;


/*!
 * jQuery UI Resizable 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/resizable/
 */


$.widget("ui.resizable", $.ui.mouse, {
	version: "1.11.4",
	widgetEventPrefix: "resize",
	options: {
		alsoResize: false,
		animate: false,
		animateDuration: "slow",
		animateEasing: "swing",
		aspectRatio: false,
		autoHide: false,
		containment: false,
		ghost: false,
		grid: false,
		handles: "e,s,se",
		helper: false,
		maxHeight: null,
		maxWidth: null,
		minHeight: 10,
		minWidth: 10,
		// See #7960
		zIndex: 90,

		// callbacks
		resize: null,
		start: null,
		stop: null
	},

	_num: function( value ) {
		return parseInt( value, 10 ) || 0;
	},

	_isNumber: function( value ) {
		return !isNaN( parseInt( value, 10 ) );
	},

	_hasScroll: function( el, a ) {

		if ( $( el ).css( "overflow" ) === "hidden") {
			return false;
		}

		var scroll = ( a && a === "left" ) ? "scrollLeft" : "scrollTop",
			has = false;

		if ( el[ scroll ] > 0 ) {
			return true;
		}

		// TODO: determine which cases actually cause this to happen
		// if the element doesn't have the scroll set, see if it's possible to
		// set the scroll
		el[ scroll ] = 1;
		has = ( el[ scroll ] > 0 );
		el[ scroll ] = 0;
		return has;
	},

	_create: function() {

		var n, i, handle, axis, hname,
			that = this,
			o = this.options;
		this.element.addClass("ui-resizable");

		$.extend(this, {
			_aspectRatio: !!(o.aspectRatio),
			aspectRatio: o.aspectRatio,
			originalElement: this.element,
			_proportionallyResizeElements: [],
			_helper: o.helper || o.ghost || o.animate ? o.helper || "ui-resizable-helper" : null
		});

		// Wrap the element if it cannot hold child nodes
		if (this.element[0].nodeName.match(/^(canvas|textarea|input|select|button|img)$/i)) {

			this.element.wrap(
				$("<div class='ui-wrapper' style='overflow: hidden;'></div>").css({
					position: this.element.css("position"),
					width: this.element.outerWidth(),
					height: this.element.outerHeight(),
					top: this.element.css("top"),
					left: this.element.css("left")
				})
			);

			this.element = this.element.parent().data(
				"ui-resizable", this.element.resizable( "instance" )
			);

			this.elementIsWrapper = true;

			this.element.css({
				marginLeft: this.originalElement.css("marginLeft"),
				marginTop: this.originalElement.css("marginTop"),
				marginRight: this.originalElement.css("marginRight"),
				marginBottom: this.originalElement.css("marginBottom")
			});
			this.originalElement.css({
				marginLeft: 0,
				marginTop: 0,
				marginRight: 0,
				marginBottom: 0
			});
			// support: Safari
			// Prevent Safari textarea resize
			this.originalResizeStyle = this.originalElement.css("resize");
			this.originalElement.css("resize", "none");

			this._proportionallyResizeElements.push( this.originalElement.css({
				position: "static",
				zoom: 1,
				display: "block"
			}) );

			// support: IE9
			// avoid IE jump (hard set the margin)
			this.originalElement.css({ margin: this.originalElement.css("margin") });

			this._proportionallyResize();
		}

		this.handles = o.handles ||
			( !$(".ui-resizable-handle", this.element).length ?
				"e,s,se" : {
					n: ".ui-resizable-n",
					e: ".ui-resizable-e",
					s: ".ui-resizable-s",
					w: ".ui-resizable-w",
					se: ".ui-resizable-se",
					sw: ".ui-resizable-sw",
					ne: ".ui-resizable-ne",
					nw: ".ui-resizable-nw"
				} );

		this._handles = $();
		if ( this.handles.constructor === String ) {

			if ( this.handles === "all") {
				this.handles = "n,e,s,w,se,sw,ne,nw";
			}

			n = this.handles.split(",");
			this.handles = {};

			for (i = 0; i < n.length; i++) {

				handle = $.trim(n[i]);
				hname = "ui-resizable-" + handle;
				axis = $("<div class='ui-resizable-handle " + hname + "'></div>");

				axis.css({ zIndex: o.zIndex });

				// TODO : What's going on here?
				if ("se" === handle) {
					axis.addClass("ui-icon ui-icon-gripsmall-diagonal-se");
				}

				this.handles[handle] = ".ui-resizable-" + handle;
				this.element.append(axis);
			}

		}

		this._renderAxis = function(target) {

			var i, axis, padPos, padWrapper;

			target = target || this.element;

			for (i in this.handles) {

				if (this.handles[i].constructor === String) {
					this.handles[i] = this.element.children( this.handles[ i ] ).first().show();
				} else if ( this.handles[ i ].jquery || this.handles[ i ].nodeType ) {
					this.handles[ i ] = $( this.handles[ i ] );
					this._on( this.handles[ i ], { "mousedown": that._mouseDown });
				}

				if (this.elementIsWrapper && this.originalElement[0].nodeName.match(/^(textarea|input|select|button)$/i)) {

					axis = $(this.handles[i], this.element);

					padWrapper = /sw|ne|nw|se|n|s/.test(i) ? axis.outerHeight() : axis.outerWidth();

					padPos = [ "padding",
						/ne|nw|n/.test(i) ? "Top" :
						/se|sw|s/.test(i) ? "Bottom" :
						/^e$/.test(i) ? "Right" : "Left" ].join("");

					target.css(padPos, padWrapper);

					this._proportionallyResize();
				}

				this._handles = this._handles.add( this.handles[ i ] );
			}
		};

		// TODO: make renderAxis a prototype function
		this._renderAxis(this.element);

		this._handles = this._handles.add( this.element.find( ".ui-resizable-handle" ) );
		this._handles.disableSelection();

		this._handles.mouseover(function() {
			if (!that.resizing) {
				if (this.className) {
					axis = this.className.match(/ui-resizable-(se|sw|ne|nw|n|e|s|w)/i);
				}
				that.axis = axis && axis[1] ? axis[1] : "se";
			}
		});

		if (o.autoHide) {
			this._handles.hide();
			$(this.element)
				.addClass("ui-resizable-autohide")
				.mouseenter(function() {
					if (o.disabled) {
						return;
					}
					$(this).removeClass("ui-resizable-autohide");
					that._handles.show();
				})
				.mouseleave(function() {
					if (o.disabled) {
						return;
					}
					if (!that.resizing) {
						$(this).addClass("ui-resizable-autohide");
						that._handles.hide();
					}
				});
		}

		this._mouseInit();
	},

	_destroy: function() {

		this._mouseDestroy();

		var wrapper,
			_destroy = function(exp) {
				$(exp)
					.removeClass("ui-resizable ui-resizable-disabled ui-resizable-resizing")
					.removeData("resizable")
					.removeData("ui-resizable")
					.unbind(".resizable")
					.find(".ui-resizable-handle")
						.remove();
			};

		// TODO: Unwrap at same DOM position
		if (this.elementIsWrapper) {
			_destroy(this.element);
			wrapper = this.element;
			this.originalElement.css({
				position: wrapper.css("position"),
				width: wrapper.outerWidth(),
				height: wrapper.outerHeight(),
				top: wrapper.css("top"),
				left: wrapper.css("left")
			}).insertAfter( wrapper );
			wrapper.remove();
		}

		this.originalElement.css("resize", this.originalResizeStyle);
		_destroy(this.originalElement);

		return this;
	},

	_mouseCapture: function(event) {
		var i, handle,
			capture = false;

		for (i in this.handles) {
			handle = $(this.handles[i])[0];
			if (handle === event.target || $.contains(handle, event.target)) {
				capture = true;
			}
		}

		return !this.options.disabled && capture;
	},

	_mouseStart: function(event) {

		var curleft, curtop, cursor,
			o = this.options,
			el = this.element;

		this.resizing = true;

		this._renderProxy();

		curleft = this._num(this.helper.css("left"));
		curtop = this._num(this.helper.css("top"));

		if (o.containment) {
			curleft += $(o.containment).scrollLeft() || 0;
			curtop += $(o.containment).scrollTop() || 0;
		}

		this.offset = this.helper.offset();
		this.position = { left: curleft, top: curtop };

		this.size = this._helper ? {
				width: this.helper.width(),
				height: this.helper.height()
			} : {
				width: el.width(),
				height: el.height()
			};

		this.originalSize = this._helper ? {
				width: el.outerWidth(),
				height: el.outerHeight()
			} : {
				width: el.width(),
				height: el.height()
			};

		this.sizeDiff = {
			width: el.outerWidth() - el.width(),
			height: el.outerHeight() - el.height()
		};

		this.originalPosition = { left: curleft, top: curtop };
		this.originalMousePosition = { left: event.pageX, top: event.pageY };

		this.aspectRatio = (typeof o.aspectRatio === "number") ?
			o.aspectRatio :
			((this.originalSize.width / this.originalSize.height) || 1);

		cursor = $(".ui-resizable-" + this.axis).css("cursor");
		$("body").css("cursor", cursor === "auto" ? this.axis + "-resize" : cursor);

		el.addClass("ui-resizable-resizing");
		this._propagate("start", event);
		return true;
	},

	_mouseDrag: function(event) {

		var data, props,
			smp = this.originalMousePosition,
			a = this.axis,
			dx = (event.pageX - smp.left) || 0,
			dy = (event.pageY - smp.top) || 0,
			trigger = this._change[a];

		this._updatePrevProperties();

		if (!trigger) {
			return false;
		}

		data = trigger.apply(this, [ event, dx, dy ]);

		this._updateVirtualBoundaries(event.shiftKey);
		if (this._aspectRatio || event.shiftKey) {
			data = this._updateRatio(data, event);
		}

		data = this._respectSize(data, event);

		this._updateCache(data);

		this._propagate("resize", event);

		props = this._applyChanges();

		if ( !this._helper && this._proportionallyResizeElements.length ) {
			this._proportionallyResize();
		}

		if ( !$.isEmptyObject( props ) ) {
			this._updatePrevProperties();
			this._trigger( "resize", event, this.ui() );
			this._applyChanges();
		}

		return false;
	},

	_mouseStop: function(event) {

		this.resizing = false;
		var pr, ista, soffseth, soffsetw, s, left, top,
			o = this.options, that = this;

		if (this._helper) {

			pr = this._proportionallyResizeElements;
			ista = pr.length && (/textarea/i).test(pr[0].nodeName);
			soffseth = ista && this._hasScroll(pr[0], "left") ? 0 : that.sizeDiff.height;
			soffsetw = ista ? 0 : that.sizeDiff.width;

			s = {
				width: (that.helper.width()  - soffsetw),
				height: (that.helper.height() - soffseth)
			};
			left = (parseInt(that.element.css("left"), 10) +
				(that.position.left - that.originalPosition.left)) || null;
			top = (parseInt(that.element.css("top"), 10) +
				(that.position.top - that.originalPosition.top)) || null;

			if (!o.animate) {
				this.element.css($.extend(s, { top: top, left: left }));
			}

			that.helper.height(that.size.height);
			that.helper.width(that.size.width);

			if (this._helper && !o.animate) {
				this._proportionallyResize();
			}
		}

		$("body").css("cursor", "auto");

		this.element.removeClass("ui-resizable-resizing");

		this._propagate("stop", event);

		if (this._helper) {
			this.helper.remove();
		}

		return false;

	},

	_updatePrevProperties: function() {
		this.prevPosition = {
			top: this.position.top,
			left: this.position.left
		};
		this.prevSize = {
			width: this.size.width,
			height: this.size.height
		};
	},

	_applyChanges: function() {
		var props = {};

		if ( this.position.top !== this.prevPosition.top ) {
			props.top = this.position.top + "px";
		}
		if ( this.position.left !== this.prevPosition.left ) {
			props.left = this.position.left + "px";
		}
		if ( this.size.width !== this.prevSize.width ) {
			props.width = this.size.width + "px";
		}
		if ( this.size.height !== this.prevSize.height ) {
			props.height = this.size.height + "px";
		}

		this.helper.css( props );

		return props;
	},

	_updateVirtualBoundaries: function(forceAspectRatio) {
		var pMinWidth, pMaxWidth, pMinHeight, pMaxHeight, b,
			o = this.options;

		b = {
			minWidth: this._isNumber(o.minWidth) ? o.minWidth : 0,
			maxWidth: this._isNumber(o.maxWidth) ? o.maxWidth : Infinity,
			minHeight: this._isNumber(o.minHeight) ? o.minHeight : 0,
			maxHeight: this._isNumber(o.maxHeight) ? o.maxHeight : Infinity
		};

		if (this._aspectRatio || forceAspectRatio) {
			pMinWidth = b.minHeight * this.aspectRatio;
			pMinHeight = b.minWidth / this.aspectRatio;
			pMaxWidth = b.maxHeight * this.aspectRatio;
			pMaxHeight = b.maxWidth / this.aspectRatio;

			if (pMinWidth > b.minWidth) {
				b.minWidth = pMinWidth;
			}
			if (pMinHeight > b.minHeight) {
				b.minHeight = pMinHeight;
			}
			if (pMaxWidth < b.maxWidth) {
				b.maxWidth = pMaxWidth;
			}
			if (pMaxHeight < b.maxHeight) {
				b.maxHeight = pMaxHeight;
			}
		}
		this._vBoundaries = b;
	},

	_updateCache: function(data) {
		this.offset = this.helper.offset();
		if (this._isNumber(data.left)) {
			this.position.left = data.left;
		}
		if (this._isNumber(data.top)) {
			this.position.top = data.top;
		}
		if (this._isNumber(data.height)) {
			this.size.height = data.height;
		}
		if (this._isNumber(data.width)) {
			this.size.width = data.width;
		}
	},

	_updateRatio: function( data ) {

		var cpos = this.position,
			csize = this.size,
			a = this.axis;

		if (this._isNumber(data.height)) {
			data.width = (data.height * this.aspectRatio);
		} else if (this._isNumber(data.width)) {
			data.height = (data.width / this.aspectRatio);
		}

		if (a === "sw") {
			data.left = cpos.left + (csize.width - data.width);
			data.top = null;
		}
		if (a === "nw") {
			data.top = cpos.top + (csize.height - data.height);
			data.left = cpos.left + (csize.width - data.width);
		}

		return data;
	},

	_respectSize: function( data ) {

		var o = this._vBoundaries,
			a = this.axis,
			ismaxw = this._isNumber(data.width) && o.maxWidth && (o.maxWidth < data.width),
			ismaxh = this._isNumber(data.height) && o.maxHeight && (o.maxHeight < data.height),
			isminw = this._isNumber(data.width) && o.minWidth && (o.minWidth > data.width),
			isminh = this._isNumber(data.height) && o.minHeight && (o.minHeight > data.height),
			dw = this.originalPosition.left + this.originalSize.width,
			dh = this.position.top + this.size.height,
			cw = /sw|nw|w/.test(a), ch = /nw|ne|n/.test(a);
		if (isminw) {
			data.width = o.minWidth;
		}
		if (isminh) {
			data.height = o.minHeight;
		}
		if (ismaxw) {
			data.width = o.maxWidth;
		}
		if (ismaxh) {
			data.height = o.maxHeight;
		}

		if (isminw && cw) {
			data.left = dw - o.minWidth;
		}
		if (ismaxw && cw) {
			data.left = dw - o.maxWidth;
		}
		if (isminh && ch) {
			data.top = dh - o.minHeight;
		}
		if (ismaxh && ch) {
			data.top = dh - o.maxHeight;
		}

		// Fixing jump error on top/left - bug #2330
		if (!data.width && !data.height && !data.left && data.top) {
			data.top = null;
		} else if (!data.width && !data.height && !data.top && data.left) {
			data.left = null;
		}

		return data;
	},

	_getPaddingPlusBorderDimensions: function( element ) {
		var i = 0,
			widths = [],
			borders = [
				element.css( "borderTopWidth" ),
				element.css( "borderRightWidth" ),
				element.css( "borderBottomWidth" ),
				element.css( "borderLeftWidth" )
			],
			paddings = [
				element.css( "paddingTop" ),
				element.css( "paddingRight" ),
				element.css( "paddingBottom" ),
				element.css( "paddingLeft" )
			];

		for ( ; i < 4; i++ ) {
			widths[ i ] = ( parseInt( borders[ i ], 10 ) || 0 );
			widths[ i ] += ( parseInt( paddings[ i ], 10 ) || 0 );
		}

		return {
			height: widths[ 0 ] + widths[ 2 ],
			width: widths[ 1 ] + widths[ 3 ]
		};
	},

	_proportionallyResize: function() {

		if (!this._proportionallyResizeElements.length) {
			return;
		}

		var prel,
			i = 0,
			element = this.helper || this.element;

		for ( ; i < this._proportionallyResizeElements.length; i++) {

			prel = this._proportionallyResizeElements[i];

			// TODO: Seems like a bug to cache this.outerDimensions
			// considering that we are in a loop.
			if (!this.outerDimensions) {
				this.outerDimensions = this._getPaddingPlusBorderDimensions( prel );
			}

			prel.css({
				height: (element.height() - this.outerDimensions.height) || 0,
				width: (element.width() - this.outerDimensions.width) || 0
			});

		}

	},

	_renderProxy: function() {

		var el = this.element, o = this.options;
		this.elementOffset = el.offset();

		if (this._helper) {

			this.helper = this.helper || $("<div style='overflow:hidden;'></div>");

			this.helper.addClass(this._helper).css({
				width: this.element.outerWidth() - 1,
				height: this.element.outerHeight() - 1,
				position: "absolute",
				left: this.elementOffset.left + "px",
				top: this.elementOffset.top + "px",
				zIndex: ++o.zIndex //TODO: Don't modify option
			});

			this.helper
				.appendTo("body")
				.disableSelection();

		} else {
			this.helper = this.element;
		}

	},

	_change: {
		e: function(event, dx) {
			return { width: this.originalSize.width + dx };
		},
		w: function(event, dx) {
			var cs = this.originalSize, sp = this.originalPosition;
			return { left: sp.left + dx, width: cs.width - dx };
		},
		n: function(event, dx, dy) {
			var cs = this.originalSize, sp = this.originalPosition;
			return { top: sp.top + dy, height: cs.height - dy };
		},
		s: function(event, dx, dy) {
			return { height: this.originalSize.height + dy };
		},
		se: function(event, dx, dy) {
			return $.extend(this._change.s.apply(this, arguments),
				this._change.e.apply(this, [ event, dx, dy ]));
		},
		sw: function(event, dx, dy) {
			return $.extend(this._change.s.apply(this, arguments),
				this._change.w.apply(this, [ event, dx, dy ]));
		},
		ne: function(event, dx, dy) {
			return $.extend(this._change.n.apply(this, arguments),
				this._change.e.apply(this, [ event, dx, dy ]));
		},
		nw: function(event, dx, dy) {
			return $.extend(this._change.n.apply(this, arguments),
				this._change.w.apply(this, [ event, dx, dy ]));
		}
	},

	_propagate: function(n, event) {
		$.ui.plugin.call(this, n, [ event, this.ui() ]);
		(n !== "resize" && this._trigger(n, event, this.ui()));
	},

	plugins: {},

	ui: function() {
		return {
			originalElement: this.originalElement,
			element: this.element,
			helper: this.helper,
			position: this.position,
			size: this.size,
			originalSize: this.originalSize,
			originalPosition: this.originalPosition
		};
	}

});

/*
 * Resizable Extensions
 */

$.ui.plugin.add("resizable", "animate", {

	stop: function( event ) {
		var that = $(this).resizable( "instance" ),
			o = that.options,
			pr = that._proportionallyResizeElements,
			ista = pr.length && (/textarea/i).test(pr[0].nodeName),
			soffseth = ista && that._hasScroll(pr[0], "left") ? 0 : that.sizeDiff.height,
			soffsetw = ista ? 0 : that.sizeDiff.width,
			style = { width: (that.size.width - soffsetw), height: (that.size.height - soffseth) },
			left = (parseInt(that.element.css("left"), 10) +
				(that.position.left - that.originalPosition.left)) || null,
			top = (parseInt(that.element.css("top"), 10) +
				(that.position.top - that.originalPosition.top)) || null;

		that.element.animate(
			$.extend(style, top && left ? { top: top, left: left } : {}), {
				duration: o.animateDuration,
				easing: o.animateEasing,
				step: function() {

					var data = {
						width: parseInt(that.element.css("width"), 10),
						height: parseInt(that.element.css("height"), 10),
						top: parseInt(that.element.css("top"), 10),
						left: parseInt(that.element.css("left"), 10)
					};

					if (pr && pr.length) {
						$(pr[0]).css({ width: data.width, height: data.height });
					}

					// propagating resize, and updating values for each animation step
					that._updateCache(data);
					that._propagate("resize", event);

				}
			}
		);
	}

});

$.ui.plugin.add( "resizable", "containment", {

	start: function() {
		var element, p, co, ch, cw, width, height,
			that = $( this ).resizable( "instance" ),
			o = that.options,
			el = that.element,
			oc = o.containment,
			ce = ( oc instanceof $ ) ? oc.get( 0 ) : ( /parent/.test( oc ) ) ? el.parent().get( 0 ) : oc;

		if ( !ce ) {
			return;
		}

		that.containerElement = $( ce );

		if ( /document/.test( oc ) || oc === document ) {
			that.containerOffset = {
				left: 0,
				top: 0
			};
			that.containerPosition = {
				left: 0,
				top: 0
			};

			that.parentData = {
				element: $( document ),
				left: 0,
				top: 0,
				width: $( document ).width(),
				height: $( document ).height() || document.body.parentNode.scrollHeight
			};
		} else {
			element = $( ce );
			p = [];
			$([ "Top", "Right", "Left", "Bottom" ]).each(function( i, name ) {
				p[ i ] = that._num( element.css( "padding" + name ) );
			});

			that.containerOffset = element.offset();
			that.containerPosition = element.position();
			that.containerSize = {
				height: ( element.innerHeight() - p[ 3 ] ),
				width: ( element.innerWidth() - p[ 1 ] )
			};

			co = that.containerOffset;
			ch = that.containerSize.height;
			cw = that.containerSize.width;
			width = ( that._hasScroll ( ce, "left" ) ? ce.scrollWidth : cw );
			height = ( that._hasScroll ( ce ) ? ce.scrollHeight : ch ) ;

			that.parentData = {
				element: ce,
				left: co.left,
				top: co.top,
				width: width,
				height: height
			};
		}
	},

	resize: function( event ) {
		var woset, hoset, isParent, isOffsetRelative,
			that = $( this ).resizable( "instance" ),
			o = that.options,
			co = that.containerOffset,
			cp = that.position,
			pRatio = that._aspectRatio || event.shiftKey,
			cop = {
				top: 0,
				left: 0
			},
			ce = that.containerElement,
			continueResize = true;

		if ( ce[ 0 ] !== document && ( /static/ ).test( ce.css( "position" ) ) ) {
			cop = co;
		}

		if ( cp.left < ( that._helper ? co.left : 0 ) ) {
			that.size.width = that.size.width +
				( that._helper ?
					( that.position.left - co.left ) :
					( that.position.left - cop.left ) );

			if ( pRatio ) {
				that.size.height = that.size.width / that.aspectRatio;
				continueResize = false;
			}
			that.position.left = o.helper ? co.left : 0;
		}

		if ( cp.top < ( that._helper ? co.top : 0 ) ) {
			that.size.height = that.size.height +
				( that._helper ?
					( that.position.top - co.top ) :
					that.position.top );

			if ( pRatio ) {
				that.size.width = that.size.height * that.aspectRatio;
				continueResize = false;
			}
			that.position.top = that._helper ? co.top : 0;
		}

		isParent = that.containerElement.get( 0 ) === that.element.parent().get( 0 );
		isOffsetRelative = /relative|absolute/.test( that.containerElement.css( "position" ) );

		if ( isParent && isOffsetRelative ) {
			that.offset.left = that.parentData.left + that.position.left;
			that.offset.top = that.parentData.top + that.position.top;
		} else {
			that.offset.left = that.element.offset().left;
			that.offset.top = that.element.offset().top;
		}

		woset = Math.abs( that.sizeDiff.width +
			(that._helper ?
				that.offset.left - cop.left :
				(that.offset.left - co.left)) );

		hoset = Math.abs( that.sizeDiff.height +
			(that._helper ?
				that.offset.top - cop.top :
				(that.offset.top - co.top)) );

		if ( woset + that.size.width >= that.parentData.width ) {
			that.size.width = that.parentData.width - woset;
			if ( pRatio ) {
				that.size.height = that.size.width / that.aspectRatio;
				continueResize = false;
			}
		}

		if ( hoset + that.size.height >= that.parentData.height ) {
			that.size.height = that.parentData.height - hoset;
			if ( pRatio ) {
				that.size.width = that.size.height * that.aspectRatio;
				continueResize = false;
			}
		}

		if ( !continueResize ) {
			that.position.left = that.prevPosition.left;
			that.position.top = that.prevPosition.top;
			that.size.width = that.prevSize.width;
			that.size.height = that.prevSize.height;
		}
	},

	stop: function() {
		var that = $( this ).resizable( "instance" ),
			o = that.options,
			co = that.containerOffset,
			cop = that.containerPosition,
			ce = that.containerElement,
			helper = $( that.helper ),
			ho = helper.offset(),
			w = helper.outerWidth() - that.sizeDiff.width,
			h = helper.outerHeight() - that.sizeDiff.height;

		if ( that._helper && !o.animate && ( /relative/ ).test( ce.css( "position" ) ) ) {
			$( this ).css({
				left: ho.left - cop.left - co.left,
				width: w,
				height: h
			});
		}

		if ( that._helper && !o.animate && ( /static/ ).test( ce.css( "position" ) ) ) {
			$( this ).css({
				left: ho.left - cop.left - co.left,
				width: w,
				height: h
			});
		}
	}
});

$.ui.plugin.add("resizable", "alsoResize", {

	start: function() {
		var that = $(this).resizable( "instance" ),
			o = that.options;

		$(o.alsoResize).each(function() {
			var el = $(this);
			el.data("ui-resizable-alsoresize", {
				width: parseInt(el.width(), 10), height: parseInt(el.height(), 10),
				left: parseInt(el.css("left"), 10), top: parseInt(el.css("top"), 10)
			});
		});
	},

	resize: function(event, ui) {
		var that = $(this).resizable( "instance" ),
			o = that.options,
			os = that.originalSize,
			op = that.originalPosition,
			delta = {
				height: (that.size.height - os.height) || 0,
				width: (that.size.width - os.width) || 0,
				top: (that.position.top - op.top) || 0,
				left: (that.position.left - op.left) || 0
			};

			$(o.alsoResize).each(function() {
				var el = $(this), start = $(this).data("ui-resizable-alsoresize"), style = {},
					css = el.parents(ui.originalElement[0]).length ?
							[ "width", "height" ] :
							[ "width", "height", "top", "left" ];

				$.each(css, function(i, prop) {
					var sum = (start[prop] || 0) + (delta[prop] || 0);
					if (sum && sum >= 0) {
						style[prop] = sum || null;
					}
				});

				el.css(style);
			});
	},

	stop: function() {
		$(this).removeData("resizable-alsoresize");
	}
});

$.ui.plugin.add("resizable", "ghost", {

	start: function() {

		var that = $(this).resizable( "instance" ), o = that.options, cs = that.size;

		that.ghost = that.originalElement.clone();
		that.ghost
			.css({
				opacity: 0.25,
				display: "block",
				position: "relative",
				height: cs.height,
				width: cs.width,
				margin: 0,
				left: 0,
				top: 0
			})
			.addClass("ui-resizable-ghost")
			.addClass(typeof o.ghost === "string" ? o.ghost : "");

		that.ghost.appendTo(that.helper);

	},

	resize: function() {
		var that = $(this).resizable( "instance" );
		if (that.ghost) {
			that.ghost.css({
				position: "relative",
				height: that.size.height,
				width: that.size.width
			});
		}
	},

	stop: function() {
		var that = $(this).resizable( "instance" );
		if (that.ghost && that.helper) {
			that.helper.get(0).removeChild(that.ghost.get(0));
		}
	}

});

$.ui.plugin.add("resizable", "grid", {

	resize: function() {
		var outerDimensions,
			that = $(this).resizable( "instance" ),
			o = that.options,
			cs = that.size,
			os = that.originalSize,
			op = that.originalPosition,
			a = that.axis,
			grid = typeof o.grid === "number" ? [ o.grid, o.grid ] : o.grid,
			gridX = (grid[0] || 1),
			gridY = (grid[1] || 1),
			ox = Math.round((cs.width - os.width) / gridX) * gridX,
			oy = Math.round((cs.height - os.height) / gridY) * gridY,
			newWidth = os.width + ox,
			newHeight = os.height + oy,
			isMaxWidth = o.maxWidth && (o.maxWidth < newWidth),
			isMaxHeight = o.maxHeight && (o.maxHeight < newHeight),
			isMinWidth = o.minWidth && (o.minWidth > newWidth),
			isMinHeight = o.minHeight && (o.minHeight > newHeight);

		o.grid = grid;

		if (isMinWidth) {
			newWidth += gridX;
		}
		if (isMinHeight) {
			newHeight += gridY;
		}
		if (isMaxWidth) {
			newWidth -= gridX;
		}
		if (isMaxHeight) {
			newHeight -= gridY;
		}

		if (/^(se|s|e)$/.test(a)) {
			that.size.width = newWidth;
			that.size.height = newHeight;
		} else if (/^(ne)$/.test(a)) {
			that.size.width = newWidth;
			that.size.height = newHeight;
			that.position.top = op.top - oy;
		} else if (/^(sw)$/.test(a)) {
			that.size.width = newWidth;
			that.size.height = newHeight;
			that.position.left = op.left - ox;
		} else {
			if ( newHeight - gridY <= 0 || newWidth - gridX <= 0) {
				outerDimensions = that._getPaddingPlusBorderDimensions( this );
			}

			if ( newHeight - gridY > 0 ) {
				that.size.height = newHeight;
				that.position.top = op.top - oy;
			} else {
				newHeight = gridY - outerDimensions.height;
				that.size.height = newHeight;
				that.position.top = op.top + os.height - newHeight;
			}
			if ( newWidth - gridX > 0 ) {
				that.size.width = newWidth;
				that.position.left = op.left - ox;
			} else {
				newWidth = gridX - outerDimensions.width;
				that.size.width = newWidth;
				that.position.left = op.left + os.width - newWidth;
			}
		}
	}

});

var resizable = $.ui.resizable;


/*!
 * jQuery UI Dialog 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/dialog/
 */


var dialog = $.widget( "ui.dialog", {
	version: "1.11.4",
	options: {
		appendTo: "body",
		autoOpen: true,
		buttons: [],
		closeOnEscape: true,
		closeText: "Close",
		dialogClass: "",
		draggable: true,
		hide: null,
		height: "auto",
		maxHeight: null,
		maxWidth: null,
		minHeight: 150,
		minWidth: 150,
		modal: false,
		position: {
			my: "center",
			at: "center",
			of: window,
			collision: "fit",
			// Ensure the titlebar is always visible
			using: function( pos ) {
				var topOffset = $( this ).css( pos ).offset().top;
				if ( topOffset < 0 ) {
					$( this ).css( "top", pos.top - topOffset );
				}
			}
		},
		resizable: true,
		show: null,
		title: null,
		width: 300,

		// callbacks
		beforeClose: null,
		close: null,
		drag: null,
		dragStart: null,
		dragStop: null,
		focus: null,
		open: null,
		resize: null,
		resizeStart: null,
		resizeStop: null
	},

	sizeRelatedOptions: {
		buttons: true,
		height: true,
		maxHeight: true,
		maxWidth: true,
		minHeight: true,
		minWidth: true,
		width: true
	},

	resizableRelatedOptions: {
		maxHeight: true,
		maxWidth: true,
		minHeight: true,
		minWidth: true
	},

	_create: function() {
		this.originalCss = {
			display: this.element[ 0 ].style.display,
			width: this.element[ 0 ].style.width,
			minHeight: this.element[ 0 ].style.minHeight,
			maxHeight: this.element[ 0 ].style.maxHeight,
			height: this.element[ 0 ].style.height
		};
		this.originalPosition = {
			parent: this.element.parent(),
			index: this.element.parent().children().index( this.element )
		};
		this.originalTitle = this.element.attr( "title" );
		this.options.title = this.options.title || this.originalTitle;

		this._createWrapper();

		this.element
			.show()
			.removeAttr( "title" )
			.addClass( "ui-dialog-content ui-widget-content" )
			.appendTo( this.uiDialog );

		this._createTitlebar();
		this._createButtonPane();

		if ( this.options.draggable && $.fn.draggable ) {
			this._makeDraggable();
		}
		if ( this.options.resizable && $.fn.resizable ) {
			this._makeResizable();
		}

		this._isOpen = false;

		this._trackFocus();
	},

	_init: function() {
		if ( this.options.autoOpen ) {
			this.open();
		}
	},

	_appendTo: function() {
		var element = this.options.appendTo;
		if ( element && (element.jquery || element.nodeType) ) {
			return $( element );
		}
		return this.document.find( element || "body" ).eq( 0 );
	},

	_destroy: function() {
		var next,
			originalPosition = this.originalPosition;

		this._untrackInstance();
		this._destroyOverlay();

		this.element
			.removeUniqueId()
			.removeClass( "ui-dialog-content ui-widget-content" )
			.css( this.originalCss )
			// Without detaching first, the following becomes really slow
			.detach();

		this.uiDialog.stop( true, true ).remove();

		if ( this.originalTitle ) {
			this.element.attr( "title", this.originalTitle );
		}

		next = originalPosition.parent.children().eq( originalPosition.index );
		// Don't try to place the dialog next to itself (#8613)
		if ( next.length && next[ 0 ] !== this.element[ 0 ] ) {
			next.before( this.element );
		} else {
			originalPosition.parent.append( this.element );
		}
	},

	widget: function() {
		return this.uiDialog;
	},

	disable: $.noop,
	enable: $.noop,

	close: function( event ) {
		var activeElement,
			that = this;

		if ( !this._isOpen || this._trigger( "beforeClose", event ) === false ) {
			return;
		}

		this._isOpen = false;
		this._focusedElement = null;
		this._destroyOverlay();
		this._untrackInstance();

		if ( !this.opener.filter( ":focusable" ).focus().length ) {

			// support: IE9
			// IE9 throws an "Unspecified error" accessing document.activeElement from an <iframe>
			try {
				activeElement = this.document[ 0 ].activeElement;

				// Support: IE9, IE10
				// If the <body> is blurred, IE will switch windows, see #4520
				if ( activeElement && activeElement.nodeName.toLowerCase() !== "body" ) {

					// Hiding a focused element doesn't trigger blur in WebKit
					// so in case we have nothing to focus on, explicitly blur the active element
					// https://bugs.webkit.org/show_bug.cgi?id=47182
					$( activeElement ).blur();
				}
			} catch ( error ) {}
		}

		this._hide( this.uiDialog, this.options.hide, function() {
			that._trigger( "close", event );
		});
	},

	isOpen: function() {
		return this._isOpen;
	},

	moveToTop: function() {
		this._moveToTop();
	},

	_moveToTop: function( event, silent ) {
		var moved = false,
			zIndices = this.uiDialog.siblings( ".ui-front:visible" ).map(function() {
				return +$( this ).css( "z-index" );
			}).get(),
			zIndexMax = Math.max.apply( null, zIndices );

		if ( zIndexMax >= +this.uiDialog.css( "z-index" ) ) {
			this.uiDialog.css( "z-index", zIndexMax + 1 );
			moved = true;
		}

		if ( moved && !silent ) {
			this._trigger( "focus", event );
		}
		return moved;
	},

	open: function() {
		var that = this;
		if ( this._isOpen ) {
			if ( this._moveToTop() ) {
				this._focusTabbable();
			}
			return;
		}

		this._isOpen = true;
		this.opener = $( this.document[ 0 ].activeElement );

		this._size();
		this._position();
		this._createOverlay();
		this._moveToTop( null, true );

		// Ensure the overlay is moved to the top with the dialog, but only when
		// opening. The overlay shouldn't move after the dialog is open so that
		// modeless dialogs opened after the modal dialog stack properly.
		if ( this.overlay ) {
			this.overlay.css( "z-index", this.uiDialog.css( "z-index" ) - 1 );
		}

		this._show( this.uiDialog, this.options.show, function() {
			that._focusTabbable();
			that._trigger( "focus" );
		});

		// Track the dialog immediately upon openening in case a focus event
		// somehow occurs outside of the dialog before an element inside the
		// dialog is focused (#10152)
		this._makeFocusTarget();

		this._trigger( "open" );
	},

	_focusTabbable: function() {
		// Set focus to the first match:
		// 1. An element that was focused previously
		// 2. First element inside the dialog matching [autofocus]
		// 3. Tabbable element inside the content element
		// 4. Tabbable element inside the buttonpane
		// 5. The close button
		// 6. The dialog itself
		var hasFocus = this._focusedElement;
		if ( !hasFocus ) {
			hasFocus = this.element.find( "[autofocus]" );
		}
		if ( !hasFocus.length ) {
			hasFocus = this.element.find( ":tabbable" );
		}
		if ( !hasFocus.length ) {
			hasFocus = this.uiDialogButtonPane.find( ":tabbable" );
		}
		if ( !hasFocus.length ) {
			hasFocus = this.uiDialogTitlebarClose.filter( ":tabbable" );
		}
		if ( !hasFocus.length ) {
			hasFocus = this.uiDialog;
		}
		hasFocus.eq( 0 ).focus();
	},

	_keepFocus: function( event ) {
		function checkFocus() {
			var activeElement = this.document[0].activeElement,
				isActive = this.uiDialog[0] === activeElement ||
					$.contains( this.uiDialog[0], activeElement );
			if ( !isActive ) {
				this._focusTabbable();
			}
		}
		event.preventDefault();
		checkFocus.call( this );
		// support: IE
		// IE <= 8 doesn't prevent moving focus even with event.preventDefault()
		// so we check again later
		this._delay( checkFocus );
	},

	_createWrapper: function() {
		this.uiDialog = $("<div>")
			.addClass( "ui-dialog ui-widget ui-widget-content ui-corner-all ui-front " +
				this.options.dialogClass )
			.hide()
			.attr({
				// Setting tabIndex makes the div focusable
				tabIndex: -1,
				role: "dialog"
			})
			.appendTo( this._appendTo() );

		this._on( this.uiDialog, {
			keydown: function( event ) {
				if ( this.options.closeOnEscape && !event.isDefaultPrevented() && event.keyCode &&
						event.keyCode === $.ui.keyCode.ESCAPE ) {
					event.preventDefault();
					this.close( event );
					return;
				}

				// prevent tabbing out of dialogs
				if ( event.keyCode !== $.ui.keyCode.TAB || event.isDefaultPrevented() ) {
					return;
				}
				var tabbables = this.uiDialog.find( ":tabbable" ),
					first = tabbables.filter( ":first" ),
					last = tabbables.filter( ":last" );

				if ( ( event.target === last[0] || event.target === this.uiDialog[0] ) && !event.shiftKey ) {
					this._delay(function() {
						first.focus();
					});
					event.preventDefault();
				} else if ( ( event.target === first[0] || event.target === this.uiDialog[0] ) && event.shiftKey ) {
					this._delay(function() {
						last.focus();
					});
					event.preventDefault();
				}
			},
			mousedown: function( event ) {
				if ( this._moveToTop( event ) ) {
					this._focusTabbable();
				}
			}
		});

		// We assume that any existing aria-describedby attribute means
		// that the dialog content is marked up properly
		// otherwise we brute force the content as the description
		if ( !this.element.find( "[aria-describedby]" ).length ) {
			this.uiDialog.attr({
				"aria-describedby": this.element.uniqueId().attr( "id" )
			});
		}
	},

	_createTitlebar: function() {
		var uiDialogTitle;

		this.uiDialogTitlebar = $( "<div>" )
			.addClass( "ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix" )
			.prependTo( this.uiDialog );
		this._on( this.uiDialogTitlebar, {
			mousedown: function( event ) {
				// Don't prevent click on close button (#8838)
				// Focusing a dialog that is partially scrolled out of view
				// causes the browser to scroll it into view, preventing the click event
				if ( !$( event.target ).closest( ".ui-dialog-titlebar-close" ) ) {
					// Dialog isn't getting focus when dragging (#8063)
					this.uiDialog.focus();
				}
			}
		});

		// support: IE
		// Use type="button" to prevent enter keypresses in textboxes from closing the
		// dialog in IE (#9312)
		this.uiDialogTitlebarClose = $( "<button type='button'></button>" )
			.button({
				label: this.options.closeText,
				icons: {
					primary: "ui-icon-closethick"
				},
				text: false
			})
			.addClass( "ui-dialog-titlebar-close" )
			.appendTo( this.uiDialogTitlebar );
		this._on( this.uiDialogTitlebarClose, {
			click: function( event ) {
				event.preventDefault();
				this.close( event );
			}
		});

		uiDialogTitle = $( "<span>" )
			.uniqueId()
			.addClass( "ui-dialog-title" )
			.prependTo( this.uiDialogTitlebar );
		this._title( uiDialogTitle );

		this.uiDialog.attr({
			"aria-labelledby": uiDialogTitle.attr( "id" )
		});
	},

	_title: function( title ) {
		if ( !this.options.title ) {
			title.html( "&#160;" );
		}
		title.text( this.options.title );
	},

	_createButtonPane: function() {
		this.uiDialogButtonPane = $( "<div>" )
			.addClass( "ui-dialog-buttonpane ui-widget-content ui-helper-clearfix" );

		this.uiButtonSet = $( "<div>" )
			.addClass( "ui-dialog-buttonset" )
			.appendTo( this.uiDialogButtonPane );

		this._createButtons();
	},

	_createButtons: function() {
		var that = this,
			buttons = this.options.buttons;

		// if we already have a button pane, remove it
		this.uiDialogButtonPane.remove();
		this.uiButtonSet.empty();

		if ( $.isEmptyObject( buttons ) || ($.isArray( buttons ) && !buttons.length) ) {
			this.uiDialog.removeClass( "ui-dialog-buttons" );
			return;
		}

		$.each( buttons, function( name, props ) {
			var click, buttonOptions;
			props = $.isFunction( props ) ?
				{ click: props, text: name } :
				props;
			// Default to a non-submitting button
			props = $.extend( { type: "button" }, props );
			// Change the context for the click callback to be the main element
			click = props.click;
			props.click = function() {
				click.apply( that.element[ 0 ], arguments );
			};
			buttonOptions = {
				icons: props.icons,
				text: props.showText
			};
			delete props.icons;
			delete props.showText;
			$( "<button></button>", props )
				.button( buttonOptions )
				.appendTo( that.uiButtonSet );
		});
		this.uiDialog.addClass( "ui-dialog-buttons" );
		this.uiDialogButtonPane.appendTo( this.uiDialog );
	},

	_makeDraggable: function() {
		var that = this,
			options = this.options;

		function filteredUi( ui ) {
			return {
				position: ui.position,
				offset: ui.offset
			};
		}

		this.uiDialog.draggable({
			cancel: ".ui-dialog-content, .ui-dialog-titlebar-close",
			handle: ".ui-dialog-titlebar",
			containment: "document",
			start: function( event, ui ) {
				$( this ).addClass( "ui-dialog-dragging" );
				that._blockFrames();
				that._trigger( "dragStart", event, filteredUi( ui ) );
			},
			drag: function( event, ui ) {
				that._trigger( "drag", event, filteredUi( ui ) );
			},
			stop: function( event, ui ) {
				var left = ui.offset.left - that.document.scrollLeft(),
					top = ui.offset.top - that.document.scrollTop();

				options.position = {
					my: "left top",
					at: "left" + (left >= 0 ? "+" : "") + left + " " +
						"top" + (top >= 0 ? "+" : "") + top,
					of: that.window
				};
				$( this ).removeClass( "ui-dialog-dragging" );
				that._unblockFrames();
				that._trigger( "dragStop", event, filteredUi( ui ) );
			}
		});
	},

	_makeResizable: function() {
		var that = this,
			options = this.options,
			handles = options.resizable,
			// .ui-resizable has position: relative defined in the stylesheet
			// but dialogs have to use absolute or fixed positioning
			position = this.uiDialog.css("position"),
			resizeHandles = typeof handles === "string" ?
				handles	:
				"n,e,s,w,se,sw,ne,nw";

		function filteredUi( ui ) {
			return {
				originalPosition: ui.originalPosition,
				originalSize: ui.originalSize,
				position: ui.position,
				size: ui.size
			};
		}

		this.uiDialog.resizable({
			cancel: ".ui-dialog-content",
			containment: "document",
			alsoResize: this.element,
			maxWidth: options.maxWidth,
			maxHeight: options.maxHeight,
			minWidth: options.minWidth,
			minHeight: this._minHeight(),
			handles: resizeHandles,
			start: function( event, ui ) {
				$( this ).addClass( "ui-dialog-resizing" );
				that._blockFrames();
				that._trigger( "resizeStart", event, filteredUi( ui ) );
			},
			resize: function( event, ui ) {
				that._trigger( "resize", event, filteredUi( ui ) );
			},
			stop: function( event, ui ) {
				var offset = that.uiDialog.offset(),
					left = offset.left - that.document.scrollLeft(),
					top = offset.top - that.document.scrollTop();

				options.height = that.uiDialog.height();
				options.width = that.uiDialog.width();
				options.position = {
					my: "left top",
					at: "left" + (left >= 0 ? "+" : "") + left + " " +
						"top" + (top >= 0 ? "+" : "") + top,
					of: that.window
				};
				$( this ).removeClass( "ui-dialog-resizing" );
				that._unblockFrames();
				that._trigger( "resizeStop", event, filteredUi( ui ) );
			}
		})
		.css( "position", position );
	},

	_trackFocus: function() {
		this._on( this.widget(), {
			focusin: function( event ) {
				this._makeFocusTarget();
				this._focusedElement = $( event.target );
			}
		});
	},

	_makeFocusTarget: function() {
		this._untrackInstance();
		this._trackingInstances().unshift( this );
	},

	_untrackInstance: function() {
		var instances = this._trackingInstances(),
			exists = $.inArray( this, instances );
		if ( exists !== -1 ) {
			instances.splice( exists, 1 );
		}
	},

	_trackingInstances: function() {
		var instances = this.document.data( "ui-dialog-instances" );
		if ( !instances ) {
			instances = [];
			this.document.data( "ui-dialog-instances", instances );
		}
		return instances;
	},

	_minHeight: function() {
		var options = this.options;

		return options.height === "auto" ?
			options.minHeight :
			Math.min( options.minHeight, options.height );
	},

	_position: function() {
		// Need to show the dialog to get the actual offset in the position plugin
		var isVisible = this.uiDialog.is( ":visible" );
		if ( !isVisible ) {
			this.uiDialog.show();
		}
		this.uiDialog.position( this.options.position );
		if ( !isVisible ) {
			this.uiDialog.hide();
		}
	},

	_setOptions: function( options ) {
		var that = this,
			resize = false,
			resizableOptions = {};

		$.each( options, function( key, value ) {
			that._setOption( key, value );

			if ( key in that.sizeRelatedOptions ) {
				resize = true;
			}
			if ( key in that.resizableRelatedOptions ) {
				resizableOptions[ key ] = value;
			}
		});

		if ( resize ) {
			this._size();
			this._position();
		}
		if ( this.uiDialog.is( ":data(ui-resizable)" ) ) {
			this.uiDialog.resizable( "option", resizableOptions );
		}
	},

	_setOption: function( key, value ) {
		var isDraggable, isResizable,
			uiDialog = this.uiDialog;

		if ( key === "dialogClass" ) {
			uiDialog
				.removeClass( this.options.dialogClass )
				.addClass( value );
		}

		if ( key === "disabled" ) {
			return;
		}

		this._super( key, value );

		if ( key === "appendTo" ) {
			this.uiDialog.appendTo( this._appendTo() );
		}

		if ( key === "buttons" ) {
			this._createButtons();
		}

		if ( key === "closeText" ) {
			this.uiDialogTitlebarClose.button({
				// Ensure that we always pass a string
				label: "" + value
			});
		}

		if ( key === "draggable" ) {
			isDraggable = uiDialog.is( ":data(ui-draggable)" );
			if ( isDraggable && !value ) {
				uiDialog.draggable( "destroy" );
			}

			if ( !isDraggable && value ) {
				this._makeDraggable();
			}
		}

		if ( key === "position" ) {
			this._position();
		}

		if ( key === "resizable" ) {
			// currently resizable, becoming non-resizable
			isResizable = uiDialog.is( ":data(ui-resizable)" );
			if ( isResizable && !value ) {
				uiDialog.resizable( "destroy" );
			}

			// currently resizable, changing handles
			if ( isResizable && typeof value === "string" ) {
				uiDialog.resizable( "option", "handles", value );
			}

			// currently non-resizable, becoming resizable
			if ( !isResizable && value !== false ) {
				this._makeResizable();
			}
		}

		if ( key === "title" ) {
			this._title( this.uiDialogTitlebar.find( ".ui-dialog-title" ) );
		}
	},

	_size: function() {
		// If the user has resized the dialog, the .ui-dialog and .ui-dialog-content
		// divs will both have width and height set, so we need to reset them
		var nonContentHeight, minContentHeight, maxContentHeight,
			options = this.options;

		// Reset content sizing
		this.element.show().css({
			width: "auto",
			minHeight: 0,
			maxHeight: "none",
			height: 0
		});

		if ( options.minWidth > options.width ) {
			options.width = options.minWidth;
		}

		// reset wrapper sizing
		// determine the height of all the non-content elements
		nonContentHeight = this.uiDialog.css({
				height: "auto",
				width: options.width
			})
			.outerHeight();
		minContentHeight = Math.max( 0, options.minHeight - nonContentHeight );
		maxContentHeight = typeof options.maxHeight === "number" ?
			Math.max( 0, options.maxHeight - nonContentHeight ) :
			"none";

		if ( options.height === "auto" ) {
			this.element.css({
				minHeight: minContentHeight,
				maxHeight: maxContentHeight,
				height: "auto"
			});
		} else {
			this.element.height( Math.max( 0, options.height - nonContentHeight ) );
		}

		if ( this.uiDialog.is( ":data(ui-resizable)" ) ) {
			this.uiDialog.resizable( "option", "minHeight", this._minHeight() );
		}
	},

	_blockFrames: function() {
		this.iframeBlocks = this.document.find( "iframe" ).map(function() {
			var iframe = $( this );

			return $( "<div>" )
				.css({
					position: "absolute",
					width: iframe.outerWidth(),
					height: iframe.outerHeight()
				})
				.appendTo( iframe.parent() )
				.offset( iframe.offset() )[0];
		});
	},

	_unblockFrames: function() {
		if ( this.iframeBlocks ) {
			this.iframeBlocks.remove();
			delete this.iframeBlocks;
		}
	},

	_allowInteraction: function( event ) {
		if ( $( event.target ).closest( ".ui-dialog" ).length ) {
			return true;
		}

		// TODO: Remove hack when datepicker implements
		// the .ui-front logic (#8989)
		return !!$( event.target ).closest( ".ui-datepicker" ).length;
	},

	_createOverlay: function() {
		if ( !this.options.modal ) {
			return;
		}

		// We use a delay in case the overlay is created from an
		// event that we're going to be cancelling (#2804)
		var isOpening = true;
		this._delay(function() {
			isOpening = false;
		});

		if ( !this.document.data( "ui-dialog-overlays" ) ) {

			// Prevent use of anchors and inputs
			// Using _on() for an event handler shared across many instances is
			// safe because the dialogs stack and must be closed in reverse order
			this._on( this.document, {
				focusin: function( event ) {
					if ( isOpening ) {
						return;
					}

					if ( !this._allowInteraction( event ) ) {
						event.preventDefault();
						this._trackingInstances()[ 0 ]._focusTabbable();
					}
				}
			});
		}

		this.overlay = $( "<div>" )
			.addClass( "ui-widget-overlay ui-front" )
			.appendTo( this._appendTo() );
		this._on( this.overlay, {
			mousedown: "_keepFocus"
		});
		this.document.data( "ui-dialog-overlays",
			(this.document.data( "ui-dialog-overlays" ) || 0) + 1 );
	},

	_destroyOverlay: function() {
		if ( !this.options.modal ) {
			return;
		}

		if ( this.overlay ) {
			var overlays = this.document.data( "ui-dialog-overlays" ) - 1;

			if ( !overlays ) {
				this.document
					.unbind( "focusin" )
					.removeData( "ui-dialog-overlays" );
			} else {
				this.document.data( "ui-dialog-overlays", overlays );
			}

			this.overlay.remove();
			this.overlay = null;
		}
	}
});


/*!
 * jQuery UI Droppable 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/droppable/
 */


$.widget( "ui.droppable", {
	version: "1.11.4",
	widgetEventPrefix: "drop",
	options: {
		accept: "*",
		activeClass: false,
		addClasses: true,
		greedy: false,
		hoverClass: false,
		scope: "default",
		tolerance: "intersect",

		// callbacks
		activate: null,
		deactivate: null,
		drop: null,
		out: null,
		over: null
	},
	_create: function() {

		var proportions,
			o = this.options,
			accept = o.accept;

		this.isover = false;
		this.isout = true;

		this.accept = $.isFunction( accept ) ? accept : function( d ) {
			return d.is( accept );
		};

		this.proportions = function( /* valueToWrite */ ) {
			if ( arguments.length ) {
				// Store the droppable's proportions
				proportions = arguments[ 0 ];
			} else {
				// Retrieve or derive the droppable's proportions
				return proportions ?
					proportions :
					proportions = {
						width: this.element[ 0 ].offsetWidth,
						height: this.element[ 0 ].offsetHeight
					};
			}
		};

		this._addToManager( o.scope );

		o.addClasses && this.element.addClass( "ui-droppable" );

	},

	_addToManager: function( scope ) {
		// Add the reference and positions to the manager
		$.ui.ddmanager.droppables[ scope ] = $.ui.ddmanager.droppables[ scope ] || [];
		$.ui.ddmanager.droppables[ scope ].push( this );
	},

	_splice: function( drop ) {
		var i = 0;
		for ( ; i < drop.length; i++ ) {
			if ( drop[ i ] === this ) {
				drop.splice( i, 1 );
			}
		}
	},

	_destroy: function() {
		var drop = $.ui.ddmanager.droppables[ this.options.scope ];

		this._splice( drop );

		this.element.removeClass( "ui-droppable ui-droppable-disabled" );
	},

	_setOption: function( key, value ) {

		if ( key === "accept" ) {
			this.accept = $.isFunction( value ) ? value : function( d ) {
				return d.is( value );
			};
		} else if ( key === "scope" ) {
			var drop = $.ui.ddmanager.droppables[ this.options.scope ];

			this._splice( drop );
			this._addToManager( value );
		}

		this._super( key, value );
	},

	_activate: function( event ) {
		var draggable = $.ui.ddmanager.current;
		if ( this.options.activeClass ) {
			this.element.addClass( this.options.activeClass );
		}
		if ( draggable ){
			this._trigger( "activate", event, this.ui( draggable ) );
		}
	},

	_deactivate: function( event ) {
		var draggable = $.ui.ddmanager.current;
		if ( this.options.activeClass ) {
			this.element.removeClass( this.options.activeClass );
		}
		if ( draggable ){
			this._trigger( "deactivate", event, this.ui( draggable ) );
		}
	},

	_over: function( event ) {

		var draggable = $.ui.ddmanager.current;

		// Bail if draggable and droppable are same element
		if ( !draggable || ( draggable.currentItem || draggable.element )[ 0 ] === this.element[ 0 ] ) {
			return;
		}

		if ( this.accept.call( this.element[ 0 ], ( draggable.currentItem || draggable.element ) ) ) {
			if ( this.options.hoverClass ) {
				this.element.addClass( this.options.hoverClass );
			}
			this._trigger( "over", event, this.ui( draggable ) );
		}

	},

	_out: function( event ) {

		var draggable = $.ui.ddmanager.current;

		// Bail if draggable and droppable are same element
		if ( !draggable || ( draggable.currentItem || draggable.element )[ 0 ] === this.element[ 0 ] ) {
			return;
		}

		if ( this.accept.call( this.element[ 0 ], ( draggable.currentItem || draggable.element ) ) ) {
			if ( this.options.hoverClass ) {
				this.element.removeClass( this.options.hoverClass );
			}
			this._trigger( "out", event, this.ui( draggable ) );
		}

	},

	_drop: function( event, custom ) {

		var draggable = custom || $.ui.ddmanager.current,
			childrenIntersection = false;

		// Bail if draggable and droppable are same element
		if ( !draggable || ( draggable.currentItem || draggable.element )[ 0 ] === this.element[ 0 ] ) {
			return false;
		}

		this.element.find( ":data(ui-droppable)" ).not( ".ui-draggable-dragging" ).each(function() {
			var inst = $( this ).droppable( "instance" );
			if (
				inst.options.greedy &&
				!inst.options.disabled &&
				inst.options.scope === draggable.options.scope &&
				inst.accept.call( inst.element[ 0 ], ( draggable.currentItem || draggable.element ) ) &&
				$.ui.intersect( draggable, $.extend( inst, { offset: inst.element.offset() } ), inst.options.tolerance, event )
			) { childrenIntersection = true; return false; }
		});
		if ( childrenIntersection ) {
			return false;
		}

		if ( this.accept.call( this.element[ 0 ], ( draggable.currentItem || draggable.element ) ) ) {
			if ( this.options.activeClass ) {
				this.element.removeClass( this.options.activeClass );
			}
			if ( this.options.hoverClass ) {
				this.element.removeClass( this.options.hoverClass );
			}
			this._trigger( "drop", event, this.ui( draggable ) );
			return this.element;
		}

		return false;

	},

	ui: function( c ) {
		return {
			draggable: ( c.currentItem || c.element ),
			helper: c.helper,
			position: c.position,
			offset: c.positionAbs
		};
	}

});

$.ui.intersect = (function() {
	function isOverAxis( x, reference, size ) {
		return ( x >= reference ) && ( x < ( reference + size ) );
	}

	return function( draggable, droppable, toleranceMode, event ) {

		if ( !droppable.offset ) {
			return false;
		}

		var x1 = ( draggable.positionAbs || draggable.position.absolute ).left + draggable.margins.left,
			y1 = ( draggable.positionAbs || draggable.position.absolute ).top + draggable.margins.top,
			x2 = x1 + draggable.helperProportions.width,
			y2 = y1 + draggable.helperProportions.height,
			l = droppable.offset.left,
			t = droppable.offset.top,
			r = l + droppable.proportions().width,
			b = t + droppable.proportions().height;

		switch ( toleranceMode ) {
		case "fit":
			return ( l <= x1 && x2 <= r && t <= y1 && y2 <= b );
		case "intersect":
			return ( l < x1 + ( draggable.helperProportions.width / 2 ) && // Right Half
				x2 - ( draggable.helperProportions.width / 2 ) < r && // Left Half
				t < y1 + ( draggable.helperProportions.height / 2 ) && // Bottom Half
				y2 - ( draggable.helperProportions.height / 2 ) < b ); // Top Half
		case "pointer":
			return isOverAxis( event.pageY, t, droppable.proportions().height ) && isOverAxis( event.pageX, l, droppable.proportions().width );
		case "touch":
			return (
				( y1 >= t && y1 <= b ) || // Top edge touching
				( y2 >= t && y2 <= b ) || // Bottom edge touching
				( y1 < t && y2 > b ) // Surrounded vertically
			) && (
				( x1 >= l && x1 <= r ) || // Left edge touching
				( x2 >= l && x2 <= r ) || // Right edge touching
				( x1 < l && x2 > r ) // Surrounded horizontally
			);
		default:
			return false;
		}
	};
})();

/*
	This manager tracks offsets of draggables and droppables
*/
$.ui.ddmanager = {
	current: null,
	droppables: { "default": [] },
	prepareOffsets: function( t, event ) {

		var i, j,
			m = $.ui.ddmanager.droppables[ t.options.scope ] || [],
			type = event ? event.type : null, // workaround for #2317
			list = ( t.currentItem || t.element ).find( ":data(ui-droppable)" ).addBack();

		droppablesLoop: for ( i = 0; i < m.length; i++ ) {

			// No disabled and non-accepted
			if ( m[ i ].options.disabled || ( t && !m[ i ].accept.call( m[ i ].element[ 0 ], ( t.currentItem || t.element ) ) ) ) {
				continue;
			}

			// Filter out elements in the current dragged item
			for ( j = 0; j < list.length; j++ ) {
				if ( list[ j ] === m[ i ].element[ 0 ] ) {
					m[ i ].proportions().height = 0;
					continue droppablesLoop;
				}
			}

			m[ i ].visible = m[ i ].element.css( "display" ) !== "none";
			if ( !m[ i ].visible ) {
				continue;
			}

			// Activate the droppable if used directly from draggables
			if ( type === "mousedown" ) {
				m[ i ]._activate.call( m[ i ], event );
			}

			m[ i ].offset = m[ i ].element.offset();
			m[ i ].proportions({ width: m[ i ].element[ 0 ].offsetWidth, height: m[ i ].element[ 0 ].offsetHeight });

		}

	},
	drop: function( draggable, event ) {

		var dropped = false;
		// Create a copy of the droppables in case the list changes during the drop (#9116)
		$.each( ( $.ui.ddmanager.droppables[ draggable.options.scope ] || [] ).slice(), function() {

			if ( !this.options ) {
				return;
			}
			if ( !this.options.disabled && this.visible && $.ui.intersect( draggable, this, this.options.tolerance, event ) ) {
				dropped = this._drop.call( this, event ) || dropped;
			}

			if ( !this.options.disabled && this.visible && this.accept.call( this.element[ 0 ], ( draggable.currentItem || draggable.element ) ) ) {
				this.isout = true;
				this.isover = false;
				this._deactivate.call( this, event );
			}

		});
		return dropped;

	},
	dragStart: function( draggable, event ) {
		// Listen for scrolling so that if the dragging causes scrolling the position of the droppables can be recalculated (see #5003)
		draggable.element.parentsUntil( "body" ).bind( "scroll.droppable", function() {
			if ( !draggable.options.refreshPositions ) {
				$.ui.ddmanager.prepareOffsets( draggable, event );
			}
		});
	},
	drag: function( draggable, event ) {

		// If you have a highly dynamic page, you might try this option. It renders positions every time you move the mouse.
		if ( draggable.options.refreshPositions ) {
			$.ui.ddmanager.prepareOffsets( draggable, event );
		}

		// Run through all droppables and check their positions based on specific tolerance options
		$.each( $.ui.ddmanager.droppables[ draggable.options.scope ] || [], function() {

			if ( this.options.disabled || this.greedyChild || !this.visible ) {
				return;
			}

			var parentInstance, scope, parent,
				intersects = $.ui.intersect( draggable, this, this.options.tolerance, event ),
				c = !intersects && this.isover ? "isout" : ( intersects && !this.isover ? "isover" : null );
			if ( !c ) {
				return;
			}

			if ( this.options.greedy ) {
				// find droppable parents with same scope
				scope = this.options.scope;
				parent = this.element.parents( ":data(ui-droppable)" ).filter(function() {
					return $( this ).droppable( "instance" ).options.scope === scope;
				});

				if ( parent.length ) {
					parentInstance = $( parent[ 0 ] ).droppable( "instance" );
					parentInstance.greedyChild = ( c === "isover" );
				}
			}

			// we just moved into a greedy child
			if ( parentInstance && c === "isover" ) {
				parentInstance.isover = false;
				parentInstance.isout = true;
				parentInstance._out.call( parentInstance, event );
			}

			this[ c ] = true;
			this[c === "isout" ? "isover" : "isout"] = false;
			this[c === "isover" ? "_over" : "_out"].call( this, event );

			// we just moved out of a greedy child
			if ( parentInstance && c === "isout" ) {
				parentInstance.isout = false;
				parentInstance.isover = true;
				parentInstance._over.call( parentInstance, event );
			}
		});

	},
	dragStop: function( draggable, event ) {
		draggable.element.parentsUntil( "body" ).unbind( "scroll.droppable" );
		// Call prepareOffsets one final time since IE does not fire return scroll events when overflow was caused by drag (see #5003)
		if ( !draggable.options.refreshPositions ) {
			$.ui.ddmanager.prepareOffsets( draggable, event );
		}
	}
};

var droppable = $.ui.droppable;


/*!
 * jQuery UI Effects 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/category/effects-core/
 */


var dataSpace = "ui-effects-",

	// Create a local jQuery because jQuery Color relies on it and the
	// global may not exist with AMD and a custom build (#10199)
	jQuery = $;

$.effects = {
	effect: {}
};

/*!
 * jQuery Color Animations v2.1.2
 * https://github.com/jquery/jquery-color
 *
 * Copyright 2014 jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * Date: Wed Jan 16 08:47:09 2013 -0600
 */
(function( jQuery, undefined ) {

	var stepHooks = "backgroundColor borderBottomColor borderLeftColor borderRightColor borderTopColor color columnRuleColor outlineColor textDecorationColor textEmphasisColor",

	// plusequals test for += 100 -= 100
	rplusequals = /^([\-+])=\s*(\d+\.?\d*)/,
	// a set of RE's that can match strings and generate color tuples.
	stringParsers = [ {
			re: /rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,
			parse: function( execResult ) {
				return [
					execResult[ 1 ],
					execResult[ 2 ],
					execResult[ 3 ],
					execResult[ 4 ]
				];
			}
		}, {
			re: /rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,
			parse: function( execResult ) {
				return [
					execResult[ 1 ] * 2.55,
					execResult[ 2 ] * 2.55,
					execResult[ 3 ] * 2.55,
					execResult[ 4 ]
				];
			}
		}, {
			// this regex ignores A-F because it's compared against an already lowercased string
			re: /#([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})/,
			parse: function( execResult ) {
				return [
					parseInt( execResult[ 1 ], 16 ),
					parseInt( execResult[ 2 ], 16 ),
					parseInt( execResult[ 3 ], 16 )
				];
			}
		}, {
			// this regex ignores A-F because it's compared against an already lowercased string
			re: /#([a-f0-9])([a-f0-9])([a-f0-9])/,
			parse: function( execResult ) {
				return [
					parseInt( execResult[ 1 ] + execResult[ 1 ], 16 ),
					parseInt( execResult[ 2 ] + execResult[ 2 ], 16 ),
					parseInt( execResult[ 3 ] + execResult[ 3 ], 16 )
				];
			}
		}, {
			re: /hsla?\(\s*(\d+(?:\.\d+)?)\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,
			space: "hsla",
			parse: function( execResult ) {
				return [
					execResult[ 1 ],
					execResult[ 2 ] / 100,
					execResult[ 3 ] / 100,
					execResult[ 4 ]
				];
			}
		} ],

	// jQuery.Color( )
	color = jQuery.Color = function( color, green, blue, alpha ) {
		return new jQuery.Color.fn.parse( color, green, blue, alpha );
	},
	spaces = {
		rgba: {
			props: {
				red: {
					idx: 0,
					type: "byte"
				},
				green: {
					idx: 1,
					type: "byte"
				},
				blue: {
					idx: 2,
					type: "byte"
				}
			}
		},

		hsla: {
			props: {
				hue: {
					idx: 0,
					type: "degrees"
				},
				saturation: {
					idx: 1,
					type: "percent"
				},
				lightness: {
					idx: 2,
					type: "percent"
				}
			}
		}
	},
	propTypes = {
		"byte": {
			floor: true,
			max: 255
		},
		"percent": {
			max: 1
		},
		"degrees": {
			mod: 360,
			floor: true
		}
	},
	support = color.support = {},

	// element for support tests
	supportElem = jQuery( "<p>" )[ 0 ],

	// colors = jQuery.Color.names
	colors,

	// local aliases of functions called often
	each = jQuery.each;

// determine rgba support immediately
supportElem.style.cssText = "background-color:rgba(1,1,1,.5)";
support.rgba = supportElem.style.backgroundColor.indexOf( "rgba" ) > -1;

// define cache name and alpha properties
// for rgba and hsla spaces
each( spaces, function( spaceName, space ) {
	space.cache = "_" + spaceName;
	space.props.alpha = {
		idx: 3,
		type: "percent",
		def: 1
	};
});

function clamp( value, prop, allowEmpty ) {
	var type = propTypes[ prop.type ] || {};

	if ( value == null ) {
		return (allowEmpty || !prop.def) ? null : prop.def;
	}

	// ~~ is an short way of doing floor for positive numbers
	value = type.floor ? ~~value : parseFloat( value );

	// IE will pass in empty strings as value for alpha,
	// which will hit this case
	if ( isNaN( value ) ) {
		return prop.def;
	}

	if ( type.mod ) {
		// we add mod before modding to make sure that negatives values
		// get converted properly: -10 -> 350
		return (value + type.mod) % type.mod;
	}

	// for now all property types without mod have min and max
	return 0 > value ? 0 : type.max < value ? type.max : value;
}

function stringParse( string ) {
	var inst = color(),
		rgba = inst._rgba = [];

	string = string.toLowerCase();

	each( stringParsers, function( i, parser ) {
		var parsed,
			match = parser.re.exec( string ),
			values = match && parser.parse( match ),
			spaceName = parser.space || "rgba";

		if ( values ) {
			parsed = inst[ spaceName ]( values );

			// if this was an rgba parse the assignment might happen twice
			// oh well....
			inst[ spaces[ spaceName ].cache ] = parsed[ spaces[ spaceName ].cache ];
			rgba = inst._rgba = parsed._rgba;

			// exit each( stringParsers ) here because we matched
			return false;
		}
	});

	// Found a stringParser that handled it
	if ( rgba.length ) {

		// if this came from a parsed string, force "transparent" when alpha is 0
		// chrome, (and maybe others) return "transparent" as rgba(0,0,0,0)
		if ( rgba.join() === "0,0,0,0" ) {
			jQuery.extend( rgba, colors.transparent );
		}
		return inst;
	}

	// named colors
	return colors[ string ];
}

color.fn = jQuery.extend( color.prototype, {
	parse: function( red, green, blue, alpha ) {
		if ( red === undefined ) {
			this._rgba = [ null, null, null, null ];
			return this;
		}
		if ( red.jquery || red.nodeType ) {
			red = jQuery( red ).css( green );
			green = undefined;
		}

		var inst = this,
			type = jQuery.type( red ),
			rgba = this._rgba = [];

		// more than 1 argument specified - assume ( red, green, blue, alpha )
		if ( green !== undefined ) {
			red = [ red, green, blue, alpha ];
			type = "array";
		}

		if ( type === "string" ) {
			return this.parse( stringParse( red ) || colors._default );
		}

		if ( type === "array" ) {
			each( spaces.rgba.props, function( key, prop ) {
				rgba[ prop.idx ] = clamp( red[ prop.idx ], prop );
			});
			return this;
		}

		if ( type === "object" ) {
			if ( red instanceof color ) {
				each( spaces, function( spaceName, space ) {
					if ( red[ space.cache ] ) {
						inst[ space.cache ] = red[ space.cache ].slice();
					}
				});
			} else {
				each( spaces, function( spaceName, space ) {
					var cache = space.cache;
					each( space.props, function( key, prop ) {

						// if the cache doesn't exist, and we know how to convert
						if ( !inst[ cache ] && space.to ) {

							// if the value was null, we don't need to copy it
							// if the key was alpha, we don't need to copy it either
							if ( key === "alpha" || red[ key ] == null ) {
								return;
							}
							inst[ cache ] = space.to( inst._rgba );
						}

						// this is the only case where we allow nulls for ALL properties.
						// call clamp with alwaysAllowEmpty
						inst[ cache ][ prop.idx ] = clamp( red[ key ], prop, true );
					});

					// everything defined but alpha?
					if ( inst[ cache ] && jQuery.inArray( null, inst[ cache ].slice( 0, 3 ) ) < 0 ) {
						// use the default of 1
						inst[ cache ][ 3 ] = 1;
						if ( space.from ) {
							inst._rgba = space.from( inst[ cache ] );
						}
					}
				});
			}
			return this;
		}
	},
	is: function( compare ) {
		var is = color( compare ),
			same = true,
			inst = this;

		each( spaces, function( _, space ) {
			var localCache,
				isCache = is[ space.cache ];
			if (isCache) {
				localCache = inst[ space.cache ] || space.to && space.to( inst._rgba ) || [];
				each( space.props, function( _, prop ) {
					if ( isCache[ prop.idx ] != null ) {
						same = ( isCache[ prop.idx ] === localCache[ prop.idx ] );
						return same;
					}
				});
			}
			return same;
		});
		return same;
	},
	_space: function() {
		var used = [],
			inst = this;
		each( spaces, function( spaceName, space ) {
			if ( inst[ space.cache ] ) {
				used.push( spaceName );
			}
		});
		return used.pop();
	},
	transition: function( other, distance ) {
		var end = color( other ),
			spaceName = end._space(),
			space = spaces[ spaceName ],
			startColor = this.alpha() === 0 ? color( "transparent" ) : this,
			start = startColor[ space.cache ] || space.to( startColor._rgba ),
			result = start.slice();

		end = end[ space.cache ];
		each( space.props, function( key, prop ) {
			var index = prop.idx,
				startValue = start[ index ],
				endValue = end[ index ],
				type = propTypes[ prop.type ] || {};

			// if null, don't override start value
			if ( endValue === null ) {
				return;
			}
			// if null - use end
			if ( startValue === null ) {
				result[ index ] = endValue;
			} else {
				if ( type.mod ) {
					if ( endValue - startValue > type.mod / 2 ) {
						startValue += type.mod;
					} else if ( startValue - endValue > type.mod / 2 ) {
						startValue -= type.mod;
					}
				}
				result[ index ] = clamp( ( endValue - startValue ) * distance + startValue, prop );
			}
		});
		return this[ spaceName ]( result );
	},
	blend: function( opaque ) {
		// if we are already opaque - return ourself
		if ( this._rgba[ 3 ] === 1 ) {
			return this;
		}

		var rgb = this._rgba.slice(),
			a = rgb.pop(),
			blend = color( opaque )._rgba;

		return color( jQuery.map( rgb, function( v, i ) {
			return ( 1 - a ) * blend[ i ] + a * v;
		}));
	},
	toRgbaString: function() {
		var prefix = "rgba(",
			rgba = jQuery.map( this._rgba, function( v, i ) {
				return v == null ? ( i > 2 ? 1 : 0 ) : v;
			});

		if ( rgba[ 3 ] === 1 ) {
			rgba.pop();
			prefix = "rgb(";
		}

		return prefix + rgba.join() + ")";
	},
	toHslaString: function() {
		var prefix = "hsla(",
			hsla = jQuery.map( this.hsla(), function( v, i ) {
				if ( v == null ) {
					v = i > 2 ? 1 : 0;
				}

				// catch 1 and 2
				if ( i && i < 3 ) {
					v = Math.round( v * 100 ) + "%";
				}
				return v;
			});

		if ( hsla[ 3 ] === 1 ) {
			hsla.pop();
			prefix = "hsl(";
		}
		return prefix + hsla.join() + ")";
	},
	toHexString: function( includeAlpha ) {
		var rgba = this._rgba.slice(),
			alpha = rgba.pop();

		if ( includeAlpha ) {
			rgba.push( ~~( alpha * 255 ) );
		}

		return "#" + jQuery.map( rgba, function( v ) {

			// default to 0 when nulls exist
			v = ( v || 0 ).toString( 16 );
			return v.length === 1 ? "0" + v : v;
		}).join("");
	},
	toString: function() {
		return this._rgba[ 3 ] === 0 ? "transparent" : this.toRgbaString();
	}
});
color.fn.parse.prototype = color.fn;

// hsla conversions adapted from:
// https://code.google.com/p/maashaack/source/browse/packages/graphics/trunk/src/graphics/colors/HUE2RGB.as?r=5021

function hue2rgb( p, q, h ) {
	h = ( h + 1 ) % 1;
	if ( h * 6 < 1 ) {
		return p + ( q - p ) * h * 6;
	}
	if ( h * 2 < 1) {
		return q;
	}
	if ( h * 3 < 2 ) {
		return p + ( q - p ) * ( ( 2 / 3 ) - h ) * 6;
	}
	return p;
}

spaces.hsla.to = function( rgba ) {
	if ( rgba[ 0 ] == null || rgba[ 1 ] == null || rgba[ 2 ] == null ) {
		return [ null, null, null, rgba[ 3 ] ];
	}
	var r = rgba[ 0 ] / 255,
		g = rgba[ 1 ] / 255,
		b = rgba[ 2 ] / 255,
		a = rgba[ 3 ],
		max = Math.max( r, g, b ),
		min = Math.min( r, g, b ),
		diff = max - min,
		add = max + min,
		l = add * 0.5,
		h, s;

	if ( min === max ) {
		h = 0;
	} else if ( r === max ) {
		h = ( 60 * ( g - b ) / diff ) + 360;
	} else if ( g === max ) {
		h = ( 60 * ( b - r ) / diff ) + 120;
	} else {
		h = ( 60 * ( r - g ) / diff ) + 240;
	}

	// chroma (diff) == 0 means greyscale which, by definition, saturation = 0%
	// otherwise, saturation is based on the ratio of chroma (diff) to lightness (add)
	if ( diff === 0 ) {
		s = 0;
	} else if ( l <= 0.5 ) {
		s = diff / add;
	} else {
		s = diff / ( 2 - add );
	}
	return [ Math.round(h) % 360, s, l, a == null ? 1 : a ];
};

spaces.hsla.from = function( hsla ) {
	if ( hsla[ 0 ] == null || hsla[ 1 ] == null || hsla[ 2 ] == null ) {
		return [ null, null, null, hsla[ 3 ] ];
	}
	var h = hsla[ 0 ] / 360,
		s = hsla[ 1 ],
		l = hsla[ 2 ],
		a = hsla[ 3 ],
		q = l <= 0.5 ? l * ( 1 + s ) : l + s - l * s,
		p = 2 * l - q;

	return [
		Math.round( hue2rgb( p, q, h + ( 1 / 3 ) ) * 255 ),
		Math.round( hue2rgb( p, q, h ) * 255 ),
		Math.round( hue2rgb( p, q, h - ( 1 / 3 ) ) * 255 ),
		a
	];
};

each( spaces, function( spaceName, space ) {
	var props = space.props,
		cache = space.cache,
		to = space.to,
		from = space.from;

	// makes rgba() and hsla()
	color.fn[ spaceName ] = function( value ) {

		// generate a cache for this space if it doesn't exist
		if ( to && !this[ cache ] ) {
			this[ cache ] = to( this._rgba );
		}
		if ( value === undefined ) {
			return this[ cache ].slice();
		}

		var ret,
			type = jQuery.type( value ),
			arr = ( type === "array" || type === "object" ) ? value : arguments,
			local = this[ cache ].slice();

		each( props, function( key, prop ) {
			var val = arr[ type === "object" ? key : prop.idx ];
			if ( val == null ) {
				val = local[ prop.idx ];
			}
			local[ prop.idx ] = clamp( val, prop );
		});

		if ( from ) {
			ret = color( from( local ) );
			ret[ cache ] = local;
			return ret;
		} else {
			return color( local );
		}
	};

	// makes red() green() blue() alpha() hue() saturation() lightness()
	each( props, function( key, prop ) {
		// alpha is included in more than one space
		if ( color.fn[ key ] ) {
			return;
		}
		color.fn[ key ] = function( value ) {
			var vtype = jQuery.type( value ),
				fn = ( key === "alpha" ? ( this._hsla ? "hsla" : "rgba" ) : spaceName ),
				local = this[ fn ](),
				cur = local[ prop.idx ],
				match;

			if ( vtype === "undefined" ) {
				return cur;
			}

			if ( vtype === "function" ) {
				value = value.call( this, cur );
				vtype = jQuery.type( value );
			}
			if ( value == null && prop.empty ) {
				return this;
			}
			if ( vtype === "string" ) {
				match = rplusequals.exec( value );
				if ( match ) {
					value = cur + parseFloat( match[ 2 ] ) * ( match[ 1 ] === "+" ? 1 : -1 );
				}
			}
			local[ prop.idx ] = value;
			return this[ fn ]( local );
		};
	});
});

// add cssHook and .fx.step function for each named hook.
// accept a space separated string of properties
color.hook = function( hook ) {
	var hooks = hook.split( " " );
	each( hooks, function( i, hook ) {
		jQuery.cssHooks[ hook ] = {
			set: function( elem, value ) {
				var parsed, curElem,
					backgroundColor = "";

				if ( value !== "transparent" && ( jQuery.type( value ) !== "string" || ( parsed = stringParse( value ) ) ) ) {
					value = color( parsed || value );
					if ( !support.rgba && value._rgba[ 3 ] !== 1 ) {
						curElem = hook === "backgroundColor" ? elem.parentNode : elem;
						while (
							(backgroundColor === "" || backgroundColor === "transparent") &&
							curElem && curElem.style
						) {
							try {
								backgroundColor = jQuery.css( curElem, "backgroundColor" );
								curElem = curElem.parentNode;
							} catch ( e ) {
							}
						}

						value = value.blend( backgroundColor && backgroundColor !== "transparent" ?
							backgroundColor :
							"_default" );
					}

					value = value.toRgbaString();
				}
				try {
					elem.style[ hook ] = value;
				} catch ( e ) {
					// wrapped to prevent IE from throwing errors on "invalid" values like 'auto' or 'inherit'
				}
			}
		};
		jQuery.fx.step[ hook ] = function( fx ) {
			if ( !fx.colorInit ) {
				fx.start = color( fx.elem, hook );
				fx.end = color( fx.end );
				fx.colorInit = true;
			}
			jQuery.cssHooks[ hook ].set( fx.elem, fx.start.transition( fx.end, fx.pos ) );
		};
	});

};

color.hook( stepHooks );

jQuery.cssHooks.borderColor = {
	expand: function( value ) {
		var expanded = {};

		each( [ "Top", "Right", "Bottom", "Left" ], function( i, part ) {
			expanded[ "border" + part + "Color" ] = value;
		});
		return expanded;
	}
};

// Basic color names only.
// Usage of any of the other color names requires adding yourself or including
// jquery.color.svg-names.js.
colors = jQuery.Color.names = {
	// 4.1. Basic color keywords
	aqua: "#00ffff",
	black: "#000000",
	blue: "#0000ff",
	fuchsia: "#ff00ff",
	gray: "#808080",
	green: "#008000",
	lime: "#00ff00",
	maroon: "#800000",
	navy: "#000080",
	olive: "#808000",
	purple: "#800080",
	red: "#ff0000",
	silver: "#c0c0c0",
	teal: "#008080",
	white: "#ffffff",
	yellow: "#ffff00",

	// 4.2.3. "transparent" color keyword
	transparent: [ null, null, null, 0 ],

	_default: "#ffffff"
};

})( jQuery );

/******************************************************************************/
/****************************** CLASS ANIMATIONS ******************************/
/******************************************************************************/
(function() {

var classAnimationActions = [ "add", "remove", "toggle" ],
	shorthandStyles = {
		border: 1,
		borderBottom: 1,
		borderColor: 1,
		borderLeft: 1,
		borderRight: 1,
		borderTop: 1,
		borderWidth: 1,
		margin: 1,
		padding: 1
	};

$.each([ "borderLeftStyle", "borderRightStyle", "borderBottomStyle", "borderTopStyle" ], function( _, prop ) {
	$.fx.step[ prop ] = function( fx ) {
		if ( fx.end !== "none" && !fx.setAttr || fx.pos === 1 && !fx.setAttr ) {
			jQuery.style( fx.elem, prop, fx.end );
			fx.setAttr = true;
		}
	};
});

function getElementStyles( elem ) {
	var key, len,
		style = elem.ownerDocument.defaultView ?
			elem.ownerDocument.defaultView.getComputedStyle( elem, null ) :
			elem.currentStyle,
		styles = {};

	if ( style && style.length && style[ 0 ] && style[ style[ 0 ] ] ) {
		len = style.length;
		while ( len-- ) {
			key = style[ len ];
			if ( typeof style[ key ] === "string" ) {
				styles[ $.camelCase( key ) ] = style[ key ];
			}
		}
	// support: Opera, IE <9
	} else {
		for ( key in style ) {
			if ( typeof style[ key ] === "string" ) {
				styles[ key ] = style[ key ];
			}
		}
	}

	return styles;
}

function styleDifference( oldStyle, newStyle ) {
	var diff = {},
		name, value;

	for ( name in newStyle ) {
		value = newStyle[ name ];
		if ( oldStyle[ name ] !== value ) {
			if ( !shorthandStyles[ name ] ) {
				if ( $.fx.step[ name ] || !isNaN( parseFloat( value ) ) ) {
					diff[ name ] = value;
				}
			}
		}
	}

	return diff;
}

// support: jQuery <1.8
if ( !$.fn.addBack ) {
	$.fn.addBack = function( selector ) {
		return this.add( selector == null ?
			this.prevObject : this.prevObject.filter( selector )
		);
	};
}

$.effects.animateClass = function( value, duration, easing, callback ) {
	var o = $.speed( duration, easing, callback );

	return this.queue( function() {
		var animated = $( this ),
			baseClass = animated.attr( "class" ) || "",
			applyClassChange,
			allAnimations = o.children ? animated.find( "*" ).addBack() : animated;

		// map the animated objects to store the original styles.
		allAnimations = allAnimations.map(function() {
			var el = $( this );
			return {
				el: el,
				start: getElementStyles( this )
			};
		});

		// apply class change
		applyClassChange = function() {
			$.each( classAnimationActions, function(i, action) {
				if ( value[ action ] ) {
					animated[ action + "Class" ]( value[ action ] );
				}
			});
		};
		applyClassChange();

		// map all animated objects again - calculate new styles and diff
		allAnimations = allAnimations.map(function() {
			this.end = getElementStyles( this.el[ 0 ] );
			this.diff = styleDifference( this.start, this.end );
			return this;
		});

		// apply original class
		animated.attr( "class", baseClass );

		// map all animated objects again - this time collecting a promise
		allAnimations = allAnimations.map(function() {
			var styleInfo = this,
				dfd = $.Deferred(),
				opts = $.extend({}, o, {
					queue: false,
					complete: function() {
						dfd.resolve( styleInfo );
					}
				});

			this.el.animate( this.diff, opts );
			return dfd.promise();
		});

		// once all animations have completed:
		$.when.apply( $, allAnimations.get() ).done(function() {

			// set the final class
			applyClassChange();

			// for each animated element,
			// clear all css properties that were animated
			$.each( arguments, function() {
				var el = this.el;
				$.each( this.diff, function(key) {
					el.css( key, "" );
				});
			});

			// this is guarnteed to be there if you use jQuery.speed()
			// it also handles dequeuing the next anim...
			o.complete.call( animated[ 0 ] );
		});
	});
};

$.fn.extend({
	addClass: (function( orig ) {
		return function( classNames, speed, easing, callback ) {
			return speed ?
				$.effects.animateClass.call( this,
					{ add: classNames }, speed, easing, callback ) :
				orig.apply( this, arguments );
		};
	})( $.fn.addClass ),

	removeClass: (function( orig ) {
		return function( classNames, speed, easing, callback ) {
			return arguments.length > 1 ?
				$.effects.animateClass.call( this,
					{ remove: classNames }, speed, easing, callback ) :
				orig.apply( this, arguments );
		};
	})( $.fn.removeClass ),

	toggleClass: (function( orig ) {
		return function( classNames, force, speed, easing, callback ) {
			if ( typeof force === "boolean" || force === undefined ) {
				if ( !speed ) {
					// without speed parameter
					return orig.apply( this, arguments );
				} else {
					return $.effects.animateClass.call( this,
						(force ? { add: classNames } : { remove: classNames }),
						speed, easing, callback );
				}
			} else {
				// without force parameter
				return $.effects.animateClass.call( this,
					{ toggle: classNames }, force, speed, easing );
			}
		};
	})( $.fn.toggleClass ),

	switchClass: function( remove, add, speed, easing, callback) {
		return $.effects.animateClass.call( this, {
			add: add,
			remove: remove
		}, speed, easing, callback );
	}
});

})();

/******************************************************************************/
/*********************************** EFFECTS **********************************/
/******************************************************************************/

(function() {

$.extend( $.effects, {
	version: "1.11.4",

	// Saves a set of properties in a data storage
	save: function( element, set ) {
		for ( var i = 0; i < set.length; i++ ) {
			if ( set[ i ] !== null ) {
				element.data( dataSpace + set[ i ], element[ 0 ].style[ set[ i ] ] );
			}
		}
	},

	// Restores a set of previously saved properties from a data storage
	restore: function( element, set ) {
		var val, i;
		for ( i = 0; i < set.length; i++ ) {
			if ( set[ i ] !== null ) {
				val = element.data( dataSpace + set[ i ] );
				// support: jQuery 1.6.2
				// http://bugs.jquery.com/ticket/9917
				// jQuery 1.6.2 incorrectly returns undefined for any falsy value.
				// We can't differentiate between "" and 0 here, so we just assume
				// empty string since it's likely to be a more common value...
				if ( val === undefined ) {
					val = "";
				}
				element.css( set[ i ], val );
			}
		}
	},

	setMode: function( el, mode ) {
		if (mode === "toggle") {
			mode = el.is( ":hidden" ) ? "show" : "hide";
		}
		return mode;
	},

	// Translates a [top,left] array into a baseline value
	// this should be a little more flexible in the future to handle a string & hash
	getBaseline: function( origin, original ) {
		var y, x;
		switch ( origin[ 0 ] ) {
			case "top": y = 0; break;
			case "middle": y = 0.5; break;
			case "bottom": y = 1; break;
			default: y = origin[ 0 ] / original.height;
		}
		switch ( origin[ 1 ] ) {
			case "left": x = 0; break;
			case "center": x = 0.5; break;
			case "right": x = 1; break;
			default: x = origin[ 1 ] / original.width;
		}
		return {
			x: x,
			y: y
		};
	},

	// Wraps the element around a wrapper that copies position properties
	createWrapper: function( element ) {

		// if the element is already wrapped, return it
		if ( element.parent().is( ".ui-effects-wrapper" )) {
			return element.parent();
		}

		// wrap the element
		var props = {
				width: element.outerWidth(true),
				height: element.outerHeight(true),
				"float": element.css( "float" )
			},
			wrapper = $( "<div></div>" )
				.addClass( "ui-effects-wrapper" )
				.css({
					fontSize: "100%",
					background: "transparent",
					border: "none",
					margin: 0,
					padding: 0
				}),
			// Store the size in case width/height are defined in % - Fixes #5245
			size = {
				width: element.width(),
				height: element.height()
			},
			active = document.activeElement;

		// support: Firefox
		// Firefox incorrectly exposes anonymous content
		// https://bugzilla.mozilla.org/show_bug.cgi?id=561664
		try {
			active.id;
		} catch ( e ) {
			active = document.body;
		}

		element.wrap( wrapper );

		// Fixes #7595 - Elements lose focus when wrapped.
		if ( element[ 0 ] === active || $.contains( element[ 0 ], active ) ) {
			$( active ).focus();
		}

		wrapper = element.parent(); //Hotfix for jQuery 1.4 since some change in wrap() seems to actually lose the reference to the wrapped element

		// transfer positioning properties to the wrapper
		if ( element.css( "position" ) === "static" ) {
			wrapper.css({ position: "relative" });
			element.css({ position: "relative" });
		} else {
			$.extend( props, {
				position: element.css( "position" ),
				zIndex: element.css( "z-index" )
			});
			$.each([ "top", "left", "bottom", "right" ], function(i, pos) {
				props[ pos ] = element.css( pos );
				if ( isNaN( parseInt( props[ pos ], 10 ) ) ) {
					props[ pos ] = "auto";
				}
			});
			element.css({
				position: "relative",
				top: 0,
				left: 0,
				right: "auto",
				bottom: "auto"
			});
		}
		element.css(size);

		return wrapper.css( props ).show();
	},

	removeWrapper: function( element ) {
		var active = document.activeElement;

		if ( element.parent().is( ".ui-effects-wrapper" ) ) {
			element.parent().replaceWith( element );

			// Fixes #7595 - Elements lose focus when wrapped.
			if ( element[ 0 ] === active || $.contains( element[ 0 ], active ) ) {
				$( active ).focus();
			}
		}

		return element;
	},

	setTransition: function( element, list, factor, value ) {
		value = value || {};
		$.each( list, function( i, x ) {
			var unit = element.cssUnit( x );
			if ( unit[ 0 ] > 0 ) {
				value[ x ] = unit[ 0 ] * factor + unit[ 1 ];
			}
		});
		return value;
	}
});

// return an effect options object for the given parameters:
function _normalizeArguments( effect, options, speed, callback ) {

	// allow passing all options as the first parameter
	if ( $.isPlainObject( effect ) ) {
		options = effect;
		effect = effect.effect;
	}

	// convert to an object
	effect = { effect: effect };

	// catch (effect, null, ...)
	if ( options == null ) {
		options = {};
	}

	// catch (effect, callback)
	if ( $.isFunction( options ) ) {
		callback = options;
		speed = null;
		options = {};
	}

	// catch (effect, speed, ?)
	if ( typeof options === "number" || $.fx.speeds[ options ] ) {
		callback = speed;
		speed = options;
		options = {};
	}

	// catch (effect, options, callback)
	if ( $.isFunction( speed ) ) {
		callback = speed;
		speed = null;
	}

	// add options to effect
	if ( options ) {
		$.extend( effect, options );
	}

	speed = speed || options.duration;
	effect.duration = $.fx.off ? 0 :
		typeof speed === "number" ? speed :
		speed in $.fx.speeds ? $.fx.speeds[ speed ] :
		$.fx.speeds._default;

	effect.complete = callback || options.complete;

	return effect;
}

function standardAnimationOption( option ) {
	// Valid standard speeds (nothing, number, named speed)
	if ( !option || typeof option === "number" || $.fx.speeds[ option ] ) {
		return true;
	}

	// Invalid strings - treat as "normal" speed
	if ( typeof option === "string" && !$.effects.effect[ option ] ) {
		return true;
	}

	// Complete callback
	if ( $.isFunction( option ) ) {
		return true;
	}

	// Options hash (but not naming an effect)
	if ( typeof option === "object" && !option.effect ) {
		return true;
	}

	// Didn't match any standard API
	return false;
}

$.fn.extend({
	effect: function( /* effect, options, speed, callback */ ) {
		var args = _normalizeArguments.apply( this, arguments ),
			mode = args.mode,
			queue = args.queue,
			effectMethod = $.effects.effect[ args.effect ];

		if ( $.fx.off || !effectMethod ) {
			// delegate to the original method (e.g., .show()) if possible
			if ( mode ) {
				return this[ mode ]( args.duration, args.complete );
			} else {
				return this.each( function() {
					if ( args.complete ) {
						args.complete.call( this );
					}
				});
			}
		}

		function run( next ) {
			var elem = $( this ),
				complete = args.complete,
				mode = args.mode;

			function done() {
				if ( $.isFunction( complete ) ) {
					complete.call( elem[0] );
				}
				if ( $.isFunction( next ) ) {
					next();
				}
			}

			// If the element already has the correct final state, delegate to
			// the core methods so the internal tracking of "olddisplay" works.
			if ( elem.is( ":hidden" ) ? mode === "hide" : mode === "show" ) {
				elem[ mode ]();
				done();
			} else {
				effectMethod.call( elem[0], args, done );
			}
		}

		return queue === false ? this.each( run ) : this.queue( queue || "fx", run );
	},

	show: (function( orig ) {
		return function( option ) {
			if ( standardAnimationOption( option ) ) {
				return orig.apply( this, arguments );
			} else {
				var args = _normalizeArguments.apply( this, arguments );
				args.mode = "show";
				return this.effect.call( this, args );
			}
		};
	})( $.fn.show ),

	hide: (function( orig ) {
		return function( option ) {
			if ( standardAnimationOption( option ) ) {
				return orig.apply( this, arguments );
			} else {
				var args = _normalizeArguments.apply( this, arguments );
				args.mode = "hide";
				return this.effect.call( this, args );
			}
		};
	})( $.fn.hide ),

	toggle: (function( orig ) {
		return function( option ) {
			if ( standardAnimationOption( option ) || typeof option === "boolean" ) {
				return orig.apply( this, arguments );
			} else {
				var args = _normalizeArguments.apply( this, arguments );
				args.mode = "toggle";
				return this.effect.call( this, args );
			}
		};
	})( $.fn.toggle ),

	// helper functions
	cssUnit: function(key) {
		var style = this.css( key ),
			val = [];

		$.each( [ "em", "px", "%", "pt" ], function( i, unit ) {
			if ( style.indexOf( unit ) > 0 ) {
				val = [ parseFloat( style ), unit ];
			}
		});
		return val;
	}
});

})();

/******************************************************************************/
/*********************************** EASING ***********************************/
/******************************************************************************/

(function() {

// based on easing equations from Robert Penner (http://www.robertpenner.com/easing)

var baseEasings = {};

$.each( [ "Quad", "Cubic", "Quart", "Quint", "Expo" ], function( i, name ) {
	baseEasings[ name ] = function( p ) {
		return Math.pow( p, i + 2 );
	};
});

$.extend( baseEasings, {
	Sine: function( p ) {
		return 1 - Math.cos( p * Math.PI / 2 );
	},
	Circ: function( p ) {
		return 1 - Math.sqrt( 1 - p * p );
	},
	Elastic: function( p ) {
		return p === 0 || p === 1 ? p :
			-Math.pow( 2, 8 * (p - 1) ) * Math.sin( ( (p - 1) * 80 - 7.5 ) * Math.PI / 15 );
	},
	Back: function( p ) {
		return p * p * ( 3 * p - 2 );
	},
	Bounce: function( p ) {
		var pow2,
			bounce = 4;

		while ( p < ( ( pow2 = Math.pow( 2, --bounce ) ) - 1 ) / 11 ) {}
		return 1 / Math.pow( 4, 3 - bounce ) - 7.5625 * Math.pow( ( pow2 * 3 - 2 ) / 22 - p, 2 );
	}
});

$.each( baseEasings, function( name, easeIn ) {
	$.easing[ "easeIn" + name ] = easeIn;
	$.easing[ "easeOut" + name ] = function( p ) {
		return 1 - easeIn( 1 - p );
	};
	$.easing[ "easeInOut" + name ] = function( p ) {
		return p < 0.5 ?
			easeIn( p * 2 ) / 2 :
			1 - easeIn( p * -2 + 2 ) / 2;
	};
});

})();

var effect = $.effects;


/*!
 * jQuery UI Effects Blind 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/blind-effect/
 */


var effectBlind = $.effects.effect.blind = function( o, done ) {
	// Create element
	var el = $( this ),
		rvertical = /up|down|vertical/,
		rpositivemotion = /up|left|vertical|horizontal/,
		props = [ "position", "top", "bottom", "left", "right", "height", "width" ],
		mode = $.effects.setMode( el, o.mode || "hide" ),
		direction = o.direction || "up",
		vertical = rvertical.test( direction ),
		ref = vertical ? "height" : "width",
		ref2 = vertical ? "top" : "left",
		motion = rpositivemotion.test( direction ),
		animation = {},
		show = mode === "show",
		wrapper, distance, margin;

	// if already wrapped, the wrapper's properties are my property. #6245
	if ( el.parent().is( ".ui-effects-wrapper" ) ) {
		$.effects.save( el.parent(), props );
	} else {
		$.effects.save( el, props );
	}
	el.show();
	wrapper = $.effects.createWrapper( el ).css({
		overflow: "hidden"
	});

	distance = wrapper[ ref ]();
	margin = parseFloat( wrapper.css( ref2 ) ) || 0;

	animation[ ref ] = show ? distance : 0;
	if ( !motion ) {
		el
			.css( vertical ? "bottom" : "right", 0 )
			.css( vertical ? "top" : "left", "auto" )
			.css({ position: "absolute" });

		animation[ ref2 ] = show ? margin : distance + margin;
	}

	// start at 0 if we are showing
	if ( show ) {
		wrapper.css( ref, 0 );
		if ( !motion ) {
			wrapper.css( ref2, margin + distance );
		}
	}

	// Animate
	wrapper.animate( animation, {
		duration: o.duration,
		easing: o.easing,
		queue: false,
		complete: function() {
			if ( mode === "hide" ) {
				el.hide();
			}
			$.effects.restore( el, props );
			$.effects.removeWrapper( el );
			done();
		}
	});
};


/*!
 * jQuery UI Effects Bounce 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/bounce-effect/
 */


var effectBounce = $.effects.effect.bounce = function( o, done ) {
	var el = $( this ),
		props = [ "position", "top", "bottom", "left", "right", "height", "width" ],

		// defaults:
		mode = $.effects.setMode( el, o.mode || "effect" ),
		hide = mode === "hide",
		show = mode === "show",
		direction = o.direction || "up",
		distance = o.distance,
		times = o.times || 5,

		// number of internal animations
		anims = times * 2 + ( show || hide ? 1 : 0 ),
		speed = o.duration / anims,
		easing = o.easing,

		// utility:
		ref = ( direction === "up" || direction === "down" ) ? "top" : "left",
		motion = ( direction === "up" || direction === "left" ),
		i,
		upAnim,
		downAnim,

		// we will need to re-assemble the queue to stack our animations in place
		queue = el.queue(),
		queuelen = queue.length;

	// Avoid touching opacity to prevent clearType and PNG issues in IE
	if ( show || hide ) {
		props.push( "opacity" );
	}

	$.effects.save( el, props );
	el.show();
	$.effects.createWrapper( el ); // Create Wrapper

	// default distance for the BIGGEST bounce is the outer Distance / 3
	if ( !distance ) {
		distance = el[ ref === "top" ? "outerHeight" : "outerWidth" ]() / 3;
	}

	if ( show ) {
		downAnim = { opacity: 1 };
		downAnim[ ref ] = 0;

		// if we are showing, force opacity 0 and set the initial position
		// then do the "first" animation
		el.css( "opacity", 0 )
			.css( ref, motion ? -distance * 2 : distance * 2 )
			.animate( downAnim, speed, easing );
	}

	// start at the smallest distance if we are hiding
	if ( hide ) {
		distance = distance / Math.pow( 2, times - 1 );
	}

	downAnim = {};
	downAnim[ ref ] = 0;
	// Bounces up/down/left/right then back to 0 -- times * 2 animations happen here
	for ( i = 0; i < times; i++ ) {
		upAnim = {};
		upAnim[ ref ] = ( motion ? "-=" : "+=" ) + distance;

		el.animate( upAnim, speed, easing )
			.animate( downAnim, speed, easing );

		distance = hide ? distance * 2 : distance / 2;
	}

	// Last Bounce when Hiding
	if ( hide ) {
		upAnim = { opacity: 0 };
		upAnim[ ref ] = ( motion ? "-=" : "+=" ) + distance;

		el.animate( upAnim, speed, easing );
	}

	el.queue(function() {
		if ( hide ) {
			el.hide();
		}
		$.effects.restore( el, props );
		$.effects.removeWrapper( el );
		done();
	});

	// inject all the animations we just queued to be first in line (after "inprogress")
	if ( queuelen > 1) {
		queue.splice.apply( queue,
			[ 1, 0 ].concat( queue.splice( queuelen, anims + 1 ) ) );
	}
	el.dequeue();

};


/*!
 * jQuery UI Effects Clip 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/clip-effect/
 */


var effectClip = $.effects.effect.clip = function( o, done ) {
	// Create element
	var el = $( this ),
		props = [ "position", "top", "bottom", "left", "right", "height", "width" ],
		mode = $.effects.setMode( el, o.mode || "hide" ),
		show = mode === "show",
		direction = o.direction || "vertical",
		vert = direction === "vertical",
		size = vert ? "height" : "width",
		position = vert ? "top" : "left",
		animation = {},
		wrapper, animate, distance;

	// Save & Show
	$.effects.save( el, props );
	el.show();

	// Create Wrapper
	wrapper = $.effects.createWrapper( el ).css({
		overflow: "hidden"
	});
	animate = ( el[0].tagName === "IMG" ) ? wrapper : el;
	distance = animate[ size ]();

	// Shift
	if ( show ) {
		animate.css( size, 0 );
		animate.css( position, distance / 2 );
	}

	// Create Animation Object:
	animation[ size ] = show ? distance : 0;
	animation[ position ] = show ? 0 : distance / 2;

	// Animate
	animate.animate( animation, {
		queue: false,
		duration: o.duration,
		easing: o.easing,
		complete: function() {
			if ( !show ) {
				el.hide();
			}
			$.effects.restore( el, props );
			$.effects.removeWrapper( el );
			done();
		}
	});

};


/*!
 * jQuery UI Effects Drop 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/drop-effect/
 */


var effectDrop = $.effects.effect.drop = function( o, done ) {

	var el = $( this ),
		props = [ "position", "top", "bottom", "left", "right", "opacity", "height", "width" ],
		mode = $.effects.setMode( el, o.mode || "hide" ),
		show = mode === "show",
		direction = o.direction || "left",
		ref = ( direction === "up" || direction === "down" ) ? "top" : "left",
		motion = ( direction === "up" || direction === "left" ) ? "pos" : "neg",
		animation = {
			opacity: show ? 1 : 0
		},
		distance;

	// Adjust
	$.effects.save( el, props );
	el.show();
	$.effects.createWrapper( el );

	distance = o.distance || el[ ref === "top" ? "outerHeight" : "outerWidth" ]( true ) / 2;

	if ( show ) {
		el
			.css( "opacity", 0 )
			.css( ref, motion === "pos" ? -distance : distance );
	}

	// Animation
	animation[ ref ] = ( show ?
		( motion === "pos" ? "+=" : "-=" ) :
		( motion === "pos" ? "-=" : "+=" ) ) +
		distance;

	// Animate
	el.animate( animation, {
		queue: false,
		duration: o.duration,
		easing: o.easing,
		complete: function() {
			if ( mode === "hide" ) {
				el.hide();
			}
			$.effects.restore( el, props );
			$.effects.removeWrapper( el );
			done();
		}
	});
};


/*!
 * jQuery UI Effects Explode 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/explode-effect/
 */


var effectExplode = $.effects.effect.explode = function( o, done ) {

	var rows = o.pieces ? Math.round( Math.sqrt( o.pieces ) ) : 3,
		cells = rows,
		el = $( this ),
		mode = $.effects.setMode( el, o.mode || "hide" ),
		show = mode === "show",

		// show and then visibility:hidden the element before calculating offset
		offset = el.show().css( "visibility", "hidden" ).offset(),

		// width and height of a piece
		width = Math.ceil( el.outerWidth() / cells ),
		height = Math.ceil( el.outerHeight() / rows ),
		pieces = [],

		// loop
		i, j, left, top, mx, my;

	// children animate complete:
	function childComplete() {
		pieces.push( this );
		if ( pieces.length === rows * cells ) {
			animComplete();
		}
	}

	// clone the element for each row and cell.
	for ( i = 0; i < rows ; i++ ) { // ===>
		top = offset.top + i * height;
		my = i - ( rows - 1 ) / 2 ;

		for ( j = 0; j < cells ; j++ ) { // |||
			left = offset.left + j * width;
			mx = j - ( cells - 1 ) / 2 ;

			// Create a clone of the now hidden main element that will be absolute positioned
			// within a wrapper div off the -left and -top equal to size of our pieces
			el
				.clone()
				.appendTo( "body" )
				.wrap( "<div></div>" )
				.css({
					position: "absolute",
					visibility: "visible",
					left: -j * width,
					top: -i * height
				})

			// select the wrapper - make it overflow: hidden and absolute positioned based on
			// where the original was located +left and +top equal to the size of pieces
				.parent()
				.addClass( "ui-effects-explode" )
				.css({
					position: "absolute",
					overflow: "hidden",
					width: width,
					height: height,
					left: left + ( show ? mx * width : 0 ),
					top: top + ( show ? my * height : 0 ),
					opacity: show ? 0 : 1
				}).animate({
					left: left + ( show ? 0 : mx * width ),
					top: top + ( show ? 0 : my * height ),
					opacity: show ? 1 : 0
				}, o.duration || 500, o.easing, childComplete );
		}
	}

	function animComplete() {
		el.css({
			visibility: "visible"
		});
		$( pieces ).remove();
		if ( !show ) {
			el.hide();
		}
		done();
	}
};


/*!
 * jQuery UI Effects Fade 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/fade-effect/
 */


var effectFade = $.effects.effect.fade = function( o, done ) {
	var el = $( this ),
		mode = $.effects.setMode( el, o.mode || "toggle" );

	el.animate({
		opacity: mode
	}, {
		queue: false,
		duration: o.duration,
		easing: o.easing,
		complete: done
	});
};


/*!
 * jQuery UI Effects Fold 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/fold-effect/
 */


var effectFold = $.effects.effect.fold = function( o, done ) {

	// Create element
	var el = $( this ),
		props = [ "position", "top", "bottom", "left", "right", "height", "width" ],
		mode = $.effects.setMode( el, o.mode || "hide" ),
		show = mode === "show",
		hide = mode === "hide",
		size = o.size || 15,
		percent = /([0-9]+)%/.exec( size ),
		horizFirst = !!o.horizFirst,
		widthFirst = show !== horizFirst,
		ref = widthFirst ? [ "width", "height" ] : [ "height", "width" ],
		duration = o.duration / 2,
		wrapper, distance,
		animation1 = {},
		animation2 = {};

	$.effects.save( el, props );
	el.show();

	// Create Wrapper
	wrapper = $.effects.createWrapper( el ).css({
		overflow: "hidden"
	});
	distance = widthFirst ?
		[ wrapper.width(), wrapper.height() ] :
		[ wrapper.height(), wrapper.width() ];

	if ( percent ) {
		size = parseInt( percent[ 1 ], 10 ) / 100 * distance[ hide ? 0 : 1 ];
	}
	if ( show ) {
		wrapper.css( horizFirst ? {
			height: 0,
			width: size
		} : {
			height: size,
			width: 0
		});
	}

	// Animation
	animation1[ ref[ 0 ] ] = show ? distance[ 0 ] : size;
	animation2[ ref[ 1 ] ] = show ? distance[ 1 ] : 0;

	// Animate
	wrapper
		.animate( animation1, duration, o.easing )
		.animate( animation2, duration, o.easing, function() {
			if ( hide ) {
				el.hide();
			}
			$.effects.restore( el, props );
			$.effects.removeWrapper( el );
			done();
		});

};


/*!
 * jQuery UI Effects Highlight 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/highlight-effect/
 */


var effectHighlight = $.effects.effect.highlight = function( o, done ) {
	var elem = $( this ),
		props = [ "backgroundImage", "backgroundColor", "opacity" ],
		mode = $.effects.setMode( elem, o.mode || "show" ),
		animation = {
			backgroundColor: elem.css( "backgroundColor" )
		};

	if (mode === "hide") {
		animation.opacity = 0;
	}

	$.effects.save( elem, props );

	elem
		.show()
		.css({
			backgroundImage: "none",
			backgroundColor: o.color || "#ffff99"
		})
		.animate( animation, {
			queue: false,
			duration: o.duration,
			easing: o.easing,
			complete: function() {
				if ( mode === "hide" ) {
					elem.hide();
				}
				$.effects.restore( elem, props );
				done();
			}
		});
};


/*!
 * jQuery UI Effects Size 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/size-effect/
 */


var effectSize = $.effects.effect.size = function( o, done ) {

	// Create element
	var original, baseline, factor,
		el = $( this ),
		props0 = [ "position", "top", "bottom", "left", "right", "width", "height", "overflow", "opacity" ],

		// Always restore
		props1 = [ "position", "top", "bottom", "left", "right", "overflow", "opacity" ],

		// Copy for children
		props2 = [ "width", "height", "overflow" ],
		cProps = [ "fontSize" ],
		vProps = [ "borderTopWidth", "borderBottomWidth", "paddingTop", "paddingBottom" ],
		hProps = [ "borderLeftWidth", "borderRightWidth", "paddingLeft", "paddingRight" ],

		// Set options
		mode = $.effects.setMode( el, o.mode || "effect" ),
		restore = o.restore || mode !== "effect",
		scale = o.scale || "both",
		origin = o.origin || [ "middle", "center" ],
		position = el.css( "position" ),
		props = restore ? props0 : props1,
		zero = {
			height: 0,
			width: 0,
			outerHeight: 0,
			outerWidth: 0
		};

	if ( mode === "show" ) {
		el.show();
	}
	original = {
		height: el.height(),
		width: el.width(),
		outerHeight: el.outerHeight(),
		outerWidth: el.outerWidth()
	};

	if ( o.mode === "toggle" && mode === "show" ) {
		el.from = o.to || zero;
		el.to = o.from || original;
	} else {
		el.from = o.from || ( mode === "show" ? zero : original );
		el.to = o.to || ( mode === "hide" ? zero : original );
	}

	// Set scaling factor
	factor = {
		from: {
			y: el.from.height / original.height,
			x: el.from.width / original.width
		},
		to: {
			y: el.to.height / original.height,
			x: el.to.width / original.width
		}
	};

	// Scale the css box
	if ( scale === "box" || scale === "both" ) {

		// Vertical props scaling
		if ( factor.from.y !== factor.to.y ) {
			props = props.concat( vProps );
			el.from = $.effects.setTransition( el, vProps, factor.from.y, el.from );
			el.to = $.effects.setTransition( el, vProps, factor.to.y, el.to );
		}

		// Horizontal props scaling
		if ( factor.from.x !== factor.to.x ) {
			props = props.concat( hProps );
			el.from = $.effects.setTransition( el, hProps, factor.from.x, el.from );
			el.to = $.effects.setTransition( el, hProps, factor.to.x, el.to );
		}
	}

	// Scale the content
	if ( scale === "content" || scale === "both" ) {

		// Vertical props scaling
		if ( factor.from.y !== factor.to.y ) {
			props = props.concat( cProps ).concat( props2 );
			el.from = $.effects.setTransition( el, cProps, factor.from.y, el.from );
			el.to = $.effects.setTransition( el, cProps, factor.to.y, el.to );
		}
	}

	$.effects.save( el, props );
	el.show();
	$.effects.createWrapper( el );
	el.css( "overflow", "hidden" ).css( el.from );

	// Adjust
	if (origin) { // Calculate baseline shifts
		baseline = $.effects.getBaseline( origin, original );
		el.from.top = ( original.outerHeight - el.outerHeight() ) * baseline.y;
		el.from.left = ( original.outerWidth - el.outerWidth() ) * baseline.x;
		el.to.top = ( original.outerHeight - el.to.outerHeight ) * baseline.y;
		el.to.left = ( original.outerWidth - el.to.outerWidth ) * baseline.x;
	}
	el.css( el.from ); // set top & left

	// Animate
	if ( scale === "content" || scale === "both" ) { // Scale the children

		// Add margins/font-size
		vProps = vProps.concat([ "marginTop", "marginBottom" ]).concat(cProps);
		hProps = hProps.concat([ "marginLeft", "marginRight" ]);
		props2 = props0.concat(vProps).concat(hProps);

		el.find( "*[width]" ).each( function() {
			var child = $( this ),
				c_original = {
					height: child.height(),
					width: child.width(),
					outerHeight: child.outerHeight(),
					outerWidth: child.outerWidth()
				};
			if (restore) {
				$.effects.save(child, props2);
			}

			child.from = {
				height: c_original.height * factor.from.y,
				width: c_original.width * factor.from.x,
				outerHeight: c_original.outerHeight * factor.from.y,
				outerWidth: c_original.outerWidth * factor.from.x
			};
			child.to = {
				height: c_original.height * factor.to.y,
				width: c_original.width * factor.to.x,
				outerHeight: c_original.height * factor.to.y,
				outerWidth: c_original.width * factor.to.x
			};

			// Vertical props scaling
			if ( factor.from.y !== factor.to.y ) {
				child.from = $.effects.setTransition( child, vProps, factor.from.y, child.from );
				child.to = $.effects.setTransition( child, vProps, factor.to.y, child.to );
			}

			// Horizontal props scaling
			if ( factor.from.x !== factor.to.x ) {
				child.from = $.effects.setTransition( child, hProps, factor.from.x, child.from );
				child.to = $.effects.setTransition( child, hProps, factor.to.x, child.to );
			}

			// Animate children
			child.css( child.from );
			child.animate( child.to, o.duration, o.easing, function() {

				// Restore children
				if ( restore ) {
					$.effects.restore( child, props2 );
				}
			});
		});
	}

	// Animate
	el.animate( el.to, {
		queue: false,
		duration: o.duration,
		easing: o.easing,
		complete: function() {
			if ( el.to.opacity === 0 ) {
				el.css( "opacity", el.from.opacity );
			}
			if ( mode === "hide" ) {
				el.hide();
			}
			$.effects.restore( el, props );
			if ( !restore ) {

				// we need to calculate our new positioning based on the scaling
				if ( position === "static" ) {
					el.css({
						position: "relative",
						top: el.to.top,
						left: el.to.left
					});
				} else {
					$.each([ "top", "left" ], function( idx, pos ) {
						el.css( pos, function( _, str ) {
							var val = parseInt( str, 10 ),
								toRef = idx ? el.to.left : el.to.top;

							// if original was "auto", recalculate the new value from wrapper
							if ( str === "auto" ) {
								return toRef + "px";
							}

							return val + toRef + "px";
						});
					});
				}
			}

			$.effects.removeWrapper( el );
			done();
		}
	});

};


/*!
 * jQuery UI Effects Scale 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/scale-effect/
 */


var effectScale = $.effects.effect.scale = function( o, done ) {

	// Create element
	var el = $( this ),
		options = $.extend( true, {}, o ),
		mode = $.effects.setMode( el, o.mode || "effect" ),
		percent = parseInt( o.percent, 10 ) ||
			( parseInt( o.percent, 10 ) === 0 ? 0 : ( mode === "hide" ? 0 : 100 ) ),
		direction = o.direction || "both",
		origin = o.origin,
		original = {
			height: el.height(),
			width: el.width(),
			outerHeight: el.outerHeight(),
			outerWidth: el.outerWidth()
		},
		factor = {
			y: direction !== "horizontal" ? (percent / 100) : 1,
			x: direction !== "vertical" ? (percent / 100) : 1
		};

	// We are going to pass this effect to the size effect:
	options.effect = "size";
	options.queue = false;
	options.complete = done;

	// Set default origin and restore for show/hide
	if ( mode !== "effect" ) {
		options.origin = origin || [ "middle", "center" ];
		options.restore = true;
	}

	options.from = o.from || ( mode === "show" ? {
		height: 0,
		width: 0,
		outerHeight: 0,
		outerWidth: 0
	} : original );
	options.to = {
		height: original.height * factor.y,
		width: original.width * factor.x,
		outerHeight: original.outerHeight * factor.y,
		outerWidth: original.outerWidth * factor.x
	};

	// Fade option to support puff
	if ( options.fade ) {
		if ( mode === "show" ) {
			options.from.opacity = 0;
			options.to.opacity = 1;
		}
		if ( mode === "hide" ) {
			options.from.opacity = 1;
			options.to.opacity = 0;
		}
	}

	// Animate
	el.effect( options );

};


/*!
 * jQuery UI Effects Puff 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/puff-effect/
 */


var effectPuff = $.effects.effect.puff = function( o, done ) {
	var elem = $( this ),
		mode = $.effects.setMode( elem, o.mode || "hide" ),
		hide = mode === "hide",
		percent = parseInt( o.percent, 10 ) || 150,
		factor = percent / 100,
		original = {
			height: elem.height(),
			width: elem.width(),
			outerHeight: elem.outerHeight(),
			outerWidth: elem.outerWidth()
		};

	$.extend( o, {
		effect: "scale",
		queue: false,
		fade: true,
		mode: mode,
		complete: done,
		percent: hide ? percent : 100,
		from: hide ?
			original :
			{
				height: original.height * factor,
				width: original.width * factor,
				outerHeight: original.outerHeight * factor,
				outerWidth: original.outerWidth * factor
			}
	});

	elem.effect( o );
};


/*!
 * jQuery UI Effects Pulsate 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/pulsate-effect/
 */


var effectPulsate = $.effects.effect.pulsate = function( o, done ) {
	var elem = $( this ),
		mode = $.effects.setMode( elem, o.mode || "show" ),
		show = mode === "show",
		hide = mode === "hide",
		showhide = ( show || mode === "hide" ),

		// showing or hiding leaves of the "last" animation
		anims = ( ( o.times || 5 ) * 2 ) + ( showhide ? 1 : 0 ),
		duration = o.duration / anims,
		animateTo = 0,
		queue = elem.queue(),
		queuelen = queue.length,
		i;

	if ( show || !elem.is(":visible")) {
		elem.css( "opacity", 0 ).show();
		animateTo = 1;
	}

	// anims - 1 opacity "toggles"
	for ( i = 1; i < anims; i++ ) {
		elem.animate({
			opacity: animateTo
		}, duration, o.easing );
		animateTo = 1 - animateTo;
	}

	elem.animate({
		opacity: animateTo
	}, duration, o.easing);

	elem.queue(function() {
		if ( hide ) {
			elem.hide();
		}
		done();
	});

	// We just queued up "anims" animations, we need to put them next in the queue
	if ( queuelen > 1 ) {
		queue.splice.apply( queue,
			[ 1, 0 ].concat( queue.splice( queuelen, anims + 1 ) ) );
	}
	elem.dequeue();
};


/*!
 * jQuery UI Effects Shake 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/shake-effect/
 */


var effectShake = $.effects.effect.shake = function( o, done ) {

	var el = $( this ),
		props = [ "position", "top", "bottom", "left", "right", "height", "width" ],
		mode = $.effects.setMode( el, o.mode || "effect" ),
		direction = o.direction || "left",
		distance = o.distance || 20,
		times = o.times || 3,
		anims = times * 2 + 1,
		speed = Math.round( o.duration / anims ),
		ref = (direction === "up" || direction === "down") ? "top" : "left",
		positiveMotion = (direction === "up" || direction === "left"),
		animation = {},
		animation1 = {},
		animation2 = {},
		i,

		// we will need to re-assemble the queue to stack our animations in place
		queue = el.queue(),
		queuelen = queue.length;

	$.effects.save( el, props );
	el.show();
	$.effects.createWrapper( el );

	// Animation
	animation[ ref ] = ( positiveMotion ? "-=" : "+=" ) + distance;
	animation1[ ref ] = ( positiveMotion ? "+=" : "-=" ) + distance * 2;
	animation2[ ref ] = ( positiveMotion ? "-=" : "+=" ) + distance * 2;

	// Animate
	el.animate( animation, speed, o.easing );

	// Shakes
	for ( i = 1; i < times; i++ ) {
		el.animate( animation1, speed, o.easing ).animate( animation2, speed, o.easing );
	}
	el
		.animate( animation1, speed, o.easing )
		.animate( animation, speed / 2, o.easing )
		.queue(function() {
			if ( mode === "hide" ) {
				el.hide();
			}
			$.effects.restore( el, props );
			$.effects.removeWrapper( el );
			done();
		});

	// inject all the animations we just queued to be first in line (after "inprogress")
	if ( queuelen > 1) {
		queue.splice.apply( queue,
			[ 1, 0 ].concat( queue.splice( queuelen, anims + 1 ) ) );
	}
	el.dequeue();

};


/*!
 * jQuery UI Effects Slide 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/slide-effect/
 */


var effectSlide = $.effects.effect.slide = function( o, done ) {

	// Create element
	var el = $( this ),
		props = [ "position", "top", "bottom", "left", "right", "width", "height" ],
		mode = $.effects.setMode( el, o.mode || "show" ),
		show = mode === "show",
		direction = o.direction || "left",
		ref = (direction === "up" || direction === "down") ? "top" : "left",
		positiveMotion = (direction === "up" || direction === "left"),
		distance,
		animation = {};

	// Adjust
	$.effects.save( el, props );
	el.show();
	distance = o.distance || el[ ref === "top" ? "outerHeight" : "outerWidth" ]( true );

	$.effects.createWrapper( el ).css({
		overflow: "hidden"
	});

	if ( show ) {
		el.css( ref, positiveMotion ? (isNaN(distance) ? "-" + distance : -distance) : distance );
	}

	// Animation
	animation[ ref ] = ( show ?
		( positiveMotion ? "+=" : "-=") :
		( positiveMotion ? "-=" : "+=")) +
		distance;

	// Animate
	el.animate( animation, {
		queue: false,
		duration: o.duration,
		easing: o.easing,
		complete: function() {
			if ( mode === "hide" ) {
				el.hide();
			}
			$.effects.restore( el, props );
			$.effects.removeWrapper( el );
			done();
		}
	});
};


/*!
 * jQuery UI Effects Transfer 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/transfer-effect/
 */


var effectTransfer = $.effects.effect.transfer = function( o, done ) {
	var elem = $( this ),
		target = $( o.to ),
		targetFixed = target.css( "position" ) === "fixed",
		body = $("body"),
		fixTop = targetFixed ? body.scrollTop() : 0,
		fixLeft = targetFixed ? body.scrollLeft() : 0,
		endPosition = target.offset(),
		animation = {
			top: endPosition.top - fixTop,
			left: endPosition.left - fixLeft,
			height: target.innerHeight(),
			width: target.innerWidth()
		},
		startPosition = elem.offset(),
		transfer = $( "<div class='ui-effects-transfer'></div>" )
			.appendTo( document.body )
			.addClass( o.className )
			.css({
				top: startPosition.top - fixTop,
				left: startPosition.left - fixLeft,
				height: elem.innerHeight(),
				width: elem.innerWidth(),
				position: targetFixed ? "fixed" : "absolute"
			})
			.animate( animation, o.duration, o.easing, function() {
				transfer.remove();
				done();
			});
};


/*!
 * jQuery UI Progressbar 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/progressbar/
 */


var progressbar = $.widget( "ui.progressbar", {
	version: "1.11.4",
	options: {
		max: 100,
		value: 0,

		change: null,
		complete: null
	},

	min: 0,

	_create: function() {
		// Constrain initial value
		this.oldValue = this.options.value = this._constrainedValue();

		this.element
			.addClass( "ui-progressbar ui-widget ui-widget-content ui-corner-all" )
			.attr({
				// Only set static values, aria-valuenow and aria-valuemax are
				// set inside _refreshValue()
				role: "progressbar",
				"aria-valuemin": this.min
			});

		this.valueDiv = $( "<div class='ui-progressbar-value ui-widget-header ui-corner-left'></div>" )
			.appendTo( this.element );

		this._refreshValue();
	},

	_destroy: function() {
		this.element
			.removeClass( "ui-progressbar ui-widget ui-widget-content ui-corner-all" )
			.removeAttr( "role" )
			.removeAttr( "aria-valuemin" )
			.removeAttr( "aria-valuemax" )
			.removeAttr( "aria-valuenow" );

		this.valueDiv.remove();
	},

	value: function( newValue ) {
		if ( newValue === undefined ) {
			return this.options.value;
		}

		this.options.value = this._constrainedValue( newValue );
		this._refreshValue();
	},

	_constrainedValue: function( newValue ) {
		if ( newValue === undefined ) {
			newValue = this.options.value;
		}

		this.indeterminate = newValue === false;

		// sanitize value
		if ( typeof newValue !== "number" ) {
			newValue = 0;
		}

		return this.indeterminate ? false :
			Math.min( this.options.max, Math.max( this.min, newValue ) );
	},

	_setOptions: function( options ) {
		// Ensure "value" option is set after other values (like max)
		var value = options.value;
		delete options.value;

		this._super( options );

		this.options.value = this._constrainedValue( value );
		this._refreshValue();
	},

	_setOption: function( key, value ) {
		if ( key === "max" ) {
			// Don't allow a max less than min
			value = Math.max( this.min, value );
		}
		if ( key === "disabled" ) {
			this.element
				.toggleClass( "ui-state-disabled", !!value )
				.attr( "aria-disabled", value );
		}
		this._super( key, value );
	},

	_percentage: function() {
		return this.indeterminate ? 100 : 100 * ( this.options.value - this.min ) / ( this.options.max - this.min );
	},

	_refreshValue: function() {
		var value = this.options.value,
			percentage = this._percentage();

		this.valueDiv
			.toggle( this.indeterminate || value > this.min )
			.toggleClass( "ui-corner-right", value === this.options.max )
			.width( percentage.toFixed(0) + "%" );

		this.element.toggleClass( "ui-progressbar-indeterminate", this.indeterminate );

		if ( this.indeterminate ) {
			this.element.removeAttr( "aria-valuenow" );
			if ( !this.overlayDiv ) {
				this.overlayDiv = $( "<div class='ui-progressbar-overlay'></div>" ).appendTo( this.valueDiv );
			}
		} else {
			this.element.attr({
				"aria-valuemax": this.options.max,
				"aria-valuenow": value
			});
			if ( this.overlayDiv ) {
				this.overlayDiv.remove();
				this.overlayDiv = null;
			}
		}

		if ( this.oldValue !== value ) {
			this.oldValue = value;
			this._trigger( "change" );
		}
		if ( value === this.options.max ) {
			this._trigger( "complete" );
		}
	}
});


/*!
 * jQuery UI Selectable 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/selectable/
 */


var selectable = $.widget("ui.selectable", $.ui.mouse, {
	version: "1.11.4",
	options: {
		appendTo: "body",
		autoRefresh: true,
		distance: 0,
		filter: "*",
		tolerance: "touch",

		// callbacks
		selected: null,
		selecting: null,
		start: null,
		stop: null,
		unselected: null,
		unselecting: null
	},
	_create: function() {
		var selectees,
			that = this;

		this.element.addClass("ui-selectable");

		this.dragged = false;

		// cache selectee children based on filter
		this.refresh = function() {
			selectees = $(that.options.filter, that.element[0]);
			selectees.addClass("ui-selectee");
			selectees.each(function() {
				var $this = $(this),
					pos = $this.offset();
				$.data(this, "selectable-item", {
					element: this,
					$element: $this,
					left: pos.left,
					top: pos.top,
					right: pos.left + $this.outerWidth(),
					bottom: pos.top + $this.outerHeight(),
					startselected: false,
					selected: $this.hasClass("ui-selected"),
					selecting: $this.hasClass("ui-selecting"),
					unselecting: $this.hasClass("ui-unselecting")
				});
			});
		};
		this.refresh();

		this.selectees = selectees.addClass("ui-selectee");

		this._mouseInit();

		this.helper = $("<div class='ui-selectable-helper'></div>");
	},

	_destroy: function() {
		this.selectees
			.removeClass("ui-selectee")
			.removeData("selectable-item");
		this.element
			.removeClass("ui-selectable ui-selectable-disabled");
		this._mouseDestroy();
	},

	_mouseStart: function(event) {
		var that = this,
			options = this.options;

		this.opos = [ event.pageX, event.pageY ];

		if (this.options.disabled) {
			return;
		}

		this.selectees = $(options.filter, this.element[0]);

		this._trigger("start", event);

		$(options.appendTo).append(this.helper);
		// position helper (lasso)
		this.helper.css({
			"left": event.pageX,
			"top": event.pageY,
			"width": 0,
			"height": 0
		});

		if (options.autoRefresh) {
			this.refresh();
		}

		this.selectees.filter(".ui-selected").each(function() {
			var selectee = $.data(this, "selectable-item");
			selectee.startselected = true;
			if (!event.metaKey && !event.ctrlKey) {
				selectee.$element.removeClass("ui-selected");
				selectee.selected = false;
				selectee.$element.addClass("ui-unselecting");
				selectee.unselecting = true;
				// selectable UNSELECTING callback
				that._trigger("unselecting", event, {
					unselecting: selectee.element
				});
			}
		});

		$(event.target).parents().addBack().each(function() {
			var doSelect,
				selectee = $.data(this, "selectable-item");
			if (selectee) {
				doSelect = (!event.metaKey && !event.ctrlKey) || !selectee.$element.hasClass("ui-selected");
				selectee.$element
					.removeClass(doSelect ? "ui-unselecting" : "ui-selected")
					.addClass(doSelect ? "ui-selecting" : "ui-unselecting");
				selectee.unselecting = !doSelect;
				selectee.selecting = doSelect;
				selectee.selected = doSelect;
				// selectable (UN)SELECTING callback
				if (doSelect) {
					that._trigger("selecting", event, {
						selecting: selectee.element
					});
				} else {
					that._trigger("unselecting", event, {
						unselecting: selectee.element
					});
				}
				return false;
			}
		});

	},

	_mouseDrag: function(event) {

		this.dragged = true;

		if (this.options.disabled) {
			return;
		}

		var tmp,
			that = this,
			options = this.options,
			x1 = this.opos[0],
			y1 = this.opos[1],
			x2 = event.pageX,
			y2 = event.pageY;

		if (x1 > x2) { tmp = x2; x2 = x1; x1 = tmp; }
		if (y1 > y2) { tmp = y2; y2 = y1; y1 = tmp; }
		this.helper.css({ left: x1, top: y1, width: x2 - x1, height: y2 - y1 });

		this.selectees.each(function() {
			var selectee = $.data(this, "selectable-item"),
				hit = false;

			//prevent helper from being selected if appendTo: selectable
			if (!selectee || selectee.element === that.element[0]) {
				return;
			}

			if (options.tolerance === "touch") {
				hit = ( !(selectee.left > x2 || selectee.right < x1 || selectee.top > y2 || selectee.bottom < y1) );
			} else if (options.tolerance === "fit") {
				hit = (selectee.left > x1 && selectee.right < x2 && selectee.top > y1 && selectee.bottom < y2);
			}

			if (hit) {
				// SELECT
				if (selectee.selected) {
					selectee.$element.removeClass("ui-selected");
					selectee.selected = false;
				}
				if (selectee.unselecting) {
					selectee.$element.removeClass("ui-unselecting");
					selectee.unselecting = false;
				}
				if (!selectee.selecting) {
					selectee.$element.addClass("ui-selecting");
					selectee.selecting = true;
					// selectable SELECTING callback
					that._trigger("selecting", event, {
						selecting: selectee.element
					});
				}
			} else {
				// UNSELECT
				if (selectee.selecting) {
					if ((event.metaKey || event.ctrlKey) && selectee.startselected) {
						selectee.$element.removeClass("ui-selecting");
						selectee.selecting = false;
						selectee.$element.addClass("ui-selected");
						selectee.selected = true;
					} else {
						selectee.$element.removeClass("ui-selecting");
						selectee.selecting = false;
						if (selectee.startselected) {
							selectee.$element.addClass("ui-unselecting");
							selectee.unselecting = true;
						}
						// selectable UNSELECTING callback
						that._trigger("unselecting", event, {
							unselecting: selectee.element
						});
					}
				}
				if (selectee.selected) {
					if (!event.metaKey && !event.ctrlKey && !selectee.startselected) {
						selectee.$element.removeClass("ui-selected");
						selectee.selected = false;

						selectee.$element.addClass("ui-unselecting");
						selectee.unselecting = true;
						// selectable UNSELECTING callback
						that._trigger("unselecting", event, {
							unselecting: selectee.element
						});
					}
				}
			}
		});

		return false;
	},

	_mouseStop: function(event) {
		var that = this;

		this.dragged = false;

		$(".ui-unselecting", this.element[0]).each(function() {
			var selectee = $.data(this, "selectable-item");
			selectee.$element.removeClass("ui-unselecting");
			selectee.unselecting = false;
			selectee.startselected = false;
			that._trigger("unselected", event, {
				unselected: selectee.element
			});
		});
		$(".ui-selecting", this.element[0]).each(function() {
			var selectee = $.data(this, "selectable-item");
			selectee.$element.removeClass("ui-selecting").addClass("ui-selected");
			selectee.selecting = false;
			selectee.selected = true;
			selectee.startselected = true;
			that._trigger("selected", event, {
				selected: selectee.element
			});
		});
		this._trigger("stop", event);

		this.helper.remove();

		return false;
	}

});


/*!
 * jQuery UI Selectmenu 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/selectmenu
 */


var selectmenu = $.widget( "ui.selectmenu", {
	version: "1.11.4",
	defaultElement: "<select>",
	options: {
		appendTo: null,
		disabled: null,
		icons: {
			button: "ui-icon-triangle-1-s"
		},
		position: {
			my: "left top",
			at: "left bottom",
			collision: "none"
		},
		width: null,

		// callbacks
		change: null,
		close: null,
		focus: null,
		open: null,
		select: null
	},

	_create: function() {
		var selectmenuId = this.element.uniqueId().attr( "id" );
		this.ids = {
			element: selectmenuId,
			button: selectmenuId + "-button",
			menu: selectmenuId + "-menu"
		};

		this._drawButton();
		this._drawMenu();

		if ( this.options.disabled ) {
			this.disable();
		}
	},

	_drawButton: function() {
		var that = this;

		// Associate existing label with the new button
		this.label = $( "label[for='" + this.ids.element + "']" ).attr( "for", this.ids.button );
		this._on( this.label, {
			click: function( event ) {
				this.button.focus();
				event.preventDefault();
			}
		});

		// Hide original select element
		this.element.hide();

		// Create button
		this.button = $( "<span>", {
			"class": "ui-selectmenu-button ui-widget ui-state-default ui-corner-all",
			tabindex: this.options.disabled ? -1 : 0,
			id: this.ids.button,
			role: "combobox",
			"aria-expanded": "false",
			"aria-autocomplete": "list",
			"aria-owns": this.ids.menu,
			"aria-haspopup": "true"
		})
			.insertAfter( this.element );

		$( "<span>", {
			"class": "ui-icon " + this.options.icons.button
		})
			.prependTo( this.button );

		this.buttonText = $( "<span>", {
			"class": "ui-selectmenu-text"
		})
			.appendTo( this.button );

		this._setText( this.buttonText, this.element.find( "option:selected" ).text() );
		this._resizeButton();

		this._on( this.button, this._buttonEvents );
		this.button.one( "focusin", function() {

			// Delay rendering the menu items until the button receives focus.
			// The menu may have already been rendered via a programmatic open.
			if ( !that.menuItems ) {
				that._refreshMenu();
			}
		});
		this._hoverable( this.button );
		this._focusable( this.button );
	},

	_drawMenu: function() {
		var that = this;

		// Create menu
		this.menu = $( "<ul>", {
			"aria-hidden": "true",
			"aria-labelledby": this.ids.button,
			id: this.ids.menu
		});

		// Wrap menu
		this.menuWrap = $( "<div>", {
			"class": "ui-selectmenu-menu ui-front"
		})
			.append( this.menu )
			.appendTo( this._appendTo() );

		// Initialize menu widget
		this.menuInstance = this.menu
			.menu({
				role: "listbox",
				select: function( event, ui ) {
					event.preventDefault();

					// support: IE8
					// If the item was selected via a click, the text selection
					// will be destroyed in IE
					that._setSelection();

					that._select( ui.item.data( "ui-selectmenu-item" ), event );
				},
				focus: function( event, ui ) {
					var item = ui.item.data( "ui-selectmenu-item" );

					// Prevent inital focus from firing and check if its a newly focused item
					if ( that.focusIndex != null && item.index !== that.focusIndex ) {
						that._trigger( "focus", event, { item: item } );
						if ( !that.isOpen ) {
							that._select( item, event );
						}
					}
					that.focusIndex = item.index;

					that.button.attr( "aria-activedescendant",
						that.menuItems.eq( item.index ).attr( "id" ) );
				}
			})
			.menu( "instance" );

		// Adjust menu styles to dropdown
		this.menu
			.addClass( "ui-corner-bottom" )
			.removeClass( "ui-corner-all" );

		// Don't close the menu on mouseleave
		this.menuInstance._off( this.menu, "mouseleave" );

		// Cancel the menu's collapseAll on document click
		this.menuInstance._closeOnDocumentClick = function() {
			return false;
		};

		// Selects often contain empty items, but never contain dividers
		this.menuInstance._isDivider = function() {
			return false;
		};
	},

	refresh: function() {
		this._refreshMenu();
		this._setText( this.buttonText, this._getSelectedItem().text() );
		if ( !this.options.width ) {
			this._resizeButton();
		}
	},

	_refreshMenu: function() {
		this.menu.empty();

		var item,
			options = this.element.find( "option" );

		if ( !options.length ) {
			return;
		}

		this._parseOptions( options );
		this._renderMenu( this.menu, this.items );

		this.menuInstance.refresh();
		this.menuItems = this.menu.find( "li" ).not( ".ui-selectmenu-optgroup" );

		item = this._getSelectedItem();

		// Update the menu to have the correct item focused
		this.menuInstance.focus( null, item );
		this._setAria( item.data( "ui-selectmenu-item" ) );

		// Set disabled state
		this._setOption( "disabled", this.element.prop( "disabled" ) );
	},

	open: function( event ) {
		if ( this.options.disabled ) {
			return;
		}

		// If this is the first time the menu is being opened, render the items
		if ( !this.menuItems ) {
			this._refreshMenu();
		} else {

			// Menu clears focus on close, reset focus to selected item
			this.menu.find( ".ui-state-focus" ).removeClass( "ui-state-focus" );
			this.menuInstance.focus( null, this._getSelectedItem() );
		}

		this.isOpen = true;
		this._toggleAttr();
		this._resizeMenu();
		this._position();

		this._on( this.document, this._documentClick );

		this._trigger( "open", event );
	},

	_position: function() {
		this.menuWrap.position( $.extend( { of: this.button }, this.options.position ) );
	},

	close: function( event ) {
		if ( !this.isOpen ) {
			return;
		}

		this.isOpen = false;
		this._toggleAttr();

		this.range = null;
		this._off( this.document );

		this._trigger( "close", event );
	},

	widget: function() {
		return this.button;
	},

	menuWidget: function() {
		return this.menu;
	},

	_renderMenu: function( ul, items ) {
		var that = this,
			currentOptgroup = "";

		$.each( items, function( index, item ) {
			if ( item.optgroup !== currentOptgroup ) {
				$( "<li>", {
					"class": "ui-selectmenu-optgroup ui-menu-divider" +
						( item.element.parent( "optgroup" ).prop( "disabled" ) ?
							" ui-state-disabled" :
							"" ),
					text: item.optgroup
				})
					.appendTo( ul );

				currentOptgroup = item.optgroup;
			}

			that._renderItemData( ul, item );
		});
	},

	_renderItemData: function( ul, item ) {
		return this._renderItem( ul, item ).data( "ui-selectmenu-item", item );
	},

	_renderItem: function( ul, item ) {
		var li = $( "<li>" );

		if ( item.disabled ) {
			li.addClass( "ui-state-disabled" );
		}
		this._setText( li, item.label );

		return li.appendTo( ul );
	},

	_setText: function( element, value ) {
		if ( value ) {
			element.text( value );
		} else {
			element.html( "&#160;" );
		}
	},

	_move: function( direction, event ) {
		var item, next,
			filter = ".ui-menu-item";

		if ( this.isOpen ) {
			item = this.menuItems.eq( this.focusIndex );
		} else {
			item = this.menuItems.eq( this.element[ 0 ].selectedIndex );
			filter += ":not(.ui-state-disabled)";
		}

		if ( direction === "first" || direction === "last" ) {
			next = item[ direction === "first" ? "prevAll" : "nextAll" ]( filter ).eq( -1 );
		} else {
			next = item[ direction + "All" ]( filter ).eq( 0 );
		}

		if ( next.length ) {
			this.menuInstance.focus( event, next );
		}
	},

	_getSelectedItem: function() {
		return this.menuItems.eq( this.element[ 0 ].selectedIndex );
	},

	_toggle: function( event ) {
		this[ this.isOpen ? "close" : "open" ]( event );
	},

	_setSelection: function() {
		var selection;

		if ( !this.range ) {
			return;
		}

		if ( window.getSelection ) {
			selection = window.getSelection();
			selection.removeAllRanges();
			selection.addRange( this.range );

		// support: IE8
		} else {
			this.range.select();
		}

		// support: IE
		// Setting the text selection kills the button focus in IE, but
		// restoring the focus doesn't kill the selection.
		this.button.focus();
	},

	_documentClick: {
		mousedown: function( event ) {
			if ( !this.isOpen ) {
				return;
			}

			if ( !$( event.target ).closest( ".ui-selectmenu-menu, #" + this.ids.button ).length ) {
				this.close( event );
			}
		}
	},

	_buttonEvents: {

		// Prevent text selection from being reset when interacting with the selectmenu (#10144)
		mousedown: function() {
			var selection;

			if ( window.getSelection ) {
				selection = window.getSelection();
				if ( selection.rangeCount ) {
					this.range = selection.getRangeAt( 0 );
				}

			// support: IE8
			} else {
				this.range = document.selection.createRange();
			}
		},

		click: function( event ) {
			this._setSelection();
			this._toggle( event );
		},

		keydown: function( event ) {
			var preventDefault = true;
			switch ( event.keyCode ) {
				case $.ui.keyCode.TAB:
				case $.ui.keyCode.ESCAPE:
					this.close( event );
					preventDefault = false;
					break;
				case $.ui.keyCode.ENTER:
					if ( this.isOpen ) {
						this._selectFocusedItem( event );
					}
					break;
				case $.ui.keyCode.UP:
					if ( event.altKey ) {
						this._toggle( event );
					} else {
						this._move( "prev", event );
					}
					break;
				case $.ui.keyCode.DOWN:
					if ( event.altKey ) {
						this._toggle( event );
					} else {
						this._move( "next", event );
					}
					break;
				case $.ui.keyCode.SPACE:
					if ( this.isOpen ) {
						this._selectFocusedItem( event );
					} else {
						this._toggle( event );
					}
					break;
				case $.ui.keyCode.LEFT:
					this._move( "prev", event );
					break;
				case $.ui.keyCode.RIGHT:
					this._move( "next", event );
					break;
				case $.ui.keyCode.HOME:
				case $.ui.keyCode.PAGE_UP:
					this._move( "first", event );
					break;
				case $.ui.keyCode.END:
				case $.ui.keyCode.PAGE_DOWN:
					this._move( "last", event );
					break;
				default:
					this.menu.trigger( event );
					preventDefault = false;
			}

			if ( preventDefault ) {
				event.preventDefault();
			}
		}
	},

	_selectFocusedItem: function( event ) {
		var item = this.menuItems.eq( this.focusIndex );
		if ( !item.hasClass( "ui-state-disabled" ) ) {
			this._select( item.data( "ui-selectmenu-item" ), event );
		}
	},

	_select: function( item, event ) {
		var oldIndex = this.element[ 0 ].selectedIndex;

		// Change native select element
		this.element[ 0 ].selectedIndex = item.index;
		this._setText( this.buttonText, item.label );
		this._setAria( item );
		this._trigger( "select", event, { item: item } );

		if ( item.index !== oldIndex ) {
			this._trigger( "change", event, { item: item } );
		}

		this.close( event );
	},

	_setAria: function( item ) {
		var id = this.menuItems.eq( item.index ).attr( "id" );

		this.button.attr({
			"aria-labelledby": id,
			"aria-activedescendant": id
		});
		this.menu.attr( "aria-activedescendant", id );
	},

	_setOption: function( key, value ) {
		if ( key === "icons" ) {
			this.button.find( "span.ui-icon" )
				.removeClass( this.options.icons.button )
				.addClass( value.button );
		}

		this._super( key, value );

		if ( key === "appendTo" ) {
			this.menuWrap.appendTo( this._appendTo() );
		}

		if ( key === "disabled" ) {
			this.menuInstance.option( "disabled", value );
			this.button
				.toggleClass( "ui-state-disabled", value )
				.attr( "aria-disabled", value );

			this.element.prop( "disabled", value );
			if ( value ) {
				this.button.attr( "tabindex", -1 );
				this.close();
			} else {
				this.button.attr( "tabindex", 0 );
			}
		}

		if ( key === "width" ) {
			this._resizeButton();
		}
	},

	_appendTo: function() {
		var element = this.options.appendTo;

		if ( element ) {
			element = element.jquery || element.nodeType ?
				$( element ) :
				this.document.find( element ).eq( 0 );
		}

		if ( !element || !element[ 0 ] ) {
			element = this.element.closest( ".ui-front" );
		}

		if ( !element.length ) {
			element = this.document[ 0 ].body;
		}

		return element;
	},

	_toggleAttr: function() {
		this.button
			.toggleClass( "ui-corner-top", this.isOpen )
			.toggleClass( "ui-corner-all", !this.isOpen )
			.attr( "aria-expanded", this.isOpen );
		this.menuWrap.toggleClass( "ui-selectmenu-open", this.isOpen );
		this.menu.attr( "aria-hidden", !this.isOpen );
	},

	_resizeButton: function() {
		var width = this.options.width;

		if ( !width ) {
			width = this.element.show().outerWidth();
			this.element.hide();
		}

		this.button.outerWidth( width );
	},

	_resizeMenu: function() {
		this.menu.outerWidth( Math.max(
			this.button.outerWidth(),

			// support: IE10
			// IE10 wraps long text (possibly a rounding bug)
			// so we add 1px to avoid the wrapping
			this.menu.width( "" ).outerWidth() + 1
		) );
	},

	_getCreateOptions: function() {
		return { disabled: this.element.prop( "disabled" ) };
	},

	_parseOptions: function( options ) {
		var data = [];
		options.each(function( index, item ) {
			var option = $( item ),
				optgroup = option.parent( "optgroup" );
			data.push({
				element: option,
				index: index,
				value: option.val(),
				label: option.text(),
				optgroup: optgroup.attr( "label" ) || "",
				disabled: optgroup.prop( "disabled" ) || option.prop( "disabled" )
			});
		});
		this.items = data;
	},

	_destroy: function() {
		this.menuWrap.remove();
		this.button.remove();
		this.element.show();
		this.element.removeUniqueId();
		this.label.attr( "for", this.ids.element );
	}
});


/*!
 * jQuery UI Slider 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/slider/
 */


var slider = $.widget( "ui.slider", $.ui.mouse, {
	version: "1.11.4",
	widgetEventPrefix: "slide",

	options: {
		animate: false,
		distance: 0,
		max: 100,
		min: 0,
		orientation: "horizontal",
		range: false,
		step: 1,
		value: 0,
		values: null,

		// callbacks
		change: null,
		slide: null,
		start: null,
		stop: null
	},

	// number of pages in a slider
	// (how many times can you page up/down to go through the whole range)
	numPages: 5,

	_create: function() {
		this._keySliding = false;
		this._mouseSliding = false;
		this._animateOff = true;
		this._handleIndex = null;
		this._detectOrientation();
		this._mouseInit();
		this._calculateNewMax();

		this.element
			.addClass( "ui-slider" +
				" ui-slider-" + this.orientation +
				" ui-widget" +
				" ui-widget-content" +
				" ui-corner-all");

		this._refresh();
		this._setOption( "disabled", this.options.disabled );

		this._animateOff = false;
	},

	_refresh: function() {
		this._createRange();
		this._createHandles();
		this._setupEvents();
		this._refreshValue();
	},

	_createHandles: function() {
		var i, handleCount,
			options = this.options,
			existingHandles = this.element.find( ".ui-slider-handle" ).addClass( "ui-state-default ui-corner-all" ),
			handle = "<span class='ui-slider-handle ui-state-default ui-corner-all' tabindex='0'></span>",
			handles = [];

		handleCount = ( options.values && options.values.length ) || 1;

		if ( existingHandles.length > handleCount ) {
			existingHandles.slice( handleCount ).remove();
			existingHandles = existingHandles.slice( 0, handleCount );
		}

		for ( i = existingHandles.length; i < handleCount; i++ ) {
			handles.push( handle );
		}

		this.handles = existingHandles.add( $( handles.join( "" ) ).appendTo( this.element ) );

		this.handle = this.handles.eq( 0 );

		this.handles.each(function( i ) {
			$( this ).data( "ui-slider-handle-index", i );
		});
	},

	_createRange: function() {
		var options = this.options,
			classes = "";

		if ( options.range ) {
			if ( options.range === true ) {
				if ( !options.values ) {
					options.values = [ this._valueMin(), this._valueMin() ];
				} else if ( options.values.length && options.values.length !== 2 ) {
					options.values = [ options.values[0], options.values[0] ];
				} else if ( $.isArray( options.values ) ) {
					options.values = options.values.slice(0);
				}
			}

			if ( !this.range || !this.range.length ) {
				this.range = $( "<div></div>" )
					.appendTo( this.element );

				classes = "ui-slider-range" +
				// note: this isn't the most fittingly semantic framework class for this element,
				// but worked best visually with a variety of themes
				" ui-widget-header ui-corner-all";
			} else {
				this.range.removeClass( "ui-slider-range-min ui-slider-range-max" )
					// Handle range switching from true to min/max
					.css({
						"left": "",
						"bottom": ""
					});
			}

			this.range.addClass( classes +
				( ( options.range === "min" || options.range === "max" ) ? " ui-slider-range-" + options.range : "" ) );
		} else {
			if ( this.range ) {
				this.range.remove();
			}
			this.range = null;
		}
	},

	_setupEvents: function() {
		this._off( this.handles );
		this._on( this.handles, this._handleEvents );
		this._hoverable( this.handles );
		this._focusable( this.handles );
	},

	_destroy: function() {
		this.handles.remove();
		if ( this.range ) {
			this.range.remove();
		}

		this.element
			.removeClass( "ui-slider" +
				" ui-slider-horizontal" +
				" ui-slider-vertical" +
				" ui-widget" +
				" ui-widget-content" +
				" ui-corner-all" );

		this._mouseDestroy();
	},

	_mouseCapture: function( event ) {
		var position, normValue, distance, closestHandle, index, allowed, offset, mouseOverHandle,
			that = this,
			o = this.options;

		if ( o.disabled ) {
			return false;
		}

		this.elementSize = {
			width: this.element.outerWidth(),
			height: this.element.outerHeight()
		};
		this.elementOffset = this.element.offset();

		position = { x: event.pageX, y: event.pageY };
		normValue = this._normValueFromMouse( position );
		distance = this._valueMax() - this._valueMin() + 1;
		this.handles.each(function( i ) {
			var thisDistance = Math.abs( normValue - that.values(i) );
			if (( distance > thisDistance ) ||
				( distance === thisDistance &&
					(i === that._lastChangedValue || that.values(i) === o.min ))) {
				distance = thisDistance;
				closestHandle = $( this );
				index = i;
			}
		});

		allowed = this._start( event, index );
		if ( allowed === false ) {
			return false;
		}
		this._mouseSliding = true;

		this._handleIndex = index;

		closestHandle
			.addClass( "ui-state-active" )
			.focus();

		offset = closestHandle.offset();
		mouseOverHandle = !$( event.target ).parents().addBack().is( ".ui-slider-handle" );
		this._clickOffset = mouseOverHandle ? { left: 0, top: 0 } : {
			left: event.pageX - offset.left - ( closestHandle.width() / 2 ),
			top: event.pageY - offset.top -
				( closestHandle.height() / 2 ) -
				( parseInt( closestHandle.css("borderTopWidth"), 10 ) || 0 ) -
				( parseInt( closestHandle.css("borderBottomWidth"), 10 ) || 0) +
				( parseInt( closestHandle.css("marginTop"), 10 ) || 0)
		};

		if ( !this.handles.hasClass( "ui-state-hover" ) ) {
			this._slide( event, index, normValue );
		}
		this._animateOff = true;
		return true;
	},

	_mouseStart: function() {
		return true;
	},

	_mouseDrag: function( event ) {
		var position = { x: event.pageX, y: event.pageY },
			normValue = this._normValueFromMouse( position );

		this._slide( event, this._handleIndex, normValue );

		return false;
	},

	_mouseStop: function( event ) {
		this.handles.removeClass( "ui-state-active" );
		this._mouseSliding = false;

		this._stop( event, this._handleIndex );
		this._change( event, this._handleIndex );

		this._handleIndex = null;
		this._clickOffset = null;
		this._animateOff = false;

		return false;
	},

	_detectOrientation: function() {
		this.orientation = ( this.options.orientation === "vertical" ) ? "vertical" : "horizontal";
	},

	_normValueFromMouse: function( position ) {
		var pixelTotal,
			pixelMouse,
			percentMouse,
			valueTotal,
			valueMouse;

		if ( this.orientation === "horizontal" ) {
			pixelTotal = this.elementSize.width;
			pixelMouse = position.x - this.elementOffset.left - ( this._clickOffset ? this._clickOffset.left : 0 );
		} else {
			pixelTotal = this.elementSize.height;
			pixelMouse = position.y - this.elementOffset.top - ( this._clickOffset ? this._clickOffset.top : 0 );
		}

		percentMouse = ( pixelMouse / pixelTotal );
		if ( percentMouse > 1 ) {
			percentMouse = 1;
		}
		if ( percentMouse < 0 ) {
			percentMouse = 0;
		}
		if ( this.orientation === "vertical" ) {
			percentMouse = 1 - percentMouse;
		}

		valueTotal = this._valueMax() - this._valueMin();
		valueMouse = this._valueMin() + percentMouse * valueTotal;

		return this._trimAlignValue( valueMouse );
	},

	_start: function( event, index ) {
		var uiHash = {
			handle: this.handles[ index ],
			value: this.value()
		};
		if ( this.options.values && this.options.values.length ) {
			uiHash.value = this.values( index );
			uiHash.values = this.values();
		}
		return this._trigger( "start", event, uiHash );
	},

	_slide: function( event, index, newVal ) {
		var otherVal,
			newValues,
			allowed;

		if ( this.options.values && this.options.values.length ) {
			otherVal = this.values( index ? 0 : 1 );

			if ( ( this.options.values.length === 2 && this.options.range === true ) &&
					( ( index === 0 && newVal > otherVal) || ( index === 1 && newVal < otherVal ) )
				) {
				newVal = otherVal;
			}

			if ( newVal !== this.values( index ) ) {
				newValues = this.values();
				newValues[ index ] = newVal;
				// A slide can be canceled by returning false from the slide callback
				allowed = this._trigger( "slide", event, {
					handle: this.handles[ index ],
					value: newVal,
					values: newValues
				} );
				otherVal = this.values( index ? 0 : 1 );
				if ( allowed !== false ) {
					this.values( index, newVal );
				}
			}
		} else {
			if ( newVal !== this.value() ) {
				// A slide can be canceled by returning false from the slide callback
				allowed = this._trigger( "slide", event, {
					handle: this.handles[ index ],
					value: newVal
				} );
				if ( allowed !== false ) {
					this.value( newVal );
				}
			}
		}
	},

	_stop: function( event, index ) {
		var uiHash = {
			handle: this.handles[ index ],
			value: this.value()
		};
		if ( this.options.values && this.options.values.length ) {
			uiHash.value = this.values( index );
			uiHash.values = this.values();
		}

		this._trigger( "stop", event, uiHash );
	},

	_change: function( event, index ) {
		if ( !this._keySliding && !this._mouseSliding ) {
			var uiHash = {
				handle: this.handles[ index ],
				value: this.value()
			};
			if ( this.options.values && this.options.values.length ) {
				uiHash.value = this.values( index );
				uiHash.values = this.values();
			}

			//store the last changed value index for reference when handles overlap
			this._lastChangedValue = index;

			this._trigger( "change", event, uiHash );
		}
	},

	value: function( newValue ) {
		if ( arguments.length ) {
			this.options.value = this._trimAlignValue( newValue );
			this._refreshValue();
			this._change( null, 0 );
			return;
		}

		return this._value();
	},

	values: function( index, newValue ) {
		var vals,
			newValues,
			i;

		if ( arguments.length > 1 ) {
			this.options.values[ index ] = this._trimAlignValue( newValue );
			this._refreshValue();
			this._change( null, index );
			return;
		}

		if ( arguments.length ) {
			if ( $.isArray( arguments[ 0 ] ) ) {
				vals = this.options.values;
				newValues = arguments[ 0 ];
				for ( i = 0; i < vals.length; i += 1 ) {
					vals[ i ] = this._trimAlignValue( newValues[ i ] );
					this._change( null, i );
				}
				this._refreshValue();
			} else {
				if ( this.options.values && this.options.values.length ) {
					return this._values( index );
				} else {
					return this.value();
				}
			}
		} else {
			return this._values();
		}
	},

	_setOption: function( key, value ) {
		var i,
			valsLength = 0;

		if ( key === "range" && this.options.range === true ) {
			if ( value === "min" ) {
				this.options.value = this._values( 0 );
				this.options.values = null;
			} else if ( value === "max" ) {
				this.options.value = this._values( this.options.values.length - 1 );
				this.options.values = null;
			}
		}

		if ( $.isArray( this.options.values ) ) {
			valsLength = this.options.values.length;
		}

		if ( key === "disabled" ) {
			this.element.toggleClass( "ui-state-disabled", !!value );
		}

		this._super( key, value );

		switch ( key ) {
			case "orientation":
				this._detectOrientation();
				this.element
					.removeClass( "ui-slider-horizontal ui-slider-vertical" )
					.addClass( "ui-slider-" + this.orientation );
				this._refreshValue();

				// Reset positioning from previous orientation
				this.handles.css( value === "horizontal" ? "bottom" : "left", "" );
				break;
			case "value":
				this._animateOff = true;
				this._refreshValue();
				this._change( null, 0 );
				this._animateOff = false;
				break;
			case "values":
				this._animateOff = true;
				this._refreshValue();
				for ( i = 0; i < valsLength; i += 1 ) {
					this._change( null, i );
				}
				this._animateOff = false;
				break;
			case "step":
			case "min":
			case "max":
				this._animateOff = true;
				this._calculateNewMax();
				this._refreshValue();
				this._animateOff = false;
				break;
			case "range":
				this._animateOff = true;
				this._refresh();
				this._animateOff = false;
				break;
		}
	},

	//internal value getter
	// _value() returns value trimmed by min and max, aligned by step
	_value: function() {
		var val = this.options.value;
		val = this._trimAlignValue( val );

		return val;
	},

	//internal values getter
	// _values() returns array of values trimmed by min and max, aligned by step
	// _values( index ) returns single value trimmed by min and max, aligned by step
	_values: function( index ) {
		var val,
			vals,
			i;

		if ( arguments.length ) {
			val = this.options.values[ index ];
			val = this._trimAlignValue( val );

			return val;
		} else if ( this.options.values && this.options.values.length ) {
			// .slice() creates a copy of the array
			// this copy gets trimmed by min and max and then returned
			vals = this.options.values.slice();
			for ( i = 0; i < vals.length; i += 1) {
				vals[ i ] = this._trimAlignValue( vals[ i ] );
			}

			return vals;
		} else {
			return [];
		}
	},

	// returns the step-aligned value that val is closest to, between (inclusive) min and max
	_trimAlignValue: function( val ) {
		if ( val <= this._valueMin() ) {
			return this._valueMin();
		}
		if ( val >= this._valueMax() ) {
			return this._valueMax();
		}
		var step = ( this.options.step > 0 ) ? this.options.step : 1,
			valModStep = (val - this._valueMin()) % step,
			alignValue = val - valModStep;

		if ( Math.abs(valModStep) * 2 >= step ) {
			alignValue += ( valModStep > 0 ) ? step : ( -step );
		}

		// Since JavaScript has problems with large floats, round
		// the final value to 5 digits after the decimal point (see #4124)
		return parseFloat( alignValue.toFixed(5) );
	},

	_calculateNewMax: function() {
		var max = this.options.max,
			min = this._valueMin(),
			step = this.options.step,
			aboveMin = Math.floor( ( +( max - min ).toFixed( this._precision() ) ) / step ) * step;
		max = aboveMin + min;
		this.max = parseFloat( max.toFixed( this._precision() ) );
	},

	_precision: function() {
		var precision = this._precisionOf( this.options.step );
		if ( this.options.min !== null ) {
			precision = Math.max( precision, this._precisionOf( this.options.min ) );
		}
		return precision;
	},

	_precisionOf: function( num ) {
		var str = num.toString(),
			decimal = str.indexOf( "." );
		return decimal === -1 ? 0 : str.length - decimal - 1;
	},

	_valueMin: function() {
		return this.options.min;
	},

	_valueMax: function() {
		return this.max;
	},

	_refreshValue: function() {
		var lastValPercent, valPercent, value, valueMin, valueMax,
			oRange = this.options.range,
			o = this.options,
			that = this,
			animate = ( !this._animateOff ) ? o.animate : false,
			_set = {};

		if ( this.options.values && this.options.values.length ) {
			this.handles.each(function( i ) {
				valPercent = ( that.values(i) - that._valueMin() ) / ( that._valueMax() - that._valueMin() ) * 100;
				_set[ that.orientation === "horizontal" ? "left" : "bottom" ] = valPercent + "%";
				$( this ).stop( 1, 1 )[ animate ? "animate" : "css" ]( _set, o.animate );
				if ( that.options.range === true ) {
					if ( that.orientation === "horizontal" ) {
						if ( i === 0 ) {
							that.range.stop( 1, 1 )[ animate ? "animate" : "css" ]( { left: valPercent + "%" }, o.animate );
						}
						if ( i === 1 ) {
							that.range[ animate ? "animate" : "css" ]( { width: ( valPercent - lastValPercent ) + "%" }, { queue: false, duration: o.animate } );
						}
					} else {
						if ( i === 0 ) {
							that.range.stop( 1, 1 )[ animate ? "animate" : "css" ]( { bottom: ( valPercent ) + "%" }, o.animate );
						}
						if ( i === 1 ) {
							that.range[ animate ? "animate" : "css" ]( { height: ( valPercent - lastValPercent ) + "%" }, { queue: false, duration: o.animate } );
						}
					}
				}
				lastValPercent = valPercent;
			});
		} else {
			value = this.value();
			valueMin = this._valueMin();
			valueMax = this._valueMax();
			valPercent = ( valueMax !== valueMin ) ?
					( value - valueMin ) / ( valueMax - valueMin ) * 100 :
					0;
			_set[ this.orientation === "horizontal" ? "left" : "bottom" ] = valPercent + "%";
			this.handle.stop( 1, 1 )[ animate ? "animate" : "css" ]( _set, o.animate );

			if ( oRange === "min" && this.orientation === "horizontal" ) {
				this.range.stop( 1, 1 )[ animate ? "animate" : "css" ]( { width: valPercent + "%" }, o.animate );
			}
			if ( oRange === "max" && this.orientation === "horizontal" ) {
				this.range[ animate ? "animate" : "css" ]( { width: ( 100 - valPercent ) + "%" }, { queue: false, duration: o.animate } );
			}
			if ( oRange === "min" && this.orientation === "vertical" ) {
				this.range.stop( 1, 1 )[ animate ? "animate" : "css" ]( { height: valPercent + "%" }, o.animate );
			}
			if ( oRange === "max" && this.orientation === "vertical" ) {
				this.range[ animate ? "animate" : "css" ]( { height: ( 100 - valPercent ) + "%" }, { queue: false, duration: o.animate } );
			}
		}
	},

	_handleEvents: {
		keydown: function( event ) {
			var allowed, curVal, newVal, step,
				index = $( event.target ).data( "ui-slider-handle-index" );

			switch ( event.keyCode ) {
				case $.ui.keyCode.HOME:
				case $.ui.keyCode.END:
				case $.ui.keyCode.PAGE_UP:
				case $.ui.keyCode.PAGE_DOWN:
				case $.ui.keyCode.UP:
				case $.ui.keyCode.RIGHT:
				case $.ui.keyCode.DOWN:
				case $.ui.keyCode.LEFT:
					event.preventDefault();
					if ( !this._keySliding ) {
						this._keySliding = true;
						$( event.target ).addClass( "ui-state-active" );
						allowed = this._start( event, index );
						if ( allowed === false ) {
							return;
						}
					}
					break;
			}

			step = this.options.step;
			if ( this.options.values && this.options.values.length ) {
				curVal = newVal = this.values( index );
			} else {
				curVal = newVal = this.value();
			}

			switch ( event.keyCode ) {
				case $.ui.keyCode.HOME:
					newVal = this._valueMin();
					break;
				case $.ui.keyCode.END:
					newVal = this._valueMax();
					break;
				case $.ui.keyCode.PAGE_UP:
					newVal = this._trimAlignValue(
						curVal + ( ( this._valueMax() - this._valueMin() ) / this.numPages )
					);
					break;
				case $.ui.keyCode.PAGE_DOWN:
					newVal = this._trimAlignValue(
						curVal - ( (this._valueMax() - this._valueMin()) / this.numPages ) );
					break;
				case $.ui.keyCode.UP:
				case $.ui.keyCode.RIGHT:
					if ( curVal === this._valueMax() ) {
						return;
					}
					newVal = this._trimAlignValue( curVal + step );
					break;
				case $.ui.keyCode.DOWN:
				case $.ui.keyCode.LEFT:
					if ( curVal === this._valueMin() ) {
						return;
					}
					newVal = this._trimAlignValue( curVal - step );
					break;
			}

			this._slide( event, index, newVal );
		},
		keyup: function( event ) {
			var index = $( event.target ).data( "ui-slider-handle-index" );

			if ( this._keySliding ) {
				this._keySliding = false;
				this._stop( event, index );
				this._change( event, index );
				$( event.target ).removeClass( "ui-state-active" );
			}
		}
	}
});


/*!
 * jQuery UI Sortable 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/sortable/
 */


var sortable = $.widget("ui.sortable", $.ui.mouse, {
	version: "1.11.4",
	widgetEventPrefix: "sort",
	ready: false,
	options: {
		appendTo: "parent",
		axis: false,
		connectWith: false,
		containment: false,
		cursor: "auto",
		cursorAt: false,
		dropOnEmpty: true,
		forcePlaceholderSize: false,
		forceHelperSize: false,
		grid: false,
		handle: false,
		helper: "original",
		items: "> *",
		opacity: false,
		placeholder: false,
		revert: false,
		scroll: true,
		scrollSensitivity: 20,
		scrollSpeed: 20,
		scope: "default",
		tolerance: "intersect",
		zIndex: 1000,

		// callbacks
		activate: null,
		beforeStop: null,
		change: null,
		deactivate: null,
		out: null,
		over: null,
		receive: null,
		remove: null,
		sort: null,
		start: null,
		stop: null,
		update: null
	},

	_isOverAxis: function( x, reference, size ) {
		return ( x >= reference ) && ( x < ( reference + size ) );
	},

	_isFloating: function( item ) {
		return (/left|right/).test(item.css("float")) || (/inline|table-cell/).test(item.css("display"));
	},

	_create: function() {
		this.containerCache = {};
		this.element.addClass("ui-sortable");

		//Get the items
		this.refresh();

		//Let's determine the parent's offset
		this.offset = this.element.offset();

		//Initialize mouse events for interaction
		this._mouseInit();

		this._setHandleClassName();

		//We're ready to go
		this.ready = true;

	},

	_setOption: function( key, value ) {
		this._super( key, value );

		if ( key === "handle" ) {
			this._setHandleClassName();
		}
	},

	_setHandleClassName: function() {
		this.element.find( ".ui-sortable-handle" ).removeClass( "ui-sortable-handle" );
		$.each( this.items, function() {
			( this.instance.options.handle ?
				this.item.find( this.instance.options.handle ) : this.item )
				.addClass( "ui-sortable-handle" );
		});
	},

	_destroy: function() {
		this.element
			.removeClass( "ui-sortable ui-sortable-disabled" )
			.find( ".ui-sortable-handle" )
				.removeClass( "ui-sortable-handle" );
		this._mouseDestroy();

		for ( var i = this.items.length - 1; i >= 0; i-- ) {
			this.items[i].item.removeData(this.widgetName + "-item");
		}

		return this;
	},

	_mouseCapture: function(event, overrideHandle) {
		var currentItem = null,
			validHandle = false,
			that = this;

		if (this.reverting) {
			return false;
		}

		if(this.options.disabled || this.options.type === "static") {
			return false;
		}

		//We have to refresh the items data once first
		this._refreshItems(event);

		//Find out if the clicked node (or one of its parents) is a actual item in this.items
		$(event.target).parents().each(function() {
			if($.data(this, that.widgetName + "-item") === that) {
				currentItem = $(this);
				return false;
			}
		});
		if($.data(event.target, that.widgetName + "-item") === that) {
			currentItem = $(event.target);
		}

		if(!currentItem) {
			return false;
		}
		if(this.options.handle && !overrideHandle) {
			$(this.options.handle, currentItem).find("*").addBack().each(function() {
				if(this === event.target) {
					validHandle = true;
				}
			});
			if(!validHandle) {
				return false;
			}
		}

		this.currentItem = currentItem;
		this._removeCurrentsFromItems();
		return true;

	},

	_mouseStart: function(event, overrideHandle, noActivation) {

		var i, body,
			o = this.options;

		this.currentContainer = this;

		//We only need to call refreshPositions, because the refreshItems call has been moved to mouseCapture
		this.refreshPositions();

		//Create and append the visible helper
		this.helper = this._createHelper(event);

		//Cache the helper size
		this._cacheHelperProportions();

		/*
		 * - Position generation -
		 * This block generates everything position related - it's the core of draggables.
		 */

		//Cache the margins of the original element
		this._cacheMargins();

		//Get the next scrolling parent
		this.scrollParent = this.helper.scrollParent();

		//The element's absolute position on the page minus margins
		this.offset = this.currentItem.offset();
		this.offset = {
			top: this.offset.top - this.margins.top,
			left: this.offset.left - this.margins.left
		};

		$.extend(this.offset, {
			click: { //Where the click happened, relative to the element
				left: event.pageX - this.offset.left,
				top: event.pageY - this.offset.top
			},
			parent: this._getParentOffset(),
			relative: this._getRelativeOffset() //This is a relative to absolute position minus the actual position calculation - only used for relative positioned helper
		});

		// Only after we got the offset, we can change the helper's position to absolute
		// TODO: Still need to figure out a way to make relative sorting possible
		this.helper.css("position", "absolute");
		this.cssPosition = this.helper.css("position");

		//Generate the original position
		this.originalPosition = this._generatePosition(event);
		this.originalPageX = event.pageX;
		this.originalPageY = event.pageY;

		//Adjust the mouse offset relative to the helper if "cursorAt" is supplied
		(o.cursorAt && this._adjustOffsetFromHelper(o.cursorAt));

		//Cache the former DOM position
		this.domPosition = { prev: this.currentItem.prev()[0], parent: this.currentItem.parent()[0] };

		//If the helper is not the original, hide the original so it's not playing any role during the drag, won't cause anything bad this way
		if(this.helper[0] !== this.currentItem[0]) {
			this.currentItem.hide();
		}

		//Create the placeholder
		this._createPlaceholder();

		//Set a containment if given in the options
		if(o.containment) {
			this._setContainment();
		}

		if( o.cursor && o.cursor !== "auto" ) { // cursor option
			body = this.document.find( "body" );

			// support: IE
			this.storedCursor = body.css( "cursor" );
			body.css( "cursor", o.cursor );

			this.storedStylesheet = $( "<style>*{ cursor: "+o.cursor+" !important; }</style>" ).appendTo( body );
		}

		if(o.opacity) { // opacity option
			if (this.helper.css("opacity")) {
				this._storedOpacity = this.helper.css("opacity");
			}
			this.helper.css("opacity", o.opacity);
		}

		if(o.zIndex) { // zIndex option
			if (this.helper.css("zIndex")) {
				this._storedZIndex = this.helper.css("zIndex");
			}
			this.helper.css("zIndex", o.zIndex);
		}

		//Prepare scrolling
		if(this.scrollParent[0] !== this.document[0] && this.scrollParent[0].tagName !== "HTML") {
			this.overflowOffset = this.scrollParent.offset();
		}

		//Call callbacks
		this._trigger("start", event, this._uiHash());

		//Recache the helper size
		if(!this._preserveHelperProportions) {
			this._cacheHelperProportions();
		}


		//Post "activate" events to possible containers
		if( !noActivation ) {
			for ( i = this.containers.length - 1; i >= 0; i-- ) {
				this.containers[ i ]._trigger( "activate", event, this._uiHash( this ) );
			}
		}

		//Prepare possible droppables
		if($.ui.ddmanager) {
			$.ui.ddmanager.current = this;
		}

		if ($.ui.ddmanager && !o.dropBehaviour) {
			$.ui.ddmanager.prepareOffsets(this, event);
		}

		this.dragging = true;

		this.helper.addClass("ui-sortable-helper");
		this._mouseDrag(event); //Execute the drag once - this causes the helper not to be visible before getting its correct position
		return true;

	},

	_mouseDrag: function(event) {
		var i, item, itemElement, intersection,
			o = this.options,
			scrolled = false;

		//Compute the helpers position
		this.position = this._generatePosition(event);
		this.positionAbs = this._convertPositionTo("absolute");

		if (!this.lastPositionAbs) {
			this.lastPositionAbs = this.positionAbs;
		}

		//Do scrolling
		if(this.options.scroll) {
			if(this.scrollParent[0] !== this.document[0] && this.scrollParent[0].tagName !== "HTML") {

				if((this.overflowOffset.top + this.scrollParent[0].offsetHeight) - event.pageY < o.scrollSensitivity) {
					this.scrollParent[0].scrollTop = scrolled = this.scrollParent[0].scrollTop + o.scrollSpeed;
				} else if(event.pageY - this.overflowOffset.top < o.scrollSensitivity) {
					this.scrollParent[0].scrollTop = scrolled = this.scrollParent[0].scrollTop - o.scrollSpeed;
				}

				if((this.overflowOffset.left + this.scrollParent[0].offsetWidth) - event.pageX < o.scrollSensitivity) {
					this.scrollParent[0].scrollLeft = scrolled = this.scrollParent[0].scrollLeft + o.scrollSpeed;
				} else if(event.pageX - this.overflowOffset.left < o.scrollSensitivity) {
					this.scrollParent[0].scrollLeft = scrolled = this.scrollParent[0].scrollLeft - o.scrollSpeed;
				}

			} else {

				if(event.pageY - this.document.scrollTop() < o.scrollSensitivity) {
					scrolled = this.document.scrollTop(this.document.scrollTop() - o.scrollSpeed);
				} else if(this.window.height() - (event.pageY - this.document.scrollTop()) < o.scrollSensitivity) {
					scrolled = this.document.scrollTop(this.document.scrollTop() + o.scrollSpeed);
				}

				if(event.pageX - this.document.scrollLeft() < o.scrollSensitivity) {
					scrolled = this.document.scrollLeft(this.document.scrollLeft() - o.scrollSpeed);
				} else if(this.window.width() - (event.pageX - this.document.scrollLeft()) < o.scrollSensitivity) {
					scrolled = this.document.scrollLeft(this.document.scrollLeft() + o.scrollSpeed);
				}

			}

			if(scrolled !== false && $.ui.ddmanager && !o.dropBehaviour) {
				$.ui.ddmanager.prepareOffsets(this, event);
			}
		}

		//Regenerate the absolute position used for position checks
		this.positionAbs = this._convertPositionTo("absolute");

		//Set the helper position
		if(!this.options.axis || this.options.axis !== "y") {
			this.helper[0].style.left = this.position.left+"px";
		}
		if(!this.options.axis || this.options.axis !== "x") {
			this.helper[0].style.top = this.position.top+"px";
		}

		//Rearrange
		for (i = this.items.length - 1; i >= 0; i--) {

			//Cache variables and intersection, continue if no intersection
			item = this.items[i];
			itemElement = item.item[0];
			intersection = this._intersectsWithPointer(item);
			if (!intersection) {
				continue;
			}

			// Only put the placeholder inside the current Container, skip all
			// items from other containers. This works because when moving
			// an item from one container to another the
			// currentContainer is switched before the placeholder is moved.
			//
			// Without this, moving items in "sub-sortables" can cause
			// the placeholder to jitter between the outer and inner container.
			if (item.instance !== this.currentContainer) {
				continue;
			}

			// cannot intersect with itself
			// no useless actions that have been done before
			// no action if the item moved is the parent of the item checked
			if (itemElement !== this.currentItem[0] &&
				this.placeholder[intersection === 1 ? "next" : "prev"]()[0] !== itemElement &&
				!$.contains(this.placeholder[0], itemElement) &&
				(this.options.type === "semi-dynamic" ? !$.contains(this.element[0], itemElement) : true)
			) {

				this.direction = intersection === 1 ? "down" : "up";

				if (this.options.tolerance === "pointer" || this._intersectsWithSides(item)) {
					this._rearrange(event, item);
				} else {
					break;
				}

				this._trigger("change", event, this._uiHash());
				break;
			}
		}

		//Post events to containers
		this._contactContainers(event);

		//Interconnect with droppables
		if($.ui.ddmanager) {
			$.ui.ddmanager.drag(this, event);
		}

		//Call callbacks
		this._trigger("sort", event, this._uiHash());

		this.lastPositionAbs = this.positionAbs;
		return false;

	},

	_mouseStop: function(event, noPropagation) {

		if(!event) {
			return;
		}

		//If we are using droppables, inform the manager about the drop
		if ($.ui.ddmanager && !this.options.dropBehaviour) {
			$.ui.ddmanager.drop(this, event);
		}

		if(this.options.revert) {
			var that = this,
				cur = this.placeholder.offset(),
				axis = this.options.axis,
				animation = {};

			if ( !axis || axis === "x" ) {
				animation.left = cur.left - this.offset.parent.left - this.margins.left + (this.offsetParent[0] === this.document[0].body ? 0 : this.offsetParent[0].scrollLeft);
			}
			if ( !axis || axis === "y" ) {
				animation.top = cur.top - this.offset.parent.top - this.margins.top + (this.offsetParent[0] === this.document[0].body ? 0 : this.offsetParent[0].scrollTop);
			}
			this.reverting = true;
			$(this.helper).animate( animation, parseInt(this.options.revert, 10) || 500, function() {
				that._clear(event);
			});
		} else {
			this._clear(event, noPropagation);
		}

		return false;

	},

	cancel: function() {

		if(this.dragging) {

			this._mouseUp({ target: null });

			if(this.options.helper === "original") {
				this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper");
			} else {
				this.currentItem.show();
			}

			//Post deactivating events to containers
			for (var i = this.containers.length - 1; i >= 0; i--){
				this.containers[i]._trigger("deactivate", null, this._uiHash(this));
				if(this.containers[i].containerCache.over) {
					this.containers[i]._trigger("out", null, this._uiHash(this));
					this.containers[i].containerCache.over = 0;
				}
			}

		}

		if (this.placeholder) {
			//$(this.placeholder[0]).remove(); would have been the jQuery way - unfortunately, it unbinds ALL events from the original node!
			if(this.placeholder[0].parentNode) {
				this.placeholder[0].parentNode.removeChild(this.placeholder[0]);
			}
			if(this.options.helper !== "original" && this.helper && this.helper[0].parentNode) {
				this.helper.remove();
			}

			$.extend(this, {
				helper: null,
				dragging: false,
				reverting: false,
				_noFinalSort: null
			});

			if(this.domPosition.prev) {
				$(this.domPosition.prev).after(this.currentItem);
			} else {
				$(this.domPosition.parent).prepend(this.currentItem);
			}
		}

		return this;

	},

	serialize: function(o) {

		var items = this._getItemsAsjQuery(o && o.connected),
			str = [];
		o = o || {};

		$(items).each(function() {
			var res = ($(o.item || this).attr(o.attribute || "id") || "").match(o.expression || (/(.+)[\-=_](.+)/));
			if (res) {
				str.push((o.key || res[1]+"[]")+"="+(o.key && o.expression ? res[1] : res[2]));
			}
		});

		if(!str.length && o.key) {
			str.push(o.key + "=");
		}

		return str.join("&");

	},

	toArray: function(o) {

		var items = this._getItemsAsjQuery(o && o.connected),
			ret = [];

		o = o || {};

		items.each(function() { ret.push($(o.item || this).attr(o.attribute || "id") || ""); });
		return ret;

	},

	/* Be careful with the following core functions */
	_intersectsWith: function(item) {

		var x1 = this.positionAbs.left,
			x2 = x1 + this.helperProportions.width,
			y1 = this.positionAbs.top,
			y2 = y1 + this.helperProportions.height,
			l = item.left,
			r = l + item.width,
			t = item.top,
			b = t + item.height,
			dyClick = this.offset.click.top,
			dxClick = this.offset.click.left,
			isOverElementHeight = ( this.options.axis === "x" ) || ( ( y1 + dyClick ) > t && ( y1 + dyClick ) < b ),
			isOverElementWidth = ( this.options.axis === "y" ) || ( ( x1 + dxClick ) > l && ( x1 + dxClick ) < r ),
			isOverElement = isOverElementHeight && isOverElementWidth;

		if ( this.options.tolerance === "pointer" ||
			this.options.forcePointerForContainers ||
			(this.options.tolerance !== "pointer" && this.helperProportions[this.floating ? "width" : "height"] > item[this.floating ? "width" : "height"])
		) {
			return isOverElement;
		} else {

			return (l < x1 + (this.helperProportions.width / 2) && // Right Half
				x2 - (this.helperProportions.width / 2) < r && // Left Half
				t < y1 + (this.helperProportions.height / 2) && // Bottom Half
				y2 - (this.helperProportions.height / 2) < b ); // Top Half

		}
	},

	_intersectsWithPointer: function(item) {

		var isOverElementHeight = (this.options.axis === "x") || this._isOverAxis(this.positionAbs.top + this.offset.click.top, item.top, item.height),
			isOverElementWidth = (this.options.axis === "y") || this._isOverAxis(this.positionAbs.left + this.offset.click.left, item.left, item.width),
			isOverElement = isOverElementHeight && isOverElementWidth,
			verticalDirection = this._getDragVerticalDirection(),
			horizontalDirection = this._getDragHorizontalDirection();

		if (!isOverElement) {
			return false;
		}

		return this.floating ?
			( ((horizontalDirection && horizontalDirection === "right") || verticalDirection === "down") ? 2 : 1 )
			: ( verticalDirection && (verticalDirection === "down" ? 2 : 1) );

	},

	_intersectsWithSides: function(item) {

		var isOverBottomHalf = this._isOverAxis(this.positionAbs.top + this.offset.click.top, item.top + (item.height/2), item.height),
			isOverRightHalf = this._isOverAxis(this.positionAbs.left + this.offset.click.left, item.left + (item.width/2), item.width),
			verticalDirection = this._getDragVerticalDirection(),
			horizontalDirection = this._getDragHorizontalDirection();

		if (this.floating && horizontalDirection) {
			return ((horizontalDirection === "right" && isOverRightHalf) || (horizontalDirection === "left" && !isOverRightHalf));
		} else {
			return verticalDirection && ((verticalDirection === "down" && isOverBottomHalf) || (verticalDirection === "up" && !isOverBottomHalf));
		}

	},

	_getDragVerticalDirection: function() {
		var delta = this.positionAbs.top - this.lastPositionAbs.top;
		return delta !== 0 && (delta > 0 ? "down" : "up");
	},

	_getDragHorizontalDirection: function() {
		var delta = this.positionAbs.left - this.lastPositionAbs.left;
		return delta !== 0 && (delta > 0 ? "right" : "left");
	},

	refresh: function(event) {
		this._refreshItems(event);
		this._setHandleClassName();
		this.refreshPositions();
		return this;
	},

	_connectWith: function() {
		var options = this.options;
		return options.connectWith.constructor === String ? [options.connectWith] : options.connectWith;
	},

	_getItemsAsjQuery: function(connected) {

		var i, j, cur, inst,
			items = [],
			queries = [],
			connectWith = this._connectWith();

		if(connectWith && connected) {
			for (i = connectWith.length - 1; i >= 0; i--){
				cur = $(connectWith[i], this.document[0]);
				for ( j = cur.length - 1; j >= 0; j--){
					inst = $.data(cur[j], this.widgetFullName);
					if(inst && inst !== this && !inst.options.disabled) {
						queries.push([$.isFunction(inst.options.items) ? inst.options.items.call(inst.element) : $(inst.options.items, inst.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"), inst]);
					}
				}
			}
		}

		queries.push([$.isFunction(this.options.items) ? this.options.items.call(this.element, null, { options: this.options, item: this.currentItem }) : $(this.options.items, this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"), this]);

		function addItems() {
			items.push( this );
		}
		for (i = queries.length - 1; i >= 0; i--){
			queries[i][0].each( addItems );
		}

		return $(items);

	},

	_removeCurrentsFromItems: function() {

		var list = this.currentItem.find(":data(" + this.widgetName + "-item)");

		this.items = $.grep(this.items, function (item) {
			for (var j=0; j < list.length; j++) {
				if(list[j] === item.item[0]) {
					return false;
				}
			}
			return true;
		});

	},

	_refreshItems: function(event) {

		this.items = [];
		this.containers = [this];

		var i, j, cur, inst, targetData, _queries, item, queriesLength,
			items = this.items,
			queries = [[$.isFunction(this.options.items) ? this.options.items.call(this.element[0], event, { item: this.currentItem }) : $(this.options.items, this.element), this]],
			connectWith = this._connectWith();

		if(connectWith && this.ready) { //Shouldn't be run the first time through due to massive slow-down
			for (i = connectWith.length - 1; i >= 0; i--){
				cur = $(connectWith[i], this.document[0]);
				for (j = cur.length - 1; j >= 0; j--){
					inst = $.data(cur[j], this.widgetFullName);
					if(inst && inst !== this && !inst.options.disabled) {
						queries.push([$.isFunction(inst.options.items) ? inst.options.items.call(inst.element[0], event, { item: this.currentItem }) : $(inst.options.items, inst.element), inst]);
						this.containers.push(inst);
					}
				}
			}
		}

		for (i = queries.length - 1; i >= 0; i--) {
			targetData = queries[i][1];
			_queries = queries[i][0];

			for (j=0, queriesLength = _queries.length; j < queriesLength; j++) {
				item = $(_queries[j]);

				item.data(this.widgetName + "-item", targetData); // Data for target checking (mouse manager)

				items.push({
					item: item,
					instance: targetData,
					width: 0, height: 0,
					left: 0, top: 0
				});
			}
		}

	},

	refreshPositions: function(fast) {

		// Determine whether items are being displayed horizontally
		this.floating = this.items.length ?
			this.options.axis === "x" || this._isFloating( this.items[ 0 ].item ) :
			false;

		//This has to be redone because due to the item being moved out/into the offsetParent, the offsetParent's position will change
		if(this.offsetParent && this.helper) {
			this.offset.parent = this._getParentOffset();
		}

		var i, item, t, p;

		for (i = this.items.length - 1; i >= 0; i--){
			item = this.items[i];

			//We ignore calculating positions of all connected containers when we're not over them
			if(item.instance !== this.currentContainer && this.currentContainer && item.item[0] !== this.currentItem[0]) {
				continue;
			}

			t = this.options.toleranceElement ? $(this.options.toleranceElement, item.item) : item.item;

			if (!fast) {
				item.width = t.outerWidth();
				item.height = t.outerHeight();
			}

			p = t.offset();
			item.left = p.left;
			item.top = p.top;
		}

		if(this.options.custom && this.options.custom.refreshContainers) {
			this.options.custom.refreshContainers.call(this);
		} else {
			for (i = this.containers.length - 1; i >= 0; i--){
				p = this.containers[i].element.offset();
				this.containers[i].containerCache.left = p.left;
				this.containers[i].containerCache.top = p.top;
				this.containers[i].containerCache.width = this.containers[i].element.outerWidth();
				this.containers[i].containerCache.height = this.containers[i].element.outerHeight();
			}
		}

		return this;
	},

	_createPlaceholder: function(that) {
		that = that || this;
		var className,
			o = that.options;

		if(!o.placeholder || o.placeholder.constructor === String) {
			className = o.placeholder;
			o.placeholder = {
				element: function() {

					var nodeName = that.currentItem[0].nodeName.toLowerCase(),
						element = $( "<" + nodeName + ">", that.document[0] )
							.addClass(className || that.currentItem[0].className+" ui-sortable-placeholder")
							.removeClass("ui-sortable-helper");

					if ( nodeName === "tbody" ) {
						that._createTrPlaceholder(
							that.currentItem.find( "tr" ).eq( 0 ),
							$( "<tr>", that.document[ 0 ] ).appendTo( element )
						);
					} else if ( nodeName === "tr" ) {
						that._createTrPlaceholder( that.currentItem, element );
					} else if ( nodeName === "img" ) {
						element.attr( "src", that.currentItem.attr( "src" ) );
					}

					if ( !className ) {
						element.css( "visibility", "hidden" );
					}

					return element;
				},
				update: function(container, p) {

					// 1. If a className is set as 'placeholder option, we don't force sizes - the class is responsible for that
					// 2. The option 'forcePlaceholderSize can be enabled to force it even if a class name is specified
					if(className && !o.forcePlaceholderSize) {
						return;
					}

					//If the element doesn't have a actual height by itself (without styles coming from a stylesheet), it receives the inline height from the dragged item
					if(!p.height()) { p.height(that.currentItem.innerHeight() - parseInt(that.currentItem.css("paddingTop")||0, 10) - parseInt(that.currentItem.css("paddingBottom")||0, 10)); }
					if(!p.width()) { p.width(that.currentItem.innerWidth() - parseInt(that.currentItem.css("paddingLeft")||0, 10) - parseInt(that.currentItem.css("paddingRight")||0, 10)); }
				}
			};
		}

		//Create the placeholder
		that.placeholder = $(o.placeholder.element.call(that.element, that.currentItem));

		//Append it after the actual current item
		that.currentItem.after(that.placeholder);

		//Update the size of the placeholder (TODO: Logic to fuzzy, see line 316/317)
		o.placeholder.update(that, that.placeholder);

	},

	_createTrPlaceholder: function( sourceTr, targetTr ) {
		var that = this;

		sourceTr.children().each(function() {
			$( "<td>&#160;</td>", that.document[ 0 ] )
				.attr( "colspan", $( this ).attr( "colspan" ) || 1 )
				.appendTo( targetTr );
		});
	},

	_contactContainers: function(event) {
		var i, j, dist, itemWithLeastDistance, posProperty, sizeProperty, cur, nearBottom, floating, axis,
			innermostContainer = null,
			innermostIndex = null;

		// get innermost container that intersects with item
		for (i = this.containers.length - 1; i >= 0; i--) {

			// never consider a container that's located within the item itself
			if($.contains(this.currentItem[0], this.containers[i].element[0])) {
				continue;
			}

			if(this._intersectsWith(this.containers[i].containerCache)) {

				// if we've already found a container and it's more "inner" than this, then continue
				if(innermostContainer && $.contains(this.containers[i].element[0], innermostContainer.element[0])) {
					continue;
				}

				innermostContainer = this.containers[i];
				innermostIndex = i;

			} else {
				// container doesn't intersect. trigger "out" event if necessary
				if(this.containers[i].containerCache.over) {
					this.containers[i]._trigger("out", event, this._uiHash(this));
					this.containers[i].containerCache.over = 0;
				}
			}

		}

		// if no intersecting containers found, return
		if(!innermostContainer) {
			return;
		}

		// move the item into the container if it's not there already
		if(this.containers.length === 1) {
			if (!this.containers[innermostIndex].containerCache.over) {
				this.containers[innermostIndex]._trigger("over", event, this._uiHash(this));
				this.containers[innermostIndex].containerCache.over = 1;
			}
		} else {

			//When entering a new container, we will find the item with the least distance and append our item near it
			dist = 10000;
			itemWithLeastDistance = null;
			floating = innermostContainer.floating || this._isFloating(this.currentItem);
			posProperty = floating ? "left" : "top";
			sizeProperty = floating ? "width" : "height";
			axis = floating ? "clientX" : "clientY";

			for (j = this.items.length - 1; j >= 0; j--) {
				if(!$.contains(this.containers[innermostIndex].element[0], this.items[j].item[0])) {
					continue;
				}
				if(this.items[j].item[0] === this.currentItem[0]) {
					continue;
				}

				cur = this.items[j].item.offset()[posProperty];
				nearBottom = false;
				if ( event[ axis ] - cur > this.items[ j ][ sizeProperty ] / 2 ) {
					nearBottom = true;
				}

				if ( Math.abs( event[ axis ] - cur ) < dist ) {
					dist = Math.abs( event[ axis ] - cur );
					itemWithLeastDistance = this.items[ j ];
					this.direction = nearBottom ? "up": "down";
				}
			}

			//Check if dropOnEmpty is enabled
			if(!itemWithLeastDistance && !this.options.dropOnEmpty) {
				return;
			}

			if(this.currentContainer === this.containers[innermostIndex]) {
				if ( !this.currentContainer.containerCache.over ) {
					this.containers[ innermostIndex ]._trigger( "over", event, this._uiHash() );
					this.currentContainer.containerCache.over = 1;
				}
				return;
			}

			itemWithLeastDistance ? this._rearrange(event, itemWithLeastDistance, null, true) : this._rearrange(event, null, this.containers[innermostIndex].element, true);
			this._trigger("change", event, this._uiHash());
			this.containers[innermostIndex]._trigger("change", event, this._uiHash(this));
			this.currentContainer = this.containers[innermostIndex];

			//Update the placeholder
			this.options.placeholder.update(this.currentContainer, this.placeholder);

			this.containers[innermostIndex]._trigger("over", event, this._uiHash(this));
			this.containers[innermostIndex].containerCache.over = 1;
		}


	},

	_createHelper: function(event) {

		var o = this.options,
			helper = $.isFunction(o.helper) ? $(o.helper.apply(this.element[0], [event, this.currentItem])) : (o.helper === "clone" ? this.currentItem.clone() : this.currentItem);

		//Add the helper to the DOM if that didn't happen already
		if(!helper.parents("body").length) {
			$(o.appendTo !== "parent" ? o.appendTo : this.currentItem[0].parentNode)[0].appendChild(helper[0]);
		}

		if(helper[0] === this.currentItem[0]) {
			this._storedCSS = { width: this.currentItem[0].style.width, height: this.currentItem[0].style.height, position: this.currentItem.css("position"), top: this.currentItem.css("top"), left: this.currentItem.css("left") };
		}

		if(!helper[0].style.width || o.forceHelperSize) {
			helper.width(this.currentItem.width());
		}
		if(!helper[0].style.height || o.forceHelperSize) {
			helper.height(this.currentItem.height());
		}

		return helper;

	},

	_adjustOffsetFromHelper: function(obj) {
		if (typeof obj === "string") {
			obj = obj.split(" ");
		}
		if ($.isArray(obj)) {
			obj = {left: +obj[0], top: +obj[1] || 0};
		}
		if ("left" in obj) {
			this.offset.click.left = obj.left + this.margins.left;
		}
		if ("right" in obj) {
			this.offset.click.left = this.helperProportions.width - obj.right + this.margins.left;
		}
		if ("top" in obj) {
			this.offset.click.top = obj.top + this.margins.top;
		}
		if ("bottom" in obj) {
			this.offset.click.top = this.helperProportions.height - obj.bottom + this.margins.top;
		}
	},

	_getParentOffset: function() {


		//Get the offsetParent and cache its position
		this.offsetParent = this.helper.offsetParent();
		var po = this.offsetParent.offset();

		// This is a special case where we need to modify a offset calculated on start, since the following happened:
		// 1. The position of the helper is absolute, so it's position is calculated based on the next positioned parent
		// 2. The actual offset parent is a child of the scroll parent, and the scroll parent isn't the document, which means that
		//    the scroll is included in the initial calculation of the offset of the parent, and never recalculated upon drag
		if(this.cssPosition === "absolute" && this.scrollParent[0] !== this.document[0] && $.contains(this.scrollParent[0], this.offsetParent[0])) {
			po.left += this.scrollParent.scrollLeft();
			po.top += this.scrollParent.scrollTop();
		}

		// This needs to be actually done for all browsers, since pageX/pageY includes this information
		// with an ugly IE fix
		if( this.offsetParent[0] === this.document[0].body || (this.offsetParent[0].tagName && this.offsetParent[0].tagName.toLowerCase() === "html" && $.ui.ie)) {
			po = { top: 0, left: 0 };
		}

		return {
			top: po.top + (parseInt(this.offsetParent.css("borderTopWidth"),10) || 0),
			left: po.left + (parseInt(this.offsetParent.css("borderLeftWidth"),10) || 0)
		};

	},

	_getRelativeOffset: function() {

		if(this.cssPosition === "relative") {
			var p = this.currentItem.position();
			return {
				top: p.top - (parseInt(this.helper.css("top"),10) || 0) + this.scrollParent.scrollTop(),
				left: p.left - (parseInt(this.helper.css("left"),10) || 0) + this.scrollParent.scrollLeft()
			};
		} else {
			return { top: 0, left: 0 };
		}

	},

	_cacheMargins: function() {
		this.margins = {
			left: (parseInt(this.currentItem.css("marginLeft"),10) || 0),
			top: (parseInt(this.currentItem.css("marginTop"),10) || 0)
		};
	},

	_cacheHelperProportions: function() {
		this.helperProportions = {
			width: this.helper.outerWidth(),
			height: this.helper.outerHeight()
		};
	},

	_setContainment: function() {

		var ce, co, over,
			o = this.options;
		if(o.containment === "parent") {
			o.containment = this.helper[0].parentNode;
		}
		if(o.containment === "document" || o.containment === "window") {
			this.containment = [
				0 - this.offset.relative.left - this.offset.parent.left,
				0 - this.offset.relative.top - this.offset.parent.top,
				o.containment === "document" ? this.document.width() : this.window.width() - this.helperProportions.width - this.margins.left,
				(o.containment === "document" ? this.document.width() : this.window.height() || this.document[0].body.parentNode.scrollHeight) - this.helperProportions.height - this.margins.top
			];
		}

		if(!(/^(document|window|parent)$/).test(o.containment)) {
			ce = $(o.containment)[0];
			co = $(o.containment).offset();
			over = ($(ce).css("overflow") !== "hidden");

			this.containment = [
				co.left + (parseInt($(ce).css("borderLeftWidth"),10) || 0) + (parseInt($(ce).css("paddingLeft"),10) || 0) - this.margins.left,
				co.top + (parseInt($(ce).css("borderTopWidth"),10) || 0) + (parseInt($(ce).css("paddingTop"),10) || 0) - this.margins.top,
				co.left+(over ? Math.max(ce.scrollWidth,ce.offsetWidth) : ce.offsetWidth) - (parseInt($(ce).css("borderLeftWidth"),10) || 0) - (parseInt($(ce).css("paddingRight"),10) || 0) - this.helperProportions.width - this.margins.left,
				co.top+(over ? Math.max(ce.scrollHeight,ce.offsetHeight) : ce.offsetHeight) - (parseInt($(ce).css("borderTopWidth"),10) || 0) - (parseInt($(ce).css("paddingBottom"),10) || 0) - this.helperProportions.height - this.margins.top
			];
		}

	},

	_convertPositionTo: function(d, pos) {

		if(!pos) {
			pos = this.position;
		}
		var mod = d === "absolute" ? 1 : -1,
			scroll = this.cssPosition === "absolute" && !(this.scrollParent[0] !== this.document[0] && $.contains(this.scrollParent[0], this.offsetParent[0])) ? this.offsetParent : this.scrollParent,
			scrollIsRootNode = (/(html|body)/i).test(scroll[0].tagName);

		return {
			top: (
				pos.top	+																// The absolute mouse position
				this.offset.relative.top * mod +										// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.top * mod -											// The offsetParent's offset without borders (offset + border)
				( ( this.cssPosition === "fixed" ? -this.scrollParent.scrollTop() : ( scrollIsRootNode ? 0 : scroll.scrollTop() ) ) * mod)
			),
			left: (
				pos.left +																// The absolute mouse position
				this.offset.relative.left * mod +										// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.left * mod	-										// The offsetParent's offset without borders (offset + border)
				( ( this.cssPosition === "fixed" ? -this.scrollParent.scrollLeft() : scrollIsRootNode ? 0 : scroll.scrollLeft() ) * mod)
			)
		};

	},

	_generatePosition: function(event) {

		var top, left,
			o = this.options,
			pageX = event.pageX,
			pageY = event.pageY,
			scroll = this.cssPosition === "absolute" && !(this.scrollParent[0] !== this.document[0] && $.contains(this.scrollParent[0], this.offsetParent[0])) ? this.offsetParent : this.scrollParent, scrollIsRootNode = (/(html|body)/i).test(scroll[0].tagName);

		// This is another very weird special case that only happens for relative elements:
		// 1. If the css position is relative
		// 2. and the scroll parent is the document or similar to the offset parent
		// we have to refresh the relative offset during the scroll so there are no jumps
		if(this.cssPosition === "relative" && !(this.scrollParent[0] !== this.document[0] && this.scrollParent[0] !== this.offsetParent[0])) {
			this.offset.relative = this._getRelativeOffset();
		}

		/*
		 * - Position constraining -
		 * Constrain the position to a mix of grid, containment.
		 */

		if(this.originalPosition) { //If we are not dragging yet, we won't check for options

			if(this.containment) {
				if(event.pageX - this.offset.click.left < this.containment[0]) {
					pageX = this.containment[0] + this.offset.click.left;
				}
				if(event.pageY - this.offset.click.top < this.containment[1]) {
					pageY = this.containment[1] + this.offset.click.top;
				}
				if(event.pageX - this.offset.click.left > this.containment[2]) {
					pageX = this.containment[2] + this.offset.click.left;
				}
				if(event.pageY - this.offset.click.top > this.containment[3]) {
					pageY = this.containment[3] + this.offset.click.top;
				}
			}

			if(o.grid) {
				top = this.originalPageY + Math.round((pageY - this.originalPageY) / o.grid[1]) * o.grid[1];
				pageY = this.containment ? ( (top - this.offset.click.top >= this.containment[1] && top - this.offset.click.top <= this.containment[3]) ? top : ((top - this.offset.click.top >= this.containment[1]) ? top - o.grid[1] : top + o.grid[1])) : top;

				left = this.originalPageX + Math.round((pageX - this.originalPageX) / o.grid[0]) * o.grid[0];
				pageX = this.containment ? ( (left - this.offset.click.left >= this.containment[0] && left - this.offset.click.left <= this.containment[2]) ? left : ((left - this.offset.click.left >= this.containment[0]) ? left - o.grid[0] : left + o.grid[0])) : left;
			}

		}

		return {
			top: (
				pageY -																// The absolute mouse position
				this.offset.click.top -													// Click offset (relative to the element)
				this.offset.relative.top	-											// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.top +												// The offsetParent's offset without borders (offset + border)
				( ( this.cssPosition === "fixed" ? -this.scrollParent.scrollTop() : ( scrollIsRootNode ? 0 : scroll.scrollTop() ) ))
			),
			left: (
				pageX -																// The absolute mouse position
				this.offset.click.left -												// Click offset (relative to the element)
				this.offset.relative.left	-											// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.left +												// The offsetParent's offset without borders (offset + border)
				( ( this.cssPosition === "fixed" ? -this.scrollParent.scrollLeft() : scrollIsRootNode ? 0 : scroll.scrollLeft() ))
			)
		};

	},

	_rearrange: function(event, i, a, hardRefresh) {

		a ? a[0].appendChild(this.placeholder[0]) : i.item[0].parentNode.insertBefore(this.placeholder[0], (this.direction === "down" ? i.item[0] : i.item[0].nextSibling));

		//Various things done here to improve the performance:
		// 1. we create a setTimeout, that calls refreshPositions
		// 2. on the instance, we have a counter variable, that get's higher after every append
		// 3. on the local scope, we copy the counter variable, and check in the timeout, if it's still the same
		// 4. this lets only the last addition to the timeout stack through
		this.counter = this.counter ? ++this.counter : 1;
		var counter = this.counter;

		this._delay(function() {
			if(counter === this.counter) {
				this.refreshPositions(!hardRefresh); //Precompute after each DOM insertion, NOT on mousemove
			}
		});

	},

	_clear: function(event, noPropagation) {

		this.reverting = false;
		// We delay all events that have to be triggered to after the point where the placeholder has been removed and
		// everything else normalized again
		var i,
			delayedTriggers = [];

		// We first have to update the dom position of the actual currentItem
		// Note: don't do it if the current item is already removed (by a user), or it gets reappended (see #4088)
		if(!this._noFinalSort && this.currentItem.parent().length) {
			this.placeholder.before(this.currentItem);
		}
		this._noFinalSort = null;

		if(this.helper[0] === this.currentItem[0]) {
			for(i in this._storedCSS) {
				if(this._storedCSS[i] === "auto" || this._storedCSS[i] === "static") {
					this._storedCSS[i] = "";
				}
			}
			this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper");
		} else {
			this.currentItem.show();
		}

		if(this.fromOutside && !noPropagation) {
			delayedTriggers.push(function(event) { this._trigger("receive", event, this._uiHash(this.fromOutside)); });
		}
		if((this.fromOutside || this.domPosition.prev !== this.currentItem.prev().not(".ui-sortable-helper")[0] || this.domPosition.parent !== this.currentItem.parent()[0]) && !noPropagation) {
			delayedTriggers.push(function(event) { this._trigger("update", event, this._uiHash()); }); //Trigger update callback if the DOM position has changed
		}

		// Check if the items Container has Changed and trigger appropriate
		// events.
		if (this !== this.currentContainer) {
			if(!noPropagation) {
				delayedTriggers.push(function(event) { this._trigger("remove", event, this._uiHash()); });
				delayedTriggers.push((function(c) { return function(event) { c._trigger("receive", event, this._uiHash(this)); };  }).call(this, this.currentContainer));
				delayedTriggers.push((function(c) { return function(event) { c._trigger("update", event, this._uiHash(this));  }; }).call(this, this.currentContainer));
			}
		}


		//Post events to containers
		function delayEvent( type, instance, container ) {
			return function( event ) {
				container._trigger( type, event, instance._uiHash( instance ) );
			};
		}
		for (i = this.containers.length - 1; i >= 0; i--){
			if (!noPropagation) {
				delayedTriggers.push( delayEvent( "deactivate", this, this.containers[ i ] ) );
			}
			if(this.containers[i].containerCache.over) {
				delayedTriggers.push( delayEvent( "out", this, this.containers[ i ] ) );
				this.containers[i].containerCache.over = 0;
			}
		}

		//Do what was originally in plugins
		if ( this.storedCursor ) {
			this.document.find( "body" ).css( "cursor", this.storedCursor );
			this.storedStylesheet.remove();
		}
		if(this._storedOpacity) {
			this.helper.css("opacity", this._storedOpacity);
		}
		if(this._storedZIndex) {
			this.helper.css("zIndex", this._storedZIndex === "auto" ? "" : this._storedZIndex);
		}

		this.dragging = false;

		if(!noPropagation) {
			this._trigger("beforeStop", event, this._uiHash());
		}

		//$(this.placeholder[0]).remove(); would have been the jQuery way - unfortunately, it unbinds ALL events from the original node!
		this.placeholder[0].parentNode.removeChild(this.placeholder[0]);

		if ( !this.cancelHelperRemoval ) {
			if ( this.helper[ 0 ] !== this.currentItem[ 0 ] ) {
				this.helper.remove();
			}
			this.helper = null;
		}

		if(!noPropagation) {
			for (i=0; i < delayedTriggers.length; i++) {
				delayedTriggers[i].call(this, event);
			} //Trigger all delayed events
			this._trigger("stop", event, this._uiHash());
		}

		this.fromOutside = false;
		return !this.cancelHelperRemoval;

	},

	_trigger: function() {
		if ($.Widget.prototype._trigger.apply(this, arguments) === false) {
			this.cancel();
		}
	},

	_uiHash: function(_inst) {
		var inst = _inst || this;
		return {
			helper: inst.helper,
			placeholder: inst.placeholder || $([]),
			position: inst.position,
			originalPosition: inst.originalPosition,
			offset: inst.positionAbs,
			item: inst.currentItem,
			sender: _inst ? _inst.element : null
		};
	}

});


/*!
 * jQuery UI Spinner 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/spinner/
 */


function spinner_modifier( fn ) {
	return function() {
		var previous = this.element.val();
		fn.apply( this, arguments );
		this._refresh();
		if ( previous !== this.element.val() ) {
			this._trigger( "change" );
		}
	};
}

var spinner = $.widget( "ui.spinner", {
	version: "1.11.4",
	defaultElement: "<input>",
	widgetEventPrefix: "spin",
	options: {
		culture: null,
		icons: {
			down: "ui-icon-triangle-1-s",
			up: "ui-icon-triangle-1-n"
		},
		incremental: true,
		max: null,
		min: null,
		numberFormat: null,
		page: 10,
		step: 1,

		change: null,
		spin: null,
		start: null,
		stop: null
	},

	_create: function() {
		// handle string values that need to be parsed
		this._setOption( "max", this.options.max );
		this._setOption( "min", this.options.min );
		this._setOption( "step", this.options.step );

		// Only format if there is a value, prevents the field from being marked
		// as invalid in Firefox, see #9573.
		if ( this.value() !== "" ) {
			// Format the value, but don't constrain.
			this._value( this.element.val(), true );
		}

		this._draw();
		this._on( this._events );
		this._refresh();

		// turning off autocomplete prevents the browser from remembering the
		// value when navigating through history, so we re-enable autocomplete
		// if the page is unloaded before the widget is destroyed. #7790
		this._on( this.window, {
			beforeunload: function() {
				this.element.removeAttr( "autocomplete" );
			}
		});
	},

	_getCreateOptions: function() {
		var options = {},
			element = this.element;

		$.each( [ "min", "max", "step" ], function( i, option ) {
			var value = element.attr( option );
			if ( value !== undefined && value.length ) {
				options[ option ] = value;
			}
		});

		return options;
	},

	_events: {
		keydown: function( event ) {
			if ( this._start( event ) && this._keydown( event ) ) {
				event.preventDefault();
			}
		},
		keyup: "_stop",
		focus: function() {
			this.previous = this.element.val();
		},
		blur: function( event ) {
			if ( this.cancelBlur ) {
				delete this.cancelBlur;
				return;
			}

			this._stop();
			this._refresh();
			if ( this.previous !== this.element.val() ) {
				this._trigger( "change", event );
			}
		},
		mousewheel: function( event, delta ) {
			if ( !delta ) {
				return;
			}
			if ( !this.spinning && !this._start( event ) ) {
				return false;
			}

			this._spin( (delta > 0 ? 1 : -1) * this.options.step, event );
			clearTimeout( this.mousewheelTimer );
			this.mousewheelTimer = this._delay(function() {
				if ( this.spinning ) {
					this._stop( event );
				}
			}, 100 );
			event.preventDefault();
		},
		"mousedown .ui-spinner-button": function( event ) {
			var previous;

			// We never want the buttons to have focus; whenever the user is
			// interacting with the spinner, the focus should be on the input.
			// If the input is focused then this.previous is properly set from
			// when the input first received focus. If the input is not focused
			// then we need to set this.previous based on the value before spinning.
			previous = this.element[0] === this.document[0].activeElement ?
				this.previous : this.element.val();
			function checkFocus() {
				var isActive = this.element[0] === this.document[0].activeElement;
				if ( !isActive ) {
					this.element.focus();
					this.previous = previous;
					// support: IE
					// IE sets focus asynchronously, so we need to check if focus
					// moved off of the input because the user clicked on the button.
					this._delay(function() {
						this.previous = previous;
					});
				}
			}

			// ensure focus is on (or stays on) the text field
			event.preventDefault();
			checkFocus.call( this );

			// support: IE
			// IE doesn't prevent moving focus even with event.preventDefault()
			// so we set a flag to know when we should ignore the blur event
			// and check (again) if focus moved off of the input.
			this.cancelBlur = true;
			this._delay(function() {
				delete this.cancelBlur;
				checkFocus.call( this );
			});

			if ( this._start( event ) === false ) {
				return;
			}

			this._repeat( null, $( event.currentTarget ).hasClass( "ui-spinner-up" ) ? 1 : -1, event );
		},
		"mouseup .ui-spinner-button": "_stop",
		"mouseenter .ui-spinner-button": function( event ) {
			// button will add ui-state-active if mouse was down while mouseleave and kept down
			if ( !$( event.currentTarget ).hasClass( "ui-state-active" ) ) {
				return;
			}

			if ( this._start( event ) === false ) {
				return false;
			}
			this._repeat( null, $( event.currentTarget ).hasClass( "ui-spinner-up" ) ? 1 : -1, event );
		},
		// TODO: do we really want to consider this a stop?
		// shouldn't we just stop the repeater and wait until mouseup before
		// we trigger the stop event?
		"mouseleave .ui-spinner-button": "_stop"
	},

	_draw: function() {
		var uiSpinner = this.uiSpinner = this.element
			.addClass( "ui-spinner-input" )
			.attr( "autocomplete", "off" )
			.wrap( this._uiSpinnerHtml() )
			.parent()
				// add buttons
				.append( this._buttonHtml() );

		this.element.attr( "role", "spinbutton" );

		// button bindings
		this.buttons = uiSpinner.find( ".ui-spinner-button" )
			.attr( "tabIndex", -1 )
			.button()
			.removeClass( "ui-corner-all" );

		// IE 6 doesn't understand height: 50% for the buttons
		// unless the wrapper has an explicit height
		if ( this.buttons.height() > Math.ceil( uiSpinner.height() * 0.5 ) &&
				uiSpinner.height() > 0 ) {
			uiSpinner.height( uiSpinner.height() );
		}

		// disable spinner if element was already disabled
		if ( this.options.disabled ) {
			this.disable();
		}
	},

	_keydown: function( event ) {
		var options = this.options,
			keyCode = $.ui.keyCode;

		switch ( event.keyCode ) {
		case keyCode.UP:
			this._repeat( null, 1, event );
			return true;
		case keyCode.DOWN:
			this._repeat( null, -1, event );
			return true;
		case keyCode.PAGE_UP:
			this._repeat( null, options.page, event );
			return true;
		case keyCode.PAGE_DOWN:
			this._repeat( null, -options.page, event );
			return true;
		}

		return false;
	},

	_uiSpinnerHtml: function() {
		return "<span class='ui-spinner ui-widget ui-widget-content ui-corner-all'></span>";
	},

	_buttonHtml: function() {
		return "" +
			"<a class='ui-spinner-button ui-spinner-up ui-corner-tr'>" +
				"<span class='ui-icon " + this.options.icons.up + "'>&#9650;</span>" +
			"</a>" +
			"<a class='ui-spinner-button ui-spinner-down ui-corner-br'>" +
				"<span class='ui-icon " + this.options.icons.down + "'>&#9660;</span>" +
			"</a>";
	},

	_start: function( event ) {
		if ( !this.spinning && this._trigger( "start", event ) === false ) {
			return false;
		}

		if ( !this.counter ) {
			this.counter = 1;
		}
		this.spinning = true;
		return true;
	},

	_repeat: function( i, steps, event ) {
		i = i || 500;

		clearTimeout( this.timer );
		this.timer = this._delay(function() {
			this._repeat( 40, steps, event );
		}, i );

		this._spin( steps * this.options.step, event );
	},

	_spin: function( step, event ) {
		var value = this.value() || 0;

		if ( !this.counter ) {
			this.counter = 1;
		}

		value = this._adjustValue( value + step * this._increment( this.counter ) );

		if ( !this.spinning || this._trigger( "spin", event, { value: value } ) !== false) {
			this._value( value );
			this.counter++;
		}
	},

	_increment: function( i ) {
		var incremental = this.options.incremental;

		if ( incremental ) {
			return $.isFunction( incremental ) ?
				incremental( i ) :
				Math.floor( i * i * i / 50000 - i * i / 500 + 17 * i / 200 + 1 );
		}

		return 1;
	},

	_precision: function() {
		var precision = this._precisionOf( this.options.step );
		if ( this.options.min !== null ) {
			precision = Math.max( precision, this._precisionOf( this.options.min ) );
		}
		return precision;
	},

	_precisionOf: function( num ) {
		var str = num.toString(),
			decimal = str.indexOf( "." );
		return decimal === -1 ? 0 : str.length - decimal - 1;
	},

	_adjustValue: function( value ) {
		var base, aboveMin,
			options = this.options;

		// make sure we're at a valid step
		// - find out where we are relative to the base (min or 0)
		base = options.min !== null ? options.min : 0;
		aboveMin = value - base;
		// - round to the nearest step
		aboveMin = Math.round(aboveMin / options.step) * options.step;
		// - rounding is based on 0, so adjust back to our base
		value = base + aboveMin;

		// fix precision from bad JS floating point math
		value = parseFloat( value.toFixed( this._precision() ) );

		// clamp the value
		if ( options.max !== null && value > options.max) {
			return options.max;
		}
		if ( options.min !== null && value < options.min ) {
			return options.min;
		}

		return value;
	},

	_stop: function( event ) {
		if ( !this.spinning ) {
			return;
		}

		clearTimeout( this.timer );
		clearTimeout( this.mousewheelTimer );
		this.counter = 0;
		this.spinning = false;
		this._trigger( "stop", event );
	},

	_setOption: function( key, value ) {
		if ( key === "culture" || key === "numberFormat" ) {
			var prevValue = this._parse( this.element.val() );
			this.options[ key ] = value;
			this.element.val( this._format( prevValue ) );
			return;
		}

		if ( key === "max" || key === "min" || key === "step" ) {
			if ( typeof value === "string" ) {
				value = this._parse( value );
			}
		}
		if ( key === "icons" ) {
			this.buttons.first().find( ".ui-icon" )
				.removeClass( this.options.icons.up )
				.addClass( value.up );
			this.buttons.last().find( ".ui-icon" )
				.removeClass( this.options.icons.down )
				.addClass( value.down );
		}

		this._super( key, value );

		if ( key === "disabled" ) {
			this.widget().toggleClass( "ui-state-disabled", !!value );
			this.element.prop( "disabled", !!value );
			this.buttons.button( value ? "disable" : "enable" );
		}
	},

	_setOptions: spinner_modifier(function( options ) {
		this._super( options );
	}),

	_parse: function( val ) {
		if ( typeof val === "string" && val !== "" ) {
			val = window.Globalize && this.options.numberFormat ?
				Globalize.parseFloat( val, 10, this.options.culture ) : +val;
		}
		return val === "" || isNaN( val ) ? null : val;
	},

	_format: function( value ) {
		if ( value === "" ) {
			return "";
		}
		return window.Globalize && this.options.numberFormat ?
			Globalize.format( value, this.options.numberFormat, this.options.culture ) :
			value;
	},

	_refresh: function() {
		this.element.attr({
			"aria-valuemin": this.options.min,
			"aria-valuemax": this.options.max,
			// TODO: what should we do with values that can't be parsed?
			"aria-valuenow": this._parse( this.element.val() )
		});
	},

	isValid: function() {
		var value = this.value();

		// null is invalid
		if ( value === null ) {
			return false;
		}

		// if value gets adjusted, it's invalid
		return value === this._adjustValue( value );
	},

	// update the value without triggering change
	_value: function( value, allowAny ) {
		var parsed;
		if ( value !== "" ) {
			parsed = this._parse( value );
			if ( parsed !== null ) {
				if ( !allowAny ) {
					parsed = this._adjustValue( parsed );
				}
				value = this._format( parsed );
			}
		}
		this.element.val( value );
		this._refresh();
	},

	_destroy: function() {
		this.element
			.removeClass( "ui-spinner-input" )
			.prop( "disabled", false )
			.removeAttr( "autocomplete" )
			.removeAttr( "role" )
			.removeAttr( "aria-valuemin" )
			.removeAttr( "aria-valuemax" )
			.removeAttr( "aria-valuenow" );
		this.uiSpinner.replaceWith( this.element );
	},

	stepUp: spinner_modifier(function( steps ) {
		this._stepUp( steps );
	}),
	_stepUp: function( steps ) {
		if ( this._start() ) {
			this._spin( (steps || 1) * this.options.step );
			this._stop();
		}
	},

	stepDown: spinner_modifier(function( steps ) {
		this._stepDown( steps );
	}),
	_stepDown: function( steps ) {
		if ( this._start() ) {
			this._spin( (steps || 1) * -this.options.step );
			this._stop();
		}
	},

	pageUp: spinner_modifier(function( pages ) {
		this._stepUp( (pages || 1) * this.options.page );
	}),

	pageDown: spinner_modifier(function( pages ) {
		this._stepDown( (pages || 1) * this.options.page );
	}),

	value: function( newVal ) {
		if ( !arguments.length ) {
			return this._parse( this.element.val() );
		}
		spinner_modifier( this._value ).call( this, newVal );
	},

	widget: function() {
		return this.uiSpinner;
	}
});


/*!
 * jQuery UI Tabs 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/tabs/
 */


var tabs = $.widget( "ui.tabs", {
	version: "1.11.4",
	delay: 300,
	options: {
		active: null,
		collapsible: false,
		event: "click",
		heightStyle: "content",
		hide: null,
		show: null,

		// callbacks
		activate: null,
		beforeActivate: null,
		beforeLoad: null,
		load: null
	},

	_isLocal: (function() {
		var rhash = /#.*$/;

		return function( anchor ) {
			var anchorUrl, locationUrl;

			// support: IE7
			// IE7 doesn't normalize the href property when set via script (#9317)
			anchor = anchor.cloneNode( false );

			anchorUrl = anchor.href.replace( rhash, "" );
			locationUrl = location.href.replace( rhash, "" );

			// decoding may throw an error if the URL isn't UTF-8 (#9518)
			try {
				anchorUrl = decodeURIComponent( anchorUrl );
			} catch ( error ) {}
			try {
				locationUrl = decodeURIComponent( locationUrl );
			} catch ( error ) {}

			return anchor.hash.length > 1 && anchorUrl === locationUrl;
		};
	})(),

	_create: function() {
		var that = this,
			options = this.options;

		this.running = false;

		this.element
			.addClass( "ui-tabs ui-widget ui-widget-content ui-corner-all" )
			.toggleClass( "ui-tabs-collapsible", options.collapsible );

		this._processTabs();
		options.active = this._initialActive();

		// Take disabling tabs via class attribute from HTML
		// into account and update option properly.
		if ( $.isArray( options.disabled ) ) {
			options.disabled = $.unique( options.disabled.concat(
				$.map( this.tabs.filter( ".ui-state-disabled" ), function( li ) {
					return that.tabs.index( li );
				})
			) ).sort();
		}

		// check for length avoids error when initializing empty list
		if ( this.options.active !== false && this.anchors.length ) {
			this.active = this._findActive( options.active );
		} else {
			this.active = $();
		}

		this._refresh();

		if ( this.active.length ) {
			this.load( options.active );
		}
	},

	_initialActive: function() {
		var active = this.options.active,
			collapsible = this.options.collapsible,
			locationHash = location.hash.substring( 1 );

		if ( active === null ) {
			// check the fragment identifier in the URL
			if ( locationHash ) {
				this.tabs.each(function( i, tab ) {
					if ( $( tab ).attr( "aria-controls" ) === locationHash ) {
						active = i;
						return false;
					}
				});
			}

			// check for a tab marked active via a class
			if ( active === null ) {
				active = this.tabs.index( this.tabs.filter( ".ui-tabs-active" ) );
			}

			// no active tab, set to false
			if ( active === null || active === -1 ) {
				active = this.tabs.length ? 0 : false;
			}
		}

		// handle numbers: negative, out of range
		if ( active !== false ) {
			active = this.tabs.index( this.tabs.eq( active ) );
			if ( active === -1 ) {
				active = collapsible ? false : 0;
			}
		}

		// don't allow collapsible: false and active: false
		if ( !collapsible && active === false && this.anchors.length ) {
			active = 0;
		}

		return active;
	},

	_getCreateEventData: function() {
		return {
			tab: this.active,
			panel: !this.active.length ? $() : this._getPanelForTab( this.active )
		};
	},

	_tabKeydown: function( event ) {
		var focusedTab = $( this.document[0].activeElement ).closest( "li" ),
			selectedIndex = this.tabs.index( focusedTab ),
			goingForward = true;

		if ( this._handlePageNav( event ) ) {
			return;
		}

		switch ( event.keyCode ) {
			case $.ui.keyCode.RIGHT:
			case $.ui.keyCode.DOWN:
				selectedIndex++;
				break;
			case $.ui.keyCode.UP:
			case $.ui.keyCode.LEFT:
				goingForward = false;
				selectedIndex--;
				break;
			case $.ui.keyCode.END:
				selectedIndex = this.anchors.length - 1;
				break;
			case $.ui.keyCode.HOME:
				selectedIndex = 0;
				break;
			case $.ui.keyCode.SPACE:
				// Activate only, no collapsing
				event.preventDefault();
				clearTimeout( this.activating );
				this._activate( selectedIndex );
				return;
			case $.ui.keyCode.ENTER:
				// Toggle (cancel delayed activation, allow collapsing)
				event.preventDefault();
				clearTimeout( this.activating );
				// Determine if we should collapse or activate
				this._activate( selectedIndex === this.options.active ? false : selectedIndex );
				return;
			default:
				return;
		}

		// Focus the appropriate tab, based on which key was pressed
		event.preventDefault();
		clearTimeout( this.activating );
		selectedIndex = this._focusNextTab( selectedIndex, goingForward );

		// Navigating with control/command key will prevent automatic activation
		if ( !event.ctrlKey && !event.metaKey ) {

			// Update aria-selected immediately so that AT think the tab is already selected.
			// Otherwise AT may confuse the user by stating that they need to activate the tab,
			// but the tab will already be activated by the time the announcement finishes.
			focusedTab.attr( "aria-selected", "false" );
			this.tabs.eq( selectedIndex ).attr( "aria-selected", "true" );

			this.activating = this._delay(function() {
				this.option( "active", selectedIndex );
			}, this.delay );
		}
	},

	_panelKeydown: function( event ) {
		if ( this._handlePageNav( event ) ) {
			return;
		}

		// Ctrl+up moves focus to the current tab
		if ( event.ctrlKey && event.keyCode === $.ui.keyCode.UP ) {
			event.preventDefault();
			this.active.focus();
		}
	},

	// Alt+page up/down moves focus to the previous/next tab (and activates)
	_handlePageNav: function( event ) {
		if ( event.altKey && event.keyCode === $.ui.keyCode.PAGE_UP ) {
			this._activate( this._focusNextTab( this.options.active - 1, false ) );
			return true;
		}
		if ( event.altKey && event.keyCode === $.ui.keyCode.PAGE_DOWN ) {
			this._activate( this._focusNextTab( this.options.active + 1, true ) );
			return true;
		}
	},

	_findNextTab: function( index, goingForward ) {
		var lastTabIndex = this.tabs.length - 1;

		function constrain() {
			if ( index > lastTabIndex ) {
				index = 0;
			}
			if ( index < 0 ) {
				index = lastTabIndex;
			}
			return index;
		}

		while ( $.inArray( constrain(), this.options.disabled ) !== -1 ) {
			index = goingForward ? index + 1 : index - 1;
		}

		return index;
	},

	_focusNextTab: function( index, goingForward ) {
		index = this._findNextTab( index, goingForward );
		this.tabs.eq( index ).focus();
		return index;
	},

	_setOption: function( key, value ) {
		if ( key === "active" ) {
			// _activate() will handle invalid values and update this.options
			this._activate( value );
			return;
		}

		if ( key === "disabled" ) {
			// don't use the widget factory's disabled handling
			this._setupDisabled( value );
			return;
		}

		this._super( key, value);

		if ( key === "collapsible" ) {
			this.element.toggleClass( "ui-tabs-collapsible", value );
			// Setting collapsible: false while collapsed; open first panel
			if ( !value && this.options.active === false ) {
				this._activate( 0 );
			}
		}

		if ( key === "event" ) {
			this._setupEvents( value );
		}

		if ( key === "heightStyle" ) {
			this._setupHeightStyle( value );
		}
	},

	_sanitizeSelector: function( hash ) {
		return hash ? hash.replace( /[!"$%&'()*+,.\/:;<=>?@\[\]\^`{|}~]/g, "\\$&" ) : "";
	},

	refresh: function() {
		var options = this.options,
			lis = this.tablist.children( ":has(a[href])" );

		// get disabled tabs from class attribute from HTML
		// this will get converted to a boolean if needed in _refresh()
		options.disabled = $.map( lis.filter( ".ui-state-disabled" ), function( tab ) {
			return lis.index( tab );
		});

		this._processTabs();

		// was collapsed or no tabs
		if ( options.active === false || !this.anchors.length ) {
			options.active = false;
			this.active = $();
		// was active, but active tab is gone
		} else if ( this.active.length && !$.contains( this.tablist[ 0 ], this.active[ 0 ] ) ) {
			// all remaining tabs are disabled
			if ( this.tabs.length === options.disabled.length ) {
				options.active = false;
				this.active = $();
			// activate previous tab
			} else {
				this._activate( this._findNextTab( Math.max( 0, options.active - 1 ), false ) );
			}
		// was active, active tab still exists
		} else {
			// make sure active index is correct
			options.active = this.tabs.index( this.active );
		}

		this._refresh();
	},

	_refresh: function() {
		this._setupDisabled( this.options.disabled );
		this._setupEvents( this.options.event );
		this._setupHeightStyle( this.options.heightStyle );

		this.tabs.not( this.active ).attr({
			"aria-selected": "false",
			"aria-expanded": "false",
			tabIndex: -1
		});
		this.panels.not( this._getPanelForTab( this.active ) )
			.hide()
			.attr({
				"aria-hidden": "true"
			});

		// Make sure one tab is in the tab order
		if ( !this.active.length ) {
			this.tabs.eq( 0 ).attr( "tabIndex", 0 );
		} else {
			this.active
				.addClass( "ui-tabs-active ui-state-active" )
				.attr({
					"aria-selected": "true",
					"aria-expanded": "true",
					tabIndex: 0
				});
			this._getPanelForTab( this.active )
				.show()
				.attr({
					"aria-hidden": "false"
				});
		}
	},

	_processTabs: function() {
		var that = this,
			prevTabs = this.tabs,
			prevAnchors = this.anchors,
			prevPanels = this.panels;

		this.tablist = this._getList()
			.addClass( "ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all" )
			.attr( "role", "tablist" )

			// Prevent users from focusing disabled tabs via click
			.delegate( "> li", "mousedown" + this.eventNamespace, function( event ) {
				if ( $( this ).is( ".ui-state-disabled" ) ) {
					event.preventDefault();
				}
			})

			// support: IE <9
			// Preventing the default action in mousedown doesn't prevent IE
			// from focusing the element, so if the anchor gets focused, blur.
			// We don't have to worry about focusing the previously focused
			// element since clicking on a non-focusable element should focus
			// the body anyway.
			.delegate( ".ui-tabs-anchor", "focus" + this.eventNamespace, function() {
				if ( $( this ).closest( "li" ).is( ".ui-state-disabled" ) ) {
					this.blur();
				}
			});

		this.tabs = this.tablist.find( "> li:has(a[href])" )
			.addClass( "ui-state-default ui-corner-top" )
			.attr({
				role: "tab",
				tabIndex: -1
			});

		this.anchors = this.tabs.map(function() {
				return $( "a", this )[ 0 ];
			})
			.addClass( "ui-tabs-anchor" )
			.attr({
				role: "presentation",
				tabIndex: -1
			});

		this.panels = $();

		this.anchors.each(function( i, anchor ) {
			var selector, panel, panelId,
				anchorId = $( anchor ).uniqueId().attr( "id" ),
				tab = $( anchor ).closest( "li" ),
				originalAriaControls = tab.attr( "aria-controls" );

			// inline tab
			if ( that._isLocal( anchor ) ) {
				selector = anchor.hash;
				panelId = selector.substring( 1 );
				panel = that.element.find( that._sanitizeSelector( selector ) );
			// remote tab
			} else {
				// If the tab doesn't already have aria-controls,
				// generate an id by using a throw-away element
				panelId = tab.attr( "aria-controls" ) || $( {} ).uniqueId()[ 0 ].id;
				selector = "#" + panelId;
				panel = that.element.find( selector );
				if ( !panel.length ) {
					panel = that._createPanel( panelId );
					panel.insertAfter( that.panels[ i - 1 ] || that.tablist );
				}
				panel.attr( "aria-live", "polite" );
			}

			if ( panel.length) {
				that.panels = that.panels.add( panel );
			}
			if ( originalAriaControls ) {
				tab.data( "ui-tabs-aria-controls", originalAriaControls );
			}
			tab.attr({
				"aria-controls": panelId,
				"aria-labelledby": anchorId
			});
			panel.attr( "aria-labelledby", anchorId );
		});

		this.panels
			.addClass( "ui-tabs-panel ui-widget-content ui-corner-bottom" )
			.attr( "role", "tabpanel" );

		// Avoid memory leaks (#10056)
		if ( prevTabs ) {
			this._off( prevTabs.not( this.tabs ) );
			this._off( prevAnchors.not( this.anchors ) );
			this._off( prevPanels.not( this.panels ) );
		}
	},

	// allow overriding how to find the list for rare usage scenarios (#7715)
	_getList: function() {
		return this.tablist || this.element.find( "ol,ul" ).eq( 0 );
	},

	_createPanel: function( id ) {
		return $( "<div>" )
			.attr( "id", id )
			.addClass( "ui-tabs-panel ui-widget-content ui-corner-bottom" )
			.data( "ui-tabs-destroy", true );
	},

	_setupDisabled: function( disabled ) {
		if ( $.isArray( disabled ) ) {
			if ( !disabled.length ) {
				disabled = false;
			} else if ( disabled.length === this.anchors.length ) {
				disabled = true;
			}
		}

		// disable tabs
		for ( var i = 0, li; ( li = this.tabs[ i ] ); i++ ) {
			if ( disabled === true || $.inArray( i, disabled ) !== -1 ) {
				$( li )
					.addClass( "ui-state-disabled" )
					.attr( "aria-disabled", "true" );
			} else {
				$( li )
					.removeClass( "ui-state-disabled" )
					.removeAttr( "aria-disabled" );
			}
		}

		this.options.disabled = disabled;
	},

	_setupEvents: function( event ) {
		var events = {};
		if ( event ) {
			$.each( event.split(" "), function( index, eventName ) {
				events[ eventName ] = "_eventHandler";
			});
		}

		this._off( this.anchors.add( this.tabs ).add( this.panels ) );
		// Always prevent the default action, even when disabled
		this._on( true, this.anchors, {
			click: function( event ) {
				event.preventDefault();
			}
		});
		this._on( this.anchors, events );
		this._on( this.tabs, { keydown: "_tabKeydown" } );
		this._on( this.panels, { keydown: "_panelKeydown" } );

		this._focusable( this.tabs );
		this._hoverable( this.tabs );
	},

	_setupHeightStyle: function( heightStyle ) {
		var maxHeight,
			parent = this.element.parent();

		if ( heightStyle === "fill" ) {
			maxHeight = parent.height();
			maxHeight -= this.element.outerHeight() - this.element.height();

			this.element.siblings( ":visible" ).each(function() {
				var elem = $( this ),
					position = elem.css( "position" );

				if ( position === "absolute" || position === "fixed" ) {
					return;
				}
				maxHeight -= elem.outerHeight( true );
			});

			this.element.children().not( this.panels ).each(function() {
				maxHeight -= $( this ).outerHeight( true );
			});

			this.panels.each(function() {
				$( this ).height( Math.max( 0, maxHeight -
					$( this ).innerHeight() + $( this ).height() ) );
			})
			.css( "overflow", "auto" );
		} else if ( heightStyle === "auto" ) {
			maxHeight = 0;
			this.panels.each(function() {
				maxHeight = Math.max( maxHeight, $( this ).height( "" ).height() );
			}).height( maxHeight );
		}
	},

	_eventHandler: function( event ) {
		var options = this.options,
			active = this.active,
			anchor = $( event.currentTarget ),
			tab = anchor.closest( "li" ),
			clickedIsActive = tab[ 0 ] === active[ 0 ],
			collapsing = clickedIsActive && options.collapsible,
			toShow = collapsing ? $() : this._getPanelForTab( tab ),
			toHide = !active.length ? $() : this._getPanelForTab( active ),
			eventData = {
				oldTab: active,
				oldPanel: toHide,
				newTab: collapsing ? $() : tab,
				newPanel: toShow
			};

		event.preventDefault();

		if ( tab.hasClass( "ui-state-disabled" ) ||
				// tab is already loading
				tab.hasClass( "ui-tabs-loading" ) ||
				// can't switch durning an animation
				this.running ||
				// click on active header, but not collapsible
				( clickedIsActive && !options.collapsible ) ||
				// allow canceling activation
				( this._trigger( "beforeActivate", event, eventData ) === false ) ) {
			return;
		}

		options.active = collapsing ? false : this.tabs.index( tab );

		this.active = clickedIsActive ? $() : tab;
		if ( this.xhr ) {
			this.xhr.abort();
		}

		if ( !toHide.length && !toShow.length ) {
			$.error( "jQuery UI Tabs: Mismatching fragment identifier." );
		}

		if ( toShow.length ) {
			this.load( this.tabs.index( tab ), event );
		}
		this._toggle( event, eventData );
	},

	// handles show/hide for selecting tabs
	_toggle: function( event, eventData ) {
		var that = this,
			toShow = eventData.newPanel,
			toHide = eventData.oldPanel;

		this.running = true;

		function complete() {
			that.running = false;
			that._trigger( "activate", event, eventData );
		}

		function show() {
			eventData.newTab.closest( "li" ).addClass( "ui-tabs-active ui-state-active" );

			if ( toShow.length && that.options.show ) {
				that._show( toShow, that.options.show, complete );
			} else {
				toShow.show();
				complete();
			}
		}

		// start out by hiding, then showing, then completing
		if ( toHide.length && this.options.hide ) {
			this._hide( toHide, this.options.hide, function() {
				eventData.oldTab.closest( "li" ).removeClass( "ui-tabs-active ui-state-active" );
				show();
			});
		} else {
			eventData.oldTab.closest( "li" ).removeClass( "ui-tabs-active ui-state-active" );
			toHide.hide();
			show();
		}

		toHide.attr( "aria-hidden", "true" );
		eventData.oldTab.attr({
			"aria-selected": "false",
			"aria-expanded": "false"
		});
		// If we're switching tabs, remove the old tab from the tab order.
		// If we're opening from collapsed state, remove the previous tab from the tab order.
		// If we're collapsing, then keep the collapsing tab in the tab order.
		if ( toShow.length && toHide.length ) {
			eventData.oldTab.attr( "tabIndex", -1 );
		} else if ( toShow.length ) {
			this.tabs.filter(function() {
				return $( this ).attr( "tabIndex" ) === 0;
			})
			.attr( "tabIndex", -1 );
		}

		toShow.attr( "aria-hidden", "false" );
		eventData.newTab.attr({
			"aria-selected": "true",
			"aria-expanded": "true",
			tabIndex: 0
		});
	},

	_activate: function( index ) {
		var anchor,
			active = this._findActive( index );

		// trying to activate the already active panel
		if ( active[ 0 ] === this.active[ 0 ] ) {
			return;
		}

		// trying to collapse, simulate a click on the current active header
		if ( !active.length ) {
			active = this.active;
		}

		anchor = active.find( ".ui-tabs-anchor" )[ 0 ];
		this._eventHandler({
			target: anchor,
			currentTarget: anchor,
			preventDefault: $.noop
		});
	},

	_findActive: function( index ) {
		return index === false ? $() : this.tabs.eq( index );
	},

	_getIndex: function( index ) {
		// meta-function to give users option to provide a href string instead of a numerical index.
		if ( typeof index === "string" ) {
			index = this.anchors.index( this.anchors.filter( "[href$='" + index + "']" ) );
		}

		return index;
	},

	_destroy: function() {
		if ( this.xhr ) {
			this.xhr.abort();
		}

		this.element.removeClass( "ui-tabs ui-widget ui-widget-content ui-corner-all ui-tabs-collapsible" );

		this.tablist
			.removeClass( "ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all" )
			.removeAttr( "role" );

		this.anchors
			.removeClass( "ui-tabs-anchor" )
			.removeAttr( "role" )
			.removeAttr( "tabIndex" )
			.removeUniqueId();

		this.tablist.unbind( this.eventNamespace );

		this.tabs.add( this.panels ).each(function() {
			if ( $.data( this, "ui-tabs-destroy" ) ) {
				$( this ).remove();
			} else {
				$( this )
					.removeClass( "ui-state-default ui-state-active ui-state-disabled " +
						"ui-corner-top ui-corner-bottom ui-widget-content ui-tabs-active ui-tabs-panel" )
					.removeAttr( "tabIndex" )
					.removeAttr( "aria-live" )
					.removeAttr( "aria-busy" )
					.removeAttr( "aria-selected" )
					.removeAttr( "aria-labelledby" )
					.removeAttr( "aria-hidden" )
					.removeAttr( "aria-expanded" )
					.removeAttr( "role" );
			}
		});

		this.tabs.each(function() {
			var li = $( this ),
				prev = li.data( "ui-tabs-aria-controls" );
			if ( prev ) {
				li
					.attr( "aria-controls", prev )
					.removeData( "ui-tabs-aria-controls" );
			} else {
				li.removeAttr( "aria-controls" );
			}
		});

		this.panels.show();

		if ( this.options.heightStyle !== "content" ) {
			this.panels.css( "height", "" );
		}
	},

	enable: function( index ) {
		var disabled = this.options.disabled;
		if ( disabled === false ) {
			return;
		}

		if ( index === undefined ) {
			disabled = false;
		} else {
			index = this._getIndex( index );
			if ( $.isArray( disabled ) ) {
				disabled = $.map( disabled, function( num ) {
					return num !== index ? num : null;
				});
			} else {
				disabled = $.map( this.tabs, function( li, num ) {
					return num !== index ? num : null;
				});
			}
		}
		this._setupDisabled( disabled );
	},

	disable: function( index ) {
		var disabled = this.options.disabled;
		if ( disabled === true ) {
			return;
		}

		if ( index === undefined ) {
			disabled = true;
		} else {
			index = this._getIndex( index );
			if ( $.inArray( index, disabled ) !== -1 ) {
				return;
			}
			if ( $.isArray( disabled ) ) {
				disabled = $.merge( [ index ], disabled ).sort();
			} else {
				disabled = [ index ];
			}
		}
		this._setupDisabled( disabled );
	},

	load: function( index, event ) {
		index = this._getIndex( index );
		var that = this,
			tab = this.tabs.eq( index ),
			anchor = tab.find( ".ui-tabs-anchor" ),
			panel = this._getPanelForTab( tab ),
			eventData = {
				tab: tab,
				panel: panel
			},
			complete = function( jqXHR, status ) {
				if ( status === "abort" ) {
					that.panels.stop( false, true );
				}

				tab.removeClass( "ui-tabs-loading" );
				panel.removeAttr( "aria-busy" );

				if ( jqXHR === that.xhr ) {
					delete that.xhr;
				}
			};

		// not remote
		if ( this._isLocal( anchor[ 0 ] ) ) {
			return;
		}

		this.xhr = $.ajax( this._ajaxSettings( anchor, event, eventData ) );

		// support: jQuery <1.8
		// jQuery <1.8 returns false if the request is canceled in beforeSend,
		// but as of 1.8, $.ajax() always returns a jqXHR object.
		if ( this.xhr && this.xhr.statusText !== "canceled" ) {
			tab.addClass( "ui-tabs-loading" );
			panel.attr( "aria-busy", "true" );

			this.xhr
				.done(function( response, status, jqXHR ) {
					// support: jQuery <1.8
					// http://bugs.jquery.com/ticket/11778
					setTimeout(function() {
						panel.html( response );
						that._trigger( "load", event, eventData );

						complete( jqXHR, status );
					}, 1 );
				})
				.fail(function( jqXHR, status ) {
					// support: jQuery <1.8
					// http://bugs.jquery.com/ticket/11778
					setTimeout(function() {
						complete( jqXHR, status );
					}, 1 );
				});
		}
	},

	_ajaxSettings: function( anchor, event, eventData ) {
		var that = this;
		return {
			url: anchor.attr( "href" ),
			beforeSend: function( jqXHR, settings ) {
				return that._trigger( "beforeLoad", event,
					$.extend( { jqXHR: jqXHR, ajaxSettings: settings }, eventData ) );
			}
		};
	},

	_getPanelForTab: function( tab ) {
		var id = $( tab ).attr( "aria-controls" );
		return this.element.find( this._sanitizeSelector( "#" + id ) );
	}
});


/*!
 * jQuery UI Tooltip 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/tooltip/
 */


var tooltip = $.widget( "ui.tooltip", {
	version: "1.11.4",
	options: {
		content: function() {
			// support: IE<9, Opera in jQuery <1.7
			// .text() can't accept undefined, so coerce to a string
			var title = $( this ).attr( "title" ) || "";
			// Escape title, since we're going from an attribute to raw HTML
			return $( "<a>" ).text( title ).html();
		},
		hide: true,
		// Disabled elements have inconsistent behavior across browsers (#8661)
		items: "[title]:not([disabled])",
		position: {
			my: "left top+15",
			at: "left bottom",
			collision: "flipfit flip"
		},
		show: true,
		tooltipClass: null,
		track: false,

		// callbacks
		close: null,
		open: null
	},

	_addDescribedBy: function( elem, id ) {
		var describedby = (elem.attr( "aria-describedby" ) || "").split( /\s+/ );
		describedby.push( id );
		elem
			.data( "ui-tooltip-id", id )
			.attr( "aria-describedby", $.trim( describedby.join( " " ) ) );
	},

	_removeDescribedBy: function( elem ) {
		var id = elem.data( "ui-tooltip-id" ),
			describedby = (elem.attr( "aria-describedby" ) || "").split( /\s+/ ),
			index = $.inArray( id, describedby );

		if ( index !== -1 ) {
			describedby.splice( index, 1 );
		}

		elem.removeData( "ui-tooltip-id" );
		describedby = $.trim( describedby.join( " " ) );
		if ( describedby ) {
			elem.attr( "aria-describedby", describedby );
		} else {
			elem.removeAttr( "aria-describedby" );
		}
	},

	_create: function() {
		this._on({
			mouseover: "open",
			focusin: "open"
		});

		// IDs of generated tooltips, needed for destroy
		this.tooltips = {};

		// IDs of parent tooltips where we removed the title attribute
		this.parents = {};

		if ( this.options.disabled ) {
			this._disable();
		}

		// Append the aria-live region so tooltips announce correctly
		this.liveRegion = $( "<div>" )
			.attr({
				role: "log",
				"aria-live": "assertive",
				"aria-relevant": "additions"
			})
			.addClass( "ui-helper-hidden-accessible" )
			.appendTo( this.document[ 0 ].body );
	},

	_setOption: function( key, value ) {
		var that = this;

		if ( key === "disabled" ) {
			this[ value ? "_disable" : "_enable" ]();
			this.options[ key ] = value;
			// disable element style changes
			return;
		}

		this._super( key, value );

		if ( key === "content" ) {
			$.each( this.tooltips, function( id, tooltipData ) {
				that._updateContent( tooltipData.element );
			});
		}
	},

	_disable: function() {
		var that = this;

		// close open tooltips
		$.each( this.tooltips, function( id, tooltipData ) {
			var event = $.Event( "blur" );
			event.target = event.currentTarget = tooltipData.element[ 0 ];
			that.close( event, true );
		});

		// remove title attributes to prevent native tooltips
		this.element.find( this.options.items ).addBack().each(function() {
			var element = $( this );
			if ( element.is( "[title]" ) ) {
				element
					.data( "ui-tooltip-title", element.attr( "title" ) )
					.removeAttr( "title" );
			}
		});
	},

	_enable: function() {
		// restore title attributes
		this.element.find( this.options.items ).addBack().each(function() {
			var element = $( this );
			if ( element.data( "ui-tooltip-title" ) ) {
				element.attr( "title", element.data( "ui-tooltip-title" ) );
			}
		});
	},

	open: function( event ) {
		var that = this,
			target = $( event ? event.target : this.element )
				// we need closest here due to mouseover bubbling,
				// but always pointing at the same event target
				.closest( this.options.items );

		// No element to show a tooltip for or the tooltip is already open
		if ( !target.length || target.data( "ui-tooltip-id" ) ) {
			return;
		}

		if ( target.attr( "title" ) ) {
			target.data( "ui-tooltip-title", target.attr( "title" ) );
		}

		target.data( "ui-tooltip-open", true );

		// kill parent tooltips, custom or native, for hover
		if ( event && event.type === "mouseover" ) {
			target.parents().each(function() {
				var parent = $( this ),
					blurEvent;
				if ( parent.data( "ui-tooltip-open" ) ) {
					blurEvent = $.Event( "blur" );
					blurEvent.target = blurEvent.currentTarget = this;
					that.close( blurEvent, true );
				}
				if ( parent.attr( "title" ) ) {
					parent.uniqueId();
					that.parents[ this.id ] = {
						element: this,
						title: parent.attr( "title" )
					};
					parent.attr( "title", "" );
				}
			});
		}

		this._registerCloseHandlers( event, target );
		this._updateContent( target, event );
	},

	_updateContent: function( target, event ) {
		var content,
			contentOption = this.options.content,
			that = this,
			eventType = event ? event.type : null;

		if ( typeof contentOption === "string" ) {
			return this._open( event, target, contentOption );
		}

		content = contentOption.call( target[0], function( response ) {

			// IE may instantly serve a cached response for ajax requests
			// delay this call to _open so the other call to _open runs first
			that._delay(function() {

				// Ignore async response if tooltip was closed already
				if ( !target.data( "ui-tooltip-open" ) ) {
					return;
				}

				// jQuery creates a special event for focusin when it doesn't
				// exist natively. To improve performance, the native event
				// object is reused and the type is changed. Therefore, we can't
				// rely on the type being correct after the event finished
				// bubbling, so we set it back to the previous value. (#8740)
				if ( event ) {
					event.type = eventType;
				}
				this._open( event, target, response );
			});
		});
		if ( content ) {
			this._open( event, target, content );
		}
	},

	_open: function( event, target, content ) {
		var tooltipData, tooltip, delayedShow, a11yContent,
			positionOption = $.extend( {}, this.options.position );

		if ( !content ) {
			return;
		}

		// Content can be updated multiple times. If the tooltip already
		// exists, then just update the content and bail.
		tooltipData = this._find( target );
		if ( tooltipData ) {
			tooltipData.tooltip.find( ".ui-tooltip-content" ).html( content );
			return;
		}

		// if we have a title, clear it to prevent the native tooltip
		// we have to check first to avoid defining a title if none exists
		// (we don't want to cause an element to start matching [title])
		//
		// We use removeAttr only for key events, to allow IE to export the correct
		// accessible attributes. For mouse events, set to empty string to avoid
		// native tooltip showing up (happens only when removing inside mouseover).
		if ( target.is( "[title]" ) ) {
			if ( event && event.type === "mouseover" ) {
				target.attr( "title", "" );
			} else {
				target.removeAttr( "title" );
			}
		}

		tooltipData = this._tooltip( target );
		tooltip = tooltipData.tooltip;
		this._addDescribedBy( target, tooltip.attr( "id" ) );
		tooltip.find( ".ui-tooltip-content" ).html( content );

		// Support: Voiceover on OS X, JAWS on IE <= 9
		// JAWS announces deletions even when aria-relevant="additions"
		// Voiceover will sometimes re-read the entire log region's contents from the beginning
		this.liveRegion.children().hide();
		if ( content.clone ) {
			a11yContent = content.clone();
			a11yContent.removeAttr( "id" ).find( "[id]" ).removeAttr( "id" );
		} else {
			a11yContent = content;
		}
		$( "<div>" ).html( a11yContent ).appendTo( this.liveRegion );

		function position( event ) {
			positionOption.of = event;
			if ( tooltip.is( ":hidden" ) ) {
				return;
			}
			tooltip.position( positionOption );
		}
		if ( this.options.track && event && /^mouse/.test( event.type ) ) {
			this._on( this.document, {
				mousemove: position
			});
			// trigger once to override element-relative positioning
			position( event );
		} else {
			tooltip.position( $.extend({
				of: target
			}, this.options.position ) );
		}

		tooltip.hide();

		this._show( tooltip, this.options.show );
		// Handle tracking tooltips that are shown with a delay (#8644). As soon
		// as the tooltip is visible, position the tooltip using the most recent
		// event.
		if ( this.options.show && this.options.show.delay ) {
			delayedShow = this.delayedShow = setInterval(function() {
				if ( tooltip.is( ":visible" ) ) {
					position( positionOption.of );
					clearInterval( delayedShow );
				}
			}, $.fx.interval );
		}

		this._trigger( "open", event, { tooltip: tooltip } );
	},

	_registerCloseHandlers: function( event, target ) {
		var events = {
			keyup: function( event ) {
				if ( event.keyCode === $.ui.keyCode.ESCAPE ) {
					var fakeEvent = $.Event(event);
					fakeEvent.currentTarget = target[0];
					this.close( fakeEvent, true );
				}
			}
		};

		// Only bind remove handler for delegated targets. Non-delegated
		// tooltips will handle this in destroy.
		if ( target[ 0 ] !== this.element[ 0 ] ) {
			events.remove = function() {
				this._removeTooltip( this._find( target ).tooltip );
			};
		}

		if ( !event || event.type === "mouseover" ) {
			events.mouseleave = "close";
		}
		if ( !event || event.type === "focusin" ) {
			events.focusout = "close";
		}
		this._on( true, target, events );
	},

	close: function( event ) {
		var tooltip,
			that = this,
			target = $( event ? event.currentTarget : this.element ),
			tooltipData = this._find( target );

		// The tooltip may already be closed
		if ( !tooltipData ) {

			// We set ui-tooltip-open immediately upon open (in open()), but only set the
			// additional data once there's actually content to show (in _open()). So even if the
			// tooltip doesn't have full data, we always remove ui-tooltip-open in case we're in
			// the period between open() and _open().
			target.removeData( "ui-tooltip-open" );
			return;
		}

		tooltip = tooltipData.tooltip;

		// disabling closes the tooltip, so we need to track when we're closing
		// to avoid an infinite loop in case the tooltip becomes disabled on close
		if ( tooltipData.closing ) {
			return;
		}

		// Clear the interval for delayed tracking tooltips
		clearInterval( this.delayedShow );

		// only set title if we had one before (see comment in _open())
		// If the title attribute has changed since open(), don't restore
		if ( target.data( "ui-tooltip-title" ) && !target.attr( "title" ) ) {
			target.attr( "title", target.data( "ui-tooltip-title" ) );
		}

		this._removeDescribedBy( target );

		tooltipData.hiding = true;
		tooltip.stop( true );
		this._hide( tooltip, this.options.hide, function() {
			that._removeTooltip( $( this ) );
		});

		target.removeData( "ui-tooltip-open" );
		this._off( target, "mouseleave focusout keyup" );

		// Remove 'remove' binding only on delegated targets
		if ( target[ 0 ] !== this.element[ 0 ] ) {
			this._off( target, "remove" );
		}
		this._off( this.document, "mousemove" );

		if ( event && event.type === "mouseleave" ) {
			$.each( this.parents, function( id, parent ) {
				$( parent.element ).attr( "title", parent.title );
				delete that.parents[ id ];
			});
		}

		tooltipData.closing = true;
		this._trigger( "close", event, { tooltip: tooltip } );
		if ( !tooltipData.hiding ) {
			tooltipData.closing = false;
		}
	},

	_tooltip: function( element ) {
		var tooltip = $( "<div>" )
				.attr( "role", "tooltip" )
				.addClass( "ui-tooltip ui-widget ui-corner-all ui-widget-content " +
					( this.options.tooltipClass || "" ) ),
			id = tooltip.uniqueId().attr( "id" );

		$( "<div>" )
			.addClass( "ui-tooltip-content" )
			.appendTo( tooltip );

		tooltip.appendTo( this.document[0].body );

		return this.tooltips[ id ] = {
			element: element,
			tooltip: tooltip
		};
	},

	_find: function( target ) {
		var id = target.data( "ui-tooltip-id" );
		return id ? this.tooltips[ id ] : null;
	},

	_removeTooltip: function( tooltip ) {
		tooltip.remove();
		delete this.tooltips[ tooltip.attr( "id" ) ];
	},

	_destroy: function() {
		var that = this;

		// close open tooltips
		$.each( this.tooltips, function( id, tooltipData ) {
			// Delegate to close method to handle common cleanup
			var event = $.Event( "blur" ),
				element = tooltipData.element;
			event.target = event.currentTarget = element[ 0 ];
			that.close( event, true );

			// Remove immediately; destroying an open tooltip doesn't use the
			// hide animation
			$( "#" + id ).remove();

			// Restore the title
			if ( element.data( "ui-tooltip-title" ) ) {
				// If the title attribute has changed since open(), don't restore
				if ( !element.attr( "title" ) ) {
					element.attr( "title", element.data( "ui-tooltip-title" ) );
				}
				element.removeData( "ui-tooltip-title" );
			}
		});
		this.liveRegion.remove();
	}
});



}));
},{}],1129:[function(require,module,exports){
// shim for using process in browser
var process = module.exports = {};

// cached from whatever global is present so that test runners that stub it
// don't break things.  But we need to wrap it in a try catch in case it is
// wrapped in strict mode code which doesn't define any globals.  It's inside a
// function because try/catches deoptimize in certain engines.

var cachedSetTimeout;
var cachedClearTimeout;

function defaultSetTimout() {
    throw new Error('setTimeout has not been defined');
}
function defaultClearTimeout () {
    throw new Error('clearTimeout has not been defined');
}
(function () {
    try {
        if (typeof setTimeout === 'function') {
            cachedSetTimeout = setTimeout;
        } else {
            cachedSetTimeout = defaultSetTimout;
        }
    } catch (e) {
        cachedSetTimeout = defaultSetTimout;
    }
    try {
        if (typeof clearTimeout === 'function') {
            cachedClearTimeout = clearTimeout;
        } else {
            cachedClearTimeout = defaultClearTimeout;
        }
    } catch (e) {
        cachedClearTimeout = defaultClearTimeout;
    }
} ())
function runTimeout(fun) {
    if (cachedSetTimeout === setTimeout) {
        //normal enviroments in sane situations
        return setTimeout(fun, 0);
    }
    // if setTimeout wasn't available but was latter defined
    if ((cachedSetTimeout === defaultSetTimout || !cachedSetTimeout) && setTimeout) {
        cachedSetTimeout = setTimeout;
        return setTimeout(fun, 0);
    }
    try {
        // when when somebody has screwed with setTimeout but no I.E. maddness
        return cachedSetTimeout(fun, 0);
    } catch(e){
        try {
            // When we are in I.E. but the script has been evaled so I.E. doesn't trust the global object when called normally
            return cachedSetTimeout.call(null, fun, 0);
        } catch(e){
            // same as above but when it's a version of I.E. that must have the global object for 'this', hopfully our context correct otherwise it will throw a global error
            return cachedSetTimeout.call(this, fun, 0);
        }
    }


}
function runClearTimeout(marker) {
    if (cachedClearTimeout === clearTimeout) {
        //normal enviroments in sane situations
        return clearTimeout(marker);
    }
    // if clearTimeout wasn't available but was latter defined
    if ((cachedClearTimeout === defaultClearTimeout || !cachedClearTimeout) && clearTimeout) {
        cachedClearTimeout = clearTimeout;
        return clearTimeout(marker);
    }
    try {
        // when when somebody has screwed with setTimeout but no I.E. maddness
        return cachedClearTimeout(marker);
    } catch (e){
        try {
            // When we are in I.E. but the script has been evaled so I.E. doesn't  trust the global object when called normally
            return cachedClearTimeout.call(null, marker);
        } catch (e){
            // same as above but when it's a version of I.E. that must have the global object for 'this', hopfully our context correct otherwise it will throw a global error.
            // Some versions of I.E. have different rules for clearTimeout vs setTimeout
            return cachedClearTimeout.call(this, marker);
        }
    }



}
var queue = [];
var draining = false;
var currentQueue;
var queueIndex = -1;

function cleanUpNextTick() {
    if (!draining || !currentQueue) {
        return;
    }
    draining = false;
    if (currentQueue.length) {
        queue = currentQueue.concat(queue);
    } else {
        queueIndex = -1;
    }
    if (queue.length) {
        drainQueue();
    }
}

function drainQueue() {
    if (draining) {
        return;
    }
    var timeout = runTimeout(cleanUpNextTick);
    draining = true;

    var len = queue.length;
    while(len) {
        currentQueue = queue;
        queue = [];
        while (++queueIndex < len) {
            if (currentQueue) {
                currentQueue[queueIndex].run();
            }
        }
        queueIndex = -1;
        len = queue.length;
    }
    currentQueue = null;
    draining = false;
    runClearTimeout(timeout);
}

process.nextTick = function (fun) {
    var args = new Array(arguments.length - 1);
    if (arguments.length > 1) {
        for (var i = 1; i < arguments.length; i++) {
            args[i - 1] = arguments[i];
        }
    }
    queue.push(new Item(fun, args));
    if (queue.length === 1 && !draining) {
        runTimeout(drainQueue);
    }
};

// v8 likes predictible objects
function Item(fun, array) {
    this.fun = fun;
    this.array = array;
}
Item.prototype.run = function () {
    this.fun.apply(null, this.array);
};
process.title = 'browser';
process.browser = true;
process.env = {};
process.argv = [];
process.version = ''; // empty string to avoid regexp issues
process.versions = {};

function noop() {}

process.on = noop;
process.addListener = noop;
process.once = noop;
process.off = noop;
process.removeListener = noop;
process.removeAllListeners = noop;
process.emit = noop;
process.prependListener = noop;
process.prependOnceListener = noop;

process.listeners = function (name) { return [] }

process.binding = function (name) {
    throw new Error('process.binding is not supported');
};

process.cwd = function () { return '/' };
process.chdir = function (dir) {
    throw new Error('process.chdir is not supported');
};
process.umask = function() { return 0; };

},{}],1130:[function(require,module,exports){
if (typeof Object.create === 'function') {
  // implementation from standard node.js 'util' module
  module.exports = function inherits(ctor, superCtor) {
    ctor.super_ = superCtor
    ctor.prototype = Object.create(superCtor.prototype, {
      constructor: {
        value: ctor,
        enumerable: false,
        writable: true,
        configurable: true
      }
    });
  };
} else {
  // old school shim for old browsers
  module.exports = function inherits(ctor, superCtor) {
    ctor.super_ = superCtor
    var TempCtor = function () {}
    TempCtor.prototype = superCtor.prototype
    ctor.prototype = new TempCtor()
    ctor.prototype.constructor = ctor
  }
}

},{}],1131:[function(require,module,exports){
module.exports = function isBuffer(arg) {
  return arg && typeof arg === 'object'
    && typeof arg.copy === 'function'
    && typeof arg.fill === 'function'
    && typeof arg.readUInt8 === 'function';
}
},{}],1132:[function(require,module,exports){
(function (process,global){
// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

var formatRegExp = /%[sdj%]/g;
exports.format = function(f) {
  if (!isString(f)) {
    var objects = [];
    for (var i = 0; i < arguments.length; i++) {
      objects.push(inspect(arguments[i]));
    }
    return objects.join(' ');
  }

  var i = 1;
  var args = arguments;
  var len = args.length;
  var str = String(f).replace(formatRegExp, function(x) {
    if (x === '%%') return '%';
    if (i >= len) return x;
    switch (x) {
      case '%s': return String(args[i++]);
      case '%d': return Number(args[i++]);
      case '%j':
        try {
          return JSON.stringify(args[i++]);
        } catch (_) {
          return '[Circular]';
        }
      default:
        return x;
    }
  });
  for (var x = args[i]; i < len; x = args[++i]) {
    if (isNull(x) || !isObject(x)) {
      str += ' ' + x;
    } else {
      str += ' ' + inspect(x);
    }
  }
  return str;
};


// Mark that a method should not be used.
// Returns a modified function which warns once by default.
// If --no-deprecation is set, then it is a no-op.
exports.deprecate = function(fn, msg) {
  // Allow for deprecating things in the process of starting up.
  if (isUndefined(global.process)) {
    return function() {
      return exports.deprecate(fn, msg).apply(this, arguments);
    };
  }

  if (process.noDeprecation === true) {
    return fn;
  }

  var warned = false;
  function deprecated() {
    if (!warned) {
      if (process.throwDeprecation) {
        throw new Error(msg);
      } else if (process.traceDeprecation) {
        console.trace(msg);
      } else {
        console.error(msg);
      }
      warned = true;
    }
    return fn.apply(this, arguments);
  }

  return deprecated;
};


var debugs = {};
var debugEnviron;
exports.debuglog = function(set) {
  if (isUndefined(debugEnviron))
    debugEnviron = process.env.NODE_DEBUG || '';
  set = set.toUpperCase();
  if (!debugs[set]) {
    if (new RegExp('\\b' + set + '\\b', 'i').test(debugEnviron)) {
      var pid = process.pid;
      debugs[set] = function() {
        var msg = exports.format.apply(exports, arguments);
        console.error('%s %d: %s', set, pid, msg);
      };
    } else {
      debugs[set] = function() {};
    }
  }
  return debugs[set];
};


/**
 * Echos the value of a value. Trys to print the value out
 * in the best way possible given the different types.
 *
 * @param {Object} obj The object to print out.
 * @param {Object} opts Optional options object that alters the output.
 */
/* legacy: obj, showHidden, depth, colors*/
function inspect(obj, opts) {
  // default options
  var ctx = {
    seen: [],
    stylize: stylizeNoColor
  };
  // legacy...
  if (arguments.length >= 3) ctx.depth = arguments[2];
  if (arguments.length >= 4) ctx.colors = arguments[3];
  if (isBoolean(opts)) {
    // legacy...
    ctx.showHidden = opts;
  } else if (opts) {
    // got an "options" object
    exports._extend(ctx, opts);
  }
  // set default options
  if (isUndefined(ctx.showHidden)) ctx.showHidden = false;
  if (isUndefined(ctx.depth)) ctx.depth = 2;
  if (isUndefined(ctx.colors)) ctx.colors = false;
  if (isUndefined(ctx.customInspect)) ctx.customInspect = true;
  if (ctx.colors) ctx.stylize = stylizeWithColor;
  return formatValue(ctx, obj, ctx.depth);
}
exports.inspect = inspect;


// http://en.wikipedia.org/wiki/ANSI_escape_code#graphics
inspect.colors = {
  'bold' : [1, 22],
  'italic' : [3, 23],
  'underline' : [4, 24],
  'inverse' : [7, 27],
  'white' : [37, 39],
  'grey' : [90, 39],
  'black' : [30, 39],
  'blue' : [34, 39],
  'cyan' : [36, 39],
  'green' : [32, 39],
  'magenta' : [35, 39],
  'red' : [31, 39],
  'yellow' : [33, 39]
};

// Don't use 'blue' not visible on cmd.exe
inspect.styles = {
  'special': 'cyan',
  'number': 'yellow',
  'boolean': 'yellow',
  'undefined': 'grey',
  'null': 'bold',
  'string': 'green',
  'date': 'magenta',
  // "name": intentionally not styling
  'regexp': 'red'
};


function stylizeWithColor(str, styleType) {
  var style = inspect.styles[styleType];

  if (style) {
    return '\u001b[' + inspect.colors[style][0] + 'm' + str +
           '\u001b[' + inspect.colors[style][1] + 'm';
  } else {
    return str;
  }
}


function stylizeNoColor(str, styleType) {
  return str;
}


function arrayToHash(array) {
  var hash = {};

  array.forEach(function(val, idx) {
    hash[val] = true;
  });

  return hash;
}


function formatValue(ctx, value, recurseTimes) {
  // Provide a hook for user-specified inspect functions.
  // Check that value is an object with an inspect function on it
  if (ctx.customInspect &&
      value &&
      isFunction(value.inspect) &&
      // Filter out the util module, it's inspect function is special
      value.inspect !== exports.inspect &&
      // Also filter out any prototype objects using the circular check.
      !(value.constructor && value.constructor.prototype === value)) {
    var ret = value.inspect(recurseTimes, ctx);
    if (!isString(ret)) {
      ret = formatValue(ctx, ret, recurseTimes);
    }
    return ret;
  }

  // Primitive types cannot have properties
  var primitive = formatPrimitive(ctx, value);
  if (primitive) {
    return primitive;
  }

  // Look up the keys of the object.
  var keys = Object.keys(value);
  var visibleKeys = arrayToHash(keys);

  if (ctx.showHidden) {
    keys = Object.getOwnPropertyNames(value);
  }

  // IE doesn't make error fields non-enumerable
  // http://msdn.microsoft.com/en-us/library/ie/dww52sbt(v=vs.94).aspx
  if (isError(value)
      && (keys.indexOf('message') >= 0 || keys.indexOf('description') >= 0)) {
    return formatError(value);
  }

  // Some type of object without properties can be shortcutted.
  if (keys.length === 0) {
    if (isFunction(value)) {
      var name = value.name ? ': ' + value.name : '';
      return ctx.stylize('[Function' + name + ']', 'special');
    }
    if (isRegExp(value)) {
      return ctx.stylize(RegExp.prototype.toString.call(value), 'regexp');
    }
    if (isDate(value)) {
      return ctx.stylize(Date.prototype.toString.call(value), 'date');
    }
    if (isError(value)) {
      return formatError(value);
    }
  }

  var base = '', array = false, braces = ['{', '}'];

  // Make Array say that they are Array
  if (isArray(value)) {
    array = true;
    braces = ['[', ']'];
  }

  // Make functions say that they are functions
  if (isFunction(value)) {
    var n = value.name ? ': ' + value.name : '';
    base = ' [Function' + n + ']';
  }

  // Make RegExps say that they are RegExps
  if (isRegExp(value)) {
    base = ' ' + RegExp.prototype.toString.call(value);
  }

  // Make dates with properties first say the date
  if (isDate(value)) {
    base = ' ' + Date.prototype.toUTCString.call(value);
  }

  // Make error with message first say the error
  if (isError(value)) {
    base = ' ' + formatError(value);
  }

  if (keys.length === 0 && (!array || value.length == 0)) {
    return braces[0] + base + braces[1];
  }

  if (recurseTimes < 0) {
    if (isRegExp(value)) {
      return ctx.stylize(RegExp.prototype.toString.call(value), 'regexp');
    } else {
      return ctx.stylize('[Object]', 'special');
    }
  }

  ctx.seen.push(value);

  var output;
  if (array) {
    output = formatArray(ctx, value, recurseTimes, visibleKeys, keys);
  } else {
    output = keys.map(function(key) {
      return formatProperty(ctx, value, recurseTimes, visibleKeys, key, array);
    });
  }

  ctx.seen.pop();

  return reduceToSingleString(output, base, braces);
}


function formatPrimitive(ctx, value) {
  if (isUndefined(value))
    return ctx.stylize('undefined', 'undefined');
  if (isString(value)) {
    var simple = '\'' + JSON.stringify(value).replace(/^"|"$/g, '')
                                             .replace(/'/g, "\\'")
                                             .replace(/\\"/g, '"') + '\'';
    return ctx.stylize(simple, 'string');
  }
  if (isNumber(value))
    return ctx.stylize('' + value, 'number');
  if (isBoolean(value))
    return ctx.stylize('' + value, 'boolean');
  // For some reason typeof null is "object", so special case here.
  if (isNull(value))
    return ctx.stylize('null', 'null');
}


function formatError(value) {
  return '[' + Error.prototype.toString.call(value) + ']';
}


function formatArray(ctx, value, recurseTimes, visibleKeys, keys) {
  var output = [];
  for (var i = 0, l = value.length; i < l; ++i) {
    if (hasOwnProperty(value, String(i))) {
      output.push(formatProperty(ctx, value, recurseTimes, visibleKeys,
          String(i), true));
    } else {
      output.push('');
    }
  }
  keys.forEach(function(key) {
    if (!key.match(/^\d+$/)) {
      output.push(formatProperty(ctx, value, recurseTimes, visibleKeys,
          key, true));
    }
  });
  return output;
}


function formatProperty(ctx, value, recurseTimes, visibleKeys, key, array) {
  var name, str, desc;
  desc = Object.getOwnPropertyDescriptor(value, key) || { value: value[key] };
  if (desc.get) {
    if (desc.set) {
      str = ctx.stylize('[Getter/Setter]', 'special');
    } else {
      str = ctx.stylize('[Getter]', 'special');
    }
  } else {
    if (desc.set) {
      str = ctx.stylize('[Setter]', 'special');
    }
  }
  if (!hasOwnProperty(visibleKeys, key)) {
    name = '[' + key + ']';
  }
  if (!str) {
    if (ctx.seen.indexOf(desc.value) < 0) {
      if (isNull(recurseTimes)) {
        str = formatValue(ctx, desc.value, null);
      } else {
        str = formatValue(ctx, desc.value, recurseTimes - 1);
      }
      if (str.indexOf('\n') > -1) {
        if (array) {
          str = str.split('\n').map(function(line) {
            return '  ' + line;
          }).join('\n').substr(2);
        } else {
          str = '\n' + str.split('\n').map(function(line) {
            return '   ' + line;
          }).join('\n');
        }
      }
    } else {
      str = ctx.stylize('[Circular]', 'special');
    }
  }
  if (isUndefined(name)) {
    if (array && key.match(/^\d+$/)) {
      return str;
    }
    name = JSON.stringify('' + key);
    if (name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)) {
      name = name.substr(1, name.length - 2);
      name = ctx.stylize(name, 'name');
    } else {
      name = name.replace(/'/g, "\\'")
                 .replace(/\\"/g, '"')
                 .replace(/(^"|"$)/g, "'");
      name = ctx.stylize(name, 'string');
    }
  }

  return name + ': ' + str;
}


function reduceToSingleString(output, base, braces) {
  var numLinesEst = 0;
  var length = output.reduce(function(prev, cur) {
    numLinesEst++;
    if (cur.indexOf('\n') >= 0) numLinesEst++;
    return prev + cur.replace(/\u001b\[\d\d?m/g, '').length + 1;
  }, 0);

  if (length > 60) {
    return braces[0] +
           (base === '' ? '' : base + '\n ') +
           ' ' +
           output.join(',\n  ') +
           ' ' +
           braces[1];
  }

  return braces[0] + base + ' ' + output.join(', ') + ' ' + braces[1];
}


// NOTE: These type checking functions intentionally don't use `instanceof`
// because it is fragile and can be easily faked with `Object.create()`.
function isArray(ar) {
  return Array.isArray(ar);
}
exports.isArray = isArray;

function isBoolean(arg) {
  return typeof arg === 'boolean';
}
exports.isBoolean = isBoolean;

function isNull(arg) {
  return arg === null;
}
exports.isNull = isNull;

function isNullOrUndefined(arg) {
  return arg == null;
}
exports.isNullOrUndefined = isNullOrUndefined;

function isNumber(arg) {
  return typeof arg === 'number';
}
exports.isNumber = isNumber;

function isString(arg) {
  return typeof arg === 'string';
}
exports.isString = isString;

function isSymbol(arg) {
  return typeof arg === 'symbol';
}
exports.isSymbol = isSymbol;

function isUndefined(arg) {
  return arg === void 0;
}
exports.isUndefined = isUndefined;

function isRegExp(re) {
  return isObject(re) && objectToString(re) === '[object RegExp]';
}
exports.isRegExp = isRegExp;

function isObject(arg) {
  return typeof arg === 'object' && arg !== null;
}
exports.isObject = isObject;

function isDate(d) {
  return isObject(d) && objectToString(d) === '[object Date]';
}
exports.isDate = isDate;

function isError(e) {
  return isObject(e) &&
      (objectToString(e) === '[object Error]' || e instanceof Error);
}
exports.isError = isError;

function isFunction(arg) {
  return typeof arg === 'function';
}
exports.isFunction = isFunction;

function isPrimitive(arg) {
  return arg === null ||
         typeof arg === 'boolean' ||
         typeof arg === 'number' ||
         typeof arg === 'string' ||
         typeof arg === 'symbol' ||  // ES6 symbol
         typeof arg === 'undefined';
}
exports.isPrimitive = isPrimitive;

exports.isBuffer = require('./support/isBuffer');

function objectToString(o) {
  return Object.prototype.toString.call(o);
}


function pad(n) {
  return n < 10 ? '0' + n.toString(10) : n.toString(10);
}


var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep',
              'Oct', 'Nov', 'Dec'];

// 26 Feb 16:19:34
function timestamp() {
  var d = new Date();
  var time = [pad(d.getHours()),
              pad(d.getMinutes()),
              pad(d.getSeconds())].join(':');
  return [d.getDate(), months[d.getMonth()], time].join(' ');
}


// log is just a thin wrapper to console.log that prepends a timestamp
exports.log = function() {
  console.log('%s - %s', timestamp(), exports.format.apply(exports, arguments));
};


/**
 * Inherit the prototype methods from one constructor into another.
 *
 * The Function.prototype.inherits from lang.js rewritten as a standalone
 * function (not on Function.prototype). NOTE: If this file is to be loaded
 * during bootstrapping this function needs to be rewritten using some native
 * functions as prototype setup using normal JavaScript does not work as
 * expected during bootstrapping (see mirror.js in r114903).
 *
 * @param {function} ctor Constructor function which needs to inherit the
 *     prototype.
 * @param {function} superCtor Constructor function to inherit prototype from.
 */
exports.inherits = require('inherits');

exports._extend = function(origin, add) {
  // Don't do anything if add isn't an object
  if (!add || !isObject(add)) return origin;

  var keys = Object.keys(add);
  var i = keys.length;
  while (i--) {
    origin[keys[i]] = add[keys[i]];
  }
  return origin;
};

function hasOwnProperty(obj, prop) {
  return Object.prototype.hasOwnProperty.call(obj, prop);
}

}).call(this,require('_process'),typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})

},{"./support/isBuffer":1131,"_process":1129,"inherits":1130}],1133:[function(require,module,exports){
/**
 *
 * Date picker
 * Author: Stefan Petre www.eyecon.ro
 * 
 * Dual licensed under the MIT and GPL licenses
 * 
 */
(function ($) {
	var DatePicker = function () {
		var	ids = {},
			views = {
				years: 'datepickerViewYears',
				moths: 'datepickerViewMonths',
				days: 'datepickerViewDays'
			},
			tpl = {
				wrapper: '<div class="datepicker"><div class="datepickerBorderT" /><div class="datepickerBorderB" /><div class="datepickerBorderL" /><div class="datepickerBorderR" /><div class="datepickerBorderTL" /><div class="datepickerBorderTR" /><div class="datepickerBorderBL" /><div class="datepickerBorderBR" /><div class="datepickerContainer"><table cellspacing="0" cellpadding="0"><tbody><tr></tr></tbody></table></div></div>',
				head: [
					'<td>',
					'<table cellspacing="0" cellpadding="0">',
						'<thead>',
							'<tr>',
								'<th class="datepickerGoPrev"><a href="#"><span><%=prev%></span></a></th>',
								'<th colspan="5" class="datepickerMonth"><a href="#"><span></span></a></th>',
								'<th class="datepickerGoNext"><a href="#"><span><%=next%></span></a></th>',
							'</tr>',
							'<tr class="datepickerDoW">',
								'<th><span><%=week%></span></th>',
								'<th><span><%=day1%></span></th>',
								'<th><span><%=day2%></span></th>',
								'<th><span><%=day3%></span></th>',
								'<th><span><%=day4%></span></th>',
								'<th><span><%=day5%></span></th>',
								'<th><span><%=day6%></span></th>',
								'<th><span><%=day7%></span></th>',
							'</tr>',
						'</thead>',
					'</table></td>'
				],
				space : '<td class="datepickerSpace"><div></div></td>',
				days: [
					'<tbody class="datepickerDays">',
						'<tr>',
							'<th class="datepickerWeek"><a href="#"><span><%=weeks[0].week%></span></a></th>',
							'<td class="<%=weeks[0].days[0].classname%>"><a href="#"><span><%=weeks[0].days[0].text%></span></a></td>',
							'<td class="<%=weeks[0].days[1].classname%>"><a href="#"><span><%=weeks[0].days[1].text%></span></a></td>',
							'<td class="<%=weeks[0].days[2].classname%>"><a href="#"><span><%=weeks[0].days[2].text%></span></a></td>',
							'<td class="<%=weeks[0].days[3].classname%>"><a href="#"><span><%=weeks[0].days[3].text%></span></a></td>',
							'<td class="<%=weeks[0].days[4].classname%>"><a href="#"><span><%=weeks[0].days[4].text%></span></a></td>',
							'<td class="<%=weeks[0].days[5].classname%>"><a href="#"><span><%=weeks[0].days[5].text%></span></a></td>',
							'<td class="<%=weeks[0].days[6].classname%>"><a href="#"><span><%=weeks[0].days[6].text%></span></a></td>',
						'</tr>',
						'<tr>',
							'<th class="datepickerWeek"><a href="#"><span><%=weeks[1].week%></span></a></th>',
							'<td class="<%=weeks[1].days[0].classname%>"><a href="#"><span><%=weeks[1].days[0].text%></span></a></td>',
							'<td class="<%=weeks[1].days[1].classname%>"><a href="#"><span><%=weeks[1].days[1].text%></span></a></td>',
							'<td class="<%=weeks[1].days[2].classname%>"><a href="#"><span><%=weeks[1].days[2].text%></span></a></td>',
							'<td class="<%=weeks[1].days[3].classname%>"><a href="#"><span><%=weeks[1].days[3].text%></span></a></td>',
							'<td class="<%=weeks[1].days[4].classname%>"><a href="#"><span><%=weeks[1].days[4].text%></span></a></td>',
							'<td class="<%=weeks[1].days[5].classname%>"><a href="#"><span><%=weeks[1].days[5].text%></span></a></td>',
							'<td class="<%=weeks[1].days[6].classname%>"><a href="#"><span><%=weeks[1].days[6].text%></span></a></td>',
						'</tr>',
						'<tr>',
							'<th class="datepickerWeek"><a href="#"><span><%=weeks[2].week%></span></a></th>',
							'<td class="<%=weeks[2].days[0].classname%>"><a href="#"><span><%=weeks[2].days[0].text%></span></a></td>',
							'<td class="<%=weeks[2].days[1].classname%>"><a href="#"><span><%=weeks[2].days[1].text%></span></a></td>',
							'<td class="<%=weeks[2].days[2].classname%>"><a href="#"><span><%=weeks[2].days[2].text%></span></a></td>',
							'<td class="<%=weeks[2].days[3].classname%>"><a href="#"><span><%=weeks[2].days[3].text%></span></a></td>',
							'<td class="<%=weeks[2].days[4].classname%>"><a href="#"><span><%=weeks[2].days[4].text%></span></a></td>',
							'<td class="<%=weeks[2].days[5].classname%>"><a href="#"><span><%=weeks[2].days[5].text%></span></a></td>',
							'<td class="<%=weeks[2].days[6].classname%>"><a href="#"><span><%=weeks[2].days[6].text%></span></a></td>',
						'</tr>',
						'<tr>',
							'<th class="datepickerWeek"><a href="#"><span><%=weeks[3].week%></span></a></th>',
							'<td class="<%=weeks[3].days[0].classname%>"><a href="#"><span><%=weeks[3].days[0].text%></span></a></td>',
							'<td class="<%=weeks[3].days[1].classname%>"><a href="#"><span><%=weeks[3].days[1].text%></span></a></td>',
							'<td class="<%=weeks[3].days[2].classname%>"><a href="#"><span><%=weeks[3].days[2].text%></span></a></td>',
							'<td class="<%=weeks[3].days[3].classname%>"><a href="#"><span><%=weeks[3].days[3].text%></span></a></td>',
							'<td class="<%=weeks[3].days[4].classname%>"><a href="#"><span><%=weeks[3].days[4].text%></span></a></td>',
							'<td class="<%=weeks[3].days[5].classname%>"><a href="#"><span><%=weeks[3].days[5].text%></span></a></td>',
							'<td class="<%=weeks[3].days[6].classname%>"><a href="#"><span><%=weeks[3].days[6].text%></span></a></td>',
						'</tr>',
						'<tr>',
							'<th class="datepickerWeek"><a href="#"><span><%=weeks[4].week%></span></a></th>',
							'<td class="<%=weeks[4].days[0].classname%>"><a href="#"><span><%=weeks[4].days[0].text%></span></a></td>',
							'<td class="<%=weeks[4].days[1].classname%>"><a href="#"><span><%=weeks[4].days[1].text%></span></a></td>',
							'<td class="<%=weeks[4].days[2].classname%>"><a href="#"><span><%=weeks[4].days[2].text%></span></a></td>',
							'<td class="<%=weeks[4].days[3].classname%>"><a href="#"><span><%=weeks[4].days[3].text%></span></a></td>',
							'<td class="<%=weeks[4].days[4].classname%>"><a href="#"><span><%=weeks[4].days[4].text%></span></a></td>',
							'<td class="<%=weeks[4].days[5].classname%>"><a href="#"><span><%=weeks[4].days[5].text%></span></a></td>',
							'<td class="<%=weeks[4].days[6].classname%>"><a href="#"><span><%=weeks[4].days[6].text%></span></a></td>',
						'</tr>',
						'<tr>',
							'<th class="datepickerWeek"><a href="#"><span><%=weeks[5].week%></span></a></th>',
							'<td class="<%=weeks[5].days[0].classname%>"><a href="#"><span><%=weeks[5].days[0].text%></span></a></td>',
							'<td class="<%=weeks[5].days[1].classname%>"><a href="#"><span><%=weeks[5].days[1].text%></span></a></td>',
							'<td class="<%=weeks[5].days[2].classname%>"><a href="#"><span><%=weeks[5].days[2].text%></span></a></td>',
							'<td class="<%=weeks[5].days[3].classname%>"><a href="#"><span><%=weeks[5].days[3].text%></span></a></td>',
							'<td class="<%=weeks[5].days[4].classname%>"><a href="#"><span><%=weeks[5].days[4].text%></span></a></td>',
							'<td class="<%=weeks[5].days[5].classname%>"><a href="#"><span><%=weeks[5].days[5].text%></span></a></td>',
							'<td class="<%=weeks[5].days[6].classname%>"><a href="#"><span><%=weeks[5].days[6].text%></span></a></td>',
						'</tr>',
					'</tbody>'
				],
				months: [
					'<tbody class="<%=className%>">',
						'<tr>',
							'<td colspan="2"><a href="#"><span><%=data[0]%></span></a></td>',
							'<td colspan="2"><a href="#"><span><%=data[1]%></span></a></td>',
							'<td colspan="2"><a href="#"><span><%=data[2]%></span></a></td>',
							'<td colspan="2"><a href="#"><span><%=data[3]%></span></a></td>',
						'</tr>',
						'<tr>',
							'<td colspan="2"><a href="#"><span><%=data[4]%></span></a></td>',
							'<td colspan="2"><a href="#"><span><%=data[5]%></span></a></td>',
							'<td colspan="2"><a href="#"><span><%=data[6]%></span></a></td>',
							'<td colspan="2"><a href="#"><span><%=data[7]%></span></a></td>',
						'</tr>',
						'<tr>',
							'<td colspan="2"><a href="#"><span><%=data[8]%></span></a></td>',
							'<td colspan="2"><a href="#"><span><%=data[9]%></span></a></td>',
							'<td colspan="2"><a href="#"><span><%=data[10]%></span></a></td>',
							'<td colspan="2"><a href="#"><span><%=data[11]%></span></a></td>',
						'</tr>',
					'</tbody>'
				]
			},
			defaults = {
				flat: false,
				starts: 1,
				prev: '&#9664;',
				next: '&#9654;',
				lastSel: false,
				mode: 'single',
				view: 'days',
				calendars: 1,
				format: 'Y-m-d',
				position: 'bottom',
				eventName: 'click',
				onRender: function(){return {};},
				onChange: function(){return true;},
				onShow: function(){return true;},
				onBeforeShow: function(){return true;},
				onHide: function(){return true;},
				locale: {
					days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"],
					daysShort: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
					daysMin: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa", "Su"],
					months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
					monthsShort: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
					weekMin: 'wk'
				}
			},
			fill = function(el) {
				var options = $(el).data('datepicker');
				var cal = $(el);
				var currentCal = Math.floor(options.calendars/2), date, data, dow, month, cnt = 0, week, days, indic, indic2, html, tblCal;
				cal.find('td>table tbody').remove();
				for (var i = 0; i < options.calendars; i++) {
					date = new Date(options.current);
					date.addMonths(-currentCal + i);
					tblCal = cal.find('table').eq(i+1);
					switch (tblCal[0].className) {
						case 'datepickerViewDays':
							dow = formatDate(date, 'B, Y');
							break;
						case 'datepickerViewMonths':
							dow = date.getFullYear();
							break;
						case 'datepickerViewYears':
							dow = (date.getFullYear()-6) + ' - ' + (date.getFullYear()+5);
							break;
					} 
					tblCal.find('thead tr:first th:eq(1) span').text(dow);
					dow = date.getFullYear()-6;
					data = {
						data: [],
						className: 'datepickerYears'
					}
					for ( var j = 0; j < 12; j++) {
						data.data.push(dow + j);
					}
					html = tmpl(tpl.months.join(''), data);
					date.setDate(1);
					data = {weeks:[], test: 10};
					month = date.getMonth();
					var dow = (date.getDay() - options.starts) % 7;
					date.addDays(-(dow + (dow < 0 ? 7 : 0)));
					week = -1;
					cnt = 0;
					while (cnt < 42) {
						indic = parseInt(cnt/7,10);
						indic2 = cnt%7;
						if (!data.weeks[indic]) {
							week = date.getWeekNumber();
							data.weeks[indic] = {
								week: week,
								days: []
							};
						}
						data.weeks[indic].days[indic2] = {
							text: date.getDate(),
							classname: []
						};
						if (month != date.getMonth()) {
							data.weeks[indic].days[indic2].classname.push('datepickerNotInMonth');
						}
						if (date.getDay() == 0) {
							data.weeks[indic].days[indic2].classname.push('datepickerSunday');
						}
						if (date.getDay() == 6) {
							data.weeks[indic].days[indic2].classname.push('datepickerSaturday');
						}
						var fromUser = options.onRender(date);
						var val = date.valueOf();

						if (val === options.date[0]) {
							data.weeks[indic].days[indic2].classname.push('datepickerSelectedFirst');
						}
						if ((val + 86399000) === options.date[1]) {
							data.weeks[indic].days[indic2].classname.push('datepickerSelectedLast');
						}
						if (fromUser.selected || options.date == val || $.inArray(val, options.date) > -1 || (options.mode == 'range' && val >= options.date[0] && val <= options.date[1])) {
							data.weeks[indic].days[indic2].classname.push('datepickerSelected');
						}
						if (fromUser.disabled) {
							data.weeks[indic].days[indic2].classname.push('datepickerDisabled');
						}
						if (fromUser.className) {
							data.weeks[indic].days[indic2].classname.push(fromUser.className);
						}
						data.weeks[indic].days[indic2].classname = data.weeks[indic].days[indic2].classname.join(' ');
						cnt++;
						date.addDays(1);
					}
					html = tmpl(tpl.days.join(''), data) + html;
					data = {
						data: options.locale.monthsShort,
						className: 'datepickerMonths'
					};
					html = tmpl(tpl.months.join(''), data) + html;
					tblCal.append(html);
				}
			},
			parseDate = function (date, format) {
				if (date.constructor == Date) {
					return new Date(date);
				}
				var parts = date.split(/\W+/);
				var against = format.split(/\W+/), d, m, y, h, min, now = new Date();
				for (var i = 0; i < parts.length; i++) {
					switch (against[i]) {
						case 'd':
						case 'e':
							d = parseInt(parts[i],10);
							break;
						case 'm':
							m = parseInt(parts[i], 10)-1;
							break;
						case 'Y':
						case 'y':
							y = parseInt(parts[i], 10);
							y += y > 100 ? 0 : (y < 29 ? 2000 : 1900);
							break;
						case 'H':
						case 'I':
						case 'k':
						case 'l':
							h = parseInt(parts[i], 10);
							break;
						case 'P':
						case 'p':
							if (/pm/i.test(parts[i]) && h < 12) {
								h += 12;
							} else if (/am/i.test(parts[i]) && h >= 12) {
								h -= 12;
							}
							break;
						case 'M':
							min = parseInt(parts[i], 10);
							break;
					}
				}
				return new Date(
					y === undefined ? now.getFullYear() : y,
					m === undefined ? now.getMonth() : m,
					d === undefined ? now.getDate() : d,
					h === undefined ? now.getHours() : h,
					min === undefined ? now.getMinutes() : min,
					0
				);
			},
			formatDate = function(date, format) {
				var m = date.getMonth();
				var d = date.getDate();
				var y = date.getFullYear();
				var wn = date.getWeekNumber();
				var w = date.getDay();
				var s = {};
				var hr = date.getHours();
				var pm = (hr >= 12);
				var ir = (pm) ? (hr - 12) : hr;
				var dy = date.getDayOfYear();
				if (ir == 0) {
					ir = 12;
				}
				var min = date.getMinutes();
				var sec = date.getSeconds();
				var parts = format.split(''), part;
				for ( var i = 0; i < parts.length; i++ ) {
					part = parts[i];
					switch (parts[i]) {
						case 'a':
							part = date.getDayName();
							break;
						case 'A':
							part = date.getDayName(true);
							break;
						case 'b':
							part = date.getMonthName();
							break;
						case 'B':
							part = date.getMonthName(true);
							break;
						case 'C':
							part = 1 + Math.floor(y / 100);
							break;
						case 'd':
							part = (d < 10) ? ("0" + d) : d;
							break;
						case 'e':
							part = d;
							break;
						case 'H':
							part = (hr < 10) ? ("0" + hr) : hr;
							break;
						case 'I':
							part = (ir < 10) ? ("0" + ir) : ir;
							break;
						case 'j':
							part = (dy < 100) ? ((dy < 10) ? ("00" + dy) : ("0" + dy)) : dy;
							break;
						case 'k':
							part = hr;
							break;
						case 'l':
							part = ir;
							break;
						case 'm':
							part = (m < 9) ? ("0" + (1+m)) : (1+m);
							break;
						case 'M':
							part = (min < 10) ? ("0" + min) : min;
							break;
						case 'p':
						case 'P':
							part = pm ? "PM" : "AM";
							break;
						case 's':
							part = Math.floor(date.getTime() / 1000);
							break;
						case 'S':
							part = (sec < 10) ? ("0" + sec) : sec;
							break;
						case 'u':
							part = w + 1;
							break;
						case 'w':
							part = w;
							break;
						case 'y':
							part = ('' + y).substr(2, 2);
							break;
						case 'Y':
							part = y;
							break;
					}
					parts[i] = part;
				}
				return parts.join('');
			},
			extendDate = function(options) {
				if (Date.prototype.tempDate) {
					return;
				}
				Date.prototype.tempDate = null;
				Date.prototype.months = options.months;
				Date.prototype.monthsShort = options.monthsShort;
				Date.prototype.days = options.days;
				Date.prototype.daysShort = options.daysShort;
				Date.prototype.getMonthName = function(fullName) {
					return this[fullName ? 'months' : 'monthsShort'][this.getMonth()];
				};
				Date.prototype.getDayName = function(fullName) {
					return this[fullName ? 'days' : 'daysShort'][this.getDay()];
				};
				Date.prototype.addDays = function (n) {
					this.setDate(this.getDate() + n);
					this.tempDate = this.getDate();
				};
				Date.prototype.addMonths = function (n) {
					if (this.tempDate == null) {
						this.tempDate = this.getDate();
					}
					this.setDate(1);
					this.setMonth(this.getMonth() + n);
					this.setDate(Math.min(this.tempDate, this.getMaxDays()));
				};
				Date.prototype.addYears = function (n) {
					if (this.tempDate == null) {
						this.tempDate = this.getDate();
					}
					this.setDate(1);
					this.setFullYear(this.getFullYear() + n);
					this.setDate(Math.min(this.tempDate, this.getMaxDays()));
				};
				Date.prototype.getMaxDays = function() {
					var tmpDate = new Date(Date.parse(this)),
						d = 28, m;
					m = tmpDate.getMonth();
					d = 28;
					while (tmpDate.getMonth() == m) {
						d ++;
						tmpDate.setDate(d);
					}
					return d - 1;
				};
				Date.prototype.getFirstDay = function() {
					var tmpDate = new Date(Date.parse(this));
					tmpDate.setDate(1);
					return tmpDate.getDay();
				};
				Date.prototype.getWeekNumber = function() {
					var tempDate = new Date(this);
					tempDate.setDate(tempDate.getDate() - (tempDate.getDay() + 6) % 7 + 3);
					var dms = tempDate.valueOf();
					tempDate.setMonth(0);
					tempDate.setDate(4);
					return Math.round((dms - tempDate.valueOf()) / (604800000)) + 1;
				};
				Date.prototype.getDayOfYear = function() {
					var now = new Date(this.getFullYear(), this.getMonth(), this.getDate(), 0, 0, 0);
					var then = new Date(this.getFullYear(), 0, 0, 0, 0, 0);
					var time = now - then;
					return Math.floor(time / 24*60*60*1000);
				};
			},
			layout = function (el) {
				var options = $(el).data('datepicker');
				var cal = $('#' + options.id);
				if (!options.extraHeight) {
					var divs = $(el).find('div');
					options.extraHeight = divs.get(0).offsetHeight + divs.get(1).offsetHeight;
					options.extraWidth = divs.get(2).offsetWidth + divs.get(3).offsetWidth;
				}
				var tbl = cal.find('table:first').get(0);
				var width = tbl.offsetWidth;
				var height = tbl.offsetHeight;
				cal.css({
					width: width + options.extraWidth + 'px',
					height: height + options.extraHeight + 'px'
				}).find('div.datepickerContainer').css({
					width: width + 'px',
					height: height + 'px'
				});
			},
			click = function(ev) {
				if ($(ev.target).is('span')) {
					ev.target = ev.target.parentNode;
				}
				var el = $(ev.target);
				if (el.is('a')) {
					ev.target.blur();
					if (el.hasClass('datepickerDisabled')) {
						return false;
					}
					var options = $(this).data('datepicker');
					var parentEl = el.parent();
					var tblEl = parentEl.parent().parent().parent();
					var tblIndex = $('table', this).index(tblEl.get(0)) - 1;
					var tmp = new Date(options.current);
					var changed = false;
					var fillIt = false;
					if (parentEl.is('th')) {
						if (parentEl.hasClass('datepickerWeek') && options.mode == 'range' && !parentEl.next().hasClass('datepickerDisabled')) {
							var val = parseInt(parentEl.next().text(), 10);
							tmp.addMonths(tblIndex - Math.floor(options.calendars/2));
							if (parentEl.next().hasClass('datepickerNotInMonth')) {
								tmp.addMonths(val > 15 ? -1 : 1);
							}
							tmp.setDate(val);
							options.date[0] = (tmp.setHours(0,0,0,0)).valueOf();
							tmp.setHours(23,59,59,0);
							tmp.addDays(6);
							options.date[1] = tmp.valueOf();
							fillIt = true;
							changed = true;
							options.lastSel = false;
						} else if (parentEl.hasClass('datepickerMonth')) {
							return false;
							// tmp.addMonths(tblIndex - Math.floor(options.calendars/2));
							// switch (tblEl.get(0).className) {
							// 	case 'datepickerViewDays':
							// 		tblEl.get(0).className = 'datepickerViewMonths';
							// 		el.find('span').text(tmp.getFullYear());
							// 		break;
							// 	case 'datepickerViewMonths':
							// 		tblEl.get(0).className = 'datepickerViewYears';
							// 		el.find('span').text((tmp.getFullYear()-6) + ' - ' + (tmp.getFullYear()+5));
							// 		break;
							// 	case 'datepickerViewYears':
							// 		tblEl.get(0).className = 'datepickerViewDays';
							// 		el.find('span').text(formatDate(tmp, 'B, Y'));
							// 		break;
							// }
						} else if (parentEl.parent().parent().is('thead')) {
							switch (tblEl.get(0).className) {
								case 'datepickerViewDays':
									options.current.addMonths(parentEl.hasClass('datepickerGoPrev') ? -1 : 1);
									break;
								case 'datepickerViewMonths':
									options.current.addYears(parentEl.hasClass('datepickerGoPrev') ? -1 : 1);
									break;
								case 'datepickerViewYears':
									options.current.addYears(parentEl.hasClass('datepickerGoPrev') ? -12 : 12);
									break;
							}
							fillIt = true;
						}
					} else if (parentEl.is('td') && !parentEl.hasClass('datepickerDisabled')) {
						switch (tblEl.get(0).className) {
							case 'datepickerViewMonths':
								options.current.setMonth(tblEl.find('tbody.datepickerMonths td').index(parentEl));
								options.current.setFullYear(parseInt(tblEl.find('thead th.datepickerMonth span').text(), 10));
								options.current.addMonths(Math.floor(options.calendars/2) - tblIndex);
								tblEl.get(0).className = 'datepickerViewDays';
								break;
							case 'datepickerViewYears':
								options.current.setFullYear(parseInt(el.text(), 10));
								tblEl.get(0).className = 'datepickerViewMonths';
								break;
							default:
								var val = parseInt(el.text(), 10);
								tmp.addMonths(tblIndex - Math.floor(options.calendars/2));
								if (parentEl.hasClass('datepickerNotInMonth')) {
									tmp.addMonths(val > 15 ? -1 : 1);
								}
								tmp.setDate(val);
								switch (options.mode) {
									case 'multiple':
										val = (tmp.setHours(0,0,0,0)).valueOf();
										if ($.inArray(val, options.date) > -1) {
											$.each(options.date, function(nr, dat){
												if (dat == val) {
													options.date.splice(nr,1);
													return false;
												}
											});
										} else {
											options.date.push(val);
										}
										break;
									case 'range':
										if (!options.lastSel) {
											options.date[0] = (tmp.setHours(0,0,0,0)).valueOf();
										}
										val = (tmp.setHours(23,59,59,0)).valueOf();
										if (val < options.date[0]) {
											options.date[1] = options.date[0] + 86399000;
											options.date[0] = val - 86399000;
										} else {
											options.date[1] = val;
										}
										options.lastSel = !options.lastSel;
										break;
									default:
										options.date = tmp.valueOf();
										break;
								}
								break;
						}
						fillIt = true;
						changed = true;
					}
					if (fillIt) {
						fill(this);
					}
					if (changed) {
						options.onChange.apply(this, prepareDate(options));
					}
				}
				return false;
			},
			prepareDate = function (options) {
				var tmp;
				if (options.mode == 'single') {
					tmp = new Date(options.date);
					return [formatDate(tmp, options.format), tmp, options.el];
				} else {
					tmp = [[],[], options.el];
					$.each(options.date, function(nr, val){
						var date = new Date(val);
						tmp[0].push(formatDate(date, options.format));
						tmp[1].push(date);
					});
					return tmp;
				}
			},
			getViewport = function () {
				var m = document.compatMode == 'CSS1Compat';
				return {
					l : window.pageXOffset || (m ? document.documentElement.scrollLeft : document.body.scrollLeft),
					t : window.pageYOffset || (m ? document.documentElement.scrollTop : document.body.scrollTop),
					w : window.innerWidth || (m ? document.documentElement.clientWidth : document.body.clientWidth),
					h : window.innerHeight || (m ? document.documentElement.clientHeight : document.body.clientHeight)
				};
			},
			isChildOf = function(parentEl, el, container) {
				if (parentEl == el) {
					return true;
				}
				if (parentEl.contains) {
					return parentEl.contains(el);
				}
				if ( parentEl.compareDocumentPosition ) {
					return !!(parentEl.compareDocumentPosition(el) & 16);
				}
				var prEl = el.parentNode;
				while(prEl && prEl != container) {
					if (prEl == parentEl)
						return true;
					prEl = prEl.parentNode;
				}
				return false;
			},
			show = function (ev) {
				var cal = $('#' + $(this).data('datepickerId'));
				if (!cal.is(':visible')) {
					var calEl = cal.get(0);
					fill(calEl);
					var options = cal.data('datepicker');
					options.onBeforeShow.apply(this, [cal.get(0)]);
					var pos = $(this).offset();
					var viewPort = getViewport();
					var top = pos.top;
					var left = pos.left;
					var oldDisplay = $.curCSS(calEl, 'display');
					cal.css({
						visibility: 'hidden',
						display: 'block'
					});
					layout(calEl);
					switch (options.position){
						case 'top':
							top -= calEl.offsetHeight;
							break;
						case 'left':
							left -= calEl.offsetWidth;
							break;
						case 'right':
							left += this.offsetWidth;
							break;
						case 'bottom':
							top += this.offsetHeight;
							break;
					}
					if (top + calEl.offsetHeight > viewPort.t + viewPort.h) {
						top = pos.top  - calEl.offsetHeight;
					}
					if (top < viewPort.t) {
						top = pos.top + this.offsetHeight + calEl.offsetHeight;
					}
					if (left + calEl.offsetWidth > viewPort.l + viewPort.w) {
						left = pos.left - calEl.offsetWidth;
					}
					if (left < viewPort.l) {
						left = pos.left + this.offsetWidth
					}
					cal.css({
						visibility: 'visible',
						display: 'block',
						top: top + 'px',
						left: left + 'px'
					});
					if (options.onShow.apply(this, [cal.get(0)]) != false) {
						cal.show();
					}
					$(document).bind('mousedown', {cal: cal, trigger: this}, hide);
				}
				return false;
			},
			hide = function (ev) {
				if (ev.target != ev.data.trigger && !isChildOf(ev.data.cal.get(0), ev.target, ev.data.cal.get(0))) {
					if (ev.data.cal.data('datepicker').onHide.apply(this, [ev.data.cal.get(0)]) != false) {
						ev.data.cal.hide();
					}
					$(document).unbind('mousedown', hide);
				}
			};
		return {
			init: function(options){
				options = $.extend({}, defaults, options||{});
				extendDate(options.locale);
				options.calendars = Math.max(1, parseInt(options.calendars,10)||1);
				options.mode = /single|multiple|range/.test(options.mode) ? options.mode : 'single';
				return this.each(function(){
					if (!$(this).data('datepicker')) {
						options.el = this;
						if (options.date.constructor == String) {
							options.date = parseDate(options.date, options.format);
							options.date.setHours(0,0,0,0);
						}
						if (options.mode != 'single') {
							if (options.date.constructor != Array) {
								options.date = [options.date.valueOf()];
								if (options.mode == 'range') {
									options.date.push(((new Date(options.date[0])).setHours(23,59,59,0)).valueOf());
								}
							} else {
								for (var i = 0; i < options.date.length; i++) {
									options.date[i] = (parseDate(options.date[i], options.format).setHours(0,0,0,0)).valueOf();
								}
								if (options.mode == 'range') {
									options.date[1] = ((new Date(options.date[1])).setHours(23,59,59,0)).valueOf();
								}
							}
						} else {
							options.date = options.date.valueOf();
						}
						if (!options.current) {
							options.current = new Date();
						} else {
							options.current = parseDate(options.current, options.format);
						} 
						options.current.setDate(1);
						options.current.setHours(0,0,0,0);
						var id = 'datepicker_' + parseInt(Math.random() * 1000), cnt;
						options.id = id;
						$(this).data('datepickerId', options.id);
						var cal = $(tpl.wrapper).attr('id', id).bind('click', click).data('datepicker', options);
						if (options.className) {
							cal.addClass(options.className);
						}
						var html = '';
						for (var i = 0; i < options.calendars; i++) {
							cnt = options.starts;
							if (i > 0) {
								html += tpl.space;
							}
							html += tmpl(tpl.head.join(''), {
									week: options.locale.weekMin,
									prev: options.prev,
									next: options.next,
									day1: options.locale.daysMin[(cnt++)%7],
									day2: options.locale.daysMin[(cnt++)%7],
									day3: options.locale.daysMin[(cnt++)%7],
									day4: options.locale.daysMin[(cnt++)%7],
									day5: options.locale.daysMin[(cnt++)%7],
									day6: options.locale.daysMin[(cnt++)%7],
									day7: options.locale.daysMin[(cnt++)%7]
								});
						}
						cal
							.find('tr:first').append(html)
								.find('table').addClass(views[options.view]);
						fill(cal.get(0));
						if (options.flat) {
							cal.appendTo(this).show().css('position', 'relative');
							layout(cal.get(0));
						} else {
							cal.appendTo(document.body);
							$(this).bind(options.eventName, show);
						}
					}
				});
			},
			showPicker: function() {
				return this.each( function () {
					if ($(this).data('datepickerId')) {
						show.apply(this);
					}
				});
			},
			hidePicker: function() {
				return this.each( function () {
					if ($(this).data('datepickerId')) {
						$('#' + $(this).data('datepickerId')).hide();
					}
				});
			},
			setDate: function(date, shiftTo){
				return this.each(function(){
					if ($(this).data('datepickerId')) {
						var cal = $('#' + $(this).data('datepickerId'));
						var options = cal.data('datepicker');
						options.date = date;
						if (options.date.constructor == String) {
							options.date = parseDate(options.date, options.format);
							options.date.setHours(0,0,0,0);
						}
						if (options.mode != 'single') {
							if (options.date.constructor != Array) {
								options.date = [options.date.valueOf()];
								if (options.mode == 'range') {
									options.date.push(((new Date(options.date[0])).setHours(23,59,59,0)).valueOf());
								}
							} else {
								for (var i = 0; i < options.date.length; i++) {
									options.date[i] = (parseDate(options.date[i], options.format).setHours(0,0,0,0)).valueOf();
								}
								if (options.mode == 'range') {
									options.date[1] = ((new Date(options.date[1])).setHours(23,59,59,0)).valueOf();
								}
							}
						} else {
							options.date = options.date.valueOf();
						}
						if (shiftTo) {
							options.current = new Date (options.mode != 'single' ? options.date[0] : options.date);
						}
						fill(cal.get(0));
					}
				});
			},
			getDate: function(formated) {
				if (this.size() > 0) {
					return prepareDate($('#' + $(this).data('datepickerId')).data('datepicker'))[formated ? 0 : 1];
				}
			},
			clear: function(){
				return this.each(function(){
					if ($(this).data('datepickerId')) {
						var cal = $('#' + $(this).data('datepickerId'));
						var options = cal.data('datepicker');
						if (options.mode != 'single') {
							options.date = [];
							fill(cal.get(0));
						}
					}
				});
			},
			fixLayout: function(){
				return this.each(function(){
					if ($(this).data('datepickerId')) {
						var cal = $('#' + $(this).data('datepickerId'));
						var options = cal.data('datepicker');
						if (options.flat) {
							layout(cal.get(0));
						}
					}
				});
			}
		};
	}();
	$.fn.extend({
		DatePicker: DatePicker.init,
		DatePickerHide: DatePicker.hidePicker,
		DatePickerShow: DatePicker.showPicker,
		DatePickerSetDate: DatePicker.setDate,
		DatePickerGetDate: DatePicker.getDate,
		DatePickerClear: DatePicker.clear,
		DatePickerLayout: DatePicker.fixLayout
	});
})(jQuery);

(function(){
  var cache = {};
 
  this.tmpl = function tmpl(str, data){
    // Figure out if we're getting a template, or if we need to
    // load the template - and be sure to cache the result.
    var fn = !/\W/.test(str) ?
      cache[str] = cache[str] ||
        tmpl(document.getElementById(str).innerHTML) :
     
      // Generate a reusable function that will serve as a template
      // generator (and which will be cached).
      new Function("obj",
        "var p=[],print=function(){p.push.apply(p,arguments);};" +
       
        // Introduce the data as local variables using with(){}
        "with(obj){p.push('" +
       
        // Convert the template into pure JavaScript
        str
          .replace(/[\r\t\n]/g, " ")
          .split("<%").join("\t")
          .replace(/((^|%>)[^\t]*)'/g, "$1\r")
          .replace(/\t=(.*?)%>/g, "',$1,'")
          .split("\t").join("');")
          .split("%>").join("p.push('")
          .split("\r").join("\\'")
      + "');}return p.join('');");
   
    // Provide some basic currying to the user
    return data ? fn( data ) : fn;
  };
})();
},{}],1134:[function(require,module,exports){

(function() {
  var Dragster,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  Dragster = (function() {
    function Dragster(el) {
      this.el = el;
      this.dragleave = __bind(this.dragleave, this);
      this.dragenter = __bind(this.dragenter, this);
      if (this.supportsEventConstructors()) {
        this.first = false;
        this.second = false;
        this.el.addEventListener("dragenter", this.dragenter, false);
        this.el.addEventListener("dragleave", this.dragleave, false);
      }
    }

    Dragster.prototype.dragenter = function(event) {
      if (this.first) {
        return this.second = true;
      } else {
        this.first = true;
        return this.el.dispatchEvent(new CustomEvent("dragster:enter", {
          bubbles: true,
          cancelable: true,
          detail: {
            dataTransfer: event.dataTransfer
          }
        }));
      }
    };

    Dragster.prototype.dragleave = function(event) {
      if (this.second) {
        this.second = false;
      } else if (this.first) {
        this.first = false;
      }
      if (!this.first && !this.second) {
        return this.el.dispatchEvent(new CustomEvent("dragster:leave", {
          bubbles: true,
          cancelable: true,
          detail: {
            dataTransfer: event.dataTransfer
          }
        }));
      }
    };

    Dragster.prototype.removeListeners = function() {
      this.el.removeEventListener("dragenter", this.dragenter, false);
      return this.el.removeEventListener("dragleave", this.dragleave, false);
    };

    Dragster.prototype.supportsEventConstructors = function() {
      try {
        new CustomEvent("z");
      } catch (_error) {
        return false;
      }
      return true;
    };

    Dragster.prototype.reset = function() {
      this.first = false;
      return this.second = false;
    };

    return Dragster;

  })();

  window.Dragster = Dragster;

}).call(this);

},{}],1135:[function(require,module,exports){

/*
 *
 * More info at [www.dropzonejs.com](http://www.dropzonejs.com)
 *
 * Copyright (c) 2012, Matias Meno
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *
 */

(function() {
  var Dropzone, Emitter, camelize, contentLoaded, detectVerticalSquash, drawImageIOSFix, noop, without,
    __slice = [].slice,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  noop = function() {};

  Emitter = (function() {
    function Emitter() {}

    Emitter.prototype.addEventListener = Emitter.prototype.on;

    Emitter.prototype.on = function(event, fn) {
      this._callbacks = this._callbacks || {};
      if (!this._callbacks[event]) {
        this._callbacks[event] = [];
      }
      this._callbacks[event].push(fn);
      return this;
    };

    Emitter.prototype.emit = function() {
      var args, callback, callbacks, event, _i, _len;
      event = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      this._callbacks = this._callbacks || {};
      callbacks = this._callbacks[event];
      if (callbacks) {
        for (_i = 0, _len = callbacks.length; _i < _len; _i++) {
          callback = callbacks[_i];
          callback.apply(this, args);
        }
      }
      return this;
    };

    Emitter.prototype.removeListener = Emitter.prototype.off;

    Emitter.prototype.removeAllListeners = Emitter.prototype.off;

    Emitter.prototype.removeEventListener = Emitter.prototype.off;

    Emitter.prototype.off = function(event, fn) {
      var callback, callbacks, i, _i, _len;
      if (!this._callbacks || arguments.length === 0) {
        this._callbacks = {};
        return this;
      }
      callbacks = this._callbacks[event];
      if (!callbacks) {
        return this;
      }
      if (arguments.length === 1) {
        delete this._callbacks[event];
        return this;
      }
      for (i = _i = 0, _len = callbacks.length; _i < _len; i = ++_i) {
        callback = callbacks[i];
        if (callback === fn) {
          callbacks.splice(i, 1);
          break;
        }
      }
      return this;
    };

    return Emitter;

  })();

  Dropzone = (function(_super) {
    var extend, resolveOption;

    __extends(Dropzone, _super);

    Dropzone.prototype.Emitter = Emitter;


    /*
    This is a list of all available events you can register on a dropzone object.
    
    You can register an event handler like this:
    
        dropzone.on("dragEnter", function() { });
     */

    Dropzone.prototype.events = ["drop", "dragstart", "dragend", "dragenter", "dragover", "dragleave", "addedfile", "removedfile", "thumbnail", "error", "errormultiple", "processing", "processingmultiple", "uploadprogress", "totaluploadprogress", "sending", "sendingmultiple", "success", "successmultiple", "canceled", "canceledmultiple", "complete", "completemultiple", "reset", "maxfilesexceeded", "maxfilesreached", "queuecomplete"];

    Dropzone.prototype.defaultOptions = {
      url: null,
      method: "post",
      withCredentials: false,
      parallelUploads: 2,
      uploadMultiple: false,
      maxFilesize: 256,
      paramName: "file",
      createImageThumbnails: true,
      maxThumbnailFilesize: 10,
      thumbnailWidth: 120,
      thumbnailHeight: 120,
      filesizeBase: 1000,
      maxFiles: null,
      filesizeBase: 1000,
      params: {},
      clickable: true,
      ignoreHiddenFiles: true,
      acceptedFiles: null,
      acceptedMimeTypes: null,
      autoProcessQueue: true,
      autoQueue: true,
      addRemoveLinks: false,
      previewsContainer: null,
      capture: null,
      dictDefaultMessage: "Drop files here to upload",
      dictFallbackMessage: "Your browser does not support drag'n'drop file uploads.",
      dictFallbackText: "Please use the fallback form below to upload your files like in the olden days.",
      dictFileTooBig: "File is too big ({{filesize}}MiB). Max filesize: {{maxFilesize}}MiB.",
      dictInvalidFileType: "You can't upload files of this type.",
      dictResponseError: "Server responded with {{statusCode}} code.",
      dictCancelUpload: "Cancel upload",
      dictCancelUploadConfirmation: "Are you sure you want to cancel this upload?",
      dictRemoveFile: "Remove file",
      dictRemoveFileConfirmation: null,
      dictMaxFilesExceeded: "You can not upload any more files.",
      accept: function(file, done) {
        return done();
      },
      init: function() {
        return noop;
      },
      forceFallback: false,
      fallback: function() {
        var child, messageElement, span, _i, _len, _ref;
        this.element.className = "" + this.element.className + " dz-browser-not-supported";
        _ref = this.element.getElementsByTagName("div");
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          child = _ref[_i];
          if (/(^| )dz-message($| )/.test(child.className)) {
            messageElement = child;
            child.className = "dz-message";
            continue;
          }
        }
        if (!messageElement) {
          messageElement = Dropzone.createElement("<div class=\"dz-message\"><span></span></div>");
          this.element.appendChild(messageElement);
        }
        span = messageElement.getElementsByTagName("span")[0];
        if (span) {
          span.textContent = this.options.dictFallbackMessage;
        }
        return this.element.appendChild(this.getFallbackForm());
      },
      resize: function(file) {
        var info, srcRatio, trgRatio;
        info = {
          srcX: 0,
          srcY: 0,
          srcWidth: file.width,
          srcHeight: file.height
        };
        srcRatio = file.width / file.height;
        info.optWidth = this.options.thumbnailWidth;
        info.optHeight = this.options.thumbnailHeight;
        if ((info.optWidth == null) && (info.optHeight == null)) {
          info.optWidth = info.srcWidth;
          info.optHeight = info.srcHeight;
        } else if (info.optWidth == null) {
          info.optWidth = srcRatio * info.optHeight;
        } else if (info.optHeight == null) {
          info.optHeight = (1 / srcRatio) * info.optWidth;
        }
        trgRatio = info.optWidth / info.optHeight;
        if (file.height < info.optHeight || file.width < info.optWidth) {
          info.trgHeight = info.srcHeight;
          info.trgWidth = info.srcWidth;
        } else {
          if (srcRatio > trgRatio) {
            info.srcHeight = file.height;
            info.srcWidth = info.srcHeight * trgRatio;
          } else {
            info.srcWidth = file.width;
            info.srcHeight = info.srcWidth / trgRatio;
          }
        }
        info.srcX = (file.width - info.srcWidth) / 2;
        info.srcY = (file.height - info.srcHeight) / 2;
        return info;
      },

      /*
      Those functions register themselves to the events on init and handle all
      the user interface specific stuff. Overwriting them won't break the upload
      but can break the way it's displayed.
      You can overwrite them if you don't like the default behavior. If you just
      want to add an additional event handler, register it on the dropzone object
      and don't overwrite those options.
       */
      drop: function(e) {
        return this.element.classList.remove("dz-drag-hover");
      },
      dragstart: noop,
      dragend: function(e) {
        return this.element.classList.remove("dz-drag-hover");
      },
      dragenter: function(e) {
        return this.element.classList.add("dz-drag-hover");
      },
      dragover: function(e) {
        return this.element.classList.add("dz-drag-hover");
      },
      dragleave: function(e) {
        return this.element.classList.remove("dz-drag-hover");
      },
      paste: noop,
      reset: function() {
        return this.element.classList.remove("dz-started");
      },
      addedfile: function(file) {
        var node, removeFileEvent, removeLink, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref2, _results;
        if (this.element === this.previewsContainer) {
          this.element.classList.add("dz-started");
        }
        if (this.previewsContainer) {
          file.previewElement = Dropzone.createElement(this.options.previewTemplate.trim());
          file.previewTemplate = file.previewElement;
          this.previewsContainer.appendChild(file.previewElement);
          _ref = file.previewElement.querySelectorAll("[data-dz-name]");
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            node = _ref[_i];
            node.textContent = file.name;
          }
          _ref1 = file.previewElement.querySelectorAll("[data-dz-size]");
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            node = _ref1[_j];
            node.innerHTML = this.filesize(file.size);
          }
          if (this.options.addRemoveLinks) {
            file._removeLink = Dropzone.createElement("<a class=\"dz-remove\" href=\"javascript:undefined;\" data-dz-remove>" + this.options.dictRemoveFile + "</a>");
            file.previewElement.appendChild(file._removeLink);
          }
          removeFileEvent = (function(_this) {
            return function(e) {
              e.preventDefault();
              e.stopPropagation();
              if (file.status === Dropzone.UPLOADING) {
                return Dropzone.confirm(_this.options.dictCancelUploadConfirmation, function() {
                  return _this.removeFile(file);
                });
              } else {
                if (_this.options.dictRemoveFileConfirmation) {
                  return Dropzone.confirm(_this.options.dictRemoveFileConfirmation, function() {
                    return _this.removeFile(file);
                  });
                } else {
                  return _this.removeFile(file);
                }
              }
            };
          })(this);
          _ref2 = file.previewElement.querySelectorAll("[data-dz-remove]");
          _results = [];
          for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
            removeLink = _ref2[_k];
            _results.push(removeLink.addEventListener("click", removeFileEvent));
          }
          return _results;
        }
      },
      removedfile: function(file) {
        var _ref;
        if (file.previewElement) {
          if ((_ref = file.previewElement) != null) {
            _ref.parentNode.removeChild(file.previewElement);
          }
        }
        return this._updateMaxFilesReachedClass();
      },
      thumbnail: function(file, dataUrl) {
        var thumbnailElement, _i, _len, _ref;
        if (file.previewElement) {
          file.previewElement.classList.remove("dz-file-preview");
          _ref = file.previewElement.querySelectorAll("[data-dz-thumbnail]");
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            thumbnailElement = _ref[_i];
            thumbnailElement.alt = file.name;
            thumbnailElement.src = dataUrl;
          }
          return setTimeout(((function(_this) {
            return function() {
              return file.previewElement.classList.add("dz-image-preview");
            };
          })(this)), 1);
        }
      },
      error: function(file, message) {
        var node, _i, _len, _ref, _results;
        if (file.previewElement) {
          file.previewElement.classList.add("dz-error");
          if (typeof message !== "String" && message.error) {
            message = message.error;
          }
          _ref = file.previewElement.querySelectorAll("[data-dz-errormessage]");
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            node = _ref[_i];
            _results.push(node.textContent = message);
          }
          return _results;
        }
      },
      errormultiple: noop,
      processing: function(file) {
        if (file.previewElement) {
          file.previewElement.classList.add("dz-processing");
          if (file._removeLink) {
            return file._removeLink.textContent = this.options.dictCancelUpload;
          }
        }
      },
      processingmultiple: noop,
      uploadprogress: function(file, progress, bytesSent) {
        var node, _i, _len, _ref, _results;
        if (file.previewElement) {
          _ref = file.previewElement.querySelectorAll("[data-dz-uploadprogress]");
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            node = _ref[_i];
            if (node.nodeName === 'PROGRESS') {
              _results.push(node.value = progress);
            } else {
              _results.push(node.style.width = "" + progress + "%");
            }
          }
          return _results;
        }
      },
      totaluploadprogress: noop,
      sending: noop,
      sendingmultiple: noop,
      success: function(file) {
        if (file.previewElement) {
          return file.previewElement.classList.add("dz-success");
        }
      },
      successmultiple: noop,
      canceled: function(file) {
        return this.emit("error", file, "Upload canceled.");
      },
      canceledmultiple: noop,
      complete: function(file) {
        if (file._removeLink) {
          file._removeLink.textContent = this.options.dictRemoveFile;
        }
        if (file.previewElement) {
          return file.previewElement.classList.add("dz-complete");
        }
      },
      completemultiple: noop,
      maxfilesexceeded: noop,
      maxfilesreached: noop,
      queuecomplete: noop,
      previewTemplate: "<div class=\"dz-preview dz-file-preview\">\n  <div class=\"dz-image\"><img data-dz-thumbnail /></div>\n  <div class=\"dz-details\">\n    <div class=\"dz-size\"><span data-dz-size></span></div>\n    <div class=\"dz-filename\"><span data-dz-name></span></div>\n  </div>\n  <div class=\"dz-progress\"><span class=\"dz-upload\" data-dz-uploadprogress></span></div>\n  <div class=\"dz-error-message\"><span data-dz-errormessage></span></div>\n  <div class=\"dz-success-mark\">\n    <svg width=\"54px\" height=\"54px\" viewBox=\"0 0 54 54\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" xmlns:sketch=\"http://www.bohemiancoding.com/sketch/ns\">\n      <title>Check</title>\n      <defs></defs>\n      <g id=\"Page-1\" stroke=\"none\" stroke-width=\"1\" fill=\"none\" fill-rule=\"evenodd\" sketch:type=\"MSPage\">\n        <path d=\"M23.5,31.8431458 L17.5852419,25.9283877 C16.0248253,24.3679711 13.4910294,24.366835 11.9289322,25.9289322 C10.3700136,27.4878508 10.3665912,30.0234455 11.9283877,31.5852419 L20.4147581,40.0716123 C20.5133999,40.1702541 20.6159315,40.2626649 20.7218615,40.3488435 C22.2835669,41.8725651 24.794234,41.8626202 26.3461564,40.3106978 L43.3106978,23.3461564 C44.8771021,21.7797521 44.8758057,19.2483887 43.3137085,17.6862915 C41.7547899,16.1273729 39.2176035,16.1255422 37.6538436,17.6893022 L23.5,31.8431458 Z M27,53 C41.3594035,53 53,41.3594035 53,27 C53,12.6405965 41.3594035,1 27,1 C12.6405965,1 1,12.6405965 1,27 C1,41.3594035 12.6405965,53 27,53 Z\" id=\"Oval-2\" stroke-opacity=\"0.198794158\" stroke=\"#747474\" fill-opacity=\"0.816519475\" fill=\"#FFFFFF\" sketch:type=\"MSShapeGroup\"></path>\n      </g>\n    </svg>\n  </div>\n  <div class=\"dz-error-mark\">\n    <svg width=\"54px\" height=\"54px\" viewBox=\"0 0 54 54\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" xmlns:sketch=\"http://www.bohemiancoding.com/sketch/ns\">\n      <title>Error</title>\n      <defs></defs>\n      <g id=\"Page-1\" stroke=\"none\" stroke-width=\"1\" fill=\"none\" fill-rule=\"evenodd\" sketch:type=\"MSPage\">\n        <g id=\"Check-+-Oval-2\" sketch:type=\"MSLayerGroup\" stroke=\"#747474\" stroke-opacity=\"0.198794158\" fill=\"#FFFFFF\" fill-opacity=\"0.816519475\">\n          <path d=\"M32.6568542,29 L38.3106978,23.3461564 C39.8771021,21.7797521 39.8758057,19.2483887 38.3137085,17.6862915 C36.7547899,16.1273729 34.2176035,16.1255422 32.6538436,17.6893022 L27,23.3431458 L21.3461564,17.6893022 C19.7823965,16.1255422 17.2452101,16.1273729 15.6862915,17.6862915 C14.1241943,19.2483887 14.1228979,21.7797521 15.6893022,23.3461564 L21.3431458,29 L15.6893022,34.6538436 C14.1228979,36.2202479 14.1241943,38.7516113 15.6862915,40.3137085 C17.2452101,41.8726271 19.7823965,41.8744578 21.3461564,40.3106978 L27,34.6568542 L32.6538436,40.3106978 C34.2176035,41.8744578 36.7547899,41.8726271 38.3137085,40.3137085 C39.8758057,38.7516113 39.8771021,36.2202479 38.3106978,34.6538436 L32.6568542,29 Z M27,53 C41.3594035,53 53,41.3594035 53,27 C53,12.6405965 41.3594035,1 27,1 C12.6405965,1 1,12.6405965 1,27 C1,41.3594035 12.6405965,53 27,53 Z\" id=\"Oval-2\" sketch:type=\"MSShapeGroup\"></path>\n        </g>\n      </g>\n    </svg>\n  </div>\n</div>"
    };

    extend = function() {
      var key, object, objects, target, val, _i, _len;
      target = arguments[0], objects = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      for (_i = 0, _len = objects.length; _i < _len; _i++) {
        object = objects[_i];
        for (key in object) {
          val = object[key];
          target[key] = val;
        }
      }
      return target;
    };

    function Dropzone(element, options) {
      var elementOptions, fallback, _ref;
      this.element = element;
      this.version = Dropzone.version;
      this.defaultOptions.previewTemplate = this.defaultOptions.previewTemplate.replace(/\n*/g, "");
      this.clickableElements = [];
      this.listeners = [];
      this.files = [];
      if (typeof this.element === "string") {
        this.element = document.querySelector(this.element);
      }
      if (!(this.element && (this.element.nodeType != null))) {
        throw new Error("Invalid dropzone element.");
      }
      if (this.element.dropzone) {
        throw new Error("Dropzone already attached.");
      }
      Dropzone.instances.push(this);
      this.element.dropzone = this;
      elementOptions = (_ref = Dropzone.optionsForElement(this.element)) != null ? _ref : {};
      this.options = extend({}, this.defaultOptions, elementOptions, options != null ? options : {});
      if (this.options.forceFallback || !Dropzone.isBrowserSupported()) {
        return this.options.fallback.call(this);
      }
      if (this.options.url == null) {
        this.options.url = this.element.getAttribute("action");
      }
      if (!this.options.url) {
        throw new Error("No URL provided.");
      }
      if (this.options.acceptedFiles && this.options.acceptedMimeTypes) {
        throw new Error("You can't provide both 'acceptedFiles' and 'acceptedMimeTypes'. 'acceptedMimeTypes' is deprecated.");
      }
      if (this.options.acceptedMimeTypes) {
        this.options.acceptedFiles = this.options.acceptedMimeTypes;
        delete this.options.acceptedMimeTypes;
      }
      this.options.method = this.options.method.toUpperCase();
      if ((fallback = this.getExistingFallback()) && fallback.parentNode) {
        fallback.parentNode.removeChild(fallback);
      }
      if (this.options.previewsContainer !== false) {
        if (this.options.previewsContainer) {
          this.previewsContainer = Dropzone.getElement(this.options.previewsContainer, "previewsContainer");
        } else {
          this.previewsContainer = this.element;
        }
      }
      if (this.options.clickable) {
        if (this.options.clickable === true) {
          this.clickableElements = [this.element];
        } else {
          this.clickableElements = Dropzone.getElements(this.options.clickable, "clickable");
        }
      }
      this.init();
    }

    Dropzone.prototype.getAcceptedFiles = function() {
      var file, _i, _len, _ref, _results;
      _ref = this.files;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        file = _ref[_i];
        if (file.accepted) {
          _results.push(file);
        }
      }
      return _results;
    };

    Dropzone.prototype.getRejectedFiles = function() {
      var file, _i, _len, _ref, _results;
      _ref = this.files;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        file = _ref[_i];
        if (!file.accepted) {
          _results.push(file);
        }
      }
      return _results;
    };

    Dropzone.prototype.getFilesWithStatus = function(status) {
      var file, _i, _len, _ref, _results;
      _ref = this.files;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        file = _ref[_i];
        if (file.status === status) {
          _results.push(file);
        }
      }
      return _results;
    };

    Dropzone.prototype.getQueuedFiles = function() {
      return this.getFilesWithStatus(Dropzone.QUEUED);
    };

    Dropzone.prototype.getUploadingFiles = function() {
      return this.getFilesWithStatus(Dropzone.UPLOADING);
    };

    Dropzone.prototype.getActiveFiles = function() {
      var file, _i, _len, _ref, _results;
      _ref = this.files;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        file = _ref[_i];
        if (file.status === Dropzone.UPLOADING || file.status === Dropzone.QUEUED) {
          _results.push(file);
        }
      }
      return _results;
    };

    Dropzone.prototype.init = function() {
      var eventName, noPropagation, setupHiddenFileInput, _i, _len, _ref, _ref1;
      if (this.element.tagName === "form") {
        this.element.setAttribute("enctype", "multipart/form-data");
      }
      if (this.element.classList.contains("dropzone") && !this.element.querySelector(".dz-message")) {
        this.element.appendChild(Dropzone.createElement("<div class=\"dz-default dz-message\"><span>" + this.options.dictDefaultMessage + "</span></div>"));
      }
      if (this.clickableElements.length) {
        setupHiddenFileInput = (function(_this) {
          return function() {
            if (_this.hiddenFileInput) {
              document.body.removeChild(_this.hiddenFileInput);
            }
            _this.hiddenFileInput = document.createElement("input");
            _this.hiddenFileInput.setAttribute("type", "file");
            if ((_this.options.maxFiles == null) || _this.options.maxFiles > 1) {
              _this.hiddenFileInput.setAttribute("multiple", "multiple");
            }
            _this.hiddenFileInput.className = "dz-hidden-input";
            if (_this.options.acceptedFiles != null) {
              _this.hiddenFileInput.setAttribute("accept", _this.options.acceptedFiles);
            }
            if (_this.options.capture != null) {
              _this.hiddenFileInput.setAttribute("capture", _this.options.capture);
            }
            _this.hiddenFileInput.style.visibility = "hidden";
            _this.hiddenFileInput.style.position = "absolute";
            _this.hiddenFileInput.style.top = "0";
            _this.hiddenFileInput.style.left = "0";
            _this.hiddenFileInput.style.height = "0";
            _this.hiddenFileInput.style.width = "0";
            document.body.appendChild(_this.hiddenFileInput);
            return _this.hiddenFileInput.addEventListener("change", function() {
              var file, files, _i, _len;
              files = _this.hiddenFileInput.files;
              if (files.length) {
                for (_i = 0, _len = files.length; _i < _len; _i++) {
                  file = files[_i];
                  _this.addFile(file);
                }
              }
              return setupHiddenFileInput();
            });
          };
        })(this);
        setupHiddenFileInput();
      }
      this.URL = (_ref = window.URL) != null ? _ref : window.webkitURL;
      _ref1 = this.events;
      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
        eventName = _ref1[_i];
        this.on(eventName, this.options[eventName]);
      }
      this.on("uploadprogress", (function(_this) {
        return function() {
          return _this.updateTotalUploadProgress();
        };
      })(this));
      this.on("removedfile", (function(_this) {
        return function() {
          return _this.updateTotalUploadProgress();
        };
      })(this));
      this.on("canceled", (function(_this) {
        return function(file) {
          return _this.emit("complete", file);
        };
      })(this));
      this.on("complete", (function(_this) {
        return function(file) {
          if (_this.getUploadingFiles().length === 0 && _this.getQueuedFiles().length === 0) {
            return setTimeout((function() {
              return _this.emit("queuecomplete");
            }), 0);
          }
        };
      })(this));
      noPropagation = function(e) {
        e.stopPropagation();
        if (e.preventDefault) {
          return e.preventDefault();
        } else {
          return e.returnValue = false;
        }
      };
      this.listeners = [
        {
          element: this.element,
          events: {
            "dragstart": (function(_this) {
              return function(e) {
                return _this.emit("dragstart", e);
              };
            })(this),
            "dragenter": (function(_this) {
              return function(e) {
                noPropagation(e);
                return _this.emit("dragenter", e);
              };
            })(this),
            "dragover": (function(_this) {
              return function(e) {
                var efct;
                try {
                  efct = e.dataTransfer.effectAllowed;
                } catch (_error) {}
                e.dataTransfer.dropEffect = 'move' === efct || 'linkMove' === efct ? 'move' : 'copy';
                noPropagation(e);
                return _this.emit("dragover", e);
              };
            })(this),
            "dragleave": (function(_this) {
              return function(e) {
                return _this.emit("dragleave", e);
              };
            })(this),
            "drop": (function(_this) {
              return function(e) {
                noPropagation(e);
                return _this.drop(e);
              };
            })(this),
            "dragend": (function(_this) {
              return function(e) {
                return _this.emit("dragend", e);
              };
            })(this)
          }
        }
      ];
      this.clickableElements.forEach((function(_this) {
        return function(clickableElement) {
          return _this.listeners.push({
            element: clickableElement,
            events: {
              "click": function(evt) {
                if ((clickableElement !== _this.element) || (evt.target === _this.element || Dropzone.elementInside(evt.target, _this.element.querySelector(".dz-message")))) {
                  return _this.hiddenFileInput.click();
                }
              }
            }
          });
        };
      })(this));
      this.enable();
      return this.options.init.call(this);
    };

    Dropzone.prototype.destroy = function() {
      var _ref;
      this.disable();
      this.removeAllFiles(true);
      if ((_ref = this.hiddenFileInput) != null ? _ref.parentNode : void 0) {
        this.hiddenFileInput.parentNode.removeChild(this.hiddenFileInput);
        this.hiddenFileInput = null;
      }
      delete this.element.dropzone;
      return Dropzone.instances.splice(Dropzone.instances.indexOf(this), 1);
    };

    Dropzone.prototype.updateTotalUploadProgress = function() {
      var activeFiles, file, totalBytes, totalBytesSent, totalUploadProgress, _i, _len, _ref;
      totalBytesSent = 0;
      totalBytes = 0;
      activeFiles = this.getActiveFiles();
      if (activeFiles.length) {
        _ref = this.getActiveFiles();
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          file = _ref[_i];
          totalBytesSent += file.upload.bytesSent;
          totalBytes += file.upload.total;
        }
        totalUploadProgress = 100 * totalBytesSent / totalBytes;
      } else {
        totalUploadProgress = 100;
      }
      return this.emit("totaluploadprogress", totalUploadProgress, totalBytes, totalBytesSent);
    };

    Dropzone.prototype._getParamName = function(n) {
      if (typeof this.options.paramName === "function") {
        return this.options.paramName(n);
      } else {
        return "" + this.options.paramName + (this.options.uploadMultiple ? "[" + n + "]" : "");
      }
    };

    Dropzone.prototype.getFallbackForm = function() {
      var existingFallback, fields, fieldsString, form;
      if (existingFallback = this.getExistingFallback()) {
        return existingFallback;
      }
      fieldsString = "<div class=\"dz-fallback\">";
      if (this.options.dictFallbackText) {
        fieldsString += "<p>" + this.options.dictFallbackText + "</p>";
      }
      fieldsString += "<input type=\"file\" name=\"" + (this._getParamName(0)) + "\" " + (this.options.uploadMultiple ? 'multiple="multiple"' : void 0) + " /><input type=\"submit\" value=\"Upload!\"></div>";
      fields = Dropzone.createElement(fieldsString);
      if (this.element.tagName !== "FORM") {
        form = Dropzone.createElement("<form action=\"" + this.options.url + "\" enctype=\"multipart/form-data\" method=\"" + this.options.method + "\"></form>");
        form.appendChild(fields);
      } else {
        this.element.setAttribute("enctype", "multipart/form-data");
        this.element.setAttribute("method", this.options.method);
      }
      return form != null ? form : fields;
    };

    Dropzone.prototype.getExistingFallback = function() {
      var fallback, getFallback, tagName, _i, _len, _ref;
      getFallback = function(elements) {
        var el, _i, _len;
        for (_i = 0, _len = elements.length; _i < _len; _i++) {
          el = elements[_i];
          if (/(^| )fallback($| )/.test(el.className)) {
            return el;
          }
        }
      };
      _ref = ["div", "form"];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        tagName = _ref[_i];
        if (fallback = getFallback(this.element.getElementsByTagName(tagName))) {
          return fallback;
        }
      }
    };

    Dropzone.prototype.setupEventListeners = function() {
      var elementListeners, event, listener, _i, _len, _ref, _results;
      _ref = this.listeners;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        elementListeners = _ref[_i];
        _results.push((function() {
          var _ref1, _results1;
          _ref1 = elementListeners.events;
          _results1 = [];
          for (event in _ref1) {
            listener = _ref1[event];
            _results1.push(elementListeners.element.addEventListener(event, listener, false));
          }
          return _results1;
        })());
      }
      return _results;
    };

    Dropzone.prototype.removeEventListeners = function() {
      var elementListeners, event, listener, _i, _len, _ref, _results;
      _ref = this.listeners;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        elementListeners = _ref[_i];
        _results.push((function() {
          var _ref1, _results1;
          _ref1 = elementListeners.events;
          _results1 = [];
          for (event in _ref1) {
            listener = _ref1[event];
            _results1.push(elementListeners.element.removeEventListener(event, listener, false));
          }
          return _results1;
        })());
      }
      return _results;
    };

    Dropzone.prototype.disable = function() {
      var file, _i, _len, _ref, _results;
      this.clickableElements.forEach(function(element) {
        return element.classList.remove("dz-clickable");
      });
      this.removeEventListeners();
      _ref = this.files;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        file = _ref[_i];
        _results.push(this.cancelUpload(file));
      }
      return _results;
    };

    Dropzone.prototype.enable = function() {
      this.clickableElements.forEach(function(element) {
        return element.classList.add("dz-clickable");
      });
      return this.setupEventListeners();
    };

    Dropzone.prototype.filesize = function(size) {
      var cutoff, i, selectedSize, selectedUnit, unit, units, _i, _len;
      units = ['TB', 'GB', 'MB', 'KB', 'b'];
      selectedSize = selectedUnit = null;
      for (i = _i = 0, _len = units.length; _i < _len; i = ++_i) {
        unit = units[i];
        cutoff = Math.pow(this.options.filesizeBase, 4 - i) / 10;
        if (size >= cutoff) {
          selectedSize = size / Math.pow(this.options.filesizeBase, 4 - i);
          selectedUnit = unit;
          break;
        }
      }
      selectedSize = Math.round(10 * selectedSize) / 10;
      return "<strong>" + selectedSize + "</strong> " + selectedUnit;
    };

    Dropzone.prototype._updateMaxFilesReachedClass = function() {
      if ((this.options.maxFiles != null) && this.getAcceptedFiles().length >= this.options.maxFiles) {
        if (this.getAcceptedFiles().length === this.options.maxFiles) {
          this.emit('maxfilesreached', this.files);
        }
        return this.element.classList.add("dz-max-files-reached");
      } else {
        return this.element.classList.remove("dz-max-files-reached");
      }
    };

    Dropzone.prototype.drop = function(e) {
      var files, items;
      if (!e.dataTransfer) {
        return;
      }
      this.emit("drop", e);
      files = e.dataTransfer.files;
      if (files.length) {
        items = e.dataTransfer.items;
        if (items && items.length && (items[0].webkitGetAsEntry != null)) {
          this._addFilesFromItems(items);
        } else {
          this.handleFiles(files);
        }
      }
    };

    Dropzone.prototype.paste = function(e) {
      var items, _ref;
      if ((e != null ? (_ref = e.clipboardData) != null ? _ref.items : void 0 : void 0) == null) {
        return;
      }
      this.emit("paste", e);
      items = e.clipboardData.items;
      if (items.length) {
        return this._addFilesFromItems(items);
      }
    };

    Dropzone.prototype.handleFiles = function(files) {
      var file, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = files.length; _i < _len; _i++) {
        file = files[_i];
        _results.push(this.addFile(file));
      }
      return _results;
    };

    Dropzone.prototype._addFilesFromItems = function(items) {
      var entry, item, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = items.length; _i < _len; _i++) {
        item = items[_i];
        if ((item.webkitGetAsEntry != null) && (entry = item.webkitGetAsEntry())) {
          if (entry.isFile) {
            _results.push(this.addFile(item.getAsFile()));
          } else if (entry.isDirectory) {
            _results.push(this._addFilesFromDirectory(entry, entry.name));
          } else {
            _results.push(void 0);
          }
        } else if (item.getAsFile != null) {
          if ((item.kind == null) || item.kind === "file") {
            _results.push(this.addFile(item.getAsFile()));
          } else {
            _results.push(void 0);
          }
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    Dropzone.prototype._addFilesFromDirectory = function(directory, path) {
      var dirReader, entriesReader;
      dirReader = directory.createReader();
      entriesReader = (function(_this) {
        return function(entries) {
          var entry, _i, _len;
          for (_i = 0, _len = entries.length; _i < _len; _i++) {
            entry = entries[_i];
            if (entry.isFile) {
              entry.file(function(file) {
                if (_this.options.ignoreHiddenFiles && file.name.substring(0, 1) === '.') {
                  return;
                }
                file.fullPath = "" + path + "/" + file.name;
                return _this.addFile(file);
              });
            } else if (entry.isDirectory) {
              _this._addFilesFromDirectory(entry, "" + path + "/" + entry.name);
            }
          }
        };
      })(this);
      return dirReader.readEntries(entriesReader, function(error) {
        return typeof console !== "undefined" && console !== null ? typeof console.log === "function" ? console.log(error) : void 0 : void 0;
      });
    };

    Dropzone.prototype.accept = function(file, done) {
      if (file.size > this.options.maxFilesize * 1024 * 1024) {
        return done(this.options.dictFileTooBig.replace("{{filesize}}", Math.round(file.size / 1024 / 10.24) / 100).replace("{{maxFilesize}}", this.options.maxFilesize));
      } else if (!Dropzone.isValidFile(file, this.options.acceptedFiles)) {
        return done(this.options.dictInvalidFileType);
      } else if ((this.options.maxFiles != null) && this.getAcceptedFiles().length >= this.options.maxFiles) {
        done(this.options.dictMaxFilesExceeded.replace("{{maxFiles}}", this.options.maxFiles));
        return this.emit("maxfilesexceeded", file);
      } else {
        return this.options.accept.call(this, file, done);
      }
    };

    Dropzone.prototype.addFile = function(file) {
      file.upload = {
        progress: 0,
        total: file.size,
        bytesSent: 0
      };
      this.files.push(file);
      file.status = Dropzone.ADDED;
      this.emit("addedfile", file);
      this._enqueueThumbnail(file);
      return this.accept(file, (function(_this) {
        return function(error) {
          if (error) {
            file.accepted = false;
            _this._errorProcessing([file], error);
          } else {
            file.accepted = true;
            if (_this.options.autoQueue) {
              _this.enqueueFile(file);
            }
          }
          return _this._updateMaxFilesReachedClass();
        };
      })(this));
    };

    Dropzone.prototype.enqueueFiles = function(files) {
      var file, _i, _len;
      for (_i = 0, _len = files.length; _i < _len; _i++) {
        file = files[_i];
        this.enqueueFile(file);
      }
      return null;
    };

    Dropzone.prototype.enqueueFile = function(file) {
      if (file.status === Dropzone.ADDED && file.accepted === true) {
        file.status = Dropzone.QUEUED;
        if (this.options.autoProcessQueue) {
          return setTimeout(((function(_this) {
            return function() {
              return _this.processQueue();
            };
          })(this)), 0);
        }
      } else {
        throw new Error("This file can't be queued because it has already been processed or was rejected.");
      }
    };

    Dropzone.prototype._thumbnailQueue = [];

    Dropzone.prototype._processingThumbnail = false;

    Dropzone.prototype._enqueueThumbnail = function(file) {
      if (this.options.createImageThumbnails && file.type.match(/image.*/) && file.size <= this.options.maxThumbnailFilesize * 1024 * 1024) {
        this._thumbnailQueue.push(file);
        return setTimeout(((function(_this) {
          return function() {
            return _this._processThumbnailQueue();
          };
        })(this)), 0);
      }
    };

    Dropzone.prototype._processThumbnailQueue = function() {
      if (this._processingThumbnail || this._thumbnailQueue.length === 0) {
        return;
      }
      this._processingThumbnail = true;
      return this.createThumbnail(this._thumbnailQueue.shift(), (function(_this) {
        return function() {
          _this._processingThumbnail = false;
          return _this._processThumbnailQueue();
        };
      })(this));
    };

    Dropzone.prototype.removeFile = function(file) {
      if (file.status === Dropzone.UPLOADING) {
        this.cancelUpload(file);
      }
      this.files = without(this.files, file);
      this.emit("removedfile", file);
      if (this.files.length === 0) {
        return this.emit("reset");
      }
    };

    Dropzone.prototype.removeAllFiles = function(cancelIfNecessary) {
      var file, _i, _len, _ref;
      if (cancelIfNecessary == null) {
        cancelIfNecessary = false;
      }
      _ref = this.files.slice();
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        file = _ref[_i];
        if (file.status !== Dropzone.UPLOADING || cancelIfNecessary) {
          this.removeFile(file);
        }
      }
      return null;
    };

    Dropzone.prototype.createThumbnail = function(file, callback) {
      var fileReader;
      fileReader = new FileReader;
      fileReader.onload = (function(_this) {
        return function() {
          if (file.type === "image/svg+xml") {
            _this.emit("thumbnail", file, fileReader.result);
            if (callback != null) {
              callback();
            }
            return;
          }
          return _this.createThumbnailFromUrl(file, fileReader.result, callback);
        };
      })(this);
      return fileReader.readAsDataURL(file);
    };

    Dropzone.prototype.createThumbnailFromUrl = function(file, imageUrl, callback) {
      var img;
      img = document.createElement("img");
      img.onload = (function(_this) {
        return function() {
          var canvas, ctx, resizeInfo, thumbnail, _ref, _ref1, _ref2, _ref3;
          file.width = img.width;
          file.height = img.height;
          resizeInfo = _this.options.resize.call(_this, file);
          if (resizeInfo.trgWidth == null) {
            resizeInfo.trgWidth = resizeInfo.optWidth;
          }
          if (resizeInfo.trgHeight == null) {
            resizeInfo.trgHeight = resizeInfo.optHeight;
          }
          canvas = document.createElement("canvas");
          ctx = canvas.getContext("2d");
          canvas.width = resizeInfo.trgWidth;
          canvas.height = resizeInfo.trgHeight;
          drawImageIOSFix(ctx, img, (_ref = resizeInfo.srcX) != null ? _ref : 0, (_ref1 = resizeInfo.srcY) != null ? _ref1 : 0, resizeInfo.srcWidth, resizeInfo.srcHeight, (_ref2 = resizeInfo.trgX) != null ? _ref2 : 0, (_ref3 = resizeInfo.trgY) != null ? _ref3 : 0, resizeInfo.trgWidth, resizeInfo.trgHeight);
          thumbnail = canvas.toDataURL("image/png");
          _this.emit("thumbnail", file, thumbnail);
          if (callback != null) {
            return callback();
          }
        };
      })(this);
      if (callback != null) {
        img.onerror = callback;
      }
      return img.src = imageUrl;
    };

    Dropzone.prototype.processQueue = function() {
      var i, parallelUploads, processingLength, queuedFiles;
      parallelUploads = this.options.parallelUploads;
      processingLength = this.getUploadingFiles().length;
      i = processingLength;
      if (processingLength >= parallelUploads) {
        return;
      }
      queuedFiles = this.getQueuedFiles();
      if (!(queuedFiles.length > 0)) {
        return;
      }
      if (this.options.uploadMultiple) {
        return this.processFiles(queuedFiles.slice(0, parallelUploads - processingLength));
      } else {
        while (i < parallelUploads) {
          if (!queuedFiles.length) {
            return;
          }
          this.processFile(queuedFiles.shift());
          i++;
        }
      }
    };

    Dropzone.prototype.processFile = function(file) {
      return this.processFiles([file]);
    };

    Dropzone.prototype.processFiles = function(files) {
      var file, _i, _len;
      for (_i = 0, _len = files.length; _i < _len; _i++) {
        file = files[_i];
        file.processing = true;
        file.status = Dropzone.UPLOADING;
        this.emit("processing", file);
      }
      if (this.options.uploadMultiple) {
        this.emit("processingmultiple", files);
      }
      return this.uploadFiles(files);
    };

    Dropzone.prototype._getFilesWithXhr = function(xhr) {
      var file, files;
      return files = (function() {
        var _i, _len, _ref, _results;
        _ref = this.files;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          file = _ref[_i];
          if (file.xhr === xhr) {
            _results.push(file);
          }
        }
        return _results;
      }).call(this);
    };

    Dropzone.prototype.cancelUpload = function(file) {
      var groupedFile, groupedFiles, _i, _j, _len, _len1, _ref;
      if (file.status === Dropzone.UPLOADING) {
        groupedFiles = this._getFilesWithXhr(file.xhr);
        for (_i = 0, _len = groupedFiles.length; _i < _len; _i++) {
          groupedFile = groupedFiles[_i];
          groupedFile.status = Dropzone.CANCELED;
        }
        file.xhr.abort();
        for (_j = 0, _len1 = groupedFiles.length; _j < _len1; _j++) {
          groupedFile = groupedFiles[_j];
          this.emit("canceled", groupedFile);
        }
        if (this.options.uploadMultiple) {
          this.emit("canceledmultiple", groupedFiles);
        }
      } else if ((_ref = file.status) === Dropzone.ADDED || _ref === Dropzone.QUEUED) {
        file.status = Dropzone.CANCELED;
        this.emit("canceled", file);
        if (this.options.uploadMultiple) {
          this.emit("canceledmultiple", [file]);
        }
      }
      if (this.options.autoProcessQueue) {
        return this.processQueue();
      }
    };

    resolveOption = function() {
      var args, option;
      option = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      if (typeof option === 'function') {
        return option.apply(this, args);
      }
      return option;
    };

    Dropzone.prototype.uploadFile = function(file) {
      return this.uploadFiles([file]);
    };

    Dropzone.prototype.uploadFiles = function(files) {
      var file, formData, handleError, headerName, headerValue, headers, i, input, inputName, inputType, key, method, option, progressObj, response, updateProgress, url, value, xhr, _i, _j, _k, _l, _len, _len1, _len2, _len3, _m, _ref, _ref1, _ref2, _ref3, _ref4, _ref5;
      xhr = new XMLHttpRequest();
      for (_i = 0, _len = files.length; _i < _len; _i++) {
        file = files[_i];
        file.xhr = xhr;
      }
      method = resolveOption(this.options.method, files);
      url = resolveOption(this.options.url, files);
      xhr.open(method, url, true);
      xhr.withCredentials = !!this.options.withCredentials;
      response = null;
      handleError = (function(_this) {
        return function() {
          var _j, _len1, _results;
          _results = [];
          for (_j = 0, _len1 = files.length; _j < _len1; _j++) {
            file = files[_j];
            _results.push(_this._errorProcessing(files, response || _this.options.dictResponseError.replace("{{statusCode}}", xhr.status), xhr));
          }
          return _results;
        };
      })(this);
      updateProgress = (function(_this) {
        return function(e) {
          var allFilesFinished, progress, _j, _k, _l, _len1, _len2, _len3, _results;
          if (e != null) {
            progress = 100 * e.loaded / e.total;
            for (_j = 0, _len1 = files.length; _j < _len1; _j++) {
              file = files[_j];
              file.upload = {
                progress: progress,
                total: e.total,
                bytesSent: e.loaded
              };
            }
          } else {
            allFilesFinished = true;
            progress = 100;
            for (_k = 0, _len2 = files.length; _k < _len2; _k++) {
              file = files[_k];
              if (!(file.upload.progress === 100 && file.upload.bytesSent === file.upload.total)) {
                allFilesFinished = false;
              }
              file.upload.progress = progress;
              file.upload.bytesSent = file.upload.total;
            }
            if (allFilesFinished) {
              return;
            }
          }
          _results = [];
          for (_l = 0, _len3 = files.length; _l < _len3; _l++) {
            file = files[_l];
            _results.push(_this.emit("uploadprogress", file, progress, file.upload.bytesSent));
          }
          return _results;
        };
      })(this);
      xhr.onload = (function(_this) {
        return function(e) {
          var _ref;
          if (files[0].status === Dropzone.CANCELED) {
            return;
          }
          if (xhr.readyState !== 4) {
            return;
          }
          response = xhr.responseText;
          if (xhr.getResponseHeader("content-type") && ~xhr.getResponseHeader("content-type").indexOf("application/json")) {
            try {
              response = JSON.parse(response);
            } catch (_error) {
              e = _error;
              response = "Invalid JSON response from server.";
            }
          }
          updateProgress();
          if (!((200 <= (_ref = xhr.status) && _ref < 300))) {
            return handleError();
          } else {
            return _this._finished(files, response, e);
          }
        };
      })(this);
      xhr.onerror = (function(_this) {
        return function() {
          if (files[0].status === Dropzone.CANCELED) {
            return;
          }
          return handleError();
        };
      })(this);
      progressObj = (_ref = xhr.upload) != null ? _ref : xhr;
      progressObj.onprogress = updateProgress;
      headers = {
        "Accept": "application/json",
        "Cache-Control": "no-cache",
        "X-Requested-With": "XMLHttpRequest"
      };
      if (this.options.headers) {
        extend(headers, this.options.headers);
      }
      for (headerName in headers) {
        headerValue = headers[headerName];
        xhr.setRequestHeader(headerName, headerValue);
      }
      formData = new FormData();
      if (this.options.params) {
        _ref1 = this.options.params;
        for (key in _ref1) {
          value = _ref1[key];
          formData.append(key, value);
        }
      }
      for (_j = 0, _len1 = files.length; _j < _len1; _j++) {
        file = files[_j];
        this.emit("sending", file, xhr, formData);
      }
      if (this.options.uploadMultiple) {
        this.emit("sendingmultiple", files, xhr, formData);
      }
      if (this.element.tagName === "FORM") {
        _ref2 = this.element.querySelectorAll("input, textarea, select, button");
        for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
          input = _ref2[_k];
          inputName = input.getAttribute("name");
          inputType = input.getAttribute("type");
          if (input.tagName === "SELECT" && input.hasAttribute("multiple")) {
            _ref3 = input.options;
            for (_l = 0, _len3 = _ref3.length; _l < _len3; _l++) {
              option = _ref3[_l];
              if (option.selected) {
                formData.append(inputName, option.value);
              }
            }
          } else if (!inputType || ((_ref4 = inputType.toLowerCase()) !== "checkbox" && _ref4 !== "radio") || input.checked) {
            formData.append(inputName, input.value);
          }
        }
      }
      for (i = _m = 0, _ref5 = files.length - 1; 0 <= _ref5 ? _m <= _ref5 : _m >= _ref5; i = 0 <= _ref5 ? ++_m : --_m) {
        formData.append(this._getParamName(i), files[i], files[i].name);
      }
      return xhr.send(formData);
    };

    Dropzone.prototype._finished = function(files, responseText, e) {
      var file, _i, _len;
      for (_i = 0, _len = files.length; _i < _len; _i++) {
        file = files[_i];
        file.status = Dropzone.SUCCESS;
        this.emit("success", file, responseText, e);
        this.emit("complete", file);
      }
      if (this.options.uploadMultiple) {
        this.emit("successmultiple", files, responseText, e);
        this.emit("completemultiple", files);
      }
      if (this.options.autoProcessQueue) {
        return this.processQueue();
      }
    };

    Dropzone.prototype._errorProcessing = function(files, message, xhr) {
      var file, _i, _len;
      for (_i = 0, _len = files.length; _i < _len; _i++) {
        file = files[_i];
        file.status = Dropzone.ERROR;
        this.emit("error", file, message, xhr);
        this.emit("complete", file);
      }
      if (this.options.uploadMultiple) {
        this.emit("errormultiple", files, message, xhr);
        this.emit("completemultiple", files);
      }
      if (this.options.autoProcessQueue) {
        return this.processQueue();
      }
    };

    return Dropzone;

  })(Emitter);

  Dropzone.version = "4.0.1";

  Dropzone.options = {};

  Dropzone.optionsForElement = function(element) {
    if (element.getAttribute("id")) {
      return Dropzone.options[camelize(element.getAttribute("id"))];
    } else {
      return void 0;
    }
  };

  Dropzone.instances = [];

  Dropzone.forElement = function(element) {
    if (typeof element === "string") {
      element = document.querySelector(element);
    }
    if ((element != null ? element.dropzone : void 0) == null) {
      throw new Error("No Dropzone found for given element. This is probably because you're trying to access it before Dropzone had the time to initialize. Use the `init` option to setup any additional observers on your Dropzone.");
    }
    return element.dropzone;
  };

  Dropzone.autoDiscover = true;

  Dropzone.discover = function() {
    var checkElements, dropzone, dropzones, _i, _len, _results;
    if (document.querySelectorAll) {
      dropzones = document.querySelectorAll(".dropzone");
    } else {
      dropzones = [];
      checkElements = function(elements) {
        var el, _i, _len, _results;
        _results = [];
        for (_i = 0, _len = elements.length; _i < _len; _i++) {
          el = elements[_i];
          if (/(^| )dropzone($| )/.test(el.className)) {
            _results.push(dropzones.push(el));
          } else {
            _results.push(void 0);
          }
        }
        return _results;
      };
      checkElements(document.getElementsByTagName("div"));
      checkElements(document.getElementsByTagName("form"));
    }
    _results = [];
    for (_i = 0, _len = dropzones.length; _i < _len; _i++) {
      dropzone = dropzones[_i];
      if (Dropzone.optionsForElement(dropzone) !== false) {
        _results.push(new Dropzone(dropzone));
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  Dropzone.blacklistedBrowsers = [/opera.*Macintosh.*version\/12/i];

  Dropzone.isBrowserSupported = function() {
    var capableBrowser, regex, _i, _len, _ref;
    capableBrowser = true;
    if (window.File && window.FileReader && window.FileList && window.Blob && window.FormData && document.querySelector) {
      if (!("classList" in document.createElement("a"))) {
        capableBrowser = false;
      } else {
        _ref = Dropzone.blacklistedBrowsers;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          regex = _ref[_i];
          if (regex.test(navigator.userAgent)) {
            capableBrowser = false;
            continue;
          }
        }
      }
    } else {
      capableBrowser = false;
    }
    return capableBrowser;
  };

  without = function(list, rejectedItem) {
    var item, _i, _len, _results;
    _results = [];
    for (_i = 0, _len = list.length; _i < _len; _i++) {
      item = list[_i];
      if (item !== rejectedItem) {
        _results.push(item);
      }
    }
    return _results;
  };

  camelize = function(str) {
    return str.replace(/[\-_](\w)/g, function(match) {
      return match.charAt(1).toUpperCase();
    });
  };

  Dropzone.createElement = function(string) {
    var div;
    div = document.createElement("div");
    div.innerHTML = string;
    return div.childNodes[0];
  };

  Dropzone.elementInside = function(element, container) {
    if (element === container) {
      return true;
    }
    while (element = element.parentNode) {
      if (element === container) {
        return true;
      }
    }
    return false;
  };

  Dropzone.getElement = function(el, name) {
    var element;
    if (typeof el === "string") {
      element = document.querySelector(el);
    } else if (el.nodeType != null) {
      element = el;
    }
    if (element == null) {
      throw new Error("Invalid `" + name + "` option provided. Please provide a CSS selector or a plain HTML element.");
    }
    return element;
  };

  Dropzone.getElements = function(els, name) {
    var e, el, elements, _i, _j, _len, _len1, _ref;
    if (els instanceof Array) {
      elements = [];
      try {
        for (_i = 0, _len = els.length; _i < _len; _i++) {
          el = els[_i];
          elements.push(this.getElement(el, name));
        }
      } catch (_error) {
        e = _error;
        elements = null;
      }
    } else if (typeof els === "string") {
      elements = [];
      _ref = document.querySelectorAll(els);
      for (_j = 0, _len1 = _ref.length; _j < _len1; _j++) {
        el = _ref[_j];
        elements.push(el);
      }
    } else if (els.nodeType != null) {
      elements = [els];
    }
    if (!((elements != null) && elements.length)) {
      throw new Error("Invalid `" + name + "` option provided. Please provide a CSS selector, a plain HTML element or a list of those.");
    }
    return elements;
  };

  Dropzone.confirm = function(question, accepted, rejected) {
    if (window.confirm(question)) {
      return accepted();
    } else if (rejected != null) {
      return rejected();
    }
  };

  Dropzone.isValidFile = function(file, acceptedFiles) {
    var baseMimeType, mimeType, validType, _i, _len;
    if (!acceptedFiles) {
      return true;
    }
    acceptedFiles = acceptedFiles.split(",");
    mimeType = file.type;
    baseMimeType = mimeType.replace(/\/.*$/, "");
    for (_i = 0, _len = acceptedFiles.length; _i < _len; _i++) {
      validType = acceptedFiles[_i];
      validType = validType.trim();
      if (validType.charAt(0) === ".") {
        if (file.name.toLowerCase().indexOf(validType.toLowerCase(), file.name.length - validType.length) !== -1) {
          return true;
        }
      } else if (/\/\*$/.test(validType)) {
        if (baseMimeType === validType.replace(/\/.*$/, "")) {
          return true;
        }
      } else {
        if (mimeType === validType) {
          return true;
        }
      }
    }
    return false;
  };

  if (typeof jQuery !== "undefined" && jQuery !== null) {
    jQuery.fn.dropzone = function(options) {
      return this.each(function() {
        return new Dropzone(this, options);
      });
    };
  }

  if (typeof module !== "undefined" && module !== null) {
    module.exports = Dropzone;
  } else {
    window.Dropzone = Dropzone;
  }

  Dropzone.ADDED = "added";

  Dropzone.QUEUED = "queued";

  Dropzone.ACCEPTED = Dropzone.QUEUED;

  Dropzone.UPLOADING = "uploading";

  Dropzone.PROCESSING = Dropzone.UPLOADING;

  Dropzone.CANCELED = "canceled";

  Dropzone.ERROR = "error";

  Dropzone.SUCCESS = "success";


  /*
  
  Bugfix for iOS 6 and 7
  Source: http://stackoverflow.com/questions/11929099/html5-canvas-drawimage-ratio-bug-ios
  based on the work of https://github.com/stomita/ios-imagefile-megapixel
   */

  detectVerticalSquash = function(img) {
    var alpha, canvas, ctx, data, ey, ih, iw, py, ratio, sy;
    iw = img.naturalWidth;
    ih = img.naturalHeight;
    canvas = document.createElement("canvas");
    canvas.width = 1;
    canvas.height = ih;
    ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    data = ctx.getImageData(0, 0, 1, ih).data;
    sy = 0;
    ey = ih;
    py = ih;
    while (py > sy) {
      alpha = data[(py - 1) * 4 + 3];
      if (alpha === 0) {
        ey = py;
      } else {
        sy = py;
      }
      py = (ey + sy) >> 1;
    }
    ratio = py / ih;
    if (ratio === 0) {
      return 1;
    } else {
      return ratio;
    }
  };

  drawImageIOSFix = function(ctx, img, sx, sy, sw, sh, dx, dy, dw, dh) {
    var vertSquashRatio;
    vertSquashRatio = detectVerticalSquash(img);
    return ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh / vertSquashRatio);
  };


  /*
   * contentloaded.js
   *
   * Author: Diego Perini (diego.perini at gmail.com)
   * Summary: cross-browser wrapper for DOMContentLoaded
   * Updated: 20101020
   * License: MIT
   * Version: 1.2
   *
   * URL:
   * http://javascript.nwbox.com/ContentLoaded/
   * http://javascript.nwbox.com/ContentLoaded/MIT-LICENSE
   */

  contentLoaded = function(win, fn) {
    var add, doc, done, init, poll, pre, rem, root, top;
    done = false;
    top = true;
    doc = win.document;
    root = doc.documentElement;
    add = (doc.addEventListener ? "addEventListener" : "attachEvent");
    rem = (doc.addEventListener ? "removeEventListener" : "detachEvent");
    pre = (doc.addEventListener ? "" : "on");
    init = function(e) {
      if (e.type === "readystatechange" && doc.readyState !== "complete") {
        return;
      }
      (e.type === "load" ? win : doc)[rem](pre + e.type, init, false);
      if (!done && (done = true)) {
        return fn.call(win, e.type || e);
      }
    };
    poll = function() {
      var e;
      try {
        root.doScroll("left");
      } catch (_error) {
        e = _error;
        setTimeout(poll, 50);
        return;
      }
      return init("poll");
    };
    if (doc.readyState !== "complete") {
      if (doc.createEventObject && root.doScroll) {
        try {
          top = !win.frameElement;
        } catch (_error) {}
        if (top) {
          poll();
        }
      }
      doc[add](pre + "DOMContentLoaded", init, false);
      doc[add](pre + "readystatechange", init, false);
      return win[add](pre + "load", init, false);
    }
  };

  Dropzone._autoDiscoverFunction = function() {
    if (Dropzone.autoDiscover) {
      return Dropzone.discover();
    }
  };

  contentLoaded(window, Dropzone._autoDiscoverFunction);

}).call(this);
},{}],1136:[function(require,module,exports){
// tipsy, facebook style tooltips for jquery with fancy fading
// version 1.0.0a
// (c) 2008-2010 jason frame [jason@onehackoranother.com] and modificated by Sergio Alvarez @saleiva
// released under the MIT license
//
//  Changes:
//  April 27 2016: fixed problem with element size.
//  June 3 2013: Added the custom class before the calc of the position.

(function($) {

  var MOVE_OFFSET = 6;

  function maybeCall(thing, ctx) {
    return (typeof thing == 'function') ? (thing.call(ctx)) : thing;
  };

  function isElementInDOM(ele) {
    while (ele = ele.parentNode) {
      if (ele == document) return true;
    }
    return false;
  };

  function Tipsy(element, options) {
    this.$element = $(element);
    this.options = options;
    this.enabled = true;
    this.fixTitle();
  };

  Tipsy.prototype = {
    show: function() {
      var title = this.getTitle();
      if (title && this.enabled) {
        var $tip = this.tip();

        $tip.find('.tipsy-inner')[this.options.html ? 'html' : 'text'](title);
            $tip[0].className = 'tipsy'; // reset classname in case of dynamic gravity
            $tip.remove().css({top: 0, left: 0, visibility: 'hidden', display: 'block'}).prependTo(document.body);

            // Modified so we can use custom class names
            if (this.options.className) {
              $tip.addClass(maybeCall(this.options.className, this.$element[0]));
            }

            // Modified
            var pos = $.extend({}, this.$element.offset(), {
              width: this.$element[0].getBoundingClientRect().width,
              height: this.$element[0].getBoundingClientRect().height
            });

            var actualWidth = $tip[0].offsetWidth,
            actualHeight = $tip[0].offsetHeight,
            gravity = maybeCall(this.options.gravity, this.$element[0]);

            var tp;
            switch (gravity.charAt(0)) {
              case 'n':
              tp = {top: pos.top + pos.height + this.options.offset, left: pos.left + pos.width / 2 - actualWidth / 2};
              mo = {top: parseInt(pos.top + pos.height + this.options.offset + MOVE_OFFSET), opacity: this.options.opacity};
              break;
              case 's':
              tp = {top: pos.top - actualHeight - this.options.offset, left: pos.left + pos.width / 2 - actualWidth / 2};
              mo = {top: parseInt(pos.top - actualHeight - this.options.offset - MOVE_OFFSET), opacity: this.options.opacity};
              break;
              case 'e':
              tp = {top: pos.top + pos.height / 2 - actualHeight / 2, left: pos.left - actualWidth - this.options.offset};
              mo = {left: parseInt(pos.left - actualWidth - this.options.offset - MOVE_OFFSET), opacity: this.options.opacity};
              break;
              case 'w':
              tp = {top: pos.top + pos.height / 2 - actualHeight / 2, left: pos.left + pos.width + this.options.offset};
              mo = {left: parseInt(pos.left + pos.width + this.options.offset + MOVE_OFFSET), opacity: this.options.opacity};
              break;
            }

            if (gravity.length == 2) {
              if (gravity.charAt(1) == 'w') {
                tp.left = pos.left + pos.width / 2 - 15;
              } else {
                tp.left = pos.left + pos.width / 2 - actualWidth + 15;
              }
            }

            $tip.css(tp).addClass('tipsy-' + gravity);
            $tip.find('.tipsy-arrow')[0].className = 'tipsy-arrow tipsy-arrow-' + gravity.charAt(0);

            if (this.options.fade) {
              $tip.stop().css({opacity: 0, display: 'block', visibility: 'visible'}).animate(mo, 200);
            } else {
              $tip.css({visibility: 'visible', opacity: this.options.opacity});
            }
          }
        },

        hide: function() {

          gravity = maybeCall(this.options.gravity, this.$element[0]);

          switch (gravity.charAt(0)) {
            case 'n':
            mo = {top: parseInt(this.tip().css("top")) + MOVE_OFFSET, opacity: 0};
            break;
            case 's':
            mo = {top: parseInt(this.tip().css("top")) - MOVE_OFFSET, opacity: 0};
            break;
            case 'e':
            mo = {left: parseInt(this.tip().css("left")) - MOVE_OFFSET, opacity: 0};
            break;
            case 'w':
            mo = {left: parseInt(this.tip().css("left")) + MOVE_OFFSET, opacity: 0};
            break;
          }

          if (this.options.fade) {
            this.tip().stop().animate(mo, 200, function(){$(this).remove();});
          } else {
            this.tip().remove();
          }
        },

        fixTitle: function() {
          var $e = this.$element;
          if ($e.attr('title') || typeof($e.attr('original-title')) != 'string') {
            $e.attr('original-title', $e.attr('title') || '').removeAttr('title');
          }
        },

        getTitle: function() {
          var title, $e = this.$element, o = this.options;
          this.fixTitle();
          var title, o = this.options;
          if (typeof o.title == 'string') {
            title = $e.attr(o.title == 'title' ? 'original-title' : o.title);
          } else if (typeof o.title == 'function') {
            title = o.title.call($e[0]);
          }
          title = ('' + title).replace(/(^\s*|\s*$)/, "");
          return title || o.fallback;
        },

        tip: function() {
          if (!this.$tip) {
            this.$tip = $('<div class="tipsy"></div>').html('<div class="tipsy-arrow"></div><div class="tipsy-inner"></div>');
            this.$tip.data('tipsy-pointee', this.$element[0]);
          }
          return this.$tip;
        },

        validate: function() {
          if (!this.$element[0].parentNode) {
            this.hide();
            this.$element = null;
            this.options = null;
          }
        },

        remove: function() { this.enabled = false; this.$tip && this.$tip.remove(); },
        enable: function() { this.enabled = true; },
        disable: function() { this.enabled = false; },
        toggleEnabled: function() { this.enabled = !this.enabled; }
      };

      $.fn.tipsy = function(options) {

        if (options === true) {
          return this.data('tipsy');
        } else if (typeof options == 'string') {
          var tipsy = this.data('tipsy');
          if (tipsy) tipsy[options]();
          return this;
        }

        options = $.extend({}, $.fn.tipsy.defaults, options);

        function get(ele) {
          var tipsy = $.data(ele, 'tipsy');
          if (!tipsy) {
            tipsy = new Tipsy(ele, $.fn.tipsy.elementOptions(ele, options));
            $.data(ele, 'tipsy', tipsy);
          }
          return tipsy;
        }

        function enter() {
          var tipsy = get(this);
          tipsy.hoverState = 'in';
          if (options.delayIn == 0) {
            tipsy.show();
          } else {
            tipsy.fixTitle();
            setTimeout(function() { if (tipsy.hoverState == 'in') tipsy.show(); }, options.delayIn);
          }
        };

        function leave() {
          var tipsy = get(this);
          tipsy.hoverState = 'out';
          if (options.delayOut == 0) {
            tipsy.hide();
          } else {
            setTimeout(function() { if (tipsy.hoverState == 'out') tipsy.hide(); }, options.delayOut);
          }
        };

        if (!options.live) this.each(function() { get(this); });

        if (options.trigger != 'manual') {
          var binder   = options.live ? 'live' : 'bind',
          eventIn  = options.trigger == 'hover' ? 'mouseenter' : 'focus',
          eventOut = options.trigger == 'hover' ? 'mouseleave' : 'blur';
          this[binder](eventIn, enter)[binder](eventOut, leave);
        }

        return this;

      };

      $.fn.tipsy.defaults = {
        className: null,
        delayIn: 0,
        delayOut: 0,
        fade: false,
        fallback: '',
        gravity: 'n',
        html: false,
        live: false,
        offset: 0,
        opacity: 0.8,
        title: 'title',
        trigger: 'hover'
      };

      $.fn.tipsy.revalidate = function() {
        $('.tipsy').each(function() {
          var pointee = $.data(this, 'tipsy-pointee');
          if (!pointee || !isElementInDOM(pointee)) {
            $(this).remove();
          }
        });
      };

    // Overwrite this method to provide options on a per-element basis.
    // For example, you could store the gravity in a 'tipsy-gravity' attribute:
    // return $.extend({}, options, {gravity: $(ele).attr('tipsy-gravity') || 'n' });
    // (remember - do not modify 'options' in place!)
    $.fn.tipsy.elementOptions = function(ele, options) {
      return $.metadata ? $.extend({}, options, $(ele).metadata()) : options;
    };

    $.fn.tipsy.autoNS = function() {
      return $(this).offset().top > ($(document).scrollTop() + $(window).height() / 2) ? 's' : 'n';
    };

    $.fn.tipsy.autoWE = function() {
      return $(this).offset().left > ($(document).scrollLeft() + $(window).width() / 2) ? 'e' : 'w';
    };

    /**
     * yields a closure of the supplied parameters, producing a function that takes
     * no arguments and is suitable for use as an autogravity function like so:
     *
     * @param margin (int) - distance from the viewable region edge that an
     *        element should be before setting its tooltip's gravity to be away
     *        from that edge.
     * @param prefer (string, e.g. 'n', 'sw', 'w') - the direction to prefer
     *        if there are no viewable region edges effecting the tooltip's
     *        gravity. It will try to vary from this minimally, for example,
     *        if 'sw' is preferred and an element is near the right viewable
     *        region edge, but not the top edge, it will set the gravity for
     *        that element's tooltip to be 'se', preserving the southern
     *        component.
     */
     $.fn.tipsy.autoBounds = function(margin, prefer) {
      return function() {
       var dir = {ns: prefer[0], ew: (prefer.length > 1 ? prefer[1] : false)},
       boundTop = $(document).scrollTop() + margin,
       boundLeft = $(document).scrollLeft() + margin,
       $this = $(this);

       if ($this.offset().top < boundTop) dir.ns = 'n';
       if ($this.offset().left < boundLeft) dir.ew = 'w';
       if ($(window).width() + $(document).scrollLeft() - $this.offset().left < margin) dir.ew = 'e';
       if ($(window).height() + $(document).scrollTop() - $this.offset().top < margin) dir.ns = 's';

       return dir.ns + (dir.ew ? dir.ew : '');
     }
   };

 })(jQuery);

},{}],1137:[function(require,module,exports){
// Released under MIT license
// Copyright (c) 2009-2010 Dominic Baggott
// Copyright (c) 2009-2010 Ash Berlin
// Copyright (c) 2011 Christoph Dorn <christoph@christophdorn.com> (http://www.christophdorn.com)

/*jshint browser:true, devel:true */

(function( expose ) {

/**
 *  class Markdown
 *
 *  Markdown processing in Javascript done right. We have very particular views
 *  on what constitutes 'right' which include:
 *
 *  - produces well-formed HTML (this means that em and strong nesting is
 *    important)
 *
 *  - has an intermediate representation to allow processing of parsed data (We
 *    in fact have two, both as [JsonML]: a markdown tree and an HTML tree).
 *
 *  - is easily extensible to add new dialects without having to rewrite the
 *    entire parsing mechanics
 *
 *  - has a good test suite
 *
 *  This implementation fulfills all of these (except that the test suite could
 *  do with expanding to automatically run all the fixtures from other Markdown
 *  implementations.)
 *
 *  ##### Intermediate Representation
 *
 *  *TODO* Talk about this :) Its JsonML, but document the node names we use.
 *
 *  [JsonML]: http://jsonml.org/ "JSON Markup Language"
 **/
var Markdown = expose.Markdown = function(dialect) {
  switch (typeof dialect) {
    case "undefined":
      this.dialect = Markdown.dialects.Gruber;
      break;
    case "object":
      this.dialect = dialect;
      break;
    default:
      if ( dialect in Markdown.dialects ) {
        this.dialect = Markdown.dialects[dialect];
      }
      else {
        throw new Error("Unknown Markdown dialect '" + String(dialect) + "'");
      }
      break;
  }
  this.em_state = [];
  this.strong_state = [];
  this.debug_indent = "";
};

/**
 *  parse( markdown, [dialect] ) -> JsonML
 *  - markdown (String): markdown string to parse
 *  - dialect (String | Dialect): the dialect to use, defaults to gruber
 *
 *  Parse `markdown` and return a markdown document as a Markdown.JsonML tree.
 **/
expose.parse = function( source, dialect ) {
  // dialect will default if undefined
  var md = new Markdown( dialect );
  return md.toTree( source );
};

/**
 *  toHTML( markdown, [dialect]  ) -> String
 *  toHTML( md_tree ) -> String
 *  - markdown (String): markdown string to parse
 *  - md_tree (Markdown.JsonML): parsed markdown tree
 *
 *  Take markdown (either as a string or as a JsonML tree) and run it through
 *  [[toHTMLTree]] then turn it into a well-formated HTML fragment.
 **/
expose.toHTML = function toHTML( source , dialect , options ) {
  var input = expose.toHTMLTree( source , dialect , options );

  return expose.renderJsonML( input );
};

/**
 *  toHTMLTree( markdown, [dialect] ) -> JsonML
 *  toHTMLTree( md_tree ) -> JsonML
 *  - markdown (String): markdown string to parse
 *  - dialect (String | Dialect): the dialect to use, defaults to gruber
 *  - md_tree (Markdown.JsonML): parsed markdown tree
 *
 *  Turn markdown into HTML, represented as a JsonML tree. If a string is given
 *  to this function, it is first parsed into a markdown tree by calling
 *  [[parse]].
 **/
expose.toHTMLTree = function toHTMLTree( input, dialect , options ) {
  // convert string input to an MD tree
  if ( typeof input ==="string" ) input = this.parse( input, dialect );

  // Now convert the MD tree to an HTML tree

  // remove references from the tree
  var attrs = extract_attr( input ),
      refs = {};

  if ( attrs && attrs.references ) {
    refs = attrs.references;
  }

  var html = convert_tree_to_html( input, refs , options );
  merge_text_nodes( html );
  return html;
};

// For Spidermonkey based engines
function mk_block_toSource() {
  return "Markdown.mk_block( " +
          uneval(this.toString()) +
          ", " +
          uneval(this.trailing) +
          ", " +
          uneval(this.lineNumber) +
          " )";
}

// node
function mk_block_inspect() {
  var util = require("util");
  return "Markdown.mk_block( " +
          util.inspect(this.toString()) +
          ", " +
          util.inspect(this.trailing) +
          ", " +
          util.inspect(this.lineNumber) +
          " )";

}

var mk_block = Markdown.mk_block = function(block, trail, line) {
  // Be helpful for default case in tests.
  if ( arguments.length == 1 ) trail = "\n\n";

  var s = new String(block);
  s.trailing = trail;
  // To make it clear its not just a string
  s.inspect = mk_block_inspect;
  s.toSource = mk_block_toSource;

  if ( line != undefined )
    s.lineNumber = line;

  return s;
};

function count_lines( str ) {
  var n = 0, i = -1;
  while ( ( i = str.indexOf("\n", i + 1) ) !== -1 ) n++;
  return n;
}

// Internal - split source into rough blocks
Markdown.prototype.split_blocks = function splitBlocks( input, startLine ) {
  input = input.replace(/(\r\n|\n|\r)/g, "\n");
  // [\s\S] matches _anything_ (newline or space)
  // [^] is equivalent but doesn't work in IEs.
  var re = /([\s\S]+?)($|\n#|\n(?:\s*\n|$)+)/g,
      blocks = [],
      m;

  var line_no = 1;

  if ( ( m = /^(\s*\n)/.exec(input) ) != null ) {
    // skip (but count) leading blank lines
    line_no += count_lines( m[0] );
    re.lastIndex = m[0].length;
  }

  while ( ( m = re.exec(input) ) !== null ) {
    if (m[2] == "\n#") {
      m[2] = "\n";
      re.lastIndex--;
    }
    blocks.push( mk_block( m[1], m[2], line_no ) );
    line_no += count_lines( m[0] );
  }

  return blocks;
};

/**
 *  Markdown#processBlock( block, next ) -> undefined | [ JsonML, ... ]
 *  - block (String): the block to process
 *  - next (Array): the following blocks
 *
 * Process `block` and return an array of JsonML nodes representing `block`.
 *
 * It does this by asking each block level function in the dialect to process
 * the block until one can. Succesful handling is indicated by returning an
 * array (with zero or more JsonML nodes), failure by a false value.
 *
 * Blocks handlers are responsible for calling [[Markdown#processInline]]
 * themselves as appropriate.
 *
 * If the blocks were split incorrectly or adjacent blocks need collapsing you
 * can adjust `next` in place using shift/splice etc.
 *
 * If any of this default behaviour is not right for the dialect, you can
 * define a `__call__` method on the dialect that will get invoked to handle
 * the block processing.
 */
Markdown.prototype.processBlock = function processBlock( block, next ) {
  var cbs = this.dialect.block,
      ord = cbs.__order__;

  if ( "__call__" in cbs ) {
    return cbs.__call__.call(this, block, next);
  }

  for ( var i = 0; i < ord.length; i++ ) {
    //D:this.debug( "Testing", ord[i] );
    var res = cbs[ ord[i] ].call( this, block, next );
    if ( res ) {
      //D:this.debug("  matched");
      if ( !isArray(res) || ( res.length > 0 && !( isArray(res[0]) ) ) )
        this.debug(ord[i], "didn't return a proper array");
      //D:this.debug( "" );
      return res;
    }
  }

  // Uhoh! no match! Should we throw an error?
  return [];
};

Markdown.prototype.processInline = function processInline( block ) {
  return this.dialect.inline.__call__.call( this, String( block ) );
};

/**
 *  Markdown#toTree( source ) -> JsonML
 *  - source (String): markdown source to parse
 *
 *  Parse `source` into a JsonML tree representing the markdown document.
 **/
// custom_tree means set this.tree to `custom_tree` and restore old value on return
Markdown.prototype.toTree = function toTree( source, custom_root ) {
  var blocks = source instanceof Array ? source : this.split_blocks( source );

  // Make tree a member variable so its easier to mess with in extensions
  var old_tree = this.tree;
  try {
    this.tree = custom_root || this.tree || [ "markdown" ];

    blocks:
    while ( blocks.length ) {
      var b = this.processBlock( blocks.shift(), blocks );

      // Reference blocks and the like won't return any content
      if ( !b.length ) continue blocks;

      this.tree.push.apply( this.tree, b );
    }
    return this.tree;
  }
  finally {
    if ( custom_root ) {
      this.tree = old_tree;
    }
  }
};

// Noop by default
Markdown.prototype.debug = function () {
  var args = Array.prototype.slice.call( arguments);
  args.unshift(this.debug_indent);
  if ( typeof print !== "undefined" )
      print.apply( print, args );
  if ( typeof console !== "undefined" && typeof console.log !== "undefined" )
      console.log.apply( null, args );
}

Markdown.prototype.loop_re_over_block = function( re, block, cb ) {
  // Dont use /g regexps with this
  var m,
      b = block.valueOf();

  while ( b.length && (m = re.exec(b) ) != null ) {
    b = b.substr( m[0].length );
    cb.call(this, m);
  }
  return b;
};

/**
 * Markdown.dialects
 *
 * Namespace of built-in dialects.
 **/
Markdown.dialects = {};

/**
 * Markdown.dialects.Gruber
 *
 * The default dialect that follows the rules set out by John Gruber's
 * markdown.pl as closely as possible. Well actually we follow the behaviour of
 * that script which in some places is not exactly what the syntax web page
 * says.
 **/
Markdown.dialects.Gruber = {
  block: {
    atxHeader: function atxHeader( block, next ) {
      var m = block.match( /^(#{1,6})\s*(.*?)\s*#*\s*(?:\n|$)/ );

      if ( !m ) return undefined;

      var header = [ "header", { level: m[ 1 ].length } ];
      Array.prototype.push.apply(header, this.processInline(m[ 2 ]));

      if ( m[0].length < block.length )
        next.unshift( mk_block( block.substr( m[0].length ), block.trailing, block.lineNumber + 2 ) );

      return [ header ];
    },

    setextHeader: function setextHeader( block, next ) {
      var m = block.match( /^(.*)\n([-=])\2\2+(?:\n|$)/ );

      if ( !m ) return undefined;

      var level = ( m[ 2 ] === "=" ) ? 1 : 2;
      var header = [ "header", { level : level }, m[ 1 ] ];

      if ( m[0].length < block.length )
        next.unshift( mk_block( block.substr( m[0].length ), block.trailing, block.lineNumber + 2 ) );

      return [ header ];
    },

    code: function code( block, next ) {
      // |    Foo
      // |bar
      // should be a code block followed by a paragraph. Fun
      //
      // There might also be adjacent code block to merge.

      var ret = [],
          re = /^(?: {0,3}\t| {4})(.*)\n?/,
          lines;

      // 4 spaces + content
      if ( !block.match( re ) ) return undefined;

      block_search:
      do {
        // Now pull out the rest of the lines
        var b = this.loop_re_over_block(
                  re, block.valueOf(), function( m ) { ret.push( m[1] ); } );

        if ( b.length ) {
          // Case alluded to in first comment. push it back on as a new block
          next.unshift( mk_block(b, block.trailing) );
          break block_search;
        }
        else if ( next.length ) {
          // Check the next block - it might be code too
          if ( !next[0].match( re ) ) break block_search;

          // Pull how how many blanks lines follow - minus two to account for .join
          ret.push ( block.trailing.replace(/[^\n]/g, "").substring(2) );

          block = next.shift();
        }
        else {
          break block_search;
        }
      } while ( true );

      return [ [ "code_block", ret.join("\n") ] ];
    },

    horizRule: function horizRule( block, next ) {
      // this needs to find any hr in the block to handle abutting blocks
      var m = block.match( /^(?:([\s\S]*?)\n)?[ \t]*([-_*])(?:[ \t]*\2){2,}[ \t]*(?:\n([\s\S]*))?$/ );

      if ( !m ) {
        return undefined;
      }

      var jsonml = [ [ "hr" ] ];

      // if there's a leading abutting block, process it
      if ( m[ 1 ] ) {
        jsonml.unshift.apply( jsonml, this.processBlock( m[ 1 ], [] ) );
      }

      // if there's a trailing abutting block, stick it into next
      if ( m[ 3 ] ) {
        next.unshift( mk_block( m[ 3 ] ) );
      }

      return jsonml;
    },

    // There are two types of lists. Tight and loose. Tight lists have no whitespace
    // between the items (and result in text just in the <li>) and loose lists,
    // which have an empty line between list items, resulting in (one or more)
    // paragraphs inside the <li>.
    //
    // There are all sorts weird edge cases about the original markdown.pl's
    // handling of lists:
    //
    // * Nested lists are supposed to be indented by four chars per level. But
    //   if they aren't, you can get a nested list by indenting by less than
    //   four so long as the indent doesn't match an indent of an existing list
    //   item in the 'nest stack'.
    //
    // * The type of the list (bullet or number) is controlled just by the
    //    first item at the indent. Subsequent changes are ignored unless they
    //    are for nested lists
    //
    lists: (function( ) {
      // Use a closure to hide a few variables.
      var any_list = "[*+-]|\\d+\\.",
          bullet_list = /[*+-]/,
          number_list = /\d+\./,
          // Capture leading indent as it matters for determining nested lists.
          is_list_re = new RegExp( "^( {0,3})(" + any_list + ")[ \t]+" ),
          indent_re = "(?: {0,3}\\t| {4})";

      // TODO: Cache this regexp for certain depths.
      // Create a regexp suitable for matching an li for a given stack depth
      function regex_for_depth( depth ) {

        return new RegExp(
          // m[1] = indent, m[2] = list_type
          "(?:^(" + indent_re + "{0," + depth + "} {0,3})(" + any_list + ")\\s+)|" +
          // m[3] = cont
          "(^" + indent_re + "{0," + (depth-1) + "}[ ]{0,4})"
        );
      }
      function expand_tab( input ) {
        return input.replace( / {0,3}\t/g, "    " );
      }

      // Add inline content `inline` to `li`. inline comes from processInline
      // so is an array of content
      function add(li, loose, inline, nl) {
        if ( loose ) {
          li.push( [ "para" ].concat(inline) );
          return;
        }
        // Hmmm, should this be any block level element or just paras?
        var add_to = li[li.length -1] instanceof Array && li[li.length - 1][0] == "para"
                   ? li[li.length -1]
                   : li;

        // If there is already some content in this list, add the new line in
        if ( nl && li.length > 1 ) inline.unshift(nl);

        for ( var i = 0; i < inline.length; i++ ) {
          var what = inline[i],
              is_str = typeof what == "string";
          if ( is_str && add_to.length > 1 && typeof add_to[add_to.length-1] == "string" ) {
            add_to[ add_to.length-1 ] += what;
          }
          else {
            add_to.push( what );
          }
        }
      }

      // contained means have an indent greater than the current one. On
      // *every* line in the block
      function get_contained_blocks( depth, blocks ) {

        var re = new RegExp( "^(" + indent_re + "{" + depth + "}.*?\\n?)*$" ),
            replace = new RegExp("^" + indent_re + "{" + depth + "}", "gm"),
            ret = [];

        while ( blocks.length > 0 ) {
          if ( re.exec( blocks[0] ) ) {
            var b = blocks.shift(),
                // Now remove that indent
                x = b.replace( replace, "");

            ret.push( mk_block( x, b.trailing, b.lineNumber ) );
          }
          else {
            break;
          }
        }
        return ret;
      }

      // passed to stack.forEach to turn list items up the stack into paras
      function paragraphify(s, i, stack) {
        var list = s.list;
        var last_li = list[list.length-1];

        if ( last_li[1] instanceof Array && last_li[1][0] == "para" ) {
          return;
        }
        if ( i + 1 == stack.length ) {
          // Last stack frame
          // Keep the same array, but replace the contents
          last_li.push( ["para"].concat( last_li.splice(1, last_li.length - 1) ) );
        }
        else {
          var sublist = last_li.pop();
          last_li.push( ["para"].concat( last_li.splice(1, last_li.length - 1) ), sublist );
        }
      }

      // The matcher function
      return function( block, next ) {
        var m = block.match( is_list_re );
        if ( !m ) return undefined;

        function make_list( m ) {
          var list = bullet_list.exec( m[2] )
                   ? ["bulletlist"]
                   : ["numberlist"];

          stack.push( { list: list, indent: m[1] } );
          return list;
        }


        var stack = [], // Stack of lists for nesting.
            list = make_list( m ),
            last_li,
            loose = false,
            ret = [ stack[0].list ],
            i;

        // Loop to search over block looking for inner block elements and loose lists
        loose_search:
        while ( true ) {
          // Split into lines preserving new lines at end of line
          var lines = block.split( /(?=\n)/ );

          // We have to grab all lines for a li and call processInline on them
          // once as there are some inline things that can span lines.
          var li_accumulate = "";

          // Loop over the lines in this block looking for tight lists.
          tight_search:
          for ( var line_no = 0; line_no < lines.length; line_no++ ) {
            var nl = "",
                l = lines[line_no].replace(/^\n/, function(n) { nl = n; return ""; });

            // TODO: really should cache this
            var line_re = regex_for_depth( stack.length );

            m = l.match( line_re );
            //print( "line:", uneval(l), "\nline match:", uneval(m) );

            // We have a list item
            if ( m[1] !== undefined ) {
              // Process the previous list item, if any
              if ( li_accumulate.length ) {
                add( last_li, loose, this.processInline( li_accumulate ), nl );
                // Loose mode will have been dealt with. Reset it
                loose = false;
                li_accumulate = "";
              }

              m[1] = expand_tab( m[1] );
              var wanted_depth = Math.floor(m[1].length/4)+1;
              //print( "want:", wanted_depth, "stack:", stack.length);
              if ( wanted_depth > stack.length ) {
                // Deep enough for a nested list outright
                //print ( "new nested list" );
                list = make_list( m );
                last_li.push( list );
                last_li = list[1] = [ "listitem" ];
              }
              else {
                // We aren't deep enough to be strictly a new level. This is
                // where Md.pl goes nuts. If the indent matches a level in the
                // stack, put it there, else put it one deeper then the
                // wanted_depth deserves.
                var found = false;
                for ( i = 0; i < stack.length; i++ ) {
                  if ( stack[ i ].indent != m[1] ) continue;
                  list = stack[ i ].list;
                  stack.splice( i+1, stack.length - (i+1) );
                  found = true;
                  break;
                }

                if (!found) {
                  //print("not found. l:", uneval(l));
                  wanted_depth++;
                  if ( wanted_depth <= stack.length ) {
                    stack.splice(wanted_depth, stack.length - wanted_depth);
                    //print("Desired depth now", wanted_depth, "stack:", stack.length);
                    list = stack[wanted_depth-1].list;
                    //print("list:", uneval(list) );
                  }
                  else {
                    //print ("made new stack for messy indent");
                    list = make_list(m);
                    last_li.push(list);
                  }
                }

                //print( uneval(list), "last", list === stack[stack.length-1].list );
                last_li = [ "listitem" ];
                list.push(last_li);
              } // end depth of shenegains
              nl = "";
            }

            // Add content
            if ( l.length > m[0].length ) {
              li_accumulate += nl + l.substr( m[0].length );
            }
          } // tight_search

          if ( li_accumulate.length ) {
            add( last_li, loose, this.processInline( li_accumulate ), nl );
            // Loose mode will have been dealt with. Reset it
            loose = false;
            li_accumulate = "";
          }

          // Look at the next block - we might have a loose list. Or an extra
          // paragraph for the current li
          var contained = get_contained_blocks( stack.length, next );

          // Deal with code blocks or properly nested lists
          if ( contained.length > 0 ) {
            // Make sure all listitems up the stack are paragraphs
            forEach( stack, paragraphify, this);

            last_li.push.apply( last_li, this.toTree( contained, [] ) );
          }

          var next_block = next[0] && next[0].valueOf() || "";

          if ( next_block.match(is_list_re) || next_block.match( /^ / ) ) {
            block = next.shift();

            // Check for an HR following a list: features/lists/hr_abutting
            var hr = this.dialect.block.horizRule( block, next );

            if ( hr ) {
              ret.push.apply(ret, hr);
              break;
            }

            // Make sure all listitems up the stack are paragraphs
            forEach( stack, paragraphify, this);

            loose = true;
            continue loose_search;
          }
          break;
        } // loose_search

        return ret;
      };
    })(),

    blockquote: function blockquote( block, next ) {
      if ( !block.match( /^>/m ) )
        return undefined;

      var jsonml = [];

      // separate out the leading abutting block, if any. I.e. in this case:
      //
      //  a
      //  > b
      //
      if ( block[ 0 ] != ">" ) {
        var lines = block.split( /\n/ ),
            prev = [],
            line_no = block.lineNumber;

        // keep shifting lines until you find a crotchet
        while ( lines.length && lines[ 0 ][ 0 ] != ">" ) {
            prev.push( lines.shift() );
            line_no++;
        }

        var abutting = mk_block( prev.join( "\n" ), "\n", block.lineNumber );
        jsonml.push.apply( jsonml, this.processBlock( abutting, [] ) );
        // reassemble new block of just block quotes!
        block = mk_block( lines.join( "\n" ), block.trailing, line_no );
      }


      // if the next block is also a blockquote merge it in
      while ( next.length && next[ 0 ][ 0 ] == ">" ) {
        var b = next.shift();
        block = mk_block( block + block.trailing + b, b.trailing, block.lineNumber );
      }

      // Strip off the leading "> " and re-process as a block.
      var input = block.replace( /^> ?/gm, "" ),
          old_tree = this.tree,
          processedBlock = this.toTree( input, [ "blockquote" ] ),
          attr = extract_attr( processedBlock );

      // If any link references were found get rid of them
      if ( attr && attr.references ) {
        delete attr.references;
        // And then remove the attribute object if it's empty
        if ( isEmpty( attr ) ) {
          processedBlock.splice( 1, 1 );
        }
      }

      jsonml.push( processedBlock );
      return jsonml;
    },

    referenceDefn: function referenceDefn( block, next) {
      var re = /^\s*\[(.*?)\]:\s*(\S+)(?:\s+(?:(['"])(.*?)\3|\((.*?)\)))?\n?/;
      // interesting matches are [ , ref_id, url, , title, title ]

      if ( !block.match(re) )
        return undefined;

      // make an attribute node if it doesn't exist
      if ( !extract_attr( this.tree ) ) {
        this.tree.splice( 1, 0, {} );
      }

      var attrs = extract_attr( this.tree );

      // make a references hash if it doesn't exist
      if ( attrs.references === undefined ) {
        attrs.references = {};
      }

      var b = this.loop_re_over_block(re, block, function( m ) {

        if ( m[2] && m[2][0] == "<" && m[2][m[2].length-1] == ">" )
          m[2] = m[2].substring( 1, m[2].length - 1 );

        var ref = attrs.references[ m[1].toLowerCase() ] = {
          href: m[2]
        };

        if ( m[4] !== undefined )
          ref.title = m[4];
        else if ( m[5] !== undefined )
          ref.title = m[5];

      } );

      if ( b.length )
        next.unshift( mk_block( b, block.trailing ) );

      return [];
    },

    para: function para( block, next ) {
      // everything's a para!
      return [ ["para"].concat( this.processInline( block ) ) ];
    }
  }
};

Markdown.dialects.Gruber.inline = {

    __oneElement__: function oneElement( text, patterns_or_re, previous_nodes ) {
      var m,
          res,
          lastIndex = 0;

      patterns_or_re = patterns_or_re || this.dialect.inline.__patterns__;
      var re = new RegExp( "([\\s\\S]*?)(" + (patterns_or_re.source || patterns_or_re) + ")" );

      m = re.exec( text );
      if (!m) {
        // Just boring text
        return [ text.length, text ];
      }
      else if ( m[1] ) {
        // Some un-interesting text matched. Return that first
        return [ m[1].length, m[1] ];
      }

      var res;
      if ( m[2] in this.dialect.inline ) {
        res = this.dialect.inline[ m[2] ].call(
                  this,
                  text.substr( m.index ), m, previous_nodes || [] );
      }
      // Default for now to make dev easier. just slurp special and output it.
      res = res || [ m[2].length, m[2] ];
      return res;
    },

    __call__: function inline( text, patterns ) {

      var out = [],
          res;

      function add(x) {
        //D:self.debug("  adding output", uneval(x));
        if ( typeof x == "string" && typeof out[out.length-1] == "string" )
          out[ out.length-1 ] += x;
        else
          out.push(x);
      }

      while ( text.length > 0 ) {
        res = this.dialect.inline.__oneElement__.call(this, text, patterns, out );
        text = text.substr( res.shift() );
        forEach(res, add )
      }

      return out;
    },

    // These characters are intersting elsewhere, so have rules for them so that
    // chunks of plain text blocks don't include them
    "]": function () {},
    "}": function () {},

    __escape__ : /^\\[\\`\*_{}\[\]()#\+.!\-]/,

    "\\": function escaped( text ) {
      // [ length of input processed, node/children to add... ]
      // Only esacape: \ ` * _ { } [ ] ( ) # * + - . !
      if ( this.dialect.inline.__escape__.exec( text ) )
        return [ 2, text.charAt( 1 ) ];
      else
        // Not an esacpe
        return [ 1, "\\" ];
    },

    "![": function image( text ) {

      // Unlike images, alt text is plain text only. no other elements are
      // allowed in there

      // ![Alt text](/path/to/img.jpg "Optional title")
      //      1          2            3       4         <--- captures
      var m = text.match( /^!\[(.*?)\][ \t]*\([ \t]*([^")]*?)(?:[ \t]+(["'])(.*?)\3)?[ \t]*\)/ );

      if ( m ) {
        if ( m[2] && m[2][0] == "<" && m[2][m[2].length-1] == ">" )
          m[2] = m[2].substring( 1, m[2].length - 1 );

        m[2] = this.dialect.inline.__call__.call( this, m[2], /\\/ )[0];

        var attrs = { alt: m[1], href: m[2] || "" };
        if ( m[4] !== undefined)
          attrs.title = m[4];

        return [ m[0].length, [ "img", attrs ] ];
      }

      // ![Alt text][id]
      m = text.match( /^!\[(.*?)\][ \t]*\[(.*?)\]/ );

      if ( m ) {
        // We can't check if the reference is known here as it likely wont be
        // found till after. Check it in md tree->hmtl tree conversion
        return [ m[0].length, [ "img_ref", { alt: m[1], ref: m[2].toLowerCase(), original: m[0] } ] ];
      }

      // Just consume the '!['
      return [ 2, "![" ];
    },

    "[": function link( text ) {

      var orig = String(text);
      // Inline content is possible inside `link text`
      var res = Markdown.DialectHelpers.inline_until_char.call( this, text.substr(1), "]" );

      // No closing ']' found. Just consume the [
      if ( !res ) return [ 1, "[" ];

      var consumed = 1 + res[ 0 ],
          children = res[ 1 ],
          link,
          attrs;

      // At this point the first [...] has been parsed. See what follows to find
      // out which kind of link we are (reference or direct url)
      text = text.substr( consumed );

      // [link text](/path/to/img.jpg "Optional title")
      //                 1            2       3         <--- captures
      // This will capture up to the last paren in the block. We then pull
      // back based on if there a matching ones in the url
      //    ([here](/url/(test))
      // The parens have to be balanced
      var m = text.match( /^\s*\([ \t]*([^"']*)(?:[ \t]+(["'])(.*?)\2)?[ \t]*\)/ );
      if ( m ) {
        var url = m[1];
        consumed += m[0].length;

        if ( url && url[0] == "<" && url[url.length-1] == ">" )
          url = url.substring( 1, url.length - 1 );

        // If there is a title we don't have to worry about parens in the url
        if ( !m[3] ) {
          var open_parens = 1; // One open that isn't in the capture
          for ( var len = 0; len < url.length; len++ ) {
            switch ( url[len] ) {
            case "(":
              open_parens++;
              break;
            case ")":
              if ( --open_parens == 0) {
                consumed -= url.length - len;
                url = url.substring(0, len);
              }
              break;
            }
          }
        }

        // Process escapes only
        url = this.dialect.inline.__call__.call( this, url, /\\/ )[0];

        attrs = { href: url || "" };
        if ( m[3] !== undefined)
          attrs.title = m[3];

        link = [ "link", attrs ].concat( children );
        return [ consumed, link ];
      }

      // [Alt text][id]
      // [Alt text] [id]
      m = text.match( /^\s*\[(.*?)\]/ );

      if ( m ) {

        consumed += m[ 0 ].length;

        // [links][] uses links as its reference
        attrs = { ref: ( m[ 1 ] || String(children) ).toLowerCase(),  original: orig.substr( 0, consumed ) };

        link = [ "link_ref", attrs ].concat( children );

        // We can't check if the reference is known here as it likely wont be
        // found till after. Check it in md tree->hmtl tree conversion.
        // Store the original so that conversion can revert if the ref isn't found.
        return [ consumed, link ];
      }

      // [id]
      // Only if id is plain (no formatting.)
      if ( children.length == 1 && typeof children[0] == "string" ) {

        attrs = { ref: children[0].toLowerCase(),  original: orig.substr( 0, consumed ) };
        link = [ "link_ref", attrs, children[0] ];
        return [ consumed, link ];
      }

      // Just consume the "["
      return [ 1, "[" ];
    },


    "<": function autoLink( text ) {
      var m;

      if ( ( m = text.match( /^<(?:((https?|ftp|mailto):[^>]+)|(.*?@.*?\.[a-zA-Z]+))>/ ) ) != null ) {
        if ( m[3] ) {
          return [ m[0].length, [ "link", { href: "mailto:" + m[3] }, m[3] ] ];

        }
        else if ( m[2] == "mailto" ) {
          return [ m[0].length, [ "link", { href: m[1] }, m[1].substr("mailto:".length ) ] ];
        }
        else
          return [ m[0].length, [ "link", { href: m[1] }, m[1] ] ];
      }

      return [ 1, "<" ];
    },

    "`": function inlineCode( text ) {
      // Inline code block. as many backticks as you like to start it
      // Always skip over the opening ticks.
      var m = text.match( /(`+)(([\s\S]*?)\1)/ );

      if ( m && m[2] )
        return [ m[1].length + m[2].length, [ "inlinecode", m[3] ] ];
      else {
        // TODO: No matching end code found - warn!
        return [ 1, "`" ];
      }
    },

    "  \n": function lineBreak( text ) {
      return [ 3, [ "linebreak" ] ];
    }

};

// Meta Helper/generator method for em and strong handling
function strong_em( tag, md ) {

  var state_slot = tag + "_state",
      other_slot = tag == "strong" ? "em_state" : "strong_state";

  function CloseTag(len) {
    this.len_after = len;
    this.name = "close_" + md;
  }

  return function ( text, orig_match ) {

    if ( this[state_slot][0] == md ) {
      // Most recent em is of this type
      //D:this.debug("closing", md);
      this[state_slot].shift();

      // "Consume" everything to go back to the recrusion in the else-block below
      return[ text.length, new CloseTag(text.length-md.length) ];
    }
    else {
      // Store a clone of the em/strong states
      var other = this[other_slot].slice(),
          state = this[state_slot].slice();

      this[state_slot].unshift(md);

      //D:this.debug_indent += "  ";

      // Recurse
      var res = this.processInline( text.substr( md.length ) );
      //D:this.debug_indent = this.debug_indent.substr(2);

      var last = res[res.length - 1];

      //D:this.debug("processInline from", tag + ": ", uneval( res ) );

      var check = this[state_slot].shift();
      if ( last instanceof CloseTag ) {
        res.pop();
        // We matched! Huzzah.
        var consumed = text.length - last.len_after;
        return [ consumed, [ tag ].concat(res) ];
      }
      else {
        // Restore the state of the other kind. We might have mistakenly closed it.
        this[other_slot] = other;
        this[state_slot] = state;

        // We can't reuse the processed result as it could have wrong parsing contexts in it.
        return [ md.length, md ];
      }
    }
  }; // End returned function
}

Markdown.dialects.Gruber.inline["**"] = strong_em("strong", "**");
Markdown.dialects.Gruber.inline["__"] = strong_em("strong", "__");
Markdown.dialects.Gruber.inline["*"]  = strong_em("em", "*");
Markdown.dialects.Gruber.inline["_"]  = strong_em("em", "_");


// Build default order from insertion order.
Markdown.buildBlockOrder = function(d) {
  var ord = [];
  for ( var i in d ) {
    if ( i == "__order__" || i == "__call__" ) continue;
    ord.push( i );
  }
  d.__order__ = ord;
};

// Build patterns for inline matcher
Markdown.buildInlinePatterns = function(d) {
  var patterns = [];

  for ( var i in d ) {
    // __foo__ is reserved and not a pattern
    if ( i.match( /^__.*__$/) ) continue;
    var l = i.replace( /([\\.*+?|()\[\]{}])/g, "\\$1" )
             .replace( /\n/, "\\n" );
    patterns.push( i.length == 1 ? l : "(?:" + l + ")" );
  }

  patterns = patterns.join("|");
  d.__patterns__ = patterns;
  //print("patterns:", uneval( patterns ) );

  var fn = d.__call__;
  d.__call__ = function(text, pattern) {
    if ( pattern != undefined ) {
      return fn.call(this, text, pattern);
    }
    else
    {
      return fn.call(this, text, patterns);
    }
  };
};

Markdown.DialectHelpers = {};
Markdown.DialectHelpers.inline_until_char = function( text, want ) {
  var consumed = 0,
      nodes = [];

  while ( true ) {
    if ( text.charAt( consumed ) == want ) {
      // Found the character we were looking for
      consumed++;
      return [ consumed, nodes ];
    }

    if ( consumed >= text.length ) {
      // No closing char found. Abort.
      return null;
    }

    var res = this.dialect.inline.__oneElement__.call(this, text.substr( consumed ) );
    consumed += res[ 0 ];
    // Add any returned nodes.
    nodes.push.apply( nodes, res.slice( 1 ) );
  }
}

// Helper function to make sub-classing a dialect easier
Markdown.subclassDialect = function( d ) {
  function Block() {}
  Block.prototype = d.block;
  function Inline() {}
  Inline.prototype = d.inline;

  return { block: new Block(), inline: new Inline() };
};

Markdown.buildBlockOrder ( Markdown.dialects.Gruber.block );
Markdown.buildInlinePatterns( Markdown.dialects.Gruber.inline );

Markdown.dialects.Maruku = Markdown.subclassDialect( Markdown.dialects.Gruber );

Markdown.dialects.Maruku.processMetaHash = function processMetaHash( meta_string ) {
  var meta = split_meta_hash( meta_string ),
      attr = {};

  for ( var i = 0; i < meta.length; ++i ) {
    // id: #foo
    if ( /^#/.test( meta[ i ] ) ) {
      attr.id = meta[ i ].substring( 1 );
    }
    // class: .foo
    else if ( /^\./.test( meta[ i ] ) ) {
      // if class already exists, append the new one
      if ( attr["class"] ) {
        attr["class"] = attr["class"] + meta[ i ].replace( /./, " " );
      }
      else {
        attr["class"] = meta[ i ].substring( 1 );
      }
    }
    // attribute: foo=bar
    else if ( /\=/.test( meta[ i ] ) ) {
      var s = meta[ i ].split( /\=/ );
      attr[ s[ 0 ] ] = s[ 1 ];
    }
  }

  return attr;
}

function split_meta_hash( meta_string ) {
  var meta = meta_string.split( "" ),
      parts = [ "" ],
      in_quotes = false;

  while ( meta.length ) {
    var letter = meta.shift();
    switch ( letter ) {
      case " " :
        // if we're in a quoted section, keep it
        if ( in_quotes ) {
          parts[ parts.length - 1 ] += letter;
        }
        // otherwise make a new part
        else {
          parts.push( "" );
        }
        break;
      case "'" :
      case '"' :
        // reverse the quotes and move straight on
        in_quotes = !in_quotes;
        break;
      case "\\" :
        // shift off the next letter to be used straight away.
        // it was escaped so we'll keep it whatever it is
        letter = meta.shift();
      default :
        parts[ parts.length - 1 ] += letter;
        break;
    }
  }

  return parts;
}

Markdown.dialects.Maruku.block.document_meta = function document_meta( block, next ) {
  // we're only interested in the first block
  if ( block.lineNumber > 1 ) return undefined;

  // document_meta blocks consist of one or more lines of `Key: Value\n`
  if ( ! block.match( /^(?:\w+:.*\n)*\w+:.*$/ ) ) return undefined;

  // make an attribute node if it doesn't exist
  if ( !extract_attr( this.tree ) ) {
    this.tree.splice( 1, 0, {} );
  }

  var pairs = block.split( /\n/ );
  for ( p in pairs ) {
    var m = pairs[ p ].match( /(\w+):\s*(.*)$/ ),
        key = m[ 1 ].toLowerCase(),
        value = m[ 2 ];

    this.tree[ 1 ][ key ] = value;
  }

  // document_meta produces no content!
  return [];
};

Markdown.dialects.Maruku.block.block_meta = function block_meta( block, next ) {
  // check if the last line of the block is an meta hash
  var m = block.match( /(^|\n) {0,3}\{:\s*((?:\\\}|[^\}])*)\s*\}$/ );
  if ( !m ) return undefined;

  // process the meta hash
  var attr = this.dialect.processMetaHash( m[ 2 ] );

  var hash;

  // if we matched ^ then we need to apply meta to the previous block
  if ( m[ 1 ] === "" ) {
    var node = this.tree[ this.tree.length - 1 ];
    hash = extract_attr( node );

    // if the node is a string (rather than JsonML), bail
    if ( typeof node === "string" ) return undefined;

    // create the attribute hash if it doesn't exist
    if ( !hash ) {
      hash = {};
      node.splice( 1, 0, hash );
    }

    // add the attributes in
    for ( a in attr ) {
      hash[ a ] = attr[ a ];
    }

    // return nothing so the meta hash is removed
    return [];
  }

  // pull the meta hash off the block and process what's left
  var b = block.replace( /\n.*$/, "" ),
      result = this.processBlock( b, [] );

  // get or make the attributes hash
  hash = extract_attr( result[ 0 ] );
  if ( !hash ) {
    hash = {};
    result[ 0 ].splice( 1, 0, hash );
  }

  // attach the attributes to the block
  for ( a in attr ) {
    hash[ a ] = attr[ a ];
  }

  return result;
};

Markdown.dialects.Maruku.block.definition_list = function definition_list( block, next ) {
  // one or more terms followed by one or more definitions, in a single block
  var tight = /^((?:[^\s:].*\n)+):\s+([\s\S]+)$/,
      list = [ "dl" ],
      i, m;

  // see if we're dealing with a tight or loose block
  if ( ( m = block.match( tight ) ) ) {
    // pull subsequent tight DL blocks out of `next`
    var blocks = [ block ];
    while ( next.length && tight.exec( next[ 0 ] ) ) {
      blocks.push( next.shift() );
    }

    for ( var b = 0; b < blocks.length; ++b ) {
      var m = blocks[ b ].match( tight ),
          terms = m[ 1 ].replace( /\n$/, "" ).split( /\n/ ),
          defns = m[ 2 ].split( /\n:\s+/ );

      // print( uneval( m ) );

      for ( i = 0; i < terms.length; ++i ) {
        list.push( [ "dt", terms[ i ] ] );
      }

      for ( i = 0; i < defns.length; ++i ) {
        // run inline processing over the definition
        list.push( [ "dd" ].concat( this.processInline( defns[ i ].replace( /(\n)\s+/, "$1" ) ) ) );
      }
    }
  }
  else {
    return undefined;
  }

  return [ list ];
};

// splits on unescaped instances of @ch. If @ch is not a character the result
// can be unpredictable

Markdown.dialects.Maruku.block.table = function table (block, next) {

    var _split_on_unescaped = function(s, ch) {
        ch = ch || '\\s';
        if (ch.match(/^[\\|\[\]{}?*.+^$]$/)) { ch = '\\' + ch; }
        var res = [ ],
            r = new RegExp('^((?:\\\\.|[^\\\\' + ch + '])*)' + ch + '(.*)'),
            m;
        while(m = s.match(r)) {
            res.push(m[1]);
            s = m[2];
        }
        res.push(s);
        return res;
    }

    var leading_pipe = /^ {0,3}\|(.+)\n {0,3}\|\s*([\-:]+[\-| :]*)\n((?:\s*\|.*(?:\n|$))*)(?=\n|$)/,
        // find at least an unescaped pipe in each line
        no_leading_pipe = /^ {0,3}(\S(?:\\.|[^\\|])*\|.*)\n {0,3}([\-:]+\s*\|[\-| :]*)\n((?:(?:\\.|[^\\|])*\|.*(?:\n|$))*)(?=\n|$)/,
        i, m;
    if (m = block.match(leading_pipe)) {
        // remove leading pipes in contents
        // (header and horizontal rule already have the leading pipe left out)
        m[3] = m[3].replace(/^\s*\|/gm, '');
    } else if (! ( m = block.match(no_leading_pipe))) {
        return undefined;
    }

    var table = [ "table", [ "thead", [ "tr" ] ], [ "tbody" ] ];

    // remove trailing pipes, then split on pipes
    // (no escaped pipes are allowed in horizontal rule)
    m[2] = m[2].replace(/\|\s*$/, '').split('|');

    // process alignment
    var html_attrs = [ ];
    forEach (m[2], function (s) {
        if (s.match(/^\s*-+:\s*$/))       html_attrs.push({align: "right"});
        else if (s.match(/^\s*:-+\s*$/))  html_attrs.push({align: "left"});
        else if (s.match(/^\s*:-+:\s*$/)) html_attrs.push({align: "center"});
        else                              html_attrs.push({});
    });

    // now for the header, avoid escaped pipes
    m[1] = _split_on_unescaped(m[1].replace(/\|\s*$/, ''), '|');
    for (i = 0; i < m[1].length; i++) {
        table[1][1].push(['th', html_attrs[i] || {}].concat(
            this.processInline(m[1][i].trim())));
    }

    // now for body contents
    forEach (m[3].replace(/\|\s*$/mg, '').split('\n'), function (row) {
        var html_row = ['tr'];
        row = _split_on_unescaped(row, '|');
        for (i = 0; i < row.length; i++) {
            html_row.push(['td', html_attrs[i] || {}].concat(this.processInline(row[i].trim())));
        }
        table[2].push(html_row);
    }, this);

    return [table];
}

Markdown.dialects.Maruku.inline[ "{:" ] = function inline_meta( text, matches, out ) {
  if ( !out.length ) {
    return [ 2, "{:" ];
  }

  // get the preceeding element
  var before = out[ out.length - 1 ];

  if ( typeof before === "string" ) {
    return [ 2, "{:" ];
  }

  // match a meta hash
  var m = text.match( /^\{:\s*((?:\\\}|[^\}])*)\s*\}/ );

  // no match, false alarm
  if ( !m ) {
    return [ 2, "{:" ];
  }

  // attach the attributes to the preceeding element
  var meta = this.dialect.processMetaHash( m[ 1 ] ),
      attr = extract_attr( before );

  if ( !attr ) {
    attr = {};
    before.splice( 1, 0, attr );
  }

  for ( var k in meta ) {
    attr[ k ] = meta[ k ];
  }

  // cut out the string and replace it with nothing
  return [ m[ 0 ].length, "" ];
};

Markdown.dialects.Maruku.inline.__escape__ = /^\\[\\`\*_{}\[\]()#\+.!\-|:]/;

Markdown.buildBlockOrder ( Markdown.dialects.Maruku.block );
Markdown.buildInlinePatterns( Markdown.dialects.Maruku.inline );

var isArray = Array.isArray || function(obj) {
  return Object.prototype.toString.call(obj) == "[object Array]";
};

var forEach;
// Don't mess with Array.prototype. Its not friendly
if ( Array.prototype.forEach ) {
  forEach = function( arr, cb, thisp ) {
    return arr.forEach( cb, thisp );
  };
}
else {
  forEach = function(arr, cb, thisp) {
    for (var i = 0; i < arr.length; i++) {
      cb.call(thisp || arr, arr[i], i, arr);
    }
  }
}

var isEmpty = function( obj ) {
  for ( var key in obj ) {
    if ( hasOwnProperty.call( obj, key ) ) {
      return false;
    }
  }

  return true;
}

function extract_attr( jsonml ) {
  return isArray(jsonml)
      && jsonml.length > 1
      && typeof jsonml[ 1 ] === "object"
      && !( isArray(jsonml[ 1 ]) )
      ? jsonml[ 1 ]
      : undefined;
}



/**
 *  renderJsonML( jsonml[, options] ) -> String
 *  - jsonml (Array): JsonML array to render to XML
 *  - options (Object): options
 *
 *  Converts the given JsonML into well-formed XML.
 *
 *  The options currently understood are:
 *
 *  - root (Boolean): wether or not the root node should be included in the
 *    output, or just its children. The default `false` is to not include the
 *    root itself.
 */
expose.renderJsonML = function( jsonml, options ) {
  options = options || {};
  // include the root element in the rendered output?
  options.root = options.root || false;

  var content = [];

  if ( options.root ) {
    content.push( render_tree( jsonml ) );
  }
  else {
    jsonml.shift(); // get rid of the tag
    if ( jsonml.length && typeof jsonml[ 0 ] === "object" && !( jsonml[ 0 ] instanceof Array ) ) {
      jsonml.shift(); // get rid of the attributes
    }

    while ( jsonml.length ) {
      content.push( render_tree( jsonml.shift() ) );
    }
  }

  return content.join( "\n\n" );
};

function escapeHTML( text ) {
  return text.replace( /&/g, "&amp;" )
             .replace( /</g, "&lt;" )
             .replace( />/g, "&gt;" )
             .replace( /"/g, "&quot;" )
             .replace( /'/g, "&#39;" );
}

function render_tree( jsonml ) {
  // basic case
  if ( typeof jsonml === "string" ) {
    return escapeHTML( jsonml );
  }

  var tag = jsonml.shift(),
      attributes = {},
      content = [];

  if ( jsonml.length && typeof jsonml[ 0 ] === "object" && !( jsonml[ 0 ] instanceof Array ) ) {
    attributes = jsonml.shift();
  }

  while ( jsonml.length ) {
    content.push( render_tree( jsonml.shift() ) );
  }

  var tag_attrs = "";
  for ( var a in attributes ) {
    tag_attrs += " " + a + '="' + escapeHTML( attributes[ a ] ) + '"';
  }

  // be careful about adding whitespace here for inline elements
  if ( tag == "img" || tag == "br" || tag == "hr" ) {
    return "<"+ tag + tag_attrs + "/>";
  }
  else {
    return "<"+ tag + tag_attrs + ">" + content.join( "" ) + "</" + tag + ">";
  }
}

function convert_tree_to_html( tree, references, options ) {
  var i;
  options = options || {};

  // shallow clone
  var jsonml = tree.slice( 0 );

  if ( typeof options.preprocessTreeNode === "function" ) {
      jsonml = options.preprocessTreeNode(jsonml, references);
  }

  // Clone attributes if they exist
  var attrs = extract_attr( jsonml );
  if ( attrs ) {
    jsonml[ 1 ] = {};
    for ( i in attrs ) {
      jsonml[ 1 ][ i ] = attrs[ i ];
    }
    attrs = jsonml[ 1 ];
  }

  // basic case
  if ( typeof jsonml === "string" ) {
    return jsonml;
  }

  // convert this node
  switch ( jsonml[ 0 ] ) {
    case "header":
      jsonml[ 0 ] = "h" + jsonml[ 1 ].level;
      delete jsonml[ 1 ].level;
      break;
    case "bulletlist":
      jsonml[ 0 ] = "ul";
      break;
    case "numberlist":
      jsonml[ 0 ] = "ol";
      break;
    case "listitem":
      jsonml[ 0 ] = "li";
      break;
    case "para":
      jsonml[ 0 ] = "p";
      break;
    case "markdown":
      jsonml[ 0 ] = "html";
      if ( attrs ) delete attrs.references;
      break;
    case "code_block":
      jsonml[ 0 ] = "pre";
      i = attrs ? 2 : 1;
      var code = [ "code" ];
      code.push.apply( code, jsonml.splice( i, jsonml.length - i ) );
      jsonml[ i ] = code;
      break;
    case "inlinecode":
      jsonml[ 0 ] = "code";
      break;
    case "img":
      jsonml[ 1 ].src = jsonml[ 1 ].href;
      delete jsonml[ 1 ].href;
      break;
    case "linebreak":
      jsonml[ 0 ] = "br";
    break;
    case "link":
      jsonml[ 0 ] = "a";
      break;
    case "link_ref":
      jsonml[ 0 ] = "a";

      // grab this ref and clean up the attribute node
      var ref = references[ attrs.ref ];

      // if the reference exists, make the link
      if ( ref ) {
        delete attrs.ref;

        // add in the href and title, if present
        attrs.href = ref.href;
        if ( ref.title ) {
          attrs.title = ref.title;
        }

        // get rid of the unneeded original text
        delete attrs.original;
      }
      // the reference doesn't exist, so revert to plain text
      else {
        return attrs.original;
      }
      break;
    case "img_ref":
      jsonml[ 0 ] = "img";

      // grab this ref and clean up the attribute node
      var ref = references[ attrs.ref ];

      // if the reference exists, make the link
      if ( ref ) {
        delete attrs.ref;

        // add in the href and title, if present
        attrs.src = ref.href;
        if ( ref.title ) {
          attrs.title = ref.title;
        }

        // get rid of the unneeded original text
        delete attrs.original;
      }
      // the reference doesn't exist, so revert to plain text
      else {
        return attrs.original;
      }
      break;
  }

  // convert all the children
  i = 1;

  // deal with the attribute node, if it exists
  if ( attrs ) {
    // if there are keys, skip over it
    for ( var key in jsonml[ 1 ] ) {
        i = 2;
        break;
    }
    // if there aren't, remove it
    if ( i === 1 ) {
      jsonml.splice( i, 1 );
    }
  }

  for ( ; i < jsonml.length; ++i ) {
    jsonml[ i ] = convert_tree_to_html( jsonml[ i ], references, options );
  }

  return jsonml;
}


// merges adjacent text nodes into a single node
function merge_text_nodes( jsonml ) {
  // skip the tag name and attribute hash
  var i = extract_attr( jsonml ) ? 2 : 1;

  while ( i < jsonml.length ) {
    // if it's a string check the next item too
    if ( typeof jsonml[ i ] === "string" ) {
      if ( i + 1 < jsonml.length && typeof jsonml[ i + 1 ] === "string" ) {
        // merge the second string into the first and remove it
        jsonml[ i ] += jsonml.splice( i + 1, 1 )[ 0 ];
      }
      else {
        ++i;
      }
    }
    // if it's not a string recurse
    else {
      merge_text_nodes( jsonml[ i ] );
      ++i;
    }
  }
}

} )( (function() {
  if ( typeof exports === "undefined" ) {
    window.markdown = {};
    return window.markdown;
  }
  else {
    return exports;
  }
} )() );

},{"util":1132}],1138:[function(require,module,exports){
/*
* jQuery UI Tag-it!
*
* @version v2.0 (06/2011)
*
* Copyright 2011, Levy Carneiro Jr.
* Released under the MIT license.
* http://aehlke.github.com/tag-it/LICENSE
*
* Homepage:
*   http://aehlke.github.com/tag-it/
*
* Authors:
*   Levy Carneiro Jr.
*   Martin Rehfeld
*   Tobias Schmidt
*   Skylar Challand
*   Alex Ehlke
*
* Maintainer:
*   Alex Ehlke - Twitter: @aehlke
*
* Dependencies:
*   jQuery v1.4+
*   jQuery UI v1.8+
*/
(function($) {

    $.widget('ui.tagit', {
        options: {
            allowDuplicates   : false,
            caseSensitive     : true,
            fieldName         : 'tags',
            placeholderText   : null,   // Sets `placeholder` attr on input field.
            readOnly          : false,  // Disables editing.
            removeConfirmation: false,  // Require confirmation to remove tags.
            tagLimit          : null,   // Max number of tags allowed (null for unlimited).

            // Used for autocomplete, unless you override `autocomplete.source`.
            availableTags     : [],

            // Use to override or add any options to the autocomplete widget.
            //
            // By default, autocomplete.source will map to availableTags,
            // unless overridden.
            autocomplete: {},

            // Shows autocomplete before the user even types anything.
            showAutocompleteOnFocus: false,

            // When enabled, quotes are unneccesary for inputting multi-word tags.
            allowSpaces: false,

            // The below options are for using a single field instead of several
            // for our form values.
            //
            // When enabled, will use a single hidden field for the form,
            // rather than one per tag. It will delimit tags in the field
            // with singleFieldDelimiter.
            //
            // The easiest way to use singleField is to just instantiate tag-it
            // on an INPUT element, in which case singleField is automatically
            // set to true, and singleFieldNode is set to that element. This
            // way, you don't need to fiddle with these options.
            singleField: false,

            // This is just used when preloading data from the field, and for
            // populating the field with delimited tags as the user adds them.
            singleFieldDelimiter: ',',

            // Set this to an input DOM node to use an existing form field.
            // Any text in it will be erased on init. But it will be
            // populated with the text of tags as they are created,
            // delimited by singleFieldDelimiter.
            //
            // If this is not set, we create an input node for it,
            // with the name given in settings.fieldName.
            singleFieldNode: null,

            // Whether to animate tag removals or not.
            animate: true,

            // Optionally set a tabindex attribute on the input that gets
            // created for tag-it.
            tabIndex: null,

            // Event callbacks.
            beforeTagAdded      : null,
            afterTagAdded       : null,

            beforeTagRemoved    : null,
            afterTagRemoved     : null,

            onTagClicked        : null,
            onTagLimitExceeded  : null,


            // DEPRECATED:
            //
            // /!\ These event callbacks are deprecated and WILL BE REMOVED at some
            // point in the future. They're here for backwards-compatibility.
            // Use the above before/after event callbacks instead.
            onTagAdded  : null,
            onTagRemoved: null,
            // `autocomplete.source` is the replacement for tagSource.
            tagSource: null,
            onSubmitTags: null,
            onFocus: null,
            onBlur: null
            // Do not use the above deprecated options.
        },

        _create: function() {
            // for handling static scoping inside callbacks
            var that = this;

            // There are 2 kinds of DOM nodes this widget can be instantiated on:
            //     1. UL, OL, or some element containing either of these.
            //     2. INPUT, in which case 'singleField' is overridden to true,
            //        a UL is created and the INPUT is hidden.
            if (this.element.is('input')) {
                this.tagList = $('<ul></ul>').insertAfter(this.element);
                this.options.singleField = true;
                this.options.singleFieldNode = this.element;
                this.element.addClass('tagit-hidden-field');
            } else {
                this.tagList = this.element.find('ul, ol').andSelf().last();
            }

            this.tagInput = $('<input type="text" />').addClass('ui-widget-content');

            if (this.options.readOnly) this.tagInput.attr('disabled', 'disabled');

            if (this.options.tabIndex) {
                this.tagInput.attr('tabindex', this.options.tabIndex);
            }

            if (this.options.placeholderText) {
                this.tagInput.attr('placeholder', this.options.placeholderText);
            }

            if (!this.options.autocomplete.source) {
                this.options.autocomplete.source = function(search, showChoices) {
                    var filter = search.term.toLowerCase();
                    var choices = $.grep(this.options.availableTags, function(element) {
                        // Only match autocomplete options that begin with the search term.
                        // (Case insensitive.)
                        return (element.toLowerCase().indexOf(filter) === 0);
                    });
                    if (!this.options.allowDuplicates) {
                        choices = this._subtractArray(choices, this.assignedTags());
                    }
                    showChoices(choices);
                };
            }

            if (this.options.showAutocompleteOnFocus) {
                this.tagInput.focus(function(event, ui) {
                    that._showAutocomplete();
                });

                if (typeof this.options.autocomplete.minLength === 'undefined') {
                    this.options.autocomplete.minLength = 0;
                }
            }

            // Bind autocomplete.source callback functions to this context.
            if ($.isFunction(this.options.autocomplete.source)) {
                this.options.autocomplete.source = $.proxy(this.options.autocomplete.source, this);
            }

            // DEPRECATED.
            if ($.isFunction(this.options.tagSource)) {
                this.options.tagSource = $.proxy(this.options.tagSource, this);
            }

            this.tagList
                .addClass('tagit')
                .addClass('ui-widget ui-widget-content ui-corner-all')
                // Create the input field.
                .append($('<li class="tagit-new"></li>').append(this.tagInput))
                .click(function(e) {
                    var target = $(e.target);
                    if (target.hasClass('tagit-label')) {
                        var tag = target.closest('.tagit-choice');
                        if (!tag.hasClass('removed')) {
                            that._trigger('onTagClicked', e, {tag: tag, tagLabel: that.tagLabel(tag)});
                        }
                    } else {
                        // Sets the focus() to the input field, if the user
                        // clicks anywhere inside the UL. This is needed
                        // because the input field needs to be of a small size.
                        that.tagInput.focus();
                    }
                });

            // Single field support.
            var addedExistingFromSingleFieldNode = false;
            if (this.options.singleField) {
                if (this.options.singleFieldNode) {
                    // Add existing tags from the input field.
                    var node = $(this.options.singleFieldNode);
                    var tags = node.val().split(this.options.singleFieldDelimiter);
                    node.val('');
                    $.each(tags, function(index, tag) {
                        that.createTag(tag, null, true);
                        addedExistingFromSingleFieldNode = true;
                    });
                } else {
                    // Create our single field input after our list.
                    this.options.singleFieldNode = $('<input type="hidden" style="display:none;" value="" name="' + this.options.fieldName + '" />');
                    this.tagList.after(this.options.singleFieldNode);
                }
            }

            // Add existing tags from the list, if any.
            if (!addedExistingFromSingleFieldNode) {
                this.tagList.children('li').each(function() {
                    if (!$(this).hasClass('tagit-new')) {
                        that.createTag($(this).text(), $(this).attr('class'), true);
                        $(this).remove();
                    }
                });
            }

            // Events.
            this.tagInput
                .keydown(function(event) {
                    // Backspace is not detected within a keypress, so it must use keydown.
                    if (event.which == $.ui.keyCode.BACKSPACE && that.tagInput.val() === '') {
                        var tag = that._lastTag();
                        if (!that.options.removeConfirmation || tag.hasClass('remove')) {
                            // When backspace is pressed, the last tag is deleted.
                            that.removeTag(tag);
                        } else if (that.options.removeConfirmation) {
                            tag.addClass('remove ui-state-highlight');
                        }
                    } else if (that.options.removeConfirmation) {
                        that._lastTag().removeClass('remove ui-state-highlight');
                    } else if (event.which == $.ui.keyCode.ENTER && that.tagInput.val() === "") {
                        that._trigger('onSubmitTags', null, that.tagList);
                    }

                    // Comma/Space/Enter are all valid delimiters for new tags,
                    // except when there is an open quote or if setting allowSpaces = true.
                    // Tab will also create a tag, unless the tag input is empty,
                    // in which case it isn't caught.
                    if (
                        (event.which === $.ui.keyCode.COMMA && event.shiftKey === false) ||
                        event.which === $.ui.keyCode.ENTER ||
                        (
                            event.which == $.ui.keyCode.TAB &&
                            that.tagInput.val() !== ''
                        ) ||
                        (
                            event.which == $.ui.keyCode.SPACE &&
                            that.options.allowSpaces !== true &&
                            (
                                $.trim(that.tagInput.val()).replace( /^s*/, '' ).charAt(0) != '"' ||
                                (
                                    $.trim(that.tagInput.val()).charAt(0) == '"' &&
                                    $.trim(that.tagInput.val()).charAt($.trim(that.tagInput.val()).length - 1) == '"' &&
                                    $.trim(that.tagInput.val()).length - 1 !== 0
                                )
                            )
                        )
                    ) {
                        // Enter submits the form if there's no text in the input.
                        if (!(event.which === $.ui.keyCode.ENTER && that.tagInput.val() === '')) {
                            event.preventDefault();
                        }

                        // Autocomplete will create its own tag from a selection and close automatically.
                        if (!(that.options.autocomplete.autoFocus && that.tagInput.data('autocomplete-open'))) {
                            that.tagInput.autocomplete('close');
                            that.createTag(that._cleanedInput());
                        }
                    }
                }).blur(function(e){
                    that._trigger('onBlur', null, null);
                    // Create a tag when the element loses focus.
                    // If autocomplete is enabled and suggestion was clicked, don't add it.
                    if (!that.tagInput.data('autocomplete-open')) {
                        that.createTag(that._cleanedInput());
                    }
                }).focus(function(e) {
                    that._trigger('onFocus', null, null);
                })

            // Autocomplete.
            if (this.options.availableTags || this.options.tagSource || this.options.autocomplete.source) {
                var autocompleteOptions = {
                    select: function(event, ui) {
                        that.createTag(ui.item.value);
                        // Preventing the tag input to be updated with the chosen value.
                        return false;
                    }
                };
                $.extend(autocompleteOptions, this.options.autocomplete);

                // tagSource is deprecated, but takes precedence here since autocomplete.source is set by default,
                // while tagSource is left null by default.
                autocompleteOptions.source = this.options.tagSource || autocompleteOptions.source;

                this.tagInput.autocomplete(autocompleteOptions).bind('autocompleteopen.tagit', function(event, ui) {
                    that.tagInput.data('autocomplete-open', true);
                }).bind('autocompleteclose.tagit', function(event, ui) {
                    that.tagInput.data('autocomplete-open', false);
                });

                this.tagInput.autocomplete('widget').addClass('tagit-autocomplete');
            }
        },

        destroy: function() {
            $.Widget.prototype.destroy.call(this);

            this.element.unbind('.tagit');
            this.tagList.unbind('.tagit');

            this.tagInput.removeData('autocomplete-open');

            this.tagList.removeClass([
                'tagit',
                'ui-widget',
                'ui-widget-content',
                'ui-corner-all',
                'tagit-hidden-field'
            ].join(' '));

            if (this.element.is('input')) {
                this.element.removeClass('tagit-hidden-field');
                this.tagList.remove();
            } else {
                this.element.children('li').each(function() {
                    if ($(this).hasClass('tagit-new')) {
                        $(this).remove();
                    } else {
                        $(this).removeClass([
                            'tagit-choice',
                            'ui-widget-content',
                            'ui-state-default',
                            'ui-state-highlight',
                            'ui-corner-all',
                            'remove',
                            'tagit-choice-editable',
                            'tagit-choice-read-only'
                        ].join(' '));

                        $(this).text($(this).children('.tagit-label').text());
                    }
                });

                if (this.singleFieldNode) {
                    this.singleFieldNode.remove();
                }
            }

            return this;
        },

        _cleanedInput: function() {
            // Returns the contents of the tag input, cleaned and ready to be passed to createTag
            return $.trim(this.tagInput.val().replace(/^"(.*)"$/, '$1'));
        },

        _lastTag: function() {
            return this.tagList.find('.tagit-choice:last:not(.removed)');
        },

        _tags: function() {
            return this.tagList.find('.tagit-choice:not(.removed)');
        },

        assignedTags: function() {
            // Returns an array of tag string values
            var that = this;
            var tags = [];
            if (this.options.singleField) {
                tags = $(this.options.singleFieldNode).val().split(this.options.singleFieldDelimiter);
                if (tags[0] === '') {
                    tags = [];
                }
            } else {
                this._tags().each(function() {
                    tags.push(that.tagLabel(this));
                });
            }
            return tags;
        },

        _updateSingleTagsField: function(tags) {
            // Takes a list of tag string values, updates this.options.singleFieldNode.val to the tags delimited by this.options.singleFieldDelimiter
            $(this.options.singleFieldNode).val(tags.join(this.options.singleFieldDelimiter)).trigger('change');
        },

        _subtractArray: function(a1, a2) {
            var result = [];
            for (var i = 0; i < a1.length; i++) {
                if ($.inArray(a1[i], a2) == -1) {
                    result.push(a1[i]);
                }
            }
            return result;
        },

        tagLabel: function(tag) {
            // Returns the tag's string label.
            if (this.options.singleField) {
                return $(tag).find('.tagit-label:first').text();
            } else {
                return $(tag).find('input:first').val();
            }
        },

        _showAutocomplete: function() {
            this.tagInput.autocomplete('search', '');
        },

        _findTagByLabel: function(name) {
            var that = this;
            var tag = null;
            this._tags().each(function(i) {
                if (that._formatStr(name) == that._formatStr(that.tagLabel(this))) {
                    tag = $(this);
                    return false;
                }
            });
            return tag;
        },

        _isNew: function(name) {
            return !this._findTagByLabel(name);
        },

        _formatStr: function(str) {
            if (this.options.caseSensitive) {
                return str;
            }
            return $.trim(str.toLowerCase());
        },

        _effectExists: function(name) {
            return Boolean($.effects && ($.effects[name] || ($.effects.effect && $.effects.effect[name])));
        },

        createTag: function(value, additionalClass, duringInitialization) {
            var that = this;

            value = $.trim(value);

            if(this.options.preprocessTag) {
                value = this.options.preprocessTag(value);
            }

            if (value === '') {
                return false;
            }

            if (!this.options.allowDuplicates && !this._isNew(value)) {
                var existingTag = this._findTagByLabel(value);
                if (this._trigger('onTagExists', null, {
                    existingTag: existingTag,
                    duringInitialization: duringInitialization
                }) !== false) {
                    if (this._effectExists('highlight')) {
                        existingTag.effect('highlight');
                    }
                }
                return false;
            }

            if (this.options.tagLimit && this._tags().length >= this.options.tagLimit) {
                this._trigger('onTagLimitExceeded', null, {duringInitialization: duringInitialization});
                return false;
            }

            var label = $(this.options.onTagClicked ? '<a class="tagit-label"></a>' : '<span class="tagit-label"></span>').text(value);

            // Create tag.
            var tag = $('<li></li>')
                .addClass('tagit-choice ui-widget-content ui-state-default ui-corner-all')
                .addClass(additionalClass)
                .append(label);

            if (this.options.readOnly){
                tag.addClass('tagit-choice-read-only');
            } else {
                tag.addClass('tagit-choice-editable');
                // Button for removing the tag.
                var removeTagIcon = $('<span></span>')
                    .addClass('ui-icon ui-icon-close');
                var removeTag = $('<a><span class="text-icon">\xd7</span></a>') // \xd7 is an X
                    .addClass('tagit-close')
                    .append(removeTagIcon)
                    .click(function(e) {
                        // Removes a tag when the little 'x' is clicked.
                        that.removeTag(tag);
                    });
                tag.append(removeTag);
            }

            // Unless options.singleField is set, each tag has a hidden input field inline.
            if (!this.options.singleField) {
                var escapedValue = label.html();
                tag.append('<input type="hidden" value="' + escapedValue + '" name="' + this.options.fieldName + '" class="tagit-hidden-field" />');
            }

            if (this._trigger('beforeTagAdded', null, {
                tag: tag,
                tagLabel: this.tagLabel(tag),
                duringInitialization: duringInitialization
            }) === false) {
                return;
            }

            if (this.options.singleField) {
                var tags = this.assignedTags();
                tags.push(value);
                this._updateSingleTagsField(tags);
            }

            // DEPRECATED.
            this._trigger('onTagAdded', null, tag);

            this.tagInput.val('');

            // Insert tag.
            this.tagInput.parent().before(tag);

            this._trigger('afterTagAdded', null, {
                tag: tag,
                tagLabel: this.tagLabel(tag),
                duringInitialization: duringInitialization
            });

            if (this.options.showAutocompleteOnFocus && !duringInitialization) {
                setTimeout(function () { that._showAutocomplete(); }, 0);
            }
        },

        removeTag: function(tag, animate) {
            animate = typeof animate === 'undefined' ? this.options.animate : animate;

            tag = $(tag);

            // DEPRECATED.
            this._trigger('onTagRemoved', null, tag);

            if (this._trigger('beforeTagRemoved', null, {tag: tag, tagLabel: this.tagLabel(tag)}) === false) {
                return;
            }

            if (this.options.singleField) {
                var tags = this.assignedTags();
                var removedTagLabel = this.tagLabel(tag);
                tags = $.grep(tags, function(el){
                    return el != removedTagLabel;
                });
                this._updateSingleTagsField(tags);
            }

            if (animate) {
                tag.addClass('removed'); // Excludes this tag from _tags.
                var hide_args = this._effectExists('blind') ? ['blind', {direction: 'horizontal'}, 'fast'] : ['fast'];

                var thisTag = this;
                hide_args.push(function() {
                    tag.remove();
                    thisTag._trigger('afterTagRemoved', null, {tag: tag, tagLabel: thisTag.tagLabel(tag)});
                });

                tag.fadeOut('fast').hide.apply(tag, hide_args).dequeue();
            } else {
                tag.remove();
                this._trigger('afterTagRemoved', null, {tag: tag, tagLabel: this.tagLabel(tag)});
            }

        },

        removeTagByLabel: function(tagLabel, animate) {
            var toRemove = this._findTagByLabel(tagLabel);
            if (!toRemove) {
                throw "No such tag exists with the name '" + tagLabel + "'";
            }
            this.removeTag(toRemove, animate);
        },

        removeAll: function() {
            // Removes all tags.
            var that = this;
            this._tags().each(function(index, tag) {
                that.removeTag(tag, false);
            });
        }

    });
})(jQuery);

},{}]},{},[690])
//# sourceMappingURL=editor3.uncompressed.js.map
