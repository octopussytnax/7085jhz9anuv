/*! v4.7.15 - 2017-05-30 */
function enableClickOut(a){a.click(function(){cdb.god.trigger("closeDialogs")})}function GrouperLayerMapView(a){return{initialize:function(){this.groupLayer=null,this.activeLayerModel=null,a.prototype.initialize.call(this)},_removeLayers:function(){var a=this;_.each(this.map.layers.getLayersByType("CartoDB"),function(b){b.unbind(null,null,a)}),cdb.geo.MapView.prototype._removeLayers.call(this),this.groupLayer&&this.groupLayer.model.unbind(),this.groupLayer=null},_removeLayer:function(a){a.cid in this.layers?this.layers[a.cid]===this.groupLayer?(this._updateLayerDefinition(a),a.unbind(null,null,this),delete this.layers[a.cid],this.trigger("removeLayerView",this)):(this.trigger("removeLayerView",this),cdb.geo.MapView.prototype._removeLayer.call(this,a)):cdb.log.info("removing non existing layer")},setActiveLayer:function(a){this.activeLayerModel=a,this._setInteraction()},disableInteraction:function(){this.groupLayer&&this.groupLayer._clearInteraction()},enableInteraction:function(){this._setInteraction()},_setInteraction:function(){if(this.groupLayer&&this.activeLayerModel){this.groupLayer._clearInteraction();for(var a=this.map.layers.getLayerDefIndex(this.activeLayerModel),b=0;b<this.groupLayer.getLayerCount();++b)this.groupLayer.setInteraction(b,b==a)}},_updateLayerDefinition:function(a){if(!a)throw"layer must be a valid layer (not null)";if(this.groupLayer)if(0===this.map.layers.getLayersByType("CartoDB").length)this.groupLayer.remove(),this.groupLayer=null;else{var b=this.map.layers.getLayerDef();this.groupLayer.setLayerDefinition(b),this._setInteraction()}},_routeErrors:function(a){var b=/style(\d+)/,c=/layer(\d+):/i,d=/PSQL error/i,e=/syntax error/i,f=/"the_geom_webmercator" does not exist/i,g=/Error:/i,h=this.map.layers.where({visible:!0,type:"CartoDB"});for(var i in a){var j=a[i];if(j&&j.length){var k=b.exec(j);if(k){var l=parseInt(k[1],10);h[l].trigger("parseError",[j])}else{var k=c.exec(j);if(k){var l=parseInt(k[1],10);f.exec(j)?(j=_t("you should select the_geom_webmercator column"),h[l].trigger("sqlNoMercator",[j])):h[l].trigger("sqlParseError",[j])}else if(d.exec(j)||e.exec(j)||g.exec(j)){var m="sqlError";f.exec(j)&&(m="sqlNoMercator",j=_t("you should select the_geom_webmercator column")),_.each(h,function(a){a.trigger(m,j)})}else _.each(h,function(a){a.trigger("error",j)})}}}},_routeSignal:function(a){var b=this;return function(){var c=b.map.layers.where({visible:!0,type:"CartoDB"}),d=[a].concat(arguments);_.each(c,function(a){a.trigger.apply(a,d)})}},_addLayer:function(b,c,d){if("CartoDB"===b.get("type")){if(this.groupLayer)this.layers[b.cid]=this.groupLayer,this._updateLayerDefinition(b),this.trigger("newLayerView",this.groupLayer,b,this);else{var e=new cdb.geo.CartoDBGroupLayer(_.extend(b.toLayerGroup(),{user_name:this.options.user.get("username"),maps_api_template:cdb.config.get("maps_api_template"),no_cdn:!1,force_cors:!0})),f=a.prototype._addLayer.call(this,e,c,_.extend({},d,{silent:!0}));delete this.layers[e.cid],this.layers[b.cid]=f,this.groupLayer=f,e.bind("error",this._routeErrors,this),e.bind("tileOk",this._routeSignal("tileOk"),this),this.trigger("newLayerView",f,b,this)}b.bind("change:tile_style change:query change:query_wrapper change:interactivity change:visible",this._updateLayerDefinition,this),this._addLayerToMap(this.groupLayer),delete this.layers[this.groupLayer.model.cid]}else a.prototype._addLayer.call(this,b,c,d)}}}window.Modernizr=function(a,b,c){function d(a){o.cssText=a}function e(a,b){return typeof a===b}var f,g,h,i="2.5.3",j={},k=!0,l=b.documentElement,m="modernizr",n=b.createElement(m),o=n.style,p=({}.toString,{}),q=[],r=q.slice,s={}.hasOwnProperty;h=e(s,"undefined")||e(s.call,"undefined")?function(a,b){return b in a&&e(a.constructor.prototype[b],"undefined")}:function(a,b){return s.call(a,b)},Function.prototype.bind||(Function.prototype.bind=function(a){var b=this;if("function"!=typeof b)throw new TypeError;var c=r.call(arguments,1),d=function(){if(this instanceof d){var e=function(){};e.prototype=b.prototype;var f=new e,g=b.apply(f,c.concat(r.call(arguments)));return Object(g)===g?g:f}return b.apply(a,c.concat(r.call(arguments)))};return d});for(var t in p)h(p,t)&&(g=t.toLowerCase(),j[g]=p[t](),q.push((j[g]?"":"no-")+g));return d(""),n=f=null,function(a,b){function c(a,b){var c=a.createElement("p"),d=a.getElementsByTagName("head")[0]||a.documentElement;return c.innerHTML="x<style>"+b+"</style>",d.insertBefore(c.lastChild,d.firstChild)}function d(){var a=k.elements;return"string"==typeof a?a.split(" "):a}function e(a){var b={},c=a.createElement,e=a.createDocumentFragment,f=e();a.createElement=function(a){var d=(b[a]||(b[a]=c(a))).cloneNode();return k.shivMethods&&d.canHaveChildren&&!j.test(a)?f.appendChild(d):d},a.createDocumentFragment=Function("h,f","return function(){var n=f.cloneNode(),c=n.createElement;h.shivMethods&&("+d().join().replace(/\w+/g,function(a){return b[a]=c(a),f.createElement(a),'c("'+a+'")'})+");return n}")(k,f)}function f(a){var b;return a.documentShived?a:(k.shivCSS&&!g&&(b=!!c(a,"article,aside,details,figcaption,figure,footer,header,hgroup,nav,section{display:block}audio{display:none}canvas,video{display:inline-block;*display:inline;*zoom:1}[hidden]{display:none}audio[controls]{display:inline-block;*display:inline;*zoom:1}mark{background:#FF0;color:#000}")),h||(b=!e(a)),b&&(a.documentShived=b),a)}var g,h,i=a.html5||{},j=/^<|^(?:button|form|map|select|textarea)$/i;!function(){var a=b.createElement("a");a.innerHTML="<xyz></xyz>",g="hidden"in a,h=1==a.childNodes.length||function(){try{b.createElement("a")}catch(a){return!0}var a=b.createDocumentFragment();return"undefined"==typeof a.cloneNode||"undefined"==typeof a.createDocumentFragment||"undefined"==typeof a.createElement}()}();var k={elements:i.elements||"abbr article aside audio bdi canvas data datalist details figcaption figure footer header hgroup mark meter nav output progress section summary time video",shivCSS:i.shivCSS!==!1,shivMethods:i.shivMethods!==!1,type:"default",shivDocument:f};a.html5=k,f(b)}(this,b),j._version=i,l.className=l.className.replace(/(^|\s)no-js(\s|$)/,"$1$2")+(k?" js "+q.join(" "):""),j}(this,this.document),function(a,b,c){function d(a){return"[object Function]"==q.call(a)}function e(a){return"string"==typeof a}function f(){}function g(a){return!a||"loaded"==a||"complete"==a||"uninitialized"==a}function h(){var a=r.shift();s=1,a?a.t?o(function(){("c"==a.t?m.injectCss:m.injectJs)(a.s,0,a.a,a.x,a.e,1)},0):(a(),h()):s=0}function i(a,c,d,e,f,i,j){function k(b){if(!n&&g(l.readyState)&&(t.r=n=1,!s&&h(),l.onload=l.onreadystatechange=null,b)){"img"!=a&&o(function(){v.removeChild(l)},50);for(var d in A[c])A[c].hasOwnProperty(d)&&A[c][d].onload()}}var j=j||m.errorTimeout,l={},n=0,q=0,t={t:d,s:c,e:f,a:i,x:j};1===A[c]&&(q=1,A[c]=[],l=b.createElement(a)),"object"==a?l.data=c:(l.src=c,l.type=a),l.width=l.height="0",l.onerror=l.onload=l.onreadystatechange=function(){k.call(this,q)},r.splice(e,0,t),"img"!=a&&(q||2===A[c]?(v.insertBefore(l,u?null:p),o(k,j)):A[c].push(l))}function j(a,b,c,d,f){return s=0,b=b||"j",e(a)?i("c"==b?x:w,a,b,this.i++,c,d,f):(r.splice(this.i++,0,a),1==r.length&&h()),this}function k(){var a=m;return a.loader={load:j,i:0},a}var l,m,n=b.documentElement,o=a.setTimeout,p=b.getElementsByTagName("script")[0],q={}.toString,r=[],s=0,t="MozAppearance"in n.style,u=t&&!!b.createRange().compareNode,v=u?n:p.parentNode,n=a.opera&&"[object Opera]"==q.call(a.opera),n=!!b.attachEvent&&!n,w=t?"object":n?"script":"img",x=n?"script":w,y=Array.isArray||function(a){return"[object Array]"==q.call(a)},z=[],A={},B={timeout:function(a,b){return b.length&&(a.timeout=b[0]),a}};m=function(a){function b(a){var b,c,d,a=a.split("!"),e=z.length,f=a.pop(),g=a.length,f={url:f,origUrl:f,prefixes:a};for(c=0;c<g;c++)d=a[c].split("="),(b=B[d.shift()])&&(f=b(f,d));for(c=0;c<e;c++)f=z[c](f);return f}function g(a,e,f,g,i){var j=b(a),l=j.autoCallback;j.url.split(".").pop().split("?").shift(),j.bypass||(e&&(e=d(e)?e:e[a]||e[g]||e[a.split("/").pop().split("?")[0]]||h),j.instead?j.instead(a,e,f,g,i):(A[j.url]?j.noexec=!0:A[j.url]=1,f.load(j.url,j.forceCSS||!j.forceJS&&"css"==j.url.split(".").pop().split("?").shift()?"c":c,j.noexec,j.attrs,j.timeout),(d(e)||d(l))&&f.load(function(){k(),e&&e(j.origUrl,i,g),l&&l(j.origUrl,i,g),A[j.url]=2})))}function i(a,b){function c(a,c){if(a){if(e(a))c||(l=function(){var a=[].slice.call(arguments);m.apply(this,a),n()}),g(a,l,b,0,j);else if(Object(a)===a)for(i in h=function(){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c}(),a)a.hasOwnProperty(i)&&(!c&&!--h&&(d(l)?l=function(){var a=[].slice.call(arguments);m.apply(this,a),n()}:l[i]=function(a){return function(){var b=[].slice.call(arguments);a&&a.apply(this,b),n()}}(m[i])),g(a[i],l,b,i,j))}else!c&&n()}var h,i,j=!!a.test,k=a.load||a.both,l=a.callback||f,m=l,n=a.complete||f;c(j?a.yep:a.nope,!!k),k&&c(k)}var j,l,n=this.yepnope.loader;if(e(a))g(a,0,n,0);else if(y(a))for(j=0;j<a.length;j++)l=a[j],e(l)?g(l,0,n,0):y(l)?m(l):Object(l)===l&&i(l,n);else Object(a)===a&&i(a,n)},m.addPrefix=function(a,b){B[a]=b},m.addFilter=function(a){z.push(a)},m.errorTimeout=1e4,null==b.readyState&&b.addEventListener&&(b.readyState="loading",b.addEventListener("DOMContentLoaded",l=function(){b.removeEventListener("DOMContentLoaded",l,0),b.readyState="complete"},0)),a.yepnope=k(),a.yepnope.executeStack=h,a.yepnope.injectJs=function(a,c,d,e,i,j){var k,l,n=b.createElement("script"),e=e||m.errorTimeout;n.src=a;for(l in d)n.setAttribute(l,d[l]);c=j?h:c||f,n.onreadystatechange=n.onload=function(){!k&&g(n.readyState)&&(k=1,c(),n.onload=n.onreadystatechange=null)},o(function(){k||(k=1,c(1))},e),i?n.onload():p.parentNode.insertBefore(n,p)},a.yepnope.injectCss=function(a,c,d,e,g,i){var j,e=b.createElement("link"),c=i?h:c||f;e.href=a,e.rel="stylesheet",e.type="text/css";for(j in d)e.setAttribute(j,d[j]);g||(p.parentNode.insertBefore(e,p),o(c,0))}}(this,document),Modernizr.load=function(){yepnope.apply(window,[].slice.call(arguments,0))},function(a){function b(a,b){return"function"==typeof a?a.call(b):a}function c(a){for(;a=a.parentNode;)if(a==document)return!0;return!1}function d(b,c){this.$element=a(b),this.options=c,this.enabled=!0,this.fixTitle()}var e=6;d.prototype={show:function(){var c=this.getTitle();if(c&&this.enabled){var d=this.tip();d.find(".tipsy-inner")[this.options.html?"html":"text"](c),d[0].className="tipsy",d.remove().css({top:0,left:0,visibility:"hidden",display:"block"}).prependTo(document.body),this.options.className&&d.addClass(b(this.options.className,this.$element[0]));var f,g=a.extend({},this.$element.offset(),{width:this.$element[0].getBoundingClientRect().width,height:this.$element[0].getBoundingClientRect().height}),h=d[0].offsetWidth,i=d[0].offsetHeight,j=b(this.options.gravity,this.$element[0]);switch(j.charAt(0)){case"n":f={top:g.top+g.height+this.options.offset,left:g.left+g.width/2-h/2},mo={top:parseInt(g.top+g.height+this.options.offset+e),opacity:this.options.opacity};break;case"s":f={top:g.top-i-this.options.offset,left:g.left+g.width/2-h/2},mo={top:parseInt(g.top-i-this.options.offset-e),opacity:this.options.opacity};break;case"e":f={top:g.top+g.height/2-i/2,left:g.left-h-this.options.offset},mo={left:parseInt(g.left-h-this.options.offset-e),opacity:this.options.opacity};break;case"w":f={top:g.top+g.height/2-i/2,left:g.left+g.width+this.options.offset},mo={left:parseInt(g.left+g.width+this.options.offset+e),opacity:this.options.opacity}}2==j.length&&("w"==j.charAt(1)?f.left=g.left+g.width/2-15:f.left=g.left+g.width/2-h+15),d.css(f).addClass("tipsy-"+j),d.find(".tipsy-arrow")[0].className="tipsy-arrow tipsy-arrow-"+j.charAt(0),this.options.fade?d.stop().css({opacity:0,display:"block",visibility:"visible"}).animate(mo,200):d.css({visibility:"visible",opacity:this.options.opacity})}},hide:function(){switch(gravity=b(this.options.gravity,this.$element[0]),gravity.charAt(0)){case"n":mo={top:parseInt(this.tip().css("top"))+e,opacity:0};break;case"s":mo={top:parseInt(this.tip().css("top"))-e,opacity:0};break;case"e":mo={left:parseInt(this.tip().css("left"))-e,opacity:0};break;case"w":mo={left:parseInt(this.tip().css("left"))+e,opacity:0}}this.options.fade?this.tip().stop().animate(mo,200,function(){a(this).remove()}):this.tip().remove()},fixTitle:function(){var a=this.$element;(a.attr("title")||"string"!=typeof a.attr("original-title"))&&a.attr("original-title",a.attr("title")||"").removeAttr("title")},getTitle:function(){var a,b=this.$element,c=this.options;this.fixTitle();var a,c=this.options;return"string"==typeof c.title?a=b.attr("title"==c.title?"original-title":c.title):"function"==typeof c.title&&(a=c.title.call(b[0])),a=(""+a).replace(/(^\s*|\s*$)/,""),a||c.fallback},tip:function(){return this.$tip||(this.$tip=a('<div class="tipsy"></div>').html('<div class="tipsy-arrow"></div><div class="tipsy-inner"></div>'),this.$tip.data("tipsy-pointee",this.$element[0])),this.$tip},validate:function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},remove:function(){this.enabled=!1,this.$tip&&this.$tip.remove()},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},toggleEnabled:function(){this.enabled=!this.enabled}},a.fn.tipsy=function(b){function c(c){var e=a.data(c,"tipsy");return e||(e=new d(c,a.fn.tipsy.elementOptions(c,b)),a.data(c,"tipsy",e)),e}function e(){var a=c(this);a.hoverState="in",0==b.delayIn?a.show():(a.fixTitle(),setTimeout(function(){"in"==a.hoverState&&a.show()},b.delayIn))}function f(){var a=c(this);a.hoverState="out",0==b.delayOut?a.hide():setTimeout(function(){"out"==a.hoverState&&a.hide()},b.delayOut)}if(b===!0)return this.data("tipsy");if("string"==typeof b){var g=this.data("tipsy");return g&&g[b](),this}if(b=a.extend({},a.fn.tipsy.defaults,b),b.live||this.each(function(){c(this)}),"manual"!=b.trigger){var h=b.live?"live":"bind",i="hover"==b.trigger?"mouseenter":"focus",j="hover"==b.trigger?"mouseleave":"blur";this[h](i,e)[h](j,f)}return this},a.fn.tipsy.defaults={className:null,delayIn:0,delayOut:0,fade:!1,fallback:"",gravity:"n",html:!1,live:!1,offset:0,opacity:.8,title:"title",trigger:"hover"},a.fn.tipsy.revalidate=function(){a(".tipsy").each(function(){var b=a.data(this,"tipsy-pointee");b&&c(b)||a(this).remove()})},a.fn.tipsy.elementOptions=function(b,c){return a.metadata?a.extend({},c,a(b).metadata()):c},a.fn.tipsy.autoNS=function(){return a(this).offset().top>a(document).scrollTop()+a(window).height()/2?"s":"n"},a.fn.tipsy.autoWE=function(){return a(this).offset().left>a(document).scrollLeft()+a(window).width()/2?"e":"w"},a.fn.tipsy.autoBounds=function(b,c){return function(){var d={ns:c[0],ew:c.length>1&&c[1]},e=a(document).scrollTop()+b,f=a(document).scrollLeft()+b,g=a(this);return g.offset().top<e&&(d.ns="n"),g.offset().left<f&&(d.ew="w"),a(window).width()+a(document).scrollLeft()-g.offset().left<b&&(d.ew="e"),a(window).height()+a(document).scrollTop()-g.offset().top<b&&(d.ns="s"),d.ns+(d.ew?d.ew:"")}}}(jQuery),function(a){"undefined"==typeof a.fn.each2&&a.fn.extend({each2:function(b){for(var c=a([0]),d=-1,e=this.length;++d<e&&(c.context=c[0]=this[d])&&b.call(c[0],d,c)!==!1;);return this}})}(jQuery),function(a,b){"use strict";function c(a,b){var c,d=0,e=b.length;if("undefined"==typeof a)return-1;if(a.constructor===String){for(;d<e;d+=1)if(0===a.localeCompare(b[d]))return d}else for(;d<e;d+=1)if(c=b[d],c.constructor===String){if(0===c.localeCompare(a))return d}else if(c===a)return d;return-1}function d(a,c){return a===c||a!==b&&c!==b&&(null!==a&&null!==c&&(a.constructor===String?0===a.localeCompare(c):c.constructor===String&&0===c.localeCompare(a)))}function e(b,c){var d,e,f;if(null===b||b.length<1)return[];for(d=b.split(c),e=0,f=d.length;e<f;e+=1)d[e]=a.trim(d[e]);return d}function f(a){return a.outerWidth(!1)-a.width()}function g(c){var d="keyup-change-value";c.bind("keydown",function(){a.data(c,d)===b&&a.data(c,d,c.val())}),c.bind("keyup",function(){var e=a.data(c,d);e!==b&&c.val()!==e&&(a.removeData(c,d),c.trigger("keyup-change"))})}function h(c){c.bind("mousemove",function(c){var d=D;d!==b&&d.x===c.pageX&&d.y===c.pageY||a(c.target).trigger("mousemove-filtered",c)})}function i(a,c,d){d=d||b;var e;return function(){var b=arguments;window.clearTimeout(e),e=window.setTimeout(function(){c.apply(d,b)},a)}}function j(a){var b,c=!1;return function(){return c===!1&&(b=a(),c=!0),b}}function k(a,b){var d=i(a,function(a){b.trigger("scroll-debounced",a)});b.bind("scroll",function(a){c(a.target,b.get())>=0&&d(a)})}function l(a){a.preventDefault(),a.stopPropagation()}function m(a){a.preventDefault(),a.stopImmediatePropagation()}function n(b){if(!C){var c=b[0].currentStyle||window.getComputedStyle(b[0],null);C=a("<div></div>").css({position:"absolute",left:"-10000px",top:"-10000px",display:"none",fontSize:c.fontSize,fontFamily:c.fontFamily,fontStyle:c.fontStyle,fontWeight:c.fontWeight,letterSpacing:c.letterSpacing,textTransform:c.textTransform,whiteSpace:"nowrap"}),a("body").append(C)}return C.text(b.val()),C.width()}function o(a,b,c){var d=a.toUpperCase().indexOf(b.toUpperCase()),e=b.length;return d<0?void c.push(a):(c.push(a.substring(0,d)),c.push("<span class='select2-match'>"),c.push(a.substring(d,d+e)),c.push("</span>"),void c.push(a.substring(d+e,a.length)))}function p(b){var c,d=0,e=null,f=b.quietMillis||100;return function(g){window.clearTimeout(c),c=window.setTimeout(function(){d+=1;var c=d,f=b.data,h=b.transport||a.ajax,i=b.traditional||!1,j=b.type||"GET";f=f.call(this,g.term,g.page,g.context),null!==e&&e.abort(),e=h.call(null,{url:b.url,dataType:b.dataType,data:f,type:j,traditional:i,success:function(a){if(!(c<d)){var e=b.results(a,g.page);g.callback(e)}}})},f)}}function q(b){var c,d=b,e=function(a){return""+a.text};return a.isArray(d)||(e=d.text,a.isFunction(e)||(c=d.text,e=function(a){return a[c]}),d=d.results),function(b){var c,f=b.term,g={results:[]};return""===f?void b.callback({results:d}):(c=function(d,g){var h,i;if(d=d[0],d.children){h={};for(i in d)d.hasOwnProperty(i)&&(h[i]=d[i]);h.children=[],a(d.children).each2(function(a,b){c(b,h.children)}),(h.children.length||b.matcher(f,e(h)))&&g.push(h)}else b.matcher(f,e(d))&&g.push(d)},a(d).each2(function(a,b){c(b,g.results)}),void b.callback(g))}}function r(c){return a.isFunction(c)?c:function(d){var e=d.term,f={results:[]};a(c).each(function(){var a=this.text!==b,c=a?this.text:this;(""===e||d.matcher(e,c))&&f.results.push(a?this:{id:this,text:this})}),d.callback(f)}}function s(b,c){if(a.isFunction(b))return!0;if(!b)return!1;throw new Error("formatterName must be a function or a falsy value")}function t(b){return a.isFunction(b)?b():b}function u(b){var c=0;return a.each(b,function(a,b){b.children?c+=u(b.children):c++}),c}function v(a,c,e,f){var g,h,i,j,k,l=a,m=!1;if(!f.createSearchChoice||!f.tokenSeparators||f.tokenSeparators.length<1)return b;for(;;){for(h=-1,i=0,j=f.tokenSeparators.length;i<j&&(k=f.tokenSeparators[i],h=a.indexOf(k),!(h>=0));i++);if(h<0)break;if(g=a.substring(0,h),a=a.substring(h+k.length),g.length>0&&(g=f.createSearchChoice(g,c),g!==b&&null!==g&&f.id(g)!==b&&null!==f.id(g))){for(m=!1,i=0,j=c.length;i<j;i++)if(d(f.id(g),f.id(c[i]))){m=!0;break}m||e(g)}}return 0!=l.localeCompare(a)?a:void 0}function w(b,c){var d=function(){};return d.prototype=new b,d.prototype.constructor=d,d.prototype.parent=b.prototype,d.prototype=a.extend(d.prototype,c),d}if(window.Select2===b){var x,y,z,A,B,C,D,E;x={TAB:9,ENTER:13,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,SHIFT:16,CTRL:17,ALT:18,PAGE_UP:33,PAGE_DOWN:34,HOME:36,END:35,BACKSPACE:8,DELETE:46,isArrow:function(a){switch(a=a.which?a.which:a){case x.LEFT:case x.RIGHT:case x.UP:case x.DOWN:return!0}return!1},isControl:function(a){var b=a.which;switch(b){case x.SHIFT:case x.CTRL:case x.ALT:return!0}return!!a.metaKey},isFunctionKey:function(a){return a=a.which?a.which:a,a>=112&&a<=123}},E=a(document),B=function(){var a=1;return function(){return a++}}(),E.bind("mousemove",function(a){D={x:a.pageX,y:a.pageY}}),E.ready(function(){E.bind("mousedown touchend",function(c){var d,e=a(c.target).closest("div.select2-container").get(0);e?E.find("div.select2-container-active").each(function(){this!==e&&a(this).data("select2").blur()}):(e=a(c.target).closest("div.select2-drop").get(0),E.find("div.select2-drop-active").each(function(){this!==e&&a(this).data("select2").blur()})),e=a(c.target),d=e.attr("for"),"LABEL"===c.target.tagName&&d&&d.length>0&&(d=d.replace(/([\[\].])/g,"\\$1"),e=a("#"+d),e=e.data("select2"),e!==b&&(e.focus(),c.preventDefault()))})}),y=w(Object,{bind:function(a){var b=this;return function(){a.apply(b,arguments)}},init:function(c){var d,e,f,i=".select2-results";if(this.opts=c=this.prepareOpts(c),this.id=c.id,c.element.data("select2")!==b&&null!==c.element.data("select2")&&this.destroy(),this.enabled=!0,this.container=this.createContainer(),this.containerId="s2id_"+(c.element.attr("id")||"autogen"+B()),this.containerSelector="#"+this.containerId.replace(/([;&,\.\+\*\~':"\!\^#$%@\[\]\(\)=>\|])/g,"\\$1"),this.container.attr("id",this.containerId),this.body=j(function(){return c.element.closest("body")}),c.element.attr("class")!==b&&this.container.addClass(c.element.attr("class").replace(/validate\[[\S ]+] ?/,"")),this.container.css(t(c.containerCss)),this.container.addClass(t(c.containerCssClass)),this.opts.element.data("select2",this).hide().before(this.container),this.container.data("select2",this),this.dropdown=this.container.find(".select2-drop"),this.dropdown.addClass(t(c.dropdownCssClass)),this.dropdown.data("select2",this),this.results=d=this.container.find(i),this.search=e=this.container.find("input.select2-input"),this.free_text=f=this.container.find("input.select2-input-free"),e.attr("tabIndex",this.opts.element.attr("tabIndex")),this.resultsPage=0,this.context=null,this.initContainer(),this.initContainerWidth(),h(this.results),this.dropdown.delegate(i,"mousemove-filtered",this.bind(this.highlightUnderEvent)),k(80,this.results),this.dropdown.delegate(i,"scroll-debounced",this.bind(this.loadMoreIfNeeded)),a.fn.mousewheel&&d.mousewheel(function(a,b,c,e){var f=d.scrollTop();e>0&&f-e<=0?(d.scrollTop(0),l(a)):e<0&&d.get(0).scrollHeight-d.scrollTop()+e<=d.height()&&(d.scrollTop(d.get(0).scrollHeight-d.height()),l(a))}),g(e),e.bind("keyup-change",this.bind(this.updateResults)),e.bind("focus",function(){e.addClass("select2-focused")," "===e.val()&&e.val("")}),e.bind("blur",function(){e.removeClass("select2-focused")}),this.dropdown.delegate(i,"mouseup",this.bind(function(b){a(b.target).closest(".select2-result-selectable:not(.select2-disabled)").length>0?(this.highlightUnderEvent(b),this.selectHighlighted(b)):this.focusSearch(),l(b)})),this.dropdown.bind("click mouseup mousedown",function(a){a.stopPropagation()}),a.isFunction(this.opts.initSelection)&&(this.initSelection(),this.monitorSource()),(c.element.is(":disabled")||c.element.is("[readonly='readonly']"))&&this.disable(),a(this.container).hasClass("color_ramp"))try{for(var m=a(this.container).find(".select2-choice").text().replace(/ /g,""),n=a(this.container).attr("class").match(/(\d)_buckets/)[1],o="<ul>",p=cdb.admin.color_ramps[m][n],q=0,r=p.length;q<r;q++){var m=p[q];o+="<li style='background:"+m+";'></li>"}o+="</ul>",a(this.container).find(".select2-choice").append(o)}catch(a){cdb.log.info("Failing Select plugin when tries to generate a color ramp dropdown")}},destroy:function(){var a=this.opts.element.data("select2");a!==b&&(a.container.remove(),a.dropdown.remove(),a.opts.element.removeData("select2").unbind(".select2").show())},prepareOpts:function(c){var f,g,h,i;if(f=c.element,"select"===f.get(0).tagName.toLowerCase()&&(this.select=g=c.element),g&&a.each(["id","multiple","ajax","query","createSearchChoice","initSelection","data","tags"],function(){if(this in c)throw new Error("Option '"+this+"' is not allowed for Select2 when attached to a <select> element.")}),c=a.extend({},{populateResults:function(d,e,f){var g,h=this.opts.id,i=this;(g=function(d,e,j){var k,l,m,n,o,p,q,r,s,t;for(k=0,l=d.length;k<l;k+=1){if(m=d[k],n=a(m.element).is(":disabled"),o=!n&&h(m)!==b,p=m.children&&m.children.length>0,q=a("<li></li>"),q.addClass("select2-results-dept-"+j),q.addClass("select2-result"),q.addClass(o?"select2-result-selectable":"select2-result-unselectable"),p&&q.addClass("select2-result-with-children"),q.addClass(i.opts.formatResultCssClass(m)),r=a("<div></div>"),!o&&a(m.element).data("message")){var u=a(m.element).data("message");q.tipsy({fade:!0,gravity:"s",offset:-10,title:function(){return u}})}r.addClass("select2-result-label "+(v?m.text:"")),t=c.formatResult(m,r,f),t!==b&&r.html(i.opts.escapeMarkup(t)),q.append(r),p&&(s=a("<ul></ul>"),s.addClass("select2-result-sub"),g(m.children,s,j+1),q.append(s));var v=a(e.prevObject).hasClass("color_ramp");if(v)try{r.html("");for(var w=m.text,x=a(e.prevObject).attr("class").match(/(\d)_buckets/)[1],y="<table><tr>",z=cdb.admin.color_ramps[w][x],A=0,B=z.length;A<B;A++){var w=z[A];y+="<td class='color' style='background:"+w+";'></td>"}y+="</tr></table>",r.append(y)}catch(a){cdb.log.info("Failing Select plugin when tries to generate a color ramp dropdown")}q.data("select2-data",m),e.append(q)}})(e,d,0)}},a.fn.select2.defaults,c),"function"!=typeof c.id&&(h=c.id,c.id=function(a){return a[h]}),g?(c.query=this.bind(function(c){var d,e,g,h={results:[],more:!1},i=c.term;g=function(a,b){var d;a.is("option")?c.matcher(i,a.text(),a)&&b.push({id:a.attr("value"),text:a.text(),element:a.get(),css:a.attr("class")}):a.is("optgroup")&&(d={text:a.attr("label"),children:[],element:a.get(),css:a.attr("class")},a.children().each2(function(a,b){g(b,d.children)}),d.children.length>0&&b.push(d))},d=f.children(),this.getPlaceholder()!==b&&d.length>0&&(e=d[0],""===a(e).text()&&(d=d.not(e))),d.each2(function(a,b){g(b,h.results)}),c.callback(h)}),c.id=function(a){return a.id},c.formatResultCssClass=function(a){return a.css}):"query"in c||("ajax"in c?(i=c.element.data("ajax-url"),i&&i.length>0&&(c.ajax.url=i),c.query=p(c.ajax)):"data"in c?c.query=q(c.data):"tags"in c&&(c.query=r(c.tags),c.createSearchChoice===b&&(c.createSearchChoice=function(a){return{id:a,text:a}}),c.initSelection=function(b,f){var g=[];a(e(b.val(),c.separator)).each(function(){var b=this,e=this,f=c.tags;a.isFunction(f)&&(f=f()),a(f).each(function(){if(d(this.id,b))return e=this.text,!1}),g.push({id:b,text:e})}),f(g)})),"function"!=typeof c.query)throw"query function not defined for Select2 "+c.element.attr("id");return c},monitorSource:function(){this.opts.element.bind("change.select2",this.bind(function(a){this.opts.element.data("select2-change-triggered")!==!0&&this.initSelection()}))},triggerChange:function(b){b=b||{},b=a.extend({},b,{type:"change",val:this.val()}),this.opts.element.data("select2-change-triggered",!0),this.opts.element.trigger(b),this.opts.element.data("select2-change-triggered",!1),this.opts.element.click(),this.opts.blurOnChange&&this.opts.element.blur()},enable:function(){this.enabled||(this.enabled=!0,this.container.removeClass("select2-container-disabled"),this.opts.element.removeAttr("disabled"))},disable:function(){this.enabled&&(this.close(),this.enabled=!1,this.container.addClass("select2-container-disabled"),this.opts.element.attr("disabled","disabled"))},opened:function(){return this.container.hasClass("select2-dropdown-open")},positionDropdown:function(){var b,c,d,e=this.container.offset(),f=this.container.outerHeight(!1),g=this.container.outerWidth(!1),h=this.dropdown.outerHeight(!1),i=a(window).scrollLeft()+document.documentElement.clientWidth,j=a(window).scrollTop()+document.documentElement.clientHeight,k=e.top+f,l=e.left,m=k+h<=j,n=e.top-h>=this.body().scrollTop(),o=this.dropdown.outerWidth(!1),p=l+o<=i,q=this.dropdown.hasClass("select2-drop-above");"static"!==this.body().css("position")&&(b=this.body().offset(),k-=b.top,l-=b.left),q?(c=!0,!n&&m&&(c=!1)):(c=!1,!m&&n&&(c=!0)),p||(l=e.left+g-o),c?(k=e.top-h,this.container.addClass("select2-drop-above"),this.dropdown.addClass("select2-drop-above")):(this.container.removeClass("select2-drop-above"),this.dropdown.removeClass("select2-drop-above")),d=a.extend({top:k,left:l,width:g},t(this.opts.dropdownCss)),this.dropdown.css(d)},shouldOpen:function(){var b;return!this.opened()&&(b=a.Event("open"),this.opts.element.trigger(b),!b.isDefaultPrevented())},clearDropdownAlignmentPreference:function(){this.container.removeClass("select2-drop-above"),this.dropdown.removeClass("select2-drop-above")},open:function(){return!!this.shouldOpen()&&(window.setTimeout(this.bind(this.opening),1),!0)},opening:function(){var b=this.containerId,c=this.containerSelector,d="scroll."+b,e="resize."+b;this.container.parents().each(function(){a(this).bind(d,function(){var b=a(c);0==b.length&&a(this).unbind(d),b.select2("close")})}),window.setTimeout(function(){a(window).bind(e,function(){var b=a(c);0==b.length&&a(window).unbind(e),b.select2("close")}),a(window).bind(d,function(){var b=a(c);0==b.length&&a(window).unbind(d),b.select2("close")})},10),this.clearDropdownAlignmentPreference()," "===this.search.val()&&this.search.val(""),this.container.addClass("select2-dropdown-open").addClass("select2-container-active"),this.updateResults(!0),this.dropdown[0]!==this.body().children().last()[0]&&this.dropdown.detach().appendTo(this.body()),this.dropdown.show(),this.positionDropdown(),this.dropdown.addClass("select2-drop-active"),this.ensureHighlightVisible(),this.focusSearch()},close:function(){if(this.opened()){var b=this;this.container.parents().each(function(){a(this).unbind("scroll."+b.containerId)}),a(window).unbind("resize."+this.containerId),a(window).unbind("scroll."+this.containerId),this.clearDropdownAlignmentPreference(),this.dropdown.hide(),this.container.removeClass("select2-dropdown-open").removeClass("select2-container-active"),this.results.empty(),this.clearSearch(),this.opts.element.trigger(a.Event("close"))}},clearSearch:function(){},ensureHighlightVisible:function(){var b,c,d,e,f,g,h,i=this.results;if(c=this.highlight(),!(c<0)){if(0==c)return void i.scrollTop(0);b=i.find(".select2-result-selectable"),d=a(b[c]),e=d.offset().top+d.outerHeight(!0),c===b.length-1&&(h=i.find("li.select2-more-results"),h.length>0&&(e=h.offset().top+h.outerHeight(!0))),f=i.offset().top+i.outerHeight(!0),e>f&&i.scrollTop(i.scrollTop()+(e-f)),g=d.offset().top-i.offset().top,g<0&&"none"!=d.css("display")&&i.scrollTop(i.scrollTop()+g)}},moveHighlight:function(b){for(var c=this.results.find(".select2-result-selectable"),d=this.highlight();d>-1&&d<c.length;){d+=b;var e=a(c[d]);if(e.hasClass("select2-result-selectable")&&!e.hasClass("select2-disabled")){this.highlight(d);break}}},highlight:function(b){var d=this.results.find(".select2-result-selectable").not(".select2-disabled");return 0===arguments.length?c(d.filter(".select2-highlighted")[0],d.get()):(b>=d.length&&(b=d.length-1),b<0&&(b=0),d.removeClass("select2-highlighted"),a(d[b]).addClass("select2-highlighted"),void this.ensureHighlightVisible())},countSelectableResults:function(){return this.results.find(".select2-result-selectable").not(".select2-disabled").length},highlightUnderEvent:function(b){var c=a(b.target).closest(".select2-result-selectable");if(c.length>0&&!c.is(".select2-highlighted")){var d=this.results.find(".select2-result-selectable");this.highlight(d.index(c))}else 0==c.length&&this.results.find(".select2-highlighted").removeClass("select2-highlighted")},loadMoreIfNeeded:function(){var a,b=this.results,c=b.find("li.select2-more-results"),d=this.resultsPage+1,e=this,f=this.search.val(),g=this.context;0!==c.length&&(a=c.offset().top-b.offset().top-b.height(),a<=0&&(c.addClass("select2-active"),this.opts.query({term:f,page:d,context:g,matcher:this.opts.matcher,callback:this.bind(function(a){e.opened()&&(e.opts.populateResults.call(this,b,a.results,{term:f,page:d,context:g}),a.more===!0?(c.detach().appendTo(b).text(e.opts.formatLoadMore(d+1)),window.setTimeout(function(){e.loadMoreIfNeeded()},10)):c.remove(),e.positionDropdown(),e.resultsPage=d)})})))},tokenize:function(){},
updateResults:function(c){function e(){k.find(".select2-result").each(function(b,c){var d=a(c),e=d.data("tipsy");e&&d.tipsy("hide").unbind("mouseleave mouseenter")})}function f(){k.scrollTop(0),j.removeClass("select2-active"),m.positionDropdown()}function g(a){k.html(m.opts.escapeMarkup(a)),f()}var h,i,j=this.search,k=this.results,l=this.opts,m=this;if(c===!0||this.showSearchInput!==!1&&this.opened()){if(j.addClass("select2-active"),e(),l.maximumSelectionSize>=1&&(h=this.data(),a.isArray(h)&&h.length>=l.maximumSelectionSize&&s(l.formatSelectionTooBig,"formatSelectionTooBig")))return void g("<li class='select2-selection-limit'>"+l.formatSelectionTooBig(l.maximumSelectionSize)+"</li>");if(j.val().length<l.minimumInputLength)return void g(s(l.formatInputTooShort,"formatInputTooShort")?"<li class='select2-no-results'>"+l.formatInputTooShort(j.val(),l.minimumInputLength)+"</li>":"");l.formatSearching()&&g("<li class='select2-searching'>"+l.formatSearching()+"</li>"),i=this.tokenize(),i!=b&&null!=i&&j.val(i),this.resultsPage=1,l.query({term:j.val(),page:this.resultsPage,context:null,matcher:l.matcher,callback:this.bind(function(e){var h;if(this.opened()){if(this.context=e.context===b?null:e.context,this.opts.createSearchChoice&&""!==j.val()&&(h=this.opts.createSearchChoice.call(null,j.val(),e.results),h!==b&&null!==h&&m.id(h)!==b&&null!==m.id(h)&&0===a(e.results).filter(function(){return d(m.id(this),m.id(h))}).length&&e.results.unshift(h)),0===e.results.length&&s(l.formatNoMatches,"formatNoMatches"))return void g("<li class='select2-no-results'>"+l.formatNoMatches(j.val())+"</li>");k.empty(),m.opts.populateResults.call(this,k,e.results,{term:j.val(),page:this.resultsPage,context:null}),e.more===!0&&s(l.formatLoadMore,"formatLoadMore")&&(k.append("<li class='select2-more-results'>"+m.opts.escapeMarkup(l.formatLoadMore(this.resultsPage))+"</li>"),window.setTimeout(function(){m.loadMoreIfNeeded()},10)),this.postprocessResults(e,c),f()}})})}},cancel:function(){this.close()},blur:function(){this.close(),this.container.removeClass("select2-container-active"),this.dropdown.removeClass("select2-drop-active"),this.search[0]===document.activeElement&&this.search.blur(),this.clearSearch(),this.selection.find(".select2-search-choice-focus").removeClass("select2-search-choice-focus"),this.opts.element.triggerHandler("blur")},focusSearch:function(){this.showSearchInput&&(this.search.show(),this.search.focus(),window.setTimeout(this.bind(function(){this.search.show(),this.search.focus(),this.search.val(this.search.val())}),10))},selectHighlighted:function(){var a=this.highlight(),b=this.results.find(".select2-highlighted").not(".select2-disabled"),c=b.closest(".select2-result-selectable").data("select2-data");c&&(b.addClass("select2-disabled"),this.highlight(a),this.onSelect(c))},getPlaceholder:function(){return this.opts.element.attr("placeholder")||this.opts.element.attr("data-placeholder")||this.opts.element.data("placeholder")||this.opts.placeholder},initContainerWidth:function(){function c(){var c,d,e,f,g;if("off"===this.opts.width)return null;if("element"===this.opts.width)return 0===this.opts.element.outerWidth(!1)?"auto":this.opts.element.outerWidth(!1)+"px";if("copy"===this.opts.width||"resolve"===this.opts.width){if(c=this.opts.element.attr("style"),c!==b)for(d=c.split(";"),f=0,g=d.length;f<g;f+=1)if(e=d[f].replace(/\s/g,"").match(/width:(([-+]?([0-9]*\.)?[0-9]+)(px|em|ex|%|in|cm|mm|pt|pc))/),null!==e&&e.length>=1)return e[1];return"resolve"===this.opts.width?(c=this.opts.element.css("width"),c.indexOf("%")>0?c:0===this.opts.element.outerWidth(!1)?"auto":this.opts.element.outerWidth(!1)+"px"):null}return a.isFunction(this.opts.width)?this.opts.width():this.opts.width}var d=c.call(this);null!==d&&this.container.attr("style","width: "+d)}}),z=w(y,{createContainer:function(){var b=a("<div></div>",{class:"select2-container"}).html(["    <a href='javascript:void(0)' onclick='return false;' class='select2-choice'>","   <span></span><abbr class='select2-search-choice-close' style='display:none;'></abbr>","   <div><b></b></div>","</a>","    <div class='select2-drop select2-offscreen'>","   <div class='select2-search'>","       <input type='text' autocomplete='off' class='select2-input'/>","   </div>","   <ul class='select2-results'>","   </ul>","   <div class='select2-text'>","       <input type='text' placeholder='Free text input' class='select2-input-free'/>","       <i class='select2-icon select2-text-icon'></i>","   </div>","</div>"].join(""));return b},opening:function(){this.search.show(),this.parent.opening.apply(this,arguments),this.dropdown.removeClass("select2-offscreen")},close:function(){this.opened()&&(this.parent.close.apply(this,arguments),this.dropdown.removeAttr("style").addClass("select2-offscreen").insertAfter(this.selection).show())},focus:function(){this.close(),this.selection.focus()},isFocused:function(){return this.selection[0]===document.activeElement},cancel:function(){this.parent.cancel.apply(this,arguments),this.selection.focus()},initContainer:function(){var b,c=this.container,d=this.dropdown,e=!1;this.selection=b=c.find(".select2-choice"),this.search.bind("keydown",this.bind(function(a){if(this.enabled){if(a.which===x.PAGE_UP||a.which===x.PAGE_DOWN)return void l(a);if(this.opened())switch(a.which){case x.UP:case x.DOWN:return this.moveHighlight(a.which===x.UP?-1:1),void l(a);case x.TAB:case x.ENTER:return this.selectHighlighted(),void l(a);case x.ESC:return this.cancel(a),void l(a)}else{if(a.which===x.TAB||x.isControl(a)||x.isFunctionKey(a)||a.which===x.ESC)return;if(this.opts.openOnEnter===!1&&a.which===x.ENTER)return;if(this.open(),a.which===x.ENTER)return}}})),this.search.bind("focus",this.bind(function(){this.selection.attr("tabIndex","-1")})),this.search.bind("blur",this.bind(function(){this.opened()||this.container.removeClass("select2-container-active"),window.setTimeout(this.bind(function(){var a=this.opts.element.attr("tabIndex");a?this.selection.attr("tabIndex",a):this.selection.removeAttr("tabIndex")}),10)})),this.free_text.bind("keydown",this.bind(function(b){var c=a(b.target).val();if(this.enabled){if(b.which===x.PAGE_UP||b.which===x.PAGE_DOWN)return void l(b);if(this.opened())switch(b.which){case x.UP:case x.DOWN:return void l(b);case x.TAB:return;case x.ENTER:return this.onSelect({id:c,text:c}),void l(b);case x.ESC:return this.cancel(b),void l(b)}}})),b.delegate("abbr","mousedown",this.bind(function(a){this.enabled&&(this.clear(),m(a),this.close(),this.triggerChange(),this.selection.focus())})),b.bind("mousedown",this.bind(function(a){e=!0,this.opened()?(this.close(),this.selection.focus()):this.enabled&&this.open(),e=!1})),d.bind("mousedown",this.bind(function(){})),b.bind("focus",this.bind(function(){this.container.addClass("select2-container-active"),this.search.attr("tabIndex","-1")})),b.bind("blur",this.bind(function(){this.opened()||this.container.removeClass("select2-container-active"),window.setTimeout(this.bind(function(){this.search.attr("tabIndex",this.opts.element.attr("tabIndex"))}),10)})),b.bind("keydown",this.bind(function(a){if(this.enabled)return a.which==x.DOWN||a.which==x.UP||a.which==x.ENTER&&this.opts.openOnEnter?(this.open(),void l(a)):a.which==x.DELETE||a.which==x.BACKSPACE?(this.opts.allowClear&&this.clear(),void l(a)):void 0})),b.bind("keypress",this.bind(function(a){var b=String.fromCharCode(a.which);this.search.val(b),this.open()})),this.setPlaceholder(),this.search.bind("focus",this.bind(function(){this.container.addClass("select2-container-active")}))},clear:function(){this.opts.element.val(""),this.selection.find("span").empty(),this.selection.removeData("select2-data"),this.setPlaceholder()},initSelection:function(){if(""===this.opts.element.val()&&""===this.opts.element.text())this.close(),this.setPlaceholder();else{var a=this;this.opts.initSelection.call(null,this.opts.element,function(c){c!==b&&null!==c&&(a.updateSelection(c),a.close(),a.setPlaceholder())})}},prepareOpts:function(){var b=this.parent.prepareOpts.apply(this,arguments);return"select"===b.element.get(0).tagName.toLowerCase()&&(b.initSelection=function(b,c){var d=b.find(":selected");a.isFunction(c)&&c({id:d.attr("value"),text:d.text(),element:d})}),b},setPlaceholder:function(){var a=this.getPlaceholder(),c=this.selection.data("select2-data");if(""===this.opts.element.val()&&a!==b&&c&&!c.id&&!c.text){if(this.select&&""!==this.select.find("option:first").text())return;this.selection.find("span").html(this.opts.escapeMarkup(a)),this.selection.addClass("select2-default"),this.selection.find("abbr").hide()}},postprocessResults:function(b,c){var e=0,f=this,g=!0,h=!1;this.results.find(".select2-result-selectable").each2(function(a,b){if(d(f.id(b.data("select2-data")),f.opts.element.val()))return e=a,!1}),this.highlight(e),c===!0&&(g=this.showSearchInput=u(b.results)>=this.opts.minimumResultsForSearch,this.dropdown.find(".select2-search")[g?"removeClass":"addClass"]("select2-search-hidden"),h=this.showFreeTextInput=this.opts.freeText,this.dropdown.find(".select2-text")[h?"removeClass":"addClass"]("select2-search-hidden"),a(this.dropdown,this.container)[g?"addClass":"removeClass"]("select2-with-searchbox"))},onSelect:function(a){var b=this.opts.element.val();this.opts.element.val(this.id(a)),this.updateSelection(a),this.close(),this.selection.focus(),d(b,this.id(a))||this.triggerChange()},updateSelection:function(a){var c,d=this.selection.find("span");this.selection.data("select2-data",a),d.empty(),c=this.opts.formatSelection(a,d),c!==b&&d.append(this.opts.escapeMarkup(c)),this.selection.removeClass("select2-default"),this.opts.allowClear&&this.getPlaceholder()!==b&&this.selection.find("abbr").show()},val:function(){var a,c=null,d=this;if(0===arguments.length)return this.opts.element.val();if(a=arguments[0],this.select)this.select.val(a).find(":selected").each2(function(a,b){return c={id:b.attr("value"),text:b.text()},!1}),c.id||c.text||(c={id:a,text:a}),this.updateSelection(c),this.setPlaceholder();else{if(this.opts.initSelection===b)throw new Error("cannot call val() if initSelection() is not defined");if(!a)return void this.clear();this.opts.element.val(a),this.opts.initSelection(this.opts.element,function(a){d.opts.element.val(a?d.id(a):""),d.updateSelection(a),d.setPlaceholder()})}},clearSearch:function(){this.search.val("")},data:function(a){var c;return 0===arguments.length?(c=this.selection.data("select2-data"),c==b&&(c=null),c):void(a&&""!==a?(this.opts.element.val(a?this.id(a):""),this.updateSelection(a)):this.clear())}}),A=w(y,{createContainer:function(){var b=a("<div></div>",{class:"select2-container select2-container-multi"}).html(["    <ul class='select2-choices'>","  <li class='select2-search-field'>","    <input type='text' autocomplete='off' class='select2-input'>","  </li>","</ul>","<div class='select2-drop select2-drop-multi' style='display:none;'>","   <ul class='select2-results'>","   </ul>","</div>"].join(""));return b},prepareOpts:function(){var b=this.parent.prepareOpts.apply(this,arguments);return"select"===b.element.get(0).tagName.toLowerCase()&&(b.initSelection=function(b,c){var d=[];b.find(":selected").each2(function(a,b){d.push({id:b.attr("value"),text:b.text(),element:b})}),a.isFunction(c)&&c(d)}),b},initContainer:function(){var b,c=".select2-choices";this.searchContainer=this.container.find(".select2-search-field"),this.selection=b=this.container.find(c),this.search.bind("keydown",this.bind(function(a){if(this.enabled){if(a.which===x.BACKSPACE&&""===this.search.val()){this.close();var c,d=b.find(".select2-search-choice-focus");if(d.length>0)return this.unselect(d.first()),this.search.width(10),void l(a);c=b.find(".select2-search-choice:not(.select2-locked)"),c.length>0&&c.last().addClass("select2-search-choice-focus")}else b.find(".select2-search-choice-focus").removeClass("select2-search-choice-focus");if(this.opened())switch(a.which){case x.UP:case x.DOWN:return this.moveHighlight(a.which===x.UP?-1:1),void l(a);case x.ENTER:case x.TAB:return this.selectHighlighted(),void l(a);case x.ESC:return this.cancel(a),void l(a)}a.which===x.TAB||x.isControl(a)||x.isFunctionKey(a)||a.which===x.BACKSPACE||a.which===x.ESC||this.opts.openOnEnter===!1&&a.which===x.ENTER||(this.open(),a.which!==x.PAGE_UP&&a.which!==x.PAGE_DOWN||l(a))}})),this.search.bind("keyup",this.bind(this.resizeSearch)),this.search.bind("blur",this.bind(function(a){this.container.removeClass("select2-container-active"),this.search.removeClass("select2-focused"),this.clearSearch(),a.stopImmediatePropagation()})),this.container.delegate(c,"mousedown",this.bind(function(b){this.enabled&&(a(b.target).closest(".select2-search-choice").length>0||(this.clearPlaceholder(),this.open(),this.focusSearch(),b.preventDefault()))})),this.container.delegate(c,"focus",this.bind(function(){this.enabled&&(this.container.addClass("select2-container-active"),this.dropdown.addClass("select2-drop-active"),this.clearPlaceholder())})),this.clearSearch()},enable:function(){this.enabled||(this.parent.enable.apply(this,arguments),this.search.removeAttr("disabled"))},disable:function(){this.enabled&&(this.parent.disable.apply(this,arguments),this.search.attr("disabled",!0))},initSelection:function(){if(""===this.opts.element.val()&&""===this.opts.element.text()&&(this.updateSelection([]),this.close(),this.clearSearch()),this.select||""!==this.opts.element.val()){var a=this;this.opts.initSelection.call(null,this.opts.element,function(c){c!==b&&null!==c&&(a.updateSelection(c),a.close(),a.clearSearch())})}},clearSearch:function(){var a=this.getPlaceholder();a!==b&&0===this.getVal().length&&this.search.hasClass("select2-focused")===!1?(this.search.val(a).addClass("select2-default"),this.resizeSearch()):this.search.val(" ").width(10)},clearPlaceholder:function(){this.search.hasClass("select2-default")?this.search.val("").removeClass("select2-default"):" "===this.search.val()&&this.search.val("")},opening:function(){this.parent.opening.apply(this,arguments),this.clearPlaceholder(),this.resizeSearch(),this.focusSearch()},close:function(){this.opened()&&this.parent.close.apply(this,arguments)},focus:function(){this.close(),this.search.focus()},isFocused:function(){return this.search.hasClass("select2-focused")},updateSelection:function(b){var d=[],e=[],f=this;a(b).each(function(){c(f.id(this),d)<0&&(d.push(f.id(this)),e.push(this))}),b=e,this.selection.find(".select2-search-choice").remove(),a(b).each(function(){f.addSelectedChoice(this)}),f.postprocessResults()},tokenize:function(){var a=this.search.val();a=this.opts.tokenizer(a,this.data(),this.bind(this.onSelect),this.opts),null!=a&&a!=b&&(this.search.val(a),a.length>0&&this.open())},onSelect:function(a){this.addSelectedChoice(a),!this.select&&this.opts.closeOnSelect||this.postprocessResults(),this.opts.closeOnSelect?(this.close(),this.search.width(10)):this.countSelectableResults()>0?(this.search.width(10),this.resizeSearch(),this.positionDropdown()):this.close(),this.triggerChange({added:a}),this.focusSearch()},cancel:function(){this.close(),this.focusSearch()},addSelectedChoice:function(c){var d,e=!c.locked,f=a("<li class='select2-search-choice'>    <div></div>    <a href='#' onclick='return false;' class='select2-search-choice-close' tabindex='-1'></a></li>"),g=a("<li class='select2-search-choice select2-locked'><div></div></li>"),h=e?f:g,i=this.id(c),j=this.getVal();d=this.opts.formatSelection(c,h.find("div")),d!=b&&h.find("div").replaceWith("<div>"+this.opts.escapeMarkup(d)+"</div>"),e&&h.find(".select2-search-choice-close").bind("mousedown",l).bind("click dblclick",this.bind(function(b){this.enabled&&(a(b.target).closest(".select2-search-choice").fadeOut("fast",this.bind(function(){this.unselect(a(b.target)),this.selection.find(".select2-search-choice-focus").removeClass("select2-search-choice-focus"),this.close(),this.focusSearch()})).dequeue(),l(b))})).bind("focus",this.bind(function(){this.enabled&&(this.container.addClass("select2-container-active"),this.dropdown.addClass("select2-drop-active"))})),h.data("select2-data",c),h.insertBefore(this.searchContainer),j.push(i),this.setVal(j)},unselect:function(a){var b,d,e=this.getVal();if(a=a.closest(".select2-search-choice"),0===a.length)throw"Invalid argument: "+a+". Must be .select2-search-choice";b=a.data("select2-data"),d=c(this.id(b),e),d>=0&&(e.splice(d,1),this.setVal(e),this.select&&this.postprocessResults()),a.remove(),this.triggerChange({removed:b})},postprocessResults:function(){var a=this.getVal(),b=this.results.find(".select2-result-selectable"),d=this.results.find(".select2-result-with-children"),e=this;b.each2(function(b,d){var f=e.id(d.data("select2-data"));c(f,a)>=0?d.addClass("select2-disabled").removeClass("select2-result-selectable"):d.removeClass("select2-disabled").addClass("select2-result-selectable")}),d.each2(function(a,b){b.is(".select2-result-selectable")||0!=b.find(".select2-result-selectable").length?b.removeClass("select2-disabled"):b.addClass("select2-disabled")}),this.highlight()==-1&&b.each2(function(a,b){if(!b.hasClass("select2-disabled")&&b.hasClass("select2-result-selectable"))return e.highlight(0),!1})},resizeSearch:function(){var a,b,c,d,e,g=f(this.search);a=n(this.search)+10,b=this.search.offset().left,c=this.selection.width(),d=this.selection.offset().left,e=c-(b-d)-g,e<a&&(e=c-g),e<40&&(e=c-g),this.search.width(e)},getVal:function(){var a;return this.select?(a=this.select.val(),null===a?[]:a):(a=this.opts.element.val(),e(a,this.opts.separator))},setVal:function(b){var d;this.select?this.select.val(b):(d=[],a(b).each(function(){c(this,d)<0&&d.push(this)}),this.opts.element.val(0===d.length?"":d.join(this.opts.separator)))},val:function(){var c,d=[],e=this;if(0===arguments.length)return this.getVal();if(c=arguments[0],!c)return this.opts.element.val(""),this.updateSelection([]),void this.clearSearch();if(this.setVal(c),this.select)this.select.find(":selected").each(function(){d.push({id:a(this).attr("value"),text:a(this).text()})}),this.updateSelection(d);else{if(this.opts.initSelection===b)throw new Error("val() cannot be called if initSelection() is not defined");this.opts.initSelection(this.opts.element,function(b){var c=a(b).map(e.id);e.setVal(c),e.updateSelection(b),e.clearSearch()})}this.clearSearch()},onSortStart:function(){if(this.select)throw new Error("Sorting of elements is not supported when attached to <select>. Attach to <input type='hidden'/> instead.");this.search.width(0),this.searchContainer.hide()},onSortEnd:function(){var b=[],c=this;this.searchContainer.show(),this.searchContainer.appendTo(this.searchContainer.parent()),this.resizeSearch(),this.selection.find(".select2-search-choice").each(function(){b.push(c.opts.id(a(this).data("select2-data")))}),this.setVal(b),this.triggerChange()},data:function(b){var c,d=this;return 0===arguments.length?this.selection.find(".select2-search-choice").map(function(){return a(this).data("select2-data")}).get():(b||(b=[]),c=a.map(b,function(a){return d.opts.id(a)}),this.setVal(c),this.updateSelection(b),this.clearSearch(),void 0)}}),a.fn.select2=function(){var d,e,f,g,h=Array.prototype.slice.call(arguments,0),i=["val","destroy","opened","open","close","focus","isFocused","container","onSortStart","onSortEnd","enable","disable","positionDropdown","data"];return this.each(function(){if(0===h.length||"object"==typeof h[0])d=0===h.length?{}:a.extend({},h[0]),d.element=a(this),"select"===d.element.get(0).tagName.toLowerCase()?g=d.element.attr("multiple"):(g=d.multiple||!1,"tags"in d&&(d.multiple=g=!0)),e=g?new A:new z,e.init(d);else{if("string"!=typeof h[0])throw"Invalid arguments to select2 plugin: "+h;if(c(h[0],i)<0)throw"Unknown method: "+h[0];if(f=b,e=a(this).data("select2"),e===b)return;if(f="container"===h[0]?e.container:e[h[0]].apply(e,h.slice(1)),f!==b)return!1}}),f===b?this:f},a.fn.select2.defaults={width:"copy",closeOnSelect:!0,openOnEnter:!0,containerCss:{},dropdownCss:{},containerCssClass:"",dropdownCssClass:"",formatResult:function(a,b,c){var d=[];return o(a.text,c.term,d),d.join("")},formatSelection:function(a,c){return a?a.text:b},formatResultCssClass:function(a){return b},formatNoMatches:function(){return"No matches found"},formatInputTooShort:function(a,b){var c=b-a.length;return"Please enter "+c+" more character"+(1==c?"":"s")},formatSelectionTooBig:function(a){return"You can only select "+a+" item"+(1==a?"":"s")},formatLoadMore:function(a){return"Loading more results..."},formatSearching:function(){return"Searching..."},minimumResultsForSearch:0,minimumInputLength:0,maximumSelectionSize:0,id:function(a){return a.id},matcher:function(a,b){return b.toUpperCase().indexOf(a.toUpperCase())>=0},separator:",",tokenSeparators:[],tokenizer:v,escapeMarkup:function(a){return a&&"string"==typeof a?a.replace(/&/g,"&amp;"):a},blurOnChange:!1},window.Select2={query:{ajax:p,local:q,tags:r},util:{debounce:i,markMatch:o},class:{abstract:y,single:z,multi:A}}}}(jQuery),function(){cdb.admin.SQL=function(){var a=this.options&&this.options.user_data?this.options.user_data.username:window.user_data?window.user_data.username:window.user_name,b=this.options&&this.options.user_data?this.options.user_data.api_key:window.user_data?window.user_data.api_key:window.api_key;return new cartodb.SQL({user:a,api_key:b,sql_api_template:cdb.config.getSqlApiBaseUrl()})},cdb.admin.Column=cdb.core.Model.extend({idAttribute:"name",url:function(a){var b=cdb.config.urlVersion("column",a),c=this.table||this.collection.table;c||cdb.log.error("column has no table assigned");var d="/api/"+b+"/tables/"+c.get("name")+"/columns/";return this.isNew()?d:d+this.id},initialize:function(){if(this.table=this.get("table"),!this.table)throw"you should specify a table model";this.unset("table",{silent:!0})},toJSON:function(){var a=_.clone(this.attributes);return a._name&&(a.name=a._name,delete a._name),a}}),cdb.admin.CartoDBTableMetadata=cdb.ui.common.TableProperties.extend({currentLoading:0,sqlApiClass:cartodb.SQL,_TEXTS:{columnDeleted:"Your column has been deleted",columnDeleting:"Deleting your column",columnAdded:"Your column has been added",columnAdding:"Adding new column"},hiddenColumns:["the_geom","the_geom_webmercator","cartodb_georef_status","created_at","updated_at","cartodb_id"],initialize:function(){_.bindAll(this,"notice"),this.readOnly=!1,this.bind("change:schema",this._prepareSchema,this),this._prepareSchema(),this.sqlView=null,this.synchronization=new cdb.admin.TableSynchronization,this.synchronization.linkToTable(this),this.synchronization.bind("change:id",function(){this.trigger("change:isSync",this,this.synchronization.isSync())},this),this.get("no_data_fetch")&&(this.no_data_fetch=!0,delete this.attributes.no_data_fetch),this.data(),this.bind("error",function(a,b){this.error("",b)},this),this._data.bind("error",function(a,b){this.notice("error loading rows, check your SQL query","error",5e3)},this),this._data.bind("reset",function(){var a=this._data;this.set({schema:a.schemaFromData(this.get("schema")),geometry_types:a.getGeometryTypes()})},this),this.retrigger("change",this._data,"data:changed"),this.retrigger("saved",this._data,"data:saved"),this.bind("change:table_visualization",function(){this.permission=new cdb.admin.Permission(this.get("table_visualization").permission),this.trigger("change:permission",this,this.permission)},this),this.permission=new cdb.admin.Permission(this.get("permission"))},url:function(a){var b=cdb.config.urlVersion("table",a),c="/api/"+b+"/tables";return this.isNew()?c:c+"/"+this.id},parse:function(a,b){return a.name&&(a.id=a.name),a.stats_geometry_types=a.geometry_types,delete a.geometry_types,delete a.schema,a},notice:function(a,b,c){this.trigger("notice",a,b,c)},setReadOnly:function(a){var b=!1;this.readOnly!==a&&(b=!0),this.readOnly=a,b&&this.trigger("change:readOnly",this,a)},isReadOnly:function(){return this.readOnly||this.data().isReadOnly()||this.synchronization.isSync()},isSync:function(){return this.synchronization.isSync()},getUnqualifiedName:function(){var a=this.get("name");if(!a)return null;var b=a.split(".");return 2==b.length?b[1]:a},getUnquotedName:function(){var a=this.get("name");return a&&a.replace(/"/g,"")},sortSchema:function(){this.set("schema",cdb.admin.CartoDBTableMetadata.sortSchema(this.get("schema")))},error:function(a,b){var c=b&&b.responseText&&JSON.parse(b.responseText).errors[0];this.trigger("notice",a+": "+c,"error")},_prepareSchema:function(){var a=this;this._columnType={},_(this.get("schema")).each(function(b){a._columnType[b[0]]=b[1]}),this.isInSQLView()||a.set("original_schema",a.get("schema"))},columnNames:function(a){return a=a||"schema",_(this.get(a)).pluck(0)},containsColumn:function(a){return _.contains(this.columnNames(),a)},columnNamesByType:function(a,b){b=b||"schema";var c=_(this.get(b)).filter(function(b){return b[1]==a});return _(c).pluck(0)},statsGeomColumnTypes:function(a){return this.geomColumnTypes(this.get("stats_geometry_types"))},geomColumnTypes:function(a){var b=a||this.get("geometry_types"),c=[];if(!_.isArray(b))return[];var d={st_multipolygon:"polygon",st_polygon:"polygon",st_multilinestring:"line",st_linestring:"line",st_multipoint:"point",st_point:"point"};for(var e in b){var f=b[e];if(f){var g=d[f.toLowerCase()];g&&c.push(g)}}return _.uniq(c)},addGeomColumnType:function(a,b){if(a){var c=_.clone(this.get("geometry_types"))||[];_.contains(c,a)||(c.push(a),this.set({geometry_types:c},b))}},nonReservedColumnNames:function(){var a=this;return _.filter(this.columnNames(),function(b){return!a.isReservedColumn(b)})},columnTypes:function(){return _.clone(this._columnType)},_getColumn:function(a){if(void 0!==this._columnType[a]){var b=new cdb.admin.Column({table:this,name:a,type:this._columnType[a]});return b}},getColumnType:function(a,b){b=b||"schema";var c=_(this.get(b)).filter(function(b){return b[0]==a});if(c.length>0)return c[0][1]},addColumn:function(a,b,c){var d=this,e=new cdb.admin.Column({table:this,_name:a,type:b||"string"});this.notice(d._TEXTS.columnAdding,"load",0),e.save(null,{success:function(b,e){d.notice(d._TEXTS.columnAdded,"info"),d.trigger("columnAdd",a),d.data().fetch(),c&&c.success&&c.success(b,e)},error:function(a,b){d.error("error adding column",b),c&&c.error&&c.error(a)},wait:!0})},deleteColumn:function(a,b){var c=this,d=this._getColumn(a);void 0!==d&&(this.notice(c._TEXTS.columnDeleting,"load",0),d.destroy({success:function(){c.trigger("columnDelete",a),c.notice(c._TEXTS.columnDeleted,"info"),c.data().fetch(),b&&b.success&&b.success()},error:function(a,d){c.error("error deleting column",d),b&&b.error&&b.error()},wait:!0}))},renameColumn:function(a,b,c){if(a!=b){var d=this,e=this._getColumn(a),f=e.get("name");e.set({new_name:b,old_name:e.get("name")}),this.notice("renaming column","load",0),e.save(null,{success:function(a,e){d.notice("Column has been renamed","info"),d.trigger("columnRename",b,f),d.data().fetch(),c&&c.success&&c.success(a,e)},error:function(a,b){cdb.log.error("can't rename column"),d.error("error renaming column",b),c&&c.error&&c.error(a,b)},wait:!0})}},isTypeChangeAllowed:function(a,b){var c={number:["date"],boolean:["date"],date:["boolean"]},d=this._getColumn(a);if(!d)return!0;var e=d.get("type"),f=c[e]||[];return f=f.concat([e]),!_.contains(f,b)},isTypeChangeDestructive:function(a,b){var c=this.getColumnType(a),d={string:{string:!1,number:!0,date:!0,boolean:!0},number:{string:!1,number:!1,date:!0,boolean:!0},date:{string:!1,number:!0,date:!1,boolean:!0},boolean:{string:!1,number:!1,date:!0,boolean:!1}};return d[c][b]},changeColumnType:function(a,b,c){var d=this._getColumn(a);return this.getColumnType(a)==b?void(c&&c.success&&c.success()):void this.saveNewColumnType(d,b,c)},saveNewColumnType:function(a,b,c){var d=this;a.set({type:b}),this.notice("Changing column type","load",0),a.save(null,{success:function(){d.notice("Column type has been changed","info"),d.trigger("typeChanged",b),d.data().fetch(),c&&c.success&&c.success()},error:function(a,e){d.trigger("typeChangeFailed",b,a),d.error("error changing column type",e),c&&c.error&&c.error(a,e)},wait:!0})},originalData:function(){return this._data},data:function(){return void 0===this._data&&(this._data=new cdb.admin.CartoDBTableData(null,{table:this}),this.bindData()),this.sqlView?this.sqlView:this._data},bindData:function(a){this._data&&!this._data.bindedReset&&(this.retrigger("reset",this._data,"dataLoaded"),this.retrigger("add",this._data,"dataAdded"),this._data.bindedReset=!0),this.sqlView&&!this.sqlView.bindedReset&&(this.retrigger("reset",this.sqlView,"dataLoaded"),this.retrigger("add",this.sqlView,"dataAdded"),this.sqlView.bindedReset=!0)},useSQLView:function(a,b){if(a||this.sqlView){b=b||{};var c=this;this.data();this.sqlView&&(this.sqlView.unbind(null,null,this),this.sqlView.unbind(null,null,this._data)),!a&&this.sqlView&&(this.sqlView.table=null),this.sqlView=a,this.bindData(),a?(a.bind("reset",function(){a.modify_rows||this.set({schema:a.schemaFromData(this.get("schema")),geometry_types:a.getGeometryTypes()})},this),a.bind("error",function(a,b){this.notice("error loading rows, check your SQL query","error",5e3)},this),a.bind("loading",function(){},this),a.bind("reset loaded",function(){a.modify_rows?(this.notice(a.affected_rows+" rows affected"),this.useSQLView(null)):this.notice(_t("loaded"))},this),this.dataModel=this.sqlView,a.table=this):(this.dataModel=this._data,c.set({schema:c.get("original_schema")}),c.data().fetch()),this.trigger("change:dataSource",this.dataModel,this)}},isInSQLView:function(){return!!this.sqlView},fetch:function(a){var b=this;silent=!!a&&a.silent,silent||this.notice("loading table","load",this,0,0);var c=this.elder("fetch",a);return $.when(c).done(function(){a&&a.success&&a.success.old_success&&a.success.old_success(),silent||b.notice("loaded")}).fail(function(){silent||b.notice("error loading the table")}),c},isReservedColumn:function(a){return cdb.admin.Row.isReservedColumn(a)},linkToInfowindow:function(a){this.bind("columnRename",function(b,c){a.containsField(c)&&(a.removeField(c),a.addField(b))},a),this.bind("columnDelete",function(b,c){a.removeField(b)},a),this.bind("change:schema",function(){function b(a){var b,c=0;for(i=0;i<a.length;i++)b=a.charCodeAt(i),c=b+(c<<6)+(c<<16)-c;return c}var c=this,d=_(this.columnNames()).filter(function(b){return!_.contains(a.SYSTEM_COLUMNS,b)});if(this.isInSQLView()){a.has("defaul_schema_fields")||a.saveFields("defaul_schema_fields");var e="schema_"+b(c.columnNames().sort().join("")),f="schema_"+b(_(c.previous("schema")).pluck(0).sort().join(""));a.has(f)||a.saveFields(f),a.has(e)&&a.restoreFields(null,e)}else a.restoreFields(null,"defaul_schema_fields");a.get("template")?a.mergeFields(d):a.removeMissingFields(d)},this)},embedURL:function(){return"/tables/"+this.get("name")+"/embed_map"},viewUrl:function(){return cdb.config.prefixUrl()+"/tables/"+this.getUnqualifiedName()},hasTheGeom:function(){var a=this.get("schema");for(var b in a)if("the_geom"===a[b][0])return!0;return!1},fetchGeoreferenceStatus:function(){var a=$.Deferred(),b=this.options&&this.options.user_data?this.options.user_data.username:window.user_data?window.user_data.username:window.user_name,c=this.options&&this.options.user_data?this.options.user_data.api_key:window.user_data?window.user_data.api_key:window.api_key;this.sqlApi=new this.sqlApiClass({user:b,version:"v1",api_key:c,sql_api_template:cdb.config.getSqlApiBaseUrl()});var d="SELECT the_geom FROM "+this.get("name")+" WHERE the_geom is not null";return this.sqlApi.execute(d).done(function(b){b.rows.length>0?a.resolve(!0):a.resolve(!1)}),a.promise()},isGeoreferenced:function(){var a=this.geomColumnTypes();return!!(a&&a.length>0)||!this.isInSQLView()&&this._data.any(function(a){return a.hasGeometry()})},geometryTypeChanged:function(){function a(a){return a=a.toLowerCase(),"st_multipolygon"===a?"st_polygon":"st_multilinestring"===a?"st_linestring":"st_multipoint"===a?"st_point":a}if(!("geometry_types"in this.changed))return!1;var b=this.get("geometry_types"),c=this.previousAttributes().geometry_types;
if(!b||0===b.length||!c||0===c.length)return!0;var d=a(b[0]),e=a(c[0]);return d!==e},duplicate:function(a,b){b=b||{};var c={table_name:a};if(this.isInSQLView()){var d=this.data().getSQL();c.sql=d&&""!=d?d:"SELECT * FROM "+cdb.Utils.safeTableNameQuoting(this.get("name"))}else c.table_copy=this.get("name");var e=new cdb.admin.Import;e.save(c,{error:b.error,success:function(a,c){var d=new cdb.admin.Import({item_queue_id:c.item_queue_id});d.bind("importComplete",function(){d.unbind();var a=new cdb.admin.CartoDBTableMetadata({id:d.get("table_id")});a.fetch({success:function(){b.success(a)},error:b.error})}),d.bind("importError",function(){d.unbind(),b.error.apply(this,arguments)}),d.pollCheck()}})},dependentVisualizations:function(){return _.chain(this.get("dependent_visualizations")).union(this.get("non_dependent_visualizations")).compact().value()||[]}},{createFromQuery:function(a,b){return new cdb.admin.CartoDBTableMetadata({sql:b,name:a})},sortSchema:function(a){function b(a){return c[a]||c.__default__}var c={cartodb_id:1,the_geom:2,__default__:3,created_at:4,updated_at:5};return _.chain(a).clone().sort(function(a,c){var d=b(a[0]),e=b(c[0]);return d<e?-1:d>e?1:a[0]<c[0]?-1:1}).value()},alterTable:function(a){return a=a.trim(),a.search(/alter\s+[\w\."]+\s+/i)!==-1||a.search(/drop\s+[\w\.\"]+/i)!==-1||a.search(/^vacuum\s+[\w\.\"]+/i)!==-1||a.search(/^create\s+[\w\.\"]+/i)!==-1||a.search(/^reindex\s+[\w\.\"]+/i)!==-1||a.search(/^grant\s+[\w\.\"]+/i)!==-1||a.search(/^revoke\s+[\w\.\"]+/i)!==-1||a.search(/^cluster\s+[\w\.\"]+/i)!==-1||a.search(/^comment\s+on\s+[\w\.\"]+/i)!==-1||a.search(/^explain\s+[\w\.\"]+/i)!==-1},alterTableData:function(a){return this.alterTable(a)||a.search(/^refresh\s+materialized\s+view\s+[\w\.\"]+/i)!==-1||a.search(/^truncate\s+[\w\.\"]+/i)!==-1||a.search(/insert\s+into/i)!==-1||a.search(/update\s+[\w\.\-"]+\s+.*set/i)!==-1||a.search(/delete\s+from/i)!==-1}}),cdb.admin.Row=cdb.core.Model.extend({_CREATED_EVENT:"created",_CREATED_EVENT:"creating",sqlApiClass:cartodb.SQL,_GEOMETRY_TYPES:{point:"st_point",multipoint:"st_multipoint",linestring:"st_linestring",multilinestring:"st_multilinestring",polygon:"st_polygon",multipolygon:"st_multipolygon"},url:function(a){var b=cdb.config.urlVersion("record",a),c=this.table||this.collection.table;c||cdb.log.error("row has no table assigned");var d="/api/"+b+"/tables/"+c.get("name")+"/records/";return this.isNew()?d:d+this.id},fetch:function(a){a=a||{};var b=this,c=(a&&a.silent,this.options&&this.options.user_data?this.options.user_data.username:window.user_data?window.user_data.username:window.user_name),d=this.options&&this.options.user_data?this.options.user_data.api_key:window.user_data?window.user_data.api_key:window.api_key,e=this.table||this.collection.table,f=new this.sqlApiClass({user:c,version:"v2",api_key:d,sql_api_template:cdb.config.getSqlApiBaseUrl(),extra_params:["skipfields"]}),g=null,h=e.columnNames();h=a.no_geom?_.without(h,"the_geom","the_geom_webmercator"):_.without(h,"the_geom"),g="SELECT "+h.join(",")+" ",e.containsColumn("the_geom")&&!a.no_geom&&(g+=",ST_AsGeoJSON(the_geom, 8) as the_geom "),g+=" from ("+e.data().getSQL()+") _table_sql WHERE cartodb_id = "+this.get("cartodb_id"),a.no_geom?a.skipfields="the_geom,the_geom_webmercator":a.skipfields="the_geom_webmercator",f.execute(g,{},a).done(function(a){b.parse(a.rows[0])&&(b.set(a.rows[0]),b.trigger("sync"))})},toJSON:function(){var a=_.clone(this.attributes);return delete a.updated_at,delete a.created_at,delete a.the_geom_webmercator,this.isGeometryGeoJSON()||delete a.the_geom,a},isGeomLoaded:function(){var a=this.get("the_geom"),b=cdb.admin.WKT.types;return"GeoJSON"!==a&&a!==-1&&!_.contains(b,a)},hasGeometry:function(){var a=this.get("the_geom");return!(null==a||void 0==a||""==a)},isGeometryGeoJSON:function(){var a=this.get("the_geom");if(a&&"object"==typeof a)return!!a.coordinates;if("string"!=typeof a)return!1;if("GeoJSON"===a)return!0;try{var b=JSON.parse(a);return!!b.coordinates}catch(a){return!1}return!1},getFeatureType:function(){if(this.isGeomLoaded())try{var a=JSON.parse(this.get("the_geom"));return a.type.toLowerCase()}catch(a){cdb.log.info("Not possible to parse geometry type")}return null},getGeomType:function(){try{return this._GEOMETRY_TYPES[this.getFeatureType()]}catch(a){cdb.log.info("Not possible to parse geometry type")}}},{RESERVED_COLUMNS:"the_geom the_geom_webmercator cartodb_id created_at updated_at".split(" "),isReservedColumn:function(a){return _(cdb.admin.Row.RESERVED_COLUMNS).indexOf(a)!==-1}})}(),cdb.admin.CartoDBTableData=cdb.ui.common.TableData.extend({_ADDED_ROW_TEXT:"Row added correctly",_ADDING_ROW_TEXT:"Adding a new row",_GEOMETRY_UPDATED:"Table geometry updated",model:cdb.admin.Row,initialize:function(a,b){this.table=b?b.table:null,this.model.prototype.idAttribute="cartodb_id",this.initOptions(),this.filter=null,this._fetching=!1,this.pages=[],this.lastPage=!1,this.bind("newPage",this.newPage,this),this.bind("reset",function(){var a=Math.floor(this.size()/this.options.get("rows_per_page"));this.pages=[];for(var b=0;b<a;++b)this.pages.push(b)},this),this.table&&this.bind("add change:the_geom",function(a){var b=this.table.get("geometry_types");b&&b.length>0||a.get("the_geom")&&this.table.addGeomColumnType(a.getGeomType())},this),this.elder("initialize")},initOptions:function(){var a=this;this.options=new cdb.core.Model({rows_per_page:40,page:0,sort_order:"asc",order_by:"cartodb_id",filter_column:"",filter_value:""}),this.options.bind("change",function(){if(!a._fetching){a._fetching=!0,opt={};var b=this.options.previous("page");this.options.hasChanged("page")?(opt.add=!0,opt.changingPage=!0,b>this.options.get("page")&&(opt.at=0)):this.options.hasChanged("mode")&&this.options.set({page:0},{silent:!0}),opt.success=function(c,d){a.trigger("loaded"),d.rows&&0!==d.rows.length?opt.changingPage&&a.trigger("newPage",a.options.get("page"),0===opt.at?"up":"down"):a.options.set({page:b}),a.trigger("endLoadingRows",a.options.get("page"),0===opt.at?"up":"down"),a._fetching=!1},opt.error=function(){cdb.log.error("there was some problem fetching rows"),a.trigger("endLoadingRows"),a._fetching=!1},a.trigger("loadingRows",0===opt.at?"up":"down"),this.fetch(opt)}},this)},parse:function(a){return this.modify_rows=0===a.rows.length&&0===_.size(a.fields),this.affected_rows=a.affected_rows,this.lastPage=!1,a.rows.length<this.options.get("rows_per_page")&&(this.lastPage=!0),a.rows},_schemaFromQueryFields:function(a){var b={};for(k in a)b[k]=a[k].type;return b},_createUrlOptions:function(a){var b;if(a){var c={};for(var d in this.options.attributes)a(d)&&(c[d]=this.options.attributes[d]);b=_(c)}else b=_(this.options.attributes);var e=b.map(function(a,b){return b+"="+encodeURIComponent(a)}).join("&");return e+="&api_key="+cdb.config.get("api_key")},_geometryColumnSQL:function(a){return["CASE","WHEN GeometryType("+a+") = 'POINT' THEN","ST_AsGeoJSON("+a+",8)","WHEN ("+a+" IS NULL) THEN","NULL","ELSE","GeometryType("+a+")","END "+a].join(" ")},wrappedSQL:function(a,b,c){var d=this;b=b||["the_geom_webmercator"],a=_.clone(a);var e=_.chain(a).omit(b).map(function(a,b){return"geometry"===a?c?'st_astext("'+b+'") as '+b:d._geometryColumnSQL(b):'"'+b+'"'}).value();e=e.join(",");var f="desc"===this.options.get("sort_order")?"desc":"asc",g="select "+e+" from ("+this.getSQL()+") __wrapped",h=this.options.get("order_by");return h&&h.length>0&&(g+=" order by "+h+" "+f),g},url:function(){return this.sqlApiUrl()},sync:function(a,b,c){if(c||(c={}),c.data=this._createUrlOptions(function(a){return"sql"!==a}),cdb.admin.CartoDBTableMetadata.alterTableData(this.options.get("sql")||""))c.data+="&q="+encodeURIComponent(this.options.get("sql")),c.type="POST";else{var d="cartodb_id"in this.query_schema;c.data+="&q="+encodeURIComponent(this.wrappedSQL(this.query_schema,[],!d)),c.data.length>2048&&(c.type="POST")}return Backbone.sync.call(this,a,this,c)},sqlApiUrl:function(){return cdb.config.getSqlApiUrl()},setOptions:function(a){this.options.set(a)},refresh:function(){this.fetch()},isFetchingPage:function(){return this._fetching},loadPageAtTop:function(){if(!this._fetching){var a=this.pages[0];a>0&&this.options.set("page",a-1)}},loadPageAtBottom:function(){if(!this._fetching){var a=this.pages[this.pages.length-1];this.lastPage||this.options.set("page",a+1)}},newPage:function(a,b){this.pages.indexOf(a)<0&&this.pages.push(a),this.pages.sort(function(a,b){return Number(a)>Number(b)});var c=this.options.get("rows_per_page"),d=4*c;this.size()>d&&("up"==b?(this.pages.pop(),this.remove(this.models.slice(d,this.size()))):(this.pages.shift(),this.remove(this.models.slice(0,c))))},addRow:function(a){var b=this;this.table.notice(b._ADDING_ROW_TEXT,"load",0);var b=this;return a=a||{},_.extend(a,{wait:!0,success:function(){b.table.notice(b._ADDED_ROW_TEXT)},error:function(a,c){b.table.error(b._ADDING_ROW_TEXT,c)}}),this.create(null,a)},newRow:function(a){return r=new cdb.admin.Row(a),r.table=this.table,r.bind("saved",function a(){0==r.table.data().length&&(r.table.data().fetch(),r.unbind("saved",a,r.table))},r.table),r},getRow:function(a,b){b=b||{};var c=this.get(a);return c||(c=new cdb.admin.Row({cartodb_id:a})),b.no_add||this.table._data.add(c),c.table=this.table,c},getRowAt:function(a){var b=this.at(a);return b.table=this.table,b},deleteRow:function(a){},isReadOnly:function(){return!1},quartiles:function(a,b,c,d){var e=_.template("select quartile, max(<%= column %>) as maxamount from (select <%= column %>, ntile(<%= slots %>) over (order by <%= column %>) as quartile from (<%= sql %>) _table_sql where <%= column %> is not null) x group by quartile order by quartile");this._sqlQuery(e({slots:a,sql:this.getSQL(),column:b}),function(a){c(_(a.rows).pluck("maxamount"))},d)},equalInterval:function(a,b,c,d){var e=_.template("       with params as (select min(a), max(a) from ( select <%= column %> as a from (<%= sql %>) _table_sql where <%= column %> is not null ) as foo )       select (max-min)/<%= slots %> as s, min, max from params");this._sqlQuery(e({slots:a,sql:this.getSQL(),column:b}),function(b){for(var d=b.rows[0].min,e=b.rows[0].max,f=b.rows[0].s,g=[],h=1,i=a;h<i;h++)g.push(f*h+d);g.push(e),c(g)},d)},_quantificationMethod:function(a,b,c,d,e,f){var g=_.template("select unnest(<%= functionName %>(array_agg(<%= simplify_fn %>((<%= column %>::numeric))), <%= slots %>)) as buckets from (<%= sql %>) _table_sql where <%= column %> is not null");this._sqlQuery(g({slots:b,sql:this.getSQL(),column:c,functionName:a,simplify_fn:"distinct"}),function(a){e(_(a.rows).pluck("buckets"))},f)},discreteHistogram:function(a,b,c,d){var e="SELECT DISTINCT(<%= column %>) AS bucket, count(*) AS value FROM (<%= sql %>) _table_sql GROUP BY <%= column %> ORDER BY value DESC LIMIT <%= nbuckets %> + 1",f=_.template(e,{column:b,nbuckets:a,sql:this.getSQL()});this._sqlQuery(f,function(b){var d=b.rows.length,e=!1;d>a&&(b.rows=b.rows.slice(0,a),e=!0),c({rows:b.rows,reached_limit:e})})},date_histogram:function(a,b,c,d){function e(a){return a.map(function(a){return parseFloat(a)})}b="EXTRACT(EPOCH FROM "+b+"::TIMESTAMP WITH TIME ZONE )";var f=_.template("with bounds as ( SELECT  current_timestamp as tz, min(<%= column %>) as lower,  max(<%= column %>) as upper,  (max(<%= column %>) - min(<%= column %>)) as span,  CASE WHEN ABS((max(<%= column %>) - min(<%= column %>))/<%= nbuckets %>) <= 0 THEN 1 ELSE GREATEST(1.0, pow(10,ceil(log((max(<%= column %>) - min(<%= column %>))/<%= nbuckets %>)))) END as bucket_size FROM  (<%= sql %>) _table_sql )  select array_agg(v) val, array_agg(bucket) buckets, tz, bounds.upper, bounds.lower, bounds.span, bounds.bucket_size from ( select  count(<%= column %>) as v,   round((<%= column %> - bounds.lower)/bounds.bucket_size) as bucket  from (<%= sql %>) _table_sql, bounds  where <%= column %> is not null group by bucket order by bucket ) a, bounds group by bounds.upper, bounds.lower, bounds.span, bounds.bucket_size, bounds.tz ");this._sqlQuery(f({nbuckets:a,sql:this.getSQL(),column:b}),function(a){if(!a.rows||0===a.rows.length)return void c(null,null);var a=a.rows[0];a.val=e(a.val),a.buckets=e(a.buckets);var b,d=[],f={},g=a.upper,h=a.lower,i=(a.span,a.tz),j=a.bucket_size;b=a.val[0];for(var k=0;k<a.buckets.length;++k){var l=a.buckets[k],m=d[l]=a.val[k];b=Math.max(b,m)}for(var n=0;n<d.length;++n)void 0===d[n]?d[n]=0:d[n]=d[n]/b;f.upper=parseFloat(g),f.lower=parseFloat(h),f.bucket_size=parseFloat(j),f.tz=i,c(d,f)},d)},histogram:function(a,b,c,d){function e(a){return a.map(function(a){return parseFloat(a)})}var f=_.template("with bounds as ( SELECT  min(<%= column %>) as lower,  max(<%= column %>) as upper,  (max(<%= column %>) - min(<%= column %>)) as span,  CASE WHEN ABS((max(<%= column %>) - min(<%= column %>))/<%= nbuckets %>) <= 0 THEN 1 ELSE GREATEST(1.0, pow(10,ceil(log((max(<%= column %>) - min(<%= column %>))/<%= nbuckets %>)))) END as bucket_size FROM  (<%= sql %>) _table_sql  )  select array_agg(v) val, array_agg(bucket) buckets, bounds.upper, bounds.lower, bounds.span, bounds.bucket_size from ( select  count(<%= column %>) as v,   round((<%= column %> - bounds.lower)/bounds.bucket_size) as bucket  from (<%= sql %>) _table_sql, bounds  where <%= column %> is not null group by bucket order by bucket ) a, bounds group by bounds.upper, bounds.lower, bounds.span, bounds.bucket_size ");this._sqlQuery(f({nbuckets:a,sql:this.getSQL(),column:b}),function(a){if(!a.rows||0===a.rows.length)return void c(null,null);var a=a.rows[0];a.val=e(a.val),a.buckets=e(a.buckets);var b,d=[],f={},g=a.upper,h=a.lower,i=(a.span,a.bucket_size);b=a.val[0];for(var j=0;j<a.buckets.length;++j){var k=a.buckets[j],l=d[k]=a.val[j];b=Math.max(b,l)}for(var m=0;m<d.length;++m)void 0===d[m]?d[m]=0:d[m]=d[m]/b;f.upper=parseFloat(g),f.lower=parseFloat(h),f.bucket_size=parseFloat(i),c(d,f)},d)},jenkBins:function(a,b,c,d){this._quantificationMethod("CDB_JenksBins",a,b,!0,c,d)},headTails:function(a,b,c,d){this._quantificationMethod("CDB_HeadsTailsBins",a,b,!1,c,d)},quantileBins:function(a,b,c,d){this._quantificationMethod("CDB_QuantileBins",a,b,!1,c,d)},categoriesForColumn:function(a,b,c,d){var e=_.template("      SELECT <%= column %>, count(<%= column %>) FROM (<%= sql %>) _table_sql GROUP BY <%= column %> ORDER BY count DESC LIMIT <%= max_values %> ");this._sqlQuery(e({sql:this.getSQL(),column:b,max_values:a+1}),function(a){c({type:a.fields[b].type||"string",categories:_(a.rows).pluck(b)})},d)},geometryBounds:function(a){var b=_.template("SELECT ST_XMin(ST_Extent(the_geom)) as minx,ST_YMin(ST_Extent(the_geom)) as miny, ST_XMax(ST_Extent(the_geom)) as maxx,ST_YMax(ST_Extent(the_geom)) as maxy from (<%= sql %>) _table_sql");this._sqlQuery(b({sql:this.getSQL()}),function(b){var c=b.rows[0],d=c.maxx,e=c.maxy,f=c.minx,g=c.miny,h=-85.0511,i=85.0511,j=-179,k=179,l=function(a,b,c){return a<b?b:a>c?c:a};d=l(d,j,k),f=l(f,j,k),e=l(e,h,i),g=l(g,h,i),a([[e,d],[g,f]])})},_sqlQuery:function(a,b,c,d){var e=encodeURIComponent(a);return $.ajax({type:d||"POST",data:"q="+e+"&api_key="+cdb.config.get("api_key"),url:this.url(),success:b,error:c})},getSQL:function(){return"select * from "+cdb.Utils.safeTableNameQuoting(this.table.get("id"))},fetch:function(a){var b=this;a=a||{},a&&a.add||(this.options.attributes.page=0,this.options._previousAttributes.page=0,this.pages=[]);var c=a.error;a.error=function(a,d){b.fetched=!0,b.trigger("error",a,d),c&&c(a,d)};var d=a.success;a.success=function(a,c){b.fetched=!0,d&&d.apply(b,arguments)},this._fetch(a)},_fetch:function(a){var b=1024,c=this;this.trigger("loading",a);var d=this.getSQL();return cdb.admin.CartoDBTableMetadata.alterTableData(d)?void cdb.ui.common.TableData.prototype.fetch.call(c,a):void this._sqlQuery(_.template("select * from (<%= sql %>) __wrapped limit 0")({sql:d}),function(b){c.query_schema=c._schemaFromQueryFields(b.fields),c.table.isInSQLView()||"the_geom"in c.query_schema&&delete c.query_schema.the_geom_webmercator,cdb.ui.common.TableData.prototype.fetch.call(c,a)},function(a){c.trigger("error",c,a)},d.length>b?"POST":"GET")},schemaFromData:function(a){return cdb.admin.CartoDBTableMetadata.sortSchema(_(this.query_schema).map(function(a,b){return[b,a]}))},geometryTypeFromGeoJSON:function(a){try{var b=JSON.parse(a);return b.type}catch(a){}},geometryTypeFromWKT:function(a){if(!a)return null;var b=cdb.admin.WKT.types;a=a.toUpperCase();for(var c=0;c<b.length;++c){var d=b[c];if(a.indexOf(d)!==-1)return d}},geometryTypeFromWKB:function(a){if(!a)return null;var b={"0001":"Point","0002":"LineString","0003":"Polygon","0004":"MultiPoint","0005":"MultiLineString","0006":"MultiPolygon"},c="0"===a[0]&&"0"===a[1],d=a.substring(2,6);return c||(d=d[2]+d[3]+d[0]+d[1]),b[d]},getGeometryTypes:function(){for(var a=null,b=this.size();b--&&(!a||!a.get("the_geom"));)a=this.at(b);if(!a)return[];var c=a.get("the_geom")||a.get("the_geom_webmercator"),d=this.geometryTypeFromWKB(c)||this.geometryTypeFromWKT(c);return d?["ST_"+d[0].toUpperCase()+d.substring(1).toLowerCase()]:[]}}),cdb.admin.SQLViewData=cdb.admin.CartoDBTableData.extend({UNDEFINED_TYPE_COLUMN:"undefined",initialize:function(a,b){this.model.prototype.idAttribute="cartodb_id",cdb.admin.CartoDBTableData.prototype.initialize.call(this,a,b),this.bind("error",function(){this.reset([])}),b&&b.sql&&this.setSQL(b.sql)},_parseSQL:function(a){a=a.replace(/([^\\]){x}/g,"$10").replace(/\\{x}/g,"{x}"),a=a.replace(/([^\\]){y}/g,"$10").replace(/\\{y}/g,"{y}"),a=a.replace(/([^\\]){z}/g,"$10").replace(/\\{z}/g,"{z}");var b="156543.03515625",c="ST_MakeEnvelope(-20037508.5,-20037508.5,20037508.5,20037508.5,3857)";return a=a.replace("!bbox!",c).replace("!pixel_width!",b).replace("!pixel_height!",b)},sqlSource:function(){return this.options.get("sql_source")},setSQL:function(a,b){b=b||{},this.options.set({page:0,sort_order:"asc",order_by:"",filter_column:"",filter_value:"",sql_source:b.sql_source||null},{silent:!0});var c=b.silent;b.silent=!0,this.options.set({sql:a?this._parseSQL(a):""},b),c||this.options.trigger("change:sql",this.options,a)},getSQL:function(){return this.options.get("sql")},url:function(){return this.sqlApiUrl()},isReadOnly:function(){return"filters"!==this.sqlSource()},quartiles:function(a,b,c,d){var e=_.template("SELECT quartile, max(<%= column %>) as maxAmount FROM (SELECT <%= column %>, ntile(<%= slots %>) over (order by <%= column %>) as quartile FROM (<%= sql %>) as _rambo WHERE <%= column %> IS NOT NULL) x GROUP BY quartile ORDER BY quartile");this._sqlQuery(e({slots:a,sql:this.options.get("sql"),column:b}),function(a){c(_(a.rows).pluck("maxamount"))},d)},isGeoreferenced:function(){return this.getGeometryTypes().length>0}}),cdb.admin.CartoDBLayer=cdb.geo.CartoDBLayer.extend({MAX_HISTORY:5,MAX_HISTORY_QUERY:5,MAX_HISTORY_TILE_STYLE:5,initialize:function(){this.sync=_.debounce(this.sync,1e3),this.error=!1,this.set("use_server_style",!0),this.initHistory("query"),this.initHistory("tile_style"),this.table=new cdb.admin.CartoDBTableMetadata({id:this.get("table_name")}),this.infowindow=new cdb.geo.ui.InfowindowModel({template_name:"infowindow_light"}),this.tooltip=new cdb.geo.ui.InfowindowModel({template_name:"tooltip_light"});var a=this.get("wizard_properties");this.wizard_properties=new cdb.admin.WizardProperties(_.extend({},a,{table:this.table,layer:this})),this.wizard_properties.bind("change:type",this._manageInteractivity,this),this.legend=new cdb.geo.ui.LegendModel,this.bind("change:table_name",function(){this.table.set("id",this.get("table_name")).fetch()},this),this.bindInfowindow(this.infowindow,"infowindow"),this.bindInfowindow(this.tooltip,"tooltip"),this.bindLegend(this.legend),this.bindTable(this.table),this.tooltip.bind("change:fields",this._manageInteractivity,this),this.get("table")&&(table_attr=this.get("table"),delete this.attributes.table,this.table.set(table_attr)),this.isTableLoaded()||this.table.fetch()},isTableLoaded:function(){return this.table.get("id")&&this.table.get("privacy")},toLayerGroup:function(){var a=_.clone(this.attributes);return a.layer_definition={version:"1.0.1",layers:[]},this.get("visible")&&a.layer_definition.layers.push(this.getLayerDef()),a.type="layergroup",a},getLayerDef:function(){var a=this.attributes,b=a.query||"select * from "+cdb.Utils.safeTableNameQuoting(a.table_name);return a.query_wrapper&&(b=_.template(a.query_wrapper)({sql:b})),{type:"cartodb",options:{sql:b,cartocss:this.get("tile_style"),cartocss_version:"2.1.1",interactivity:this.get("interactivity")}}},initHistory:function(a){this.get(a+"_history")||this.set(a+"_history",[]),this[a+"_history_position"]=0,this[a+"_storage"]=new cdb.admin.localStorage(a+"_storage_"+this.get("table_name"))},addToHistory:function(a,b){b!=this.get(a+"_history")[this.get(a+"_history").length-1]&&(this.get(a+"_history").push(b),this.trimHistory(a),this[a+"_history_position"]=this.get(a+"_history").length-1)},trimHistory:function(a){for(var b=this["MAX_HISTORY_"+a.toUpperCase()]?this["MAX_HISTORY_"+a.toUpperCase()]:this.MAX_HISTORY;this.get(a+"_history").length>b;){var c=this.get(a+"_history").splice(0,1);this[a+"_storage"].add(c[0])}},moveHistoryPosition:function(a,b){var c=this[a+"_history_position"]+b;c>=0&&c<this.get(a+"_history").length?this[a+"_history_position"]=c:c<0&&Math.abs(c)<=this[a+"_storage"].get().length&&(this[a+"_history_position"]=c)},getCurrentHistoryPosition:function(a){var b=this[a+"_history_position"];return this[a+"_history_position"]>=0?this.get(a+"_history")[b]:Math.abs(b)<=this[a+"_storage"].get().length?this[a+"_storage"].get(this[a+"_storage"].get().length-Math.abs(b)):this.get(a+"_history")[0]},redoHistory:function(a){return this.moveHistoryPosition(a,1),this.getCurrentHistoryPosition(a)},undoHistory:function(a){var b=this.getCurrentHistoryPosition(a);return this.moveHistoryPosition(a,-1),b},isHistoryAtLastPosition:function(a){return 0===this.get(a+"_history").length||this.get(a+"_history").length-1==this[a+"_history_position"]},isHistoryAtFirstPosition:function(a){if(0===this.get(a+"_history").length)return!0;var b=this[a+"_storage"].get();if(!b||0!==b.length){var c=b?1*b.length:0,d=-1*c;return d==this[a+"_history_position"]}return 0===this[a+"_history_position"]},clone:function(){var a=_.clone(this.attributes);return delete a.id,a.table=this.table.toJSON(),new cdb.admin.CartoDBLayer(a)},toJSON:function(){var a=_.clone(this.attributes);a.extra_params&&(a.extra_params=_.clone(this.attributes.extra_params),a.extra_params.api_key&&delete a.extra_params.api_key,a.extra_params.map_key&&delete a.extra_params.map_key),delete a.infowindow,delete a.tooltip,a.wizard_properties=this.wizard_properties.toJSON(),a.legend=this.legend.toJSON();var b={kind:"cartodb"===a.type.toLowerCase()?"carto":a.type,options:a,order:a.order,infowindow:null,tooltip:this.tooltip.toJSON()};return this.wizard_properties.supportsInteractivity()&&(b.infowindow=this.infowindow.toJSON()),void 0!==a.id&&(b.id=a.id),b},parse:function(a,b){var c={};if(!a||this._saving&&!this.isNew())return c;a.options.extra_params&&this.attributes&&this.attributes.extra_params&&(a.options.extra_params.map_key=this.attributes.extra_params.map_key);var d=this.attributes,e=d&&d.wizard_properties;return e&&e.properties&&e.properties.metadata&&a.options.wizard_properties&&a.options.wizard_properties.properties&&(a.options.wizard_properties.properties.metadata=e.properties.metadata),this.wizard_properties&&a.options.wizard_properties&&this.wizard_properties.properties(a.options.wizard_properties),_.extend(c,a.options,{id:a.id,type:"carto"===a.kind?"CartoDB":a.kind,infowindow:a.infowindow,tooltip:a.tooltip,order:a.order}),c},sync:function(a,b,c){return"read"!=a&&(c.data=JSON.stringify(b.toJSON())),c.contentType="application/json",c.url=b.url(),Backbone.syncAbort(a,this,c)},unbindSQLView:function(a){this.sqlView.unbind(null,null,this),this.sqlView=null},getCurrentState:function(){return this.error?"error":"success"},bindSQLView:function(a){var b=this;this.sqlView=a,this.sqlView.bind("error",this.errorSQLView,this),this.sqlView.bind("reset",function(){b.table.isInSQLView()&&(b.error=!1,b.sqlView.modify_rows?(b.set({query:null}),b.invalidate(),b.table.useSQLView(null,{force_data_fetch:!0}),b.trigger("clearSQLView")):b.save({query:a.getSQL(),sql_source:a.sqlSource()}))},this);var c=this.get("query");c?this.applySQLView(c,{add_to_history:!1}):this.table.data().fetch()},bindTable:function(a){this.table=a;var b=this;b.table.bind("change:name",function(){b.get("table_name")!=b.table.get("name")&&b.fetch({success:function(){b.updateCartoCss(b.table.previous("name"),b.table.get("name"))}})}),this.table.bind("change:schema",this._manageInteractivity,this)},_manageInteractivity:function(){var a=null;if(this.wizard_properties.supportsInteractivity()){this.table.containsColumn("cartodb_id")&&(a=["cartodb_id"]);var b=this.tooltip.getInteractivity();b.length&&(a=(a||[]).concat(b)),a&&(a=a.join(","))}this.get("interactivity")!==a&&(this.isNew()?this.set({interactivity:a}):this.save({interactivity:a}))},updateCartoCss:function(a,b){var c=this.get("tile_style");if(c){var d=new RegExp("#"+a,"g");c=c.replace(d,"#"+b),this.save({tile_style:c})}},bindLegend:function(a){var b=this.get("legend");b&&this.legend.set(b),this.legend.bind("change:template change:type change:title change:show_title change:items",_.debounce(function(){this.isNew()||this.save(null,{silent:!0})},250),this)},bindInfowindow:function(a,b){b=b||"infowindow";var c=this.get(b);if(c)a.set(c);else{var d=0;_(this.table.get("schema")).each(function(b){_.contains(["the_geom","created_at","updated_at","cartodb_id"],b[0])||(a.addField(b[0],d),++d)})}this.table.linkToInfowindow(a);var e="change:fields change:template_name change:alternative_names change:template change:disabled change:width change:maxHeight",f=_.debounce(function(){a.unbind(e,f,this),a.removeMissingFields(this.table.columnNames()),a.bind(e,f,this),this.isNew()||this.save(null,{silent:!0})},250);a.bind(e,f,this)},resetQuery:function(){this.get("query")&&this.save({query:void 0,sql_source:null})},errorSQLView:function(a,b){this.save({query:null},{silent:!0}),this.trigger("errorSQLView",b),this.error=!0},clearSQLView:function(){this.table.useSQLView(null),this.addToHistory("query","SELECT * FROM "+cdb.Utils.safeTableNameQuoting(this.table.get("name"))),this.undoHistory("query"),this.resetQuery(),this.trigger("clearSQLView")},applySQLView:function(a,b){b=b||{add_to_history:!0,sql_source:null},this.table.useSQLView(this.sqlView),this.sqlView.setSQL(a,{silent:!0,sql_source:b.sql_source||null}),b.add_to_history&&this.addToHistory("query",a),this.sqlView.fetch(),this.trigger("applySQLView",a)},moveToFront:function(a){var b=this.collection,c=b.getDataLayers();b.moveLayer(this,{to:c.length})}},{createDefaultLayerForTable:function(a,b){return new cdb.admin.CartoDBLayer({user_name:b,table_name:a,tile_style:"#"+a+cdb.admin.CartoStyles.DEFAULT_GEOMETRY_STYLE,style_version:"2.1.0",visible:!0,interactivity:"cartodb_id",maps_api_template:cdb.config.get("maps_api_template"),no_cdn:!0})}}),_.extend(cdb.geo.ui.InfowindowModel.prototype,{toJSON:function(){var a=[];return this.attributes.disabled||(a=_.clone(this.attributes.fields)),{fields:a,template_name:this.attributes.template_name,template:this.attributes.template,alternative_names:this.attributes.alternative_names,old_fields:this.attributes.old_fields,old_template_name:this.attributes.old_template_name,width:this.attributes.width,maxHeight:this.attributes.maxHeight}},removeMissingFields:function(a){for(var b={},c=0;c<a.length;++c){var d=a[c];b[d]=!0}var e=this.get("fields");if(e)for(var c=0;c<e.length;++c){var f=e[c].name;f in b||this.removeField(f)}},addMissingFields:function(a){for(var b={},c=this.get("fields"),d=0;d<c.length;++d){var e=c[d].name;b[e]=!0}for(var d=0;d<a.length;++d){var f=a[d];f in b||this.addField(f)}},mergeFields:function(a){this.removeMissingFields(a),this.addMissingFields(a)},getInteractivity:function(){for(var a=this.get("fields")||[],b=[],c=0;c<a.length;++c)b.push(a[c].name);return b}}),cdb.admin.GMapsBaseLayer=cdb.geo.GMapsBaseLayer.extend({clone:function(){return new cdb.admin.GMapsBaseLayer(_.clone(this.attributes))},parse:function(a){var b={};return _.extend(b,a.options,{id:a.id,type:"GMapsBase",order:a.order,parent_id:a.parent_id}),b},toJSON:function(){var a=_.clone(this.attributes),b={kind:"gmapsbase",options:a,order:a.order};return void 0!==a.id&&(b.id=a.id),b}}),cdb.admin.WMSLayer=cdb.geo.WMSLayer.extend({clone:function(){return new cdb.admin.WMSLayer(_.clone(this.attributes))},_generateClassName:function(a){if(a){var b=a;return b&&parseInt(b)&&_.isNumber(parseInt(b))&&(b="w"+b),b.replace(/\s+/g,"").replace(/[^a-zA-Z_0-9 ]/g,"").toLowerCase()}return""},parse:function(a){var b=this,c={};return _.extend(c,a.options,{id:a.id,className:b._generateClassName(a.options.layers),type:"WMS",order:a.order,parent_id:a.parent_id}),c},toJSON:function(){var a=_.clone(this.attributes),b={kind:"wms",options:a,order:a.order};return void 0!==a.id&&(b.id=a.id),b}}),cdb.admin.PlainLayer=cdb.geo.PlainLayer.extend({parse:function(a){var b={};return _.extend(b,a.options,{id:a.id,type:"Plain",order:a.order,parent_id:a.parent_id}),b},toJSON:function(){var a=_.clone(this.attributes),b={kind:"background",options:a,order:a.order};return void 0!==a.id&&(b.id=a.id),b}}),cdb.admin.TileLayer=cdb.geo.TileLayer.extend({clone:function(){return new cdb.admin.TileLayer(_.clone(this.attributes))},_generateClassName:function(a){return a?a.replace(/\s+/g,"").replace(/[^a-zA-Z_0-9 ]/g,"").toLowerCase():""},parse:function(a){var b=this,c={};return _.extend(c,a.options,{id:a.id,className:b._generateClassName(a.options.urlTemplate),type:"Tiled",order:a.order,parent_id:a.parent_id}),c},toJSON:function(){var a=_.clone(this.attributes),b={kind:"tiled",options:a,order:a.order};return void 0!==a.id&&(b.id=a.id),b},validateTemplateURL:function(a){var b=["a","b","c"],c=new Image;c.onload=a.success,c.onerror=a.error,c.src=this.get("urlTemplate").replace(/\{s\}/g,function(){return b[Math.floor(3*Math.random())]}).replace(/\{x\}/g,"0").replace(/\{y\}/g,"0").replace(/\{z\}/g,"0")}},{byCustomURL:function(a,b){if(a&&a.indexOf("/")===-1)throw new TypeError("invalid URL");a=a.replace(/\{S\}/g,"{s}").replace(/\{X\}/g,"{x}").replace(/\{Y\}/g,"{y}").replace(/\{Z\}/g,"{z}");var c=new cdb.admin.TileLayer({urlTemplate:a,attribution:null,maxZoom:21,minZoom:0,name:"",tms:b});return c.set("className",c._generateClassName(a)),c}}),cdb.admin.TorqueLayer=cdb.admin.CartoDBLayer.extend({}),cdb.admin.Layers=cdb.geo.Layers.extend({_DATA_LAYERS:["CartoDB","torque"],model:function(a,b){var c={Tiled:cdb.admin.TileLayer,CartoDB:cdb.admin.CartoDBLayer,Plain:cdb.admin.PlainLayer,GMapsBase:cdb.admin.GMapsBaseLayer,WMS:cdb.admin.WMSLayer,torque:cdb.admin.CartoDBLayer},d={"Layer::Tiled":"Tiled","Layer::Carto":"CartoDB","Layer::Background":"Plain",tiled:"Tiled",carto:"CartoDB",wms:"WMS",background:"Plain",gmapsbase:"GMapsBase",torque:"torque"};return new c[d[a.kind]](a,b)},initialize:function(){this.bind("change:order",function(){this._isSorted()||this.sort()}),cdb.geo.Layers.prototype.initialize.call(this)},add:function(a,b){return Backbone.Collection.prototype.add.apply(this,arguments)},getTorqueLayers:function(){return this.where({type:"torque"})},getTiledLayers:function(){return this.where({type:"Tiled"})},getLayerDefIndex:function(a){var b=this.getLayersByType("CartoDB");if(!b.length)return-1;for(var c=0,d=0;c<b.length;++c)if(b[c].get("visible")){if(b[c].cid===a.cid)return d;++d}return-1},getLayerDef:function(){for(var a=this.getLayersByType("CartoDB"),b={version:"1.0.1",layers:[]},c=0;c<a.length;++c)a[c].get("visible")&&b.layers.push(a[c].getLayerDef());return b},getDataLayers:function(){var a=this;return this.filter(function(b){return _.contains(a._DATA_LAYERS,b.get("type"))})},getTotalDataLayers:function(){return this.getDataLayers().length},getTotalDataLegends:function(){var a=this;return this.filter(function(b){return _.contains(a._DATA_LAYERS,b.get("type"))&&b.get("legend")&&b.get("legend").type&&"none"!==b.get("legend").type.toLowerCase();
}).length},getLayersByType:function(a){return a&&""!==a?this.filter(function(b){return b.get("type")===a}):(cdb.log.info("a layer type is necessary to get layers"),0)},isLayerOnTopOfDataLayers:function(a){var b=this.getDataLayers().splice(-1)[0];return b.cid===a.cid},url:function(a){var b=cdb.config.urlVersion("layer",a);return"/api/"+b+"/maps/"+this.map.id+"/layers"},parse:function(a){return a.layers},saveLayers:function(a){a=a||{},this.save(null,a)},save:function(a,b){Backbone.sync("update",this,b)},toJSON:function(a){var b=_.map(this.models,function(b){return b.toJSON(a)});return{layers:b}},clone:function(a){return a=a||new cdb.admin.Layers,this.each(function(b){if(b.clone){var c=b.clone();c.unset("id"),a.add(c)}else{var d=_.clone(b.attributes);delete d.id,a.add(d)}}),a},_isSorted:function(){var a=_(this.models).map(function(a){return{cid:a.cid,order:a.get("order")}});return a.sort(function(a,b){return a.order-b.order}),_.isEqual(_(a).map(function(a){return a.cid}),_(this.models).map(function(a){return a.cid}))},moveLayer:function(a,b){b=b||{};var c=b.to,d=this.at(c);a.set("order",d.get("order"),{silent:!0}),this.remove(a,{silent:!0}),this.add(a,{at:c,silent:!0});for(var e=0;e<this.size();e++){var f=this.at(e);f.set("order",e)}this.trigger("reset"),this.saveLayers({complete:b.complete,error:function(){throw"Error saving layers after moving them"}})}}),cdb.admin.Map=cdb.geo.Map.extend({urlRoot:"/api/v1/maps",initialize:function(){this.constructor.__super__.initialize.apply(this),this.sync=Backbone.delayedSaveSync(Backbone.syncAbort,500),this.bind("change:id",this._fetchLayers,this),this.layers=new cdb.admin.Layers,this.layers.map=this,this.layers.bind("reset add change",this._layersChanged,this),this.layers.bind("reset add remove change:attribution",this._updateAttributions,this)},saveLayers:function(a){a=a||{};var b=function(){};this.layers.saveLayers({success:a.success||b,error:a.error||b})},_layersChanged:function(){this.layers.size()>=1&&(this._adjustZoomtoLayer(this.layers.at(0)),this.layers.size()>=2&&this.set({dataLayer:this.layers.at(1)}))},_fetchLayers:function(){this.layers.fetch()},relatedTo:function(a){this.table=a,this.table.bind("change:map_id",this._fetchOrCreate,this)},parse:function(a){return a.bounding_box_ne=JSON.parse(a.bounding_box_ne),a.bounding_box_sw=JSON.parse(a.bounding_box_sw),a.view_bounds_ne=JSON.parse(a.view_bounds_ne),a.view_bounds_sw=JSON.parse(a.view_bounds_sw),a.center=JSON.parse(a.center),a},_fetchOrCreate:function(){var a=this,b=this.table.get("map_id");b?(this.set({id:b}),this.fetch({error:function(){cdb.log.info("creating map for table"),a.create()}})):this.create()},setBaseLayer:function(a){if(this.trigger("savingLayers"),this.isBaseLayerAdded(a))return this.trigger("savingLayersFinish"),!1;var b=this,c=a,d=this.layers.at(0),e=c.get("labels")&&c.get("labels").url,f={success:function(){e||b.trigger("savingLayersFinish")},error:function(){cdb.log.error("error changing the basemap"),b.trigger("savingLayersFinish")}};return d?d.get("type")===c.get("type")?this._updateBaseLayer(d,c,f):this._replaceBaseLayer(d,c,f):this._addBaseLayer(c,f),f.success=function(){b.trigger("savingLayersFinish")},e?this._hasLabelsLayer()?this._updateLabelsLayer(c,f):this._addLabelsLayer(c,f):this._hasLabelsLayer()&&this._destroyLabelsLayer(f),c},_updateBaseLayer:function(a,b,c){var d=_.extend(_.clone(b.attributes),{id:a.get("id"),order:a.get("order")});a.clear({silent:!0}),a.set(d),a.save(null,c)},_replaceBaseLayer:function(a,b,c){this.layers.remove(a),b.set({id:a.get("id"),order:a.get("order")}),this.layers.add(b,{at:0}),b.save(null,c)},_addBaseLayer:function(a,b){this.layers.add(a,{at:0}),a.save(null,b)},_hasLabelsLayer:function(){return this.layers.size()>1&&"Tiled"===this.layers.last().get("type")},_updateLabelsLayer:function(a,b){var c=this.layers.last();c.set({name:this._labelsLayerNameFromBaseLayer(a),urlTemplate:a.get("labels").url,attribution:a.get("attribution"),minZoom:a.get("minZoom"),maxZoom:a.get("maxZoom"),subdomains:a.get("subdomains")}),c.save(null,b)},_addLabelsLayer:function(a,b){this.layers.add({name:this._labelsLayerNameFromBaseLayer(a),urlTemplate:a.get("labels").url,attribution:a.get("attribution"),minZoom:a.get("minZoom"),maxZoom:a.get("maxZoom"),subdomains:a.get("subdomains"),kind:"tiled"});var c=this.layers.last();c.save(null,b)},_destroyLabelsLayer:function(a){this.layers.last().destroy(a)},_labelsLayerNameFromBaseLayer:function(a){return a.get("name")+" Labels"},addDataLayer:function(a){this.addLayer(a),this.set({dataLayer:a})},create:function(){this.unset("id"),this.set({table_id:this.table.id}),this.save()},autoSave:function(){this.bind("change:center",this.save),this.bind("change:zoom",this.save)},toJSON:function(){var a=_.clone(this.attributes);return delete a.dataLayer,a},changeProvider:function(a,b){var c=this;if(b&&b.get("id"))return void cdb.log.error("the baselayer should not be saved in the server");var d=function(){b&&c.setBaseLayer(b)};this.get("provider")!==a?this.save({provider:a},{success:function(){d(),c.change()},error:function(a,b){c.error(_t("error switching base layer"),b)},silent:!0}):d()},isProviderGmaps:function(){var a=this.get("provider");return a&&a.toLowerCase().indexOf("googlemaps")!==-1},clone:function(a){a=a||new cdb.admin.Map;var b=_.clone(this.attributes);return delete b.id,a.set(b),a.set({center:_.clone(this.attributes.center),bounding_box_sw:_.clone(this.attributes.bounding_box_sw),bounding_box_ne:_.clone(this.attributes.bounding_box_ne),view_bounds_sw:_.clone(this.attributes.view_bounds_sw),view_bounds_ne:_.clone(this.attributes.view_bounds_ne),attribution:_.clone(this.attributes.attribution)}),this.layers.clone(a.layers),a.layers.map=a,a},notice:function(a,b,c){this.trigger("notice",a,b,c)},error:function(a,b){var c=b&&JSON.parse(b.responseText).errors[0];this.trigger("notice",a+" "+c,"error")},addCartodbLayerFromTable:function(a,b,c){c=c||{};var d=this,e=new cdb.admin.CartoDBTableMetadata({id:a});e.fetch({success:function(){var a=new cdb.admin.Map({id:e.get("map_id")});a.layers.bind("reset",function(){function b(){e.table.unbind("change:geometry_types",b),"torque"===e.wizard_properties.get("type")&&d.layers.getTorqueLayers().length&&e.wizard_properties.active("polygon"),d.layers.create(e,_.extend({wait:!0},c))}var e=a.layers.at(1).clone();e.unset("order"),e.isTableLoaded()?b():(e.table.bind("change:geometry_types",b),e.table.data().fetch())}),a.layers.fetch()}})},clamp:function(){var a=function(a,b){return Number((a-Math.floor(a/b)*b).toPrecision(8))},b=this.get("center"),c=b[1];return(c<-180||c>180)&&(c=a(180+c,360)-180,this.set("center",[b[0],c])),this}}),cdb.admin.Group=cdb.core.Model.extend({defaults:{display_name:""},initialize:function(a){this.parse(a||{})},parse:function(a){return this.users=new cdb.admin.GroupUsers(a.users,{group:this}),a}}),cdb.admin.UserGroups=Backbone.Collection.extend({model:cdb.admin.Group,initialize:function(a,b){this.organization=b.organization}}),cdb.admin.OrganizationGroups=Backbone.Collection.extend({model:cdb.admin.Group,url:function(a){var b=cdb.config.urlVersion("organizationGroups",a);return"/api/"+b+"/organization/"+this.organization.id+"/groups"},initialize:function(a,b){if(!b.organization)throw new Error("organization is required");this.organization=b.organization},parse:function(a){return this.total_entries=a.total_entries,a.groups},newGroupById:function(a){var b=this.get(a);return b||(b=new this.model({id:a}),b.collection=this),b},totalCount:function(){return this.total_entries}}),cdb.admin.UserLayers=cdb.admin.Layers.extend({url:function(a){var b=cdb.config.urlVersion("layer",a);return"/api/"+b+"/users/"+this.user.id+"/layers"},custom:function(){return this.where({category:void 0})}}),cdb.admin.User=cdb.core.Model.extend({urlRoot:"/api/v1/users",defaults:{avatar_url:"http://cartodb.s3.amazonaws.com/static/public_dashboard_default_avatar.png",username:""},initialize:function(a){a=a||{},this.tables=[],null===this.get("avatar_url")&&this.set("avatar_url",this.defaults.avatar_url),this.get("get_layers")&&(this.layers=new cdb.admin.UserLayers,this.layers.user=this,this._fetchLayers()),this.email="undefined"!=typeof a.email?a.email:"",this.get("organization")&&(this.organization=new cdb.admin.Organization(this.get("organization"),{currentUserId:this.id})),this.groups=new cdb.admin.UserGroups(a.groups,{organization:_.result(this.collection,"organization")||this.organization})},isInsideOrg:function(){return!!this.organization&&(0!=this.organization.id||this.isOrgOwner())},isOrgOwner:function(){return!!this.organization&&this.organization.owner.get("id")===this.get("id")},isOrgAdmin:function(){return!!this.organization&&this.organization.isOrgAdmin(this)},isViewer:function(){return 1==this.get("viewer")},isBuilder:function(){return!this.isViewer()},nameOrUsername:function(){return this.get("name")||this.get("username")},renderData:function(a){var b=this.get("username");return a&&a.id===this.id&&(b=_t("You")),{username:b,avatar_url:this.get("avatar_url")}},_fetchLayers:function(){this.layers.fetch({add:!0})},fetchTables:function(){var a=this;if(!this._fetchingTables){var b=new cdb.admin.Visualizations;b.options.set("type","table"),b.bind("reset",function(){a.tables=b.map(function(a){return a.get("name")})}),this._fetchingTables=!0,b.fetch()}},hasCreateDatasetsFeature:function(){return this.isBuilder()},canCreateDatasets:function(){return!(!this.get("remaining_byte_quota")||this.get("remaining_byte_quota")<=0)&&this.hasCreateDatasetsFeature()},hasCreateMapsFeature:function(){return this.isBuilder()},canAddLayerTo:function(a){if(!a||!a.layers||!a.layers.getDataLayers)throw new Error("Map model is not defined or wrong");var b=a.layers.getDataLayers();return b.length<this.getMaxLayers()},getMaxLayers:function(){return this.get("limits")&&this.get("limits").max_layers||5},getMaxConcurrentImports:function(){return this.get("limits")&&this.get("limits").concurrent_imports||1},featureEnabled:function(a){var b=this.get("feature_flags");return!(!b||0===b.length||!a)&&_.contains(b,a)},isCloseToLimits:function(){var a=this.get("quota_in_bytes"),b=this.get("remaining_byte_quota");return 100*b/a<20},getMaxLayersPerMap:function(){return this.get("max_layers")||4},canStartTrial:function(){return!this.isInsideOrg()&&"FREE"===this.get("account_type")&&this.get("table_count")>0},canCreatePrivateDatasets:function(){var a=this.get("actions");return a&&a.private_tables},equals:function(a){if(a.get)return this.get("id")===a.get("id")},viewUrl:function(){return new cdb.common.UserUrl({base_url:this.get("base_url"),is_org_admin:this.isOrgAdmin()})},upgradeContactEmail:function(){return this.isInsideOrg()?this.isOrgOwner()?"enterprise-support@carto.com":this.organization.owner.get("email"):"support@carto.com"},usedQuotaPercentage:function(){return 100*this.get("db_size_in_bytes")/this.organization.get("available_quota_for_user")},assignedQuotaInRoundedMb:function(){return Math.floor(this.get("quota_in_bytes")/1024/1024).toFixed(0)},assignedQuotaPercentage:function(){return 100*this.get("quota_in_bytes")/this.organization.get("available_quota_for_user")}}),cdb.admin.Permission=cdb.core.Model.extend({urlRoot:"/api/v1/perm",initialize:function(){this.acl=new Backbone.Collection,this.owner=null,this._generateOwner(),this._generateAcl(),this.bind("change:owner",this._generateOwner,this),this.bind("change:acl",this._generateAcl,this)},_generateOwner:function(){this.owner||(this.owner=new cdb.admin.User),this.owner.set(this.get("owner"))},_generateAcl:function(){this.acl.reset([],{silent:!0}),_.each(this.get("acl"),function(a){var b;switch(a.type){case"user":b=new cdb.admin.User(a.entity);break;case"org":b=new cdb.admin.Organization(a.entity);break;case"group":b=new cdb.admin.Group(a.entity);break;default:throw new Error("Unknown ACL item type: "+a.type)}this._grantAccess(b,a.access)},this)},cleanPermissions:function(){this.acl.reset()},hasAccess:function(a){return this.hasReadAccess(a)},hasReadAccess:function(a){return!!this.findRepresentableAclItem(a)},hasWriteAccess:function(a){var b=cdb.Utils.result(this.findRepresentableAclItem(a),"get","access");return b===cdb.admin.Permission.READ_WRITE},canChangeReadAccess:function(a){return this._canChangeAccess(a)},canChangeWriteAccess:function(a){return(!a.isBuilder||a.isBuilder())&&this._canChangeAccess(a,function(a){return cdb.Utils.result(a,"get","access")!==cdb.admin.Permission.READ_WRITE})},_canChangeAccess:function(a){var b=this.findRepresentableAclItem(a);return this.isOwner(a)||!b||b===this._ownAclItem(a)||cdb.Utils.result(arguments,1,b)||!1},grantWriteAccess:function(a){this._grantAccess(a,this.constructor.READ_WRITE)},grantReadAccess:function(a){this._grantAccess(a,this.constructor.READ_ONLY)},revokeWriteAccess:function(a){this.grantReadAccess(a)},revokeAccess:function(a){var b=this._ownAclItem(a);b&&this.acl.remove(b)},isOwner:function(a){return _.result(this.owner,"id")===_.result(a,"id")},toJSON:function(){return{entity:this.get("entity"),acl:this.acl.toJSON()}},getUsersWithAnyPermission:function(){return this.acl.chain().filter(this._hasTypeUser).map(this._getEntity).value()},isSharedWithOrganization:function(){return this.acl.any(this._hasTypeOrg)},clone:function(){var a=_.clone(this.attributes);return delete a.id,new cdb.admin.Permission(a)},overwriteAcl:function(a){this.acl.reset(a.acl.models)},findRepresentableAclItem:function(a){if(this.isOwner(a))return this._newAclItem(a,this.constructor.READ_WRITE);var b=["_ownAclItem","_organizationAclItem","_mostPrivilegedGroupAclItem"];return this._findMostPrivilegedAclItem(b,function(b){return this[b](a)})},_hasTypeUser:function(a){return"user"===a.get("type")},_getEntity:function(a){return a.get("entity")},_hasTypeOrg:function(a){return"org"===a.get("type")},_isOrganization:function(a){return a instanceof cdb.admin.Organization},_ownAclItem:function(a){if(a&&_.isFunction(a.isNew)||cdb.log.error("model is required to find an ACL item"),!a.isNew())return this.acl.find(function(b){return b.get("entity").id===a.id})},_organizationAclItem:function(a){var b=_.result(a.collection,"organization")||a.organization;if(b)return this._ownAclItem(b)},_mostPrivilegedGroupAclItem:function(a){var b=_.result(a.groups,"models");if(b)return this._findMostPrivilegedAclItem(b,this._ownAclItem)},_findMostPrivilegedAclItem:function(a,b){for(var c,d=0,e=a[d];e&&cdb.Utils.result(c,"get","access")!==cdb.admin.Permission.READ_WRITE;e=a[++d])c=b.call(this,e)||c;return c},_grantAccess:function(a,b){var c=this._ownAclItem(a);if(c)c.set("access",b);else{if(c=this._newAclItem(a,b),!c.isValid())throw new Error(b+" is not a valid ACL access");this.acl.add(c)}},_newAclItem:function(a,b){var c;if(a instanceof cdb.admin.User)c="user";else if(a instanceof cdb.admin.Group)c="group";else{if(!this._isOrganization(a))throw new Error("model not recognized as a valid ACL entity "+a);c="org"}return new cdb.admin.ACLItem({type:c,entity:a,access:b})}},{READ_ONLY:"r",READ_WRITE:"rw"}),cdb.admin.ACLItem=Backbone.Model.extend({defaults:{access:"r"},isOwn:function(a){return a.id===this.get("entity").id},validate:function(a,b){var c=cdb.admin.Permission;if(a.access!==c.READ_ONLY&&a.access!==c.READ_WRITE)return"access can't take 'r' or 'rw' values"},toJSON:function(){var a=_.pick(this.get("entity").toJSON(),"id","username","avatar_url","name");return a.username||(a.username=a.name,delete a.name),{type:this.get("type")||"user",entity:a,access:this.get("access")}}}),cdb.admin.GroupUsers=Backbone.Collection.extend({model:cdb.admin.User,initialize:function(a,b){if(!b.group)throw new Error("group is required");this.group=b.group},url:function(){return this.group.url.apply(this.group,arguments)+"/users"},parse:function(a){return this.total_entries=a.total_entries,this.total_user_entries=a.total_user_entries,a.users},addInBatch:function(a){return this._batchAsyncProcessUsers("POST",a)},removeInBatch:function(a){var b=this;return this._batchAsyncProcessUsers("DELETE",a).done(function(){_.each(a,b.remove.bind(b))})},_batchAsyncProcessUsers:function(a,b){var c=this,d=$.Deferred();return $.ajax({type:a,url:cdb.config.prefixUrl()+this.url(),data:{users:b},success:function(){var a=arguments;c.fetch({success:function(){d.resolve.apply(d,a)},error:function(){d.resolve.apply(d,a)}})},error:function(){d.reject.apply(d,arguments)}}),d},totalCount:function(){return this.total_user_entries}}),cdb.admin.Grantable=cdb.core.Model.extend({initialize:function(){this.entity=this._createEntity()},_createEntity:function(){var a=cdb.Utils.capitalize(this.get("type")),b=new cdb.admin[a](this.get("model"));return b.organization=this.collection.organization,b}}),cdb.admin.Grantables=Backbone.Collection.extend({model:cdb.admin.Grantable,url:function(a){var b=cdb.config.urlVersion("organizationGrantables",a);return"/api/"+b+"/organization/"+this.organization.id+"/grantables"},initialize:function(a,b){if(!b.organization)throw new Error("organization is required");this.organization=b.organization,this.currentUserId=b.currentUserId,this.sync=Backbone.syncAbort},parse:function(a){return this.total_entries=a.total_entries,_.reduce(a.grantables,function(a,b){return b.id===this.currentUserId?this.total_entries--:a.push(b),a},[],this)},totalCount:function(){return this.total_entries}}),cdb.admin.Organization=cdb.core.Model.extend({url:"/api/v1/org/",initialize:function(a,b){a=a||{},this.owner=new cdb.admin.User(this.get("owner")),this.display_email="undefined"!=typeof a.admin_email&&null!=a.admin_email&&(""==a.admin_email?this.owner.email:a.admin_email);var c={organization:this,currentUserId:b&&b.currentUserId};this.users=new cdb.admin.Organization.Users(a.users,c),this.groups=new cdb.admin.OrganizationGroups(a.groups,c),this.grantables=new cdb.admin.Grantables(void 0,c),this.users.each(this._setOrganizationOnModel,this),this.groups.each(this._setOrganizationOnModel,this)},_setOrganizationOnModel:function(a){a.organization=this},fetch:function(){throw new Error("organization should not be fetch, should be static")},containsUser:function(a){return!!this.users.find(function(b){return b.id===a.id})},isOrgAdmin:function(a){return this.owner.id===a.id||!!_.find(this.get("admins"),function(b){return b.id===a.id})},viewUrl:function(){return new cdb.common.OrganizationUrl({base_url:this.get("base_url")})}}),cdb.admin.Organization.Users=Backbone.Collection.extend({model:cdb.admin.User,_DEFAULT_EXCLUDE_CURRENT_USER:!0,url:function(){return"/api/v1/organization/"+this.organization.id+"/users"},initialize:function(a,b){if(!b.organization)throw new Error("Organization is needed for fetching organization users");this.elder("initialize"),this.organization=b.organization,this.currentUserId=b.currentUserId,this._excludeCurrentUser=this._DEFAULT_EXCLUDE_CURRENT_USER,this.sync=Backbone.syncAbort},comparator:function(a){return a.get("username")},excludeCurrentUser:function(a){a=!!a,this._excludeCurrentUser=a,a&&!this.currentUserId&&cdb.log.error("set excludeCurrentUser to true, but there is no current user id set to exclude!")},restoreExcludeCurrentUser:function(){this.excludeCurrentUser(this._DEFAULT_EXCLUDE_CURRENT_USER)},parse:function(a){return this.total_entries=a.total_entries,this.total_user_entries=a.total_user_entries,_.reduce(a.users,function(a,b){return this._excludeCurrentUser&&b.id===this.currentUserId?(this.total_user_entries--,this.total_entries--):a.push(b),a},[],this)},totalCount:function(){return this.total_user_entries}}),cdb.admin.Organization.Invites=cdb.core.Model.extend({defaults:{users_emails:[],welcome_text:"I'd like to invite you to my CARTO organization,\nBest regards"},url:function(){return"/api/v1/organization/"+this.organizationId+"/invitations"},initialize:function(a,b){if(!b.organizationId)throw new Error("Organization id is needed for fetching organization users");this.organizationId=b.organizationId}}),cdb.admin.Like=cdb.core.Model.extend({defaults:{likeable:!0},url:function(a){var b=cdb.config.urlVersion("like",a);return"/api/"+b+"/viz/"+this.get("vis_id")+"/like"},initialize:function(){_.bindAll(this,"_onSaveError"),this.on("destroy",function(){this.set({liked:!1,likes:this.get("likes")-1})},this)},_onSaveError:function(a,b){this.trigger("error",{status:b.status,statusText:b.statusText})},toggleLiked:function(){this.get("liked")?this.destroy():(this.set({id:null},{silent:!0}),this.save({},{error:this._onSaveError}))}},{newByVisData:function(a){var b=_.defaults({id:a.liked?a.vis_id:null},_.omit(a,"url")),c=new cdb.admin.Like(b);return a.url&&(c.url=a.url),c}}),cdb.admin.TableSynchronization=cdb.core.Model.extend({_X:1.2,_INTERVAL:1500,_STATES:["created","failure","success","syncing","queued"],defaults:{name:"",url:"",state:"",run_at:0,ran_at:0,retried_times:0,interval:0,error_code:0,error_message:"",service_name:"",service_item_id:"",content_guessing:!0,type_guessing:!0},url:function(a){var b=cdb.config.urlVersion("synchronization",a),c="/api/"+b+"/synchronizations/";return this.isNew()?c:c+this.id},initialize:function(){this.bind("destroy",function(){this.unset("id")})},toJSON:function(){var a=_.clone(this.attributes),b={url:a.url,interval:a.interval,content_guessing:a.content_guessing,type_guessing:a.type_guessing,create_vis:a.create_vis};return"remote"===a.type&&_.extend(b,{remote_visualization_id:a.remote_visualization_id,create_vis:!1,value:a.value}),void 0!==a.id&&(b.id=a.id),a.service_name&&(b.service_name=a.service_name,b.service_item_id=a.service_item_id),b},syncNow:function(a){$.ajax({url:cdb.config.prefixUrl()+this.url()+"/sync_now",type:"PUT"}).always(a)},pollCheck:function(a){function b(){c.destroyCheck(),c.fetch({error:function(a,b){c.set({error_message:b.statusText||"",state:"failure"})}}),d*=c._X,c.pollTimer=setInterval(b,d)}var c=this,d=this._INTERVAL;this.pollTimer=setInterval(b,d)},destroyCheck:function(){clearInterval(this.pollTimer)},isSync:function(){return!this.isNew()},linkToTable:function(a){var b=this;a.has("synchronization")&&this.set(a.get("synchronization")),a.bind("change:synchronization",function(){b.set(a.get("synchronization"))},a),a.bind("destroy",function(){b.unbind(null,null,a),b.destroy()},a)}}),cdb.admin.WKT={types:["POINT","LINESTRING","POLYGON","MULTIPOINT","MULTILINESTRING","MULTIPOLYGON"]},cdb.admin.VisualizationOrder=cdb.core.Model.extend({url:function(a){return this.visualization.url(a)+"/next_id"},initialize:function(){this.visualization=this.get("visualization"),this.set("id",this.visualization.id),this.unset("visualization")}}),cdb.admin.Visualization=cdb.core.Model.extend({defaults:{bindMap:!0},url:function(a){var b=cdb.config.urlVersion("visualization",a),c="/api/"+b+"/viz";return this.isNew()?c:c+"/"+this.id},INHERIT_TABLE_ATTRIBUTES:["name","description","privacy"],initialize:function(){this.map=new cdb.admin.Map,this.permission=new cdb.admin.Permission(this.get("permission")),this.overlays=new cdb.admin.Overlays([]),this.overlays.vis=this,this.initSlides(),this.bind("change:type",this.initSlides),this.transition=new cdb.admin.SlideTransition(this.get("transition_options"),{parse:!0}),this.order=new cdb.admin.VisualizationOrder({visualization:this}),this.like=cdb.admin.Like.newByVisData({vis_id:this.id,liked:this.get("liked"),likes:this.get("likes")}),"derived"===this.get("type")&&this.get("related_tables")&&this.generateRelatedTables(),this.get("bindMap")&&this._bindMap(),this.on(_(this.INHERIT_TABLE_ATTRIBUTES).map(function(a){return"change:"+a}).join(" "),this._changeAttributes,this),this._initBinds()},initSlides:function(){return this.slides?this:("derived"===this.get("type")&&this.get("bindMap")?(this.slides=new cdb.admin.Slides(this.get("children"),{visualization:this}),this.slides.initializeModels()):this.slides=new cdb.admin.Slides([],{visualization:this}),this)},activeSlide:function(a){return a>=0&&a<this.slides.length&&this.slides.setActive(this.slides.at(a)),this},setMaster:function(a){var b=this;a.bind("change:id",function(){b.changeTo(a),b.slides.master_visualization_id=a.id},this),a.bind("change",function(){var c=a.changedAttributes();c.type&&b.set("type",a.get("type")),b.set("description",a.get("description")),c.name&&b.set("name",a.get("name")),c.privacy&&b.set("privacy",a.get("privacy"))})},enableOverlays:function(){this.bind("change:id",this._fetchOverlays,this),this.isNew()||this._fetchOverlays()},_fetchOverlays:function(){this.overlays.fetch({reset:!0})},_initBinds:function(){this.permission.acl.bind("reset",function(){this.set("permission",this.permission.attributes,{silent:!0}),this.trigger("change:permission",this)},this),this.bind("change:permission",function(){this.permission.set(this.get("permission"))},this)},isLoaded:function(){return this.has("privacy")&&this.has("type")},generateRelatedTables:function(a){var b=this.get("related_tables");if(b.length){for(var c=new Backbone.Collection([]),d=0,e=b.length;d<e;d++){var f=new cdb.admin.CartoDBTableMetadata(b[d]);c.add(f)}this.related_tables=c,a&&a.success&&a.success()}},getRelatedTables:function(a,b){if(b=b||{},"derived"===this.get("type")){if(!b.force&&this.get("related_tables"))return void this.generateRelatedTables(a);var c=this;this.fetch({success:function(){c.generateRelatedTables(a)},error:a&&a.error&&a.error})}},tableMetadata:function(){return this._metadata||(this._metadata=new cdb.admin.CartoDBTableMetadata(this.get("table"))),this._metadata},_bindMap:function(){this.on("change:map_id",this._fetchMap,this),this.map.bind("change:id",function(){this.set("map_id",this.map.id)},this),this.map.set("id",this.get("map_id")),this.map.layers.bind("change:id remove",function(){this.getRelatedTables(null,{force:!0})},this)},isVisualization:function(){return"derived"===this.get("type")||"slide"===this.get("type")},changeTo:function(a,b){this.set(a.attributes,{silent:!0}),this.transition.set(a.transition.attributes);var c=function(){this.map.layers.unbind("reset",c),this.map.layers.unbind("error",d),b&&b.success&&b.success(this)},d=function(){this.map.layers.unbind("reset",c),this.map.layers.unbind("error",d),b&&b.error&&b.error()};this.map.layers.bind("reset",c,this),this.map.layers.bind("error",d,this),this.permission.set(a.permission.attributes),this.set({map_id:a.get("map_id")}),this.getRelatedTables()},changeToVisualization:function(a){var b=this;if(this.isVisualization())b.notice("","",1e3);else{var c={success:function(c){b.changeTo(c,a),b.notice("","",1e3)},error:function(c){var d="error changing to visualization";b.error(d,c),a&&a.error(c,d)}};this.copy({name:this.get("name"),description:this.get("description")},c)}return this},parse:function(a){return this.transition&&a.transition_options&&this.transition.set(this.transition.parse(a.transition_options)),this.like&&this.like.set({vis_id:this.id,likes:this.get("likes"),liked:this.get("liked")}),a},toJSON:function(){var a=_.clone(this.attributes);return delete a.bindMap,delete a.stats,delete a.related_tables,delete a.children,a.map_id=this.map.id,a.transition_options=this.transition.toJSON(),a},createChild:function(a,b){a=a||{},b=b||{};var c=new cdb.admin.Visualization(_.extend({copy_overlays:!1,type:"slide",parent_id:this.id},a));return c.save(null,b),c},copy:function(a,b){a=a||{},b=b||{};var c=new cdb.admin.Visualization(_.extend({source_visualization_id:this.id},a));return c.save(null,b),c},_fetchMap:function(){this.map.set("id",this.get("map_id")).fetch()},_changeAttributes:function(a,b){if(!this.isVisualization()){var c=this;this.map.layers.each(function(a){if("cartodb"==a.get("type").toLowerCase()){if(!c.changedAttributes())return!1;var b=_.pick(c.changedAttributes(),c.INHERIT_TABLE_ATTRIBUTES);b&&a.fetch()}})}},publicURL:function(){var a=this.permission.owner.viewUrl();return a+"/viz/"+this.get("id")+"/public_map"},deepInsightsUrl:function(a){var b=a.viewUrl();return b+"/bivisualizations/"+this.get("id")+"/embed_map"},embedURL:function(){var a=this.permission.owner.viewUrl();return a+"/viz/"+this.get("id")+"/embed_map"},vizjsonURL:function(){var a=this.permission.owner.viewUrl(),b=cdb.config.urlVersion("vizjson","read","v2");return a+"/api/"+b+"/viz/"+this.get("id")+"/viz.json"},notice:function(a,b,c){this.trigger("notice",a,b,c)},error:function(a,b){this.trigger("notice",a,"error")},sharedWithEntities:function(){return _.map(this.permission.acl.toArray()||[],function(a){return a.get("entity")})},privacyOptions:function(){return this.isVisualization()?cdb.admin.Visualization.ALL_PRIVACY_OPTIONS:_.reject(cdb.admin.Visualization.ALL_PRIVACY_OPTIONS,function(a){return"PASSWORD"===a})},isOwnedByUser:function(a){return a.equals(this.permission.owner)},viewUrl:function(a){var b=this.permission.owner,c=this.permission.owner.viewUrl();if(this.isVisualization()||_.isUndefined(this.get("type"))){var d=this.get("id");return a&&a.id!==b.id&&this.permission.hasAccess(a)&&(c=a.viewUrl(),d=b.get("username")+"."+d),new cdb.common.MapUrl({base_url:c.urlToPath("viz",d)})}return a&&this.permission.hasAccess(a)&&(c=a.viewUrl()),new cdb.common.DatasetUrl({base_url:c.urlToPath("tables",this.tableMetadata().getUnquotedName())})},_canonicalViewUrl:function(){var a=this.isVisualization()||_.isUndefined(this.get("type")),b=a?cdb.common.MapUrl:cdb.common.DatasetUrl;return new b({base_url:this.get("url")})}},{ALL_PRIVACY_OPTIONS:["PUBLIC","LINK","PRIVATE","PASSWORD"]}),cdb.admin.Visualizations=Backbone.Collection.extend({model:cdb.admin.Visualization,_PREVIEW_TABLES_PER_PAGE:10,_TABLES_PER_PAGE:20,_PREVIEW_ITEMS_PER_PAGE:3,_ITEMS_PER_PAGE:9,initialize:function(){var a=new cdb.core.Model({tag_name:"",q:"",page:1,type:"derived",exclude_shared:!1,per_page:this._ITEMS_PER_PAGE});this.sync=Backbone.syncAbort,this.options=_.extend(a,this.options),this.total_entries=0,this.options.bind("change",this._changeOptions,this),this.bind("reset",this._checkPage,this),this.bind("update",this._checkPage,this),this.bind("add",this._fetchAgain,this)},getTotalPages:function(){return Math.ceil(this.total_entries/this.options.get("per_page"))},_checkPage:function(){var a=this.getTotalPages();this.options.get("page")-1;this.options.get("page")>a?this.options.set({page:a+1}):this.options.get("page")<1&&this.options.set({page:1})},_createUrlOptions:function(){return _.compact(_(this.options.attributes).map(function(a,b){return b+"="+encodeURIComponent(a)})).join("&")},url:function(a){var b="";if(this.options.get("deepInsights"))b+="/api/v1/bivisualizations",b+="?page="+this.options.get("page")+"&per_page="+this.options.get("per_page");else{var c=cdb.config.urlVersion("visualizations",a);b+="/api/"+c+"/viz/",b+="?"+this._createUrlOptions()}return b},remove:function(a){this.total_entries--,this.elder("remove",a)},parse:function(a){return this.total_entries=a.total_entries,this.slides&&this.slides.reset(a.children),this.total_shared=a.total_shared,this.total_likes=a.total_likes,this.total_user_entries=a.total_user_entries,_.map(a.visualizations,function(a){return a.bindMap=!1,a})},_changeOptions:function(){},create:function(a){var b=$.Deferred();return Backbone.Collection.prototype.create.call(this,a,{wait:!0,success:function(){b.resolve()},error:function(){b.reject()}}),b.promise()},fetch:function(a){var b=$.Deferred(),c=this;return this.trigger("loading",this),$.when(Backbone.Collection.prototype.fetch.call(this,a)).done(function(a){c.trigger("loaded"),b.resolve()}).fail(function(a){c.trigger("loadFailed"),b.reject(a)}),b.promise()}}),cdb.ui.common.TabPane=cdb.core.View.extend({initialize:function(){this.tabs={},this.activeTab=null,this.activePane=null},addTab:function(a,b,c){if(c=c||{active:!0},void 0!==this.tabs[a])cdb.log.debug(a+"already added");else{if(this.tabs[a]=b.cid,this.addView(b),void 0!==c.after){var d=this.$el.children()[c.after];b.$el.insertAfter(d)}else c.prepend?this.$el.prepend(b.el):this.$el.append(b.el);this.trigger("tabAdded",a,b),c.active?this.active(a):b.hide()}},getPreviousPane:function(){var a=_.toArray(this.tabs),b=_.toArray(this._subviews),c=_.indexOf(a,this.activePane.cid)-1;return c<0&&(c=b.length-1),b[c]},getNextPane:function(){
var a=_.toArray(this.tabs),b=_.toArray(this._subviews),c=1+_.indexOf(a,this.activePane.cid);return c>b.length-1&&(c=0),b[c]},getPane:function(a){var b=this.tabs[a];return this._subviews[b]},getActivePane:function(){return this.activePane},size:function(){return _.size(this.tabs)},clean:function(){this.removeTabs(),cdb.core.View.prototype.clean.call(this)},removeTab:function(a){if(void 0!==this.tabs[a]){var b=this.tabs[a];this._subviews[b].clean(),delete this.tabs[a],this.activeTab==a&&(this.activeTab=null),_.size(this.tabs)&&this.active(_.keys(this.tabs)[0])}},removeTabs:function(){for(var a in this.tabs){var b=this.tabs[a];this._subviews[b].clean(),delete this.tabs[a]}this.activeTab=null},active:function(a){var b=this,c=this.tabs[a];if(void 0!==c){if(this.activeTab!==a){var d=this._subviews[c];if(this.activeTab){var e=this._subviews[this.tabs[this.activeTab]];e.hide(),b.trigger("tabDisabled",this.activeTab,e),b.trigger("tabDisabled:"+this.activeTab,e),e.deactivated&&e.deactivated()}d.show(),d.activated&&d.activated(),this.activeTab=a,this.activePane=d,b.trigger("tabEnabled",a,d),b.trigger("tabEnabled:"+a,d)}return this.activePane}},render:function(){return this},each:function(a){var b=this;_.each(this.tabs,function(c,d){a(d,b.getPane(d))})}}),cdb.admin.DropdownMenu=cdb.ui.common.Dropdown.extend({show:function(){var a=$.Deferred(),b=this;return this.delegateEvents(),this.$el.css({marginTop:"down"==b.options.vertical_position?"-10px":"10px",opacity:0,display:"block"}).animate({margin:"0",opacity:1},{duration:this.options.speedIn,complete:function(){a.resolve()}}),this.trigger("onDropdownShown",this.el),a.promise()},openAt:function(a,b){var c=$.Deferred();return this.$el.css({top:b,left:a,width:this.options.width}).addClass(("up"==this.options.vertical_position?"vertical_top":"vertical_bottom")+" "+("right"==this.options.horizontal_position?"horizontal_right":"horizontal_left")+" tick_"+this.options.tick),this.isOpen=!0,$.when(this.show()).done(function(){c.resolve()}),c.promise()},hide:function(a){if(!this.isOpen)return void(a&&a());var b=this;this.isOpen=!1,this.$el.animate({marginTop:"down"==b.options.vertical_position?"10px":"-10px",opacity:0},this.options.speedOut,function(){$(b.options.target).removeClass("selected"),b.$el.hide(),a&&a(),b.trigger("onDropdownHidden",b.el)})}}),cdb.admin.StringField=cdb.core.View.extend({tagName:"div",className:"field string",default_options:{template_name:"old_common/views/forms/string_field",label:!1,autoResize:!0,readOnly:!1},events:{"change textarea":"_onChange","keydown textarea":"_onKeyDown"},initialize:function(){_.defaults(this.options,this.default_options),_.bindAll(this,"_onChange","_onKeyDown"),this.template_base=this.options.template_base?_.template(this.options.template_base):cdb.templates.getTemplate(this.options.template_name),this.valid=!0,this._setOS()},render:function(){return this.$el.html(this.template_base(_.extend(this.model.toJSON(),this.options))),this.options.readOnly&&this.undelegateEvents(),this.options.autoResize&&this._resize(),this},_setOS:function(){var a=navigator.userAgent.toLowerCase();this.so="rest",/mac os/.test(a)&&(this.so="mac")},isValid:function(){return this.valid},_onChange:function(a){var b=$(a.target).val();this.model.set("value",b)},_onKeyDown:function(a){if(("mac"==this.so&&a.metaKey||"rest"==this.so&&a.ctrlKey)&&13==a.keyCode)return a.preventDefault(),this._triggerEvent("ENTER"),!1;var b=$(a.target).val();this.model.set("value",b),this.options.autoResize&&this._resize()},_resize:function(){var a=this.$("textarea");a&&setTimeout(function(){a.height(20),a.height(a[0].scrollHeight-22)})},_triggerEvent:function(a,b){this.trigger(a,b,this)}}),cdb.forms.Color=cdb.core.View.extend({className:"form-view form_color",events:{"click .image-picker":"_openImagePicker","click .color-picker":"_openColorPicker"},initialize:function(){this.template=cdb.templates.getTemplate("old_common/views/color_form"),this.property=this.options.property,this.model.bind("change",this.render,this),this.image_property=this.options.extra?this.options.extra.image_property:null,this.image_kind=this.options.extra?this.options.extra.image_kind:null,this.image_kind=this.image_kind||"marker"},render:function(){return this.$el.html(this.template({image_kind:this.image_kind,image_property:this.image_property,image_value:this.model.get(this.image_property),color:this.model.get(this.property)})),this.image_property&&this._createTooltips(),this},_createTooltips:function(){this.addView(new cdb.common.TipsyTooltip({el:this.$(".image-picker"),delayIn:100}))},_createPicker:function(){var a,b,c;this.options.extra&&(this.options.extra.tick&&(a=this.options.extra.tick),this.options.extra.picker_vertical_position&&(b=this.options.extra.picker_vertical_position),this.options.extra.picker_horizontal_position&&(c=this.options.extra.picker_horizontal_position)),this.color_picker=new cdb.admin.ColorPicker({target:this.$el,colors:this.options.colors,extra_colors:this.options.extra_colors,tick:a,vertical_position:b,horizontal_position:c}).bind("colorChosen",function(a,b){this.image_property==this.property?this.model.set(this.property,a):(this.model.unset(this.image_property,{silent:!0}),this.model.set(this.property,a)),b&&this._destroyPicker()},this),this._bindColorPicker(),this.addView(this.color_picker)},_destroyPicker:function(){this.color_picker&&(this._unbindColorPicker(),this.removeView(this.color_picker),this.color_picker.hide(),delete this.color_picker)},_bindColorPicker:function(){cdb.god.bind("closeDialogs",this._destroyPicker,this),cdb.god.bind("closeDialogs:color",this._destroyPicker,this)},_unbindColorPicker:function(){cdb.god.unbind("closeDialogs",this._destroyPicker,this),cdb.god.unbind("closeDialogs:color",this._destroyPicker,this)},setExtraColors:function(a){this.color_picker&&this.color_picker.setColors("extra_colors",a)},setColors:function(a){this.color_picker&&this.color_picker.setColors("colors",a)},_openImagePicker:function(a){if(this.killEvent(a),!this.image_property)return this;cdb.god.trigger("closeDialogs:color"),this.user=new cdb.admin.User(window.user_data);var b=new cdb.editor.ImagePickerView({user:this.user,kind:this.image_kind});b.appendToBody(),b.bind("fileChosen",this._onImageFileChosen,this)},_onImageFileChosen:function(a){this.image_property&&(this.image_property!==this.property&&this.model.unset(this.property,{silent:!0}),this.model.set(this.image_property,"url("+a+")"))},_openColorPicker:function(a){this.killEvent(a),this.color_picker&&this._destroyPicker(),cdb.god.trigger("closeDialogs:color"),this.color_picker||(this._createPicker(),$("body").append(this.color_picker.render().el),this.color_picker.init(this.model.get(this.property)))}}),cdb.forms.ColorWizard=cdb.forms.Color.extend({_createPicker:function(){if(this.model.layer&&this.model.layer.get("tile_style")){var a=this.model.layer.get("tile_style"),b=new cdb.admin.CartoParser(a);this.options.extra_colors=b.colorsUsed({mode:"hex"})}cdb.forms.Color.prototype._createPicker.call(this)}}),cdb.forms.Hidden=cdb.core.View.extend({className:"form-view form_hidden",initialize:function(){this.add_related_model(this.model)}}),cdb.forms.SimpleNumber=cdb.core.View.extend({className:"form-view form_spinner",defaults:{max:999999999999,min:-999999999999,inc:1,width:25,pattern:/^-?[0-9]+\.?[0-9]*$/,debounce_time:200,disable_triggering:!1},events:{"click .plus":"_plus","click .minus":"_minus","keypress input.value":"_checkInputPress","keydown input.value":"_checkInputPress","keyup input.value":"_checkInputUp","change .value":"_checkValueChange",click:"_showSlider"},initialize:function(){_.bindAll(this,"_fireChange","_checkNumber"),this.property=this.options.property,this.model.bind("change",this.render,this),this.options.pattern&&"object"==typeof this.options.pattern&&("object"!=typeof this.options.pattern||this.options.pattern.test)||delete this.options.pattern,_.defaults(this.options,this.defaults),this.options.noSlider||this._initSlider(),this.options.debounce_time>0&&(this._fireChange=_.debounce(this._fireChange,this.options.debounce_time))},render:function(a){var b=this.options.initValue||this.model.get(this.property);return a&&_.isNumber(a)&&(b=a),this.$el.html('<input class="value" '+(this.options.disabled?"readonly":"")+' value="" style="width:'+this.options.width+'px!important"/><a href="#" class="plus">+</a><a href="#" class="minus">-</a>'),this.$(".value").val(b),this.options.classes&&this.$el.addClass(this.options.classes),this.options.disabled&&(this.undelegateEvents(),this.$el.addClass("disabled").find("a").bind("click",this.killEvent)),this},_fireChange:function(){this.model.change()},_changeValue:function(a){this.model.set(a,{silent:!0}),this._fireChange()},inc:function(a){var b={},c=b[this.property]=parseFloat(this.model.get(this.property))+a;c=b[this.property]=Math.min(this.options.max,c.toFixed?c.toFixed(1):1*c),b[this.property]=Math.max(this.options.min,c),this._changeValue(b),this.render(b[this.property])},_plus:function(a){return a&&a.preventDefault(),this.trigger("saved",this),this.inc(this.options.inc),!1},_minus:function(a){return a&&a.preventDefault(),this.trigger("saved",this),this.inc(-this.options.inc),!1},_initSlider:function(){var a=this;this.spinner_slider=new cdb.admin.SpinnerSlider({target:this.$el,template_base:"old_common/views/spinner_slider"}).bind("valueSet",function(b){var c={};c[a.property]=b,a.model.set(c)}).bind("valueChanged",function(b){a.$el.find(".value").val(b)}),this.addView(this.spinner_slider)},_checkNumber:function(a){return this.options.pattern.test(a)},_checkInputPress:function(a){var b=String.fromCharCode(a.charCode);return"-"==b||"."==b||1*b!==NaN||(a.preventDefault(),a.stopPropagation(),!1)},_checkInputUp:function(a){this.value?null:this.value=this.model.get(this.property);var b=$(a.target).val();return 40==a.keyCode?(a.preventDefault(),a.stopPropagation(),this.inc(-this.options.inc),this._saveValue(a),this.$el.find("input").focus(),!1):38==a.keyCode?(a.preventDefault(),a.stopPropagation(),this.inc(this.options.inc),this._saveValue(a),this.$el.find("input").focus(),!1):13===a.keyCode?(this._saveValue(a,!0),!1):(this._checkNumber(b)||"-"==b||""==b?"-"!=b&&""!=b&&(this.value=$(a.target).val()):this.$el.find("input.value").val(this.value),!0)},_checkValueChange:function(a){var b=$(a.target).val();return b=""==b||"-"==b?0:1*b,this._checkNumber(b)?(this._saveValue(a,!0),this.value=$(a.target).val()):this.$el.find("input.value").val(this.value),!0},_saveValue:function(a,b){var c={},d=this.$el.find("input.value").val(),e=this.options.min<0&&this.options.max>0?0:this.options.min,f=""==d||"-"==d?e:1*d;f<this.options.min&&(f=this.options.min),f>this.options.max&&(f=this.options.max),this.$el.find("input.value").val(f),c[this.property]=f,this.model.set(c),this.trigger("saved",this),b&&!this.options.disable_triggering&&cdb.god.trigger("closeDialogs")},_showSlider:function(a){a.preventDefault(),a.stopPropagation(),this.$el.find("input").focus()}}),cdb.forms.SimpleNumberWithLabel=cdb.forms.SimpleNumber.extend({className:"form-view form_spinner with-label",render:function(a){var b=this.options.initValue||this.model.get(this.property);return a&&_.isNumber(a)&&(b=a),this.$el.html(this.getTemplate("old_common/forms/widget_simple_number_with_label")({label:this.options.label,isDisabled:this.options.disabled,width:this.options.width})),this.$(".value").val(b),this.options.classes&&this.$el.addClass(this.options.classes),this.options.disabled&&(this.undelegateEvents(),this.$el.addClass("disabled").find("a").bind("click",this.killEvent)),this}}),cdb.forms.Spinner=cdb.core.View.extend({className:"form-view form_spinner",defaults:{max:999999999999,min:-999999999999,inc:1,width:25,pattern:/^-?[0-9]+\.?[0-9]*$/,debounce_time:200},events:{"click .plus":"_plus","click .minus":"_minus","keypress input.value":"_checkInputPress","keydown input.value":"_checkInputPress","keyup input.value":"_checkInputUp","change .value":"_checkValueChange",click:"_showSlider"},initialize:function(){_.bindAll(this,"_fireChange","_checkNumber"),this.property=this.options.property,this.model.bind("change",this.render,this),this.options.pattern&&"object"==typeof this.options.pattern&&("object"!=typeof this.options.pattern||this.options.pattern.test)||delete this.options.pattern,_.defaults(this.options,this.defaults),this.options.noSlider||this._initSlider(),this.options.debounce_time>0&&(this._fireChange=_.debounce(this._fireChange,this.options.debounce_time))},render:function(a){var b=this.options.initValue||this.model.get(this.property);return a&&_.isNumber(a)&&(b=a),this.$el.html('<input class="value" '+(this.options.disabled?"readonly":"")+' value="" style="width:'+this.options.width+'px!important"/><a href="#" class="plus">+</a><a href="#" class="minus">-</a>'),this.$(".value").val(b),this.options.disabled&&(this.undelegateEvents(),this.$el.addClass("disabled").find("a").bind("click",this.killEvent)),this},_fireChange:function(){this.model.change()},_changeValue:function(a){this.model.set(a,{silent:!0}),this._fireChange()},inc:function(a){var b={},c=b[this.property]=this.model.get(this.property)+a;c=b[this.property]=Math.min(this.options.max,c.toFixed?c.toFixed(1):1*c),b[this.property]=Math.max(this.options.min,c),this._changeValue(b),this.render(b[this.property])},_plus:function(a){return a&&a.preventDefault(),this.inc(this.options.inc),!1},_minus:function(a){return a&&a.preventDefault(),this.inc(-this.options.inc),!1},_initSlider:function(){var a=this;this.spinner_slider=new cdb.admin.SpinnerSlider({target:this.$el,template_base:"old_common/views/spinner_slider"}).bind("valueSet",function(b){var c={};c[a.property]=b,a.model.set(c)}).bind("valueChanged",function(b){a.$el.find(".value").val(b)}),this.addView(this.spinner_slider)},_checkNumber:function(a){return this.options.pattern.test(a)},_checkInputPress:function(a){var b=String.fromCharCode(a.charCode);return"-"==b||"."==b||1*b!==NaN||(a.preventDefault(),a.stopPropagation(),!1)},_checkInputUp:function(a){this.value?null:this.value=this.model.get(this.property);var b=$(a.target).val();return 13===a.keyCode?(this._saveValue(a),!1):(this._checkNumber(b)||"-"==b||""==b?"-"!=b&&""!=b&&(this.value=$(a.target).val()):this.$el.find("input.value").val(this.value),!0)},_checkValueChange:function(a){var b=$(a.target).val();return b=""==b||"-"==b?0:1*b,this._checkNumber(b)?(this._saveValue(a),this.value=$(a.target).val()):this.$el.find("input.value").val(this.value),!0},_saveValue:function(a){var b={},c=this.$el.find("input.value").val(),d=this.options.min<0&&this.options.max>0?0:this.options.min,e=""==c||"-"==c?d:1*c;this.$el.find("input.value").val(e),b[this.property]=e,this.model.set(b),cdb.god.trigger("closeDialogs")},_showSlider:function(a){this.options.noSlider||(a.stopPropagation(),cdb.god.unbind("closeDialogs",this.spinner_slider.hide,this.spinner_slider),cdb.god.trigger("closeDialogs"),this.spinner_slider.el.parentElement||($("body").append(this.spinner_slider.render().el),this.spinner_slider.init(this.options.max,this.options.min,this.options.inc,this.$el.find("input.value").val()),cdb.god.bind("closeDialogs",this.spinner_slider.hide,this.spinner_slider),cdb.god.bind("closeDialogs:color",this.spinner_slider.hide,this.spinner_slider)),this.$el.find("input.value").focus())}}),cdb.forms.Opacity=cdb.forms.Spinner.extend({initialize:function(){_.defaults(this.options,{max:1,min:0,inc:.1}),this.$el.addClass("opacity"),cdb.forms.Spinner.prototype.initialize.call(this)}}),cdb.forms.SimpleOpacity=cdb.forms.SimpleNumber.extend({initialize:function(){_.defaults(this.options,{max:1,min:0,inc:.1}),this.$el.addClass("opacity"),cdb.forms.Spinner.prototype.initialize.call(this)}}),cdb.forms.OpacityPolygon=cdb.forms.Spinner.extend({initialize:function(){_.defaults(this.options,{max:1,min:0,inc:.1}),this.$el.addClass("opacity"),this.model.bind("change",function(){this.switchProperty()},this),cdb.forms.Spinner.prototype.initialize.call(this)},switchProperty:function(){if(this.model.get("polygon-pattern-file")){if(!this.originalProperty){this.originalProperty=this.property,this.property="polygon-pattern-opacity";var a=this.model.get(this.property);this.model.set(this.property,void 0===a?this.model.get(this.originalProperty):a),this.model.unset(this.originalProperty)}}else"polygon-pattern-opacity"===this.property&&(this.property=this.originalProperty,this.originalProperty=null,this.model.set(this.property,this.model.get("polygon-pattern-opacity")),this.model.unset("polygon-pattern-opacity"))}}),cdb.forms.Width=cdb.forms.Spinner.extend({initialize:function(){_.defaults(this.options,{max:40,min:0,inc:.5}),cdb.forms.Spinner.prototype.initialize.call(this)}}),cdb.forms.Combo=cdb.core.View.extend({className:"form-view form_combo",options:{minimumResultsForSearch:20,placeholder:"",formatResult:!1,formatSelection:!1,matcher:!1,dropdownCssClass:""},events:{"change select":"_changeSelection"},initialize:function(){_.bindAll(this,"_onUpdate","_changeSelection"),this.data=this.options.extra,this.model&&(this.add_related_model(this.model),this.model.bind("change:"+this.options.property,this._onUpdate,this))},deselect:function(){this.$el.find("select").val("").change()},updateData:function(a){this.data=a,this._onUpdate()},_onUpdate:function(){this.render()},_getOptions:function(){var a=_.map(this.data,function(a){return _.isArray(a)?'<option value="'+a[1]+'">'+a[0]+"</option>":"<option>"+a+"</option>"}).join("");return this.options.placeholder&&(a="<option></option>"+a),a},_setValue:function(a){this.$select.val(a)},render:function(){this.$select=$("<select>"+this._getOptions()+"</select>");var a=this.model&&this.model.get("method")&&this.model.get("method").replace(/ /g,"_").toLowerCase();if(this.$select.attr({style:this.options.width?"width:"+this.options.width:""}),this.$select.addClass(this.options.property+(a?" "+a:"")),this.options.disabled&&this.$select.attr("disabled",""),this._setValue(this.model&&this.model.get(this.options.property)||this.options.property),this.$el.html(this.$select),!this.options||!this.options.plainSelect){var b=this.$("select");b.select2("destroy");var c={minimumResultsForSearch:this.options.minimumResultsForSearch,placeholder:this.options.placeholder,dropdownCssClass:this.options.dropdownCssClass};this.options.formatResult&&(c.formatResult=this._formatResult),this.options.formatSelection&&(c.formatSelection=this._formatSelection),this.options.matcher&&(c.matcher=this._matcher),b.select2(c)}return this},_changeSelection:function(a){var b={},c=this.$("select").val();b[this.options.property]=c,this.model&&(c?this.model.set(b):this.model.set(b,{silent:!0})),c&&this.trigger("change",b[this.options.property])},_formatResult:function(a){return a.id||a.text},_matcher:function(a,b,c){return b.toUpperCase().indexOf(a.toUpperCase())>=0},clean:function(){this.$select.select2("destroy"),cdb.core.View.prototype.clean.call(this)}}),cdb.forms.Switch=cdb.core.View.extend({events:{click:"_onClick"},tagName:"a",className:"form-view form_switch",initialize:function(){this.property=this.options.property,this.model.bind("change:"+this.property,this._change,this)},_onClick:function(a){if(a.preventDefault(),!this.$el.hasClass("inactive")){var b={},c=!this.model.get(this.property);b[this.property]=c,this.model.set(b),this.trigger("switched",this.property,c)}return!1},_change:function(){this.model.get(this.property)?this.$el.removeClass("disabled").addClass("enabled"):this.$el.removeClass("enabled").addClass("disabled")},render:function(){return this.$el.append("<span class='handle'></span>"),this._change(),this}}),cdb.forms.TextAlign=cdb.core.View.extend({className:"form-view form_align",defaults:{debounce_time:200},events:{"click .align":"_align"},initialize:function(){_.bindAll(this,"_fireChange"),this.property=this.options.property,this.template=cdb.templates.getTemplate("old_common/views/text_align"),this.model.bind("change",this.render,this),this.options.pattern&&"object"==typeof this.options.pattern&&("object"!=typeof this.options.pattern||this.options.pattern.test)||delete this.options.pattern,_.defaults(this.options,this.defaults),this.options.debounce_time>0&&(this._fireChange=_.debounce(this._fireChange,this.options.debounce_time))},_fireChange:function(){this.model.change()},_align:function(a){a&&a.preventDefault();var b=$(a.target).attr("data-align"),c={};c[this.property]=b,this.model.set(c,{silent:!0}),this._fireChange()},render:function(a){var b=this.options.initValue||this.model.get(this.property),c=this.options.alignments||{},d=void 0===c.left||c.left,e=void 0===c.right||c.right,f=void 0===c.center||c.center;return this.$el.html(this.template({left:d,right:e,center:f})),this.$el.find("a[data-align='"+b+"']").addClass("selected"),this.options.disabled&&(this.undelegateEvents(),this.$el.addClass("disabled").find("a").bind("click",this.killEvent)),this}}),cdb.common.Url=cdb.core.Model.extend({initialize:function(a){if(!a.base_url)throw new Error("base_url is required")},urlToPath:function(){return cdb.common.Url.byBaseUrl(this.toString.apply(this,arguments))},pathname:function(){return this.toString().match(/^.+\/\/[^\/]+(.*)$/)[1]},toString:function(){return this._joinArgumentsWithSlashes(this.get("base_url"),Array.prototype.slice.call(arguments,0))},_joinArgumentsWithSlashes:function(){return _.chain(arguments).flatten().compact().value().join("/")}},{byBaseUrl:function(a){return new cdb.common.Url({base_url:a})}}),cdb.common.DashboardVisUrl=cdb.common.Url.extend({lockedItems:function(){return this.urlToPath("locked")},sharedItems:function(){return this.urlToPath("shared")},likedItems:function(){return this.urlToPath("liked")}}),cdb.admin.CustomScrolls=cdb.core.View.extend({events:{scroll:"checkScroll"},initialize:function(){var a=this;this.render(),this.timeout=setTimeout(function(){a.checkScroll()},300)},render:function(){return this.options.parent.append('<span class="top scroll"></span><span class="bottom scroll"></span>'),this},checkScroll:function(a){var b=this.$el.outerHeight(),c=this.$el[0].scrollTop,d=(this.$el[0].scrollLeft,this.$el[0].scrollHeight-b),e=this.options.parent,f=e.find("span.top"),g=e.find("span.bottom");0==c?f.hide():f.show(),c==d?g.hide():g.show()}}),cdb.admin.ErrorStats=cdb.core.Model.extend({defaults:{name:"trackJs",people:"configure",template:"old_common/views/trackjs",enable_logs:!1},initialize:function(a){a&&a.user_data&&(this.user_data=a.user_data),window[this.get("name")]&&this._setService()},_setService:function(){if(this.get("people")&&this.user_data){var a=cdb.templates.getTemplate(this.get("template"));window[this.get("name")][this.get("people")](JSON.parse(a(this.user_data)))}this.get("enable_logs")&&(cdb.log=window[this.get("name")])}}),cdb.admin.BooleanField=cdb.admin.StringField.extend({className:"field boolean",default_options:{template_name:"old_common/views/forms/boolean_field",label:!1,readOnly:!1},events:{"click a.radiobutton":"_onChange"},_onChange:function(a){a.preventDefault();var b=$(a.target).closest("a.radiobutton"),c=b.text().toLowerCase();this.model.get("value")!=c&&(this.model.set("value",c),this._setSelected(b))},_setSelected:function(a){this.$("a.selected").removeClass("selected"),a.addClass("selected")},_resize:function(){},_triggerEvent:function(a,b){this.trigger(a,b,this)}}),cdb.admin.ColorPicker=cdb.admin.DropdownMenu.extend({className:"CDB-Text dropdown color_picker border",_PICKER_DELAY:800,_COLORS:["#136400","#229A00","#B81609","#D6301D","#F84F40","#41006D","#7B00B4","#A53ED5","#2E5387","#3E7BB6","#5CA2D1","#FF6600","#FF9900","#FFCC00","#FFFFFF","#012700","#055D00","#850200","#B40903","#F11810","#11002F","#3B007F","#6B0FB2","#081B47","#0F3B82","#2167AB","#FF2900","#FF5C00","#FFA300","#000000"],default_options:{width:197,speedIn:150,speedOut:300,vertical_position:"up",horizontal_position:"right",horizontal_offset:5,vertical_offset:0,tick:"right",dragUpdate:!1,template_base:"old_common/views/color_picker"},events:{"click a.advanced":"_openAdvanced","click .default-colors li a":"_clickedColor","keyup input.text":"_checkColor","change input.text":"_checkColor","submit form":"_submitColor",click:"stopPropagation"},initialize:function(){cdb.admin.DropdownMenu.prototype.initialize.call(this),this.model=new cdb.core.Model({visible:!1,colors:this._COLORS,extra_colors:this.options.extra_colors,color:""}),this.options.target&&$(this.options.target).off("click",this._handleClick),this._initBinds()},_initBinds:function(){_.bindAll(this,"open","hide","_handleClick","_keydown","_openAdvanced","_setPicker","_setColor","_onPickerMouseMove","_onPickerMouseUp","_submitColor"),this.model.bind("change:colors change:extra_colors change:color",this.render,this)},render:function(){var a=this.model.toJSON(),b=this;return a.extra_colors&&(a.extra_colors=_.filter(_.uniq(this.options.extra_colors),function(a){return!_.contains(b._COLORS,a.toUpperCase())})),this.$el.html(this.template_base(a)).css({width:this.options.width}),ColorPicker.fixIndicators(this.$(".slider-indicator").get(0),this.$(".picker-indicator").get(0)),this.color_picker=ColorPicker(this.$(".slider").get(0),this.$(".picker").get(0),this._setPicker),this},stopPropagation:function(a){a.stopPropagation()},_checkColor:function(a){a.preventDefault();var b=new RGBColor(this.$("input.text").val());b.ok?(this.$("input.text").removeClass("error"),this.$("form > span.color").css("background",b.toHex())):this.$("input.text").addClass("error")},setColors:function(a,b){return a&&b?void this.model.set(a,b):(cdb.log.info("No attribute or value for color picker model"),!1)},init:function(a){a=a||"#FFFFFF",this.model.set("color",a),this._setColor(a),this.open()},_clickedColor:function(a){a.preventDefault();var b=$(a.target).attr("href");this._triggerColor(b,!0),this.hide()},_setPicker:function(a,b,c,d,e){this._setColor(a),ColorPicker.positionIndicators(this.$(".slider-indicator").get(0),this.$(".picker-indicator").get(0),e,d)},_setColor:function(a){this.$("form > span.color").css("background",a),this.$("input.text").val(a)},_submitColor:function(a){a&&a.preventDefault();var b=new RGBColor(this.$("input.text").val());b.ok&&(this._triggerColor(b.toHex(),!0),this.hide())},_onPickerMouseMove:function(){if(this.options.dragUpdate){var a=new RGBColor(this.$("input.text").val());a.ok&&this._triggerColor(a.toHex(),!1)}},_onPickerMouseUp:function(){var a=new RGBColor(this.$("input.text").val());a.ok&&this._triggerColor(a.toHex(),!1)},_bindAdvancedPicker:function(){this.$(".slider").bind("mousemove",this._onPickerMouseMove),this.$(".picker").bind("mousemove",this._onPickerMouseMove),this.$(".picker").bind("mouseup",this._onPickerMouseUp),this.$(".slider").bind("mouseup",this._onPickerMouseUp)},_destroyAdvancedPicker:function(){this.$(".slider").unbind("mousemove",this._onPickerMouseMove),this.$(".picker").unbind("mousemove",this._onPickerMouseMove),this.$(".picker").unbind("mouseup",this._onPickerMouseUp),this.$(".slider").unbind("mouseup",this._onPickerMouseUp)},_openAdvanced:function(a){a&&a.preventDefault(),this._bindAdvancedPicker(),this.$("div.top").addClass("advanced"),this.positionate(a);var b=new RGBColor(this.$("input.text").val());b.ok&&this.color_picker.setHex(b.toHex())},_triggerColor:function(a,b){this.trigger("colorChosen",a,b,this.el)},positionate:function(a,b){var c=this.options.target,d=c[this.options.position||"offset"](),e=c.outerWidth(),f=c.outerHeight(),g=this.$el.outerWidth(),h=this.$el.outerHeight();this.$el.css({top:d.top+parseInt("up"==this.options.vertical_position?-h-10-this.options.vertical_offset:f+10-this.options.vertical_offset),left:d.left+parseInt("left"==this.options.horizontal_position?this.options.horizontal_offset-15:e-g+15-this.options.horizontal_offset)}).addClass(("up"==this.options.vertical_position?"vertical_top":"vertical_bottom")+" "+("right"==this.options.horizontal_position?"horizontal_right":"horizontal_left")+" tick_"+this.options.tick)},open:function(a,b){b&&$(b)||this.options.target;this.positionate(a,b),this.show(),this.model.set("visible",!0)},hide:function(a){var b=this;this.$el.animate({marginTop:"down"==b.options.vertical_position?"10px":"-10px",opacity:0},this.options.speedOut,function(){$(b.options.target).removeClass("selected"),b.clean()}),this.model.set("visible",!1)},clean:function(){this.color_picker&&this.color_picker.unBind(),this.options.target&&$(this.options.target).unbind("click",this._handleClick),cdb.admin.DropdownMenu.prototype.clean.call(this)}}),cdb.admin.DateField=cdb.admin.StringField.extend({className:"field date",timezone:"00:00",default_options:{template_name:"old_common/views/forms/date_field",label:!1,readOnly:!1},events:{"change input.time":"_onChange","keyup input.time":"_onKeyUp"},initialize:function(){_.defaults(this.options,this.default_options),_.bindAll(this,"_onChange","_onKeyUp","_onChangeModel"),this.template_base=this.options.template_base?_.template(this.options.template_base):cdb.templates.getTemplate(this.options.template_name);var a=this._splitDate(this.model.get("value"));this.timezone=this._getTimeZone(this.model.get("value")),this.date_model=new cdb.core.Model,this.valid=!0,this.date_model.bind("change",this._onChangeModel),this.date_model.set(a),this.bind("clean",this._reClean)},render:function(){return this.$el.html(this.template_base(_.extend(this.model.toJSON(),this.options))),this._initViews(),this.options.readOnly&&this.undelegateEvents(),this},_initViews:function(){var a=this.days=new cdb.forms.Spinner({el:this.$el.find("div.day"),model:this.date_model,disabled:this.options.readOnly,property:"day",min:1,max:31,inc:1,width:15,noSlider:!0,pattern:/^([12]?\d{0,1}|3[01]{0,2})$/});this.addView(this.days),this.$("div.day").append(a.render());var b=this.years=new cdb.forms.Spinner({el:this.$el.find("div.year"),model:this.date_model,disabled:this.options.readOnly,property:"year",min:1900,max:2100,width:28,noSlider:!0,pattern:/^([0-9]{0,4})$/});this.addView(this.years),this.$("div.year").append(b.render());var c=this.months=new cdb.forms.Combo({el:this.$el.find("div.month"),model:this.date_model,disabled:this.options.readOnly,property:"month",width:"140px",extra:[["January",1],["February",2],["March",3],["April",4],["May",5],["June",6],["July",7],["August",8],["September",9],["October",10],["November",11],["December",12]]});this.addView(this.months),this.$("div.month").append(c.render()),this.$("input.time").val(this.date_model.get("time"))},_getTimeZone:function(a){if(a){var b=a.match(/\+(.*)$/);if(b&&2==b.length)return b[1]}return this.timezone},_splitDate:function(a){var b={},c=new Date,d=c.getDate(),e=c.getMonth()+1,f=c.getFullYear(),g=c.getHours()+":"+c.getMinutes()+":"+c.getSeconds();if(""==a)b.day=d,b.month=e,b.year=f,b.time=g;else try{var h=a.split("T");if(h.length>1){var i=h[0].split("-");b.time=h[1].substr(0,8),b.day=parseInt(i[2]),b.month=parseInt(i[1]),b.year=parseInt(i[0])}else b.day=d,b.month=e,b.year=f,b.time=g}catch(a){b.day=d,b.month=e,b.year=f,b.time=g}return b},_toDate:function(a){return a.year+"-"+a.month+"-"+a.day+"T"+a.time+"+"+this.timezone},_checkTime:function(a){var b=/^([01]{1}[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/;return!!b.test(a)},_onChange:function(a){var b=this.$("input.time").val();this._checkTime(b)&&this.date_model.set("time",b)},_onChangeModel:function(a){this.model.set("value",this._toDate(this.date_model.toJSON()))},_onKeyDown:function(){},_onKeyUp:function(a){var b=$(a.target).val();if(this._checkTime(b)){if(13===a.keyCode)return a.preventDefault(),this._triggerEvent("ENTER"),!1;this.valid=!0,this.date_model.set("time",b),$(a.target).removeClass("error")}else this.valid=!1,$(a.target).addClass("error")},_reClean:function(){this.date_model.unbind("change"),this.date_model.destroy()}}),cdb.admin.EditInPlace=cdb.core.View.extend({events:{"click .value":"_onClick","keyup input":"_onKeyUp","blur input":"_onBlur"},initialize:function(){this.options=_.extend({disabled:!1,stripHTML:!1},this.options),_.bindAll(this,"_close","_onKeyUp"),this._observedField=this.options.observe,
this.disabled=this.options.disabled,this.stripHTML=this.options.stripHTML,this.template=this.options.template_name?this.getTemplate(this.options.template_name):this.getTemplate("table/menu_modules/legends/views/edit_in_place"),this._setupConfig(),this.add_related_model(this.model),this.model.bind("change:"+this._observedField,this._updateValue,this),this.render()},_setupConfig:function(){this.config=new cdb.core.Model({mode:"view"}),this.add_related_model(this.config),this.config.bind("change:mode",this._updateMode,this)},_updateMode:function(a){if("edit"==this.config.get("mode"))this.$el.find(".value").hide(),this.$input.show(),this.$input.focus();else{this.$el.find(".value").show(),this.$input.hide();var b=this.model.get(this._observedField);this.$input.val(b),this.$el.find(".value span").html(b)}},_updateValue:function(){var a=this.model.get(this._observedField);return this.stripHTML&&(a=cdb.Utils.stripHTML(a)),cdb.Utils.isBlank(a)?(this.$input.text(""),this.$el.find(".value").addClass("empty"),this.$el.find(".value span").text("empty"),void this.trigger("change",null,this)):(this.$input.text(a),this.$el.find(".value span").html(a),this.$el.find(".value").removeClass("empty"),void this.trigger("change",a,this))},_close:function(a){a&&a.preventDefault(),a&&a.stopPropagation(),this.config.set("mode","view"),this._preventEmptyValue()},_preventEmptyValue:function(){var a=this.model.get(this._observedField);cdb.Utils.isBlank(a)?(this.$el.find(".value").addClass("empty"),this.$el.find(".value span").text("empty")):this.$el.find(".value").removeClass("empty")},_onBlur:function(a){var b=this.$el.find("input").val();this.stripHTML&&(b=cdb.Utils.stripHTML(b)),this.model.set(this._observedField,b),this._close()},_onKeyUp:function(a){if(13==a.keyCode){var b=this.$el.find("input").val();this.stripHTML&&(b=cdb.Utils.stripHTML(b)),this.model.set(this._observedField,b),this._close()}else 27==a.keyCode&&this._close()},_onClick:function(a){a&&a.preventDefault(),a&&a.stopPropagation(),this.disabled||this.config.set("mode","edit")},render:function(){var a=!0,b=this.model.get(this._observedField);this.stripHTML&&(b=cdb.Utils.stripHTML(b)),cdb.Utils.isBlank(b)?(b="empty",this.$el.append('<input type="text" value="" />')):(a=!1,this.$el.append('<input type="text" value="'+_.escape(b)+'" />')),this.$el.append(this.template({value:b})),this.$el.addClass("edit_in_place"),this.disabled&&this.$el.addClass("disabled"),a?this.$el.find(".value").addClass("empty"):this.$el.find(".value").removeClass("empty"),this.$input=this.$el.find("input"),this.options.maxWidth&&this.$el.find("span").css("max-width",this.options.maxWidth)}}),cdb.forms.ColumnTypeCombo=cdb.forms.Combo.extend({options:{minimumResultsForSearch:20,placeholder:"",formatResult:!0,matcher:!0,dropdownCssClass:"column-type"},_formatResult:function(a){return'<span class="value">'+a.id+'</span><span class="type">'+(a.text&&a.text.charAt(0))+"</span>"},_matcher:function(a,b,c){var d=$(c).val();return d.toUpperCase().indexOf(a.toUpperCase())>=0}}),cdb.forms.Form=cdb.core.View.extend({tagName:"ul",widgets:{color:"ColorWizard",opacity:"Opacity",simple_opacity:"SimpleOpacity",opacity_polygon:"OpacityPolygon",number:"Spinner",simple_number:"SimpleNumber",simple_number_with_label:"SimpleNumberWithLabel",width:"Width",select:"Combo",hidden:"Hidden",switch:"Switch",text_align:"TextAlign"},field_template:_.template('<li <% if (className) { %>class="<%- className %>"<% } %>><span><%-name %></span><span class="field"></li>'),initialize:function(){this.fields={},this.form_data=this.options.form_data,this.bind("clean",function(){this.fields=null},this)},updateForm:function(a){this.form_data=a},_renderField:function(a){var b=this,c=$(this.field_template({name:a.title||a.name,className:a.className||!1}));return _(a.form).each(function(d,e){var f=window.cdb.forms[b.widgets[d.type]];if(f){var g=d;_.extend(g,{property:e,model:b.model,extra:d.extra,field_name:a.name});var h=new f(g);c.find(".field").append(h.render().el),h.on("saved",function(){b.trigger("saved",b)}),b.addView(h)}else cdb.log.error("field class not found "+d.type)}),a.text&&$("<span class='text light'>"+a.text+"</span>").insertAfter(c.find(".field div:eq(0)")),c},getFieldByName:function(a){return this.fields[a]},getFieldsByName:function(a){return _.filter(this._subviews,function(b){if(b.options.field_name===a)return b})},render:function(){var a=this;return this.clearSubViews(),_(this.filter).each(function(a){a.destroy()}),this.$el.html(""),_(this.form_data).each(function(b){var c=a._renderField(b);a.fields[b.name]=c,a.$el.append(c)}),this}}),cdb.admin.GeometryField=cdb.admin.StringField.extend({className:"field geometry",default_options:{template_name:"old_common/views/forms/geometry_field",label:!1,readOnly:!1},events:{"click .switch":"_chooseEditor","keyup input":"_onKeyInputUp","keydown textarea":"_onKeyTextareaDown","change textarea":"_onChange"},initialize:function(){_.defaults(this.options,this.default_options),_.bindAll(this,"_chooseEditor","_onKeyInputUp","_onKeyTextareaDown"),this.template_base=this.options.template_base?_.template(this.options.template_base):cdb.templates.getTemplate(this.options.template_name),this.valid=!0,this.row=this.options.row,this._setOS()},render:function(){return this.$el.html(this.template_base(_.extend(this.model.toJSON(),this.options))),this._initViews(),this.options.readOnly&&this.undelegateEvents(),this},_initViews:function(){this.model.get("value");this.row.isGeomLoaded()?this._chooseGeom():this._loadGeom()},_loadGeom:function(){var a=this;this.row.bind("change",function(){a.model.set("value",a.row.get("the_geom")),a._chooseGeom()},this),this.row.fetch({rowNumber:this.options.rowNumber})},_chooseGeom:function(){var a=null;try{a=JSON.parse(this.model.get("value"))}catch(a){}this.options.readOnly?(this.$(".loader").remove(),this.$(".selector").show(),this.$("textarea").val(this.model.get("value"))):a&&"point"!=a.type.toLowerCase()?(this.status="rest",this.$(".loader").remove(),this.$(".rest").show(),this.$("textarea").val(this.model.get("value"))):(this.status="point",this.$(".loader").remove(),this.$(".point").show(),this.$(".selector").show(),a&&(this.$("input.longitude").val(a.coordinates[0]),this.$("input.latitude").val(a.coordinates[1]),this.$("textarea").val(JSON.stringify(a))))},_chooseEditor:function(a){this.killEvent(a);var b=$(a.target).closest("a");this.status="point"==this.status?"rest":"point",b.removeClass("rest"==this.status?"disabled":"enabled").addClass("rest"==this.status?"enabled":"disabled"),this.updateInputs(),"rest"==this.status?(this.$(".point").hide(),this.$(".rest").show(),this.valid=!0):(this.$(".point").show(),this.$(".rest").hide(),this.valid=this._checkInputs())},updateInputs:function(){if(this.model.get("value"))try{var a=JSON.parse(this.model.get("value"));this.$("input.longitude").val(a.coordinates[0]),this.$("input.latitude").val(a.coordinates[1]),this.$("textarea").val(JSON.stringify(a))}catch(a){return!1}},_checkNumber:function(a,b){var c=/^-?(?:[0-9]+|[0-9]*\.[0-9]+)$/;return!!c.test(a)&&("lat"===b?a>=-90&&a<=90:"lon"!==b||a>=-180&&a<=180)},_checkInputs:function(){var a=!0,b=this.$("input.latitude"),c=this.$("input.longitude");return this._checkNumber(b.val(),"lat")?b.removeClass("error"):(b.addClass("error"),a=!1),this._checkNumber(c.val(),"lon")?c.removeClass("error"):(c.addClass("error"),a=!1),a},_onKeyInputUp:function(a){if(this._checkInputs()){if(13===a.keyCode)return a.preventDefault(),this._triggerEvent("ENTER"),!1;this.valid=!0;var b=parseFloat(this.$("input.latitude").val()),c=parseFloat(this.$("input.longitude").val());this.model.set("value",JSON.stringify({type:"Point",coordinates:[c,b]}))}else this.valid=!1},_onKeyTextareaDown:function(a){if(("mac"==this.so&&a.metaKey||"rest"==this.so&&a.ctrlKey)&&13==a.keyCode)return a.preventDefault(),this._triggerEvent("ENTER"),!1;var b=$(a.target).val();this.model.set("value",b)}}),cdb.admin.NumberField=cdb.admin.StringField.extend({className:"field number",default_options:{template_name:"old_common/views/forms/number_field",label:!1,readOnly:!1},events:{"change input":"_onChange","keyup input":"_onKeyUp","keydown input":"_onKeyDown"},_checkNumber:function(a){var b=/^-?(?:[0-9]+|[0-9]*\.[0-9]+)$/;return!!b.test(a)},_onChange:function(a){var b=$(a.target).val();this._checkNumber(b)&&this.model.set("value",b)},_onKeyDown:function(a){var b=$(a.target).val();(("mac"==this.so&&a.metaKey||"rest"==this.so&&a.ctrlKey)&&13==a.keyCode||13==a.keyCode)&&(""===b||this._checkNumber(b))&&(this._setValid(b),this._triggerEvent("ENTER"))},_onKeyUp:function(a){var b=$(a.target).val();""===b||this._checkNumber(b)?this._setValid(b):this._setInvalid(b)},_setInvalid:function(a){this.valid=!1,this.$('input[type="text"]').addClass("error")},_setValid:function(a){this.valid=!0,""===a&&(a="null"),this.$('input[type="text"]').removeClass("error"),this.model.set("value",a)},_resize:function(){}}),cdb.admin.SpinnerSlider=cdb.admin.DropdownMenu.extend({className:"dropdown spinner_slider border",default_options:{width:26,speedIn:150,speedOut:300,vertical_position:"up",horizontal_position:"right",horizontal_offset:32,vertical_offset:0,tick:"top"},events:{click:"_stopPropagation"},_stopPropagation:function(a){a.stopPropagation(),a.preventDefault()},init:function(a,b,c,d){var e=this;this.$el.find("div.slider-ui").slider({orientation:"vertical",max:a,min:b,step:c,value:d,slide:function(a,b){e.trigger("valueChanged",b.value,this.el)},change:function(a,b){e.trigger("valueSet",b.value,this.el)}}),this.open()},hide:function(a){var b=this;this.isOpen=!1,this.$el.animate({marginTop:"down"==b.options.vertical_position?"10px":"-10px",opacity:0},this.options.speedOut,function(){$(b.options.target).removeClass("selected"),b.$el.hide(),b.$el.find("div.slider-ui").slider("destroy"),b.remove()})}}),cdb.forms.CustomTextCombo=cdb.forms.ColumnTypeCombo.extend({className:"form_combo form_custom_text_combo",options:{minimumResultsForSearch:20,placeholder:"",formatResult:!0,formatSelection:!0,matcher:!0,freeText:!0,dropdownCssClass:"column-type custom_text_combo"},render:function(){this.$select=$("<select>"+this._getOptions()+"</select>");var a=this.model&&this.model.get("method")&&this.model.get("method").replace(/ /g,"_").toLowerCase();if(this.$select.attr({style:this.options.width?"width:"+this.options.width:""}),this.$select.addClass(this.options.property+(a?" "+a:"")),this.options.disabled&&this.$select.attr("disabled",""),this._setValue(this.model&&this.model.get(this.options.property)||this.options.property),this.$el.html(this.$select),!this.options||!this.options.plainSelect){var b=this.$("select");b.select2("destroy");var c={minimumResultsForSearch:this.options.minimumResultsForSearch,placeholder:this.options.placeholder,dropdownCssClass:this.options.dropdownCssClass,freeText:this.options.freeText};this.options.formatSelection&&(c.formatSelection=this._formatSelection),this.options.formatResult&&(c.formatResult=this._formatResult),this.options.matcher&&(c.matcher=this._matcher),b.select2(c)}var d=this.model.get(this.options.property);return""===d||this._valueAsOption(this.model.get(this.options.property))||b.select2("val",this.model.get(this.options.property)),this},_valueAsOption:function(a){return void 0!==_.find(this.options.extra,function(b){return b[1]===a})},_formatSelection:function(a){return a?a.id:a.text},_changeSelection:function(a){var b=this.$("select").val()||this.$("select").data("select2").data().id,c=!this._valueAsOption(b),d={};d[this.options.property]=b,d[this.options.text||"text"]=!!c,b&&this.model.set(d),this.$(".select2-choice > div").removeClass().addClass(c?"free-text-icon":"combo-option-icon")}}),cdb.admin.GlobalError=cdb.core.View.extend({DEFAULT_TAG:"",initialize:function(){_.bindAll(this,"hide"),this._lastType=-1,this._lastTag=this.DEFAULT_TAG},templates:{info:"old_common/views/notifications/info",warn:"old_common/views/notifications/info",error:"old_common/views/notifications/info",load:"old_common/views/notifications/loading"},priority:{error:3,warn:2,info:1,load:0},getTypeTemplate:function(a){var b=this.templates[a]?this.templates[a]:this.templates.info,c=this.getTemplate(b);return c},showError:function(a,b,c,d){d=d||this.DEFAULT_TAG,c=void 0===c?2e3:c,b||(b="info");var e=this.priority[b]||0,f=this.priority[this._lastType]||0;e<f||(this._lastType=b,this._lastTag=d,this.$el.html(this.getTypeTemplate(b)({text:a,type:b})),this._timer&&clearTimeout(this._timer),c>0&&(this._timer=setTimeout(this.hide,c)),this.show())},show:function(){this.$el.find("p").stop().animate({marginTop:0},500)},hide:function(a){a=a||this.DEFAULT_TAG,this._lastTag===a&&(this.$el.find("p").stop().animate({marginTop:40},500),this._timer=0,this._lastType=-1,this._lastTag=this.DEFAULT_TAG)},listenGlobal:function(){cdb.god.bind("error",this.showError,this)}}),cdb.admin.Header=cdb.core.View.extend({_TEXTS:{saving:_t("Saving..."),saved:_t("Saved"),error:_t("Something went wrong, try again later"),metadata:{edit:_t("Edit metadata..."),view:_t("View metadata...")},visualization:{loader:_t("Changing to visualization"),created:_t("Visualization created")},share:{publish:_t("PUBLISH"),visualize:_t("VISUALIZE")},share_privacy:{ok_next:_t("Share it now!")},rename:{readonly:_t("It is not possible to rename<br/>the dataset in <%- mode %> mode"),owner:_t("It is not possible to rename<br/>the dataset if you are not the owner")}},_MAX_DESCRIPTION_LENGTH:200,events:{"click a.title":"_changeTitle","click .metadata a":"_changeMetadata","click a.options":"_openOptionsMenu","click a.share":"_shareVisualization","click a.privacy":"_showPrivacyDialog","click header nav a":"_onTabClick"},initialize:function(a){_.bindAll(this,"_changeTitle","_setPrivacy"),this.$body=$("body"),this.dataLayer=null,this.globalError=this.options.globalError,this._initBinds(),this.setInfo()},setActiveLayer:function(a){this.dataLayer&&(this.dataLayer.unbind("applySQLView applyFilter errorSQLView clearSQLView",this.setEditableInfo,this),this.dataLayer.table.unbind("change:isSync",this.setEditableInfo,this),this.dataLayer.table.unbind("change:permission",this.setInfo,this)),this.dataLayer=a.model,this.model.isVisualization()||(this.dataLayer.bind("applySQLView applyFilter errorSQLView clearSQLView",this.setEditableInfo,this),this.dataLayer.table.bind("change:isSync",this.setEditableInfo,this),this.dataLayer.table.bind("change:permission",this.setInfo,this),this.setEditableInfo())},_initBinds:function(){this.model.bind("change:name",this._setName,this),this.model.bind("change:type",this.setInfo,this),this.model.bind("change:privacy",this._setPrivacy,this),this.model.bind("change:permission",this._setSharedCount,this)},_openOptionsMenu:function(a){this.killEvent(a);var b=this,c=$(a.target);this.options_menu=new cdb.admin.HeaderOptionsMenu({target:$(a.target),model:this.model,dataLayer:this.dataLayer,user:this.options.user,private_tables:this.options.user.get("actions").private_tables,geocoder:this.options.geocoder,backgroundPollingModel:this.options.backgroundPollingModel,globalError:this.options.globalError,template_base:"table/header/views/options_menu"}).bind("onDropdownShown",function(a){cdb.god.unbind("closeDialogs",b.options_menu.hide,b.options_menu),cdb.god.trigger("closeDialogs"),cdb.god.bind("closeDialogs",b.options_menu.hide,b.options_menu)}).bind("onDropdownHidden",function(){this.clean(),c.unbind("click"),cdb.god.unbind(null,null,b.options_menu)}),this.$body.append(this.options_menu.render().el),this.options_menu.open(a)},_shareVisualization:function(a){this.killEvent(a);var b;b=this.model.isVisualization()?new cdb.editor.PublishView({clean_on_hide:!0,enter_to_confirm:!0,user:this.options.user,model:this.model}):new cdb.editor.CreateVisFirstView({clean_on_hide:!0,enter_to_confirm:!0,model:this.model,router:window.table_router,title:"A map is required to publish",explanation:"A map is a shareable mix of layers, styles and queries. You can view all your maps in your dashboard."}),b.appendToBody()},_showPrivacyDialog:function(a){if(a&&this.killEvent(a),this.model.isOwnedByUser(this.options.user)){var b=new cdb.editor.ChangePrivacyView({vis:this.model,user:this.options.user,enter_to_confirm:!0,clean_on_hide:!0});b.appendToBody()}},setInfo:function(){this._setName(),this._setSyncInfo(),this._setVisualization(),this._setMetadata()},setEditableInfo:function(){this._setName(),this._setSyncInfo(),this._setMetadata()},_setPrivacy:function(){var a=this.$("a.privacy");this._setSharedCount();var b=this.model.get("privacy").toLowerCase();"public"==b?a.removeClass("private").removeClass("link_protected").removeClass("password_protected").removeClass("organization").addClass("public"):"link"==b?a.removeClass("public").removeClass("private").removeClass("password_protected").removeClass("organization").addClass("link_protected"):"private"==b?a.removeClass("public").removeClass("link_protected").removeClass("password_protected").removeClass("organization").addClass("private"):"password"==b?a.removeClass("private").removeClass("link_protected").removeClass("public").removeClass("organization").addClass("password_protected"):"organization"==b&&a.removeClass("private").removeClass("link_protected").removeClass("public").removeClass("password_protected").addClass("organization");var c=this.model.permission.isOwner(this.options.user);a.find("i")[c?"removeClass":"addClass"]("disabled")},_setSharedCount:function(){var a=this.model.permission.isOwner(this.options.user),b=this.$("a.privacy i");if(b.empty(),a){var c=$("<span>").addClass("shared_users");if(this.model.permission.acl.size()>0){var d=0,e=this.model.permission.getUsersWithAnyPermission();d=this.model.permission.isSharedWithOrganization()?"ORG":e.length,c.text(0!==d?d:""),b.append(c)}}},_setMetadata:function(){var a=this.model.permission.isOwner(this.options.user),b=this.$(".metadata a"),c=this._TEXTS.metadata.edit,d="#/edit-metadata";a||(c=this._TEXTS.metadata.view,d="#/view-metadata"),b.attr("href",d).text(c)},_setSyncInfo:function(){this.sync_info&&this.sync_info.clean(),!this.model.isVisualization()&&this.isSyncTable()?(this.$el.addClass("synced"),this.sync_info=new cdb.admin.SyncInfo({dataLayer:this.dataLayer,user:this.options.user}),this.$(".sync_status").append(this.sync_info.render().el),this.addView(this.sync_info)):this.$el.removeClass("synced")},_setName:function(){var a=this.$("h1 a.title");a[this.isVisEditable()&&!this.isSyncTable()?"removeClass":"addClass"]("disabled").text(this.model.get("name")),document.title=this.model.get("name")+" | CARTO"},_setVisualization:function(){var a=this.$("a.back"),b=this.$("a.share"),c=this.model.isVisualization();if(c){b.find("span").text(this._TEXTS.share.publish),this._setPrivacy();var d=cdb.config.prefixUrl()+"/dashboard/maps";a.attr("href",d)}else{b.find("span").text(this._TEXTS.share.visualize),this._setPrivacy();var d=cdb.config.prefixUrl()+"/dashboard/datasets";a.attr("href",d)}},_changeMetadata:function(a){a.preventDefault();var b=new cdb.editor.EditVisMetadataView({maxLength:this._MAX_DESCRIPTION_LENGTH,vis:this.model,dataLayer:this.dataLayer&&this.dataLayer.table,user:this.options.user,clean_on_hide:!0,enter_to_confirm:!1,onShowPrivacy:this._showPrivacyDialog.bind(this),onDone:this._onChangeMetadata.bind(this)});b.appendToBody()},_onChangeMetadata:function(a){a&&!this.model.isVisualization()&&(window.table_router.navigate(this._generateTableUrl(),{trigger:!1}),window.table_router.addToHistory())},_changeTitle:function(a){function b(){var a=$(this),c=a.data("tipsy");c&&a.tipsy("hide").unbind("mouseleave",b)}function c(a){if(a!==d.model.get("name")&&""!=a){var b=cdb.Utils.stripHTML(a,"");d.model.isVisualization()?d._onSetAttributes({name:b}):(d.change_confirmation&&d.change_confirmation.clean(),d.change_confirmation=cdb.editor.ViewFactory.createDialogByTemplate("common/dialogs/confirm_rename_dataset"),d.change_confirmation.ok=function(){d._onSetAttributes({name:b}),_.isFunction(this.close)&&this.close()},d.change_confirmation.appendToBody().open())}}this.killEvent(a);var d=this,e=this.model.permission.isOwner(this.options.user);if(this.isVisEditable()){this.title_dialog&&this.title_dialog.clean(),cdb.god.trigger("closeDialogs");var f=this.title_dialog=new cdb.admin.EditTextDialog({initial_value:this.model.get("name"),template_name:"table/views/edit_name",clean_on_hide:!0,modal_class:"edit_name_dialog",onResponse:c});cdb.god.bind("closeDialogs",f.hide,f);var g=$(a.target).offset();g.left-=$(window).scrollLeft(),g.top-=$(window).scrollTop();var h=Math.max($(a.target).width()+100,280);f.showAt(g.left-20,g.top-10,h)}else{var i=$(a.target);i.bind("mouseleave",b).tipsy({fade:!0,trigger:"manual",html:!0,title:function(){var a=d.isSyncTable()?"sync":"read-only";return _.template(d._TEXTS.rename[e?"readonly":"owner"])({mode:a})}}).tipsy("show")}},_onSetAttributes:function(a){var b=this.model.toJSON(),c=a;if(this.model.set(a,{silent:!0}),this.model.hasChanged()){var d=this;this.globalError.showError(this._TEXTS.saving,"load",-1),this.model.save({},{wait:!0,success:function(a){c.name===b.name||d.model.isVisualization()||(window.table_router.navigate(d._generateTableUrl(),{trigger:!1}),window.table_router.addToHistory()),d.globalError.showError(d._TEXTS.saved,"info",3e3)},error:function(a,c){var e=c&&JSON.parse(c.responseText).errors[0];d.globalError.showError(e,"error",3e3),d.model.set(b,{silent:!0}),d.setInfo()}})}},isVisEditable:function(){if(this.model.isVisualization())return!0;var a=this.dataLayer&&this.dataLayer.table;return!!a&&!(a&&(a.isReadOnly()||!a.permission.isOwner(this.options.user)))},isSyncTable:function(){return!(!this.dataLayer||!this.dataLayer.table)&&this.dataLayer.table.isSync()},_generateTableUrl:function(a){var b="";if(this.model.isVisualization())b+="/viz/"+this.model.get("id");else{var c=this.model.permission.isOwner(this.options.user),d=new cdb.admin.CartoDBTableMetadata(this.model.get("table"));if(c)b+="/tables/"+d.getUnqualifiedName();else{var e=this.model.permission.owner.get("username");b+="/tables/"+e+"."+d.getUnqualifiedName()}}var f=a?$(a.target).attr("href"):window.location.pathname;return b+=f.search("/map")!=-1?"/map":"/table"},_onTabClick:function(a){a.preventDefault(),window.table_router.navigate(this._generateTableUrl(a),{trigger:!0})}}),cdb.admin.hotkeys={_keyMap:{68:"s",67:"c",83:"s"},enable:function(){$("body").bind("keydown",function(a){if(a.altKey&&a.ctrlKey){var b=cdb.admin.hotkeys._keyMap[a.keyCode];if(b)return cdb.god.trigger("hotkey:"+b,a),a.preventDefault(),a.stopPropagation(),!1}})}},function(){var a=function(a){this.name=a};a.prototype.get=function(a){if(localStorage.getItem(this.name)){if(void 0===a)return JSON.parse(localStorage.getItem(this.name));var b=JSON.parse(localStorage.getItem(this.name));return b[a]}return[]},a.prototype.search=function(a){var b=JSON.parse(localStorage.getItem(this.name));for(var c in b)if(b[c][a])return b[c][a];return null},a.prototype.set=function(a){return localStorage.getItem(this.name)||localStorage.setItem(this.name,"[]"),localStorage.setItem(this.name,JSON.stringify(a))},a.prototype.add=function(a){var b=this.get();if(b)return b.push(a),this.set(b)},a.prototype.remove=function(a){var b=this.get();return b.splice(a,a),this.set(b)},a.prototype.destroy=function(){localStorage.removeItem(this.name)},cdb.admin.localStorage=a}(),cdb.admin.Metrics=cdb.core.Model.extend({initialize:function(a){this.bindEvents()},bindEvents:function(){cdb.god.bind("metrics",this._setTrack,this)},_setTrack:function(a,b){if(window.hubspot_token){window._hsq=window._hsq||[],window._hsq.push(["identify",{email:b.email}]);var c;switch(a){case"published_visualization":c=window.hubspot_ids.published_visualization;break;case"visited_dashboard":c=window.hubspot_ids.visited_dashboard;break;case"connect_dataset":c=window.hubspot_ids.connect_dataset;break;case"create_map":c=window.hubspot_ids.create_map;break;case"export_table":c=window.hubspot_ids.export_table;break;case"export_map":c=window.hubspot_ids.export_map;break;case"select_wms":c=window.hubspot_ids.select_wms;break;case"color_basemap":c=window.hubspot_ids.color_basemap;break;case"pattern_basemap":c=window.hubspot_ids.pattern_basemap;break;case"geocoding":c=window.hubspot_ids.geocoding;break;case"visual_merge":c=window.hubspot_ids.visual_merge;break;case"common_data":c=window.hubspot_ids.common_data;break;case"cartocss_manually":c=window.hubspot_ids.cartocss_manually;break;case"wizard":c=window.hubspot_ids.wizard;break;case"filter":c=window.hubspot_ids.filter;break;case"query":c=window.hubspot_ids.query;break;case"logged_in":c=window.hubspot_ids.logged_in;break;case"visited_dashboard_first_time":c=window.hubspot_ids.visited_dashboard_first_time;break;case"applied_pecan":c=window.hubspot_ids.applied_pecan;break;case"open_pecan_list":c=window.hubspot_ids.open_pecan_list}window._hsq.push(["trackEvent",{id:c}])}}}),cdb.admin.SmallDialog=cdb.ui.common.Dialog.extend({className:"floating",initialize:function(){_.extend(this.options,{title:"",description:"",clean_on_hide:!0}),cdb.ui.common.Dialog.prototype.initialize.apply(this),this.render(),$(document.body).append(this.el)},showAt:function(a,b,c,d){this.$el.css({top:b,left:a,minWidth:c}),d&&this.$el.find("> textarea, > input").css({minWidth:c-22}),this.show()},showAtElement:function(a){var b=$(a).offset();this.showAt(b.left,b.top)}}),cdb.admin.EditTextDialog=cdb.admin.SmallDialog.extend({events:cdb.core.View.extendEvents({"keypress input":"_keyPress",click:"_stopPropagation"}),initialize:function(){_.defaults(this.options,{template_name:"old_common/views/dialog_small_edit",ok_title:"Save",modal_class:"edit_text_dialog",clean_on_hide:!0}),this.constructor.__super__.initialize.apply(this)},render_content:function(){this._focusInput();var a='<input value="'+this.options.initial_value.replace(/\"/g,"&quot;").replace(/\'/g,"&#39;")+'" ';return this.options.maxLength&&(a+="maxLength = "+this.options.maxLength),a+=' type="text"/>'},_stopPropagation:function(a){a.stopPropagation()},_focusInput:function(){var a=this;setTimeout(function(){var b=a.$el.outerWidth()-a.$el.find("a.button").outerWidth()-35;a.$el.find("input").width(b).focus()},0)},_keyPress:function(a){13===a.keyCode&&this._ok()},ok:function(){this.options.onResponse&&this.options.onResponse(this.$("input").val())}}),cdb.admin.EditMarkdownDialog=cdb.admin.SmallDialog.extend({events:cdb.core.View.extendEvents({"keypress input":"_keyPress",click:"_stopPropagation"}),initialize:function(){_.defaults(this.options,{old_template_name:"old_common/views/dialog_markdown_edit",ok_title:"Save",modal_class:"edit_name_dialog markdown",clean_on_hide:!0}),this.constructor.__super__.initialize.apply(this)},render_content:function(){this._focusInput();var a='<div class="input_field"><input value="'+this.options.initial_value.replace(/\"/g,"&quot;").replace(/\'/g,"&#39;")+'" ';return this.options.maxLength&&(a+="maxLength = "+this.options.maxLength),a+=' type="text"/><div class="hint"><strong>**bold**</strong> <em>*italics*</em> [link title](url)</div></div>'},_stopPropagation:function(a){a.stopPropagation()},_focusInput:function(){var a=this;setTimeout(function(){var b=a.$el.outerWidth()-a.$el.find("a.button").outerWidth()-35;a.$el.find(".input_field").width(b),a.$el.find(".input_field input").focus()},0)},_keyPress:function(a){13===a.keyCode&&this._ok()},ok:function(){this.options.onResponse&&this.options.onResponse(this.$("input").val())}}),cdb.admin.Tabs=cdb.core.View.extend({events:{click:"_click"},initialize:function(){_.bindAll(this,"activate"),this.preventDefault=!1},activate:function(a){this.$("a").removeClass("selected"),this.$('a[href$="#'+(this.options.slash?"/":"")+a+'"]').addClass("selected")},desactivate:function(a){this.$('a[href$="#'+(this.options.slash?"/":"")+a+'"]').removeClass("selected")},disable:function(a){this.$('a[href$="#'+(this.options.slash?"/":"")+a+'"]').addClass("disabled")},enable:function(a){this.$('a[href$="#'+(this.options.slash?"/":"")+a+'"]').removeClass("disabled")},getTab:function(a){return this.$('a[href$="#'+(this.options.slash?"/":"")+a+'"]')},disableAll:function(){this.$("a").addClass("disabled")},removeDisabled:function(){this.$(".disabled").parent().remove()},_click:function(a){a&&this.preventDefault&&a.preventDefault();var b=$(a.target).closest("a"),c=b.attr("href");if(!b.hasClass("disabled")&&c){var d=c.replace("#/","#").split("#")[1];this.trigger("click",d)}},linkToPanel:function(a){this.preventDefault=!0,a.bind("tabEnabled",this.activate,this),this.bind("click",a.active,a)}}),cdb.common.TipsyTooltip=cdb.core.View.extend({options:{gravity:"s",fade:!0},initialize:function(a){return void 0===a.el?(cdb.log.info("Element is needed to have tipsy tooltip working"),!1):(this._tipsyOpenedManually="manual"===a.trigger,void this._initTipsy())},showTipsy:function(){this.$el.tipsy("show")},hideTipsy:function(){this.$el.tipsy("hide")},_initTipsy:function(){this.$el.tipsy(this.options),this.tipsy=this.$el.data("tipsy")},_destroyTipsy:function(){this.tipsy&&(this.tipsy.hide(),this.$el.unbind("mouseleave mouseenter")),this._tipsyOpenedManually&&this.$el.tipsy("hide")},clean:function(){this._destroyTipsy(),cdb.core.View.prototype.clean.call(this)}}),cdb.admin.TooltipTrails=cdb.core.View.extend({className:"tooltip-trails",tagName:"div",options:{msg:_t("Checking tooltip-trails"),offset:[15,5]},render:function(){return this.$el.append(this.options.msg),this},show:function(a){this.$el.css({"margin-left":this.options.offset[0],"margin-top":this.options.offset[1],left:a.left,top:a.top}),this.$el.show()},move:function(a){this.$el.css(a)},hide:function(){this.$el.hide(),this.clean()}}),cdb.common.DashboardDatasetsUrl=cdb.common.DashboardVisUrl.extend({dataLibrary:function(){return this.urlToPath("library")}}),cdb.common.DashboardUrl=cdb.common.Url.extend({datasets:function(){return new cdb.common.DashboardDatasetsUrl({base_url:this.urlToPath("datasets")})},maps:function(){return new cdb.common.DashboardVisUrl({base_url:this.urlToPath("maps")})},deepInsights:function(){return new cdb.common.DashboardVisUrl({base_url:this.urlToPath("deep-insights")})}}),cdb.common.DatasetUrl=cdb.common.Url.extend({edit:function(){return this.urlToPath()},public:function(){return this.urlToPath("public")}}),cdb.common.MapUrl=cdb.common.Url.extend({edit:function(){return this.urlToPath("map")},public:function(){return this.urlToPath("public_map")},deepInsights:function(){return this.urlToPath("deep-insights")}}),cdb.common.OrganizationUrl=cdb.common.Url.extend({edit:function(a){if(!a)throw new Error("User is needed to create the url");return this.urlToPath(a.get("username")+"/edit")},create:function(){return this.urlToPath("new")},groups:function(){return this.urlToPath("groups")}}),cdb.common.UserUrl=cdb.common.Url.extend({initialize:function(a){if(cdb.common.Url.prototype.initialize.apply(this,arguments),_.isUndefined(a.is_org_admin))throw new Error("is_org_admin is required")},organization:function(){return this.get("is_org_admin")?new cdb.common.OrganizationUrl({base_url:this.urlToPath("organization")}):this.urlToPath("account")},accountSettings:function(){return this.urlToPath("profile")},publicProfile:function(){return this.urlToPath("me")},apiKeys:function(){return this.urlToPath("your_apps")},logout:function(){return this.urlToPath("logout")},dashboard:function(){return new cdb.common.DashboardUrl({base_url:this.urlToPath("dashboard")})}}),cdb.Utils={},cdb.Utils.stripHTML=function(a,b){b=(((b||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var c=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;return a&&"string"==typeof a?a.replace(c,function(a,c){return b.indexOf("<"+c.toLowerCase()+">")>-1?a:""}):""},cdb.Utils.removeHTMLEvents=function(a){return a?a.replace(/ on\w+="[^"]*"/g,""):""},cdb.Utils.truncate=function(a,b){return a.substr(0,b-1)+(a.length>b?"&hellip;":"")},cdb.Utils.isURL=function(a){var b=/^((http|https|ftp)\:\/\/)/g;return!!a&&b.test(a)},cdb.Utils.encodeURLParams=function(a){if(this.isURL(a)){
var b=a.split("?");return b.length>1?b[0]+"?"+encodeURIComponent(b[1]):a}return a},cdb.Utils.readablizeBytes=function(a,b){if(!a||isNaN(a))return 0;var c=["bytes","kB","MB","GB","TB","PB"],d=Math.floor(Math.log(a)/Math.log(1024)),e=(a/Math.pow(1024,Math.floor(d))).toFixed(2);return b&&(e=parseInt(e)),e+" "+c[d]},cdb.Utils.isEmpty=function(a){return!a||0===a.length},cdb.Utils.isBlank=function(a){return!a||/^\s*$/.test(a)},cdb.Utils.formatNumber=function(a){if(!a)return"0";var b=a.toString().split(".");return b[0]=b[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),b.join(".")},cdb.Utils.rgbToHex=function(a,b,c){function d(a){var b=a.toString(16);return 1==b.length?"0"+b:b}return"#"+d(a)+d(b)+d(c)},cdb.Utils.hexToRGB=function(a){var b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return b?{r:parseInt(b[1],16),g:parseInt(b[2],16),b:parseInt(b[3],16)}:null},cdb.Utils.genRandomPass=function(a){function b(){var a=Math.random();return a=parseInt(1e3*a),a=a%94+33}function c(a){return a>=33&&a<=47||(a>=58&&a<=64||(a>=91&&a<=96||a>=123&&a<=126))}a=isNaN(a)?"":a;var d="",e=!a;for(e&&(a=Math.random(),a=parseInt(100*a),a=a%7+6),i=0;i<a;i++){for(numI=b();c(numI);)numI=b();d+=String.fromCharCode(numI)}return d},cdb.Utils.pad=function(a,b){for(var c=a+"";c.length<b;)c="0"+c;return c},cdb.Utils.sanitizeString=function(a){return a.replace(/[^a-z0-9\s]/gi,"").replace(/[_\s]/g,"-")},cdb.Utils.readizableNumber=function(a){return a>=1e9?(a/1e9).toFixed(1)+"G":a>=1e6?(a/1e6).toFixed(1)+"M":a>=1e3?(a/1e3).toFixed(1)+"K":a},cdb.Utils.getFileExtension=function(a){return a?a.substr(a.lastIndexOf(".")+1):""},cdb.Utils.getGetOrdinal=function(a){if(!a)return"";var b=["th","st","nd","rd"],c=a%100;return a+(b[(c-20)%10]||b[c]||b[0])},cdb.Utils.capitalize=function(a){return a.charAt(0).toUpperCase()+a.slice(1)},cdb.Utils.isValidEmail=function(a){var b=/^([^@]+)@([^@]+)\.([^@\.]+)$/i;return b.test(a)},cdb.Utils.result=function(a,b){if(null==a)return null;var c=a[b];return _.isFunction(c)?c.apply(a,Array.prototype.slice.call(arguments,2)):c},cdb.Utils.safeTableNameQuoting=function(a){return void 0===a||a.indexOf("-")===-1||'"'===a[0]||'"'===a[a.length-1]?a:'"'+a+'"'},cdb.admin.VideoModel=cdb.core.Model.extend({defaults:{minimized:!0,size:{minimized:{width:420,height:236},maximized:{width:700,height:393}}},initialize:function(){this._initLocalStorage();var a=this.defaults.minimized;this.videoData&&void 0!==this.videoData.minimized&&(a=this.videoData.minimized);var b=this.defaults.size[a?"minimized":"maximized"];this.set({minimized:a,width:b.width,height:b.height,seconds:this.videoData?this.videoData.seconds:0,top:this.videoData?this.videoData.top:null,left:this.videoData?this.videoData.left:20,bottom:this.videoData?this.videoData.bottom:20}),this.bind("change",this._onChangeProperty,this),this.bind("change:minimized",this._onChangeMinimized,this)},_initLocalStorage:function(){this.localStorage=new cdb.admin.localStorage("VideoPlayer"),this.videoData=this.localStorage.get("currentVideo")||{};var a=this.get("video_id");a?(this._storeVideoID(a),this.videoData=this.localStorage.get("currentVideo")):this.set("video_id",this.videoData.video_id)},_onChangeMinimized:function(){var a=this.defaults.size[this.get("minimized")?"minimized":"maximized"];this.set("width",a.width),this.set("height",a.height)},_onChangeProperty:function(a){this.videoData=a.attributes,this._saveVideoData()},_saveVideoData:function(){this.set(this.videoData),this.localStorage.set({currentVideo:this.videoData})},_storeVideoID:function(a){this.videoData.video_id=a,this._saveVideoData()},clearStoredData:function(a){this.set("video_id",null),this.videoData={},this.localStorage.set({currentVideo:null})}}),cdb.admin.VideoPlayer=cdb.core.View.extend({className:"VideoPlayer",events:{dblclick:"_toggle","click .js-toggle":"_toggle","click .js-close":"close",mouseenter:"_mouseEnter",mouseleave:"_mouseLeave"},initialize:function(a){_.bindAll(this,"_onInitDraggable","_onStopDragging","_onCloseAnimationFinished"),this.template=cdb.templates.getTemplate("dashboard/views/video_player"),this._initModel()},render:function(){var a=this;return this.clearSubViews(),this.hasVideoData()&&(this.$el.html(this.template({id:this.model.get("video_id")})),this.$el.draggable({stop:a._onStopDragging,create:a._onInitDraggable}),this.video=this.$el.find("iframe"),this._loadScript()),this},_initModel:function(){this.model=new cdb.admin.VideoModel({video_id:this.options.id}),this.model.bind("change:minimized",this._onChangeMinimized,this)},_loadScript:function(){var a=this;$.getScript("//f.vimeocdn.com/js/froogaloop2.min.js",function(){a._initVideoBinds()})},_initVideoBinds:function(){var a=this;this.player=$f(this.video[0]),this.player.addEvent("ready",function(){a._seekToStoredPosition(),a.player.addEvent("pause",function(b){a.model.set("status","stop")}),a.player.addEvent("finish",function(b){a.model.set("status","stop"),a.close(!1,{dontHide:!0})}),a.player.addEvent("play",function(b){a.model.set("status","play")}),a.player.addEvent("playProgress",function(b){a.model.set("seconds",b.seconds)})})},_removeVideoBinds:function(){this.player&&this.player.removeEvent("ready")},_onInitDraggable:function(a,b){var c=this.model.get("bottom"),d=this.model.get("left"),e=this.model.get("height"),f=this.model.get("width"),g=$(window).width();d+f>g&&(d=g-f-20),this.$el.css({position:"fixed",left:d,bottom:c}),c<0?this.$el.animate({bottom:20,width:f,height:e},{easing:"easeOutQuad",duration:200}):this.$el.animate({width:f,height:e},{easing:"easeOutQuad",duration:200})},_onStopDragging:function(a,b){var c=$(window).height(),d=b.position.top,e=b.position.left,f=c-(d+this.$el.outerHeight(!0));this.$el.css({bottom:"auto"}),this.model.set({top:d,left:e,bottom:f})},_mouseEnter:function(){this.$el.find(".VideoControls").fadeIn(150)},_mouseLeave:function(){this.$el.find(".VideoControls").fadeOut(150)},hasVideoData:function(){return!!this.model.get("video_id")},_seekToStoredPosition:function(){var a=this,b=this.model.get("seconds");b&&this.player.api("seekTo",b),"stop"===this.model.get("status")&&setTimeout(function(){a.player.api("pause")},100)},close:function(a,b){a&&this.killEvent(a),b&&b.dontHide?this.model.clearStoredData():this.$el.animate({width:0,height:0,opacity:0},{easing:"easeInQuad",duration:200,complete:this._onCloseAnimationFinished})},_onCloseAnimationFinished:function(){this.model.clearStoredData(),this._removeVideoBinds(),this.remove()},_toggle:function(a){a&&this.killEvent(a),this.model.set("minimized",!this.model.get("minimized"))},_onChangeMinimized:function(){function a(a){if(h+a>d){var b=d-h-c.$el.outerWidth(!0);c.$el.css({left:"auto",right:b})}}function b(a){g<0||c.$el.offset().top<0?c.$el.animate({top:20},100):g-a<0||c.$el.offset().top-a<0?c.$el.css({bottom:"auto",top:g}):f<0?c.$el.css({top:"auto",bottom:20}):g+a>e&&c.$el.css({top:"auto",bottom:f})}var c=this,d=$(window).width(),e=$(window).height(),f=($(document).height(),this.model.get("bottom")),g=this.model.get("top"),h=(this.$el.offset().top,this.$el.position().left),i=this.model.get("width"),j=this.model.get("height");a(i),b(j),this.$el.animate({width:i,height:j},{easing:"easeOutQuad",duration:200,complete:function(){var a=$(window).height()-($(".VideoPlayer").offset().top+$(".VideoPlayer").outerHeight(!0));c.model.set("bottom",a)}})}}),cdb.admin.WizardDialog=cdb.ui.common.Dialog.extend({}),cdb.admin.SmallEditorDialog=cdb.admin.SmallDialog.extend({initialize:function(){_.defaults(this.options,{template_name:"old_common/views/dialog_small_edit",ok_title:"Save",modal_class:"edit_text_dialog",clean_on_hide:!0}),cdb.ui.common.Dialog.prototype.initialize.apply(this),this.render(),$(document.body).find("div.table table").append(this.el)},render_content:function(){var a=$("<div>");return this.options.editorField&&(this.editor=new this.options.editorField({label:!1,autoResize:!1,rowNumber:this.options.rowNumber,row:this.options.row,readOnly:this.options.readOnly,model:new cdb.core.Model({attribute:this.options.column,value:this.options.value})}).bind("ENTER",this._ok,this),a.append(this.editor.render().el),this.addView(this.editor)),a},showAt:function(a,b,c,d){this.$el.css({top:b,left:a,minWidth:c}),d&&this.$el.find("textarea").css({"min-width":c-22}),this.show(),this.$el.find("textarea, input").focus().select()},_ok:function(a){return a&&a.preventDefault(),!!this.editor.isValid()&&(this.options.res&&this.options.res(this.editor.model.get("value")),void this.hide())}}),function(){var a=cdb.geo.ui.Infowindow.extend({_TEXTS:{_NO_FIELDS_SELECTED:_t("You havent selected any fields to be shown in the infowindow."),_NO_FIELDS_SELECTED_BUTTON:_t("Select fields")},_TEMPLATE_URL:"table/views/infowindow/templates",events:cdb.core.View.extendEvents({"click .edit_data":"_editData","click .edit_geo":"_editGeom","click .remove":"_removeGeom","click .open_infowindow_panel":"_openInfowindowPanel"}),initialize:function(){var a=this;_.bindAll(this,"_removeGeom"),this.table=this.options.table,this.model.set({content:"loading..."}),this.constructor.__super__.initialize.apply(this),this.model.set("offset",[28,0]),this.model.bind("change:fields",function(){!this.hasChanged("content")&&a.row&&a.renderInfo()}),this.table.bind("change:schema",this.render,this),this.add_related_model(this.table),this._containsCover&&this._createHelpDialog(),this.$("div.cartodb-edit-buttons a.button").tipsy({live:!0,fade:!0,gravity:"s",offset:-2,className:function(){return $(this).closest(".cartodb-popup").hasClass("dark")?"dark":""},title:function(a){var b=!$(this).hasClass("disabled");return b?$(this).text():"Not available in this mode"}})},_createHelpDialog:function(){this.helpDialog=cdb.editor.ViewFactory.createDialogByTemplate("common/dialogs/help/infowindow_with_images",{},{clean_on_hide:!1}),this.addView(this.helpDialog)},setFeatureInfo:function(a){return this.cartodb_id=a,this.render(),this.row&&this.row.unbind(null,null,this),this.row=this.table.data().getRow(a,{no_add:!0}),this.row.bind("change",this.renderInfo,this).fetch({cache:!1,no_geom:!0}),this.renderInfo(),this},render:function(){var a=this;cdb.geo.ui.Infowindow.prototype.render.call(this);var b=this.model.get("fields");if(b&&(!b||b.length)||this.model.get("template"))this.$(".cartodb-popup").removeClass("no_fields");else{this.$(".cartodb-popup").addClass("no_fields");var c=".cartodb-popup-content";this.$(".cartodb-popup-header").length>0&&(c=".cartodb-popup-header"),this.$(c).html('<p class="italic">'+this._TEXTS._NO_FIELDS_SELECTED+'</p><p><a class="margin5 underline open_infowindow_panel" href="#/select-fields">'+this._TEXTS._NO_FIELDS_SELECTED_BUTTON+"</a></p>")}this.$(".cartodb-popup-content-wrapper").append(this.getTemplate("table/views/infowindow/infowindow_footer")({cartodb_id:this.cartodb_id})),this.table.isReadOnly()&&this.$(".cartodb-popup-content-wrapper").find("a.remove, a.edit_data, a.edit_geo").addClass("disabled"),this._containsCover()&&(this.$(".image_not_found a.help").off("click"),this.$(".image_not_found a.help").on("click",function(){$("body").append(a.helpDialog.render().el),a.helpDialog.open()}))},renderInfo:function(){var a=this,b=a.row.attributes,c=[];for(var d in b)if(b.hasOwnProperty(d)&&a.model.containsField(d)&&!_.contains(a.model.SYSTEM_COLUMNS,d)){var e={title:a.model.getFieldProperty(d,"title")?d:null,value:b[d],position:a.model.getFieldPos(d)};c.push(e)}c=_.compact(c),c.sort(function(a,b){return a.position-b.position});for(var f=[],g=0;g<c.length;++g){var h=c[g];h&&(h.index=f.length?f.length:null,f.push(h))}c.length>0?this.model.set({content:{fields:f}}):this.setLoading(),this.model.get("visibility")&&this.adjustPan()},_loadCover:function(){if(this._containsCover()){var a=this.$(".cover"),b=this.$(".image_not_found"),c=a.find("img"),d=this._getCoverURL();if(!this._isValidURL(d))return b.fadeIn(250),void c.hide();var e=document.getElementById("spinner"),f={lines:9,length:4,width:2,radius:4,corners:1,rotate:0,color:"#ccc",speed:1,trail:60,shadow:!0,hwaccel:!1,zIndex:2e9},g=new Spinner(f).spin(e);b.hide(),c.hide(function(){this.remove()}),c=$("<img />").attr("src",d),a.append(c),c.load(function(){g.stop();var b=c.width(),d=c.height(),e=a.width(),f=a.height(),h=d/b,i=f/e;if(b>e&&d>f)if(h<i)c.css({height:f});else{var j=d/(b/e);c.css({width:e,top:"50%",position:"absolute","margin-top":-1*parseInt(j,10)/2})}else{var j=d/(b/e);c.css({width:e,top:"50%",position:"absolute","margin-top":-1*parseInt(j,10)/2})}c.fadeIn(300)}).error(function(){g.stop(),b.fadeIn(250)})}},_editGeom:function(a){this.killEvent(a),this.table.isReadOnly()||(this.model.set("visibility",!1),this.trigger("editGeom",this.row))},_editData:function(a){this.killEvent(a),this.table.isReadOnly()||(this.model.set("visibility",!1),this.trigger("editData",this.row))},_removeGeom:function(a){this.killEvent(a),this.table.isReadOnly()||(this.model.set("visibility",!1),this.trigger("removeGeom",this.row))},_openInfowindowPanel:function(a){this.killEvent(a),this.trigger("openInfowindowPanel")},_getModelTemplate:function(){var a=cdb.admin.mod.TemplateMap[this.model.get("template_name")]||this.model.get("template_name");return this._TEMPLATE_URL+"/"+a}});cdb.admin.MapInfowindow=a}(),cdb.admin.Tooltip=cdb.geo.ui.Tooltip.extend({_TEMPLATE_URL:"table/views/tooltip/templates",defaults:{vertical_offset:10,horizontal_offset:4,position:"bottom|right"},events:{mouseover:"_lock",mouseout:"_unlock"},initialize:function(){this.table=this.options.table,this.options.empty_fields=!0,cdb.geo.ui.Tooltip.prototype.initialize.call(this),this.model.bind("change:template_name",this._setTemplate,this),this.model.bind("change:template",this._compileTemplate,this),this.model.bind("change:fields",this._changeFields,this),this.model.bind("change:alternative_names",this._alternameNames,this),this._setTemplate(),this._alternameNames(),this._changeFields(),this.model.get("template")&&this._compileTemplate(),this.targetPos=null,this.locked=!1,this.hideTimeout=-1},render:function(a){return this.model.fieldCount()?cdb.geo.ui.Tooltip.prototype.render.call(this,a):this.el.innerHTML="",this},_lock:function(a){this.locked=!0,clearTimeout(this.hideTimeout)},_unlock:function(a){this.locked=!1},_changeFields:function(){this.setFields(this.model.get("fields"))},_alternameNames:function(){this.options.alternative_names=this.model.get("alternative_names")},_compileTemplate:function(){var a=this.model.get("template")?this.model.get("template"):cdb.templates.getTemplate(this._getModelTemplate());"function"!=typeof a?this.template=new cdb.core.Template({template:a,type:this.model.get("template_type")||"mustache"}).asFunction():this.template=a,this.render()},_setTemplate:function(){this.model.get("template_name")&&(this.template=cdb.templates.getTemplate(this._getModelTemplate()),this.render())},_getModelTemplate:function(){return this._TEMPLATE_URL+"/"+this.model.get("template_name")},_move:function(){if(this.targetPos){var a=this.$el.position(),b=this.targetPos.x-a.left,c=this.targetPos.y-a.top;a.left+=.05*b,a.top+=.05*c,this.$el.css(a),!this.locked&&(Math.abs(b)>1||Math.abs(c)>1)&&L.Util.requestAnimFrame(this._move,this)}}}),cdb.admin.RowView=cdb.ui.common.RowView.extend({classLabel:"cdb.admin.RowView",events:{"click      .row_header":"_onOptionsClick","mouseout   .row_header":"_onOptionsOut"},cellRenderers:{default:"_renderDefault",boolean:"_renderBoolean",number:"_renderNumber",geometry:"_renderGeometry"},initialize:function(){this.elder("initialize"),_.bindAll(this,"_onOptionsClick","_onOptionsOut"),this.options.row_header=!0,this.retrigger("saving",this.model),this.retrigger("saved",this.model),this.retrigger("errorSaving",this.model)},_getRowOptions:function(){if(!cdb.admin.RowView.rowOptions){var a=cdb.admin.RowView.rowOptions=new cdb.admin.RowHeaderDropdown({position:"position",user:this.tableView.user,template_base:"table/views/table_row_header_options",tick:"top",horizontal_position:"left",tableData:this.getTableView().dataModel,table:this.getTableView().model});a.render(),this.retrigger("createRow",a)}return cdb.admin.RowView.rowOptions},_onOptionsOut:function(a){var b=$(a.relatedTarget);b.closest("tr").attr("id");0==b.closest(".dropdown").length&&0==b.closest(".row_header").length&&this.rowOptions&&this.rowOptions.hide()},_onOptionsClick:function(a){var b,c,d,e,f=$(a.target);if(c=this.getTableView().dataModel,!this.table.isReadOnly())return b=this._getRowOptions(),a.preventDefault(),f.append(b.el),d=30,e=5,f.closest("tr").is(":last-child")&&f.closest("tr").index()>1?(b.options.vertical_position="top",b.options.tick="bottom"):(b.options.vertical_position="down",b.options.tick="top"),b.setRow(this.model),b.openAt(d,e),this.rowOptions=b,!1},valueView:function(a,b){this.table=this.table||this.getTableView().model;var c="_renderDefault";if(a.length){var d=this.table.getColumnType(a);c=this.cellRenderers[d]||c}var e=$(this[c](b));return e.addClass("cell"),cdb.admin.Row.isReservedColumn(a)&&e.addClass("disabled"),""===a&&""===b&&(this.table.isReadOnly()?e.addClass("disabled").html(""):e.addClass("row_header")),e},_renderDefault:function(a,b){b=b||"";var c;return null===a?(b+=" isNull",c='<div class="'+b+'">null</div>'):c='<div class="'+b+'">'+_.escape(a)+"</div>",c},_renderBoolean:function(a){return this._renderDefault(a,"boolean")},_renderNumber:function(a){return this._renderDefault(a,"number")},_renderGeometry:function(a){function b(a){var b=_.uniq(d.table.geomColumnTypes());return!_.isNull(a)&&b&&b.length&&b[0]&&(b=b[0],a=b.charAt(0).toUpperCase()+b.substring(1).toLowerCase()),a}function c(a){var b="       ";return void 0!==a&&(b=a.toFixed(4),a>0&&(b=" "+b)),b}var d=this,e={};try{e=JSON.parse(a),a="Point"===e.type?c(e.coordinates[0])+","+c(e.coordinates[1]):b(a)}catch(c){a=b(a)}return this._renderDefault(a)}}),function(){var a=cdb.admin.HeaderView=cdb.core.View.extend({_TEXTS:{no_geo:{title:_t("Georeference your table"),description:_t('This funcionality is not available in the visualization view.                     Please, visit <a href="<%- prefix %>/tables/<%- table_name %>">your table</a> and start georeferencing there.'),ok:_t("Ok, close")}},NO_MENU_COLUMNS:["the_geom","the_geom_webmercator"],events:{"dblclick .coloptions":"renameColumn","click    .coloptions":"showColumnOptions","click    .coltype":"showColumnTypeOptions","click    .geo":"showGeoreferenceWindow","keydown  .col_name_edit":"_checkEditColnameInput","focusout input":"_finishEdit",click:"activateColumnOptions"},initialize:function(){this.column=this.options.column,this.table=this.options.table,this.vis=this.options.vis,this.template=this.getTemplate("table/views/table_header_view"),this.editing_name=!1,this.changing_type=!1,this.vis.bind("change:type",function(){a&&a.colTypeOptions.render()}),this.add_related_model(this.vis),void 0===a.colOptions&&(a.colOptions=new cdb.admin.HeaderDropdown({user:this.options.user,position:"position",horizontal_position:"right",tick:"right",template_base:"table/views/table_header_options",sqlView:this.options.sqlView,vis:this.vis}),a.colOptions.render(),cdb.god.bind("closeDialogs",a.colOptions.hide,a.colOptions)),void 0===a.colTypeOptions&&(a.colTypeOptions=new cdb.admin.ColumntypeDropdown({user:this.options.user,position:"position",horizontal_position:"right",tick:"right",template_base:"table/views/table_column_type_options"}),a.colTypeOptions.render(),cdb.god.bind("closeDialogs",a.colTypeOptions.hide,a.colTypeOptions))},_addColumn:function(a){table.tableTab.tableView.addColumn(a)},render:function(){if(this.$el.html(""),this.$el.append(this.template({col_name:this.column[0],col_type:this.column[1],editing_name:this.editing_name,changing_type:this.changing_type,read_only:this.table.isReadOnly(),isReservedColumn:this.table.isReadOnly()||this.table.isReservedColumn(this.column[0]),noMenu:this.NO_MENU_COLUMNS.indexOf(this.column[0])>=0})),this.editing_name){var a=this.$el.find("p.auto").width()||175;this.$el.find("input").css({"max-width":a,width:a}).focus()}return this.delegateEvents(),this},_openColOptions:function(b){var c=this,d=a.colOptions;d.off(),cdb.god.unbind("closeDialogs",a.colOptions.hide,a.colOptions),cdb.god.trigger("closeDialogs"),d.setTable(this.table,this.column[0]),d.bind("addColumn",this._addColumn,this),d.bind("renameColumn",this.renameColumn,this),d.bind("changeType",this._changeType,this),d.bind("clearView",function(){c.trigger("clearView")},this),d.bind("georeference",function(a){c.trigger("georeference",a)},this),d.bind("applyFilter",function(a){c.trigger("applyFilter",a)},this);var e=$(b.target).parent().parent();e.append(d.el);var f=$(b.target).width()+26,g=e.parent();d.openAt(f-d.$el.width(),g.height()/2+7),cdb.god.bind("closeDialogs",a.colOptions.hide,a.colOptions)},_openColTypeOptions:function(b){if(!this.table.isReadOnly()){var c=a.colTypeOptions;c.off(),cdb.god.unbind("closeDialogs",a.colTypeOptions.hide,a.colTypeOptions),cdb.god.trigger("closeDialogs"),c.setTable(this.table,this.column[0]);var d=$(b.target).parent().parent();d.append(c.el);var e=$(b.target).outerWidth()+24,f=d.parent();c.openAt(e-c.$el.width(),f.height()/2+25),cdb.god.bind("closeDialogs",a.colTypeOptions.hide,a.colTypeOptions)}},_checkEditColnameInput:function(a){13===a.keyCode&&this._submitEdit(),27===a.keyCode&&this._finishEdit()},_submitEdit:function(){this.table.renameColumn(this.column[0],$(".col_name_edit").val()),this._finishEdit()},_finishEdit:function(){this.editing_name=!1,this.render()},renameColumn:function(a){a&&this.killEvent(a),this.editing_name=!0,this.changing_type=!1,this.render()},_changeType:function(a){this.editing_name=!1,this.changing_type=!0;var b=this.$el.find("a.coltype");b.click()},activateColumnOptions:function(a){this.killEvent(a),this.$el.find("a.coloptions").click()},showColumnOptions:function(b){var c=this,d=a.colOptions,e=this.column[0];return b.preventDefault(),d.isOpen&&e==d.column?(d.hide(),!1):(this.NO_MENU_COLUMNS.indexOf(this.column[0])<0&&d.hide(function(){d.parent_&&d.parent_.css("z-index",0);var a=c.$el.find("th > div");d.parent_=a,a.css("z-index","100"),c._openColOptions(b)}),!1)},showGeoreferenceWindow:function(a){this.killEvent(a),this.trigger("georeference",null)},showColumnTypeOptions:function(b){var c=this,d=a.colTypeOptions,e=this.column[0];return b&&b.preventDefault(),d.isOpen&&e==d.column?(d.hide(),!1):(d.hide(function(){c._openColTypeOptions(b)}),!1)}})}(),function(){cdb.admin.TableView=cdb.ui.common.Table.extend({classLabel:"cdb.admin.TableView",events:cdb.core.View.extendEvents({"click .clearview":"_clearView","click .sqlview .export_query":"_tableFromQuery","click .noRows":"addEmptyRow"}),rowView:cdb.admin.RowView,initialize:function(){this.elder("initialize"),this.options.row_header=!0,this.globalError=this.options.globalError,this.vis=this.options.vis,this.user=this.options.user,this._editorsOpened=null,this.initializeBindings(),this.initPaginationAndScroll()},initializeBindings:function(){var a=this;_.bindAll(this,"render","rowSaving","addEmptyRow","_checkEmptyTable","_forceScroll","_scrollMagic","rowChanged","rowSynched","_startPagination","_finishPagination","rowFailed","rowDestroyed","emptyTable"),this.model.data().bind("newPage",this.newPage,this),this.model.data().bind("endLoadingRows",this._finishPagination),this.bind("cellDblClick",this._editCell,this),this.bind("createRow",function(){a._checkEmptyTable()}),this.model.bind("change:dataSource",this._onSQLView,this),this.model.bind("dataLoaded",function(){a._forceScroll()},this),this.model.bind("change:permission",this._checkEmptyTable,this),this.model.bind("change:isSync",this._swicthEnabled,this),this._swicthEnabled(),cdb.god.bind("panel_action",function(b){a._moveInfo(b)},this),this.add_related_model(cdb.god),this.options.geocoder.bind("geocodingComplete geocodingError geocodingCanceled",function(){this.notice(_t("loaded"))},this),this.add_related_model(this.options.geocoder)},initPaginationAndScroll:function(){var a=this,b=!1,c=!1;this.scroll_position={x:$(window).scrollLeft(),y:$(window).scrollTop(),last:"vertical"},$(window).scroll(this._scrollMagic);var d=2;this.checkScrollTimer=setInterval(function(){if(a.$el.is(":visible")&&!a.model.data().isFetchingPage()){var e=$(this).scrollTop(),f=a.model.data();e>d&&(b=!1);var g=$(window).height()-a.$el.offset().top,h=this.$("tbody").height(),i=e+g;h<g||(i<h-d&&(c=!1),i>=h?(c||(f.lastPage||a._startPagination("down"),setTimeout(function(){f.loadPageAtBottom()},600)),c=!0):e<=0&&(b||(f.pages&&0!=f.pages[0]&&a._startPagination("up"),setTimeout(function(){f.loadPageAtTop()},600)),b=!0),a._setUpPagination(f))}},300),this.bind("clean",function(){clearInterval(this.checkScrollTimer)},this)},needsRender:function(a){if(!a)return!0;var b=a.changedAttributes();return!b.geometry_types||1!==_.keys(b).length},render:function(a){this.needsRender(a)&&(this.elder("render",a),this.model.isInSQLView()&&this._onSQLView(),this._swicthEnabled(),this.trigger("render"))},_renderHeader:function(){var a=cdb.ui.common.Table.prototype._renderHeader.apply(this);return a.append($("<div>").addClass("shadow")),a},addColumn:function(a){this.newColumnName="column_"+(new Date).getTime(),this.model.addColumn(this.newColumnName,"string"),this.unbind("render",this._highlightColumn,this),this.bind("render",this._highlightColumn,this)},_highlightColumn:function(){if(this.newColumnName){var a=this.$("a[href='#"+this.newColumnName+"']").parents("th"),b=a.index();b&&(setTimeout(function(){var c=$(window).width();if(a&&a.position()){var d=a.position().left-c/2+a.width()/2;$(window).scrollLeft(d)}this.$("[data-x='"+b+"']").addClass("is-highlighted")},300),this.unbind("render",this._highlightColumn,this))}},_setUpPagination:function(a){var b=a.pages;b.length>0&&b[0]>0?(0==this.$el.find("tfoot.page_loader.up").length&&this.$el.append(this.getTemplate("table/views/table_pagination_loaders")({direction:"up"})),this.$el.parent().addClass("page_up")):this.$el.parent().removeClass("page_up"),a.lastPage?this.$el.parent().removeClass("page_down"):(0==this.$el.find("tfoot.page_loader.down").length&&this.$el.append(this.getTemplate("table/views/table_pagination_loaders")({direction:"down"})),this.$el.parent().addClass("page_down"))},_startPagination:function(a){this.$el.find(".page_loader."+a).addClass("active")},_finishPagination:function(a,b){0!=a&&"up"==b&&setTimeout(function(){$(window).scrollTop(180)},300),this.$el.find(".page_loader.active").removeClass("active")},_onSQLView:function(){this.$(".sqlview").remove(),this.options.sqlView.unbind("reset error",this._renderSQLHeader,this),this.options.sqlView.unbind("loading",this._renderLoading,this),this.options.sqlView.bind("loading",this._renderLoading,this),this.options.sqlView.bind("reset",this._renderSQLHeader,this),this.options.sqlView.bind("error",this._renderSQLHeader,this),this._renderSQLHeader()},_renderLoading:function(a){a=a||{},this.cleanEmptyTableInfo(),a.add||this._renderBodyTemplate("table/views/sql_loading")},_renderSQLHeader:function(){var a=this;if(a.model.isInSQLView()){var b=a.isEmptyTable();a.$("thead").find(".sqlview").remove(),a.$("thead").append(a.getTemplate("table/views/sql_view_notice")({empty:b,isVisualization:a.vis.isVisualization(),warnMsg:null})),a.$("thead > tr").css("height",106),a.isEmptyTable()&&a.addEmptySQLIfo(),a._moveInfo()}},_swicthEnabled:function(){this.$el[this.model.isSync()?"addClass":"removeClass"]("synced"),this.$el[this.vis.isVisualization()?"addClass":"removeClass"]("vis")},_clearView:function(a){return a&&a.preventDefault(),this.options.layer.clearSQLView(),!1},_tableFromQuery:function(a){a.preventDefault();var b=new cdb.editor.DuplicateDatasetView({model:this.model,user:this.user,clean_on_hide:!0});b.appendToBody()},_scrollMagic:function(a){var b={x:$(window).scrollLeft(),y:$(window).scrollTop()};this.scroll_position.x!=b.x?(this.scroll_position.x=b.x,this.$el.find("thead").addClass("horizontal"),"vertical"==this.scroll_position.last&&(this.scroll_position.x=b.x,this.$el.find("thead > tr > th > div > div:not(.dropdown)").removeAttr("style").css("top",b.y+"px"),this.scroll_position.last="horizontal")):this.scroll_position.y!=b.y&&(this.scroll_position.y=b.y,this.$el.find("thead").removeClass("horizontal"),"horizontal"==this.scroll_position.last&&(this.$el.find("thead > tr > th > div > div:not(.dropdown)").removeAttr("style").css({marginLeft:"-"+b.x+"px"}),this.scroll_position.last="vertical"))},_moveInfo:function(a){if("show"==a)this.$el.removeClass("narrow").addClass("displaced");else if("narrow"==a)this.$el.addClass("displaced narrow");else if("hide"==a)this.$el.removeClass("displaced narrow");else if($(".table_panel").length>0){var b=0==$(".table_panel").css("right").replace("px","");b||this.$el.removeClass("displaced")}},_getEditor:function(a,b){var c={string:cdb.admin.StringField,number:cdb.admin.NumberField,date:cdb.admin.DateField,geometry:cdb.admin.GeometryField,"timestamp with time zone":cdb.admin.DateField,"timestamp without time zone":cdb.admin.DateField,boolean:cdb.admin.BooleanField},d=_.filter(c,function(b,c){return c===a}).length>0;return"undefined"!==a&&d?c[a]:c.string},closeEditor:function(){this._editorsOpened&&(this._editorsOpened.hide(),this._editorsOpened.clean())},_editCell:function(a,b,c,d){var e=this;this.closeEditor();var f=e.model.columnName(c-1),g=this.model.getColumnType(f);if(!this.model.isReservedColumn(f)||this.model.isReadOnly()||"geometry"==g){var h=e.model.data().getRowAt(d),i="";0===e.model.data().getCell(d,f)||"0"===e.model.data().getCell(d,f)?i="0":void 0!==e.model.data().getCell(d,f)&&(i=e.model.data().getCell(d,f)),"the_geom"==f&&(g="geometry");var j=_.clone(h.toJSON()),k=this._editorsOpened=new cdb.admin.SmallEditorDialog({value:i,column:f,row:h,rowNumber:d,readOnly:this.model.isReadOnly(),editorField:this._getEditor(g),res:function(a){_.isEqual(a,j[f])||(h.bind("error",function a(){h.unbind("error",a),h.set(f,j[f])}),h.save(f,a).done(function(a){e.model.trigger("data:saved")}))}});if(!k)return void cdb.log.error("editor not defined for column type "+g);var l=$(a.target).closest("td"),m=l.offset(),n=$(a.target).closest("tr"),o=Math.min(l.outerWidth(),278);m.top=m.top-this.$el.offset().top,0==l.parent().index()?m.top+=5:m.top-=11,l.index()==n.find("td").size()-1&&n.find("td").size()<2?m.left-=o/2:m.left-=11,k.showAt(m.left,m.top,o,!0)}},headerView:function(a){var b=this;if("header"!==a[1]){var c=new cdb.admin.HeaderView({column:a,table:this.model,sqlView:this.options.sqlView,user:this.user,vis:this.vis}).bind("clearView",this._clearView,this).bind("georeference",function(a){var b,c=this.options.backgroundPollingModel,d=this.model.isSync(),e=""===c||c.canAddGeocoding();if(this.options.geocoder.isGeocoding()||d||!e){if(!this.options.geocoder.isGeocoding()&&(e||d))return;b=cdb.editor.ViewFactory.createDialogByTemplate("common/background_polling/views/geocodings/geocoding_in_progress")}else var b=new cdb.editor.GeoreferenceView({table:this.model,user:this.user,tabs:["lonlat","city","admin","postal","ip","address"],option:"lonlat",data:{longitude:a}});b.appendToBody()},this).bind("applyFilter",function(a){b.options.menu.show("filters_mod"),b.options.layer.trigger("applyFilter",a)},this);return this.addView(c),this.newColumnName==a[0]&&setTimeout(function(){c.renameColumn(),b.newColumnName=null},300),c.render().el}return"<div><div></div></div>"},_checkEmptyTable:function(){this.isEmptyTable()?this.addEmptyTableInfo():this.cleanEmptyTableInfo()},_forceScroll:function(a){$(window).scrollLeft(0)},_renderEmpty:function(){this.addEmptyTableInfo()},addEmptyTableInfo:function(){if(0==this.$(".noRows").length&&!this.model.isInSQLView()&&this.model.get("schema")){if(this.elder("addEmptyTableInfo"),this.$el.hide(),!this.model.isReadOnly()){for(var a=this.model.get("schema").length,b='<tr class="placeholder noRows"><td class="addNewRow">+</td>',c=0;c<a;c++)b+="<td></td>";b+="</tr>";for(var d='<tr class="placeholder noRows decoration"><td></td>',c=0;c<a;c++)d+="<td></td>";d+="</tr>";var e=$(b+d);this.$el.append(e)}this.template_base=cdb.templates.getTemplate(this.model.isReadOnly()?"table/views/empty_readtable_info":"table/views/empty_table");
var f=this.template_base(),g=$('<tfoot><tr><td colspan="100">'+f+"</td></tr></tfoot>");this.$el.append(g),this.$el.fadeIn()}},addEmptySQLIfo:function(){this.model.isInSQLView()&&this._renderBodyTemplate("table/views/empty_sql")},_renderBodyTemplate:function(a){this.$("tbody").html(""),this.$("tfoot").remove(),this.$el.hide();var b=!1;$(".table_panel").length>0&&(b=0==$(".table_panel").css("right").replace("px",""));var c=cdb.templates.getTemplate(a)({panel_opened:b}),d=$('<tfoot class="sql_loader"><tr><td colspan="100">'+c+"</td></tr></tfoot>");this.$el.append(d),this.$el.fadeIn()},cleanEmptyTableInfo:function(){this.$("tfoot").fadeOut("fast",function(){$(this).remove()}),this.$(".noRows").slideUp("fast",function(){$(this).remove()})},notice:function(a,b,c){this.globalError.showError(a,b,c)},addEmptyRow:function(){this.dataModel.addRow({at:0}),this.cleanEmptyTableInfo()},rowSaving:function(){this.notice("Saving your edit","load",-1)},rowSynched:function(){this.notice("Sucessfully saved")},rowFailed:function(){this.notice("Oops, there has been an error saving your changes.","error")},rowDestroying:function(){this.notice("Deleting row","load",-1)},rowDestroyed:function(){this.notice("Sucessfully deleted"),this._checkEmptyTable()}}),cdb.admin.TableTab=cdb.core.View.extend({className:"table",initialize:function(){this.user=this.options.user,this.sqlView=this.options.sqlView,this.geocoder=this.options.geocoder,this.backgroundPollingModel=this.options.backgroundPollingModel,this._initBinds()},setActiveLayer:function(a){var b=!!this.tableView;this.deactivated(),this.model=a.table,this.layer=a.model,this.sqlView=a.sqlView,b&&this.activated()},_initBinds:function(){this.geocoder.bind("geocodingComplete geocodingError geocodingCanceled",function(){this.model.data&&this.model.data().refresh()},this),this.add_related_model(this.geocoder)},_createTable:function(){this.tableView=new cdb.admin.TableView({dataModel:this.model.data(),model:this.model,sqlView:this.sqlView,layer:this.layer,geocoder:this.options.geocoder,backgroundPollingModel:this.backgroundPollingModel,vis:this.options.vis,menu:this.options.menu,user:this.user,globalError:this.options.globalError})},activated:function(){this.tableView||(this._createTable(),this.tableView.render(),this.render())},deactivated:function(){this.tableView&&(this.tableView.clean(),this.tableView=null,this.hasRenderedTableView=!1)},render:function(){return this.tableView&&!this.hasRenderedTableView&&(this.hasRenderedTableView=!0,this.$el.append(this.tableView.el)),this}})}(),cdb.admin.LeafletMapView=cdb.geo.LeafletMapView.extend(GrouperLayerMapView(cdb.geo.LeafletMapView)),"undefined"!=typeof google&&(cdb.admin.GoogleMapsMapView=cdb.geo.GoogleMapsMapView.extend(GrouperLayerMapView(cdb.geo.GoogleMapsMapView))),cdb.admin.MapTab=cdb.core.View.extend({events:{"click .toggle_slides.button":"_toggleSlides","click .add_overlay.button":"killEvent","click .canvas_setup.button":"killEvent","click .export_image.button":"_exportImage","click .sqlview .clearview":"_clearView","click .sqlview .export_query":"_tableFromQuery",keydown:"_onKeyDown"},_TEXTS:{no_interaction_warn:_t("Map interaction is disabled, select cartodb_id to enable it")},className:"map",animation_time:300,initialize:function(){this.template=this.getTemplate("table/views/maptab"),this.map=this.model,this.user=this.options.user,this.vis=this.options.vis,this.master_vis=this.options.master_vis,this.canvas=new cdb.core.Model({mode:"desktop"}),this.map_enabled=!1,this.georeferenced=!1,this.featureHovered=null,this.activeLayerView=null,this.layerDataView=null,this.layerModel=null,this.legends=[],this.overlays=null,this.add_related_model(this.map),this.add_related_model(this.canvas),this.add_related_model(this.map.layers),this._addBindings()},_addBindings:function(){cdb.god.bind("panel_action",function(a){this._moveInfo(a)},this),this.add_related_model(cdb.god),this.map.bind("change:provider",this.switchMapType,this),this.map.bind("change:legends",this._toggleLegends,this),this.map.layers.bind("change:visible",this._addLegends,this),this.map.layers.bind("change:visible",this._addTimeline,this),this.map.layers.bind("change:tile_style",this._addTimeline,this),this.map.layers.bind("remove reset",this._addLegends,this),this.map.layers.bind("remove reset",this._addTimeline,this),_.bindAll(this,"showNoGeoRefWarning","_exportImage")},isMapEnabled:function(){return this.map_enabled},deactivated:function(){this.map_enabled&&this.clearMap()},clearMap:function(){clearTimeout(this.autoSaveBoundsTimer),this.mapView.clean(),this.exportImageView&&(this.exportImageView.clean(),this.exportImageView=null),this.overlaysDropdown&&this.overlaysDropdown.clean(),this.mapOptionsDropdown&&this.mapOptionsDropdown.clean(),this.basemapDropdown&&this.basemapDropdown.clean(),this.configureCanvasDropdown&&this.configureCanvasDropdown.clean(),this.zoom&&this.zoom.clean(),this.infowindow&&this.infowindow.clean(),this.overlays&&this.overlays._cleanOverlays(),this._cleanLegends(),this.stackedLegend&&this.stackedLegend.clean(),this.timeline&&(this.timeline.clean(),this.timeline=null),this.geometryEditor&&this.geometryEditor.clean(),this.table&&this.table.unbind(null,null,this),delete this.mapView,delete this.overlaysDropdown,delete this.basemapDropdown,delete this.mapOptionsDropdown,delete this.configureCanvasDropdown,delete this.zoom,delete this.infowindow,delete this.layer_selector,delete this.header,delete this.share,delete this.legends,delete this.overlays,delete this.legend,delete this.stackedLegend,delete this.geometryEditor,this.map_enabled=!1,this.render()},_hideInfowindow:function(){this.infowindow&&this.infowindow.model.set("visibility",!1)},switchMapType:function(){this.map_enabled&&(this.clearMap(),this.enableMap())},_showGMapsDeprecationDialog:function(){var a=cdb.editor.ViewFactory.createDialogByTemplate("common/dialogs/confirm_gmaps_basemap_to_leaflet_conversion"),b=this;a.ok=function(){b.map.set("provider","leaflet",{silent:!0}),b.setupMap(),this.close&&this.close()},a.cancel=function(){b.user.isInsideOrg()?window.location="/u/"+b.user.get("username")+"/dashboard":window.location="/dashboard"},a.appendToBody()},enableMap:function(){this.render();var a=this.map.getBaseLayer();return"undefined"==typeof cdb.admin.GoogleMapsMapView&&a&&this.map.isProviderGmaps()?void this._showGMapsDeprecationDialog():void this.setupMap()},setupMap:function(){this.$(".tipsy").remove();var a=this;if(!this.map_enabled){this._addMapView(),this.clickTimeout=null,this._bindMissingClickEvents(),this.map_enabled=!0,$(".map").append('<div class="map-options" />').append("<div class='mobile_bkg' />"),this._addBasemapDropdown(),this._addInfowindow(),this._addTooltip(),this._addLegends(),this._addOverlays(),this._showPecan(),this._showScratchDialog(),this.user.featureEnabled("slides")&&this._addSlides();var b=this.vis.get("type");"table"!==b&&(this._addOverlaysDropdown(),this._addConfigureCanvasDropdown(),this._addMapOptionsDropdown(),this.canvas.on("change:mode",this._onChangeCanvasMode,this)),this.master_vis.on("change:type",function(){"table"===this.master_vis.previous("type")&&this.switchMapType()},this),this.autoSaveBoundsTimer=setTimeout(function(){a.mapView.on("dragend zoomend",function(){a.mapView._saveLocation()})},1e3)}},_addMapView:function(){var a=this.$(".cartodb-map"),b=cdb.admin.LeafletMapView;if("googlemaps"===this.map.get("provider"))var b=cdb.admin.GoogleMapsMapView;this.mapView=new b({el:a,map:this.map,user:this.user}),this.mapView.bind("removeLayerView",function(a){this.layer_selector&&this.layer_selector.render()},this),this.mapView.bind("newLayerView",function(a,b){this.activeLayerView&&this.activeLayerView.model.id===b.id&&(this._bindDataLayer(this.activeLayerView,b),this.layer_selector&&this.layer_selector.render()),this._addTimeline()},this),this.activeLayerView&&this._bindDataLayer(this.activeLayerView,this.activeLayerView.model)},_addConfigureCanvasDropdown:function(){this.configureCanvasDropdown||(this.configureCanvasDropdown=new cdb.admin.ConfigureCanvasDropdown({target:$(".canvas_setup"),position:"position",canvas:this.canvas,template_base:"table/views/canvas_setup_dropdown",tick:"left",horizontal_position:"left",horizontal_offset:"40px"}),this.addView(this.configureCanvasDropdown),this.configureCanvasDropdown.bind("onDropdownShown",function(){this.exportImageView&&this.exportImageView.hide()},this),cdb.god.bind("closeDialogs",this.configureCanvasDropdown.hide,this.configureCanvasDropdown),$(".canvas_setup").append(this.configureCanvasDropdown.render().el))},_addOverlaysDropdown:function(){this.overlaysDropdown||(this.overlaysDropdown=new cdb.admin.OverlaysDropdown({vis:this.master_vis,canvas:this.canvas,mapView:this.mapView,target:$(".add_overlay"),position:"position",collection:this.vis.overlays,template_base:"table/views/widget_dropdown",tick:"left",horizontal_position:"left",horizontal_offset:"40px"}),this.addView(this.overlaysDropdown),this.overlaysDropdown.bind("onOverlayDropdownOpen",function(){this.slidesPanel&&this.slidesPanel.hide(),this.exportImageView&&this.exportImageView.hide()},this),cdb.god.bind("closeDialogs",this.overlaysDropdown.hide,this.overlaysDropdown),cdb.god.bind("closeOverlayDropdown",this.overlaysDropdown.hide,this.overlaysDropdown),$(".add_overlay").append(this.overlaysDropdown.render().el))},_addBasemapDropdown:function(){if(!this.basemapDropdown){if("table"!==this.vis.get("type")){var a=$('<a href="#" class="option-button dropdown basemap_dropdown"><div class="thumb"></div>Change basemap</a>');$(".map-options").append(a)}this.basemapDropdown=new cdb.admin.DropdownBasemap({target:$(".basemap_dropdown"),position:"position",template_base:"table/views/basemap/basemap_dropdown",model:this.map,mapview:this.mapView,user:this.user,baseLayers:this.options.baseLayers,tick:"left",vertical_offset:40,horizontal_position:"left",vertical_position:"table"===this.vis.get("type")?"down":"up",horizontal_offset:"table"===this.vis.get("type")?42:0}),this.addView(this.basemapDropdown),this.basemapDropdown.bind("onDropdownShown",function(){cdb.god.trigger("closeDialogs")}),cdb.god.bind("closeDialogs",this.basemapDropdown.hide,this.basemapDropdown),$(".basemap_dropdown").append(this.basemapDropdown.render().el)}this.map.getBaseLayer()&&this.basemapDropdown.setActiveBaselayer()},bindGeoRefCheck:function(){this.table.data().fetched?this.checkGeoRef():this.table.bind("dataLoaded",function(){this.checkGeoRef(),this.scratchDialog||this._showScratchDialog(),this.pecanView||this._showPecan()},this)},activated:function(){this.checkGeoRef(),$(window).scrollTop(0)},checkGeoRef:function(){this.options&&this.table&&(this.georeferenced=this.table.isGeoreferenced(),this.noGeoRefDialog&&this.noGeoRefDialog.hide(),this.georeferenced||this.table.data().length>0&&this[this.table.isSync()?"_showNoGeoWarning":"showNoGeoRefWarning"]())},_showNoGeoWarning:function(){var a="noGeoWarningDialog_"+this.table.id+"_"+this.table.get("map_id");this.noGeoWarningDialog||localStorage[a]||(this.noGeoWarningDialog=cdb.editor.ViewFactory.createDialogByTemplate("table/views/no_geo_warning_template",{clean_on_hide:!0}),this.noGeoWarningDialog.bind("hide",function(){localStorage[a]=!0}),this.noGeoWarningDialog.appendToBody())},_showPecan:function(){var a=this.user.featureEnabled("pecan_cookies"),b=!!(this.options.table&&this.options.table.data()&&this.options.table.data().length>0);if(a&&b){var c="pecan_"+this.options.user.get("username")+"_"+this.options.table.id;localStorage[c]||(this.pecanView=new cdb.editor.PecanView({table:this.options.table,backgroundPollingModel:this.options.backgroundPollingModel}))}},_showScratchDialog:function(){if(this.options.table&&this.options.table.data().fetched&&0===this.options.table.data().length){var a="scratchDialog_"+this.options.table.id+"_"+this.options.table.get("map_id");localStorage[a]||(this.scratchDialog=new cdb.editor.ScratchView({table:this.options.table}),this.scratchDialog.appendToBody(),this.scratchDialog.bind("newGeometry",function(a){this._addGeometry(a)},this),this.scratchDialog.bind("skip",function(){localStorage[a]=!0}))}},_bindMissingClickEvents:function(){var a=this;this.mapView.bind("click",function(b){null===a.clickTimeout&&(a.clickTimeout=setTimeout(function(){a.clickTimeout=null,a.featureHovered||a.trigger("missingClick")},150)),!a.featureHovered&&b.preventDefault&&(b.preventDefault(),b.stopPropagation())}),this.mapView.bind("dblclick",function(){null!==a.clickTimeout&&(clearTimeout(a.clickTimeout),a.clickTimeout=null)})},setActiveLayer:function(a){if(this.activeLayerView=a,this.mapView&&this.mapView.getLayerByCid(a.model.cid)){var b=a.model;this._bindDataLayer(a,b)}},_bindDataLayer:function(a,b){var c=this,d=b.get("type");"CartoDB"!==d&&"torque"!==d||(c.layerDataView&&c.layerDataView.unbind(null,null,this),c.layerModel&&c.layerModel.unbind(null,null,this),c.options.geocoder&&c.options.geocoder.unbind(null,null,this),c.infowindowModel=b.infowindow,c.tooltipModel=b.tooltip,c.legendModel=b.legend,c._bindTable(b.table),c._bindSQLView(b.sqlView),c.layerDataView=c.mapView.getLayerByCid(b.cid),c.mapView.setActiveLayer(b),c._addLegends(),c._addTimeline(),c.layerDataView&&(c.layerDataView.bind("featureClick",c.featureClick,c),c.layerDataView.bind("featureOut",c.featureOut,c),c.layerDataView.bind("featureOver",c.featureOver,c),c.layerDataView.bind("loading",c.loadingTiles,c),c.layerDataView.bind("load",c.loadTiles,c),c.layerDataView.bind("error",c.loadTiles,c),c.tooltip.setLayer(c.layerDataView).enable()),a&&b&&(b.unbind("startEdition",this._addGeometry,this),b.bind("startEdition",this._addGeometry,this)),b&&(c.layerModel=b,b.bind("change:interactivity",this._updateSQLHeader,this),this._updateSQLHeader()),c.options.geocoder&&(c.options.geocoder.bind("geocodingComplete geocodingError geocodingCanceled",this.updateDataLayerView,this),c.add_related_model(c.options.geocoder)))},_cleanLegends:function(){this.legends&&_.each(this.legends,function(a){a.clean()}),this.legends=[]},_getCartoDBLayers:function(){return this.map.layers.models.filter(function(a){return"CartoDB"===a.get("type")})},_onKeyDown:function(a){this.overlays&&86==a.which&&(a.ctrlKey||a.metaKey)&&this.overlays.paste()},_onChangeCanvasMode:function(){var a=this;cdb.god.trigger("closeDialogs");var b=this.canvas.get("mode");"desktop"===b?(this._showDesktopCanvas(b),this.overlays.loader&&this.overlays.fullscreen&&setTimeout(function(){a.overlays&&a.overlays._positionOverlaysVertically(!0)},500)):"mobile"===b&&(this._showMobileCanvas(b),setTimeout(function(){a.overlays&&a.overlays._positionOverlaysVertically(!0)},300))},_showMobileCanvas:function(a){var b=this,c=288,d=476;this.overlays._hideOverlays("desktop");var e=$("div.map div.cartodb-map");this.$el.addClass(a);var f=function(){e.animate({width:c,marginLeft:-Math.round(c/2)-1,left:"50%"},{easing:"easeOutQuad",duration:200,complete:h})},g=function(){b.$el.find(".mobile_bkg").animate({opacity:1},{duration:250}),b.overlays._showOverlays(a);var c=b.map.get("center");b.mapView.invalidateSize(),e.fadeOut(250),setTimeout(function(){b.mapView.map.setCenter(c),e.fadeIn(250)},300)},h=function(){e.animate({height:d,marginTop:-Math.round(d/2)+23,top:"50%"},{easing:"easeOutQuad",duration:200,complete:g})};f(),this._enableAnimatedMap(),this._enableMobileLayout()},_enableMobileLayout:function(){if(this.mobile)this.mobile.show();else{this.mobile=new cdb.admin.overlays.Mobile({mapView:this.mapView,overlays:this.overlays,map:this.map}),this.mapView.$el.append(this.mobile.render().$el)}},_disableMobileLayout:function(){this.mobile&&this.mobile.hide()},_showDesktopCanvas:function(a){var b=this;this.overlays._hideOverlays("mobile"),this.$el.removeClass("mobile"),this.$el.find(".mobile_bkg").animate({opacity:0},250);var c=$("div.map div.cartodb-map"),d=c.css("top"),e=c.css("left"),f=c.css("marginTop"),g=c.css("marginLeft"),h=c.width(),i=c.height(),j=c.css({width:"auto",marginLeft:0,left:"15px"}).width();autoHeight=c.css({height:"auto",marginTop:0,top:"82px"}).height(),c.height(i),c.width(h),c.css({top:d,left:e,marginLeft:g,marginTop:f,height:i,width:h});var k=function(){c.css("width","auto"),b.overlays._showOverlays(a);var d=b.map.get("center");b.mapView.invalidateSize(),setTimeout(function(){b.mapView.map.setCenter(d)},300)},l=function(){c.css("height","auto"),c.animate({width:j,left:"15px",marginLeft:"0"},{easing:"easeOutQuad",duration:200,complete:k})},m=function(){c.animate({height:autoHeight,top:"82",marginTop:"0"},{easing:"easeOutQuad",duration:200,complete:l})};m(),this._disableAnimatedMap(),this._disableMobileLayout()},_enableAnimatedMap:function(){var a=this;setTimeout(function(){a.$el.addClass("animated")},800)},_disableAnimatedMap:function(){this.$el.removeClass("animated")},_addMapOptionsDropdown:function(){if(!this.mapOptionsDropdown){var a=$("<a href='#show-options' class='option-button show-table-options'>Options</a>");this.$options=a,$(".map-options").append(a),this.mapOptionsDropdown=new cdb.admin.MapOptionsDropdown({target:$(".show-table-options"),template_base:"table/views/map_options_dropdown",table:table,model:this.map,mapview:this.mapView,collection:this.vis.overlays,user:this.user,vis:this.vis,canvas:this.canvas,position:"position",tick:"left",vertical_position:"up",horizontal_position:"left",horizontal_offset:"-3px"}),this._bindMapOptions(),this.addView(this.mapOptionsDropdown),$(".show-table-options").append(this.mapOptionsDropdown.render().el)}},_bindMapOptions:function(){this.mapOptionsDropdown.bind("onDropdownShown",function(){cdb.god.trigger("closeDialogs"),this.$options.addClass("open")},this),this.mapOptionsDropdown.bind("onDropdownHidden",function(){this.$options.removeClass("open")},this),this.mapOptionsDropdown.bind("createOverlay",function(a,b){this.vis.overlays.createOverlayByType(a,b)},this),cdb.god.bind("closeDialogs",this.mapOptionsDropdown.hide,this.mapOptionsDropdown)},_addOverlays:function(){this.overlays=new cdb.admin.MapOverlays({headerMessageIsVisible:this._shouldAddSQLViewHeader(),vis:this.vis,canvas:this.canvas,mapView:this.mapView,master_vis:this.master_vis,mapToolbar:this.$el.find(".map_toolbar")})},_exportImage:function(a){this.killEvent(a),this.exportImageView||(this.exportImageView=new cdb.admin.ExportImageView({vizjson:this.vis.vizjsonURL(),vis:this.vis,user:this.options.user,overlays:this.overlays,mapView:this.mapView,width:this.mapView.$el.width(),height:this.mapView.$el.height(),map:this.map}),this.exportImageView.bind("was_removed",function(){this.exportImageView=null},this),this.mapView.$el.append(this.exportImageView.render().$el),cdb.god.bind("panel_action",function(a){"hide"!==a&&this.exportImageView&&this.exportImageView.hide()},this))},_addSlides:function(){this.vis.isVisualization()&&(this.slidesPanel=new cdb.admin.SlidesPanel({user:this.user,slides:this.vis.slides,toggle:this.$el.find(".toggle_slides")}),this.slidesPanel.bind("onChangeVisible",function(){this.exportImageView&&this.exportImageView.hide()},this),this.$el.append(this.slidesPanel.render().el),this.addView(this.slidesPanel))},_addLegends:function(){var a=this;if(this._cleanLegends(),this.map.get("legends"))for(var b=this.map.layers.models,c=b.length-1;c>=0;--c){var d=b[c];a._addLegend(d)}},_addLegend:function(a){var b=a.get("type");if(("CartoDB"===b||"torque"===b)&&this.table&&this.mapView&&(this.legend&&this.legend.clean(),a.get("visible"))){var c=new cdb.geo.ui.Legend({model:a.legend,mapView:this.mapView,table:this.table});this.legends&&(this.legends.push(c),this._renderStackedLengeds())}},_toggleLegends:function(){this.map.get("legends")?this._addLegends():this._cleanLegends()},_addTimeline:function(){if(this.mapView)if(this.map.layers.any(function(a){return"torque"===a.get("type")&&a.get("visible")})){var a=this.map.layers.getLayersByType("torque")[0],b=a.wizard_properties.get("torque-frame-count");this.timeline&&this.timeline.torqueLayer.model.cid!==a.cid&&(this.timeline.clean(),this.timeline=null),layerView=this.mapView.getLayerByCid(a.cid),layerView&&"undefined"!=typeof layerView.getStep&&b>1?this.timeline?this.timeline.setLayer(layerView):(this.timeline=new cdb.geo.ui.TimeSlider({layer:layerView,width:"auto"}),this.mapView.$el.append(this.timeline.render().$el),this.addView(this.timeline)):this.timeline&&(this.timeline.clean(),this.timeline=null)}else this.timeline&&this.timeline.clean(),this.timeline=null},_renderStackedLengeds:function(){this.stackedLegend&&this.stackedLegend.clean(),this.legend&&this.legend.clean(),this.stackedLegend=new cdb.geo.ui.StackedLegend({legends:this.legends}),this.mapView.$el.append(this.stackedLegend.render().$el),this.addView(this.stackedLegend)},_renderLegend:function(){this.legend&&this.legend.clean(),this.legend=this.legends[0],this.mapView.$el.append(this.legend.render().$el),this.legend.model.get("type")?this.legend.show():this.legend.hide(),this.addView(this.legend)},_addTooltip:function(){this.tooltip&&this.tooltip.clean(),this.table&&this.mapView&&(this.tooltip=new cdb.admin.Tooltip({model:this.tooltipModel,table:this.table,mapView:this.mapView,omit_columns:["cartodb_id"]}),this.mapView.$el.append(this.tooltip.render().el),this.tooltip.bind("editData",this._editData,this),this.tooltip.bind("removeGeom",this._removeGeom,this),this.tooltip.bind("editGeom",this._editGeom,this),this.layerDataView&&this.tooltip.setLayer(this.layerDataView).enable())},_addInfowindow:function(){if(this.infowindow&&this.infowindow.clean(),this.table&&this.mapView){this.infowindow=new cdb.admin.MapInfowindow({model:this.infowindowModel,mapView:this.mapView,table:this.table}),this.mapView.$el.append(this.infowindow.el),this.geometryEditor&&(this.geometryEditor.discard(),this.geometryEditor.clean()),this.geometryEditor=new cdb.admin.GeometryEditor({user:this.user,model:this.table}),this.geometryEditor.mapView=this.mapView,this.mapView.$el.append(this.geometryEditor.render().el),this.geometryEditor.hide(),this.geometryEditor.bind("editStart",this.hideDataLayer,this),this.geometryEditor.bind("editDiscard",this.showDataLayer,this),this.geometryEditor.bind("editFinish",this.showDataLayer,this),this.geometryEditor.bind("editFinish",this.updateDataLayerView,this),this.geometryEditor.bind("geomCreated",function(a){this.table.data().add(a)},this);this.infowindow.bind("editData",this._editData,this),this.infowindow.bind("removeGeom",this._removeGeom,this),this.infowindow.bind("editGeom",this._editGeom,this),this.infowindow.bind("openInfowindowPanel",function(){this.activeLayerView.showModule("infowindow","fields")},this),this.infowindow.bind("close",function(){this.tooltip&&this.tooltip.setFilter(null)},this),this.table.bind("remove:row",this.updateDataLayerView,this),this.table.bind("change:dataSource",function(){this.geometryEditor&&this.geometryEditor.discard()},this),this.map.bind("change:provider",function(){this.geometryEditor&&this.geometryEditor.discard()},this)}},_editGeom:function(a){"leaflet"===this.map.get("provider")&&this.map.clamp(),this.geometryEditor.editGeom(a)},_editData:function(a){if(!this.table.isReadOnly()){var b=this;return a.fetch({cache:!1,no_geom:!0,success:function(){var c=new cdb.editor.FeatureDataView({row:a,provider:b.map.get("provider"),baseLayer:b.map.getBaseLayer().clone(),dataLayer:b.layerModel.clone(),currentZoom:b.map.getZoom(),enter_to_confirm:!1,table:b.table,user:b.user,clean_on_hide:!0,onDone:b.updateDataLayerView.bind(b)});c.appendToBody()}}),!1}},_removeGeom:function(a){if(!this.table.isReadOnly()){var b=new cdb.editor.DeleteRowView({name:"feature",table:this.table,row:a,clean_on_hide:!0,enter_to_confirm:!0,wait:!0});return b.appendToBody(),!1}},_addGeometry:function(a){this.geometryEditor.createGeom(this.table.data().newRow(),a)},_bindTable:function(a){this.table&&this.table.unbind(null,null,this),this.table=a,this.table.bind("change:dataSource",this._hideInfowindow,this),this.table.bind("change:dataSource",this._updateSQLHeader,this),this.table.bind("change:schema",this._updateSQLHeader,this),this.table.bind("data:saved",this.updateDataLayerView,this),this._addInfowindow(),this._addLegends(),this._addTooltip(),this.bindGeoRefCheck()},_bindSQLView:function(a){this.sqlView&&this.sqlView.unbind(null,null,this),this.sqlView=a,this.sqlView.bind("reset error",this._updateSQLHeader,this),this.sqlView.bind("loading",this._renderLoading,this),this._updateSQLHeader()},_renderLoading:function(a){this._removeSQLViewHeader(),$(".table_panel").length>0&&(panel_opened=0==$(".table_panel").css("right").replace("px",""));var b=this.getTemplate("table/views/sql_view_notice_loading")({panel_opened:panel_opened});this.overlays&&this.overlays.setHeaderMessageIsVisible(!0),this.$(".cartodb-map").after(b)},_updateSQLHeader:function(){this._shouldAddSQLViewHeader()?this._addSQLViewHeader():this._removeSQLViewHeader()},_shouldAddSQLViewHeader:function(){return this.table&&this.table.isInSQLView()},loadingTiles:function(){this.overlays.loader&&this.overlays.loader.show()},loadTiles:function(){this.overlays.loader&&this.overlays.loader.hide()},featureOver:function(a,b,c,d){this.infowindowModel.get("disabled")||(this.mapView.setCursor("pointer"),this.featureHovered=d)},featureOut:function(){this.infowindowModel.get("disabled")||(this.mapView.setCursor("auto"),this.featureHovered=null)},featureClick:function(a,b,c,d){this.infowindowModel.get("disabled")||this.geometryEditor.isEditing()||(d.cartodb_id?(this.infowindow.setLatLng(b).setFeatureInfo(d.cartodb_id).showInfowindow(),this.tooltip.setFilter(function(a){return a.cartodb_id!==d.cartodb_id}).hide()):cdb.log.error("can't show infowindow, no cartodb_id on data"))},_moveInfo:function(a){"show"===a?this.$el.removeClass("narrow").addClass("displaced"):"hide"===a?this.$el.removeClass("narrow displaced"):"narrow"===a&&this.$el.addClass("narrow displaced")},render:function(){this.$el.html(""),this.$el.removeClass("mobile").removeClass("derived").removeClass("table"),this.$el.addClass(this.vis.isVisualization()?"derived":"table");this.map.get("provider");return this.$el.append(this.template({slides_enabled:this.user.featureEnabled("slides"),type:this.vis.get("type"),exportEnabled:!this.map.isProviderGmaps()})),this},showDataLayer:function(){this.mapView.enableInteraction(),this.layerDataView.setOpacity&&this.layerDataView.setOpacity(1)},hideDataLayer:function(){this.mapView.disableInteraction(),this.layerDataView.setOpacity&&this.layerDataView.setOpacity(.5)},updateDataLayerView:function(){this.layerDataView&&this.layerDataView.invalidate()},showNoGeoRefWarning:function(){var a="georefNoContentWarningShowed_"+this.table.id+"_"+this.table.get("map_id");this.noGeoRefDialog||this.table.isInSQLView()||localStorage[a]||(localStorage[a]=!0,this.noGeoRefDialog=new cdb.editor.GeoreferenceView({table:this.table,user:this.user}),this.noGeoRefDialog.appendToBody())},_addSQLViewHeader:function(){this.$(".sqlview").remove();var a=this.table.data().size(),b=null;this.layerModel&&!this.layerModel.get("interactivity")&&this.layerModel.wizard_properties.supportsInteractivity()&&(b=this._TEXTS.no_interaction_warn),this.layerModel&&!this.layerModel.table.containsColumn("the_geom_webmercator")&&(b=_t("the_geom_webmercator column should be selected"));var c=this.getTemplate("table/views/sql_view_notice")({empty:!a,isVisualization:this.vis.isVisualization(),warnMsg:b});this.$(".cartodb-map").after(c),this.overlays&&this.overlays.setHeaderMessageIsVisible(!0)},_removeSQLViewHeader:function(){this.$(".sqlview").remove(),this.overlays&&this.overlays.setHeaderMessageIsVisible(!1)},_toggleSlides:function(a){this.killEvent(a),this.slidesPanel&&this.slidesPanel.toggle()},_clearView:function(a){return this.killEvent(a),this.activeLayerView.model.clearSQLView(),!1},_tableFromQuery:function(a){this.killEvent(a);var b=new cdb.editor.DuplicateDatasetView({model:this.table,user:this.user,clean_on_hide:!0});b.appendToBody()}}),cdb.admin.HeaderDropdown=cdb.admin.DropdownMenu.extend({className:"dropdown border",isPublic:!1,events:{"click .asc":"orderColumnsAsc","click .desc":"orderColumnsDesc","click .rename_column":"renameColumn","click .change_data_type":"changeType","click .georeference":"georeference","click .clearview":"clearView","click .filter_by_this_column":"filterColumn","click .delete_column":"deleteColumn","click .add_new_column":"addColumn"},initialize:function(){this.options.reserved_column=!1,this.options.read_only=!1,this.options.in_sql_view=!1,this.options.isPublic=this.isPublic,this.elder("initialize")},render:function(){return cdb.admin.DropdownMenu.prototype.render.call(this),this.$el[this.options.isPublic!==!0||this.options.read_only?"addClass":"removeClass"]("public"),this},setTable:function(a,b){this.table=a,this.column=b,this.options.reserved_column=this.table.isReadOnly()||this.table.isReservedColumn(b),this.options.read_only=this.table.isReadOnly(),this.options.in_sql_view=this.table.isInSQLView(),this.render(),this.$(".asc").removeClass("selected"),this.$(".desc").removeClass("selected"),a.data().options.get("order_by")===b&&("asc"===a.data().options.get("sort_order")?this.$(".asc").addClass("selected"):this.$(".desc").addClass("selected"))},orderColumnsAsc:function(a){return a.preventDefault(),this.table.data().setOptions({sort_order:"asc",order_by:this.column}),this.hide(),!1},orderColumnsDesc:function(a){return a.preventDefault(),this.table.data().setOptions({sort_order:"desc",order_by:this.column}),this.hide(),!1},renameColumn:function(a){return a.preventDefault(),this.hide(),this.trigger("renameColumn"),!1},clearView:function(a){return a&&a.preventDefault(),this.hide(),this.trigger("clearView"),!1},changeType:function(a){return a.preventDefault(),this.hide(),this.trigger("changeType",this.column),!1},georeference:function(a){return a.preventDefault(),this.trigger("georeference",this.column),this.hide(),!1},filterColumn:function(a){this.killEvent(a),this._addFilter(this.column)},_addFilter:function(a){this.trigger("applyFilter",a),this.hide()},deleteColumn:function(a){a.preventDefault(),this.hide();var b=new cdb.editor.DeleteColumnView({clean_on_hide:!0,enter_to_confirm:!0,table:this.table,column:this.column,clean_on_hide:!0});return b.appendToBody(),!1},addColumn:function(a){return a.preventDefault(),this.trigger("addColumn",this),this.hide(),!1}}),cdb.open.AuthenticatedUser=cdb.core.Model.extend({defaults:{username:"",avatar_url:""},url:function(){var a=this.get("host")?this.get("host"):this._getCurrentHost();return"//"+a+"/api/v1/get_authenticated_users"},_getCurrentHost:function(){return window.location.host}}),cdb.open.AccountDropdown=cdb.admin.DropdownMenu.extend({_TEMPLATE:'     <ul>      <li><a class="small" href="<%- urls[0] %>">View your datasets</a></li>      <li><a class="small" href="<%- urls[0] %>/visualizations">View your maps</a></li>      <li><a class="small" href="<%- urls[0].replace("dashboard", "logout") %>">Close session</a></li>    </ul>  ',render:function(){return this.$el.html(_.template(this._TEMPLATE)(this.model.attributes)).css({width:this.options.width}),this}}),cdb.open.Header=cdb.core.View.extend({initialize:function(){this.vis=this.options.vis,this.template=cdb.templates.getTemplate("public/views/public_header"),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this.template(_.defaults({vis_url:this.vis&&this.vis.viewUrl(this.model)||"",isMobileDevice:this.options.isMobileDevice,owner_username:this.options.owner_username,current_view:this.options.current_view},this.model.attributes))),this._initViews(),this},_initBinds:function(){this.model.bind("change",this.render,this)},_initViews:function(){if(this.$(".account").length>0){var a=new cdb.open.AccountDropdown({target:this.$("a.account"),model:this.model,vertical_offset:20,width:166});this.addView(a),cdb.god.bind("closeDialogs",a.hide,a),this.add_related_model(cdb.god),$("body").append(a.render().el)}}}),cdb.open.LikeView=cdb.core.View.extend({events:{click:"_onClick"},_onClick:function(a){a.preventDefault(),a.stopPropagation(),
this.model.toggleLiked();var b=this;this.model.bind("error",function(a){400===a.status?b.model.set({id:b.model.get("vis_id"),liked:!0}):403===a.status&&(window.top.location.href="https://carto.com/sessions/new")})},initialize:function(){this.model.bind("change:likes, change:liked",function(){this._updateCounter(),this.model.get("liked")?this._highlightHeart():this._unhighlightHeart()},this),this.options.auto_fetch&&this.model.fetch()},_updateCounter:function(){var a=$(".js-like .counter"),b=this.model.get("likes");b>2||this.model.get("show_count")?a.text(b):a.text("")},_unhighlightHeart:function(){var a=$(".js-like"),b=$(".js-like .icon");b.addClass("is-pulsating is-animated"),b.one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){$(this).removeClass("is-pulsating is-animated"),a.removeClass("is-highlighted")})},_highlightHeart:function(){var a=$(".js-like"),b=$(".js-like .icon");a.addClass("is-highlighted"),b.addClass("is-pulsating is-animated"),b.one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){$(this).removeClass("is-pulsating is-animated")})}}),cdb.open.Like=cdb.admin.Like.extend({}),cdb.open.PublicVisualization=cdb.core.Model.extend({urlRoot:"/api/v1/viz",initialize:function(){this.like=new cdb.open.Like({id:this.get("liked")?this.id:null,vis_id:this.id})},viewUrl:function(){return cdb.config.prefixUrl()+"/viz/"+this.id+"/"},copy:function(a,b){a=a||{},b=b||{};var c=new cdb.open.PublicVisualization(_.extend({source_visualization_id:this.id},a));return c.save(null,b),c}}),function(){cdb.open.PublicCartoDBTableMetadata=cdb.admin.CartoDBTableMetadata.extend({fetch:function(){this.trigger("sync")},data:function(){return void 0===this._data&&(this._data=new cdb.admin.CartoDBTableData(null,{table:this}),this._data.fetch=function(){}),this.sqlView?this.sqlView:this._data}})}(),cdb.open.PublicHeader=cdb.admin.Header.extend({_SQL:"SELECT * FROM ",events:{"click .navigation li a":"_onTabClick"},initialize:function(){this.$body=$("body"),this.setInfo()},setInfo:function(){this.$("h2").text(this.model.get("name")),this.$(".description p").text(this.model.get("description"))},_shareVisualization:function(){},_changeToVisualization:function(a){},_changePrivacy:function(a){},_changeDescription:function(a){},_changeTitle:function(a){},_changeTags:function(a){},_onSetAttribute:function(a){},isVisEditable:function(a){},_onTabClick:function(a){a.preventDefault();var b="";b+=this.options.belong_organization?"/"+this.model.getUnquotedName()+"/public":"/"+this.model.getUnqualifiedName()+"/public",b+=$(a.target).closest("a").attr("href").search("/map")!=-1?"/map":"/table",window.history&&window.history.pushState&&window.table_router.navigate(b,{trigger:!0})}}),function(){HeaderView=cdb.open.PublicHeaderView=cdb.admin.HeaderView.extend({events:{},initialize:function(){this.column=this.options.column,this.table=this.options.table,this.template=this.getTemplate("public_table/views/public_table_header_view"),this.editing_name=!1,this.changing_type=!1},render:function(){return this.$el.html(""),this.$el.append(this.template({col_name:this.column[0],col_type:this.column[1],editing_name:this.editing_name})),this.editing_name&&this.$el.find("input").focus(),this.delegateEvents(),this},_openColOptions:function(a){var b=this,c=HeaderView.colOptions;c.off(),cdb.god.unbind("closeDialogs",HeaderView.colOptions.hide,HeaderView.colOptions),cdb.god.trigger("closeDialogs"),c.setTable(this.table,this.column[0]),c.bind("renameColumn",this._renameColumn,this),c.bind("changeType",this._changeType,this),c.bind("georeference",function(a){b.trigger("georeference",a)},this);var d=$(a.target).parent().parent();d.append(c.el);var e=$(a.target).width()+26,f=d.parent();c.openAt(e-c.$el.width(),f.height()/2+7),cdb.god.bind("closeDialogs",HeaderView.colOptions.hide,HeaderView.colOptions)},_openColTypeOptions:function(a){},_checkEditColnameInput:function(a){},_submitEdit:function(){},_finishEdit:function(){},_renameColumn:function(){},_changeType:function(){},showColumnOptions:function(a){var b=this;a.preventDefault();var c=HeaderView.colOptions;return c.hide(function(){b._openColOptions(a)}),!1},showColumnTypeOptions:function(a){}})}(),function(){cdb.open.PublicMapInfowindow=cdb.admin.MapInfowindow.extend({events:cdb.geo.ui.Infowindow.prototype.events,initialize:function(){this.table=this.options.table,this.model.set({content:"loading..."}),cdb.geo.ui.Infowindow.prototype.initialize.call(this)},render:function(){return this.$el.html($(this.template(_.clone(this.model.attributes)))),this._update(),this},_editGeom:function(a){},_removeGeom:function(a){}})}(),cdb.open.PublicMapTab=cdb.admin.MapTab.extend({className:"map",events:{"click .js-bounds":"_changeBounds"},initialize:function(){this.template=this.getTemplate("public_table/views/maptab_public"),this.map_enabled=!1,this._initBinds()},_initBinds:function(){this.model.bind("change:bounds",this._setBoundsCheckbox,this),this.model.bind("change:map",this._setBounds,this)},_changeBounds:function(){this.model.set("bounds",!this.model.get("bounds"))},_setBounds:function(){if(this.vis){var a=this.model.get("map");this.vis.mapView.map.setView(a.center,a.zoom)}},_setBoundsCheckbox:function(){this.trigger("boundsChanged",{bounds:this.model.get("bounds")}),this.$(".js-bounds .Checkbox-input").toggleClass("is-checked",!!this.model.get("bounds"))},enableMap:function(){this.map_enabled||this.vis||(this.vis=new cdb.vis.Vis({el:this.$(".cartodb-map")}),this.vis.load(this.options.vizjson,{auth_token:this.options.auth_token,https:this.options.https,search:!1,scrollwheel:!1,shareable:!1,fullscreen:!0,no_cdn:cdb.config.get("debug")})),this._bindBounds()},_bindBounds:function(){this.vis.mapView.bind("dragend zoomend",function(){this.trigger("mapBoundsChanged",{map:this.vis.map})},this)},clearMap:function(){},render:function(){return this.$el.html(this.template()),this}}),$(function(){$.extend($.easing,{easeInQuad:function(a,b,c,d,e){return d*(b/=e)*b+c}}),cdb.init(function(){cdb.config.set(config),api_key&&cdb.config.set("api_key",api_key),cdb.config.set("url_prefix",window.base_url),cdb.templates.namespace="cartodb/";var a=/Android|webOS|iPad|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);new cdb.open.PublicTableWindow({el:window,table_id:table_id,table_name:table_name,user_name:user_name,owner_username:owner_username,vizjson:vizjson_obj,auth_token:auth_token,https:use_https,api_key:api_key,schema:schema,config:config,isMobileDevice:a,belong_organization:belong_organization})})}),cdb.open.PublicTableWindow=cdb.core.View.extend({initialize:function(){this.$body=$(this.el.document.body),this.$map=this.$body.find("#map"),this._initBinds(),this._initViews(),setTimeout(this._onStart,250)},_initViews:function(){var a=_.defaults({el:this.el.document.body,model:new cdb.core.Model({bounds:!1,map:null})},this.options),b=new cdb.open.TablePublic(a);this.el.table_router=new cdb.open.TableRouter(b);var c=!0,d="/tables/";this.el.history&&this.el.history.pushState||(c=!1),this.options.belong_organization&&(d="/u/"+this.options.user_name+d),Backbone.history.start({pushState:c,root:d})},_initBinds:function(){_.bindAll(this,"_onWindowResize","_onOrientationChange","_onStart"),this.$el.on("resize",this._onWindowResize),this.el.addEventListener?this.el.addEventListener("orientationchange",this._onOrientationChange):this.el.attachEvent("orientationchange",this._onOrientationChange,this)},_onStart:function(){this._setupMapDimensions();var a=this.$el.height(),b=a-this.$body.find(".cartodb-info").outerHeight(!0)-this.$body.find(".cartodb-public-header").outerHeight(!0);if(this.options.isMobileDevice){var c=120;a<670&&(c=80),b=a-this.$body.find(".cartodb-public-header").outerHeight(!0)-c}this._showNavigationBar(b)},_onWindowResize:function(){this._setupMapDimensions(),cdb.god.trigger("closeDialogs")},_onOrientationChange:function(){DISQUS&&DISQUS.reset({reload:!0}),this._setupMapDimensions(!0)},_setupMapDimensions:function(a){var b,c,d,e=this.$el.height(),f=this.$body.find(".js-Navmenu").height(),g=this.$body.find(".Header").height(),h=this.el.matchMedia&&this.el.matchMedia("(orientation: landscape)").matches;b=this.options.isMobileDevice?h?g+7:e>670?220:138:260,c=e-b,d=e-(b-80),a?(this.$map.animate({height:c},{easing:"easeInQuad",duration:150}),this.$body.find(".navigation").animate({top:d-130},{easing:"easeInQuad",duration:150})):this.options.isMobileDevice?(this.$map.css({height:c,opacity:1}),this.$body.find(".navigation").css({top:d-130},250)):(this.$map.css({height:e-(f+g),opacity:1}),this.$body.find(".navigation").css({top:d-21},250)),this.options.isMobileDevice&&h&&$(window).scrollTop()<g&&this.$body.animate({scrollTop:g},600),this.map_view&&this.map_view.invalidateMap()},_showNavigationBar:function(a){var b=this.el.matchMedia&&this.el.matchMedia("(orientation: landscape)").matches,c=this.$el.height();if(this.options.isMobileDevice){var d=108;b&&(d=48),this.$body.find(".navigation").css({top:c}).animate({top:a-d,opacity:1},250)}else this.$body.find(".navigation").css({top:c}).animate({top:a-201,opacity:1},250);this.map_view&&this.map_view.invalidateMap()}}),cdb.open.PublicRowView=cdb.admin.RowView.extend({classLabel:"cdb.open.PublicRowView",events:{},initialize:function(){this.options.row_header=!1,this.order=this.options.order},_renderGeometry:function(a){return this._renderDefault("GeoJSON")},_getRowOptions:function(){},click_header:function(a){}}),cdb.open.TablePublic=cdb.core.View.extend({events:{"click .js-Navmenu-link--download":"_exportTable","click .js-Navmenu-link--api":"_apiCallTable"},initialize:function(){this._initModels(),this._initViews(),this._initBinds()},_initModels:function(){this.table=new cdb.open.PublicCartoDBTableMetadata({id:this.options.table_name,name:this.options.table_name,description:this.options.vizjson.description||""}),this.table.set({user_name:this.options.user_name,vizjson:this.options.vizjson,schema:this.options.schema}),this.columns=this.table.data(),this.sqlView=new cdb.admin.SQLViewData,this.sqlView.syncMethod="read";var a=this.query=this.table.data().getSQL();this.table.useSQLView(this.sqlView),this.sqlView.options.set("rows_per_page",20,{silent:!0}),this._fetchData(a),this.user=new cdb.admin.User({username:this.options.user_name}),this.authenticated_user=new cdb.open.AuthenticatedUser},_initViews:function(){var a=this;if(this.$(".cartodb-public-header").length>0){var b=new cdb.open.Header({el:this.$(".cartodb-public-header"),model:this.authenticated_user,vis:this.table,current_view:this._getCurrentView(),owner_username:this.options.owner_username,isMobileDevice:this.options.isMobileDevice});this.addView(b),this.authenticated_user.fetch()}this.header=new cdb.open.PublicHeader({el:this.$(".navigation"),model:this.table,user:this.user,belong_organization:belong_organization,config:this.options.config}),this.addView(this.header);new cdb.open.LikeView({el:this.$el.find(".extra_options .js-like"),auto_fetch:!0,model:new cdb.open.Like({vis_id:this.options.vizjson.id})});this.workViewTable=new cdb.ui.common.TabPane({el:this.$(".pane_table")}),this.addView(this.workViewTable),this.workViewMap=new cdb.ui.common.TabPane({el:this.$(".pane_map")}),this.addView(this.workViewMap),this.workViewMobile=new cdb.ui.common.TabPane({el:this.$(".panes_mobile")}),this.addView(this.workViewMobile),this.tabs=new cdb.admin.Tabs({el:this.$(".navigation ul"),slash:!0}),this.addView(this.tabs);var c=new cdb.common.TipsyTooltip({el:this.$("span.help"),gravity:$.fn.tipsy.autoBounds(250,"s")});this.addView(c),$.browser.msie&&7===parseInt($.browser.version)&&this.$(".comments .content").html("<p>Your browser doesn't support comments.</p>"),this.tableTab=new cdb.open.PublicTableTab({model:this.table,vizjson:this.options.vizjson,user_name:this.options.user_name}),this.tableTabMobile=new cdb.open.PublicTableTab({model:this.table,vizjson:this.options.vizjson,user_name:this.options.user_name}),this.mapTab=new cdb.open.PublicMapTab({vizjson:this.options.vizjson,auth_token:this.options.auth_token,https:this.options.https,vizjson_url:this.options.vizjson_url,model:new cdb.core.Model({bounds:!1})}),this.mapTab.bind("mapBoundsChanged",function(b){a.model.set("map",{bounds:[b.map.get("view_bounds_ne")[1],b.map.get("view_bounds_ne")[0],b.map.get("view_bounds_sw")[1],b.map.get("view_bounds_sw")[0]],center:b.map.get("center"),zoom:b.map.get("zoom")})}),this.mapTab.bind("boundsChanged",function(b){a.model.set("bounds",b.bounds)}),this.mapTabMobile=new cdb.open.PublicMapTab({vizjson:this.options.vizjson,auth_token:this.options.auth_token,https:this.options.https,vizjson_url:this.options.vizjson_url,model:new cdb.core.Model({bounds:!1})}),this.mapTabMobile.bind("mapBoundsChanged",function(b){a.model.set("map",{bounds:[b.map.get("view_bounds_ne")[1],b.map.get("view_bounds_ne")[0],b.map.get("view_bounds_sw")[1],b.map.get("view_bounds_sw")[0]],center:b.map.get("center"),zoom:b.map.get("zoom")})}),this.mapTabMobile.bind("boundsChanged",function(b){a.model.set("bounds",b.bounds)}),this.workViewMobile.addTab("table",this.tableTabMobile.render()),this.workViewMobile.addTab("map",this.mapTabMobile.render()),this.workViewMobile.bind("tabEnabled:map",this.mapTabMobile.enableMap,this.mapTabMobile),this.workViewTable.addTab("table",this.tableTab.render()),this.workViewMap.addTab("map",this.mapTab.render()),this.workViewMobile.bind("tabEnabled",function(b){a.$el.removeClass("table"),a.$el.removeClass("map"),a.$el.addClass(b),$(window).trigger("resize")},this.mapTabMobile),this.workViewMobile.bind("tabEnabled",this.tabs.activate),this.workViewMobile.active("table"),this.workViewTable.active("table"),this.workViewMap.active("map"),this.mapTab.enableMap(),$(".pane_table").addClass("is-active")},_updateTable:function(){var a=this.model.get("bounds")&&this.model.get("map")?this.query+" WHERE the_geom && ST_MakeEnvelope("+this.model.get("map").bounds[0]+", "+this.model.get("map").bounds[1]+", "+this.model.get("map").bounds[2]+", "+this.model.get("map").bounds[3]+", 4326)":this.query;this._fetchData(a)},_fetchData:function(a){a&&this.sqlView.setSQL(a),this.sqlView.fetch({success:function(){self.$(".js-spinner").remove()}})},_exportTable:function(a){if(a.preventDefault(),!this.sqlView.getSQL())return!1;var b=cdb.editor.PublicExportView,c=new b({model:this.table,config:config,user_data:this.user.toJSON(),bounds:this.sqlView.getSQL()!==this.query});c.appendToBody().open()},_apiCallTable:function(a){return a.preventDefault(),!!this.sqlView.getSQL()&&(api_dialog=cdb.editor.ViewFactory.createDialogByTemplate("common/dialogs/api_call",{url:cdb.config.getSqlApiUrl(),sql:this.sqlView.getSQL(),schema:this.table.attributes.original_schema.slice(0,5),rows:this.table.dataModel.models}),void api_dialog.appendToBody().open())},_initBinds:function(){var a=this;enableClickOut(this.$el),this.model.bind("change:bounds",function(){a._setBoundsCheckbox(),a._updateTable()},this),this.model.bind("change:map",function(){a._setBounds(),a._updateTable()},this),this.authenticated_user.bind("change",this._onUserLogged,this),this.add_related_model(this.authenticated_user)},_setBoundsCheckbox:function(){this.mapTab.model.set("bounds",this.model.get("bounds")),this.mapTabMobile.model.set("bounds",this.model.get("bounds"))},_setBounds:function(){this.mapTab.model.set("map",this.model.get("map")),this.mapTabMobile.model.set("map",this.model.get("map"))},_getCurrentView:function(){var a=location.pathname;return a.indexOf("/tables/")!==-1?"table":a.indexOf("/viz/")!==-1?"visualization":"dashboard"},keyUp:function(a){},_onUserLogged:function(){this.options.owner_username===this.authenticated_user.get("username")&&(this.$(".extra_options .edit").css("display","inline-block"),this.$(".extra_options .oneclick").css("display","none"))}}),cdb.open.TableRouter=Backbone.Router.extend({routes:{":id/public/:scenario":"change"},initialize:function(a){this.table=a},change:function(a,b){"table"!=b&&"map"!=b&&(b="table"),this.table.workViewMobile.active(b)}}),cdb.open.PublicTableView=cdb.admin.TableView.extend({events:{},rowView:cdb.open.PublicRowView,initialize:function(){this.elder("initialize"),this.options.row_header=!0,this._editorsOpened=null,this.initializeBindings(),this.initPaginationAndScroll()},initializeBindings:function(){var a=this;_.bindAll(this,"render","rowSaving","addEmptyRow","_checkEmptyTable","_forceScroll","_scrollMagic","rowChanged","rowSynched","_startPagination","_finishPagination","rowFailed","rowDestroyed","emptyTable"),this.model.data().bind("newPage",this.newPage,this),this.model.data().bind("endLoadingRows",this._finishPagination),this.bind("cellDblClick",this._editCell,this),this.model.bind("dataLoaded",function(){a._checkEmptyTable(),a._forceScroll()},this)},headerView:function(a){if("header"!==a[1]){var b=new cdb.open.PublicHeaderView({column:a,table:this.model,sqlView:this.options.sqlView});return this.addView(b),b.render().el}return"<div><div></div></div>"},_onSQLView:function(){},_checkEmptyTable:function(){this.isEmptyTable()?this.addEmptyTableInfo():(this.cleanEmptyTableInfo(),this.$("footer").remove())},_swicthEnabled:function(){},addEmptyTableInfo:function(){this.template_base=cdb.templates.getTemplate("public_table/views/empty_table_public");var a=this.template_base(this.import_),b=$('<tfoot><tr><td colspan="100">'+a+"</td></tr></tfoot>");this.$("footer").remove(),this.$el.append(b)},_scrollMagic:function(){}}),cdb.open.PublicTableTab=cdb.admin.TableTab.extend({className:"table public",initialize:function(){this.user=this.options.user,this.sqlView=this.options.sqlView},_createTable:function(){this.tableView=new cdb.open.PublicTableView({dataModel:this.model.data(),model:this.model,sqlView:this.sqlView})}});
//# sourceMappingURL=public_table.js.map