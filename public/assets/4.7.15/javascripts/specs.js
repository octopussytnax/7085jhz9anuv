/*! v4.7.15 - 2017-05-30 */
!function(){function a(){this.executeCount=0,this.getBoundsCount=0}a.prototype.executeCount=0,a.prototype.getBoundsCount=0,a.prototype.executeResponse=null,a.prototype.getBoundsResponse=null,a.prototype.promise={},a.setResponse=function(b,c){a.prototype[b+"Response"]=c},a.getState=function(){return{executeCount:a.prototype.executeCount,getBoundsCount:a.prototype.getBoundsCount,executeArgs:a.prototype.executeArgs}},a.prototype.execute=function(b,c,d,e){a.prototype.executeCount++,this.executeCount++,a.prototype.executeArgs={sql:b,vars:c,options:d,callback:e},e&&e(this.executeResponse);var f={done:function(b){return a.prototype.promise.done=b,f},error:function(b){return a.prototype.promise.error=b,f}};return f},a.getPromise=function(){return a.prototype.promise},a.prototype.getBounds=function(a,b,c,d){this.getBoundsCount++,this.getBoundsResponse},cartodb.SQLMock=a}(),describe("cdb.admin.CartoStyles",function(){beforeEach(function(){table_polygons=new cdb.admin.CartoDBTableMetadata({name:"test_table",geometry_types:["st_polygon"]}),table_polylines=new cdb.admin.CartoDBTableMetadata({name:"test_table",geometry_types:["st_multilinestring"]}),table_points=new cdb.admin.CartoDBTableMetadata({name:"test_table",geometry_types:["st_multipoint"]}),table_empty=new cdb.admin.CartoDBTableMetadata({name:"test_table",geometry_types:[]})}),describe("simple polygon generation",function(){it("should return valid css",function(){var a;simple_polygon_generator(table_polygons,{"polygon-fill":"#FF6600","line-color":"#FFFFFF","line-width":1,"polygon-opacity":.7,"line-opacity":1,"marker-opacity":.2},{},function(b){a=b}),expect(a.indexOf("#test_table")!=-1).toEqual(!0),expect(a.indexOf("polygon-fill: #FF6600;")!=-1).toEqual(!0),expect(a.indexOf("line-opacity: 1;")!=-1).toEqual(!0),expect(a.indexOf("marker-fill-opacity: 0.2;")!=-1).toEqual(!0)}),it("should quota text-name entries",function(){var a;simple_polygon_generator(table_polygons,{"polygon-fill":"#FF6600","line-color":"#FFFFFF","text-name":"test"},{},function(b){a=b}),expect(a.indexOf("[test]")!=-1).toEqual(!0)}),it("should remove text properies if the font is none",function(){var a;simple_polygon_generator(table_polygons,{"polygon-fill":"#FF6600","line-color":"#FFFFFF","text-name":"None","text-face-name":"jajaja"},{},function(b){a=b}),expect(a.indexOf("text-name")==-1).toEqual(!0),expect(a.indexOf("text-face-name")==-1).toEqual(!0),expect(a.indexOf("polygon-fill")!=-1).toEqual(!0)}),it("should create a layer with text-properties",function(){var a;simple_polygon_generator(table_polygons,{"polygon-fill":"#FF6600","line-color":"#FFFFFF","text-name":"test","text-face-name":"jajaja","text-fill":"#fff","text-allow-overlap":!0},{},function(b){a=b});var b=a.indexOf("#test_table::labels");expect(b!=-1).toEqual(!0),expect(a.indexOf("text-face-name")>b).toEqual(!0),expect(a.indexOf("text-name")>b).toEqual(!0),expect(a.indexOf("text-fill")>b).toEqual(!0),expect(a.indexOf("text-allow-overlap")>b).toEqual(!0)}),it("should not allow polygon-patter-file and polygon-fill at the same time",function(){simple_polygon_generator(table_polygons,{"polygon-fill":"#FF6600","line-color":"#FFFFFF","polygon-pattern-file":"url(https://s3.amazonaws.com/com.cartodb.assets.dev/development/dev/assets/layers.png)"},{},function(a){css=a}),expect(css.indexOf("polygon-fill")).toEqual(-1)})}),describe("simple polyline generation",function(){it("should return valid css",function(){var a;simple_polygon_generator(table_polylines,{"line-color":"#FFFFFF","line-width":1,"line-opacity":1},{},function(b){a=b}),expect(a.indexOf("#test_table")!=-1).toEqual(!0),expect(a.indexOf("polygon-fill")==-1).toEqual(!0),expect(a.indexOf("polygon-opacity")==-1).toEqual(!0),expect(a.indexOf("line-opacity: 1;")!=-1).toEqual(!0)})}),describe("bubble generator",function(){it("should return valid css",function(){var a,b={"marker-fill":"#FFF","marker-line-color":"#F00","marker-line-width":1,"marker-line-opacity":.5,"marker-opacity":.6,property:"property_test",radius_max:10,radius_min:0,qfunction:"Equal Interval"},c=!1;table_polygons.data=function(){return c=!0,table_polygons._data},sinon.stub(table_polygons.data(),"_sqlQuery").yields({rows:[{max:10,min:0,s:1}]}),bubble_generator(table_polygons,b,{},function(b){a=b}),expect(c).toEqual(!0),expect(a.indexOf("property: property_test")==-1).toEqual(!0),expect(a.indexOf("#test_table")!=-1).toEqual(!0),expect(a.indexOf("marker-fill: #FFF;")!=-1).toEqual(!0),expect(a.indexOf("marker-fill-opacity: 0.6;")!=-1).toEqual(!0);for(var d=1;d<=10;++d)expect(a.indexOf("#test_table [ property_test <= "+d+"]")!=-1).toEqual(!0)})}),it("should return valid css polygon",function(){var a,b={"line-color":"#FFF","line-opacity":.2,"line-width":3,"polygon-opacity":.3,property:"property_test",color_ramp:"red",method:"5 Buckets",radius_min:0,"comp-op":"src",qfunction:"Equal Interval"};sinon.stub(table_polygons.data(),"_sqlQuery").yields({rows:[{max:5,min:0,s:1}]}),choropleth_generator(table_polygons,b,{},function(b){a=b}),expect(a.indexOf("property: property_test")==-1).toEqual(!0),expect(a.indexOf("#test_table")!=-1).toEqual(!0),expect(a.indexOf("line-color: #FFF;")!=-1).toEqual(!0),expect(a.indexOf("line-opacity: 0.2;")!=-1).toEqual(!0),expect(a.indexOf("polygon-opacity: 0;")==-1).toEqual(!0);for(var c=1;c<=5;++c)expect(a.indexOf("#test_table [ property_test <= "+c+"]")!=-1).toEqual(!0)}),it("should return valid css point",function(){var a,b={"marker-width":12,"marker-opacity":.5,"marker-line-width":3,"marker-line-color":"#FFF","marker-line-opacity":.5,"polygon-opacity":void 0,property:"property_test",color_ramp:"red",method:"5 Buckets",radius_min:0,"comp-op":"src",qfunction:"Equal Interval"};sinon.stub(table_points.data(),"_sqlQuery").yields({rows:[{max:5,min:0,s:1}]}),choropleth_generator(table_points,b,{},function(b){a=b}),expect(a.indexOf("property: property_test")==-1).toEqual(!0),expect(a.indexOf("#test_table")!=-1).toEqual(!0),expect(a.indexOf("marker-width: 12;")!=-1).toEqual(!0),expect(a.indexOf("polygon-opacity")==-1).toEqual(!0),expect(a.indexOf("marker-line-width: 3;")!=-1).toEqual(!0),expect(a.indexOf("marker-fill-opacity: 0.5;")!=-1).toEqual(!0);for(var c=1;c<=5;++c)expect(a.indexOf("#test_table [ property_test <= "+c+"]")!=-1).toEqual(!0)}),it("should return valid css for less quartiles than requested",function(){var a,b={"line-color":"#FFF","line-opacity":.2,"line-width":3,property:"property_test",color_ramp:"red",method:"5 Buckets",radius_min:0,"text-name":"none","comp-op":"src",qfunction:"Equal Interval"};sinon.stub(table_polylines.data(),"_sqlQuery").yields({rows:[{maxamount:1},{maxamount:2},{maxamount:3},{maxamount:2147483649}]}),choropleth_generator(table_polylines,b,{},function(b){a=b}),expect(a.indexOf("undefined")).toEqual(-1)}),it("should return valid css for polyline",function(){var a,b={"line-color":"#FFF","line-opacity":.2,"line-width":3,property:"property_test",color_ramp:"red",method:"5 Buckets",radius_min:0,qfunction:"Equal Interval"};sinon.stub(table_polylines.data(),"_sqlQuery").yields({rows:[{max:4,min:0,s:1}]}),choropleth_generator(table_polylines,b,{},function(b){a=b}),expect(a.indexOf("property: property_test")==-1).toEqual(!0),expect(a.indexOf("#test_table")!=-1).toEqual(!0),expect(a.indexOf("line-color: #FFFFB2;")!=-1).toEqual(!0),expect(a.indexOf("line-opacity: 0.2;")!=-1).toEqual(!0),expect(a.indexOf("polygon-opacity: 0;")!=-1).toEqual(!0);for(var c=1;c<=4;++c)expect(a.indexOf("#test_table [ property_test <= "+c+"]")!=-1).toEqual(!0)}),it("density should generate many zooms",function(){var a,b={"line-color":"#FFF","line-opacity":.2,"line-width":3,"polygon-opacity":.3,property:"property_test",color_ramp:"red",method:"5 Buckets",radius_min:0,"polygon-size":10};sinon.stub(table_polygons.data(),"_sqlQuery").yields({rows:[{z:0,maxdensity:1},{z:0,maxdensity:2},{z:2,maxdensity:3},{z:2,maxdensity:4},{z:2,maxdensity:5}]}),density_generator(table_polygons,b,{},function(b){a=b}),expect(a.indexOf("#test_table")!=-1).toEqual(!0),expect(a.indexOf("line-color: #FFF;")!=-1).toEqual(!0),expect(a.indexOf("line-opacity: 0.2;")!=-1).toEqual(!0),expect(a.indexOf("polygon-opacity: 0;")==-1).toEqual(!0);for(var c=1;c<=5;++c)expect(a.indexOf("[points_density <= "+c+"]")!=-1).toEqual(!0)}),it("torque category should generate sql",function(){var a=cdb.admin.carto.torque_cat.sql([{title:"a",title_type:"string"},{title:"b",title_type:"string"}],"column_cat"),b=["select *, (CASE","WHEN \"column_cat\" = 'a' THEN 1","WHEN \"column_cat\" = 'b' THEN 2","ELSE 3 END) as torque_category FROM __wrapped _cdb_wrap"];expect(a).toEqual(b.join(" "))}),it("torque category should generate categories",function(){sinon.stub(table_points.data(),"_sqlQuery").yields({fields:{cat:{type:"string"}},rows:[{cat:"cat1"},{cat:"cat2"},{cat:"cat3"},{cat:"cat4"}]});var a,b={property:"test","torque-duration":10,"torque-frame-count":12,"torque-blend-mode":"lighten","torque-trails":1,"torque-resolution":1,property_cat:"cat"};cdb.admin.carto.torque_cat.generate(table_points,b,{},function(b){a=b}),console.log(a),expect(a.indexOf('-torque-aggregation-function:"CDB_Math_Mode(torque_category)"')!==-1).toEqual(!0),expect(a.indexOf("[value=0]")===-1).toEqual(!0),expect(a.indexOf("[value=1]")!==-1).toEqual(!0)}),describe("cdb.admin.CartoStyles",function(){var a,b;beforeEach(function(){b=new cdb.admin.CartoDBTableMetadata({name:"test"}),a=new cdb.admin.CartoStyles({table:table_polygons})}),it("should not regenerate carto style when table name changes",function(){var c=sinon.spy();a.bind("change:style",c),b.set({name:"test2"}),expect(c.called).toEqual(!1)}),it("should generate carto style when properties changes",function(){var b=sinon.spy();a.bind("change:style",b),a.set({properties:{"polygon-fill":"#FFF"}}),expect(b.called).toEqual(!0)}),it("should add changes object when any change has happened in properties",function(){var b={};a.registerGenerator("jam_type",function(a,c,d,e){b=d}),a.set("type","jam_type"),a.set({properties:{"polygon-fill":"#FFF"}}),expect(_.isEmpty(b)).toBeFalsy(),expect(b["polygon-fill"]).toBe("#FFF")})}),describe("cartoparser",function(){var a,b;beforeEach(function(){b="   @test_var: #FF6622;  #sensor_log_2013_06_02_12_43{   marker-fill: #FF6611;   marker-opacity: 1;marker-width: [ax]*3;   marker-line-color: white;   marker-line-width: 3;   marker-line-opacity: 0.9;   marker-placement: point;   marker-type: ellipse;marker-allow-overlap: true;[az > 1] { marker-fill:@test_var;}[zoom = 12][az > 1] { marker-fill: red;}[mapnik-geometry-type = 'point'] { marker-fill: blue;}}",a=new cdb.admin.CartoParser(b)}),it("should report errors",function(){expect(a.errors().length).toEqual(0),a.parse(b+"#whatever {aksdjj; lakjsdk; jaksdjaks;}"),expect(a.errors().length>0).toEqual(!0)}),it("should get the variables used",function(){var b=a.variablesUsed();expect(b.indexOf("ax")).not.toEqual(-1),expect(b.indexOf("az")).not.toEqual(-1),expect(b.indexOf("zoom")).toEqual(-1),expect(b.indexOf("mapnik-geometry-type")).toEqual(-1)}),it("shoudl return the rules for main definition",function(){var b=["marker-fill","marker-opacity","marker-width","marker-line-color","marker-line-width","marker-line-opacity","marker-placement","marker-type","marker-allow-overlap"],c=a.getDefaultRules();for(var d in b)expect(b[d]in c).toEqual(!0)})})}),describe("cdb.admin.CartoDBLayer",function(){describe(".toLayerGroup",function(){it("should clone the attributes and set the layer definition",function(){var a=new cdb.admin.CartoDBLayer({table_name:"table_name",tile_style:"tile_style",interactivity:"interactivity",visible:!0}),b=a.toLayerGroup();expect(b.table_name).toEqual("table_name"),expect(b.type).toEqual("layergroup"),expect(b.layer_definition).toEqual({version:"1.0.1",layers:[{type:"cartodb",options:{sql:"select * from table_name",cartocss:"tile_style",cartocss_version:"2.1.1",interactivity:"interactivity"}}]})}),it("should clone the attributes and set the layer definition quoting the table name if needed",function(){var a=new cdb.admin.CartoDBLayer({table_name:"000cd294-b124-4f82-b569-0f7fe41d2db8",tile_style:"tile_style",interactivity:"interactivity",visible:!0}),b=a.toLayerGroup();expect(b.table_name).toEqual("000cd294-b124-4f82-b569-0f7fe41d2db8"),expect(b.type).toEqual("layergroup"),expect(b.layer_definition).toEqual({version:"1.0.1",layers:[{type:"cartodb",options:{sql:'select * from "000cd294-b124-4f82-b569-0f7fe41d2db8"',cartocss:"tile_style",cartocss_version:"2.1.1",interactivity:"interactivity"}}]})}),it("should not include the layer in the layer definition if is not visible",function(){var a=new cdb.admin.CartoDBLayer({visible:!1}),b=a.toLayerGroup();expect(b.layer_definition).toEqual({version:"1.0.1",layers:[]})})})}),describe("modules.Filters",function(){describe("cdb.admin.models.Filters",function(){var a,b;beforeEach(function(){b=TestUtil.createTable("test"),a=new cdb.admin.models.Filters(null,{table:b})}),it("should generate correct model for column type",function(){a.reset([{column_type:"number",column:"test"},{column_type:"string",column:"teststr"}]),expect(a.models[0]instanceof cdb.admin.models.Filter).toEqual(!0),expect(a.models[1]instanceof cdb.admin.models.FilterDiscrete).toEqual(!0)})}),describe("cdb.admin.models.Filter (numeric)",function(){var a,b,c,d;beforeEach(function(){c=[],d={},d.upper=10,d.lower=3,d.bucket_size=1;for(var e=0;e<10;++e)c.push(e);b=TestUtil.createTable("test"),spyOn(b.data(),"histogram").and.callFake(function(a,b,e){e(c,_.clone(d))}),a=new cdb.admin.models.Filter({table:b,column_type:"number",column:"c"})}),it("should have a table",function(){expect(a.table).toEqual(b),expect(a.get("table")).toEqual(void 0)}),it("should set bounds",function(){expect(a.get("lower")).toEqual(3),expect(a.get("upper")).toEqual(10)}),it("should return the condition",function(){expect(a.getSQLCondition()).toEqual(" (c >= 3 AND c <= 10) ")}),it("should fecth data when the table is saved",function(){spyOn(a,"_fetchHist"),b.trigger("data:saved"),expect(a._fetchHist).toHaveBeenCalled()}),it("should adjust the bounds",function(){a.set({bounds:{lower:2,upper:10},lower:3,upper:9}),b.trigger("data:saved"),expect(a.get("lower")).toEqual(3),expect(a.get("upper")).toEqual(9),d.lower=1,d.upper=11,b.trigger("data:saved"),expect(a.get("lower")).toEqual(1),expect(a.get("upper")).toEqual(11)}),it("should raise an error when histogram can't be generated",function(){spy=sinon.spy(),a.bind("error",spy),b.data().histogram.and.callFake(function(a,b,c){c(null,null)}),b.trigger("data:saved"),expect(spy.called).toEqual(!0)}),it("should serialize to json",function(){expect(a.toJSON()).toEqual({column:"c",upper:10,tz:void 0,lower:3,column_type:"number"})})}),describe("cdb.admin.models.Filter (date)",function(){var a,b,c,d;beforeEach(function(){c=[],d={},d.lower=36e7,d.upper=76e7,d.bucket_size=1;for(var e=0;e<10;++e)c.push(d.upper+1e4*e);b=TestUtil.createTable("test"),spyOn(b.data(),"date_histogram").and.callFake(function(a,b,e){e(c,_.clone(d))}),a=new cdb.admin.models.Filter({table:b,column_type:"date",column:"c",bounds:d,lower:1e3*d.lower,upper:1e3*d.upper,lower_limit:1e3*d.lower,upper_limit:1e3*d.upper,tz:"1981-05-29T18:00:00+0000"})}),it("should have a table",function(){expect(a.table).toEqual(b),expect(a.get("table")).toEqual(void 0)}),it("should return the condition",function(){var b=moment(36e10).format("YYYY-MM-DDTHH:mm:ssZ").toString(),c=moment(76e10).format("YYYY-MM-DDTHH:mm:ssZ").toString();expect(a.getSQLCondition()).toEqual(" (c >= ('"+b+"') AND c <= ('"+c+"')) "),c=moment(d.upper-61e3).format("YYYY-MM-DDTHH:mm:ssZ").toString(),a.set("upper_limit",d.upper-61e3),expect(a.getSQLCondition()).toEqual(" (c >= ('"+b+"') AND c <= ('"+c+"')) ")}),it("should transform a timestamp to a date",function(){var b=3616704e5,c=a._getDateFromTimestamp(b);expect(c.toString()).toEqual(new Date(b).toString())}),it("should adjust the bounds",function(){a.set({bounds:{lower:36e7,upper:76e7},lower:4e11,upper:7e11}),b.trigger("data:saved"),expect(a.get("lower")).toEqual(4e11),expect(a.get("upper")).toEqual(7e11),d.lower=3e8,d.upper=8e8,b.trigger("data:saved"),expect(a.get("lower")).toEqual(3e11),expect(a.get("upper")).toEqual(8e11)})}),describe("FilterDiscrete (boolean)",function(){var a,b,c,d,e,f,g;beforeEach(function(){function h(a){return f={},f.rows=a,e=TestUtil.createTable("test"),g=sinon.stub(e.data(),"discreteHistogram"),g.yields(f),new cdb.admin.models.FilterDiscrete({table:e,column:"c",column_type:"boolean"})}var i=[{bucket:!1,value:100},{bucket:!0,value:200}];b=h(i),i=[{bucket:!0,value:200}],a=h(i),i=[{bucket:null,value:100},{bucket:!0,value:200}],c=h(i),i=[{bucket:null,value:100},{bucket:!0,value:200},{bucket:!1,value:20}],d=h(i)}),it("should return a valid SQL in boolean mode for true and false values",function(){b.set({list_view:!0});var a=b.getSQLCondition();expect(a).toEqual("c IN (false,true) ")}),it("should return a valid SQL in boolean mode for true values",function(){a.set({list_view:!0});var b=a.getSQLCondition();expect(b).toEqual("c IN (true) ")}),it("should return a valid SQL in boolean mode for true and null values ",function(){c.set({list_view:!0});var a=c.getSQLCondition();expect(a).toEqual("c IN (true) OR c IS NULL ")}),it("should return a valid SQL in boolean mode for true, false and null values ",function(){d.set({list_view:!0});var a=d.getSQLCondition();expect(a).toEqual("c IN (true,false) OR c IS NULL ")})}),describe("FilterDiscrete (null)",function(){var a,b,c,d;beforeEach(function(){c={},c.rows=[{bucket:"test1"},{bucket:null},{bucket:"test3"}],b=TestUtil.createTable("test"),d=sinon.stub(b.data(),"discreteHistogram"),d.yields(c),a=new cdb.admin.models.FilterDiscrete({table:b,column:"d",items:[{bucket:"test1",selected:!0},{bucket:null,selected:!0},{bucket:"test3",selected:!1}]})}),it("should handle the null buckets",function(){var b=a.getSQLCondition();expect(b).toEqual("d IN ('test1','null') OR d IS NULL ")})}),describe("FilterDiscrete",function(){var a,b,c,d,e;beforeEach(function(){d={},d.rows=[{bucket:"test1"},{bucket:"test2"},{bucket:"test3"}],c=TestUtil.createTable("test"),e=sinon.stub(c.data(),"discreteHistogram"),e.yields(d),a=new cdb.admin.models.FilterDiscrete({table:c,column:"c",items:[{bucket:"test1",selected:!0},{bucket:"test2",selected:!0},{bucket:"test3",selected:!1}]}),b=new cdb.admin.models.FilterDiscrete({table:c,column:"c",items:[{bucket:"test1",selected:!0},{bucket:"test2",selected:!0},{bucket:"test3",selected:!0}]})}),it("should return a 'partial' SQL condition when some of the items are selected",function(){var b=a.getSQLCondition();expect(b).toEqual("c IN ('test1','test2') ")}),it("should return a full SQL condition when all the items are selected",function(){sql=b.getSQLCondition(),expect(sql).toEqual(" (true) ")}),it("should return SQL with free_text",function(){a.set({free_text:"Valladolid",list_view:!1});var b=a.getSQLCondition();expect(a.get("column")).toEqual("c"),expect(b).toEqual("c ILIKE '%Valladolid%' ")}),it("shouldn't return a free_text query in list_view mode",function(){a.set({free_text:"Valladolid",list_view:!0});var b=a.getSQLCondition();expect(a.get("column")).toEqual("c"),expect(b).toEqual("c IN ('test1','test2') ")}),it("should return a valid SQL when free_text is empty",function(){a.set({free_text:"",list_view:!1});var b=a.getSQLCondition();expect(b).toEqual(" (true) ")}),it("should return sql condition with selected only",function(){a.items.models[0].set("selected",!1);var b=a.getSQLCondition();expect(b).toEqual("c IN ('test2') ")}),it("should raise an error when histogram can't be generated",function(){spy=sinon.spy(),a.bind("error",spy),e.yields(null),c.trigger("data:saved"),expect(spy.called).toEqual(!0)}),it("should keep selected values",function(){a=new cdb.admin.models.FilterDiscrete({table:c,column:"c",items:[{bucket:"test",selected:!1}]}),d={},d.rows=[{bucket:"test"}],e.yields(d),c.trigger("data:saved"),expect(a.items.where({bucket:"test"})[0].get("selected")).toEqual(!0)}),it("should serialize to json",function(){expect(a.toJSON()).toEqual({reached_limit:void 0,column:"c",items:[{bucket:"test1",selected:!0},{bucket:"test2",selected:!0},{bucket:"test3",selected:!1}],free_text:void 0,column_type:void 0,list_view:!0})})}),describe("FilterDiscrete: null",function(){var a,b,c,d;beforeEach(function(){c={},c.rows=[{bucket:"test1"},{bucket:"test2"},{bucket:"test3"},{bucket:null}],b=TestUtil.createTable("test"),d=sinon.stub(b.data(),"discreteHistogram"),d.yields(c),a=new cdb.admin.models.FilterDiscrete({table:b,column:"c",items:[{bucket:"test1",selected:!0},{bucket:"test2",selected:!0},{bucket:"test3",selected:!1},{bucket:null,selected:!1}]})}),it("shouldn't select the NULL value in the query it'is unchecked",function(){var b=a.getSQLCondition();expect(a.get("column")).toEqual("c"),expect(b).toEqual("c IN ('test1','test2') AND c IS NOT NULL ")})})}),describe("Geocodings",function(){var a;beforeEach(function(){cdb.config.set({sql_api_port:80,sql_api_domain:"carto.com",sql_api_endpoint:"/api/v1/sql"}),this.table=TestUtil.createTable("test",[["the_geom","geometry"],["cartodb_georef_status","boolean"]]),this.geocoder=new cdb.admin.Geocoding,a=sinon.fakeServer.create()}),afterEach(function(){a.restore(),this.geocoder.dlg&&this.geocoder.dlg.hide()}),it("should initialize the values",function(){expect(this.geocoder.get("id")).toEqual(void 0),expect(this.geocoder.get("formatter")).toEqual(""),expect(this.geocoder.get("table_name")).toEqual(""),expect(this.geocoder.isGeocoding()).toBeFalsy()}),it("should trigger events when state property changes",function(){var a=!1;this.geocoder.set({id:666,formatter:"{name}",table_name:"test",state:null},{silent:!0}),this.geocoder.bind("geocodingStarted",function(){a=!0},this),this.geocoder.trigger("change"),expect(a).toBeTruthy()}),it("should save and trigger event when model cancels geocoding",function(b){var c=!1;this.geocoder.set({id:666,formatter:"{name}",table_name:"test"},{silent:!0}),this.geocoder.bind("geocodingCanceled",function(){c=!0},this),this.geocoder.pollCheck(1);var d=this;setTimeout(function(){a.requests[0].respond(200,{"Content-Type":"application/json"},JSON.stringify({id:666,state:null,processed_rows:0,total_rows:10})),d.geocoder.cancelGeocoding(),a.requests[0].respond(200,{"Content-Type":"application/json"},JSON.stringify({id:666,state:"canceled",processed_rows:0,total_rows:10})),expect(c).toBeTruthy(),b()},100)}),it("should trigger event when model resets geocoding",function(b){var c=!1;this.geocoder.set({id:666,formatter:"{name}",table_name:"test"},{silent:!0}),this.geocoder.bind("geocodingReset",function(){c=!0},this),this.geocoder.pollCheck(1);var d=this;setTimeout(function(){a.requests[0].respond(200,{"Content-Type":"application/json"},JSON.stringify({id:666,state:null,processed_rows:0,total_rows:10})),d.geocoder.resetGeocoding(),a.requests[0].respond(200,{"Content-Type":"application/json"},JSON.stringify({id:666,state:"reset",processed_rows:0,total_rows:10})),expect(c).toBeTruthy(),b()},100)})}),describe("cdb.admin.Grantables",function(){beforeEach(function(){this.org=new cdb.admin.Organization({id:"o1"}),this.grantables=new cdb.admin.Grantables(void 0,{organization:this.org,currentUserId:"u2"})}),it("should have a working URL",function(){expect(this.grantables.url()).toMatch("/organization/o1/grantables")}),describe("when is fetched",function(){beforeEach(function(){this.grantables.sync=function(a,b,c){c.success&&c.success({grantables:[{id:"u1",type:"user",name:"an user",avatar_url:"images/avatars/avatar_marker_red.png",model:{id:"u1",username:"foo"}},{id:"u2"},{id:"g1",type:"group",name:"my group",avatar_url:"avatar_marker_red.png",model:{id:"g1",display_name:"my group",name:"my_group"}}],total_entries:3})},this.grantables.fetch()}),it("should set grantables model",function(){expect(this.grantables.length).toBeGreaterThan(0)}),it("should have a organization set on collection",function(){expect(this.grantables.organization).toBe(this.org)}),it("should not add current user",function(){expect(this.grantables.length).toEqual(2),expect(this.grantables.total_entries).toEqual(2),expect(this.grantables.pluck("id")).toEqual(["u1","g1"])}),it("should set organization on each entity model",function(){expect(this.grantables.first().entity.organization).toBe(this.org),expect(this.grantables.last().entity.organization).toBe(this.org)})}),describe(".totalCount",function(){it("should not be set initially",function(){expect(this.grantables.totalCount()).toBeUndefined()}),describe("when data is fetched",function(){beforeEach(function(){this.grantables.sync=function(a,b,c){c.success&&c.success({grantables:[],total_entries:77})},this.grantables.fetch()}),it("should have the total count set",function(){expect(this.grantables.totalCount()).toEqual(77)})})})}),describe("cdb.admin.Group",function(){describe("when given no attrs",function(){beforeEach(function(){this.group=new cdb.admin.Group}),it("should create an empty users collection",function(){expect(this.group.users).toBeDefined(),expect(this.group.users.length).toEqual(0)})}),describe("when given some attrs",function(){beforeEach(function(){this.group=new cdb.admin.Group({id:"g1",display_name:"My Group",name:"my_group",users:[{id:"u1",username:"pepe"}]})}),it("should create a users collection from given members collection",function(){expect(this.group.users).toBeDefined(),expect(this.group.users.length).toEqual(1),expect(this.group.users.first().get("username")).toEqual("pepe"),expect(this.group.users.group).toBe(this.group)})})}),describe("cdb.admin.GroupUsers",function(){beforeEach(function(){var a=new cdb.admin.User({id:123,base_url:"https://carto.com/user/paco",username:"paco",organization:{id:"o1",owner:{id:123}}}),b=new cdb.admin.OrganizationGroups(void 0,{organization:a.organization});this.group=new cdb.admin.Group({id:"g1"}),this.group.collection=b,this.groupUsers=new cdb.admin.GroupUsers(void 0,{group:this.group})}),it("should create an empty users collection",function(){expect(this.groupUsers.length).toEqual(0)}),describe(".addInBatch",function(){beforeEach(function(){this.server=sinon.fakeServer.create(),spyOn($,"ajax").and.callThrough(),this.result=this.groupUsers.addInBatch([1,2,3])}),afterEach(function(){this.server.restore()}),it("should return a deferred object",function(){expect(this.result).toBeDefined(),expect(this.result.done).toBeDefined(),expect(this.result.fail).toBeDefined()}),it("should make a POST call to add users to group",function(){expect($.ajax).toHaveBeenCalled(),expect($.ajax.calls.argsFor(0)[0].type).toEqual("POST"),expect($.ajax.calls.argsFor(0)[0].data).toEqual(jasmine.objectContaining({users:[1,2,3]}))}),describe("when successfully added users",function(){beforeEach(function(){spyOn(this.groupUsers,"fetch"),this.server.respond("200")}),it("should fetch collection to update to proper state",function(){expect(this.groupUsers.fetch).toHaveBeenCalled()}),it("should not resolve promise just yet",function(){expect(this.result.isResolved()).toBe(!1)}),describe("when fetch succeeds",function(){beforeEach(function(){this.groupUsers.fetch.calls.argsFor(0)[0].success()}),it("should resolved promise",function(){expect(this.result.isResolved()).toBe(!0)})}),describe("when fetch fails",function(){beforeEach(function(){this.groupUsers.fetch.calls.argsFor(0)[0].error()}),it("should resolved promise",function(){expect(this.result.isResolved()).toBe(!0)})})})}),describe(".removeInBatch",function(){beforeEach(function(){this.server=sinon.fakeServer.create(),spyOn($,"ajax").and.callThrough(),this.groupUsers.reset([{id:1},{id:2},{id:9e3}]),this.result=this.groupUsers.removeInBatch([1,2,3])}),afterEach(function(){this.server.restore()}),it("should return a deferred object",function(){expect(this.result).toBeDefined(),expect(this.result.done).toBeDefined(),expect(this.result.fail).toBeDefined()}),it("should make a POST call to add users to group",function(){expect($.ajax).toHaveBeenCalled(),expect($.ajax.calls.argsFor(0)[0].type).toEqual("DELETE"),expect($.ajax.calls.argsFor(0)[0].data).toEqual(jasmine.objectContaining({users:[1,2,3]}))}),describe("when successfully removed users",function(){beforeEach(function(){spyOn(this.groupUsers,"fetch"),this.server.respond("200")}),it("should fetch collection to update to proper state",function(){expect(this.groupUsers.fetch).toHaveBeenCalled()}),it("should not change collection until fetch is successfully returned",function(){expect(this.groupUsers.pluck("id")).toEqual([1,2,9e3])}),it("should not resolved promise just yet",function(){expect(this.result.isResolved()).toBe(!1)}),describe("when fetch succeeds",function(){beforeEach(function(){this.groupUsers.fetch.calls.argsFor(0)[0].success()}),it("should resolved promise",function(){expect(this.result.isResolved()).toBe(!0)})}),describe("when fetch fails",function(){beforeEach(function(){this.groupUsers.fetch.calls.argsFor(0)[0].error()}),it("should remove users from collection, but might not be accurate state since fetch failed",function(){expect(this.groupUsers.pluck("id")).toEqual([9e3])}),it("should resolved promise",function(){expect(this.result.isResolved()).toBe(!0)})})})}),describe(".totalCount",function(){it("should not be set initially",function(){expect(this.groupUsers.totalCount()).toBeUndefined()}),describe("when data is fetched",function(){beforeEach(function(){this.groupUsers.sync=function(a,b,c){c.success&&c.success({users:[],total_user_entries:77,total_entries:0})},this.groupUsers.fetch()}),it("should have the total count set",function(){expect(this.groupUsers.totalCount()).toEqual(77)})})})}),describe("cdb.admin.Like",function(){describe("by default",function(){beforeEach(function(){this.like=new cdb.admin.Like}),it("should be likeable",function(){expect(this.like.get("likeable")).toBeTruthy()})}),describe(".newByVisData",function(){beforeEach(function(){this.visId=123}),describe("when url is provided",function(){beforeEach(function(){this.like=cdb.admin.Like.newByVisData({url:"http://patata.domain.com/api/like",vis_id:this.visId})}),it("should return a new like model with custom url",function(){expect(this.like.url).toBe("http://patata.domain.com/api/like")})}),describe("when liked",function(){beforeEach(function(){this.like=cdb.admin.Like.newByVisData({vis_id:this.visId,liked:!0})}),it("should return a new like model with liked set",function(){expect(this.like.get("liked")).toBeTruthy()}),it("should return a new like model with id set to vis id",function(){expect(this.like.get("id")).toEqual(this.visId)})}),describe("when not liked",function(){beforeEach(function(){this.like=cdb.admin.Like.newByVisData({vis_id:this.visId})}),it("should return a new like model with liked set to false",function(){expect(this.like.get("liked")).toBeFalsy()}),it("should return a new like model with no id",function(){expect(this.like.get("id")).toBeNull()})})})}),describe("cartodb.models.Map",function(){var a,b;beforeEach(function(){a=new cdb.admin.Map,b=new cdb.admin.Layers});var c='© <a href="https://carto.com/attributions" target="_blank">CARTO</a>';it("should clone",function(){var a=new cdb.geo.CartoDBLayer;b.add(a);var c=b.clone();expect(c.size()).toEqual(b.size());var d=_.clone(b.models[0].attributes);delete d.id,expect(c.models[0].attributes).toEqual(d),expect(c.get("id")).toEqual(void 0)}),it("should not change bounds according to base layer",function(){var b=new cdb.geo.TileLayer({maxZoom:8,minZoom:7,type:"Tiled",urlTemplate:"x",base_type:"x",name:"Positron"});a.addLayer(b),expect(a.get("maxZoom")).toEqual(8),expect(a.get("minZoom")).toEqual(7);var c=new cdb.geo.TileLayer({maxZoom:10,minZoom:9,type:"Tiled",urlTemplate:"y",base_type:"y",name:"Dark Matter"});sinon.stub(c,"save").yieldsTo("success"),a.setBaseLayer(c),expect(a.get("maxZoom")).toEqual(10),expect(a.get("minZoom")).toEqual(9)}),describe(".setBaseLayer",function(){it("should set the base layer as the first layer",function(b){savingLayersFinishCallback=jasmine.createSpy("savingLayersFinishCallback"),a.bind("savingLayersFinish",savingLayersFinishCallback);
var d=new cdb.geo.CartoDBLayer({id:"XXX-YYY",attribution:"CartoDB1.0",type:"Tiled",urlTemplate:"x",base_type:"x",name:"Positron"});sinon.stub(d,"save").yieldsTo("success"),a.setBaseLayer(d);var e=a.layers.at(0);expect(a.layers.length).toEqual(1),expect(e).toEqual(d),setTimeout(function(){expect(e.get("id")).toEqual("XXX-YYY"),expect(e.get("order")).toEqual(0),expect(d.save.called).toBeTruthy(),expect(savingLayersFinishCallback.calls.count()).toEqual(1),b()},0),expect(a.get("attribution")).toEqual(["CartoDB1.0",c])}),it("should update the existing base layer if the new layer has the same type",function(b){var d=new cdb.geo.TileLayer({id:"XXX-YYY",attribution:"CartoDB1.0",urlTemplate:"x",base_type:"x",name:"Positron"});sinon.stub(d,"save").yieldsTo("success");var e=new cdb.geo.TileLayer({attribution:"CartoDB2.0",urlTemplate:"y",base_type:"y",name:"Dark Matter"});a.setBaseLayer(d),savingLayersFinishCallback=jasmine.createSpy("savingLayersFinishCallback"),a.bind("savingLayersFinish",savingLayersFinishCallback),a.setBaseLayer(e),expect(a.layers.at(0).isEqual(e)).toBeTruthy(),setTimeout(function(){expect(a.layers.at(0).get("id")).toEqual("XXX-YYY"),expect(a.layers.at(0).get("order")).toEqual(0),expect(a.layers.at(0).get("name")).toEqual("Dark Matter"),expect(d.save.called).toBeTruthy(),expect(savingLayersFinishCallback.calls.count()).toEqual(1),b()},0),expect(a.get("attribution")).toEqual(["CartoDB2.0",c]),expect(a.layers.length).toEqual(1)}),it("should replace the base layer if the current base layer has a different type",function(b){var d=new cdb.admin.CartoDBLayer({id:"XXX-YYY",attribution:"CartoDB1.0",tile_style:"test1",query:"sql1",interactivity:"int1",visible:!0});sinon.stub(d,"save").yieldsTo("success");var e=new cdb.geo.TileLayer({id:"ZZZ-YYY",attribution:"CartoDB2.0",urlTemplate:"y",base_type:"y",name:"Positron"});sinon.stub(e,"save").yieldsTo("success"),a.setBaseLayer(d),expect(a.get("attribution")).toEqual(["CartoDB1.0",c]),savingLayersFinishCallback=jasmine.createSpy("savingLayersFinishCallback"),a.bind("savingLayersFinish",savingLayersFinishCallback),a.setBaseLayer(e),expect(a.layers.at(0).isEqual(e)).toBeTruthy(),setTimeout(function(){expect(a.layers.at(0).get("id")).toEqual("XXX-YYY"),expect(a.layers.at(0).get("order")).toEqual(0),expect(e.save.called).toBeTruthy(),expect(savingLayersFinishCallback.calls.count()).toEqual(1),b()},0),expect(a.get("attribution")).toEqual(["CartoDB2.0",c]),expect(a.layers.length).toEqual(1)}),it("shouldn't set base layer if the old base layer is the same",function(){var b=new cdb.geo.TileLayer({type:"Tiled",urlTemplate:"x",base_type:"x",name:"Positron"}),c={alreadyAdded:function(){console.log("base layer already added")}},d=!1;a.bind("savingLayersFinish",function(){d=!0}),expect(a.setBaseLayer(b)).not.toBeFalsy(),expect(a.setBaseLayer(b,c)).toBeFalsy(),expect(d).toEqual(!0)}),describe("basemaps with labels",function(){it("should add a layer with labels at the top if basemap has labels",function(b){var c=new cdb.admin.TileLayer({id:"ZZZ-YYY",attribution:"CartoDB2.0",name:"Wadus",urlTemplate:"y",minZoom:"0",maxZoom:"19",subdomains:"abcd",visible:!0,labels:{url:"http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png"}});a.setBaseLayer(c),setTimeout(function(){expect(a.layers.length).toEqual(2),expect(a.layers.at(0).isEqual(c)).toBeTruthy(),expect(a.layers.at(1).attributes).toEqual({visible:!0,type:"Tiled",urlTemplate:"http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png",attribution:"CartoDB2.0",name:"Wadus Labels",minZoom:"0",maxZoom:"19",subdomains:"abcd",kind:"tiled",order:1}),b()},0)}),it("should remove the layer with labels if new basemap has no labels",function(b){var c=new cdb.admin.TileLayer({id:"ZZZ-YYY",attribution:"CartoDB2.0",urlTemplate:"y",minZoom:"0",maxZoom:"19",subdomains:"abcd",visible:!0,labels:{url:"http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png"}});a.setBaseLayer(c);var d=new cdb.admin.TileLayer({id:"ZZZ-YYY",attribution:"CartoDB3.0",urlTemplate:"z",minZoom:"0",maxZoom:"20",subdomains:"abcd",visible:!0});a.setBaseLayer(d),setTimeout(function(){expect(a.layers.length).toEqual(1),expect(a.layers.at(0).isEqual(d)).toBeTruthy(),b()},0)}),it("should remove the layer with labels if new basemap is not a Tiled layer",function(b){var c=new cdb.admin.TileLayer({id:"ZZZ-YYY",attribution:"CartoDB2.0",urlTemplate:"y",minZoom:"0",maxZoom:"19",subdomains:"abcd",visible:!0,labels:{url:"http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png"}});a.setBaseLayer(c);var d=new cdb.admin.PlainLayer;a.setBaseLayer(d),setTimeout(function(){expect(a.layers.length).toEqual(1),expect(a.layers.at(0).isEqual(d)).toBeTruthy(),b()},0)}),it("should update layer with labels if previous basemap had labels and new basemap has labels",function(b){var c=new cdb.admin.TileLayer({id:"ZZZ-YYY",attribution:"CartoDB2.0",name:"Basemap 1",urlTemplate:"http://{s}.basemaps.cartocdn.com/light_no_labels/{z}/{x}/{y}.png",minZoom:"0",maxZoom:"19",subdomains:"abcd",visible:!0,labels:{url:"http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png"}});a.setBaseLayer(c);var d=new cdb.admin.TileLayer({id:"ZZZ-YYY",attribution:"newAttribution",name:"Basemap 2",urlTemplate:"http://{s}.basemaps.cartocdn.com/dark_no_labels/{z}/{x}/{y}.png",minZoom:"newMinZoom",maxZoom:"newMaxZoom",subdomains:"newSubdomains",visible:!0,labels:{url:"http://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}.png"}});a.setBaseLayer(d),setTimeout(function(){expect(a.layers.length).toEqual(2),expect(a.layers.last().attributes).toEqual({visible:!0,type:"Tiled",name:"Basemap 2 Labels",urlTemplate:"http://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}.png",attribution:"newAttribution",minZoom:"newMinZoom",maxZoom:"newMaxZoom",subdomains:"newSubdomains",kind:"tiled",order:1}),b()},0)})})}),it("should get 0 layers when type is not specified",function(){expect(a.layers.getLayersByType()).toBe(0),expect(a.layers.getLayersByType("")).toBe(0)}),it("should get the number of CartoDB layers",function(){var b=new cdb.geo.CartoDBLayer({urlTemplate:"x",base_type:"x"}),c=new cdb.geo.CartoDBLayer({urlTemplate:"y",base_type:"y"});a.addLayer(b),a.addLayer(c),expect(a.layers.getLayersByType("CartoDB").length).toBe(2)}),it("should get the number of Tiled layers",function(){var b=new cdb.geo.CartoDBLayer({urlTemplate:"x",base_type:"x"}),c=new cdb.geo.CartoDBLayer({urlTemplate:"y",base_type:"y"}),d=new cdb.geo.CartoDBLayer({maxZoom:8,minZoom:7,type:"Tiled",urlTemplate:"x",base_type:"x"});a.addLayer(b),a.addLayer(c),a.addLayer(d),expect(a.layers.getLayersByType("Tiled").length).toBe(1)}),it("shouldn't get any layer if this layer type doesn't exist",function(){var b=new cdb.geo.CartoDBLayer({urlTemplate:"x",base_type:"x"}),c=new cdb.geo.CartoDBLayer({urlTemplate:"y",base_type:"y"}),d=new cdb.geo.CartoDBLayer({maxZoom:8,minZoom:7,type:"Tiled",urlTemplate:"x",base_type:"x"});a.addLayer(b),a.addLayer(c),a.addLayer(d),expect(a.layers.getLayersByType("Jamon").length).toBe(0)}),it("should set base layer",function(){var b=new cdb.geo.CartoDBLayer({urlTemplate:"x",base_type:"x",id:1});a.addLayer(b);var c=new cdb.geo.CartoDBLayer({urlTemplate:"y",base_type:"y",id:2});a.addLayer(c);var d=new cdb.geo.CartoDBLayer({urlTemplate:"z",base_type:"z",id:3});sinon.stub(d,"save").yieldsTo("success");var e=a.setBaseLayer(d);expect(e).toEqual(d),expect(a.layers.at(0).id).not.toEqual(d.id),expect(a.layers.at(0).attributes.urlTemplate).toEqual(d.attributes.urlTemplate)}),it("should change layers 'map_id' attribution if map id changes",function(){var b=new cdb.geo.CartoDBLayer({});a.setCenter([1,0]),a.addLayer(b),b.sync=function(a,b,c){c.success({map_id:68},200)},a.set("id",68),expect(a.layers.models[0].url().indexOf("/maps/68/layers")!=-1).toEqual(!0)}),it("should trigger change:dataLayer when datalayer changes",function(){var b={changed:function(){}};spyOn(b,"changed"),a.bind("change:dataLayer",b.changed),a.addDataLayer(new cdb.geo.MapLayer),expect(b.changed).toHaveBeenCalled()}),it("should trigger change:dataLayer when 2 layers are added",function(){var b={changed:function(){}};spyOn(b,"changed"),a.bind("change:dataLayer",b.changed),a.layers.add(new cdb.geo.MapLayer),a.layers.add(new cdb.geo.MapLayer),expect(b.changed).toHaveBeenCalled()}),it("should trigger change:dataLayer when is reset with two layers",function(){var b={changed:function(){}};spyOn(b,"changed"),a.bind("change:dataLayer",b.changed),a.layers.reset([new cdb.geo.MapLayer,new cdb.geo.MapLayer]),expect(b.changed).toHaveBeenCalled()}),it("should change provider",function(){spyOn(a,"save"),a.changeProvider("googlemaps"),expect(a.save).toHaveBeenCalled()}),it("should not change provider if it is the same",function(){spyOn(a,"save"),a.changeProvider("leaflet"),expect(a.save).not.toHaveBeenCalled()}),it("should change the base layer",function(){spyOn(a,"save"),spyOn(a,"setBaseLayer"),sinon.stub(a,"save",function(a,b){b.success()}),a.changeProvider("leaflet",new cdb.geo.MapLayer),expect(a.setBaseLayer).toHaveBeenCalled()}),it("should notice on fail",function(){s=sinon.spy(),spyOn(a,"setBaseLayer"),a.bind("notice",s),sinon.stub(a,"save",function(a,b){b.error(null,{responseText:'{"errors":[]}'})}),a.changeProvider("gmaps",new cdb.geo.MapLayer),expect(a.setBaseLayer).not.toHaveBeenCalled(),expect(s.called).toEqual(!0)}),it("should clamp",function(){expect(a.set("center",[0,185]).clamp().get("center")).toEqual([0,-175]),expect(a.set("center",[0,-185]).clamp().get("center")).toEqual([0,175])}),it("should update the attribution of the map when layers change",function(){var b=new cdb.geo.CartoDBLayer({attribution:"attribution1"}),d=new cdb.geo.CartoDBLayer({attribution:"attribution1"}),e=new cdb.geo.CartoDBLayer({attribution:"wadus"}),f=new cdb.geo.CartoDBLayer({attribution:""});a.layers.reset([b,d,e,f]),expect(a.get("attribution")).toEqual(["attribution1","wadus",c])}),describe("layers",function(){it("should add layers on top",function(){var a=new cdb.admin.Layers;a.reset([new cdb.geo.TileLayer,new cdb.geo.CartoDBLayer]);var b=new cdb.geo.TorqueLayer;b.unset("order"),a.add(b),expect(a.at(2).get("type")).toEqual("torque")}),it("should insert cartodb layers before torque layers",function(){var a=new cdb.admin.Layers;a.reset([new cdb.geo.TileLayer,new cdb.geo.TorqueLayer]);var b=new cdb.geo.CartoDBLayer;b.unset("order"),a.add(b),expect(a.at(0).get("type")).toEqual("Tiled"),expect(a.at(1).get("type")).toEqual("CartoDB"),expect(a.at(2).get("type")).toEqual("torque")}),it("should create the right type",function(){var a=new cdb.admin.Layers;a.reset([{kind:"carto",options:{}}],{parse:!0}),expect(a.at(0).undoHistory).not.toEqual(void 0)}),it("should remove api key in toJSON",function(){var a=new cdb.admin.CartoDBLayer;a.set({extra_params:{map_key:"test",api_key:"test",dummy:"test2"}}),expect(_.keys(a.toJSON().options.extra_params).length).toEqual(1)}),it("should include infowindow in toJSON",function(){var a=new cdb.admin.CartoDBLayer;a.set({infowindow:"test"}),expect(a.toJSON().infowindow).toEqual(a.infowindow.toJSON())}),it("should not include infowindow if wizard doesn's support it",function(){var a=new cdb.admin.CartoDBLayer;a.wizard_properties={supportsInteractivity:function(){return!1},toJSON:function(){return{}}},a.set({infowindow:"test"}),expect(a.toJSON().infowindow).toBeNull()}),it("should include legend in toJSON",function(){var a=new cdb.admin.CartoDBLayer;a.legend.set({test:"test"}),expect(a.toJSON().options.legend).toEqual(a.legend.toJSON())}),it("should include tooltip in toJSON",function(){var a=new cdb.admin.CartoDBLayer;a.tooltip.addField("test"),expect(a.toJSON().tooltip).toEqual(a.tooltip.toJSON())}),it("should save when tooltip changes",function(a){var b=new cdb.admin.CartoDBLayer({id:1});spyOn(b,"save"),b.table=TestUtil.createTable("test",[["test","number"],["test2","string"]]),b.tooltip.addField("test"),setTimeout(function(){expect(b.save).toHaveBeenCalled(),expect(b.toJSON().tooltip).toEqual(b.tooltip.toJSON()),a()},300)}),it("should remove missing fields before save",function(a){var b=new cdb.admin.CartoDBLayer({id:1});spyOn(b,"save"),b.table=TestUtil.createTable("test",[["test","number"],["test2","string"]]),b.infowindow.addField("rambo"),b.infowindow.addField("test"),b.infowindow.addField("test2"),setTimeout(function(){expect(b.save).toHaveBeenCalled(),expect(b.save.calls.count()).toEqual(1);var c=_.pluck(b.toJSON().infowindow.fields,"name");expect(_.contains(c,"rambo")).toEqual(!1),expect(_.contains(c,"test")).toEqual(!0),expect(_.contains(c,"test2")).toEqual(!0),a()},1e3)}),it("should add api key when parse",function(){var a=new cdb.admin.CartoDBLayer;a.set({extra_params:{map_key:"test",api_key:"test",dummy:"test2"}});var b=a.parse({type:"Layer::Carto",options:{extra_params:{dummy:"test2"}}});expect(b.extra_params.map_key).not.toEqual(void 0)}),it("should add metadata when parse",function(){var a=new cdb.admin.CartoDBLayer;a.set({wizard_properties:{properties:{metadata:"test"}}},{silent:!0});var b=a.parse({type:"Layer::Carto",options:{wizard_properties:{type:"polygon",properties:{dummy:"test2"}}}});expect(b.wizard_properties.properties.metadata).toEqual("test")}),it("should get layer def",function(){var a=new cdb.admin.Layers;a.reset([new cdb.geo.TileLayer,new cdb.admin.CartoDBLayer({tile_style:"test1",query:"sql1",interactivity:"int1",visible:!0}),new cdb.admin.CartoDBLayer({tile_style:"test2",query:"sql2",interactivity:"int2",visible:!0}),new cdb.admin.CartoDBLayer({tile_style:"test3",query:"sql3",interactivity:"int3",visible:!1}),new cdb.admin.CartoDBLayer({tile_style:"test4",query:"select * from jaja",query_wrapper:"select i from (<%= sql %>)",interactivity:"int3",visible:!0})]),expect(a.getLayerDef()).toEqual({version:"1.0.1",layers:[{type:"cartodb",options:{sql:"sql1",cartocss:"test1",cartocss_version:"2.1.1",interactivity:"int1"}},{type:"cartodb",options:{sql:"sql2",cartocss:"test2",cartocss_version:"2.1.1",interactivity:"int2"}},{type:"cartodb",options:{sql:"select i from (select * from jaja)",cartocss:"test4",cartocss_version:"2.1.1",interactivity:"int3"}}]})}),it("should get layer def index",function(){var a=new cdb.admin.Layers,b=new cdb.admin.CartoDBLayer({tile_style:"test2",query:"sql2",interactivity:"int2",visible:!0}),c=new cdb.admin.CartoDBLayer({tile_style:"test3",query:"sql3",interactivity:"int3",visible:!0});a.reset([new cdb.geo.TileLayer,new cdb.admin.CartoDBLayer({tile_style:"test1",query:"sql1",interactivity:"int1",visible:!1}),b,c]),expect(a.getLayerDefIndex(b)).toEqual(0),expect(a.getLayerDefIndex(c)).toEqual(1)}),it("should get properly the number of data layers",function(){var a=new cdb.admin.Layers,b=new cdb.geo.TileLayer({type:"Tiled",urlTemplate:"x",base_type:"x"}),c=new cdb.admin.CartoDBLayer({tile_style:"test2",query:"sql2",interactivity:"int2",visible:!0}),d=new cdb.admin.CartoDBLayer({tile_style:"test1",query:"sql1",interactivity:"int1",visible:!1}),e=new cdb.admin.CartoDBLayer({tile_style:"test3",query:"sql3",interactivity:"int3",visible:!0}),f=new cdb.geo.TorqueLayer;a.reset([b,c,d,e]),expect(a.getTotalDataLayers()).toBe(3),a.reset([d,f]),expect(a.getTotalDataLayers()).toBe(2),a.reset([b,f]),expect(a.getTotalDataLayers()).toBe(1),a.reset([b]),expect(a.getTotalDataLayers()).toBe(0),a.reset([b,c,d,e,f]),expect(a.getTotalDataLayers()).toBe(4)}),it("should get properly the number of data layers with legend applied",function(){var a=new cdb.admin.Layers,b=new cdb.geo.TileLayer({type:"Tiled",urlTemplate:"x",base_type:"x"}),c=new cdb.admin.CartoDBLayer({tile_style:"test2",query:"sql2",interactivity:"int2",visible:!0,legend:{type:""}}),d=new cdb.admin.CartoDBLayer({tile_style:"test1",query:"sql1",interactivity:"int1",visible:!1,legend:{type:"custom"}}),e=new cdb.admin.CartoDBLayer({tile_style:"test3",query:"sql3",interactivity:"int3",visible:!0,legend:{}}),f=new cdb.geo.TorqueLayer({legend:{type:"torque"}});a.reset([b,c,d,e]),expect(a.getTotalDataLegends()).toBe(1),a.reset([d,f]),expect(a.getTotalDataLegends()).toBe(2),a.reset([b,f]),expect(a.getTotalDataLegends()).toBe(1),a.reset([b]),expect(a.getTotalDataLegends()).toBe(0),a.reset([b,c,d,e,f]),expect(a.getTotalDataLegends()).toBe(2),a.reset([c,e]),expect(a.getTotalDataLegends()).toBe(0)}),it(".isLayerOnTopOfDataLayers",function(){var a=new cdb.admin.Layers,b=new cdb.geo.CartoDBLayer,c=new cdb.geo.CartoDBLayer,d=new cdb.geo.TileLayer;a.add(b),expect(a.isLayerOnTopOfDataLayers(b)).toBeTruthy(),a.add(c),a.add(d),expect(a.isLayerOnTopOfDataLayers(b)).toBeFalsy(),expect(a.isLayerOnTopOfDataLayers(c)).toBeTruthy()}),describe(".moveLayer",function(){beforeEach(function(){spyOn(Backbone,"sync")}),it("should reassign orders correctly",function(){var a=new cdb.admin.Layers,b=new cdb.geo.TileLayer,c=new cdb.geo.CartoDBLayer,d=new cdb.geo.CartoDBLayer,e=new cdb.geo.CartoDBLayer;a.add(b),a.add(c),a.add(d),a.add(e),expect(b.get("order")).toEqual(0),expect(c.get("order")).toEqual(1),expect(d.get("order")).toEqual(2),expect(e.get("order")).toEqual(3),a.moveLayer(e,{to:1}),expect(b.get("order")).toEqual(0),expect(e.get("order")).toEqual(1),expect(c.get("order")).toEqual(2),expect(d.get("order")).toEqual(3),a.moveLayer(e,{to:2}),expect(b.get("order")).toEqual(0),expect(c.get("order")).toEqual(1),expect(e.get("order")).toEqual(2),expect(d.get("order")).toEqual(3),a.moveLayer(c,{to:3}),expect(b.get("order")).toEqual(0),expect(e.get("order")).toEqual(1),expect(d.get("order")).toEqual(2),expect(c.get("order")).toEqual(3)}),it("should trigger a reset event",function(a){var b=new cdb.admin.Layers,c=new cdb.geo.TileLayer,d=new cdb.geo.CartoDBLayer,e=new cdb.geo.CartoDBLayer;b.add(c),b.add(d),b.add(e);var f=jasmine.createSpy("callback");b.bind("reset",f),b.moveLayer(d,{to:2}),setTimeout(function(){expect(f).toHaveBeenCalled(),expect(f.calls.count()).toEqual(1),a()},0)}),it("should save layers",function(a){var b=new cdb.admin.Layers,c=new cdb.geo.TileLayer,d=new cdb.geo.CartoDBLayer,e=new cdb.geo.CartoDBLayer;b.add(c),b.add(d),b.add(e),b.moveLayer(d,{to:2}),setTimeout(function(){expect(Backbone.sync).toHaveBeenCalled(),a()},100)}),it("should throw an exception if saving layers fails",function(){var a=new cdb.admin.Layers,b=new cdb.geo.TileLayer,c=new cdb.geo.CartoDBLayer,d=new cdb.geo.CartoDBLayer;spyOn(a,"saveLayers"),a.add(b),a.add(c),a.add(d),a.moveLayer(c,{to:2}),expect(a.saveLayers.calls.count()).toEqual(1),expect(function(){a.saveLayers.calls.first().args[0].error()}).toThrow("Error saving layers after moving them")})})}),describe("CartoDBLayer",function(){var a;beforeEach(function(){a=new cdb.admin.CartoDBLayer,a.set("tile_style_custom",!0)}),afterEach(function(){delete localStorage["test_storage_"+a.get("table_name")]}),it("should set order on parse",function(){var b=a.parse({id:1,order:1001,options:{}});expect(b.order).toEqual(1001),expect(b.id).toEqual(1)}),it("should contain a default wizard type",function(){a.sync=function(){},a.table.set("geometry_types",["st_point"]),expect(a.wizard_properties.get("type")).toEqual("polygon")}),it("should not save when the layer is new",function(){a.set("interactivity","test"),spyOn(a,"save"),a.table.trigger("change:schema"),expect(a.save).not.toHaveBeenCalled(),a.set("tile_style","testttting"),expect(a.save).not.toHaveBeenCalled()}),it("should initialize history",function(){a.initHistory("test"),expect(a.get("test_history").length).toEqual(0),expect(a.test_history_position).toEqual(0)}),it("should be able to update history",function(){a.initHistory("test"),a.addToHistory("test","test1"),expect(a.get("test_history").length).toEqual(1),expect(a.get("test_history")[0]).toEqual("test1")}),it("should trim the history when limit is reached",function(){a.MAX_HISTORY_TEST=3,a.initHistory("test"),a.addToHistory("test","test1"),a.addToHistory("test","test2"),a.addToHistory("test","test3"),a.addToHistory("test","test4"),expect(a.get("test_history").length).toEqual(3),expect(a.get("test_history")[0]).toEqual("test2")}),it("should save on localStorage the history when limit is reached",function(){a.MAX_HISTORY_TEST=3,a.initHistory("test"),a.addToHistory("test","test1"),a.addToHistory("test","test2"),a.addToHistory("test","test3"),a.addToHistory("test","test4"),expect(localStorage.getItem("test_storage_"+a.get("table_name"))).toEqual('["test1"]')}),it("should detect if it's on the last history position",function(){a.initHistory("test"),a.addToHistory("test","test1"),a.addToHistory("test","test2"),expect(a.isHistoryAtLastPosition("test")).toBeTruthy()}),it("should detect if it's not on the last history position after browse",function(){a.initHistory("test"),a.addToHistory("test","test1"),a.addToHistory("test","test2"),a.undoHistory("test"),expect(a.isHistoryAtLastPosition("test")).toBeFalsy()}),it("should detect if it's on the last history position after browse and back",function(){a.initHistory("test"),a.addToHistory("test","test1"),a.addToHistory("test","test2"),a.undoHistory("test"),a.redoHistory("test"),expect(a.isHistoryAtLastPosition("test")).toBeTruthy()}),it("should detect if it's not the first history position",function(){a.initHistory("test"),a.addToHistory("test","test1"),a.addToHistory("test","test2"),expect(a.isHistoryAtFirstPosition("test")).toBeFalsy()}),it("should detect if it's on the first history position",function(){a.initHistory("test"),a.addToHistory("test","test1"),a.addToHistory("test","test2"),a.undoHistory("test"),expect(a.isHistoryAtFirstPosition("test")).toBeTruthy()}),it("should detect if it's not the first history position when there's local storage and user has browse after 0 pos",function(){a.MAX_HISTORY_TEST=3,a.initHistory("test"),a.addToHistory("test","test1"),a.addToHistory("test","test2"),a.addToHistory("test","test3"),a.addToHistory("test","test4"),expect(a.isHistoryAtFirstPosition("test")).toBeFalsy()}),it("should detect if it's not the first history position when there's local storage and user has browse after 0 pos",function(){a.MAX_HISTORY_TEST=3,a.initHistory("test"),a.addToHistory("test","test1"),a.addToHistory("test","test2"),a.addToHistory("test","test3"),a.addToHistory("test","test4"),a.undoHistory("test"),a.undoHistory("test"),expect(a.isHistoryAtFirstPosition("test")).toBeFalsy()}),it("should detect if it's on the first history position when there's local storage",function(){a.MAX_HISTORY_TEST=3,a.initHistory("test"),a.addToHistory("test","test1"),a.addToHistory("test","test2"),a.addToHistory("test","test3"),a.addToHistory("test","test4"),a.undoHistory("test"),a.undoHistory("test"),a.undoHistory("test"),expect(a.isHistoryAtFirstPosition("test")).toBeTruthy()}),it("should not save a new style if it's the same than previous one",function(){a.initHistory("test"),a.addToHistory("test","test1"),a.addToHistory("test","test1"),expect(a.get("test_history").length).toEqual(1)}),it("should undo tile_style history",function(){a.initHistory("tile_style"),a.addToHistory("tile_style","test1"),a.addToHistory("tile_style","test2"),a.addToHistory("tile_style","test3"),a.set({test:"test3"});a.undoHistory("tile_style");expect(a.getCurrentHistoryPosition("tile_style")).toEqual("test2")}),it("should undo history and get it from localStorage",function(){a.MAX_HISTORY_TEST=3,a.initHistory("test"),a.addToHistory("test","test1"),a.addToHistory("test","test2"),a.addToHistory("test","test3"),a.addToHistory("test","test4");var b=a.undoHistory("test");b=a.undoHistory("test"),b=a.undoHistory("test"),expect(a.getCurrentHistoryPosition("test")).toEqual("test1")}),it("should return first history if you undo more than the length",function(){a.MAX_HISTORY_TEST=3,a.initHistory("test"),a.addToHistory("test","test1"),a.addToHistory("test","test2"),a.addToHistory("test","test3");var b=a.undoHistory("test");b=a.undoHistory("test"),b=a.undoHistory("test"),expect(a.getCurrentHistoryPosition("test")).toEqual("test1")}),it("should return first history if you undo more than the length also from localStorage",function(){a.MAX_HISTORY_TEST=3,a.initHistory("test"),a.addToHistory("test","test1"),a.addToHistory("test","test2"),a.addToHistory("test","test3"),a.addToHistory("test","test4");var b=a.undoHistory("test");b=a.undoHistory("test"),b=a.undoHistory("test"),b=a.undoHistory("test"),b=a.undoHistory("test"),b=a.undoHistory("test"),expect(a.getCurrentHistoryPosition("test")).toEqual("test1")}),it("should redo tile_style history",function(){a.initHistory("tile_style"),a.addToHistory("tile_style","test1"),a.addToHistory("tile_style","test2"),a.addToHistory("tile_style","test3"),a.set({test:"test3"}),a.undoHistory("tile_style"),a.redoHistory("tile_style"),expect(a.getCurrentHistoryPosition("tile_style")).toEqual("test3")}),it("should undo to localstorage and redo to persisted history flawless",function(){a.MAX_HISTORY_TEST=3,a.initHistory("test"),a.addToHistory("test","test1"),a.addToHistory("test","test2"),a.addToHistory("test","test3"),a.addToHistory("test","test4"),a.addToHistory("test","test5");var b=a.undoHistory("test");b=a.undoHistory("test"),b=a.undoHistory("test"),b=a.undoHistory("test"),b=a.redoHistory("test"),b=a.redoHistory("test"),b=a.redoHistory("test"),b=a.redoHistory("test"),expect(a.getCurrentHistoryPosition("test")).toEqual("test5")}),it("should not save more than MAX_HISTORY_TILE_STYLE",function(){for(var b=0;b<a.MAX_HISTORY_TILE_STYLE+1;++b)a.addToHistory("tile_style","test"+b);expect(a.get("tile_style_history").length).toEqual(a.MAX_HISTORY_TILE_STYLE)}),it("should change state",function(){var b=new cdb.admin.SQLViewData;a.sync=function(){var a=$.Deferred();return a.abort=function(){},a},a.table.isInSQLView=function(){return!0},a.bindSQLView(b),expect(a.getCurrentState()).toEqual("success"),b.trigger("error"),expect(a.getCurrentState()).toEqual("error"),b.trigger("reset"),expect(a.getCurrentState()).toEqual("success")}),it("should bind to sqlView",function(){var b=new cdb.admin.SQLViewData;a.table.isInSQLView=function(){return!0},a.bindSQLView(b),a.set("query","test"),spyOn(a,"save"),b.trigger("error"),expect(a.save).toHaveBeenCalledWith({query:null},{silent:!0}),b.modify_rows=!0,a.set("query","test"),spyOn(a,"invalidate"),b.trigger("reset"),expect(a.get("query")).toEqual(null),expect(a.invalidate).toHaveBeenCalled(),b.modify_rows=!1,a.set("query","test"),b.options.set("sql","testsql"),b.trigger("reset"),expect(a.save.calls.mostRecent().args[0]).toEqual({query:"testsql",sql_source:void 0}),b.add({cartodb_id:1,test:2}),b.trigger("reset"),expect(a.save.calls.mostRecent().args[0]).toEqual({query:"testsql",sql_source:void 0})}),it("should disable interaction when the query has no cartodb_id",function(){spyOn(a,"save"),a.set({interactivity:"cartodb_id",id:"test-id"}),a.table.set({schema:[["the_geom_webmercator","geom"],["test1","number"],["test2","number"]]}),expect(a.save).toHaveBeenCalledWith({interactivity:null}),a.set({interactivity:null}),a.save.calls.reset(),a.table.set({schema:[["cartodb_id","number"],["the_geom_webmercator","geom"]]}),expect(a.save).toHaveBeenCalledWith({interactivity:"cartodb_id"})}),it("should include tooltip fields in interaction",function(){spyOn(a,"save"),a.table.set({schema:[["cartodb_id","number"],["the_geom_webmercator","geom"],["test1","number"],["test2","number"]]}),a.set({interactivity:"cartodb_id",id:"test-id"}),a.tooltip.addField("test1").addField("test2"),a.table.set({schema:[["the_geom_webmercator","geom"],["test1","number"],["test2","number"]]}),expect(a.save).toHaveBeenCalledWith({interactivity:"test1,test2"}),a.set({interactivity:null}),a.save.calls.reset(),a.table.set({schema:[["cartodb_id","number"],["the_geom_webmercator","geom"]]}),expect(a.save).toHaveBeenCalledWith({interactivity:"cartodb_id"}),a.table.set({schema:[["cartodb_id","number"],["the_geom_webmercator","geom"],["test1","number"],["test2","number"],["test3","number"]]}),a.save.calls.reset(),a.tooltip.addField("test3"),expect(a.save).toHaveBeenCalledWith({interactivity:"cartodb_id,test3"})}),it("should apply sql when it's binded to sqlView",function(){var b;a.set("query",b="select * from table");var c=new cdb.admin.SQLViewData;a.bindSQLView(c),expect(c.getSQL()).toEqual(b)}),it("should define sqlView when binds it",function(){var b=new cdb.admin.SQLViewData;a.bindSQLView(b),expect(a.sqlView).toBeDefined()}),it("should apply a sql to the sqlView if it was previously set in the layer",function(){var b=!1;a.set("query","SELECT * FROM table_test"),a.bind("applySQLView",function(){b=!0}),a.bindSQLView(new cdb.admin.SQLViewData),expect(b).toBeTruthy()}),it("should apply a query",function(){var b=new cdb.admin.SQLViewData;a.bindSQLView(b),spyOn(a.sqlView,"setSQL"),spyOn(a.sqlView,"fetch"),a.applySQLView("SELECT * FROM test"),expect(a.query_history_position).toBe(0),expect(a.get("query_history").length).toBe(1),expect(a.sqlView.setSQL).toHaveBeenCalledWith("SELECT * FROM test",{silent:!0,sql_source:null}),expect(a.sqlView.fetch).toHaveBeenCalled(),a.applySQLView("SELECT * FROM test where cartodb_id = 1234",{sql_source:"rambo"}),expect(a.sqlView.setSQL).toHaveBeenCalledWith("SELECT * FROM test where cartodb_id = 1234",{silent:!0,sql_source:"rambo"})}),it("should remove a query",function(){a.sync=function(){};var b=new cdb.admin.SQLViewData;a.bindSQLView(b),spyOn(a,"resetQuery"),spyOn(a.sqlView,"fetch"),a.applySQLView("SELECT * FROM test WHERE cartodb_id > 10"),a.clearSQLView(),expect(a.get("query_history").length).toBe(2),expect(a.table.isInSQLView()).toBeFalsy(),expect(a.resetQuery).toHaveBeenCalled()}),it("when style is updated the forms should not be updated",function(){a.sync=function(){},a.table.set("geometry_types",["st_polygon"]);var b=new cdb.admin.CartoStyles({table:a.table});b.attr("polygon-fill","#FFEE00");var c=b.get("style")+"\n #table::wadus { }";a.sync=function(){},a.wizard_properties.active("polygon"),a.set({tile_style:c,tile_style_custom:!0}),expect(a.wizard_properties.get("polygon-fill")).not.toEqual("#ffee00")}),it("should use table information if it's included",function(){a=new cdb.admin.CartoDBLayer({table:{id:"test",testing:"test"}}),expect(a.table.get("testing")).toEqual("test")}),it("should disable interactivity on torque, cluster, density",function(){a.sync=function(){},a.table.set({geometry_types:["st_point"],schema:[["cartodb_id","number"]]}),a.wizard_properties.active("cluster"),expect(a.get("interactivity")).toEqual(null),a.wizard_properties.active("polygon"),expect(a.get("interactivity")).toEqual("cartodb_id")}),it(".moveToFront should move the layer above other data layers",function(b){var c=new cdb.admin.TileLayer,d=new cdb.admin.CartoDBLayer,e=new cdb.admin.TorqueLayer,f=new cdb.admin.TileLayer,g=new cdb.admin.Layers;spyOn(g,"saveLayers"),a.collection=g,g.add(c),g.add(a),a.moveToFront(),expect(a.get("order")).toEqual(1),g.add(d),g.add(e),g.add(f),expect(a.get("order")).toEqual(1);var h=jasmine.createSpy("callback");g.bind("reset",h),a.moveToFront(),setTimeout(function(){expect(h.calls.count()).toEqual(1),expect(c.get("order")).toEqual(0),expect(d.get("order")).toEqual(1),expect(e.get("order")).toEqual(2),expect(a.get("order")).toEqual(3),expect(f.get("order")).toEqual(4),b()},0),expect(g.saveLayers).toHaveBeenCalled()})})}),describe("Infowindow",function(){it("should remove missing fields",function(){info=new cdb.geo.ui.InfowindowModel,info.addField("test").addField("test2"),info.removeMissingFields(["test2","uhuh"]),expect(info.containsField("test")).toEqual(!1),expect(info.containsField("uhuh")).toEqual(!1),expect(info.containsField("test2")).toEqual(!0)}),it("should add new fields and remove missing fields",function(){info=new cdb.geo.ui.InfowindowModel,info.addField("test").addField("test2"),info.mergeFields(["test2","jamon"]),expect(info.containsField("test")).toEqual(!1),expect(info.containsField("uhuh")).toEqual(!1),expect(info.containsField("test2")).toEqual(!0),expect(info.containsField("jamon")).toEqual(!0)})}),describe("cdb.admin.TileLayer",function(){describe(".validateTemplateURL",function(){beforeEach(function(){var a=this;this.img=jasmine.createSpy("Image"),spyOn(window,"Image").and.callFake(function(){
return a.img}),this.layer=new cdb.admin.TileLayer({urlTemplate:"http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png"}),this.successSpy=jasmine.createSpy("success"),this.errorSpy=jasmine.createSpy("error"),this.layer.validateTemplateURL({success:this.successSpy,error:this.errorSpy})}),it("should check a base tile",function(){expect(this.img.src).toMatch("http://[a-d].basemaps"),expect(this.img.src).toContain("basemaps.cartocdn.com/light_nolabels/0/0/0.png")}),describe("when succeeds to validate template URL",function(){beforeEach(function(){this.img.onload()}),it("should call success callback",function(){expect(this.successSpy).toHaveBeenCalled(),expect(this.errorSpy).not.toHaveBeenCalled()})}),describe("when failed to validate template URL",function(){beforeEach(function(){this.img.onerror()}),it("should call error callback",function(){expect(this.successSpy).not.toHaveBeenCalled(),expect(this.errorSpy).toHaveBeenCalled()})})}),describe(".byCustomURL",function(){beforeEach(function(){this.layer=cdb.admin.TileLayer.byCustomURL("http://{S}.basemaps.cartocdn.com/light_nolabels/{Z}/{X}/{Y}.png?key=Abc123D")}),it("should return a new tilelayer",function(){expect(this.layer instanceof cdb.admin.TileLayer).toBeTruthy()}),it("should have the URL set as template with vars in small caps",function(){expect(this.layer.get("urlTemplate")).toEqual("http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png?key=Abc123D")}),it("should have a set of default values",function(){expect(this.layer.get("maxZoom")).toEqual(21),expect(this.layer.get("minZoom")).toEqual(0),expect(this.layer.get("name")).toEqual(""),expect(this.layer.get("className")).toEqual("httpsbasemapscartocdncomlight_nolabelszxypngkeyabc123d")}),it("should throw error when given an invalid URL",function(){expect(function(){cdb.admin.TileLayer.byCustomURL("bampadam!@#")}).toThrowError(TypeError)})})}),describe("cdb.admin.Organization",function(){beforeEach(function(){this.organization=new cdb.admin.Organization({id:"68a57d79-d454-4b28-8af8-968e97b1349c",seats:5,quota_in_bytes:1234567890,created_at:"2014-06-05T16:34:51+02:00",updated_at:"2014-06-05T16:34:51+02:00",name:"orgtest3",owner:{id:"4ab67a64-7cbf-4890-88b8-9d3c398249d5",username:"dev",avatar_url:null},users:[]})}),it("should have owner",function(){expect(this.organization.owner.get("username")).toEqual("dev")}),it("should have a users collection attribute",function(){expect(this.organization.users).not.toBeUndefined()}),it("all collections should have reference to the organization",function(){var a=new cdb.admin.Organization({id:"68a57d79-d454-4b28-8af8-968e97b1349c",seats:5,quota_in_bytes:1234567890,created_at:"2014-06-05T16:34:51+02:00",updated_at:"2014-06-05T16:34:51+02:00",name:"orgtest3",owner:{id:"4ab67a64-7cbf-4890-88b8-9d3c398249d5",username:"dev",avatar_url:null},users:[{id:"b6551618-9544-4f22-b8ba-2242d6b20733",username:"t2",avatar_url:null},{id:"5b514d61-fb7a-4b9b-8a0a-3fdb82cf79ca",username:"t1",avatar_url:null}],groups:[{id:"g1"},{id:"g2"}]});expect(a.users.organization).toEqual(a),expect(a.groups.organization).toEqual(a),expect(a.grantables.organization).toEqual(a)})}),describe("cdb.admin.Organization.Users",function(){function a(a){return{id:a||"hello-id",username:"user"+a,avatar_url:"hi",base_url:"base-url"+a}}beforeEach(function(){this.org=new cdb.admin.Organization({id:"hello-org-id"}),this.orgUsers=new cdb.admin.Organization.Users(null,{organization:this.org,currentUserId:"current-user-id"}),this.originalSync=this.orgUsers.sync,this.orgUsers.sync=function(a,b,c){}}),it("should include sync abort",function(){expect(this.orgUsers.sync).not.toBeUndefined()}),it("should parse results properly",function(){this.orgUsers.sync=function(b,c,d){d.success&&d.success({users:[a()],total_user_entries:1,total_entries:1})},this.orgUsers.fetch(),expect(this.orgUsers.length).toBe(1),expect(this.orgUsers.total_user_entries).toBe(1),expect(this.orgUsers.total_entries).toBe(1)}),it("should exclude current user from results",function(){this.orgUsers.sync=function(b,c,d){d.success&&d.success({users:[a("current-user-id"),a()],total_user_entries:2,total_entries:2})},this.orgUsers.fetch(),expect(this.orgUsers.length).toBe(1),expect(this.orgUsers.total_user_entries).toBe(1),expect(this.orgUsers.total_entries).toBe(1)}),describe("when fetch is given data options",function(){beforeEach(function(){spyOn(Backbone,"sync").and.returnValue($.Deferred()),this.orgUsers.sync=this.originalSync,this.orgUsers.fetch({data:{page:1,per_page:77}})}),it("should set them on the fetch URL",function(){expect(Backbone.sync).toHaveBeenCalled();var a=Backbone.sync.calls.argsFor(0)[2];expect(a).toEqual(jasmine.objectContaining({data:{page:1,per_page:77}}))})}),describe(".totalCount",function(){it("should not be set initially",function(){expect(this.orgUsers.totalCount()).toBeUndefined()}),describe("when data is fetched",function(){beforeEach(function(){this.orgUsers.sync=function(b,c,d){d.success&&d.success({users:[a()],total_user_entries:77,total_entries:1})},this.orgUsers.fetch()}),it("should have the total count set",function(){expect(this.orgUsers.totalCount()).toEqual(77)})})})}),describe("cdb.admin.OrganizationGroups",function(){beforeEach(function(){var a=new cdb.admin.User({id:123,base_url:"https://carto.com/user/paco",username:"paco",organization:{id:"myorg42",owner:{id:123}}});this.org=a.organization,this.groups=new cdb.admin.OrganizationGroups([],{organization:a.organization})}),it("should set organization",function(){expect(this.groups.organization).toBe(this.org)}),describe(".newGroupById",function(){describe("when the group with the given id is not yet loaded",function(){beforeEach(function(){this.group=this.groups.newGroupById("g1")}),it("should return a group with the given id set",function(){expect(this.group.id).toEqual("g1")}),it("should have a valid url under the organization",function(){var a=this.group.url();expect(a).toBeTruthy(),expect(a).toMatch("organization/myorg42/groups/g1")}),it("should set collection on group",function(){expect(this.group.collection).toBe(this.groups)})}),describe("when group with given id already exists in collection",function(){beforeEach(function(){this.groups.add({id:"g2",display_name:"foobar"}),this.group=this.groups.newGroupById("g2")}),it("should return existing group",function(){expect(this.group).toBe(this.groups.first()),expect(this.group.collection).toBe(this.groups)})})}),describe("when groups is fetched",function(){beforeEach(function(){this.groups.sync=function(a,b,c){c.success&&c.success({groups:[{id:"g1"}],total_entries:1})},this.groups.fetch()}),it("should set organization on group objects",function(){expect(this.groups.length).toEqual(1)}),it("should have a total_entries prop set",function(){expect(this.groups.total_entries).toEqual(1)})}),describe(".totalCount",function(){it("should not be set initially",function(){expect(this.groups.totalCount()).toBeUndefined()}),describe("when data is fetched",function(){beforeEach(function(){this.groups.sync=function(a,b,c){c.success&&c.success({groups:[{id:"g1"}],total_entries:1})},this.groups.fetch()}),it("should have the total count set",function(){expect(this.groups.totalCount()).toEqual(1)})})})}),describe("cdb.admin.Permission",function(){var a,b,c,d,e;beforeEach(function(){this.owner=e=new cdb.admin.User({id:"uuid_owner",username:"owner"}),this.permission=a=new cdb.admin.Permission({owner:e.toJSON(),entity:{id:"test_id",type:"vis"}}),b=new cdb.admin.User({id:"uuid",username:"u1"}),c=new cdb.admin.User({id:"uuid2",username:"u2"}),this.organization=d=new cdb.admin.Organization({id:"org_uuid",users:[{id:"uuid2",username:"u2"}]}),c.organization=d}),describe(".isOwner",function(){it("should return true if given model is considered owner of item",function(){expect(this.permission.isOwner(b)).toBe(!1),expect(this.permission.isOwner({})).toBe(!1),expect(this.permission.isOwner(this.owner)).toBe(!0)}),it("should return true if ids are not set for owner",function(){this.permission.owner.unset("id"),expect(this.permission.isOwner({})).toBe(!0)}),describe("when has no owner",function(){beforeEach(function(){this.permission.owner=void 0}),it("should return false when owner is not set",function(){expect(this.permission.isOwner(this.owner)).toBe(!1)})}),describe("when owner has no id",function(){beforeEach(function(){this.other=this.owner.clone(),this.permission.owner.set("id",void 0)}),it("should return false when owner has no id",function(){expect(this.permission.isOwner(this.other)).toBe(!1)})})}),describe(".revokeWriteAccess",function(){beforeEach(function(){spyOn(this.permission,"grantReadAccess"),this.permission.revokeWriteAccess(b)}),it("should downgrade to read access",function(){expect(this.permission.grantReadAccess).toHaveBeenCalled(),expect(this.permission.grantReadAccess).toHaveBeenCalledWith(b)})}),describe(".revokeAccess",function(){describe("when model has own ACL item",function(){beforeEach(function(){this.permission.acl.add(this.permission._newAclItem(b,cdb.admin.Permission.READ_ONLY)),this.permission.revokeAccess(b)}),it("should return the ACL item",function(){expect(this.permission.acl.length).toEqual(0)})})}),describe("access",function(){beforeEach(function(){this.groupX=new cdb.admin.Group({id:"gx"}),this.permission.acl.add(this.permission._newAclItem(this.groupX,cdb.admin.Permission.READ_ONLY)),this.groupA=new cdb.admin.Group({id:"ga"}),this.permission.acl.add(this.permission._newAclItem(this.groupA,cdb.admin.Permission.READ_ONLY)),this.groupB=new cdb.admin.Group({id:"gb"}),this.permission.acl.add(this.permission._newAclItem(this.groupB,cdb.admin.Permission.READ_WRITE))}),describe("when given a model w/o any access",function(){it("should not have any access",function(){expect(this.permission.hasAccess(c)).toBe(!1),expect(this.permission.hasReadAccess(c)).toBe(!1),expect(this.permission.hasWriteAccess(c)).toBe(!1)}),it("should be able to set any access",function(){expect(this.permission.canChangeReadAccess(c)).toBe(!0),expect(this.permission.canChangeWriteAccess(c)).toBe(!0)})}),describe("when given an owner",function(){it("should have all access",function(){expect(this.permission.hasAccess(this.owner)).toBe(!0),expect(this.permission.hasReadAccess(this.owner)).toBe(!0),expect(this.permission.hasWriteAccess(this.owner)).toBe(!0)}),it("should be able to set any access",function(){expect(this.permission.canChangeReadAccess(this.owner)).toBe(!0),expect(this.permission.canChangeWriteAccess(this.owner)).toBe(!0)})}),describe("when given an user",function(){describe("when user is given read access",function(){beforeEach(function(){this.permission.grantReadAccess(c)}),it("should have read access",function(){expect(this.permission.hasAccess(c)).toBe(!0),expect(this.permission.hasReadAccess(c)).toBe(!0),expect(this.permission.hasWriteAccess(c)).toBe(!1)}),it("should be able to set any access",function(){expect(this.permission.canChangeReadAccess(this.owner)).toBe(!0),expect(this.permission.canChangeWriteAccess(this.owner)).toBe(!0)})}),describe("when user is given write access",function(){beforeEach(function(){this.permission.grantWriteAccess(c)}),it("should have both read+write access",function(){expect(this.permission.hasAccess(c)).toBe(!0),expect(this.permission.hasReadAccess(c)).toBe(!0),expect(this.permission.hasWriteAccess(c)).toBe(!0)}),it("should be able to set any access",function(){expect(this.permission.canChangeReadAccess(this.owner)).toBe(!0),expect(this.permission.canChangeWriteAccess(this.owner)).toBe(!0)})}),describe("when user is part of organization with read access",function(){beforeEach(function(){this.permission.grantReadAccess(this.organization)}),it("should have read access",function(){expect(this.permission.hasAccess(c)).toBe(!0),expect(this.permission.hasReadAccess(c)).toBe(!0),expect(this.permission.hasWriteAccess(c)).toBe(!1)}),it("should only be able to set write access",function(){expect(this.permission.canChangeReadAccess(c)).toBe(!1),expect(this.permission.canChangeWriteAccess(c)).toBe(!0)}),describe("when organization has write access",function(){beforeEach(function(){this.permission.grantWriteAccess(this.organization)}),it("should have both read+write access",function(){expect(this.permission.hasAccess(c)).toBe(!0),expect(this.permission.hasReadAccess(c)).toBe(!0),expect(this.permission.hasWriteAccess(c)).toBe(!0)}),it("should not be able to change any access",function(){expect(this.permission.canChangeReadAccess(c)).toBe(!1),expect(this.permission.canChangeWriteAccess(c)).toBe(!1)})})})}),describe("when given a group",function(){describe("when given group has own access",function(){it("should have the expected access",function(){expect(this.permission.hasAccess(this.groupX)).toBe(!0),expect(this.permission.hasReadAccess(this.groupX)).toBe(!0),expect(this.permission.hasWriteAccess(this.groupX)).toBe(!1),expect(this.permission.hasAccess(this.groupA)).toBe(!0),expect(this.permission.hasReadAccess(this.groupA)).toBe(!0),expect(this.permission.hasWriteAccess(this.groupA)).toBe(!1),expect(this.permission.hasAccess(this.groupB)).toBe(!0),expect(this.permission.hasReadAccess(this.groupB)).toBe(!0),expect(this.permission.hasWriteAccess(this.groupB)).toBe(!0)}),describe("when group is part of organization that has more privileged access",function(){beforeEach(function(){this.permission.grantWriteAccess(this.organization),this.organization.groups.add(this.groupA)}),it("should have organization access",function(){expect(this.permission.hasAccess(this.groupA)).toBe(!0),expect(this.permission.hasReadAccess(this.groupA)).toBe(!0),expect(this.permission.hasWriteAccess(this.groupA)).toBe(!0)}),it("should not be able to change any access",function(){expect(this.permission.canChangeReadAccess(this.groupA)).toBe(!1),expect(this.permission.canChangeWriteAccess(this.groupA)).toBe(!1)})})}),describe("when group w/o own access but is part of organization with read access",function(){beforeEach(function(){this.permission.grantReadAccess(this.organization),this.organization.groups.add(this.groupX)}),it("should have the organization read access",function(){expect(this.permission.hasAccess(this.groupX)).toBe(!0),expect(this.permission.hasReadAccess(this.groupX)).toBe(!0),expect(this.permission.hasWriteAccess(this.groupX)).toBe(!1)}),it("should only be able to change write access",function(){expect(this.permission.canChangeReadAccess(this.groupX)).toBe(!1),expect(this.permission.canChangeWriteAccess(this.groupX)).toBe(!0)}),describe("when organization has write access",function(){beforeEach(function(){this.permission.grantWriteAccess(this.organization),this.organization.groups.add(this.groupX)}),it("should have the organization read+write access",function(){expect(this.permission.hasAccess(this.groupX)).toBe(!0),expect(this.permission.hasReadAccess(this.groupX)).toBe(!0),expect(this.permission.hasWriteAccess(this.groupX)).toBe(!0)}),it("should not be able to change any access",function(){expect(this.permission.canChangeReadAccess(this.groupX)).toBe(!1),expect(this.permission.canChangeWriteAccess(this.groupX)).toBe(!1)})})})}),describe("when given a user w/o own access but is member of group with read access",function(){beforeEach(function(){b.groups.add(this.groupA)}),it("should have the group access",function(){expect(this.permission.hasAccess(b)).toBe(!0),expect(this.permission.hasReadAccess(b)).toBe(!0),expect(this.permission.hasWriteAccess(b)).toBe(!1)}),it("should only be able to change write access",function(){expect(this.permission.canChangeReadAccess(b)).toBe(!1),expect(this.permission.canChangeWriteAccess(b)).toBe(!0)}),describe("when user is member of multiple groups",function(){beforeEach(function(){b.groups.add(this.groupB)}),it("should have the most privileged access of the grops",function(){expect(this.permission.hasAccess(b)).toBe(!0),expect(this.permission.hasReadAccess(b)).toBe(!0),expect(this.permission.hasWriteAccess(b)).toBe(!0)}),it("should not be able to change any access (since has write inherited)",function(){expect(this.permission.canChangeReadAccess(b)).toBe(!1),expect(this.permission.canChangeWriteAccess(b)).toBe(!1)})}),describe("when user is also part of organization with read+write access",function(){beforeEach(function(){this.permission.grantWriteAccess(this.organization),b.organization=this.organization}),it("should return the organization access since it has precedence over groups",function(){expect(this.permission.hasAccess(b)).toBe(!0),expect(this.permission.hasReadAccess(b)).toBe(!0),expect(this.permission.hasWriteAccess(b)).toBe(!0)}),it("should not be able to change any access (since has write inherited)",function(){expect(this.permission.canChangeReadAccess(b)).toBe(!1),expect(this.permission.canChangeWriteAccess(b)).toBe(!1)})}),describe("when user is part of organization with read+write access",function(){beforeEach(function(){b.organization=null,this.organization.users.add(b),this.permission.grantWriteAccess(this.organization)}),it("should return the organization access since it has precedence over groups",function(){expect(this.permission.hasAccess(b)).toBe(!0),expect(this.permission.hasReadAccess(b)).toBe(!0),expect(this.permission.hasWriteAccess(b)).toBe(!0)}),it("should not be able to change any access (since has write inherited)",function(){expect(this.permission.canChangeReadAccess(b)).toBe(!1),expect(this.permission.canChangeWriteAccess(b)).toBe(!1)})}),describe("when user has organization read-only access",function(){beforeEach(function(){b.organization=this.organization,this.permission.grantReadAccess(this.organization)}),it("should return the organization access",function(){expect(this.permission.hasAccess(b)).toBe(!0),expect(this.permission.hasReadAccess(b)).toBe(!0),expect(this.permission.hasWriteAccess(b)).toBe(!1)}),it("should be able to change write access only",function(){expect(this.permission.canChangeReadAccess(b)).toBe(!1),expect(this.permission.canChangeWriteAccess(b)).toBe(!0)}),describe("when user has better access than organization",function(){beforeEach(function(){this.permission.grantWriteAccess(b)}),it("should have read+write access",function(){expect(this.permission.hasAccess(b)).toBe(!0),expect(this.permission.hasReadAccess(b)).toBe(!0),expect(this.permission.hasWriteAccess(b)).toBe(!0)}),it("should be able to change access",function(){expect(this.permission.canChangeReadAccess(b)).toBe(!0),expect(this.permission.canChangeWriteAccess(b)).toBe(!0)})}),describe("when user is also owner",function(){beforeEach(function(){this.permission.owner=b}),it("should have read+write access",function(){expect(this.permission.hasAccess(b)).toBe(!0),expect(this.permission.hasReadAccess(b)).toBe(!0),expect(this.permission.hasWriteAccess(b)).toBe(!0)}),it("should be able to change access",function(){expect(this.permission.canChangeReadAccess(b)).toBe(!0),expect(this.permission.canChangeWriteAccess(b)).toBe(!0)})})})})}),it("should parse owner and acl",function(){a=new cdb.admin.Permission({owner:{username:"rambo"},acl:[{type:"user",entity:{id:"u1",username:"u1"},access:"r"},{type:"user",entity:{id:"u2",username:"u2"},access:"rw"}]}),expect(a.owner.get("username")).toEqual("rambo"),expect(a.acl.length).toEqual(2),expect(a.acl.at(0).get("entity").get("username")).toEqual("u1")}),it("toJSON",function(){a.grantReadAccess(b),a.grantWriteAccess(c),expect(a.toJSON()).toEqual({entity:{id:"test_id",type:"vis"},acl:[{type:"user",entity:{id:"uuid",username:"u1",avatar_url:"http://cartodb.s3.amazonaws.com/static/public_dashboard_default_avatar.png"},access:"r"},{type:"user",entity:{id:"uuid2",username:"u2",avatar_url:"http://cartodb.s3.amazonaws.com/static/public_dashboard_default_avatar.png"},access:"rw"}]})}),it("updates owner",function(){a.set("owner",{username:"changed"}),expect(a.owner.get("username")).toEqual("changed"),a.set("acl",[{type:"user",entity:{id:"uuid",username:"u1",avatar_url:"http://cartodb.s3.amazonaws.com/static/public_dashboard_default_avatar.png"},access:"r"},{type:"user",entity:{id:"uuid2",username:"u2",avatar_url:"http://cartodb.s3.amazonaws.com/static/public_dashboard_default_avatar.png"},access:"rw"}]),expect(a.acl.length).toEqual(2)}),it("shouldn't trigger an acl reset change when acl is re-generated",function(){var b=0;a.acl.bind("reset",function(){++b}),a.set("acl",[{type:"user",entity:{id:"uuid",username:"u1",avatar_url:"http://cartodb.s3.amazonaws.com/static/public_dashboard_default_avatar.png"},access:"r"},{type:"user",entity:{id:"uuid2",username:"u2",avatar_url:"http://cartodb.s3.amazonaws.com/static/public_dashboard_default_avatar.png"},access:"rw"}]),expect(b).toEqual(0)}),describe(".clone",function(){beforeEach(function(){a.set("id","abc-123",{silent:!0}),this.permission=a.clone()}),it("should return a new Permission object",function(){expect(this.permission).not.toBe(a),expect(this.permission instanceof cdb.admin.Permission).toBeTruthy()}),it("should contain the same attributes as the original permission",function(){expect(this.permission.owner).not.toBeUndefined(),expect(this.permission.acl).not.toBeUndefined()}),it("should not have an id set",function(){expect(this.permission.get("id")).toBeUndefined(),expect(this.permission.get("id")).not.toEqual(a.get("id"))})}),describe(".overwriteAcl",function(){beforeEach(function(){this.otherPermission=a.clone(),this.otherPermission.grantReadAccess(b),this.otherPermission.grantWriteAccess(c),a.overwriteAcl(this.otherPermission)}),it("should set the ACL list from other permission object",function(){expect(a.acl.models).toEqual(this.otherPermission.acl.models)})})}),describe("cdb.admin.Slide",function(){var a,b,c;beforeEach(function(){c=new cdb.admin.Visualization({id:"vis_id",map_id:"map_id",active_layer_id:null,name:"test_table",description:"Visualization description",tags:["jamon","probando","test"],privacy:"PUBLIC",updated_at:"2013-03-04T18:09:34+01:00",type:"table"}),a=c.map,a.layers.add(new cdb.admin.CartoDBLayer({id:"layer_0"})),a.layers.add(new cdb.admin.CartoDBLayer({id:"layer_1"})),a.layers.add(new cdb.geo.TileLayer({id:"baselayer_0"})),a.layers.at(0).table.set("geometry_types",["st_point"]),a.layers.at(1).table.set("geometry_types",["st_point"]),c.overlays.url="/vis_overlays",b=new cdb.admin.Slide({id:"vis_id"}),b.visualization=new cdb.admin.Visualization({id:"test"}),spyOn(jQuery,"ajax").and.callThrough()}),it("should set vis id on activation",function(){b.setMaster(c),b.set("active",!0),expect(c.get("id")).toEqual(b.visualization.id)}),it("should not fetch map data on activation",function(){b.visualization=null,b.setMaster(c),b.unload(),b.set("active","true"),expect(jQuery.ajax.calls.count()).toEqual(0)}),it("should remove visualization on remove",function(){b.setMaster(c);var a=sinon.spy();spyOn(b.visualization,"destroy"),b.bind("destroy",a),b.destroy(),expect(b.visualization.destroy).toHaveBeenCalled(),expect(a.called).toEqual(!0)})}),describe("cdb.admin.Slides",function(){var a,b;beforeEach(function(){b=new cdb.admin.Visualization({id:"master_vis"}),a=new cdb.admin.Slides(null,{visualization:b})}),it("should create slide",function(c){b.map.layers.reset([new cdb.admin.TileLayer({id:"parentlayer"})]);var d=0;b.copy=function(a,b){var c=new cdb.admin.Visualization({id:"test_vis_id"+ ++d});return setTimeout(function(){b.success(c),c.map.layers.reset([new cdb.admin.TileLayer({id:"test_layer_id"})])},10),c};var e;a.create(function(a){e=a}),setTimeout(function(){expect(a.at(0).visualization.id).toEqual("test_vis_id1"),expect(e.visualization.id).toEqual("test_vis_id2"),expect(a.length).toEqual(2),c()},1e3)}),it("should active slide",function(){a.reset([{},{test:1}]),a.setActive(a.at(0)),expect(a.at(0).isActive()).toEqual(!0),expect(a.at(1).isActive()).toEqual(!1),a.setActive(a.at(1)),expect(a.at(0).isActive()).toEqual(!1),expect(a.at(1).isActive()).toEqual(!0)}),describe("setNext",function(){beforeEach(function(){a.reset([new cdb.admin.Slide({id:"id_0"}),new cdb.admin.Slide({id:"id_1"}),new cdb.admin.Slide({id:"id_2"})])}),it("should reorder layers",function(){a.at(0).setNext("id_1"),expect(a.at(0).id).toEqual("id_0"),expect(a.at(1).id).toEqual("id_1"),expect(a.at(2).id).toEqual("id_2")}),it("should reorder layers 2",function(){a.at(2).setNext("id_1"),expect(a.at(0).id).toEqual("id_0"),expect(a.at(1).id).toEqual("id_2"),expect(a.at(2).id).toEqual("id_1")}),it("should reorder moving to the end",function(){a.at(0).setNext(null),expect(a.at(0).id).toEqual("id_1"),expect(a.at(1).id).toEqual("id_2"),expect(a.at(2).id).toEqual("id_0")}),it("should reorder moving to the beginning",function(){a.at(2).setNext("id_0"),expect(a.at(0).id).toEqual("id_2"),expect(a.at(1).id).toEqual("id_0"),expect(a.at(2).id).toEqual("id_1")})})}),describe("backbone.cachedSync",function(){var a,b,c,d={};beforeAll(function(){spyOn(localStorage,"getItem").and.callFake(function(a){return d[a]}),spyOn(localStorage,"removeItem").and.callFake(function(a){delete d[a]}),spyOn(localStorage,"setItem").and.callFake(function(a,b){return d[a]=b+"",d[a]}),spyOn(localStorage,"clear").and.callFake(function(){d={}})}),beforeEach(function(){d={},window.user_data={username:"testuser",twitter:{enabled:!0},mailchimp:{enabled:!1}},c=Backbone.cachedSync("test-namespace"),a=Backbone.sync,Backbone.sync=function(a,b,c){setTimeout(function(){var a=["testresponse"];c.success(a,"success",{responseText:JSON.stringify(a)})},100)},b=new Backbone.Model,b.url=function(){return"test-url"}}),afterEach(function(){Backbone.sync=a}),it("should store in the cache",function(a){c("read",b,{success:function(){var b=d["cdb-cache/test-namespace-testuser/test-url"];expect(b).toEqual('["testresponse"]'),a()}})}),it("should invalidate by surrogate key",function(){c("read",b,{}),Backbone.cachedSync.invalidateSurrogateKeys("test-namespace"),expect(_.keys(d).length).toEqual(0)}),it("should return the value from cache if cached and then the new",function(a){d["cdb-cache/test-namespace-testuser/test-url"]='["cached"]';var e=0;c("read",b,{success:function(b){0===e?(expect(b).toEqual(["cached"]),++e):(expect(b,d["cdb-cache/test-namespace-testuser/test-url"]),expect(b).toEqual(["testresponse"]),a())}})})}),describe("TableSynchronization",function(){var a,b;beforeEach(function(){a=TestUtil.createTable("test"),b=new cdb.admin.TableSynchronization}),describe("JSON stringification",function(){it("should return guessing parameters, interval and URL when it doesn't come from a service",function(){b.set({content_guessing:!0,fake_guessing:!1});var a=b.toJSON();expect(_.size(a)).toBe(5),expect(a.type_guessing).not.toBeUndefined(),expect(a.url).not.toBeUndefined(),expect(a.interval).not.toBeUndefined(),expect(a.fake_guessing).toBeUndefined()}),it("should return the right params when it comes from a remote source",function(){b.set({type:"remote",remote_visualization_id:123,value:1234});var a=b.toJSON();expect(a.value).not.toBeUndefined(),expect(a.create_vis).toBeFalsy(),expect(a.remote_visualization_id).not.toBeUndefined()}),it("should add service attributes when it comes from a service",function(){b.set({service_name:"follower"});var a=b.toJSON();expect(_.size(a)).toBe(7),expect(a.service_name).not.toBeUndefined(),expect(a.service_item_id).not.toBeUndefined()})}),describe("linkToTable",function(){it("should assign id from table it exists and not fetch",function(){var c={id:"test",duration:10};a.set("synchronization",c),spyOn(b,"fetch"),b.linkToTable(a),expect(b.get("id")).toEqual(c.id),expect(b.get("duration")).toEqual(c.duration),expect(b.fetch).not.toHaveBeenCalled(),a.set("synchronization",{id:"test2"}),expect(b.get("id")).toEqual("test2")}),it("should remove sync",function(){spyOn(b,"destroy"),b.linkToTable(a),a.destroy(),expect(b.destroy).toHaveBeenCalled()})}),it("should unset id on destroy",function(){b.set("id","test"),expect(b.isSync()).toEqual(!0),b.destroy(),expect(b.isNew()).toEqual(!0),expect(b.isSync()).toEqual(!1)})}),describe("admin table",function(){describe("cbd.admin.Column",function(){var a;beforeEach(function(){var b=new cdb.admin.CartoDBTableMetadata({id:"testTable",name:"testTable"});a=new cdb.admin.Column({table:b,name:"columnName"})}),it("should have correct url",function(){expect(a.url()).toEqual("/api/v1/tables/testTable/columns/columnName")})}),describe("cbd.admin.CartoDBTableMetadata",function(){var a;beforeEach(function(){a=new cdb.admin.CartoDBTableMetadata({id:"testTable",name:"testTable",schema:[["test","string"],["test2","number"]]})}),it("should return columntypes",function(){expect(a.columnTypes()).toEqual({test:"string",test2:"number"})}),it("should return unqualified name",function(){ntable=new cdb.admin.CartoDBTableMetadata({id:'"kease".testTable',name:'"kease".testTable'}),expect(ntable.getUnqualifiedName()).toEqual("testTable"),expect(a.getUnqualifiedName()).toEqual("testTable")}),it("should add geometrytypes when adding a row",function(){a=new cdb.admin.CartoDBTableMetadata({name:"testTable",schema:[["test","string"],["test2","number"]],geometry_types:[]}),a.data().add({cartodb_id:2});var b=a.data().get(2);b.set("the_geom",'{"type": "point", "coordinates": [1,2]}'),expect(a.get("geometry_types")).toEqual(["st_point"])}),it("geometryTypeChanged",function(){var b=null;a.bind("change",function(){b=a.geometryTypeChanged()}),a.set("geometry_types",["ST_Point"]),expect(b).toEqual(!0),b=null,a.set("geometry_types",["ST_Point"]),expect(b).toEqual(null),b=null,a.set("geometry_types",["ST_MultiPoint"]),expect(b).toEqual(!1),b=null,a.set("geometry_types",["ST_Polygon"]),expect(b).toEqual(!0),b=null,a.unset("geometry_types"),expect(b).toEqual(!0)}),it("should be read only if it's synced",function(){expect(a.isReadOnly()).toEqual(!1),a.synchronization.set("id","test"),expect(a.isReadOnly()).toEqual(!0)}),it("should emit sync changes",function(){var b=sinon.spy();a.bind("change:isSync",b),a.synchronization.set("id","test"),expect(b.called).toEqual(!0),expect(b.firstCall.args[1]).toEqual(!0),a.synchronization.unset("id"),expect(b.secondCall.args[1]).toEqual(!1)}),it("should create column types",function(){expect(a._getColumn("test").get("type")).toEqual("string"),expect(a._getColumn("test2").get("type")).toEqual("number"),a.set({schema:[["test","number"],["test2","number"]]}),expect(a._getColumn("test").get("type")).toEqual("number")}),it("should sort schema",function(){a=new cdb.admin.CartoDBTableMetadata({name:"testTable",schema:[["otra_foobar","string"],["test2","number"],["_desc","string"],["other","string"],["the_geom","geometry"],["created_at","date"],["updated_at","date"],["cartodb_id","number"]]});var b=jasmine.createSpy();a.bind("change:schema",b),a.sortSchema(),expect(a.get("schema")).toEqual([["cartodb_id","number"],["the_geom","geometry"],["_desc","string"],["other","string"],["otra_foobar","string"],["test2","number"],["created_at","date"],["updated_at","date"]]),expect(b).toHaveBeenCalled()}),it("should copy the types of the original schema",function(){var b=new cdb.admin.SQLViewData(null,{sql:"select * from a"});a.useSQLView(b),b.query_schema={test:"string",test3:"number"},b.reset([{test:1,b:2}]),expect(a.getColumnType("test")).toEqual("string"),expect(a.getColumnType("test3")).toEqual("number"),expect(a.getColumnType("test2")).toEqual(void 0),a.useSQLView(null),expect(a.getColumnType("test")).toEqual("string"),expect(a.getColumnType("test3")).toEqual(void 0),expect(a.getColumnType("b")).toEqual(void 0)}),it("should have a original_schema",function(){var b=_.clone(a.get("schema"));expect(a.get("original_schema")).toEqual(b);var c=new cdb.admin.SQLViewData(null,{sql:"select * from a"});a.useSQLView(c),c.reset([{a:1,b:2}]),expect(a.get("original_schema")).toEqual(b),expect(a.get("schema")).not.toEqual(b)}),it("should return geom column types",function(){a.set({geometry_types:["ST_MultiPolygon"]}),expect(a.geomColumnTypes()).toEqual(["polygon"]),a.set({geometry_types:["ST_MultiPolygon","ST_LineString"]}),expect(a.geomColumnTypes()).toEqual(["polygon","line"]),a.set({geometry_types:["ST_MultiPoint","ST_LineString"]
}),expect(a.geomColumnTypes()).toEqual(["point","line"]),a.set({geometry_types:[]}),expect(a.geomColumnTypes()).toEqual([]),a.set({geometry_types:["st_MultiPoint","ST_LINESTRING"]}),expect(a.geomColumnTypes()).toEqual(["point","line"]),expect(a.geomColumnTypes("test")).toEqual([]),a.set({geometry_types:""}),expect(a.geomColumnTypes()).toEqual([])}),it("should return stats geom column types",function(){a.set({stats_geometry_types:["ST_MultiPolygon"]}),expect(a.statsGeomColumnTypes()).toEqual(["polygon"])}),it("hasgeomtype",function(){var a=new cdb.admin.Row({cartodb_id:100,the_geom:JSON.stringify({type:"point",coordinates:[2,1]})});expect(a.hasGeometry()).toEqual(!0),a.set("the_geom",null),expect(a.hasGeometry()).toEqual(!1),a.set("the_geom",void 0),expect(a.hasGeometry()).toEqual(!1)}),it("should know if the_geom contains a geoJSON",function(){var a={cartodb_id:100,the_geom:JSON.stringify({type:"point",coordinates:[2,1]})},b=new cdb.admin.Row(a);expect(b.isGeometryGeoJSON()).toBeTruthy(),a.the_geom="asdasdsad",b=new cdb.admin.Row(a),expect(b.isGeometryGeoJSON()).toBeFalsy()}),it("tojson should not include the_geom if is not in geojson format",function(){var a={cartodb_id:100,the_geom:JSON.stringify({type:"point",coordinates:[2,1]})},b=new cdb.admin.Row(a);expect(b.toJSON().the_geom).toEqual(a.the_geom),a.the_geom="asdasdsad",b=new cdb.admin.Row(a),expect(b.toJSON().the_geom).toEqual(void 0)}),it("tojson should not include the_geom_webmercator, created_at or updated_at",function(){var a={cartodb_id:100,updated_at:1,created_at:1,the_geom_webmercator:1},b=new cdb.admin.Row(a);expect(b.toJSON().the_geom).toEqual(void 0),expect(b.toJSON().created_at).toEqual(void 0),expect(b.toJSON().updated_at).toEqual(void 0)}),it("altertable",function(){var a=cdb.admin.CartoDBTableMetadata;expect(a.alterTable("select * from blba")).toEqual(!1),expect(a.alterTable("select create from table")).toEqual(!1),expect(a.alterTable("select * from test wherw id='vacuum'")).toEqual(!1),expect(a.alterTable("insert into blaba values (1,2,3,4)")).toEqual(!1),expect(a.alterTable("delete from bkna")).toEqual(!1),expect(a.alterTable("update aaa set a = 1")).toEqual(!1),expect(a.alterTable("vacuum full")).toEqual(!0),expect(a.alterTable("exPlain     Analyze select * from test")).toEqual(!0),expect(a.alterTable("grant update on foo to jerry")).toEqual(!0),expect(a.alterTable("comment on foo 'this is crazy'")).toEqual(!0),expect(a.alterTable("revoke update on foo from jerry")).toEqual(!0),expect(a.alterTable("reindex public.foo")).toEqual(!0),expect(a.alterTable("cluster public.foo using foo_gidx")).toEqual(!0),expect(a.alterTable("alter table add column blbla")).toEqual(!0),expect(a.alterTable("alter schema.table add column blbla")).toEqual(!0),expect(a.alterTable("create function")).toEqual(!0),expect(a.alterTable("create or replace function")).toEqual(!0),expect(a.alterTable("create index foo_idx on foo using gist(the_geom)")).toEqual(!0),expect(a.alterTable("create index foo_idx on public.foo (cartodb_id)")).toEqual(!0)}),it("altertabledata",function(){var a=cdb.admin.CartoDBTableMetadata;expect(a.alterTableData("select * from blba")).toEqual(!1),expect(a.alterTableData("alter table add column blbla")).toEqual(!0),expect(a.alterTableData("vacuum full")).toEqual(!0),expect(a.alterTableData("refresh materialized view bar")).toEqual(!0),expect(a.alterTableData("truncate table")).toEqual(!0),expect(a.alterTableData("truncate schema.table")).toEqual(!0),expect(a.alterTableData("update aaa set a = 1")).toEqual(!0),expect(a.alterTableData("update table as whatvever set a = null")).toEqual(!0),expect(a.alterTableData("update  __rabos123123     set a = 1")).toEqual(!0),expect(a.alterTableData("insert into blaba values (1,2,3,4)")).toEqual(!0),expect(a.alterTableData("insert    into blaba values (1,2,3,4)")).toEqual(!0),expect(a.alterTableData("delete from bkna")).toEqual(!0),expect(a.alterTableData("update  schema.table  set a = 1")).toEqual(!0),expect(a.alterTableData('update  "schema".table  set a = 1')).toEqual(!0),expect(a.alterTableData('update  "schema"."table"  set a = 1')).toEqual(!0),expect(a.alterTableData('update  "schema-dash".table  set a = 1')).toEqual(!0),expect(a.alterTableData('update  "schema-dash"."table"  set a = 1')).toEqual(!0)}),it("isGeoreferenced should be false when there's geom and no data",function(){new cdb.admin.Row({cartodb_id:100,the_geom:JSON.stringify({type:"point",coordinates:[2,1]})});a=TestUtil.createTable("test",[["the_geom","geometry"]],[]),expect(a.isGeoreferenced()).toEqual(!1)}),it("row fetch should request geometry",function(){a=TestUtil.createTable("test",[["the_geom","geometry"],["testa","number"]]);var b=new cdb.admin.Row({cartodb_id:100});b.table=a;var c;b.sqlApiClass=function(){return{execute:function(){return c=Array.prototype.slice.call(arguments),{done:function(){}}}}},b.fetch(),expect(c[0]).toEqual("SELECT testa ,ST_AsGeoJSON(the_geom, 8) as the_geom  from (select * from test) _table_sql WHERE cartodb_id = 100")}),it("row should not fetch the geom when no_geom is passed",function(){a=TestUtil.createTable("test",[["testa","number"],["the_geom","geometry"]]);var b=new cdb.admin.Row({cartodb_id:100});b.table=a;var c;b.sqlApiClass=function(){return{execute:function(){return c=Array.prototype.slice.call(arguments),{done:function(){}}}}},b.fetch({no_geom:!0}),expect(c[0]).toEqual("SELECT testa  from (select * from test) _table_sql WHERE cartodb_id = 100")}),it("row should not fetch the geom when no_geom is passed but quote the sql if needed",function(){a=TestUtil.createTable("000cd294-b124-4f82-b569-0f7fe41d2db8",[["testa","number"],["the_geom","geometry"]]);var b=new cdb.admin.Row({cartodb_id:100});b.table=a;var c;b.sqlApiClass=function(){return{execute:function(){return c=Array.prototype.slice.call(arguments),{done:function(){}}}}},b.fetch({no_geom:!0}),expect(c[0]).toEqual('SELECT testa  from (select * from "000cd294-b124-4f82-b569-0f7fe41d2db8") _table_sql WHERE cartodb_id = 100')}),it("isGeoreferenced should be false when there isn't any geometry column",function(){expect(a.isGeoreferenced()).toEqual(!1)}),it("isGeoreferenced should be true when there's geom and data",function(){var b=new cdb.admin.Row({cartodb_id:100,the_geom:JSON.stringify({type:"point",coordinates:[2,1]})});a=TestUtil.createTable("test",[["the_geom","geometry"]]),a.data().add(b),expect(a.isGeoreferenced()).toEqual(!0)}),it("isGeoreferenced should be true when there's geom and geometry data, but it's not loaded yet",function(){var b=new cdb.admin.Row({cartodb_id:100,the_geom:"GeoJSON"});a=TestUtil.createTable("test",[["the_geom","geometry"]]),a.data().add(b),expect(a.isGeoreferenced()).toEqual(!0)}),it("isGeoreferenced should be false when there's geom and no georef data",function(){var b=new cdb.admin.Row({cartodb_id:100,the_geom:null});a=TestUtil.createTable("test",[["the_geom","geometry"]],[]),a.data().add(b),expect(a.isGeoreferenced()).toEqual(!1)}),it("should change schema when a sqlview is reset",function(){var b=new cdb.admin.SQLViewData(null,{sql:"select * from a"});a.useSQLView(b),b.reset([{a:1,b:2}]),spyOn(a._data,"fetch"),expect(b.table).toEqual(a),a.useSQLView(null),expect(a._data.fetch).toHaveBeenCalled(),expect(b.table).toEqual(null)}),it("should remove sqlview when sqlview executes a write query",function(){var b=new cdb.admin.SQLViewData(null,{sql:"insert bbblba"});a.useSQLView(b),spyOn(a,"fetch"),b.modify_rows=!0,b.reset([{a:1,b:2}]),expect(a.isInSQLView()).toEqual(!1)}),it("it should return a row",function(){var b=a.data().getRow(1234);expect(b.id).toEqual(1234)}),it("newRow should fetch the table if table is emtpy",function(){a.data().reset([]);var b=a.data().newRow();spyOn(a.data(),"fetch"),b.trigger("saved"),expect(a.data().fetch).toHaveBeenCalled()}),it("should be able to link to infowindow",function(){info=new cdb.geo.ui.InfowindowModel,info.addField("test").addField("test2"),a.linkToInfowindow(info),a.trigger("columnRename","tt","test"),expect(info.containsField("test")).toEqual(!1),expect(info.containsField("tt")).toEqual(!0),a.trigger("columnRename","java","tt"),expect(info.containsField("tt")).toEqual(!1)}),it("should not clear infowindow on write queries",function(){info=new cdb.geo.ui.InfowindowModel,info.addField("test"),a.linkToInfowindow(info);var b=new cdb.admin.SQLViewData(null,{sql:"select * from a"});b.url="test",a.useSQLView(b),b.modify_rows=!0,b.reset([]),expect(info.containsField("test")).toEqual(!0)}),it("should restore the infowindow fields for an sql view",function(){info=new cdb.geo.ui.InfowindowModel,info.addField("test"),a.linkToInfowindow(info);var b=new cdb.admin.SQLViewData(null,{sql:"select * from a limit 10"});a.useSQLView(b),b.query_schema={a:"string",b:"number"},b.reset([{a:1,b:2}]),info.addField("a").addField("b"),b.query_schema={c:"string",d:"number"},b.reset([{c:1,d:2}]),info.addField("c").addField("d"),b.query_schema={b:"number",a:"string"},b.reset([{a:1,b:2}]),expect(info.containsField("a")).toEqual(!0),expect(info.containsField("b")).toEqual(!0)}),it("should restore the infowindow fields after clear a sql view",function(){info=new cdb.geo.ui.InfowindowModel,info.addField("test"),a.linkToInfowindow(info);var b=new cdb.admin.SQLViewData(null,{sql:"select * from a"});a.useSQLView(b),b.query_schema={test:"string",b:"number"},b.reset([{a:1,b:2}]),spyOn(a,"fetch"),expect(b.table).toEqual(a),expect(info.containsField("test")).toEqual(!0),expect(info.containsField("b")).not.toEqual(!0),a.useSQLView(null),expect(info.containsField("test")).toEqual(!0),expect(info.containsField("test2")).toEqual(!1),a.useSQLView(b),b.reset([{a:1,b:2}]),b.reset([{a:1,b:2,c:3}]),a.useSQLView(null),expect(info.containsField("test")).toEqual(!0),expect(info.containsField("test2")).toEqual(!1)}),it("should return default sql",function(){expect(a.data().getSQL()).toEqual("select * from testTable")}),it("should retrieve a column type",function(){var b=a.getColumnType("test");expect(b).toEqual("string")}),it("should add a column",function(){var b=sinon.fakeServer.create();b.respondWith("POST","/api/v1/tables/"+a.get("name")+"/columns/",[200,{"Content-Type":"application/json"},'{"name":"irrelevant1","type":"text","cartodb_type":"string"}']);var c=!1,d=!1;a.bind("columnAdd",function(){d=!0}),a.addColumn("irrelevant1","string",{success:function(){c=!0}}),b.respond(),expect(c).toBeTruthy(),expect(d).toEqual(!0)}),it("should remove a column",function(){var b=sinon.fakeServer.create();b.respondWith("DELETE","/api/v1/tables/"+a.get("name")+"/columns/test",[200,{"Content-Type":"application/json"},'{"name":"irrelevant1","type":"text","cartodb_type":"string"}']);var c=!1;a.bind("columnDelete",function(){c=!0}),spyOn(a._data,"fetch"),a.deleteColumn("test"),b.respond(),expect(c).toBeTruthy(),expect(a._data.fetch).toHaveBeenCalled()}),it("should not remove a column if it's invalid",function(){var b=sinon.fakeServer.create();b.respondWith("DELETE","/api/v1/tables/"+a.get("name")+"/columns/test",[200,{"Content-Type":"application/json"},'{"name":"irrelevant1","type":"text","cartodb_type":"string"}']);var c=!1;a.bind("columnDelete",function(){c=!0}),a.deleteColumn(""),b.respond(),expect(c).not.toBeTruthy()}),it("should rename a column",function(){var b=sinon.fakeServer.create();b.respondWith("PUT","/api/v1/tables/"+a.get("name")+"/columns/test",[200,{"Content-Type":"application/json"},'{"name":"irrelevant1","type":"text","cartodb_type":"string"}']);var c=!1;a.bind("columnRename",function(a,b){"test"==b&&"irrelevant"==a&&(c=!0)}),spyOn(a._data,"fetch"),a.renameColumn("test","irrelevant"),b.respond(),expect(c).toBeTruthy(),expect(a._data.fetch).toHaveBeenCalled()}),it("should be able to say if a type change is possible",function(){expect(a.isTypeChangeAllowed("test2","string")).toBeTruthy(),expect(a.isTypeChangeAllowed("test2","date")).toBeFalsy(),expect(a.isTypeChangeAllowed("test","date")).toBeTruthy()}),it("should be able to say if a type change is destructive",function(){expect(a.isTypeChangeDestructive("test2","string")).toBeFalsy(),expect(a.isTypeChangeDestructive("test","number")).toBeTruthy()}),it("should change the type of a column",function(){var b=sinon.fakeServer.create();b.respondWith("PUT","/api/v1/tables/"+a.get("name")+"/columns/test2",[200,{"Content-Type":"application/json"},'{"name":"irrelevant1","type":"text","cartodb_type":"string"}']);var c=!1;a.bind("typeChanged",function(a){(a="string")&&(c=!0)}),spyOn(a._data,"fetch"),a.changeColumnType("test2","string"),b.respond(),expect(c).toBeTruthy(),expect(a._data.fetch).toHaveBeenCalled()}),it("should trigger an error when there's any error saving the type change",function(){var b=sinon.fakeServer.create();b.respondWith("PUT","/api/v1/tables/"+a.get("name")+"/columns/test",[500,{"Content-Type":"application/json"},'{"name":"irrelevant1","type":"text","cartodb_type":"string"}']);var c=!1;a.bind("typeChangeFailed",function(a){(a="string")&&(c=!0)}),a.changeColumnType("test2","string"),b.respond(),expect(c).toBeTruthy()}),it("should do nothing when you try to change a column to its own type",function(){sinon.spy();spyOn(a,"saveNewColumnType"),a.changeColumnType("test","string"),expect(a.saveNewColumnType).not.toHaveBeenCalled()}),it("shoudl not fetch data when geometry_types change",function(){a.trigger("change"),spyOn(a._data,"fetch"),a.set("geometry_types",["st_polygon","st_multilinestring"]),expect(a._data.fetch).not.toHaveBeenCalled()}),it("should raise when read only is set",function(){var b=0;a.bind("change:readOnly",function(){++b}),a.setReadOnly(!0),expect(b).toEqual(1),a.setReadOnly(!0),expect(b).toEqual(1),a.setReadOnly(!1),expect(b).toEqual(2)}),describe(".duplicate",function(){beforeEach(function(){var a=this;this.fakeImport=new cdb.admin.Import,spyOn(this.fakeImport,"save"),spyOn(cdb.admin,"Import").and.callFake(function(){return a.fakeImport})}),describe("when table is in SQL view",function(){beforeEach(function(){spyOn(a,"isInSQLView").and.returnValue(!0),a.duplicate("foobar",{})}),it("should the new table name",function(){expect(this.fakeImport.save).toHaveBeenCalled(),expect(this.fakeImport.save.calls.argsFor(0)[0]).toEqual(jasmine.objectContaining({table_name:"foobar"}))}),it("should return an object with SQL",function(){expect(this.fakeImport.save.calls.argsFor(0)[0]).toEqual(jasmine.objectContaining({sql:"select * from testTable"}))})}),describe("when table is not in SQL view",function(){beforeEach(function(){spyOn(a,"isInSQLView").and.returnValue(!1),a.duplicate("foobar",{})}),it("should the new table name",function(){expect(this.fakeImport.save).toHaveBeenCalled(),expect(this.fakeImport.save.calls.argsFor(0)[0]).toEqual(jasmine.objectContaining({table_name:"foobar"}))}),it("should return an object with SQL",function(){expect(this.fakeImport.save.calls.argsFor(0)[0]).toEqual(jasmine.objectContaining({table_copy:"testTable"}))})}),describe("when import creation fails",function(){beforeEach(function(){this.errorCallback=jasmine.createSpy("error"),a.duplicate("foobar",{error:this.errorCallback}),this.fakeImport.save.calls.argsFor(0)[1].error()}),it("should call the error callback",function(){expect(this.errorCallback).toHaveBeenCalled()})}),describe("when import creation succeeds",function(){beforeEach(function(){this.errorCallback=jasmine.createSpy("error"),this.successCallback=jasmine.createSpy("success"),spyOn(this.fakeImport,"pollCheck"),a.duplicate("foobar",{error:this.errorCallback,success:this.successCallback}),this.fakeImport.save.calls.argsFor(0)[1].success(this.fakeImport,{item_queue_id:"abc-123"})}),it("should create a new import model from the old one",function(){expect(cdb.admin.Import.calls.count()).toEqual(2),expect(cdb.admin.Import.calls.argsFor(1)[0]).toEqual(jasmine.objectContaining({item_queue_id:"abc-123"}))}),it("should start checking for import status",function(){expect(this.fakeImport.pollCheck).toHaveBeenCalled()}),describe("when import fails",function(){beforeEach(function(){this.fakeImport.trigger("importError",1,2,3)}),it("should called error callback with args",function(){expect(this.errorCallback).toHaveBeenCalled(),expect(this.errorCallback).toHaveBeenCalledWith(1,2,3)})}),describe("when import succeeds",function(){beforeEach(function(){var a=this;this.fakeTable=new cdb.admin.CartoDBTableMetadata,this.fakeImport.set("table_id","abc-123"),spyOn(cdb.admin,"CartoDBTableMetadata").and.callFake(function(){return a.fakeTable}),spyOn(this.fakeTable,"fetch"),this.fakeImport.trigger("importComplete")}),it("should create new table from imported table id",function(){expect(cdb.admin.CartoDBTableMetadata).toHaveBeenCalled(),expect(cdb.admin.CartoDBTableMetadata).toHaveBeenCalledWith(jasmine.objectContaining({id:"abc-123"}))}),it("should fetch all table data for it to be ready",function(){expect(this.fakeTable.fetch).toHaveBeenCalled()}),describe("when table fetch fails",function(){beforeEach(function(){this.fakeTable.fetch.calls.argsFor(0)[0].error(1,2,3)}),it("should call error callback with args",function(){expect(this.errorCallback).toHaveBeenCalled(),expect(this.errorCallback).toHaveBeenCalledWith(1,2,3)})}),describe("when table fetch succeeds",function(){beforeEach(function(){this.fakeTable.fetch.calls.argsFor(0)[0].success()}),it("should call the sucess callback with new table",function(){expect(this.successCallback).toHaveBeenCalled(),expect(this.successCallback).toHaveBeenCalledWith(this.fakeTable)})})})})}),describe(".dependentVisualizations",function(){it("should return a list",function(){expect(a.dependentVisualizations()).toEqual([])}),describe("when there are at least some dependent/non-dependent visualizations",function(){beforeEach(function(){a.set({dependent_visualizations:[{id:"dv1"},{id:"dv2"}],non_dependent_visualizations:[{id:"ndv1"}]})}),it("should return them as a list",function(){var b=a.dependentVisualizations();expect(b.length).toEqual(3),expect(_.pluck(b,"id")).toEqual(["dv1","dv2","ndv1"])})})})}),describe("cbd.admin.CartoDBTableData",function(){var a,b;beforeEach(function(){a=new cdb.admin.CartoDBTableMetadata({name:"testTable",schema:[["test","string"],["test2","number"]]}),a.sqlApiClass=cartodb.SQLMock,a.sqlApiClass.setResponse("execute",{rows:["row"]}),b=new cdb.admin.CartoDBTableData(null,{table:a})}),it("should reset pagination on fetch",function(){b.fetch(),expect(b.options.get("page")).toEqual(0),expect(b.options.previous("page")).toEqual(0),b.options.set("page",1),b.fetch({add:!0}),expect(b.options.get("page")).toEqual(1)}),it("should allow user to paginate past 10th page",function(){b.fetch(),b.pages=[6,7,8,9],b.options.set("page",1),b.size=function(){return 1e5},b.newPage(10,"down"),expect(b.pages).toEqual([7,8,9,10])}),it("should allow refresh all table data",function(){spyOn(b.table,"fetch").and.callFake(function(a){a.complete()}),spyOn(b,"fetch"),b.refresh(),expect(b.fetch).toHaveBeenCalled()}),it("url should include sql query",function(){spyOn(Backbone,"sync"),a.set({name:"testTable",id:"testTable"});var c=["CASE","WHEN GeometryType(the_geom) = 'POINT' THEN","ST_AsGeoJSON(the_geom,8)","WHEN (the_geom IS NULL) THEN","NULL","ELSE","GeometryType(the_geom)","END the_geom"].join(" "),d='select "cartodb_id","test","test2",'+c+" from (select * from testTable) __wrapped order by cartodb_id asc";b.query_schema={cartodb_id:"integer",test:"string",test2:"number",the_geom:"geometry"},b.sync();var e=Backbone.sync.calls.mostRecent().args[2].data;expect(e.indexOf(encodeURIComponent(d))).not.toEqual(-1),expect(e.indexOf("rows_per_page=40")).not.toEqual(-1),expect(e.indexOf("the_geom_webmercator")).toEqual(-1),b.query_schema={test:"string",test2:"number"},b.sync(),e=Backbone.sync.calls.mostRecent().args[2].data;var d='select "test","test2" from (select * from testTable) __wrapped order by cartodb_id asc';expect(e.indexOf(encodeURIComponent(d))).not.toEqual(-1),expect(e.indexOf("the_geom_webmercator")).toEqual(-1),b.options.set("sort_order","desc"),b.options.set("order_by","test"),d='select "test","test2" from (select * from testTable) __wrapped order by test desc',b.sync(),e=Backbone.sync.calls.mostRecent().args[2].data,expect(e.indexOf(encodeURIComponent(d))).not.toEqual(-1)}),it("url should include sql query quoting the table name if needed",function(){spyOn(Backbone,"sync"),a.set({name:"000cd294-b124-4f82-b569-0f7fe41d2db8",id:"000cd294-b124-4f82-b569-0f7fe41d2db8"});var c=["CASE","WHEN GeometryType(the_geom) = 'POINT' THEN","ST_AsGeoJSON(the_geom,8)","WHEN (the_geom IS NULL) THEN","NULL","ELSE","GeometryType(the_geom)","END the_geom"].join(" "),d='select "cartodb_id","test","test2",'+c+' from (select * from "000cd294-b124-4f82-b569-0f7fe41d2db8") __wrapped order by cartodb_id asc';b.query_schema={cartodb_id:"integer",test:"string",test2:"number",the_geom:"geometry"},b.sync();var e=Backbone.sync.calls.mostRecent().args[2].data;expect(e.indexOf(encodeURIComponent(d))).not.toEqual(-1),expect(e.indexOf("rows_per_page=40")).not.toEqual(-1),expect(e.indexOf("the_geom_webmercator")).toEqual(-1),b.query_schema={test:"string",test2:"number"},b.sync(),e=Backbone.sync.calls.mostRecent().args[2].data;var d='select "test","test2" from (select * from "000cd294-b124-4f82-b569-0f7fe41d2db8") __wrapped order by cartodb_id asc';expect(e.indexOf(encodeURIComponent(d))).not.toEqual(-1),expect(e.indexOf("the_geom_webmercator")).toEqual(-1),b.options.set("sort_order","desc"),b.options.set("order_by","test"),d='select "test","test2" from (select * from "000cd294-b124-4f82-b569-0f7fe41d2db8") __wrapped order by test desc',b.sync(),e=Backbone.sync.calls.mostRecent().args[2].data,expect(e.indexOf(encodeURIComponent(d))).not.toEqual(-1)}),it("should add params to the request",function(){spyOn(Backbone,"sync"),b.query_schema={cartodb_id:"integer",test:"string",test2:"number",the_geom:"geometry"},b.sync();var a=Backbone.sync.calls.mostRecent().args[2].data;expect(a.indexOf("rows_per_page=40")).not.toEqual(-1)}),it("should call fetch when options change",function(){spyOn(b,"fetch"),b.loadPageAtBottom(),expect(b.fetch).toHaveBeenCalled()}),it("should manage page blocks",function(){var a=40;b.sync=function(c,d,e){for(var f=[],g=0;g<a;++g)f.push({cartodb_id:g+40*b.options.get("page"),jaja:"test"});e.success({rows:f,modified:!1})},b._sqlQuery=function(a,b){b({cartodb_id:"integer",test:"string",test2:"number",the_geom:"geometry"})},b.fetch(),expect(b.pages).toEqual([0]),expect(b.size()).toEqual(40),b.loadPageAtBottom(),expect(b.pages).toEqual([0,1]),expect(b.size()).toEqual(80),b.loadPageAtBottom(),expect(b.pages).toEqual([0,1,2]),expect(b.size()).toEqual(120),b.loadPageAtBottom(),expect(b.pages).toEqual([0,1,2,3]),expect(b.size()).toEqual(160),b.loadPageAtBottom(),expect(b.pages).toEqual([1,2,3,4]),expect(b.size()).toEqual(160),b.loadPageAtTop(),expect(b.size()).toEqual(160)}),it("should set page 0 when order is changed",function(){b.options.attributes.page=10,b.setOptions({mode:"desc"}),expect(b.options.get("page")).toEqual(0),b.setOptions({mode:"desc",page:8}),expect(b.options.get("page")).toEqual(8)}),it("should be able to fetch the georeference status",function(){a.fetchGeoreferenceStatus(),expect(cartodb.SQLMock.getState().executeCount).toEqual(1)}),it("should detect if the_geom is present",function(){a.set({name:"testTable",schema:[["test","string"],["test2","number"],["the_geom","geometry"]]}),expect(a.hasTheGeom()).toBeTruthy()}),it("should get the histogram",function(){for(var b={upper:1,lower:-1,buckets:[],val:[]},c=0;c<10;++c)b.buckets.push(c),b.val.push(100*Math.sin(c));sinon.stub(a.data(),"_sqlQuery").yields({rows:[b]}),a.data().histogram(10,"column",function(a,b){expect(a.length).toEqual(10),expect(_.max(a)).toEqual(1),expect(b.upper).toEqual(1),expect(b.lower).toEqual(-1)})}),it("should get the discrete histogram",function(){var b=[1,2,3,4,5,6,7,8,9,10,11,12,13,14],c=10;b.length;sinon.stub(a.data(),"_sqlQuery").yields({rows:b}),a.data().discreteHistogram(c,"column",function(a){expect(a.reached_limit).toBeTruthy(),expect(a.rows.length).toEqual(c)})})});var a="0101000020110F00004E3CE77C32B324418662B3BD88715841",b="0106000020E61000000100000001030000000100000016000000000000C0D4211740000000A07DC34840000000C0285C1740000000E0AEC6484000000000BF98174000000060D5D44840000000A03F48174000000020E4DF48400000000096FC164000000060CBE54840000000C06903174000000000B1EC484000000060A8EC16400000008073F2484000000060BB3B17400000006005FB48400000000065471740000000203E0149400000002085EB1740000000000B16494000000080826D1840000000207915494000000040FF861840000000601110494000000040138F18400000004092FF484000000080814E1940000000A07BEB484000000060C1161A4000000020D2E74840000000E0CE0A1A40000000A06ADA484000000060707D1940000000A08DCB484000000000EA721940000000A0E0BA4840000000603EA91840000000609AC0484000000000F1EC17400000008062B948400000000074DA17400000004081BE4840000000C0D4211740000000A07DC34840";describe("cbd.admin.SQLViewData",function(){var c;beforeEach(function(){c=new cdb.admin.SQLViewData(null,{sql:"select * from a"})}),it("default order should be empty after set sql",function(){c.setSQL("select * from table"),expect(c.options.get("order_by")).toEqual(""),expect(c.options.get("sort_order")).toEqual("asc"),expect(c.options.get("filter_column")).toEqual(""),expect(c.options.get("filter_value")).toEqual(""),expect(c.options.get("page")).toEqual(0)}),it("should guess geometry type",function(){c.reset({the_geom:a}),expect(c.getGeometryTypes()).toEqual(["ST_Point"]),c.reset({the_geom:b}),expect(c.getGeometryTypes()).toEqual(["ST_Multipolygon"]),c.reset({the_geom_webmercator:a}),expect(c.getGeometryTypes()).toEqual(["ST_Point"]),c.reset({the_geom_webmercator:b}),expect(c.getGeometryTypes()).toEqual(["ST_Multipolygon"]),c.reset({the_geom:b,the_geom_webmercator:a}),expect(c.getGeometryTypes()).toEqual(["ST_Multipolygon"]),c.reset([{the_geom:null},{the_geom:null},null,{the_geom:a},{the_geom:null}]),expect(c.getGeometryTypes()).toEqual(["ST_Point"])}),it("should return true if has georeferenced data",function(){c.reset([{the_geom:'{"type":"Point","coordinates":[-5.84198,43.648001]}'}]),expect(c.isGeoreferenced()).toEqual(!0)}),it("should return false if hasn't any georeferenced data",function(){c.reset([{r:1}]),expect(c.isGeoreferenced()).toEqual(!1)}),it("should raise change:sql always",function(){var a=0;c.options.bind("change:sql",function(){++a}),c.setSQL("select * from test"),c.setSQL("select * from test"),c.setSQL("select * from test2"),expect(a).toEqual(3)}),it("should not set null sql",function(){c.setSQL(null),expect(c.options.get("sql")).toEqual("")}),it("should replace variables like {x},{y},{z} by a 0",function(){c.setSQL("select {x}, {y}, {z} as aaa from table"),expect(c.options.get("sql")).toEqual("select 0, 0, 0 as aaa from table"),c.setSQL("select \\{x} as aaa from table"),expect(c.options.get("sql")).toEqual("select {x} as aaa from table")}),it("should be read only when a filter has been applied",function(){c.setSQL("select {x}, {y}, {z} as aaa from table"),expect(c.isReadOnly()).toBeTruthy(),c.options.set("sql_source","filters"),expect(c.isReadOnly()).toBeFalsy()}),it("should reset rows when fails",function(){c.reset([{a:1,b:2}]),expect(c.size()).toEqual(1);var a=sinon.spy();c.bind("reset",a),c.trigger("error"),expect(a.called).toEqual(!0),expect(c.size()).toEqual(0)}),it("fech should use POST when the query is longer than 1024 bytes",function(){spyOn(c,"_sqlQuery");for(var a="select * from table limit ";a.length<1025;)a+="0";c.setSQL(a),c.fetch(),expect(c._sqlQuery.calls.argsFor(0)[3]).toEqual("POST")}),it("write queries should not fetch metadata",function(){c.url="test",spyOn(c,"_sqlQuery"),c.setSQL("update table set a = 1"),c.fetch(),expect(c._sqlQuery).not.toHaveBeenCalled(),c.setSQL("select * from table"),c.fetch(),expect(c._sqlQuery).toHaveBeenCalled()}),it("write queries should use post",function(){spyOn(Backbone,"sync"),c.setSQL("update table set a = 1"),c.sync(),expect(Backbone.sync.calls.argsFor(0)[2].type).toEqual("POST")}),it("should explicitly add 'as' to aliases",function(){spyOn(c,"_sqlQuery"),c.setSQL("SELECT the_geom as location FROM testTable"),c.fetch(),expect(c._sqlQuery.calls.mostRecent().args[0]).toEqual("select * from (SELECT the_geom as location FROM testTable) __wrapped limit 0",Function,Function,"GET")})})}),describe("cdb.admin.TileJSON",function(){beforeEach(function(){this.model=new cdb.admin.TileJSON({url:"/tile.json"}),this.attrsExFromToTileJSONSpec={tilejson:"2.1.0",name:"compositing",description:"A simple, light grey world.",version:"1.0.0",attribution:'<a href="http://openstreetmap.org">OSM contributors</a>',template:"{{#__teaser__}}{{NAME}}{{/__teaser__}}",legend:"Dangerous zones are red, safe zones are green",scheme:"xyz",tiles:["http://localhost:8888/admin/1.0.0/world-light,broadband/{z}/{x}/{y}.png"],grids:["http://localhost:8888/admin/1.0.0/broadband/{z}/{x}/{y}.grid.json"],data:["http://localhost:8888/admin/data.geojson"],minzoom:0,maxzoom:11,bounds:[-180,-85.05112877980659,180,85.0511287798066],center:[-76.275329586789,39.153492567373,8]}}),it("should have a custom URL to get JSON result",function(){expect(this.model.url()).toEqual("/tile.json")}),describe(".newTileLayer",function(){describe("when have fetched model successfully",function(){beforeEach(function(){this.model.set(this.attrsExFromToTileJSONSpec)}),it("should return a new tile layer",function(){expect(this.model.newTileLayer()instanceof cdb.admin.TileLayer).toBeTruthy()}),it("should return model with expected attrs",function(){var a=this.model.newTileLayer();expect(a.get("urlTemplate")).toEqual("http://localhost:8888/admin/1.0.0/world-light,broadband/{z}/{x}/{y}.png"),expect(a.get("maxZoom")).toEqual(11),expect(a.get("minZoom")).toEqual(0),expect(a.get("bounding_boxes")).toEqual([-180,-85.05112877980659,180,85.0511287798066]),expect(a.get("attribution")).toEqual('<a href="http://openstreetmap.org">OSM contributors</a>'),expect(a.get("name")).toEqual("compositing")}),it("should set the TMS option based on the value of scheme",function(){expect(this.model.newTileLayer().get("tms")).toEqual(!1),this.model.set("scheme","tms"),expect(this.model.newTileLayer().get("tms")).toEqual(!0)})})})}),describe("cdb.admin.User",function(){var a;beforeEach(function(){a=new cdb.admin.User({base_url:"http://team.carto.com/u/pepe",id:"uuid",organization:{id:"o1",admins:[]},groups:[{id:"g1",display_name:"my group"}]})}),it("should create an organization",function(){expect(a.organization.id).toEqual("o1")}),it("should create a user groups collection",function(){expect(a.groups).toBeDefined(),expect(a.groups.length).toEqual(1),expect(a.groups.organization).toBeDefined()}),it("shouldn't set avatar_url is it comes with null value",function(){new cdb.admin.User({avatar_url:null});expect(a.get("avatar_url")).toBe("http://cartodb.s3.amazonaws.com/static/public_dashboard_default_avatar.png")}),it("isInsideOrg",function(){a.organization.users.reset([]),a.organization.id="",expect(a.isInsideOrg()).toEqual(!1),a.organization.users.add(new cdb.admin.User),a.organization.users.add(new cdb.admin.User),expect(a.isInsideOrg()).toEqual(!1),a.organization.id="hello-org-id",expect(a.isInsideOrg()).toEqual(!0)}),it("isOrgOwner",function(){a.organization.owner=a,expect(a.isOrgOwner()).toEqual(!0),a.organization.owner=new cdb.admin.User({id:"test",organization:{}}),expect(a.isOrgOwner()).toEqual(!1)}),it("isOrgAdmin",function(){a.organization.set("admins",[{id:a.id}]),expect(a.isOrgAdmin()).toEqual(!0),a.organization.set("admins",[{id:"not_me"}]),expect(a.isOrgAdmin()).toEqual(!1),a.organization=null,expect(a.isOrgAdmin()).toEqual(!1)}),it("should answer if user can create new datasets",function(){a.set("remaining_byte_quota",0),expect(a.canCreateDatasets()).toEqual(!1),a.set("remaining_byte_quota",10),expect(a.canCreateDatasets()).toEqual(!0),a.set("remaining_byte_quota",void 0),a.unset("remaining_byte_quota"),expect(a.canCreateDatasets()).toEqual(!1)}),it("hasFeatureFlagEnabled",function(){var b="test_flag",c=[];c.push(b),a.set("feature_flags",c),expect(a.featureEnabled(b)).toEqual(!0),
expect(a.featureEnabled("flagWrong")).toEqual(!1)}),describe(".equals",function(){describe("given same user",function(){it("should return true",function(){expect(a.equals(a)).toBeTruthy()})}),describe("given not same user",function(){it("should return false",function(){expect(a.equals(new cdb.admin.User)).toBeFalsy(),expect(a.equals(new cdb.core.Model)).toBeFalsy()})})}),describe(".viewUrl",function(){it("should return a user URL",function(){expect(a.viewUrl()).toEqual(jasmine.any(Object))}),it("should have been set with base url",function(){expect(a.viewUrl().get("base_url")).toEqual("http://team.carto.com/u/pepe")}),it("should have been created with if user is org admin or not",function(){expect(a.viewUrl().get("is_org_admin")).toBeFalsy(),spyOn(a,"isOrgAdmin").and.returnValue(!0),expect(a.viewUrl().get("is_org_admin")).toBeTruthy()})}),describe(".upgradeContactEmail",function(){describe("when is a normal user",function(){beforeEach(function(){spyOn(a,"isInsideOrg").and.returnValue(!1)}),it("should return the general support email",function(){expect(a.upgradeContactEmail()).toEqual("support@carto.com")})}),describe("when us a organization user",function(){beforeEach(function(){spyOn(a,"isInsideOrg").and.returnValue(!0)}),describe("when user is also admin of organization",function(){beforeEach(function(){spyOn(a,"isOrgOwner").and.returnValue(!0)}),it("should return enterprise support email",function(){expect(a.upgradeContactEmail()).toEqual("enterprise-support@carto.com")})}),describe("when user is a normal organization member",function(){beforeEach(function(){a.organization.owner=new cdb.admin.User({email:"owner@org.com"})}),it("should return the organiation owner email",function(){expect(a.upgradeContactEmail()).toEqual("owner@org.com")})})})}),describe(".nameOrUsername",function(){it("should return the name or username as fallback if name is not available",function(){a.set("username","kalle"),expect(a.nameOrUsername()).toEqual("kalle"),a.set("name","Kalle Anka"),expect(a.nameOrUsername()).toEqual("Kalle Anka")})}),describe("canAddLayerTo",function(){beforeEach(function(){this.map=new cdb.admin.Map({provider:"leaflet"}),this.map.layers.reset([new cdb.admin.CartoDBLayer({type:"CartoDB",id:1,table_name:"test_table_1"}),new cdb.admin.CartoDBLayer({type:"CartoDB",id:2,table_name:"test_table_2"})]),a.set("limits",{max_layers:3})}),it("should be true when user has not reached layer limits",function(){expect(a.canAddLayerTo(this.map)).toBeTruthy()}),it("should not be true when user has reached layer limits",function(){a.set("limits",{max_layers:2}),expect(a.canAddLayerTo(this.map)).toBeFalsy()}),it("should raise an error when map argument is not defined",function(){expect(function(){a.canAddLayerTo()}).toThrow(new Error("Map model is not defined or wrong")),expect(function(){a.canAddLayerTo({layers:{}})}).toThrow(new Error("Map model is not defined or wrong"))})})}),describe("Visualization model",function(){var a,b;beforeEach(function(){cdb.admin.CartoDBLayer.updateCartoCss=function(){},b=96,a=new cdb.admin.Visualization({map_id:b,active_layer_id:null,name:"test_table",description:"Visualization description",tags:["jamon","probando","test"],privacy:"PUBLIC",updated_at:"2013-03-04T18:09:34+01:00",type:"table",permission:{owner:{username:"rambo",base_url:"http://team.carto.com/u/rambo"},acl:[{type:"user",access:"r",entity:{username:"charly",base_url:"http://team.carto.com/u/charly"}}]},transition_options:{action:"click",time:40},table:{name:'"rambo".test_table'}})}),describe("transition_options",function(){it("should load transition_options",function(){expect(a.transition.get("action")).toEqual("click")}),it("should serailize transition_options",function(){a.transition.set("time",50),expect(a.toJSON().transition_options).toEqual({action:"click",time:50})})}),describe("permission",function(){it("should load permissions",function(){expect(a.permission.owner.get("username")).toEqual("rambo"),expect(a.permission.acl.length).toEqual(1)})}),describe("slides",function(){beforeEach(function(){this.master=new cdb.admin.Visualization({id:"test",type:"derived",children:[{id:"slide_1"},{id:"slide_2"}]})}),it("should change name on master change",function(){a.setMaster(this.master),this.master.set("name","testing"),expect(a.get("name")).toEqual("testing")}),it("should change id on master change",function(){a.setMaster(this.master),this.master.set("id","id_testing"),expect(a.get("id")).toEqual("id_testing"),expect(a.slides.master_visualization_id).toEqual("id_testing")}),it("should change privacy on master change",function(){a.setMaster(this.master),this.master.set("privacy","PASSWORD"),expect(a.get("privacy")).toEqual("PASSWORD")}),it("should load slides",function(){a=new cdb.admin.Visualization({id:"test",type:"derived",children:[{id:"slide_1"},{id:"slide_2"}]}),expect(a.slides.at(0).id).toEqual("slide_1"),expect(a.slides.at(1).id).toEqual("slide_2")}),it("should not load slides for slide type",function(){a=new cdb.admin.Visualization({type:"slide",children:[{id:"slide_1"},{id:"slide_2"}]}),expect(a.slides.length).toEqual(0)})}),describe("> defaults & config",function(){it("should define a number of ITEMS_PER_PAGE",function(){expect(cdb.admin.Visualizations.prototype._ITEMS_PER_PAGE).toBeDefined()}),it("should define a number of PREVIEW_ITEMS_PER_PAGE",function(){expect(cdb.admin.Visualizations.prototype._PREVIEW_ITEMS_PER_PAGE).toBeDefined()}),it("should setup map bindings by default",function(){expect(a.get("bindMap")).toBeTruthy(),expect(a.map.get("id")).toEqual(b)}),it("shouldn't setup map bindings when bindMap is false",function(){a=new cdb.admin.Visualization({map_id:b,bindMap:!1}),expect(a.get("bindMap")).toBeFalsy(),expect(a.map.get("id")).toEqual(void 0)})}),describe("> related tables",function(){it("should generate related_tables collection if related_tables attribute exists",function(){var a=new cdb.admin.Visualization({map_id:b,active_layer_id:null,name:"test_table",description:"Visualization description",tags:["jamon","probando","test"],privacy:"PUBLIC",updated_at:"2013-03-04T18:09:34+01:00",type:"derived",related_tables:[{id:"hello",table_name:"hello",privacy:"PRIVATE"}]});expect(a.related_tables).toBeDefined(),expect(a.related_tables.size()).toBe(1)}),it("shouldn't generate related_tables collection if visualization is a table type",function(){var a=new cdb.admin.Visualization({map_id:b,active_layer_id:null,name:"test_table",description:"Visualization description",tags:["jamon","probando","test"],privacy:"PUBLIC",updated_at:"2013-03-04T18:09:34+01:00",type:"table",related_tables:[{id:"hello",table_name:"hello",privacy:"PRIVATE"}]});expect(a.related_tables).not.toBeDefined()}),it("should generate related_tables collection if it is required by the user",function(){var a=new cdb.admin.Visualization({map_id:b,active_layer_id:null,name:"test_table",description:"Visualization description",tags:["jamon","probando","test"],privacy:"PUBLIC",updated_at:"2013-03-04T18:09:34+01:00",type:"derived",id:5}),c=sinon.fakeServer.create();a.getRelatedTables(),c.respondWith("/api/v1/viz/5",[200,{"Content-Type":"application/json"},'{ "related_tables": [{ "table_name": "jamon", "privacy": "PRIVATE" }] }']),c.respond(),expect(a.related_tables).toBeDefined(),expect(a.related_tables.size()).toBe(1)}),it("related_tables should be regenrated when a new layer is added and saved",function(){spyOn(a,"getRelatedTables");var b=new cdb.geo.MapLayer;a.map.layers.add(b),expect(a.getRelatedTables).not.toHaveBeenCalled(),b.set("id",1),expect(a.getRelatedTables).toHaveBeenCalledWith(null,{force:!0})}),it("related_tables should be regenrated when a layer is removed",function(){var b=new cdb.geo.MapLayer;a.map.layers.add(b),spyOn(a,"getRelatedTables"),a.map.layers.remove(b),expect(a.getRelatedTables).toHaveBeenCalledWith(null,{force:!0})})}),describe("> map_id",function(){it("should set bindMap to false for all visualizations on parse/fetch",function(){var a=new cdb.admin.Visualizations({type:"derived"}),b=a.parse({total_entries:1,visualizations:[{id:1}]});expect(b[0].bindMap).toBeFalsy()})}),describe("> isVisualization",function(){var b;beforeEach(function(){b=new cdb.admin.CartoDBLayer({table_name:"test_table"}),a.map.layers.reset([new cdb.geo.MapLayer,b])}),it("should return if the model is a visualization or a table",function(){expect(a.isVisualization()).toBeFalsy(),a.set({type:"derived"}),a.map.layers.reset([new cdb.geo.MapLayer]),expect(a.isVisualization()).toBeTruthy()})}),describe("> transform to visualization",function(){var b,c;beforeEach(function(){b=new cdb.admin.CartoDBLayer({table_name:"test_table"}),c={id:69,bounding_box_ne:"[]",bounding_box_sw:"[]",view_bounds_ne:"[]",view_bounds_sw:"[]",center:"[]"},a.map.layers.reset([new cdb.geo.MapLayer,b])}),it("should copy correctly",function(){var b=a.copy();expect(b.get("source_visualization_id")).toEqual(a.id)}),it("should change to",function(){a.changeTo(new cdb.admin.Visualization({map_id:"def-456",id:"abc-123",permission:{foo:"bar"}})),expect(a.map.id).toEqual("def-456"),expect(a.id).toEqual("abc-123"),expect(a.get("permission")).toEqual(jasmine.objectContaining({foo:"bar"}))})}),describe("> name",function(){var b;beforeEach(function(){b=new cdb.admin.CartoDBLayer({table_name:"test_table"}),a.map.layers.reset([new cdb.geo.MapLayer,b])}),it("should fetch cartodb layer if the table name has changed",function(){a.set({type:"table"},{silent:!0});var c=!1;b.fetch=function(a,b,d){c=!0},a.map.layers.each(function(a){a.updateCartoCss=function(){}}),a.set("name","a visualization name"),expect(c).toBeTruthy()}),it("shouldn't set name if it is a visualization",function(){a.map.layers.add(new cdb.admin.CartoDBLayer({table_name:"jam"})),a.set({type:"derived"},{silent:!0}),b.table.sync=function(a,b,c){c.error({},404)},spyOn(b.table,"sync"),a.set("name","another name"),expect(a.map.getLayerAt(1).table.get("name")).not.toBe("another name"),expect(a.map.getLayerAt(2).table.get("name")).not.toBe("another name"),expect(b.table.sync).not.toHaveBeenCalled()})}),describe("> description",function(){var b;beforeEach(function(){b=new cdb.admin.CartoDBLayer({table_name:"test_table"}),a.map.layers.reset([new cdb.geo.MapLayer,b])}),it("shouldn't set description layer name in any case",function(){b.table.set("description","hey description"),a.set({type:"table"},{silent:!0}),b.table.sync=function(a,b,c){c.success({description:"this is a description"},200)},a.set("description","this is a description"),expect(a.map.getLayerAt(1).table.get("description")).not.toBe("this is a description")}),it("shouldn't set table layer description if sync fails",function(){b.table.set("description","Visualization description"),a.set("type","table"),b.table.sync=function(a,b,c){c.error({},404)},a.set("description","this is a description"),expect(a.map.getLayerAt(1).table.get("description")).toBe("Visualization description"),expect(a.get("description")).toBe("this is a description")}),it("shouldn't set itself if there are at least 2 data layers",function(){a.map.layers.add(new cdb.admin.CartoDBLayer({table_name:"test_table"})),a.map.layers.each(function(a){a.table&&a.table.set("description","desc example")}),a.set({type:"derived"},{silent:!0}),b.table.sync=function(a,b,c){c.error({},404)},spyOn(b.table,"sync"),a.set("description","another world"),expect(a.map.getLayerAt(1).table.get("description")).not.toBe("another world"),expect(a.map.getLayerAt(2).table.get("description")).not.toBe("another world"),expect(b.table.sync).not.toHaveBeenCalled()})}),describe("> tags",function(){var b;beforeEach(function(){b=new cdb.admin.CartoDBLayer({table_name:"test_table"}),a.map.layers.reset([new cdb.geo.MapLayer,b])}),it("shouldn't set table layer tags if there is only one data layer <==> table",function(){b.table.set("tags",["zurullo"]),a.set({type:"table"},{silent:!0}),b.table.sync=function(a,b,c){c.success({tags:["zurullo"]},200)},a.set("tags",["zurullo"]),expect(a.map.getLayerAt(1).table.get("tags").length).toBe(1),expect(a.map.getLayerAt(1).table.get("tags")[0]).toBe("zurullo")}),it("shouldn't set table layer tags if sync fails",function(){b.table.set("tags",["eing"]),a.set({type:"table"},{silent:!0}),b.table.sync=function(a,b,c){c.error({},404)},a.set("tags",["esto","va","a","fallar"]),expect(a.map.getLayerAt(1).table.get("tags").length).toBe(1),expect(a.map.getLayerAt(1).table.get("tags").toString()).toBe("eing"),expect(a.get("tags").length).toBe(4),expect(a.get("tags").toString()).toBe("esto,va,a,fallar")}),it("shouldn't set table layers tags if there are at least 2 data layers",function(){a.map.layers.add(new cdb.admin.CartoDBLayer({table_name:"test_table"})),a.map.layers.each(function(a){a.table&&a.table.set("tags",["i","love","this","game"])}),a.set({type:"derived"},{silent:!0}),b.table.sync=function(a,b,c){c.error({},404)},spyOn(b.table,"sync"),a.set("tags",["ciruelo"]),expect(a.map.getLayerAt(1).table.get("tags").length).not.toBe(1),expect(a.map.getLayerAt(2).table.get("tags").length).not.toBe(1),expect(b.table.sync).not.toHaveBeenCalled()})}),describe("> privacy",function(){var b;beforeEach(function(){b=new cdb.admin.CartoDBLayer({table_name:"test_table"}),a.map.layers.reset([new cdb.geo.MapLayer,b])}),it("should fetch cartodb layer if the table PRIVACY has changed",function(){a.set({type:"table"},{silent:!0});var c=!1;b.fetch=function(a,b,d){c=!0},a.map.layers.each(function(a){a.updateCartoCss=function(){}}),a.set("privacy","PRIVATE"),expect(c).toBeTruthy()}),it("shouldn't set table layers privacy if there are at least 2 data layers",function(){a.map.layers.add(new cdb.admin.CartoDBLayer({table_name:"test_table"})),a.map.layers.each(function(a){a.table&&a.table.set("privacy","PUBLIC")}),a.set({type:"derived"},{silent:!0}),b.table.sync=function(a,b,c){c.error({},404)},spyOn(b.table,"sync"),a.set("privacy","PRIVATE"),expect(a.map.getLayerAt(1).table.get("privacy").toLowerCase()).toBe("public"),expect(a.get("privacy").toLowerCase()).toBe("private"),expect(b.table.sync).not.toHaveBeenCalled()})}),describe(".sharedWithEntities",function(){beforeEach(function(){this.sharedWithEntities=function(){return a.sharedWithEntities()}}),describe("given at least shared with one other user",function(){beforeEach(function(){this.sharedWithEntities=this.sharedWithEntities()}),it("should return an array containing the entities the visualization is shared with",function(){expect(this.sharedWithEntities.length).toEqual(1),expect(this.sharedWithEntities[0].get("username")).toEqual("charly")})}),describe("given that model is not shared with anyone",function(){beforeEach(function(){a.permission.acl.reset([],{silent:!0})}),it("should return an empty array",function(){expect(this.sharedWithEntities()).toEqual([])})})}),describe(".tableMetadata",function(){beforeEach(function(){a.set({table:{foo:"bar"}},{silent:!0}),this.tableMetadata=a.tableMetadata()}),it("should return a Table metadata object",function(){expect(this.tableMetadata instanceof cdb.admin.CartoDBTableMetadata).toBeTruthy()}),it("should return a single instance if called several times",function(){expect(this.tableMetadata).toBe(a.tableMetadata())}),it("should created the tableMetadata object with the table attributes",function(){expect(this.tableMetadata.get("foo")).toEqual("bar")})}),describe(".privacyOptions",function(){describe("given a visualization",function(){beforeEach(function(){this.vis=new cdb.admin.Visualization({type:"derived"}),this.privacyOptions=this.vis.privacyOptions()}),it("should return all privacy options",function(){expect(this.privacyOptions.length).toEqual(4),expect(this.privacyOptions).toContain("PUBLIC"),expect(this.privacyOptions).toContain("PRIVATE"),expect(this.privacyOptions).toContain("LINK"),expect(this.privacyOptions).toContain("PASSWORD")})}),describe("given a table",function(){beforeEach(function(){this.vis=new cdb.admin.Visualization({type:"table"}),this.privacyOptions=this.vis.privacyOptions()}),it("should return all privacy options but the password",function(){expect(this.privacyOptions.length).toEqual(3),expect(this.privacyOptions).toContain("PUBLIC"),expect(this.privacyOptions).toContain("PRIVATE"),expect(this.privacyOptions).toContain("LINK"),expect(this.privacyOptions).not.toContain("PASSWORD")})})}),describe(".isOwnedByUser",function(){describe("when owned by given user",function(){beforeEach(function(){this.user=new cdb.admin.User({}),spyOn(this.user,"equals").and.returnValue(!0),this.results=a.isOwnedByUser(this.user)}),it("should return true",function(){expect(this.results).toBeTruthy()}),it("should check equality from given permission owner",function(){expect(this.user.equals).toHaveBeenCalledWith(a.permission.owner)})}),describe("when owned by someone else",function(){beforeEach(function(){this.user=new cdb.admin.User({}),spyOn(this.user,"equals").and.returnValue(!1),this.results=a.isOwnedByUser(this.user)}),it("should return false",function(){expect(this.results).toBeFalsy()})})}),describe(".viewUrl",function(){describe("when vis is a dataset",function(){beforeEach(function(){a.set("type","table")}),it("should return a new dataset URL",function(){expect(a.viewUrl().toString()).toEqual("http://team.carto.com/u/rambo/tables/rambo.test_table")}),describe("when given a current user",function(){it("should return the URL from perspective of owner",function(){expect(a.viewUrl(a.permission.owner).toString()).toEqual("http://team.carto.com/u/rambo/tables/rambo.test_table")}),it("should return the URL from the perspective of shared user",function(){var b=a.permission.acl.first().get("entity");expect(a.viewUrl(b).toString()).toEqual("http://team.carto.com/u/charly/tables/rambo.test_table")}),it("should return the URL from the perspective of owner if do not have read access",function(){var b=new cdb.admin.User({id:123,base_url:"http://team.carto.com/u/current-user",username:"current-user"});expect(a.viewUrl(b).toString()).toEqual("http://team.carto.com/u/rambo/tables/rambo.test_table")})})}),describe("when vis is a map",function(){beforeEach(function(){a.set("type","derived"),a.set("id","abc-123")}),it("should return a new map URL",function(){expect(a.viewUrl().toString()).toEqual("http://team.carto.com/u/rambo/viz/abc-123")}),describe("when the type is not available",function(){it("should assume it's a map and thus return a new map URL",function(){a.set("type",void 0),expect(a.viewUrl().toString()).toEqual("http://team.carto.com/u/rambo/viz/abc-123")})}),describe("when given a other current user (e.g. a shared map)",function(){beforeEach(function(){this.userSharingVis=a.permission.acl.first().get("entity"),this.userSharingVis.id="123"}),it("should return the URL from the perspective of the current user",function(){expect(a.viewUrl(this.userSharingVis).toString()).toEqual("http://team.carto.com/u/charly/viz/rambo.abc-123")})})})})}),describe("cdb.admin.FormSchema",function(){var a,b;beforeEach(function(){b=TestUtil.createTable("test")}),it("should use default values",function(){a=new cdb.admin.FormSchema({table:b,type:"bubble"}),expect(a.get("Bubble fill").form).toEqual({"marker-fill":{type:"color",value:"#FF5C00"},"marker-opacity":{type:"opacity",value:.9}})}),it("should change column fields when table schema changes",function(){a=new cdb.admin.FormSchema({table:b,type:"bubble"}),expect(a.get("Column").form.property.extra).toEqual(["test"]);var c;a.bind("change",function(){c=_.clone(a.changed)}),b.set("schema",[["test","number"],["test3","number"],["test2","string"]]),expect(a.get("Column").form.property.extra).toEqual(["test","test3"]),expect(a.get("Column").form.property.value).toEqual("test"),expect(c.Column).not.toEqual(void 0),expect(_.keys(c).length).toEqual(1)}),it("should not include cartodb_id columns",function(){b.set("schema",[["cartodb_id","number"],["test","number"],["test3","number"],["test2","string"]]),a=new cdb.admin.FormSchema({table:b,type:"bubble"}),expect(a.get("Column").form.property.extra).toEqual(["test","test3"])}),describe("column_numeric_date_with_cartodb_id",function(){it("should include the 'cartodb_id' column and set it as value if no custom date column is present",function(){var c=[["number","number"],["created_at","date"],["updated_at","date"]];b=TestUtil.createTable("test",c,["ST_Point"]),a=new cdb.admin.FormSchema({table:b,type:"torque"}),expect(a.get("Time Column").form.property.extra).toEqual(["cartodb_id","number","created_at","updated_at"]),expect(a.get("Time Column").form.property.value).toEqual("cartodb_id")}),it("should use the first custom date column as value instead of 'cartodb_id'",function(){var c=[["number","number"],["date_column","date"],["created_at","date"],["updated_at","date"]];b=TestUtil.createTable("test",c,["ST_Point"]),a=new cdb.admin.FormSchema({table:b,type:"torque"}),expect(a.get("Time Column").form.property.extra).toEqual(["cartodb_id","number","date_column","created_at","updated_at"]),expect(a.get("Time Column").form.property.value).toEqual("date_column")})}),it("should validate",function(){a=new cdb.admin.FormSchema({table:b,type:"polygon"}),expect(a.isValid("polygon")).toEqual(!0),a=new cdb.admin.FormSchema({table:b,type:"bubble"}),b.set("schema",[["test2","string"]]),expect(a.isValid("bubble")).toEqual(!1),b.set("schema",[["test","number"],["test3","number"],["test2","string"]]),expect(a.isValid("bubble")).toEqual(!0)})}),describe("cdb.admin.WizardProperties",function(){var a,b,c;beforeEach(function(){b=TestUtil.createTable("test"),c=new cdb.admin.CartoDBLayer,a=new cdb.admin.WizardProperties({table:b,layer:c,type:"polygon"}),c.sync=function(){}}),it("active",function(){a.set("marker-fill","test"),a.active("polygon",{test:"rambo"}),expect(a.get("polygon-fill")).toEqual("#FF6600"),expect(a.get("type")).toEqual("polygon"),expect(a.get("test")).toEqual("rambo"),expect(a.get("marker-fill")).toEqual("test")}),it("getEnabledWizards",function(){expect(a.getEnabledWizards()).toEqual(["polygon","choropleth","category","bubble"])}),it("formData should fill text-name",function(){var c=a.formData("polygon"),d=c[3].form["text-name"];expect(d.value).toEqual("None"),expect(d.extra).toEqual(["None"].concat(b.columnNamesByType("string")).concat(b.columnNamesByType("number")))}),it("layer change query styles should be regenerated",function(){spyOn(a.cartoStylesGeneration,"regenerate"),spyOn(c.wizard_properties.cartoStylesGeneration,"regenerate"),c.set("query","select * from asdasd"),expect(a.cartoStylesGeneration.regenerate).toHaveBeenCalled()}),it("activate should force regeneration",function(){var b=0;a.cartoStylesGeneration.bind("change:style",function(){++b}),a.active("polygon"),a.active("polygon"),a.active("polygon"),expect(b).toEqual(3)}),it("when properties are changed styles should be regenerated",function(b){c.set("tile_style","test");var d=c.get("tile_style");a.set("marker-fill","#FFF"),setTimeout(function(){expect(c.get("tile_style")).not.toEqual(d),b()},200)}),it("should not be activated when is not valid",function(){b.set({schema:[["test","string"]]});var c=!1;a.cartoStylesGeneration.bind("change:properties",function(){c=!0}),a.active("bubble"),expect(c).toEqual(!1)}),it("should regenate style on table schema changes",function(){spyOn(a.cartoStylesGeneration,"regenerate"),b.set({schema:[["test","number"]]}),expect(a.cartoStylesGeneration.regenerate).toHaveBeenCalled()}),it("should not regenerate when style is custom",function(){c.set("tile_style_custom",!0),spyOn(a.cartoStylesGeneration,"regenerate"),c.set("query","select * from asdasd"),expect(a.cartoStylesGeneration.regenerate).not.toHaveBeenCalled(),b.set("schema",[["test","number"],["test3","number"],["test2","string"]]),expect(a.cartoStylesGeneration.regenerate).not.toHaveBeenCalled()}),it("should set tile_style_custom to true when on activate",function(b){c.set("tile_style_custom",!0),a.active("polygon",{test:"rambo"}),setTimeout(function(){expect(c.get("tile_style_custom")).toBe(!1),b()},100)}),it("should trigger change:form when current form changes",function(){var c=0;a.bind("change:form",function(){++c}),b.set("schema",[["rambo_is_the_best","number"]]),expect(c).toEqual(1),a.active("bubble"),b.set("schema",[["test","number"],["test3","number"],["john","string"]]),expect(c).toEqual(2),a.active("choropleth"),b.set("schema",[["test4","number"]]),expect(c).toEqual(3)}),it("should reset styles when geometry type changes",function(){a.active("bubble"),b.set("geometry_types",["st_polygon"]),expect(a.get("type")).toEqual("bubble"),b.set("geometry_types",["st_point"]),expect(a.get("type")).toEqual("polygon"),a.active("bubble"),b.set("geometry_types",["st_polygon"]),expect(a.get("type")).toEqual("polygon"),a.set("test",1),b.set("geometry_types",["st_point"]),expect(a.get("type")).toEqual("polygon"),expect(a.get("test")).toEqual(void 0)}),it("should reset to polygon on type changes if the previous does not exist",function(){b.set("geometry_types",["st_point"]),a.active("intensity"),b.set("geometry_types",["st_linestring"]),expect(a.get("type")).toEqual("polygon")}),it("should not reset styles when table has no geo types",function(){a.active("bubble"),b.isInSQLView=function(){return!0},b.set("geometry_types",[]),expect(a.get("type")).toEqual("bubble")}),it("should change layer type",function(d){b.set("geometry_types",["st_point"]),a.active("torque"),setTimeout(function(){expect(c.get("type")).toEqual("torque"),setTimeout(function(){a.active("polygon"),setTimeout(function(){expect(c.get("type")).toEqual("CartoDB"),d()},100)},100)},100)}),it("should change sql",function(){a.cartoStylesGeneration.change(),a.cartoStylesGeneration.set({sql:"select * from __wrapped",style:"test"}),expect(c.get("query_wrapper")).toEqual("select * from (<%= sql %>)"),expect(c.get("query_generated")).toEqual(!0)}),it("should change medatata",function(b){a.cartoStylesGeneration.set({metadata:{test:"test"},sql:"select * from __wrapped",style:"test"}),setTimeout(function(){expect(a.get("metadata")).toEqual({test:"test"}),b()},100)}),it("should not regenerate on start",function(){b.unset("schema"),spyOn(a.cartoStylesGeneration,"regenerate"),b.set("schema",[["test4","number"]]),expect(a.cartoStylesGeneration.regenerate).not.toHaveBeenCalled()}),it("should save previous state on change",function(){a.active("polygon",{test:"rambo"}),a.set("test2","test"),a.active("bubble"),expect(a.get("test2")).toEqual(void 0),a.active("polygon"),expect(a.get("test2")).toEqual("test")}),it("should not save state when type is the same",function(){a.active("polygon",{test:"rambo"}),a.active("polygon"),expect(a.get("test")).toEqual("rambo"),a.active("polygon"),expect(a.get("test")).toEqual("rambo")}),it("should not serialize metadata",function(){a.set("medatata","test"),expect("metadata"in c.toJSON().options.wizard_properties.properties).toEqual(!1)}),describe("propertiesFromStyle",function(){it("should return new properties based on cartocss",function(){a.set("polygon-pattern-file","url(https://rambo)"),expect(a.get("polygon-fill")).toEqual(void 0);var b=a.propertiesFromStyle("#layer { polygon-fill: #FFF; line-width: 0.1; marker-fill: red; polygon-pattern-file: url(https://s3.amazonaws.com/com.cartodb.users-assets.production/production/matallo/assets/20130808152815bullet.png);\n}");expect(b).toEqual({"polygon-fill":"#ffffff","line-width":.1,"polygon-pattern-file":"url(https://s3.amazonaws.com/com.cartodb.users-assets.production/production/matallo/assets/20130808152815bullet.png)"})}),it("should return not change values when style is wrong",function(){var b=a.propertiesFromStyle('#layer { polygon-fill: "rambo"; line-width: 0.1; marker-fill: red;}');expect(b).toEqual({})})}),describe("when column is removed",function(){var c,d=!1,e=0,f=1;beforeEach(function(g){c=[],a.bind("change:type",function(){c.push(e)}),a.bind("change:form",function(){c.push(f),g()}),a.cartoStylesGeneration.bind("change:properties",function(){d=!0}),a.active("bubble"),b.set({schema:[["test2","string"]]})}),it("should active polygon ",function(){expect(a.get("type")).toEqual("polygon")}),it("should have called change:properties",function(){expect(d).toBeTruthy()}),it("should have called change:type and change:form in that order",function(){expect(c).toEqual([e,e,f])})}),it("should rename column",function(){b.set({schema:[["test","number"],["test2","string"]]});var d=!1;a.cartoStylesGeneration.bind("change:properties",function(){d=!0}),a.active("bubble"),b.trigger("columnRename","test_abc","test"),expect(a.get("property")).toEqual("test_abc"),expect(d).toEqual(!0),c.set("tile_style_custom",!0),b.trigger("columnRename","test3","test_abc"),expect(a.get("property")).toEqual("test_abc")}),it("should fill form values with correct values",function(){c=new cdb.admin.CartoDBLayer,c.sync=function(){},c.table.set("geometry_types",["st_polygon"]),expect(c.wizard_properties.get("marker-width")).toEqual(void 0)}),it("should save correct values",function(){c.table.set("geometry_types",["st_point"]),c.table.set("geometry_types",["st_polygon"]),c.wizard_properties.active("polygon");var a=c.wizard_properties.get("marker-fill");expect(a).toEqual(void 0)}),it("should not active wizard when there is no geometry type",function(){c.table.set("geometry_types",["st_point"]),c.wizard_properties.active("polygon"),c.table.isInSQLView=function(){return!0},c.table.set("geometry_types",[]),c.wizard_properties.active("bubble"),expect(c.wizard_properties.get("type")).toEqual("polygon")}),it("should apply a wizard with it becomes valid",function(){var a=0;c.table.set("geometry_types",["st_point"]),c.table.set({schema:[["test","string"]]}),c.wizard_properties.cartoStylesGeneration.bind("change",function(){++a}),c.wizard_properties.active("polygon"),expect(a).toEqual(1),c.wizard_properties.active("bubble"),expect(a).toEqual(1),c.table.set({schema:[["test","number"]]}),expect(a).toEqual(2),expect(c.wizard_properties.get("property")).toEqual("test"),c.table.set({schema:[["test2","number"],["test","number"]]}),expect(c.wizard_properties.get("property")).toEqual("test")}),it("should force parameter override when geometry does not match",function(){c.table.set("geometry_types",["st_point"]),c.wizard_properties.active("polygon"),c.table.set("geometry_types",["st_polygon"],{silent:!0}),c.wizard_properties.active("polygon"),expect(c.wizard_properties.get("marker-width")).toEqual(void 0),expect(c.wizard_properties.get("polygon-fill")).not.toEqual(void 0)}),it("should raise a change:form when geometry_type changes",function(){var a=0;c.wizard_properties.bind("change:form",function(){++a}),c.table.set("geometry_types",[]),expect(a).toEqual(1),c.table.set("geometry_types",["st_point"]),expect(a).toEqual(2)}),it("should not override previos wizard style",function(){c=new cdb.admin.CartoDBLayer,c.sync=function(){};var a=0;c.wizard_properties.cartoStylesGeneration.bind("change",function(){++a}),c.set({tile_style_custom:!1,tile_style:"test"}),c.wizard_properties.properties({type:"choropleth",geometry_type:"st_point",properties:{property:"vel",method:"7 Buckets",qfunction:"Quantile",color_ramp:"red","marker-opacity":.8,"marker-width":12,"marker-allow-overlap":!0,"marker-placement":"point","marker-type":"ellipse","marker-line-width":2,"marker-line-color":"#FFF","marker-line-opacity":1,"marker-comp-op":"none",zoom:18}}),expect(a).toEqual(0);var b=[["cartodb_id","number"],["the_geom","geometry","geometry","point"],["ax","string"],["ay","string"],["az","string"],["dir","string"],["field_12","string"],["lat","string"],["lon","string"],["pitch","string"],["roll","string"],["time","number"],["vel","number"],["yaw","string"],["created_at","date"],["updated_at","date"]];c.table.set({name:"sensor_log_2013_10_27_12_01",privacy:"PUBLIC",schema:b,updated_at:"2013-11-04T10:19:39+01:00",rows_counted:13079,table_size:2584576,map_id:29086,description:null,geometry_types:["ST_Point"]}),expect(a).toEqual(0);var d=_.clone(b);d.push(["testest","number"]),c.table.set("schema",d),expect(a).toEqual(0)}),it("should update properties when a column being used is removed ",function(){c.table.set("geometry_types",["st_point"]),
c.table.set({schema:[["c0","number"],["c1","number"],["c2","number"]]}),c.wizard_properties.active("bubble"),c.wizard_properties.set("property","c1"),c.table.set({schema:[["c0","number"],["c2","number"]]}),expect(c.wizard_properties.get("property")).toEqual("c0")}),it("should not use saved data when is restored",function(){c.table.set("geometry_types",["st_point"]),c.table.set({schema:[["test","string"],["test2","number"]]}),c.wizard_properties.active("bubble"),c.table.set({schema:[["test","string"]]}),expect(c.wizard_properties.get("type")).toEqual("polygon"),c.wizard_properties.active("bubble"),c.table.set({schema:[["test","string"],["test3","number"]]}),expect(c.wizard_properties.get("type")).toEqual("bubble"),expect(c.wizard_properties.get("property")).toEqual("test3")}),it("should update forms even if they are not active",function(){c.table.set("geometry_types",["st_point"]),c.table.set({schema:[["test","string"]]}),c.wizard_properties.active("polygon"),c.wizard_properties.active("bubble"),c.wizard_properties.get("property",void 0),c.wizard_properties.active("polygon"),c.table.set({schema:[["test","string"],["test2","number"]]}),c.wizard_properties.active("bubble"),expect(c.wizard_properties.get("property")).toEqual("test2")}),it("should not save layer if it's new",function(){c.unset("id"),spyOn(c,"save"),c.wizard_properties.cartoStylesGeneration.set("style","testing"),expect(c.save).not.toHaveBeenCalled()}),it("should regenerate wizard when the geometry is empty",function(){c.table.set("geometry_types",["st_point"]),c.wizard_properties.active("polygon"),c.table.set("geometry_types",[]),expect(c.wizard_properties.get("type")).toEqual(void 0)})}),describe("cdb.admin.WMSService ",function(){describe(".url",function(){it("should add necessary params",function(){var a="http://myURL",b=new cdb.admin.WMSService({wms_url:a}),c=b.url("create");expect(c.indexOf(encodeURIComponent("request=GetCapabilities"))).toBeGreaterThan(0),expect(c.indexOf(encodeURIComponent("service=WMS"))).toBeGreaterThan(0),expect(c.indexOf("type=wms")).toBeGreaterThan(0)}),it("shouldn't remove extra params in the URL",function(){var a="http://myURL?request=GetCapabilities&service=WMS&type=wms&FORMAT=image/png24",b=new cdb.admin.WMSService({wms_url:a}),c=b.url("create");expect(c.indexOf(encodeURIComponent("FORMAT=image/png24"))).toBeGreaterThan(0),expect(c.indexOf(encodeURIComponent("service=WMS"))).toBeGreaterThan(0)}),it("should set the supported matrix sets to create a WMTS resource",function(){var a="http://myURL",b=new cdb.admin.WMSService({wms_url:a,matrix_sets:["EPSG:4326"],type:"wmts",layer:"foobar_layer"}),c=b.url("create");expect(c).toContain("&layer=foobar_layer&"),expect(c).toContain("&matrix_set=EPSG:4326")})}),describe(".newTileLayer",function(){beforeEach(function(){this.model=new cdb.admin.WMSService({})}),it("should throw an error unless mapproxy id is present",function(){expect(function(){this.model.newTileLayer()}).toThrowError()}),describe("when mapproxy id is present",function(){beforeEach(function(){this.model.set({mapproxy_id:"abc123",attribution:"attribution",name:"tilelayer test",bounding_boxes:[1,2,3,4]}),this.tileLayer=this.model.newTileLayer()}),it("should return a tilelayer object",function(){expect(this.tileLayer).toEqual(jasmine.any(cdb.admin.TileLayer))}),it("should should have expected attrs on returned object",function(){expect(this.tileLayer.get("urlTemplate")).toMatch("/abc123/wmts/"),expect(this.tileLayer.get("attribution")).toEqual("attribution"),expect(this.tileLayer.get("maxZoom")).toEqual(21),expect(this.tileLayer.get("minZoom")).toEqual(0),expect(this.tileLayer.get("name")).toEqual("tilelayer test"),expect(this.tileLayer.get("proxy")).toBeTruthy(),expect(this.tileLayer.get("bounding_boxes")).toEqual([1,2,3,4])})})}),describe("::supportedMatrixSets",function(){it("should return a subset of the supported matrix sets (used for a WMTS result)",function(){expect(cdb.admin.WMSService.supportedMatrixSets(["foo","bar","EPSG:4258","baz","EPSG:4326"])).toEqual(["EPSG:4258","EPSG:4326"])}),it("should return empty results for empty or missing input",function(){expect(cdb.admin.WMSService.supportedMatrixSets()).toEqual([]),expect(cdb.admin.WMSService.supportedMatrixSets([])).toEqual([])})})}),describe("Boolean field",function(){var a;beforeEach(function(){a=new cdb.admin.BooleanField({model:new cdb.core.Model({attribute:"boolean",value:null})})}),it("should render three radio buttons and one selected",function(){a.render(),expect(3==a.$el.find("a.radiobutton").size()).toBeTruthy(),expect(a.$el.find("a.radiobutton.null").hasClass("selected")).toBeTruthy()}),it("should render a readonly input and don't trigger any event",function(){a.options.readOnly=!0,a.render();var b=a.$el.find("a.radiobutton.true");spyOn(a,"_onChange"),b.trigger(jQuery.Event("click")),expect(a._onChange).not.toHaveBeenCalled(),expect(3==a.$el.find("a.radiobutton.disabled").size()).toBeTruthy()}),it("should be valid selecting other value",function(){a.render();var b=a.$el.find("a.radiobutton.true"),c=a.$el.find("a.radiobutton.null");b.trigger(jQuery.Event("click")),expect(a.isValid()).toBeTruthy(),expect(b.hasClass("selected")).toBeTruthy(),expect(c.hasClass("selected")).toBeFalsy(),expect(a.model.get("value")).toBe("true")})}),describe("ColorPicker",function(){var a,b;beforeEach(function(){b=$("<a>"),a=new cdb.admin.ColorPicker({target:b,imagePicker:!1,kind:"marker"})}),afterEach(function(){a.clean()}),it("should render properly",function(){a.render(),expect(a.$("a.advanced").length).toBe(1),expect(a.$("ul.default-colors > li").length).toBe(30),expect(a.$(".image_picker a").is(":visible")).toBeFalsy()}),it("should show advanced picker",function(){a.render(),spyOn(a,"positionate"),a.$("a.advanced").click(),expect(a.positionate).toHaveBeenCalled(),expect(a.$(".top").hasClass("advanced")).toBeTruthy()}),it("should trigger color when submit form",function(){a.render();var b=!1;a.bind("colorChosen",function(){b=!0}),a.$("input.text").val("white"),a.$("form").submit(),expect(b).toBeTruthy(),b=!1,a.$("input.text").val("what?"),a.$("form").submit(),expect(b).toBeFalsy()}),it("should change color when is selected from the list",function(){a.render();var b=!1;a.bind("colorChosen",function(){b=!0});var c=a.$("input.text").val();a.$("ul li:eq(3) a").click(),expect(a.$("input.text").val()).toBe(c),expect(b).toBeTruthy()}),it("should render again when colors or extra_colors attributes have changed",function(){a.render(),spyOn(a,"render"),a.setColors("colors",[]),expect(a.$("ul.default-colors li").length).toBe(0),a.setColors("visible",!1),expect(a.render).not.toHaveBeenCalled()})}),describe("Date field",function(){var a;beforeEach(function(){a=new cdb.admin.DateField({model:new cdb.core.Model({attribute:"date",value:"2012-12-12T10:10:10+02:00"})})}),it("should render one combo, two spinners and one input with their correct values applied",function(){a.render(),expect(a.$el.find("input.time").size()).toBe(1),expect(a.$el.find("input.time").val()).toBe("10:10:10"),expect(a.$el.find(".form_spinner").size()).toBe(2),expect(a.$el.find(".form_spinner.day input").val()).toBe("12"),expect(a.$el.find(".form_spinner.year input").val()).toBe("2012"),expect(a.$el.find(".form_combo .select2-container").size()).toBe(1),expect(a.$el.find(".form_combo .select2-container .select2-choice span").text()).toBe("December")}),it("should create a valid internal date model",function(){a.render(),expect(a.date_model.get("year")).toBe(2012),expect(a.date_model.get("month")).toBe(12),expect(a.date_model.get("day")).toBe(12),expect(a.date_model.get("time")).toBe("10:10:10")}),it("should render a readonly form and don't trigger any event",function(){a.options.readOnly=!0,a.render();var b=a.$el.find("input.time"),c=a.$el.find(".form_spinner.day input"),d=a.$el.find(".select2-choice");spyOn(a,"_onKeyUp"),spyOn(a,"_onChangeModel"),b.trigger(jQuery.Event("keyup",{keyCode:21})),d.trigger(jQuery.Event("click")),c.val("20"),expect(a._onChangeModel).not.toHaveBeenCalled(),expect(a._onKeyUp).not.toHaveBeenCalled(),expect(b.attr("readonly")).toBeTruthy(),expect(a.date_model.get("day")).toBe(12)}),it("should be invalid adding a string in the time input",function(){a.render();var b=a.$el.find("input.time");b.val("testing"),b.trigger(jQuery.Event("keyup",{keyCode:11})),expect(a.isValid()).toBeFalsy(),expect(b.hasClass("error")).toBeTruthy(),expect(a.date_model.get("time")).toBe("10:10:10")}),it("should store a valid time",function(){a.render();var b=a.$el.find("input.time");b.val("02:02:02"),b.trigger(jQuery.Event("keyup",{keyCode:11})),expect(a.isValid()).toBeTruthy(),expect(b.hasClass("error")).toBeFalsy(),expect(a.date_model.get("time")).toBe("02:02:02"),expect(a.model.get("value")).toBe("2012-12-12T02:02:02+02:00")}),it("should return a 00:00 timezone if none is provided",function(){var a=new cdb.admin.DateField({model:new cdb.core.Model({attribute:"date",value:"2012-12-12T10:10:10"})});a.render();var b=a.$el.find("input.time");b.val("10:04:12"),b.trigger(jQuery.Event("keyup",{keyCode:11})),expect(a.model.get("value")).toBe("2012-12-12T10:04:12+00:00")}),it("should return the same timezone as provided",function(){var a=new cdb.admin.DateField({model:new cdb.core.Model({attribute:"date",value:"2012-12-12T10:10:10+03:00"})});a.render();var b=a.$el.find("input.time");b.val("10:04:12"),b.trigger(jQuery.Event("keyup",{keyCode:11})),expect(a.model.get("value")).toBe("2012-12-12T10:04:12+03:00")}),it("should trigger event if ENTER is pressed",function(){a.render();var b=a.$el.find("input.time");spyOn(a,"_triggerEvent"),b.trigger(jQuery.Event("keyup",{keyCode:13})),expect(a._triggerEvent).toHaveBeenCalled()})}),describe("cdb.admin.EditInPlace",function(){var a,b;beforeEach(function(){b=new cdb.core.Model({name:"hi"}),$("body").append('<div class="field" />'),a=new cdb.admin.EditInPlace({observe:"name",model:b,el:$("body .field")})}),afterEach(function(){a.clean(),$(".field").remove(),$(".disabled_field").remove()}),it("should render the field",function(){expect(a.$el.find(".value span").text()).toEqual("hi")}),it("should start in view mode",function(){expect(a.config.get("mode")).toEqual("view")}),it("should observe the field selected by the user",function(){expect(a._observedField).toEqual("name")}),it("should enter the edit mode on click",function(){a.$el.find(".value").click(),expect(a.config.get("mode")).toEqual("edit")}),it("should go back to view mode on blur",function(){a.config.set("mode","edit"),a.$input.blur(),expect(a.config.get("mode")).toEqual("view")}),it("should store the value on blur",function(){a.config.set("mode","edit"),a.$input.val("Rambo"),a.$input.blur(),expect(a.config.get("mode")).toEqual("view"),expect(b.get("name")).toEqual("Rambo")}),it("should go back to view mode on keyup Esc and not store the value",function(){a.config.set("mode","edit"),a.$input.val("Rambo");var c=$.Event("keyup");c.keyCode=27,a.$input.trigger(c),expect(a.config.get("mode")).toEqual("view"),expect(b.get("name")).toEqual("hi")}),it("should store the entered text on Enter",function(){a.config.set("mode","edit"),a.$input.val("Rambo");var c=$.Event("keyup");c.keyCode=13,a.$input.trigger(c),expect(a.config.get("mode")).toEqual("view"),expect(b.get("name")).toEqual("Rambo")}),it("should update the values when the model is changed",function(){b.set("name","Rambo"),expect(a.$input.text()).toEqual("Rambo"),expect(a.$el.find(".value span").text()).toEqual("Rambo"),b.set("name",""),expect(a.$input.text()).toEqual(""),expect(a.$el.find(".value span").text()).toEqual("empty"),expect(a.$el.find(".value").hasClass("empty")).toBeTruthy()}),it("shouldn't strip the HTML tags by default",function(){var c="<strong>Rambo</strong>";b.set("name",c),expect(a.$input.text()).toEqual(c),expect(a.$el.find(".value span").html()).toEqual(c)}),it("should allow to define the max-width",function(){$("body .field").empty(),widget=new cdb.admin.EditInPlace({observe:"name",stripHTML:!0,model:b,maxWidth:50,el:$("body .field")});var a="<strong>Rambo</strong>";b.set("name",a),expect(widget.$input.text()).toEqual("Rambo"),expect(widget.$el.find("span").css("max-width")).toEqual("50px")}),it("should strip the HTML tags",function(){$("body .field").empty(),widget=new cdb.admin.EditInPlace({observe:"name",stripHTML:!0,model:b,el:$("body .field")});var a="<strong>Rambo</strong>";b.set("name",a),expect(widget.$input.text()).toEqual("Rambo"),expect(widget.$el.find(".value span").html()).toEqual("Rambo")}),it("should show an empty message when there's no text",function(){a.$input.val("");var c=$.Event("keyup");c.keyCode=13,a.$input.trigger(c),expect(b.get("name")).toEqual(""),expect(a.$el.find(".value span").text()).toEqual("empty")}),it("shouldn't enter the edit mode on click when view is diabled",function(){var a=new cdb.core.Model({name:"hi"});$("body").append('<div class="disabled_field" />');var b=new cdb.admin.EditInPlace({observe:"name",disabled:!0,model:a,el:$("body .disabled_field")});b.$el.find(".value").click(),expect(b.config.get("mode")).toEqual("view")}),it("should add a disabled class when view is diabled",function(){var a=new cdb.core.Model({name:"hi"});$("body").append('<div class="disabled_field" />');var b=new cdb.admin.EditInPlace({observe:"name",disabled:!0,model:a,el:$("body .disabled_field")});expect(b.$el.hasClass("disabled")).toBeTruthy()})}),describe("Geometry field",function(){var a;beforeEach(function(){a=new cdb.admin.GeometryField({row:new cdb.admin.Row({cartodb_id:"1",c1:"jamon",c2:10,c3:!1,c4:"2012-10-10T10:10:10+02:00",the_geom:'{ "type": "Point", "coordinates": [100.0, 0.0] }'}),model:new cdb.core.Model({attribute:"goemetry",value:'{ "type": "Point", "coordinates": [100.0, 0.0] }'})})}),it("should render a selector, two inputs and a textarea, applying the correct values",function(){a.render(),expect(a.$el.find("input").size()).toBe(2),expect(a.$el.find("input.longitude").val()).toBe("100"),expect(a.$el.find("input.latitude").val()).toBe("0"),expect(a.$el.find("textarea").size()).toBe(1),expect(a.$el.find("textarea").val()).toBe('{"type":"Point","coordinates":[100,0]}'),expect(a.$el.find(".selector").size()).toBe(1),expect(a.$el.find(".selector .switch").hasClass("enabled")).toBeFalsy()}),it("should render a readonly textarea and don't trigger any event",function(){a.options.readOnly=!0,a.render();var b=a.$("textarea");spyOn(a,"_onKeyTextareaDown"),b.trigger(jQuery.Event("keydown",{keyCode:21})),expect(a._onKeyTextareaDown).not.toHaveBeenCalled(),expect(b.attr("readonly")).toBeTruthy(),expect(a.model.get("value")).toBe('{ "type": "Point", "coordinates": [100.0, 0.0] }')}),it("should be invalid adding a string in the longitude input",function(){a.render();var b=a.$("input.longitude");b.val("testing"),b.trigger(jQuery.Event("keyup",{keyCode:11})),expect(a.isValid()).toBeFalsy(),expect(b.hasClass("error")).toBeTruthy(),expect(a.model.get("value")).toBe('{ "type": "Point", "coordinates": [100.0, 0.0] }')}),it("should be invalid adding a longitude value bigger than 90 or fewer than -90",function(){a.render();var b=a.$("input.latitude");b.val(92),b.trigger(jQuery.Event("keyup",{keyCode:11})),expect(a.isValid()).toBeFalsy(),expect(b.hasClass("error")).toBeTruthy(),expect(a.model.get("value")).toBe('{ "type": "Point", "coordinates": [100.0, 0.0] }'),b.val(-91),b.trigger(jQuery.Event("keyup",{keyCode:11})),expect(a.isValid()).toBeFalsy(),expect(b.hasClass("error")).toBeTruthy(),expect(a.model.get("value")).toBe('{ "type": "Point", "coordinates": [100.0, 0.0] }')}),it("should be invalid adding a longitude value bigger than 180 or fewer than -180",function(){a.render();var b=a.$("input.longitude");b.val(181),b.trigger(jQuery.Event("keyup",{keyCode:11})),expect(a.isValid()).toBeFalsy(),expect(b.hasClass("error")).toBeTruthy(),expect(a.model.get("value")).toBe('{ "type": "Point", "coordinates": [100.0, 0.0] }'),b.val(-181),b.trigger(jQuery.Event("keyup",{keyCode:11})),expect(a.isValid()).toBeFalsy(),expect(b.hasClass("error")).toBeTruthy(),expect(a.model.get("value")).toBe('{ "type": "Point", "coordinates": [100.0, 0.0] }')}),it("should be invalid adding a string in the latitude input",function(){a.render();var b=a.$("input.latitude");b.val("testing"),b.trigger(jQuery.Event("keyup",{keyCode:11})),expect(a.isValid()).toBeFalsy(),expect(b.hasClass("error")).toBeTruthy(),expect(a.model.get("value")).toBe('{ "type": "Point", "coordinates": [100.0, 0.0] }')}),it("should be valid adding a string in the longitude input but changing to geometry free editor",function(){a.render();var b=a.$("input.longitude");b.val("testing"),b.trigger(jQuery.Event("keyup",{keyCode:11})),expect(a.isValid()).toBeFalsy(),a.$("a.switch").click(),expect(a.isValid()).toBeTruthy();var c=a.$("textarea");c.val('{ "type": "Point", "coordinates": [100.0, 0.10] }').trigger(jQuery.Event("keydown",{keyCode:11})),expect(a.model.get("value")).toBe('{ "type": "Point", "coordinates": [100.0, 0.10] }')}),it("should be valid adding a correct latitude and longitude",function(){a.render();var b=a.$("input.latitude");b.val("10.3"),b.trigger(jQuery.Event("keyup",{keyCode:11})),expect(a.isValid()).toBeTruthy(),expect(b.hasClass("error")).toBeFalsy(),expect(a.model.get("value")).toBe('{"type":"Point","coordinates":[100,10.3]}')}),it("should trigger event if ENTER is pressed",function(){a.render();var b=a.$("input.longitude");spyOn(a,"_triggerEvent"),b.trigger(jQuery.Event("keyup",{keyCode:13})),expect(a._triggerEvent).toHaveBeenCalled()}),it("should trigger event if ENTER + CMD || ENTER + Ctrl is pressed",function(){a.render();var b=a.$("textarea");spyOn(a,"_triggerEvent"),b.trigger(jQuery.Event("keydown",{metaKey:!0,ctrlKey:!0,keyCode:13})),expect(a._triggerEvent).toHaveBeenCalled()})}),describe("Number field",function(){var a;beforeEach(function(){a=new cdb.admin.NumberField({model:new cdb.core.Model({attribute:"number",value:6})})}),it("should render an input",function(){a.render(),expect(a.$el.find("input").size()).toBe(1),expect(a.$el.find("input").val()).toBe("6")}),it("should render a readonly input and don't trigger any event",function(){a.options.readOnly=!0,a.render();var b=a.$el.find("input");spyOn(a,"_onKeyDown"),b.trigger(jQuery.Event("keydown",{keyCode:21})),expect(a._onKeyDown).not.toHaveBeenCalled(),expect(a.$el.find("input").attr("readonly")).toBeTruthy()}),it("should be invalid adding a string",function(){a.render();var b=a.$el.find("input");b.val("testing"),b.trigger(jQuery.Event("keyup",{keyCode:11})),expect(a.isValid()).toBeFalsy(),expect(b.hasClass("error")).toBeTruthy()}),it("should be valid adding a number",function(){a.render();var b=a.$el.find("input");b.val(1e3),b.trigger(jQuery.Event("keydown",{keyCode:13})),expect(a.isValid()).toBeTruthy(),expect(b.hasClass("error")).toBeFalsy(),expect(a.model.get("value")).toBe("1000")}),it("should trigger event if ENTER is keypressed",function(){a.render();var b=a.$el.find("input");spyOn(a,"_triggerEvent"),b.trigger(jQuery.Event("keydown",{keyCode:13})),expect(a._triggerEvent).toHaveBeenCalled()}),it("should be valid adding several numbers",function(){a.render();var b=a.$el.find("input");b.trigger(jQuery.Event("keyup",{keyCode:49})),b.val("1"),expect(a.isValid()).toBeTruthy(),expect(b.hasClass("error")).toBeFalsy(),b.val("1a"),b.trigger(jQuery.Event("keyup",{keyCode:97})),expect(a.isValid()).toBeFalsy(),expect(b.hasClass("error")).toBeTruthy(),b.val("1"),b.trigger(jQuery.Event("keyup",{keyCode:46})),expect(a.isValid()).toBeTruthy(),expect(b.hasClass("error")).toBeFalsy(),b.trigger(jQuery.Event("keydown",{keyCode:13})),expect(a.model.get("value")).toBe("1")})}),describe("String field",function(){var a;beforeEach(function(){a=new cdb.admin.StringField({model:new cdb.core.Model({attribute:"string",value:"value"})})}),it("should render a textarea with the correct value",function(){a.render(),expect(a.$el.find("textarea").size()).toBe(1),expect(a.$el.find("textarea").val()).toBe("value")}),it("should not render a label",function(){a.render(),expect(a.$el.find("label").size()).toBe(0)}),it("should render a label if it is specified",function(){a.options.label=!0,a.render(),expect(a.$el.find("label").size()).toBe(1)}),it("should render a readonly textarea and don't trigger any event if it is readonly",function(){a.options.readOnly=!0,a.render();var b=a.$el.find("textarea");spyOn(a,"_onKeyDown"),b.trigger(jQuery.Event("keydown",{keyCode:21})),expect(a._onKeyDown).not.toHaveBeenCalled(),expect(a.$el.find("textarea").attr("readonly")).toBeTruthy()}),it("should be valid with any change applied",function(){a.render();var b=a.$el.find("textarea");b.val("testing"),b.trigger(jQuery.Event("keydown",{which:$.ui.keyCode.ENTER})),expect(a.isValid()).toBeTruthy(),expect(a.model.get("value")).toBe("testing")}),it("should trigger event if ENTER + CMD || ENTER + Ctrl is pressed",function(){a.render();var b=a.$el.find("textarea");spyOn(a,"_triggerEvent"),b.trigger(jQuery.Event("keydown",{metaKey:!0,ctrlKey:!0,keyCode:13})),expect(a._triggerEvent).toHaveBeenCalled()})}),describe("Form",function(){var a;beforeEach(function(){var b=[{name:"Marker Fill",form:{"polygon-fill":{type:"color",value:"#00FF00"},"polygon-opacity":{type:"opacity",value:.6}}},{name:"test",form:{"polygon-fill":{type:"color",value:"#00FF00"},"polygon-opacity":{type:"opacity",value:.6}}}];a=new cdb.forms.Form({form_data:b,model:new Backbone.Model})}),it("should render form fields",function(){a.render(),expect(a.$("li").length).toEqual(2),expect(a.$(".form_color").length).toEqual(2),expect(a.$(".form_spinner").length).toEqual(2),expect(_.keys(a._subviews).length).toEqual(4),a.render(),expect(a.$("li").length).toEqual(2)}),it("should clear fields when render",function(){a.render();var b=a._subviews[_.keys(a._subviews)[0]];expect(b._parent).toEqual(a),a.render(),expect(b._parent).toEqual(null)}),it("should get fields by name",function(){a.render();var b=a.getFieldsByName("Marker Fill");expect(b.length).toEqual(2),expect(b[0].options.field_name).toEqual("Marker Fill"),expect(b[0].options.property).toEqual("polygon-fill"),expect(b[1].options.field_name).toEqual("Marker Fill")})}),describe("widgets",function(){beforeEach(function(){this.originalUserId=window.user_data.id,window.user_data.id=123}),afterEach(function(){window.user_data.id=this.originalUserId}),describe("cdb.forms.Color",function(){var a,b;beforeEach(function(){b=new Backbone.Model({test:"#FFF"}),a=new cdb.forms.Color({model:b,property:"test"})}),it("should render",function(){a.render(),expect(a.$(".color-picker").css("background-color")).toEqual("rgb(255, 255, 255)")}),it("should render color",function(){b.set({test:"#000"}),expect(a.$(".color-picker").css("background-color")).toEqual("rgb(0, 0, 0)")}),it("should use image_property",function(){b=new Backbone.Model({test:"#FaF"}),a=new cdb.forms.Color({user_data:{id:1},model:b,property:"test",extra:{image_property:"polygon-pattern-file"}}),a._openImagePicker(),a._onImageFileChosen("myurl.png"),expect(b.get("polygon-pattern-file")).toEqual("url(myurl.png)"),expect(b.get("test")).toEqual(void 0),a._createPicker(),a.color_picker.trigger("colorChosen","#FFa"),expect(b.get("polygon-pattern-file")).toEqual(void 0),expect(b.get("test")).toEqual("#FFa")})}),describe("cdb.forms.OpacityPolygon",function(){var a,b;beforeEach(function(){b=new Backbone.Model({test:2}),a=new cdb.forms.OpacityPolygon({el:$("<div>"),model:b,property:"test",min:0,max:10})}),it("should swicth property depending other one",function(){a.switchProperty(),expect(b.get("test")).toEqual(2),b.set("polygon-pattern-file","url(test.png)"),expect(b.get("test")).toEqual(void 0),expect(b.get("polygon-pattern-opacity")).toEqual(2),expect(b.originalProperty,"test"),b.set("polygon-pattern-file","url(test2.png)"),expect(b.originalProperty,"test"),b.unset("polygon-pattern-file"),expect(b.get("test")).toEqual(2)})}),describe("cdb.forms.Spinner",function(){var a,b;beforeEach(function(){b=new Backbone.Model({test:0}),a=new cdb.forms.Spinner({el:$("<div>"),model:b,property:"test",min:0,max:10})}),it("should render",function(){a.render(),expect(a.$(".value").val()).toEqual("0")}),it("should render color",function(){b.set({test:1}),expect(a.$(".value").val()).toEqual("1")}),it("should increment/decrement value on click",function(){a.render(),a.$(".plus").trigger("click"),expect(a.$(".value").val()).toEqual("1"),expect(b.get("test")).toEqual(1),a.$(".minus").trigger("click"),expect(a.$(".value").val()).toEqual("0"),expect(b.get("test")).toEqual(0)}),it("should not pass max/min",function(){b.set({test:9.1}),a.options.max=10,a.$(".plus").trigger("click"),expect(a.$(".value").val()).toEqual("10"),b.set({test:.1}),a.options.min=0,a.$(".minus").trigger("click"),expect(a.$(".value").val()).toEqual("0")}),it("should have always pattern option available",function(){var a=new Backbone.Model({test:0}),b=new cdb.forms.Spinner({el:$("<div>"),model:a,property:"test",min:0,max:10,pattern:{}});expect(b.options.pattern).toBeTruthy(),expect(b._checkNumber(1)).toBeTruthy();var c=new cdb.forms.Spinner({el:$("<div>"),model:a,property:"test",min:0,max:10,pattern:""});expect(c.options.pattern).toBeTruthy(),expect(c._checkNumber(.3)).toBeTruthy();var d=new cdb.forms.Spinner({el:$("<div>"),model:a,property:"test",min:0,max:10,pattern:/[a]/});expect(d.options.pattern).toBeTruthy(),expect(d._checkNumber("a")).toBeTruthy()}),it("should increment the value specified",function(){b.set({test:9.1}),a.options.inc=.1,a.$(".plus").trigger("click"),expect(a.$(".value").val()).toEqual("9.2")}),it("should change when slider changes",function(){a.render(),a.spinner_slider.trigger("valueSet",.55),expect(b.get("test")).toEqual(.55)})}),describe("cdb.forms.Combo",function(){var a,b,c,d;beforeEach(function(){c=new Backbone.Model({hola:10,test:1}),d=[["field1","one"],["field2","two"],["field3","three"],["field4","four"]],a=spyOn(cdb.forms.Combo.prototype,"_onUpdate"),b=new cdb.forms.Combo({width:"123px",model:c,extra:d,property:"test"})}),it("should render",function(){b.render(),expect(b.$("option").length).toEqual(4)}),it("should be able to initialize with values",function(){b=new cdb.forms.Combo({model:c,property:"test",extra:[["one",1],["two",2]]}),b.render(),b.$("select").val(2).change(),expect(c.get("test")).toEqual("2")}),it("should generate a string of options",function(){var a=b._getOptions();expect(a).toEqual('<option value="one">field1</option><option value="two">field2</option><option value="three">field3</option><option value="four">field4</option>')}),it("should generate a string of options if the combo has a placeholder",function(){b.options.placeholder="Hi";var a=b._getOptions();expect(a).toEqual('<option></option><option value="one">field1</option><option value="two">field2</option><option value="three">field3</option><option value="four">field4</option>')}),it("when val changes it should update model",function(){b.render(),b.$("select").val("four").change(),expect(c.get("test")).toEqual("four")}),it("should render when model changed",function(){b.render(),c.set({test:"one"}),expect(b.$("select").val()).toEqual("one")}),it("should throw an event when the observed field changes",function(){b.render(),c.set("test",2),expect(a).toHaveBeenCalled()}),it("should throw an event when the data change",function(){b.render(),b.updateData([["field1","one"],["field2","two"]]),expect(a).toHaveBeenCalled()}),it("shouldn't throw an event when a field changes",function(){b.render(),c.set("hola",2),expect(a).not.toHaveBeenCalled(),expect(b.$("select").val()).toEqual("one")}),it("should be able to initialize with values",function(){b.render(),b.$("select").val("two").change(),expect(c.get("test")).toEqual("two")}),it("should be able to deselect the selected value if the select has a placeholder",function(){b.options.placeholder="Hi",b.render(),b.$("select").val("four").change(),b.deselect(),expect(c.get("test")).toEqual(""),expect(b.$("select").val()).toEqual("")}),it("shouldn't be able to deselect the selected value if the select doesn't have a placeholder",function(){b.render(),b.$("select").val("four").change(),b.deselect(),expect(c.get("test")).toEqual("one"),expect(b.$("select").val()).toEqual("one")}),it("should be able to specify the width",function(){b.render();var a=b.$("select").css("width");expect(a).toEqual("123px")}),it("should be able to format results of the dropdown",function(a){spyOn(b,"_formatResult"),b.options.formatResult=!0;var c=$("<body>");c.append(b.render().el),b.$("select").select2("open"),setTimeout(function(){expect(b._formatResult).toHaveBeenCalled(),c.remove(),a()},100)})}),describe("cdb.forms.Switch",function(){var a,b;beforeEach(function(){b=new Backbone.Model({test:!0}),a=new cdb.forms.Switch({el:$("<a>"),model:b,property:"test"})}),it("should render",function(){a.render(),expect(a.$el.hasClass("enabled")).toEqual(!0)}),it("should render when model changed",function(){a.render(),b.set({test:!1}),expect(a.$el.hasClass("enabled")).toEqual(!1),expect(a.$el.hasClass("disabled")).toEqual(!0)}),it("when val changes it should update model",function(){a.render(),a.$el.trigger("click"),expect(b.get("test")).toEqual(!1)})})}),describe("localStorage",function(){var a;beforeAll(function(){localStorage.removeItem("tests")}),beforeEach(function(){a=new cdb.admin.localStorage("tests")}),afterEach(function(){localStorage.clear()}),afterAll(function(){localStorage.removeItem("tests")}),it("should contain an empty array after initialized",function(){expect(a.get()).toEqual([])}),it("add a element to localStorage",function(){var b={test:!0};a.add(b),expect(a.get(0)).toEqual(b)}),it("should be able to set the whole array",function(){a.set([1,2,3,4]),expect(a.get()).toEqual([1,2,3,4])}),it("should be able to retrieve the n element",function(){a.add(1),a.add(2),a.add(3),expect(a.get(1)).toEqual(2)}),it("should be able to retrieve the n element and transform it on an object",function(){a.add({hello:"bye"}),expect(a.get(0).hello).toEqual("bye")}),it("should persist on localStorage when added",function(){a.add(1),expect(localStorage.getItem("tests")).toBeDefined(),expect(localStorage.getItem("tests")).toBe("[1]")}),it("should remove an element",function(){a.add(1),a.add(2),a.add(3),a.remove(1),expect(a.get()).toEqual([1,3])}),it("should destroy the storage",function(){a.add(1),a.destroy(),expect(localStorage.getItem("tests")).toBeFalsy()})}),describe("tabs",function(){var a;beforeEach(function(){a=new cdb.admin.Tabs({el:$("<div>")}),a.$el.append("<span></span>"),a.$el.find("span").append('<a href="#t1">pene<div class="name">hola</div></a>'),a.$el.find("span").append('<a href="#t2"></a>')}),it("should trigger click with tab name",function(){var b;a.bind("click",function(a){b=a}),$(a.$el.find("span").children()[0]).trigger("click"),expect(b).toEqual("t1"),expect(a.preventDefault).toEqual(!1)}),it("should trigger click with tab name although is clicking over a div",function(){var b;a.bind("click",function(a){b=a}),$(a.$el.find("span:eq(0) a div")).trigger("click"),expect(b).toEqual("t1"),expect(a.preventDefault).toEqual(!1)}),it("should enable panel view when s linked",function(){var b=new cdb.ui.common.TabPane;b.addTab("t1",new cdb.core.View),b.addTab("t2",new cdb.core.View),b.active("t2"),a.linkToPanel(b);var c=$(a.$el.find("span").children()[0]),d=$(a.$el.find("span").children()[1]);c.trigger("click"),expect(b.activeTab).toEqual("t1"),expect(c.hasClass("selected")).toEqual(!0),b.active("t2"),expect(c.hasClass("selected")).not.toEqual(!0),expect(d.hasClass("selected")).toEqual(!0),expect(a.preventDefault).toEqual(!0)}),it("should disable all the links when disableAll is called",function(){a.disableAll(),expect(a.$("a").length).toEqual(2),expect(a.$("a").eq(0).hasClass("disabled")).toBeTruthy(),expect(a.$("a").eq(1).hasClass("disabled")).toBeTruthy()}),it("should remove a disabled panel view when removeDisabled is called",function(){a.disableAll(),a.removeDisabled(),expect(a.$el.find("span").length).toBeFalsy()})}),describe("TipsyTooltip",function(){
var a,b;beforeEach(function(){b=$("<a>").addClass("tooltip").attr("title","hello title"),$("body").append(b),a=new cdb.common.TipsyTooltip({el:b})}),afterEach(function(){}),it("should destroy properly",function(c){b.data().tipsy.show();var d=(b.data().tipsy.$tip,[]);a.clean(),$._data(b[0],"events")&&$.each($._data(b[0],"events"),function(a){d.push(a)}),setTimeout(function(){expect($("body").find(".tipsy").length).toBe(0),expect(_.contains(d,"mouseover")).toBeFalsy(),expect(_.contains(d,"mouseout")).toBeFalsy(),c()},1e3)})}),describe("cdb.common.DashboardUrl",function(){beforeEach(function(){this.url=new cdb.common.DashboardUrl({base_url:"http://team.carto.com/u/pepe/dashboard"})}),describe(".datasets",function(){beforeEach(function(){this.newUrl=this.url.datasets()}),it("should return a new URL pointing for datsets",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url").toString()).toEqual("http://team.carto.com/u/pepe/dashboard/datasets")})}),describe(".maps",function(){beforeEach(function(){this.newUrl=this.url.maps()}),it("should return a new URL for maps",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url").toString()).toEqual("http://team.carto.com/u/pepe/dashboard/maps")})})}),describe("cdb.common.DashboardDatasetsUrl",function(){beforeEach(function(){this.url=new cdb.common.DashboardDatasetsUrl({base_url:"http://team.carto.com/u/pepe/dashboard/datasets"})}),describe(".lockedItems",function(){beforeEach(function(){this.newUrl=this.url.lockedItems()}),it("should return a new URL pointing at locked items",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url")).toEqual("http://team.carto.com/u/pepe/dashboard/datasets/locked")})}),describe(".sharedItems",function(){beforeEach(function(){this.newUrl=this.url.sharedItems()}),it("should return a new URL pointing at shared items",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url")).toEqual("http://team.carto.com/u/pepe/dashboard/datasets/shared")})}),describe(".likedItems",function(){beforeEach(function(){this.newUrl=this.url.likedItems()}),it("should return a new URL pointing at liked items",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url")).toEqual("http://team.carto.com/u/pepe/dashboard/datasets/liked")})}),describe(".dataLibrary",function(){beforeEach(function(){this.newUrl=this.url.dataLibrary()}),it("should return a new URL pointing at data library",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url")).toEqual("http://team.carto.com/u/pepe/dashboard/datasets/library")})})}),describe("cdb.common.DashboardVisUrl",function(){beforeEach(function(){this.url=new cdb.common.DashboardVisUrl({base_url:"http://team.carto.com/u/pepe/dashboard/maps"})}),describe(".lockedItems",function(){beforeEach(function(){this.newUrl=this.url.lockedItems()}),it("should return a new URL pointing at locked items",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url")).toEqual("http://team.carto.com/u/pepe/dashboard/maps/locked")})}),describe(".sharedItems",function(){beforeEach(function(){this.newUrl=this.url.sharedItems()}),it("should return a new URL pointing at shared items",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url")).toEqual("http://team.carto.com/u/pepe/dashboard/maps/shared")})}),describe(".likedItems",function(){beforeEach(function(){this.newUrl=this.url.likedItems()}),it("should return a new URL pointing at liked items",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url")).toEqual("http://team.carto.com/u/pepe/dashboard/maps/liked")})})}),describe("cdb.common.DatasetUrl",function(){beforeEach(function(){this.url=new cdb.common.DatasetUrl({base_url:"http://team.carto.com/u/pepe/tables/awesome_data"})}),describe(".edit",function(){beforeEach(function(){this.newUrl=this.url.edit()}),it("should return a new URL pointing at the page where the map can be edited",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url")).toEqual("http://team.carto.com/u/pepe/tables/awesome_data")})}),describe(".public",function(){beforeEach(function(){this.newUrl=this.url.public()}),it("should return a new URL pointing at the page where the map can be seen publically",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url")).toEqual("http://team.carto.com/u/pepe/tables/awesome_data/public")})})}),describe("cdb.common.MapUrl",function(){beforeEach(function(){this.url=new cdb.common.MapUrl({base_url:"http://team.carto.com/u/pepe/viz/8b44c8ba-6fcf-11e4-8581-080027880ca6"})}),describe(".edit",function(){beforeEach(function(){this.newUrl=this.url.edit()}),it("should return a new URL pointing at the page where the map can be edited",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url")).toEqual("http://team.carto.com/u/pepe/viz/8b44c8ba-6fcf-11e4-8581-080027880ca6/map")})}),describe(".public",function(){beforeEach(function(){this.newUrl=this.url.public()}),it("should return a new URL pointing at the page where the map can be seen publically",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url")).toEqual("http://team.carto.com/u/pepe/viz/8b44c8ba-6fcf-11e4-8581-080027880ca6/public_map")})})}),describe("cdb.common.Url",function(){beforeEach(function(){this.baseUrl="http://subdomain.carto.com/foobar",this.url=new cdb.common.Url({base_url:this.baseUrl})}),describe(".pathname",function(){it("should return the full path of this URL",function(){expect(this.url.pathname()).toEqual("/foobar")})}),describe(".urlToPath",function(){describe("when given no arguments",function(){beforeEach(function(){this.newUrl=this.url.urlToPath()}),it("should return a new url object",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl instanceof cdb.common.Url).toBeTruthy()}),it("should return a new url object that have the same base url",function(){expect(this.newUrl.get("base_url")).toContain(this.baseUrl)})}),describe("when given any argument",function(){beforeEach(function(){this.newUrl=this.url.urlToPath("sub","path")}),it("should return a new url object that have same base url",function(){expect(this.newUrl.get("base_url")).toContain(this.baseUrl)}),it("should return a new url object that have the given params as path",function(){expect(this.newUrl.get("base_url")).toContain(this.baseUrl+"/sub/path")})})}),describe(".toString",function(){it("should return the string representation of the URL",function(){expect(this.url.toString()).toEqual(this.baseUrl)})})}),describe("cdb.common.UserUrl",function(){beforeEach(function(){this.is_org_admin=!1,this.createUrl=function(){this.url=new cdb.common.UserUrl({base_url:"http://team.carto.com/u/pepe",is_org_admin:this.is_org_admin})}}),describe(".organization",function(){describe("when user is organization admin",function(){beforeEach(function(){this.is_org_admin=!0,this.createUrl(),this.newUrl=this.url.organization()}),it("should return a new url point to the organization settings page",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url").toString()).toEqual("http://team.carto.com/u/pepe/organization")})}),describe("when user is a normal organization member",function(){beforeEach(function(){this.is_org_admin=!1,this.createUrl(),this.newUrl=this.url.organization()}),it("should return a new url point to the organization settings page",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url")).toEqual("http://team.carto.com/u/pepe/account")})})}),describe(".accountSettings",function(){beforeEach(function(){this.createUrl(),this.newUrl=this.url.accountSettings()}),it("should return a new url point to the user's account profile page",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url")).toEqual("http://team.carto.com/u/pepe/profile")})}),describe(".publicProfile",function(){beforeEach(function(){this.createUrl(),this.newUrl=this.url.publicProfile()}),it("should return a new URL pointing to the user's public profile home",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url")).toMatch("http://team.carto.com/u/pepe/me")})}),describe(".apiKeys",function(){beforeEach(function(){this.createUrl(),this.newUrl=this.url.apiKeys()}),it("should return a new URL pointing to where the user can find his/her API keys",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url")).toMatch("http://team.carto.com/u/pepe/your_apps")})}),describe(".logout",function(){beforeEach(function(){this.createUrl(),this.newUrl=this.url.logout()}),it("should return a new URL pointing to the logout endpoint",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url")).toMatch("http://team.carto.com/u/pepe/logout")})}),describe(".dashboard",function(){beforeEach(function(){this.createUrl(),this.newUrl=this.url.dashboard()}),it("should return a new URL pointing to the dashboard of the user",function(){expect(this.newUrl).not.toBe(this.url),expect(this.newUrl.get("base_url")).toMatch("http://team.carto.com/u/pepe/dashboard")})})}),describe("UserMenu",function(){var a;beforeEach(function(){a=new cdb.admin.DropdownMenu({speedIn:250})}),afterEach(function(){a.clean()}),it("should open at position x, y",function(b){a.openAt(11,12),setTimeout(function(){expect(a.$el.css("opacity")).not.toEqual("0"),expect(a.$el.css("top")).toEqual("12px"),expect(a.$el.css("left")).toEqual("11px"),b()},300)})}),describe("Utils",function(){describe("stripHTML",function(){it("should strip a text with tags except <a>",function(){var a="<p>jamon</p> <a>jamon</a>",b="<a>";expect(cdb.Utils.stripHTML(a,b)).toBe("jamon <a>jamon</a>")}),it("shouldn't strip anything if the input is an object",function(){var a=[],b="<a>";expect(cdb.Utils.stripHTML(a,b)).toBe("");var a={};expect(cdb.Utils.stripHTML(a,b)).toBe("")}),it("shouldn't strip anything if the input is undefined",function(){var a=void 0,b="<a>";expect(cdb.Utils.stripHTML(a,b)).toBe("")}),it("should strip a text with tags",function(){var a="<p>jamon</p> <a>jamon</a>",b="";expect(cdb.Utils.stripHTML(a,b)).toBe("jamon jamon")})}),describe("removeHTMLEvents",function(){it("should remove onClick function from a <a> tag",function(){var a="<a onClick=\"alert('paco')\">jamon</a>";expect(cdb.Utils.removeHTMLEvents(a)).toBe("<a>jamon</a>")}),it("shouldn't remove anything if there is no events attached",function(){var a="<a>jamon</a>";expect(cdb.Utils.removeHTMLEvents(a)).toBe("<a>jamon</a>")}),it("shouldn't remove anything if the input is undefined",function(){var a=void 0;expect(cdb.Utils.removeHTMLEvents(a)).toBe("")})}),describe("isURL",function(){it("should check if the string is an url or an ftp",function(){expect(cdb.Utils.isURL("ftp://jamon.com")).toBeTruthy()}),it("shouldn't check if the string is undefined or null or empty",function(){expect(cdb.Utils.isURL("")).toBeFalsy(),expect(cdb.Utils.isURL()).toBeFalsy(),expect(cdb.Utils.isURL(void 0)).toBeFalsy()}),it("should be false if the string is a name, for example",function(){expect(cdb.Utils.isURL("eyeyyeeyyeey")).toBeFalsy()})}),describe("formatNumber",function(){it("should format the number",function(){expect(cdb.Utils.formatNumber(2e6)).toEqual("2,000,000")}),it("shouldn't format numbers < 1000",function(){expect(cdb.Utils.formatNumber(99)).toEqual("99"),expect(cdb.Utils.formatNumber(0)).toEqual("0")}),it("shouldn't handle invalid values",function(){expect(cdb.Utils.formatNumber("Solvitur ambulando")).toEqual("Solvitur ambulando"),expect(cdb.Utils.formatNumber(null)).toEqual("0")})}),describe("formatNumber",function(){it("should generate random password",function(){expect(cdb.Utils.genRandomPass()).not.toBe(""),expect(cdb.Utils.genRandomPass().length).toBeGreaterThan(5),expect(cdb.Utils.genRandomPass().length).toBeLessThan(13)}),it("should generate random password with only 8 chars",function(){expect(cdb.Utils.genRandomPass(8)).not.toBe(""),expect(cdb.Utils.genRandomPass(8).length).toBe(8)}),it("should generate random password despite of an incorrect length",function(){expect(cdb.Utils.genRandomPass("-")).not.toBe(""),expect(cdb.Utils.genRandomPass("*")).not.toBe(""),expect(cdb.Utils.genRandomPass("$").length).toBeGreaterThan(5),expect(cdb.Utils.genRandomPass("4").length).toBe(4)})}),describe(".result",function(){beforeEach(function(){this.model=new cdb.core.Model({something:"yay"}),this.model.myProp=123}),it("should try to call given method",function(){expect(cdb.Utils.result(this.model,"get","something")).toEqual("yay")}),it("should return the property if a value",function(){expect(cdb.Utils.result(this.model,"myProp")).toEqual(123)}),it("should return fallback value if can not call method",function(){expect(cdb.Utils.result(this.model,"nonexisting")).toBeUndefined(),expect(cdb.Utils.result(void 0,"nonexisting")).toBeNull()})})}),describe("VideoPlayer",function(){var a,b;beforeEach(function(){b=new cdb.admin.localStorage("VideoPlayer"),b.destroy(),cdb.templates.add(new cdb.core.Template({name:"cartodb/dashboard/views/video_player",compiled:_.template('<iframe class="VideoPlayer-videoIframe" src="//player.vimeo.com/video/<%= id %>?api=1&title=0&byline=0&portrait=0"></iframe>')})),a=new cdb.admin.VideoPlayer}),afterEach(function(){b&&b.destroy(),a.remove()}),it("shouldn't start if there's no video data",function(){a.render(),expect(a.hasVideoData()).toEqual(!1)}),it("should render if an id is provided",function(){var a=122308083,b=new cdb.admin.VideoPlayer({id:a});b.render(),expect(b.hasVideoData()).toEqual(!0),expect(b.model.get("video_id")).toEqual(a),expect(b.$el.find("iframe").length).toBe(1)}),it("should clear the localstorage when the player is closed",function(){var a=122308083,b=new cdb.admin.VideoPlayer({video_id:a});b.render(),b.close(null,{dontHide:!0}),expect(b.hasVideoData()).toEqual(!1),expect(b.model.localStorage.get("currentVideo")).toEqual(null)}),it("should render if there's video data",function(){b=new cdb.admin.localStorage("VideoPlayer"),id=122308083;var a={currentVideo:{video_id:id}};b.set(a);var c=new cdb.admin.VideoPlayer;c.render(),expect(c.hasVideoData()).toEqual(!0),expect(c.model.videoData.video_id).toEqual(id),expect(c.$el.find("iframe").length).toBe(1)}),it("should change the size",function(){var a=122308083,b=new cdb.admin.VideoPlayer({video_id:a});b.render(),$("body").append(b.$el),expect(b.model.get("width")).toEqual(420),expect(b.model.get("height")).toEqual(236),b.model.set("minimized",!1),expect(b.model.get("width")).toEqual(700),expect(b.model.get("height")).toEqual(393)})}),describe("Authenticated user",function(){beforeEach(function(){this.model=new cdb.open.AuthenticatedUser({})}),it("should return the normal URL",function(){var a=sinon.stub(this.model,"_getCurrentHost");a.returns("test.carto.com"),expect(this.model.url()).toBe("//test.carto.com/api/v1/get_authenticated_users")}),it("should return the a URL with a custom host",function(){var a=sinon.stub(cdb.open.AuthenticatedUser.prototype,"_getCurrentHost");a.returns("test.carto.com");var b=new cdb.open.AuthenticatedUser({host:"hello.carto.com"});expect(b.url()).toBe("//hello.carto.com/api/v1/get_authenticated_users")})}),describe("Public pages header tests",function(){var a,b,c;beforeEach(function(){b=$("<header>").addClass("cartodb-public-header"),c=new cdb.open.AuthenticatedUser({}),table=new cdb.admin.CartoDBTableMetadata({name:"test_table",geometry_types:["st_polygon"]}),a=new cdb.open.Header({el:b,model:c,vis:table,current_view:"dashboard",owner_username:"test",isMobileDevice:!1}),cdb.config.set({cartodb_com_hosted:!1})}),afterEach(function(){a.clean()}),it("should render properly when authenticated users are 'empty'",function(){a.render(),expect(a.$("ul.options li a").size()).toBe(3),expect(a.$("ul.options li a.account").size()).toBe(0),expect(a.$("ul.options li a.login").size()).toBe(1)}),it("should render properly when authenticated users are 'empty' and it is a mobile device",function(){a.options.isMobileDevice=!0,a.render(),expect(a.$("ul.options li a").size()).toBe(2),expect(a.$("ul.options li a.account").size()).toBe(0),expect(a.$("ul.options li a.login").size()).toBe(1),expect(a.$("ul.options li a.signup").size()).toBe(1)}),it("should render properly when authenticated user is filled and it is in dashboard view",function(){c.set({urls:["http://test.carto.com/dashboard"],username:"test"}),expect(a.$("ul.options li a").size()).toBe(1),expect(a.$("ul.options li a.account").size()).toBe(1),expect(a.$("ul.options li a.login").size()).toBe(0),expect(a.$("ul.options li a.signup").size()).toBe(0)}),it("should render properly when authenticated user is filled and it is in table or visualization view, edit button should appear",function(){a.options.current_view="table",c.set({urls:["http://test.carto.com/dashboard"],username:"test"}),expect(a.$("ul.options li a").size()).toBe(1),expect(a.$("ul.options li a.account").size()).toBe(1),expect(a.$("ul.options li a.login").size()).toBe(0),expect(a.$("ul.options li a.signup").size()).toBe(0),a.options.current_view="visualization",a.vis=new cdb.open.PublicVisualization({id:"aaaa-bbbb-cccc-dddd",name:"fake_2"}),a.render(),expect(a.$("ul.options li a").size()).toBe(1),expect(a.$("ul.options li a.account").size()).toBe(1),expect(a.$("ul.options li a.login").size()).toBe(0),expect(a.$("ul.options li a.signup").size()).toBe(0)})}),describe("Actions menu",function(){var a,b,c,d,e;beforeEach(function(){b=TestUtil.createVis(),master_vis=TestUtil.createVis(),c=new cdb.admin.SQLViewData(null,{sql:"select * from a"}),table=new cdb.admin.CartoDBTableMetadata({name:"test1"}),d=new cdb.admin.User({base_url:"http://test.carto.com",id:1,name:"test",limits:{concurrent_imports:1},remaining_byte_quota:1e3,salesforce:{enabled:!1},twitter:{enabled:!0},mailchimp:{enabled:!1}}),window.table_router={},cdb.config.set({upgrade_url:"whatever",cartodb_com_hosted:!1}),a=new cdb.admin.LayersPanel({vis:b,master_vis:master_vis,user:d,globalError:new cdb.admin.GlobalError({el:$("<div>")})}),b.map.layers.reset([new cdb.geo.MapLayer,new cdb.admin.CartoDBLayer({type:"CartoDB",table_name:"test_table_1"}),new cdb.admin.CartoDBLayer({type:"CartoDB",table_name:"test_table_2"})]),e=sinon.fakeServer.create()}),it("should render a layer panel for each layer in the map",function(){expect(_.keys(a.tabs).length).toEqual(2)}),it("should add a layer panel when layers is added to the map",function(){spyOn(a,"_bindLayerTooltip"),b.map.layers.add(new cdb.admin.CartoDBLayer({table_name:"test_table_3"})),expect(_.keys(a.tabs).length).toEqual(3),expect(a._bindLayerTooltip).toHaveBeenCalled()}),it("should set current layer when added a new layer",function(){var c=new cdb.admin.CartoDBLayer({table_name:"test_table_3"});spyOn(a,"_switchTo"),b.map.layers.add(c),expect(a.map.layers.getLayersByType("CartoDB").length).toBe(3),expect(a._switchTo).toHaveBeenCalled()}),it("should set active layer when active-menu initilizes or layers change",function(){spyOn(a,"_setDefaultLayer"),b.map.layers.reset([new cdb.geo.MapLayer,new cdb.admin.CartoDBLayer({table_name:"test_table_1"}),new cdb.admin.CartoDBLayer({table_name:"test_table_2"})]),expect(a._setDefaultLayer).toHaveBeenCalled()}),it("should add a layers panels when on reset layers",function(){b.map.layers.reset([new cdb.admin.CartoDBLayer({table_name:"test_table_4"}),new cdb.admin.CartoDBLayer({table_name:"test_table_5"})]),expect(_.keys(a.tabs).length).toEqual(2)}),it("should show",function(){spyOn(a.$el,"animate"),a.show("table"),expect(a.$el.animate).toHaveBeenCalled(),expect(a.model.get("open")).toEqual(!0),expect(a.model.get("activeWorkView")).toEqual("table")}),it("should hide",function(){spyOn(a.$el,"animate"),a.render().hide(),expect(a.$el.animate).toHaveBeenCalled(),expect(a.model.get("open")).toEqual(!1)}),it("should open delete layer modal on delete event on a layer",function(){spyOn(cdb.editor.DeleteLayerView.prototype,"initialize").and.callThrough();var b=a.layer_panels[1];b.trigger("delete",b),expect(cdb.editor.DeleteLayerView.prototype.initialize).toHaveBeenCalled()}),it("should show tools",function(){var b=a.getActivePane();spyOn(b,"setActiveWorkView"),a.setActiveWorkView("table"),expect(b.setActiveWorkView).toHaveBeenCalledWith("table")}),it("should ask create vis first when vis of type",function(){var b=a.master_vis.cid,c=a.vis.cid;spyOn(cdb.editor.CreateVisFirstView.prototype,"initialize").and.callThrough(),a.$(".add_layer").click(),expect(cdb.editor.CreateVisFirstView.prototype.initialize).toHaveBeenCalled(),expect(a.createVisDlg).toBeDefined(),expect(a.createVisDlg.model.cid).toBe(b),expect(a.createVisDlg.model.cid).not.toBe(c)}),it("should open new layer modal when vis if of type derived (i.e. map)",function(){b.set("type","derived"),spyOn(cdb.editor.AddLayerModel.prototype,"initialize").and.callThrough(),a.$(".add_layer").click(),expect(cdb.editor.AddLayerModel.prototype.initialize).toHaveBeenCalled()}),it("should order layers when removes a layer",function(){spyOn(a,"_manageLayers");var b=a.layer_panels[1];b.model.destroy(),expect(a._manageLayers).toHaveBeenCalled()}),it("should order layers when adds a layer",function(){var c=new cdb.admin.CartoDBLayer({table_name:"test_table_3"});spyOn(a,"_manageLayers"),b.map.layers.add(c),expect(a._manageLayers).toHaveBeenCalled()}),it("should manage layers when active layer changes",function(){var b=a.layer_panels[0];spyOn(a,"_manageLayers"),b.trigger("switchTo",b),expect(a._manageLayers).toHaveBeenCalled()}),it("should set other current layer if the previous saved one doesn't exist",function(){spyOn(a,"_switchTo"),b.map.layers.reset([new cdb.geo.MapLayer,new cdb.admin.CartoDBLayer({table_name:"test_table_1"})]),expect(a._switchTo).toHaveBeenCalled()}),it("should not save visualization if the active layer does not change",function(){b.set("active_layer_id",2);var c=[new cdb.admin.CartoDBLayer({id:1,table_name:"test_table_1"}),new cdb.admin.CartoDBLayer({id:2,table_name:"test_table_2"})];b.map.layers.reset(c),a._switchTo(a.layer_panels[1]),expect(a.vis.get("active_layer_id")).toEqual(2),spyOn(a.vis,"save"),a._switchTo(a.layer_panels[1]),expect(a.vis.save).not.toHaveBeenCalled()}),describe("limits dialog",function(){beforeEach(function(){spyOn(d,"canAddLayerTo").and.returnValue(!1),spyOn(a,"_createAddLayerDialog").and.callThrough(),spyOn(cdb.editor.CreateVisFirstView.prototype,"initialize").and.callThrough(),spyOn(cdb.editor.LimitsReachView.prototype,"initialize").and.callThrough(),b.map.layers.reset([new cdb.admin.CartoDBLayer({type:"CartoDB",id:1,table_name:"test_table_1"}),new cdb.admin.CartoDBLayer({type:"CartoDB",id:2,table_name:"test_table_2"})]),b.set("type","derived")}),it("should show reached limits dialog when user has all the allowed layers for a map",function(){a.$(".add_layer a.info").click(),expect(a._createAddLayerDialog).not.toHaveBeenCalled(),expect(cdb.editor.CreateVisFirstView.prototype.initialize).not.toHaveBeenCalled(),expect(cdb.editor.LimitsReachView.prototype.initialize).toHaveBeenCalled()}),it("should show reached limits dialog when user has more than the allowed layers for a map",function(){var b=d.get("limits");b.max_layers=1,d.set("limits",b),a.$(".add_layer a.info").click(),expect(a._createAddLayerDialog).not.toHaveBeenCalled(),expect(cdb.editor.CreateVisFirstView.prototype.initialize).not.toHaveBeenCalled(),expect(cdb.editor.LimitsReachView.prototype.initialize).toHaveBeenCalled()})}),it("should not have leaks",function(){expect(a).toHaveNoLeaks()}),afterEach(function(){cdb.config.unset("upgrade_url"),cdb.config.unset("cartodb_com_hosted"),window.table_router=void 0,delete window.table_router})}),describe("basemap_dropdown",function(){var a,b;beforeEach(function(){var c=TestUtil.createTable("test"),d=(new cdb.geo.ui.InfowindowModel({}),TestUtil.createVis("jam")),e=TestUtil.createVis("jam"),f=new cdb.admin.Map,g=new cdb.admin.CartoDBLayer({table_name:"test",tile_style:"test",user_name:"test"});f.layers.add(g),f.layers.add(new cdb.admin.CartoDBLayer({table_name:"test2",tile_style:"style",user_name:"test"}));var h=$('<div><div class="cartodb-map"></div></div>');h.appendTo($("body")),b=new cdb.admin.MapTab({user:TestUtil.createUser("jamon"),model:f,vis:d,master_vis:e,menu:new cdb.admin.RightMenu({}),geocoder:new cdb.admin.Geocoding("",c),el:h,baseLayers:new cdb.admin.Layers([new cdb.admin.TileLayer({urlTemplate:"rabos"})])}),b.enableMap(),b.render(),layerView=new cdb.admin.LayerPanelView({model:g,vis:TestUtil.createVis(),user:TestUtil.createUser("jamon"),globalError:new cdb.admin.GlobalError({el:$("<div>")})}),b.setActiveLayer(layerView),a=new cdb.admin.DropdownBasemap({target:$(".basemap_dropdown"),position:"position",template_base:"table/views/basemap/basemap_dropdown",model:f,mapview:b,user:new cdb.admin.User({username:"test",id:"1"}),baseLayers:new cdb.admin.Layers([new cdb.admin.TileLayer({urlTemplate:"rabos",category:"cat1"}),new cdb.admin.TileLayer({urlTemplate:"rabos",category:"cat2"}),new cdb.admin.TileLayer({urlTemplate:"rabos"}),new cdb.admin.GMapsBaseLayer({category:"GMaps",className:"googlemaps"})]),tick:"left",vertical_offset:40,horizontal_position:"left"})}),afterEach(function(){b.options.geocoder.dlg&&b.options.geocoder.dlg.hide(),b.noGeoRefDialog&&b.noGeoRefDialog.clean(),localStorage.clear(),b.$el.html("").remove(),$(".dropdown").remove()}),it("should render the view",function(){a.render(),expect(a.$el.length).toEqual(1)}),it("should render the available basemaps",function(){a.render(),expect(a.$el.find(".thumbs.cat1").length).toEqual(1),expect(a.$el.find(".thumbs.cat2").length).toEqual(1),expect(a.$el.find(".thumbs.others").length).toEqual(1)}),it("should render gmaps basemaps",function(){spyOn(a,"googleMapsEnabled").and.returnValue(!0),a.render(),expect(a.$el.find(".thumbs.gmaps").length).toEqual(1)})}),describe("baseMapView",function(){var a,b,c;beforeEach(function(){a=new cdb.admin.TileLayer({urlTemplate:"http://test.com"}),c=new cdb.admin.Map({provider:"leaflet"}),c.layers.add(new cdb.admin.TileLayer),b=new cdb.admin.BaseMapView({el:$("<div>"),model:a,map:c})}),it("should change base layer when click",function(){spyOn(c,"setBaseLayer"),b.render(),b.$el.trigger("click"),expect(c.setBaseLayer).toHaveBeenCalled(),expect(c.setBaseLayer.calls.mostRecent().args[0].get("urlTemplate")).toEqual("http://test.com")}),it("if the map provider is gmaps should switch to leaflet",function(){var a=!1;spyOn(c,"setBaseLayer"),c.set({provider:"googlemaps"});var d=new cdb.admin.TileLayer;c.layers.add(d),spyOn(d,"save"),spyOn(c,"save"),sinon.stub(c,"save",function(b,c){expect(b).toEqual({provider:"leaflet"}),c.success(),a=!0}),spyOn(c.layers,"saveLayers"),b.render(),b.$el.trigger("click"),expect(c.setBaseLayer).toHaveBeenCalled(),expect(c.setBaseLayer.calls.mostRecent().args[0].get("urlTemplate")).toEqual("http://test.com"),expect(a).toEqual(!0)})}),describe("gmapsbaseview",function(){var a,b,c;beforeEach(function(){a=new cdb.admin.TileLayer({urlTemplate:"http://test.com"}),c=new cdb.admin.Map({provider:"leaflet"}),c.layers.add(new cdb.admin.GMapsBaseLayer),b=new cdb.admin.GMapsBaseView({el:$("<div>"),model:new cdb.admin.GMapsBaseLayer,map:c})}),it("if the map provider is leaflet should switch to gmaps and change baselayer",function(){var a=new cdb.admin.TileLayer;c.layers.add(a),spyOn(a,"save"),sinon.stub(c,"save",function(a,b){expect(a).toEqual({provider:"googlemaps"}),b.success(),called=!0}),spyOn(c,"setBaseLayer"),b.render(),b.$el.trigger("click"),expect(c.setBaseLayer).toHaveBeenCalled(),expect(c.setBaseLayer.calls.mostRecent().args[0].get("type")).toEqual("GMapsBase")})}),describe("Column_type_dropdown",function(){var a,b;beforeEach(function(){b=TestUtil.createTable("test",[["test2","number"],["date","string"]]),a=new cdb.admin.ColumntypeDropdown({position:"position",horizontal_position:"left",tick:"left",template_base:"table/views/table_column_type_options"}),a.dialogContainer=$("<div></div>"),a.render()}),afterEach(function(){$(".confirmTypeChangeDialog").remove()}),it("should set the options",function(){a.setTable(b,"test2"),expect(a.table).toEqual(b),expect(a.column).toEqual("test2")}),it("should try to disable the previous column type",function(){spyOn(a,"_disableColumn"),a.setTable(b,"test2"),expect(a._disableColumn).toHaveBeenCalled()}),describe("When the requested type change is not type safe",function(){it("should show the confirmation dialog when the change is destructive ",function(){a.setTable(b,"test2"),a.setColumnTypeChange("boolean"),expect(a.change_confirmation.className).toContain("Dialog"),a.change_confirmation.clean()}),it("should not change the type if it is already that type",function(){spyOn(a,"setColumnTypeChange"),a.setTable(b,"date"),a.setString({}),expect(a.setColumnTypeChange).not.toHaveBeenCalled()}),it("should change the type after dialog ok is click",function(){sinon.spy();spyOn(b,"changeColumnType"),a.setTable(b,"test2"),a.setColumnTypeChange("boolean"),a.change_confirmation.ok(),expect(b.changeColumnType).toHaveBeenCalled(),a.change_confirmation.clean()})}),describe("when the change is type safe",function(){it("should change type without ask for confirmation ",function(){sinon.spy();spyOn(b,"changeColumnType"),a.setTable(b,"test2"),a.setColumnTypeChange("string"),expect(a.change_confirmation).toBeFalsy()}),it("should change the type",function(){sinon.spy();spyOn(b,"changeColumnType"),a.setTable(b,"test2"),a.setColumnTypeChange("string"),expect(b.changeColumnType).toHaveBeenCalled()})})}),describe("GeomEditor",function(){var a,b;beforeEach(function(){b=TestUtil.createTable(),a=new cdb.admin.GeometryEditor({el:$("<div>"),model:b});var c=cdb.geo.LeafletMapView,d=new c({el:$("<div>"),map:new cdb.geo.Map});a.mapView=d}),it("user clicks on a geometry should finish editing the current one",function(){a.render();var b=new cdb.geo.Geometry({the_geom:'{"type":"Point","coordinates":[-0.13163,51.512354]}'});spyOn(b,"save"),b.fetch=function(a){a.success()},a.editGeom(b),a.$(".done").trigger("click"),expect(b.save).toHaveBeenCalled()}),it("if the geometry is tooooo big, you cannot edit it",function(){a.render();var b=[];for(i=0;i<2001;i++)b.push([[0,0]]);var c=new cdb.geo.Geometry({the_geom:JSON.stringify({type:"Point",coordinates:b})});spyOn(a,"_showStopEdit"),c.fetch=function(a){a.success()},a.editGeom(c),expect(a._showStopEdit).toHaveBeenCalled()}),it("user clicks on discard the row should be the same",function(){a.render();var b='{"type":"Point","coordinates":[-0.13163,51.512354]}',c=new cdb.geo.Geometry({the_geom:b});c.fetch=function(a){a.success()},a.editGeom(c),spyOn(c,"save"),c.set("the_geom",'{"type":"Point","coordinates":[1, 2]}'),a.$(".discard").trigger("click"),expect(c.save).not.toHaveBeenCalled(),expect(c.get("the_geom")).toEqual(b)})}),describe("GrouperLayerMapView",function(){function a(a){beforeEach(function(){b=new cdb.geo.TileLayer({urlTemplate:"test"}),c=new cdb.admin.CartoDBLayer({tile_style:"test1",query:"sql1",interactivity:"int1",visible:!0}),d=new cdb.admin.CartoDBLayer({tile_style:"test2",query:"sql2",interactivity:"int2",visible:!0});var f=new cdb.admin.Map;e=new a({map:f,user:new cdb.admin.User})}),it("should group cartodb layers when they are added",function(){e.map.layers.add(b),e.map.layers.add(c),e.map.layers.add(d),expect(e.getLayerByCid(c.cid)===e.getLayerByCid(d.cid)).toEqual(!0),expect(_(e.layers).size()).toEqual(3),expect(e.groupLayer.getLayerCount()).toEqual(2)}),it("should remove layer",function(){e.map.layers.add(b),e.map.layers.add(c),e.map.layers.add(d),e.map.layers.remove(c),expect(_(e.layers).size()).toEqual(2),expect(e.groupLayer.getLayerCount()).toEqual(1)}),it("should remove all layers",function(){e.map.layers.add(b),e.map.layers.add(c),e.map.layers.add(d),e._removeLayers(),expect(_(e.layers).size()).toEqual(0),expect(e.groupLayer).toEqual(null)}),it("set active layer",function(){
e.map.layers.add(b),e.map.layers.add(c),e.map.layers.add(d),spyOn(e.groupLayer,"setInteraction"),e.setActiveLayer(c),expect(e.groupLayer.setInteraction.calls.count()).toEqual(2);var a=e.groupLayer.setInteraction.calls.argsFor(0);expect(a).toEqual([0,!0]),a=e.groupLayer.setInteraction.calls.argsFor(1),expect(a).toEqual([1,!1])}),describe("listening to changes on any layer",function(){beforeEach(function(){e.map.layers.add(b),e.map.layers.add(c),e.map.layers.add(d)}),it("should update the groupLayer definition when 'tile_style' changes",function(){spyOn(e.groupLayer,"setLayerDefinition"),c.set("tile_style","whatever"),expect(e.groupLayer.setLayerDefinition).toHaveBeenCalled()}),it("should update the groupLayer definition when 'query' changes",function(){spyOn(e.groupLayer,"setLayerDefinition"),c.set("query","whatever"),expect(e.groupLayer.setLayerDefinition).toHaveBeenCalled()}),it("should update the groupLayer definition when 'query_wrapper' changes",function(){spyOn(e.groupLayer,"setLayerDefinition"),c.set("query_wrapper","whatever"),expect(e.groupLayer.setLayerDefinition).toHaveBeenCalled()}),it("should update the groupLayer definition when 'interactivity' changes",function(){spyOn(e.groupLayer,"setLayerDefinition"),c.set("interactivity","whatever"),expect(e.groupLayer.setLayerDefinition).toHaveBeenCalled()}),it("should update the groupLayer definition when 'visible' changes",function(){spyOn(e.groupLayer,"setLayerDefinition"),c.set("visible","whatever"),expect(e.groupLayer.setLayerDefinition).toHaveBeenCalled()})}),describe(".disableInteraction",function(){describe("given no non-base layer has been added",function(){it("should not throw any errors",function(){expect(e.disableInteraction).not.toThrow()})}),describe("given at least one non-base layer has been added",function(){beforeEach(function(){e.map.layers.add(c),spyOn(e.groupLayer,"_clearInteraction"),e.disableInteraction()}),it("should clear interaction on the created group layer of the map",function(){expect(e.groupLayer._clearInteraction).toHaveBeenCalled()})})})}var b,c,d,e;describe("leaflet",function(){a(cdb.admin.LeafletMapView)})}),describe("Table/Visualization Header tests",function(){var a;beforeEach(function(){this.vis=new cdb.admin.Visualization({map_id:96,active_layer_id:null,name:"test_table",description:"Visualization description",tags:["jamon","probando","test"],privacy:"PUBLIC",updated_at:"2013-03-04T18:09:34+01:00",type:"table"}),a=new cdb.admin.CartoDBLayer({table_name:"test_table"}),this.vis.map.layers.reset([new cdb.geo.MapLayer,a]),this.user=TestUtil.createUser(),a.table.permission.owner=this.user,this.$header=$('       <header class="vis">        <div class="inner">          <div class="header_content">            <div class="vis_navigation">              <nav>                <a href="#/table" class="smaller strong tab selected">Data view</a>                <a href="#/map" class="smaller strong tab">Map view</a>              </nav>              <div class="globalerror"></div>            </div>            <div class="left">              <ul class="actions">                <li><a class="back" href="">Back</a></li>                <li><a class="privacy" href="#/visualize"><i class="privacy-status"></i></a></li>                <li><h1><a href="#/change-title" class="title"></a></h1></li>              </ul>              <div class="metadata">                <p><a href="#/edit-metadata">edit metadata…</a></p>              </div>            </div>            <div class="right">              <ul class="options">                <li><a class="dropdown options" href="#/options">options</a></li>                <li><a class="rounded share" href="#/visualize"><span>VISUALIZE</span></a></li>              </ul>            </div>          </div>          <div class="sync_status"></div>        </div>      </header>'),this.header=new cdb.admin.Header({el:this.$header,globalError:{showError:{}},model:this.vis,user:this.user,config:TestUtil.config,geocoder:{}}),this.header.setActiveLayer(new cdb.admin.LayerPanelView({model:a,vis:this.vis,map:this.vis.map,user:this.user,globalError:{}}))}),afterEach(function(){this.header.clean(),this.$header.remove()}),it("should contain a change title link",function(){expect(this.header.$el.find(".title").length).toBeTruthy()}),it("should create the title change dialog on click",function(a){$(this.header.el).find(".title").click();var b=this;setTimeout(function(){expect(b.header.title_dialog).toBeTruthy(),b.header.title_dialog.hide(),a()},25)}),it("should open a warning dialog when user changes the title",function(a){$(this.header.el).find(".title").click();var b=this;setTimeout(function(){b.header.title_dialog.$("input").val("example"),b.header.title_dialog.$(".ok").click(),setTimeout(function(){expect(b.header.change_confirmation).toBeTruthy(),b.header.title_dialog.clean(),b.header.change_confirmation.clean(),a()},25)},25)}),it("should not open the warning dialog when user changes the title",function(a){this.vis.set("type","derived"),$(this.header.el).find(".title").click(),this.header._onSetAttributes=function(){};var b=this;setTimeout(function(){b.header.title_dialog.$("input").val("example"),b.header.title_dialog.$(".ok").click(),setTimeout(function(){expect(b.header.change_confirmation).toBeFalsy(),b.header.title_dialog.clean(),a()},25)},25)}),it("should not let the user change the visualization/table name when the table is not writable",function(a){this.vis.map.layers.last().table.sqlView={isReadOnly:function(){return!0}},$(this.header.el).find(".title").click();var b=this;setTimeout(function(){var c=b.header.$("a.title");expect(c.data("tipsy")).toBeDefined(),expect(c.data("tipsy").$tip.is(":visible")).toBeTruthy(),expect(b.header.title_dialog).toBeFalsy(),a()},25)}),it("should not let the user change the visualization/table name when the table is syncable",function(a){this.vis.map.layers.last().table.synchronization.set({id:"test",from_external_source:!1}),$(this.header.el).find(".title").click();var b=this;setTimeout(function(){expect(b.header.title_dialog).toBeFalsy(),a()},25)}),it("should let the user change the visualization name although the table is syncable",function(a){this.vis.set("type","derived"),this.vis.map.layers.last().table.synchronization.set({id:"test",from_external_source:!1}),$(this.header.el).find(".title").click();var b=this;setTimeout(function(){expect(b.header.title_dialog).toBeTruthy(),b.header.title_dialog.clean(),a()},25)}),it("should render sync info when table is synced",function(){this.vis.map.layers.last().table.synchronization.set({id:"test",from_external_source:!1}),expect(this.header.sync_info.el).toBeDefined(),expect($(this.header.el).find(".sync_status").length).toBe(1)}),it("should remove sync info when table is not synced",function(){this.vis.map.layers.last().table.synchronization.set({id:"test",from_external_source:!1}),expect(this.header.sync_info).toBeDefined(),expect($(this.header.el).find(".sync_status .sync_info").length).toBe(1),this.vis.map.layers.last().table.synchronization.destroy(),expect($(this.header.el).find(".sync_status .sync_info").length).toBe(0)}),it("should add the privacy class on the status selector link",function(){this.vis.set("privacy","public"),expect($(this.header.el).find(".privacy").hasClass("public")).toBeTruthy()}),it("should remove the previous privacy class when the status change",function(){this.vis.set("privacy","private"),expect($(this.header.el).find(".privacy").hasClass("public")).toBeFalsy()}),it("should add the number of shared users if the table/vis is shared and you are the owner",function(){this.vis.permission.owner=this.user,this.vis.permission.acl.reset([{entity:{},type:"user",access:"r"}]),expect(this.header.$(".privacy i span.shared_users").text()).toBe("1"),this.vis.permission.acl.reset([{entity:{},type:"org",access:"r"}]),expect(this.header.$(".privacy i span.shared_users").text()).toBe("ORG"),this.vis.permission.acl.reset([{entity:{},type:"user",access:"r"},{entity:{},type:"user",access:"r"}]),expect(this.header.$(".privacy i span.shared_users").text()).toBe("2")}),it("shouldn't show shared-users count and add disable class when user is not the owner of the table",function(){this.vis.permission.owner=this.user,this.header.setInfo(),expect(this.header.$(".privacy i").hasClass("disabled")).toBeFalsy(),this.vis.permission.owner=new cdb.admin.User({id:"rambo2"}),this.vis.permission.acl.reset([{entity:{},type:"user",access:"r"}]),this.header.setInfo(),expect(this.header.$(".privacy i").hasClass("disabled")).toBeTruthy(),expect(this.header.$(".privacy i span.shared_users").length).toBe(0)}),it("shouldn't open 'privacy dialog' when user is not owner of the table/vis",function(){this.header.model.set("table",{id:1}),spyOn(cdb.editor.ChangePrivacyView.prototype,"initialize").and.callThrough(),this.header.setInfo(),this.header.$(".privacy i").click(),expect(cdb.editor.ChangePrivacyView.prototype.initialize).not.toHaveBeenCalled(),this.vis.permission.owner=this.user,this.header.setInfo(),this.header.$(".privacy i").click(),expect(cdb.editor.ChangePrivacyView.prototype.initialize).toHaveBeenCalled()}),it("shouldnt allow to edit table when user is not the owner",function(){this.vis.set("derived",!1),a.table.permission.owner=this.user,this.header.setInfo(),this.header.title_dialog=null,this.header.$("a.title").click(),expect(this.header.title_dialog).not.toEqual(null),this.header.title_dialog.clean(),a.table.permission.owner=new cdb.admin.User({id:"test_not_owner"}),this.header.setInfo(),this.header.title_dialog=null,this.header.$("a.title").click(),expect(this.header.title_dialog).toEqual(null)}),it("should show visualize button when visualization type is table",function(){expect($(this.header.el).find(".share span").text()).toBe("VISUALIZE")}),it("should change share button when visualization type is derived",function(){this.vis.set("type","derived"),expect($(this.header.el).find(".share span").text()).toBe("PUBLISH")}),it("should change href of back button when user belongs to an organization",function(){this.vis.set("type","derived"),expect(this.header.$("a.back").attr("href")).toBe("/dashboard/maps"),this.vis.set("type","table"),expect(this.header.$("a.back").attr("href")).toBe("/dashboard/datasets");var a=cdb.config.prefixUrl;cdb.config.prefixUrl=function(){return"/u/staging20"},this.header._setVisualization(),expect(this.header.$("a.back").attr("href")).toBe("/u/staging20/dashboard/datasets"),this.vis.set("type","derived"),expect(this.header.$("a.back").attr("href")).toBe("/u/staging20/dashboard/maps"),cdb.config.prefixUrl=a}),it("should create a new options dropdown menu each time link is clicked",function(){this.header.options.visualization=this.header.model,this.header.$(".dropdown").click();var a=this.header.options_menu.cid;this.header.$(".dropdown").click(),expect(a).not.toEqual(this.header.options_menu)}),it("should check sync info when data layer changes",function(){spyOn(this.header,"_setSyncInfo"),this.vis.map.layers.last().table.sqlView="",this.header.setActiveLayer({model:this.vis.map.layers.last()}),expect(this.header._setSyncInfo).toHaveBeenCalled()}),it("should redirect to a qualified table url if user is not the owner",function(){this.vis.set({table:{name:"untitled_table_9"}}),this.vis.permission=new cdb.admin.Permission({owner:{username:"paco",avatar_url:"http://test.com",id:10},acl:[]}),expect(this.header._generateTableUrl()).toBe("/tables/paco.untitled_table_9/table")}),it("should redirect to a normal table url if user is the owner",function(){this.vis.set({table:{name:"untitled_table_9"}}),this.vis.permission=new cdb.admin.Permission({owner:{username:"test",avatar_url:"http://test.com",id:2},acl:[]}),expect(this.header._generateTableUrl()).toBe("/tables/untitled_table_9/table")})}),describe("Header sync info",function(){beforeEach(function(){this.vis=new cdb.admin.Visualization({map_id:96,active_layer_id:null,name:"test_table",description:"Visualization description",tags:["jamon","probando","test"],privacy:"PUBLIC",updated_at:"2013-03-04T18:09:34+01:00",type:"table"}),cartodb_layer=new cdb.admin.CartoDBLayer({table_name:"test_table"}),this.vis.map.layers.reset([new cdb.geo.MapLayer,cartodb_layer]),this.user=TestUtil.createUser(),this.$header=$('<header><div class="sync_status"></div></header>'),this.header=new cdb.admin.Header({el:this.$header,globalError:{showError:{}},model:this.vis,user:this.user,config:TestUtil.config,geocoder:{}}),this.header.setActiveLayer(new cdb.admin.LayerPanelView({model:cartodb_layer,vis:this.vis,map:this.vis.map,user:this.user,globalError:{}}))}),afterEach(function(){this.header.clean(),this.$header.remove()}),it("shouldn't appear sync-info if table is not synced",function(){expect(this.header.$(".sync_status").html()).toBe("")}),it("should appear sync-info after table is synced",function(){this.header.dataLayer.table.synchronization.set({id:"test",from_external_source:!1}),expect(this.header.$(".sync_status").html()).not.toBe("")}),it("should show sync now button",function(){this.header.dataLayer.table.synchronization.set({ran_at:new Date("1980/2/2"),id:"test",state:"success",from_external_source:!1}),expect(this.header.$("a.sync_now").length).toBeTruthy()}),it("shouldn't show sync now button when is from external source",function(){this.header.dataLayer.table.synchronization.set({ran_at:new Date("1980/2/2"),id:"test",state:"success",from_external_source:!0}),expect(this.header.$("a.sync_now").length).toBeFalsy()}),it("shouldn't show sync now button",function(){this.header.dataLayer.table.synchronization.set({ran_at:new Date,id:"test",state:"success",from_external_source:!1}),expect(this.header.$("a.sync_now").length).toBeFalsy(),expect(this.header.$("em.sync_now_disabled").length).toBeTruthy()}),it("should open sync settings",function(){this.header.dataLayer.table.synchronization.set({ran_at:new Date,id:"test",state:"success",from_external_source:!1}),spyOn(cdb.editor.SyncView.prototype,"initialize").and.callThrough(),this.header.$("a.sync_options").click(),expect(cdb.editor.SyncView.prototype.initialize).toHaveBeenCalled()}),it("should show syncing mamufas",function(){this.header.dataLayer.table.synchronization.set({ran_at:new Date("1980/2/2"),id:"test",state:"success",from_external_source:!1}),this.header.$("a.sync_now").click(),expect(this.header.sync_info.sync_now).toBeDefined(),this.header.sync_info.sync_now.clean()}),it("shouldn't hide syncing mamufas",function(){this.header.dataLayer.table.synchronization.set({ran_at:new Date("1980/2/2"),id:"test",state:"success",from_external_source:!1}),this.header.$("a.sync_now").click();var a=jQuery.Event("keyup");a.keyCode=27,$(document).trigger(a),expect(this.header.sync_info.sync_now).toBeDefined(),expect(this.header.sync_info.sync_now.$el.html()).not.toBe(""),this.header.sync_info.sync_now.clean()}),it("shouldn't show syncing mamufas",function(){this.header.dataLayer.table.synchronization.set({ran_at:new Date,id:"test",state:"success",from_external_source:!1}),this.header.$("a.sync_now").click(),expect(this.header.sync_info.sync_now).not.toBeDefined()}),it("shouldn't display options when syncing is running",function(){this.header.dataLayer.table.synchronization.set({ran_at:new Date,id:"test",state:"syncing",from_external_source:!1}),expect(this.header.sync_info.$("a.sync_now").length).toBeFalsy(),expect(this.header.sync_info.$("a.sync_options").length).toBeFalsy()})}),describe("Header options menu",function(){var a,b,c;beforeEach(function(){this.vis=new cdb.admin.Visualization({map_id:96,active_layer_id:null,name:"test_table",description:"Visualization description",tags:["jamon","probando","test"],privacy:"PUBLIC",updated_at:"2013-03-04T18:09:34+01:00",type:"table",permission:{owner:{username:"staging20",avatar_url:"http://test.com",id:2}}}),c=new cdb.admin.CartoDBLayer({table_name:"test_table"}),c.table.permission=new cdb.admin.Permission({owner:{username:"staging20",avatar_url:"http://test.com",id:2},acl:[]}),this.vis.map.layers.reset([new cdb.geo.MapLayer,c]),this.user=TestUtil.createUser({username:"staging20"}),a=t=new cdb.admin.HeaderOptionsMenu({target:$("a.options"),model:this.vis,username:this.user.get("username"),private_tables:this.user.get("actions").private_tables,geocoder:{},dataLayer:c,user:this.user,template_base:"table/header/views/options_menu"})}),it("should open the menu options with table mode",function(){a.render(),expect(a.$el.find("li").size()).toEqual(7),expect(a.$el.find("div.progress-bar").size()).toEqual(1),expect(a.$el.find("li:contains('Duplicate dataset')").size()).toEqual(1)}),it("should create geocoding progress bar correctly",function(){a.render(),expect(Math.floor(a.$el.find("div.progress-bar .bar-2").width())).toEqual(20),expect(a.$el.find("div.progress-bar .bar-2").hasClass("danger")).toBeFalsy(),a.user.set("geocoding",{block_price:150,hard_limit:!1,monthly_use:4e3,quota:5e3}),a.render(),expect(Math.floor(a.$el.find("div.progress-bar .bar-2").width())).toEqual(80),expect(a.$el.find("div.progress-bar .bar-2").hasClass("caution")).toBeTruthy(),expect(a.$el.find("div.progress-bar .bar-2").hasClass("danger")).toBeFalsy(),a.user.set("geocoding",{block_price:150,hard_limit:!1,monthly_use:4999,quota:5e3}),a.render(),expect(Math.floor(a.$el.find("div.progress-bar .bar-2").width())).toEqual(99),expect(a.$el.find("div.progress-bar .bar-2").hasClass("caution")).toBeFalsy(),expect(a.$el.find("div.progress-bar .bar-2").hasClass("danger")).toBeTruthy()}),it("should show 'sync settings' option if table is synced in table mode",function(){c.table.synchronization.set("id","test"),a.render(),expect(a.$el.find("li:contains('Sync settings')").size()).toEqual(1)}),it("should show geocoding option disabled if table is synced in table mode",function(){c.table.synchronization.set("id","test"),a.render(),expect(a.$el.find("li:contains('Georeference')").hasClass("disabled")).toBeTruthy()}),it("should open the menu options with visualization mode",function(){this.vis.set("type","derived"),a.render(),expect(a.$el.find("li").size()).toEqual(7),expect(a.$el.find("li:contains('Export layer')").size()).toEqual(1),expect(a.$el.find("li:contains('Georeference layer')").size()).toEqual(1),expect(a.$el.find("li:contains('Duplicate map')").size()).toEqual(1),expect(a.$el.find("li:contains('Lock map')").size()).toEqual(1),expect(a.$el.find("li:contains('Change privacy')").size()).toEqual(1),expect(a.$el.find("li:contains('Delete map')").size()).toEqual(1)}),it("shouldn't display the 'Georeference layer' option if table has a sql applied in visualization mode",function(){this.vis.set("type","derived"),b=new cdb.admin.SQLViewData(null,{sql:"select * from test"}),c.set("query","select * from test"),this.vis.map.layers.last().table.useSQLView(b),a.render(),expect(a.$el.find("li").size()).toEqual(7),expect(a.$el.find("li:contains('Export layer')").size()).toEqual(1),expect(a.$el.find("li:contains('Dataset from query')").size()).toEqual(1),expect(a.$el.find("li:contains('Duplicate map')").size()).toEqual(1),expect(a.$el.find("li:contains('Lock map')").size()).toEqual(1),expect(a.$el.find("li:contains('Change privacy')").size()).toEqual(1),expect(a.$el.find("li:contains('Delete map')").size()).toEqual(1)}),it("shouldn't have disabled export and duplicate links if a query is applied in table mode",function(){b=new cdb.admin.SQLViewData(null,{sql:"select * from test"}),c.set("query","select * from test"),this.vis.map.layers.last().table.useSQLView(b),a.render(),expect(a.$el.find("li.disabled").size()).toEqual(0),expect(a.$el.find("li:contains('Dataset from query')").size()).toEqual(1)}),it("should have disabled export and duplicate links if a query is applied but it is not valid in table mode",function(){b=new cdb.admin.SQLViewData(null,{sql:"select * from test"}),this.vis.map.layers.last().table.useSQLView(b),a.render(),expect(a.$el.find("li.disabled").size()).toEqual(1),expect(a.$el.find("li:contains('Dataset from query')").size()).toEqual(1)}),it("shouldn't offer 'delete table' and 'change privacy' options if user is not the owner",function(){c.table.permission=new cdb.admin.Permission({owner:{username:"test",avatar_url:"http://test.com",id:10}}),a.render(),expect(a.$("li a:contains('Change privacy')").length).toBe(0),expect(a.$("li a:contains('Sync settings')").length).toBe(0),expect(a.$("li a:contains('Delete this dataset')").length).toBe(0)}),it("shouldn't offer 'delete map' or 'change privacy' if user is not the owner",function(){this.vis.set("type","derived"),this.vis.permission=new cdb.admin.Permission({owner:{username:"test",avatar_url:"http://test.com",id:10}}),a.render(),expect(a.$("li a:contains('Delete map')").length).toBe(0),expect(a.$("li a:contains('Change privacy')").length).toBe(0)}),it("shouldn't have disabled any option if a query is applied in visualization mode",function(){this.vis.set("type","derived"),b=new cdb.admin.SQLViewData(null,{sql:"select * from test"}),this.vis.map.layers.last().table.useSQLView(b),a.render(),expect(a.$el.find("li.disabled").size()).toEqual(0),expect(a.$el.find("li:contains('Duplicate map')").size()).toEqual(1),expect(a.$el.find("li:contains('Delete map')").size()).toEqual(1)})}),describe("MapInfowindow",function(){function a(a){beforeEach(function(){var b=new cdb.admin.Map,c=new a({map:b,user:new cdb.admin.User}),d=new cdb.geo.ui.InfowindowModel({fields:[{name:"name",title:!0,position:0},{name:"length",position:1,title:!0}]}),e=new cdb.admin.CartoDBTableMetadata({name:"testTable",schema:[["name","lorem ipsum"],["description","dolor sit amet"],["length",4]]});this.view=new cdb.admin.MapInfowindow({model:d,mapView:c,table:e}),this.view.row={attributes:{name:"lorem ipsum",length:4}},spyOn(this.view,"setLoading"),this.view.renderInfo()}),it("should update the model with fields including the length one",function(){expect(this.view.model.get("fields")[0].name).toContain("name"),expect(this.view.model.get("fields")[1].name).toContain("length")}),it("should not set loading",function(){expect(this.view.setLoading).not.toHaveBeenCalled()})}describe("leaflet",function(){a(cdb.admin.LeafletMapView)})}),describe("cdb.admin.LayerPanelView",function(){var a,b,c,d,e,f;beforeEach(function(){d=new cdb.admin.User({username:"testusername",api_key:"rabos"}),f=new cdb.admin.Visualization({id:"abcde",map_id:96,name:"test_table",privacy:"PUBLIC",type:"table"}),b=f.map;var g=new cdb.admin.GlobalError({el:$("<div>")});e=new cdb.admin.CartoDBLayer({table_name:"test",id:10,visible:"true"}),c=e.table,b.layers.add(e),this.createView=function(){a&&a.clean(),a=new cdb.admin.LayerPanelView({model:e,vis:f,map:b,user:d,globalError:g})},this.createView()}),it("should show UI features that might be disabled by default",function(){expect(a.$(".sql_mod")[0]).toBeDefined(),expect(a.$(".cartocss_mod")[0]).toBeDefined()}),describe("when some UI features are disabled",function(){beforeEach(function(){d.set("feature_flags",["disabled_ui_sql","disabled_ui_cartocss"]),this.createView()}),it("should now show the SQL or CartoCSS modules",function(){expect(a.$(".sql_mod")[0]).not.toBeDefined(),expect(a.$(".cartocss_mod")[0]).not.toBeDefined()})}),it("should add stat_tag to the layer",function(){expect(e.get("stat_tag")).toEqual(f.get("id"))}),it("should use no_cdn",function(){expect(e.get("no_cdn")).toEqual(!1)}),it("should the layer",function(){expect(e.get("force_cors")).toEqual(!0)}),it("should add map_key in layer",function(){expect(e.get("extra_params").map_key).toEqual("rabos")}),it("should add layer-type",function(){expect(a.$el.attr("layer-type")).toEqual("cartodb"),e.set("type","ToRquE"),expect(a.$el.attr("layer-type")).toEqual("torque")}),it("should hide/show the layer",function(){a.hide(),expect(a.$(".layer-sidebar").css("display")).toEqual("none"),expect(a.$(".layer-views").css("display")).toEqual("none"),a.show(),expect(a.$(".layer-sidebar").css("display")).toEqual("block"),expect(a.$(".layer-views").css("display")).toEqual("block")}),it("visiblity switch should be hidden if there is only a layer",function(){expect(a.$(".switch").css("display")).toEqual("none"),b.layers.reset(),e=new cdb.admin.CartoDBLayer({table_name:"test",id:12,visible:"true"}),layer2=new cdb.admin.CartoDBLayer({table_name:"test2",id:13,visible:"true"}),b.layers.add(e),b.layers.add(layer2),expect(a.$(".switch").css("display")).not.toEqual("none"),b.layers.remove(e),expect(a.$(".switch").css("display")).toEqual("none")}),describe("layer initialization",function(){beforeEach(function(){}),it("should have 6 modules + 4 action buttons",function(){expect(a.buttons.length).toBe(10)})}),describe("buttons behavior",function(){it("should show all the buttons when no sql is applied",function(){a.setActiveWorkView("table");var b=_(a.enabledButtonsForSection("table")).filter(function(a){return"none"!=a.$el.css("display")});expect(b.length).toEqual(5),a.setActiveWorkView("map");var b=_(a.enabledButtonsForSection("map")).filter(function(a){return"none"!=a.$el.css("display")});expect(b.length).toEqual(7)}),it("should show/hide buttons on sync table",function(){a.setActiveWorkView("table");var b=_(a.enabledButtonsForSection("table")).filter(function(a){return"none"!=a.$el.css("display")});expect(b.length).toEqual(5),c.synchronization.set("id",1);var b=_(a.enabledButtonsForSection("table")).filter(function(a){return"none"!=a.$el.css("display")});expect(b.length).toEqual(2),c.synchronization.unset("id");var b=_(a.enabledButtonsForSection("table")).filter(function(a){return"none"!=a.$el.css("display")});expect(b.length).toEqual(5)}),it("should show readonly buttons when sql is applied",function(){c.useSQLView(a.sqlView),a.setActiveWorkView("table");var b=_(a.enabledButtonsForSection("table")).filter(function(a){return"none"!=a.$el.css("display")});expect(b.length).toEqual(2),a.setActiveWorkView("map");var b=_(a.enabledButtonsForSection("map")).filter(function(a){return"none"!=a.$el.css("display")});expect(b.length).toEqual(6)}),it("should change to readonly buttons when sql is applied",function(){c.useSQLView(a.sqlView),a.setActiveWorkView("table"),a.sqlView.modify_rows=!1,a.sqlView.trigger("reset");var b=_(a.enabledButtonsForSection("table")).filter(function(a){return"none"!=a.$el.css("display")});expect(b.length).toEqual(2)}),it("should change to readonly buttons when table is read only",function(){c.setReadOnly(!0),a._checkButtons();var b=_(a.enabledButtonsForSection("table")).filter(function(a){return"none"!=a.$el.css("display")});expect(b.length).toEqual(2),a.setActiveWorkView("map"),b=_(a.enabledButtonsForSection("map")).filter(function(a){return"none"!=a.$el.css("display")}),expect(b.length).toEqual(6)})}),describe("layer info",function(){it("should set layer name, order and options",function(){expect(a.$(".layer-info .info .name").text()).toBe("test"),expect(a.$(".layer-info .info .order").text()).toBe("1"),expect(a.$(".layer-info div.right").css("display")).toBe("none")}),it("should show layer option buttons if the visualization is the type derived",function(){a.vis.set("type","derived"),expect(a.$(".layer-info div.right").css("display")).toBe("block")}),it("should set layer tooltip if the visualization is the type derived",function(){a.vis.set("type","derived"),expect(a.$(".layer-info .info .name").data("tipsy").enabled).toBeTruthy()}),it("shouldn't set layer tooltip if the visualization is the type table",function(){expect(a.$(".layer-info .info .name").data("tipsy")).toBeFalsy()}),it("should change the layer name if it changes",function(){a.dataLayer.set("table_name","jam"),expect(a.$(".layer-info .info .name").text()).toBe("jam")}),it("shouldn't change the layer order if it changes, due to the visualization is the type table",function(){a.dataLayer.set("order","4"),expect(a.$(".layer-info .info .order").text()).toBe("1")}),it("should change the layer order if it changes",function(){var c=new cdb.admin.CartoDBLayer({table_name:"test",id:11,visible:"true"});b.layers.add(c,{at:0}),a.vis.set("type","derived"),a.setLayerOrder(a.dataLayer),expect(a.$(".layer-info .info .order").text()).toBe("1")}),it("should add alias if the layer is in a visualization",function(){a.vis.set("type","derived"),a.setLayerName(a.dataLayer),expect(a.$(".layer-info .info .name").text()).toBe("test"),expect(a.$(".layer-info .info .order").text()).toBe("1"),expect(a.$(".layer-info .info .name_info").text()).toBe("view of test")}),it("should add alias if the layer is in a visualization",function(){a.vis.set("type","derived"),a.model.set("table_name","test_jamon"),a.setLayerName(a.dataLayer),expect(a.$(".layer-info .info .name").text()).toBe("test jamon"),expect(a.$(".layer-info .info .order").text()).toBe("1"),expect(a.$(".layer-info .info .name_info").text()).toBe("view of test_jamon")}),it("should be able to change alias if layer is in a visualization",function(){a.vis.set("type","derived"),a.$(".layer-info .info .name").dblclick(),expect(a.$(".layer-info input.alias").css("display")).not.toBe("none")}),it("should add sync-table icon if table is synced and layer is in a visualization",function(){a.vis.set("type","derived"),a.table.synchronization.set("id","test"),expect(a.$(".layer-info .info .name i.synced").length).toBe(1)}),it("shouldn't add sync-table icon if table is synced but layer is not in a visualization",function(){a.table.synchronization.set("id","test"),a.vis.set("type","table"),expect(a.$(".layer-info .info .name i.synced").length).toBe(0)}),it("shouldn't be able to change alias if layer is NOT in a visualization",function(){a.$(".layer-info .info .name").dblclick(),expect(a.$(".layer-info input.alias").is(":visible")).toBe(!1)})}),describe("layer actions",function(){beforeEach(function(){a.vis.set("type","derived")}),it("should remove the layer",function(){a.$("a.remove").trigger("click");var b=!1;a.bind("delete",function(){b=!0}),a.trigger("delete",this),expect(b).toBeTruthy()}),it("should toggle the layer",function(){a.$("a.visibility").trigger("click"),expect(a.model.get("visible")).toBeFalsy()}),it("should appear visibility message if toggles the layer",function(){a.$("a.visibility").trigger("click"),expect(a.model.get("visible")).toBeFalsy(),expect(a.$(".info.warning").length).toBe(1),a.$("a.visibility").trigger("click"),expect(a.model.get("visible")).toBeTruthy(),expect(a.$(".info.warning").length).toBe(0)}),it("should hide infowindow if hides the layer",function(){a.model.infowindow.set("visibility",!0),a.$("a.visibility").trigger("click"),expect(a.model.infowindow.get("visibility")).toBeFalsy()}),it("should active the layer",function(){var b=!1;a.bind("switchTo",function(){b=!0}),a.$(".info").trigger("click"),expect(b).toBeTruthy()}),it("shouldn't remove a layer if visualization is a table type",function(){a.vis.set("type","table"),a.$("a.remove").trigger("click"),expect(a.remove_dlg).toBe(void 0)}),it("shouldn't change layer visibility if visualization is a table type",function(){a.vis.set("type","table"),a.$("a.visibility").trigger("click"),expect(a.model.get("visible")).toBeTruthy()}),it("should open scratch view",function(){spyOn(cdb.editor.ScratchView.prototype,"initialize").and.callThrough(),a.$(".add_feature").click(),expect(cdb.editor.ScratchView.prototype.initialize).toHaveBeenCalled()}),describe("when a model is added/removed",function(){beforeEach(function(){a.model.set("visible",!1),a.model.collection.add(new cdb.admin.CartoDBLayer({table_name:"test",id:11,visible:"true"})),a.model.collection.add(new cdb.admin.CartoDBLayer({table_name:"test",id:12,visible:"true"}))}),it("should keep layer visibility of existing layer",function(){expect(a.$(".visibility.switch").hasClass("disabled")).toBe(!0),expect(a.$(".visibility.switch").hasClass("enabled")).toBe(!1),a.model.collection.remove(a.model.collection.last()),expect(a.$(".visibility.switch").hasClass("disabled")).toBe(!0),expect(a.$(".visibility.switch").hasClass("enabled")).toBe(!1)}),it("should only show switch if there is only one data layer",function(){expect(a.$(".visibility.switch").attr("style")).not.toContain("none"),
b.layers.pop(),b.layers.pop(),expect(a.$(".visibility.switch").attr("style")).toContain("display: none")})})}),describe("when model is destroyed",function(){beforeEach(function(){this.destroySpy=jasmine.createSpy("destroy"),a.bind("destroy",this.destroySpy),a.model.destroy()}),it("should trigger a destroy event with the view cid its dataLayer as param",function(){expect(this.destroySpy).toHaveBeenCalled(),expect(this.destroySpy).toHaveBeenCalledWith(a.dataLayer.cid)})}),it("should not have leaks",function(){expect(a).toHaveNoLeaks()})}),describe("drawer",function(){beforeEach(function(){var a=cdb.geo.LeafletMapView;mapView=new a({el:$("<div>"),map:new cdb.geo.Map})}),it("should create a polygon",function(){var a=new PolygonDrawTool({mapview:mapView});a.start(),mapView.trigger("click",null,[0,0]),mapView.trigger("click",null,[0,1]),mapView.trigger("click",null,[1,1]),mapView.trigger("click",null,[2,3]),expect(a.getGeoJSON()).toEqual({type:"MultiPolygon",coordinates:[[[[0,0],[1,0],[1,1],[3,2],[0,0]]]]})}),it("should create a line",function(){var a=new PolylineDrawTool({mapview:mapView});a.start(),mapView.trigger("click",null,[0,0]),mapView.trigger("click",null,[0,1]),mapView.trigger("click",null,[1,1]),mapView.trigger("click",null,[2,3]),expect(a.getGeoJSON()).toEqual({type:"MultiLineString",coordinates:[[[0,0],[1,0],[1,1],[3,2]]]})}),it("should create a point",function(){var a=new PointDrawTool({mapview:mapView});a.start(),mapView.trigger("click",null,[0,1]),expect(a.getGeoJSON()).toEqual({type:"Point",coordinates:[1,0]})})}),describe("export_image_result_view",function(){beforeEach(function(){this.filenameRegexp="[\\S]+_by_[\\S]+_\\d\\d_\\d\\d_\\d\\d\\d\\d_\\d\\d_\\d\\d_\\d\\d",this.url="https://carto.com",this.vis=new cdb.admin.Visualization({type:"derived",name:"my name"}),this.view=new cdb.editor.ExportImageResultView({vis:this.vis,clean_on_hide:!0,enter_to_confirm:!1,user:TestUtil.createUser("jamon"),x:0,y:0,format:"png",width:100,height:100}),spyOn(this.view,"_loadMapImage").and.callFake(function(a,b){return b(a)}),spyOn(this.view,"_mergeAnnotations").and.returnValue("url"),this.view.render()}),afterEach(function(){this.view.clean()}),it("should render the result view",function(){this.view.generateImage(this.url),expect(this.view.$(".js-open-image").length).toBe(1),expect(this.innerHTML()).toContain("Your image has been generated correctly"),expect(this.view.$("p.Dialog-headerText").html()).toMatch("It's now available in: <a href=\""+this.url+'" target="_blank" class="ExportImageResult--url" download="'+this.filenameRegexp+'">'+this.filenameRegexp+".png</a>")}),it("should close the dialog when clicking on the view image link",function(){this.view.generateImage(this.url);var a=!1;this.view.bind("hide",function(){a=!0}),this.view.$(".js-open-image").click(),expect(a).toBe(!0)}),it("should trigger a finish event",function(){var a=!1;this.view.bind("finish",function(){a=!0}),this.view.generateImage(this.url),expect(a).toBe(!0)}),it("should generate exported image filename correctly",function(){var a=this.view._generateImageFilename();expect(a).toMatch(this.filenameRegexp)})}),describe("ExportImage",function(){describe("cdb.admin.ExportImageView",function(){beforeEach(function(){this.map=new cdb.geo.Map,this.container=$("<div>").css({width:"500px",height:"500px"}),this.mapView=new cdb.geo.LeafletMapView({el:this.container,map:this.map}),this.pixelToLatLon=sinon.stub(this.mapView,"pixelToLatLon"),this.pixelToLatLon.returns([10,20]),this.fakeSpy=jasmine.createSpyObj("cdb",["size","getUrl","format","zoom","center"]),spyOn(cdb,"Image").and.returnValue(this.fakeSpy),this.fakeSpy.center.and.returnValue(this.fakeSpy),this.fakeSpy.zoom.and.returnValue(this.fakeSpy),this.fakeSpy.format.and.returnValue(this.fakeSpy),this.fakeSpy.size.and.returnValue(this.fakeSpy),this.fakeSpy.getUrl.and.returnValue(this.fakeSpy),this.vis=new cdb.admin.Visualization({map_id:96,active_layer_id:null,name:"test_table",description:"Visualization description",tags:["jamon","probando","test"],privacy:"PUBLIC",updated_at:"2013-03-04T18:09:34+01:00",type:"table",permission:{owner:{username:"staging20",avatar_url:"http://test.com",id:2}}}),this.header=new cdb.admin.models.Overlay({type:"header",display:!0,show_title:!0,show_description:!0,title:"Map title",description:"Map description"}),this.zoomOverlay=new cdb.admin.models.Overlay({type:"zoom",display:!0}),this.searchOverlay=new cdb.admin.models.Overlay({type:"search",display:!0}),this.overlays=new Backbone.Collection([this.header,this.zoomOverlay,this.searchOverlay]),this.vis.overlays=this.overlays,this.canvas=new cdb.core.Model({mode:"desktop"}),this.overlays=new cdb.admin.MapOverlays({vis:this.vis,canvas:this.canvas,mapView:this.mapView,master_vis:this.vis}),this.view=new cdb.admin.ExportImageView({vizjson:"vizjson_url",mapView:this.mapView,vis:this.vis,overlays:this.overlays,map:this.map,width:500,height:400}),this.view.render()}),afterEach(function(){this.view.clean()}),it("should render",function(){expect(this.view.$(".ExportHelper--header").length).toBe(1),expect(this.view.$(".ExportHelper--north").length).toBe(1),expect(this.view.$(".ExportHelper--south").length).toBe(1),expect(this.view.$(".ExportHelper--west").length).toBe(1),expect(this.view.$(".ExportHelper--east").length).toBe(1),expect(this.view.$(".js-ok").length).toBe(1),expect(this.view.$(".ExportImageView--help").text()).toBe("Adjust zoom level and canvas size to fit the area you want to export."),expect(this.view.$(".js-title").text()).toBe("Map title"),expect(this.view.$(".js-description").text()).toBe("Map description")}),it("should enable the resizable",function(){expect(this.view.$(".CanvasExport").hasClass("ui-resizable")).toBe(!0)}),it("should hide the overlays",function(){expect(this.overlays.getOverlay("search").get("display")).toBe(!1),expect(this.overlays.getOverlay("header").get("display")).toBe(!1)}),it("shouldn't hide the zoom overlays",function(){expect(this.overlays.getOverlay("zoom").get("display")).toBe(!0)}),it("should add the right classes depending on the dimensions",function(){this.view._updateHelpers(0,0,100,100),expect(this.view.$(".CanvasExport").hasClass("is-small")).toBe(!0),expect(this.view.$(".CanvasExport").hasClass("is-top")).toBe(!0),this.view._updateHelpers(0,400,100,100),expect(this.view.$(".CanvasExport").hasClass("is-top")).toBe(!1),expect(this.view.$(".CanvasExport").hasClass("is-bottom")).toBe(!0),this.view._updateHelpers(0,400,100,100),expect(this.view.$(".CanvasExport").hasClass("is-top")).toBe(!1),expect(this.view.$(".CanvasExport").hasClass("is-bottom")).toBe(!0)}),it("should set the default dimensions in the custom model",function(){expect(this.view.model.get("x")).toBe(cdb.admin.ExportImageView.prototype.defaults.top),expect(this.view.model.get("y")).toBe(cdb.admin.ExportImageView.prototype.defaults.left),expect(this.view.model.get("width")).toBe(410),expect(this.view.model.get("height")).toBe(270)}),it("should set the width and height input fields",function(){expect(+this.view.$(".js-width").val()).toBe(410),expect(+this.view.$(".js-height").val()).toBe(270)}),it("should update the width and height input fields when the model changes",function(){this.view.model.set({width:100,height:50}),expect(+this.view.$(".js-width").val()).toBe(100),expect(+this.view.$(".js-height").val()).toBe(50)}),it("should update the width by using the up key",function(){this.view.model.set({x:50,y:50,width:100,height:50});var a=$.Event("keyup");a.keyCode=$.ui.keyCode.UP,a.target=this.view.$(".js-width")[0],this.view.$(".js-width").trigger(a),expect(+this.view.$(".js-width").val()).toBe(101),expect(this.view.model.get("width")).toBe(101)}),it("should update the height by using the up key",function(){this.view.model.set({x:50,y:50,width:100,height:50});var a=$.Event("keyup");a.keyCode=$.ui.keyCode.UP,a.target=this.view.$(".js-height")[0],this.view.$(".js-height").trigger(a),expect(+this.view.$(".js-height").val()).toBe(51),expect(this.view.model.get("height")).toBe(51)}),it("should update the width by using the down key",function(){this.view.model.set({x:50,y:50,width:100,height:50});var a=$.Event("keyup");a.keyCode=$.ui.keyCode.DOWN,a.target=this.view.$(".js-width")[0],this.view.$(".js-width").trigger(a),expect(+this.view.$(".js-width").val()).toBe(99),expect(this.view.model.get("width")).toBe(99)}),it("should update the height by using the down key",function(){this.view.model.set({x:50,y:50,width:100,height:50});var a=$.Event("keyup");a.keyCode=$.ui.keyCode.DOWN,a.target=this.view.$(".js-height")[0],this.view.$(".js-height").trigger(a),expect(+this.view.$(".js-height").val()).toBe(49),expect(this.view.model.get("height")).toBe(49)}),it("should add a class when the window is too small",function(){this.view.model.set({width:700}),expect(this.view.$el.hasClass("is-small")).not.toBeTruthy(),this.view.model.set({width:100}),expect(this.view.$el.hasClass("is-small")).toBeTruthy()}),it("changing the format should be reflected on the UI",function(){this.view.model.set({format:"jpg"}),expect(this.view.$(".js-formatName").text()).toBe(".jpg")}),it("should change the helpers dimensions when the stored dimesions are changed",function(){this.view.model.set({x:50,y:50,width:200,height:200}),expect(this.view.$(".js-helper-north").css("top")).toBe("0px"),expect(this.view.$(".js-helper-north").width()).toBe(251),expect(this.view.$(".js-helper-north").height()).toBe(51),expect(this.view.$(".js-helper-west").css("left")).toBe("0px"),expect(this.view.$(".js-helper-west").css("top")).toBe("51px"),expect(this.view.$(".js-helper-west").width()).toBe(51),expect(this.view.$(".js-helper-west").height()).toBe(200),expect(this.view.$(".js-helper-south").css("left")).toBe("0px"),expect(this.view.$(".js-helper-south").css("top")).toBe("251px"),expect(this.view.$(".js-helper-south").width()).toBe(this.view.options.mapView.$el.width()),expect(this.view.$(".js-helper-south").height()).toBe(this.view.options.mapView.$el.height()-200+50),expect(this.view.$(".js-helper-east").css("left")).toBe("251px"),expect(this.view.$(".js-helper-east").css("top")).toBe("0px"),expect(this.view.$(".js-helper-east").width()).toBe(this.view.options.mapView.$el.width()-200),expect(this.view.$(".js-helper-east").height()).toBe(251)}),it("should attempt to generate an image with the right dimensions",function(){this.view.$(".js-ok").click(),expect(this.fakeSpy.size.calls.argsFor(0)[0]).toEqual(410),expect(this.fakeSpy.size.calls.argsFor(0)[1]).toEqual(270),expect(this.fakeSpy.zoom.calls.argsFor(0)[0]).toEqual(this.map.get("zoom"))}),it("should update the title and description",function(){this.vis.set({name:"New map title",description:"New map description"}),expect(this.view.$(".js-title").text()).toBe("New map title"),expect(this.view.$(".js-description").text()).toBe("New map description")})}),describe("cdb.admin.AdvancedExportView",function(){afterEach(function(){this.view.clean()}),beforeEach(function(){this.map=new cdb.geo.Map,this.container=$("<div>").css({width:"200px",height:"200px"}),this.mapView=new cdb.geo.LeafletMapView({el:this.container,map:this.map}),spyOn(this.mapView,"pixelToLatLon").and.returnValue({lat:20,lng:30}),this.vis=new cdb.admin.Visualization({map_id:96,active_layer_id:null,name:"test_table",description:"Visualization description",tags:["jamon","probando","test"],privacy:"PUBLIC",updated_at:"2013-03-04T18:09:34+01:00",type:"table",permission:{owner:{username:"staging20",avatar_url:"http://test.com",id:2}}}),this.view=new cdb.editor.AdvancedExportView({mapView:this.mapView,x:100,y:20,width:500,height:400}),this.view.render()}),it("should have png as the default format",function(){expect(this.view.$(".is-checked").parent().data("format")).toBe("png")}),it("should show the current mapview dimensions",function(){expect(this.view.$(".js-width").val()).toBe("500"),expect(this.view.$(".js-height").val()).toBe("400")}),it("should have a model populated with the default data",function(){expect(this.view.model.get("width")).toBe(500),expect(this.view.model.get("height")).toBe(400)}),it("should allow to specify the default format",function(){var a=new cdb.editor.AdvancedExportView({vis:this.vis,x:100,y:20,width:500,height:400,format:"jpg"});a.render(),expect(a.$(".is-checked").parent().data("format")).toBe("jpg")}),it("should return the right params to build the image",function(a){this.view.bind("generate_image",function(b){expect(b.width).toBe(123),expect(b.height).toBe(321),expect(b.format).toBe("jpg");var c=b.bounds;expect(c[0][0]).toBe(20),expect(c[0][1]).toBe(30),expect(c[1][0]).toBe(20),expect(c[1][1]).toBe(30),a()},this),this.view.$(".js-jpg").click(),this.view.$(".js-width").val(123),this.view.$(".js-height").val(321),this.view.$(".js-ok").click()})})}),describe("map_options_dropdown",function(){beforeEach(function(){var a=TestUtil.createTable("test"),b=TestUtil.createVis("jam");this.user=TestUtil.createUser("jamon"),master_vis=TestUtil.createVis("jam");var c=new cdb.admin.Map,d=new cdb.admin.CartoDBLayer({table_name:"test",tile_style:"test",user_name:"test"});c.layers.add(d),c.layers.add(new cdb.admin.CartoDBLayer({table_name:"test2",tile_style:"style",user_name:"test"}));var e=$('<div><div class="cartodb-map"></div></div>');e.appendTo($("body")),view=new cdb.admin.MapTab({user:this.user,model:c,vis:b,master_vis:master_vis,menu:new cdb.admin.RightMenu({}),geocoder:new cdb.admin.Geocoding("",a),el:e,baseLayers:new cdb.admin.Layers([new cdb.admin.TileLayer({urlTemplate:"rabos"})])}),this.header=new cdb.core.Model({order:1,shareable:!1,description:"Description",title:"Hello!",type:"header",url:null,extra:{description:"Description",title:"Hello!",show_title:!0,show_description:!0}}),this.overlays=new Backbone.Collection([this.header,new cdb.core.Model({device:"screen",type:"text",style:{"z-index":9}}),new cdb.core.Model({type:"text",device:"screen",style:{"z-index":2}})]);var f=new cdb.core.Model({mode:"desktop"});this.view=new cdb.admin.MapOptionsDropdown({target:$(".show-table-options"),template_base:"table/views/map_options_dropdown",table:a,model:c,mapview:this.mapView,collection:this.overlays,user:this.user,vis:b,canvas:f,position:"position",tick:"left",vertical_position:"up",horizontal_position:"left",horizontal_offset:"-3px"})}),it("should render the dropdown",function(){this.view.render(),expect(this.view.$(".switches li").length).toEqual(9)}),it("should change disabled the description option when show_description is false ",function(){this.view.render(),expect(this.view.$(".switches li.description").hasClass("active")).toBe(!0);var a=this.header.get("extra");a.show_description=!1,this.header.set({extra:a,description:""}),expect(this.view.$(".switches li.description").hasClass("active")).toBe(!1)})}),describe("mapview",function(){var a,b,c;beforeEach(function(){var d=TestUtil.createTable("test"),e=TestUtil.createVis("jam");c=TestUtil.createVis("jam");var f=new cdb.admin.Map,g=new cdb.admin.CartoDBLayer({table_name:"test",tile_style:"test",user_name:"test",attribution:"attribution1"});f.layers.add(g),f.layers.add(new cdb.admin.CartoDBLayer({table_name:"test2",tile_style:"style",user_name:"test",attribution:"attribution2"}));var h=$('<div><div class="cartodb-map"></div></div>');h.appendTo($("body")),a=new cdb.admin.MapTab({user:TestUtil.createUser("jamon"),model:f,vis:e,master_vis:c,menu:new cdb.admin.RightMenu({}),geocoder:new cdb.admin.Geocoding("",d),el:h,baseLayers:new cdb.admin.Layers([new cdb.admin.TileLayer({urlTemplate:"rabos"})])}),a.enableMap(),b=new cdb.admin.LayerPanelView({model:g,vis:TestUtil.createVis(),user:TestUtil.createUser("jamon"),globalError:new cdb.admin.GlobalError({el:$("<div>")})}),a.setActiveLayer(b)}),afterEach(function(){a.options.geocoder.dlg&&a.options.geocoder.dlg.hide(),a.noGeoRefDialog&&a.noGeoRefDialog.clean(),a.pecanDialog&&a.pecanDialog.clean(),localStorage.clear(),a.remove(),$(".dropdown").remove()}),it("should render the map container",function(){a.render(),expect(a.$(".cartodb-map").length).toEqual(1)}),it("should render the basemap_dropdown",function(){a.render(),expect(a.$(".basemap_dropdown").length).toEqual(1)}),xit("should trigger the georef warning when none of the rows contain geom info",function(){a.table=TestUtil.createTable("test",[["the_geom","geometry"],["name","string"]],[]),a.table._data.reset([{the_geom:"",name:"Benidorm"},{the_geom:"",name:"San Juan"}]),a.bindGeoRefCheck(),a.render(),a.table.trigger("dataLoaded"),expect(a.noGeoRefDialog).toBeTruthy()}),xit("should trigger the georef warning only once when there is no geom in the table",function(){a.table=TestUtil.createTable("test",[["the_geom","geometry"],["name","string"]],[]),a.table._data.reset([{the_geom:"",name:"Benidorm"}]),a.bindGeoRefCheck(),a.render(),a.table.trigger("dataLoaded"),a.noGeoRefDialog.clean(),a.noGeoRefDialog=void 0,a.table.trigger("dataLoaded"),expect(void 0===a.noGeoRefDialog).toEqual(!0)}),xit("should trigger the georef warning when there is no geom in the table and there was a table with the same name in the past",function(){a.table=TestUtil.createTable("test",[["the_geom","geometry"],["name","string"]],[],"12345"),a.table._data.reset([{the_geom:"",name:"Benidorm"}]),a.bindGeoRefCheck(),a.render(),a.table.trigger("dataLoaded"),expect(void 0===a.noGeoRefDialog).toEqual(!1),a.noGeoRefDialog.clean(),a.noGeoRefDialog=void 0,a.table=TestUtil.createTable("test",[["the_geom","geometry"]],[],"45678"),a.table._data.reset([{the_geom:""}]),a.bindGeoRefCheck(),a.table.trigger("dataLoaded"),expect(void 0===a.noGeoRefDialog).toEqual(!1)}),it("should NOT trigger the georef warning when there is no data in the table",function(){a.table=TestUtil.createTable("test",[["the_geom","geometry"]],[]),a.bindGeoRefCheck(),a.render(),a.table.trigger("dataLoaded"),expect(void 0===a.noGeoRefDialog).toEqual(!0)}),it("should NOT trigger the georef warning when there is some data with geom info",function(){a.table=TestUtil.createTable("test",[["the_geom","geometry"],["name","string"]],[]),a.table._data.reset([{the_geom:'{"type":"Point","coordinates":["1","1"]}',name:"Benidorm"},{the_geom:"",name:"San Juan"}]),a.bindGeoRefCheck(),a.render(),a.table.trigger("dataLoaded"),expect(void 0===a.noGeoRefDialog).toEqual(!0)}),it("should trigger the no-geo warning when there is data without geom info and it is in read-only mode",function(){a.table=TestUtil.createTable("test",[["the_geom","geometry"],["name","string"]],[],"12345"),spyOn(a.table,"isSync").and.returnValue(!0),spyOn(a.table,"data").and.returnValue(["hello"]),a.bindGeoRefCheck(),a.render(),a.table.trigger("dataLoaded"),expect(void 0===a.noGeoRefDialog).toEqual(!0),expect(void 0===a.noGeoWarningDialog).toEqual(!1)}),it("should have a geocoding binding each time map view is rendered",function(){a.render(),spyOn(a.layerModel.table,"fetch"),a.options.geocoder.trigger("geocodingComplete"),expect(a.layerModel.table.fetch).not.toHaveBeenCalled(),a.clearMap(),a.render(),a.options.geocoder.trigger("geocodingComplete"),expect(a.layerModel.table.fetch).not.toHaveBeenCalled(),expect(a.layerModel.table.fetch.calls.count()).toBe(0)}),it("should bind new geometry event in the current layer view",function(){spyOn(a.geometryEditor,"createGeom"),b.model.trigger("startEdition","point"),expect(a.geometryEditor.createGeom).toHaveBeenCalled()}),it("should bind new geometry event in the current layer view",function(){spyOn(a.geometryEditor,"createGeom"),b.model.trigger("startEdition","point"),expect(a.geometryEditor.createGeom).toHaveBeenCalled()}),it("should switch map type when master vis change type",function(){c.set("type","table"),spyOn(a,"switchMapType"),c.set("type","derived"),expect(a.switchMapType).toHaveBeenCalled()}),it("should render attributions of each layer and default CARTO attribution",function(){var b=a.$el.find(".leaflet-control-attribution").html();expect(b).toEqual('attribution1, attribution2, © <a href="https://carto.com/attributions" target="_blank">CARTO</a>')}),describe("cdb.admin.MapTab.updateDataLayerView",function(){describe("given MapTab view has a cdb.CartoDB.Layer as data layer view",function(){beforeEach(function(){spyOn(a.layerDataView,"invalidate"),a.updateDataLayerView()}),it("should invalidate the data layer view (e.g. to reload tiles)",function(){expect(a.layerDataView.invalidate).toHaveBeenCalled()})})})}),describe("mod.carto",function(){describe("editor",function(){var a,b;beforeEach(function(){b=new cdb.admin.CartoDBLayer({tile_style:"#test { polygon-fill: #FFF; }\n"}),a=new cdb.admin.mod.CartoCSSEditor({model:b})}),it("should render style from model",function(){a.render(),expect(a.codeEditor.getValue()).toEqual(b.get("tile_style"))}),it("should update style from model",function(){a.render(),b.set({tile_style:"#test { polygon-fill: #F00; }\n"}),expect(a.codeEditor.getValue()).toEqual(b.get("tile_style"))}),it("should send Map rules as well",function(){var a=new cdb.admin.CartoDBLayer({tile_style:"Map{ buffer-size: 30; }\n"}),b=new cdb.admin.mod.CartoCSSEditor({model:a});b.render(),expect(b.model.wizard_properties.layer.attributes.tile_style.indexOf("buffer-size: 30;")>-1)}),it("should parse errors",function(){var b=["style.mss:11:2 Invalid code: asdasd","style.mss:7:2 Invalid code: asdasdasda","style.mss:7:2 Invalid code: asdasdasda","blablabla balball balbla"],c=a._parseError(b);expect(c).toEqual([{line:null,message:"blablabla balball balbla"},{line:7,message:"Invalid code: asdasdasda"},{line:11,message:"Invalid code: asdasd"}])}),it("should detect when the cartocss hasn't changed",function(){a.render(),b.set({tile_style:"#test { polygon-fill: #F00; }\n"}),expect(a.hasChanges()).toBeFalsy()}),it("should detect when the cartocss has changed",function(){a.render(),b.set({tile_style:"#test { polygon-fill: #F00; }\n"}),a.codeEditor.setValue("php sux"),expect(a.hasChanges()).toBeTruthy()}),it("should not save style if there are errors",function(){a.render(),a.codeEditor.setValue("#test { polygon-fill: #FFF; asdas; asdasdasd; }\n"),spyOn(b,"save"),spyOn(a,"_adjustCodeEditorSize"),a.applyStyle(),expect(a._adjustCodeEditorSize).toHaveBeenCalled(),expect(b.save).not.toHaveBeenCalled()}),it("should save style if there no are errors",function(){a.render(),a.codeEditor.setValue("#test { polygon-fill: #FFF; }\n"),spyOn(b,"save"),a.applyStyle(),expect(b.save).toHaveBeenCalled()}),it("should set tile_style_custom to true",function(){var c;a.render(),a.codeEditor.setValue(c="#test { polygon-fill: #FFF; }\n"),spyOn(b,"save"),a.applyStyle(),expect(b.save).toHaveBeenCalledWith({tile_style:c,tile_style_custom:!0})}),it("should throw type errors in torque symbolizer",function(){a.render(),spyOn(a,"_parseError"),b.set({tile_style:["Map {",'-torque-frame-count:"512";','-torque-animation-duration:"10";',"-torque-time-attribute: 23;","-torque-aggregation-function:count(cartodb_id);",'-torque-resolution:"2";',"-torque-data-aggregation: manolo;","}"].join("\n")}),a.applyStyle(),expect(a._parseError.calls.argsFor(0)[0].length).toEqual(6)})})}),describe("CartoWizard",function(){var a,b,c,d;beforeEach(function(){c=TestUtil.createTable("test"),d=new cdb.admin.CartoDBLayer,d.sync=function(){},b=d,d.wizard_properties.set("type","polygon"),d.table.set({name:"test",geometry_types:["st_point"]}),a=new cdb.admin.mod.CartoCSSWizard({el:$("<div>"),model:b,table:d.table,map:new cdb.admin.Map,wizards:{polygon:"SimpleWizard",cluster:"ClusterWizard",bubble:"BubbleWizard",color:"ColorMapWizard",category:"CategoryWizard",choropleth:"ChoroplethWizard",density:"DensityWizard"}})}),afterEach(function(){a.clean()}),it("should not have leaks",function(){expect(a).toHaveNoLeaks()}),it("should add a panel",function(){a.render(),expect(a.$(".forms").children().length).toEqual(1)}),it("should switch when click on tabs",function(){a.render(),$(a.$el.find(".vis_options a")[0]).trigger("click"),expect(d.wizard_properties.get("type")).toEqual("polygon")}),it("shouldn't switch to color tab",function(){a.render(),$(a.$el.find(".vis_options a")[3]).trigger("click"),expect(d.wizard_properties.get("type")).toEqual("category")}),it("should switch when click on tabs",function(){a.render(),$(a.$el.find(".vis_options a")[0]).trigger("click"),expect(d.wizard_properties.get("type")).toEqual("polygon")}),it("when new style is generated and tab is active should set tile_style in the model",function(d){a.render(),b.set("id",1),c.data().create(),spyOn(b,"set"),$(a.$el.find(".vis_options a")[2]).trigger("click"),$(a.$el.find(".vis_options a")[0]).trigger("click"),setTimeout(function(){expect(b.set).toHaveBeenCalled();var a=["/** simple visualization */\n","#test{","  marker-fill-opacity: 0.9;","  marker-line-color: #FFF;","  marker-line-width: 1;","  marker-line-opacity: 1;","  marker-placement: point;","  marker-type: ellipse;","  marker-width: 10;","  marker-fill: #FF6600;","  marker-allow-overlap: true;","}"].join("\n");expect(b.set.calls.argsFor(2)[0].tile_style).toEqual(a),d()},700)}),it("when a wizard is deactivated the style is customized it should not be updated",function(d){a.render(),c.data().create(),b.set("tile_style_custom",!0),spyOn(b,"save"),$(a.$el.find(".vis_options a")[2]).trigger("click"),setTimeout(function(){expect(b.save).not.toHaveBeenCalled(),d()},700)}),describe("ChoroplethWizard",function(){var a;beforeEach(function(){d.table.set({name:"test_table",geometry_types:["st_point"]}),a=new cdb.admin.mod.CartoCSSWizard({el:$("<div>"),model:d,table:d.table,wizards:{polygon:"SimpleWizard",bubble:"BubbleWizard",choropleth:"ChoroplethWizard",density:"DensityWizard"}})}),afterEach(function(){a.clean()}),it("should not have leaks",function(){expect(a).toHaveNoLeaks()}),it("should activate choropleth, no matter if table is made of points",function(){a.render(),expect(a.tabs.$el.find("a.choropleth").length).toBeTruthy()}),it("should show the form if there is any number column",function(){d.table.set({name:"test_table",geometry_types:["st_polygon"],schema:[["test","number"]]}),a=new cdb.admin.mod.ChoroplethWizard({table:d.table,layer:d,wizard_properties:d.wizard_properties}),a.render(),expect(a.$el.find("div.content").length).toEqual(1),expect(a.$el.find("div.no_content").length).toEqual(0)}),it("should not show the form if there isn't any number column",function(){d.table.set({name:"test_table",geometry_types:["st_polygon"],schema:[["cartodb_id","number"]]}),a=new cdb.admin.mod.ChoroplethWizard({table:d.table,layer:d,wizard_properties:d.wizard_properties}),a.render(),expect(a.$el.find("div.content").length).toEqual(0),expect(a.$el.find("div.no_content").length).toEqual(1)})}),describe("SimpleWizard",function(){var a;beforeEach(function(){a=new cdb.admin.mod.SimpleWizard({table:d.table,layer:d,wizard_properties:d.wizard_properties})}),xit("should re-render when table geo types changes",function(){spyOn(a,"render"),d.table.set("geometry_types",["st_linestring"]),expect(a.render).toHaveBeenCalled()}),it("should not have leaks",function(){expect(a).toHaveNoLeaks()}),describe("properties change from edition",function(){it("should set text-dy when marker-width changes",function(){a.render(),a.cartoProperties.active("polygon"),expect(a.cartoProperties.get("text-dy")).toBe(-10),a.cartoProperties.set("marker-width",20),expect(a.cartoProperties.get("text-dy")).toBe(-20)}),it("should set several properties when text-allow-overlap changes",function(){a.render(),a.cartoProperties.active("polygon"),a.cartoProperties.set("text-allow-overlap","false"),expect(a.cartoProperties.get("text-placement-type")).toBe("simple"),expect(a.cartoProperties.get("text-label-position-tolerance")).toBe(10),a.cartoProperties.set("text-allow-overlap","true"),expect(a.cartoProperties.get("text-placement-type")).toBe("dummy"),expect(a.cartoProperties.get("text-label-position-tolerance")).toBe(0)})}),describe("marker color is changed from icon",function(){it("should revert to the default marker",function(){a.render();var b="url(http://com.cartodb.users-assets.production.s3.amazonaws.com/simpleicon/heart206.svg)";a.cartoProperties.set("marker-file",b),expect(a.cartoProperties.get("marker-file")).toBe(b),a.cartoProperties.set("marker-fill","#a0f0f1"),expect(a.cartoProperties.get("marker-file")).toBe(void 0)})})}),describe("BubbleWizard",function(){var a;beforeEach(function(){d.wizard_properties.active("bubble"),d.table.set({schema:[["aaa","string"]]}),a=new cdb.admin.mod.BubbleWizard({table:d.table,layer:d,wizard_properties:d.wizard_properties})}),it("should not have leaks",function(){expect(a).toHaveNoLeaks()}),it("should re-render when table schema changes",function(){a.render(),d.table.set({schema:[["jaja","number"],["jaja2","number"]]}),expect(a.$(".property option").length).toEqual(d.table.columnNamesByType("number").length),d.table.set({schema:[["jaja","number"]]}),expect(a.$(".property option").length).toEqual(d.table.columnNamesByType("number").length)})}),describe("DensityWizard",function(){var a;beforeEach(function(){d.wizard_properties.active("density"),a=new cdb.admin.mod.DensityWizard({table:d.table,layer:d,wizard_properties:d.wizard_properties,map:new cdb.admin.Map})})}),it("should not have leaks",function(){expect(a).toHaveNoLeaks()}),describe("CategoryWizard",function(){var a;beforeEach(function(){d=new cdb.admin.CartoDBLayer,d.sync=function(){},d.wizard_properties.set("type","polygon"),d.table.set({name:"test",schema:[["test","number"],["test2","string"]]}),d.wizard_properties.active("category"),d.wizard_properties.set({property:"test",categories:[{title:"rojo",title_type:"string",value_type:"color",color:"#F11810"}]}),a=new cdb.admin.mod.CategoryWizard({table:d.table,layer:d,wizard_properties:d.wizard_properties,map:new cdb.admin.Map})}),afterEach(function(){a.clean()}),it("should not have leaks",function(){expect(a).toHaveNoLeaks()}),it("should create the custom_categories collection from the beginning",function(){expect(a.colors).not.toBeDefined(),expect(a.categories).toBeDefined()}),it("should append new custom views",function(){a.render(),expect(a.$(".colors_error").size()).toBe(1),expect(a.$("ul.custom_categories").size()).toBe(1),expect(a.$(".colors_loader").size()).toBe(1)}),it("should generate custom categories list",function(){a.render(),expect(a.$("ul.custom_categories > li").size()).toBe(1),expect(a.$("ul.custom_categories > li .color-picker").css("background-color")).toBe("rgb(241, 24, 16)"),d.wizard_properties.unbindGenerator(),d.wizard_properties.set({property:"test",metadata:[{title:"rojo",title_type:"string",value_type:"color",color:"#F118FF"}]}),d.wizard_properties.bindGenerator(),expect(a.categories.size()).toBe(1),expect(a.$("ul.custom_categories > li").size()).toBe(1),expect(a.$("ul.custom_categories > li .color-picker").css("background-color")).toBe("rgb(241, 24, 255)")}),it("should generate custom categories list from a colors property",function(){d.wizard_properties.set({colors:[["rojo","#F11810","string"]]}),a.clean(),a=new cdb.admin.mod.CategoryWizard({table:d.table,layer:d,wizard_properties:d.wizard_properties,map:new cdb.admin.Map}),expect(a.cartoProperties.get("colors")).toBeDefined(),expect(a.cartoProperties.get("categories")).toBeDefined(),expect(a.cartoProperties.get("categories")[0].title).toBe("rojo"),expect(a.cartoProperties.get("categories")[0].title_type).toBe("string"),expect(a.cartoProperties.get("categories")[0].color).toBe("#F11810"),expect(a.cartoProperties.get("categories")[0].value_type).toBe("color"),expect(a.cartoProperties.get("categories").length).toBe(1)}),it("should be able to render a url background",function(){a.render(),d.wizard_properties.unbindGenerator(),d.wizard_properties.set({property:"test",metadata:[{title:"rojo",title_type:"string",value_type:"file",file:"https://carto.com"}]}),d.wizard_properties.bindGenerator(),expect(a.categories.size()).toBe(1),expect(a.$("ul.custom_categories > li").size()).toBe(1),expect(a.$("ul.custom_categories > li .color-picker").css("background")).toBe("")}),it("should change categories when they are edited",function(){a.render(),a.categories.models[0].set("title","verde"),
expect(d.wizard_properties.get("categories")[0].title).toEqual("verde")})})}),describe("cdb.admin.Filters",function(){var a,b,c;beforeEach(function(){b=TestUtil.createTable("tst"),b.unset("name"),dataLayer=new cdb.admin.CartoDBLayer({name:"test"}),dataLayer.sync=function(){},dataLayer.table.unset("name");var d=new cdb.admin.SQLViewData;dataLayer.bindSQLView(d),a=new cdb.admin.mod.Filters({table:b,dataLayer:dataLayer,repeatInterval:-1});var e=new cdb.admin.models.Filter({column:"test",table:b,lower:1,upper:10,column_type:"number"});c=e}),it("should manage models filter view",function(){a.render(),a.filters.add(c),expect(a.$("li").length).toEqual(1),c.destroy(),expect(a.$("li").length).toEqual(0)}),it("should apply queyr on changes",function(){a.filters.add(c),a._filtersChanged(),expect(a.options.dataLayer.sqlView.getSQL()).toEqual("SELECT * FROM tst WHERE (test >= 1 AND test < 10)")}),it("should serialize filters data to layer",function(){a.render(),a.filters.add(c),c.set("lower",0);var b=a.options.dataLayer.get("filters");expect(b).toEqual([c.toJSON()])}),describe("cdb.admin.mod.Filter",function(){var c;beforeEach(function(){c=new cdb.admin.models.Filter({column:"test",table:b}),view=new cdb.admin.mod.Filter({model:c})}),it("should render",function(){view.render(),expect(view.$(".legend").html()).toEqual("test:")}),it("should be removed",function(){spyOn(c,"destroy"),view.render(),view.$("a.remove").click(),expect(c.destroy).toHaveBeenCalled()}),it("should update the dropdowns",function(){spyOn(a.columnSelector,"updateData"),spyOn(a.innerColumnSelector,"updateData"),b.set({schema:[["test","number"],["test2","number"]]}),expect(a.columnSelector.updateData).toHaveBeenCalled(),expect(a.innerColumnSelector.updateData).toHaveBeenCalled()})}),describe("cdb.admin.mod.SelectorFilter",function(){var a;beforeEach(function(){a=new cdb.admin.models.FilterDiscrete({column:"test",table:b,column_type:"string"}),view=new cdb.admin.mod.SelectorFilter({model:a})}),it("should render items",function(){a._updateHist({rows:[{bucket:"test",value:10},{bucket:"test2",value:20}]}),view.render(),expect(view.$("ul.items li").length).toEqual(2)}),it("should pass the reached_limit flag to the model",function(){a._updateHist({reached_limit:!1,rows:[{bucket:"test",value:10},{bucket:"test2",value:20}]}),expect(a.get("reached_limit")).toEqual(!1)}),it("should disable/enable items",function(){a._updateHist({rows:[{bucket:"test",value:10},{bucket:"test2",value:20}]}),view.render(),$(view.$("ul.items li")[0]).click(),expect(a.items.at(0).get("selected")).toEqual(!1),expect(a.items.at(1).get("selected")).toEqual(!0),expect($(view.$("ul.items li")[0]).hasClass("selected")).toEqual(!1),expect($(view.$("ul.items li")[1]).hasClass("selected")).toEqual(!0),$(view.$("ul.items li")[0]).click(),expect(a.items.at(0).get("selected")).toEqual(!0),expect(a.items.at(1).get("selected")).toEqual(!0),expect($(view.$("ul.items li")[0]).hasClass("selected")).toEqual(!0),expect($(view.$("ul.items li")[1]).hasClass("selected")).toEqual(!0)})}),it("should not have leaks",function(){expect(view).toHaveNoLeaks()})}),describe("mod.infowindow",function(){var a,b,c;beforeEach(function(){b=new cdb.geo.ui.InfowindowModel({fields:[{name:"name1",title:!0,position:0}],template:"<div>test</div>"}),fake_dataLayer={infowindow:b,tooltip:b},c=new cdb.admin.CartoDBTableMetadata({name:"testTable",schema:[["name1","string"],["name2","number"],["name3","number"]]}),a=new cdb.admin.mod.InfoWindow({el:$("<div>"),dataLayer:fake_dataLayer,table:c})}),it("should render two infowindow types, click and hover",function(){a.render(),expect(_.size(a._subviews)).toBe(2),expect(a.infowindow_panes).toBeDefined(),expect(_.size(a.infowindow_panes._subviews)).toBe(2),expect(a.infowindow_tabs).toBeDefined(),expect(a.$("ul.types").length>0).toBeTruthy(),expect(a.$("ul.types li").length).toBe(2)}),describe("infowindow tab (same for tooltip tab)",function(){var a,b,c;beforeEach(function(){b=new cdb.geo.ui.InfowindowModel({fields:[{name:"name1",title:!0,position:0}]}),c=new cdb.admin.CartoDBTableMetadata({name:"testTable",schema:[["name1","string"],["name2","number"],["name3","number"]]}),a=new cdb.admin.mod.InfoWindowTab({el:$("<div>"),table:c,model:b})}),it("should render/add 3 panes + 3 tabs + header + menu",function(){a.render(),expect(_.size(a._subviews)).toBe(4),expect(a.$(".header").length>0).toBeTruthy(),expect(a.infowindow_panes).toBeDefined(),expect(_.size(a.infowindow_panes._subviews)).toBe(3),expect(a.infowindow_tabs).toBeDefined(),expect(a.$(".menu").length>0).toBeTruthy(),expect(a.$(".menu a").length).toBe(3)}),it("should select a different pane if template is not empty",function(){var a=new cdb.geo.ui.InfowindowModel({template:"<div></div>"}),b=new cdb.admin.mod.InfoWindowTab({el:$("<div>"),table:c,model:a});b.render(),expect(b.$(".header h3").text()).toBe("Custom HTML"),expect(b.$(".header .doc_info").css("display")).not.toBe("none"),expect(b.$(".header .form_combo").css("display")).toBe("none")}),it("should check 'title pane' when there is any change in the table schema or in the fields",function(){a.render(),b.set("fields",[]),expect(_.size(a.infowindow_panes._subviews)).toBe(2),expect(a.$(".menu a.disabled").length).toBe(1),b.set("fields",[{name:"jam",title:!0,position:0}]),expect(_.size(a.infowindow_panes._subviews)).toBe(3),expect(a.$(".menu a.disabled").length).toBe(0),c.set("schema",[]),expect(_.size(a.infowindow_panes._subviews)).toBe(2),expect(a.$(".menu a.disabled").length).toBe(1),b.set("fields",[{name:"jamon",title:!1,position:0},{name:"ey",title:!1,position:0}]),expect(_.size(a.infowindow_panes._subviews)).toBe(2),expect(a.$(".menu a.disabled").length).toBe(1)}),it("should change the title when a pane is active",function(){a.render(),a.infowindow_panes.active("title"),expect(a.$(".header h3").text()).toBe(""),expect(a.$(".header .doc_info").css("display")).toBe("none"),expect(a.$(".header .form_combo").css("display")).toBe("block"),expect(a.$(".header .controls .form_spinner").length).toBe(1),expect(a.$(".header .controls").hasClass("margin")).toBeFalsy(),a.infowindow_panes.active("html"),expect(a.$(".header h3").text()).toBe("Custom HTML"),expect(a.$(".header .doc_info").css("display")).not.toBe("none"),expect(a.$(".header .form_combo").css("display")).toBe("none"),expect(a.$(".header .controls .form_spinner").length).toBe(1),expect(a.$(".header .controls").hasClass("margin")).toBeTruthy(),a.infowindow_panes.active("fields"),expect(a.$(".header h3").text()).toBe(""),expect(a.$(".header .doc_info").css("display")).toBe("none"),expect(a.$(".header .form_combo").css("display")).toBe("block"),expect(a.$(".header .controls .form_spinner").length).toBe(1),expect(a.$(".header .controls").hasClass("margin")).toBeFalsy()}),it("should change the header when template is changed",function(){a.render(),a.infowindow_panes.active("html"),b.set("template","<div>{{ pisha }}</div>"),expect(a.$(".header .blocked").css("display")).toBe("none"),a.infowindow_panes.active("title"),expect(a.$(".header .blocked").css("display")).toBe("block"),a.infowindow_panes.active("fields"),expect(a.$(".header .blocked").css("display")).toBe("block")}),it("should send a trigger when a tab is selected",function(){a.render();var b=!1;a.bind("tabChanged",function(){b=!0},this),a.infowindow_panes.active("html"),expect(b).toBeTruthy()}),it("should refresh codemirror when html editor is enabled",function(){a.render(),spyOn(a,"_refreshHTMLEditor"),a.infowindow_panes.active("html"),expect(a._refreshHTMLEditor).toHaveBeenCalled()}),describe("infowindow fields pane",function(){var a,b,c;beforeEach(function(){b=new cdb.geo.ui.InfowindowModel,b.clearFields(),c=new cdb.admin.CartoDBTableMetadata({name:"testTable",schema:[["name1","string"],["name2","number"],["name3","number"]]}),a=new cdb.admin.mod.InfowindowFieldsPane({el:$("<div>"),model:b,table:c})}),it("should render fields",function(){a.render(),expect(a.$el.find("li").length).toEqual(3)}),it("should toggle switches",function(){a.render(),b.addField("name1").addField("name2"),expect($(a.$el.find(".switch")[0]).hasClass("enabled")).toEqual(!0),expect($(a.$el.find(".switch")[1]).hasClass("enabled")).toEqual(!0),b.removeField("name1"),expect($(a.$el.find(".switch")[0]).hasClass("enabled")).toEqual(!1),expect($(a.$el.find(".switch")[1]).hasClass("enabled")).toEqual(!0)}),it("should enable/disable all fields",function(){a.render(),expect($(a.$el.find(".fields .switch:not(.enabled)")).length).toEqual(3),a.$el.find(".selectall").trigger("click"),expect($(a.$el.find(".fields .switch.enabled")).length).toEqual(3),a.$el.find(".selectall").trigger("click"),expect($(a.$el.find(".fields .switch:not(.enabled)")).length).toEqual(3)}),it("should disable select-all when all chosen",function(){a.render(),b.addField("name1").addField("name2").addField("name3"),expect($(a.$el.find(".selectall")[0]).hasClass("enabled")).toEqual(!0)}),it("should disable select-all",function(){a.render(),b.addField("name1").addField("name2").addField("name3"),b.removeField("name1"),expect($(a.$el.find(".selectall")[0]).hasClass("disabled")).toEqual(!0)}),it("should assign fileds positions when there are no fields selected",function(){a.render();var b=0;_.each(a._subviews,function(a){expect(a.position).toEqual(b),++b})}),it("should remember the position of the fields after reordering and selecting all",function(){b.set("fields",[{name:"name2",title:!1,position:0},{name:"name1",title:!1,position:1}]),a.render(),expect(b.fieldCount()).toEqual(2);var c=a.$el.find(".drag_field")[0];a.$el.append(c),a._reasignPositions(),a.$el.find(".selectall").trigger("click"),expect(b.fieldCount()).toEqual(3),expect(b.getFieldPos("name1")).toEqual(0),expect(b.getFieldPos("name3")).toEqual(1),expect(b.getFieldPos("name2")).toEqual(2)}),it("should toggle titles",function(){a.render(),b.addField("name1").addField("name2"),expect($(a.$el.find(".title")[0]).hasClass("enabled")).toEqual(!0),expect($(a.$el.find(".title")[1]).hasClass("enabled")).toEqual(!0),b.setFieldProperty("name1","title",!1),expect($(a.$el.find(".title")[0]).hasClass("enabled")).toEqual(!1),expect($(a.$el.find(".title")[1]).hasClass("enabled")).toEqual(!0)}),it("should toggle fields on click",function(){a.render(),b.addField("name1").addField("name2"),$(a.$el.find(".switch")[0]).trigger("click"),expect(b.containsField("name1")).toEqual(!1),expect(b.containsField("name2")).toEqual(!0)}),it("should be placed in order",function(){a.render(),b.addField("name1",0).addField("name2",1);var c=a.$el.find(".drag_field")[0];a.$el.append(c),a._reasignPositions();var d=b.get("fields");expect(d[0].name).toEqual("name2"),expect(d[1].name).toEqual("name1")}),it("should show blocked panel when a template is set",function(){a.render(),a.model.set("template","<div></div>"),expect(a.$(".blocked").css("display")).toBe("block"),expect(a.$el.hasClass("disabled")).toBeTruthy()}),it("should show no content panel when there isn't any column in the schema",function(){a.render(),c.set("schema",[]),expect(a.$(".no_content").css("display")).toBe("block"),expect(a.$("li").length).toBe(0),expect(a.$(".all").css("display")).toBe("none")})}),describe("infowindow titles pane",function(){var a,b,c;beforeEach(function(){b=new cdb.geo.ui.InfowindowModel,c=new cdb.admin.CartoDBTableMetadata({name:"testTable",schema:[["name1","string"],["name2","number"],["name3","number"]]}),a=new cdb.admin.mod.InfowindowTitlePane({el:$("<div>"),model:b,table:c})}),it("should render titles",function(){a.render(),expect(a.$el.find("li").length).toEqual(3)}),it("should toggle titles",function(){a.render(),b.addField("name1").addField("name2"),expect(a.$(".edit_in_place").length).toBe(3),expect(a.$(".edit_in_place.disabled").length).toBe(1),b.removeField("name1"),expect(a.$(".edit_in_place").length).toBe(3),expect(a.$(".edit_in_place.disabled").length).toBe(2)}),it("should toggle titles on name fields change",function(){a.render(),b.addField("name1").addField("name2").addField("name3"),expect(a.$(".edit_in_place").length).toBe(3),expect(a.$(".edit_in_place.disabled").length).toBe(0),b.setFieldProperty("name1","title",!1),expect(a.$(".edit_in_place").length).toBe(3),expect(a.$(".edit_in_place.disabled").length).toBe(1),expect(a.$(".edit_in_place.disabled .value span").text()).toBe("name1")}),it("should show blocked panel when a template is set",function(){a.render(),a.model.set("template","<div></div>"),expect(a.$(".blocked").css("display")).toBe("block"),expect(a.$el.hasClass("disabled")).toBeTruthy()}),it("should render the list sorted as fields-pane if it is defined",function(){var a=new cdb.admin.mod.InfowindowFieldsPane({el:$("<div>"),model:b,table:c});a.render();var d=new cdb.admin.mod.InfowindowTitlePane({el:$("<div>"),model:b,table:c,fields_pane:a});d.render(),a.$(".switch:eq(1)").click(),expect(d.$("ul.fields li:eq(0) .edit_in_place div.value span").text()).toBe("name1"),expect(d.$("ul.fields li:eq(1) .edit_in_place").hasClass("disabled")).toBeFalsy(),expect(d.$("ul.fields li:eq(1) .edit_in_place div.value span").text()).toBe("name2"),expect(d.$("ul.fields li:eq(2) .edit_in_place div.value span").text()).toBe("name3")})}),describe("infowindow HTML pane",function(){var a,b,c;beforeEach(function(){b=new cdb.geo.ui.InfowindowModel({template_name:"infowindow_light"}),c=new cdb.admin.CartoDBTableMetadata({name:"testTable",schema:[["name1","string"],["name2","number"],["name3","number"]]}),a=new cdb.admin.mod.InfowindowHTMLPane({el:$("<div>"),model:b,table:c})}),it("should render HTML editor",function(){a.render(),expect(a.$(".CodeMirror").length).toBe(1);var b=$(a.codeEditor.getValue().trim());expect(b.attr("class")).toBe("cartodb-popup v2"),expect(b.find(".cartodb-popup-close-button").length).toBe(1),expect(b.find(".cartodb-popup-content-wrapper").length).toBe(1),expect(b.find(".cartodb-popup-content").length).toBe(1),expect(b.find(".cartodb-popup-tip-container").length).toBe(1)}),it("should apply infowindow template when template or fields change",function(){a.render(),spyOn(a.codeEditor,"setValue"),b.set("template_name","infowindow_dark"),expect(a.codeEditor.setValue).toHaveBeenCalled()}),it("should apply infowindow template when alternative_names change",function(){a.render(),spyOn(a.codeEditor,"setValue"),b.set("alternative_names",{name3:"jamon"}),expect(a.codeEditor.setValue).toHaveBeenCalled()}),it("should apply v2 class to infowindow template when width changes and template is old",function(){a.render(),a.codeEditor.setValue('<div class="cartodb-popup header blue"></div>'),spyOn(a.codeEditor,"setValue"),b.set("width",200),expect(a.codeEditor.setValue).toHaveBeenCalled()}),it("shouldn't apply v2 class to infowindow template when width changes but template has already v2",function(){a.render(),a.codeEditor.setValue('<div class="cartodb-popup header yellow v2"></div>'),spyOn(a.codeEditor,"setValue"),b.set("width",200),expect(a.codeEditor.setValue).not.toHaveBeenCalled()}),it("shouldn't apply v2 class to infowindow template without a cartodb-popup class when width changes ",function(){a.render(),a.codeEditor.setValue('<div class="header yellow v2"></div>'),spyOn(a.codeEditor,"setValue"),b.set("width",200),expect(a.codeEditor.setValue).not.toHaveBeenCalled()}),it("shouldn't apply v2 to a CSS style",function(){a.render(),a.codeEditor.setValue('<style>.cartodb-popup {color:red}</style><div class="cartodb-popup header yellow v2"></div>'),spyOn(a.codeEditor,"setValue"),b.set("width",200),expect(a.codeEditor.setValue).not.toHaveBeenCalled()}),it("should show an error when the template is empty",function(){a.render(),spyOn(a,"adjustCodeEditorSize"),a.codeEditor.setValue(""),a._apply(),expect(a.$(".info").css("display")).toBe("block"),expect(a.$(".info p").html()).toEqual("Error in line 1: Template can't be empty"),expect(a.adjustCodeEditorSize).toHaveBeenCalled(),a.codeEditor.setValue("<div>wadus</div>"),a._apply(),expect(a.$(".info").css("display")).toBe("none"),expect(a.adjustCodeEditorSize).toHaveBeenCalled()}),it("should set the new table schema fields when a query is applied, only if a template is defined",function(){a.render(),spyOn(a,"_apply"),c.set("schema",[["paco","number"]]),expect(a._apply).not.toHaveBeenCalled(),a.codeEditor.setValue("<div>{{name3.jamon}}</div>"),a._apply(),c.set("schema",[["paco","number"]]),expect(a._apply).toHaveBeenCalled()}),it("should remove template variable when apply a custom infowindow",function(){a.render(),b.set("fields",[{name:"name3",title:!1,position:0}]),a.codeEditor.setValue("<div>{{name3}}</div>"),a._apply(),expect(b.get("template_name")).toBe(""),expect(b.get("old_fields").length).toBe(1),expect(b.get("template")).toBe("<div>{{name3}}</div>"),expect(b.get("old_template_name")).toBe("infowindow_light")}),it("should respect the position of fields",function(){b.set("fields",[{name:"name3",title:!0,position:3},{name:"name1",title:!0,position:1},{name:"name2",title:!0,position:2}]),a.render(),a._apply(),expect(b.getFieldPos("name1")).toEqual(1),expect(b.getFieldPos("name2")).toEqual(2),expect(b.getFieldPos("name3")).toEqual(3)})})})}),describe("cdb.admin.mod.LegendEditor ",function(){var a,b,c,d,e,f,g,h;afterEach(function(){a.model.items.reset()}),beforeEach(function(){e=new cdb.geo.ui.LegendModel({type:null}),d=new cdb.admin.CartoDBLayer,d.sync=function(){},f=TestUtil.createTable("test"),h={"marker-allow-overlap":!0,"marker-fill":"#FFCC00","marker-line-color":"#FFF","marker-line-opacity":1,"marker-line-width":2,"marker-opacity":.9,"marker-placement":"point","marker-type":"ellipse","marker-width":12},g={categories:[{color:"#A6CEE3",title:"title",title_type:"string",value_type:"color"},{color:"#F1F1F1",title:null,title_type:"string",value_type:"color"}],"marker-allow-overlap":!0,"marker-line-color":"#FFF","marker-line-opacity":1,"marker-line-width":2,"marker-opacity":.9,"marker-placement":"point","marker-type":"ellipse","marker-width":12,property:"name"},d.wizard_properties.active("polygon",g),d.table.set("geometry_types",["st_point"]),b=[{name:"none",enabled:!0},{name:"custom",enabled:!0},{name:"color",enabled:!1},{name:"category",enabled:!1},{name:"bubble",enabled:!1},{name:"choropleth",enabled:!1},{name:"intensity",enabled:!1},{name:"density",enabled:!1}],a=new cdb.admin.mod.LegendEditor({model:e,dataLayer:d,className:"legends_panel",availableLegends:b}),a.render(),c=a.legend_panes.getPane("fields")}),it("should have tabs and panes",function(){expect(a.legend_tabs).toBeDefined(),expect(a.legend_panes).toBeDefined()}),it("should have panes",function(){expect(c.panes).toBeDefined()}),it("should have a combo",function(){expect(c.templates).toBeDefined()}),it('should render the "none" pane by default',function(){var a=c.$el.find(".none").text().replace(/^\s+|\s+$/g,"");expect(a).toEqual("Enable your legend by selecting a template from the selector above.")}),it("should contain two templates activated by default",function(){var a=c.templates.data;expect(a.length).toEqual(2),expect(a[0]).toEqual("none"),expect(a[1]).toEqual("custom")}),it("should render the panes",function(){expect(_.size(c.panes.tabs)).toEqual(b.length),expect(c.panes.$el.find("div").length).toEqual(b.length+1)}),it("should change the template combo when the user selects a new option in the combo",function(){c.$("select").val("custom").change(),expect(e.get("type")).toEqual("custom")}),it("should change the pane when the template combo is changed",function(){c.$("select").val("custom").change(),expect(c.panes.$el.find(".none").css("display")).toEqual("none"),expect(c.panes.$el.find(".custom").css("display")).toEqual("block")}),it("should add items",function(){c.$("select").val("custom").change(),c.$el.find(".add").click(),c.$el.find(".add").click(),c.$el.find(".add").click(),expect(c.$el.find(".custom ul li span.field").length).toEqual(4)}),it("should change the title",function(){c.$("select").val("custom").change(),c.model.set("title","this is a title"),expect(c.$el.find(".custom ul li.title span:last-child").text()).toEqual("this is a title")}),it("should select a different pane when the wizard changes",function(){d.wizard_properties.active("polygon",g),d.wizard_properties.active("category",g),expect(c.panes.$el.find(".none").css("display")).toEqual("none"),expect(c.panes.$el.find(".custom").css("display")).toEqual("none"),expect(c.panes.$el.find(".category").css("display")).toEqual("block")}),it("should change the combo when the wizard changes",function(){d.wizard_properties.active("category",g);var a=c.templates.data;expect(a.length).toEqual(3),expect(a[0]).toEqual("none"),expect(a[1]).toEqual("custom"),expect(a[2]).toEqual("category")}),it("should render the new pane when the wizard changes",function(){d.wizard_properties.active("category",g);c.templates.data;expect(c.model.get("type")).toEqual("category"),expect(c.$el.find(".category").css("display")).toEqual("block"),expect(c.$el.find(".choropleth").css("display")).toEqual("none")}),it("should update color items when the wizard changes",function(){g.categories[0].color="red",d.wizard_properties.active("category",g),expect(c.model.get("type")).toEqual("category"),expect(c.$el.find(".none").css("display")).toEqual("none"),expect(c.$el.find(".custom").css("display")).toEqual("none"),expect(c.$el.find(".category").css("display")).toEqual("block"),expect(c.$el.find(".category li span.field .form_color .color-picker").css("background-color")).toEqual("red")}),it("should generate the custom legend from the category legend",function(){g.categories[0].color="red",d.wizard_properties.active("category",g),expect(c.model.get("type")).toEqual("category"),expect(c.$el.find(".custom").css("display")).toEqual("none"),expect(c.$el.find(".category").css("display")).toEqual("block"),expect(c.$el.find(".category li span.field .form_color .color-picker").css("background-color")).toEqual("red"),c.model.set("type","custom"),expect(c.$el.find(".custom").css("display")).toEqual("block"),expect(c.$el.find(".category").css("display")).toEqual("none"),expect(c.$el.find(".custom li span.field .form_color .color-picker").css("background-color")).toEqual("red")}),it("should restore the state of the custom legend pane",function(){c.model.set("type","custom"),c.model.items.reset({name:"Remember me",value:"#F1F1F1"}),d.wizard_properties.active("intensity",h),expect(c.model.get("type")).toEqual("custom")}),it("should change the type of legend when the wizard changes",function(){d.wizard_properties.active("category",g),expect(e.get("type")).toEqual("category"),expect(c.panes.getActivePane()._FILTER_NAME).toEqual("category"),d.wizard_properties.active("polygon",g),expect(e.get("type")).toEqual("none"),expect(c.panes.getActivePane()._FILTER_NAME).toEqual("none")}),it("should select the empty legend when the type doesn't exist",function(){c.$("select").val("custom").change(),d.wizard_properties.active("polygon",g),expect(e.get("type")).toEqual("custom")}),it("shouldn change the type of the legend when the wizard changes even if the user has decided not to have a legend",function(){c.$("select").val("custom").change(),e.set("type","none"),d.wizard_properties.active("category",g),expect(c.templates.$el.find(".select2-choice span").text()).toEqual("category"),expect(e.get("type")).toEqual("category")}),it("should render tipsys ",function(){var b=a.$("a[href='#/fields']");b.trigger("mouseenter"),expect(b.data("tipsy")).not.toBeUndefined();var c=a.$("a[href='#/html']");c.trigger("mouseenter"),expect(c.data("tipsy")).not.toBeUndefined()}),it("should not have leaks",function(){expect(c).toHaveNoLeaks()})}),describe("cdb.admin.mod.LegendEditor: choropleth",function(){var a,b,c,d,e,f,g;afterEach(function(){a.model.items.reset()}),beforeEach(function(){e=new cdb.geo.ui.LegendModel({type:"choropleth"}),d=new cdb.admin.CartoDBLayer,d.sync=function(){},wizardProperties=new Backbone.Model,f=TestUtil.createTable("test"),g={categories:[{color:"#A6CEE3",title:"title",title_type:"string",value_type:"color"},{color:"#F1F1F1",title:null,title_type:"string",value_type:"color"}],"marker-allow-overlap":!0,"marker-line-color":"#FFF","marker-line-opacity":1,"marker-line-width":2,"marker-opacity":.9,"marker-placement":"point","marker-type":"ellipse","marker-width":12,property:"name"},d.table.set("geometry_types",["st_point"]),d.wizard_properties.active("choropleth",g),b=[{name:"none",enabled:!0},{name:"custom",enabled:!0},{name:"color",enabled:!1},{name:"category",enabled:!1},{name:"bubble",enabled:!1},{name:"choropleth",enabled:!1},{name:"intensity",enabled:!1},{name:"density",enabled:!1}],a=new cdb.admin.mod.LegendEditor({model:e,dataLayer:d,className:"legends_panel",availableLegends:b}),a.render(),c=a.legend_panes.getPane("fields")}),it("should have panes",function(){expect(c.panes).toBeDefined()}),it('should render the "choropleth" pane by default',function(){var a=c.templates.data;expect(a.length).toEqual(3),expect(a[0]).toEqual("none"),expect(a[1]).toEqual("custom"),expect(a[2]).toEqual("choropleth")}),it("should contain three templates activated by default",function(){var a=c.templates.data;expect(a.length).toEqual(3),expect(a[0]).toEqual("none"),expect(a[1]).toEqual("custom"),expect(a[2]).toEqual("choropleth")}),it("should render the panes",function(){expect(_.size(c.panes.tabs)).toEqual(b.length),expect(c.panes.$el.find("> div").length).toEqual(b.length)})}),describe("cdb.admin.mod.BubbleLegend",function(){beforeEach(function(){spyOn(Backbone,"sync");var a=TestUtil.createTable("test"),b=new cdb.admin.CartoDBLayer;this.wizardProps=new cdb.admin.WizardProperties({table:a,layer:b,type:"bubble",property:"track_seg_point_id",qfunction:"Quantile",radius_min:10,radius_max:25,"marker-fill":"#FF5C00","marker-opacity":.9,"marker-line-width":1.5,"marker-line-color":"#FFF","marker-line-opacity":1,"marker-comp-op":"none",zoom:15,geometry_type:"point","text-placement-type":"simple","text-label-position-tolerance":10,metadata:[51,102,154,205,256,307,358,410,461,512]}),this.legend=new cdb.admin.mod.BubbleLegend({model:{items:new Backbone.Collection},wizardProperties:this.wizardProps})}),describe("._calculateItems",function(){beforeEach(function(){this.legend._calculateItems()}),it("should set bubble items with sync state set to false by default",function(){expect(this.legend.items.pluck("sync")).toEqual([!1,!1,void 0])}),it("should set bubble items with sync value based on previous state",function(){this.legend._calculateItems(),expect(this.legend.items.pluck("sync")).toEqual([!1,!1,void 0]),this.legend.items.at(1).set("sync",!0),this.legend._calculateItems(),expect(this.legend.items.pluck("sync")).toEqual([!1,!0,void 0]),this.legend.items.at(0).set("sync",!0),this.legend._calculateItems(),expect(this.legend.items.pluck("sync")).toEqual([!0,!0,void 0])}),it("should set label values from metadata",function(){expect(this.legend.items.at(0).get("value")).toEqual(51),expect(this.legend.items.at(1).get("value")).toEqual(512)}),it("should update labels based only if sync state is disabled",function(){this.wizardProps.set("metadata",[1,2,3]),this.legend._calculateItems(),expect(this.legend.items.at(0).get("value")).toEqual(1),expect(this.legend.items.at(1).get("value")).toEqual(3),this.legend.items.at(1).set("sync",!0),this.legend.items.at(0).set("sync",!0),this.wizardProps.set("metadata",[4,5,6]),this.legend._calculateItems(),expect(this.legend.items.at(0).get("value")).toEqual(1),expect(this.legend.items.at(1).get("value")).toEqual(3)})})}),describe("Legend HTML pane",function(){var a,b;beforeEach(function(){b=new cdb.geo.ui.LegendModel,dataLayer=new cdb.admin.CartoDBLayer({name:"test",id:"test"}),a=new cdb.admin.mod.LegendHTMLPane({el:$("<div>"),model:b,table:dataLayer})}),it("should render HTML editor",function(){a.render(),expect(a.$(".CodeMirror").length).toBe(1),expect(a.codeEditor.getValue()).toBe("")}),it("should apply a new template when items attribute change",function(){a.render(),spyOn(a.codeEditor,"setValue"),b.set("items",[{value:"#343",type:"color"}]),expect(a.codeEditor.setValue).toHaveBeenCalled()}),it("should apply a new template when type attribute change",function(){a.render(),spyOn(a.codeEditor,"setValue"),b.set("type","choropleth"),expect(a.codeEditor.setValue).toHaveBeenCalled()})}),describe("SQL module",function(){var a,b,c,d;beforeEach(function(){c=new cdb.admin.SQLViewData,table=TestUtil.createTable(),b=new cdb.admin.CartoDBLayer({query:"select * from rambo2",table_name:"jamon"}),b.bindSQLView(c),b.urlRoot="/test",d=new cdb.admin.User({username:"u"}),a=new cdb.admin.mod.SQL({el:$("<div>"),model:b,user:d})}),it("should render current sql",function(){a.render(),expect(a.codeEditor.getValue()).toEqual("select * from rambo2")}),it("should render update sql",function(){var c="select * from rambo where id = 1";a.render(),b.set({query:c}),expect(a.codeEditor.getValue()).toEqual(c)}),it("should put the default sql when no sql",function(){b.set({query:null}),a.render(),expect(a.codeEditor.getValue()).toEqual(a._defaultSQL())}),it("should update editor when sql is changed",function(){b.set({query:sql="select * from rambo where id = 1"}),a.render(),expect(a.codeEditor.getValue()).toEqual(sql),b.set({query:sql="select * from rambo where id = 2"}),expect(a.codeEditor.getValue()).toEqual(sql)}),it("should detect when the sql hasn't changed",function(){b.set({query:sql="select * from rambo where id = 1"}),a.render(),expect(a.hasChanges()).toBeFalsy()}),it("should detect when the sql has changed",function(){b.set({query:sql="select * from rambo where id = 1"}),a.render(),a.codeEditor.setValue("spaggetti"),expect(a.hasChanges()).toBeTruthy()}),it("should change query value when a table name has happened",function(){b.set({query:"select * from cto"},{silent:!0}),a.render(),spyOn(a.codeEditor,"setValue"),b.set({table_name:"new_cto"}),expect(a.codeEditor.setValue.calls.count()).toEqual(1),a.codeEditor.setValue.calls.reset(),b.set({query:null},{silent:!0}),b.set({table_name:"old_cto"}),expect(a.codeEditor.setValue.calls.count()).toEqual(2)}),it("should set sql view when click on the apply button",function(){var b,c={sql:function(){}};spyOn(c,"sql"),spyOn(a.model,"addToHistory"),a.render(),a.codeEditor.setValue(b="select * from rambo limit 1"),a.$("button").trigger("click"),expect(a.model.addToHistory).toHaveBeenCalled()}),it("should replace {table_name}",function(){a.render(),a.model.table.set({name:"test"},{silent:!0}),a.codeEditor.setValue(sql="select * from {table_name} limit 1"),spyOn(a.model,"applySQLView"),a.$("button").trigger("click"),expect(a.model.applySQLView).toHaveBeenCalledWith("select * from test limit 1")}),it("should replace/remove ; character",function(){a.render(),a.model.table.set({name:"test"},{silent:!0}),spyOn(a.model,"applySQLView"),a.codeEditor.setValue(sql="select cartodb_id from (select * from test) as ha;"),a.$("button").trigger("click"),expect(a.model.applySQLView).toHaveBeenCalledWith("select cartodb_id from (select * from test) as ha"),a.codeEditor.setValue(sql="select * from table where name = 'our;CTO;is;the;fucking;master'"),a.$("button").trigger("click"),expect(a.model.applySQLView).toHaveBeenCalledWith("select * from table where name = 'our;CTO;is;the;fucking;master'")}),it("should show errors when query fails",function(){spyOn(a,"_adjustCodeEditorSize"),a.render(),a.model.trigger("errorSQLView",{responseText:JSON.stringify({errors:["test error"]})}),expect(a.$(".error").html().indexOf("test error")).not.toEqual(-1),expect(a._adjustCodeEditorSize).toHaveBeenCalled()}),it("should clear errors when sql is changed",function(){a.render(),spyOn(a,"_clearErrors"),b.set({query:sql="select * from rambo where id = 2"}),expect(a._clearErrors).toHaveBeenCalled()}),it("should clear a sql previously applied",function(){a.render(),a.codeEditor.setValue(sql="select * from rambo limit 1"),spyOn(a.model,"addToHistory"),spyOn(a,"_clearErrors"),a.$("button").trigger("click"),expect(a._clearErrors).toHaveBeenCalled(),expect(a.model.addToHistory).toHaveBeenCalled()}),it("should not save layer model on write queries",function(){
var c,d={test:function(){}};spyOn(d,"test"),spyOn(b,"save"),a.render(),a.codeEditor.setValue(c="insert into table (name) value (1)"),a.$("button").trigger("click"),expect(b.get("query")).not.toEqual(c),expect(b.save).not.toHaveBeenCalled()}),it("should not update sql in the editor if there was a query on it and there is no new query",function(){var c;b.set("sql","select * from test"),a.render(),a.codeEditor.setValue(c="insert into table (name) value (1)"),b.set("sql",null),expect(a.codeEditor.getValue()).toEqual(c)}),it("should qualify tables",function(){d.tables=["table1","table2","table3","Dentist","dentist","allbusiness"];var b=a.qualifyTables('select * from table1, table2,"table3", uu.table, "uu".table3');expect(b).toEqual('select * from u.table1, u.table2,u."table3", uu.table, "uu".table3'),a.user=new cdb.admin.User({username:"u-a"}),a.user.tables=["table1","table2","table3"],b=a.qualifyTables('select * from table1, table2,"table3", uu.table, "uu".table3'),expect(b).toEqual('select * from "u-a".table1, "u-a".table2,"u-a"."table3", uu.table, "uu".table3'),a.user=new cdb.admin.User({username:"timchung"}),a.user.tables=["table1","table2","table3","Dentist","dentist","allbusiness"],b=a.qualifyTables("select * from timchung.allbusiness where position('Dentist' in categories)>0"),expect(b).toEqual("select * from timchung.allbusiness where position('Dentist' in categories)>0"),b=a.qualifyTables("select * from allbusiness where position('Dentist' in categories)>0"),expect(b).toEqual("select * from timchung.allbusiness where position('Dentist' in categories)>0"),a.user=new cdb.admin.User({username:"xxx"}),a.user.tables=["parks","im_networks","Parks"],b=a.qualifyTables("SELECT * FROM parks WHERE poly_source IN ('WSD_Parks', 'IRMA', 'None', 'im_networks')"),expect(b).toEqual("SELECT * FROM xxx.parks WHERE poly_source IN ('WSD_Parks', 'IRMA', 'None', 'im_networks')")})}),describe("cdb.admin.overlays.Text",function(){var a;afterEach(function(){a._close()}),beforeEach(function(){var b={"z-index":4,"box-color":"#000000","box-opacity":.7,"box-width":200},c={pLeft:"50",pTop:"50",landscapeDirection:"left",portraitDirection:"top",text:"I'm a **text overlay**",rendered_text:"I'm a <strong>text overlay</strong>"},d=new cdb.admin.models.Overlay({type:"text",display:!0,width:100,height:100,device:"desktop",x:0,y:0,extra:c,style:b});a=new cdb.admin.overlays.Text({model:d}),a.render()}),it("should remove the overlay when overlay is selected and the backspace key is pressed",function(){var b=!1;a.model.set({selected:!0},{silent:!0}),a._onClickEdit(),a.bind("remove",function(){b=!0});var c=$.Event("keydown");c.keyCode=8,c.target=a.$el.find(".overlay_text"),$("body").trigger(c),expect(b).toBeTruthy()}),it("shouldn't remove the overlay when overlay is not selected and the backspace key is pressed",function(){var b=!1;a._onClickEdit(),a.model.set({selected:!1},{silent:!0}),a.bind("remove",function(){b=!0});var c=$.Event("keydown");c.keyCode=8,c.target=a.$el.find(".overlay_text"),$("body").trigger(c),expect(b).toBeFalsy()}),it("should remove the overlay when the content of the overlay is empty and it is not selected",function(){var b=!1;a.bind("remove",function(){b=!0}),a.model.set("text",""),a.model.set("selected",!1),expect(b).toBeTruthy()}),it("should remove the overlay when the content of the overlay is empty and it is not selected",function(){var b=!1;a.bind("remove",function(){b=!0}),a.model.set("text","<br />"),a.model.set("selected",!1),expect(b).toBeTruthy()}),it("should check the emptiness of a text",function(){expect(a._isEmptyText("<div><br /></div>")).toBeTruthy(),expect(a._isEmptyText("<div><br></div>")).toBeTruthy(),expect(a._isEmptyText("<div></div>")).toBeTruthy(),expect(a._isEmptyText("")).toBeTruthy(),expect(a._isEmptyText(" ")).toBeTruthy(),expect(a._isEmptyText("<br />a")).toBeFalsy(),expect(a._isEmptyText(" <br />")).toBeTruthy(),expect(a._isEmptyText("   <div></div>")).toBeTruthy()})}),describe("cdb.admin.models.Overlay",function(){var a;beforeEach(function(){var b={"z-index":5,color:"#ffffff","text-align":"left","font-size":10,"font-family-name":"Helvetica","box-color":"#000000","box-opacity":.7,"box-padding":5,"line-color":"#000000","line-width":50,"min-zoom":3,"max-zoom":40},c={latlng:[20,2],text:"I'm an **annotation overlay**",rendered_text:"I'm a <strong>annotation overlay</strong>"};a=new cdb.admin.models.Overlay({type:"annotation",display:!0,device:"desktop",extra:c,style:b})}),it("should clone the attributes",function(){expect(_.isEqual(a.attributes,a.cloneAttributes())).toEqual(!0)})}),describe("OverlayPropertiesBar",function(){beforeEach(function(){var a=[{name:"Text Align",form:{"text-align":{type:"text_align",value:"left"}}},{name:"Text Style",form:{"font-size":{type:"simple_number",value:12,min:5,max:50,inc:2},color:{type:"color",value:"#FFF",extra:{picker_horizontal_position:"right",picker_vertical_position:"down"}}}}],b=new cdb.vis.Vis({});this.overlays=new cdb.admin.Overlays,this.overlays.push(new cdb.admin.models.Overlay({type:"text",device:"screen",x:0,y:0,style:{"z-index":9}})),this.overlays.push(new cdb.admin.models.Overlay({type:"text",device:"screen",style:{"z-index":2}}));var c=new cdb.core.Model({style:{"z-index":2}}),d=new cdb.core.Model({mode:"screen"});this.view=new cdb.admin.OverlayPropertiesBar({model:c,canvas:d,overlays:this.overlays,vis:b,form_data:a})}),it("should render the bar fields",function(){this.view.render(),expect(this.view.$(".field").length).toEqual(4)}),it("should render the actions",function(){this.view.render(),expect(this.view.actions).toBeDefined(),expect(this.view.$("li.actions").length).toEqual(1),expect(this.view.$("li.actions a.btn").length).toEqual(4)}),it("should send to back",function(){this.view.render(),this.view.$(".btn-zIndexInc").click(),expect(this.view.model.get("style")["z-index"]).toBe(10)}),it("should send to front",function(){this.view.render(),this.view.$(".btn-zIndexDec").click(),expect(this.view.model.get("style")["z-index"]).toBe(1)})}),describe("cdb.admin.MapOverlays",function(){beforeEach(function(){this.vis=new cdb.admin.Visualization,this.overlays=new cdb.admin.Overlays,this.overlays.push(new cdb.admin.models.Overlay({type:"text",device:"screen",x:0,y:0,extra:{text:"test"},style:{"box-color":"#ffffff","z-index":9}})),this.overlays.push(new cdb.admin.models.Overlay({type:"zoom",device:"screen",style:{"z-index":2}})),this.vis.overlays=this.overlays,this.mapView=new cdb.core.View,this.canvas=new cdb.core.Model({mode:"desktop"}),this.view=new cdb.admin.MapOverlays({vis:this.vis,canvas:this.canvas,mapView:this.mapView,master_vis:this.vis})}),it("should duplicate an overlay",function(){var a=!1;cdb.admin.models.Overlay.prototype.save=function(){a=!0};var b=this.vis.overlays.at(0),c=this.vis.overlays.length;this.view._duplicate(b),expect(this.vis.overlays.length).toBe(c+1),expect(a).toBe(!0)}),it("should store the duplicated overlay for future copy",function(){var a=this.overlays.at(0);this.view._bindOverlay(a),expect(this.view._copiedOverlay).toEqual(void 0),a.trigger("duplicate",a),expect(this.view.editing).toBeDefined(),expect(this.view._copiedOverlay).toBeDefined()}),it("should render overlays",function(){cdb.admin.models.Overlay.prototype.save=function(){saved=!0},this.vis.overlays.createOverlayByType("zoom"),this.vis.overlays.createOverlayByType("search"),expect(this.mapView.$(".cartodb-zoom").length).toEqual(1),expect(this.mapView.$(".cartodb-searchbox").length).toEqual(1),expect(this.vis.overlays.size()).toEqual(4),this.vis.overlays.reset([{type:"zoom",order:6,display:!0,template:"",x:20,y:20}]),expect(this.mapView.$(".cartodb-zoom").length).toEqual(1),expect(this.mapView.$(".cartodb-searchbox").length).toEqual(0),expect(this.vis.overlays.size()).toEqual(1)})}),describe("right menu",function(){var a;beforeEach(function(){cdb.templates.add(new cdb.core.Template({name:"table/views/right_panel",compiled:_.template('<section class="table_panel"><div class="layer-sidebar"><nav class="tools"></nav><nav class="edit"></nav></div><div class="layer-views"></div></section>')})),a=new cdb.admin.RightMenu}),it("should render",function(){var b=a.render().$el;expect(b.find(".layer-sidebar")).toBeTruthy(),expect(b.find(".layer-views")).toBeTruthy()}),it("should add view and a button",function(){var b=new cdb.core.View;b.buttonClass="testButtonClass",b.type="tool",a.render(),a.addModule(b),expect(a.$el.find(".layer-views").children().length).toEqual(1),expect(a.$el.find(".tools").children().length).toEqual(1)}),it("should activate right panel and add a selected class in the button",function(){var b=new cdb.core.View;b.buttonClass="testButtonClass",b.type="tool",a.render(),a.addModule(b);var c=new cdb.core.View;c.buttonClass="testButtonClass2",c.type="tool",a.addModule(c),expect(a.panels.activeTab).toEqual("testButtonClass2"),a.$(".layer-sidebar .testButtonClass").trigger("click"),expect(a.panels.activeTab).toEqual("testButtonClass")}),it("should hide tools related to a section and remove selected class in the button",function(){var b=new cdb.core.View;b.buttonClass="testButtonClass",b.type="tool",a.render(),a.addModule(b,"table");var c=new cdb.core.View;c.buttonClass="testButtonClass2",c.type="tool",a.addModule(c,"map"),a.showTools("map"),expect(a.buttons[0].$el.css("display")).toEqual("none"),a.showTools("table"),expect(a.buttons[0].$el.css("display")).not.toEqual("none"),expect(a.buttons[0].$el.attr("class")).toEqual("testButtonClass")}),it("should hide tool on add if the section is disabled",function(){var b=new cdb.core.View;b.buttonClass="testButtonClass",b.type="tool",a.render(),a.addModule(b,"table"),a.showTools("table");var c=new cdb.core.View;c.buttonClass="testButtonClass2",c.type="tool",a.addModule(c,"map"),expect(a.buttons[0].$el.css("display")).not.toEqual("none"),expect(a.buttons[1].$el.css("display")).toEqual("none")}),it("should add tool buttons",function(){a.render();var b=a.addToolButton("testing","table");a.addToolButton("testing2","map"),expect(a.buttons[0].className).toEqual("testing"),expect(a.buttons[0]).toEqual(b),a.showTools("map"),a.addToolButton("testing3","table"),expect(a.buttons[0].$el.css("display")).toEqual("none"),expect(a.buttons[1].$el.css("display")).not.toEqual("none"),expect(a.buttons[2].$el.css("display")).toEqual("none")}),it("should not have leaks",function(){expect(a).toHaveNoLeaks()})}),describe("RowView",function(){var a,b,c,d;beforeEach(function(){c=new cdb.admin.CartoDBTableMetadata({name:"test",schema:[["cartodb_id","number"],["test","string"],["test2","number"],["the_geom","geometry"]],geometry_types:["ST_MultiPoint"]}),c.data().create(),b=new cdb.admin.RowView({el:$("<div>"),model:new cdb.admin.Row({cartodb_id:1,test:"test",test2:1,the_geom:'{ "type": "Point", "coordinates": [100.0, 0.0] }'}),row_header:!0}),d=new cdb.admin.SQLViewData(null,{sql:"select * from test"}),a=new cdb.admin.TableView({model:c,geocoder:new cdb.admin.Geocodings,dataModel:c.data(),sqlView:d,vis:TestUtil.createVis("test")}),b.tableView=a,b._getRowOptions().$el.css("display","none")}),it("should render properly",function(){b.render(),expect(b.$("td").length).toBe(5),expect(b.$("td:eq(0) div.cell").text()).toBe(""),expect(b.$("td:eq(1) div.cell").text()).toBe("1"),expect(b.$("td:eq(2) div.cell").text()).toBe("test"),expect(b.$("td:eq(3) div.cell").text()).toBe("1"),expect(b.$("td:eq(4) div.cell").text()).toBe(" 100.0000,0.0000")}),it("should render properly a row with point geometry but no data",function(){b.model.set({cartodb_id:1,test:"test",test2:1,the_geom:null}),b.render(),expect(b.$("td:eq(4) div.cell").text()).toBe("null")}),it("should render properly a row with polygon geometry",function(){c.set("geometry_types",["ST_MultiPolygon"],{silent:!0}),b.model.set({cartodb_id:1,test:"test",test2:1,the_geom:'{ "type": "Polygon", "coordinates": [[ [100.0, 0.0], [101.0, 0.0], [101.0, 1.0], [100.0, 1.0], [100.0, 0.0] ]]}'}),b.render(),expect(b.$("td").length).toBe(5),expect(b.$("td:eq(4) div.cell").text()).toBe("Polygon")}),it("should render properly a row with polygon geometry without data",function(){c.set("geometry_types",["ST_MultiPolygon"],{silent:!0}),b.model.set({cartodb_id:1,test:"test",test2:1,the_geom:null}),b.render(),expect(b.$("td:eq(4) div.cell").text()).toBe("null")}),it("should render properly a row with polyline geometry",function(){c.set("geometry_types",["ST_MultiLineString"],{silent:!0}),b.model.set({cartodb_id:1,test:"test",test2:1,the_geom:'{ "type": "LineString", "coordinates": [ [100.0, 0.0], [101.0, 1.0] ]}'}),b.render(),expect(b.$("td").length).toBe(5),expect(b.$("td:eq(4) div.cell").text()).toBe("Line")}),it("should render properly a row with polyline geometry but no data",function(){c.set("geometry_types",["ST_MultiLineString"],{silent:!0}),b.model.set({cartodb_id:1,test:"test",test2:1,the_geom:null}),b.render(),expect(b.$("td:eq(4) div.cell").text()).toBe("null")}),it("should open row menu",function(){b.render(),b.$(".row_header").trigger("click"),expect(b._getRowOptions().$el.css("display")).toEqual("block")})}),describe("cdb.admin.SlidesPanel",function(){var a,b,c;beforeEach(function(){a=new cdb.admin.Visualization,b=new cdb.admin.Slides(null,{visualization:a}),c=new cdb.admin.SlidesPanel({slides:b}),c.render()}),it("should reset slides",function(){b.reset([{},{},{}]),expect(c.$('.slide_view:not(".add")').length).toEqual(3)}),it("should add slide",function(){b.add({}),expect(c.$('.slide_view:not(".add")').length).toEqual(1)}),it("should render a fake slide when there are no slides",function(){expect(c.$('.slide_view:not(".add")').length).toEqual(1)}),it("should remove a fake slide there are slides",function(){expect(c.$('.slide_view:not(".add")').length).toEqual(1),b.add({}),expect(c.$('.slide_view:not(".add")').length).toEqual(1)}),it("should remove slide",function(a){b.add({}),b.add({}),b.at(0).destroy(),setTimeout(function(){expect(c.$('.slide_view:not(".add")').length).toEqual(1),a()},500)}),it("should activate the first slide after a remove",function(a){b.add({}),b.add({}),b.add({}),$(c.$('.slide_view:not(".add") .count')[0]).click(),b.remove(b.at(0)),setTimeout(function(){expect(c.$('.slide_view:not(".add"):nth-child(1)').hasClass("active")).toEqual(!0),a()},500)}),it("should activate the last slide after a remove",function(a){b.add({}),b.add({}),b.add({}),$(c.$('.slide_view:not(".add") .count')[2]).click(),b.remove(b.at(2)),setTimeout(function(){expect(c.$('.slide_view:not(".add"):nth-child(2)').hasClass("active")).toEqual(!0),a()},500)}),it("should activate the next slide after a remove",function(a){b.add({}),b.add({}),b.add({}),b.add({}),$(c.$('.slide_view:not(".add") .count')[1]).click(),b.remove(b.at(1)),setTimeout(function(){expect(c.$('.slide_view:not(".add"):nth-child(2)').hasClass("active")).toEqual(!0),a()},500)}),it("should mantain the same activated slide after a remove",function(a){b.add({}),b.add({}),b.add({}),b.add({}),$(c.$('.slide_view:not(".add") .count')[0]).click(),b.remove(b.at(2)),setTimeout(function(){expect(c.$('.slide_view:not(".add"):nth-child(1)').hasClass("active")).toEqual(!0),a()},500)}),it("should active on click",function(){b.reset([{},{},{}]),$(c.$('.slide_view:not(".add") .count')[0]).click(),expect(b.at(0).isActive()).toEqual(!0),expect(b.at(1).isActive()).toEqual(!1),expect(b.at(2).isActive()).toEqual(!1),$(c.$('.slide_view:not(".add") .count')[1]).click(),expect(b.at(0).isActive()).toEqual(!1),expect(b.at(1).isActive()).toEqual(!0),expect(b.at(2).isActive()).toEqual(!1)}),it("should show transition dropdown on click",function(){b.reset([{},{},{}]),$(c.$(".slide_view .info")[0]).click()})}),describe("tableview",function(){describe("headerview",function(){var a,b=new cdb.admin.CartoDBTableMetadata({name:"test"});beforeEach(function(){a=new cdb.admin.HeaderView({el:$("<div>"),column:["name","type"],table:b,vis:TestUtil.createVis("jam")})}),it("should render",function(){a.render(),expect(a.$("label > a").html().trim()).toEqual("name"),expect(a.$("p > a").html()).toEqual("type")}),it("when click on column name a menu should be opened",function(b){a.render(),a.$(".coloptions").trigger("click"),setTimeout(function(){expect(cdb.admin.HeaderView.colOptions.$el.css("display")).toEqual("block"),b()},400)}),it("when click on column type a menu should be opened",function(b){a.render(),a.$(".coltype").trigger("click"),setTimeout(function(){expect(cdb.admin.HeaderView.colTypeOptions.$el.css("display")).toEqual("block"),b()},800)}),it("when click on column type, being in a SQL view should not open anything",function(c){a.render();var d=new cdb.admin.SQLViewData(null,{sql:"select * from a"});b.useSQLView(d),a.$(".coltype").trigger("click"),setTimeout(function(){expect(cdb.admin.HeaderView.colTypeOptions.$el.css("display")).not.toEqual("block"),c()},800)})}),describe("TableView",function(){var a,b,c;beforeEach(function(){this.server=sinon.fakeServer.create(),c={showError:function(a,b,c){return this.params={first:a,second:b,third:c},!0}},b=new cdb.admin.CartoDBTableMetadata({name:"test",schema:[["id","number"],["col1","number"],["col2","number"],["col3","number"],["the_geom","geometry"]]}),a=new cdb.admin.TableView({el:$("<table>"),dataModel:b.data(),model:b,row_header:!0,vis:TestUtil.createVis("jam"),geocoder:new cdb.admin.Geocoding,globalError:c}),b.data().query_schema=b._columnType,b.data().reset([{id:1,col1:1,col2:2,col3:3,the_geom:null},{id:2,col1:4,col2:5,col3:6,the_geom:null}])}),afterEach(function(){a.options.geocoder.dlg&&a.options.geocoder.dlg.hide()}),it("should render a table",function(){b.set({columns:[["test","number"]]}),a.render(),expect(a.$("thead").length).toEqual(1)}),it("should edit cell",function(){spyOn(a,"_getEditor"),a.render(),a.getCell(0,0).trigger("dblclick"),expect(a._getEditor).toHaveBeenCalled()}),it("should set string editor when try to edit an unknown type",function(){b.set({schema:[["test","unknown_19"]]}),a.render(),a.getCell(0,0).trigger("dblclick");var c=b.columnName(0),d=b.getColumnType(c),e=b.data().getRowAt(0),f=b.data().getCell(0,c),g=this._editorsOpened=new cdb.admin.SmallEditorDialog({value:f,column:c,row:e,rowNumber:0,readOnly:b.isReadOnly(),editorField:a._getEditor(d),res:function(a){}});expect(g.render().$el.find(".string_field").length).toBe(1)}),it("should set string editor when try to edit an undefined type",function(){b.set({schema:[["test",void 0]]}),a.render(),a.getCell(0,0).trigger("dblclick");var c=b.columnName(0),d=b.getColumnType(c),e=b.data().getRowAt(0),f=b.data().getCell(0,c),g=this._editorsOpened=new cdb.admin.SmallEditorDialog({value:f,column:c,row:e,rowNumber:0,readOnly:b.isReadOnly(),editorField:a._getEditor(d),res:function(a){}});expect(g.render().$el.find(".string_field").length).toBe(1)}),it("should change table class if sync is enabled",function(){b.synchronization.set("id","test"),a.render(),expect(a.$el.hasClass("synced")).toEqual(!0),b.synchronization.unset("id"),expect(a.$el.hasClass("synced")).toEqual(!1),b.synchronization.set("id","test"),expect(a.$el.hasClass("synced")).toEqual(!0),b.synchronization.destroy(),expect(a.$el.hasClass("synced")).toEqual(!1)}),it("should show the type when the_Geom is a point",function(){b.data().reset([{id:1,col1:1,col2:2,col3:3,the_geom:'{"type":"Point", "coordinates": [45.32111111,-33.3312312312]}'}]),b.set("geometry_types",["st_point"]),a.render(),expect(a.$("td .cell").eq(1).html()).toEqual(" 45.3211,-33.3312")}),it("should show the type when the_Geom is a line",function(){b.data().reset([{id:1,col1:1,col2:2,col3:3,the_geom:'{"type":"Linestring", "coordinates": [[1,1],[2,3],[6,6]]}'}]),b.set("geometry_types",["st_linestring"]),a.render(),expect(a.$("td .cell").eq(1).html()).toEqual("Line")}),it("should show 'null' on the_geom cell when there is not a value for it",function(){b.data().reset([{id:1,col1:1,col2:2,col3:3,the_geom:null}]),a.render(),expect(a.$("td .cell").eq(1).html()).toEqual("null")}),it("should be able to add an empty row",function(){var b=a._models[0].table.data().length;a.addEmptyRow(),this.server.requests[1].respond(200,{"Content-Type":"application/json"},""),expect(b+1).toEqual(a._models[0].table.data().length)}),it("should show the empty table layout when there's no data",function(){b.data().reset(),expect(a.$(".placeholder.noRows").length).toBe(2),expect(a.$(".placeholder.noRows.decoration").length).toBe(1),expect(a.$("tfoot").length).toBe(1),expect(a.$("h4").text()).toBe("Start by adding rows to your table")}),it("should show the empty readonly table layout when there's no data and you can't change anything",function(){b.setReadOnly(!0),b.data().reset(),expect(a.$(".emptyPublicTableInfo").length).toBe(1),expect(a.$("h4").text()).toBe("This dataset is empty")}),it("should NOT show a notice when nothing happens",function(){expect(c.params).toBeFalsy()}),it("should show a notice when a row is being saved",function(){a.rowSaving(),expect(c.params).toBeTruthy()}),it("should show a notice when the model when a row is synched",function(){a.rowSynched(),expect(c.params).toBeTruthy()}),it("should show a notice the model when a row synch fails",function(){a.rowFailed(),expect(c.params).toBeTruthy()}),it("should show a notice the model when a row is deleted",function(){a.rowDestroyed(),expect(c.params).toBeTruthy()}),it("should not show the empty table layout after an empty row insertion",function(){b.data().reset(),a.render(),a.addEmptyRow(),expect(a.$(".placeholder.noRows").length).toBe(0),expect(a.$(".placeholder.noRows.decoration").length).toBe(0),expect(a.$("tfoot").length).toBe(0)}),xit("should show the empty table layout after the deletion of the last row",function(){b.data().reset(),a=new cdb.admin.TableView({el:$("<table>"),dataModel:b.data(),model:b,geocoder:new cdb.admin.Geocoding,row_header:!0}),a.render(),a.addEmptyRow(),spyOn(a,"rowDestroyed"),spyOn(a,"emptyTable");var c=a.rowViews[0]._getRowOptions();c.setRow(a.rowViews[0].model),c.deleteRow(),waits(100),expect(a.emptyTable).toHaveBeenCalled(),expect(a.$(".placeholder.noRows").length).toBe(2),expect(a.$(".placeholder.noRows.decoration").length).toBe(1),expect(a.$("tfoot").length).toBe(1)}),it("should have a geocoding binding each time table view is rendered",function(){a.render(),spyOn(a.model,"fetch"),a.options.geocoder.trigger("geocodingComplete"),expect(a.model.fetch).not.toHaveBeenCalled(),a.clean(),a.render(),a.options.geocoder.trigger("geocodingComplete"),expect(a.model.fetch.calls.count()).toBe(0)})}),describe("TableTab",function(){var a,b;beforeEach(function(){b=new cdb.admin.CartoDBTableMetadata({name:"test"}),a=new cdb.admin.TableTab({model:b,geocoder:new cdb.admin.Geocoding,vis:TestUtil.createVis("jam")})}),it("should render a div",function(){a.render(),expect(a.$el.hasClass("table")).toBeTruthy()}),it("should have a geocoding binding from the begining",function(){a.render(),spyOn(a.model.data(),"refresh"),a.geocoder.trigger("geocodingComplete"),expect(a.model.data().refresh).toHaveBeenCalled()})}),describe("HeaderColumnOptionsDropdown",function(){var a,b;beforeEach(function(){b=new cdb.admin.CartoDBTableMetadata({name:"test"}),a=new cdb.admin.HeaderDropdown({position:"position",template_base:"table/views/table_header_options",vis:TestUtil.createVis("jam")})}),it("should render all options for normal fields",function(){a.setTable(b,"normal"),expect(a.$("li").length).toEqual(7)}),it("should not render all options for reserved column",function(){a.setTable(b,"cartodb_id"),expect(a.$("li").length).toEqual(2),a.setTable(b,"normal"),expect(a.$("li").length).toEqual(7)}),it("should not render all options when query is applied",function(){var c=new cdb.admin.SQLViewData(null,{sql:"select * from a"});b.useSQLView(c),a.setTable(b,"cartodb_id"),expect(a.$("li").length).toEqual(3),a.setTable(b,"normal"),expect(a.$("li").length).toEqual(3),expect(a.$("a.clearview").length).toEqual(1)}),it("should not render all options for read only data",function(){b.setReadOnly(!0),a.setTable(b,"cartodb_id"),expect(a.$("li").length).toEqual(2),a.setTable(b,"normal"),expect(a.$("li").length).toEqual(2),expect(a.$("a.clearview").length).toEqual(0)})}),describe("HeaderColumnTypeDropdown",function(){var a,b;beforeEach(function(){b=new cdb.admin.CartoDBTableMetadata({name:"test"}),a=new cdb.admin.ColumntypeDropdown({position:"position",template_base:"table/views/table_column_type_options"})}),it("should render all available column types",function(){a.setTable(b,"normal"),expect(a.render().$el.find("li").length).toEqual(4)})})}),describe("cdb.admin.Tooltip",function(){var a,b,c,d;beforeEach(function(){a=new cdb.geo.LeafletMapView({el:$("<div>"),map:new cdb.geo.Map}),b=new cdb.geo.ui.InfowindowModel({fields:[{name:"name1",title:!0,position:0}],template_name:"tooltip_light"}),d=new Backbone.Model,c=new cdb.admin.Tooltip({model:b,layer:d,mapView:a})}),it("should render if the model change",function(){c.template=null,b.set("template_name","tooltip_dark"),expect(c.template).not.toEqual(null)}),it("should not render when no fields",function(){c.template=null,b.set("fields",[]),c.render(),expect(c.el.innerHTML).toEqual("")}),it("should use template if available",function(){b=new cdb.geo.ui.InfowindowModel({fields:[{name:"name1",title:!0,position:0}],template_name:"tooltip_light",template:"test"}),c=new cdb.admin.Tooltip({model:b,mapView:a}),c.render(),expect(c.$el.html()).toEqual("test")}),it("should render empty fields",function(){b.addField("test2"),d.trigger("mouseover",null,null,{x:0,y:0},{test:"test"}),expect(c.$el.html().indexOf("test2")===-1).toEqual(!1),c.options.empty_fields=!1,d.trigger("mouseover",null,null,{x:0,y:0},{test:"test"}),expect(c.$el.html().indexOf("test2")===-1).toEqual(!0)})}),describe("Watching notifier",function(){describe("Model",function(){var a,b,c;beforeEach(function(){a=new cdb.admin.Visualization({name:"test_vis",privacy:"PUBLIC",type:"table",permission:{owner:{username:"test",avatar_url:"http://test.com",id:"test"},acl:[]}}),c=TestUtil.createUser(),b=new cdb.admin.WatchingNotifierModel({},{vis:a})}),afterEach(function(){b.destroyCheck()}),it("should check users when acl has any item",function(){a.permission.grantWriteAccess(c),spyOn(b.vis.permission.acl,"size"),b._checkPermissions(),expect(b.vis.permission.acl.size).toHaveBeenCalled()}),it("should check again when visualization id has changed and acl has any item",function(){spyOn(b,"destroyCheck"),a.set("description","test"),expect(b.destroyCheck).not.toHaveBeenCalled(),a.set("id","test"),expect(b.destroyCheck).toHaveBeenCalled()}),it("should destroy poll check when acl list is empty",function(){spyOn(b,"destroyCheck"),a.permission.grantWriteAccess(c),a.set("id","test2"),expect(b.destroyCheck).not.toHaveBeenCalled(),a.permission.revokeAccess(c),a.set("id","test1"),expect(b.destroyCheck).toHaveBeenCalled()}),it("should destroy poll check when visualization is derived type",function(){spyOn(b,"destroyCheck"),a.permission.grantWriteAccess(c),a.set("id","test2"),expect(b.destroyCheck).not.toHaveBeenCalled(),a.set("type","derived"),a.set("id","test1"),expect(b.destroyCheck).toHaveBeenCalled()})}),describe("View",function(){var a,b,c,d;beforeEach(function(){b=new cdb.admin.Visualization({name:"test_vis",privacy:"PUBLIC",type:"derived",permission:{owner:{username:"test",avatar_url:"http://test.com",id:"test"},acl:[]}}),d=TestUtil.createUser(),c=new cdb.admin.WatchingNotifierModel({},{vis:b}),a=new cdb.admin.WatchingNotifierView({model:c,user:d})}),afterEach(function(){c.destroyCheck()}),it("should render properly",function(){a.render(),expect(a.$el.text().replace(/^\s+|\s+$/g,"")).toBe("0 people are also editing this dataset"),expect(a.$el.hasClass("active")).toBeFalsy()}),it("should change text when watcher users has changed",function(){a.render(),expect(a.$el.text().replace(/^\s+|\s+$/g,"")).toBe("0 people are also editing this dataset"),c.set("users",["test","test2","test3"]),expect(a.$el.hasClass("active")).toBeTruthy(),expect(a.$el.text().replace(/^\s+|\s+$/g,"")).toBe("3 people are also editing this dataset"),c.set("users",["test"]),expect(a.$el.text().replace(/^\s+|\s+$/g,"")).toBe("test is also editing this dataset")}),it("should hide when watcher users is 0",function(){a.render(),c.set("users",[]),expect(a.$el.hasClass("active")).toBeFalsy()}),it("should remove current user from users array",function(){a.render(),c.set("users",["staging20","test2","test3"]),expect(a.$el.hasClass("active")).toBeTruthy(),expect(a.$el.text().replace(/^\s+|\s+$/g,"")).toBe("2 people are also editing this dataset")})})}),describe("mapview public",function(){var a;beforeEach(function(){var b={id:"5ed698fa-cc85-11e3-a76b-003ee1fffe8b",version:"0.1.0",title:"untitled_table_5",description:null,url:null};a=new cdb.open.PublicMapTab({vizjson:b,vizjson_url:"",model:new cdb.core.Model({bounds:!1})})}),it("should render",function(){a.render(),expect(a.$(".cartodb-map").length).toEqual(1)}),it("should not render the private components",function(){a.render(),expect(a.$(".base_maps").length).toEqual(0),expect(a.$(".share").length).toEqual(0)})}),describe("PublicRowView",function(){var a,b,c;beforeEach(function(){c=new cdb.open.PublicCartoDBTableMetadata({name:"test",schema:[["cartodb_id","number"],["test","string"],["test2","number"],["the_geom","geometry"]],geometry_types:["ST_MultiPoint"]}),b=new cdb.open.PublicRowView({el:$("<div>"),model:new cdb.admin.Row({cartodb_id:1,test:"test",test2:1,the_geom:'{ "type": "Point", "coordinates": [100.0, 0.0] }'}),row_header:!0}),a=new cdb.open.PublicTableView({model:c,geocoder:new cdb.admin.Geocodings,dataModel:c.data()}),b.tableView=a}),it("should render properly",function(){b.render(),expect(b.$("td").length).toBe(5),expect(b.$("td:eq(0) div.cell").text()).toBe(""),expect(b.$("td:eq(1) div.cell").text()).toBe("1"),expect(b.$("td:eq(2) div.cell").text()).toBe("test"),expect(b.$("td:eq(3) div.cell").text()).toBe("1"),expect(b.$("td:eq(4) div.cell").text()).toBe("GeoJSON")}),it("should not open row menu on click",function(){b.render(),b.$(".row_header").trigger("click"),expect(b._getRowOptions()).toBeFalsy()})}),describe("tableview_public",function(){describe("TableView",function(){var a,b;beforeEach(function(){this.server=sinon.fakeServer.create(),b=new cdb.open.PublicCartoDBTableMetadata({name:"test",schema:[["id","integer"],["col1","integer"],["col2","integer"],["col3","integer"]]}),a=new cdb.open.PublicTableView({el:$("<table>"),dataModel:b.data(),model:b,row_header:!0}),b.data().reset([{id:1,col1:1,col2:2,col3:3},{id:2,col1:4,col2:5,col3:6}])}),it("should show the empty table layout when there's no data",function(){b.data().reset(),expect(a.$("tfoot").length).toBe(1)}),it("should show the public empty table warning, not the private one",function(){b.data().reset(),b.data().trigger("dataLoaded"),a.render(),expect(a.$(".placeholder.noRows").length).toBe(0),expect(a.$(".placeholder.noRows.decoration").length).toBe(0)}),it("should not show the empty table layout after an empty row insertion",function(){b.data().reset(),a.render(),a.addEmptyRow(),expect(a.$("tfoot").length).toBe(0)})}),describe("TableTab",function(){var a,b;beforeEach(function(){b=new cdb.open.PublicCartoDBTableMetadata({name:"test"}),a=new cdb.open.PublicTableTab({model:b})}),it("should render a div",function(){a.render(),expect(a.$el.hasClass("table")).toBeTruthy()})})}),function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){var d=a("../common/views/base_dialog/view"),e=a("../common/view_helpers/random_quote"),f=a("../common/service_models/service_invalidate_model");b.exports=d.extend({events:d.extendEvents({"click .js-revoke":"_revokeAccess"}),initialize:function(){
this.elder("initialize"),this._initBinds()},render_content:function(){return"loading"===this.model.get("state")?this.getTemplate("common/templates/loading")({title:"Revoking access",quote:e()}):this.getTemplate("account/views/service_disconnect_dialog")(this.model.attributes)},_initBinds:function(){this.model.bind("change:state",this._maybeReplaceContent,this)},_maybeReplaceContent:function(){"error"!==this.model.get("state")&&this.$(".Dialog-content").html(this.render_content())},_revokeAccess:function(){this.model.set("state","loading");var a=this,b=new f({datasource:this.model.get("name")});b.destroy({success:function(b,c){c.success?a._reloadWindow():a._setErrorState()},error:function(){a._setErrorState()}})},_setErrorState:function(){this.model.set("state","error"),this.close()},_reloadWindow:function(){window.location.reload()}})},{"../common/service_models/service_invalidate_model":231,"../common/view_helpers/random_quote":241,"../common/views/base_dialog/view":242}],2:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("../common/service_models/service_oauth_model"),f=a("../common/service_models/service_valid_token_model"),g=a("./service_disconnect_dialog_view"),h="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;b.exports=d.core.View.extend({_WINDOW_INTERVAL:1e3,className:"FormAccount-row",tagName:"div",events:{"click .js-connect":"_connect","click .js-disconnect":"_disconnect"},initialize:function(){this.template=d.templates.getTemplate("account/views/service_item"),this._initBinds(),this.model.get("connected")&&this._checkToken()},render:function(){return this.$el.html(this.template(this.model.attributes)),this},_initBinds:function(){h.bindAll(this,"_setErrorState"),this.model.bind("change:state change:connected",this.render,this)},_connect:function(a){if("loading"!==this.model.get("state")){var b=this;this.model.set("state","loading");var c=new e(null,{datasource_name:this.model.get("name")});c.fetch({success:function(a,c){c.success&&c.url&&b._openWindow(c.url)},error:function(){b._setErrorState()}})}},_disconnect:function(){if("loading"!==this.model.get("state")){var a=new g({model:this.model,clean_on_hide:!0,enter_to_confirm:!1});a.appendToBody()}},_checkToken:function(a,b){var c=this,d=new f({datasource:this.model.get("name")});d.fetch({success:function(d,e){c.model.set("connected",e.oauth_valid),e.oauth_valid?a&&a():b&&b()},error:function(){b&&b()}})},_setErrorState:function(){this.model.set("state","error")},_reloadWindow:function(){window.location.reload()},_openWindow:function(a){var b=this,c=window.open(a,null,"menubar=no,toolbar=no,width=600,height=495"),d=window.setInterval(function(){c&&c.closed?(b._checkToken(b._reloadWindow,b._setErrorState),clearInterval(d)):c||(b._setErrorState(),clearInterval(d))},this._WINDOW_INTERVAL)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../common/service_models/service_oauth_model":232,"../common/service_models/service_valid_token_model":234,"./service_disconnect_dialog_view":1}],3:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof a?a.Backbone:null;"undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=d.Model.extend({url:function(a){var b=c.config.urlVersion("asset",a);return"/api/"+b+"/users/"+this.userId+"/assets"},fileAttribute:"filename",initialize:function(a,b){if(!b.userId)throw new Error("user id is required");this.userId=b.userId}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],4:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./asset_model.js");b.exports=d.core.View.extend({options:{avatarAcceptedExtensions:["jpeg","jpg","png","gif"]},initialize:function(){this.renderModel=this.options.renderModel,this.model=new d.core.Model({state:"idle"}),this.template=d.templates.getTemplate("common/views/avatar_selector_view"),this._initBinds()},render:function(){return this._destroyFileInput(),this.clearSubViews(),this.$el.html(this.template({state:this.model.get("state"),name:this.renderModel.get("name"),inputName:this.renderModel.get("inputName"),avatarURL:this.renderModel.get("avatar_url"),avatarAcceptedExtensions:this._formatAvatarAcceptedExtensions(this.options.avatarAcceptedExtensions)})),this._renderFileInput(),this},_initBinds:function(){_.bindAll(this,"_onInputChange","_onSuccess","_onError"),this.model.bind("change",this.render,this)},_destroyFileInput:function(){var a=this.$(":file");a.unbind("change",this._onInputChange,this),a.filestyle("destroy")},_renderFileInput:function(){var a=this.$(":file"),b={buttonText:"Choose image"};"loading"===this.model.get("state")&&(b.disabled=!0),a.filestyle(b),a.bind("change",this._onInputChange)},_onInputChange:function(){var a=this.$(":file").prop("files"),b=new e(null,{userId:this.renderModel.get("id")});b.save({kind:"orgavatar",filename:a},{success:this._onSuccess,error:this._onError}),this.model.set("state","loading")},_onSuccess:function(a,b){this.renderModel.set("avatar_url",b.public_url),this.model.set("state","success")},_onError:function(){this.model.set("state","error")},clean:function(){this._destroyFileInput(),this.elder("clean")},_formatAvatarAcceptedExtensions:function(a){for(var b=[],c=0;c<a.length;c++)b[c]="image/"+a[c];return b.join(",")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./asset_model.js":3}],5:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./models/imports_collection"),f=a("./models/geocodings_collection"),g=a("./models/analysis_collection"),h=3e3;b.exports=d.core.Model.extend({defaults:{showGeocodingDatasetURLButton:!1,showSuccessDetailsButton:!0,geocodingsPolling:!1,importsPolling:!1},initialize:function(a,b){this.user=b.user,this.vis=b.vis,this.importsCollection=b.importsCollection||new e(null,{user:this.user}),this.geocodingsCollection=b.geocodingsCollection||new f(null,{user:this.user,vis:this.vis}),this.analysisCollection=b.anaylysisCollection||new g(null,{user:this.user}),this._initBinds(),this.startPollings()},_initBinds:function(){this.importsCollection.bind("change:state",function(a){this.trigger("change",a,this),this._onImportsStateChange(a)},this),this.importsCollection.bind("remove",function(a){this.trigger("importRemoved",a,this)},this),this.importsCollection.bind("add",function(a){this.trigger("importAdded",a,this)},this),this.geocodingsCollection.bind("change:state",function(a){this.trigger("change",a,this),this._onGeocodingsStateChange(a)},this),this.geocodingsCollection.bind("remove",function(a){this.trigger("geocodingRemoved",a,this)},this),this.geocodingsCollection.bind("add",function(a){this.trigger("geocodingAdded",a,this)},this),this.analysisCollection.bind("reset",function(){this.analysisCollection.size()>0?this.trigger("analysisAdded",this.analysisCollection,this):this.trigger("analysisRemoved",this.analysisCollection,this)},this),this.analysisCollection.bind("change:state",function(a){this._onAnalysisStateChange(a,this.analysisCollection)},this)},getTotalFailedItems:function(){return this.importsCollection.failedItems().length+this.geocodingsCollection.failedItems().length},removeImportItem:function(a){return!!a&&void this.importsCollection.remove(a)},addImportItem:function(a){return!!a&&void this.importsCollection.add(a)},removeGeocodingItem:function(a){return!(!a||!this.canAddImport())&&void this.geocodingsCollection.remove(a)},addGeocodingItem:function(a){return!(!a||!this.canAddGeocoding())&&void this.geocodingsCollection.add(a)},removeAnalysis:function(){this.analysisCollection.destroyCheck(),this.analysisCollection.reset()},addAnalysis:function(a){return!(!a||!this.canAddAnalysis())&&void this.analysisCollection.reset(a)},canAddImport:function(){return this.importsCollection.canImport()},canAddGeocoding:function(){return this.geocodingsCollection.canGeocode()},canAddAnalysis:function(){return this.analysisCollection.canStartPecan()},getTotalImports:function(){return this.importsCollection.size()},getTotalGeocodings:function(){return this.geocodingsCollection.size()},getTotalAnalysis:function(){return this.analysisCollection.size()>0?1:0},getTotalPollings:function(){return this.importsCollection.size()+this.geocodingsCollection.size()+(this.analysisCollection.isAnalyzing()?1:0)},stopPollings:function(){this.get("geocodingsPolling")&&this.geocodingsCollection.destroyCheck(),this.get("importsPolling")&&this.importsCollection.destroyCheck()},startPollings:function(){var a=this;setTimeout(function(){a.get("geocodingsPolling")&&a.geocodingsCollection.pollCheck(),a.get("importsPolling")&&a.importsCollection.pollCheck()},h)},_onImportsStateChange:function(){},_onGeocodingsStateChange:function(){},_onAnalysisStateChange:function(){},clean:function(){this.importsCollection.unbind(null,null,this),this.geocodingsCollection.unbind(null,null,this),this.analysisCollection.unbind(null,null,this),this.elder("clean")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./models/analysis_collection":7,"./models/geocodings_collection":10,"./models/imports_collection":13}],6:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null),e=a("./views/imports/background_import_item_view"),f=a("./views/analysis/background_analysis_item_view"),g=a("./views/geocodings/background_geocoding_item_view"),h=a("./views/imports/background_import_limit_view"),i=a("./models/imports_model"),j=(a("./models/geocoding_model"),a("./background_polling_model")),k=a("./views/background_polling_header_view");b.exports=d.core.View.extend({className:"BackgroundPolling",initialize:function(){this.user=this.options.user,this.createVis=this.options.createVis,this.vis=this.options.vis,this.model||(this.model=new j({},{user:this.user})),this.template=d.templates.getTemplate("common/background_polling/background_polling"),this._initBinds()},render:function(){return this.$el.html(this.template()),this._initViews(),this},_initBinds:function(){this.model.bind("importAdded",this._addImport,this),this.model.bind("geocodingAdded",this._addGeocoding,this),this.model.bind("analysisAdded",this._addAnalysis,this),this.model.bind("analysisAdded analysisRemoved importAdded importRemoved geocodingAdded geocodingRemoved",this._checkPollingsSize,this),d.god.bind("importByUploadData",this._addDataset,this),d.god.bind("fileDropped",this._onDroppedFile,this),this.add_related_model(d.god)},_initViews:function(){var a=new k({model:this.model});this.$el.prepend(a.render().el),this.addView(a)},_checkPollingsSize:function(){this.model.getTotalPollings()>0?this.show():this.hide()},_addAnalysis:function(a){this._analysisItem&&this._analysisItem.clean(),this._analysisItem=new f({collection:a,vis:this.vis,user:this.user}),this._analysisItem.bind("remove",function(a){this.model.removeAnalysis()},this),this.$(".js-list").prepend(this._analysisItem.render().el),this.addView(this._analysisItem)},_addGeocoding:function(a){var b=new g({showGeocodingDatasetURLButton:this.model.get("showGeocodingDatasetURLButton"),model:a,user:this.user});b.bind("remove",function(a){this.model.removeGeocodingItem(a)},this),this.$(".js-list").prepend(b.render().el),this.addView(b),this.enable()},_addImport:function(a){var b=new e({showSuccessDetailsButton:this.model.get("showSuccessDetailsButton"),model:a,user:this.user});b.bind("remove",function(a){this.model.removeImportItem(a)},this),this.$(".js-list").prepend(b.render().el),this.addView(b),this.enable()},_addDataset:function(a){a&&this._addImportsItem(a)},_onDroppedFile:function(a){a&&this._addImportsItem({type:"file",value:a,create_vis:this.createVis})},_addImportsItem:function(a){if(!this.model.canAddImport())return this._addLimitItem(),!1;this._removeLimitItem();var b=new i({},{upload:a,user:this.user});this.model.addImportItem(b)},_addLimitItem:function(){if(!this._importLimit){var a=new h({user:this.user});this.$(".js-list").prepend(a.render().el),this.addView(a),this._importLimit=a}},_removeLimitItem:function(){var a=this._importLimit;a&&(a.clean(),this.removeView(a),delete this._importLimit)},enable:function(){this.model.startPollings()},disable:function(){this.model.stopPollings()},show:function(){this.$el.addClass("is-visible")},hide:function(){this.$el.removeClass("is-visible")},clean:function(){this.disable(),this.elder("clean")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./background_polling_model":5,"./models/geocoding_model":8,"./models/imports_model":14,"./views/analysis/background_analysis_item_view":20,"./views/background_polling_header_view":22,"./views/geocodings/background_geocoding_item_view":23,"./views/imports/background_import_item_view":25,"./views/imports/background_import_limit_view":26}],7:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("cartodb-pecan"),g=a("./pecan_model"),h=5;b.exports=d.Collection.extend({model:g,initialize:function(a,b){this.user=b.user,this._initBinds()},_initBinds:function(){this.bind("reset",this.pollCheck,this)},canStartPecan:function(){return this.getTotalAnalysis()===this.getCompletedAnalysis()},pollCheck:function(){this._nextAnalysisItems&&e.each(this._nextAnalysisItems,function(a){a.unbind(null,null,this)},this);var a=e.first(this.where({state:"idle"}),h);a.length>0&&(this._nextAnalysisItems=a,e.each(this._nextAnalysisItems,function(a){this.user.featureEnabled("pecan_debugging")&&a.bind("print_stats",function(a){this._printStats(a)},this),a.bind("change:state",function(a,b){if(a.isAnalyzed()){var c=e.find(this._nextAnalysisItems,function(a){return!a.isAnalyzed()});c||this.pollCheck()}},this),a.getData()},this))},_printStats:function(a){var b=a.column,c=a.type,d=a.weight,e=a.skew,g=a.distinct,h=a.count,i=a.null_ratio,j=a.dist_type,k=(d+f.getWeightFromShape(j))/2,l=g/h*100;cdb.log.info("%cAnalyzing %c"+b,"text-decoration:underline; font-weight:bold","text-decoration:underline; font-weight:normal"),cdb.log.info("%c · %ctype%c = "+c,"color:#666;","color: #666; font-weight:bold;","color: #666; font-weight:normal"),cdb.log.info("%c · %cdistinctPercentage%c = "+l,"color:#666;","color: #666; font-weight:bold;","color: #666; font-weight:normal"),cdb.log.info("%c · %ccount%c = "+h,"color:#666;","color: #666; font-weight:bold;","color: #666; font-weight:normal;"),cdb.log.info("%c · %cnull ratio%c = "+i,"color:#666;","color: #666; font-weight:bold;","color: #666; font-weight:normal;"),j&&(cdb.log.info("%c · %cdist_type%c = "+j,"color:#666;","color: #666; font-weight:bold;","color: #666; font-weight:normal;"),cdb.log.info("%c · %ccalc_weight%c = "+k,"color:#666;","color: #666; font-weight:bold;","color: #666; font-weight:normal;")),e&&cdb.log.info("%c · %cskew%c: "+e.toFixed(2),"color:#666;","color: #666; font-weight:bold;","color: #666; font-weight:normal;"),d&&cdb.log.info("%c · %cweight%c: "+d.toFixed(2),"color: #666;","color:#666; font-weight:bold;","color:#666;font-weight:normal"),a.density&&cdb.log.info("%c · %cdensity%c: "+a.density,"color:#666;","color: #666; font-weight:bold;","color: #666; font-weight:normal;")},destroyCheck:function(){var a=this.where({state:"idle"});this.remove(a)},failedItems:function(){},getTotalAnalysis:function(){return this.size()},getSuccessfullyAnalysedColumns:function(){return this.where({success:!0}).length},getCompletedAnalysis:function(){return this.where({state:"analyzed"}).length},isAnalyzing:function(){return this.getCompletedAnalysis()!==this.getTotalAnalysis()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./pecan_model":16,"cartodb-pecan":528}],8:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,"undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null),e=a("./geocoding_model_poller");b.exports=cdb.core.Model.extend({options:{startPollingAutomatically:!0},defaults:{kind:"",formatter:"",table_name:"",state:""},url:function(a){var b=cdb.config.urlVersion("geocoding",a),c="/api/"+b+"/geocodings/";return this.isNew()?c:c+this.id},setUrlRoot:function(a){this.urlRoot=a},initialize:function(a){this._initBinds(),d.extend(this.options,a),this.poller=new e(this),this.options.startPollingAutomatically&&this._checkModel()},_initBinds:function(){this.bind("change:id",this._checkModel,this)},_checkModel:function(){this.get("id")?this.pollCheck():this._saveModel()},_saveModel:function(){var a=this;this.isNew()&&this.save({},{error:function(){a.set({state:"failed",error:{title:"Oops, there was a problem",description:"Unfortunately there was an error starting the geocoder"}})}})},pollCheck:function(){this.poller.start()},destroyCheck:function(){this.poller.stop()},getError:function(){return this.get("error")},hasFailed:function(){var a=this.get("state");return"failed"===a||"reset"===a||"cancelled"===a},hasCompleted:function(){return"finished"===this.get("state")},isOngoing:function(){return!this.hasCompleted()&&!this.hasFailed()},cancelGeocoding:function(){this.save({state:"cancelled"},{wait:!0})},resetGeocoding:function(){this.set("state","reset")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./geocoding_model_poller":9}],9:[function(a,b,c){var d=a("./poller"),e=function(a){var b=2e3,c={interval:b,stopWhen:function(a){return a.hasFailed()||a.hasCompleted()},error:function(a){a.trigger("change")}};d.call(this,a,c)};e.prototype=_.extend({},d.prototype),b.exports=e},{"./poller":17}],10:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=6e4,g=a("./geocoding_model");b.exports=d.Collection.extend({model:g,url:function(a){var b=cdb.config.urlVersion("geocoding",a);return"/api/"+b+"/geocodings"},initialize:function(a,b){this.user=b.user,this.vis=b.vis},parse:function(a){var b=this;return e.each(a.geocodings,function(a){var c=b.filter(function(b){return b.get("id")===a.id});0===c.length&&b._checkOngoingGeocoding(new g(a,{startPollingAutomatically:!1}))}),this.models},_checkOngoingGeocoding:function(a){if(this.vis){var b=this;this.vis.map.layers.each(function(c){c.table&&c.table.id===a.get("table_name")&&(b.add(a),a.pollCheck())})}else this.add(a),a.pollCheck()},canGeocode:function(){return!this.any(function(a){return a.isOngoing()})},fetchGeocodings:function(){var a=this;this.fetch({error:function(b){a.destroyCheck()}})},pollCheck:function(a){if(!this.pollTimer){var b=this;this.pollTimer=setInterval(function(){b.fetchGeocodings()},f),this.fetchGeocodings()}},destroyCheck:function(){clearInterval(this.pollTimer),delete this.pollTimer},failedItems:function(){return this.filter(function(a){return a.hasFailed()})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./geocoding_model":8}],11:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null,f=a("./import_model_poller");b.exports=d.core.Model.extend({url:function(a){var b=d.config.urlVersion("import",a),c="/api/"+b+"/imports";return this.isNew()?c:c+"/"+this.id},idAttribute:"item_queue_id",initialize:function(){this._initBinds(),this.poller=new f(this)},_initBinds:function(){this.bind("change:item_queue_id",this._checkQueueId,this)},createImport:function(a){var b=this._prepareData(a);this[0===b.interval?"_createRegularImport":"_createSyncImport"](b)},_checkQueueId:function(){this.get("item_queue_id")&&this.pollCheck()},_prepareData:function(a){var b={create_vis:a.create_vis,privacy:a.privacy},c=a.type;"remote"!==c&&_.extend(b,{type_guessing:a.type_guessing,content_guessing:a.content_guessing,interval:a.interval});var d=a.service_name;if("url"===c&&_.extend(b,{url:a.value}),"remote"===c&&_.extend(b,{type:"remote",interval:null,remote_visualization_id:a.remote_visualization_id,create_vis:!1,value:a.value}),"sql"===c&&_.extend(b,{table_name:a.table_name,sql:a.value}),"duplication"===c&&_.extend(b,{table_name:a.table_name,table_copy:a.value}),"service"===c){var e="twitter_search"===d?JSON.stringify(a.service_item_id):a.service_item_id;a.user_defined_limits&&(b.user_defined_limits=a.user_defined_limits),_.extend(b,{value:a.value,service_name:a.service_name,service_item_id:e})}return b},_createSyncImport:function(a){var b=this,c=new e.TableSynchronization(a);c.save(null,{success:function(a){b.set("item_queue_id",a.get("data_import").item_queue_id)},error:function(a,c,d){b._setErrorState(c)}})},_createRegularImport:function(a){var b=this;this.save(a,{error:function(a,c,d){b._setErrorState(c)}})},_setErrorState:function(a){var b;try{b=a&&JSON.parse(a.responseText).errors.imports}catch(a){b="Unfortunately there was an error starting the import"}this.set({state:"failure",get_error_text:{title:"There was an error",what_about:b}})},pollCheck:function(){this.poller.start()},destroyCheck:function(){this.poller.stop()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./import_model_poller":12}],12:[function(a,b,c){var d=a("./poller"),e=function(a){var b=2e3,c=2.5,e=30,f={interval:function(a){return a>=e?b*c:b},stopWhen:function(a){var b=a.get("state");return"complete"===b||"failure"===b}};d.call(this,a,f)};e.prototype=_.extend({},d.prototype),b.exports=e},{"./poller":17}],13:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=3e4,g=a("./imports_model");b.exports=d.Collection.extend({model:g,url:function(a){var b=cdb.config.urlVersion("import",a);return"/api/"+b+"/imports"},initialize:function(a,b){this.user=b.user},parse:function(a){var b=this;return 0===a.imports.length?this.destroyCheck():e.each(a.imports,function(a){var c=b.filter(function(b){return b.imp.get("item_queue_id")===a});0===c.length&&b.add(new g({id:a},{user:b.user}))}),this.models},canImport:function(){var a=this.user.getMaxConcurrentImports(),b=this.size(),c=0;return this.each(function(a){(a.hasFailed()||a.hasCompleted())&&++c}),b-c<a},pollCheck:function(a){if(!this.pollTimer){var b=this;this.pollTimer=setInterval(function(){b.fetch()},f||2e3),this.fetch()}},destroyCheck:function(){clearInterval(this.pollTimer),delete this.pollTimer},failedItems:function(){return this.filter(function(a){return a.hasFailed()})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./imports_model":14}],14:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./import_model"),g=a("./upload_model");b.exports=d.core.Model.extend({defaults:{step:"upload",state:""},initialize:function(a,b){e.isEmpty(b)&&(b={}),this.user=b&&b.user,this.upl=new g(b.upload,{user:this.user}),this.imp=new f(b.import),this._initBinds(),this._checkStatus()},_initBinds:function(){this.bind("change:import",this._onImportChange,this),this.bind("change:upload",this._onUploadChange,this),this.bind("change:id",this._onIdChange,this),this.imp.bind("change",function(){this.trigger("change:import"),this.trigger("change")},this),this.upl.bind("change",function(){this.trigger("change:upload"),this.trigger("change")},this)},_destroyBinds:function(){this.upl.unbind(null,null,this),this.imp.unbind(null,null,this)},_onIdChange:function(){var a=this.get("id");a&&this.imp.set("item_queue_id",a),this.set("step","import")},_onUploadChange:function(a,b){if("upload"===this.get("step")){var c=this.upl.get("item_queue_id"),d=this.upl.get("state");c&&this.set("id",c),d&&this.set("state",d)}},_onImportChange:function(){if("import"===this.get("step")){var a=this.imp.get("state");a&&this.set("state",a)}},_checkStatus:function(){return this.get("id")||this.upl.isValid()?void("file"===this.upl.get("type")?this.upl.upload():this.get("id")?(this.set("step","import"),this.imp.set("item_queue_id",this.get("id"))):this.imp.get("item_queue_id")||""===this.upl.get("type")||(this.set("step","import"),this.imp.createImport(this.upl.toJSON()))):void this.trigger("change:upload")},pause:function(){this.stopUpload(),this.stopImport()},hasFailed:function(){var a=this.get("state"),b=this.get("step");return"import"===b&&"failure"===a||"upload"===b&&"error"===a},hasCompleted:function(){return"import"===this.get("step")&&this.imp&&"complete"===this.imp.get("state")},getWarnings:function(){var a=this.get("step");return"import"===a?this.imp.get("warnings"):""},getError:function(){if(this.hasFailed()){var a=this.get("step");return e.extend({error_code:this["upload"===a?"upl":"imp"].get("error_code"),item_queue_id:"import"===a?this.imp.get("id"):"",original_url:"import"===a?this.imp.get("original_url"):"",data_type:"import"===a?this.imp.get("data_type"):"",http_response_code:"import"===a?this.imp.get("http_response_code"):"",http_response_code_message:"import"===a?this.imp.get("http_response_code_message"):""},this["upload"===a?"upl":"imp"].get("get_error_text"))}return{title:"",what_about:"",error_code:""}},importedVis:function(){return this.get("import").derived_visualization_id?this._getMapVis():this._getDatasetVis()},_getMapVis:function(){var a=this.imp.get("derived_visualization_id");return!!a&&this._createVis({type:"derived",id:a})},_getDatasetVis:function(){var a=this.imp.get("table_name");return!!a&&this._createVis({type:"table",table:{name:a}})},_createVis:function(a){var b=new d.admin.Visualization(a);return b.permission.owner=this.user,b},setError:function(a){var b=this.get("step"),c=this["upload"===b?"upl":"imp"];this.stopUpload(),this.stopImport(),c.set(a),this.set("state","error")},stopUpload:function(){this.upl.stopUpload()},stopImport:function(){this.imp.destroyCheck()},get:function(a){return"upload"===a?this.upl.toJSON():"import"===a?this.imp.toJSON():d.core.Model.prototype.get.call(this,a)},toJSON:function(){return{step:this.get("step"),id:this.get("id"),state:this.get("state"),upload:this.upl.toJSON(),import:this.imp.toJSON()}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./import_model":11,"./upload_model":19}],15:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.core.Model.extend({initialize:function(a){if(!a.table)throw new Error("table is required");if(!a.longitude_column)throw new Error("longitude_column is required");if(!a.latitude_column)throw new Error("latitude_column is required");if(!d.isBoolean(a.force_all_rows))throw new Error("force_all_rows is required");this.set("table_name",a.table.get("name")),this._startGeocoding()},_startGeocoding:function(){this._changeState("isOngoing");var a=this,b=this.get("table");b.save({longitude_column:this.get("longitude_column"),latitude_column:this.get("latitude_column"),force_all_rows:this.get("force_all_rows")},{success:function(){b.trigger("geolocated"),b.data().fetch(),a._changeState("hasCompleted")},error:function(b,c){var d;try{d=c&&JSON.parse(c.responseText).errors[0]}catch(a){d="Unknown error"}a.set("error",d),a._changeState("hasFailed")},wait:!0})},isOngoing:function(){return this.get("isOngoing")},hasCompleted:function(){return this.get("hasCompleted")},hasFailed:function(){return this.get("hasFailed")},getError:function(){return this.get("error")},_changeState:function(a){var b=d.reduce(["isOngoing","hasCompleted","hasFailed"],function(b,c){return b[c]=c===a,b},{});this.set(b)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],16:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("cartodb-pecan");b.exports=e.core.Model.extend({_PRINT_STATS:!0,defaults:{table_id:"",column:"",state:"idle"},initialize:function(){d.bindAll(this,"_onDescribe"),this.sql=e.admin.SQL(),this.query="SELECT * FROM "+this.get("table_id")},getData:function(){this.sql.describe(this.query,this.get("column"),{},this._onDescribe)},_onDescribe:function(a){var b={state:"analyzed",success:!1};this._PRINT_STATS&&this.trigger("print_stats",a,this);var c=f.hasEnoughToGuess({stats:a,isPointGeometryType:"point"===this.get("geometry_type")});if(c){var e=f.guessMap({tableName:this.get("table_id"),column:{stats:a,geometryType:this.get("geometry_type"),bbox:this.get("bbox")},dependencies:{underscore:d}});if(e){var g={sql:this.query,success:!0};b=d.extend(b,g,a,e)}}"geom"===a.type&&a.bbox&&(b.bbox=a.bbox),this.set(b)},isAnalyzed:function(){return"analyzed"===this.get("state")},hasFailed:function(){return"failed"===this.get("state")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"cartodb-pecan":528}],17:[function(a,b,c){var d=function(a,b){this.model=a,this.numberOfRequests=0,this.polling=!1,this.interval=b.interval,"function"!=typeof this.interval&&(this.interval=function(){return b.interval}),this.stopWhen=b.stopWhen,this.error=b.error,this.autoStart=b.autoStart,this.autoStart&&this.start()};d.prototype.start=function(){this.timeout||this._scheduleFetch()},d.prototype._scheduleFetch=function(){this.timeout=setTimeout(this._fetch.bind(this),this.interval(this.numberOfRequests))},d.prototype._fetch=function(){var a=this;a.polling||(a.polling=!0,a.model.fetch({success:function(){a.polling=!1,a.numberOfRequests++,a._continuePolling()&&a._scheduleFetch()},error:function(b){_.isFunction(a.error)&&a.error(a.model)}}))},d.prototype._continuePolling=function(){return!this.stopWhen||_.isFunction(this.stopWhen)&&!this.stopWhen(this.model)},d.prototype.stop=function(){this.polling=!1,clearTimeout(this.timeout),delete this.timeout},b.exports=d},{}],18:[function(a,b,c){b.exports={uploadStates:["enqueued","pending","importing","uploading","guessing","unpacking","getting","creating","complete"],fileExtensions:["csv","xls","xlsx","zip","kml","geojson","json","ods","kmz","tsv","gpx","tar","gz","tgz","osm","bz2","tif","tiff","txt","sql","rar","carto","gpkg"],fileTimesBigger:3}},{}],19:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,e=a("./upload_config"),f="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,g="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null,h="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;b.exports=d.Model.extend({url:"/api/v1/imports",fileAttribute:"filename",defaults:{type:"",value:"",interval:0,privacy:"",progress:0,state:"idle",service_item_id:"",service_name:"",option:"",content_guessing:!0,type_guessing:!0,create_vis:!0},initialize:function(a,b){this.user=b&&b.user,this._initBinds(),this._validate(this.attributes,{validate:!0})},isValidToUpload:function(){
return this.get("value")&&"error"!==this.get("state")},setFresh:function(a){a&&!h.isEmpty(a)?this.set(h.omit(a,"create_vis")):this.clear()},_initBinds:function(){this.bind("progress",function(a){this.set({progress:100*a,state:"uploading"})},this),this.bind("change:value",function(){"error"===this.get("state")&&(this.set({state:"idle"}),this.unset("get_error_text",{silent:!0}))},this),this.bind("error invalid",function(a,b){this.set({state:"error",error_code:b&&b.error_code||"",get_error_text:{title:"Invalid import",what_about:b&&b.msg||""}},{silent:!0}),this.trigger("change")},this)},validate:function(a){if(a){if("file"===a.type){if(a.value&&a.value.length)return{msg:"Unfortunately only one file is allowed per upload"};var b=a.value.name;if(!b)return{msg:"File name should be defined"};var c=b.substr(b.lastIndexOf(".")+1);if(c&&(c=c.toLowerCase()),!h.contains(e.fileExtensions,c))return{msg:"Unfortunately this file extension is not allowed"};if(this.user&&this.user.get("remaining_byte_quota")*e.fileTimesBigger<a.value.size)return{msg:"Unfortunately the size of the file is bigger than your remaining quota",error_code:8001}}if("remote"===a.type){if(!a.remote_visualization_id)return{msg:"The remote visualization id was not specified"};if(this.user&&a.size&&this.user.get("remaining_byte_quota")*e.fileTimesBigger<a.size)return{msg:"Unfortunately the size of the remote dataset is bigger than your remaining quota",error_code:8001}}if("url"===a.type&&!f.isURL(a.value))return{msg:"Unfortunately the URL provided is not valid"};if("sql"===a.type&&!a.value)return{msg:"Query is not provided"};if("duplication"===a.type&&!a.value)return{msg:"Dataset copy is not defined"};if("service"===a.type&&"twitter_search"===a.service_name){var d=a.service_item_id;if(!d||h.isEmpty(d))return{msg:"Twitter data is empty"};if(h.isEmpty(d.categories))return{msg:"Twitter categories are not valid"};var i=d.dates;if(!i||h.isEmpty(i))return{msg:"Twitter dates are empty"};var j=g(i.fromDate)<=g(new Date);if(!i.fromDate||!i.toDate||!j)return{msg:"Twitter dates are not valid"}}}},isValid:function(){return this.get("value")&&"error"!==this.get("state")},upload:function(){if("file"===this.get("type")){var a=this;this.xhr=this.save({filename:this.get("value")},{success:function(a){a.set("state","uploaded")},error:function(b,c){var d="Unfortunately there was a connection error";if(c&&429===c.status){var e=JSON.parse(c.responseText);d=e.errors.imports}a.set({state:"error",get_error_text:{title:"There was an error",what_about:d}})},complete:function(){delete a.xhr}})}},stopUpload:function(){this.xhr&&this.xhr.abort()},setGuessing:function(a){this.set({type_guessing:a,content_guessing:a})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./upload_config":18}],20:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=(a("../../../view_factory"),a("../../../dialogs/pecan/pecan_dialog_view"));b.exports=d.core.View.extend({className:"ImportItem",tagName:"li",events:{"click .js-abort":"_removeItem","click .js-show_dialog":"_showDialog","click .js-close":"_removeItem"},initialize:function(){this.user=this.options.user,this.vis=this.options.vis,this.template=d.templates.getTemplate("common/background_polling/views/analysis/background_analysis_item"),this._initBinds()},render:function(){var a=this.collection.getTotalAnalysis(),b=this.collection.getCompletedAnalysis(),c=this.collection.getSuccessfullyAnalysedColumns(),d={totalSuccess:c,totalItems:a,totalAnalyzed:b,progress:b/a*100};return this.$el.html(this.template(d)),this},_initBinds:function(){this.collection.bind("change:state",this._onChangeState,this),this.add_related_model(this.collection)},_onChangeState:function(){var a=this.collection.getTotalAnalysis(),b=this.collection.getCompletedAnalysis(),c=this.collection.getSuccessfullyAnalysedColumns();this.render(),b===a&&0===c&&this._removeItem()},_showDialog:function(){var a=new e({clean_on_hide:!0,vis:this.vis,collection:this.collection,user:this.user});a.appendToBody()},_skip:function(){var a,b=this.vis.get("active_layer_id"),c=this.vis.map.layers.where({id:b});c&&(a=c[0].table.get("name"));var d="pecan_"+this.user.get("username")+"_"+a;localStorage[d]=!0},_removeItem:function(){this.trigger("remove",this.collection,this),this._skip(),this.clean()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../dialogs/pecan/pecan_dialog_view":197,"../../../view_factory":237}],21:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({tagName:"h3",className:"CDB-Text CDB-Size-large u-lSpace--xl",initialize:function(){this.template=c.templates.getTemplate("common/background_polling/views/background_polling_header_title"),this._initBinds()},render:function(){return this.$el.html(this.template({imports:this.model.getTotalImports(),geocodings:this.model.getTotalGeocodings(),analysis:this.model.getTotalAnalysis(),totalPollings:this.model.getTotalPollings()})),this},_initBinds:function(){this.model.bind("change analysisAdded analysisRemoved importAdded importRemoved geocodingAdded geocodingRemoved",this.render,this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],22:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./background_polling_header_title_view");b.exports=d.core.View.extend({className:"BackgroundPolling-header",initialize:function(){this.template=d.templates.getTemplate("common/background_polling/views/background_polling_header"),this._initBinds()},render:function(){return this.$el.html(this.template()),this._initViews(),this._updateBadges(),this},_initBinds:function(){this.model.bind("change importAdded importRemoved geocodingAdded geocodingRemoved",this._updateBadges,this)},_initViews:function(){var a=new e({model:this.model});this.$el.append(a.render().el),this.addView(a)},_updateBadges:function(){var a=this.model.getTotalFailedItems();if(0===this.$(".BackgroundPolling-headerBadgeCount").length&&a>0){var b=$("<span>").addClass("BackgroundPolling-headerBadgeCount Badge Badge--negative CDB-Text CDB-Size-small").text(a);this.$(".BackgroundPolling-headerBadge").append(b).addClass("has-failures")}else this.$(".BackgroundPolling-headerBadgeCount").length>0&&a>0?this.$(".BackgroundPolling-headerBadgeCount").text(a):0===a&&(this.$(".BackgroundPolling-headerBadgeCount").remove(),this.$(".BackgroundPolling-headerBadge").removeClass("has-failures"));var c=this.model.getTotalGeocodings(),d=c>0&&c===this.model.getTotalPollings();this.$(".js-icon").toggleClass("CDB-IconFont-marker",d),this.$(".js-icon").toggleClass("CDB-IconFont-cloud",!d)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./background_polling_header_title_view":21}],23:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,g=a("../../../view_helpers/pluralize_string"),h=a("./geocoding_result_details_view");b.exports=d.core.View.extend({className:"ImportItem",tagName:"li",events:{"click .js-abort":"_cancelGeocoding","click .js-info":"_showDetails","click .js-close":"_removeGeocoding"},initialize:function(){this.user=this.options.user,this.template=d.templates.getTemplate("common/background_polling/views/geocodings/background_geocoding_item"),this._initBinds()},render:function(){var a=this.model.get("processed_rows")||0,b=this.model.get("processable_rows")||0,c=this.model.get("real_rows")||0,d=this.model.get("latitude_column")&&this.model.get("longitude_column"),h={realRows:c,tableName:this.model.get("table_name"),canCancel:e.isFunction(this.model.cancelGeocoding),hasFailed:this.model.hasFailed(),hasCompleted:this.model.hasCompleted(),processedRows:a,processableRows:b,processableRowsFormatted:f.formatNumber(b),realRowsPluralize:g("row","rows",this.model.get("real_rows")),realRowsFormatted:f.formatNumber(c),processableRowsPluralize:g("row","rows",b),width:c>0?b/c:100,isLatLngType:d};return this.$el.html(this.template(h)),this},_initBinds:function(){this.model.bind("change",this.render,this),this.model.bind("remove",this.clean,this)},_cancelGeocoding:function(){this.model.cancelGeocoding()},_removeGeocoding:function(){this.trigger("remove",this.model,this),this.clean()},_showDetails:function(){new h({clean_on_hide:!0,user:this.user,model:this.model,showGeocodingDatasetURLButton:this.options.showGeocodingDatasetURLButton}).appendToBody()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_helpers/pluralize_string":240,"./geocoding_result_details_view":24}],24:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../../views/base_dialog/view"),f=a("../../../view_helpers/pluralize_string"),g="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null;b.exports=e.extend({className:"Dialog BackgroundPollingDetails is-opening",initialize:function(){this.elder("initialize"),this.user=this.options.user},render_content:function(){var a,b=this.model.get("error")||{},c=this.model.get("processed_rows")||0,e=this.model.get("processable_rows")||0,h=this.model.get("real_rows")||0,i=this.model.get("geometry_type")||"point",j=this.model.get("price"),k=void 0!==j&&null!==j,l=this.user.featureEnabled("google_maps");if(this.user&&this.model.get("table_name")){var m=new d.admin.Visualization({type:"table",table:{name:this.model.get("table_name")}});m.permission.owner=this.user,a=encodeURI(m.viewUrl(this.user).edit())}var n="common/background_polling/views/geocodings/";return n+=this.model.hasCompleted()?0===h?"geocoding_no_result_details":"geocoding_success_details":"geocoding_error_details",d.templates.getTemplate(n)({id:this.model.get("id"),geometryTypePluralize:f(i,i+"s",e),geometryType:i,remainingQuotaFormatted:g.formatNumber(this.model.get("remaining_quota")),googleUser:l,tableName:this.model.get("table_name"),state:this.model.get("state")||"",blockPrice:this.user.get("geocoding").block_price,realRows:h,realRowsFormatted:g.formatNumber(h),processedRows:c,processableRows:e,processableRowsFormatted:g.formatNumber(e),hasPrice:k,price:j,customHosted:d.config.get("cartodb_com_hosted"),errorDescription:b.description,showGeocodingDatasetURLButton:this.options.showGeocodingDatasetURLButton&&a,datasetURL:a})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_helpers/pluralize_string":240,"../../../views/base_dialog/view":242}],25:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../models/upload_config"),f=a("../../../views/error_details_view"),g=a("../../../views/warnings_details_view"),h=a("../../../view_factory"),i=a("./twitter_import_details_view");b.exports=d.core.View.extend({className:"ImportItem",tagName:"li",events:{"click .js-abort":"_removeItem","click .js-show_error":"_showImportError","click .js-show_warnings":"_showImportWarnings","click .js-show_stats":"_showImportStats","click .js-close":"_removeItem"},initialize:function(){this.user=this.options.user,this._showSuccessDetailsButton=this.options.showSuccessDetailsButton,this.template=d.templates.getTemplate("common/background_polling/views/imports/background_import_item"),this._initBinds()},render:function(){var a=this.model.get("upload"),b=this.model.get("import"),c={name:"",state:this.model.get("state"),progress:"",service:"",step:this.model.get("step"),url:"",failed:this.model.hasFailed(),completed:this.model.hasCompleted(),warnings:this.model.getWarnings(),showSuccessDetailsButton:this._showSuccessDetailsButton,tables_created_count:b.tables_created_count};if("complete"===c.state){var d=this.model.importedVis();d&&(c.url=encodeURI(d.viewUrl(this.user).edit()))}return a.type?("file"===a.type&&(a.value.length>1?c.name=a.value.length+" files":c.name=a.value.name),"url"!==a.type&&"remote"!==a.type||(c.name=a.value),"service"===a.type&&(c.name=a.value&&a.value.filename||""),"twitter_search"===a.service_name&&(c.name="Twitter import"),"sql"===a.type&&(c.name="SQL"),"duplication"===a.type&&(c.name=a.table_name||a.value)):c.name=b.display_name||b.item_queue_id||"import",c.service=a.service_name,"upload"===this.model.get("step")?c.progress=this.model.get("upload").progress:c.progress=e.uploadStates.indexOf(c.state)/e.uploadStates.length*100,this.$el.html(this.template(c)),this},_initBinds:function(){this.model.bind("change",this.render,this),this.model.bind("remove",this.clean,this)},_removeItem:function(){this.trigger("remove",this.model,this),this.model.pause(),this.clean()},_showImportStats:function(){new i({clean_on_hide:!0,user:this.user,model:this.model}).appendToBody()},_showImportError:function(){var a=h.createDialogByView(new f({err:this.model.getError(),user:this.user}));a.appendToBody()},_showImportWarnings:function(){var a=h.createDialogByView(new g({warnings:this.model.getWarnings(),user:this.user}));a.appendToBody()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_factory":237,"../../../views/error_details_view":254,"../../../views/warnings_details_view":260,"../../models/upload_config":18,"./twitter_import_details_view":27}],26:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"ImportItem ImportItem--sticky",tagName:"li",initialize:function(){this.user=this.options.user,this.template=c.templates.getTemplate("common/background_polling/views/imports/background_import_limit")},render:function(){var a=this.user.getMaxConcurrentImports(),b=!c.config.get("cartodb_com_hosted")&&1===a;return this.$el.html(this.template({upgradeUrl:window.upgrade_url,isUpgradeable:b,importQuota:a})),this}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],27:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../../views/base_dialog/view"),f="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null;b.exports=e.extend({className:"Dialog TwitterImportDetails is-opening",initialize:function(){this.elder("initialize"),this.user=this.options.user,this.template=d.templates.getTemplate("common/background_polling/views/imports/twitter_import_details")},render_content:function(){var a=this.model.get("import"),b=this.user.get("twitter"),c=b.quota-b.monthly_use,d=this.model.importedVis(),e=d&&encodeURI(d.viewUrl(this.user).edit())||"",g={type:d&&"table"===d.get("type")?"dataset":"map",mapURL:e,datasetTotalRows:a.tweets_georeferenced,datasetTotalRowsFormatted:f.formatNumber(a.tweets_georeferenced),tweetsCost:a.tweets_cost,tweetsCostFormatted:f.formatNumber(a.tweets_cost),availableTweets:c,availableTweetsFormatted:f.formatNumber(c),tweetsOverquota:a.tweets_overquota,tweetsOverquotaFormatted:f.formatNumber(a.tweets_overquota),blockSizeFormatted:f.formatNumber(b.block_size),blockPriceFormatted:f.formatNumber(b.block_price)};return this.template(g)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../views/base_dialog/view":242}],28:[function(a,b,c){(function(c){var d=a("queue-async"),e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;b.exports=function(a){var b=d(a.howManyInParallel);e.each(a.items,function(c){b.defer(function(b){a.processItem(c,b)})}),b.awaitAll(function(b){b?a.fail(b):a.done()})}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"queue-async":557}],29:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f=a("./xyz/xyz_model.js"),g=a("./wms/wms_model.js"),h=a("./nasa/nasa_model.js"),i=a("./mapbox/mapbox_model.js"),j=a("./tile_json/tile_json_view_model.js");b.exports=d.core.Model.extend({defaults:{map:void 0,baseLayers:void 0,tabs:void 0,currentView:"tabs",currentTab:"xyz"},initialize:function(a){if(this.elder("initialize"),!a.map)throw new Error("map is required");if(!a.baseLayers)throw new Error("baseLayers is required");this._initTabs(),this._initBinds()},activeTabModel:function(){return this.get("tabs").where({name:this.get("currentTab")})[0]},canSaveBasemap:function(){return"tabs"===this.get("currentView")&&this._layerToSave()},saveBasemap:function(){if(this.canSaveBasemap()){this.set("currentView","saving");var a=this._layerToSave();if(this.activeTabModel().hasAlreadyAddedLayer(this.get("baseLayers")))this._onLayerSaved(a);else{this.get("baseLayers").add(a);var b=this;a.save().done(function(){b._onLayerSaved(a)}).fail(function(){b.get("baseLayers").remove(a),b.set("currentView","saveFail")})}}},_onLayerSaved:function(a){var b=this.get("map"),c=a.clone();c.unset("id"),b.changeProvider("leaflet",c);var d=a.get("bounding_boxes");d&&4===d.length&&b.setBounds([[d[1],d[0]],[d[3],d[2]]]),this.set("currentView","saveDone")},_initTabs:function(){var a=new e.Collection([new f,new g({baseLayers:this.get("baseLayers")}),new h,new i,new j]);this.set({tabs:a,currentTab:a.first().get("name")})},_initBinds:function(){this.get("tabs").each(function(a){a.bind("saveBasemap",this.saveBasemap,this)},this)},_layerToSave:function(){return this.activeTabModel().get("layer")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./mapbox/mapbox_model.js":31,"./nasa/nasa_model.js":34,"./tile_json/tile_json_view_model.js":38,"./wms/wms_model.js":43,"./xyz/xyz_model.js":45}],30:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=("undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,"undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null),f=a("../../views/base_dialog/view.js"),g=a("../../view_helpers/random_quote.js"),h=a("../../view_factory.js"),i=a("./add_custom_basemap_model.js"),j=a("./tabs_view.js");b.exports=f.extend({initialize:function(){this.elder("initialize"),this.model=new i({map:this.options.map,baseLayers:this.options.baseLayers}),this._initViews(),this._initBinds()},render:function(){return f.prototype.render.apply(this,arguments),this.$(".content").addClass("Dialog-contentWrapper"),this},render_content:function(){var a=this._panes.active(this.model.get("currentView")).render();a.$el.addClass("Dialog-body Dialog-body--expanded Dialog-body--create"),a.delegateEvents();var b=e(d.templates.getTemplate("common/dialogs/add_custom_basemap/add_custom_basemap")({model:this.model}));return b.append(a.el),b},ok:function(){this.model.canSaveBasemap()&&this.model.saveBasemap()},_initViews:function(){this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("tabs",new j({model:this.model})),this._panes.addTab("saving",h.createByTemplate("common/templates/loading",{title:"Setting basemap…",quote:g()}).render()),this._panes.addTab("saveFail",h.createByTemplate("common/templates/fail",{msg:""}).render()),this._panes.active(this.model.get("currentView"))},_initBinds:function(){this.model.bind("change:currentView",this._onCurrentViewChange,this)},_onCurrentViewChange:function(){"saveDone"===this.model.get("currentView")?this.close():this.render()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory.js":237,"../../view_helpers/random_quote.js":241,"../../views/base_dialog/view.js":242,"./add_custom_basemap_model.js":29,"./tabs_view.js":36}],31:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./mapbox_view"),g=a("./mapbox_to_tile_layer_factory");b.exports=d.core.Model.extend({defaults:{name:"mapbox",label:"Mapbox",currentView:"enterURL",lastErrorMsg:"",layer:void 0},createView:function(){return this.set({currentView:"enterURL",layer:void 0}),new f({model:this})},hasAlreadyAddedLayer:function(a){var b=this.get("layer").get("urlTemplate");return e.any(a.custom(),function(a){return a.get("urlTemplate")===b})},save:function(a,b){this.set({currentView:"validatingInputs",url:a,accessToken:b});var c=this,d=new g({url:a,accessToken:b});d.createTileLayer({success:function(a){c.set("layer",a),c.trigger("saveBasemap")},error:function(a){c.set({currentView:"enterURL",lastErrorMsg:a})}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./mapbox_to_tile_layer_factory":32,"./mapbox_view":33}],32:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=e.core.Model.extend({defaults:{url:"",accessToken:""},_MAPBOX:{version:4,https:"https://dnv9my2eseobd.cloudfront.net",base:"https://a.tiles.mapbox.com/"},createTileLayer:function(a){var b,d=this.get("url"),e=this._lowerXYZ(d),f=this.get("accessToken"),g="json",h=["a","b","c"];e.indexOf("{x}")<0&&e.indexOf("tiles.mapbox.com")!==-1?(b=this._getMapBoxMapID(e),b&&(g="mapbox_id",e=b)):e.indexOf("{x}")!==-1?(g="xyz",e=e.replace(/\{s\}/g,function(){return h[Math.floor(3*Math.random())]}).replace(/\{x\}/g,"0").replace(/\{y\}/g,"0").replace(/\{z\}/g,"0")):e&&e.indexOf("http")<0&&null!=e.match(/(.*?)\.(.*)/)&&3===e.match(/(.*?)\.(.*)/).length?(g="mapbox_id",b=d):e=this._fixHTTPS(e);var i,j=this;if("mapbox"===g)a.success(this._newTileLayer({tiles:[e]}));else if("xyz"===g)i=new Image,i.onload=function(){a.success(j._newTileLayer({tiles:[j._lowerXYZ(d)]}))},i.onerror=function(){a.error(j._errorToMsg())},i.src=e;else if("mapbox_id"===g){var k="?access_token="+f,l=this._MAPBOX.base+"v"+this._MAPBOX.version+"/"+b,m=l+"/{z}/{x}/{y}.png"+k,n=l+".json"+k,o=setTimeout(function(){a.error(j._errorToMsg())},5e3);c.ajax({url:n,success:function(b){clearTimeout(o),a.success(j._newTileLayer({tiles:[m],attribution:b.attribution,minzoom:b.minzoom,maxzoom:b.maxzoom,name:b.name}))},error:function(b){clearTimeout(o),a.error(j._errorToMsg(b))}})}else a.error(this._errorToMsg())},_newTileLayer:function(a){return d.isArray(a)&&d.size(a)>0&&(a=d.first(a)),new e.admin.TileLayer({urlTemplate:a.tiles[0],attribution:a.attribution||null,maxZoom:a.maxzoom||21,minZoom:a.minzoom||0,name:a.name||""})},_errorToMsg:function(a){return"object"!=typeof a&&a?a:a&&a.status&&401===a.status?"Error retrieving your basemap. Please, check your access token.":"This value is not valid."},_lowerXYZ:function(a){return a.replace(/\{S\}/g,"{s}").replace(/\{X\}/g,"{x}").replace(/\{Y\}/g,"{y}").replace(/\{Z\}/g,"{z}")},_getMapBoxMapID:function(a){var b=/https?:\/\/[a-z]?\.?tiles\.mapbox.com\/v(\d)\/([^\/.]*)\.([^\/.]*)/,c=/https?:\/\/tiles\.mapbox\.com\/(.*?)\/edit\/(.*?)(\?|#)/,d="";return d=a.match(b),d&&d[1]&&d[2]?d[2]+"."+d[3]:(d=a.match(c),d&&d[1]&&d[2]?d[1]+"."+d[2]:void 0)},_fixHTTPS:function(a,b){if(b=b||location,0!==a.indexOf("https")&&"https:"===b.protocol){var c=a.indexOf("mapbox.com");return c!==-1?this._MAPBOX.https+a.substr(c+"mapbox.com".length):a.replace(/http/,"https")}return a}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],33:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../../view_factory.js"),f=a("../../../view_helpers/random_quote.js");b.exports=d.core.View.extend({events:{"click .js-ok":"_onClickOK",keydown:"_onKeyDown",keyup:"_onKeyUp"},initialize:function(){this.elder("initialize"),this._initBinds()},render:function(){this.clearSubViews();var a;switch(this.model.get("currentView")){case"validatingInputs":a=e.createByTemplate("common/templates/loading",{title:"Validating…",quote:f()});break;case"enterURL":default:a=e.createByTemplate("common/dialogs/add_custom_basemap/mapbox/enter_url",{url:this.model.get("url"),accessToken:this.model.get("accessToken"),lastErrorMsg:this.model.get("lastErrorMsg")})}return this.addView(a),this.$el.append(a.render().el),this},_initBinds:function(){this.model.bind("change",this.render,this)},_hasValues:function(){return this._urlVal()&&this._accessToken()},_urlVal:function(){return this.$(".js-url").val()},_accessToken:function(){return this.$(".js-access-token").val()},_onClickOK:function(a){if(this.killEvent(a),this._hasValues()){var b=this._urlVal(),c=this._accessToken();this.model.save(b,c)}},_onKeyDown:function(a){a.stopPropagation(),this.$(".js-error").removeClass("is-visible")},_onKeyUp:function(a){a.stopPropagation(),this.$(".js-ok").toggleClass("is-disabled",!this._hasValues())}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_factory.js":237,"../../../view_helpers/random_quote.js":241}],34:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./nasa_view"),g="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null,h={day:{url:"http://map1.vis.earthdata.nasa.gov/wmts-webmerc/MODIS_Terra_CorrectedReflectance_TrueColor/default/<%- date %>/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpeg",limit:"2012-05-01",default:"2012-05-01",attribution:'<a href="http://earthdata.nasa.gov/gibs" target="_blank">NASA EOSDIS GIBS</a>',name:"NASA Terra",maxZoom:9,minZoom:1},night:{url:"http://map1.vis.earthdata.nasa.gov/wmts-webmerc/VIIRS_CityLights_2012/default/<%- date %>/GoogleMapsCompatible_Level8/{z}/{y}/{x}.jpeg",limit:"2012-05-01",default:"2012-05-02",attribution:'<a href="http://earthdata.nasa.gov/gibs" target="_blank">NASA EOSDIS GIBS</a>',name:"NASA Earth at night",maxZoom:8,minZoom:1}};b.exports=d.core.Model.extend({defaults:{name:"nasa",label:"NASA",layer:void 0,layerType:"day",date:void 0,current:void 0,format:"Y-m-d"},initialize:function(){this.elder("initialize"),this._initBinds()},createView:function(){var a=(new Date).getTimezoneOffset(),b=g(new Date).utcOffset(a).format("YYYY-MM-DD"),c=g(new Date).utcOffset(a).subtract(1,"days").format("YYYY-MM-DD");return this.set({current:b,date:c}),new f({model:this})},hasAlreadyAddedLayer:function(a){var b=this.get("layer").get("urlTemplate");return e.any(a.custom(),function(a){return a.get("urlTemplate")===b})},_initBinds:function(){this.bind("change:date change:layerType",this._onChange,this)},_onChange:function(){var a=this.get("date"),b=this.get("layerType");this.set("layer",new d.admin.TileLayer({urlTemplate:e.template(h[b].url)({date:a}),attribution:h[b].attribution,maxZoom:h[b].maxZoom,minZoom:h[b].minZoom,name:h[b].name+" "+a}))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./nasa_view":35}],35:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null,f=a("../../../edit_fields/date_field/date_field_view"),g=a("../../../edit_fields/edit_field_model");b.exports=d.core.View.extend({options:{dateFormat:"YYYY-MM-DD"},events:{"click .js-day":"_onChangeToDay","click .js-night":"_onChangeToNight"},initialize:function(){this.elder("initialize"),this.dateModel=new g({value:this.model.get("date"),type:"date"}),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(d.templates.getTemplate("common/dialogs/add_custom_basemap/nasa/nasa")({layerType:this.model.get("layerType"),initialDateStr:e(this.dateModel.get("value")).format(this.options.dateFormat)})),this._renderDatePicker(),this},_initBinds:function(){this.model.bind("change:layerType",function(){this.dateModel.set("readOnly","night"===this.model.get("layerType")),this.render()},this),this.dateModel.bind("change:value",function(){var a=e(this.dateModel.get("value")).format(this.options.dateFormat);this.model.set("date",a)},this),this.add_related_model(this.dateModel)},_renderDatePicker:function(){var a=new f({model:this.dateModel,showTime:!1,showGMT:!1});this.addView(a),this._$datePicker().append(a.render().el),this.dateModel.get("readOnly")&&this.addView(new d.common.TipsyTooltip({el:this._$datePicker(),title:function(a){return $(this).attr("data-title")}}))},_onChangeToNight:function(a){this.model.set("layerType","night")},_onChangeToDay:function(){this.model.set("layerType","day")},_$datePicker:function(){return this.$(".js-datePicker")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../edit_fields/date_field/date_field_view":214,"../../../edit_fields/edit_field_model":218}],36:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null;b.exports=c.core.View.extend({events:{"click .js-tabs button":"_onClickTab"},initialize:function(){this.elder("initialize"),this._initBinds()},render:function(){var a=d(c.templates.getTemplate("common/dialogs/add_custom_basemap/tabs")({model:this.model}));return a.find(".js-tab-content").append(this._createTabContentView().el),this.$el.html(a),this},_initBinds:function(){this.model.bind("change:currentTab",this.render,this)},_createTabContentView:function(){return this._currentTabView&&this._currentTabView.clean(),this._currentTabView=this.model.activeTabModel().createView(),this.addView(this._currentTabView),this._currentTabView.render()},_onClickTab:function(a){this.killEvent(a);var b=d(a.target).closest("button").data("name");b?this.model.set("currentTab",b):c.log.error("tab name was expected but was empty")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],37:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.core.View.extend({events:{"keydown .js-url":"_update","paste .js-url":"_update"},initialize:function(){this.elder("initialize"),this._lastURL=""},render:function(){return this.$el.html(c.templates.getTemplate("common/dialogs/add_custom_basemap/tile_json/tile_json")({})),this},_update:function(a){a.stopPropagation(),this._debouncedUpdate()},_debouncedUpdate:d.debounce(function(){this._disableOkBtn(!0),this._indicateIsValidating(!0);var a=this._urlWithHTTP();if(a===this._lastURL)return this._indicateIsValidating(!1),void this._updateError();this._lastURL=a,this._indicateIsValidating(!0);var b=new c.admin.TileJSON({url:a}),d=this;b.fetch({success:function(){a===d._lastURL&&(d.model.set("layer",b.newTileLayer()),d._disableOkBtn(!1),d._indicateIsValidating(!1),d._updateError())},error:function(){a===d._lastURL&&(d._indicateIsValidating(!1),d._updateError("Invalid URL, please make sure it is correct"))}})},150),_disableOkBtn:function(a){this.$(".ok")[a?"addClass":"removeClass"]("is-disabled")},_updateError:function(a){this.$(".js-error").text(a)[a?"addClass":"removeClass"]("is-visible");
},_indicateIsValidating:function(a){a?(this.$(".js-idle").hide(),this.$(".js-validating").show()):(this.$(".js-validating").hide(),this.$(".js-idle").show())},_urlWithHTTP:function(){var a=this.$(".js-url").val();return a.indexOf("http://")===-1?"http://"+a:a}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],38:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./tile_json_view");b.exports=d.core.Model.extend({defaults:{name:"tile_json",label:"TileJSON",layer:void 0},createView:function(){return this.set({layer:void 0}),new f({model:this})},hasAlreadyAddedLayer:function(a){var b=this.get("layer").get("urlTemplate");return e.any(a.custom(),function(a){return a.get("urlTemplate")===b})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./tile_json_view":37}],39:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.core.Model.extend({defaults:{state:"idle",layer:void 0},canSave:function(a){return!d.any(a.custom(),function(a){return a.get("name")===this.get("title")},this)},save:function(){this.set("state","saving"),this._shouldBeProxied()?this._createProxiedLayer():this._newTileLayer()},_shouldBeProxied:function(){if("wmts"===this.get("type")){var a=c.admin.WMSService.supportedMatrixSets(this.get("matrix_sets")||[]);return a.length>0}return!0},_createProxiedLayer:function(){var a=this,b=new c.admin.WMSService({wms_url:this.url(),title:this.get("title"),name:this.get("name"),layer:this.get("name"),srs:this.get("srs"),bounding_boxes:this.get("llbbox"),type:this.get("type"),matrix_sets:this.get("matrix_sets")});c.god.trigger("metrics","select_wms",{email:window.user_data.email});var a=this;return b.save({},{success:function(b){var c;try{c=b.newTileLayer()}catch(a){}c?a._setNewTileLayer(c):a.set("state","saveFail")},error:function(){a.set("state","saveFail")}}),b},_setNewTileLayer:function(a){this.set({state:"saveDone",tileLayer:a})},_newTileLayer:function(){var a=c.admin.TileLayer.byCustomURL(this._xyzURLTemplate(),!1);return a.set({name:this.get("title")||this.get("name"),attribution:this.get("attribution"),bounding_boxes:this.get("llbbox")}),this._setNewTileLayer(a),a},_xyzURLTemplate:function(){var a=this.get("url_template")||"";return a.replace(/%%\((\w)\)s/g,"{$1}")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],40:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({tagName:"li",className:"List-row",events:{"click .js-add":"_onClickAdd"},render:function(){return this.$el.html(c.templates.getTemplate("common/dialogs/add_custom_basemap/wms/layer")({model:this.model,canSave:this.model.canSave(this.options.baseLayers)})),this},_onClickAdd:function(a){this.killEvent(a),this.model.canSave(this.options.baseLayers)&&this.model.save()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],41:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,e=a("./layer_model.js");b.exports=d.Collection.extend({model:e,fetch:function(a,b){this.url=a;var c=new cdb.admin.WMSService({wms_url:a}),d=this;c.fetch().always(function(){d.reset(c.get("layers")),d.each(function(a){a.set("type",c.get("type"))}),b()})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./layer_model.js":39}],42:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f=a("../../../view_helpers/pluralize_string"),g=a("./layer_view.js");b.exports=d.core.View.extend({events:{"click .js-back":"_onClickBack"},render:function(){this.clearSubViews();var a=e(d.templates.getTemplate("common/dialogs/add_custom_basemap/wms/select_layer")({searchQuery:this.model.get("searchQuery"),layersFound:this.model.getLayers(),layersAvailableCount:this.model.layersAvailableCount(),pluralizeStr:f})),b=a.find(".js-layers");return b.append.apply(b,this._renderedLayers()),this.$el.html(a),this},_renderedLayers:function(){return this.model.getLayers().map(function(a){var b=new g({model:a,baseLayers:this.model.get("baseLayers")});return this.addView(b),b.render().el},this)},_onClickBack:function(a){this.killEvent(a),this.model.set("currentView","enterURL")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_helpers/pluralize_string":240,"./layer_view.js":40}],43:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./wms_view.js"),g=a("./layers_collection.js");b.exports=d.core.Model.extend({defaults:{name:"wms",label:"WMS/WMTS",currentView:"enterURL",layersFetched:!1,layers:void 0,baseLayers:void 0},initialize:function(){this.elder("initialize"),this.set("layers",new g),this._initBinds()},createView:function(){return this.set({currentView:"enterURL",layersFetched:!1}),new f({model:this})},fetchLayers:function(a){this.set("currentView","fetchingLayers");var b=this;this.get("layers").fetch(a,function(){b.set({currentView:b.get("layers").length>0?"selectLayer":"enterURL",layersFetched:!0})})},layersAvailableCount:function(){return e.difference(this.get("layers").pluck("title"),this.get("baseLayers").pluck("name")).length},get:function(a){return"layer"===a?this.get("layers").find(function(a){return"saveDone"===a.get("state")}).get("tileLayer"):d.core.Model.prototype.get.apply(this,arguments)},getLayers:function(){if(this.get("searchQuery")){var a=new RegExp(this.get("searchQuery"),"i");return this.get("layers").filter(function(b){return b.get("name").match(a)},this)}return this.get("layers")},hasAlreadyAddedLayer:function(){return!1},_initBinds:function(){this.get("layers").bind("change:state",this._onLayerStateChange,this)},_onLayerStateChange:function(a,b){switch(b){case"saving":this.set("currentView","savingLayer");break;case"saveDone":this.trigger("saveBasemap");break;case"saveFail":this.set("currentView","saveFail");break;default:this.set("currentView","selectLayer")}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./layers_collection.js":41,"./wms_view.js":44}],44:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("../../../view_helpers/random_quote.js"),g=a("./select_layer_view.js"),h=a("../../../view_factory.js");b.exports=d.core.View.extend({events:{"keydown .js-search-input":"_onKeyDown","submit .js-search-form":"killEvent","keydown .js-url":"_update","paste .js-url":"_update","click .js-fetch-layers":"_onClickFetchLayers","click .js-clean-search":"_onCleanSearchClick","click .js-search-link":"_submitSearch"},initialize:function(){this.elder("initialize"),this._initBinds()},render:function(){this.clearSubViews();var a;switch(this.model.get("currentView")){case"savingLayer":a=h.createByTemplate("common/templates/loading",{title:"Saving layer…",quote:f()});break;case"selectLayer":a=new g({model:this.model});break;case"saveFail":a=h.createByTemplate("common/templates/fail",{msg:""});break;case"fetchingLayers":a=h.createByTemplate("common/templates/loading",{title:"Fetching layers…",quote:f()});break;case"enterURL":default:a=h.createByTemplate("common/dialogs/add_custom_basemap/wms/enter_url",{layersFetched:this.model.get("layersFetched"),layers:this.model.get("layers")})}return this.addView(a),this.$el.append(a.render().el),this.$(".js-search-input").focus(),this},_showCleanSearchButton:function(){this.$(".js-clean-search").show()},_hideCleanSearchButton:function(){this.$(".js-clean-search").hide()},_initBinds:function(){this.model.bind("change",this.render,this),this.model.bind("change",this._onChangeSearchQuery,this),this.model.get("layers").bind("reset",this.render,this)},_update:function(a){a.stopPropagation(),this._debouncedUpdate()},_debouncedUpdate:e.debounce(function(){this._enableFetchLayersButton(!!this.$(".js-url").val()),this.$(".js-error").removeClass("is-visible")},100),_enableFetchLayersButton:function(a){this.$(".js-fetch-layers")[a?"removeClass":"addClass"]("is-disabled")},_onKeyDown:function(a){var b=a.keyCode==$.ui.keyCode.ENTER;b&&(this.killEvent(a),this._submitSearch())},_submitSearch:function(a){this.killEvent(a),this.model.set("searchQuery",this.$(".js-search-input").val())},_onChangeSearchQuery:function(){var a=this.model.get("searchQuery");a||this._hideCleanSearchButton()},_onCleanSearchClick:function(a){this.killEvent(a),this.model.set("searchQuery","")},_onClickFetchLayers:function(a){this.killEvent(a);var b=this.$(".js-url").val();b&&this.model.fetchLayers(b)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_factory.js":237,"../../../view_helpers/random_quote.js":241,"./select_layer_view.js":42}],45:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./xyz_view");b.exports=d.core.Model.extend({defaults:{name:"xyz",label:"XYZ",tms:!1,layer:void 0},createView:function(){return new f({model:this})},hasAlreadyAddedLayer:function(a){var b=this.get("layer").get("urlTemplate");return e.any(a.custom(),function(a){return a.get("urlTemplate")===b})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./xyz_view":46}],46:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.core.View.extend({className:"XYZPanel",events:{"click .js-tms":"_changeTMS","keydown .js-url":"_update","paste .js-url":"_update"},initialize:function(){this.elder("initialize"),this._lastCallSeq=0,this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(c.templates.getTemplate("common/dialogs/add_custom_basemap/xyz/xyz")({})),this._initViews(),this},_initViews:function(){var a=new c.common.TipsyTooltip({el:this.$(".js-tms"),title:function(){return $(this).data("title")}});this.addView(a)},_initBinds:function(){this.model.bind("change:tms",this._setTMSCheckbox,this)},_update:function(a){a.stopPropagation(),this._debouncedUpdate()},_changeTMS:function(a){this.model.set("tms",!this.model.get("tms")),this._update(a)},_setTMSCheckbox:function(a){this.$(".js-tms .Checkbox-input")[this.model.get("tms")?"addClass":"removeClass"]("is-checked")},_debouncedUpdate:d.debounce(function(){this._disableOkBtn(!0),this._indicateIsValidating(!0);var a,b,d=this.$(".js-url").val(),e=this.model.get("tms");if(d)try{a=c.admin.TileLayer.byCustomURL(d,e)}catch(a){b="It does not look like a valid XYZ URL"}if(this.model.set("layer",a),a){var f=this,g=++this._lastCallSeq;a.validateTemplateURL({success:function(){g===f._lastCallSeq&&(f._disableOkBtn(!1),f._indicateIsValidating(!1),f._updateError())},error:function(){g===f._lastCallSeq&&(f._disableOkBtn(!1),f._indicateIsValidating(!1),f._updateError("We couldn't validate this, if you're sure it contains data click \"add basemap\""))}})}else d?(this._indicateIsValidating(!1),this._updateError(b)):(this._indicateIsValidating(!1),this._updateError())},150),_setTMS:function(a){var b=$(a.target).closest(".Checkbox");b.find(".Checkbox-input").toggleClass("is-checked"),this._update(a)},_disableOkBtn:function(a){this.$(".ok")[a?"addClass":"removeClass"]("is-disabled")},_updateError:function(a){this.$(".js-error").text(a)[a?"addClass":"removeClass"]("is-visible")},_indicateIsValidating:function(a){a?this.$(".js-validating").show():this.$(".js-validating").hide()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],47:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,g=a("../../views/base_dialog/view.js"),h=a("../../views/paged_search/paged_search_view"),i=a("../../paged_search_model"),j=a("../../view_helpers/random_quote"),k=a("../../../organization/groups_admin/group_users_list_view");b.exports=g.extend({initialize:function(){e.each(["group","orgUsers"],function(a){if(!this.options[a])throw new Error(a+" is required")},this),this.elder("initialize"),this.model=new f.core.Model,this.options.orgUsers.excludeCurrentUser(!1),this._initBinds(),this._initViews()},clean:function(){this.options.orgUsers.restoreExcludeCurrentUser(),this.elder("clean")},render:function(){return g.prototype.render.apply(this,arguments),this._onChangeSelected(),this.$(".content").addClass("Dialog-contentWrapper"),this},render_content:function(){switch(this.model.get("state")){case"saving":return this.getTemplate("common/templates/loading")({title:"Adding users to group",quote:j()});case"saveFail":return this.getTemplate("common/templates/fail")({msg:""});default:var a=d(this.getTemplate("common/dialogs/add_group_users/add_group_users")({}));return a.find(".js-dlg-body").replaceWith(this._PagedSearchView.render().el),a}},ok:function(){var a=this._selectedUsers();if(a.length>0){this.model.set("state","saving");var b=e.pluck(a,"id"),c=this;this.options.group.users.addInBatch(b).done(function(){c.options.group.users.add(a),c.close()}).fail(function(){c.model.set("state","saveFail")})}},_initViews:function(){this._PagedSearchView=new h({isUsedInDialog:!0,pagedSearchModel:new i({per_page:50,order:"username"}),collection:this.options.orgUsers,createListView:this._createUsersListView.bind(this)}),this.addView(this._PagedSearchView)},_createUsersListView:function(){return new k({users:this.options.orgUsers})},_initBinds:function(){this.options.orgUsers.on("change:selected",this._onChangeSelected,this),this.add_related_model(this.options.orgUsers),this.model.on("change:state",this.render,this)},_onChangeSelected:function(){this.$(".ok").toggleClass("is-disabled",0===this._selectedUsers().length)},_selectedUsers:function(){return this.options.orgUsers.where({selected:!0})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../organization/groups_admin/group_users_list_view":304,"../../paged_search_model":227,"../../view_helpers/random_quote":241,"../../views/base_dialog/view.js":242,"../../views/paged_search/paged_search_view":257}],48:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;b.exports=e.extend({events:function(){return f.extend({},e.prototype.events,{"click .js-ok":"_continue"})},initialize:function(){this.elder("initialize"),this.template=d.templates.getTemplate("common/dialogs/builder_features_warning/template")},render_content:function(){return this.template({})},_continue:function(){this.close()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../views/base_dialog/view":242}],49:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("../../views/base_dialog/view"),g=a("../../view_helpers/pluralize_string"),h=a("../../view_helpers/random_quote");b.exports=f.extend({events:function(){return e.extend({},f.prototype.events,{"click .js-ok":"_ok"})},initialize:function(){this.elder("initialize"),this.options.template=this.options.template||d.templates.getTemplate("common/dialogs/change_lock/templates/dashboard"),this.model.bind("change",function(){"ProcessItemsDone"===this.model.get("state")?this.close():this.render()},this)},render_content:function(){return this["_render"+this.model.get("state")]()},_renderConfirmChangeLock:function(){var a=this.model.get("items").length,b=this.model.get("initialLockValue");return this.options.template({model:this.model,itemsCount:a,ownerName:this.options.ownerName,isOwner:this.options.isOwner,thisOrTheseStr:1===a?"this":"these",itOrThemStr:1===a?"it":"them",areLocked:b,positiveOrNegativeStr:b?"positive":"alert",lockOrUnlockStr:b?"unlock":"lock",contentTypePluralized:g("datasets"===this.model.get("contentType")?"dataset":"map",this.model.get("contentType"),a)})},_ok:function(a){this.killEvent(a),this.model.inverseLock(),this.render()},_renderProcessingItems:function(){var a=this.model.get("initialLockValue")?"Unlocking":"Locking";return d.templates.getTemplate("common/templates/loading")({title:a+" "+g("datasets"===this.model.get("contentType")?"dataset":"map",this.model.get("items").length)+"…",quote:h()})},_renderProcessItemsFail:function(){var a=this.model.get("initialLockValue")?"unlock":"lock";return d.templates.getTemplate("common/templates/fail")({msg:"Failed to "+a+" all items"})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_helpers/pluralize_string":240,"../../view_helpers/random_quote":241,"../../views/base_dialog/view":242}],50:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f=a("../../batch_process_items");b.exports=d.core.Model.extend({defaults:{state:"ConfirmChangeLock",initialLockValue:!1,contentType:"datasets",items:void 0},initialize:function(a){if(this.elder("initialize"),this.set("items",new e.Collection(a.items)),this.get("items").chain().map(function(a){return a.get("locked")}).uniq().value().length>1){var b="It is assumed that all items have the same locked state, a user should never be able to select a mixed item with current UI. If you get an error with this message something is broken";if(!window.trackJs||!window.trackJs.track)throw new Error(b);window.trackJs.track(b)}this.set("initialLockValue",this.get("items").at(0).get("locked"))},inverseLock:function(){this.set("state","ProcessingItems"),f({howManyInParallel:5,items:this.get("items").toArray(),processItem:this._lockItem.bind(this,!this.get("initialLockValue")),done:this.set.bind(this,"state","ProcessItemsDone"),fail:this.set.bind(this,"state","ProcessItemsFail")})},_lockItem:function(a,b,c){b.save({locked:a}).done(function(){c()}).fail(function(){c("something failed")})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../batch_process_items":28}],51:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./start_view"),f=a("./options_collection"),g=a("../../views/base_dialog/view"),h=a("../../view_helpers/random_quote"),i=a("../../view_factory"),j=a("./share/share_view"),k=g.extend({initialize:function(){this.elder("initialize"),this._privacyOptions=f.byVisAndUser(this.options.vis,this.options.user),this._initViews(),this._initBinds()},render_content:function(){return this._panes.getActivePane().render().el},ok:function(){var a=this._privacyOptions.selectedOption();if(a.canSave()){var b=this;this._panes.active("saving"),a.saveToVis(this.options.vis,{success:function(){b.close()},error:function(){b._panes.active("saveFail")}})}},_initViews:function(){this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("start",new e({privacyOptions:this._privacyOptions,user:this.options.user,vis:this.options.vis})),this._panes.addTab("saving",i.createByTemplate("common/templates/loading",{title:"Saving privacy…",quote:h()}).render()),this._panes.addTab("saveFail",i.createByTemplate("common/templates/fail",{msg:""}).render()),this._panes.active("start")},_initBinds:function(){this._panes.bind("tabEnabled",this.render,this),this._panes.getPane("start").bind("clickedShare",this._openShareDialog,this)},_openShareDialog:function(){var a=new j({clean_on_hide:!0,enter_to_confirm:!0,user:this.options.user,vis:this.options.vis,ChangePrivacyView:k});this.close(),a.appendToBody()}});b.exports=k}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"../../view_helpers/random_quote":241,"../../views/base_dialog/view":242,"./options_collection":53,"./share/share_view":60,"./start_view":62}],52:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.core.Model.extend({defaults:{privacy:"PUBLIC",disabled:!1,selected:!1,password:void 0},validate:function(a){if(a.disabled&&a.selected)return"Option can not be disabled and selected at the same time"},classNames:function(){return d.chain(["disabled","selected"]).map(function(a){return this.attributes[a]?"is-"+a:void 0},this).compact().value().join(" ")},canSave:function(){return!this.get("disabled")},saveToVis:function(a,b){return a.save(this._attrsToSave(),d.extend({wait:!0},b))},_attrsToSave:function(){return d.pick(this.attributes,"privacy","password")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],53:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./option_model"),g=a("./password_option_model"),h=[{privacy:"PUBLIC",illustrationType:"positive",iconFontType:"unlock",title:"Public",desc:"Everyone can view and download it",alwaysEnable:!0},{privacy:"LINK",illustrationType:"alert",iconFontType:"unlock",title:"With link",desc:"Only the people with the link can view it"},{privacy:"PASSWORD",illustrationType:"alert",iconFontType:"unlockWithEllipsis",title:"Password protected",desc:"Only the people with the password can view it"},{privacy:"PRIVATE",illustrationType:"negative",iconFontType:"lock",title:"Private",desc:"Only you can access it"}];b.exports=d.Collection.extend({model:function(a,b){return"PASSWORD"===a.privacy?new g(a,b):new f(a,b)},initialize:function(){this.bind("change:selected",this._deselectLastSelected,this)},selectedOption:function(){return this.find(function(a){return a.get("selected")})},passwordOption:function(){return this.find(function(a){return"PASSWORD"===a.get("privacy")})},_deselectLastSelected:function(a,b){b&&this.each(function(b){b!==a&&b.set({selected:!1},{silent:!0})})}},{byVisAndUser:function(a,b){var c=b.get("actions")[a.isVisualization()?"private_maps":"private_tables"],d=a.get("privacy"),f=a.privacyOptions();return new this(e.chain(h).filter(function(a){return e.contains(f,a.privacy)}).map(function(a){return e.defaults({selected:a.privacy===d,disabled:!(a.alwaysEnable||c)},a)}).value())}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./option_model":52,"./password_option_model":54}],54:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,"undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null),e=a("./option_model"),f=e.extend({initialize:function(){e.prototype.initialize.apply(this,arguments),this.set("password",f.DEFAULT_FAKE_PASSWORD)},_attrsToSave:function(){var a=e.prototype._attrsToSave.call(this);return a.password===f.DEFAULT_FAKE_PASSWORD&&delete a.password,a},canSave:function(){return e.prototype.canSave.call(this)&&!d.isEmpty(this.get("password"))}},{DEFAULT_FAKE_PASSWORD:"!@#!@#"});b.exports=f}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./option_model":52}],55:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e=("undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null),f=a("./permission_view"),g=a("./user_details_view"),h=a("./group_details_view"),i=a("../../../view_factory");b.exports=e.core.View.extend({initialize:function(){d.each(["model","collection","pagedSearchModel"],function(a){if(d.isUndefined(this.options[a]))throw new Error(a+" is required")},this),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.empty(),this.options.pagedSearchModel.get("q")||this._renderOrganizationPermissionView(),this._renderGrantablesViews(),this},_initBinds:function(){this.collection.bind("reset",this.render,this),this.add_related_model(this.collection),this.options.pagedSearchModel.on("change:q",this.render,this),this.add_related_model(this.options.pagedSearchModel)},_renderGrantablesViews:function(){var a=this.model.get("vis").tableMetadata().dependentVisualizations();this.collection.each(function(b){this._appendView(new f({model:b.entity,permission:this.model.get("permission"),isWriteAccessTogglerAvailable:this.model.isWriteAccessTogglerAvailable(),detailsView:this._createDetailsView(this._detailsViewOpts.bind(this,a,b.entity),b)}))},this)},_renderOrganizationPermissionView:function(){this._appendView(new f({model:this.model.get("organization"),permission:this.model.get("permission"),isWriteAccessTogglerAvailable:this.model.isWriteAccessTogglerAvailable(),detailsView:i.createByTemplate("common/dialogs/change_privacy/share/details",{avatarUrl:!1,willRevokeAccess:!1,title:"Default settings for your Organization",desc:"New users will have this permission",roleLabel:!1},{className:"ChangePrivacy-shareListItemInfo"})}))},_appendView:function(a){this.$el.append(a.render().el),this.addView(a)},_createDetailsView:function(a,b){var c=b.get("type");switch(c){case"user":return new g(a([b.id]));case"group":return new h(a(b.entity.users.chain().reject(this._isCurrentUser).pluck("id").value()));default:return e.log.error("No details view for grantable model of type "+c),new e.core.View(a())}},_detailsViewOpts:function(a,b,c){return{className:"ChangePrivacy-shareListItemInfo",model:b,permission:this.model.get("permission"),isUsingVis:d.any(a,function(a){return d.any(c,function(b){return b===a.permission.owner.id})})}},_isCurrentUser:function(a){return a.id===e.config.get("user").id}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_factory":237,"./group_details_view":56,"./permission_view":58,"./user_details_view":61}],56:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("../../../view_helpers/pluralize_string");b.exports=e.core.View.extend({initialize:function(){d.each(["permission","isUsingVis"],function(a){if(d.isUndefined(this.options[a]))throw new Error(a+" is required")},this)},render:function(){return this.$el.html(this.getTemplate("common/dialogs/change_privacy/share/details")({willRevokeAccess:this._willRevokeAccess(),avatarUrl:this.model.get("avatar_url"),title:this.model.get("display_name"),desc:this._desc(),roleLabel:!1})),this},_desc:function(){var a=this.model.users.length,b=f.prefixWithCount("member","members",a);return this._willRevokeAccess()?b+". "+f("Member's","Members'",a)+" maps will be affected":this.options.isUsingVis?b+". "+f("Member is","Members are",a)+" using this dataset":b},_willRevokeAccess:function(){return this.options.isUsingVis&&!this.options.permission.hasReadAccess(this.model)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_helpers/pluralize_string":240}],57:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.core.View.extend({tagName:"span",events:{"mouseover .js-toggler.is-disabled":"_onHoverDisabledToggler","mouseout .js-toggler":"_closeTooltip","mouseleave .js-toggler":"_closeTooltip","change .js-input":"_onChangeInput"},initialize:function(){c.each(["model","permission","hasAccess","canChangeAccess","toggleAccess","label"],function(a){if(c.isUndefined(this.options[a]))throw new Error(a+" is required")},this)},render:function(){return this.clearSubViews(),this.$el.html(d.templates.getTemplate("common/dialogs/change_privacy/share/permission_toggler")({cid:this.cid,hasAccess:this.options.hasAccess(),canChangeAccess:this.options.canChangeAccess(),label:this.options.label})),this},_onChangeInput:function(){this.options.toggleAccess()},_onHoverDisabledToggler:function(a){var b=this.options.permission.findRepresentableAclItem(this.model);b&&!b.isOwn(this.model)&&this._tooltipView().showTipsy()},_closeTooltip:function(){this._tooltipView().hideTipsy()},_tooltipView:function(a){return this._tooltip||(this._tooltip=this._newTooltipView(),this.addView(this._tooltip)),this._tooltip},_newTooltipView:function(a){return new d.common.TipsyTooltip({el:this.$(".js-toggler"),trigger:"manual",title:this._inheritedAccessTooltipText.bind(this)})},_inheritedAccessTooltipText:function(){var a=this.options.permission.findRepresentableAclItem(this.model),b=a.get("type");switch(b){case"group":return"Access is inherited from group "+a.get("entity").get("name");case"org":return"Access is inherited from organization";default:return d.log.error("Trying to display inherited access for an unrecognized type "+b),""}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],58:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("./permission_toggler_view"),g=a("../../../view_factory");b.exports=e.core.View.extend({className:"ChangePrivacy-shareListItem",initialize:function(){d.each(["model","permission","isWriteAccessTogglerAvailable","detailsView"],function(a){if(d.isUndefined(this.options[a]))throw new Error(a+" is required")},this),this._initBinds()},_initBinds:function(){this.options.permission.acl.bind("add remove reset change",this.render,this),this.add_related_model(this.options.permission)},render:function(){return this.clearSubViews(),this._renderDetails(),this._renderAccessTogglers(),this},_renderDetails:function(){this._renderView(this.options.detailsView)},_renderAccessTogglers:function(){var a=[this._newReadToggler()];this.options.isWriteAccessTogglerAvailable&&a.unshift(this._newWriteToggler()),this._renderView(g.createByList(a))},_newWriteToggler:function(){var a=this.options.permission;return new f({className:"ChangePrivacy-shareListItemTogglerContainer",model:this.model,permission:a,label:"Write",hasAccess:a.hasWriteAccess.bind(a,this.model),canChangeAccess:a.canChangeWriteAccess.bind(a,this.model),toggleAccess:this._toggleWrite.bind(this)})},_newReadToggler:function(){var a=this.options.permission;return new f({model:this.model,permission:a,label:"Read",hasAccess:a.hasReadAccess.bind(a,this.model),canChangeAccess:a.canChangeReadAccess.bind(a,this.model),
toggleAccess:this._toggleRead.bind(this)})},_renderView:function(a){this.addView(a),this.$el.append(a.render().el)},_toggleWrite:function(){var a=this.options.permission;a.canChangeWriteAccess(this.model)&&(a.hasWriteAccess(this.model)?a.revokeWriteAccess(this.model):a.grantWriteAccess(this.model))},_toggleRead:function(){var a=this.options.permission;a.canChangeReadAccess(this.model)&&(a.hasReadAccess(this.model)?a.revokeAccess(this.model):a.grantReadAccess(this.model))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_factory":237,"./permission_toggler_view":57}],59:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;"undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.core.Model.extend({defaults:{vis:void 0,permission:void 0,organization:void 0},initialize:function(a){if(!a.vis)throw new Error("vis is required");if(!a.organization)throw new Error("organization is required");var b=this.get("vis");if(this.set("permission",b.permission.clone()),!b.isVisualization()){var c=this;b.tableMetadata().fetch({silent:!0,success:function(){c.trigger("all")}})}},name:function(){return this.get("vis").get("name")},isWriteAccessTogglerAvailable:function(){return!this.get("vis").isVisualization()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],60:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f=("undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,a("../../../views/base_dialog/view")),g=a("../../../view_helpers/random_quote"),h=a("../../../view_factory"),i=a("../../../paged_search_model"),j=a("../../../views/paged_search/paged_search_view"),k=a("./share_model"),l=a("./grantables_view");b.exports=f.extend({events:f.extendEvents({"click .js-back":"_openChangePrivacy"}),initialize:function(){if(!this.options.ChangePrivacyView)throw new Error("ChangePrivacyView is required");this.user=this.options.user,this.organization=this.user.organization,this.model=new k({vis:this.options.vis,organization:this.organization}),this.elder("initialize"),this._initViews(),this._initBinds()},render:function(){return f.prototype.render.apply(this,arguments),this.$(".content").addClass("Dialog-content--expanded"),this},render_content:function(){return[this._htmlNode(d.templates.getTemplate("common/dialogs/change_privacy/share/share_header")({name:this.options.vis.get("name")})),this._grantablesView.render().el,this._htmlNode(d.templates.getTemplate("common/dialogs/change_privacy/share/share_footer")())]},ok:function(){var a=h.createDialogByTemplate("common/templates/loading",{title:"Sharing…",quote:g()});a.appendToBody();var b=this.options.vis.permission;b.overwriteAcl(this.model.get("permission")),b.save().always(function(){a.close()}).fail(function(){var a=h.createDialogByTemplate("common/templates/fail",{msg:""});a.appendToBody()}).done(this._openChangePrivacy.bind(this))},_initViews:function(){var a=this.model,b=this.organization.grantables,c=new i({per_page:50,order:"name"});this._grantablesView=new j({isUsedInDialog:!0,pagedSearchModel:c,collection:b,createListView:function(){return new l({model:a,collection:b,pagedSearchModel:c})}})},_initBinds:function(){this.model.on("all",this._grantablesView.render,this._grantablesView)},_htmlNode:function(a){return e(a)[0]},_openChangePrivacy:function(){var a=new this.options.ChangePrivacyView({clean_on_hide:!0,enter_to_confirm:!0,vis:this.options.vis,user:this.user});a.appendToBody(),this.close()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../paged_search_model":227,"../../../view_factory":237,"../../../view_helpers/random_quote":241,"../../../views/base_dialog/view":242,"../../../views/paged_search/paged_search_view":257,"./grantables_view":55,"./share_model":59}],61:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.core.View.extend({initialize:function(){c.each(["permission","isUsingVis"],function(a){if(c.isUndefined(this.options[a]))throw new Error(a+" is required")},this)},render:function(){return this.$el.html(this.getTemplate("common/dialogs/change_privacy/share/details")({willRevokeAccess:this._willRevokeAccess(),avatarUrl:this.model.get("avatar_url"),title:this.model.get("username"),desc:this._desc(),roleLabel:this.model.get("viewer")?"Viewer":"Builder"})),this},_desc:function(){var a=this.model.get("email");return this._willRevokeAccess()?a+". User's maps will be affected":this.options.isUsingVis?a+". User is using this dataset":a},_willRevokeAccess:function(){return this.options.isUsingVis&&!this.options.permission.hasReadAccess(this.model)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],62:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,g=a("../../view_helpers/pluralize_string"),h="is-disabled",i=5;b.exports=d.core.View.extend({events:{"click .js-option":"_onClickOption","click .js-share":"_onClickShare","keyup .js-password-input":"_onKeyUpPasswordInput"},initialize:function(){if(this.elder("initialize"),!this.options.privacyOptions)throw new Error("privacyOptions is required");if(!this.options.user)throw new Error("user is required");if(!this.options.vis)throw new Error("vis is required");this.template=d.templates.getTemplate("common/dialogs/change_privacy/start"),this._initBinds()},render:function(){var a=this.options.privacyOptions.passwordOption(),b=a?a.get("password"):"",c=this.options.privacyOptions.selectedOption(),f=d.config.get("upgrade_url"),j=this.options.vis.permission.getUsersWithAnyPermission();return this.$el.html(this.template({vis:this.options.vis,privacyOptions:this.options.privacyOptions,password:b,saveBtnClassNames:c.canSave()?"":h,showUpgradeBanner:f&&this.options.privacyOptions.any(function(a){return!!a.get("disabled")}),upgradeUrl:f,showTrial:this.options.user.canStartTrial(),showShareBanner:this.options.user.organization,sharedEntitiesCount:j.length,personOrPeopleStr:g("person","people",j.length),sharedEntitiesSampleCount:i,sharedEntitiesSample:e.take(j,i),sharedWithOrganization:this.options.vis.permission.isSharedWithOrganization()})),this.delegateEvents(),this},_initBinds:function(){this.options.privacyOptions.bind("change:selected change:disabled",this.render,this),this.options.privacyOptions.bind("change:password",this._onChangePassword,this),this.add_related_model(this.options.privacyOptions)},_onClickOption:function(a){var b=f(a.target).closest(".js-option").data("index"),c=this.options.privacyOptions.at(b);c.get("disabled")||c.set("selected",!0);var d=this.options.privacyOptions.passwordOption();c===d?this.$(".js-password-input").val("").focus().keyup():d&&this.$(".js-password-input").val(d.get("password"))},_onChangePassword:function(){this.$(".ok").toggleClass(h,!this.options.privacyOptions.selectedOption().canSave())},_onKeyUpPasswordInput:function(a){this.options.privacyOptions.passwordOption().set("password",a.target.value)},_onClickShare:function(a){this.killEvent(a),this.trigger("clickedShare")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_helpers/pluralize_string":240}],63:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./create_header"),f=a("./create_footer"),g=a("./create_listing"),h=a("./create_loading"),i=a("./listing/navigation_view");b.exports=d.core.View.extend({events:{click:"_onClickContent"},initialize:function(){this.user=this.options.user,this._initBinds()},render:function(){return this.clearSubViews(),this._initViews(),this._setOption(),this},_initViews:function(){var a=new e({el:this.$(".CreateDialog-header"),user:this.user,model:this.model});a.render(),this.addView(a);var b=new i({el:this.$(".js-navigation"),user:this.user,routerModel:this.model.visFetchModel,createModel:this.model,collection:this.model.collection});b.render(),this.addView(b);var c=new f({el:this.$(".CreateDialog-footer"),user:this.user,createModel:this.model});c.render(),this.addView(c),this.createPane=new d.ui.common.TabPane({el:this.$(".Dialog-body--create")}),this.createPane.bind("tabEnabled",function(a){b["listing"===a?"show":"hide"]()},this),this.addView(this.createPane);var j=new h({user:this.user,createModel:this.model});j.render(),this.createPane.addTab("loading",j),this._createListing=new g({user:this.user,createModel:this.model}),this._createListing.render(),this.createPane.addTab("listing",this._createListing),this.addView(this._createListing),this.model.set("option","listing")},_setOption:function(){this.createPane.active(this.model.getOption())},_initBinds:function(){_.bindAll(this,"_onScrollContent"),this.model.bind("change:option",this._setOption,this),this.model.bind("change:option",this._maybeShowOnboarding,this),this.$(".Dialog-body--create").bind("scroll",this._onScrollContent)},_maybeShowOnboarding:function(){this._onboardingView&&this.model.showOnboarding()&&(this._createListing.$el.append(this._onboardingView.render().el),this._onboardingView.show())},_onClickContent:function(){d.god.trigger("closeDialogs")},_onScrollContent:function(){var a=this.$(".Dialog-body--create").scrollTop()>0;this.$(".js-navigation").toggleClass("with-long-separator",!!a)},clean:function(){this.$(".Dialog-body--create").unbind("scroll",this._onScrollContent),this.elder("clean")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./create_footer":65,"./create_header":66,"./create_listing":67,"./create_loading":68,"./listing/navigation_view":104}],64:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../background_polling/models/upload_model"),f=a("../../visualizations_fetch_model");b.exports=d.core.Model.extend({defaults:{type:"dataset",option:"listing",listing:"import"},initialize:function(a,b){this.user=b.user,this.upload=new e({create_vis:!1},{user:this.user}),this.selectedDatasets=new Backbone.Collection,this.collection=new d.admin.Visualizations,this.visFetchModel=new f({content_type:"datasets",library:this.showLibrary()}),this._initBinds()},viewsReady:function(){},showLibrary:function(){return!0},showDatasets:function(){return!1},canSelect:function(){return!0},getOption:function(){var a=this.get("option"),b=a.split(".");return b.length>0?b[0]:""},getImportState:function(){var a=this.get("option"),b=a.split(".");return b.length>0&&b.length<4&&"listing"===b[0]&&"import"===b[1]?b[2]:""},showGuessingToggler:function(){return!0},showPrivacyToggler:function(){return!0},startUpload:function(){d.god.trigger("importByUploadData",this.upload.toJSON())},setActiveImportPane:function(a){a&&"import"===this.get("listing")&&this.getImportState()!==a&&this.set("option","listing.import."+a)},isMapType:function(){return!1},createFromScratch:function(){this.trigger("creatingDataset","dataset",this),this.set("option","loading");var a=this,b=new d.admin.CartoDBTableMetadata;b.save({},{success:function(b){a.trigger("datasetCreated",b,a)},error:function(b,c){a.trigger("datasetError",c,a)}})},_initBinds:function(){this.upload.bind("change",function(){this.trigger("change:upload",this)},this),this.collection.bind("change:selected",this._onItemSelected,this),this.visFetchModel.bind("change",this._fetchCollection,this),this.bind("change:option",this._maybePrefetchDatasets,this),this.bind("change:listing",this._maybePrefetchDatasets,this)},_maybePrefetchDatasets:function(){var a="datasets"===this.get("listing");!a||this.get("collectionFetched")||this.visFetchModel.isSearching()||(this.set("collectionFetched",!0),this._fetchCollection())},_selectedItems:function(){return this.collection.where({selected:!0})},_fetchCollection:function(){var a=this.visFetchModel.attributes;this.collection.options.set({locked:"",q:a.q,page:a.page||1,tags:a.tag,per_page:this.collection._TABLES_PER_PAGE,shared:a.shared,only_liked:a.liked,order:"updated_at",type:"",types:a.library?"remote":"table",exclude_raster:!0}),this.collection.fetch()},_onItemSelected:function(a){if("remote"===a.get("type")){var b=new d.admin.CartoDBTableMetadata(a.get("external_source")),c={type:"remote",value:a.get("name"),remote_visualization_id:a.get("id"),size:b.get("size"),create_vis:!1};d.god.trigger("importByUploadData",c)}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../background_polling/models/upload_model":19,"../../visualizations_fetch_model":261}],65:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./footer/guessing_toggler_view"),f=a("./footer/privacy_toggler_view");b.exports=d.core.View.extend({events:{"click .js-templates":"_goToTemplates","click .js-create_map":"_createMap","click .js-connect":"_connectDataset","click .js-videoTutorial":"_startTutorial"},initialize:function(){this.user=this.options.user,this.createModel=this.options.createModel,this.guessingModel=new d.core.Model({guessing:!0}),this.privacyModel=new d.core.Model({privacy:this.user.canCreatePrivateDatasets()?"PRIVATE":"PUBLIC"}),this.template=d.templates.getTemplate("common/views/create/create_footer"),this._initBinds()},render:function(){this.clearSubViews();var a=window.upgrade_url&&!d.config.get("cartodb_com_hosted")&&(!this.user.isInsideOrg()||this.user.isOrgOwner());return this.$el.html(this.template({isMapType:this.createModel.isMapType(),option:this.createModel.getOption(),listingState:this.createModel.get("listing"),isLibrary:this.createModel.visFetchModel.get("library"),importState:this.createModel.getImportState(),isUploadValid:this.createModel.upload.isValidToUpload(),selectedDatasetsCount:this.createModel.selectedDatasets.length,maxSelectedDatasets:this.user.getMaxLayers(),mapTemplate:this.createModel.get("mapTemplate"),userCanUpgrade:a,upgradeUrl:window.upgrade_url,currentUrl:window.location.href})),this._initViews(),this},_initBinds:function(){this.createModel.bind("change:upload",this.render,this),this.createModel.bind("change:option",this.render,this),this.createModel.bind("change:listing",this.render,this),this.createModel.selectedDatasets.bind("all",this.render,this),this.createModel.visFetchModel.bind("change:library",this.render,this),this.add_related_model(this.createModel),this.add_related_model(this.createModel.selectedDatasets),this.add_related_model(this.createModel.visFetchModel)},_initViews:function(){this.guessingTogglerView=new e({model:this.guessingModel,createModel:this.createModel}),this.$(".js-footer-info").append(this.guessingTogglerView.render().el),this.addView(this.guessingTogglerView),this.privacyTogglerView=new f({model:this.privacyModel,user:this.user,createModel:this.createModel}),this.$(".js-footerActions").prepend(this.privacyTogglerView.render().el),this.addView(this.privacyTogglerView)},_connectDataset:function(){this.createModel.upload.isValidToUpload()&&(this.createModel.showPrivacyToggler()&&this.createModel.upload.set("privacy",this.privacyModel.get("privacy")),this.createModel.upload.setGuessing(this.guessingModel.get("guessing")),this.createModel.startUpload())},_startTutorial:function(){this.createModel.startTutorial()},_goToTemplates:function(a){a&&a.preventDefault(),this.createModel.set("option","templates")},_createMap:function(){var a=this.createModel.selectedDatasets;a.length>0&&a.length<=this.user.getMaxLayers()&&this.createModel.createMap()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./footer/guessing_toggler_view":71,"./footer/privacy_toggler_view":72}],66:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({initialize:function(){this.user=this.options.user,this.template=c.templates.getTemplate("common/views/create/create_header"),this._initBinds()},render:function(){return this.$el.html(this.template({type:this.model.get("type"),option:this.model.getOption()})),this},_initBinds:function(){this.model.bind("change:option",this.render,this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],67:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./listing/datasets_view"),f=a("./listing/imports_view");b.exports=d.core.View.extend({className:"CreateDialog-listing CreateDialog-listing--noPaddingTop",initialize:function(){this.user=this.options.user,this.createModel=this.options.createModel,this.template=d.templates.getTemplate("common/views/create/create_listing"),this.createModel.bind("change:listing",this._onChangeListing.bind(this)),this.add_related_model(this.createModel),this._onChangeListing()},render:function(){return this.clearSubViews(),this.$el.html(this.template()),this._initViews(),this},_onChangeListing:function(){this.listingPane&&this.listingPane.active(this.createModel.get("listing"))},_initViews:function(){this.listingPane=new d.ui.common.TabPane({el:this.$(".ListingContent")}),this.addView(this.listingPane);var a=new e({defaultUrl:this.user.viewUrl().dashboard().datasets(),user:this.user,createModel:this.createModel,routerModel:this.createModel.visFetchModel,collection:this.createModel.collection});if(a.render(),this._addListingPane("datasets",a),this.user.canCreateDatasets()){var b=new f({user:this.user,createModel:this.createModel});b.render(),this._addListingPane("import",b)}},_addListingPane:function(a,b){this.listingPane.addTab(a,b,{active:this.createModel.get("listing")===a})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./listing/datasets_view":78,"./listing/imports_view":103}],68:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("../../view_helpers/random_quote");b.exports=d.core.View.extend({className:"IntermediateInfo",tagName:"div",initialize:function(){this.createModel=this.options.createModel,this.user=this.options.user,this.model=new d.core.Model({state:"loading",type:"dataset"}),this._initBinds()},render:function(){var a=this.model.get("currentImport"),b={createModelType:this.createModel.get("type"),type:this.model.get("type"),state:this.model.get("state"),currentImport:a,currentImportName:a&&(a.upl.get("service_item_id")||a.upl.get("value")),tableIdsArray:this.model.get("tableIdsArray"),selectedDatasets:this.createModel.selectedDatasets,upgradeUrl:window.upgrade_url,freeTrial:this.user.get("show_trial_reminder"),quote:f()};if(a&&(b.err=a.getError(),b.err.item_queue_id=a.get("id")),"error"===b.state){var c=b.err&&b.err.error_code&&"8001"==b.err.error_code,e=!d.config.get("cartodb_com_hosted")&&(!this.user.isInsideOrg()||this.user.isOrgOwner());this.template=d.templates.getTemplate(c&&e?"common/views/create/create_loading_upgrade":"common/views/create/create_loading_error")}else this.template=d.templates.getTemplate("common/views/create/create_loading");return this.$el.html(this.template(b)),this},_initBinds:function(){this.model.bind("change:state change:tableIdsArray change:currentImport",this.render,this),this.createModel.bind("datasetError",this._onDatasetError,this),this.createModel.bind("creatingDataset",this._creatingDataset,this),this.createModel.bind("importingRemote",this._importingRemote,this),this.createModel.bind("importFailed",this._onImportFailed,this),this.createModel.bind("creatingMap",this._creatingMap,this),this.createModel.bind("mapError",this._onMapError,this),this.add_related_model(this.createModel)},_creatingDataset:function(){this.model.set({type:"dataset",state:"loading"})},_onDatasetError:function(){this.model.set({type:"dataset",state:"error"})},_importingRemote:function(a){this.model.set(e.extend(a.toJSON(),{state:"importing"}))},_onImportFailed:function(a){this.model.set(e.extend(a.toJSON(),{state:"error"}))},_creatingMap:function(a){this.model.set(e.extend(a.toJSON(),{state:"creating"}))},_onMapError:function(a){this.model.set(e.extend(a.toJSON(),{state:"error"}))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_helpers/random_quote":241}],69:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("../../background_polling/models/imports_model"),g=a("../../background_polling/models/upload_model"),h=a("../../visualizations_fetch_model");b.exports=d.core.Model.extend({defaults:{type:"map",option:"listing",currentImport:null,tableIdsArray:[],listing:"datasets"},_DEFAULT_MAP_NAME:"Untitled Map",initialize:function(a,b){this.user=b.user,this.upload=new g({create_vis:!0},{user:this.user}),this.selectedDatasets=new Backbone.Collection(b.selectedItems),this.collection=new d.admin.Visualizations,this.vis=new d.admin.Visualization({name:"Untitled map"}),this.visFetchModel=new h({content_type:"datasets",library:this.showLibrary()}),this._initBinds()},viewsReady:function(){this.selectedDatasets.isEmpty()?this._maybePrefetchDatasets():this.createMap()},showLibrary:function(){return!1},showDatasets:function(){return!0},canSelect:function(a){return!!a.get("selected")||this.selectedDatasets.length<this.user.getMaxLayers()},getOption:function(){var a=this.get("option"),b=a.split(".");return b.length>0?b[0]:""},getImportState:function(){var a=this.get("option"),b=a.split(".");return b.length>0&&b.length<4&&"listing"===b[0]&&"import"===b[1]?b[2]:""},showGuessingToggler:function(){return!0},showPrivacyToggler:function(){return"import"===this.get("listing")},setActiveImportPane:function(a){a&&"import"===this.get("listing")&&this.getImportState()!==a&&this.set("option","listing.import."+a)},isMapType:function(){return!0},startTutorial:function(){this.trigger("startTutorial",this)},startUpload:function(){d.god.trigger("importByUploadData",this.upload.toJSON())},createMap:function(){0!==this.selectedDatasets.length&&(this.set("option","loading"),this._checkCollection())},createFromScratch:function(){this.trigger("creatingDataset","dataset",this),this.set("option","loading");var a=this,b=new d.admin.CartoDBTableMetadata;b.save({},{success:function(b){a.trigger("datasetCreated",b,a)},error:function(b,c){a.trigger("datasetError",c,a)}})},_initBinds:function(){this.upload.bind("change",function(){this.trigger("change:upload",this)},this),this.bind("change:option",this._onOptionChange,this),this.collection.bind("change:selected",function(a,b){this.selectedDatasets[b?"add":"remove"](a)},this),this.collection.bind("reset",function(){this.selectedDatasets.each(function(a){var b=this.collection.get(a.id);b&&b.set("selected",!0)},this)},this),this.visFetchModel.bind("change",this._fetchCollection,this),this.selectedDatasets.isEmpty()&&(this.bind("change:option",this._maybePrefetchDatasets,this),this.bind("change:listing",this._maybePrefetchDatasets,this))},_maybePrefetchDatasets:function(){var a="datasets"===this.get("listing");!a||this.get("collectionFetched")||this.visFetchModel.isSearching()||(this.set("collectionFetched",!0),this._fetchCollection())},_fetchCollection:function(){var a,b=this.visFetchModel.attributes;a=this.visFetchModel.isSearching()?"table,remote":b.library?"remote":"table",this.collection.options.set({locked:"",q:b.q,page:b.page||1,tags:b.tag,per_page:this.collection._TABLES_PER_PAGE,shared:b.shared,only_liked:b.liked,order:"updated_at",type:"",types:a,exclude_raster:!0}),this.collection.fetch()},_selectedItems:function(){return this.selectedDatasets},_checkCollection:function(){this.selectedDatasets.length>0?this._importDataset(this.selectedDatasets.pop()):(this.set("currentImport",""),this._createMap())},_importDataset:function(a){var b=e.clone(this.get("tableIdsArray"));if("remote"===a.get("type")){var c={create_vis:!1,type:"remote",value:a.get("name"),remote_visualization_id:a.get("id"),size:a.get("external_source")?a.get("external_source").size:void 0},d=new f({},{upload:c,user:this.user});this.set("currentImport",e.clone(d)),this.trigger("importingRemote",this),d.bind("change:state",function(a){if(a.hasCompleted()){var c=a.imp.toJSON();b.push(c.table_name),this.set("tableIdsArray",b),this._checkCollection(),this.trigger("importCompleted",this)}a.hasFailed()&&this.trigger("importFailed",this)},this),d.hasFailed()&&this.trigger("importFailed",this)}else{var g=a.tableMetadata();b.push(g.get("name")),this.set({currentImport:"",tableIdsArray:b}),this._checkCollection()}},_createMap:function(){var a=this,b=new d.admin.Visualization({name:this._DEFAULT_MAP_NAME,type:"derived"});this.trigger("creatingMap",this),b.save({tables:this.get("tableIdsArray")},{success:function(){a._redirectTo(b.viewUrl(a.user).edit().toString())},error:function(){a.trigger("mapError",a)}})},_redirectTo:function(a){window.location=a}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../background_polling/models/imports_model":14,"../../background_polling/models/upload_model":19,"../../visualizations_fetch_model":261}],70:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("./create_content");b.exports=e.extend({className:"Dialog is-opening CreateDialog",initialize:function(){this.elder("initialize"),this.user=this.options.user,this.template=d.templates.getTemplate("common/views/create/dialog_template"),this._initBinds()},render:function(){return e.prototype.render.call(this),this.$(".content").addClass("Dialog-content--expanded"),this._initViews(),this},render_content:function(){return this.template()},_initBinds:function(){d.god.bind("importByUploadData",this.close,this),this.add_related_model(d.god)},_initViews:function(){var a=new f({el:this.$el,model:this.model,user:this.user});a.render(),this.addView(a)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../views/base_dialog/view":242,"./create_content":63}],71:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({events:{"click .js-toggle":"_toggle"},initialize:function(){this.elder("initialize"),this.createModel=this.options.createModel,this.template=c.templates.getTemplate("common/dialogs/create/footer/guessing_toggler"),this._initBinds()},render:function(){var a="";return this.createModel.showGuessingToggler()&&(a=this.template({isGuessingEnabled:this.model.get("guessing"),importState:this.createModel.getImportState(),isUploadValid:this.createModel.upload.isValidToUpload(),customHosted:c.config.get("cartodb_com_hosted")})),this.$el.html(a),this},_initBinds:function(){this.createModel.bind("change",this.render,this),this.model.bind("change",this.render,this),this.add_related_model(this.createModel)},_toggle:function(){var a=!this.model.get("guessing");this.model.set("guessing",a)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],72:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null;b.exports=c.core.View.extend({events:{click:"_onClick"},initialize:function(){this.user=this.options.user,this.createModel=this.options.createModel,this.template=c.templates.getTemplate("common/dialogs/create/footer/privacy_toggler_template"),this._initBinds()},render:function(){if(this.clearSubViews(),this.$el.empty(),this.createModel.showPrivacyToggler()){var a=this.user.canCreatePrivateDatasets(),b=this.model.get("privacy"),d="PUBLIC"===b?"PRIVATE":"PUBLIC",e="PUBLIC"===b?"unlock":"lock",f=c.config.get("upgrade_url")||window.upgrade_url,g=!c.config.get("cartodb_com_hosted")&&!a&&f;this.$el.html(this.template({privacy:b,isDisabled:!a,canUpgrade:g,nextPrivacy:d,upgradeUrl:f,icon:e})),this._initViews()}return this},_initBinds:function(){this.model.bind("change:privacy",this.render,this)},_initViews:function(){this.addView(new c.common.TipsyTooltip({el:this.$(".js-toggler"),html:!0,title:function(){return d(this).attr("data-title")}}))},_onClick:function(){if(this.user.canCreatePrivateDatasets()){var a=this.model.get("privacy");return void this.model.set("privacy","PUBLIC"===a?"PRIVATE":"PUBLIC")}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],73:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("../../../../../common/view_helpers/random_quote");b.exports=d.core.View.extend({events:{"click .js-connect":"_onConnectClick"},initialize:function(){if(!this.options.defaultUrl)throw new Error("defaultUrl is required");this.user=this.options.user,this.routerModel=this.options.routerModel,this.template=d.templates.getTemplate(this.options.template),this._initBinds()},render:function(){var a=this.routerModel.get("content_type");return this.$el.html(this.template({defaultUrl:this.options.defaultUrl,page:this.routerModel.get("page"),tag:this.routerModel.get("tag"),q:this.routerModel.get("q"),shared:this.routerModel.get("shared"),locked:this.routerModel.get("locked"),library:this.routerModel.get("library"),quote:e(),type:a,totalItems:this.collection.size(),totalEntries:this.collection.total_entries})),this},_initBinds:function(){this.routerModel.bind("change",this.render,this),this.collection.bind("reset",this.render,this),this.add_related_model(this.routerModel),this.add_related_model(this.collection)},_onConnectClick:function(){this.trigger("connectDataset",this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../common/view_helpers/random_quote":241}],74:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null,f="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,g=a("../../../../view_helpers/pluralize_string"),h=a("../../../../views/likes/view");b.exports=d.core.View.extend({tagName:"li",className:"DatasetsList-item DatasetsList-item--selectable",events:{"click .js-tag-link":"_onTagClick",click:"_toggleSelected"},initialize:function(){this.user=this.options.user,this.routerModel=this.options.createModel.visFetchModel,this.template=d.templates.getTemplate("common/views/create/listing/dataset_item"),this.table=new d.admin.CartoDBTableMetadata(this.model.get("table")),this.model.on("change",this.render,this)},render:function(){var a=this.model,b=this.table,c=a.get("tags")||[],d=a.get("description")&&f.stripHTML(markdown.toHTML(a.get("description")))||"",h={isRaster:"raster"===a.get("kind"),geometryType:b.geomColumnTypes().length>0?b.geomColumnTypes()[0]:"",title:a.get("name"),isOwner:a.permission.isOwner(this.user),
owner:a.permission.owner.renderData(this.user),showPermissionIndicator:!a.permission.hasWriteAccess(this.user),description:d,privacy:a.get("privacy").toLowerCase(),likes:a.get("likes")||0,timeDiff:e(a.get("updated_at")).fromNow(),tags:c,tagsCount:c.length,maxTagsToShow:3,rowCount:void 0,datasetSize:void 0,syncStatus:void 0,syncRanAt:void 0},i=b.get("row_count");i>=0&&(h.rowCount=i<1e4?f.formatNumber(i):f.readizableNumber(i),h.pluralizedRows=g("Row",i));var j=b.get("size");return j>=0&&(h.datasetSize=f.readablizeBytes(j,!0)),_.isEmpty(a.get("synchronization"))||(h.syncRanAt=e(a.get("synchronization").ran_at||new Date).fromNow(),h.syncStatus=a.get("synchronization").state),this.$el.html(this.template(h)),this._renderLikesIndicator(),this._renderTooltips(),this.$el[a.get("selected")?"addClass":"removeClass"]("is--selected"),this},_renderLikesIndicator:function(){var a=new h({model:this.model.like});this.$(".js-likes-indicator").replaceWith(a.render().el),this.addView(a)},_renderTooltips:function(){_.isEmpty(this.model.get("synchronization"))||this.addView(new d.common.TipsyTooltip({el:this.$(".DatasetsList-itemStatus"),title:function(a){return $(this).attr("data-title")}}))},_onTagClick:function(a){var b=$(a.target).val();b&&this.routerModel.set("tag",b)},_toggleSelected:function(a){"A"!==a.target.tagName&&(this.killEvent(a),this.options.createModel.canSelect(this.model)&&this.model.set("selected",!this.model.get("selected")))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../view_helpers/pluralize_string":240,"../../../../views/likes/view":255}],75:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../../../views/pagination/model"),f=a("../../../../views/pagination/view");b.exports=d.core.View.extend({className:"DatasetsPaginator",initialize:function(){this.routerModel=this.options.routerModel,this.collection=this.options.collection,this.model=new e({current_page:this.routerModel.get("page")}),this._initBinds(),this._initViews()},render:function(){return this.clearSubViews(),this.$el.append(this.paginationView.render().el),this},_initBinds:function(){this.model.bind("change",this.render,this),this.model.bind("change:current_page",function(){this.routerModel.set("page",this.model.get("current_page"))},this),this.collection.bind("reset",this._updatePaginationModelByCollection,this),this.routerModel.bind("change:page",this._updatePaginationModelByRouterModel,this),this.add_related_model(this.routerModel),this.add_related_model(this.collection),this.add_related_model(this.model)},_initViews:function(){this.paginationView=new f({model:this.model}),this.addView(this.paginationView)},_updatePaginationModelByCollection:function(){this.model.set({per_page:this.collection.options.get("per_page"),total_count:this.collection.total_entries})},_updatePaginationModelByRouterModel:function(){this.model.set("current_page",this.routerModel.get("page"))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../views/pagination/model":258,"../../../../views/pagination/view":259}],76:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f=a("./dataset_item_view"),g="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,h=a("../../../../background_polling/models/upload_config"),i=a("../../../../view_helpers/pluralize_string");b.exports=f.extend({tagName:"li",className:"DatasetsList-item",events:{"click .js-tag-link":"_onTagClick",click:"_toggleSelected"},initialize:function(){this.elder("initialize"),this.template=d.templates.getTemplate("common/views/create/listing/remote_dataset_item"),this.table=new d.admin.CartoDBTableMetadata(this.model.get("external_source"))},render:function(){var a=this.model,b=this.table,c=a.get("tags")||[],d=a.get("description")&&g.stripHTML(markdown.toHTML(a.get("description")))||"",e=a.get("source")&&markdown.toHTML(a.get("source"))||"",f={isRaster:"raster"===a.get("kind"),geometryType:b.geomColumnTypes().length>0?b.geomColumnTypes()[0]:"",title:a.get("display_name")||a.get("name"),source:e,description:d,timeDiff:moment(a.get("updated_at")).fromNow(),tags:c,tagsCount:c.length,routerModel:this.routerModel,maxTagsToShow:3,canImportDataset:this._canImportDataset(),rowCount:void 0,datasetSize:void 0},h=b.get("row_count");h>=0&&(f.rowCount=h<1e4?g.formatNumber(h):g.readizableNumber(h),f.pluralizedRows=i("Row",h));var j=b.get("size");return j>=0&&(f.datasetSize=g.readablizeBytes(j,!(j.toString().length>9))),this.$el.html(this.template(f)),this._setItemClasses(),this._renderTooltips(),this},_setItemClasses:function(){this.$el[this.model.get("selected")?"addClass":"removeClass"]("is--selected"),this.$el[this._canImportDataset()?"addClass":"removeClass"]("DatasetsList-item--selectable"),this.$el[this._canImportDataset()?"removeClass":"addClass"]("DatasetsList-item--banned")},_renderTooltips:function(){this.addView(new d.common.TipsyTooltip({el:this.$(".DatasetsList-itemStatus"),title:function(a){return e(this).attr("data-title")}}))},_onTagClick:function(a){a&&this.killEvent(a);var b=e(a.target).val();b&&this.routerModel.set({tag:b,library:!0})},_canImportDataset:function(){var a=this.table.get("size")||0;return this.user.get("remaining_byte_quota")*h.fileTimesBigger>=a&&this.user.get("limits").import_file_size>a},_toggleSelected:function(a){"A"!==a.target.tagName&&(this.killEvent(a),this._canImportDataset()&&this.options.createModel.canSelect(this.model)&&this.model.set("selected",!this.model.get("selected")))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../background_polling/models/upload_config":18,"../../../../view_helpers/pluralize_string":240,"./dataset_item_view":74}],77:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./datasets/dataset_item_view"),f=a("./datasets/remote_dataset_item_view");b.exports=d.core.View.extend({tagName:"ul",className:"DatasetsList",events:{},_ITEMS:{remotes:f,datasets:e},initialize:function(){this.user=this.options.user,this.createModel=this.options.createModel,this.collection.bind("reset",this.render,this),this.add_related_model(this.collection)},render:function(){return this.clearSubViews(),this.collection.each(this._addItem,this),this},_addItem:function(a,b){var c="remote"===a.get("type")?"remotes":"datasets",d=new this._ITEMS[c]({model:a,createModel:this.createModel,user:this.user});this.addView(d),this.$el.append(d.render().el)},show:function(){this.$el.removeClass("is-hidden")},hide:function(){this.$el.addClass("is-hidden")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./datasets/dataset_item_view":74,"./datasets/remote_dataset_item_view":76}],78:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./datasets_list_view"),g=a("./datasets/content_result_view"),h=a("./datasets/datasets_paginator_view");b.exports=d.core.View.extend({initialize:function(){this.user=this.options.user,this.createModel=this.options.createModel,this.routerModel=this.options.routerModel,this._initViews(),this._initBindings()},_initBindings:function(){this.routerModel.bind("change",this._onRouterChange,this),this.collection.bind("loading",this._onDataLoading,this),this.collection.bind("reset",this._onDataFetched,this),this.collection.bind("error",function(a){(!a||a&&"abort"!==a.statusText)&&this._onDataError()},this),this.add_related_model(this.routerModel),this.add_related_model(this.createModel),this.add_related_model(this.collection)},_initViews:function(){this.controlledViews={},this.enabledViews=[];var a=new g({className:"ContentResult no-datasets",user:this.user,defaultUrl:this.options.defaultUrl,routerModel:this.routerModel,collection:this.collection,template:"common/views/create/listing/content_no_datasets"});a.bind("connectDataset",function(){this.user.canCreateDatasets()&&this.createModel.set("listing","import")},this),a.render().hide(),this.controlledViews.no_datasets=a,this.$el.append(a.el),this.addView(a);var b=new f({user:this.user,createModel:this.createModel,routerModel:this.routerModel,collection:this.collection});this.controlledViews.list=b,this.$el.append(b.render().el),this.addView(b);var c=new g({defaultUrl:this.options.defaultUrl,routerModel:this.routerModel,collection:this.collection,template:"common/views/create/listing/datasets_no_result"});c.render().hide(),this.controlledViews.no_results=c,this.$el.append(c.el),this.addView(c);var d=new g({defaultUrl:this.options.defaultUrl,routerModel:this.routerModel,collection:this.collection,template:"common/views/create/listing/datasets_error"});d.render().hide(),this.controlledViews.error=d,this.$el.append(d.el),this.addView(d);var e=new g({defaultUrl:this.options.defaultUrl,routerModel:this.routerModel,collection:this.collection,template:"common/views/create/listing/datasets_loader"});this.controlledViews.main_loader=e,this.$el.append(e.render().el),this.addView(e);var i=new h({routerModel:this.routerModel,collection:this.collection});this.controlledViews.content_footer=i,this.$el.append(i.render().el),this.addView(i)},_onRouterChange:function(){this._hideBlocks(),this._showBlocks(["main_loader"])},_onDataFetched:function(){var a=["content_footer"],b=this.routerModel.get("tag"),c=this.routerModel.get("q"),d=this.routerModel.get("shared"),e=this.routerModel.get("locked"),f=this.routerModel.get("library");if(f&&0===this.collection.total_user_entries&&a.push("no_datasets"),0===this.collection.size())if(b||c||"no"!==d||e)a.push("no_results");else{if(!f)return void this._goToLibrary();a.push("no_results")}else a.push("list");this._hideBlocks(),this._showBlocks(a)},_onDataLoading:function(){this._hideBlocks(),this._showBlocks(["main_loader"])},_onDataError:function(a){this._hideBlocks(),this._showBlocks(["error"])},_showBlocks:function(a){var b=this;a?e.each(a,function(a){b.controlledViews[a]&&(b.controlledViews[a].show(),b.enabledViews.push(a))}):(b.enabledViews=[],e.each(this.controlledViews,function(a){a.show(),b.enabledViews.push(a)}))},_goToLibrary:function(){this.routerModel.set({shared:"no",library:!0,page:1})},_hideBlocks:function(a){var b=this;a?e.each(a,function(a){b.controlledViews[a]&&(b.controlledViews[a].hide(),b.enabledViews=e.without(b.enabledViews,a))}):(e.each(this.controlledViews,function(a){a.hide()}),b.enabledViews=[])},_isBlockEnabled:function(a){return!!a&&e.contains(this.enabledViews,a)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./datasets/content_result_view":73,"./datasets/datasets_paginator_view":75,"./datasets_list_view":77}],79:[function(a,b,c){var d=a("./imports/service_import/import_service_view"),e=a("./imports/twitter_import/import_twitter_view"),f=a("./imports/import_data_view"),g=a("./imports/import_arcgis_view");b.exports={File:{className:f,enabled:function(a,b){return!0},name:"file",title:"Data file",options:{type:"url",fileEnabled:!0,acceptSync:!0}},GDrive:{className:d,enabled:function(a,b){return!!a.get("oauth_gdrive")},name:"gdrive",title:"Google Drive",options:{service:"gdrive",fileExtensions:["Google SpreadSheet","CSV"],showAvailableFormats:!1,acceptSync:!0,fileAttrs:{ext:!0,title:"filename",description:{content:[{name:"size",format:"size",key:!0}]}}}},Dropbox:{className:d,enabled:function(a,b){return!!a.get("oauth_dropbox")},name:"dropbox",title:"Dropbox",options:{service:"dropbox",fileExtensions:["CSV","XLS"],showAvailableFormats:!1,acceptSync:!0,fileAttrs:{ext:!0,title:"filename",description:{content:[{name:"id",format:""},{name:"size",format:"size",key:!0}],separator:"-"}}}},Box:{className:d,enabled:function(a,b){return!!a.get("oauth_box")},name:"box",title:"Box",fallback:"common/views/create/listing/import_box_fallback",options:{service:"box",fileExtensions:["CSV","XLS"],showAvailableFormats:!1,acceptSync:!0,fileAttrs:{ext:!0,title:"filename",description:{content:[{name:"size",format:"size",key:!0}],separator:"-"}}}},Twitter:{className:e,enabled:function(a,b){return b.twitter.enabled&&!!a.get("datasource_search_twitter")},fallback:"common/views/create/listing/import_twitter_fallback",name:"twitter",title:"Twitter"},Mailchimp:{className:d,enabled:function(a,b){return b.mailchimp.enabled&&!!a.get("oauth_mailchimp")},fallback:"common/views/create/listing/import_mailchimp_fallback",name:"mailchimp",title:"MailChimp",options:{service:"mailchimp",fileExtensions:[],acceptSync:!0,showAvailableFormats:!1,headerTemplate:"common/views/create/listing/import_types/data_header_mailchimp",fileAttrs:{ext:!0,title:"filename",description:{content:[{name:"member_count",format:"number",key:!0}],itemName:"member",separator:""}}}},Arcgis:{className:g,enabled:function(a,b){return a.get("arcgis_enabled")},fallback:"common/views/create/listing/import_arcgis_fallback",name:"arcgis",title:"ArcGIS Server&trade;"},Salesforce:{className:f,enabled:function(a,b){return a.get("salesforce_enabled")},fallback:"common/views/create/listing/import_salesforce_fallback",name:"salesforce",title:"Salesforce",options:{type:"service",service_name:"salesforce",acceptSync:!0,formTemplate:"common/views/create/listing/import_types/data_form_salesforce",headerTemplate:"common/views/create/listing/import_types/data_header_salesforce"}}}},{"./imports/import_arcgis_view":83,"./imports/import_data_view":84,"./imports/service_import/import_service_view":88,"./imports/twitter_import/import_twitter_view":98}],80:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;c.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof a?a.cdb.admin:null,b.exports=c.core.View.extend({options:{template:"",fileEnabled:!1},events:{"keyup .js-textInput":"_onTextChanged","submit .js-form":"_onSubmitForm"},initialize:function(){this.user=this.options.user,this.template=c.templates.getTemplate(this.options.template||"common/views/create/listing/import_types/data_form"),this._initBinds(),this._checkVisibility()},render:function(){return this.$el.html(this.template(this.options)),this._initViews(),this},_initBinds:function(){this.model.bind("change:state",this._checkVisibility,this)},_initViews:function(){if(this.options.fileEnabled){var a=this;this.$(".js-fileInput").bind("change",function(b){this.files&&this.files.length>0&&a._onFileChanged(this.files),this.value=""}),this._initDropzone()}},_initDropzone:function(){var a=$("html")[0],b=this;this.dragster=new Dragster(a),$(a).bind("dragster:enter",function(a){b._showDropzone()}),$(a).bind("dragster:leave",function(a){b._hideDropzone()}),a.dropzone||(this.dropzone=new Dropzone(a,{url:":)",autoProcessQueue:!1,previewsContainer:!1}),this.dropzone.on("dragover",function(){b._showDropzone()}),this.dropzone.on("drop",function(a){var c=a.dataTransfer.files;b._onFileChanged(c),b._hideDropzone()}))},_destroyDropzone:function(){var a=$("html")[0];this.dragster&&(this.dragster.removeListeners(),this.dragster.reset(),$(a).unbind("dragster:enter dragster:leave")),this.dropzone&&this.dropzone.destroy()},_setValidFileExtensions:function(a){return RegExp("(.|/)("+a.join("|")+")$","i")},_onTextChanged:function(){var a=this.$(".js-textInput").val();a||this._hideTextError()},_onFileChanged:function(a){this.trigger("fileSelected",this),a&&1===a.length&&(a=a[0]),this.model.set({type:"file",value:a}),"error"!==this.model.get("state")?(this._hideFileError(),this.model.set("state","selected")):this._showFileError()},_showTextError:function(){this.$(".Form-inputError").addClass("is-visible")},_hideTextError:function(){this.$(".Form-inputError").removeClass("is-visible")},_showDropzone:function(){this.$(".Form-upload").addClass("is-dropping"),this._hideFileError()},_hideDropzone:function(){this.$(".Form-upload").removeClass("is-dropping")},_showFileError:function(){"error"===this.model.get("state")&&(this.$(".js-fileError").text(this.model.get("get_error_text").what_about).show(),this.$(".js-fileLabel").hide(),this.$(".js-fileButton").addClass("Button--negative"))},_hideFileError:function(){this.$(".js-fileError").hide(),this.$(".js-fileLabel").show(),this.$(".js-fileButton").removeClass("Button--negative")},_onSubmitForm:function(a){a&&this.killEvent(a);var b=this.$(".js-textInput").val();if(!b)return void this._hideTextError();this.trigger("urlSelected",this);var c=this.model.get("service_name")?"service":"url";this.model.set({type:c,value:b,service_item_id:b,state:"idle"}),"error"!==this.model.get("state")?(this._hideFileError(),this._hideTextError(),this.model.set("state","selected")):this._showTextError()},_checkVisibility:function(){var a=this.model.get("state");this["selected"!==a?"show":"hide"]()},clean:function(){this._destroyDropzone(),this.$(".js-fileInput").unbind("change"),this.elder("clean")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],81:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({events:{"click .js-back":"_goToStart"},options:{fileEnabled:!1,acceptSync:!1},initialize:function(){this.user=this.options.user,this.template=c.templates.getTemplate(this.options.template||"common/views/create/listing/import_types/data_header"),this._initBinds(),this._checkVisibility()},render:function(){var a=this.options.acceptSync&&this.user.get("actions")&&this.user.get("actions").sync_tables&&"file"!==this.model.get("type");return this.$el.html(this.template({type:this.model.get("type"),fileEnabled:this.options.fileEnabled,acceptSync:a,state:this.model.get("state")})),this._checkVisibility(),this},_initBinds:function(){this.model.bind("change:state",this.render,this)},_checkVisibility:function(){this.show()},_goToStart:function(){this.model.set("state","idle")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],82:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,f=a("./import_selected_dataset_view");b.exports=f.extend({render:function(){var a=this.options.fileAttrs.title&&this.model.get("value")[this.options.fileAttrs.title]||this.model.get("value"),b=this._genDescription(),c=this.options.fileAttrs.ext?e.getFileExtension(a):"";this.options.fileAttrs.ext&&(a=a&&a.replace("."+c,""));var f=window.upgrade_url,g=this.user.get("actions")&&this.user.get("actions").sync_tables,h=d.config.get("cartodb_com_hosted");return this.$el.html(this.template({title:a,description:b,ext:c,interval:this.model.get("interval"),importCanSync:this.options.acceptSync&&this._isArcGISLayer(a),userCanSync:g,showTrial:this.user.canStartTrial(),showUpgrade:!g&&!h&&f&&!this.user.isInsideOrg(),upgradeUrl:f})),this},_isArcGISLayer:function(a){return a.search(/([0-9]+\/|[0-9]+)/)!==-1}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./import_selected_dataset_view":87}],83:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("./data_import/data_form_view"),f=a("./data_import/data_header_view"),g=a("./import_arcgis_selected_dataset_view"),h=a("./import_data_view");b.exports=h.extend({options:{fileExtensions:[],type:"service",service:"arcgis",acceptSync:!0,fileEnabled:!1,fileAttrs:{ext:!1,title:"",description:""}},_initViews:function(){var a=new f({el:this.$(".ImportPanel-header"),model:this.model,user:this.user,collection:this.collection,fileEnabled:this.options.fileEnabled,acceptSync:this.options.acceptSync,template:"common/views/create/listing/import_types/data_header_arcgis"});a.render(),this.addView(a);var b=new g({el:this.$(".DatasetSelected"),user:this.user,model:this.model,acceptSync:this.options.acceptSync,fileAttrs:this.options.fileAttrs});b.render(),this.addView(b);var c=new e({el:this.$(".ImportPanel-form"),user:this.user,model:this.model,template:"common/views/create/listing/import_types/data_form_arcgis",fileEnabled:this.options.fileEnabled});c.render(),this.addView(c)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./data_import/data_form_view":80,"./data_import/data_header_view":81,"./import_arcgis_selected_dataset_view":82,"./import_data_view":84}],84:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("./import_default_view"),f=a("../../../../background_polling/models/upload_model"),g=a("./data_import/data_form_view"),h=a("./data_import/data_header_view"),i=a("./import_selected_dataset_view");b.exports=e.extend({options:{fileExtensions:[],type:"url",service:"",acceptSync:!1,fileEnabled:!1,formTemplate:"",headerTemplate:"",fileAttrs:{}},className:"ImportPanel ImportDataPanel",initialize:function(){this.user=this.options.user,this.model=new f({type:this.options.type,service_name:this.options.service},{user:this.user}),this.template=d.templates.getTemplate("common/views/create/listing/import_types/import_data"),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this.template()),this._initViews(),this},_initViews:function(){var a=new h({el:this.$(".ImportPanel-header"),model:this.model,user:this.user,fileEnabled:this.options.fileEnabled,acceptSync:this.options.acceptSync,template:this.options.headerTemplate});a.render(),this.addView(a);var b=new i({el:this.$(".DatasetSelected"),user:this.user,model:this.model,acceptSync:this.options.acceptSync,fileAttrs:this.options.fileAttrs});b.render(),this.addView(b);var c=new g({el:this.$(".ImportPanel-form"),user:this.user,model:this.model,template:this.options.formTemplate,fileEnabled:this.options.fileEnabled});c.bind("fileSelected",function(){b.setOptions({acceptSync:!1,fileAttrs:{ext:!0,title:"name",description:{content:[{name:"size",format:"size"}]}}})}),c.bind("urlSelected",function(){b.setOptions({acceptSync:!0,fileAttrs:{ext:!1,title:"",description:""}})}),c.render(),this.addView(c)},_initBinds:function(){this.model.bind("change:state",this._checkState,this),this.model.bind("change",this._triggerChange,this)},_checkState:function(){"selected"===this.model.previous("state")&&this.model.set({type:void 0,value:"",service_name:"",service_item_id:"",interval:0})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../background_polling/models/upload_model":19,"./data_import/data_form_view":80,"./data_import/data_header_view":81,"./import_default_view":86,"./import_selected_dataset_view":87}],85:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"ImportPanel",initialize:function(){this.template=c.templates.getTemplate(this.options.template||"common/views/create/listing/import_default_fallback")},render:function(){this.$el.append(this.template())}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],86:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../../../background_polling/models/upload_model");b.exports=d.core.View.extend({initialize:function(){this.user=this.options.user,this.model=new e(null,{user:this.user}),this._initBinds()},_initBinds:function(){this.model.bind("change",this._triggerChange,this)},_triggerChange:function(){this.trigger("change",this.model.toJSON(),this)},getModelData:function(){return this.model?this.model.toJSON():{}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../background_polling/models/upload_model":19}],87:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,f=a("../../../../view_helpers/pluralize_string");b.exports=d.core.View.extend({className:"DatasetSelected",_FORMATTERS:{size:e.readablizeBytes,number:e.formatNumber},options:{acceptSync:!1,fileAttrs:{ext:!1,title:"",description:{content:[{name:"id",format:""}],itemName:"",separator:""}}},events:{"click .js-interval-0":"_onIntervalZero","click .js-interval-1":"_onIntervalHour","click .js-interval-2":"_onIntervalDay","click .js-interval-3":"_onIntervalWeek","click .js-interval-4":"_onIntervalMonth"},initialize:function(){this.user=this.options.user,this.template=d.templates.getTemplate("common/views/create/listing/import_selected_dataset"),this._initBinds(),this._checkVisibility()},render:function(){var a=this.options.fileAttrs.title&&this.model.get("value")[this.options.fileAttrs.title]||this.model.get("value"),b=this._genDescription(),c=this.options.fileAttrs.ext?e.getFileExtension(a):"";this.options.fileAttrs.ext&&(a=a&&a.replace("."+c,""));var f=window.upgrade_url,g=this.user.get("actions")&&this.user.get("actions").sync_tables,h=d.config.get("cartodb_com_hosted");return this.$el.html(this.template({title:a,description:b,ext:c,interval:this.model.get("interval"),importCanSync:this.options.acceptSync,userCanSync:g,showTrial:this.user.canStartTrial(),showUpgrade:!g&&!h&&f&&!this.user.isInsideOrg(),upgradeUrl:f})),this},_initBinds:function(){this.model.bind("change:value",this.render,this),this.model.bind("change:interval",this.render,this),this.model.bind("change:state",this._checkVisibility,this)},_genDescription:function(){if(this.options.fileAttrs&&this.options.fileAttrs.description){var a=this.options.fileAttrs.description,b="",c="",d=this;return a.content&&a.content.length>0&&_.each(a.content,function(e,f){f>0&&a.separator&&(c+=" "+a.separator+" ");var g=d.model.get("value")[e.name],h=e.format&&d._FORMATTERS[e.format];c+=h&&h(g)||g,e.key&&(b=e.name)}),a.itemName&&b&&(c+=" "+(a.itemName&&f(a.itemName,b)||"")),c}return""},_onIntervalZero:function(){this.model.set("interval",0)},_onIntervalHour:function(){this.options.acceptSync&&this.user.get("actions").sync_tables&&this.model.set("interval",3600)},_onIntervalDay:function(){this.options.acceptSync&&this.user.get("actions").sync_tables&&this.model.set("interval",86400)},_onIntervalWeek:function(){this.options.acceptSync&&this.user.get("actions").sync_tables&&this.model.set("interval",604800)},_onIntervalMonth:function(){this.options.acceptSync&&this.user.get("actions").sync_tables&&this.model.set("interval",2592e3)},setOptions:function(a){a&&!_.isEmpty(a)&&_.extend(this.options,a)},_checkVisibility:function(){var a=this.model.get("state");"selected"===a?this.show():this.hide()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../view_helpers/pluralize_string":240}],88:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("../import_default_view"),f=a("../../../../../background_polling/models/upload_model"),g=a("./service_header_view"),h=a("./service_loader_view"),i=a("./service_list_view"),j=a("../import_selected_dataset_view"),k=a("../../../../../service_models/service_token_model"),l=a("../../../../../service_models/service_oauth_model"),m=a("./service_items_collection");b.exports=e.extend({_DATASOURCE_NAME:"",_WINDOW_INTERVAL:1e3,className:"ImportPanel ImportPanelService",options:{service:"",showAvailableFormats:!1,fileExtensions:[],acceptSync:!1,fileAttrs:{ext:!1,title:"filename",description:"<%- size %>",formatDescription:"size",headerTemplate:""}},initialize:function(){return this.options.service?(this._DATASOURCE_NAME=this.options.service,this.user=this.options.user,this.model=new f({type:"service",service_name:this._DATASOURCE_NAME},{user:this.user}),this.template=d.templates.getTemplate("common/views/create/listing/import_types/import_service"),this._initModels(),void this._initBinds()):(d.log.info("Service provider not set for import panel!"),!1)},render:function(){return this.clearSubViews(),this.$el.html(this.template(this.options)),this._initViews(),this},_initModels:function(){this.token=new k(null,{datasource_name:this._DATASOURCE_NAME}),this.service=new l(null,{datasource_name:this._DATASOURCE_NAME}),this.collection=new m(null,{datasource_name:this._DATASOURCE_NAME})},_initBinds:function(){this.model.bind("change",this._triggerChange,this),this.model.bind("change:state",this._checkState,this),this.token.bind("change:oauth_valid",this._onOauthChange,this),this.service.bind("change:url",this._openWindow,this),this.add_related_model(this.service),this.add_related_model(this.token)},_initViews:function(){var a=new g({el:this.$(".ImportPanel-header"),user:this.user,model:this.model,collection:this.collection,title:this.options.title,showAvailableFormats:this.options.showAvailableFormats,fileExtensions:this.options.fileExtensions,acceptSync:this.options.acceptSync,template:this.options.headerTemplate});a.render(),this.addView(a);var b=new h({el:this.$(".ServiceLoader"),model:this.model,token:this.token,service:this.service});b.render(),this.addView(b);var c=new i({el:this.$(".ServiceList"),model:this.model,collection:this.collection,title:this.options.title,fileAttrs:this.options.fileAttrs});c.render(),this.addView(c);var d=new j({el:this.$(".ServiceSelected"),user:this.user,model:this.model,acceptSync:this.options.acceptSync,fileAttrs:this.options.fileAttrs});d.render(),this.addView(d)},_onOauthChange:function(){this.token.get("oauth_valid")&&this._getFiles()},_getFiles:function(){var a=this;this.model.set("state","retrieving"),this.collection.fetch({error:function(){a.model.set("state","error")},success:function(){a.model.set("state","list")}})},_checkState:function(){if("list"===this.model.get("state")&&1===this.collection.size()){var a=this.collection.at(0);this.model.set({state:"selected",value:a.toJSON(),service_item_id:a.get("id")})}"selected"!==this.model.get("state")&&this.model.set({value:"",service_item_id:"",interval:0})},_openWindow:function(){var a=this.service.get("url"),b=this,c=window.open(a,null,"menubar=no,toolbar=no,width=600,height=495"),d=window.setInterval(function(){c&&c.closed?(b._getFiles(),clearInterval(d)):c||(b.model.set("state","error"),clearInterval(d))},this._WINDOW_INTERVAL)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../background_polling/models/upload_model":19,"../../../../../service_models/service_oauth_model":232,"../../../../../service_models/service_token_model":233,"../import_default_view":86,"../import_selected_dataset_view":87,"./service_header_view":89,"./service_items_collection":92,"./service_list_view":94,"./service_loader_view":95}],89:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({events:{"click .js-back":"_goToList"
},options:{title:"Service",showAvailableFormats:!1,acceptSync:!1,fileExtensions:[],template:""},initialize:function(){this.user=this.options.user,this.template=c.templates.getTemplate(this.options.template||"common/views/create/listing/import_types/service_header"),this._initBinds()},render:function(){return this.$el.html(this.template({items:this.collection.size(),service_name:this.model.get("service_name"),showAvailableFormats:this.options.showAvailableFormats,fileExtensions:this.options.fileExtensions,acceptSync:this.options.acceptSync&&this.user.get("actions").sync_tables,state:this.model.get("state"),title:this.options.title})),this._checkVisibility(),this},_initBinds:function(){this.model.bind("change:state",this.render,this)},_checkVisibility:function(){var a=this.model.get("state");this["list"!==a?"show":"hide"]()},_goToList:function(){this.model.set("state","list")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],90:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof a?a.cdb.Utils:null;b.exports={formatSize:function(a){return a&&a>0?c.readablizeBytes(a):"Unknown"}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],91:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({defaults:{id:"",filename:"",checksum:"",service:"",size:"",title:""}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],92:[function(a,b,c){(function(c){var d=a("./service_item_model.js"),e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null;b.exports=e.Collection.extend({_DATASOURCE_NAME:"dropbox",model:d,initialize:function(a,b){b.datasource_name&&(this._DATASOURCE_NAME=b.datasource_name)},fetch:function(){return this.trigger("fetch",this),e.Collection.prototype.fetch.apply(this,arguments)},parse:function(a){return a.files},url:function(a){var b=cdb.config.urlVersion("imports_service",a);return"/api/"+b+"/imports/service/"+this._DATASOURCE_NAME+"/list_files"}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./service_item_model.js":91}],93:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,f=a("./service_item_description_format"),g=a("../../../../../view_helpers/pluralize_string");b.exports=d.core.View.extend({options:{title:"",fileAttrs:{ext:!1,title:"filename",description:"size",itemName:"file",formatDescription:""}},_FORMATTERS:{size:f.formatSize,number:e.formatNumber},className:"ServiceList-item",tagName:"li",events:{"click .js-choose":"_onSelectItem"},initialize:function(){this.template=d.templates.getTemplate("common/views/create/listing/import_types/service_list_item")},render:function(){var a=this.model.get(this.options.fileAttrs.title),b=this._genDescription(),c=this.options.fileAttrs.ext?e.getFileExtension(a):"";return this.options.fileAttrs.ext&&(a=a&&a.replace("."+c,"")),this.$el.html(this.template({name:this.options.title,ext:c,title:a,description:b})),this},_genDescription:function(){if(this.options.fileAttrs&&this.options.fileAttrs.description){var a=this.options.fileAttrs.description,b="",c="",d=this;return a.content&&a.content.length>0&&_.each(a.content,function(e,f){f>0&&a.separator&&(c+=" "+a.separator+" ");var g=d.model.get(e.name),h=e.format&&d._FORMATTERS[e.format];c+=h&&h(g)||g,e.key&&(b=e.name)}),a.itemName&&b&&(c+=" "+(a.itemName&&g(a.itemName,b)||"")),c}return""},_onSelectItem:function(){this.trigger("selected",this.model,this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../view_helpers/pluralize_string":240,"./service_item_description_format":90}],94:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./service_list_item_view"),f=a("../../../../../view_helpers/pluralize_string");b.exports=d.core.View.extend({_TEXTS:{item:_t("item")},options:{title:"service",fileAttrs:{}},initialize:function(){this.template=d.templates.getTemplate("common/views/create/listing/import_types/service_list"),this._initBinds(),this._checkVisibility()},render:function(){this.clearSubViews();var a=this.collection.size();return this.$el.html(this.template({size:a,title:this.options.title,pluralize:f(this._TEXTS.item,a)})),this.collection.size()>0&&this.collection.each(this._addItem,this),this},_initBinds:function(){this.collection.bind("reset",this.render,this),this.model.bind("change:state",this._checkVisibility,this),this.add_related_model(this.collection)},_addItem:function(a){var b=new e({model:a,title:this.options.title,fileAttrs:this.options.fileAttrs});b.bind("selected",this._onSelectedItem,this),this.$(".ServiceList-items").append(b.render().el),this.addView(b)},_onSelectedItem:function(a){this.model.set({state:"selected",value:a.toJSON(),service_item_id:a.get("id")})},_checkVisibility:function(){var a=this.model.get("state");"list"===a?this.show():this.hide()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../view_helpers/pluralize_string":240,"./service_list_item_view":93}],95:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({events:{"click .js-connect":"_checkToken"},initialize:function(){this.token=this.options.token,this.service=this.options.service,this.template=c.templates.getTemplate("common/views/create/listing/import_types/service_loader"),this._initBinds(),this._checkVisibility()},render:function(){return this.$el.html(this.template({state:this.model.get("state")})),this},_initBinds:function(){this.model.bind("change:state",this.render,this),this.model.bind("change:state",this._checkVisibility,this)},_checkToken:function(){var a=this;this.model.set("state","token");var a=this;this.token.fetch({success:function(b){b.get("oauth_valid")||a._getOauthURL()},error:function(b){a._getOauthURL()}})},_checkVisibility:function(){var a=this.model.get("state");"list"!==a&&"selected"!==a?this.show():this.hide()},_getOauthURL:function(){var a=this;this.model.set("state","oauth"),this.service.set({url:""},{silent:!0}),this.service.fetch({error:function(){a.model.set("state","error")}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],96:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;c.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof a?a.cdb.admin:null;var d="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof a?a.cdb.Utils:null;b.exports=c.core.View.extend({initialize:function(){this.user=this.options.user,this._initBinds(),this.template=c.templates.getTemplate("common/views/create/listing/import_types/credits_info")},render:function(){var a=this.user.get("twitter"),b=a.quota-a.monthly_use,c=Math.min(100,Math.ceil(100*this.model.get("value")/b));return this.$el.html(this.template({value:this.model.get("value"),remaining:b,per:c,hardLimit:a.hard_limit,remainingFormatted:d.formatNumber(b),quota:a.quota,block_price:a.block_price,block_size:d.readizableNumber(a.block_size)})),this},_initBinds:function(){this.model.bind("change",this.render,this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],97:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("./credits_info_view");b.exports=d.core.View.extend({_DEFAULT_PER_VALUE:80,_MIN_PER_VALUE:1,initialize:function(){this.user=this.options.user,this.model=new d.core.Model,this._initBinds(),this._setModel()},render:function(){return this.clearSubViews(),this.$(".js-slider").slider("destroy"),this._initViews(),this},_initBinds:function(){_.bindAll(this,"_onSlideChange"),this.model.bind("change:value",this._onValueChange,this)},_setModel:function(){var a=this.user.get("twitter"),b=a.quota-a.monthly_use,c=this._MIN_PER_VALUE*b/100,d=b*this._DEFAULT_PER_VALUE/100,e=b>0?d:b+1;this.model.set({max:a.hard_limit?b:b+1,min:c,step:c,value:b>0?e:a.quota,disabled:!(b>0)})},_initViews:function(){this.$(".js-slider").slider(_.extend({range:"min",orientation:"horizontal",slide:this._onSlideChange,change:this._onSlideChange},this.model.attributes));var a=new e({el:this.$(".js-info"),user:this.user,model:this.model});a.render(),this.addView(a)},_onSlideChange:function(a,b){this.model.set("value",b.value)},_onValueChange:function(){this.trigger("maxCreditsChange",this.getMaxCredits(),this)},getMaxCredits:function(){var a=this.user.get("twitter"),b=a.quota-a.monthly_use,c=this.model.get("value");return c>b?0:c}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./credits_info_view":96}],98:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("../../../../../dialogs/create/listing/imports/import_default_view"),g=a("../../../../../background_polling/models/upload_model"),h=a("../../../../../views/date_pickers/dates_range_picker"),i=a("../../../../../dialogs/create/listing/imports/twitter_import/twitter_categories/twitter_categories_view"),j=a("./credits_usage_view.js");b.exports=f.extend({options:{acceptSync:!1,type:"service",service:"twitter_search"},className:"ImportPanel ImportTwitterPanel",initialize:function(){this.user=this.options.user,this.model=new g({type:this.options.type,service_name:this.options.service},{user:this.user}),this.template=d.templates.getTemplate("common/views/create/listing/import_types/import_twitter"),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this.template()),this._initViews(),this},_initViews:function(){var a=this.categories=new i;a.bind("changeCategory",this._setModel,this),this.$(".ImportTwitterPanel-cagetories").append(a.render().el),this.addView(a);var b=this.datepicker=new h({className:"DatePicker DatePicker--withBorder"});b.bind("changeDate",this._setModel,this),this.$(".js-picker").append(b.render().el),this.addView(b);var c=this.creditsUsage=new j({el:this.$(".CreditsUsage"),user:this.user});c.bind("maxCreditsChange",this._setModel,this),c.render(),this.addView(c),this._setModel()},_initBinds:function(){this.model.bind("change",this._triggerChange,this)},_getCategories:function(){var a=this.categories.getCategories();return e.filter(a,function(a){return a.category&&a.terms.length>0})},_getDates:function(){return this.datepicker.getDates()},_getMaxCredits:function(){return this.creditsUsage.getMaxCredits()},_setModel:function(){var a=this._getCategories(),b=this._getDates(),c=this._getMaxCredits(),d={categories:a,dates:b};this.model.set({value:d,service_item_id:d,user_defined_limits:{twitter_credits_limit:c}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../background_polling/models/upload_model":19,"../../../../../dialogs/create/listing/imports/import_default_view":86,"../../../../../dialogs/create/listing/imports/twitter_import/twitter_categories/twitter_categories_view":100,"../../../../../views/date_pickers/dates_range_picker":253,"./credits_usage_view.js":97}],99:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,e=a("./twitter_category_model");b.exports=d.Collection.extend({model:e})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./twitter_category_model":101}],100:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("./twitter_categories_collection"),f=a("./twitter_category_model"),g=a("./twitter_category_view");b.exports=d.core.View.extend({_MAX_CATEGORIES:4,_MAX_TERMS:29,initialize:function(){var a=this._generateCategory();this.collection=new e([a]),this._initBinds()},render:function(){return this.clearSubViews(),this.collection.each(this._addCategory,this),this},_initBinds:function(){this.collection.bind("change",this._manageCategories,this),this.collection.bind("change",this._onCategoryChange,this),this.add_related_model(this.collection)},_manageCategories:function(){var a=this.collection.size(),b=this.collection.filter(function(a){return 0===a.get("terms").length});if(0===b.length&&a<this._MAX_CATEGORIES){var c=this._generateCategory();return this.collection.add(c),this._addCategory(c),!1}if(b.length>0){var c=_.first(b),d=_.find(this._subviews,function(a){return c.cid===a.model.cid}),e=d.$el.index();if(1===a)return!1;if(e===a-1)return!1;e!==a-1&&b.length>1&&(c=b[1],d=_.find(this._subviews,function(a){return c.cid===a.model.cid}),this._removeCategory(d)),this._setCategoryIndex()}},_setCategoryIndex:function(){var a=this;this.$(".twitter-category").each(function(b,c){var d=$(c).find(".js-category").text().replace("Category ","");if(d!==b+1){var e=a.collection.find(function(a){return a.get("category")===d});e.set("category",(b+1).toString())}})},_generateCategory:function(){return new f({terms:[],category:(this.collection?this.collection.size()+1:1).toString()})},_addCategory:function(a){var b=new g({model:a});b.bind("submit",this._onCategorySubmit,this),b.bind("limit",this._onCategoryLimit,this),b.bind("nolimit",this._onCategoryNoLimit,this),this.$el.append(b.render().el),this.addView(b),this.trigger("addCategory")},_removeCategory:function(a){a.hide(),a.clean(),a.model.destroy(),this.trigger("removeCategory")},_onCategorySubmit:function(){this.trigger("submitCategory",this.collection.toJSON(),this)},_onCategoryLimit:function(){this.trigger("limitCategory",this.collection.toJSON(),this)},_onCategoryNoLimit:function(){this.trigger("noLimitCategory",this.collection.toJSON(),this)},_onCategoryChange:function(){this.trigger("changeCategory",this.collection.toJSON(),this)},getCategories:function(){return this.collection.toJSON()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./twitter_categories_collection":99,"./twitter_category_model":101,"./twitter_category_view":102}],101:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({_MAX_COUNTER:1014,_CHAR_MAP:{" ":2,"-":2,_:2,".":2},defaults:{terms:[],category:"",counter:1014},initialize:function(){this._initBinds()},_initBinds:function(){this.bind("change:terms",this._setCounter,this)},_setCounter:function(){var a=this._MAX_COUNTER,b=this;this.get("terms").length>1&&(a-=4*(this.get("terms").length-1)),_.each(this.get("terms"),function(c){_.each(c,function(c){void 0!==b._CHAR_MAP[c]?a-=b._CHAR_MAP[c]:a--})}),this.set("counter",Math.max(0,a))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],102:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"TwitterCategory",_MAX_CATEGORIES:4,_MAX_TERMS:29,events:{"keydown .js-terms":"_onInputChange","keypress .js-terms":"_onInputChange","keyup .js-terms":"_onInputChange"},initialize:function(){this.template=c.templates.getTemplate("common/views/create/listing/import_types/twitter_category"),this._initBinds()},render:function(){return this.$el.append(this.template({terms:this.model.get("terms"),category:this.model.get("category"),counter:this.model.get("counter")})),this.show(),this},_initBinds:function(){_.bindAll(this,"_onInputChange"),this.model.bind("change:category",this._onCategoryChange,this)},_onCategoryChange:function(){this.$(".js-category").text("Category "+this.model.get("category"))},_onInputChange:function(a){var b=$(a.target).val();if(13===a.keyCode)return a.preventDefault(),this.trigger("submit",this.model,this),!1;if(this.$(".CDB-IconFont-twitter")[b.length>0?"addClass":"removeClass"]("is-highlighted"),(0===this.model.get("counter")||this.model.get("terms").length>this._MAX_TERMS)&&37!==a.keyCode&&39!==a.keyCode&&8!==a.keyCode&&b.length>0)return this.killEvent(a),this.trigger("limit",this.model,this),!1;this.trigger("nolimit",this.model,this);var c=$(a.target),b=c.val(),d={};b=b?b.split(","):[],d.terms=b,this.model.set(d)},show:function(){this.$el.addClass("enabled")},hide:function(){this.$el.removeClass("enabled")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],103:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("./import_options"),f=a("./imports/import_default_fallback_view"),g="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;b.exports=d.core.View.extend({className:"ImportOptions",_TABS_PER_ROW:5,_DEFAULT_IMPORT:"file",_IMPORT_OPTIONS:e,_TEXTS:{key:_t("<%- name %> key is not specified and panel can't be enabled"),account:_t("<%- name %> data source is not available in your plan. Please upgrade"),limits:_t("You've reached the limits for your account. Please upgrade"),credits:_t("You've reached the available <%- name %> credits for your account this month")},events:{"click .js-goNext":"_moveNextTabs","click .js-goPrev":"_movePrevTabs"},initialize:function(){this.user=this.options.user,this.model=new d.core.Model({page:1,maxPages:0}),this.createModel=this.options.createModel,this.template=d.templates.getTemplate("common/views/create/listing/import_view")},render:function(){return this._destroyBinds(),this.clearSubViews(),this.$el.empty(),this.$el.append(this.template()),this._genTabs(),this._genTabsNavigation(),this._genPanes(),this._initBinds(),this._setOption(),this},_genTabs:function(){var a="",b=d.templates.getTemplate("common/views/create/listing/import_tab");g.each(this._IMPORT_OPTIONS,function(c){!g.isEmpty(c)&&c.enabled(d.config,this.user_data)&&(a+=b(c))}),this.$(".ImportOptions-tabsList").append(a),this.importTabs=new d.admin.Tabs({el:this.$(".ImportOptions-tabsList"),slash:!0}),this.addView(this.importTabs)},_genTabsNavigation:function(){var a=this.$(".ImportOptions-tab").size();a<=1&&this.$(".ImportOptions-tabs").hide(),this.model.set("maxPages",Math.ceil(a/this._TABS_PER_ROW)),this._checkTabsNavigation(),this.model.get("maxPages")<=1&&this.$(".ImportOptions-navigation").hide()},_moveNextTabs:function(){var a=this.model.get("page"),b=this.model.get("maxPages");a<b&&this.model.set("page",a+1)},_movePrevTabs:function(){var a=this.model.get("page");a>1&&this.model.set("page",a-1)},_moveTabsNavigation:function(){var a=this.model.get("page"),b=800;this.$(".ImportOptions-tabsList").css("margin-left","-"+b*(a-1)+"px"),this._checkTabsNavigation()},_checkTabsNavigation:function(){var a=this.model.get("page"),b=this.model.get("maxPages");this.$(".js-goPrev")[a>1?"removeClass":"addClass"]("is-disabled"),this.$(".js-goNext")[a<b?"removeClass":"addClass"]("is-disabled")},_genPanes:function(){var a=this;this.importPanes=new d.ui.common.TabPane({el:this.$(".ImportOptions-panes")}),this.addView(this.importPanes),this.importTabs.linkToPanel(this.importPanes),g.each(this._IMPORT_OPTIONS,function(b,c){var d="",e=a["_check"+c+"Import"],h=e&&e(b,a);!h&&void 0!==h||g.isEmpty(b)?b.fallback&&(d=new f({template:b.fallback})):d=new b.className(g.extend(b.options||{},{user:a.user,title:b.title})),d&&(d.render(),d.bind("change",a._setUploadModel,a),a.importPanes.addTab(b.name,d),a.addView(d))})},_checkGDriveImport:function(a,b){return!!d.config.get("oauth_gdrive")||(b._setFailedTab("gdrive","key"),!1)},_checkDropboxImport:function(a,b){return!!d.config.get("oauth_dropbox")||(b._setFailedTab("dropbox","key"),!1)},_checkBoxImport:function(a,b){return!!d.config.get("oauth_box")||(b._setFailedTab("box","key"),!1)},_checkTwitterImport:function(a,b){return d.config.get("datasource_search_twitter")?!!b.user.get("twitter").enabled&&(!(b.user.get("twitter").quota-b.user.get("twitter").monthly_use<=0&&b.user.get("twitter").hard_limit)||(b._setFailedTab("twitter","credits"),!1)):(b._setFailedTab("twitter","key"),!1)},_checkInstagramImport:function(a,b){return!!b.user.featureEnabled("instagram_import")&&(!!d.config.get("oauth_instagram")||(b._setFailedTab("instagram","key"),!1))},_checkSalesforceImport:function(a,b){return!!b.user.get("salesforce").enabled},_checkMailchimpImport:function(a,b){return d.config.get("oauth_mailchimp")?!!b.user.featureEnabled("mailchimp_import"):(b._setFailedTab("mailchimp","key"),!1)},_setFailedTab:function(a,b){var c=this.importTabs.getTab(a);c.addClass("disabled"),this._createTooltip(a,b)},_createTooltip:function(a,b){var c=this,e=this.importTabs.getTab(a),f=new d.common.TipsyTooltip({el:e,title:function(){return g.template(c._TEXTS[b])({name:a})}});this.addView(f)},_setUploadModel:function(a){this.createModel.upload.setFresh(a)},_initBinds:function(){this.model.bind("change:page",this._moveTabsNavigation,this),this.importPanes&&this.importPanes.bind("tabEnabled",this._onTabChange,this)},_destroyBinds:function(){this.importPanes&&this.importPanes.unbind("tabEnabled",null,this)},_setOption:function(){this.importPanes.active(this._DEFAULT_IMPORT),this._updateImportOption()},_updateImportOption:function(){this.createModel.setActiveImportPane(this.importPanes.activeTab)},_onTabChange:function(a){var b=this.importPanes.getPane(a),c=b.getModelData&&b.getModelData();c?this._setUploadModel(c):this._setUploadModel({}),this._updateImportOption()},clean:function(){this._destroyBinds(),d.core.View.prototype.clean.call(this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./import_options":79,"./imports/import_default_fallback_view":85}],104:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,g=a("../../../view_helpers/pluralize_string");b.exports=d.core.View.extend({events:{"submit .js-search-form":"_submitSearch","keydown .js-search-form":"_onSearchKeyDown","click .js-search-form":"killEvent","click .js-search-link":"_onSearchClick","click .js-clean-search":"_onCleanSearchClick","click .js-shared":"_onSharedClick","click .js-library":"_onLibraryClick","click .js-connect":"_onConnectClick","click .js-datasets":"_onDatasetsClick","click .js-create_empty":"_onCreateEmptyClick"},_TEXTS:{createFromScratchLabel:{map:"Create empty map",dataset:"Create empty dataset",addLayer:"Add an empty layer"}},initialize:function(){this.routerModel=this.options.routerModel,this.createModel=this.options.createModel,this.user=this.options.user,this.template=d.templates.getTemplate("common/views/create/listing/navigation"),this.model=new d.core.Model,this._preRender(),this._initBinds()},_preRender:function(){var a=$("<div>").addClass("u-inner"),b=$("<div>").addClass("Filters-inner");this.$el.append(a.append(b))},render:function(a,b){this.clearSubViews();var c=this._selectedItems().length,d=b&&b.changes&&b.changes.content_type,f=this.createModel.get("type");return this.$(".Filters-inner").html(this.template(e.extend({createModel:this.createModel,canCreateDataset:this.user.canCreateDatasets(),listing:this.createModel.get("listing"),isInsideOrg:this.user.isInsideOrg(),selectedItemsCount:c,maxLayersByMap:this.user.getMaxLayers(),totalShared:d?0:this.collection.total_shared,totalItems:d?0:this.collection.total_user_entries,pageItems:this.collection.size(),routerModel:this.routerModel,pluralizedContentType:g("dataset",d?0:this.collection.total_user_entries),pluralizedContentTypeSelected:g("dataset",c),createFromScratchLabel:this._TEXTS.createFromScratchLabel[f]},this.routerModel.attributes))),this._animate(),this.routerModel.isSearching()&&this._focusSearchInput(),this},_initBinds:function(){this.model.on("change:isSearchEnabled",this._onChangeIsSearchEnabled,this),this.createModel.bind("change:listing",this.render,this),this.routerModel.bind("change",this.render,this),this.collection.bind("reset",this.render,this),d.god.bind("closeDialogs",this._animate,this),this.add_related_model(d.god),this.add_related_model(this.createModel),this.add_related_model(this.collection),this.add_related_model(this.routerModel)},_onChangeIsSearchEnabled:function(a,b){this._enableSearchUI(b),this.routerModel.isSearching()?this._cleanSearch():b&&(this._$searchInput().val(""),this._focusSearchInput())},_$searchInput:function(){return this.$(".js-search-input")},_focusSearchInput:function(){this._$searchInput().select().focus()},_onSearchKeyDown:function(a){27===a.keyCode&&(this.killEvent(a),this._cleanSearch())},_selectedItems:function(){return this.collection.where({selected:!0})},_animate:function(){this._enableSearchUI(!!this.routerModel.isSearching());var a=this.routerModel.get("library"),b="datasets"===this.createModel.get("listing"),c=this.collection.total_user_entries>0;this.$el.toggleClass("no-shadow",a&&!c&&b)},_enableSearchUI:function(a){this.$(".js-search-field").toggle(a),this.$(".js-links-list").toggleClass("is-hidden",a),this.$(".js-order-list").toggleClass("is-hidden",a)},_onDatasetsClick:function(){this.routerModel.set({shared:"no",library:!1,page:1}),this.createModel.set("listing","datasets")},_onSharedClick:function(){this.routerModel.set({shared:"only",library:!1,page:1}),this.createModel.set("listing","datasets")},_onLibraryClick:function(){this.routerModel.set({shared:"no",library:!0,page:1}),this.createModel.set("listing","datasets"),d.god.trigger("metrics","common_data",{email:window.user_data.email})},_onConnectClick:function(){this.user.canCreateDatasets()&&this.createModel.set("listing","import")},_onCreateEmptyClick:function(){this.user.canCreateDatasets()&&this.createModel.createFromScratch()},_onSearchClick:function(a){a&&this.killEvent(a),this.model.set("isSearchEnabled",!this.model.get("isSearchEnabled"))},_onCleanSearchClick:function(a){a&&a.preventDefault(),this._cleanSearch()},_cleanSearch:function(){this.routerModel.set({q:"",tag:"",shared:"no",library:this.createModel.showLibrary()}),this.model.set("isSearchEnabled",!1)},_submitSearch:function(a){a&&this.killEvent(a);var b=f.stripHTML(this.$(".js-search-input").val().trim(),""),c=0===b.search(":")?b.replace(":",""):"",d=0!==b.search(":")?b:"";this.routerModel.set({page:1,tag:c,q:d,shared:"yes"}),this.createModel.set("listing","datasets")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_helpers/pluralize_string":240}],105:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("../../view_factory"),g=a("../../view_helpers/random_quote");b.exports=e.extend({initialize:function(){if(this.elder("initialize"),!this.model)throw new Error("model is required (cdb.admin.Visualization)");if(!this.options.title)throw new Error("title is required");if(!this.options.explanation)throw new Error("title is required");if(!this.options.router)throw new Error("router callback is required");this._initViews(),this._initBinds()},render_content:function(){return this._panes.getActivePane().render().el},_initViews:function(){this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("confirm",f.createByTemplate("common/dialogs/create_vis_first/template",{title:this.options.title,explanation:this.options.explanation})),this._panes.addTab("loading",f.createByTemplate("common/templates/loading",{title:"Creating map…",quote:g()})),this._panes.addTab("fail",f.createByTemplate("common/templates/fail",{msg:"Could not create map for some reason"})),this._panes.active("confirm")},_initBinds:function(){this._panes.bind("tabEnabled",this.render,this)},ok:function(){this._panes.active("loading");var a=this;this.model.changeToVisualization({success:function(b){a.options.router.changeToVis(b),a.options.success&&a.options.success(b),a.clean()},error:function(){a._panes.active("fail")}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"../../view_helpers/random_quote":241,"../../views/base_dialog/view":242}],106:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("../../view_factory"),g=a("../../view_helpers/random_quote");b.exports=e.extend({initialize:function(){if(this.elder("initialize"),!this.options.table)throw new Error("table is required");if(!this.options.column)throw new Error("column is required");this._initViews(),this._initBinds()},render_content:function(){return this._panes.getActivePane().render().el},_initViews:function(){this.table=this.options.table,this.column=this.options.column,this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("confirm",f.createByTemplate("common/dialogs/delete_column/template",{column:this.column})),this._panes.addTab("loading",f.createByTemplate("common/templates/loading",{title:"Deleting column…",quote:g()})),this._panes.addTab("fail",f.createByTemplate("common/templates/fail",{msg:"Could not delete column for some reason"})),this._panes.active("confirm")},_initBinds:function(){this._panes.bind("tabEnabled",this.render,this)},ok:function(){this._panes.active("loading"),this.table.deleteColumn(this.column),this.close()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"../../view_helpers/random_quote":241,"../../views/base_dialog/view":242}],107:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../views/base_dialog/view"),f=a("../view_helpers/pluralize_string"),g=a("../view_helpers/random_quote"),h=a("../views/mapcard_preview"),i="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,j="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null,k=3,l=3;b.exports=e.extend({initialize:function(){if(this.elder("initialize"),!this.options.viewModel)throw new TypeError("viewModel is required");if(!this.options.user)throw new TypeError("user is required");this._viewModel=this.options.viewModel,this._viewModel.loadPrerequisites(),this._viewModel.bind("change",function(){"DeleteItemsDone"===this._viewModel.state()?this.close():this.render()},this),this.add_related_model(this._viewModel)},render:function(){return e.prototype.render.call(this),this._loadMapPreviews(),this},render_content:function(){return this["_render"+this._viewModel.state()]()},_renderLoadingPrerequisites:function(){return d.templates.getTemplate("common/templates/loading")({title:"Checking what consequences deleting the selected "+this._pluralizedContentType()+" would have...",quote:g()})},_renderLoadPrerequisitesFail:function(){return d.templates.getTemplate("common/templates/fail")({
msg:"Failed to check consequences of deleting the selected "+this._pluralizedContentType()})},_renderConfirmDeletion:function(){var a=this._viewModel.affectedEntities(),b=this._viewModel.affectedVisData();return d.templates.getTemplate("common/dialogs/delete_items_view_template")({firstItemName:this._getFirstItemName(),selectedCount:this._viewModel.length,isDatasets:this._viewModel.isDeletingDatasets(),pluralizedContentType:this._pluralizedContentType(),affectedEntitiesCount:a.length,affectedEntitiesSample:a.slice(0,k),affectedEntitiesSampleCount:k,affectedVisCount:b.length,pluralizedMaps:f("map",b.length),affectedVisVisibleCount:l,visibleAffectedVis:this._prepareVisibleAffectedVisForTemplate(b.slice(0,l))})},_prepareVisibleAffectedVisForTemplate:function(a){return a.map(function(a){var b=new d.admin.Visualization(a),c=b.permission.owner;return{visId:b.get("id"),name:b.get("name"),url:b.viewUrl(this.options.user).edit(),owner:c,ownerName:c.get("username"),isOwner:b.permission.isOwner(this.options.user),showPermissionIndicator:!b.permission.hasWriteAccess(this.options.user),timeDiff:j(b.get("updated_at")).fromNow()}},this)},ok:function(){this._viewModel.deleteItems(),this.render()},_loadMapPreviews:function(){var a=this;this.$el.find(".MapCard").each(function(){var b=i(this).data("visOwnerName"),c=new h({el:i(this).find(".js-header"),width:298,height:130,mapsApiResource:d.config.getMapsResourceName(b),visId:i(this).data("visId"),username:b}).load();a.addView(c)})},_renderDeletingItems:function(){return d.templates.getTemplate("common/templates/loading")({title:"Deleting the selected "+this._pluralizedContentType()+"...",quote:g()})},_renderDeleteItemsFail:function(){var a=this._viewModel.errorMessage().replace(/\n/g,"<br>");return"something failed"===a&&(a=""),d.templates.getTemplate("common/templates/fail")({msg:"Failed to delete the selected "+this._pluralizedContentType()+". "+a})},_pluralizedContentType:function(){return f(this._viewModel.isDeletingDatasets()?"dataset":"map",this._viewModel.length)},_getFirstItemName:function(){if(this.options.viewModel){var a=this.options.viewModel.at(0);return a?a.get("name"):void 0}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../view_helpers/pluralize_string":240,"../view_helpers/random_quote":241,"../views/base_dialog/view":242,"../views/mapcard_preview":256}],108:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,e=a("../../common/batch_process_items");b.exports=d.Collection.extend({initialize:function(a,b){if(!b.contentType)throw new TypeError("contentType is required");this._contentType=b.contentType},state:function(){return this._state},errorMessage:function(){return this._errorMessage},setState:function(a){this._state=a,this.trigger("change"),this.trigger(a)},isDeletingDatasets:function(){return"datasets"===this._contentType},loadPrerequisites:function(){var a=this.setState.bind(this,"ConfirmDeletion");this.isDeletingDatasets()?(this.setState("LoadingPrerequisites"),e({howManyInParallel:5,items:this.toArray(),processItem:this._loadPrerequisitesForModel,done:a,fail:this.setState.bind(this,"LoadPrerequisitesFail")})):a()},affectedEntities:function(){return this.chain().map(function(a){return a.sharedWithEntities()}).flatten().compact().value()},affectedVisData:function(){var a=this.chain().map(function(a){var b=a.tableMetadata();return[].concat(b.get("dependent_visualizations")).concat(b.get("non_dependent_visualizations"))}).flatten().compact().value();return _.uniq(a,function(a){return a.id})},deleteItems:function(){this.setState("DeletingItems"),e({howManyInParallel:1,items:this.toArray(),processItem:this._deleteItem,done:this.setState.bind(this,"DeleteItemsDone"),fail:this._deletionFailed.bind(this)})},_deletionFailed:function(a){this._errorMessage=a,this.setState("DeleteItemsFail")},_loadPrerequisitesForModel:function(a,b){var c=a.tableMetadata();c.no_data_fetch=!0,c.fetch({wait:!0,success:function(){b()},error:function(a,c){b(c.responseText)}})},_deleteItem:function(a,b){a.destroy({wait:!0}).done(function(){b()}).fail(function(a){var c;try{c=JSON.parse(a.responseText).errors.join("; ")}catch(a){c="something failed"}b(c)})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/batch_process_items":28}],109:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("../../view_factory"),g=a("../../view_helpers/random_quote");b.exports=e.extend({initialize:function(){if(this.elder("initialize"),_.extend(this.options,{clean_on_hide:!0,enter_to_confirm:!0}),!this.model)throw new Error("model is required (layer)");this._initViews(),this._initBinds()},render_content:function(){return this._panes.getActivePane().render().el},_initViews:function(){this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("confirm",f.createByTemplate("common/dialogs/delete_layer/template",{})),this._panes.addTab("loading",f.createByTemplate("common/templates/loading",{title:"Deleting layer…",quote:g()})),this._panes.addTab("fail",f.createByTemplate("common/templates/fail",{msg:"Could not delete layer for some reason"})),this._panes.active("confirm")},_initBinds:function(){this._panes.bind("tabEnabled",this.render,this)},ok:function(){this._panes.active("loading");var a=this;this.model.destroy({wait:!0,success:function(){a.close()},error:function(){a._panes.active("fail")}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"../../view_helpers/random_quote":241,"../../views/base_dialog/view":242}],110:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("../../view_factory"),g=a("../../view_helpers/random_quote");b.exports=e.extend({initialize:function(){if(this.elder("initialize"),!this.options.table)throw new Error("table is required");if(!this.options.row)throw new Error("row is required");this.options.name=this.options.name||"row",this._initViews(),this._initBinds()},render_content:function(){return this._panes.getActivePane().render().el},_initViews:function(){this.table=this.options.table,this.row=this.options.row,this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("confirm",f.createByTemplate("common/dialogs/delete_row/template",{name:this.options.name})),this._panes.addTab("loading",f.createByTemplate("common/templates/loading",{title:"Deleting "+this.options.name+"…",quote:g()})),this._panes.addTab("fail",f.createByTemplate("common/templates/fail",{msg:"Could not delete "+this.options.name+" for some reason"})),this._panes.active("confirm")},_initBinds:function(){this._panes.bind("tabEnabled",this.render,this)},ok:function(){var a=this;this._panes.active("loading"),this.table.trigger("removing:row"),this.row.destroy({success:function(){a.table.trigger("remove:row",a.row),a.close()},error:function(){a._panes.active("fail")}},{wait:this.options.wait})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"../../view_helpers/random_quote":241,"../../views/base_dialog/view":242}],111:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("../views/base_dialog/view"),g=a("../view_factory"),h=a("../view_helpers/random_quote"),i=a("../views/error_details_view");b.exports=f.extend({initialize:function(){if(this.elder("initialize"),!this.model)throw new Error("model is required (cdb.admin.CartoDBTableMetadata)");if(!this.options.user)throw new Error("user is required");this.elder("initialize"),this._initViews(),this._initBinds(),this._duplicateDataset()},render_content:function(){return this._panes.getActivePane().render().el},_initViews:function(){this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("loading",g.createByTemplate("common/templates/loading",{title:this.model.isInSQLView()?"Creating dataset from your query":"Duplicating your dataset",quote:h()})),this._panes.active("loading")},_initBinds:function(){this._panes.bind("tabEnabled",this.render,this)},_duplicateDataset:function(a){var b=this,a=this.model.get("name")+"_copy";this.model.duplicate(a,{success:function(a){b._redirectTo(a.viewUrl())},error:b._showError.bind(b)})},_showError:function(a){var b;try{var c=e.clone(a.attributes);b=new i({err:e.extend(c,a.attributes.get_error_text),user:this.options.user})}catch(a){b=g.createByTemplate("common/templates/fail",{msg:"Sorry, something went wrong, but we're not sure why."})}this._panes.addTab("fail",b.render()),this._panes.active("fail")},_redirectTo:function(a){window.location=a}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../view_factory":237,"../view_helpers/random_quote":241,"../views/base_dialog/view":242,"../views/error_details_view":254}],112:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("../views/base_dialog/view"),g=a("../view_factory"),h=a("../view_helpers/random_quote"),i=a("../views/error_details_view");b.exports=f.extend({initialize:function(){if(this.elder("initialize"),!this.model)throw new Error("model is required (cdb.admin.Visualization)");if(!this.options.user)throw new Error("user is required");this.elder("initialize"),this._initViews(),this._initBinds(),this._duplicateMap()},render_content:function(){return this._panes.getActivePane().render().el},_initViews:function(){this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("loading",g.createByTemplate("common/templates/loading",{title:"Duplicating your map",quote:h()})),this._panes.active("loading")},_initBinds:function(){this._panes.bind("tabEnabled",this.render,this)},_duplicateMap:function(a){var b=this,a=this.model.get("name")+" copy";this.model.copy({name:a},{success:function(a){b._redirectTo(a.viewUrl(b.options.user).edit().toString())},error:b._showError.bind(b)})},_showError:function(a){var b;try{var c=e.clone(a.attributes);b=new i({err:e.extend(c,a.attributes.get_error_text),user:this.options.user})}catch(a){b=g.createByTemplate("common/templates/fail",{msg:"Sorry, something went wrong, but we're not sure why."})}this._panes.addTab("fail",b.render()),this._panes.active("fail")},_redirectTo:function(a){window.location=a}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../view_factory":237,"../view_helpers/random_quote":241,"../views/base_dialog/view":242,"../views/error_details_view":254}],113:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,f="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof a?a.cdb.Utils:null;b.exports=d.core.View.extend({options:{maxLength:200},events:{"keydown .js-name":"_onNameKeyDown","click .js-privacy":"_showPrivacy",submit:"_onSubmit"},initialize:function(){this.user=this.options.user,this.template=d.templates.getTemplate("common/dialogs/edit_vis_metadata/edit_vis_form"),this._initBinds()},render:function(){return this.clearSubViews(),this._destroyTags(),this.$el.html(this.template({isDataset:this.model.isDataset(),isDataLibraryEnabled:this.user.featureEnabled("data_library"),visValue:this.model.get("name"),visDescription:this.model.get("description"),visPrivacy:this.model.get("privacy").toLowerCase(),visSource:this.model.get("source"),visAttributions:this.model.get("attributions"),visDisplayName:this.model.get("display_name"),isNameEditable:this.model.isNameEditable(),isMetadataEditable:this.model.isMetadataEditable(),maxLength:this.options.maxLength})),this._initViews(),this},_initBinds:function(){this.model.bind("error",this._setFields,this),this.model.bind("valid",this._setFields,this)},_initViews:function(){var a=this;this.addView(new d.common.TipsyTooltip({el:this.$(".js-markdown"),html:!0,title:function(){return c(this).data("title")}})),this.addView(new d.common.TipsyTooltip({el:this.$(".js-name"),title:function(){return a.model.getError()}})),e.each(this.model.get("tags"),function(a){this.$(".js-tagsList").append("<li>"+d.core.sanitize.html(a)+"</li>")},this);var b=this.model.isMetadataEditable()||0!==this.model.get("tags").length?"Add tags":"No tags";this.$(".js-tagsList").tagit({allowSpaces:!0,placeholderText:b,readOnly:!this.model.isMetadataEditable(),onBlur:function(){a.model.isMetadataEditable()&&a.$(".js-tags").removeClass("is-focus")},onFocus:function(){a.model.isMetadataEditable()&&a.$(".js-tags").addClass("is-focus")},onSubmitTags:function(b,c){return b.preventDefault(),a._onSubmit(),!1}}),this.model.isDataset()&&(this._licenseDropdown=new d.forms.Combo({className:"Select",width:"100%",property:"license",model:this.model,disabled:!this.model.isMetadataEditable(),extra:this._getLicensesForFormsCombo()}),this.addView(this._licenseDropdown),this.$(".js-license").append(this._licenseDropdown.render().el))},_getLicensesForFormsCombo:function(){var a=d.config.get("licenses"),b=[{id:"",name:"-"}];return e.chain(b.concat(a)).compact().map(function(a){return[a.name,a.id]}).value()},_setFields:function(){this.$(".js-name").toggleClass("is-invalid",!!this.model.getError())},_showPrivacy:function(a){this.killEvent(a),this.trigger("onPrivacy",this)},_onNameKeyDown:function(a){if(a.keyCode===c.ui.keyCode.ENTER)return a.preventDefault(),this._onSubmit(),!1},_onSubmit:function(a){a&&this.killEvent(a);var b={};this.model.isNameEditable()&&(b.name=f.stripHTML(this.$(".js-name").val())),this.model.isMetadataEditable()&&(b.description=f.removeHTMLEvents(this.$(".js-description").val()),b.tags=this.$(".js-tagsList").tagit("assignedTags"),this.model.isDataset()&&(b.source=this.$(".js-source").val(),b.attributions=this.$(".js-attributions").val(),b.display_name=this.$(".js-displayName").val())),this.model.set(b),this.model.isValid()&&this.trigger("onSubmit",this.model,this)},_destroyTags:function(){this.$(".js-tagsList").tagit("destroy")},clean:function(){this._destroyTags(),this.elder("clean")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],114:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({defaults:{name:"",description:"",tags:"",privacy:""},initialize:function(a,b){if(!(b&&b.vis&&b.user&&b.dataLayer))throw new Error("Visualization, user and dataLayer models are required");this.vis=b.vis,this.user=b.user,this.dataLayer=b.dataLayer;var c={name:this.vis.get("name"),description:this.vis.get("description"),tags:this.vis.get("tags"),privacy:this.vis.get("privacy")};this.vis.isVisualization()||(c.source=this.vis.get("source")||"",c.attributions=this.vis.get("attributions")||"",c.license=this.vis.get("license")||"",c.display_name=this.vis.get("display_name")||""),this.set(c),this.validationError="",this._initBinds()},_initBinds:function(){this.bind("valid",function(){this.validationError=""},this),this.bind("error",function(a,b){this.validationError=b},this)},_validate:function(a){var b=c.core.Model.prototype._validate.apply(this,arguments);return!!b&&(this.trigger("valid"),!0)},validate:function(a){if(a)return a.name?void 0:"Name can't be blank"},getError:function(){return this.validationError},isValid:function(){return!this.validate||!this.validate(this.attributes)&&""===this.validationError},isDataset:function(){return!this.vis.isVisualization()},isVisEditable:function(){return this.vis.permission.isOwner(this.user)},isAttributeEditable:function(a){if(this.vis.isVisualization())return this.isVisEditable();var b="name"===a&&this.dataLayer.isReadOnly();return!!this.dataLayer&&!(this.dataLayer&&(b||!this.dataLayer.permission.isOwner(this.user)))},isNameEditable:function(){return this.isAttributeEditable("name")},isMetadataEditable:function(){return this.isAttributeEditable("rest")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],115:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("../../view_factory"),g=a("./edit_vis_form_view"),h=a("./edit_vis_metadata_dialog_model"),i=a("../../view_helpers/random_quote"),j="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;b.exports=e.extend({events:e.extendEvents({"click .js-back":"_showForm"}),className:"Dialog is-opening EditVisMetadata",initialize:function(){if(this.elder("initialize"),!this.options.vis)throw new TypeError("vis model is required");this.vis=this.options.vis,this.user=this.options.user,this.dataLayer=this.options.dataLayer,this.model=new h({},{vis:this.vis,dataLayer:this.dataLayer,user:this.user}),this.template=d.templates.getTemplate("common/dialogs/edit_vis_metadata/edit_vis_metadata_dialog")},render:function(){return this.clearSubViews(),e.prototype.render.call(this),this.$(".content").addClass("Dialog-content--expanded"),this._initViews(),this},render_content:function(){var a=this.vis.isVisualization()?"map":"dataset";return this.template({visType:a,visTypeCapitalized:a.charAt(0).toUpperCase()+a.slice(1),isNameEditable:this.model.isNameEditable(),isMetadataEditable:this.model.isMetadataEditable()})},_initViews:function(){this._panes=new d.ui.common.TabPane({el:this.$(".js-content")});var a=new g({el:this.$(".js-form"),model:this.model,user:this.user,maxLength:this.options.maxLength});a.bind("onPrivacy",this._showPrivacy,this),a.bind("onSubmit",this._saveAttributes,this),this._panes.addTab("form",a.render()),this._panes.addTab("loading",f.createByTemplate("common/templates/loading",{title:"Saving new data...",quote:i()}).render()),this._panes.addTab("error",f.createByTemplate("common/templates/fail",{msg:'Sorry, something went wrong but you can get <button class="Button--link js-back">back to the form</button>.'}).render()),this._panes.active("form")},_saveAttributes:function(){var a=this,b=j.omit(this.model.toJSON(),"privacy"),c={name:this.vis.get("name"),description:this.vis.get("description"),tags:this.vis.get("tags")};this.model.isDataset()&&(c.source=this.vis.get("source"),c.attributions=this.vis.get("attributions"),c.license=this.vis.get("license")),j.isEmpty(this.vis.changedAttributes(b))?this.hide():(this._panes.active("loading"),this.vis.save(b,{success:function(){a.options.onDone&&a.options.onDone(c.name!==b.name),a.hide()},error:function(){a.vis.set(c),a._panes.active("error")}}))},_showPrivacy:function(){this.options.onShowPrivacy&&this.options.onShowPrivacy(),this.hide()},_showForm:function(){this._panes.active("form")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"../../view_helpers/random_quote":241,"../../views/base_dialog/view":242,"./edit_vis_form_view":113,"./edit_vis_metadata_dialog_model":114}],116:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,g=a("../../views/base_dialog/view");b.exports=g.extend({_CSV_FILTER:"SELECT * FROM (%%sql%%) as subq ",_MAX_SQL_GET_LENGTH:1e3,events:g.extendEvents({"click .js-option:not(.is-disabled)":"_export"}),formats:[{format:"csv",fetcher:"fetchCSV",geomRequired:!1,illustrationIconModifier:"IllustrationIcon--neutral"},{format:"shp",fetcher:"fetch",geomRequired:!0,illustrationIconModifier:"IllustrationIcon--magenta"},{format:"kml",fetcher:"fetch",geomRequired:!0,illustrationIconModifier:"IllustrationIcon--sunrise"},{format:"geojson",label:"geo json",fetcher:"fetch",geomRequired:!0,illustrationIconModifier:"IllustrationIcon--cyan"},{format:"svg",fetcher:"fetchSVG",geomRequired:!0,illustrationIconModifier:"IllustrationIcon--royalDark"}],initialize:function(){d.extend(this.options,{clean_on_hide:!0,table_id:this.model.id}),this.elder("initialize"),d.bindAll(this,"_export"),this.baseUrl=f.config.getSqlApiUrl(),this.model.bind("change:geometry_types",this.refresh,this)},getFormat:function(a){for(var b in this.formats)if(this.formats[b].format===a)return this.formats[b]},_export:function(a){this.killEvent(a);var b=e(a.currentTarget),c=b.data("format"),d=this.getFormat(c);this[d.fetcher](c)},getBaseOptions:function(){var a={};return a.filename=this.model.get("name"),this.options.user_data&&(a.api_key=this.options.user_data.api_key),a},getPlainSql:function(){return this.options.sql?sql=this.options.sql:this.model.sqlView?sql=this.model.sqlView.getSQL():sql="select * from "+this.model.get("name"),sql},getGeomFilteredSql:function(){var a=this.getPlainSql();return this.model.isGeoreferenced()?this._CSV_FILTER.replace(/%%sql%%/g,a):a},_fetch:function(a,b){if(this._showElAndHideRest(".js-preparing-download"),this.$(".format").val(a.format),this.$(".q").val(b),this.$(".filename").val(a.filename),this.$(".api_key").val(a.api_key),"csv"===a.format?this.$(".skipfields").val("the_geom_webmercator"):this.$(".skipfields").val("the_geom,the_geom_webmercator"),window.user_data&&window.user_data.email&&f.god.trigger("metrics","export_table",{email:window.user_data.email}),b.length<this._MAX_SQL_GET_LENGTH){var c=this.$("form").attr("action")+"?"+this.$("form").serialize();this._fetchGET(c)}else this.submit();this.$(".db").attr("disabled","disabled"),this.$(".skipfields").attr("disabled","disabled"),this.options.autoClose&&(this.close(),this.trigger("generating",this.$(".js-preparing-download").html()))},showError:function(a){this.$(".js-error").html(this.getTemplate("common/templates/fail")({msg:a})),this._showElAndHideRest(".js-error")},_fetchGET:function(a){function b(a){var b=null;try{var c=JSON.parse(a);b=c.error[0]}catch(c){a&&a.indexOf("error")!==-1&&(b="an error occurred")}return b}var c,d=this,e=window.open(a);e.onload=function(){clearInterval(c);var a=b(e.document.body.textContent);a?d.showError(a):d.close(),e.close()},window.focus(),c=setInterval(function(){(e.closed||e.document&&0===e.document.body.textContent.length)&&(d.close(),clearInterval(c))},100)},submit:function(){this.$("form").submit()},fetch:function(a){var b=this.getBaseOptions();b.format=a;var c=this.getPlainSql();this._fetch(b,c)},fetchCSV:function(){var a=this.getBaseOptions();a.format="csv";var b=this.getGeomFilteredSql();this.$(".skipfields").removeAttr("disabled"),this._fetch(a,b)},fetchSVG:function(){this.$(".db").removeAttr("disabled"),this.fetch("svg")},render_content:function(){var a=this.model.isGeoreferenced();return d.isBoolean(a)?this.getTemplate("common/dialogs/export/export_template")({preparingDownloadContent:this._renderLoadingContent("We are preparing your download. Depending on the size, it could take some time."),formats:this.formats,url:this.baseUrl,isGeoreferenced:a}):this._renderLoadingContent("Checking georeferences…")},refresh:function(){this.$(".content").html(this.render_content())},_renderLoadingContent:function(a){return this.getTemplate("common/templates/loading")({title:a,quote:f.editor.randomQuote()})},_showElAndHideRest:function(a){[".js-start",".js-preparing-download",".js-error"].forEach(function(b){this.$(b)[b===a?"show":"hide"]()},this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../views/base_dialog/view":242}],117:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("../../view_helpers/random_quote");b.exports=e.extend({events:e.extendEvents({"click .js-ok":"_confirm","click .js-download":"_download","click .js-cancel":"_abortExport"}),initialize:function(a){this.elder("initialize"),this._initBinds()},render_content:function(){var a=this.model.get("state");if("complete"!==a){if("failure"===a)return d.templates.getTemplate("common/templates/fail")({msg:"Export has failed"});if("pending"===a||"exporting"===a||"uploading"===a){var b=a.charAt(0).toUpperCase()+a.slice(1)+" ...";return this.getTemplate("common/templates/loading")({title:b,quote:f()})}return d.templates.getTemplate("common/dialogs/export_map/templates/confirm")}var c=window.open(this.model.get("url"));return void 0===c?d.templates.getTemplate("common/dialogs/export_map/templates/download"):(c.focus(),void this.close())},_confirm:function(){this.model.requestExport()},_download:function(){window.open(this.model.get("url")),window.focus(),this.close()},_abortExport:function(){this.model.cancelExport(),this.close()},_initBinds:function(){this.model.bind("change:state",function(){this.render()},this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_helpers/random_quote":241,"../../views/base_dialog/view":242}],118:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"AddColumn js-addField",events:{"click .js-addColumn":"_addColumn"},initialize:function(){this.model=new c.core.Model({state:"idle"}),this.table=this.options.table,this.template=c.templates.getTemplate("common/dialogs/feature_data/add_column/add_column"),this._initBinds()},render:function(){return this.$el.html(this.template({state:this.model.get("state")})),this},_initBinds:function(){this.model.bind("change:state",this.render,this)},_addColumn:function(){var a=this;this.model.set("state","loading"),this.table.addColumn("column_"+(new Date).getTime(),"string",{success:function(b,c){a.trigger("newColumn",b,this),a.model.set("state","idle")},error:function(){a.model.set("state","error")}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],119:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("./form_view"),g=a("../../view_factory"),h=a("../../view_helpers/random_quote"),i="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;b.exports=e.extend({events:e.extendEvents({"click .js-back":"_showForm"}),className:"Dialog is-opening FeatureData",initialize:function(){if(this.elder("initialize"),!this.options.table)throw new TypeError("table is required");this.row=this.options.row,this.table=this.options.table,this.baseLayer=this.options.baseLayer,this.dataLayer=this.options.dataLayer,this.provider=this.options.provider,this.currentZoom=this.options.currentZoom,this.user=this.options.user,this._template=d.templates.getTemplate("common/dialogs/feature_data/feature_data_dialog")},render:function(){return this.clearSubViews(),e.prototype.render.call(this),this.$(".content").addClass("Dialog-content--expanded"),this._initViews(),this},render_content:function(){return this._template({featureType:this.row.getFeatureType(),quote:h()})},_initViews:function(){var a=this;this._panes=new d.ui.common.TabPane({el:this.$(".js-content")}),setTimeout(function(){a._createPreviewMap()},200),this.form=new f({el:this.$(".js-form"),table:this.table,row:this.row}),this.form.bind("onSubmit",this._changeAttributes,this),this.form.bind("onError",this._scrollToError,this),this._panes.addTab("form",this.form.render()),this.addView(this.form),this._panes.addTab("loading",g.createByTemplate("common/templates/loading",{title:"Saving new data...",quote:h()}).render()),this._panes.addTab("error",g.createByTemplate("common/templates/fail",{msg:'Sorry, something went wrong but you can get <button class="Button--link js-back">back to the form</button>.'}).render()),this._panes.active("form")},_scrollToError:function(a){this.$(".js-content").animate({scrollTop:this.$(".EditField-label[value='"+a.get("attribute")+"']").position().top-20})},_changeAttributes:function(a){var b=this,c=i.object(i.pluck(a,"attribute"),i.pluck(a,"value")),e={};this._panes.active("loading"),i.each(this.row.attributes,function(a,f){void 0!==c[f]||d.admin.Row.isReservedColumn(f)||"id"===f||b.row.unset(f),e[f]=a}),i.isEmpty(this.row.changedAttributes(c))?b._cancel():this.row.save(c,{success:function(){b._ok()},error:function(){b.row.set(e),b._panes.active("error")}})},_createPreviewMap:function(){var a=this,b=this.$(".js-map"),c=d.admin.LeafletMapView;if("googlemaps"===this.provider)var c=d.admin.GoogleMapsMapView;this.map=new d.admin.Map,this.mapView=new c({el:b,map:this.map,user:this.user}),this.baseLayer.set("attribution",""),this.map.addLayer(this.baseLayer),this.dataLayer.set("query","SELECT * FROM "+this.table.get("name")+" WHERE cartodb_id="+this.row.get("cartodb_id")),this.dataLayer.set("attribution",""),this.map.addLayer(this.dataLayer);var e=new d.admin.SQL({user:this.user.get("username"),api_key:this.user.get("api_key")});e.getBounds("SELECT * FROM "+this.table.get("name")+" WHERE cartodb_id="+this.row.get("cartodb_id")).done(function(b){b&&(b[0][0]===b[1][0]&&b[0][1]===b[1][1]?a.map.setCenter(b[0]):a.map.setBounds(b),a.map.setZoom(a.currentZoom))})},_showForm:function(){this._panes.active("form")},_ok:function(){this.options.onDone&&this.options.onDone(),this.elder("_ok")},_cancel:function(){this.elder("_cancel")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"../../view_helpers/random_quote":241,"../../views/base_dialog/view":242,"./form_view":122}],120:[function(a,b,c){(function(a){var c=("undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,"undefined"!=typeof window?window.Backbone:"undefined"!=typeof a?a.Backbone:null);b.exports=c.Collection.extend({isValid:function(){return!this.getInvalid()},getInvalid:function(){return this.find(function(a){return!a.isValid()})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],121:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("../../../edit_fields/string_field/string_field_view"),g=a("../../../edit_fields/number_field/number_field_view"),h=a("../../../edit_fields/boolean_field/boolean_field_view"),i=a("../../../edit_fields/date_field/date_field_view");b.exports=d.core.View.extend({events:{"keydown .js-columnName":"_onInputChange","focusout .js-columnName":"_onColNameChange"},_FIELD_VIEW:{string:f,number:g,boolean:h,date:i,"timestamp with time zone":i,"timestamp without time zone":i},initialize:function(){this.model=new d.core.Model({columnError:"",typeError:"",fieldError:""}),this.table=this.options.table,this.row=this.options.row,this.fieldModel=this.options.fieldModel,this.template=d.templates.getTemplate("common/dialogs/feature_data/form_field/form_field"),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this.template({type:this.fieldModel.get("type"),value:this.fieldModel.get("value"),attribute:this.fieldModel.get("attribute"),readOnly:this.fieldModel.get("readOnly"),typeError:this.model.get("typeError"),columnError:this.model.get("columnError")})),this._initViews(),this},_initBinds:function(){this.fieldModel.bind("change:readOnly",this.render,this),this.fieldModel.bind("change:type",this._onTypeChanged,this),
this.add_related_model(this.fieldModel)},_initViews:function(){var a=this,b=this._FIELD_VIEW[this.fieldModel.get("type")]||this._FIELD_VIEW.string,c=new b({readOnly:this.fieldModel.get("readOnly"),model:this.fieldModel}).bind("onSubmit",function(a){this.trigger("onSubmit")},this);this.$(".js-editField").append(c.render().el),this.addView(c);var e=new d.common.TipsyTooltip({el:this.$(".js-editField"),title:function(){return a.fieldModel.getError()}});this.addView(e);var f=[this.fieldModel.get("type")].concat(_.filter(["string","boolean","number","date"],function(b){return a.table.isTypeChangeAllowed(a.fieldModel.get("attribute"),b)})),g=new d.forms.Combo({el:this.$(".js-fieldType"),model:this.fieldModel,property:"type",disabled:this.fieldModel.get("readOnly"),width:"85px",extra:f});this.$(".js-fieldType").append(g.render()),g.bind("change",function(a){this.fieldModel.set({value:null,type:a})},this),this.addView(g);var h=new d.common.TipsyTooltip({el:this.$(".js-fieldType"),title:function(){return a.model.get("typeError")}});this.addView(h);var h=new d.common.TipsyTooltip({el:this.$(".js-columnName"),title:function(){return a.model.get("columnError")}});this.addView(h)},_onTypeChanged:function(){var a=this,b=this.fieldModel.previous("type"),c=this.fieldModel.previous("value");this.model.set("typeError",""),this.fieldModel.set("readOnly",!0),this.table.changeColumnType(this.fieldModel.get("attribute"),this.fieldModel.get("type"),{success:function(){a._refreshRecordData(function(){a.fieldModel.set("readOnly",!1)})},error:function(){a.fieldModel.attributes.readOnly=!1,a.fieldModel.attributes.value=c,a.fieldModel.attributes.type=b;try{var d=JSON.parse(e.responseText).errors[0];a.model.set("typeError",d)}catch(a){}a.render()}})},_onInputChange:function(a){13===a.keyCode&&($(a.target).blur(),this.killEvent(a))},_onColNameChange:function(a){var b=this,c=$(a.target).val(),d=this.fieldModel.get("attribute");d!==c&&(this.fieldModel.set({attribute:c,readOnly:!0}),this.table.renameColumn(d,c,{success:function(a,c){b.model.set("columnError",""),b.fieldModel.set({attribute:c.name,readOnly:!1})},error:function(a,c){try{var e=JSON.parse(c.responseText).errors[0];b.model.set("columnError",e)}catch(a){}b.fieldModel.set({attribute:d,readOnly:!1})}}))},_refreshRecordData:function(a){var b=this;this.row.fetch({success:function(c){var d=c&&c.rows[0]&&c.rows[0][b.fieldModel.get("attribute")];b.fieldModel.set("value",d),a&&a()},error:function(){a&&a()}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../edit_fields/boolean_field/boolean_field_view":213,"../../../edit_fields/date_field/date_field_view":214,"../../../edit_fields/number_field/number_field_view":220,"../../../edit_fields/string_field/string_field_view":221}],122:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./form_field/form_field_view"),f=a("./add_column/add_column_view"),g=a("../../edit_fields/edit_field_model"),h=a("./form_collection"),i="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;b.exports=d.core.View.extend({events:{"click .js-submit":"_onSubmit",submit:"_onSubmit"},initialize:function(){this.model=new d.core.Model({state:"idle"}),this.table=this.options.table,this.row=this.options.row,this.collection=new h,this._generateCollection()},render:function(){return this.clearSubViews(),this._newColumn(),this.collection.each(this._renderField,this),this},_generateCollection:function(){var a=this,b=this.table.get("schema"),c=this.table.hiddenColumns;i.each(b,function(b){if(!i.contains(c,b[0])){var d=a._generateModel(b[0],b[1],a.row.get(b[0]));a.collection.add(d)}})},_generateModel:function(a,b,c){return new g({attribute:a,value:c,type:b})},_renderField:function(a){var b=new e({fieldModel:a,table:this.table,row:this.row});this.$(".js-addField").before(b.render().el),b.bind("onSubmit",this._onSubmit,this),this.addView(b)},_newColumn:function(){var a=new f({table:this.table});a.bind("newColumn",function(a){var b=this._generateModel(a.get("_name"),a.get("type"),null);this.collection.add(b),this._renderField(b)},this),this.addView(a),this.$el.append(a.render().el)},_onSubmit:function(a){this.killEvent(a);var b=this.collection.getInvalid();if(b)this.trigger("onError",b,this);else{var c=this.collection.toJSON();this.trigger("onSubmit",c,this)}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../edit_fields/edit_field_model":218,"./add_column/add_column_view":118,"./form_collection":120,"./form_field/form_field_view":121}],123:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f=a("./steps_view"),g=a("./row_model"),h=a("./default_footer_view"),i=a("../../view_factory");b.exports=d.core.Model.extend({TAB_LABEL:"Admin. Regions",KIND:"admin1",defaults:{step:0,columns:[]},initialize:function(a){if(!a.geocodeStuff)throw new Error("geocodeStuff is required");if(!a.columnsNames)throw new Error("columnsNames is required");if(!a.columns)throw new Error("columns is required")},createView:function(){return this._initRows(),this._setStateForFirstStep(),i.createByList([new f({title:"Select the column that has Administrative Regions",desc:"Georeference your data by country, state, province or municipality",model:this}),new h({model:this})])},assertIfCanContinue:function(){var a=0===this.get("step")?this._columnNameValue():this.get("geometryType");this.set("canContinue",!!a)},continue:function(){0===this.get("step")?this._setStateForSecondStep():this._geocode()},goBack:function(){this._setStateForFirstStep()},availableGeometriesFetchData:function(){return this.get("geocodeStuff").availableGeometriesFetchData(this.KIND,this._locationValue(),this._isLocationFreeText())},_setStateForFirstStep:function(){this.set({step:0,canGoBack:!1,canContinue:!1,hideFooter:!1}),this.get("rows").invoke("unset","value")},_setStateForSecondStep:function(){this.set({step:1,canGoBack:!0,canContinue:!1,hideFooter:!0,geometryType:""})},_initRows:function(){var a=new e.Collection([new g({comboViewClass:"Combo",label:"Select Your Region Name",placeholder:"Select column",data:this.get("columnsNames")}),new g({label:"Select Your Country Data",data:this.get("columns")})]);this.set("rows",a)},_geocode:function(){var a=this.get("geocodeStuff"),b=this._locationValue(),c=this._isLocationFreeText(),d=a.geocodingChosenData({type:"admin",kind:a.isLocationWorld(b,c,!0)?"admin0":this.KIND,location:b,column_name:this._columnNameValue(),geometry_type:this.get("geometryType")},c,!0);this.set("geocodeData",d)},_columnNameValue:function(){return this.get("rows").first().get("value")},_locationValue:function(){return this._location().get("value")},_isLocationFreeText:function(){return this._location().get("isFreeText")},_location:function(){return this.get("rows").last()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"./default_footer_view":126,"./row_model":134,"./steps_view":137}],124:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,"undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null),e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("./geometry_item_view"),g=a("../../view_factory"),h=a("../../view_helpers/random_quote");b.exports=e.core.View.extend({initialize:function(){this.availableGeometries=new e.admin.Geocodings.AvailableGeometries,this._initBinds(),this._fetchAvailableGeometries()},render:function(){return this.clearSubViews(),this.$el.html(this.getTemplate("common/dialogs/georeference/choose_geometry")()),d.each(this.availableGeometries.get("available_geometries")?this._createItemsViews():[this._createLoadingView()],this._appendView,this),this},_appendView:function(a){this.addView(a),this.$(".js-items").append(a.render().el)},_createItemsViews:function(){return[this._createItemView({type:"point",titles:{available:"Georeference your data with points",unavailable:"No point data available for your selection"}}),this._createItemView({type:"polygon",titles:{available:"Georeference your data with administrative regions",unavailable:"No polygon data available for your selection.",learnMore:"Sorry, we don't have polygons available for the datatype you are trying to geocode. For example, if you are geocoding placenames we can only give you points for where those places exist."}})]},_createItemView:function(a){return new f(d.extend({model:this.model,availableGeometries:this.availableGeometries},a))},_createLoadingView:function(){return g.createByTemplate("common/templates/loading",{title:"Checking for available geometries…",quote:h()})},_initBinds:function(){this.availableGeometries.bind("change:available_geometries",this.render,this),this.add_related_model(this.availableGeometries)},_fetchAvailableGeometries:function(){this.availableGeometries.fetch({data:this.model.availableGeometriesFetchData()})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"../../view_helpers/random_quote":241,"./geometry_item_view":128}],125:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,g=a("./steps_view"),h=a("./row_model"),i=a("./default_footer_view"),j=a("../../view_factory");b.exports=e.core.Model.extend({TAB_LABEL:"City Names",KIND:"namedplace",defaults:{step:0,columns:[]},initialize:function(a){if(!a.geocodeStuff)throw new Error("geocodeStuff is required");if(!a.columnsNames)throw new Error("columnsNames is required");if(!a.columns)throw new Error("columns is required")},createView:function(){return this._initRows(),this._setStateForFirstStep(),j.createByList([new g({title:"Select the column that contains the City's Name",desc:"No matter the type of the columns you select, we will transform them to number for georeferencing.",model:this}),new i({model:this})])},assertIfCanContinue:function(){var a=0===this.get("step")?this._columnNameValue():this.get("geometryType");this.set("canContinue",!!a)},continue:function(){0===this.get("step")?this._setStateForSecondStep():this._geocode()},goBack:function(){this._setStateForFirstStep()},availableGeometriesFetchData:function(){return this.get("geocodeStuff").availableGeometriesFetchData(this.KIND,this._locationValue(),this._isLocationFreeText())},_setStateForFirstStep:function(){this.set({step:0,canGoBack:!1,canContinue:!1,hideFooter:!1})},_setStateForSecondStep:function(){this.set({step:1,canGoBack:!0,canContinue:!1,hideFooter:!0,geometryType:""})},_geocode:function(){var a=this.get("geocodeStuff").geocodingChosenData({type:"city",kind:this.KIND,location:this._locationValue(),column_name:this._columnNameValue(),geometry_type:this.get("geometryType")},this._isLocationFreeText(),!0),b=this._regionValue();d.isEmpty(b)||(a.region=b,a.region_text=this._isRegionFreeText()),this.set("geocodeData",a)},_initRows:function(){var a=new f.Collection([new h({comboViewClass:"Combo",label:"In which column are your city names stored?",placeholder:"Select column",data:this.get("columnsNames")}),new h({label:"Admin. Region where city's located, if known",data:this.get("columns")}),new h({label:"Country where city's located, if known",data:this.get("columns")})]);this.set("rows",a)},_columnNameValue:function(){return this.get("rows").first().get("value")},_regionValue:function(){return this._region().get("value")},_isRegionFreeText:function(){return this._region().get("isFreeText")},_region:function(){return this.get("rows").at(1)},_locationValue:function(){return this._location().get("value")},_isLocationFreeText:function(){return this._location().get("isFreeText")},_location:function(){return this.get("rows").last()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"./default_footer_view":126,"./row_model":134,"./steps_view":137}],126:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({events:{"click .js-force-all-rows":"_onClickForceAllRows"},initialize:function(){this._initBinds()},render:function(){return this.$el.html(this.getTemplate("common/dialogs/georeference/default_footer")()),this},_initBinds:function(){this.model.bind("change:canContinue",this._onChangeCanContinue,this),this.model.bind("change:hideFooter",this._onChangeHideFooter,this);var a=this._geocodeStuff();a.bind("change:forceAllRows",this._onChangeForceAllRows,this),this.add_related_model(a)},_onChangeCanContinue:function(a,b){this.$(".ok").toggleClass("is-disabled",!b)},_onChangeHideFooter:function(a,b){this.$el.toggle(!b)},_onChangeForceAllRows:function(a,b){this.$(".js-force-all-rows button").toggleClass("is-checked",!!b)},_onClickForceAllRows:function(a){this.killEvent(a);var b=this._geocodeStuff();b.set("forceAllRows",!b.get("forceAllRows"))},_geocodeStuff:function(){return this.model.get("geocodeStuff")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],127:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.core.Model.extend({defaults:{tableName:void 0,forceAllRows:!1},initialie:function(a){if(!a.tableName)throw new Error("tableName is required")},availableGeometriesFetchData:function(a,b,d){if(!a)throw new Error("kind is required");var e={kind:a};return c.isEmpty(b)?e.free_text="World":d?e.free_text=b:(e.column_name=b,e.table_name=this.get("tableName")),e},isLocationWorld:function(a,b,c){var d=void 0===a&&c,e=""===a||d;return e||!!b&&a.search("world")!==-1},geocodingChosenData:function(a,b,d){return a.table_name=this.get("tableName"),this.isLocationWorld(a.location,b,d)?(a.location="world",a.text=!0):c.isBoolean(b)&&b&&(a.text=!0),this.get("forceAllRows")&&(a.force_all_rows=!0),a}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],128:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.core.View.extend({className:"OptionCard OptionCard--blocky",events:{click:"_onClick"},initialize:function(){this.options.type||d.log.error("type is required"),this.options.titles||d.log.error("titles is required"),this.options.titles.available||d.log.error("titles.available is required"),this.options.titles.unavailable||d.log.error("titles.unavailable is required"),this.availableGeometries=this.options.availableGeometries,this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this.getTemplate("common/dialogs/georeference/geometry_item_"+this.options.type)({})),this._onChangeAvailableGeometries(),this},_initBinds:function(){this.availableGeometries.bind("change:available_geometries",this._onChangeAvailableGeometries,this),this.add_related_model(this.availableGeometries),this.model.bind("change:geometryType",this._onChangeGeometryType,this)},_onChangeGeometryType:function(a,b){this.$el.toggleClass("is-selected",b===this.options.type)},_onChangeAvailableGeometries:function(){var a=this._isAvailable();this.$el.toggleClass("OptionCard--static",!a),this.$(".js-icon").toggleClass("u-disabled",!a),this.$(".js-warning").toggle(!a),this.$(".js-title").toggleClass("u-disabled",!a).text(this.options.titles[a?"available":"unavailable"])},_onClick:function(a){this.killEvent(a),this._isAvailable()&&(this.model.set("geometryType",this.options.type),this.model.continue())},_isAvailable:function(){return c.contains(this.availableGeometries.get("available_geometries"),this.options.type)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],129:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,g=a("./lon_lat_columns_model"),h=a("./city_names_model"),i=a("./admin_regions_model"),j=a("./postal_codes_model"),k=a("./ip_addresses_model"),l=a("./street_addresses/street_addresses_model"),m=a("./geocode_stuff_model"),n=a("./user_geocoding_model");b.exports=f.core.Model.extend({_EXCLUDED_COLUMN_NAMES:["cartodb_id","the_geom","updated_at","created_at","cartodb_georef_status"],_ALLOWED_COLUMN_TYPES:["string","number","boolean","date"],defaults:{options:void 0},initialize:function(a){if(!a.table)throw new Error("table is required");if(!a.user)throw new Error("user is required");this._initGeocodeStuff(),this._initOptions()},changedSelectedTab:function(a){this.get("options").chain().without(a).each(this._deselect)},createView:function(){return this._selectedTabModel().createView()},canContinue:function(){return this._selectedTabModel().get("canContinue")},continue:function(){this.canContinue()&&this._selectedTabModel().continue()},canGoBack:function(){return this._selectedTabModel().get("canGoBack")},goBack:function(){this.canGoBack()&&this._selectedTabModel().goBack()},_selectedTabModel:function(){return this.get("options").find(this._isSelected)},_columnsNames:function(){return e.chain(this.get("table").get("schema")).filter(this._isAllowedColumnName,this).map(this._columnName).value()},_filteredColumns:function(){var a=this.get("table");return e.chain(a.get("original_schema")||a.get("schema")).filter(this._isAllowedColumnName,this).filter(this._isAllowedColumnType,this).map(this._inverColumnRawValues).value()},_inverColumnRawValues:function(a){var b=a[1],c=a[0];return[b,c]},_isAllowedColumnName:function(a){return!e.contains(this._EXCLUDED_COLUMN_NAMES,this._columnName(a))},_isAllowedColumnType:function(a){return e.contains(this._ALLOWED_COLUMN_TYPES,this._columnType(a))},_columnName:function(a){return a[0]},_columnType:function(a){return a[1]},_isSelected:function(a){return a.get("selected")},_deselect:function(a){a.set("selected",!1)},_initGeocodeStuff:function(){var a=new m({tableName:this.get("table").get("id")});this.set("geocodeStuff",a)},_initOptions:function(){var a=this.get("geocodeStuff"),b=this._columnsNames(),c=this._filteredColumns();this.set("options",new d.Collection([new g({geocodeStuff:a,columnsNames:b,selected:!0}),new h({geocodeStuff:a,columnsNames:b,columns:c}),new i({geocodeStuff:a,columnsNames:b,columns:c}),new j({geocodeStuff:a,columnsNames:b,columns:c}),new k({geocodeStuff:a,columnsNames:b,columns:c}),new l({geocodeStuff:a,columns:c,isGoogleMapsUser:this._isGmeGeocoderEnabled(),userGeocoding:this._userGeocoding(),lastBillingDate:this.get("user").get("billing_period"),estimation:new f.admin.Geocodings.Estimation({id:this.get("table").getUnquotedName()})})])),this.get("user").featureEnabled("georef_disabled")?this._disableGeorefTabs():this._maybeDisabledStreetAddresses()},_disableGeorefTabs:function(){e.each(this._georefTabs(),this._disableTab.bind(this,"You don't have this option available in this version"))},_georefTabs:function(){return this.get("options").rest()},_maybeDisabledStreetAddresses:function(){var a=this._isGmeGeocoderEnabled();this._isGoogleMapsEnabled()?a||this._disableTab("Google Maps geocoder is not configured. Please contact us at sales@carto.com",this._streetAddrTabModel()):a?this._disableTab("Geocoder is not configured properly. Please contact us at sales@carto.com",this._streetAddrTabModel()):this._userGeocoding().hasQuota()||this._disableTab("Your geocoding quota is not defined. Please contact us at sales@carto.com",this._streetAddrTabModel())},_userGeocoding:function(){return new n(this.get("user").get("geocoding"))},_isGoogleMapsEnabled:function(){return this._hasUserActionEnabled("google_maps_enabled")},_isGmeGeocoderEnabled:function(){return this._hasUserActionEnabled("google_maps_geocoder_enabled")},_hasUserActionEnabled:function(a){return!!this.get("user").get("actions")[a]},_streetAddrTabModel:function(){return this.get("options").find(function(a){return a instanceof l})},_disableTab:function(a,b){b.set("disabled",a)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./admin_regions_model":123,"./city_names_model":125,"./geocode_stuff_model":127,"./ip_addresses_model":131,"./lon_lat_columns_model":132,"./postal_codes_model":133,"./street_addresses/street_addresses_model":140,"./user_geocoding_model":145}],130:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,g=a("../../views/base_dialog/view.js"),h=a("./georeference_model"),i=a("./tab_item_view");b.exports=g.extend({events:g.extendEvents({"click .js-back:not(.is-disabled)":"_onGoBack"}),initialize:function(){if(!this.options.user)throw new Error("user is required");this.options.clean_on_hide=!0,this.options.enter_to_confirm=!0,this.elder("initialize"),this.model=new h({table:this.options.table,user:this.options.user}),this._initViews(),this._initBinds()},render:function(){return g.prototype.render.apply(this,arguments),this.$(".content").addClass("Dialog-contentWrapper"),this},render_content:function(){var a=this.model.get("table"),b=d(this.getTemplate("common/dialogs/georeference/georeference")({hasNoGeoferencedData:!a.isGeoreferenced()&&a.data().length>0}));return this._renderTabs(b.find(".js-tabs")),this._renderTabContent(b),b},ok:function(){this.model.continue()},_initViews:function(){this._tabViews=this.model.get("options").map(this._createDefaultTabView,this)},_createDefaultTabView:function(a){var b=new i({model:a});return this.addView(b),b},_renderTabs:function(a){a.append.apply(a,e.map(this._tabViews,this._getRenderedElement))},_getRenderedElement:function(a){return a.render().el},_renderTabContent:function(a){this._tabContentView&&this._tabContentView.clean(),this._tabContentView=this.model.createView(),this.addView(this._tabContentView),a.find(".js-tab-content").html(this._tabContentView.render().el)},_initBinds:function(){var a=this.model.get("options");a.bind("change:selected",this._onChangeSelectedTab,this),a.bind("change:canGoBack",this._onChangeCanGoBack,this),a.bind("change:geocodeData",this._onChangeGeocodeData,this),this.add_related_model(a)},_onChangeSelectedTab:function(a,b){b&&(this.model.changedSelectedTab(a),this._renderTabContent(this.$el))},_onChangeCanGoBack:function(a,b){this.$(".js-back").toggle(!!b)},_onGoBack:function(){this.model.goBack()},_onChangeGeocodeData:function(a,b){f.god.trigger("geocodingChosen",b),this.close()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../views/base_dialog/view.js":242,"./georeference_model":129,"./tab_item_view":144}],131:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f=a("./row_model"),g=a("./rows_view"),h=a("./default_footer_view"),i=a("../../view_factory");b.exports=d.core.Model.extend({TAB_LABEL:"IP Addresses",initialize:function(a){if(!a.geocodeStuff)throw new Error("geocodeStuff is required");if(!a.columnsNames)throw new Error("columnsNames is required")},createView:function(){return this._initRows(),this.set({canContinue:!1,hideFooter:!1}),i.createByList([i.createByTemplate("common/dialogs/georeference/default_content_header",{title:"Select the column that that contains the IP's name",desc:"Convert IP address into geographical locations."}),new g({model:this}),new h({model:this})])},assertIfCanContinue:function(){this.set("canContinue",!!this._columnNameValue())},continue:function(){var a=this.get("geocodeStuff").geocodingChosenData({type:"ip",kind:"ipaddress",column_name:this._columnNameValue(),geometry_type:"point"});this.set("geocodeData",a)},_initRows:function(){var a=new e.Collection([new f({comboViewClass:"Combo",label:"In which column are your IP addresses stored?",placeholder:"Select column",data:this.get("columnsNames")})]);this.set("rows",a)},_columnNameValue:function(){return this.get("rows").first().get("value")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"./default_footer_view":126,"./row_model":134,"./rows_view":136}],132:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f=a("./row_model"),g=a("./rows_view"),h=a("./default_footer_view"),i=a("../../view_factory");b.exports=d.core.Model.extend({TAB_LABEL:"Lon/Lat Columns",defaults:{columnsNames:[]},initialize:function(a){if(!a.geocodeStuff)throw new Error("geocodeStuff is required");if(!a.columnsNames)throw new Error("columnsNames is required")},createView:function(){return this.set({canContinue:!1,hideFooter:!1}),this._initRows(),i.createByList([i.createByTemplate("common/dialogs/georeference/default_content_header",{title:"Select the columns containing your Lon/Lat columns",desc:"The selected columns are transformed into georeference coordinates."}),new g({model:this}),new h({model:this})])},assertIfCanContinue:function(){var a=this.get("rows").all(function(a){return!!a.get("value")});this.set("canContinue",a)},continue:function(){var a=this.get("geocodeStuff").geocodingChosenData({type:"lonlat",longitude:this.get("rows").first().get("value"),latitude:this.get("rows").last().get("value")});this.set("geocodeData",a)},_initRows:function(){var a=new e.Collection([new f({comboViewClass:"Combo",label:"Select your Longitude",placeholder:"Select column",property:"longitude",data:this.get("columnsNames")}),new f({comboViewClass:"Combo",label:"Select your Latitude",placeholder:"Select column",property:"latitude",data:this.get("columnsNames")})]);this.set("rows",a)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"./default_footer_view":126,"./row_model":134,"./rows_view":136}],133:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f=a("./row_model"),g=a("./steps_view"),h=a("./default_footer_view"),i=a("../../view_factory");b.exports=d.core.Model.extend({TAB_LABEL:"Postal Codes",KIND:"postalcode",defaults:{step:0,columns:[]},initialize:function(a){if(!a.geocodeStuff)throw new Error("geocodeStuff is required");if(!a.columnsNames)throw new Error("columnsNames is required");if(!a.columns)throw new Error("columns is required")},createView:function(){return this._initRows(),this._setStateForFirstStep(),i.createByList([new g({title:"Select the column that has the Postal Codes",desc:"Georeference your data by postal codes.",model:this}),new h({model:this})])},assertIfCanContinue:function(){var a=0===this.get("step")?this._columnNameValue():this.get("geometryType");this.set("canContinue",!!a)},continue:function(){0===this.get("step")?this._setStateForSecondStep():this._geocode()},goBack:function(){this._setStateForFirstStep()},availableGeometriesFetchData:function(){return this.get("geocodeStuff").availableGeometriesFetchData(this.KIND,this._locationValue(),this._isLocationFreeText())},_setStateForFirstStep:function(){this.set({step:0,canGoBack:!1,canContinue:!1,hideFooter:!1})},_setStateForSecondStep:function(){this.set({step:1,canGoBack:!0,canContinue:!1,hideFooter:!0,geometryType:""})},_geocode:function(){var a=this.get("geocodeStuff").geocodingChosenData({type:"postal",kind:this.KIND,location:this._locationValue(),column_name:this._columnNameValue(),geometry_type:this.get("geometryType")},this._isLocationFreeText(),!0);this.set("geocodeData",a)},_initRows:function(){var a=new e.Collection([new f({comboViewClass:"Combo",label:"In which column are your postal codes stored?",placeholder:"Select column",data:this.get("columnsNames")}),new f({label:"Country where postal codes are located, if known",data:this.get("columns")})]);this.set("rows",a)},_columnNameValue:function(){return this.get("rows").first().get("value")},_locationValue:function(){return this._location().get("value")},_isLocationFreeText:function(){return this._location().get("isFreeText")},_location:function(){return this.get("rows").last()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"./default_footer_view":126,"./row_model":134,"./steps_view":137}],134:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./row_view");b.exports=d.core.Model.extend({defaults:{comboViewClass:"CustomTextCombo",label:"",placeholder:"Select column or type it",isFreeText:!1,data:[]},createView:function(){return new e({model:this})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./row_view":135}],135:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"Form-row Form-row--step",initialize:function(){this._initViews(),this._initBinds()},render:function(){return this.$el.html(this.getTemplate("common/dialogs/georeference/row")({label:this.model.get("label")})),this.$(".js-select").append(this._selectView.render().el),this},_initBinds:function(){this.model.bind("change:value",this._onChangeValue,this)},_initViews:function(){this._selectView=new(c.forms[this.model.get("comboViewClass")])({model:this.model,placeholder:this.model.get("placeholder"),disabled:this.model.get("disabled"),extra:this.model.get("data"),className:"Select",width:"100%",property:"value",text:"isFreeText"}),this.addView(this._selectView),this._selectView.render()._changeSelection()},_onChangeValue:function(a,b){this.$el.toggleClass("is-done",!!b)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],136:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({initialize:function(){this._initBinds()},render:function(){return this.clearSubViews(),this._renderRows(),this},_initBinds:function(){var a=this.model.get("rows");a.bind("change",this.model.assertIfCanContinue,this.model),this.add_related_model(a)},_renderRows:function(){this.model.get("rows").chain().map(this._createRowView,this).map(this._appendRowToDOM,this)},_createRowView:function(a){var b=a.createView();return this.addView(b),b},_appendRowToDOM:function(a){this.$el.append(a.render().el)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],137:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./rows_view"),f=a("./choose_geometry_view"),g=a("../../view_factory");b.exports=d.core.View.extend({initialize:function(){this._initBinds()},render:function(){return this.clearSubViews(),1===this.model.get("step")?this._renderChooseGeometry():(this._renderHeader(),
this._renderRows()),this},_renderHeader:function(){this._appendView(g.createByTemplate("common/dialogs/georeference/default_content_header",{title:this.options.title,desc:this.options.desc}))},_renderRows:function(){this._appendView(new e({model:this.model}))},_renderChooseGeometry:function(){this._appendView(new f({model:this.model}))},_appendView:function(a){this.addView(a),this.$el.append(a.render().$el)},_initBinds:function(){this.model.bind("change:step",this.render,this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"./choose_geometry_view":124,"./rows_view":136}],138:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.core.View.extend({className:"Georeference-estimation",initialize:function(){if(!c.isBoolean(this.options.hasHardLimit))throw new Error("hasHardLimit is required");if(!this.options.userGeocoding)throw new Error("userGeocoding is required");this._initBinds()},render:function(){var a=this.model.get("estimation"),b=this.model.get("rows");return this.$el.html(this.getTemplate("common/dialogs/georeference/street_addresses/estimation")({hasEstimation:void 0!==a&&void 0!==b,hasHardLimit:this.options.hasHardLimit,costInCredits:this.model.costInCredits(),costInDollars:this.model.costInDollars(),blockPriceInDollars:this.options.userGeocoding.blockPriceInDollars(),hasRows:0!==b})),this},_initBinds:function(){this.model.bind("change error",this.render,this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],139:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"Georeference-quota",render:function(){return this.$el.html(this.getTemplate("common/dialogs/georeference/street_addresses/quota")({quotaLeft:this.model.quotaLeftThisMonth(),quotaUsedInPct:this.model.quotaUsedThisMonthInPct()})),this}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],140:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null,g="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,h=a("./street_addresses_view"),i=a("../row_model"),j=a("./street_row_model");b.exports=g.core.Model.extend({TAB_LABEL:"Street Addresses",MAX_STREET_ROWS:3,defaults:{columnsNames:[],columns:[],estimation:void 0},initialize:function(a){if(!a.geocodeStuff)throw new Error("geocodeStuff is required");if(!d.isBoolean(a.isGoogleMapsUser))throw new Error("isGoogleMapsUser is required");if(!a.userGeocoding)throw new Error("userGeocoding is required");if(!a.columns)throw new Error("columns is required");if(!a.estimation)throw new Error("estimation is required")},createView:function(){return this.set({canContinue:!1,hideFooter:!1,mustAgreeToTOS:!1,confirmTOS:!1,hasAgreedToTOS:!1}),this._initRows(),new h({model:this})},isDisabled:function(){return!this.get("isGoogleMapsUser")&&this.get("userGeocoding").hasReachedMonthlyQuota()},showCostsInfo:function(){return!this.get("isGoogleMapsUser")},getFormatterItemByRow:function(a){var b=a.get("value");if(b)return a.get("isFreeText")?b.trim():"{"+b+"}"},assertIfCanAddMoreRows:function(){var a=this.get("rows").filter(this._isStreetRow);d.invoke(a,"set","canAddRow",!1),d.last(a).set("canAddRow",a.length<this.MAX_STREET_ROWS)},daysLeftToNextBilling:function(){var a=f().startOf("day");return f(this.get("lastBillingDate")).add(30,"days").diff(a,"days")},continue:function(){var a=this.get("mustAgreeToTOS");if(this._hasAgreedToTOS()||!a){var b=this.get("geocodeStuff").geocodingChosenData({type:"address",kind:"high-resolution",formatter:this.get("formatter")});this.set("geocodeData",b)}else a&&this.set("confirmTOS",!0)},hasHardLimit:function(){return!!this.get("userGeocoding").get("hard_limit")},_hasAgreedToTOS:function(){return this.get("mustAgreeToTOS")&&this.get("hasAgreedToTOS")},_isStreetRow:function(a){return a instanceof j},_initRows:function(){var a=this.get("columns"),b=this.isDisabled(),c=new e.Collection([new j({label:"Which column are your street addresses stored in?",data:a,canAddRow:!0,disabled:b}),new i({label:"State/province where address is located, if known",data:a,disabled:b}),new i({label:"Country where street address is located, if known",data:a,disabled:b})]);this.set("rows",c)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../row_model":134,"./street_addresses_view":141,"./street_row_model":142}],141:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("../../../view_factory"),g=a("./estimation_view"),h=a("./quota_view"),i=a("../default_footer_view"),j=a("../../../view_helpers/pluralize_string");b.exports=d.core.View.extend({initialize:function(){this._initBinds(),this._fetchEstimation()},render:function(){this.clearSubViews(),this.$el.html(this.getTemplate("common/dialogs/georeference/street_addresses/street_addresses")({})),this._renderHeader(),this._renderRows();var a=this.model.showCostsInfo();return a&&(this._renderEstimation(),this._renderQuota()),this.$(".js-costs-info").toggle(!!a),this._renderFooter(),this},_renderHeader:function(){var a=f.createByTemplate("common/dialogs/georeference/default_content_header",{title:"Select the column(s) that has your street address",desc:"Use this option if you need high resolution geocoding of your street adresses data."});this.addView(a),this.$el.prepend(a.render().$el)},_renderRows:function(){this._$rows().toggleClass("u-disabled",!!this.model.isDisabled()),this.model.get("rows").chain().map(this._createRowView,this).map(this._appendRowToDOM,this)},_renderEstimation:function(){var a=new g({model:this.model.get("estimation"),userGeocoding:this.model.get("userGeocoding"),hasHardLimit:this.model.hasHardLimit()});this.addView(a),this.$(".js-estimation").append(a.render().el)},_renderQuota:function(){var a=new h({model:this.model.get("userGeocoding")});this.addView(a),this.$(".js-quota").append(a.render().el)},_renderFooter:function(){var a;if(this.model.isDisabled())a=this.getTemplate("common/dialogs/georeference/street_addresses/upgrade_footer")({cartodb_com_hosted:d.config.get("cartodb_com_hosted"),upgradeURL:d.config.get("upgrade_url"),pluralizeString:j,daysLeftToNextBilling:this.model.daysLeftToNextBilling()});else{var b=new i({model:this.model});this.addView(b),a=b.render().$el}this.$el.append(a)},_createRowView:function(a){var b=a.createView();return this.addView(b),b},_appendRowToDOM:function(a){this._$rows().append(a.render().el)},_$rows:function(){return this.$(".js-rows")},_initBinds:function(){var a=this.model.get("rows");a.bind("change",this._onChangeRows,this),a.bind("add",this._onAddRow,this),this.add_related_model(a);var b=this.model.get("estimation");b.bind("change",this._onChangeEstimation,this),b.bind("error",this._onEstimationError,this),this.add_related_model(b);var c=this.model.get("geocodeStuff");c.bind("change:forceAllRows",this._onChangeForceAllRows,this),this.add_related_model(c),this.model.bind("change:confirmTOS",this._onChangeConfirmTOS,this),this.model.bind("change:isGoogleMapsUser",this.render,this)},_onChangeForceAllRows:function(){this.model.get("estimation").reset(),this._fetchEstimation()},_fetchEstimation:function(){this.model.showCostsInfo()&&this.model.get("estimation").fetch({data:{force_all_rows:this.model.get("geocodeStuff").get("forceAllRows")}})},_onChangeRows:function(){var a=this.model.get("rows").chain().map(this.model.getFormatterItemByRow).compact().value().join(", ");this.model.set({formatter:a,canContinue:!e.isEmpty(a)})},_onAddRow:function(a,b,c){var d=this._createRowView(a);this.$(".js-rows").children().eq(c.index).before(d.render().el),this.model.assertIfCanAddMoreRows()},_onChangeEstimation:function(){var a=this.model.get("estimation").mayHaveCost()&&!this.model.hasHardLimit();this.model.set("mustAgreeToTOS",a)},_onEstimationError:function(){this.model.get("estimation").set({estimation:-1,rows:-1})},_onChangeConfirmTOS:function(a,b){if(b){this.model.set("confirmTOS",!1,{silent:!0});var c=f.createDialogByTemplate("common/dialogs/georeference/street_addresses/confirm_tos",{costInDollars:this.model.get("estimation").costInDollars()},{triggerDialogEvents:!1,enter_to_confirm:!0,clean_on_hide:!1});c.ok=this._onAgreeToTOS.bind(this),this.addView(c),c.appendToBody()}},_onAgreeToTOS:function(){this.model.set("hasAgreedToTOS",!0),this.model.continue()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_factory":237,"../../../view_helpers/pluralize_string":240,"../default_footer_view":126,"./estimation_view":138,"./quota_view":139}],142:[function(a,b,c){var d=a("../row_model"),e=a("./street_row_view");b.exports=d.extend({createView:function(){return new e({model:this})},addRow:function(){var a=new this.constructor({label:"Additional information to complete street address",data:this.get("data")});this.collection.add(a,{at:this._indexAfterThisModel()})},_indexAfterThisModel:function(){return this.collection.indexOf(this)+1}})},{"../row_model":134,"./street_row_view":143}],143:[function(a,b,c){var d=a("../row_view");b.exports=d.extend({events:d.extendEvents({"click .js-add-row":"_onClickAddRow"}),initialize:function(){d.prototype.initialize.apply(this,arguments),this._initStreetRowBinds()},render:function(){return d.prototype.render.call(this),this.model.get("disabled")||this.$el.append(this.getTemplate("common/dialogs/georeference/street_addresses/row_add_row")()),this},_initStreetRowBinds:function(){this.model.bind("change:canAddRow",this._onChangeCanAddRow,this)},_onClickAddRow:function(a){this.killEvent(a),this.model.addRow()},_onChangeCanAddRow:function(a,b){this.$(".js-add-row").toggle(!!b)}})},{"../row_view":135}],144:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.core.View.extend({tagName:"li",className:"Filters-typeItem Filters-typeItem--moreMargins",events:{"click .js-btn":"_onClick"},initialize:function(){this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this.getTemplate("common/dialogs/georeference/tab_item")({label:this.model.TAB_LABEL,isDisabled:this.model.get("disabled")})),this._onChangeSelected(this.model,this.model.get("selected")),this._onChangeDisabled(this.model,this.model.get("disabled")),this._createDisabledTooltip(),this},_initBinds:function(){this.model.bind("change:selected",this._onChangeSelected,this),this.model.bind("change:disabled",this._onChangeDisabled,this)},_onChangeSelected:function(a,b){this.$("button").toggleClass("is-selected",!!b)},_onChangeDisabled:function(a,b){b?this.undelegateEvents():this.delegateEvents()},_createDisabledTooltip:function(){var a=this.model.get("disabled");c.isEmpty(a)||this.addView(new d.common.TipsyTooltip({el:this.$(".js-btn"),fallback:a,gravity:"s",offset:-30}))},_onClick:function(a){this.killEvent(a),this.model.set("selected",!0)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],145:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({defaults:{quota:null,block_price:null,monthly_use:0,hard_limit:!1},hasQuota:function(){var a=this.get("quota");return null!==a&&void 0!==a&&""!==a},hasReachedMonthlyQuota:function(){return this.get("hard_limit")&&this._maybe(function(a,b){return b>=a},!1)},quotaLeftThisMonth:function(){return this._maybe(function(a,b){return Math.max(a-b,0)},0)},quotaUsedThisMonthInPct:function(){return this._maybe(function(a,b){return 100*b/a},0)},blockPriceInDollars:function(){return Math.ceil(this.get("block_price")/100)},_maybe:function(a,b){var c=this.get("monthly_use"),d=this.get("quota");return c>=0&&d>=0?a(d,c):b}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],146:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof a?a.cdb.Utils:null;b.exports=c.core.View.extend({events:{"click .js-toggler":"_onLumpSumClick"},initialize:function(){this.user=this.options.user,this.model=new c.core.Model({lumpSum:!1}),this.template=c.templates.getTemplate("common/dialogs/limits_reach/limits_reached_content"),this._initBinds()},render:function(){var a=c.config.get("upgrade_url")&&!c.config.get("cartodb_com_hosted")&&!this.user.isInsideOrg(),b=this.user.get("account_type"),e=_.compact(this.collection.map(function(a,c){var e=a.get("price"),f=a.get("title");return{name:f.toLowerCase(),price:d.formatNumber(e),isUserPlan:f.search(b)!==-1,lumpSumPrice:"0"==e?"0":d.formatNumber(a.get("lump_sum").price),quota:d.readablizeBytes(a.get("bytes_quota")).replace(/\.00/g,"").replace(" ",""),layers:a.get("max_layers"),privateMaps:a.get("private_tables"),removableBrand:a.get("removable_brand")}}));return this.$el.html(this.template({lumpSum:this.model.get("lumpSum"),itemHighlighted:this._getHighlighted(e,this.user.get("account_type")),canUpgrade:a,availablePlans:e,organizationAdmin:this.user.isOrgOwner(),organizationUser:this.user.isInsideOrg()&&!this.user.isOrgOwner(),customHosted:c.config.get("cartodb_com_hosted"),upgradeURL:c.config.get("upgrade_url"),canStartTrial:this.user.canStartTrial()})),this},_initBinds:function(){this.model.bind("change",this.render,this),this.collection.bind("reset",this.render,this),this.add_related_model(this.collection)},_getHighlighted:function(a,b){for(var c=0,d=0,e=a.length;d<e;d++)a[d].name.search(b)!==-1&&(c=d);return c<2?2:3},_onLumpSumClick:function(){this.model.set("lumpSum",!this.model.get("lumpSum"))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],147:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./user_plans_collection"),f=a("./limits_reached_content_view"),g=a("../../views/base_dialog/view"),h=a("../../view_helpers/random_quote"),i=a("../../view_factory");b.exports=g.extend({initialize:function(){this.user=this.options.user,this.userPlans=new e(null,{user:this.user}),this.elder("initialize"),this._initBinds()},render_content:function(){var a=d.config.get("upgrade_url")&&!d.config.get("cartodb_com_hosted")&&!this.user.isInsideOrg(),b=this.user.isInsideOrg()&&this.user.organization.get("owner").email||"",c=$(d.templates.getTemplate("common/dialogs/limits_reach/limits_reached")({canUpgrade:a,organizationAdminEmail:b,organizationAdmin:this.user.isOrgOwner(),organizationUser:this.user.isInsideOrg()&&!this.user.isOrgOwner(),layersCount:this.user.getMaxLayers(),customHosted:d.config.get("cartodb_com_hosted")}));return this._initViews(c),c},_initBinds:function(){this.userPlans.bind("error",function(){this._panes.active("error")},this),this.userPlans.bind("reset",function(){this._panes.active("content")},this),this.add_related_model(this.userPlans)},_initViews:function(a){this._panes=new d.ui.common.TabPane({el:a.find(".js-content")}),this.addView(this._panes),this._panes.addTab("loading",i.createByTemplate("common/templates/loading",{title:"Getting plans info…",quote:h()}).render()),this._panes.addTab("error",i.createByTemplate("common/templates/fail",{msg:"Sorry, something went wrong trying to get your available plans."}).render()),this._panes.addTab("content",new f({user:this.user,collection:this.userPlans}).render());var b=d.config.get("upgrade_url")&&!d.config.get("cartodb_com_hosted")&&!this.user.isInsideOrg();this._panes.active(b?"loading":"content"),b&&this.userPlans.fetch({error:function(){this.trigger("error")}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"../../view_helpers/random_quote":241,"../../views/base_dialog/view":242,"./limits_reached_content_view":146,"./user_plans_collection":149}],148:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;"undefined"!=typeof window?window.Backbone:"undefined"!=typeof a?a.Backbone:null;b.exports=c.core.Model.extend({defaults:{title:"",desc:"",price:0,tables_quota:"",bytes_quota:0,support:"",private_tables:!1,removable_brand:!1,max_layers:4}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],149:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f=a("./user_plan_model");b.exports=e.Collection.extend({model:f,url:function(){return"//"+d.config.get("account_host")+"/account/"+this.user.get("username")+".json"},initialize:function(a,b){if(!b.user)throw new Error("user model is needed");this.user=b.user},sync:function(a,b,c){var d=this,e=_.extend({type:"GET",dataType:"jsonp",url:d.url(),processData:!1},c);return $.ajax(e)},parse:function(a){return a.available_plans}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./user_plan_model":148}],150:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("../../create/footer/guessing_toggler_view"),g=a("../../create/footer/privacy_toggler_view");b.exports=e.core.View.extend({events:{"click .js-ok":"_finish"},initialize:function(){this.elder("initialize"),this.user=this.options.user,this.guessingModel=new e.core.Model({guessing:!0}),this.privacyModel=new e.core.Model({privacy:this.user.canCreatePrivateDatasets()?"PRIVATE":"PUBLIC"}),this._template=e.templates.getTemplate("common/dialogs/map/add_layer/footer"),this._initBinds()},render:function(){this.clearSubViews();var a=d(this._template({canFinish:this.model.canFinish(),listing:this.model.get("listing")}));return this.$el.html(a),this._initViews(),this},_initViews:function(){var a=new f({model:this.guessingModel,createModel:this.model});this.$(".js-footer-info").append(a.render().el),this.addView(a),this.privacyTogglerView=new g({model:this.privacyModel,user:this.user,createModel:this.model}),this.$(".js-footerActions").prepend(this.privacyTogglerView.render().el),this.addView(this.privacyTogglerView)},_initBinds:function(){this.model.upload.bind("change",this.render,this),this.model.selectedDatasets.bind("all",this._update,this),this.model.bind("change",this._update,this),this.add_related_model(this.model.upload),this.add_related_model(this.model.selectedDatasets)},_update:function(){var a=this.model.get("contentPane"),b=this.model.get("listing");"listing"===a&&"scratch"!==b?this.render().show():this.hide()},_finish:function(a){this.killEvent(a),this.model.canFinish()&&("import"===this.model.get("listing")&&(this.model.upload.set("privacy",this.privacyModel.get("privacy")),this.model.upload.setGuessing(this.guessingModel.get("guessing"))),this.model.finish())}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../create/footer/guessing_toggler_view":71,"../../create/footer/privacy_toggler_view":72}],151:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=("undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,a("../../background_polling/models/upload_model")),f=a("../../visualizations_fetch_model");b.exports=d.core.Model.extend({defaults:{type:"addLayer",contentPane:"listing",listing:"datasets",collectionFetched:!1,activeImportPane:"file"},initialize:function(a,b){this.user=b.user,this.vis=b.vis,this.map=b.map,this.upload=new e({create_vis:!1},{user:this.user}),this.selectedDatasets=new Backbone.Collection,this.collection=new d.admin.Visualizations,this.visFetchModel=new f({content_type:"datasets",library:this.showLibrary()}),this._initBinds(),this._maybePrefetchDatasets()},canSelect:function(a){return a.get("selected")||this.selectedDatasets.length<1},showLibrary:function(){return!1},showDatasets:function(){return!0},setActiveImportPane:function(a){this.set("activeImportPane",a)},canFinish:function(){return"import"===this.get("listing")?this.upload.isValidToUpload():"datasets"===this.get("listing")?this.selectedDatasets.length>0:void 0},finish:function(){if("import"===this.get("listing"))d.god.trigger("importByUploadData",this.upload.toJSON(),this);else if("datasets"===this.get("listing")){var a=this.selectedDatasets.at(0);if("remote"===a.get("type")){var b={create_vis:!1,type:"remote",value:a.get("name"),remote_visualization_id:a.get("id"),size:a.get("external_source")?a.get("external_source").size:void 0};d.god.trigger("importByUploadData",b,this)}else this._addNewLayer(a.tableMetadata().get("name"))}},getImportState:function(){return this.get("activeImportPane")},showGuessingToggler:function(){return"import"===this.get("listing")},showPrivacyToggler:function(){return"import"===this.get("listing")},createFromScratch:function(){this.set("contentPane","creatingFromScratch");var a=this,b=new d.admin.CartoDBTableMetadata;b.save({},{success:function(){a._addNewLayer(b.get("name"))},error:function(){this.set("contentPane","addLayerFailed")}})},_initBinds:function(){this.upload.bind("change",function(){this.trigger("change:upload",this)},this),this.visFetchModel.bind("change",this._fetchCollection,this),this.bind("change:listing",this._maybePrefetchDatasets),this.collection.bind("change:selected",function(a,b){this.selectedDatasets[b?"add":"remove"](a)},this),this.collection.bind("reset",function(){this.selectedDatasets.each(function(a){var b=this.collection.get(a.id);b&&b.set("selected",!0)},this)},this)},_maybePrefetchDatasets:function(){"datasets"!==this.get("listing")||this.get("collectionFetched")||this.visFetchModel.isSearching()||(this.set("collectionFetched",!0),this._fetchCollection())},_fetchCollection:function(){var a,b=this.visFetchModel.attributes;a=this.visFetchModel.isSearching()?"table,remote":b.library?"remote":"table",this.collection.options.set({locked:"",q:b.q,page:b.page||1,tags:b.tag,per_page:this.collection._TABLES_PER_PAGE,shared:b.shared,only_liked:b.liked,order:"updated_at",type:"",types:a,exclude_raster:!0}),this.collection.fetch()},_onCollectionChange:function(){this.selectedDatasets.reset(this.collection.where({selected:!0}))},_addNewLayer:function(a){this.set("contentPane","addingNewLayer");var b=this;this.map.addCartodbLayerFromTable(a,this.user.get("username"),{vis:this.vis,success:function(){b.map.layers.saveLayers(),b.trigger("addLayerDone")},error:function(){b.set("contentPane","addLayerFailed")}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../background_polling/models/upload_model":19,"../../visualizations_fetch_model":261}],152:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("../create/create_listing"),g=a("./add_layer/footer_view"),h=a("../../view_factory"),i=a("../../view_helpers/random_quote"),j=a("../create/listing/navigation_view");b.exports=e.extend({initialize:function(){if(this.elder("initialize"),!this.model)throw new TypeError("model is required");if(!this.options.user)throw new TypeError("user is required");this._template=d.templates.getTemplate("common/dialogs/map/add_layer_template"),this._initBinds()},render:function(){return this.clearSubViews(),e.prototype.render.call(this),this.$(".content").addClass("Dialog-content--expanded"),this._initViews(),this.$(".js-footer").append(this._footerView.render().el),this},render_content:function(){return this._template({})},_initBinds:function(){this.model.bind("addLayerDone",this.close,this),this.model.bind("change:contentPane",this._onChangeContentView,this),d.god.bind("importByUploadData",this.close,this),this.add_related_model(d.god)},_initViews:function(){this._contentPane=new d.ui.common.TabPane({el:this.$(".js-content-container")}),this.addView(this._contentPane),this._navigationView=new j({el:this.$(".js-navigation"),user:this.options.user,routerModel:this.model.visFetchModel,createModel:this.model,collection:this.model.collection}),this._navigationView.render(),this.addView(this._navigationView),this._addTab("listing",new f({createModel:this.model,user:this.options.user})),this._addTab("creatingFromScratch",h.createByTemplate("common/templates/loading",{title:"Creating empty dataset…",quote:i()})),this._addTab("addingNewLayer",h.createByTemplate("common/templates/loading",{title:"Adding new layer…",quote:i()})),this._addTab("addLayerFailed",h.createByTemplate("common/templates/fail",{msg:"Could not add layer"})),this._contentPane.active(this.model.get("contentPane")),this._footerView=new g({model:this.model,user:this.options.user}),this.addView(this._footerView)},_addTab:function(a,b){this._contentPane.addTab(a,b.render()),this.addView(b)},_onChangeContentView:function(){var a=this.model.get("contentPane");this._contentPane.active(a),"loading"===a&&this._footerView.hide(),"listing"!==a&&this._navigationView.hide()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"../../view_helpers/random_quote":241,"../../views/base_dialog/view":242,"../create/create_listing":67,"../create/listing/navigation_view":104,"./add_layer/footer_view":150}],153:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null;b.exports=c.core.View.extend({_SIZE:60,_MIN_SIZE:32,tagName:"li",options:{template:"common/dialogs/map/image_picker/assets_item"},events:{"click a.delete":"_openDropdown",click:"_onClick"},initialize:function(){this.template=c.templates.getTemplate(this.options.template),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.append(this.template(this.model.toJSON())),this._calcBkgImg(this.model.get("public_url")),this},_initBinds:function(){_.bindAll(this,"_onClick","_openDropdown"),this.model.bind("change:state",this._changeState,this),this.model.bind("destroy",this.remove,this)},_calcBkgImg:function(a){var b=new Image,d=this;b.onload=function(){var a=this.width,b=this.height,c=d.$("a.image");d.$el.css("background","none"),"marker"===d.model.get("kind")?b>d._SIZE?c.css({"background-size":"cover","background-origin":"content-box"}):(a||b)<d._MIN_SIZE&&c.css({"background-size":d._MIN_SIZE+"px"}):(a||b)>d._SIZE?c.css({"background-size":"cover","background-origin":"content-box"}):c.css({"background-position":"0 0","background-repeat":"repeat"})},b.onerror=function(a){c.log.info(a)},b.src=a},_onClick:function(a){this.killEvent(a),"selected"!==this.model.get("state")&&"destroying"!=this.model.get("state")&&(this.trigger("selected",this.model),this.model.set("state","selected"))},_changeState:function(){this.$el.removeClass("is-idle is-selected is-destroying").addClass("is-"+this.model.get("state"))},_openDropdown:function(a){var b=this;this.killEvent(a),a.stopImmediatePropagation(),this.dropdown=new c.admin.DropdownMenu({className:"dropdown border tiny",target:d(a.target),width:196,speedIn:150,speedOut:300,template_base:"common/dialogs/map/image_picker/remove_asset",vertical_position:"down",horizontal_position:"left",horizontal_offset:3,tick:"left"}),this.dropdown.bind("optionClicked",function(a){a.preventDefault(),b._deleteAsset()}),d("body").append(this.dropdown.render().el),this.dropdown.open(a),c.god.bind("closeDialogs",this.dropdown.hide,this.dropdown)},_deleteAsset:function(){var a=this;this.model.set("state","destroying"),this.model.destroy({success:function(){},error:function(){a.model.set("state","idle")}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],154:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./static_assets_item_view");b.exports=d.core.View.extend({className:"AssetPane",initialize:function(){this.model=this.options.model,this.template=d.templates.getTemplate("common/dialogs/map/image_picker/assets_template"),this._setupAssets()},render:function(){return this.clearSubViews(),this.$el.html(this.template()),this._renderAssets(),this},_setupAssets:function(){var a={};void 0!==this.options.folder&&(a.folder=this.options.folder),void 0!==this.options.size&&(a.size=this.options.size),void 0!==this.options.host&&(a.host=this.options.host),void 0!==this.options.ext&&(a.ext=this.options.ext),e.isEmpty(a)||(this.options.icons=e.map(this.options.icons,function(b){return e.extend(b,a)})),this.collection=new d.admin.StaticAssets(this.options.icons)},_renderAssets:function(){var a=this,b=this.collection.where({kind:this.options.kind});e(b).each(function(b){var c=new f({className:"AssetItem "+(a.options.folder||""),template:"common/dialogs/map/image_picker/static_assets_item",model:b});c.bind("selected",a._selectItem,a),a.$("ul").append(c.render().el),a.addView(c)})},_selectItem:function(a){this.model.set("value",a.get("public_url")),this.trigger("fileChosen",this),this._unselectItems(a)},_unselectItems:function(a){this.collection.each(function(b){b!==a&&"selected"===b.get("state")&&b.set("state","idle")})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./static_assets_item_view":164}],155:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("./upload_model");b.exports=d.core.View.extend({className:"AssetPane",events:{"click .js-fileButton":"_onBoxClick"},_UPLOADER:{url:"/api/v1/users/<%- id %>/assets",uploads:1,maxFileSize:1048576,acceptFileTypes:["png","svg","jpeg","jpg"],acceptSync:void 0,resolution:"1024x1024"},initialize:function(){_.bindAll(this,"_onDbxChooserSuccess"),this.kind=this.options.kind,this.user=this.options.user,this._setupModel(),this.collection=this.options.collection},render:function(){return this.clearSubViews(),this.template=d.templates.getTemplate("common/dialogs/map/image_picker/box_template"),this.$el.html(this.template()),this},_setupModel:function(){this.model=new e({type:this.options.type,kind:this.options.kind},{userId:this.user.get("id")}),this._initBinds()},_initBinds:function(){this.model.bind("change:state",this._onChangeState,this)},_onStateUploaded:function(){this.collection.fetch(),this.model.setFresh({kind:this.kind})},_onStateError:function(){this._showFileError(),this.trigger("hide_loader",this),this.$(".js-import-panel").show(),this.model.setFresh({kind:this.kind})},_showFileError:function(){"error"===this.model.get("state")&&(this.$(".js-fileError").text(this.model.get("get_error_text").what_about).show(),this.$(".js-fileButton").addClass("Button--negative"))},_hideFileError:function(){this.$(".js-fileError").hide(),this.$(".js-fileLabel").show(),
this.$(".js-fileButton").removeClass("Button--negative")},_onChangeState:function(){var a=this.model.get("state");"uploaded"===a?this._onStateUploaded():"error"==a?this._onStateError():"idle"===a||"uploading"===a?(this.$(".js-import-panel").hide(),this.trigger("show_loader",this)):(this.$(".js-import-panel").show(),this.trigger("hide_loader",this))},_onBoxClick:function(a){this.killEvent(a),Box.choose({success:this._onDbxChooserSuccess,multiselect:!1,linkType:"direct",extensions:_.map(this._UPLOADER.acceptFileTypes,function(a){return"."+a})})},_onDbxChooserSuccess:function(a){a&&a[0]&&(this.model.set({type:"url",value:a[0].link,state:"uploading"}),this.model.upload(),"error"!==this.model.get("state")?this._hideFileError():this._showFileError())}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./upload_model":165}],156:[function(a,b,c){b.exports={disclaimer:'<a href="https://github.com/mapbox/maki" target="_blank">Maki Icons</a>, an open source project by <a href="http://mapbox.com" target="_blank">Mapbox</a>',icons:[{name:"Circle stroked",icon:"circle-stroked"},{name:"Circle solid",icon:"circle"},{name:"Square stroked",icon:"square-stroked"},{name:"Square solid",icon:"square"},{name:"Triangle stroked",icon:"triangle-stroked"},{name:"Triangle solid",icon:"triangle"},{name:"Star stroked",icon:"star-stroked"},{name:"Star solid",icon:"star"},{name:"Cross",icon:"cross"},{name:"Marker Stroke",icon:"marker-stroked"},{name:"Marker Solid",icon:"marker"},{name:"Religious Jewish",icon:"religious-jewish"},{name:"Religious Christian",icon:"religious-christian"},{name:"Religious Muslim",icon:"religious-muslim"},{name:"Cemetery",icon:"cemetery"},{name:"Rocket",icon:"rocket"},{name:"Airport",icon:"airport"},{name:"Heliport",icon:"heliport"},{name:"Rail",icon:"rail"},{name:"Rail Metro",icon:"rail-metro"},{name:"Rail Light",icon:"rail-light"},{name:"Bus",icon:"bus"},{name:"Fuel",icon:"fuel"},{name:"Parking",tags:["parking","transportation"],icon:"parking"},{name:"Parking Garage",tags:["parking","transportation","garage"],icon:"parking-garage"},{name:"Airfield",tags:["airfield","airport","plane","landing strip"],icon:"airfield"},{name:"Roadblock",tags:["roadblock","stop","warning","dead end"],icon:"roadblock"},{name:"Ferry",tags:["ship","boat","water","ferry","transportation"],icon:"ferry"},{name:"Harbor",tags:["marine","dock","water","wharf"],icon:"harbor"},{name:"Bicycle",tags:["cycling","cycle","transportation"],icon:"bicycle"},{name:"Park",tags:["recreation","park","forest","tree","green","woods","nature"],icon:"park"},{name:"Park 2",tags:["recreation","park","forest","tree","green","woods","nature"],icon:"park2"},{name:"Museum",tags:["recreation","museum","tourism"],icon:"museum"},{name:"Lodging",tags:["lodging","hotel","recreation","motel","tourism"],icon:"lodging"},{name:"Monument",tags:["recreation","statue","monument","tourism"],icon:"monument"},{name:"Zoo",tags:["recreation","zoo","animal","giraffe"],icon:"zoo"},{name:"Garden",tags:["recreation","garden","park","flower","nature"],icon:"garden"},{name:"Campsite",tags:["recreation","campsite","camp","camping","tent","nature"],icon:"campsite"},{name:"Theatre",tags:["recreation","theatre","theater","entertainment","play","performance"],icon:"theatre"},{name:"Art gallery",tags:["art","center","museum","gallery","creative","recreation","entertainment","studio"],icon:"art-gallery"},{name:"Pitch",tags:["pitch","track","athletic","sports","field"],icon:"pitch"},{name:"Soccer",tags:["soccer","sports"],icon:"soccer"},{name:"American Football",tags:["football","sports"],icon:"america-football"},{name:"Tennis",tags:["tennis","court","ball","sports"],icon:"tennis"},{name:"Basketball",tags:["basketball","ball","sports"],icon:"basketball"},{name:"Baseball",tags:["baseball","softball","ball","sports"],icon:"baseball"},{name:"Golf",tags:["golf","sports","course"],icon:"golf"},{name:"Swimming",tags:["swimming","water","swim","sports"],icon:"swimming"},{name:"Cricket",tags:["cricket","sports"],icon:"cricket"},{name:"Skiing",tags:["winter","skiing","ski","sports"],icon:"skiing"},{name:"School",tags:["school","highschool","elementary","children","amenity","middle"],icon:"school"},{name:"College",tags:["college","school","amenity","university"],icon:"college"},{name:"Library",tags:["library","books","amenity"],icon:"library"},{name:"Post",tags:["post","office","amenity","mail","letter"],icon:"post"},{name:"Fire station",tags:["fire","station","amenity"],icon:"fire-station"},{name:"Town hall",tags:["townhall","mayor","building","amenity","government"],icon:"town-hall"},{name:"Police",tags:["police","jail","arrest","amenity","station"],icon:"police"},{name:"Prison",tags:["prison","jail","amenity"],icon:"prison"},{name:"Embassy",tags:["embassy","diplomacy","consulate","amenity","flag"],icon:"embassy"},{name:"Beer",tags:["bar","beer","drink","commercial","biergarten","pub"],icon:"beer"},{name:"Restaurant",tags:["restaurant","commercial"],icon:"restaurant"},{name:"Cafe",tags:["cafe","coffee","commercial","tea"],icon:"cafe"},{name:"Shop",tags:["shop","mall","commercial","store"],icon:"shop"},{name:"Fast Food",tags:["food","fast","commercial","burger","drive-through"],icon:"fast-food"},{name:"Bar",tags:["bar","drink","commercial","club","martini","lounge"],icon:"bar"},{name:"Bank",tags:["bank","atm","commercial","money"],icon:"bank"},{name:"Grocery",tags:["food","grocery","commercial","store","market"],icon:"grocery"},{name:"Cinema",tags:["cinema","theatre","film","movie","commercial","theater","entertainment"],icon:"cinema"},{name:"Pharmacy",tags:["pharmacy","drugs","medication","social","medicine","prescription"],icon:"pharmacy"},{name:"Hospital",tags:["hospital","health","medication","social","medicine","medical","clinic"],icon:"hospital"},{name:"Danger",tags:["minefield","landmine","disaster","dangerous","hazard"],icon:"danger"},{name:"Industrial",tags:["industrial","factory","property","building"],icon:"industrial"},{name:"Warehouse",tags:["warehouse","property","storage","building"],icon:"warehouse"},{name:"Commercial",tags:["commercial","property","business","building"],icon:"commercial"},{name:"Building",tags:["building","property","structure","business","building"],icon:"building"},{name:"Place of worship",tags:["religion","ceremony","religious","nondenominational","church","temple"],icon:"place-of-worship"},{name:"Alcohol shop",tags:["alcohol","liquor","store","shop","beer","wine","vodka"],icon:"alcohol-shop"},{name:"Logging",tags:["logger","chainsaw","woods","industry"],icon:"logging"},{name:"Oil well",tags:["oil","natural","environment","industry","resources"],icon:"oil-well"},{name:"Slaughterhouse",tags:["cows","cattle","food","meat","industry","resources"],icon:"slaughterhouse"},{name:"Dam",tags:["water","natural","hydro","hydroelectric","energy","environment","industry","resources"],icon:"dam"},{name:"Water",tags:["water","natural","hydro","lake","river","ocean","resources"],icon:"water"},{name:"Wetland",tags:["water","swamp","natural"],icon:"wetland"},{name:"Disability",tags:["handicap","wheelchair","access"],icon:"disability"},{name:"Telephone",tags:["payphone","call"],icon:"telephone"},{name:"Emergency Telephone",tags:["payphone","danger","safety","call"],icon:"emergency-telephone"},{name:"Toilets",tags:["bathroom","men","women","sink","washroom","lavatory"],icon:"toilets"},{name:"Waste Basket",tags:["trash","rubbish","bin","garbage"],icon:"waste-basket"},{name:"Music",tags:["stage","performance","band","concert","venue"],icon:"music"},{name:"Land Use",tags:["zoning","usage","area"],icon:"land-use"},{name:"City",tags:["area","point","place","urban"],icon:"city"},{name:"Town",tags:["area","point","place","small"],icon:"town"},{name:"Village",tags:["area","point","place","small","rural"],icon:"village"},{name:"Farm",tags:["building","farming","crops","plants","agriculture","rural"],icon:"farm"},{name:"Bakery",tags:["bakery","pastry","croissant","food","shop","bread"],icon:"bakery"},{name:"Dog Park",tags:["dog","pet"],icon:"dog-park"},{name:"Lighthouse",tags:["building","navigation","nautical","ocean","logistics"],icon:"lighthouse"},{name:"Clothing Store",tags:["clothing","store","shop"],icon:"clothing-store"},{name:"Polling Place",icon:"polling-place"},{name:"Playground",icon:"playground"},{name:"Entrance",icon:"entrance"},{name:"Heart",icon:"heart"},{name:"London Underground",icon:"london-underground"},{name:"Minefield",icon:"minefield"},{name:"Rail Underground",icon:"rail-underground"},{name:"Rail Above",icon:"rail-above"},{name:"Camera",icon:"camera"},{name:"Laundry",icon:"laundry"},{name:"Car",icon:"car"},{name:"Suitcase",icon:"suitcase"},{name:"Hairdresser",icon:"hairdresser"},{name:"Chemist",icon:"chemist"},{name:"Mobile phone",icon:"mobilephone"},{name:"Scooter",icon:"scooter"}]}},{}],157:[function(a,b,c){b.exports={icons:[{kind:"pattern",ext:"png",name:"diagonal_1px_fast",icon:"diagonal_1px_fast"},{kind:"pattern",ext:"png",name:"diagonal_1px_med",icon:"diagonal_1px_med"},{kind:"pattern",ext:"png",name:"diagonal_1px_slow",icon:"diagonal_1px_slow"},{kind:"pattern",ext:"png",name:"diagonal_2px_fast",icon:"diagonal_2px_fast"},{kind:"pattern",ext:"png",name:"diagonal_2px_med",icon:"diagonal_2px_med"},{kind:"pattern",ext:"png",name:"diagonal_2px_slow",icon:"diagonal_2px_slow"},{kind:"pattern",ext:"png",name:"donuts_4px_med",icon:"donuts_4px_med"},{kind:"pattern",ext:"png",name:"donuts_6px_med",icon:"donuts_6px_med"},{kind:"pattern",ext:"png",name:"dots_2px_fast",icon:"dots_2px_fast"},{kind:"pattern",ext:"png",name:"dots_2px_med",icon:"dots_2px_med"},{kind:"pattern",ext:"png",name:"dots_2px_slow",icon:"dots_2px_slow"},{kind:"pattern",ext:"png",name:"dots_4px_fast",icon:"dots_4px_fast"},{kind:"pattern",ext:"png",name:"dots_4px_med",icon:"dots_4px_med"},{kind:"pattern",ext:"png",name:"dots_6px_fast",icon:"dots_6px_fast"},{kind:"pattern",ext:"png",name:"dots_6px_med",icon:"dots_6px_med"}]}},{}],158:[function(a,b,c){b.exports={disclaimer:'<a href="http://www.flaticon.com/packs/pins-of-maps/" target="_blank">Pin Maps</a>, icons by <a href="http://freepik.com" target="_blank">freepik.com</a>',icons:[{name:"air",icon:"air"},{name:"air2",icon:"air2"},{name:"anchor2",icon:"anchor2"},{name:"anchor3",icon:"anchor3"},{name:"bag1",icon:"bag1"},{name:"bag2",icon:"bag2"},{name:"balloon",icon:"balloon"},{name:"black41",icon:"black41"},{name:"boat1",icon:"boat1"},{name:"book16",icon:"book16"},{name:"building",icon:"building"},{name:"burger",icon:"burger"},{name:"bus6",icon:"bus6"},{name:"caravan2",icon:"caravan2"},{name:"church1",icon:"church1"},{name:"church3",icon:"church3"},{name:"club",icon:"club"},{name:"cocktail3",icon:"cocktail3"},{name:"coffee2",icon:"coffee2"},{name:"dark11",icon:"dark11"},{name:"disabled",icon:"disabled"},{name:"dog2",icon:"dog2"},{name:"favourite1",icon:"favourite1"},{name:"flag5",icon:"flag5"},{name:"flat",icon:"flat"},{name:"hotel",icon:"hotel"},{name:"information3",icon:"information3"},{name:"location10",icon:"location10"},{name:"location11",icon:"location11"},{name:"location5",icon:"location5"},{name:"location6",icon:"location6"},{name:"location7",icon:"location7"},{name:"location8",icon:"location8"},{name:"location9",icon:"location9"},{name:"marker2",icon:"marker2"},{name:"marker3",icon:"marker3"},{name:"marker4",icon:"marker4"},{name:"marker5",icon:"marker5"},{name:"marker6",icon:"marker6"},{name:"marker7",icon:"marker7"},{name:"monument2",icon:"monument2"},{name:"mountains",icon:"mountains"},{name:"p",icon:"p"},{name:"petrol",icon:"petrol"},{name:"petrol2",icon:"petrol2"},{name:"pharmacy",icon:"pharmacy"},{name:"phone13",icon:"phone13"},{name:"pin10",icon:"pin10"},{name:"pins",icon:"pins"},{name:"pins1",icon:"pins1"},{name:"pins10",icon:"pins10"},{name:"pins11",icon:"pins11"},{name:"pins12",icon:"pins12"},{name:"pins13",icon:"pins13"},{name:"pins14",icon:"pins14"},{name:"pins15",icon:"pins15"},{name:"pins16",icon:"pins16"},{name:"pins17",icon:"pins17"},{name:"pins18",icon:"pins18"},{name:"pins19",icon:"pins19"},{name:"pins2",icon:"pins2"},{name:"pins20",icon:"pins20"},{name:"pins21",icon:"pins21"},{name:"pins22",icon:"pins22"},{name:"pins23",icon:"pins23"},{name:"pins24",icon:"pins24"},{name:"pins25",icon:"pins25"},{name:"pins26",icon:"pins26"},{name:"pins27",icon:"pins27"},{name:"pins28",icon:"pins28"},{name:"pins29",icon:"pins29"},{name:"pins3",icon:"pins3"},{name:"pins30",icon:"pins30"},{name:"pins31",icon:"pins31"},{name:"pins32",icon:"pins32"},{name:"pins33",icon:"pins33"},{name:"pins34",icon:"pins34"},{name:"pins35",icon:"pins35"},{name:"pins36",icon:"pins36"},{name:"pins37",icon:"pins37"},{name:"pins38",icon:"pins38"},{name:"pins39",icon:"pins39"},{name:"pins4",icon:"pins4"},{name:"pins40",icon:"pins40"},{name:"pins41",icon:"pins41"},{name:"pins42",icon:"pins42"},{name:"pins43",icon:"pins43"},{name:"pins44",icon:"pins44"},{name:"pins45",icon:"pins45"},{name:"pins46",icon:"pins46"},{name:"pins47",icon:"pins47"},{name:"pins48",icon:"pins48"},{name:"pins49",icon:"pins49"},{name:"pins5",icon:"pins5"},{name:"pins50",icon:"pins50"},{name:"pins51",icon:"pins51"},{name:"pins52",icon:"pins52"},{name:"pins53",icon:"pins53"},{name:"pins54",icon:"pins54"},{name:"pins55",icon:"pins55"},{name:"pins56",icon:"pins56"},{name:"pins57",icon:"pins57"},{name:"pins58",icon:"pins58"},{name:"pins59",icon:"pins59"},{name:"pins6",icon:"pins6"},{name:"pins60",icon:"pins60"},{name:"pins61",icon:"pins61"},{name:"pins62",icon:"pins62"},{name:"pins63",icon:"pins63"},{name:"pins64",icon:"pins64"},{name:"pins65",icon:"pins65"},{name:"pins66",icon:"pins66"},{name:"pins67",icon:"pins67"},{name:"pins68",icon:"pins68"},{name:"pins69",icon:"pins69"},{name:"pins7",icon:"pins7"},{name:"pins70",icon:"pins70"},{name:"pins71",icon:"pins71"},{name:"pins72",icon:"pins72"},{name:"pins73",icon:"pins73"},{name:"pins74",icon:"pins74"},{name:"pins75",icon:"pins75"},{name:"pins76",icon:"pins76"},{name:"pins77",icon:"pins77"},{name:"pins78",icon:"pins78"},{name:"pins79",icon:"pins79"},{name:"pins8",icon:"pins8"},{name:"pins80",icon:"pins80"},{name:"pins81",icon:"pins81"},{name:"pins82",icon:"pins82"},{name:"pins83",icon:"pins83"},{name:"pins84",icon:"pins84"},{name:"pins85",icon:"pins85"},{name:"pins86",icon:"pins86"},{name:"pins87",icon:"pins87"},{name:"pins88",icon:"pins88"},{name:"pins89",icon:"pins89"},{name:"pins9",icon:"pins9"},{name:"pins90",icon:"pins90"},{name:"pins91",icon:"pins91"},{name:"position",icon:"position"},{name:"restaurant2",icon:"restaurant2"},{name:"right14",icon:"right14"},{name:"road3",icon:"road3"},{name:"shop2",icon:"shop2"},{name:"shopping8",icon:"shopping8"},{name:"sit",icon:"sit"},{name:"ski1",icon:"ski1"},{name:"soccer1",icon:"soccer1"},{name:"suitcase1",icon:"suitcase1"},{name:"suitcase2",icon:"suitcase2"},{name:"telephone3",icon:"telephone3"},{name:"tent",icon:"tent"},{name:"tent1",icon:"tent1"},{name:"train3",icon:"train3"},{name:"train4",icon:"train4"},{name:"turn7",icon:"turn7"},{name:"walk",icon:"walk"},{name:"wifi11",icon:"wifi11"}]}},{}],159:[function(a,b,c){b.exports={disclaimer:'<a href="http://www.flaticon.com/packs/simpleicon-places/" target="_blank">SimpleIcons Places</a>, icons by <a href="http://www.simpleicon.com" target="_blank">simpleicon.com</a>',icons:[{name:"beach3",icon:"beach3"},{name:"beach4",icon:"beach4"},{name:"boat12",icon:"boat12"},{name:"building21",icon:"building21"},{name:"building22",icon:"building22"},{name:"building23",icon:"building23"},{name:"building24",icon:"building24"},{name:"buildings5",icon:"buildings5"},{name:"castle7",icon:"castle7"},{name:"church7",icon:"church7"},{name:"coconut5",icon:"coconut5"},{name:"compass44",icon:"compass44"},{name:"compass45",icon:"compass45"},{name:"compass46",icon:"compass46"},{name:"compass47",icon:"compass47"},{name:"compass49",icon:"compass49"},{name:"compass50",icon:"compass50"},{name:"factory7",icon:"factory7"},{name:"factory8",icon:"factory8"},{name:"flag31",icon:"flag31"},{name:"flag32",icon:"flag32"},{name:"heart206",icon:"heart206"},{name:"home84",icon:"home84"},{name:"home85",icon:"home85"},{name:"home86",icon:"home86"},{name:"home87",icon:"home87"},{name:"home88",icon:"home88"},{name:"home89",icon:"home89"},{name:"home90",icon:"home90"},{name:"map35",icon:"map35"},{name:"map36",icon:"map36"},{name:"map37",icon:"map37"},{name:"map38",icon:"map38"},{name:"map39",icon:"map39"},{name:"map40",icon:"map40"},{name:"map41",icon:"map41"},{name:"map42",icon:"map42"},{name:"map43",icon:"map43"},{name:"map44",icon:"map44"},{name:"map45",icon:"map45"},{name:"map46",icon:"map46"},{name:"map47",icon:"map47"},{name:"map48",icon:"map48"},{name:"map49",icon:"map49"},{name:"map50",icon:"map50"},{name:"map51",icon:"map51"},{name:"map52",icon:"map52"},{name:"map53",icon:"map53"},{name:"map54",icon:"map54"},{name:"map55",icon:"map55"},{name:"map56",icon:"map56"},{name:"map57",icon:"map57"},{name:"map58",icon:"map58"},{name:"map59",icon:"map59"},{name:"map60",icon:"map60"},{name:"palm9",icon:"palm9"},{name:"placeholder4",icon:"placeholder4"},{name:"sailboat5",icon:"sailboat5"},{name:"sunbathing",icon:"sunbathing"},{name:"sunbathing1",icon:"sunbathing1"},{name:"tower15",icon:"tower15"},{name:"town",icon:"town"}]}},{}],160:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("./upload_model");b.exports=d.core.View.extend({className:"AssetPane",events:{"click .js-fileButton":"_onDropboxClick"},_UPLOADER:{url:"/api/v1/users/<%- id %>/assets",uploads:1,maxFileSize:1048576,acceptFileTypes:["png","svg","jpeg","jpg"],acceptSync:void 0,resolution:"1024x1024"},initialize:function(){_.bindAll(this,"_onDbxChooserSuccess"),this.kind=this.options.kind,this.user=this.options.user,this._setupModel(),this.collection=this.options.collection},render:function(){return this.clearSubViews(),this.template=d.templates.getTemplate("common/dialogs/map/image_picker/dropbox_template"),this.$el.html(this.template()),this},_setupModel:function(){this.model=new e({type:this.options.type,kind:this.options.kind},{userId:this.user.get("id")}),this._initBinds()},_initBinds:function(){this.model.bind("change:state",this._onChangeState,this)},_onStateUploaded:function(){this.collection.fetch(),this.model.setFresh({kind:this.kind})},_onStateError:function(){this._showFileError(),this.trigger("hide_loader",this),this.$(".js-import-panel").show(),this.model.setFresh({kind:this.kind})},_showFileError:function(){"error"===this.model.get("state")&&(this.$(".js-fileError").text(this.model.get("get_error_text").what_about).show(),this.$(".js-fileButton").addClass("Button--negative"))},_hideFileError:function(){this.$(".js-fileError").hide(),this.$(".js-fileLabel").show(),this.$(".js-fileButton").removeClass("Button--negative")},_onChangeState:function(){var a=this.model.get("state");"uploaded"===a?this._onStateUploaded():"error"==a?this._onStateError():"idle"===a||"uploading"===a?(this.$(".js-import-panel").hide(),this.trigger("show_loader",this)):(this.$(".js-import-panel").show(),this.trigger("hide_loader",this))},_onDropboxClick:function(a){this.killEvent(a),Dropbox.choose({success:this._onDbxChooserSuccess,multiselect:!1,linkType:"direct",extensions:_.map(this._UPLOADER.acceptFileTypes,function(a){return"."+a})})},_onDbxChooserSuccess:function(a){a&&a[0]&&(this.model.set({type:"url",value:a[0].link,state:"uploading"}),this.model.upload(),"error"!==this.model.get("state")?this._hideFileError():this._showFileError())}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./upload_model":165}],161:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("./upload_model");b.exports=d.core.View.extend({className:"AssetPane",options:{type:"url",acceptSync:!1,fileEnabled:!0,formTemplate:"",headerTemplate:"",fileAttrs:{}},events:{"keyup .js-textInput":"_onTextChanged","submit .js-form":"_onSubmitForm"},initialize:function(){this.user=this.options.user,this.kind=this.options.kind,this.collection=this.options.collection,this._setupModel(),this.template=d.templates.getTemplate("common/dialogs/map/image_picker/file_upload_template")},render:function(){return this.$el.html(this.template(_.extend(this.options,this.model.attributes))),this._initViews(),this},_setupModel:function(){this.model=new e({type:this.options.type,kind:this.options.kind},{userId:this.user.get("id")}),this._initBinds()},_initBinds:function(){this.model.bind("change:state",this._onChangeState,this)},_initViews:function(){if(this.options.fileEnabled){var a=this;this.$(".js-fileInput").bind("change",function(b){this.files&&this.files.length>0&&a._onFileChanged(this.files)}),this._initDropzone()}},_onTextChanged:function(){var a=this.$(".js-textInput").val();a||this._hideTextError()},_onSubmitForm:function(a){a&&this.killEvent(a);var b=this.$(".js-textInput").val();return b?(this.trigger("urlSelected",this),this.model.set({type:"url",value:b,state:"idle"}),this.model.upload(),void("error"!==this.model.get("state")?(this._hideFileError(),this._hideTextError()):this._showTextError())):void this._hideTextError()},_initDropzone:function(){var a=$("html")[0],b=this;this.dragster=new Dragster(a),$(a).bind("dragster:enter",function(a){b._showDropzone()}),$(a).bind("dragster:leave",function(a){b._hideDropzone()}),a.dropzone||(this.dropzone=new Dropzone(a,{url:":)",autoProcessQueue:!1,previewsContainer:!1}),this.dropzone.on("dragover",function(){b._showDropzone()}),this.dropzone.on("drop",function(a){var c=a.dataTransfer.files;b._onFileChanged(c),b._hideDropzone()}))},_destroyDropzone:function(){var a=$("html")[0];this.dragster&&(this.dragster.removeListeners(),this.dragster.reset(),$(a).unbind("dragster:enter dragster:leave")),this.dropzone&&this.dropzone.destroy()},_setValidFileExtensions:function(a){return RegExp("(.|/)("+a.join("|")+")$","i")},_onFileChanged:function(a){a&&1===a.length&&(a=a[0]),this.model.set({type:"file",value:a}),"error"!==this.model.get("state")?(this._hideFileError(),this.model.set("state","selected"),this.model.upload()):this._showFileError()},_showTextError:function(){this.$(".Form-inputError").addClass("is-visible")},_hideTextError:function(){this.$(".Form-inputError").removeClass("is-visible")},_showDropzone:function(){this.$(".Form-upload").addClass("is-dropping"),this._hideFileError()},_hideDropzone:function(){this.$(".Form-upload").removeClass("is-dropping")},_showFileError:function(){"error"===this.model.get("state")&&(this.$(".js-fileError").text(this.model.get("get_error_text").what_about).show(),this.$(".js-fileLabel").hide(),this.$(".js-fileButton").addClass("Button--negative"))},_hideFileError:function(){this.$(".js-fileError").hide(),this.$(".js-fileLabel").show(),this.$(".js-fileButton").removeClass("Button--negative")},_onStateUploaded:function(){this.collection.fetch(),this.model.setFresh({kind:this.kind}),this.$(".js-textInput").val("")},_onStateError:function(){this._showFileError(),this.$(".js-form").show(),this.trigger("hide_loader",this),this.model.setFresh({kind:this.kind})},_onChangeState:function(){var a=this.model.get("state");"uploaded"===a?this._onStateUploaded():"error"===a?this._onStateError():"idle"===a||"uploading"===a||"selected"===a?(this.$(".js-form").hide(),this.trigger("show_loader",this)):(this.$(".js-form").show(),this.trigger("hide_loader",this))},clean:function(){this._destroyDropzone(),this.$(".js-fileInput").unbind("change"),this.elder("clean")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./upload_model":165}],162:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.core.View.extend({_TEXTS:{ok:{simple_icons:_t("Set image"),pin_icons:_t("Set image"),maki_icons:_t("Set image"),your_icons:_t("Set image"),upload_file:_t("Upload image"),dropbox:_t("Upload image"),box:_t("Upload image")}},events:{"click .js-ok":"_finish"},initialize:function(){this.elder("initialize"),this._template=d.templates.getTemplate("common/dialogs/map/image_picker/footer_template"),this._initBinds()},render:function(){this.clearSubViews();var a=this._TEXTS.ok[this.model.get("pane")]||"Set image",b=_.extend(this.model.attributes,{action:a}),d=c(this._template(b));return this.$el.html(d),this},_initBinds:function(){this.model.bind("change",this.render,this),this.model.bind("change:disclaimer",this._updateFooterInfo,this)},_updateFooterInfo:function(){this.$el.find(".js-footer-info").html(this.model.get("disclaimer"))},_finish:function(a){this.killEvent(a),this.model.get("submit_enabled")&&this.trigger("finish",this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],163:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;"undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.core.View.extend({events:{"click .js-item":"_onItemClick","click .js-your-icons":"_onYourIconsClick"},initialize:function(){this.model=this.options.model,this.kind=this.options.kind,this.collection=this.options.collection,this.template=c.templates.getTemplate("common/dialogs/map/image_picker/navigation_template"),this._preRender(),this._initBinds()},_preRender:function(){var a=$("<div>").addClass("u-inner"),b=$("<div>").addClass("Filters-inner");this.$el.append(a.append(b))},render:function(a,b){if(this.clearSubViews(),this.$(".Filters-inner").html(this.template({dropbox_enabled:this.model.get("dropbox_enabled"),box_enabled:this.model.get("box_enabled"),pane:this.model.get("pane"),kind:this.kind})),this.collection.where({kind:this.kind}).length>0){var c="your_icons";this.$el.find('[data-type="'+c+'"]').removeClass("is-disabled")}return this},_initBinds:function(){this.model.bind("change:pane",this.render,this),this.model.bind("change:pane",this._enableFilter,this),this.add_related_model(this.model)},_onYourIconsClick:function(a){if(this.collection.where({kind:this.kind}).length>0){var b=$(a.target).data("type");this.model.set("pane",b)}},_onItemClick:function(a){var b=$(a.target).data("type");this.model.set("pane",b)},_enableFilter:function(a){var b=this.model.get("pane"),c=this.$el.find('[data-type="'+b+'"]');c.removeClass("is-disabled")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],164:[function(a,b,c){var d=a("./assets_item_view");b.exports=d.extend({events:{click:"_onClick"},_deleteAsset:function(){},_openDropdown:function(){}})},{"./assets_item_view":153}],165:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.Backbone:"undefined"!=typeof a?a.Backbone:null,d="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof a?a.cdb.Utils:null,e=("undefined"!=typeof window?window.moment:"undefined"!=typeof a?a.moment:null,"undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null);b.exports=c.Model.extend({url:function(a){var b=cdb.config.urlVersion("asset",a);return"/api/"+b+"/users/"+this.userId+"/assets"},fileAttribute:"filename",defaults:{type:"",value:"",interval:0,progress:0,state:"idle",option:""},initialize:function(a,b){if(this.user=b&&b.user,!b.userId)throw new Error("userId is required");this.userId=b.userId,this._initBinds(),this._validate(this.attributes,{validate:!0})},isValidToUpload:function(){return this.get("value")&&"error"!==this.get("state")},setFresh:function(a){this.clear(),this.set(a)},_initBinds:function(){this.bind("progress",function(a){this.set({progress:100*a,state:"uploading"})},this),this.bind("change:value",function(){"error"===this.get("state")&&(this.set({state:"idle"}),this.unset("get_error_text",{silent:!0}))},this),this.bind("error invalid",function(a,b){this.set({state:"error",error_code:b&&b.error_code||"",get_error_text:{title:"Invalid import",what_about:b&&b.msg||""}},{silent:!0}),this.trigger("change")},this)},validate:function(a){if(a){if("file"===a.type){if(a.value&&a.value.length)return{msg:"Unfortunately only one file is allowed per upload"};var b=a.value.name,c=b.substr(b.lastIndexOf(".")+1);if(c&&(c=c.toLowerCase()),!e.contains(["jpg","png","gif","svg"],c))return{msg:"Unfortunately this file extension is not allowed"}}return"url"!==a.type||d.isURL(a.value)?void 0:{msg:"Unfortunately the URL provided is not valid"}}},isValid:function(){return this.get("value")&&"error"!==this.get("state")},upload:function(){var a=this,b={kind:this.get("kind")};"file"===this.get("type")?b.filename=this.get("value"):"url"===this.get("type")&&(b.url=this.get("value")),this.xhr=this.save(b,{success:function(a){a.set("state","uploaded")},error:function(b,c){var d="Unfortunately there was a connection error";if(c&&429===c.status){var e=JSON.parse(c.responseText);d=e.error}else if(c&&400===c.status){var e=JSON.parse(c.responseText);d=e.error}a.set({state:"error",get_error_text:{title:"There was an error",what_about:d}})},complete:function(){delete a.xhr}})},stopUpload:function(){this.xhr&&this.xhr.abort()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],166:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./assets_view"),g=a("./assets_item_view");b.exports=f.extend({className:"AssetPane AssetPane-userIcons",initialize:function(){this.model=this.options.model,this.template=d.templates.getTemplate("common/dialogs/map/image_picker/assets_template"),this.collection.bind("add remove reset",this.render,this)},_renderAssets:function(){var a=this,b=this.collection.where({kind:this.options.kind});e(b).each(function(b){var c=new g({className:"AssetItem AssetItem-User",model:b});c.bind("selected",a._selectItem,a),a.$("ul").append(c.render().el),a.addView(c)})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./assets_item_view":153,"./assets_view":154}],167:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("./image_picker/navigation_view"),g=a("./image_picker/footer_view"),h=a("./image_picker/assets_view"),i=a("./image_picker/user_icons_view"),j=a("./image_picker/file_upload_view"),k=a("./image_picker/dropbox_view"),l=a("./image_picker/box_view"),m=a("./image_picker/data/maki_icons"),n=a("./image_picker/data/patterns"),o=a("./image_picker/data/pin_maps"),p=a("./image_picker/data/simpleicon"),q=a("../../view_factory"),r=a("../../view_helpers/random_quote");b.exports=e.extend({className:"Dialog ImagePicker",initialize:function(){this.elder("initialize"),this._validate(),this.kind=this.options.kind,this.model=new d.core.Model({disclaimer:"",dropbox_enabled:!!d.config.get("dropbox_api_key"),box_enabled:!!d.config.get("box_api_key"),submit_enabled:!1}),this.collection=new d.admin.Assets([],{user:this.options.user}),this._template=d.templates.getTemplate("common/dialogs/map/image_picker_template"),this._initBinds(),this._onChangePane()},render:function(){return this.clearSubViews(),e.prototype.render.call(this),this.$(".content").addClass("Dialog-content--expanded"),this._initViews(),this._initAssets(),this},_initAssets:function(){this.collection.bind("add remove reset",this._onAssetsFetched,this),this.collection.fetch()},_showLoader:function(){var a=this._contentPane.getPane("loader");a&&a.show()},_hideLoader:function(){var a=this._contentPane.getPane("loader");
a&&a.hide()},_showUploadLoader:function(){var a=this._contentPane.getPane("upload_loader");a&&a.show()},_hideUploadLoader:function(){var a=this._contentPane.getPane("upload_loader");a&&a.hide()},_onAssetsFetched:function(){this._hideLoader();var a=this.collection.where({kind:this.kind});0===a.length?"marker"===this.kind?this.model.set("pane","simple_icons"):this.model.set("pane","patterns"):this.model.set("pane","your_icons")},render_content:function(){return this._template({kind:this.kind})},_initViews:function(){this._renderContentPane(),this._renderNavigation(),this._renderTabPane(),this._renderLoader(),this._renderUploadLoader(),"marker"===this.kind?(this._renderSimpleiconPane(),this._renderPinIconsPane(),this._renderMakisPane()):"pattern"===this.kind&&this._renderPatternPane(),this._renderUserIconsPane(),this._renderFilePane(),this._renderDropboxPane(),this._renderBoxPane(),this._renderFooter(),this._contentPane.active("loader")},_renderFooter:function(){this._footerView=new g({model:this.model}),this._footerView.bind("finish",this._ok,this),this.$(".js-footer").append(this._footerView.render().el),this.addView(this._footerView)},_renderTabPane:function(){this.tabPane=new d.ui.common.TabPane({el:this.$(".AssetsContent")}),this.addView(this.tabPane)},_renderContentPane:function(){this._contentPane=new d.ui.common.TabPane({el:this.$(".js-content-container")}),this.addView(this._contentPane),this._contentPane.active(this.model.get("contentPane"))},_renderNavigation:function(){var a=new f({el:this.$(".js-navigation"),kind:this.kind,collection:this.collection,user:this.options.user,model:this.model});a.render(),this.addView(a)},_renderPane:function(a,b){b.bind("fileChosen",this._onFileChosen,this),b.render(),this._addPane(a,b)},_renderUploadLoader:function(){this._addTab("upload_loader",q.createByTemplate("common/templates/loading",{title:"Uploading asset…",quote:r()}))},_renderLoader:function(){this._addTab("loader",q.createByTemplate("common/templates/loading",{title:"Loading assets…",quote:r()}))},_renderPatternPane:function(){var a=new h({model:this.model,collection:this.collection,kind:this.kind,icons:n.icons,folder:"patterns",size:""});this._renderPane("patterns",a)},_renderSimpleiconPane:function(){var a=new h({model:this.model,collection:this.collection,kind:this.kind,icons:p.icons,disclaimer:p.disclaimer,folder:"simpleicon",size:""});this._renderPane("simple_icons",a)},_renderMakisPane:function(){var a=new h({model:this.model,collection:this.collection,kind:this.kind,icons:m.icons,disclaimer:m.disclaimer,folder:"maki-icons",size:"18"});this._renderPane("maki_icons",a)},_renderUserIconsPane:function(){var a=new i({model:this.model,collection:this.collection,kind:this.kind,folder:"your-icons"});this._renderPane("your_icons",a)},_renderPinIconsPane:function(){var a=new h({model:this.model,collection:this.collection,kind:this.kind,icons:o.icons,disclaimer:o.disclaimer,folder:"pin-maps",size:""});this._renderPane("pin_icons",a)},_renderFilePane:function(){var a=new j({collection:this.collection,kind:this.kind,user:this.options.user});a.bind("valueChange",this._onFileChosen,this),a.bind("show_loader",this._showUploadLoader,this),a.bind("hide_loader",this._hideUploadLoader,this),this._renderPane("upload_file",a)},_renderDropboxPane:function(){if(this.model.get("dropbox_enabled")){var a=new k({model:this.model,collection:this.collection,kind:this.kind,user:this.options.user});a.bind("valueChange",this._onFileChosen,this),a.bind("show_loader",this._showUploadLoader,this),a.bind("hide_loader",this._hideUploadLoader,this),this._renderPane("dropbox",a)}},_renderBoxPane:function(){if(this.model.get("box_enabled")){var a=new l({model:this.model,collection:this.collection,kind:this.kind,user:this.options.user});a.bind("valueChange",this._onFileChosen,this),a.bind("show_loader",this._showUploadLoader,this),a.bind("hide_loader",this._hideUploadLoader,this),this._renderPane("box",a)}},_addPane:function(a,b){this.tabPane.addTab(a,b,{active:this.model.get("pane")===a})},_addTab:function(a,b){this._contentPane.addTab(a,b.render()),this.addView(b)},_validate:function(){if(!this.options.user)throw new TypeError("user is required");if(!this.options.kind)throw new Error("kind should be passed")},_initBinds:function(){this.model.bind("change:pane",this._onChangePane.bind(this))},_onChangePane:function(){if(this.tabPane){this.tabPane.active(this.model.get("pane")),this.model.set("submit_enabled",!1);var a=this.tabPane.getActivePane();a&&this.model.set("disclaimer",a.options.disclaimer)}},_ok:function(){this.trigger("fileChosen",this.model.get("value")),this.close()},_onFileChosen:function(){this.model.set("submit_enabled",!0)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"../../view_helpers/random_quote":241,"../../views/base_dialog/view":242,"./image_picker/assets_view":154,"./image_picker/box_view":155,"./image_picker/data/maki_icons":156,"./image_picker/data/patterns":157,"./image_picker/data/pin_maps":158,"./image_picker/data/simpleicon":159,"./image_picker/dropbox_view":160,"./image_picker/file_upload_view":161,"./image_picker/footer_view":162,"./image_picker/navigation_view":163,"./image_picker/user_icons_view":166}],168:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view");b.exports=e.extend({events:d.core.View.extendEvents({"click .js-option":"_onOptionClick","click .js-skip":"_onSkipClick"}),options:{skipDisabled:!1},initialize:function(){if(this.elder("initialize"),!this.options.table)throw new TypeError("table is required");this.table=this.options.table,this._template=d.templates.getTemplate("common/dialogs/map/scratch_view_template")},render:function(){return this.clearSubViews(),e.prototype.render.call(this),this},render_content:function(){return this._template({name:this.table.get("name"),skipDisabled:this.options.skipDisabled})},_onSkipClick:function(a){this.killEvent(a),this.close(),this.trigger("skip",this)},_onOptionClick:function(a){this.killEvent(a),this.close(),this.trigger("newGeometry",$(a.target).closest(".js-option").data("type"))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../views/base_dialog/view":242}],169:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,g="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,h=a("./choose_key_columns_view"),i=a("./select_columns_model");b.exports=g.core.Model.extend({INSTRUCTIONS_SAFE_HTML:"Select the dataset on the right that you want to merge the left with. You can only merge datasets by joining by columns of the same type (e.g. number to a number).",defaults:{user:void 0,isReadyForNextStep:!1,excludeColumns:[],leftTable:void 0,leftColumns:void 0,rightTableData:void 0,rightColumns:void 0},initialize:function(){this._initColumns()},createView:function(){this.set("gotoNextStep",!1);var a=this.get("leftColumns");return a.each(function(a){a.unset("selected")}),this.get("rightColumns").reset(),this._resetSorting(a),this._resetSorting(this.get("rightColumns")),new h({model:this})},changeRightTable:function(a){this.get("rightColumns").reset(),this.set("rightTableData",a),d.ajax({url:g.config.prefixUrl()+"/api/v1/tables/"+a.id,dataType:"jsonp",success:this._onFetchedColumns.bind(this)})},_onFetchedColumns:function(a){var b=this._filterColumns(a.schema);this.get("rightColumns").reset(b);var c=this.selectedItemFor("leftColumns");c&&this.disableRightColumnsNotMatchingType(c.get("type"))},disableRightColumnsNotMatchingType:function(a){this.get("rightColumns").each(function(b){var c=b.get("type")!==a;c&&b.get("selected")&&b.set("selected",!1),b.set("disabled",c)})},assertIfReadyForNextStep:function(){var a=!!(this.selectedItemFor("leftColumns")&&this.selectedItemFor("rightColumns")&&this.get("rightTableData"));this.set("isReadyForNextStep",a)},nextStep:function(){return new this.constructor.nextStep({user:this.get("user"),leftTable:this.get("leftTable"),leftColumns:this.get("leftColumns"),leftKeyColumn:this.selectedItemFor("leftColumns").clone(),rightKeyColumn:this.selectedItemFor("rightColumns").clone(),rightColumns:this.get("rightColumns"),rightTableData:this.get("rightTableData")})},selectedItemFor:function(a){return this.get(a).find(function(a){return a.get("selected")})},_initColumns:function(){var a=this._filterColumns(this.get("leftTable").get("schema"));this.set("leftColumns",new f.Collection(a)),this.set("rightColumns",new f.Collection([]))},_filterColumns:function(a){var b=this.get("excludeColumns");return e.chain(a).map(function(a){return{name:a[0],type:a[1]}}).reject(function(a){return e.contains(b,a.name)}).value()},_resetSorting:function(a){a.comparator=function(a){return a.get("name")},a.sort()}},{header:{icon:"CDB-IconFont-play",title:"Choose merge column"},nextStep:i})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./choose_key_columns_view":170,"./select_columns_model":174}],170:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("../columns_selector_view"),g=a("../tables_selector_view"),h=a("../footer_view"),i=a("./footer_info_view");b.exports=e.core.View.extend({initialize:function(){this._initViews(),this._initBinds()},render:function(){var a=d(this.getTemplate("common/dialogs/merge_datasets/column_merge/choose_key_columns")({leftTableName:this.model.get("leftTable").get("name")}));return a.find(".js-left-table").append(this._leftTableComboView.render().$el),a.find(".js-left-columns").append(this._leftColumnsView.render().$el),a.find(".js-right-tables").append(this._rightTableSelectorView.render().$el),a.find(".js-right-columns").append(this._rightColumnsView.render().$el),a.append(this._footerView.render().$el),this.$el.html(a),this},_initViews:function(){var a=this.model.get("leftTable").get("name");this._leftTableComboView=new e.forms.Combo({className:"Select",width:"100%",disabled:!0,extra:[a]}),this.addView(this._leftTableComboView),this._leftColumnsView=new f({collection:this.model.get("leftColumns"),excludeFilter:this._columnsExcludeFilter,selectorType:"radio"}),this.addView(this._leftColumnsView),this._rightTableSelectorView=new g({excludeFilter:function(b){return b.get("name")===a}}),this.addView(this._rightTableSelectorView),this._rightColumnsView=new f({collection:this.model.get("rightColumns"),excludeFilter:this._columnsExcludeFilter,selectorType:"radio",loading:"datasets"}),this.addView(this._rightColumnsView),this._footerView=new h({model:this.model,infoView:new i({model:this.model})}),this.addView(this._footerView)},_columnsExcludeFilter:function(a){return"the_geom"===a.get("name")},_initBinds:function(){var a=this.model.get("leftColumns");a.bind("change:selected",this._onChangeSelectedLeftColumn,this),this.add_related_model(a);var b=this.model.get("rightColumns");b.bind("change:selected",this._onChangeSelectedRightColumn,this),b.bind("reset",this._assertIfReadyForNextStep,this),this.add_related_model(b);var c=this._rightTableSelectorView.model;c.bind("change:tableData",this._onChangeRightTableData,this),this.add_related_model(c)},_onChangeSelectedLeftColumn:function(a,b){b&&this.model.disableRightColumnsNotMatchingType(a.get("type")),this._assertIfReadyForNextStep()},_onChangeSelectedRightColumn:function(){this._assertIfReadyForNextStep()},_assertIfReadyForNextStep:function(){this.model.assertIfReadyForNextStep()},_onChangeRightTableData:function(a,b){this._rightColumnsView.model.set("loading","columns"),this.model.changeRightTable(b)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../columns_selector_view":177,"../footer_view":178,"../tables_selector_view":195,"./footer_info_view":172}],171:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("./choose_key_columns_model");b.exports=e.core.Model.extend({ILLUSTRATION_ICON_TYPE:"IllustrationIcon--alert",ICON:"CDB-IconFont-mergeColumns",TITLE:"Column join",DESC:"Merge two datasets based on a shared value (ex. ISO codes in both datasets)",defaults:{user:void 0,table:void 0,excludeColumns:[]},initialize:function(a){if(!a.table)throw new Error("table is required");a.excludeColumns&&!d.isEmpty(a.excludeColumns)||e.log.error("excludeColumns was empty")},isAvailable:function(){return d.chain(this.get("table").get("schema")).map(this._columnDataName).difference(this.get("excludeColumns")).any(this._isntTheGeomName).value()},_columnDataName:function(a){return a[0]},_isntTheGeomName:function(a){return"the_geom"!==a},firstStep:function(){return new f({user:this.get("user"),leftTable:this.get("table"),excludeColumns:this.get("excludeColumns")})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./choose_key_columns_model":169}],172:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({initialize:function(){this._initBinds()},render:function(){var a=this.model.get("leftKeyColumn"),b=this.model.get("rightKeyColumn");return this.$el.html(this.getTemplate("common/dialogs/merge_datasets/column_merge/footer_info")({leftKeyColumnName:a?a.get("name"):"",rightKeyColumnName:b?b.get("name"):""})),this},_initBinds:function(){if(this.model.selectedItemFor){var a=this.model.get("leftColumns");a.bind("change:selected",this._onChangeLeftColumn,this),this.add_related_model(a);var b=this.model.get("rightColumns");b.bind("change:selected",this._onChangeRightColumn,this),this.add_related_model(b)}},_onChangeLeftColumn:function(){var a=this.model.selectedItemFor("leftColumns");this.$(".js-left-key-column").text(a?a.get("name"):"")},_onChangeRightColumn:function(){var a=this.model.selectedItemFor("rightColumns");this.$(".js-right-key-column").text(a?a.get("name"):"").toggleClass("is-placeholder",!a)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],173:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d=function(a,b,c){return"the_geom"===c?["CASE WHEN "+a+"."+c+" IS NULL THEN",b+"."+c,"ELSE",a+"."+c,"END AS",c]:[a+"."+c]};b.exports=function(a){var b=a.leftTableName,e=a.leftColumnsNames,f=a.leftKeyColumnName,g=a.leftKeyColumnType,h=a.rightTableName,i=a.rightColumnsNames,j=a.rightKeyColumnName,k=a.rightKeyColumnType,l=["SELECT"],m=c.map(e,function(a){return d(b,h,a).join(" ")});return m.push.apply(m,c.map(i,function(a){var f=d(h,b,a),g=c.any(e,function(b){return a===b});return g&&(f=f.concat("AS "+h+"_"+a)),f.join(" ")})),l.push(c.flatten(m).join(", ")),l.push("FROM "+b+" FULL OUTER JOIN "+h+" ON"),"string"===g&&"string"===k?l.push("LOWER(TRIM("+b+"."+f+"))","=","LOWER(TRIM("+h+"."+j+"))"):l.push(b+"."+f,"=",h+"."+j),l.join(" ")}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],174:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./select_columns_view"),f=a("./generate_column_merge_sql"),g=a("../merge_step_model");b.exports=d.core.Model.extend({INSTRUCTIONS_SAFE_HTML:"Choose other columns you want in your dataset.",defaults:{user:void 0,isReadyForNextStep:!0,leftTable:void 0,leftKeyColumn:void 0,leftColumns:void 0,rightTableData:void 0,rightColumns:void 0,rightKeyColumn:void 0},createView:function(){return this.set("gotoNextStep",!1),this._resetColumns(this.get("leftColumns"),function(a){a.set("selected",!0)}),this._resetColumns(this.get("rightColumns"),function(a){"the_geom"!==a.get("name")&&a.set("selected",!0),a.set("disabled",!1)}),new e({model:this})},onlyAllowOneSelectedTheGeomColumn:function(a,b){if("the_geom"===a.get("name")){var c=this._theGeomColumnFor("leftColumns"),d=this._theGeomColumnFor("rightColumns");a===c?(c.set("selected",b),d.set("selected",!b)):a===d&&(c.set("selected",!b),d.set("selected",b))}},nextStep:function(){var a=this.get("leftKeyColumn"),b=this.get("rightKeyColumn"),c=f({leftTableName:this.get("leftTable").get("name"),leftKeyColumnName:a.get("name"),leftKeyColumnType:a.get("type"),leftColumnsNames:this._selectedColumnsNamesFor("leftColumns"),rightTableName:this.get("rightTableData").name,rightKeyColumnName:b.get("name"),rightKeyColumnType:b.get("type"),rightColumnsNames:this._selectedColumnsNamesFor("rightColumns")});return new this.constructor.nextStep({user:this.get("user"),tableName:this.get("leftTable").get("name"),sql:c})},_selectedColumnsNamesFor:function(a){return this.get(a).chain().filter(function(a){return a.get("selected")}).map(function(a){return a.get("name")}).value()},_theGeomColumnFor:function(a){return this.get(a).find(function(a){return"the_geom"===a.get("name")})},_resetColumns:function(a,b){a.comparator=function(a){var b=a.get("name");return"the_geom"===b?"00000":b},a.each(b,this),a.sort()}},{header:{icon:"CDB-IconFont-wizard",title:"Choose the rest to add"},nextStep:g})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../merge_step_model":182,"./generate_column_merge_sql":173,"./select_columns_view":175}],175:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("../columns_selector_view"),g=a("../sticky_header_view"),h=a("../footer_view"),i=a("./footer_info_view");b.exports=e.core.View.extend({initialize:function(){this._initViews(),this._initBinds()},render:function(){var a=d(this.getTemplate("common/dialogs/merge_datasets/column_merge/select_columns")({leftKeyColumn:this.model.get("leftKeyColumn"),rightKeyColumn:this.model.get("rightKeyColumn")}));return a.find(".js-sticky-header").append(this._stickyHeaderView.render().$el),a.find(".js-left-table").append(this._leftTableComboView.render().$el),a.find(".js-left-columns").append(this._leftColumnsView.render().$el),a.find(".js-right-table").append(this._rightTableComboView.render().$el),a.find(".js-right-columns").append(this._rightColumnsView.render().$el),a.append(this._footerView.render().$el),this.$el.html(a),this},onChangeKeyColumnsVisiblity:function(){this._stickyHeaderView.$el.slideToggle(200)},_initViews:function(){this._stickyHeaderView=new g({leftKeyColumn:this.model.get("leftKeyColumn"),rightKeyColumn:this.model.get("rightKeyColumn")}),this.addView(this._stickyHeaderView),this._leftTableComboView=new e.forms.Combo({className:"Select",width:"100%",disabled:!0,extra:[this.model.get("leftTable").get("name")]}),this.addView(this._leftTableComboView),this._leftColumnsView=new f({collection:this.model.get("leftColumns"),selectorType:"switch"}),this.addView(this._leftColumnsView),this._rightTableComboView=new e.forms.Combo({className:"Select",width:"100%",disabled:!0,extra:[this.model.get("rightTableData").name]}),this.addView(this._rightTableComboView),this._rightColumnsView=new f({collection:this.model.get("rightColumns"),selectorType:"switch"}),this.addView(this._rightColumnsView),this._footerView=new h({model:this.model,nextLabel:"Merge datasets",infoView:new i({model:this.model})}),this.addView(this._footerView)},_initBinds:function(){this.model.get("leftColumns").bind("change:selected",this._onChangeSelectedColumn,this),this.add_related_model(this.model.get("leftColumns")),this.model.get("rightColumns").bind("change:selected",this._onChangeSelectedColumn,this),this.add_related_model(this.model.get("rightColumns"))},_onChangeSelectedColumn:function(a,b){this.model.onlyAllowOneSelectedTheGeomColumn(a,b)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../columns_selector_view":177,"../footer_view":178,"../sticky_header_view":194,"./footer_info_view":172}],176:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"List-row",events:{click:"_onClick",mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave"},initialize:function(){if(!this.options.selectorType)throw new Error("selectorType is required");this.model=new c.core.Model({type:this.options.selectorType}),this.column=this.options.column,this._initBinds()},render:function(){return this.$el.html(this.getTemplate("common/dialogs/merge_datasets/column_selector")({selectorType:this.model.get("type"),columnName:this.column.get("name"),columnType:this.column.get("type")})),this._tooltip||(this._tooltip=new c.common.TipsyTooltip({el:this.el,offset:-20,trigger:"manual",fallback:"Your column type is not compatible with the column you have selected in the left column"}),this.addView(this._tooltip)),this._onChangeSelected(this.column,this.column.get("selected")),this._onChangeDisabled(this.column,this.column.get("disabled")),this},_initBinds:function(){this.column.bind("change:selected",this._onChangeSelected,this),this.column.bind("change:disabled",this._onChangeDisabled,this),this.add_related_model(this.column)},_onChangeSelected:function(a,b){"radio"===this.model.get("type")&&this.$el.toggleClass("is-selected",!!b),this.$(".js-radio").toggleClass("is-checked",!!b),this.$(".js-switch").prop("checked",!!b)},_onChangeDisabled:function(a,b){b=!!b,this.$el.toggleClass("is-disabled",b)},_onClick:function(a){if(this.killEvent(a),!this._isDisabled()){var b=!this.column.get("selected");(b||"radio"!==this.model.get("type"))&&this.column.set("selected",b)}},_onMouseEnter:function(){this._isDisabled()&&this._tooltip.showTipsy()},_onMouseLeave:function(){this._tooltip.hideTipsy()},_isDisabled:function(){return this.column.get("disabled")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],177:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("./column_selector_view"),g=a("../../view_helpers/random_quote");b.exports=e.core.View.extend({className:"List",events:{"click .js-select-all":"_onClickSelectAll",click:"killEvent"},initialize:function(){this.model=new e.core.Model({showSelectAllToggle:"switch"===this.options.selectorType||!1,enforceSingleSelected:"radio"===this.options.selectorType||!1,loading:this.options.loading}),this._initBinds()},render:function(){if(this.clearSubViews(),this.$el.html(""),this.collection.length>0){var a=this.collection.chain();this.options.excludeFilter&&(a=a.reject(this.options.excludeFilter)),a.each(this._addColumnSelectorView,this),this._renderSelectAllToggle()}else this.model.get("loading")&&this._renderLoading();return this},_renderLoading:function(){this.$el.html(this.getTemplate("common/templates/loading")({title:"Fetching "+this.model.get("loading"),quote:g()}))},_addColumnSelectorView:function(a){var b=new f(d.chain({column:a}).extend(this.options).omit(["el","collection"]).value());this.addView(b),this.$el.append(b.render().$el)},_renderSelectAllToggle:function(){this.model.get("showSelectAllToggle")&&this.$el.append(this.getTemplate("common/dialogs/merge_datasets/columns_selector_toggle_all")({areAllSelected:this._areAllSelected()}))},_initBinds:function(){this.collection.bind("reset",this.render,this),this.collection.bind("change:selected",this._onChangeSelected,this),this.add_related_model(this.collection),this.model.bind("change:loading",this.render,this)},_onChangeSelected:function(a,b){b&&this.model.get("enforceSingleSelected")&&(this._unselectAllExcept(a),this.collection.sort(),this.render()),this.$(".js-select-all input").prop("checked",this._areAllSelected())},_unselectAllExcept:function(a){this.collection.each(function(b){b!==a&&b.set("selected",!1)})},_onClickSelectAll:function(){var a=!this._areAllSelected();this.collection.chain().reject(function(a){return a.get("disabled")}).each(function(b){b.set("selected",a)})},_areAllSelected:function(){return this.collection.all(function(a){return a.get("selected")})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_helpers/random_quote":241,"./column_selector_view":176}],178:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({events:{"click .js-next":"_onClickNext"},initialize:function(){this.options.infoView&&this.addView(this.options.infoView),this._initBinds()},render:function(){return this.$el.html(this.getTemplate("common/dialogs/merge_datasets/footer")({nextLabel:this.options.nextLabel||"next step"})),this._onChangeIsReadyForNextStep(this.model,this.model.get("isReadyForNextStep")),this._maybeRenderInfoView(),this},_maybeRenderInfoView:function(){this.options.infoView&&this.$(".js-info").append(this.options.infoView.render().$el)},_initBinds:function(){this.model.bind("change:isReadyForNextStep",this._onChangeIsReadyForNextStep,this)},_onChangeIsReadyForNextStep:function(a,b){this.$(".js-next").toggleClass("is-disabled",!b)},_onClickNext:function(){this.model.get("isReadyForNextStep")&&this.model.set("gotoNextStep",!0)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],179:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,g=a("./column_merge/column_merge_model"),h=a("./spatial_merge/spatial_merge_model");b.exports=f.core.Model.extend({excludeColumns:["cartodb_id","created_at","updated_at","the_geom_webmercator","cartodb_georef_status"],defaults:{mergeFlavors:void 0,prevSteps:[],currentStep:void 0,table:void 0,user:void 0},initialize:function(a){if(!a.table)throw new Error("table is required");if(!a.user)throw new Error("user is required");var b={user:this.get("user"),table:this.get("table"),excludeColumns:this.excludeColumns};this.set("mergeFlavors",new e.Collection([new g(b),new h(b)]))},headerSteps:function(){var a=[],b=this.get("currentStep"),c=this.get("prevSteps")[0]||b,e=!0;if(c)for(var f=c.constructor;f;){if(f.header){var g=f===b.constructor;g&&(e=!1),a.push(d.extend({isFinished:e,isCurrent:g},f.header))}f=f===f.nextStep?void 0:f.nextStep}return a},gotoNextStep:function(){var a=this.get("currentStep"),b=a.nextStep();this.set({prevSteps:this.get("prevSteps").concat(a),currentStep:b})},gotoPrevStep:function(){this.set("currentStep",this.get("prevSteps").pop())}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./column_merge/column_merge_model":171,"./spatial_merge/spatial_merge_model":192}],180:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f=a("../../views/base_dialog/view.js"),g=a("./merge_datasets_model.js"),h=a("./merge_flavor_view");b.exports=f.extend({events:f.extendEvents({"click .js-back":"_onBackClick"}),initialize:function(){this.options.clean_on_hide=!0,this.options.enter_to_confirm=!1,this.elder("initialize"),this.model=new g({table:this.options.table,user:this.options.user}),this._initBinds()},render:function(){if(f.prototype.render.apply(this,arguments),this.$(".content").addClass("Dialog-contentWrapper"),this.$(".js-scroll").off("scroll"),this._stepView&&this._stepView.onChangeKeyColumnsVisiblity){this._areKeyColumnsVisible=!0;var a=this;this.$(".js-scroll").on("scroll",function(b){var c=b.target.scrollTop<=175;c!==a._areKeyColumnsVisible&&(a._areKeyColumnsVisible=c,a._stepView.onChangeKeyColumnsVisiblity(c))})}return this},render_content:function(){this.clearSubViews();var a,b=this.getTemplate("common/dialogs/merge_datasets/merge_datasets_content"),c=this.model.get("currentStep");if(c){var d=this._$renderedStep(c);if(c.get("skipDefaultTemplate"))return d;a=e(b({currentStep:c,headerSteps:this.model.headerSteps()})),a.find(".js-details").append(d)}else{a=e(b({currentStep:void 0}));var f=a.find(".js-flavors");f.append.apply(f,this._$renderedMergeFlavors())}return a},_$renderedMergeFlavors:function(){return this.model.get("mergeFlavors").map(function(a){var b=new h({model:a});return this.addView(b),b.render().$el},this)},_onChangeSelectedMergeFlavor:function(a,b){if(b){a.unset("selected");var c=a.firstStep();this.model.set("currentStep",c),cdb.god.trigger("metrics","visual_merge",{email:window.user_data.email})}},_initBinds:function(){var a=this.model.get("mergeFlavors");a.bind("change:selected",this._onChangeSelectedMergeFlavor,this),this.add_related_model(a),this.model.bind("change:currentStep",this.render,this)},_onChangeGotoNextStep:function(a,b){b&&this.model.gotoNextStep()},_$renderedStep:function(a){return this._stepView&&(this._stepView.clean(),this.removeView(this._stepView),this._stepModel.unbind("change:gotoNextStep"),this._models=d.without(this._models,this._stepModel)),this._stepModel=a,this._stepModel.bind("change:gotoNextStep",this._onChangeGotoNextStep,this),this.add_related_model(this._stepModel),this._stepView=a.createView(),this._stepView.bind("clickedNext",this._onClickNext,this),this.addView(this._stepView),this._stepView.render().$el},_onClickNext:function(a){this.killEvent(a),this.model.gotoNextStep()},_onBackClick:function(a){this.killEvent(a),this.model.gotoPrevStep()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../views/base_dialog/view.js":242,"./merge_datasets_model.js":179,"./merge_flavor_view":181}],181:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"OptionCard OptionCard--blocky",events:{click:"_onClick"},render:function(){return this.$el.html(this.getTemplate("common/dialogs/merge_datasets/merge_flavor")({illustrationIconType:this.model.ILLUSTRATION_ICON_TYPE,icon:this.model.ICON,title:this.model.TITLE,desc:this.model.DESC})),this.model.isAvailable()||this.$el.addClass("is-disabled"),this},_onClick:function(a){this.killEvent(a),this.model.isAvailable()&&this.model.set("selected",!0)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],182:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./merge_step_view");b.exports=d.core.Model.extend({defaults:{skipDefaultTemplate:!0,user:void 0,tableName:"",sql:void 0},createView:function(){return new e({model:this})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./merge_step_view":183}],183:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,g=a("../../view_helpers/random_quote.js"),h=a("../../views/error_details_view");b.exports=f.core.View.extend({initialize:function(){d.bindAll(this,"_onMergeSuccess","_onMergeError"),this._startMerge()},render:function(){return this.$el.html(this.getTemplate("common/templates/loading")({
title:"Merging datasets and generating the new one…",quote:g()})),this},_startMerge:function(){e.ajax({type:"POST",url:f.config.prefixUrl()+"/api/v1/imports",data:{table_name:this.model.get("tableName")+"_merge",sql:this.model.get("sql")},success:this._onMergeSuccess,error:this._onMergeError})},_onMergeSuccess:function(a){var b=this.importation=new f.admin.Import({item_queue_id:a.item_queue_id});this.add_related_model(b),b.bind("importComplete",function(){b.unbind(),window.location.href=f.config.prefixUrl()+"/tables/"+(b.get("table_name")||b.get("table_id"))+"/"},this);var c=this;b.bind("importError",function(a){c._showError(a.attributes.error_code,a.attributes.get_error_text.title,a.attributes.get_error_text.what_about,a.attributes.item_queue_id)},this),b.pollCheck()},_onMergeError:function(a){try{this._showError(a.attributes.error_code,a.attributes.get_error_text.title,a.attributes.get_error_text.what_about,a.attributes.item_queue_id)}catch(a){this._showError("99999","Unknown","")}},_showError:function(a,b,c,d){var e=new h({err:{error_code:a,title:b,what_about:c,item_queue_id:d},user:this.model.get("user")});this.addView(e),this.$el.html(e.render().el)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_helpers/random_quote.js":241,"../../views/error_details_view":254}],184:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./spatial_merge_view"),f=a("../merge_step_model"),g=a("./generate_spatial_merge_sql");b.exports=d.core.Model.extend({INSTRUCTIONS_SAFE_HTML:"Calculate the intersecting geospatial records between two datasets (ex. points in polygons).<br/>You'll need to decide the operation to perform here.",defaults:{isReadyForNextStep:!1,user:void 0,mergeMethods:void 0,leftTable:void 0,leftKeyColumn:void 0,leftColumns:void 0,rightTableData:void 0,rightKeyColumn:void 0,rightColumns:void 0},createView:function(){return this.set("gotoNextStep",!1),this.get("mergeMethods").each(function(a){a.set("disabled",!this.isCountMergeMethod(a))},this),this.get("rightColumns").comparator=function(a){return a.get("name")},new e({model:this})},selectedMergeMethod:function(){return this.get("mergeMethods").find(this._isSelectedColumn)},selectedRightMergeColumn:function(){return this.get("rightColumns").find(this._isSelectedColumn)},changedRightMergeColumn:function(a){this._updateMergeMethods(a),this._assertIfReadyForNextStep()},changedSelectedMergeMethod:function(a){var b=this.get("mergeMethods").chain().without(a);b.each(this._deselect),this.isCountMergeMethod(a)?(b.each(this._enable),this.get("rightColumns").each(this._deselect)):this._updateMergeMethods(this.selectedRightMergeColumn()),this._assertIfReadyForNextStep()},_updateMergeMethods:function(a){this.get("mergeMethods").each(function(b){b.changedMergeColumn(a)})},isCountMergeMethod:function(a){return a&&"count"===a.NAME},nextStep:function(){return new this.constructor.nextStep({user:this.get("user"),tableName:this.get("leftTable").get("name"),sql:this._sqlForMergeMethod()})},_deselect:function(a){a.set("selected",!1)},_disable:function(a){a.set("disabled",!0)},_enable:function(a){a.set("disabled",!1)},_assertIfReadyForNextStep:function(){var a=this.selectedMergeMethod(),b=a&&(this.isCountMergeMethod(a)||!a.get("disabled")&&this.selectedRightMergeColumn());this.set("isReadyForNextStep",b)},_sqlForMergeMethod:function(){var a=this.get("rightTableData").name,b=this.selectedMergeMethod(),c=this.selectedRightMergeColumn(),d=b.sqlSelectClause(a,c?c.get("name"):"");return g({leftTableName:this.get("leftTable").get("name"),leftColumnsNames:this._selectedLeftColumnsNames(),rightTableName:a,selectClause:d,intersectType:b.NAME})},_selectedLeftColumnsNames:function(){return this.get("leftColumns").filter(this._isSelectedColumn).map(function(a){return a.get("name")})},_isSelectedColumn:function(a){return a.get("selected")}},{header:{icon:"CDB-IconFont-wizard",title:"Choose merge columns"},nextStep:f})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../merge_step_model":182,"./generate_spatial_merge_sql":187,"./spatial_merge_view":193}],185:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,g="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,h=a("./merge_methods/sum_merge_method"),i=a("./merge_methods/avg_merge_method"),j=a("./merge_methods/count_merge_method"),k=a("./spatial_merge_view"),l=a("./choose_merge_method_model");b.exports=d.core.Model.extend({INSTRUCTIONS_SAFE_HTML:"Calculate the intersecting geospatial records between two datasets (ex. points in polygons).<br/>You'll need to decide the operation to perform here.",defaults:{user:void 0,leftTable:void 0,excludeColumns:void 0,leftKeyColumn:void 0,leftColumns:void 0,mergeMethods:void 0,rightTableData:void 0,rightColumns:void 0},initialize:function(a){if(!a.leftTable)throw new Error("leftTable is required");a.excludeColumns&&!f.isEmpty(a.excludeColumns)||d.log.error("excludeColumns was empty"),this._initColumns(),this._initLeftKeyColumn(),this._initMergeMethods()},createView:function(){return this.set({gotoNextStep:!1,rightTableData:void 0}),this.get("mergeMethods").each(function(a){a.set({selected:!1,disabled:!0})}),this.get("rightColumns").reset(),new k({model:this})},assertIfReadyForNextStep:function(){return!1},fetchRightColumns:function(a){this.set("rightTableData",a),e.ajax({url:d.config.prefixUrl()+"/api/v1/tables/"+a.id,dataType:"jsonp",success:this._onFetchedRightColumns.bind(this)})},nextStep:function(){return new this.constructor.nextStep({user:this.get("user"),mergeMethods:this.get("mergeMethods"),leftTable:this.get("leftTable"),leftKeyColumn:this.get("leftKeyColumn"),leftColumns:this.get("leftColumns"),rightTableData:this.get("rightTableData"),rightKeyColumn:this._rightKeyColumn(),rightColumns:this.get("rightColumns")})},_initColumns:function(){var a=this._filterColumns(this.get("leftTable").get("schema"));this.set("leftColumns",new g.Collection(a)),this.set("rightColumns",new g.Collection)},_initMergeMethods:function(){var a=new g.Collection([new h,new j,new i]);this.set("mergeMethods",a)},_filterColumns:function(a){var b=this.get("excludeColumns");return f.chain(a).map(this._columnDataToColumn).reject(function(a){return f.contains(b,a.name)}).value()},_columnDataToColumn:function(a){return{name:a[0],type:a[1]}},_initLeftKeyColumn:function(){var a=this.get("leftColumns").find(this._isColumnTheGeom);this.set("leftKeyColumn",a.clone())},_onFetchedRightColumns:function(a){var b=this._filterColumns(a.schema);this.get("rightColumns").reset(b,{silent:!0}),this.set("gotoNextStep",!0)},_rightKeyColumn:function(){return this.get("rightColumns").find(this._isColumnTheGeom).clone()},_isColumnTheGeom:function(a){return"the_geom"===a.get("name")}},{header:{icon:"CDB-IconFont-play",title:"Choose dataset to merge"},nextStep:l})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./choose_merge_method_model":184,"./merge_methods/avg_merge_method":189,"./merge_methods/count_merge_method":190,"./merge_methods/sum_merge_method":191,"./spatial_merge_view":193}],186:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({initialize:function(){this._initBinds()},render:function(){var a=this.model.get("rightColumns");return this.$el.html(this.getTemplate("common/dialogs/merge_datasets/spatial_merge/footer_info")({leftTableName:this.model.get("leftTable").get("name"),rightColumnName:a?a.get("name"):""})),this},_initBinds:function(){var a=this.model.get("rightColumns");a.bind("change:selected",this._updatePieces,this),this.add_related_model(a);var b=this.model.get("mergeMethods");b.bind("change:selected",this._updatePieces,this),this.add_related_model(b)},_updatePieces:function(){var a=this.model.selectedMergeMethod();if(this.$(".js-merge-method-name").text(a?a.NAME:""),this.model.isCountMergeMethod(a))this._changeRightPiece(this.model.get("rightTableData").name);else{var b=this.model.selectedRightMergeColumn();this._changeRightPiece(b?b.get("name"):"")}},_changeRightPiece:function(a){this.$(".js-right").text(a||"").toggleClass("is-placeholder",!a)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],187:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=function(a){var b=a.leftTableName,d=a.leftColumnsNames,e=a.rightTableName,f=a.selectClause,g=a.intersectType,h=["SELECT",b+".cartodb_id,",b+".the_geom_webmercator,",b+".the_geom,"];return c.each(d,function(a){"the_geom"!==a&&h.push(b+"."+a+",")}),h.push("(SELECT "+f+" FROM "+e,"WHERE ST_Intersects("+b+".the_geom, "+e+".the_geom)",") AS intersect_"+g,"FROM "+b),h.join(" ")}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],188:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"TabLink TabLink--positive TabLink--textCenterUpcase",events:{hover:"_onHover",mouseout:"_onMouseOut",click:"_onClick"},initialize:function(){this._initBinds()},render:function(){var a=this.model.get("disabled");return this.$el.text(this.model.NAME).toggleClass("disabled",a).toggleClass("selected",this.model.get("selected")&&!a),a&&this._tooltipView().show(),this},_tooltipView:function(){return this._tooltip||(this._tooltip=new c.common.TipsyTooltip({el:this.$el,trigger:"manual",title:function(){return"Select a column of type number to use this merge method"}}),this.addView(this._tooltip)),this._tooltip},_initBinds:function(){this.model.bind("change:selected",this.render,this),this.model.bind("change:disabled",this.render,this)},_onHover:function(a){this.killEvent(a),this.model.get("disabled")&&this._tooltip.showTipsy()},_onMouseOut:function(a){this.killEvent(a),this._tooltip&&this._tooltip.hideTipsy()},_onClick:function(a){this.killEvent(a),this.model.get("disabled")||this.model.set("selected",!0)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],189:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({NAME:"avg",defaults:{disabled:!1,selected:!1},changedMergeColumn:function(a){var b=!a||"number"!==a.get("type");this.set({disabled:b,selected:this.get("selected")&&!b})},sqlSelectClause:function(a,b){return"AVG("+a+"."+b+")"}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],190:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({NAME:"count",defaults:{disabled:!1,selected:!1},changedMergeColumn:function(a){},sqlSelectClause:function(){return"COUNT(*)"}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],191:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({NAME:"sum",defaults:{disabled:!1,selected:!1},changedMergeColumn:function(a){var b=!a||"number"!==a.get("type");this.set({disabled:b,selected:this.get("selected")&&!b})},sqlSelectClause:function(a,b){return"SUM("+a+"."+b+")"}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],192:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./choose_right_dataset_model");b.exports=d.core.Model.extend({ILLUSTRATION_ICON_TYPE:"IllustrationIcon--royal",ICON:"CDB-IconFont-mergeSpatial",TITLE:"Spatial join",DESC:"Measure the number of intesecting records between two datasets (ex. count point inside polygons)",defaults:{user:void 0,table:void 0,excludeColumns:[]},initialize:function(a){if(!a.user)throw new Error("user is required");if(!a.table)throw new Error("table is required");a.excludeColumns&&!e.isEmpty(a.excludeColumns)||d.log.error("excludeColumns was empty")},isAvailable:function(){return!0},firstStep:function(){return new f({user:this.get("user"),leftTable:this.get("table"),excludeColumns:this.get("excludeColumns")})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./choose_right_dataset_model":185}],193:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,g=a("../columns_selector_view"),h=a("../tables_selector_view"),i=a("./merge_method_view"),j=a("../sticky_header_view"),k=a("../footer_view"),l=a("./footer_info_view");b.exports=f.core.View.extend({initialize:function(){this._initViews(),this._initBinds()},render:function(){var a=this._hasSelectedRightTable(),b=d(this.getTemplate("common/dialogs/merge_datasets/spatial_merge/spatial_merge")({leftKeyColumn:this.model.get("leftKeyColumn"),hasSelectedRightTable:a,rightKeyColumn:this.model.get("rightKeyColumn"),rightColumns:this.model.get("rightColumns")}));return b.find(".js-left-table").append(this._leftTableComboView.render().$el),b.find(".js-left-columns").append(this._leftColumnsView.render().$el),b.find(".js-right-columns").append(this._rightColumnsView.render().$el),b.append(this._footerView.render().$el),a?(b.find(".js-sticky-header").append(this._stickyHeaderView.render().$el),b.find(".js-right-table").append(this._rightTableComboView.render().$el),this._renderMergeMethods(b.find(".js-merge-methods"))):b.find(".js-right-tables").append(this._rightTablesSelectorView.render().$el),this.$el.html(b),this},onChangeKeyColumnsVisiblity:function(){this._hasSelectedRightTable()&&this._stickyHeaderView.$el.slideToggle(200)},_hasSelectedRightTable:function(){return e.isObject(this.model.get("rightTableData"))},_initViews:function(){this._leftTableComboView=new f.forms.Combo({className:"Select",width:"100%",disabled:!0,extra:[this.model.get("leftTable").get("name")]}),this.addView(this._leftTableComboView),this._leftColumnsView=new g({collection:this.model.get("leftColumns"),excludeFilter:this._columnsExcludeFilter,selectorType:"switch"}),this.addView(this._leftColumnsView);var a,b=this.model.get("rightTableData");b?(this._stickyHeaderView=new j({leftKeyColumn:this.model.get("leftKeyColumn"),rightKeyColumn:this.model.get("rightKeyColumn"),addRadioPlaceholder:!0}),this.addView(this._stickyHeaderView),this._rightTableComboView=new f.forms.Combo({className:"Select",width:"100%",disabled:!0,extra:[this.model.get("rightTableData").name]}),this.addView(this._rightTableComboView),a=new l({model:this.model})):(this._rightTablesSelectorView=new h({excludeFilter:this._rightTablesExcludeFilter.bind(this),initialOption:{label:b?b.name:"Select dataset"}}),this.addView(this._rightTablesSelectorView)),this._rightColumnsView=new g({collection:this.model.get("rightColumns"),excludeFilter:this._columnsExcludeFilter,selectorType:"radio"}),this.addView(this._rightColumnsView),this._mergeMethodViews=this.model.get("mergeMethods").map(this._createMergeMethodView,this),this._footerView=new k({model:this.model,nextLabel:b?"Merge datasets":void 0,infoView:a}),this.addView(this._footerView)},_createMergeMethodView:function(a){var b=new i({model:a});return this.addView(b),b},_initBinds:function(){var a=this.model.get("rightColumns");a.bind("change:selected",this._onChangeSelectedRightColumn,this),this.add_related_model(a);var b=this.model.get("mergeMethods");b&&(b.bind("change:selected",this._onChangeSelectedMergeMethod,this),this.add_related_model(b)),this._rightTablesSelectorView&&(this._rightTablesSelectorView.model.bind("change:tableData",this._onChangeRightTableData,this),this.add_related_model(this._rightTablesSelectorView.model))},_onChangeRightTableData:function(a,b){this._rightColumnsView.model.set("loading","columns"),this.model.fetchRightColumns(b)},_onChangeSelectedRightColumn:function(a,b){b&&this.model.changedRightMergeColumn(a)},_onChangeSelectedMergeMethod:function(a,b){if(b){this.model.changedSelectedMergeMethod(a);var c=this.model.isCountMergeMethod(a);this.$(".js-count-merge-method-info").toggle(c),this.$(".js-right-columns").toggle(!c)}},_renderMergeMethods:function(a){a.append.apply(a,this._$renderedMergeMethodViews())},_$renderedMergeMethodViews:function(){return e.map(this._mergeMethodViews,function(a){return a.render().$el})},_columnsExcludeFilter:function(a){return"the_geom"===a.get("name")},_rightTablesExcludeFilter:function(a){return a.get("name")===this.model.get("leftTable").get("name")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../columns_selector_view":177,"../footer_view":178,"../sticky_header_view":194,"../tables_selector_view":195,"./footer_info_view":186,"./merge_method_view":188}],194:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"MergeDatasets-stickyHeader",attributes:{style:"display: none"},render:function(){var a=this.options.leftKeyColumn,b=this.options.rightKeyColumn;return this.$el.html(this.getTemplate("common/dialogs/merge_datasets/sticky_header")({leftColumnName:a.get("name"),leftColumnType:a.get("type"),rightColumnName:b.get("name"),rightColumnType:b.get("type"),addRadioPlaceholder:this.options.addRadioPlaceholder})),this}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],195:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.forms.Combo.extend({className:"Select",initialize:function(){this.options.width="100%",this.options.disabled=!0,this.options.extra=[this._initialOptionDataItem()||"Loading tables…"],this.options.excludeFilter=this.options.excludeFilter||function(){},this.elder("initialize"),this.model=this.model||new d.core.Model,this._initVisualizations(),this._initBinds(),this._fetchTables()},_formatResult:function(a){return JSON.stringify(a)},_initVisualizations:function(){var a=new d.admin.Visualizations;a.options.set({type:"table",per_page:1e5,table_data:!1}),this.model.set("visualizations",a)},_initBinds:function(){this.bind("change",this._onChangeOption,this);var a=this.model.get("visualizations");a.bind("reset",this._onResetTables,this),this.add_related_model(a)},_fetchTables:function(){this.model.get("visualizations").fetch({data:{o:{updated_at:"desc"},exclude_raster:!0}})},_onResetTables:function(){this.options.disabled=!1;var a=this.model.get("visualizations").reject(this.options.excludeFilter),b=c.map(a,this._visToComboDataItem,this),d=this._initialOptionDataItem();d&&b.unshift(d),this.updateData(b);var e=a[0];!d&&e&&this._onChangeOption(e.id)},_visToComboDataItem:function(a){return this._comboDataItem(a.get("name"),a.id)},_initialOptionDataItem:function(){if(c.isObject(this.options.initialOption)){var a=this.options.initialOption;return this._comboDataItem(a.label,a.value)}},_comboDataItem:function(a,b){return[a,b]},_onChangeOption:function(a){var b=this.model.get("visualizations").get(a);this.model.set("tableData",b?b.get("table"):void 0)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],196:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,g=a("cartodb-pecan");b.exports=d.core.View.extend({_CARD_WIDTH:288,_CARD_HEIGHT:170,_TABS_PER_ROW:3,_GET_BBOX_FROM_THE_GEOM:!0,tagName:"li",className:"GalleryList-item MapsList-item js-card",events:{"click ":"_onClick"},initialize:function(){this.template=d.templates.getTemplate("common/dialogs/pecan/card")},render:function(){var a=this.options.url+"?api_key="+this.options.api_key,b=this.model.get("visualizationType").charAt(0).toUpperCase()+this.model.get("visualizationType").slice(1),c=+(this.model.get("null_ratio")*this.model.get("count")).toFixed(2),e=f.formatNumber(c);this.$el.html(this.template({column:this.model.get("column"),wizard:b,metadata:this.model.get("metadata"),null_count:e,weight:this.model.get("weight")})),"choropleth"===this.model.get("visualizationType")&&this._addHistogram();var g=this,h=new Image;return h.onerror=function(){d.log.info("error loading the image for "+g.model.get("column"))},h.onload=function(){g.$(".js-loader").hide(),g.$(".js-header").append('<img class="MapCard-preview" src="'+a+'" />'),g.$("img").show()},h.src=a,this},_onClick:function(a){this.killEvent(a),this.trigger("click",this.model,this)},_addHistogram:function(){var a=this.model.get("cat_hist").slice(0,7);a=e.sortBy(a,function(a){return a[0]});var b=g.getMethodProperties(this.model.attributes).name,c=37,h=11,i=2,j=d3.scale.ordinal().rangeRoundBands([0,c],.1),k=d3.scale.linear().range([h,0]),l=d3.svg.axis().scale(j).orient("bottom"),m=d3.select(this.$(".js-graph")[0]).append("svg").attr("width",c).attr("height",h).append("g");return j.domain(a.map(function(a){return a[0]})),k.domain([0,d3.max(a,function(a){return a[1]})]),m.append("g").attr("class","x axis").attr("transform","translate(0,"+h+")").call(l),m.selectAll(".bar").data(a).enter().append("rect").attr("fill",function(a,c){return d.admin.color_ramps[b][7][c]}).attr("class","HistogramGraph-bar").attr("data-title",function(a){return f.formatNumber(a[1])}).attr("x",function(a){return j(a[0])}).attr("width",4).attr("y",function(a){var b=h-k(a[1]),c=k(a[1]);return b<i?h-i:c}).attr("height",function(a){var b=h-k(a[1]);return b<i?i:b}),this}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"cartodb-pecan":528}],197:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=("undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,a("cartodb-pecan")),f=a("../../views/base_dialog/view"),g=a("../../view_factory"),h=a("../../view_helpers/random_quote"),i=a("./pecan_card");b.exports=f.extend({_CARD_MARGIN:20,_CARD_WIDTH:288,_CARD_HEIGHT:170,_STROKE_PX_LIMIT:.04,_TABS_PER_ROW:3,_GET_BBOX_FROM_THE_GEOM:!0,_DEFAULT_BASEMAP_TEMPLATE:"http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",_SUPPORTED_BASEMAPS:["light_all","dark_all","light_nolabels","dark_nolabels","base-antique","base-flatblue","toner","watercolor"],events:f.extendEvents({"click .js-goPrev":"_prevPage","click .js-goNext":"_nextPage","click .js-skip":"cancel"}),initialize:function(){if(this.elder("initialize"),!this.options.vis)throw new Error("vis is required");if(!this.options.user)throw new Error("user is required");this.columns=this.options.collection,this.add_related_model(this.collection),this._initModels(),this._initViews(),this._initBinds()},render_content:function(){return this._panes.getActivePane().render().el},render:function(){return f.prototype.render.apply(this,arguments),this},_initModels:function(){this.model=new d.core.Model({page:1,maxPages:0})},_initViews:function(){_.bindAll(this,"_addCard","_generateThumbnail","_refreshMapList","_setWizardProperties"),this.vis=this.options.vis,this.map=this.vis.map,this.user=this.options.user,this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("vis",g.createByTemplate("common/dialogs/pecan/template",{})),this._panes.addTab("applying",g.createByTemplate("common/templates/loading",{title:"Applying style…",quote:h()})),this._panes.addTab("loading",g.createByTemplate("common/templates/loading",{title:"Loading previews…",quote:h()})),this._getBBox(),this._sendOpenStats(),this._loadCards()},_initBinds:function(){this.model.bind("change:page",this._moveTabsNavigation,this),this._panes.bind("tabEnabled",this.render,this)},_getBBox:function(){this.columns.each(function(a){"the_geom"===a.get("column")&&(this.bbox=a.get("bbox"))},this)},_loadCards:function(){this.columns.each(this._loadCard,this)},_loadCard:function(a){var b=this;a.get("success")&&this._generateThumbnail(a,function(c,e){c?d.log.error(c):b._addCard(e,a)})},_sendAppliedStats:function(){d.god.trigger("metrics","applied_pecan",{email:window.user_data.email})},_sendOpenStats:function(){d.god.trigger("metrics","open_pecan_list",{email:window.user_data.email})},_skip:function(){var a,b=this.vis.get("active_layer_id"),c=this.vis.map.layers.where({id:b});c&&(a=c[0].table.get("name"));var d="pecan_"+this.options.user.get("username")+"_"+a;localStorage[d]=!0},_nextPage:function(){var a=this.model.get("page"),b=this.model.get("maxPages");a<b&&this.model.set("page",a+1)},_prevPage:function(){var a=this.model.get("page");a>1&&this.model.set("page",a-1)},_moveTabsNavigation:function(){var a=this.model.get("page"),b=960,c=b*(a-1);this.$(".js-map-list").css("margin-left","-"+c+"px"),this._refreshNavigation()},_refreshNavigation:function(){var a=this.model.get("page"),b=this.model.get("maxPages");this.$(".js-goPrev")[a>1?"removeClass":"addClass"]("is-disabled"),this.$(".js-goNext")[a<b?"removeClass":"addClass"]("is-disabled")},_hideNavigation:function(){this.$(".js-navigation").addClass("is-hidden")},_setupCSS:function(a,b){var c=this.options.vis.tableMetadata().get("row_count"),d=c/(this._CARD_WIDTH*this._CARD_HEIGHT),e=d>this._STROKE_PX_LIMIT;return"line"!==b&&e&&(a=a.replace("marker-line-width: 1;","marker-line-width: 0.7;"),a=a.replace("marker-width: 10;","marker-width: 7;")),a},_setupTemplate:function(){var a=this.map.getLayerAt(0).get("urlTemplate");if(a)var b=_.find(this._SUPPORTED_BASEMAPS,function(b){return a.indexOf(b)!==-1});return a&&b||(a=this._DEFAULT_BASEMAP_TEMPLATE),a},_generateLayerDefinition:function(a){var b=a.get("visualizationType"),c=a.get("sql"),e=this._setupCSS(a.get("css"),a.get("geometryType")),f=this.user.get("api_key"),g=d.config.get("maps_api_template"),h=this._setupTemplate(),i={user_name:user_data.username,maps_api_template:g,api_key:f,layers:[{type:"http",options:{urlTemplate:h,subdomains:["a","b","c"]}},{type:"cartodb",options:{sql:c,cartocss:e,cartocss_version:"2.1.1"}}]};return"torque"!==b&&"heatmap"!==b||(i.layers[1]={type:"torque",options:{sql:c,cartocss:e,cartocss_version:"2.1.1"}}),i},_generateThumbnail:function(a,b){var c=this._generateLayerDefinition(a),e=function(a,c){b&&b(a,c)};this.columns.find(function(a){return"the_geom"===a.get("column")});this.bbox&&this._GET_BBOX_FROM_THE_GEOM?d.Image(c).size(this._CARD_WIDTH,this._CARD_HEIGHT).bbox(this.bbox).getUrl(e):d.Image(c).size(this._CARD_WIDTH,this._CARD_HEIGHT).zoom(this.map.get("zoom")).center(this.map.get("center")).getUrl(e)},_addCard:function(a,b){var c=new i({url:a,urlTemplate:this.map.getLayerAt(0).get("urlTemplate"),api_key:this.user.get("api_key"),model:b});c.bind("click",this._onCardClick,this),c.render(),this._panes.active("vis"),this._getSuccessColumns().length<3&&this.$(".js-map-list").addClass("is--centered"),"heatmap"===b.get("visualizationType")||"torque"===b.get("visualizationType")?this.$(".js-map-list").prepend(c.$el):this.$(".js-map-list").append(c.$el),this._refreshMapList(c.$el),this._refreshNavigation()},_refreshMapList:function(a){var b=a.width(),c=this.$(".js-card").length;this.$(".js-map-list").width(b*c+(c-1)*this._CARD_MARGIN),this.model.set("maxPages",Math.ceil(this.$(".js-card").size()/this._TABS_PER_ROW))},_getSuccessColumns:function(){return this.columns.filter(function(a){return a.get("success")})},_bindDataLayer:function(){this.layer.wizard_properties.unbind("load",this._setWizardProperties,this),this.layer.wizard_properties.bind("load",this._setWizardProperties,this)},_getProperties:function(a){var b=a.get("column"),c=this._getWizardName(a.get("visualizationType")),d={property:b};return"category"===c?this._getCategoriesProperties(d):"choropleth"===c?this._getChoroplethProperties(d):"heatmap"===c?this._getHeatmapProperties(d):void 0},_onCardClick:function(a){this._panes.active("applying"),this.model.set("column",a),this._skip(),this.layer=this._getDataLayer(),this._sendAppliedStats();var b=this._getWizardName(a.get("visualizationType")),c=this._getProperties(a);this._bindDataLayer(),this.layer.wizard_properties.active(b,c)},_getWizardName:function(a){var b={heatmap:"torque_heat"};return b[a]||a},_getDataLayer:function(){return this.map.layers.getDataLayers()[0]},_setWizardProperties:function(){var a=this._getProperties(this.model.get("column"));this.layer.wizard_properties.unbind("load",this._setWizardProperties,this),a&&this.layer.wizard_properties.set(a),this.close()},_getChoroplethProperties:function(a){var b=this.model.get("column"),c=(b.get("column"),b.get("type"),b.get("dist_type")),d=b.get("stats");return a.qfunction=this._getQFunction(c),a.color_ramp=e.getMethodProperties(d).name,a},_getCategoriesProperties:function(a){var b=this.model.get("column");return a.metadata=b.get("metadata"),a.categories=b.get("metadata"),a},_getHeatmapProperties:function(a){return a.property="cartodb_id",a["torque-resolution"]=2,a},_getQFunction:function(a){var b="Jenks";return"L"===a||"J"==a?b="Heads/Tails":"A"===a||"U"==a?b="Jenks":"F"===a&&(b="Quantile"),b},_keydown:function(a){a.keyCode===$.ui.keyCode.LEFT?this._prevPage():a.keyCode===$.ui.keyCode.RIGHT&&this._nextPage(),f.prototype._keydown.call(this,a)},clean:function(){this.layer&&this.layer.wizard_properties.unbind("load",this._setWizardProperties,this),f.prototype.clean.call(this)},cancel:function(a){this.killEvent(a),this.model.set("disabled",!0),this._skip(),this.elder("cancel")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"../../view_helpers/random_quote":241,"../../views/base_dialog/view":242,"./pecan_card":196,"cartodb-pecan":528}],198:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;"undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,a("../../views/base_dialog/view"),a("../../view_factory"),a("../../view_helpers/random_quote");b.exports=d.core.View.extend({_MAX_ROWS:1e5,_MAX_COLS:60,_EXCLUDED_COLUMNS:["cartodb_id","lat","lon","lng","long","latitude","longitude","longitudenumber","latitudenumber","minlat","maxlat","minlon","maxlon","minlng","maxlng","center_lat","centerlat","center_lon","centerlon","latdd","longdd","shape_length","shape_area","objectid","id","created_at","updated_at","iso2","iso3","x","y","x_coord","y_coord","xcoord","ycoord","coord_x","coord_y","coordx","coordy","cartodb_georef_status","scalerank","strokweig","country","state","area_sqkm","region","subregion","funcstat","classfp","county_fip","county","aland10"],initialize:function(){if(this.elder("initialize"),!this.options.table)throw new Error("table is required");this._initModels(),this._initViews()},_check:function(){var a=this.options.table.isGeoreferenced(),b=this.options.table.data(),c=b.table&&b.table.get("geometry_types"),d=!!(c&&c.length>0),e=b.table.get("rows_counted"),f=e>0&&e<this._MAX_ROWS,g=_(this.query_schema).size(),h=g>0&&g<this._MAX_COLS;return a&&d&&f&&h},_initModels:function(){
this.columns=new Backbone.Collection,this.model=new d.core.Model({page:1,maxPages:0})},_initViews:function(){this.table=this.options.table,this.query_schema=this.table.data().query_schema,this.backgroundPollingModel=this.options.backgroundPollingModel,this._check()&&this.backgroundPollingModel.canAddAnalysis()&&(this._setupColumns(),this._start())},_getSimplifiedGeometryType:function(a){return{st_multipolygon:"polygon",st_polygon:"polygon",st_multilinestring:"line",st_linestring:"line",st_multipoint:"point",st_point:"point"}[a.toLowerCase()]},_getGeometryType:function(){var a=this.table.data().table.get("geometry_types");return this._getSimplifiedGeometryType(a[0])},_start:function(){var a=this.columns.map(function(a){return{table_id:this.table.id,column:a.get("name"),geometry_type:a.get("geometry_type")}},this);this.backgroundPollingModel.addAnalysis(a)},_setupColumns:function(){_(this.query_schema).each(function(a,b){_.include(this._EXCLUDED_COLUMNS,b)||this.columns.add({name:b.concat(""),geometry_type:this._getGeometryType()})},this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"../../view_helpers/random_quote":241,"../../views/base_dialog/view":242}],199:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({isDisabled:function(){return this.get("isPrivacyPrivate")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],200:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"OptionCard OptionCard--static",events:{"click input":"_onClickInput"},initialize:function(){this.elder("initialize"),this._template=c.templates.getTemplate(this.model.get("template")),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this._template({model:this.model})),this.$el.toggleClass("is-disabled",!!this.model.isDisabled()),this},_initBinds:function(){this.model.bind("change",this.render,this)},_onClickInput:function(a){this.killEvent(a),this.$("input").select()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],201:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,g="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,h=a("../../views/base_dialog/view"),i=a("./publish_option_view"),j=a("./options/view_model");b.exports=h.extend({events:function(){return e.extend({},h.prototype.events,{"click .js-change-privacy":"_openPrivacyDialog"})},initialize:function(){if(this.elder("initialize"),!this.model)throw new Error("model (vis) is required");if(!this.options.user)throw new Error("user is required");this._initOptions(),this._initBinds()},render_content:function(){this.clearSubViews();var a=f(d.templates.getTemplate("common/dialogs/publish/publish")({}));return this._options.each(function(b){var c=new i({model:b});this.addView(c),a.find(".js-publish-options").append(c.render().el)},this),d.god.trigger("metrics","published_visualization",{email:window.user_data.email}),a},_initOptions:function(){this._options=new g.Collection,this._publicUrlOption=new j({template:"common/dialogs/publish/options/public_url"}),this._options.add(this._publicUrlOption),this._embedOption=new j({template:"common/dialogs/publish/options/embed",embedURL:this.model.embedURL()}),this._options.add(this._embedOption),this._options.add(new j({template:"common/dialogs/publish/options/cdb",vizjsonURL:this.model.vizjsonURL()})),this._updateOptionsWithNewPrivacy()},_updateOptionsWithNewPrivacy:function(){var a="PRIVATE"===this.model.get("privacy");if(this._publicUrlOption.set("isPrivacyPrivate",a),this._embedOption.set("isPrivacyPrivate",a),!a){var b=this.model.publicURL();this._publicUrlOption.set({url:b})}},_initBinds:function(){this.model.bind("change:privacy",this._updateOptionsWithNewPrivacy,this)},_openPrivacyDialog:function(a){this.killEvent(a);var b=new d.editor.ChangePrivacyView({vis:this.model,user:this.options.user,clean_on_hide:!0,enter_to_confirm:!0}),c=this.options.clean_on_hide;this.options.clean_on_hide=!1,this.close(),b.appendToBody();var e=this,f=function(){b.unbind("hide",f),e.options.clean_on_hide=c,e.show(),b.close()};b.bind("hide",f)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../views/base_dialog/view":242,"./options/view_model":199,"./publish_option_view":200}],202:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view");a("../../view_factory"),a("../../view_helpers/random_quote"),"undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null;b.exports=e.extend({_FORMAT:"png",events:e.extendEvents({"click .js-format":"_onClickFormat","keyup .js-textInput":"_onKeyUp","focus .js-textInput":"_onFocus","blur .js-textInput":"_onBlur"}),initialize:function(){this.elder("initialize"),this.options=_.defaults(this.options,{format:this._FORMAT}),this.model=new d.core.Model(this.options),this.mapView=this.options.mapView,this._initBinds()},render_content:function(){return this.getTemplate("common/dialogs/static_image/advanced_export_view")(this.model.attributes)},_initBinds:function(){this.model.on("change:format",this._onChangeFormat,this)},_onKeyUp:function(a){var b=+$(a.target).val();$(a.target).parent().toggleClass("has-error",!(_.isNumber(b)&&b>10))},_onFocus:function(a){$(a.target).parent().addClass("is-focused")},_onBlur:function(a){$(a.target).parent().removeClass("is-focused")},_onChangeFormat:function(){this.$(".js-radioButton").removeClass("is-checked"),this.$(".js-"+this.model.get("format")).addClass("is-checked")},_onClickFormat:function(a){this.killEvent(a);var b=$(a.target).closest(".js-format");this.model.set("format",b.data("format"))},_getBounds:function(){var a=this.mapView.pixelToLatLon([this.options.x+this.options.width,this.options.y]),b=this.mapView.pixelToLatLon([this.options.x,this.options.y+this.options.height]);return[[b.lat,b.lng],[a.lat,a.lng]]},_ok:function(){var a=+this.$(".js-width").val(),b=+this.$(".js-height").val(),c=this.model.get("format"),d=this._getBounds();this.trigger("generate_image",{width:a,height:b,bounds:d,format:c}),this.close()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"../../view_helpers/random_quote":241,"../../views/base_dialog/view":242}],203:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("../../view_factory"),g=a("../../view_helpers/random_quote"),h="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null;b.exports=e.extend({events:e.extendEvents({"click .js-input":"_onInputClick","click .js-open-image":"close"}),initialize:function(){this.elder("initialize"),this._initViews(),this._initBinds()},render_content:function(){return this._panes.getActivePane().render().el},_initViews:function(){this.vis=this.options.vis,this.user=this.options.user,this.column=this.options.column,this._panes=new d.ui.common.TabPane({el:this.el}),this.addView(this._panes),this._panes.addTab("loading",f.createByTemplate("common/templates/loading",{title:"Generating image",quote:g()})),this._panes.addTab("fail",f.createByTemplate("common/templates/fail",{msg:"Could not generate image"})),this._panes.active("loading")},loadURL:function(a){this._showResult({displayedLink:a,filename:a,content:a,type:"url"})},_generateImageFilename:function(){var a=this.vis.get("name")+" by "+this.user.nameOrUsername()+" "+h(new Date).format("MM DD YYYY hh mm ss");return a.replace(/ /g,"_").toLowerCase()},generateImage:function(a){var b=function(a){var b=this._generateImageFilename();this._showResult({content:a,type:"url",displayedLink:b+"."+this.options.format,filename:b})};d.config.get("static_image_upload_endpoint")&&(b=this._exportImage),this._loadMapImage(a,b.bind(this))},_showResult:function(a){this._panes.addTab("result",f.createByTemplate("common/dialogs/static_image/export_image_result_view",{column:this.column,response:a})),this._panes.active("result"),this.trigger("finish",this)},_initBinds:function(){this._panes.bind("tabEnabled",this.render,this)},_loadMapImage:function(a,b){var c=this,d=new Image;d.crossOrigin="Anonymous",d.onload=function(){c._mergeAnnotations(d,b)},d.src=a},_exportImage:function(a){var b=this,c=this.options.vis;$.ajax({type:"POST",url:d.config.get("static_image_upload_endpoint"),data:{base64image:a,name:c.get("name"),visualization_uuid:c.get("id"),description:c.get("description")},success:function(a){b._showResult({content:a,type:"html"})},error:function(a){d.editor.ViewFactory.createDialogByTemplate("common/templates/fail",{msg:a.errors}).render().appendToBody()}})},_mergeAnnotations:function(a,b){var c=this.options.x,e=this.options.y,f=this.options.width,g=this.options.height,h=this.options.format;"jpg"===h&&(h="jpeg");var i=d.config.get("url_prefix")+"/api/v1/image_proxy";html2canvas($(".cartodb-map")[0],{allowTaint:!1,taintTest:!0,proxy:{url:i,api_key:this.options.user.get("api_key")},background:void 0,onclone:function(a){var b=$(a);return b.find(".cartodb-map > div:not(.annotation, .text, .image, .ExportImageView)").remove(),b.find(".ExportImageView").addClass("is-exportable"),b.find(".cartodb-map").css("background-color","transparent"),!0},onrendered:function(d){var i=document.createElement("canvas");i.width=f,i.height=g;var j=i.getContext("2d");j.drawImage(a,0,0),j.drawImage(d,c,e,f,g,0,0,f,g),b(i.toDataURL("image/"+h))}})},ok:function(){this.close()},_onInputClick:function(a){$(a.target).focus().select()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"../../view_helpers/random_quote":241,"../../views/base_dialog/view":242}],204:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({tagName:"li",className:"DatasetSelected-syncOptionsItem",events:{click:"_onClick"},initialize:function(){this._setupModel(),this._template=c.templates.getTemplate("common/dialogs/sync_dataset/interval_template"),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this._template(this.model.attributes)),this},_initBinds:function(){this.model.bind("change:checked",this._onToggleChecked,this)},_setupModel:function(){this.model=this.options.model},_onClick:function(a){this.killEvent(a),this.model.get("disabled")||(this.model.set("checked",!0),this.trigger("checked",this.model,this))},_onToggleChecked:function(){this.model.get("checked")?(this.$(".js-interval").addClass("is-checked"),this.$(".js-input").addClass("is-checked")):(this.$(".js-interval").removeClass("is-checked"),this.$(".js-input").removeClass("is-checked"))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],205:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,g=a("../../views/base_dialog/view"),h=a("./interval_view"),i=a("../../view_helpers/random_quote");b.exports=g.extend({_INTERVALS:[{name:"Every hour",time:3600,type:"hourly",if_external_source:!1},{name:"Every day",time:86400,type:"daily",if_external_source:!1},{name:"Every week",time:604800,type:"weekly",if_external_source:!1},{name:"Every month",time:2592e3,type:"monthly",if_external_source:!0},{name:"Never",time:0,type:"never",if_external_source:!0}],initialize:function(){if(!this.options.table)throw new TypeError("table is required");this.elder("initialize"),this.model=new f.core.Model({option:"interval",state:"prefetching",wait:!0}),this.table=this.options.table,this._initBinds(),this.table.fetch({success:this._onFetchedTable.bind(this),error:this._setterForDefaultErrorState()})},_initBinds:function(){this.model.bind("change:state",this.render,this)},render:function(){return this.clearSubViews(),g.prototype.render.call(this),this._initIntervals(),this},render_content:function(){switch(this.model.get("state")){case"prefetching":return this._renderLoading("Checking synchronization");case"error":return this.getTemplate("common/templates/fail")({msg:""});case"saving":return this._renderLoading("Saving…");default:return this.getTemplate("common/dialogs/sync_dataset/sync_dataset")({service:this._serviceName(),url:this._serviceURL()})}},_onFetchedTable:function(){this.model.set({state:"idle",interval:this.table.synchronization.get("interval")})},_renderLoading:function(a){return this.getTemplate("common/templates/loading")({title:a,quote:i()})},_serviceURL:function(){return this.table.synchronization.get("service_name")||this.table.synchronization.get("service_item_id")?this.table.synchronization.get("service_item_id"):this.table.synchronization.get("url")},_serviceName:function(){var a=this.table.synchronization.get("service_name");if(a&&d.isString(a))return f.Utils.capitalize(a)},_initIntervals:function(){this._intervals=new e.Collection;var a=this.table.synchronization.from_external_source;d.each(this._INTERVALS,function(b){var c=a&&!b.if_external_source;this._intervals.add({name:b.name,interval:b.time,checked:this.table.synchronization.get("interval")===b.time,disabled:c})},this),this._intervals.each(function(a){var b=new h({model:a});b.bind("checked",this._onIntervalChecked,this),this.$(".js-intervals").append(b.render().$el),this.addView(b)},this)},_onIntervalChecked:function(a){this._intervals.each(function(b){a.get("interval")!==b.get("interval")&&b.set("checked",!1)},this)},_getSelectedInterval:function(){return this._intervals.find(function(a){return a.get("checked")})},_addTab:function(a,b){this._contentPane.addTab(a,b.render()),this.addView(b)},ok:function(){var a=this._getSelectedInterval();if(a){this.model.set("state","saving");var b={success:this.close.bind(this),error:this._setterForDefaultErrorState()},c=a.get("interval");c?this.table.synchronization.save({interval:c},b):this.table.synchronization.destroy(b)}else this.close()},_setterForDefaultErrorState:function(){return this.model.set.bind(this.model,"state","error")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_helpers/random_quote":241,"../../views/base_dialog/view":242,"./interval_view":204}],206:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({events:{"click .js-start":"_startTutorial"},initialize:function(){this.template=c.templates.getTemplate("common/dialogs/video_tutorial/video_tutorial_footer_template"),this._initBinds()},render:function(){return this.$el.html(this.template({isVideoSelected:this.model.isVideoSelected()})),this},_initBinds:function(){this.model.bind("change:videoId",this.render,this)},_startTutorial:function(a){var b=this.model.get("videoId");b&&c.god.trigger("startTutorial",b,this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],207:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({events:{"click .js-back":"_backToList"},initialize:function(){this.template=c.templates.getTemplate("common/dialogs/video_tutorial/video_tutorial_header_template"),this._initBinds()},render:function(){return this.$el.html(this.template({isVideoSelected:this.model.isVideoSelected()})),this},_initBinds:function(){this.model.bind("change:videoId",this.render,this)},_backToList:function(){this.model.unset("videoId")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],208:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"VideoTutorial-item",tagName:"li",events:{"click .js-button":"_selectVideo"},initialize:function(){this.template=c.templates.getTemplate("common/dialogs/video_tutorial/video_tutorial_item_template")},render:function(){return this.$el.html(this.template({shortName:this.model.get("short_name"),shortDescription:this.model.get("short_description"),color:this.model.get("color"),icon:this.model.get("icon")||"",duration:this.model.get("duration")||"",difficulty:this.model.get("difficulty")||"",iconUrl:this.model.get("icon_url")||""})),this},_selectVideo:function(){this.trigger("selected",this.model,this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],209:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f=("undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,a("../../map_templates")),g=a("./video_tutorial_item_view");b.exports=d.core.View.extend({className:"VideoTutorial-listWrapper",initialize:function(){this.collection=new e.Collection(f),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.empty(),this.$el.append('<ul class="VideoTutorial-list js-list"></ul>'),this.collection.reset(f),this},_initBinds:function(){this.collection.bind("reset",this._renderList,this),this.add_related_model(this.collection)},_renderList:function(){this.collection.each(this._addItem,this)},_addItem:function(a){var b=new g({model:a});this.$(".js-list").append(b.render().el),b.bind("selected",this._onItemSelected,this),this.addView(b)},_onItemSelected:function(a){this.model.set("videoId",a.get("videoId")),d.god.trigger("onTemplateSelected",this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../map_templates":226,"./video_tutorial_item_view":208}],210:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,"undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null),e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("../../map_templates");b.exports=d.Model.extend({defaults:{videoId:""},isVideoSelected:function(){return!!this.get("videoId")},getVideoTemplate:function(){var a=this.get("videoId");if(a){var b=e.find(f,function(b){return b.videoId===a});if(!e.isEmpty(b))return b}return!1}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../map_templates":226}],211:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"VideoTutorial-video",initialize:function(){this.template=c.templates.getTemplate("common/dialogs/video_tutorial/video_tutorial_preview_template"),this.localStorage=new c.admin.localStorage("VideoPlayer"),this._initBinds()},render:function(){this.clearSubViews();var a=this.model.getVideoTemplate();return a&&a.name&&(this.$el.html(this.template(a)),this._loadScript()),this},_storeVideoInfo:function(a){this.localStorage.set({currentVideo:{seconds:a}})},_storeVideoInfoWithId:function(a){var b=this.model.get("videoId");this.localStorage.set({currentVideo:{video_id:b,seconds:a}})},_loadScript:function(){var a=this;$.getScript("//f.vimeocdn.com/js/froogaloop2.min.js",function(){a._initVideoBinds()})},_initVideoBinds:function(){var a=this;this._removeVideoBinds(),this.player=$f(this.$("iframe")[0]),this.player.addEvent("ready",function(){a.player.addEvent("playProgress",function(b){a._storeVideoInfo(b.seconds)})})},_removeVideoBinds:function(){this.player&&this.player.removeEvent("ready")},_initBinds:function(){this.model.bind("change:videoId",this.render,this)},clean:function(){this._removeVideoBinds(),this.elder("clean")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],212:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../views/base_dialog/view"),f=a("./video_tutorial_model"),g=a("./video_tutorial_header_view"),h=a("./video_tutorial_footer_view"),i=a("./video_tutorial_list_view"),j=a("./video_tutorial_preview_view");b.exports=e.extend({className:"Dialog is-opening VideoTutorial",initialize:function(){this.model=new f({videoId:this.options.videoId}),this.elder("initialize"),this.template=d.templates.getTemplate("common/dialogs/video_tutorial/video_tutorial_template"),this._initBinds()},render:function(){return this.clearSubViews(),this.elder("render"),this._initViews(),this},render_content:function(){return this.template()},_initBinds:function(){this.model.bind("change:videoId",this.setContentVisibility,this),d.god.bind("startTutorial",this.close,this),this.add_related_model(d.god)},_initViews:function(){var a=new g({el:this.$(".VideoTutorial-header"),model:this.model});a.render(),this.addView(a);var b=new h({el:this.$(".VideoTutorial-footer"),model:this.model});b.render(),this.addView(b),this._videoTutorialContent=new d.ui.common.TabPane({el:this.$(".VideoTutorial-content")}),this.addView(this._videoTutorialContent),this._videoTutorialContent.addTab("list",new i({model:this.model}).render()),this._videoTutorialContent.addTab("video",new j({model:this.model}).render()),this.setContentVisibility()},setContentVisibility:function(){this._videoTutorialContent.active(this.model.isVideoSelected()?"video":"list")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../views/base_dialog/view":242,"./video_tutorial_footer_view":206,"./video_tutorial_header_view":207,"./video_tutorial_list_view":209,"./video_tutorial_model":210,"./video_tutorial_preview_view":211}],213:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,a("../edit_field_view"));"undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,"undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null;b.exports=d.extend({options:{template:"common/edit_fields/boolean_field/boolean_field"},events:{"click .js-true":"_onTrueClick","click .js-false":"_onFalseClick","click .js-null":"_onNullClick"},_initBinds:function(){this.model.bind("change",this.render,this)},_onTrueClick:function(){this.model.set("value",!0)},_onFalseClick:function(){this.model.set("value",!1)},_onNullClick:function(){this.model.set("value",null)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../edit_field_view":219}],214:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,a("../edit_field_view")),e=a("./date_picker/date_picker_view"),f=a("./time_input/time_input_view");"undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,"undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null;b.exports=d.extend({className:"EditField EditField--withBorder EditField--withSeparator",options:{showTime:!0,showGMT:!1,timezone:"Z"},render:function(){return this.clearSubViews(),this._initViews(),this},_initViews:function(){this.datePicker=new e({model:this.model}),this.datePicker.bind("onDateChange",this._setDate,this),this.$el.append(this.datePicker.render().el),this.addView(this.datePicker),this.options.showTime&&(this.timeInput=new f({model:this.model}),this.$el.append(this.timeInput.render().el),this.timeInput.bind("onTimeChange",this._setTime,this),this.timeInput.bind("onSubmit",function(){this.trigger("onSubmit",this.model,this)},this),this.addView(this.timeInput))},_setTime:function(a){var b,c=moment(this.model.get("value")),d=moment(new Date);c.isValid()?(c.hour(d.hour()).minutes(d.minutes()).seconds(d.seconds()),b=c.format("YYYY-MM-DDT")):b=d.format("YYYY-MM-DDT"),this.model.set("value",b+a+this.options.timezone)},_setDate:function(a){var b,c=moment(this.model.get("value")),d=moment(a);c.isValid()?(c.month(d.month()).date(d.date()).year(d.year()),b=c.format("YYYY-MM-DDTHH:mm:ss")):b=d.format("YYYY-MM-DDTHH:mm:ss"),this.model.set("value",b+this.options.timezone)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../edit_field_view":219,"./date_picker/date_picker_view":216,"./time_input/time_input_view":217}],215:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null,f="undefined"!=typeof window?window.moment:"undefined"!=typeof a?a.moment:null;b.exports=c.admin.DropdownMenu.extend({className:"Dropdown",options:{flat:!0,date:"2008-07-01",current:"2008-07-31",calendars:1,starts:1},initialize:function(){if(!this.model)throw new Error("model is required");this.elder("initialize"),this.template=c.templates.getTemplate("common/edit_fields/date_field/date_picker/calendar_dropdown"),this._initDefaults()},render:function(){return this.$el.html(this.template({initialDateStr:f(this.model.get("value")).format("YYYY-MM-DD")})),c.god.bind("closeDialogs",this.hide,this),e("body").append(this.el),this._initCalendar(),this},clean:function(){this._$calendar().DatePickerHide(),c.admin.DropdownMenu.prototype.clean.call(this)},_initDefaults:function(){var a=(new Date).getTimezoneOffset(),b=f(new Date).utcOffset(a).format("YYYY-MM-DD");this.options.date=this.model.get("value")&&f(this.model.get("value")).format("YYYY-MM-DD")||b,this.options.current=this.options.date},_initCalendar:function(){var a=this;this._$calendar().DatePicker(d.extend(this.options,this.model.attributes,{onChange:function(b,c){a.trigger("onDateSelected",c,this),a.hide()}}))},_$calendar:function(){return this.$(".js-calendar")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],216:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,g="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null,h=a("./calendar_dropdown_view.js");b.exports=d.admin.DropdownMenu.extend({className:"DatePicker",events:{"click .js-date-picker":"_onClickDateBtn"},options:{vertical_position:"down",tick:"center",dateFormat:"YYYY-MM-DD"},initialize:function(){this.elder("initialize"),this._initBinds()},render:function(){var a=this.model.get("value")||new Date;return this.$el.html(d.templates.getTemplate("common/edit_fields/date_field/date_picker/date_picker")({readOnly:this.model.get("readOnly"),date:g(a).format(this.options.dateFormat)})),this.model.get("readOnly")&&this.undelegateEvents(),this},_initBinds:function(){this.model.bind("change",this.render,this)},_onClickDateBtn:function(a){this.killEvent(a),this._calendar?this._destroyCalendarDropdown():(this._calendar=new h(e.extend(this.options,{target:f(a.target).closest("button"),model:this.model})),this.addView(this._calendar),this._calendar.render(),this._calendar.on("onDropdownHidden",this._destroyCalendarDropdown,this),this._calendar.on("onDateSelected",function(a){this.trigger("onDateChange",a,this)},this),this._calendar.open())},_destroyCalendarDropdown:function(){this._calendar.options.target.unbind("click",this._calendar._handleClick),this._calendar.clean(),this._calendar=null}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./calendar_dropdown_view.js":215}],217:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"TimeInput",events:{"keydown .js-input":"_onKeyDown","keyup .js-input":"_onKeyUp"},initialize:function(){this.template=c.templates.getTemplate("common/edit_fields/date_field/time_input/time_input")},render:function(){var a=this.model.get("value")||new Date;return this.$el.html(this.template({readOnly:this.model.get("readOnly"),time:moment(a).format("HH:mm:ss")})),this.model.get("readOnly")&&this.undelegateEvents(),this},_onKeyDown:function(a){if(13===a.keyCode)return a.preventDefault(),this.trigger("onSubmit",this),!1},_onKeyUp:function(a){var b=$(a.target).val();this.trigger("onTimeChange",b,this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],218:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window.moment:"undefined"!=typeof a?a.moment:null;b.exports=c.core.Model.extend({defaults:{attribute:"",value:"",type:"string",readOnly:!1},initialize:function(){this.validationError="",this.bind("valid",function(){this.validationError=""},this),this.bind("error",function(a,b){this.validationError=b})},_validate:function(a,b){var d=c.core.Model.prototype._validate.apply(this,arguments);return!!d&&(this.trigger("valid"),!0)},validate:function(a){if(a){var b=a.value,c=a.type;if("number"===a.type){var e=/^(\+|-)?(?:[0-9]+|[0-9]*\.[0-9]+)$/;if(b&&!e.test(b))return"Invalid number"}return"boolean"===c&&null!==b&&b!==!0&&b!==!1?"Invalid boolean":"date"===c&&b&&!d(b).isValid()?"Invalid date":void 0}},getError:function(){return this.validationError},isValid:function(){return!this.validate||!this.validate(this.attributes)&&""===this.validationError}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],219:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"EditField",options:{template:"common/edit_fields/edit_field"},initialize:function(){this.model||(this.model=new c.core.Model({value:""})),this.options.template&&(this.template=c.templates.getTemplate(this.options.template)),this._initBinds()},render:function(){return this.$el.html(this.template(_.extend(this.options,{type:this.model.get("type"),value:this.model.get("value"),attribute:this.model.get("attribute"),readOnly:this.model.get("readOnly")}))),this.model.get("readOnly")&&this.undelegateEvents(),this},_initBinds:function(){this.model.bind("error valid",this._setFieldStyle,this),this.model.bind("change:readOnly",this.render,this)},_setFieldStyle:function(){this.$el[this.model.getError()?"addClass":"removeClass"]("is-invalid")},_hasSubmit:function(a){if(!a)throw new Error("event needed to check if user has submitted from the input");var b=navigator.userAgent.toLowerCase(),c=/mac os/.test(b);return(c&&a.metaKey||!c&&a.ctrlKey)&&13===a.keyCode},isValid:function(){return this.model.isValid()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],220:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,a("../edit_field_view")),e=("undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,"undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null);
b.exports=d.extend({options:{template:"common/edit_fields/number_field/number_field"},events:{"keydown .js-input":"_onKeyDown","keyup .js-input":"_onKeyUp"},_hasSubmit:function(a){if(!a)throw new Error("event needed to check if user has submitted from the input");return 13===a.keyCode},_onKeyDown:function(a){if(this._hasSubmit(a)&&this.model.isValid())return a.preventDefault(),this.trigger("onSubmit",this.model,this),!1},_onKeyUp:function(a){if(this._hasSubmit(a)&&this.model.isValid())return a.preventDefault(),!1;var b=e(a.target).val();""===b&&(b=null),this.model.set("value",b)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../edit_field_view":219}],221:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,a("../edit_field_view")),e=("undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,"undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null);b.exports=d.extend({options:{template:"common/edit_fields/string_field/string_field",autoResize:!0},events:{"keydown .js-textarea":"_onKeyDown","keyup .js-textarea":"_onKeyUp"},render:function(){return this.elder("render"),this.options.autoResize&&this._resize(),this},_onKeyDown:function(a){if(this._hasSubmit(a))return a.preventDefault(),this.trigger("onSubmit",this.model,this),!1},_onKeyUp:function(a){a.preventDefault();var b=e(a.target).val();this.model.set("value",b),this.options.autoResize&&this._resize()},_resize:function(){var a=this.$(".js-textarea");a&&setTimeout(function(){a.height(20),a.height(a[0].scrollHeight-22)})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../edit_field_view":219}],222:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;c.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof a?a.cdb.admin:null;var d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null;b.exports=c.core.View.extend({className:"form-view form_spinner",defaults:{max:999999999999,min:-999999999999,inc:1,width:25,pattern:/^-?[0-9]+\.?[0-9]*$/,debounce_time:200},events:{"click .plus":"_plus","click .minus":"_minus","keypress input.value":"_checkInputPress","keydown input.value":"_checkInputPress","keyup input.value":"_checkInputUp","change .value":"_checkValueChange"},initialize:function(){d.bindAll(this,"_fireChange","_checkNumber"),this.property=this.options.property,this.model.bind("change",this.render,this),this.options.pattern&&"object"==typeof this.options.pattern&&("object"!=typeof this.options.pattern||this.options.pattern.test)||delete this.options.pattern,d.defaults(this.options,this.defaults),this.options.debounce_time>0&&(this._fireChange=d.debounce(this._fireChange,this.options.debounce_time))},render:function(a){var b=this.options.initValue||this.model.get(this.property);return a&&d.isNumber(a)&&(b=a),this.$el.html('<input class="value" '+(this.options.disabled?"readonly":"")+' value="" style="width:'+this.options.width+'px!important"/><a href="#" class="plus">+</a><a href="#" class="minus">-</a>'),this.$(".value").val(b),this.options.disabled&&(this.undelegateEvents(),this.$el.addClass("disabled").find("a").bind("click",this.killEvent)),this},_fireChange:function(){this.model.change()},_changeValue:function(a){this.model.set(a,{silent:!0}),this._fireChange()},inc:function(a){var b={},c=b[this.property]=this.model.get(this.property)+a;c=b[this.property]=Math.min(this.options.max,c.toFixed?c.toFixed(1):1*c),b[this.property]=Math.max(this.options.min,c),this._changeValue(b),this.render(b[this.property])},_plus:function(a){return a&&a.preventDefault(),this.inc(this.options.inc),!1},_minus:function(a){return a&&a.preventDefault(),this.inc(-this.options.inc),!1},_checkNumber:function(a){return this.options.pattern.test(a)},_checkInputPress:function(a){var b=String.fromCharCode(a.charCode);return"-"==b||"."==b||1*b!==NaN||(a.preventDefault(),a.stopPropagation(),!1)},_checkInputUp:function(a){this.value?null:this.value=this.model.get(this.property);var b=e(a.target).val();return 13===a.keyCode?(this._saveValue(a),!1):(this._checkNumber(b)||"-"==b||""==b?"-"!=b&&""!=b&&(this.value=e(a.target).val()):this.$el.find("input.value").val(this.value),!0)},_checkValueChange:function(a){var b=e(a.target).val();return b=""==b||"-"==b?0:1*b,this._checkNumber(b)?(this._saveValue(a),this.value=e(a.target).val()):this.$el.find("input.value").val(this.value),!0},_saveValue:function(a){var b={},d=this.$el.find("input.value").val(),e=this.options.min<0&&this.options.max>0?0:this.options.min,f=""==d||"-"==d?e:1*d;this.$el.find("input.value").val(f),b[this.property]=f,this.model.set(b),c.god.trigger("closeDialogs")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],223:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d=function(a){this.name=a||"cartodb",!localStorage.getItem(this.name)&&this.isEnabled()&&localStorage.setItem(this.name,"{}")};d.prototype.isEnabled=function(){try{return localStorage.setItem("checking","test"),localStorage.removeItem("checking"),!0}catch(a){return!1}},d.prototype.get=function(a){if(!this.isEnabled())return!1;if(void 0===a)return JSON.parse(localStorage.getItem(this.name));var b=JSON.parse(localStorage.getItem(this.name));return b[a]},d.prototype.search=function(a){if(!this.isEnabled())return null;var b=JSON.parse(localStorage.getItem(this.name));for(var c in b)if(b[c][a])return b[c][a];return null},d.prototype.set=function(a){if(!this.isEnabled())return null;var b=c.extend(this.get(),a);return localStorage.setItem(this.name,JSON.stringify(b))},d.prototype.add=function(a){return this.set(a)},d.prototype.remove=function(a){if(!this.isEnabled())return null;var b=c.omit(this.get(),a);return localStorage.setItem(this.name,JSON.stringify(b))},d.prototype.destroy=function(){delete localStorage.removeItem(this.name)},b.exports=d}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],224:[function(a,b,c){var d=a("../views/base_dialog/view");b.exports=d.extend({className:"Dialog is-opening MamufasDialog",overrideDefaults:{template_name:"common/views/base_dialog/template",triggerDialogEvents:!1},initialize:function(){d.prototype.initialize.apply(this,arguments),this.template=cdb.templates.getTemplate("common/mamufas_import/mamufas_import_dialog")},render_content:function(){return this.template()},render:function(){return this.elder("render"),this.$(".Dialog-content").addClass("Dialog-content--expanded"),this},hide:function(){d.prototype.hide.apply(this,arguments),this.trigger("hide"),this._setBodyForDialogMode("remove")}})},{"../views/base_dialog/view":242}],225:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./mamufas_import_dialog_view");b.exports=d.core.View.extend({initialize:function(){this.user=this.options.user,this.model=new d.core.Model({visible:!1})},render:function(){return this},_createDragster:function(){this.dragster&&this._destroyDragster(),this.dragster=new Dragster(this.$el[0])},_createDropzone:function(){this.dropzone&&this._destroyDropzone(),this.dropzone=new Dropzone(this.$el[0],{url:":)",autoProcessQueue:!1,previewsContainer:!1})},_destroyDragster:function(){this.dragster&&(this.dragster.removeListeners(),this.dragster.reset(),delete this.dragster)},_destroyDropzone:function(){this.dropzone&&(this.dropzone.destroy(),delete this.dropzone)},_initBinds:function(){var a=this,b=new e({clean_on_hide:!0});this.$el.on("dragster:enter",function(a){b.appendToBody()}),this.$el.on("dragster:leave",function(a){b.hide()}),this.dropzone.on("drop",function(c){a.dragster.dragleave(c),b.hide(),a.dropzone.removeFile(c);var e=c.dataTransfer.files;e&&e.length>0&&(1===e.length&&(e=e[0]),d.god.trigger("fileDropped",e,this))})},_removeBinds:function(){this.$el.off("dragster:enter"),this.$el.off("dragster:leave")},enable:function(){this.model.get("visible")||(this._createDragster(),this._createDropzone(),this._initBinds(),this.model.set("visible",!0))},disable:function(){this.model.get("visible")&&(this._removeBinds(),this._destroyDragster(),this._destroyDropzone(),this.model.set("visible",!1))},clean:function(){this._removeBinds(),this.elder("clean")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./mamufas_import_dialog_view":224}],226:[function(a,b,c){b.exports=[{name:"Create animated maps",short_name:"Create animated maps",description:"Learn how to animate your data, by using historic United States tornado data.",short_description:"Create maps for showing events over time",icon:"snake",color:"#CB3F29",difficulty:"easy",duration:"5:01",videoId:"122308083",map:{url:"https://examples.carto.com/viz/960736aa-cd8c-11e4-a309-0e6e1df11cbf/embed_map",source:["https://examples.carto.com/api/v2/sql?q=SELECT%20*%20FROM%20tornado_centroids&filename=tornados&format=geojson"]}},{name:"Animate the life of a cat",short_name:"Create GPS Data maps",description:"Let's take a look at one week of movements for a cat named Spencer. Using GPS collected data, we can animate Spencer over time to see his patterns of exploration in his neighborhood.",short_description:"Mapping your GPS data was never so easy!",icon:"points",color:"#AC638B",difficulty:"easy",duration:"1:53",videoId:"122308076",map:{url:"https://examples.carto.com/viz/00c8701c-c121-11e4-b828-0e4fddd5de28/embed_map",source:["https://examples.carto.com/api/v2/sql?q=SELECT%20*%20FROM%20spencer_the_cat&filename=spencer_the_cat&format=geojson"]}},{name:"Create your own data using the CARTO Editor",short_name:"Create your own datasets",description:"Learn to create your own point, line, or polygon dataset directly in the CARTO editor.",short_description:" Add and style features in a map using the CARTO UI",icon:"notes",color:"#F2C000",difficulty:"easy",duration:"5:39",videoId:"122308073",map:{url:"https://examples.carto.com/viz/eaa226aa-cd8e-11e4-893e-0e0c41326911/embed_map"}},{name:"Map your local world",short_name:"Map your local world",description:"We will use a publically available set of buildings to map Nantucket Island. Then we will use CARTO's annotation tools to highlight our point of interest.",short_description:"Learn to create and style a map of your city",icon:"mountain",color:"#EA703D",difficulty:"easy",duration:"2:57",videoId:"122308073",map:{url:"https://examples.carto.com/viz/b8847e3e-c1f4-11e4-8c09-0e853d047bba/embed_map",source:["https://examples.carto.com/api/v2/sql?q=SELECT%20*%20FROM%20structures_poly_197&filename=buildings_nantucket&format=geojson"]}},{name:"Create your first choropleth map using Table Join",short_name:"Join Datasets",description:"Create your first choropleth map by joining historic tornado data with United States polygons",short_description:"Build your first choropleth map by joining two datasets",icon:"rectangles",color:"#86B765",difficulty:"medium",duration:"5:17",videoId:"122308079",map:{url:"https://examples.carto.com/viz/339c7670-cd90-11e4-ab8c-0e018d66dc29/embed_map",source:["https://examples.carto.com/api/v2/sql?q=SELECT%20*%20FROM%20tornado_centroids&filename=tornados&format=geojson","https://examples.carto.com/api/v2/sql?q=SELECT%20*%20FROM%20tornados_in_us&filename=tornados_us&format=geojson"]}},{name:"Map your MailChimp Campaigns",short_name:"Map MailChimp Campaigns",description:"Create a map of where your subscribers are and which of them have opened any of your campaigns. Also this is a great way to learn about conditional styling.",short_description:"Map your engagement using the MailChimp Connector.",icon:"email",color:"#AC638B",difficulty:"easy",duration:"1:49",videoId:"125895396",map:{url:"https://examples.carto.com/viz/560de38c-ea88-11e4-aac4-0e5e07bb5d8a/embed_map",source:[]}}]},{}],227:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({defaults:{per_page:20,page:1},fetch:function(a){return a.trigger("fetching"),a.fetch({data:this.attributes})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],228:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof a?a.Backbone:null,e=d.Router.extend({navigate:function(){throw new Error("router.enableAfterMainView({ ... }) must be called before you can navigate")},enableAfterMainView:function(){this.navigate=function(a,b){d.Router.prototype.navigate.call(this,this.normalizeFragmentOrUrl(a),b)},d.history.start({pushState:!0,root:this.rootPath()+"/"})},rootPath:function(){throw new Error("implement rootPath in child router (no trailing slash)")},normalizeFragmentOrUrl:function(a){throw new Error("implement normalizeFragmentOrUrl in child router")}});e.supportTrailingSlashes=function(a){return c.reduce(a,function(a,b,c){return a[c]=b,a[c+"/"]=b,a},{})},b.exports=e}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],229:[function(a,b,c){(function(c){var d=a("perfect-scrollbar"),e=a("./scroll.tpl"),f=window.MutationObserver,g="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;b.exports=g.core.View.extend({tagName:"div",className:"ScrollView",initialize:function(a){if(!a.createContentView)throw new Error("A factory createContentView function is required");this.options=a||{},this._type=a.type||"vertical",this._maxScroll=0},render:function(){this.clearSubViews(),this._html();var a=this.options.createContentView.call(this);return this._contentContainer().append(a.render().el),this.addView(a),this._applyScroll(),this._updateScrollWhenExist(),this},_html:function(){this.$el.html(e({type:this._type})),"horizontal"===this._type&&this.$el.addClass("ScrollView--horizontal")},_contentContainer:function(){return this.$(".js-content")},_wrapperContainer:function(){return this.$(".js-wrapper")},_updateScrollWhenExist:function(){if(f){var a=document.body,b=this._wrapperContainer().get(0),c=function(){a.contains(b)&&(d.update(b),e.disconnect())},e=new f(c);c();var g={subtree:!0,childList:!0};e.observe(a,g)}},_applyScroll:function(){d.initialize(this._wrapperContainer().get(0),{wheelSpeed:2,wheelPropagation:!0,stopPropagationOnClick:!1,minScrollbarLength:20,suppressScrollX:"vertical"===this._type,suppressScrollY:"horizontal"===this._type})},destroyScroll:function(){d.destroy(this._wrapperContainer().get(0))},clean:function(){this.destroyScroll(),g.core.View.prototype.clean.call(this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./scroll.tpl":230,"perfect-scrollbar":533}],230:[function(require,module,exports){var _=require("underscore");module.exports=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="ScrollView-wrapper js-wrapper js-perfect-scroll">\n  <div class="ScrollView-content js-content"></div>\n</div>\n';return __p}},{underscore:568}],231:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({idAttribute:"datasource",url:function(){return"/api/v1/imports/service/"+this.get("datasource")+"/invalidate_token"}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],232:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({_DATASOURCE_NAME:"dropbox",initialize:function(a,b){b.datasource_name&&(this._DATASOURCE_NAME=b.datasource_name)},url:function(a){var b=c.config.urlVersion("imports_service",a);return"/api/"+b+"/imports/service/"+this._DATASOURCE_NAME+"/auth_url"},parse:function(a){return a}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],233:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({_DATASOURCE_NAME:"dropbox",initialize:function(a,b){b.datasource_name&&(this._DATASOURCE_NAME=b.datasource_name)},url:function(a){var b=c.config.urlVersion("imports_service",a);return"/api/"+b+"/imports/service/"+this._DATASOURCE_NAME+"/token_valid"},parse:function(a){return a}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],234:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({idAttribute:"datasource",url:function(a){var b=c.config.urlVersion("imports_service",a);return"/api/"+b+"/imports/service/"+this.get("datasource")+"/token_valid"}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],235:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof a?a.Backbone:null,e="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.core.Model.extend({sync:function(a,b,c){return d.sync("update",b,c)},url:function(){var a=this._configModel.get("url_prefix");return a+"/api/v3/notifications/"+this.get("key")},initialize:function(a,b){if(!b.key)throw new Error("key is required");if(!b.configModel)throw new Error("configModel is required");this._configModel=b.configModel,this.attributes=e.extend({notifications:a},{key:b.key})},getKey:function(a){var b=this.get("notifications")||{};return b[a]},setKey:function(a,b){var c=this.get("notifications")||{};c[a]=b,this.set("notifications",c)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],236:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null,e="builder_activated";b.exports=c.core.View.extend({className:"js-builderNotification",events:{"click .js-close":"_onClose"},initialize:function(){if(!this.options.notification)throw new Error("notification is required");this._notification=this.options.notification,this._template=c.templates.getTemplate("common/user_notification/user_notification"),this.render()},render:function(){return this.$el.html(this._template()),d("body").prepend(this.$el),this},_onClose:function(){this._notification.setKey(e,!0),this._notification.save(),this.clean()},clean:function(){this.constructor.__super__.clean.apply(this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],237:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("./views/base_dialog/view");b.exports={createDialogByTemplate:function(a,b,c){return this.createDialogByView(this.createByTemplate(a,b),c)},createByTemplate:function(a,b,c){var f=d.isString(a)?e.templates.getTemplate(a):a,g=new e.core.View(c);return g.render=function(){return this.$el.html(f(b)),this},g},createByList:function(a,b){var c=new e.core.View(b);return c.render=function(){return this.clearSubViews(),d.each(a,function(a){this.addView(a),this.$el.append(a.render().$el)},this),this},c},createDialogByView:function(a,b){var c=d.extend({clean_on_hide:!0,enter_to_confirm:!0},b);return new(f.extend({initialize:function(){this.elder("initialize"),this.addView(a)},render_content:function(){return a.render().el}}))(c)}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./views/base_dialog/view":242}],238:[function(a,b,c){var d=function(a){return this instanceof d?(this.bytes=a,0==a?this.unit=0:this.unit=parseInt(Math.floor(Math.log(a)/Math.log(1024))),this):new d(a)};d.prototype.size=function(){return this.bytes/Math.pow(1024,this.unit)},d.prototype.UNIT_SUFFIXES=["B","kB","MB","GB","TB"],d.prototype.suffix=function(){return this.UNIT_SUFFIXES[this.unit]},d.prototype.toString=function(a){var b=this.size();if(a){var c=Math.pow(10,a);b=Math.floor(b*c)/c}else b=Math.floor(b);return b+this.suffix()},b.exports=d},{}],239:[function(a,b,c){(function(a){function c(a){return 2===a.which||3===a.which}function d(a){return a.metaKey}function e(a){return a.ctrlKey}var f="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null;b.exports=function(a){this.killEvent(a);var b=f(a.target).closest("a").attr("href");return!!b&&void(c(a)||d(a)?(e(a)||d(a))&&window.open(b,"_blank"):(this.router||this.options.router).navigate(b,{trigger:!0}))}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],240:[function(a,b,c){var d=function(a,b,c){return 2===arguments.length?d.call(this,arguments[0],arguments[0]+"s",arguments[1]):1===c?a:b};d.prefixWithCount=function(a,b,c){return d("1 "+a,c+" "+b,c)},b.exports=d},{}],241:[function(a,b,c){b.exports=function(){var a=_.template('<p class="CDB-Text CDB-Size-medium u-altTextColor">"<%= quote %>"</p><% if (author) { %><p class="CDB-Text CDB-Size-medium u-altTextColor u-tSpace"><em>– <%- author %></em></p><% } %>'),b=[{quote:"Geographers never get lost. They just do accidental field work.",author:"Nicholas Chrisman"},{quote:"Geography is just physics slowed down, with a couple of trees stuck in it.",author:"Terry Pratchett"},{quote:"Not all those who wander are lost.",author:"J. R. R. Tolkien"},{quote:"In that Empire, the Art of Cartography attained such Perfection that the map of a single Province occupied the entirety of a City.",author:"Jorge Luis Borges"},{quote:"X marks the spot",author:"Indiana Jones"},{quote:"It's turtles all the way down.",author:null},{quote:"Remember: no matter where you go, there you are.",author:null},{quote:"Without geography, you're nowhere!",author:"Jimmy Buffett"},{quote:"our earth is a globe / whose surface we probe /<br />no map can replace her / but just try to trace her",author:"Steve Waterman"},{quote:"Everything happens somewhere.",author:"Doctor Who"},{quote:"A map is the greatest of all epic poems. Its lines and colors show the realization of great dreams.",author:"Gilbert H. Grosvenor"},{quote:"Everything is related to everything else,<br />but near things are more related than distant things.",author:"Tobler's first law of geography"},{quote:"Hic Sunt Dracones",author:null},{quote:"Here be dragons",author:null},{quote:"Stand in the place where you live / Now face North /<br/>Think about direction / Wonder why you haven't before",author:"R.E.M"},{quote:"The virtue of maps, they show what can be done with limited space, they foresee that everything can happen therein.",author:"José Saramago"}],c=Math.round(Math.random()*(b.length-1));return a(b[c])}},{}],242:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null,f=c.ui.common.Dialog;b.exports=f.extend({className:"Dialog is-opening",overrideDefaults:{template_name:"common/views/base_dialog/template",triggerDialogEvents:!0},initialize:function(){d.defaults(this.options,this.overrideDefaults),this.elder("initialize"),this.bind("show",this._setBodyForDialogMode.bind(this,"add")),this.bind("hide",this._setBodyForDialogMode.bind(this,"remove"))},show:function(){f.prototype.show.apply(this,arguments),this.trigger("show"),this.options.triggerDialogEvents&&c.god.trigger("dialogOpened"),this.$el.removeClass("is-closing"),document.activeElement&&document.activeElement.blur()},render:function(){return f.prototype.render.apply(this,arguments),this.$(".content").addClass("is-newContent"),this._isSticky()&&this.$el.addClass("is-sticky"),this.show(),this},_isSticky:function(){return this.options&&this.options.sticky},close:function(){this._cancel(void 0,!0)},open:function(){f.prototype.open.apply(this,arguments),this.show()},hide:function(){f.prototype.hide.apply(this,arguments),this.trigger("hide")},_cancel:function(a,b){if(a&&this.killEvent(a),!this._isSticky()){this.$el.removeClass("is-opening").addClass("is-closing");var d=this;setTimeout(function(){d.cancel&&!b&&d.cancel(),f.prototype.hide.call(d)},80),this.trigger("hide"),this.options.triggerDialogEvents&&c.god.trigger("dialogClosed")}},_ok:function(a){this.killEvent(a),this.ok?this.ok():this.close()},_setBodyForDialogMode:function(a){e("body")[a+"Class"]("is-inDialog")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],243:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=function(a){var b="leaflet",e="tiled";a.baselayer.url?a.baselayer.urlTemplate=a.baselayer.url:(b="googlemaps",e="GMapsBase");var f=c.createVis(a.el,{version:"0.1.0",title:"default",scrollwheel:void 0!==a.scrollwheel&&a.scrollwheel,zoom:6,map_provider:b,center:[40.7127837,-74.0059413],layers:[d.extend({type:e},a.baselayer)]});return f}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],244:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f=a("../../../view_helpers/navigate_through_router");b.exports=d.admin.DropdownMenu.extend({className:"Dropdown BreadcrumbsDropdown",events:{"click a":"_navigateToLinksHref"},initialize:function(){if(this.elder("initialize"),!this.options.viewModel)throw new Error("viewModel must be provided");this.viewModel=this.options.viewModel,this.router=this.options.router},render:function(){var a=this.model.viewUrl().dashboard(),b=a.datasets(),c=a.deepInsights(),f=a.maps();return this.$el.html(this.template_base({avatarUrl:this.model.get("avatar_url"),userName:this.model.get("username"),mapsUrl:f,datasetsUrl:b,deepInsightsUrl:c,lockedDatasetsUrl:b.lockedItems(),lockedMapsUrl:f.lockedItems(),isDeepInsights:this.viewModel.isDisplayingDeepInsights(),isDatasets:this.viewModel.isDisplayingDatasets(),isMaps:this.viewModel.isDisplayingMaps(),isLocked:this.viewModel.isDisplayingLockedItems()})),d.god.bind("closeDialogs",this.hide,this),e("body").append(this.el),this},_navigateToLinksHref:function(){this.hide(),this.options.router&&f.apply(this,arguments)},clean:function(){e(this.options.target).unbind("click",this._handleClick),this.constructor.__super__.clean.apply(this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../view_helpers/navigate_through_router":239}],245:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,"undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,"undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null),e=a("./model"),f=a("./organization-model");b.exports=d.Collection.extend({model:function(a,b){return"org_notification"===a.type?new f(a,b):new e(a)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./model":247,"./organization-model":248}],246:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("../../../scroll/scroll-view"),f=a("../../../../common/view_factory");b.exports=d.admin.DropdownMenu.extend({className:"Dropdown",initialize:function(){d.admin.DropdownMenu.prototype.initialize.apply(this,arguments),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this.template_base()),this._renderDropdown(),this._checkScroll(),$("body").append(this.el),this},_renderDropdown:function(){this.dropdown_content=f.createByTemplate("common/views/dashboard_header/notifications/templates/dropdown_content",{items:this.collection.toJSON(),unreadItems:this.collection.filter(function(a){return!a.get("opened")}).length}),this.addView(this.dropdown_content),this.$(".js-content").html(this.dropdown_content.render().el)},_checkScroll:function(){setTimeout(function(){if(this.$el.height()>=300){var a=new e({createContentView:function(){return this.dropdown_content}.bind(this)});this.addView(a),this.$el.addClass("Dropdown--withScroll"),this.$(".js-content").html(a.render().el)}}.bind(this),301)},_initBinds:function(){d.god.bind("closeDialogs",this.hide,this),this.add_related_model(d.god)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../common/view_factory":237,"../../../scroll/scroll-view":229}],247:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;"undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null;b.exports=c.core.Model.extend({defaults:{type:"",message:"",opened:!1}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],248:[function(a,b,c){var d=a("./model");b.exports=d.extend({url:function(a){return"/api/v3/users/"+this._userId+"/notifications/"+this.id+"?api_key="+this._apiKey},initialize:function(a,b){if(!b.userId)throw new Error("user Id is required");if(!b.apiKey)throw new Error("apiKey is required");this._userId=b.userId,this._apiKey=b.apiKey},markAsRead:function(){this.save({notification:{read_at:new Date}})}})},{"./model":247}],249:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f=a("./collection"),g=a("./dropdown_view");b.exports=d.core.View.extend({attributes:{href:"#/notifications"},tagName:"a",className:"UserNotifications",events:{click:"_openNotifications"},initialize:function(){this.user=this.options.user,this.localStorage=this.options.localStorage,this.template=d.templates.getTemplate("common/views/dashboard_header/notifications/templates/user_notifications"),this.collection=new f,this.collection.reset(this._generateCollection(),{userId:this.user.get("id"),apiKey:this.user.get("api_key"),silent:!0}),this._initBinds()},render:function(){var a=this.collection.filter(function(a){return!a.get("opened")}).length;return this.$el.html(this.template({notificationsCount:a})),this.$el.toggleClass("has--alerts",a>0),this},_initBinds:function(){this.user.bind("change",this._onUserChange,this),this.collection.bind("reset",this.render,this),this.collection.bind("remove",this.render,this),this.add_related_model(this.user),this.add_related_model(this.collection)},_onUserChange:function(){this.collection.reset(this._generateCollection(),{userId:this.user.get("id"),apiKey:this.user.get("api_key")}),this.render()},_generateCollection:function(){var a=[],b={},c=this.user.viewUrl();if(b.isInsideOrg=this.user.isInsideOrg(),b.isOrgOwner=this.user.isOrgOwner(),b.accountType=this.user.get("account_type").toLowerCase(),b.remainingQuota=this.user.get("remaining_byte_quota"),
b.publicProfileUrl=c.publicProfile(),b.bytesQuota=this.user.get("quota_in_bytes"),b.userType="regular",b.upgradeUrl=window.upgrade_url||"",b.upgradeContactEmail=this.user.upgradeContactEmail(),b.trialEnd=this.user.get("trial_ends_at")&&moment(this.user.get("trial_ends_at")).format("YYYY-MM-DD"),b.userName=this.user.get("name")||this.user.get("username"),b.isInsideOrg&&!b.isOrgOwner?b.userType="org":b.isOrgOwner?b.userType="admin":"internal"!==b.accountType&&"partner"!==b.accountType&&"ambassador"!==b.accountType||(b.userType="internal"),!b.isInsideOrg&&"free"===b.accountType&&this.user.get("table_count")>0?a.push({iconFont:"CDB-IconFont-gift",severity:"NotificationsDropdown-itemIcon--positive",type:"try_trial",msg:d.templates.getTemplate("common/views/dashboard_header/notifications/templates/try_trial")(b),opened:this.localStorage.get("notification.try_trial")}):this.localStorage.remove("notification.try_trial"),b.remainingQuota<=0?a.push({iconFont:"CDB-IconFont-barometer",severity:"NotificationsDropdown-itemIcon--negative",type:"limits_exceeded",msg:d.templates.getTemplate("common/views/dashboard_header/notifications/templates/limits_exceeded")(b),opened:this.localStorage.get("notification.limits_exceeded")}):this.localStorage.remove("notification.limits_exceeded"),100*b.remainingQuota/b.bytesQuota<20?a.push({iconFont:"CDB-IconFont-barometer",severity:"NotificationsDropdown-itemIcon--alert",type:"close_limits",msg:d.templates.getTemplate("common/views/dashboard_header/notifications/templates/close_limits")(b),opened:this.localStorage.get("notification.close_limits")}):this.localStorage.remove("notification.close_limits"),this.user.get("show_upgraded_message")?a.push({iconFont:"CDB-IconFont-heartFill",severity:"NotificationsDropdown-itemIcon--positive",type:"upgraded_message",msg:d.templates.getTemplate("common/views/dashboard_header/notifications/templates/upgraded_message")(b),opened:this.localStorage.get("notification.upgraded_message")}):this.localStorage.remove("notification.upgraded_message"),this.user.get("show_trial_reminder")?a.push({iconFont:"CDB-IconFont-clock",severity:"NotificationsDropdown-itemIcon--alert",type:"trial_ends_soon",msg:d.templates.getTemplate("common/views/dashboard_header/notifications/templates/trial_ends_soon")(b),opened:this.localStorage.get("notification.trial_ends_soon")}):this.localStorage.remove("notification.trial_ends_soon"),window.organization_notifications)for(var e=0;e<window.organization_notifications.length;e++){var f=window.organization_notifications[e],g=f.icon?"CDB-IconFont-"+f.icon:"CDB-IconFont-alert";a.push({iconFont:g,severity:"NotificationsDropdown-itemIcon--alert",id:f.id,msg:f.html_body,read_at:f.read_at,type:"org_notification"})}return a},_openNotifications:function(a){if(a&&this.killEvent(a),this.notification)return this.notification.hide(),delete this.notification,this;var b=this.notification=new g({target:this.$el,collection:this.collection,horizontal_offset:5,vertical_offset:-5,template_base:"common/views/dashboard_header/notifications/templates/dropdown"});e(b.options.target).unbind("click",b._handleClick),this._closeAnyOtherOpenDialogs(),b.on("onDropdownHidden",function(){this._onDropdownHidden(b)},this),b.render(),b.open(),this.addView(b)},_onDropdownHidden:function(a){var b=this;this.collection.each(function(a){if("org_notification"===a.get("type"))a.markAsRead();else if(a.get("type")){a.set("opened",!0);var c={};c["notification."+a.get("type")]=!0,b.localStorage.set(c)}}),this.collection.reset(),a.clean(),this.removeView(a),this.$el.removeClass("has--alerts"),delete this.notification},_closeAnyOtherOpenDialogs:function(){d.god.trigger("closeDialogs")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./collection":245,"./dropdown_view":246}],250:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f=a("../../view_helpers/bytes_to_size");b.exports=d.admin.DropdownMenu.extend({className:"Dropdown",initialize:function(){if(this.elder("initialize"),!this.model)throw new Error("model is required");this.template_base=d.templates.getTemplate("common/views/dashboard_header/settings_dropdown")},shortDisplayName:function(a){var b=a.get("account_type_display_name"),c=_.isUndefined(b)?a.get("account_type"):b;return _.isUndefined(c)?c:(c=c.toLowerCase(),"organization user"===c?"org. user":c.replace(/lump-sum/gi,"- A").replace(/academic/gi,"aca.").replace(/ - Monthly/i," - M").replace(/ - Annual/i," - A").replace(/Non-Profit/i,"NP").replace(/On-premises/i,"OP").replace(/Internal use engine/i,"engine").replace(/Lite/i,"L").replace(/Cloud Engine &/i,"C. Engine &").replace(/& Enterprise Builder/i,"& E. Builder").replace(/CARTO for /i,"").replace(/CARTO /i,""))},render:function(){var a=this.model,b=a.get("db_size_in_bytes"),c=a.get("quota_in_bytes"),g=Math.round(b/c*100),h="";g>80&&g<90?h="is--inAlert":g>89&&(h="is--inDanger");var i=this.shortDisplayName(a),j=this.model.viewUrl(),k=window.upgrade_url||d.config.get("upgrade_url")||"";return this.$el.html(this.template_base({name:a.get("name")||a.get("username"),email:a.get("email"),accountType:i,isOrgAdmin:a.isOrgAdmin(),usedDataStr:f(b).toString(2),usedDataPct:g,progressBarClass:h,availableDataStr:f(c).toString(2),showUpgradeLink:k&&(a.isOrgOwner()||!a.isInsideOrg())&&!d.config.get("cartodb_com_hosted"),upgradeUrl:k,publicProfileUrl:j.publicProfile(),apiKeysUrl:j.apiKeys(),organizationUrl:j.organization(),accountSettingsUrl:j.accountSettings(),logoutUrl:j.logout(),isViewer:a.isViewer(),isBuilder:a.isBuilder(),orgDisplayEmail:a.isInsideOrg()?a.organization.display_email:null,engineEnabled:a.get("actions").engine_enabled,mobileAppsEnabled:a.get("actions").mobile_sdk_enabled})),d.god.bind("closeDialogs",this.hide,this),e("body").append(this.el),this},clean:function(){e(this.options.target).unbind("click",this._handleClick),this.constructor.__super__.clean.apply(this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_helpers/bytes_to_size":238}],251:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;"undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null;b.exports=c.core.View.extend({initialize:function(){this.user=this.model,this.template_base=c.templates.getTemplate("common/views/dashboard_header/user_support_template")},render:function(){return this.$el.html(this.template_base({userType:this._getUserType()})),this},_getUserType:function(){var a=this.user.get("account_type").toLowerCase();return this.user.isInsideOrg()?"org":"internal"===a||"partner"===a||"ambassador"===a?"internal":"free"!==a?"client":"regular"}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],252:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("./dashboard_header/settings_dropdown_view"),g=a("./dashboard_header/breadcrumbs/dropdown_view"),h=a("./dashboard_header/notifications/view"),i=a("./dashboard_header/user_support_view");b.exports=e.core.View.extend({events:{"click .js-breadcrumb-dropdown":"_createBreadcrumbsDropdown","click .js-settings-dropdown":"_createSettingsDropdown"},initialize:function(){if(!this.options.el)throw new Error("el element is required");if(!this.options.viewModel)throw new Error("viewModel is required");this._viewModel=this.options.viewModel,this.router=this.options.router,this._initBinds()},render:function(){return this.clearSubViews(),this._renderBreadcrumbsDropdownLink(),this._renderSupportLink(),this._renderNotifications(),this._renderLogoLink(),this},_initBinds:function(){this._viewModel.bind("change",this._renderBreadcrumbsDropdownLink,this),this.router&&(this.router.model.bind("change",this._onRouterChange,this),this.add_related_model(this.router.model)),this.collection&&(this.collection.bind("reset",this._stopLogoAnimation,this),this.collection.bind("error",this._onCollectionError,this),this.add_related_model(this.collection)),this.add_related_model(this._viewModel)},_onCollectionError:function(a,b,c){(!b||b&&"abort"!==b.statusText)&&this._stopLogoAnimation()},_onRouterChange:function(a,b){b&&b.changes&&!b.changes.content_type&&this.collection.total_user_entries>0&&this._startLogoAnimation()},_startLogoAnimation:function(){this.$(".Logo").addClass("is-loading")},_stopLogoAnimation:function(){this.$(".Logo").removeClass("is-loading")},_renderBreadcrumbsDropdownLink:function(){this.$(".js-breadcrumb-dropdown").html(e.templates.getTemplate("common/views/dashboard_header/breadcrumbs/dropdown_link")({title:this._viewModel.breadcrumbTitle(),dropdownEnabled:this._viewModel.isBreadcrumbDropdownEnabled()}))},_renderNotifications:function(){var a=new h({user:this.model,localStorage:this.options.localStorage});this.$(".js-user-notifications").html(a.render().el),this.addView(a)},_renderSupportLink:function(){var a=new i({el:d(".js-user-support"),model:this.model});a.render()},_renderLogoLink:function(){var a=e.templates.getTemplate("common/views/dashboard_header/logo");this.$(".js-logo").html(a({homeUrl:this.model.viewUrl().dashboard(),googleEnabled:this.model.featureEnabled("google_maps")}))},_createSettingsDropdown:function(a){this.killEvent(a),this._setupDropdown(new f({target:d(a.target),model:this.model,horizontal_offset:18}))},_createBreadcrumbsDropdown:function(a){this._viewModel.isBreadcrumbDropdownEnabled()&&(this.killEvent(a),this._setupDropdown(new g({target:d(a.target),model:this.model,viewModel:this._viewModel,router:this.router,horizontal_offset:-110,tick:"center",template_base:"common/views/dashboard_header/breadcrumbs/dropdown"})))},_setupDropdown:function(a){this._closeAnyOtherOpenDialogs(),this.addView(a),a.on("onDropdownHidden",function(){a.clean()},this),a.render(),a.open()},_closeAnyOtherOpenDialogs:function(){e.god.trigger("closeDialogs")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./dashboard_header/breadcrumbs/dropdown_view":244,"./dashboard_header/notifications/view":249,"./dashboard_header/settings_dropdown_view":250,"./dashboard_header/user_support_view":251}],253:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var f="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null,g=a("../../forms/spinner");b.exports=d.core.View.extend({_MAX_RANGE:30,className:"DatePicker",options:{flat:!0,date:["2008-07-31","2008-07-31"],current:"2008-07-31",calendars:2,mode:"range",starts:1},events:{"click .js-dates":"_toggleCalendar","click .js-fourHours":"_setLastFourHours","click .js-oneDay":"_setLastDay","click .js-oneWeek":"_setLastWeek"},initialize:function(){this.model=new d.core.Model({fromDate:"",fromHour:0,fromMin:0,toDate:"",toHour:23,toMin:59,user_timezone:0}),this.template=this.options.template||d.templates.getTemplate("common/views/date_pickers/dates_range"),this._initBinds(),this._setToday()},render:function(){var a=this;return this.clearSubViews(),this.$el.append(this.template(e.extend(this.model.attributes,{max_days:this._MAX_RANGE}))),setTimeout(function(){a._initCalendar(),a._hideCalendar(),a._initTimers()},100),this},_initBinds:function(){e.bindAll(this,"_onDatesChange","_onDocumentClick"),this.model.bind("change",this._setValues,this),this.model.bind("change",this._onValuesChange,this),$(document).bind("click",this._onDocumentClick)},_destroyBinds:function(){$(document).unbind("click",this._onDocumentClick)},_setValues:function(a,b){var c="Choose your dates",e=this.model.attributes;e.fromDate&&e.toDate&&(c="From <strong>"+this.model.get("fromDate")+" "+(d.Utils.pad(this.model.get("fromHour"),2)+":"+d.Utils.pad(this.model.get("fromMin"),2))+"</strong> to <strong>"+this.model.get("toDate")+" "+(d.Utils.pad(this.model.get("toHour"),2)+":"+d.Utils.pad(this.model.get("toMin"),2))+'</strong><i class="CDB-IconFont CDB-IconFont-calendar DatePicker-datesIcon"></i>'),this.$(".DatePicker-dates").html(c)},_setToday:function(){var a=this.model.get("user_timezone"),b=f().utc(a),c=f().utc(a).subtract(this._MAX_RANGE-1,"days");this.options.date=[c.format("YYYY-MM-DD"),b.format("YYYY-MM-DD")],this.options.current=b.format("YYYY-MM-DD"),this._setModelFromPrevious(c)},_initCalendar:function(){var a=".DatePicker-calendar";document.body.contains(this.$(a)[0])&&(this.calendar=this.$(a).DatePicker(e.extend(this.options,{onChange:this._onDatesChange,onRender:function(a){var b=a.valueOf(),c=new Date,d=new Date;return d.setDate(c.getDate()-30),b<d||b>c?{disabled:!0}:""}})))},_onDatesChange:function(a,b){var c=f(a[0]),d=f(a[1]);Math.abs(c.diff(d,"days"))>this._MAX_RANGE&&(a[1]=f(a[0]).add("days",this._MAX_RANGE).format("YYYY-MM-DD"),this.$(".DatePicker-calendar").DatePickerSetDate([a[0],a[1]])),this.model.set({fromDate:a[0],toDate:a[1]})},_hideCalendar:function(a){a&&this.killEvent(a),this.$(".DatePicker-dropdown").hide()},_toggleCalendar:function(a){a&&this.killEvent(a),this.$(".DatePicker-dropdown").toggle()},_setLastFourHours:function(){var a=f().utc(0).subtract(4,"hours");this._setModelFromPrevious(a),this._setDatepickerFromPrevious(a),this.closeCalendar()},_setLastDay:function(){var a=f().utc(0).subtract(1,"day");this._setModelFromPrevious(a),this._setDatepickerFromPrevious(a),this.closeCalendar()},_setLastWeek:function(){var a=f().utc(0).subtract(1,"week");this._setModelFromPrevious(a),this._setDatepickerFromPrevious(a),this.closeCalendar()},_setModelFromPrevious:function(a){var b=f().utc(0);this.model.set({fromDate:a.format("YYYY-MM-DD"),fromHour:parseInt(a.format("H")),fromMin:parseInt(a.format("m")),toDate:b.format("YYYY-MM-DD"),toHour:parseInt(b.format("H")),toMin:parseInt(b.format("m"))})},_setDatepickerFromPrevious:function(a){var b=f().utc(0);this.$(".DatePicker-calendar").DatePickerSetDate([a.format("YYYY-MM-DD"),b.format("YYYY-MM-DD")])},_initTimers:function(){var a=this.$(".DatePicker-timersFrom"),b=new g({model:this.model,property:"fromHour",min:0,max:23,inc:1,width:15,pattern:/^([12]?\d{0,1}|3[01]{0,2})$/,debounce_time:0});a.find(".DatePicker-timersHour").append(b.render().el),this.addView(b);var c=new g({model:this.model,property:"fromMin",min:0,max:59,inc:1,width:15,pattern:/^([12345]?\d{0,1})$/,debounce_time:0});a.find(".DatePicker-timersMin").append(c.render().el),this.addView(c);var d=this.$(".DatePicker-timersTo"),e=new g({model:this.model,property:"toHour",min:0,max:23,inc:1,width:15,pattern:/^([12]?\d{0,1}|3[01]{0,2})$/,debounce_time:0});d.find(".DatePicker-timersHour").append(e.render().el),this.addView(e);var f=new g({model:this.model,property:"toMin",min:0,max:59,inc:1,width:15,pattern:/^([12345]?\d{0,1})$/,debounce_time:0});d.find(".DatePicker-timersMin").append(f.render().el),this.addView(f)},_onValuesChange:function(){this.trigger("changeDate",this.model.toJSON(),this)},getDates:function(){return this.model.toJSON()},closeCalendar:function(){this.$(".DatePicker-dropdown").hide()},_onDocumentClick:function(a){var b=$(a.target);0===b.closest(".DatePicker").length&&this.closeCalendar()},clean:function(){this._destroyBinds(),this.closeCalendar(),this.$(".DatePicker-calendar").DatePickerHide(),d.core.View.prototype.clean.call(this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../forms/spinner":222}],254:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({_TEMPLATES:{8001:"common/views/size_error_details_upgrade_template",8005:"common/views/layers_error_details_upgrade_template",default:"common/views/error_details"},initialize:function(){this.user=this.options.user,this.err=this.options.err},render:function(){var a=this.err.error_code&&parseInt(this.err.error_code),b=c.config.get("upgrade_url"),d=b&&!c.config.get("cartodb_com_hosted")&&(!this.user.isInsideOrg()||this.user.isOrgOwner()),e=this._TEMPLATES.default,f=this.err.original_url,g=this.err.http_response_code,h=this.err.http_response_code_message;d&&this._TEMPLATES[a]&&(e=this._TEMPLATES[a]);var i=c.templates.getTemplate(e);return this.$el.html(i({errorCode:a,title:this.err.title,text:this.err.what_about,itemQueueId:this.err.item_queue_id,originalUrl:f,httpResponseCode:g,httpResponseCodeMessage:h,userCanUpgrade:d,showTrial:this.user.canStartTrial(),upgradeUrl:b})),this}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],255:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({tagName:"a",events:{click:"_toggleLike"},initialize:function(){this.template=c.templates.getTemplate("common/views/likes/template"),this.model.bind("change:likeable change:liked change:likes error",this.render,this)},render:function(){return this.$el.html(this.template({likes:this.model.get("likes"),size:this.model.get("size"),show_count:this.model.get("show_count"),show_label:this.model.get("show_label")})).attr({class:this._classNames(),href:this._hrefLocation()}),this},_hrefLocation:function(){var a="#/like";return this.model.get("likeable")||(a=window.login_url),a},_classNames:function(){var a=["LikesIndicator"];return this.model.get("likeable")&&a.push("is-likeable"),this.model.get("liked")&&a.push("is-liked"),this._animate&&(a.push("is-animated"),this.$el.one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){this._animate=!1,this.render()}.bind(this))),a.join(" ")},_toggleLike:function(a){this.model.get("likeable")&&(this.killEvent(a),this._animate=!0,this.model.toggleLiked())}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],256:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=d.core.View.extend({options:{width:300,height:170,privacy:"PUBLIC",username:"",visId:"",mapsApiResource:"",className:"",authTokens:[]},_TEMPLATES:{regular:"<%- protocol %>://<%= mapsApiResource %>/api/v1/map/static/named/<%- tpl %>/<%- width %>/<%- height %>.png<%= authTokens %>",cdn:"<%- protocol %>://<%- cdn %>/<%- username %>/api/v1/map/static/named/<%- tpl %>/<%- width %>/<%- height %>.png<%= authTokens %>"},initialize:function(){e.each(["visId","mapsApiResource","username"],function(a){this.options[a]||console.log(a+" is required for Static Map instantiation")},this)},load:function(){return this._startLoader(),this._loadFromVisId(),this},_generateImageTemplate:function(){return"tpl_"+this.options.visId.replace(/-/g,"_")},_loadFromVisId:function(){var a=this._isHTTPS()?"https":"http",b=d.config.get("cdn_url"),c=e.template(b?this._TEMPLATES.cdn:this._TEMPLATES.regular),f={protocol:a,username:this.options.username,mapsApiResource:this.options.mapsApiResource,tpl:this._generateImageTemplate(),width:this.options.width,height:this.options.height,authTokens:this._generateAuthTokensParams()};b&&(f=e.extend(f,{cdn:b[a]}));var g=c(f);this._loadImage({},g)},_generateAuthTokensParams:function(){var a=this.options.authTokens;return a&&a.length>0?"?"+e.map(a,function(a){return"auth_token="+a}).join("&"):""},_isHTTPS:function(){return 0===location.protocol.indexOf("https")},loadURL:function(a){var b=c('<img class="MapCard-preview" src="'+a+'" />');this.$el.append(b),this.options.className&&b.addClass(this.options.className),b.fadeIn(250)},showError:function(){this._onError()},_startLoader:function(){this.$el.addClass("is-loading")},_stopLoader:function(){this.$el.removeClass("is-loading")},_onSuccess:function(a){this._stopLoader(),this.loadURL(a),this.trigger("loaded",a)},_onError:function(a){this._stopLoader(),this.$el.addClass("has-error");var b=c('<div class="MapCard-error" />');this.$el.append(b),b.fadeIn(250),this.trigger("error")},_loadImage:function(a,b){var c=this,d=new Image;d.onerror=function(){c._onError(a)},d.onload=function(){c._onSuccess(b)};try{d.src=b}catch(a){this._onError(a)}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],257:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,g="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,h=a("../pagination/model"),i=a("../../view_helpers/random_quote"),j=a("../../view_factory"),k=a("../pagination/view");b.exports=d.core.View.extend({events:{"click .js-search-link":"_onSearchClick","click .js-clean-search":"_onCleanSearchClick","keydown .js-search-input":"_onKeyDown","submit .js-search-form":"killEvent"},initialize:function(){e.each(["collection","pagedSearchModel","createListView"],function(a){if(!this.options[a])throw new Error(a+" is required")},this),this.collection=this.options.collection,this.options.noResults=this.options.noResults||{};var a=this.options.pagedSearchModel;this.paginationModel=new h({current_page:a.get("page"),total_count:this.collection.totalCount()||0,per_page:a.get("per_page")}),this.elder("initialize"),this._initBinds(),this.options.pagedSearchModel.fetch(this.collection)},render:function(){return this.clearSubViews(),this._renderContent(this.getTemplate("common/views/paged_search/paged_search")({thinFilters:this.options.thinFilters,q:this.options.pagedSearchModel.get("q")})),this._initViews(),this._$cleanSearchBtn().hide(),this._renderExtraFilters(),this},_renderExtraFilters:function(){this.options.filtersExtrasView&&this.options.filtersExtrasView&&this.$(".js-filters").append(this.options.filtersExtrasView.render().el)},_renderContent:function(a){this.options.isUsedInDialog&&(a=this.getTemplate("common/views/paged_search/paged_search_dialog_wrapper")({htmlToWrap:a})),this.$el.html(a),this.options.isUsedInDialog&&(this.$el.addClass("Dialog-expandedSubContent"),this._$tabPane().addClass("Dialog-bodyInnerExpandedWithSubFooter"))},_initBinds:function(){this.collection.bind("fetching",function(){this._toggleCleanSearchBtn(),this._activatePane("loading")},this),this.collection.bind("error",function(a){(!a||a&&"abort"!==a.statusText)&&this._activatePane("error"),this._toggleCleanSearchBtn()},this),this.collection.bind("reset",function(a){this.paginationModel.set({total_count:this.collection.totalCount(),current_page:this.options.pagedSearchModel.get("page")}),this._activatePane(this.collection.totalCount()>0?"list":"no_results"),this._toggleCleanSearchBtn()},this),this.paginationModel.bind("change:current_page",function(a,b){this.options.pagedSearchModel.set("page",b),this.options.pagedSearchModel.fetch(this.collection)},this),this.add_related_model(this.options.pagedSearchModel),this.add_related_model(this.collection),this.add_related_model(this.paginationModel)},_toggleCleanSearchBtn:function(){this._$cleanSearchBtn().toggle(!!this.options.pagedSearchModel.get("q"))},_initViews:function(){this._panes=new d.ui.common.TabPane({el:this._$tabPane()}),this.addView(this._panes),this._panes.addTab("list",j.createByList([this._createListView(),new k({className:"CDB-Text CDB-Size-medium Pagination Pagination--shareList",model:this.paginationModel})])),this._panes.addTab("error",j.createByTemplate("common/templates/fail",{msg:""})),this._panes.addTab("no_results",j.createByTemplate("common/templates/no_results",{icon:this.options.noResults.icon||"CDB-IconFont-defaultUser",title:this.options.noResults.title||"Oh! No results",msg:this.options.noResults.msg||"Unfortunately we could not find anything with these parameters"})),this._panes.addTab("loading",j.createByTemplate("common/templates/loading",{title:"Searching",quote:i()})),this.options.pagedSearchModel.get("q")&&this._focusSearchInput(),this._activatePane(this._chooseActivePaneName(this.collection.totalCount()))},_createListView:function(){var a=this.options.createListView();return a instanceof d.core.View?a:(d.log.error("createListView function must return a view"),new d.core.View)},_activatePane:function(a){this._panes&&this._panes.size()>0&&this._panes.active(a).render()},_chooseActivePaneName:function(a){return 0===a?"no_results":a>0?"list":"loading"},_focusSearchInput:function(){this._$searchInput().focus().val(this._$searchInput().val())},_onSearchClick:function(a){this.killEvent(a),this._$searchInput().focus()},_onCleanSearchClick:function(a){this.killEvent(a),this._cleanSearch()},_onKeyDown:function(a){var b=a.keyCode==f.ui.keyCode.ENTER,c=a.keyCode==f.ui.keyCode.ESCAPE;b?(this.killEvent(a),this._submitSearch()):c&&(this.killEvent(a),this.options.pagedSearchModel.get("q")&&this._cleanSearch())},_submitSearch:function(a){this._makeNewSearch(g.stripHTML(this._$searchInput().val().trim()))},_cleanSearch:function(){this._$searchInput().val(""),this._makeNewSearch()},_makeNewSearch:function(a){this.options.pagedSearchModel.set({q:a,page:1}),this.options.pagedSearchModel.fetch(this.collection)},_$searchInput:function(){return this.$(".js-search-input")},_$cleanSearchBtn:function(){return this.$(".js-clean-search")},_$tabPane:function(){return this.$(".js-tab-pane")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_factory":237,"../../view_helpers/random_quote":241,"../pagination/model":258,"../pagination/view":259}],258:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.core.Model.extend({defaults:{total_count:0,per_page:10,current_page:1,display_count:5,extras_display_count:1,url_to:void 0},pagesCount:function(){return Math.max(Math.ceil(this.get("total_count")/this.get("per_page")),1)},isCurrentPage:function(a){return this.get("current_page")===a},shouldBeVisible:function(){var a=this.pagesCount();return this.get("total_count")>0&&a>1&&this.get("current_page")<=a},urlTo:function(a){if(this.hasUrl())return this.get("url_to")(a)},hasUrl:function(){return"function"==typeof this.get("url_to")},pagesToDisplay:function(){var a;return a=this._inLowRange()?1:this._inHighRange()?this.get("current_page")-this._startOffset():this.pagesCount()-this.get("display_count")+1,a=Math.max(a,1),this._withExtraPages(d.range(a,this._rangeEnd(a)))},_withExtraPages:function(a){var b=this.pagesCount(),c=this.get("extras_display_count"),e=d.range(1,c+1),f=d.range(b-c+1,b+1),g=a[0]-e.slice(-1)[0];2===g?e.push(a[0]-1):g>2&&e.push(-1);var h=f[0]-a.slice(-1);return 2===h&&f.unshift(f[0]-1),h>2&&f.unshift(-2),d.union(e,a,f)},_inLowRange:function(){return this.get("current_page")<this._startOffset()},_inHighRange:function(){return this.get("current_page")<this._highBoundary()},_highBoundary:function(){return this.pagesCount()-this._startOffset()},_startOffset:function(){return Math.floor(this.get("display_count")/2)},_rangeEnd:function(a){return Math.min(a+this.get("display_count"),this.pagesCount()+1)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],259:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f=a("../../view_helpers/navigate_through_router");b.exports=d.core.View.extend({className:"Pagination CDB-Text CDB-Size-medium",events:{"click a":"_paginate"},initialize:function(){if(this.template=d.templates.getTemplate("common/views/pagination/template"),this.router=this.options.router,this.router&&!this.model.hasUrl())throw new Error("since router is set the model must have a url method set too");this.model.bind("change",this.render,this)},render:function(){return this.model.shouldBeVisible()?(this.$el.html(this.template({m:this.model,pagesCount:this.model.pagesCount(),currentPage:this.model.get("current_page")})),this.$el.addClass(this.className),this.delegateEvents()):this.$el.html(""),this},_paginate:function(a){this.router?f.apply(this,arguments):this.model.hasUrl()||this.killEvent(a);var b=e(a.target).data("page");this.model.set("current_page",b)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../view_helpers/navigate_through_router":239}],260:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({_TEMPLATES:{partial_import:"common/views/partial_import_details",too_many_files:"common/views/too_many_files_details",too_many_rows_connection:"common/views/too_many_rows_connection_details"},initialize:function(){this.warnings=this.options.warnings},render:function(){var a=this.warnings,b=this._getTemplateKey(a),d=c.templates.getTemplate(this._TEMPLATES[b]);return this.$el.html(d({warnings:a})),this},_getTemplateKey:function(a){return a.user_max_layers&&a.max_tables_per_import?a.user_max_layers<a.max_tables_per_import?"partial_import":"too_many_files":a.user_max_layers?"partial_import":a.max_tables_per_import?"too_many_files":a.max_rows_per_connection?"too_many_rows_connection":void 0}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],261:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({defaults:{content_type:"",page:1,q:"",tag:"",category:"",shared:"no",locked:!1,liked:!1,library:!1,order:"updated_at",deepInsights:!1},isSearching:function(){return this.get("q")||this.get("tag")},isDatasets:function(){return"datasets"===this.get("content_type")},isMaps:function(){return"maps"===this.get("content_type")},isDeepInsights:function(){return this.isMaps()&&this.get("deepInsights")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],262:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,a("../common/background_polling/background_polling_model"));b.exports=d.extend({_onImportsStateChange:function(a){if(this.importsCollection.size()-this.importsCollection.failedItems().length===1&&a.hasCompleted()&&1===a.imp.get("tables_created_count")&&"twitter_search"!==a.imp.get("service_name")){var b=a.importedVis();if(b)return void this._redirectTo(encodeURI(b.viewUrl(this.user).edit()))}a.hasCompleted()&&this.trigger("importCompleted",a,this)},_redirectTo:function(a){window.location=a}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../common/background_polling/background_polling_model":5}],263:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;e.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var g=a("./filters_view"),h=a("./list_view"),i=a("./content_result_view"),j=a("./onboarding_view"),k=a("./content_footer/view"),l=a("./datasets/loading_library_view");
b.exports=e.core.View.extend({initialize:function(){this.user=this.options.user,this.router=this.options.router,this.localStorage=this.options.localStorage,this._initViews(),this._initBindings()},_initBindings:function(){this.router.model.bind("change",this._onRouterChange,this),this.collection.bind("reset",this._onDataFetched,this),this.collection.bind("loading",this._onDataLoading,this),this.collection.bind("add",this._onDataChange,this),this.collection.bind("error",function(a,b,c){(!b||b&&"abort"!==b.statusText)&&this._onDataError()},this),d(window).bind("scroll",this._onWindowScroll),this.add_related_model(this.router.model),this.add_related_model(this.collection)},_initViews:function(){this.controlledViews={},this.enabledViews=[];var a=new j({user:this.user});this.controlledViews.onboarding=a,this.$el.prepend(a.render().el),this.addView(a);var b=new g({el:this.$(".Filters"),headerHeight:this.options.headerHeight,user:this.user,router:this.router,collection:this.collection,localStorage:this.localStorage});this.controlledViews.filters=b,b.render(),this.addView(b);var c=new i({className:"ContentResult no-datasets",user:this.user,router:this.router,collection:this.collection,template:"dashboard/views/content_no_datasets"});c.bind("connectDataset",function(){this.user&&this.user.canCreateDatasets()&&e.god.trigger("openCreateDialog",{type:"dataset"})},this),this.controlledViews.no_datasets=c,this.$(".NoDatasets").append(c.render().el),this.addView(c);var d=new h({user:this.user,router:this.router,collection:this.collection}),f=this;e.god.bind("onTemplateSelected",function(a){f.player&&f.player.close()}),e.god.bind("startTutorial",function(a){f._addVideoPlayer(a)}),this._addVideoPlayer(),this.controlledViews.list=d,this.$("#content-list").append(d.render().el),this.addView(d);var m=new i({router:this.router,collection:this.collection,template:"dashboard/views/content_no_results"});this.controlledViews.no_results=m,this.$el.append(m.render().el),this.addView(m);var n=new i({router:this.router,collection:this.collection,template:"dashboard/views/content_error"}),o=new l;this.controlledViews.loading_library=o,this.$el.append(o.render().el),this.addView(o),this.controlledViews.error=n,this.$el.append(n.render().el),this.addView(n);var p=new i({router:this.router,collection:this.collection,template:"dashboard/views/content_loader"});this.controlledViews.main_loader=p,this.$el.append(p.render().el),this.addView(p);var q=new k({el:this.$("#content-footer"),model:this.user,router:this.router,collection:this.collection});this.controlledViews.content_footer=q,this.$("#content-footer").appendTo(this.$el),this.addView(q)},_onRouterChange:function(a,b){var c=[];b&&b.changes&&b.changes.content_type?c=["filters","main_loader"]:(c=["filters"],this._isBlockEnabled("list")&&this.collection.total_user_entries>0?c.push("list","content_footer"):c.push("main_loader"),(this._isBlockEnabled("no_results")||this._isBlockEnabled("error"))&&(f.contains(c,"main_loader")||c.push("main_loader"))),this._hideBlocks(),this._showBlocks(c),this._scrollToTop()},_onDataLoading:function(){this.$el.removeClass("on-boarding")},_onDataFetched:function(){var a=["filters","content_footer"],b=this.router.model.get("tag"),c=this.router.model.get("q"),d=this.router.model.get("shared"),f=this.router.model.get("liked"),g=this.router.model.get("locked"),h=this.router.model.get("library");if(h&&0===this.collection.total_user_entries&&a.push("no_datasets"),0===this.collection.size())if(b||c||"no"!==d||g||f)a.push("no_results");else if("maps"===this.router.model.get("content_type")){if(this.collection.total_shared>0)return void this.router.navigate(this.user.viewUrl().dashboard().maps().urlToPath("shared"),{trigger:!0});this.$el.addClass("on-boarding"),a=["onboarding","filters"]}else if(h)a.push("loading_library"),this.controlledViews.loading_library.retrySoonAgainOrAbortIfLeavingLibrary(this.collection,this.router.model);else if(h||"datasets"!==this.router.model.get("content_type"))a.push("no_results");else{if(this.collection.total_shared>0)return void this.router.navigate(this.user.viewUrl().dashboard().datasets().urlToPath("shared"),{trigger:!0});if(this.user.hasCreateDatasetsFeature()&&e.config.get("data_library_enabled"))return void this.router.navigate(this.user.viewUrl().dashboard().datasets().dataLibrary(),{trigger:!0});a.push("no_results")}else a.push("list");this._hideBlocks(),this._showBlocks(a)},_onDataChange:function(){this.collection.fetch()},_onDataError:function(a){this._hideBlocks(),this._showBlocks(["filters","error"])},_showBlocks:function(a){var b=this;a?f.each(a,function(a){b.controlledViews[a].show(),b.enabledViews.push(a)}):(b.enabledViews=[],f.each(this.controlledViews,function(a){a.show(),b.enabledViews.push(a)}))},_hideBlocks:function(a){var b=this;a?f.each(a,function(a){b.controlledViews[a].hide(),b.enabledViews=f.without(b.enabledViews,a)}):(f.each(this.controlledViews,function(a){a.hide()}),b.enabledViews=[])},_isBlockEnabled:function(a){return!!a&&f.contains(this.enabledViews,a)},_scrollToTop:function(){d("body").animate({scrollTop:0},550)},_addVideoPlayer:function(a){var b={id:a};this.player=new e.admin.VideoPlayer(b),this.player.hasVideoData()&&this.$el.append(this.player.render().$el)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./content_footer/view":264,"./content_result_view":265,"./datasets/loading_library_view":267,"./filters_view":271,"./list_view":273,"./onboarding_view":278}],264:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../common/views/pagination/model"),f=a("../../common/views/pagination/view"),g=a("../../common/view_helpers/pluralize_string"),h=a("../../common/view_helpers/navigate_through_router"),i="filter-shortcut",j={};j["click #"+i+" a"]=h,b.exports=d.core.View.extend({events:j,initialize:function(a){if(!a.el)throw new Error("The root element must be provided from parent view");this.collection=a.collection,this.router=a.router,this.router.model.bind("change",this.render,this),this.add_related_model(this.router.model),this._createPaginationView(this.collection,this.router),this._setupFilterShortcut(this.collection,this.router)},render:function(){return this.clearSubViews(),this._renderFilterShortcut(),this._renderPaginationView(),this},_createPaginationView:function(a,b){var c=new e({current_page:b.model.get("page"),url_to:function(a){return b.currentUrl({page:a})}});a.bind("all",_.partial(this._updatePaginationModelByCollection,c,a)),b.model.bind("change",_.partial(this._updatePaginationModelByRouter,c,b.model)),this.paginationView=new f({model:c,router:this.router}),this.addView(this.paginationView)},_updatePaginationModelByCollection:function(a,b){a.set({per_page:b.options.get("per_page"),total_count:b.total_entries})},_updatePaginationModelByRouter:function(a,b){a.set("current_page",b.get("page"))},_renderFilterShortcut:function(){this.$el.append('<div id="'+i+'"></div>'),this._renderFilterShortcut=function(){var a="",b=this.router.model,c=this.router.currentDashboardUrl(),d=this.filterShortcutVis.total_entries,e={totalCount:d,pluralizedContents:this._pluralizedContentType(d),url:b.get("locked")?c:c.lockedItems()};b.get("locked")?a=this.filterShortcutNonLockedTemplate(e):d>0&&this._isLockInfoNeeded()&&(a=this.filterShortcutLockedTemplate(e)),this.$("#"+i).html(a)}},_pluralizedContentType:function(a){var b=this.router.model.get("content_type").slice(0,-1);return g(b,a)},_setupFilterShortcut:function(a,b){this.filterShortcutLockedTemplate=d.templates.getTemplate("dashboard/content_footer/filter_shortcut/locked_template"),this.filterShortcutNonLockedTemplate=d.templates.getTemplate("dashboard/content_footer/filter_shortcut/non_locked_template"),this.filterShortcutVis=new d.admin.Visualizations,a.bind("loaded",this._updateFilterShortcut,this),this.add_related_model(a)},_isLockInfoNeeded:function(){return"no"===this.router.model.get("shared")&&!this.router.model.get("library")&&!this.router.model.isSearching()},_updateFilterShortcut:function(){if(this._isLockInfoNeeded()){this.filterShortcutVis.options.set({locked:!this.router.model.get("locked"),shared:"no",page:1,per_page:1,only_liked:this.router.model.get("liked"),q:this.router.model.get("q"),tag:this.router.model.get("tags"),type:"datasets"===this.router.model.get("content_type")?"table":"derived"});var a=this;this.filterShortcutVis.fetch({success:function(b){a.render()}})}else this.render()},_renderPaginationView:function(){this.paginationView.render(),this.$el.append(this.paginationView.el)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/view_helpers/navigate_through_router":239,"../../common/view_helpers/pluralize_string":240,"../../common/views/pagination/model":258,"../../common/views/pagination/view":259}],265:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var e=a("../common/view_helpers/navigate_through_router"),f=a("../common/view_helpers/random_quote");b.exports=d.core.View.extend({events:{"click .js-mail-link":"_onMailClick","click .js-link":e,"click .js-connect":"_onConnectClick"},initialize:function(){this.user=this.options.user,this.router=this.options.router,this.template=d.templates.getTemplate(this.options.template),this._initBinds()},render:function(){return this.$el.html(this.template({defaultUrl:this.router.currentDashboardUrl(),page:this.router.model.get("page"),tag:this.router.model.get("tag"),q:this.router.model.get("q"),shared:this.router.model.get("shared"),liked:this.router.model.get("liked"),locked:this.router.model.get("locked"),library:this.router.model.get("library"),isSearching:this.router.model.isSearching(),quote:f(),type:this.router.model.get("content_type"),totalItems:this.collection.size(),totalEntries:this.collection.total_entries})),this},_initBinds:function(){this.router.model.bind("change",this.render,this),this.collection.bind("remove add reset",this.render,this),this.add_related_model(this.router.model),this.add_related_model(this.collection)},_onMailClick:function(a){a&&a.stopPropagation()},_onConnectClick:function(a){a&&a.preventDefault(),this.trigger("connectDataset",this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../common/view_helpers/navigate_through_router":239,"../common/view_helpers/random_quote":241}],266:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null,f="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,g=a("../../common/view_helpers/navigate_through_router"),h=a("../../common/view_helpers/pluralize_string"),i=a("../../common/views/likes/view"),j=a("../../dashboard/editable_fields/editable_description"),k=a("../../dashboard/editable_fields/editable_tags"),l=a("../../common/dialogs/sync_dataset/sync_dataset_view");b.exports=d.core.View.extend({tagName:"li",className:"DatasetsList-item DatasetsList-item--selectable",events:{"click .js-tag-link":g,"click .js-privacy":"_openPrivacyDialog","click .js-sync":"_openSyncDialog",click:"_selectDataset"},initialize:function(){this.user=this.options.user,this.router=this.options.router,this.template=d.templates.getTemplate("dashboard/views/datasets_item"),this._initBinds()},render:function(){this.clearSubViews();var a=this.model,b=a.tableMetadata(),c=a.get("tags")||[],d=a.viewUrl(this.user);d=this.router.model.get("liked")&&!a.permission.hasAccess(this.user)?d.public():d.edit();var g={isRaster:"raster"===a.get("kind"),geometryType:b.statsGeomColumnTypes().length>0?b.statsGeomColumnTypes()[0]:"",title:a.get("name"),datasetUrl:encodeURI(d),isOwner:a.permission.isOwner(this.user),owner:a.permission.owner.renderData(this.user),showPermissionIndicator:!a.permission.hasWriteAccess(this.user),privacy:a.get("privacy").toLowerCase(),likes:a.get("likes")||0,timeDiff:e(a.get("updated_at")).fromNow(),tags:c,tagsCount:c.length,router:this.router,maxTagsToShow:3,rowCount:void 0,datasetSize:void 0,syncStatus:void 0,syncRanAt:void 0,fromExternalSource:""},i=b.get("row_count");i>=0&&(g.rowCount=i<1e4?f.formatNumber(i):f.readizableNumber(i),g.pluralizedRows=h("Row",i)),_.isEmpty(a.get("synchronization"))||(g.fromExternalSource=a.get("synchronization").from_external_source);var j=b.get("size");return j>=0&&(g.datasetSize=f.readablizeBytes(j,!0)),_.isEmpty(a.get("synchronization"))||(g.syncRanAt=e(a.get("synchronization").ran_at||new Date).fromNow(),g.syncStatus=a.get("synchronization").state),this.$el.html(this.template(g)),this._renderDescription(),this._renderTags(),this._renderLikesIndicator(),this._renderTooltips(),this.$el[a.get("selected")?"addClass":"removeClass"]("is--selected"),this},_initBinds:function(){this.model.on("change",this.render,this)},_renderDescription:function(){var a=this.model.permission.isOwner(this.user),b=new j({el:this.$(".js-item-description"),model:this.model,editable:a&&this.user.hasCreateDatasetsFeature()});this.addView(b.render())},_renderTags:function(){var a=this.model.permission.isOwner(this.user),b=new k({el:this.$(".js-item-tags"),model:this.model,router:this.router,editable:a&&this.user.hasCreateDatasetsFeature()});this.addView(b.render())},_renderLikesIndicator:function(){var a=new i({model:this.model.like});this.$(".js-likes-indicator").replaceWith(a.render().el),this.addView(a)},_renderTooltips:function(){var a=this.model.get("synchronization");_.isEmpty(a)||this.addView(new d.common.TipsyTooltip({el:this.$(".js-syncInfo"),title:function(a){return $(this).attr("data-title")}})),this.model.permission.isOwner(this.user)||this.addView(new d.common.TipsyTooltip({el:this.$(".UserAvatar"),title:function(a){return $(this).attr("data-title")}})),!_.isEmpty(a)&&a.from_external_source&&this.addView(new d.common.TipsyTooltip({el:this.$(".js-public"),title:function(a){return $(this).attr("data-title")}}))},_openPrivacyDialog:function(a){this.killEvent(a),d.god.trigger("openPrivacyDialog",this.model)},_openSyncDialog:function(a){this.killEvent(a);var b=new l({clean_on_hide:!0,enter_to_confirm:!0,table:this.model.tableMetadata()}),c=this,d=b.ok;b.ok=function(){d.apply(b,arguments),c.model.fetch()},b.appendToBody()},_selectDataset:function(a){"A"!==a.target.tagName&&(this.killEvent(a),this.model.set("selected",!this.model.get("selected")))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/dialogs/sync_dataset/sync_dataset_view":205,"../../common/view_helpers/navigate_through_router":239,"../../common/view_helpers/pluralize_string":240,"../../common/views/likes/view":255,"../../dashboard/editable_fields/editable_description":269,"../../dashboard/editable_fields/editable_tags":270}],267:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({render:function(){return this.$el.html(c.templates.getTemplate("common/templates/loading")({title:"Your Data library is being stocked up",quote:"Please wait while we load the list of Datasets in the Data library for you."})),this},retrySoonAgainOrAbortIfLeavingLibrary:function(a,b){var c,d=function(){clearTimeout(c),b.unbind("all",d),a.unbind("reset",d)},e=function(){c=setTimeout(function(){a.bind("reset",d),a.fetch()},1e4)};b.bind("all",d),e()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],268:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../dashboard/datasets/datasets_item"),f=a("../../common/view_helpers/navigate_through_router"),g=a("../../common/background_polling/models/upload_config"),h="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,i=a("../../common/view_helpers/pluralize_string");b.exports=e.extend({tagName:"li",className:"DatasetsList-item",events:{"click .js-tag-link":f,click:"_selectDataset"},initialize:function(){this.user=this.options.user,this.router=this.options.router,this.template=d.templates.getTemplate("dashboard/views/remote_datasets_item"),this.table=new d.admin.CartoDBTableMetadata(this.model.get("external_source")),this._initBinds()},render:function(){var a=this.model,b=this.table,c=a.get("tags")||[],d=a.get("description")&&h.stripHTML(markdown.toHTML(a.get("description")))||"",e=a.get("source")&&markdown.toHTML(a.get("source"))||"",f={isRaster:"raster"===a.get("kind"),geometryType:b.statsGeomColumnTypes().length>0?b.statsGeomColumnTypes()[0]:"",title:a.get("display_name")||a.get("name"),source:e,description:d,timeDiff:moment(a.get("updated_at")).fromNow(),tags:c,tagsCount:c.length,router:this.router,maxTagsToShow:3,canImportDataset:this._canImportDataset(),rowCount:void 0,datasetSize:void 0,fromExternalSource:""},g=b.get("row_count");g>=0&&(f.rowCount=g<1e4?h.formatNumber(g):h.readizableNumber(g),f.pluralizedRows=i("Row",g)),_.isEmpty(a.get("synchronization"))||(f.fromExternalSource=a.get("synchronization").from_external_source);var j=b.get("size");return j>=0&&(f.datasetSize=h.readablizeBytes(j,!(j.toString().length>9))),this.$el.html(this.template(f)),this._setItemClasses(),this._renderTooltips(),this},_renderTooltips:function(){this.addView(new d.common.TipsyTooltip({el:this.$(".DatasetsList-itemStatus"),title:function(a){return $(this).attr("data-title")}}))},_setItemClasses:function(){this.$el[this.model.get("selected")?"addClass":"removeClass"]("is--selected"),this.$el[this._canImportDataset()?"addClass":"removeClass"]("DatasetsList-item--selectable"),this.$el[this._canImportDataset()?"removeClass":"addClass"]("DatasetsList-item--banned")},_canImportDataset:function(){var a=this.table.get("size")||0;return this.user.get("remaining_byte_quota")*g.fileTimesBigger>=a&&this.user.get("limits").import_file_size>a},_selectDataset:function(a){"A"!==a.target.tagName&&this._canImportDataset()&&(this.killEvent(a),this.model.set("selected",!this.model.get("selected")))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/background_polling/models/upload_config":18,"../../common/view_helpers/navigate_through_router":239,"../../common/view_helpers/pluralize_string":240,"../../dashboard/datasets/datasets_item":266}],269:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({events:{"click .js-add-btn":"_edit","click .js-field-input":"killEvent","blur .js-field-input":"_cancelEditing","keydown .js-field-input":"_keyPressed"},options:{editable:!0,maxLength:200},initialize:function(){this.template=c.templates.getTemplate("dashboard/editable_fields/editable_description"),this.$el.addClass("EditableField")},render:function(){var a=c.core.sanitize.html(markdown.toHTML(this.model.get("description")||"")),b={safeHTML:a,clean:c.Utils.stripHTML(a)};return this.$el.html(this.template({value:b,editable:this.options.editable,maxLength:this.options.maxLength})),this},_edit:function(a){this.killEvent(a),this.$el.addClass("is-editing"),this.$(".js-field-input").val("").focus()},_keyPressed:function(a){var b=a.keyCode==$.ui.keyCode.ESCAPE,c=(a.metaKey||a.ctrlKey)&&a.keyCode==$.ui.keyCode.ENTER,d=a.keyCode==$.ui.keyCode.ENTER,e=this.$(".js-field-input").val();c?(a.preventDefault(),this._addNewLine()):d&&""!=e.trim()?(a.preventDefault(),this._save()):b&&this._cancelEditing()},_addNewLine:function(){var a=this.$(".js-field-input");a.val(a.val()+"\n"),a[0].scrollTop=a[0].scrollHeight},_save:function(){var a={description:this.$(".js-field-input").val()};this.model.save(a),this.$el.removeClass("is-editing"),this.render()},_cancelEditing:function(){this.$el.removeClass("is-editing")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],270:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({events:{"click .js-add-btn":"_edit","click .js-field-input":"killEvent","keydown .js-field-input":"_keyPressed","blur .js-field-input":"_cancelEditing"},initialize:function(){this.template=c.templates.getTemplate("dashboard/editable_fields/editable_tags"),this.editable=this.options.editable,this.$el.addClass("EditableField")},render:function(){var a=this.model.get("tags")||[];return this.$el.html(this.template({tags:_.compact(a),tagsCount:a.length,editable:this.editable,router:this.options.router})),this},_edit:function(a){this.killEvent(a),this.$el.addClass("is-editing"),this.$(".js-field-input").val("").focus()},_keyPressed:function(a){var b=a.keyCode==$.ui.keyCode.ENTER,c=a.keyCode==$.ui.keyCode.ESCAPE;b?this._save():c&&this._cancelEditing()},_save:function(){var a=this.$(".js-field-input").val().split(",").map(function(a){return c.Utils.stripHTML(a.trim())});a=_.chain(a).compact().uniq().value(),this.model.save({tags:a}),this.$el.removeClass("is-editing"),this.render()},_cancelEditing:function(a){this.$el.removeClass("is-editing")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],271:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,g="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,h=a("../common/view_helpers/navigate_through_router"),i=a("../common/view_helpers/pluralize_string"),j=a("../common/dialogs/duplicate_vis_view"),k=a("../common/dialogs/delete_items_view"),l=a("../common/dialogs/change_lock/change_lock_view"),m=a("../common/dialogs/change_lock/change_lock_view_model"),n=a("../common/dialogs/delete_items_view_model");b.exports=d.core.View.extend({_TOOLTIPS:["js-likes","js-mapviews","js-updated_at","js-size"],events:{"submit .js-search-form":"_submitSearch","keydown .js-search-form":"_onSearchKeyDown","click .js-search-form":"killEvent","click .js-search-link":"_onSearchClick","click .js-clean-search":"_onCleanSearchClick","click .js-deselect_all":"_unselectAll","click .js-select_all":"_selectAll","click .js-order-link":"_changeOrder","click .js-delete":"_openDeleteItemsDialog","click .js-create_map":"_createMap","click .js-import_remote":"_importRemote","click .js-new_dataset":"_connectDataset","click .js-duplicate_dataset":"_duplicateDataset","click .js-duplicate_map":"_duplicateMap","click .js-new_map":"_newMap","click .js-lock":"_openChangeLockDialog","click .js-privacy":"_openPrivacyDialog","click .js-link":h},initialize:function(){this.router=this.options.router,this.user=this.options.user,this.localStorage=this.options.localStorage,this.model=new d.core.Model,this._preRender(),this._initBinds()},_preRender:function(){var a=e("<div>").addClass("u-inner"),b=e("<div>").addClass("Filters-inner js-skip-unselect-all");this.$el.append(a.append(b))},render:function(a,b){this.clearSubViews();var c=this._selectedItems().length,e=b&&b.changes&&b.changes.content_type,g=this.router.model.get("content_type"),h=this.router.model.isDeepInsights(),j=h?"dashboard":g.slice(0,-1),k=d.templates.getTemplate(h?"dashboard/views/filters_deep_insights":"dashboard/views/filters"),l=i(j,e?0:this.collection.total_user_entries),m=i(j,c);return this.$(".Filters-inner").html(k(f.extend({canCreateDatasets:this.user.canCreateDatasets(),hasCreateMapsFeature:this.user.hasCreateMapsFeature(),hasCreateDatasetsFeature:this.user.hasCreateDatasetsFeature(),canDeleteItems:this._canDeleteSelectedItems(),order:this.localStorage.get("dashboard.order"),isInsideOrg:this.user.isInsideOrg(),isMaps:this.router.model.isMaps(),selectedItemsCount:c,isSelectedItemLibrary:this._isSelectedItemLibrary(),maxLayersByMap:this.user.getMaxLayers(),totalShared:e?0:this.collection.total_shared,totalLiked:e?0:this.collection.total_likes,totalItems:e?0:this.collection.total_user_entries,pageItems:this.collection.size(),router:this.router,currentDashboardUrl:this.router.currentDashboardUrl(),pluralizedContentType:l,pluralizedContentTypeSelected:m},this.router.model.attributes))),this._initViews(),this._checkScroll(),this._animate(),this.router.model.isSearching()&&this._focusSearchInput(),this},_initBinds:function(){this.model.on("change:isSearchEnabled",this._onChangeIsSearchEnabled,this),this.router.model.bind("change",this.render,this),this.collection.bind("loading",function(){this.$el.removeClass("is-relative")},this),this.collection.bind("add remove change reset",this.render,this),this.user.bind("change:remaining_byte_quota",this.render,this),d.god.bind("closeDialogs",this._animate,this),d.god.bind("unselectAllItems",this._unselectAll,this),f.bindAll(this,"_onWindowScroll"),this.add_related_model(this.collection),this.add_related_model(this.router.model),this.add_related_model(this.user),this.add_related_model(d.god)},_checkScroll:function(){var a=this.router.model.get("content_type"),b=this.router.model.get("shared"),c=this.router.model.get("locked"),d=this.router.model.get("liked"),e=this.router.model.isSearching(),f=this.collection.total_entries;0!==f||"maps"!==a||"no"!==b||c||d||e?(this.$el.removeClass("is-relative"),this._bindScroll()):(this.$el.addClass("is-relative"),this._unbindScroll())},_bindScroll:function(){this._unbindScroll(),e(window).bind("scroll",this._onWindowScroll)},_unbindScroll:function(){e(window).unbind("scroll",this._onWindowScroll)},_initViews:function(){var a=this;f.each(this._TOOLTIPS,function(b){a.addView(new d.common.TipsyTooltip({el:a.$("."+b),title:function(){var b=a.$el.hasClass("is-fixed");return b?"":"Order by "+e(this).attr("data-title")}}))})},_selectedItems:function(){return this.collection.where({selected:!0})},_animate:function(){this.$(".Filters-inner").toggleClass("show-second-row",this._selectedItems().length>0),this._enableSearchUI(!!this.router.model.isSearching())},_selectAll:function(a){this._select(a,!0)},_unselectAll:function(a){this._select(a,!1)},_select:function(a,b){this.killEvent(a);this.user;this.collection.each(function(a){a.set("selected",b)})},_openDeleteItemsDialog:function(a){a.preventDefault();var b=new n(this._selectedItems(),{contentType:this.router.model.get("content_type")});b.bind("DeleteItemsDone",function(){this.user.fetch(),this.collection.fetch()},this);var c=new k({viewModel:b,user:this.user,clean_on_hide:!0,enter_to_confirm:!0});c.appendToBody()},_openChangeLockDialog:function(a){a.preventDefault();var b=new m({items:this._selectedItems(),contentType:this.router.model.get("content_type")});b.bind("change:state",function(){"ProcessItemsDone"===b.get("state")&&this.collection.fetch()},this);var c=new l({model:b,clean_on_hide:!0,enter_to_confirm:!0});c.appendToBody()},_openPrivacyDialog:function(a){a.preventDefault(),d.god.trigger("openPrivacyDialog",this._selectedItems()[0])},_onSearchClick:function(a){this.killEvent(a),this.model.set("isSearchEnabled",!this.model.get("isSearchEnabled"))},_onChangeIsSearchEnabled:function(a,b){this._enableSearchUI(b),this.router.model.isSearching()?this._cleanSearch():b&&(this._$searchInput().val(""),this._focusSearchInput())},_$searchInput:function(){return this.$(".js-search-input")},_focusSearchInput:function(){this._$searchInput().select(),this._$searchInput().focus()},_enableSearchUI:function(a){this.$(".js-search-field").toggle(a),this.$(".js-links-list").toggle(!a),this.$(".js-order-list").toggle(!a)},_onSearchKeyDown:function(a){27===a.keyCode&&this._cleanSearch()},_createMap:function(a){a&&a.preventDefault(),this._openCreateDialog("map",!0)},_newMap:function(a){a&&a.preventDefault(),d.god.trigger("metrics","create_map",{email:window.user_data.email}),this._openCreateDialog("map")},_connectDataset:function(a){a&&a.preventDefault(),d.god.trigger("metrics","connect_dataset",{email:window.user_data.email}),this.user.canCreateDatasets()&&this._openCreateDialog("dataset")},_duplicateDataset:function(a){a&&this.killEvent(a);var b=this._selectedItems();if(1===b.length){var c=b[0],e=c.tableMetadata(),f=e.get("name");d.god.trigger("importByUploadData",{type:"duplication",table_name:e.getUnqualifiedName()+"_copy",value:f,create_vis:!1})}},_duplicateMap:function(a){a&&this.killEvent(a);var b=this._selectedItems();if(1===b.length){var c=b[0],d=c.tableMetadata();new j({model:c,table:d,user:this.user,clean_on_hide:!0}).appendToBody()}},_importRemote:function(a){a&&this.killEvent(a);var b=this._selectedItems();if(1===b.length){var c=b[0],e=c.get("table"),f={type:"remote",value:c.get("name"),remote_visualization_id:c.get("id"),size:e&&e.size,create_vis:!1};d.god.trigger("importByUploadData",f,this),this._select(!1)}},_openCreateDialog:function(a,b){d.god.trigger("openCreateDialog",{type:a,selectedItems:b?this._selectedItems():[]})},_onCleanSearchClick:function(a){this.killEvent(a),this._cleanSearch()},_submitSearch:function(a){this.killEvent(a),this._navigateToUrl({search:g.stripHTML(this.$(".js-search-input").val().trim(),""),page:1,liked:!1,shared:"no",library:!1,locked:!1})},_cleanSearch:function(){this._navigateToUrl({search:"",liked:!1,library:!1,shared:"no"}),this.model.set("isSearchEnabled",!1)},_navigateToUrl:function(a){this.router.navigate(this.router.currentUrl(a),{trigger:!0})},_changeOrder:function(a){a&&a.preventDefault();var b=e(a.target).closest(".js-order-link"),c="updated_at";b.hasClass("js-mapviews")&&(c="mapviews"),b.hasClass("js-likes")&&(c="likes"),b.hasClass("js-size")&&(c="size"),this.router.model.get("order")!==c&&(this.localStorage.set({"dashboard.order":c}),this.router.model.set("order",c))},_onWindowScroll:function(){var a=e(window).scrollTop(),b=this.options.headerHeight+(this.user.get("notification")?this.options.headerHeight:0);this.$el[a>b?"addClass":"removeClass"]("is-fixed with-long-separator")},_canDeleteSelectedItems:function(){var a=this;return!f.find(this._selectedItems(),function(b){return!b.permission.isOwner(a.user)||"remote"===b.get("type")})},_isSelectedItemLibrary:function(){var a=this._selectedItems();return 1===a.length&&"remote"===a[0].get("type")},clean:function(){this._unbindScroll(),d.core.View.prototype.clean.call(this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../common/dialogs/change_lock/change_lock_view":49,"../common/dialogs/change_lock/change_lock_view_model":50,"../common/dialogs/delete_items_view":107,"../common/dialogs/delete_items_view_model":108,"../common/dialogs/duplicate_vis_view":112,"../common/view_helpers/navigate_through_router":239,"../common/view_helpers/pluralize_string":240}],272:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({initialize:function(a){this.router=a,this.router.model.bind("change",this.trigger.bind(this,"change"))},breadcrumbTitle:function(){var a=this.router.model.get("content_type");return this.isDisplayingLockedItems()?"Locked "+a:this.isDisplayingDeepInsights()?"Deep insights":a&&a[0].toUpperCase()+a.slice(1)},isBreadcrumbDropdownEnabled:function(){return!0},isDisplayingDatasets:function(){return"datasets"===this.router.model.get("content_type")},isDisplayingMaps:function(){return"maps"===this.router.model.get("content_type")},isDisplayingLockedItems:function(){return!!this.router.model.get("locked")},isDisplayingDeepInsights:function(){var a=this.router.model;return a.isDeepInsights()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});
},{}],273:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./datasets/datasets_item"),g=a("./maps/maps_item"),h=a("./maps/deep_insights_item"),i=a("./maps/placeholder_item_view"),j=a("./datasets/remote_datasets_item"),k=a("../common/map_templates"),l=3;b.exports=d.core.View.extend({tagName:"ul",events:{},_ITEMS:{remotes:j,datasets:f,deepInsights:h,maps:g},initialize:function(){this.router=this.options.router,this.user=this.options.user,this._initBinds()},render:function(){return this.clearSubViews(),this.$el.attr("class",this.router.model.isDatasets()?"DatasetsList":"MapsList"),this.collection.each(this._addItem,this),this.router.model.isMaps()&&this.collection.size()>0&&this._fillEmptySlotsWithPlaceholderItems(),this},show:function(){this.$el.removeClass("is-hidden")},hide:function(){this.$el.addClass("is-hidden")},_addItem:function(a){var b=this.router.model.get("content_type");"remote"===a.get("type")&&this.router.model.isDatasets()&&(b="remotes"),this.router.model.isDeepInsights()&&(b="deepInsights");var c=new this._ITEMS[b]({model:a,router:this.router,user:this.user});this.addView(c),this.$el.append(c.render().el)},_initBinds:function(){this.collection.bind("loading",this._onItemsLoading,this),this.collection.bind("reset",this.render,this),this.add_related_model(this.collection)},_onItemsLoading:function(){this.$el.addClass("is-loading")},_fillEmptySlotsWithPlaceholderItems:function(){var a=e.shuffle(k);e.times(this._emptySlotsCount(),function(b){var c=a[b];if(c){var e=new d.core.Model(c),f=new i({model:e,collection:this.collection});this.$el.append(f.render().el),this.addView(f)}},this)},_emptySlotsCount:function(){return(this.collection._ITEMS_PER_PAGE-this.collection.size())%l}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../common/map_templates":226,"./datasets/datasets_item":266,"./datasets/remote_datasets_item":268,"./maps/deep_insights_item":274,"./maps/maps_item":275,"./maps/placeholder_item_view":276}],274:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null;a("../../common/view_helpers/navigate_through_router"),"undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null,b.exports=d.core.View.extend({className:"MapsList-item",tagName:"li",initialize:function(){this.router=this.options.router,this.user=this.options.user,this.template=d.templates.getTemplate("dashboard/views/deep_insights_item")},render:function(){this.clearSubViews();var a=this.model.deepInsightsUrl(this.user);return this.$el.html(this.template({url:a,title:this.model.get("title"),description:this.model.get("description"),timeDiff:e(this.model.get("updated_at")).fromNow()})),this}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/view_helpers/navigate_through_router":239}],275:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.moment:"undefined"!=typeof c?c.moment:null,f=a("../../common/view_helpers/navigate_through_router"),g=a("../../dashboard/mapviews_graph"),h=a("../../common/views/mapcard_preview"),i=a("../../common/views/likes/view"),j=a("../../dashboard/editable_fields/editable_description"),k=a("../../dashboard/editable_fields/editable_tags");"undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null,b.exports=d.core.View.extend({className:"MapsList-item",tagName:"li",events:{"click tag-link":f,"click .js-privacy":"_openPrivacyDialog",click:"_onCardClick"},initialize:function(){this.router=this.options.router,this.user=this.options.user,this.template=d.templates.getTemplate("dashboard/views/maps_item"),this._initBinds()},render:function(){this.clearSubViews();var a=this.model.viewUrl(this.user);return a=this.router.model.get("liked")&&!this.model.permission.hasAccess(this.user)?a.public():a.edit(),this.$el.html(this.template({url:a,name:this.model.get("name"),privacy:this.model.get("privacy").toLowerCase(),isOwner:this.model.permission.isOwner(this.user),owner:this.model.permission.owner.renderData(this.user),showPermissionIndicator:!this.model.permission.hasWriteAccess(this.user),timeDiff:e(this.model.get("updated_at")).fromNow(),likes:this.model.get("likes")||0,liked:this.model.get("liked")||!1})),this._renderDescription(),this._renderTags(),this._renderMapviewsGraph(),this._renderLikesIndicator(),this._renderMapThumbnail(),this._renderTooltips(),this._checkSelected(),this},_initBinds:function(){this.model.on("change:selected",this._checkSelected,this),this.model.on("change:privacy",this.render,this)},_renderDescription:function(){var a=this.model.permission.isOwner(this.user),b=new j({el:this.$(".js-item-description"),model:this.model,editable:a&&this.user.hasCreateMapsFeature()});this.addView(b.render())},_renderTags:function(){var a=this.model.permission.isOwner(this.user),b=new k({el:this.$(".js-item-tags"),model:this.model,router:this.router,editable:a&&this.user.hasCreateMapsFeature()});this.addView(b.render())},_renderLikesIndicator:function(){var a=new i({model:this.model.like});this.$(".js-likes-indicator").replaceWith(a.render().el),this.addView(a)},_renderMapviewsGraph:function(){var a=new g({el:this.$(".js-header-graph"),stats:this.model.get("stats")});this.addView(a.render())},_renderTooltips:function(){this.model.permission.isOwner(this.user)||this.addView(new d.common.TipsyTooltip({el:this.$(".UserAvatar"),title:function(a){return $(this).attr("data-title")}}))},_renderMapThumbnail:function(){var a=this.model.get("zoom"),b=this.model.permission.owner,c=b.get("username"),e=(a+2<=this.model.map.get("maxZoom")?a+2:a,new h({el:this.$(".js-header"),privacy:this.model.get("privacy"),mapsApiResource:d.config.getMapsResourceName(c),username:c,visId:this.model.get("id"),authTokens:this.model.get("auth_tokens")}));this.imageURL?e.loadURL(this.imageURL):e.load(),e.bind("loaded",function(a){this.imageURL=a},this),this.addView(e)},_checkSelected:function(){this.$(".MapCard")[this.model.get("selected")?"addClass":"removeClass"]("is-selected")},_openPrivacyDialog:function(a){this.killEvent(a),d.god.trigger("openPrivacyDialog",this.model)},_onCardClick:function(a){if(!$(a.target).closest("a")[0]){this.killEvent(a);var b=this.model.permission.isOwner(this.user);b&&this.model.set("selected",!this.model.get("selected"))}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/view_helpers/navigate_through_router":239,"../../common/views/likes/view":255,"../../common/views/mapcard_preview":256,"../../dashboard/editable_fields/editable_description":269,"../../dashboard/editable_fields/editable_tags":270,"../../dashboard/mapviews_graph":277}],276:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=(a("../../common/dialogs/create/create_view"),a("../../common/dialogs/video_tutorial/video_tutorial_view"));b.exports=d.core.View.extend({className:"MapsList-item",tagName:"li",events:{"click .js-open":"_openVideoTutorialDialog"},initialize:function(){this.template=d.templates.getTemplate("dashboard/maps/placeholder_item")},render:function(){return this.clearSubViews(),this.$el.html(this.template({desc:this.model.get("short_description"),icon:this.model.get("icon")})),this},_openVideoTutorialDialog:function(){var a=new e({videoId:this.model.get("videoId"),clean_on_hide:!0,enter_to_confirm:!1});d.god.trigger("onTemplateSelected",this),a.appendToBody()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/dialogs/create/create_view":70,"../../common/dialogs/video_tutorial/video_tutorial_view":212}],277:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../common/view_helpers/pluralize_string"),f="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null,g="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null;b.exports=d.core.View.extend({options:{stats:[],width:127,height:22},initialize:function(){this.options.stats=g.map(this.options.stats,function(a,b){return{mapviews:a,when:b,today:moment(new Date(b)).format("DD/MM/YYYY")==moment(new Date).format("DD/MM/YYYY")}})},render:function(){var a=this,b=this.options.width,c=this.options.height,g=this.options.stats,h=2,i=d3.scale.ordinal().rangeRoundBands([0,b],.1),j=d3.scale.linear().range([c,0]),k=d3.svg.axis().scale(i).orient("bottom"),l=d3.select(this.$el[0]).append("svg").attr("width",b).attr("height",c).append("g");return i.domain(g.map(function(a){return a.when})),j.domain([0,d3.max(g,function(a){return a.mapviews})]),l.append("g").attr("class","x axis").attr("transform","translate(0,"+c+")").call(k),l.selectAll(".bar").data(g).enter().append("rect").attr("class","MapviewsGraph-bar").attr("data-title",function(a){return f.formatNumber(a.mapviews)+" "+e("mapview",a.mapviews)+(a.today?" today":" on "+a.when)}).attr("x",function(a){return i(a.when)}).attr("width",3).attr("y",function(a){var b=c-j(a.mapviews),d=j(a.mapviews);return b<h?c-h:d}).attr("height",function(a){var b=c-j(a.mapviews);return b<h?h:b}).on("mouseover",function(b){if(b.mapviews>0){var c=$(d3.select(this)[0]);a.addView(new d.common.TipsyTooltip({el:c,className:"MapviewsGraph-tooltip",html:!0,trigger:"manual",title:function(a){return $(this).attr("data-title")}})),c.tipsy("show")}}).on("mouseout",function(a){if(a.mapviews>0){var b=$(d3.select(this)[0]);b.tipsy("hide"),b.unbind("mouseleave mouseenter")}}),this}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../common/view_helpers/pluralize_string":240}],278:[function(a,b,c){(function(c){"use strict";var d="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null;f.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof c?c.cdb.admin:null;var g=a("../common/views/create_default_fallback_map");b.exports=f.core.View.extend({tagName:"div",className:"OnBoarding",events:{"click .js-createMap":"_createMap"},initialize:function(){this.user=this.options.user,this.template=f.templates.getTemplate("dashboard/views/onboarding"),this._resizeMap(),this._initBindings()},render:function(){return this.$el.html(this.template({username:this.user.get("name")||this.user.get("username"),hasCreateMapsFeature:this.user.hasCreateMapsFeature()})),this},_renderMap:function(){this.map||(this.map=g({el:this.$(".js-onboarding-map"),baselayer:f.config.get("default_fallback_basemap"),scrollwheel:!1}))},_createMap:function(){f.god.trigger("openCreateDialog",{type:"map"})},_destroyMap:function(){this.map&&this.map.remove()},_initBindings:function(){e.bindAll(this,"_resizeMap"),d(window).on("resize",this._resizeMap)},_destroyBindings:function(){d(window).off("resize",this._resizeMap)},_resizeMap:function(){this.$el.height(window.innerHeight-71)},show:function(){this.$el.show(),this._renderMap()},hide:function(){this.$el.hide()},clean:function(){this._destroyMap(),this._destroyBindings(),f.core.View.prototype.clean.call(this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../common/views/create_default_fallback_map":243}],279:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e=a("../common/router"),f=a("../common/visualizations_fetch_model"),g=a("./router/current_url_model"),h="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null;b.exports=e.extend({routes:{"":"_changeRouteToMaps","?:queries":"_changeRouteToMaps",dashboard:"_changeRouteToMaps","dashboard?:queries":"_changeRouteToMaps","*prefix/dashboard":"_changeRouteToMaps","*prefix/dashboard?:queries":"_changeRouteToMaps",tables:"_changeRouteToDatasets","tables/:whatever":"_changeRouteToDatasets",visualizations:"_changeRouteToMaps","visualizations/:whatever":"_changeRouteToMaps",":content_type/search/:q":"_changeRouteToSearch",":content_type/search/:q/:page":"_changeRouteToSearch",":content_type/shared/tag/:tag":"_changeRouteToTag",":content_type/shared/tag/:tag/:page":"_changeRouteToTag",":content_type/liked/tag/:tag":"_changeRouteToTag",":content_type/liked/tag/:tag/:page":"_changeRouteToTag",":content_type/locked/tag/:tag":"_changeRouteToTag",":content_type/locked/tag/:tag/:page":"_changeRouteToTag",":content_type/library/tag/:tag":"_changeRouteToTag",":content_type/library/tag/:tag/:page":"_changeRouteToTag",":content_type/tag/:tag":"_changeRouteToTag",":content_type/tag/:tag/:page":"_changeRouteToTag","datasets/liked":"_changeRouteToDatasets","datasets/liked/":"_changeRouteToDatasets","datasets/liked?:q":"_changeRouteToDatasets","datasets/liked/:page":"_changeRouteToDatasets","datasets/liked/:page?:q":"_changeRouteToDatasets","datasets/shared":"_changeRouteToDatasets","datasets/shared/":"_changeRouteToDatasets","datasets/shared?:q":"_changeRouteToDatasets","datasets/shared/:page":"_changeRouteToDatasets","datasets/shared/:page?:q":"_changeRouteToDatasets","datasets/locked":"_changeRouteToDatasets","datasets/locked/":"_changeRouteToDatasets","datasets/locked?:q":"_changeRouteToDatasets","datasets/locked/:page":"_changeRouteToDatasets","datasets/locked/:page?:q":"_changeRouteToDatasets","datasets/library":"_changeRouteToDatasets","datasets/library/":"_changeRouteToDatasets","datasets/library?:q":"_changeRouteToDatasets","datasets/library/:page":"_changeRouteToDatasets","datasets/library/:page?:q":"_changeRouteToDatasets",datasets:"_changeRouteToDatasets","datasets/":"_changeRouteToDatasets","datasets?:q":"_changeRouteToDatasets","datasets/:page":"_changeRouteToDatasets","datasets/:page?:q":"_changeRouteToDatasets","maps/shared":"_changeRouteToMaps","maps/shared/":"_changeRouteToMaps","maps/shared?:q":"_changeRouteToMaps","maps/shared/:page":"_changeRouteToMaps","maps/shared/:page?:q":"_changeRouteToMaps","maps/locked":"_changeRouteToMaps","maps/locked/":"_changeRouteToMaps","maps/locked?:q":"_changeRouteToMaps","maps/locked/:page":"_changeRouteToMaps","maps/locked/:page?:q":"_changeRouteToMaps","maps/shared/locked":"_changeRouteToMaps","maps/shared/locked/":"_changeRouteToMaps","maps/shared/locked?:q":"_changeRouteToMaps","maps/shared/locked/:page":"_changeRouteToMaps","maps/shared/locked/:page?:q":"_changeRouteToMaps","maps/liked":"_changeRouteToMaps","maps/liked/":"_changeRouteToMaps","maps/liked?:q":"_changeRouteToMaps","maps/liked/:page":"_changeRouteToMaps","maps/liked/:page?:q":"_changeRouteToMaps",maps:"_changeRouteToMaps","maps/":"_changeRouteToMaps","maps?:q":"_changeRouteToMaps","maps/:page":"_changeRouteToMaps","maps/:page?:q":"_changeRouteToMaps","deep-insights":"_changeRouteToDeepInsights","deep-insights/":"_changeRouteToDeepInsights","deep-insights?:q":"_changeRouteToDeepInsights","deep-insights/:page":"_changeRouteToDeepInsights","deep-insights/:page?:q":"_changeRouteToDeepInsights"},initialize:function(a){this._dashboardUrl=a.dashboardUrl,this._rootPath=this._dashboardUrl.pathname(),this.model=new f({}),this._currentUrl=new g({visFetchModel:this.model,dashboardUrl:this._dashboardUrl})},rootPath:function(){return this._rootPath},normalizeFragmentOrUrl:function(a){return a&&a.toString().replace(this._dashboardUrl,"")||this.currentDashboardUrl().toString()},currentDashboardUrl:function(){return this._currentUrl.forCurrentContentType()},currentUrl:function(a){return this._currentUrl.forCurrentState(a)},_changeRouteToSearch:function(a,b,c){c=this._getPage(c),this.model.set({action:"search",content_type:a,q:h.stripHTML(decodeURIComponent(b),""),tag:"",page:c,shared:"yes",locked:null,liked:null,library:null,deepInsights:!1})},_changeRouteToTag:function(a,b,c){c=this._getPage(c),this.model.set({action:"tag",content_type:a,tag:h.stripHTML(decodeURIComponent(b),""),q:"",page:c,shared:"yes",locked:null,liked:null,library:null,deepInsights:!1})},_changeRouteToDatasets:function(a){a=this._getPage(a);var b=this._doesCurrentUrlContain("datasets/shared"),c=this._doesCurrentUrlContain("datasets/locked")||this._doesCurrentUrlContain("shared/locked"),d=this._doesCurrentUrlContain("datasets/liked"),e=this._doesCurrentUrlContain("datasets/library");this.model.set({content_type:"datasets",page:a,q:"",tag:"",shared:b?"only":"no",locked:c,liked:d,library:e,deepInsights:!1})},_changeRouteToMaps:function(a){a=this._getPage(a);var b=this._doesCurrentUrlContain("maps/shared"),c=this._doesCurrentUrlContain("maps/locked")||this._doesCurrentUrlContain("shared/locked"),d=this._doesCurrentUrlContain("maps/liked");this.model.set({content_type:"maps",page:a,q:"",tag:"",shared:b?"only":"no",locked:c,liked:d,library:!1,deepInsights:!1})},_changeRouteToDeepInsights:function(a){a=this._getPage(a),this.model.set({content_type:"maps",page:a,q:"",tag:"",shared:"no",locked:!1,liked:!1,library:!1,deepInsights:!0})},_doesCurrentUrlContain:function(a){return Backbone.history.fragment.search(a)!==-1},_getPage:function(a){return a=parseInt(a),a&&d.isNumber(a)?a:1}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../common/router":228,"../common/visualizations_fetch_model":261,"./router/current_url_model":280}],280:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.core.Model.extend({defaults:{dashboardUrl:void 0,visFetchModel:void 0},initialize:function(){if(d.bindAll(this,"_appendPage","_appendSearch","_appendLocked","_appendLibrary","_appendSharedOrLiked"),!this.get("dashboardUrl"))throw new Error("dashboardUrl is required");if(!this.get("visFetchModel"))throw new Error("visFetchModel is required")},forCurrentContentType:function(){var a=this.get("visFetchModel").get("content_type")||"datasets";return this.get("dashboardUrl")[this.isDeepInsights()?"deepInsights":a]()},forCurrentState:function(a){var b=d.extend([this.forCurrentContentType()],a),e=d.compose(this._appendPage,this._appendSearch,this._appendLocked,this._appendLibrary,this._appendSharedOrLiked)(b).join("/");return new c.common.Url({base_url:e})},isSearching:function(){var a=this.get("visFetchModel");return a.get("q")||a.get("tag")},isDeepInsights:function(){var a=this.get("visFetchModel");return this.isMaps()&&a.get("deepInsights")},isDatasets:function(){return"datasets"===this.get("visFetchModel").get("content_type")},isMaps:function(){return"maps"===this.get("visFetchModel").get("content_type")},_appendPage:function(a){var b=a.page;return d.isUndefined(b)&&(b=this.get("visFetchModel").get("page")),b>1&&a.push(encodeURIComponent(b)),a},_appendSearch:function(a){var b=[],c=a.search;if(d.isUndefined(c)){var e=this.get("visFetchModel"),f=e.get("tag"),g=e.get("q");f?b=this._keyValueItems("tag",f):g&&(b=this._keyValueItems("search",g))}else 0===c.search(":")?b=this._keyValueItems("tag",c.replace(":","")):d.isEmpty(c)||(b=this._keyValueItems("search",c));return a.push.apply(a,b),a},_keyValueItems:function(a,b){return[a,encodeURIComponent(b)]},_appendLocked:function(a){var b=a.locked;return(d.isUndefined(b)&&this.get("visFetchModel").get("locked")||b)&&a.push("locked"),a},_appendLibrary:function(a){var b=a.library;return(d.isUndefined(b)&&this.get("visFetchModel").get("library")||b)&&a.push("library"),a},_appendSharedOrLiked:function(a){var b=a.shared,c=a.liked;return d.isUndefined(b)&&"only"===this.get("visFetchModel").get("shared")||"only"===b?a.push("shared"):(d.isUndefined(c)&&this.get("visFetchModel").get("liked")||c)&&a.push("liked"),a}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],281:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../../common/views/mapcard_preview");"undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null;b.exports=d.core.View.extend({tagName:"li",className:"MapsList-item",initialize:function(){this.template=d.templates.getTemplate("data_library/content/list/dataset_item_template")},render:function(){this.clearSubViews();var a=this.model,b={vis:a.attributes,date:"updated_at"===a.get("order")?a.get("updated_at"):a.get("created_at"),datasetSize:this._getDatasetSize(a.get("table").size),geomType:this._getGeometryType(a.get("table").geometry_types),account_host:d.config.get("account_host"),dataset_base_url:d.config.get("dataset_base_url")};return this.$el.html(this.template(b)),this._renderMapThumbnail(),this},_renderMapThumbnail:function(){var a=this.model.get("permission").owner.username,b=new e({el:this.$(".js-header"),username:a,width:298,height:220,visId:this.model.get("id"),mapsApiResource:d.config.getMapsResourceName(a)});this.imageURL?b.loadURL(this.imageURL):b.load(),b.bind("loaded",function(a){this.imageURL=a},this),this.addView(b)},_getGeometryType:function(a){if(a&&a.length>0){var b=["point","polygon","line","raster"],c=a[0];return _.find(b,function(a){return c.toLowerCase().indexOf(a)!==-1})}return null},_getDatasetSize:function(a){return a?d.Utils.readablizeBytes(a,!0).split(" "):0}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../common/views/mapcard_preview":256}],282:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"MapsList-item MapsList-item--fake",tagName:"li",initialize:function(){this.template=c.templates.getTemplate("data_library/content/list/placeholder_item_template")},render:function(){return this.clearSubViews(),this.$el.html(this.template()),this}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],283:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("./dataset_item_view"),g=a("./placeholder_item_view"),h=3;b.exports=d.core.View.extend({tagName:"ul",initialize:function(){this._initBinds()},render:function(){1===this.collection.options.get("page")&&this.clearSubViews(),this.collection.each(this._addItem,this);var a="MapsList";return this.collection._ITEMS_PER_PAGE*this.collection.options.get("page")>=this.collection.total_entries&&(a+=" is-bottom"),this.$el.attr("class",a),this.collection.size()>0&&this._fillEmptySlotsWithPlaceholderItems(),this},show:function(){this.$el.removeClass("is-hidden")},hide:function(){this.$el.addClass("is-hidden")},_addItem:function(a){var b=new f({model:a});this.addView(b),this.$el.append(b.render().el)},_initBinds:function(){this.collection.bind("reset",this.render,this),this.add_related_model(this.collection)},_fillEmptySlotsWithPlaceholderItems:function(){e.times(this._emptySlotsCount(),function(a){var b=new g;this.$el.append(b.render().el),this.addView(b)},this)},_emptySlotsCount:function(){return(this.collection._ITEMS_PER_PAGE-this.collection.size())%h}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./dataset_item_view":281,"./placeholder_item_view":282}],284:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../common/view_helpers/random_quote");b.exports=d.core.View.extend({initialize:function(){this.template=d.templates.getTemplate(this.options.template),this._initBinds()},render:function(){return this.$el.html(this.template({defaultUrl:"",page:this.collection.options.get("page"),isSearching:this.model.get("is_searching"),tag:this.collection.options.get("tags"),q:this.collection.options.get("q"),quote:e(),type:this.collection.options.get("type"),totalItems:this.collection.size(),totalEntries:this.collection.total_entries})),this},_initBinds:function(){this.collection.bind("change",this.render,this),this.collection.bind("remove add reset",this.render,this),this.add_related_model(this.collection)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/view_helpers/random_quote":241}],285:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.admin.Visualizations.extend({_ITEMS_PER_PAGE:12,model:c.core.Model,url:function(){var a="//"+c.config.get("data_library_user")+"."+c.config.get("account_host")+"/api/v1/viz";return a+="?"+this._createUrlOptions()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],286:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;c.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof a?a.cdb.admin:null;var d="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null;b.exports=c.admin.DropdownMenu.extend({className:"CDB-Text Dropdown Dropdown--public",events:{click:"killEvent","click .js-all":"_onClickAll","click .js-categoryLink":"_onClickLink"},initialize:function(){this.elder("initialize"),this.template_base=c.templates.getTemplate("data_library/filters/dropdown/template"),c.god.bind("closeDialogs",this.hide,this),this._initBinds()},_initBinds:function(){this.add_related_model(this.collection)},_onClickAll:function(a){this.collection.options.set({tags:"",page:1}),this.hide()},_onClickLink:function(a){var b=d(a.target).text();this.collection.options.set({tags:b,page:1}),this.hide()},render:function(){return this.$el.html(this.template_base({})),d("body").append(this.el),this},clean:function(){this.elder("clean")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],287:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./dropdown/view"),f="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof c?c.cdb.Utils:null;b.exports=d.core.View.extend({events:{"submit .js-search-form":"_submitSearch","keydown .js-search-form":"_onSearchKeyDown","click .js-search-form":"killEvent","click .js-search-link":"_onSearchClick","click .js-clean-search":"_onCleanSearchClick","click .js-categoriesDropdown":"_createDropdown"},initialize:function(){this.template=d.templates.getTemplate("data_library/filters/template"),this._preRender(),this._initBinds()},_preRender:function(){var a=$("<div>").addClass("u-inner"),b=$("<div>").addClass("Filters-inner");this.$el.append(a.append(b))},render:function(){return this.$(".Filters-inner").html(this.template({tag:this.collection.options.get("tags"),q:this.collection.options.get("q")})),this},_initBinds:function(){this.collection.bind("add remove change reset",this.render,this),this.collection.options.bind("change:tags",this.render,this),this.add_related_model(this.collection),this.add_related_model(this.collection.options),this.add_related_model(d.god)},_createDropdown:function(a){this.killEvent(a),this._setupDropdown(new e({target:$(a.target).closest(".js-categoriesDropdown"),horizontal_position:"horizontal_left",horizontal_offset:-90,tick:"center",collection:this.collection,position:"offset",vertical_offset:-20}))},_setupDropdown:function(a){this._closeAnyOtherOpenDialogs(),this.addView(a),d.god.bind("closeDialogs",function(){a.clean()},this),this.add_related_model(d.god),a.render(),a.open()},_closeAnyOtherOpenDialogs:function(){d.god.trigger("closeDialogs")},_onSearchClick:function(a){this.killEvent(a),this.$(".js-search-input").val(""),this.$(".js-search-input").focus()},_onSearchKeyDown:function(a){27===a.keyCode&&this._onSearchClick(a)},_onCleanSearchClick:function(a){this.killEvent(a),this._cleanSearch()},_submitSearch:function(a){this.killEvent(a),this.model.set("is_searching",!0),this.collection.options.set({q:f.stripHTML(this.$(".js-search-input").val().trim(),""),page:1}),this.render()},_cleanSearch:function(){this.model.set("is_searching",!1),this.collection.options.set({q:"",page:1}),this.render()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./dropdown/view":286}],288:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null;b.exports=c.core.View.extend({className:"DataLibrary-header",initialize:function(){_.bindAll(this,"_addGeojsonData"),this.ACTIVE_CARTODB_ID=null,this.template_base=c.templates.getTemplate("data_library/header/template"),this._initBindings()},events:{"click .js-country":"_onClickCountry","click .js-back":"_onClickBack"},_initBindings:function(){this.model.bind("change:show_more",this._onChangeShowMore,this),this.model.bind("change:vis_count",this._onChangeVisCount,this),this.model.bind("change:show_countries",this._onChangeCountries,this)},load:function(){this.map=L.map(this.$("#DataLibraryMap")[0],{zoomControl:!1,attributionControl:!1}).setView([44,-31],3);var a=c.config.get("sql_api_template").replace("{user}",c.config.get("data_library_user")),b=a+"/api/v2/sql?q="+encodeURIComponent("select * from world_borders")+"&format=geojson&filename=world_borders";d.getJSON(b).done(this._addGeojsonData)},_addGeojsonData:function(a){var b=this,c={color:"#2E3C43",weight:1,opacity:1,fillColor:"#242D32",fillOpacity:1};this.layer=L.geoJson(a,{style:c,onEachFeature:function(a,c){c.on("click",function(d){a.properties.cartodb_id!=b.ACTIVE_CARTODB_ID&&b._onClickFeature(a,c,d.layer)}).on("mouseover",function(a){b._onMouseOverFeature(c,a.target)}).on("mouseout",function(){b._onMouseOutFeature()})}}).addTo(this.map)},_onClickFeature:function(a,b,c){this.ACTIVE_CARTODB_ID=a.properties.cartodb_id,this.layer.eachLayer(function(a){a.setStyle({fillColor:"#242D32"})}),b.setStyle({fillColor:"#fff"});var d=c.getBounds();this.map.fitBounds(d),this._updateBounds([d._southWest.lng,d._southWest.lat,d._northEast.lng,d._northEast.lat])},_onMouseOverFeature:function(a,b){var c=this;this.layer.eachLayer(function(a){a.feature.properties.cartodb_id!=c.ACTIVE_CARTODB_ID&&a.setStyle({fillColor:"#242D32"})}),b.feature.properties.cartodb_id!=this.ACTIVE_CARTODB_ID&&a.setStyle({fillColor:"#616567"})},_onMouseOutFeature:function(){var a=this;this.layer.eachLayer(function(b){b.feature.properties.cartodb_id!=a.ACTIVE_CARTODB_ID&&b.setStyle({fillColor:"#242D32"})})},show:function(){d(".js-Header-title").removeClass("is-hidden"),d(".js-Header-footer").removeClass("is-hidden"),this.$el.addClass("is-active")},hide:function(){d(".js-Header-title").addClass("is-hidden"),d(".js-Header-footer").addClass("is-hidden"),this.$el.removeClass("is-active")},_updateBounds:function(a){this.collection.options.set({bbox:a.join(","),page:1})},_onClickCountry:function(){this.model.set("show_countries",!0)},_onClickBack:function(){this.model.set("show_countries",!1),this.ACTIVE_CARTODB_ID=null,this.collection.options.set({bbox:"",page:1}),this.map.setView([44,-31],3),this.layer.eachLayer(function(a){a.setStyle({fillColor:"#242D32"})})},render:function(){return this.$el.html(this.template_base({})),this},_onChangeCountries:function(){
this.$(".js-Header-title").toggleClass("is-hidden",this.model.get("show_countries")),this.$(".js-CountrySelector").toggleClass("is-hidden",this.model.get("show_countries")),this.$(".js-CountrySelector-back").toggleClass("is-hidden",!this.model.get("show_countries")),this.$el.toggleClass("is-active",this.model.get("show_countries"))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],289:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./filters/view"),f=a("./content/list/view"),g=a("./content/view"),h=a("./datasets_collection"),i=a("./header/view");b.exports=d.core.View.extend({events:{"click .js-more":"_onClickMore"},initialize:function(){this._initModels(),this._initViews(),this._initBindings()},_initViews:function(){this.controlledViews={},this.enabledViews=[];var a=new i({model:this.model,collection:this.collection});this.addView(a),$(".js-Header--datalibrary").append(a.render().el),a.load();var b=new e({el:this.$(".Filters"),collection:this.collection,model:this.model});b.render(),this.addView(b);var c=new g({model:this.model,collection:this.collection,template:"data_library/content/more_template"});this.$el.append(c.render().el),this.addView(c);var d=new f({collection:this.collection});this.$(".js-DataLibrary-content").append(d.render().el),this.addView(d),this.controlledViews.list=d;var h=new g({model:this.model,collection:this.collection,template:"data_library/content/no_results_template"});this.$el.append(h.render().el),this.addView(h),this.controlledViews.no_results=h;var j=new g({model:this.model,collection:this.collection,template:"data_library/content/error_template"});this.$el.append(j.render().el),this.addView(j),this.controlledViews.error=j;var k=new g({model:this.model,collection:this.collection,template:"data_library/content/loader_template"});this.$el.append(k.render().el),this.addView(k),this.controlledViews.main_loader=k},_fetchCollection:function(){this.collection.fetch()},render:function(){return this._fetchCollection(),this},_initBindings:function(){this.model.bind("change:show_more",this._onChangeShowMore,this),this.model.bind("change:vis_count",this._onChangeVisCount,this),this.collection.options.bind("change:tags",function(){this.model.set({vis_count:0})},this),this.collection.options.bind("change:bbox",function(){this.model.set({vis_count:0})},this),this.collection.options.bind("change",function(){this.model.set({show_more:!1}),this._fetchCollection()},this),this.collection.bind("reset",function(){this._onDataFetched()},this),this.collection.bind("loading",function(){1===this.collection.options.get("page")?this._showLoader():this._showLoaderOnly()},this),this.collection.bind("error",function(a,b,c){(!b||b&&"abort"!==b.statusText)&&this._onDataError(b)},this),this.add_related_model(this.collection),this.add_related_model(this.collection.options)},_onChangeVisCount:function(){this.model.get("vis_count")>=this.collection.total_entries?this.model.set({show_more:!1}):this.model.set({show_more:!0})},_onChangeShowMore:function(){this.$(".js-more").toggleClass("is-hidden",!this.model.get("show_more"))},_onDataFetched:function(){var a=[];0===this.collection.size()?a.push("no_results"):(this.model.set({vis_count:this.model.get("vis_count")+this.collection.length,show_more:!0}),a.push("list")),this._hideBlocks(),this._showBlocks(a)},_onDataError:function(a){window.trackJs&&window.trackJs.track&&window.trackJs.track(a),this._hideBlocks(),this._showBlocks(["error"])},_showBlocks:function(a){var b=this;a?_.each(a,function(a){b.controlledViews[a].show(),b.enabledViews.push(a)}):(b.enabledViews=[],_.each(this.controlledViews,function(a){a.show(),b.enabledViews.push(a)}))},_hideBlocks:function(a){var b=this;a?_.each(a,function(a){b.controlledViews[a].hide(),b.enabledViews=_.without(b.enabledViews,a)}):(_.each(this.controlledViews,function(a){a.hide()}),b.enabledViews=[])},_isBlockEnabled:function(a){return!!a&&_.contains(this.enabledViews,a)},_showLoader:function(){this._hideBlocks(),this._showBlocks(["main_loader"])},_showLoaderOnly:function(){this._showBlocks(["main_loader"])},_hideLoader:function(){this._hideBlocks(["main_loader"])},_initModels:function(){this.model=new d.core.Model({vis_count:0,show_countries:!1,is_searching:!1}),this.collection=new h,this._resetOptions()},_resetOptions:function(){this.collection.options.set({q:"",order:"updated_at",page:1,tags:"",bbox:"",source:[],type:"table"})},_onClickMore:function(a){this.killEvent(a),this.model.set({show_more:!1}),this.collection.options.set({page:this.collection.options.get("page")+1})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./content/list/view":283,"./content/view":284,"./datasets_collection":285,"./filters/view":287,"./header/view":288}],290:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null;c.editor={CreateVisFirstView:a("./common/dialogs/create_vis_first/create_vis_first_view"),ImportsCollection:a("./common/background_polling/models/imports_collection"),GeocodingModel:a("./common/background_polling/models/geocoding_model"),LonLatGeocodingModel:a("./common/background_polling/models/lon_lat_geocoding_model"),BackgroundPollingModel:a("./editor/background_polling_model"),ImagePickerView:a("./common/dialogs/map/image_picker_view"),BackgroundPollingView:a("./common/background_polling/background_polling_view"),AddLayerView:a("./common/dialogs/map/add_layer_view"),SyncView:a("./common/dialogs/sync_dataset/sync_dataset_view"),ScratchView:a("./common/dialogs/map/scratch_view"),AddLayerModel:a("./common/dialogs/map/add_layer_model"),FeatureDataView:a("./common/dialogs/feature_data/feature_data_dialog_view"),ChangePrivacyView:a("./common/dialogs/change_privacy/change_privacy_view"),EditVisMetadataView:a("./common/dialogs/edit_vis_metadata/edit_vis_metadata_dialog_view"),DeleteItemsView:a("./common/dialogs/delete_items_view"),DeleteItemsViewModel:a("./common/dialogs/delete_items_view_model"),DeleteLayerView:a("./common/dialogs/delete_layer/delete_layer_view"),DeleteColumnView:a("./common/dialogs/delete_column/delete_column_view"),DeleteRowView:a("./common/dialogs/delete_row/delete_row_view"),ExportImageResultView:a("./common/dialogs/static_image/export_image_result_view"),AdvancedExportView:a("./common/dialogs/static_image/advanced_export_view"),PublishView:a("./common/dialogs/publish/publish_view"),ChangeLockViewModel:a("./common/dialogs/change_lock/change_lock_view_model"),ChangeLockView:a("./common/dialogs/change_lock/change_lock_view"),BuilderFeaturesWarningDialog:a("./common/dialogs/builder_features_warning/builder_features_warning_view"),PecanView:a("./common/dialogs/pecan/pecan_view"),DuplicateVisView:a("./common/dialogs/duplicate_vis_view"),DuplicateDatasetView:a("./common/dialogs/duplicate_dataset_view"),ExportView:a("./common/dialogs/export/export_view"),MergeDatasetsView:a("./common/dialogs/merge_datasets/merge_datasets_view"),GeoreferenceView:a("./common/dialogs/georeference/georeference_view"),LimitsReachView:a("./common/dialogs/limits_reach/limits_reached_view"),MamufasImportView:a("./common/mamufas_import/mamufas_import_view"),AddCustomBasemapView:a("./common/dialogs/add_custom_basemap/add_custom_basemap_view"),ViewFactory:a("./common/view_factory"),randomQuote:a("./common/view_helpers/random_quote.js"),ExportMapView:a("./common/dialogs/export_map/export_map_view")}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./common/background_polling/background_polling_view":6,"./common/background_polling/models/geocoding_model":8,"./common/background_polling/models/imports_collection":13,"./common/background_polling/models/lon_lat_geocoding_model":15,"./common/dialogs/add_custom_basemap/add_custom_basemap_view":30,"./common/dialogs/builder_features_warning/builder_features_warning_view":48,"./common/dialogs/change_lock/change_lock_view":49,"./common/dialogs/change_lock/change_lock_view_model":50,"./common/dialogs/change_privacy/change_privacy_view":51,"./common/dialogs/create_vis_first/create_vis_first_view":105,"./common/dialogs/delete_column/delete_column_view":106,"./common/dialogs/delete_items_view":107,"./common/dialogs/delete_items_view_model":108,"./common/dialogs/delete_layer/delete_layer_view":109,"./common/dialogs/delete_row/delete_row_view":110,"./common/dialogs/duplicate_dataset_view":111,"./common/dialogs/duplicate_vis_view":112,"./common/dialogs/edit_vis_metadata/edit_vis_metadata_dialog_view":115,"./common/dialogs/export/export_view":116,"./common/dialogs/export_map/export_map_view":117,"./common/dialogs/feature_data/feature_data_dialog_view":119,"./common/dialogs/georeference/georeference_view":130,"./common/dialogs/limits_reach/limits_reached_view":147,"./common/dialogs/map/add_layer_model":151,"./common/dialogs/map/add_layer_view":152,"./common/dialogs/map/image_picker_view":167,"./common/dialogs/map/scratch_view":168,"./common/dialogs/merge_datasets/merge_datasets_view":180,"./common/dialogs/pecan/pecan_view":198,"./common/dialogs/publish/publish_view":201,"./common/dialogs/static_image/advanced_export_view":202,"./common/dialogs/static_image/export_image_result_view":203,"./common/dialogs/sync_dataset/sync_dataset_view":205,"./common/mamufas_import/mamufas_import_view":225,"./common/view_factory":237,"./common/view_helpers/random_quote.js":241,"./editor/background_polling_model":291}],291:[function(a,b,c){(function(c){var d=("undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,a("../common/background_polling/models/imports_collection"),a("../common/background_polling/models/geocodings_collection"),a("../common/background_polling/background_polling_model"));b.exports=d.extend({addImportItem:function(a){return!!a&&(this.user.canAddLayerTo(this.vis.map)||a.setError({error_code:8005,get_error_text:{title:"Max layers per map reached",what_about:"You can't add more layers to your map. Please upgrade your account."}}),void this.importsCollection.add(a))},_onImportsStateChange:function(a){if(a.hasCompleted()){this.trigger("importCompleted",a,this);var b=this;this.vis.map.addCartodbLayerFromTable(a.imp.get("table_name"),this.user.get("username"),{vis:this.vis,success:function(){b.vis.map.layers.saveLayers();var c=a.get("upload").service_name,d=c&&"twitter_search"===c;d||b.importsCollection.remove(a)},error:function(){b.trigger("importLayerFail","Failed to add the connected dataset as a layer to this map"),b.importsCollection.remove(a)}})}},_onGeocodingsStateChange:function(a){a.hasCompleted()&&this.trigger("geocodingCompleted",a,this),a.hasFailed()&&this.trigger("geocodingFailed",a,this)},_onAnalysisStateChange:function(a,b){}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../common/background_polling/background_polling_model":5,"../common/background_polling/models/geocodings_collection":10,"../common/background_polling/models/imports_collection":13}],292:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.Backbone:"undefined"!=typeof a?a.Backbone:null;b.exports=c.Collection.extend({url:function(){return"//"+cdb.config.get("explore_user")+"."+cdb.config.get("account_host")+"/api/v2/sql"},_SORT:{likes:"likes_trend",updated_at:"visualization_updated_at",mapviews:"mapviews_trend"},parse:function(a){return a.rows},fetch:function(a){var b=this._generateQuery(a.type,a.orderBy,a.page,a.limit);a=_.extend({q:b},{reset:a.reset}),c.Collection.prototype.fetch.call(this,{data:a})},_generateQuery:function(a,b,c,d){var e=["user_avatar_url AS avatar_url","user_username AS username","visualization_geometry_types AS geom_types","visualization_id AS id","visualization_likes AS likes","visualization_mapviews AS mapviews","visualization_mapviews::numeric / (1.0 + (now()::date - visualization_created_at::date)::numeric)^2 * 100.0 / m.max_views As mapviews_trend","visualization_likes::numeric / (1.0 + (now()::date - visualization_created_at::date)::numeric)^2 * 100.0 / m.max_likes As likes_trend","visualization_name AS name","visualization_map_datasets AS map_datasets","visualization_table_rows AS rows","visualization_table_size AS table_size","visualization_tags AS tags","visualization_title AS title","visualization_type AS type","visualization_created_at AS created_at","visualization_updated_at AS updated_at"].join(","),f="WITH m As (SELECT max(visualization_likes) As max_likes, max(visualization_mapviews) As max_views FROM <%- table %>) SELECT <%= fields %> FROM <%- table %>, m <%= where %> ORDER BY <%- order_by %> DESC, created_at DESC, visualization_id DESC LIMIT <%- limit %> OFFSET <%- offset %>";return _.template(f,{table:"visualizations",fields:e,order_by:this._SORT[b],limit:d,where:a?"WHERE visualization_type = '"+a+"'":"",offset:d*c})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],293:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.Backbone:"undefined"!=typeof a?a.Backbone:null;b.exports=c.Model.extend({url:function(){return"//"+cdb.config.get("explore_user")+"."+cdb.config.get("account_host")+"/api/v2/sql"},parse:function(a){return a.rows[0]},fetch:function(a){var b=_.extend({data:{q:this._generateQuery()}},a);c.Model.prototype.fetch.call(this,b)},_generateQuery:function(){var a=["visualization_mapviews::numeric/(1.0 + (now()::date - visualization_created_at::date)::numeric)^2 AS mapviews_trend","visualization_name AS name","user_username AS username","visualization_id AS id","visualization_likes AS likes","visualization_title AS title"].join(","),b="SELECT <%= fields %> FROM visualizations ORDER BY mapviews_trend DESC LIMIT 1";return _.template(b,{fields:a})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],294:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({breadcrumbTitle:function(){return"Configuration"},isBreadcrumbDropdownEnabled:function(){return!1},isDisplayingDatasets:function(){return!1},isDisplayingMaps:function(){return!1},isDisplayingLockedItems:function(){return!1}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],295:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.core.View.extend({events:{click:"_openPicker"},initialize:function(){this.model=new d.core.Model({color:this.options.color}),this._initBinds()},_initBinds:function(){this.model.bind("change:color",this._onChangeColor,this)},_onChangeColor:function(){var a=this.model.get("color");this.$el.css("background-color",a),this.trigger("colorChosen",a,this)},_createPicker:function(){this.colorPicker=new d.admin.ColorPicker({className:"dropdown color_picker border",target:this.$el,vertical_position:"up",horizontal_position:"left",vertical_offset:5,horizontal_offset:17,tick:"left",dragUpdate:!0}).bind("colorChosen",this._setColor,this),this._bindPicker(),this.addView(this.colorPicker)},_openPicker:function(a){return this.killEvent(a),this.colorPicker?(this._destroyPicker(),!1):void(this.colorPicker||(this._createPicker(),c("body").append(this.colorPicker.render().el),this.colorPicker.init(this.model.get("color"))))},_destroyPicker:function(){this.colorPicker&&(this._unbindPicker(),this.removeView(this.colorPicker),this.colorPicker.hide(),delete this.colorPicker)},_bindPicker:function(){d.god.bind("closeDialogs",this._destroyPicker,this)},_unbindPicker:function(){d.god.unbind("closeDialogs",this._destroyPicker,this)},_setColor:function(a,b){a&&this.model.set("color",a),b&&this._destroyPicker()},clean:function(){this._destroyPicker(),this.elder("clean")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],296:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.Model.extend({defaults:{msg:"",display:!1},shouldDisplay:function(){return this.get("display")&&!!this.get("msg")},show:function(a){return this.set({display:!0,msg:a})},hide:function(){this.set("display",!1)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],297:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=c.core.View.extend({className:"FlashMessage FlashMessage--error CDB-Text",initialize:function(){if(!this.model)throw new Error("model is required");this._template=c.templates.getTemplate("organization/flash_message"),this.model.on("change",this.render,this)},render:function(){return this.$el.toggle(this.model.shouldDisplay()),this.$el.html(this._html()),this},_html:function(){return this._template({str:this.model.get("msg")})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],298:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("../../common/dialogs/add_group_users/add_group_users_view"),g=a("../../common/view_factory"),h=a("../../common/view_helpers/random_quote");b.exports=e.core.View.extend({className:"Filters-group",events:{"click .js-add-users":"_onClickAddUsers","click .js-rm-users":"_onClickRemoveUsers"},initialize:function(){d.each(["group","orgUsers"],function(a){if(!this.options[a])throw new Error(a+" is required")},this),this.options.group.users.on("change:selected",this._onChangeSelectedUser,this),this.options.group.users.on("add remove reset",this.render,this),this.add_related_model(this.options.group.users)},render:function(){return this.$el.html(this.getTemplate("organization/groups_admin/add_or_remove_group_users_filters_extra")({})),this},_onClickAddUsers:function(a){this.killEvent(a),this._openAddGroupsUsersDialog()},_openAddGroupsUsersDialog:function(){var a=new f({group:this.options.group,orgUsers:this.options.orgUsers});a.appendToBody()},_onChangeSelectedUser:function(){var a=this._selectedUsers().length>0;this.$(".js-add-users").toggle(!a),this.$(".js-rm-users").toggle(a)},_onClickRemoveUsers:function(a){this.killEvent(a);var b=this._selectedUsers();if(b.length>0){var c=d.pluck(b,"id"),e=g.createDialogByTemplate("common/templates/loading",{title:"Removing users",quote:h()});e.appendToBody(),this.options.group.users.removeInBatch(c).always(function(){e.close()}).fail(function(){var a=g.createDialogByTemplate("common/templates/fail",{msg:""});a.appendToBody()})}},_selectedUsers:function(){return this.options.group.users.where({selected:!0})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/dialogs/add_group_users/add_group_users_view":47,"../../common/view_factory":237,"../../common/view_helpers/random_quote":241}],299:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("../../common/view_helpers/random_quote");b.exports=e.core.View.extend({tagName:"form",events:{"click .js-create":"_onClickCreate","submit form":"_onClickCreate","keyup .js-name":"_onChangeName"},initialize:function(){d.each(["group","onCreated","flashMessageModel"],function(a){if(!this.options[a])throw new Error(a+" is required")},this),this.model=new e.core.Model,this._initBinds()},render:function(){return this.model.get("isLoading")?this.$el.html(this.getTemplate("common/templates/loading")({title:"Creating group",quote:f()})):this.$el.html(this.getTemplate("organization/groups_admin/create_group")({})),this},_initBinds:function(){this.model.on("change:isLoading",this.render,this)},_onClickCreate:function(a){this.killEvent(a);var b=this._name();b&&(this.model.set("isLoading",!0),this.options.group.save({display_name:b},{wait:!0,success:this.options.onCreated,error:this._showErrors.bind(this)}))},_showErrors:function(a,b,c){this.model.set("isLoading",!1);var d;try{d=b&&JSON.parse(b.responseText).errors.join(". ")}catch(a){d="Could not create group for some unknown reason, please try again"}this.options.flashMessageModel.show(d)},_onChangeName:function(){this.options.flashMessageModel.hide(),this.$(".js-create").toggleClass("is-disabled",0===this._name().length)},_name:function(){return this.$(".js-name").val()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/view_helpers/random_quote":241}],300:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("../../common/view_helpers/random_quote");b.exports=e.core.View.extend({tagName:"form",events:{"click .js-delete":"_onClickDelete","click .js-save":"_onClickSave","submit form":"_onClickSave","keyup .js-name":"_onChangeName"},initialize:function(){d.each(["group","onSaved","onDeleted","flashMessageModel"],function(a){if(!this.options[a])throw new Error(a+" is required")},this),this.model=new e.core.Model,this._initBinds()},render:function(){return this.model.get("isLoading")?this.$el.html(this.getTemplate("common/templates/loading")({title:this.model.get("loadingText"),quote:f()})):this.$el.html(this.getTemplate("organization/groups_admin/edit_group")({displayName:this.options.group.get("display_name")})),this},_initBinds:function(){this.model.on("change:isLoading",this.render,this)},_onClickSave:function(a){this.killEvent(a);var b=this._name();b&&b!==this.options.group.get("display_name")&&(this._setLoading("Saving changes"),this.options.group.save({display_name:b},{wait:!0,success:this.options.onSaved,error:this._showErrors.bind(this)}))},_onClickDelete:function(a){this.killEvent(a),this._setLoading("Deleting group"),this.options.group.destroy({wait:!0,success:this.options.onDeleted,error:this._showErrors.bind(this)})},_setLoading:function(a){this.options.flashMessageModel.hide(),this.model.set({isLoading:!!a,loadingText:a})},_showErrors:function(a,b,c){this._setLoading("");var d;try{d=b&&JSON.parse(b.responseText).errors.join(". ")}catch(a){d="Could not update group for some unknown reason, please try again"}this.options.flashMessageModel.show(d)},_onChangeName:function(){this.$(".js-save").toggleClass("is-disabled",0===this._name().length),this.options.flashMessageModel.hide()},_name:function(){return this.$(".js-name").val()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/view_helpers/random_quote":241}],301:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("../../common/view_factory"),g=a("../../common/view_helpers/random_quote");b.exports=e.core.View.extend({className:"Filters-group",events:{"click .js-add-users":"_onClickAddUsers"},initialize:function(){d.each(["groupUsers","orgUsers"],function(a){if(!this.options[a])throw new Error(a+" is required")},this),this.options.orgUsers.on("change:selected",this._onChangeSelectedUser,this),this.add_related_model(this.options.orgUsers)},render:function(){return this.$el.html(this.getTemplate("organization/groups_admin/empty_group_filters_extra")({})),this},_onChangeSelectedUser:function(){this.$(".js-add-users").toggleClass("is-disabled",0===this._selectedUsers().length)},_onClickAddUsers:function(a){this.killEvent(a);var b=this._selectedUsers();if(b.length>0){var c=d.pluck(b,"id"),e=this._createLoadingView();e.appendToBody(),this.options.groupUsers.addInBatch(c).always(function(){e.close()}).fail(function(){f.createDialogByTemplate("common/templates/fail",{msg:""}).appendToBody()})}},_createLoadingView:function(){return f.createDialogByTemplate("common/templates/loading",{title:"Adding users",quote:g()})},_selectedUsers:function(){return this.options.orgUsers.where({selected:!0})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/view_factory":237,"../../common/view_helpers/random_quote":241}],302:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,g=a("../../common/view_helpers/pluralize_string");b.exports=f.core.View.extend({initialize:function(){e.each(["group","urls"],function(a){if(!this.options[a])throw new Error(a+" is required")},this),this._initBinds()},render:function(){this._$orgSubheader().hide();var a=this.options.group,b=a.isNew(),c={backUrl:this.options.urls.root,title:a.get("display_name")||"Create new group",isNewGroup:b,usersUrl:!1};if(b)c.editUrl=window.location,c.editUrl.isCurrent=!0;else{c.editUrl=this.options.urls.edit,c.usersUrl=this.options.urls.users;var d=a.users.length;c.usersLabel=0===d?"Users":d+" "+g("User","Users",d),this.options.urls.users.isCurrent||(c.backUrl=this.options.urls.users)}return this.$el.html(this.getTemplate("organization/groups_admin/group_header")(c)),this},clean:function(){this._$orgSubheader().show(),f.core.View.prototype.clean.call(this)},_$orgSubheader:function(){return d(".js-org-subheader")},_initBinds:function(){var a=this.options.group;a.on("change:display_name",this.render,this),this.add_related_model(a),a.users.on("reset add remove",this.render,this),this.add_related_model(a.users)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/view_helpers/pluralize_string":240}],303:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("../../common/view_helpers/pluralize_string");b.exports=e.core.View.extend({tagName:"li",className:"OrganizationList-user is-selectable",events:{click:"_onClick"},initialize:function(){d.each(["model"],function(a){if(!this.options[a])throw new Error(a+" is required")},this),this._initBinds()},render:function(){return this.$el.html(this.getTemplate("organization/groups_admin/group_user")({avatarUrl:this.model.get("avatar_url"),username:this.model.get("username"),email:this.model.get("email"),maps_count:f.prefixWithCount("map","maps",this.model.get("all_visualization_count")),table_count:f.prefixWithCount("dataset","datasets",this.model.get("table_count"))})),this},_initBinds:function(){this.model.on("change:selected",this._onChangeSelected,this)},_onChangeSelected:function(a,b){this.$el.toggleClass("is-selected",!!b)},_onClick:function(a){this.killEvent(a),this.model.set("selected",!this.model.get("selected"))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/view_helpers/pluralize_string":240}],304:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("./group_user_view");b.exports=e.core.View.extend({tagName:"ul",className:"OrganizationList",initialize:function(){d.each(["users"],function(a){if(!this.options[a])throw new Error(a+" is required")},this),this.options.users.bind("reset add remove",this.render,this),this.add_related_model(this.options.users)},render:function(){return this.clearSubViews(),this._renderUsers(),this},_renderUsers:function(){this.options.users.each(this._createUserView,this)},_createUserView:function(a){var b=new f({model:a});this.addView(b),this.$el.append(b.render().el)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./group_user_view":303}],305:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("../../common/views/paged_search/paged_search_view"),g=a("../../common/paged_search_model"),h=a("../../common/view_factory"),i=a("../../common/view_helpers/random_quote"),j=a("./add_or_remove_group_users_filters_extra_view"),k=a("./empty_group_filters_extra_view"),l=a("./group_users_list_view");b.exports=e.core.View.extend({initialize:function(){d.each(["group","orgUsers"],function(a){if(!this.options[a])throw new Error(a+" is required")},this),this._groupUsers=this.options.group.users,this._orgUsers=this.options.orgUsers,this._orgUsers.excludeCurrentUser(!1),this._hasPrefetchedGroupUsers=!1,this.model=new e.core.Model({hasPrefetchedGroupUsers:!1,lastRendered:null}),this._groupUsers.bind("reset",this._onResetGroupUsers,this),this.add_related_model(this._groupUsers);var a=this;this._groupUsers.fetch({success:function(){a.model.set("hasPrefetchedGroupUsers",!0),a.render()}})},render:function(){this.clearSubViews(),this.$el.empty();var a;return a=this.model.get("hasPrefetchedGroupUsers")?this._groupUsers.totalCount()>0?this._createViewForGroupUsers():this._createViewForEmptyGroup():this._createInitialPreloadingView(),this.addView(a),this.$el.append(a.render().el),this},clean:function(){this._orgUsers.restoreExcludeCurrentUser(),this.elder("clean")},_createInitialPreloadingView:function(){return h.createByTemplate("common/templates/loading",{title:"Getting users",quote:i()})},_createViewForGroupUsers:function(){this.model.set("lastRendered","groupUsers");var a=new j({group:this.options.group,orgUsers:this._orgUsers});return this.addView(a),new f({pagedSearchModel:new g,collection:this._groupUsers,createListView:this._createGroupUsersListView.bind(this,this._groupUsers),thinFilters:!0,filtersExtrasView:a})},_createViewForEmptyGroup:function(){this.model.set("lastRendered","empty");var a=new k({groupUsers:this._groupUsers,orgUsers:this._orgUsers});return this.addView(a),new f({pagedSearchModel:new g,collection:this._orgUsers,createListView:this._createGroupUsersListView.bind(this,this._orgUsers),thinFilters:!0,filtersExtrasView:a})},_createGroupUsersListView:function(a){return new l({users:a})},_onResetGroupUsers:function(){var a=this.model.get("lastRendered"),b=this._groupUsers.totalCount();"empty"===a?b>0&&this.render():"groupUsers"===a&&0===b&&this.render()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/paged_search_model":227,"../../common/view_factory":237,"../../common/view_helpers/random_quote":241,"../../common/views/paged_search/paged_search_view":257,"./add_or_remove_group_users_filters_extra_view":298,"./empty_group_filters_extra_view":301,"./group_users_list_view":304}],306:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("../../common/view_helpers/pluralize_string");b.exports=e.core.View.extend({tagName:"li",className:"OrganizationList-user",_PREVIEW_COUNT:3,initialize:function(){d.each(["model","url"],function(a){if(!this.options[a])throw new Error(a+" is required")},this)},render:function(){var a=this.model.get("shared_maps_count"),b=this.model.get("shared_tables_count");return this.$el.html(this.getTemplate("organization/groups_admin/group")({displayName:this.model.get("display_name"),sharedMapsCount:f("1 shared map",a+" shared maps",a),
sharedDatasetsCount:f("1 shared dataset",b+" shared datasets",b),url:this.options.url,previewUsers:this.model.users.toArray().slice(0,this._PREVIEW_COUNT),usersCount:Math.max(this.model.users.length-this._PREVIEW_COUNT,0)})),this}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/view_helpers/pluralize_string":240}],307:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("./groups_list_view"),g=a("../../common/views/paged_search/paged_search_view"),h=a("../../common/paged_search_model"),i=a("../../common/view_factory");b.exports=e.core.View.extend({initialize:function(){d.each(["groups","router","newGroupUrl"],function(a){if(!this.options[a])throw new Error(a+" is required")},this)},render:function(){this.clearSubViews();var a=new g({pagedSearchModel:new h({fetch_users:!0,fetch_shared_maps_count:!0,fetch_shared_tables_count:!0}),collection:this.options.groups,createListView:this._createGroupsView.bind(this),thinFilters:!0,filtersExtrasView:this._createFiltersExtraView(),noResults:{icon:"CDB-IconFont-group",title:"You have not created any groups yet",msg:"Creating groups enables you to visualize and search for user members assigned to a business group or team in your organization."}});return this.addView(a),this.$el.empty(),this.$el.append(a.render().el),this},_createGroupsView:function(){return new f({groups:this.options.groups,newGroupUrl:this.options.newGroupUrl})},_createFiltersExtraView:function(){return i.createByTemplate("organization/groups_admin/groups_index_filters_extra",{createGroupUrl:this.options.router.rootUrl.urlToPath("new")},{className:"Filters-group"})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/paged_search_model":227,"../../common/view_factory":237,"../../common/views/paged_search/paged_search_view":257,"./groups_list_view":308}],308:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("./group_view"),g=a("../../common/view_factory");b.exports=e.core.View.extend({initialize:function(){d.each(["groups"],function(a){if(d.isUndefined(this.options[a]))throw new Error(a+" is required")},this)},render:function(){return this.clearSubViews(),this.$el.empty(),this._renderGroupsView(),this},_renderGroupsView:function(){var a=g.createByList(this._createGroupViews(),{tagName:"ul",className:"OrganizationList"});this.addView(a),this.$el.append(a.render().el)},_createGroupViews:function(){return this.options.groups.map(function(a){return new f({model:a,url:this.options.newGroupUrl(a)})},this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/view_factory":237,"./group_view":306}],309:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,g=a("../../common/view_helpers/navigate_through_router");b.exports=f.core.View.extend({events:{click:"_onClick"},initialize:function(){e.each(["router"],function(a){if(!this.options[a])throw new Error(a+" is required")},this),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this._contentView().render().el),this},_initBinds:function(){this.options.router.model.bind("change:view",this._onChangeView,this),this.add_related_model(this.options.router.model)},_onChangeView:function(a){a.previous("view").clean(),this.render()},_contentView:function(){return this.options.router.model.get("view")},_onClick:function(a){if(this._isEventTriggeredOutsideOf(a,".Dialog")&&f.god.trigger("closeDialogs"),!this._isEventTriggeredOutsideOf(a,"a")){var b=d(a.target).closest("a").attr("href");this.options.router.isWithinCurrentRoutes(b)&&g.apply(this,arguments)}},_isEventTriggeredOutsideOf:function(a,b){return 0===d(a.target).closest(b).length}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/view_helpers/navigate_through_router":239}],310:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e=a("../../common/router"),f=a("./router_model"),g=a("./group_header_view"),h=a("./groups_index_view"),i=a("./create_group_view"),j=a("./group_users_view"),k=a("./edit_group_view"),l=a("../../common/view_factory");b.exports=e.extend({routes:e.supportTrailingSlashes({"":"renderGroupsIndex",new:"renderCreateGroup",":id":"renderGroupUsers",":id/edit":"renderEditGroup","*prefix/groups":"renderGroupsIndex"}),initialize:function(a){d.each(["rootUrl","groups","user","flashMessageModel"],function(b){if(!a[b])throw new Error(b+" is required")},this),this.model=new f,this.user=a.user,this.groups=a.groups,this.flashMessageModel=a.flashMessageModel,this.rootUrl=a.rootUrl,this.rootPath=this.rootUrl.pathname.bind(this.rootUrl),this.model.createLoadingView("Loading view"),this.model.on("change",this._onChange,this)},normalizeFragmentOrUrl:function(a){return a?a.toString().replace(this.rootUrl.toString(),""):""},isWithinCurrentRoutes:function(a){return a.indexOf(this.rootUrl.pathname())!==-1},renderGroupsIndex:function(){this.model.set("view",new h({newGroupUrl:this._groupUrl.bind(this),groups:this.groups,router:this}))},renderCreateGroup:function(){var a=this.groups.newGroupById(),b=this;this.model.set("view",l.createByList([b._createGroupHeader(a),new i({flashMessageModel:b.flashMessageModel,group:a,onCreated:b._navigateToGroup.bind(b,a)})]))},renderGroupUsers:function(a){var b=this;this.model.createGroupView(this.groups,a,function(a){return l.createByList([b._createGroupHeader(a,"group_users"),new j({group:a,orgUsers:b.user.organization.users})])})},renderEditGroup:function(a){var b=this;this.model.createGroupView(this.groups,a,function(a){return l.createByList([b._createGroupHeader(a,"edit_group"),new k({flashMessageModel:b.flashMessageModel,group:a,onSaved:b._navigateToGroup.bind(b,a),onDeleted:b.navigate.bind(b,b.rootUrl,{trigger:!0})})])})},_navigateToGroup:function(a){this.navigate(this.rootUrl.urlToPath(a.id),{trigger:!0})},_groupUrl:function(a,b){var c=a.id;return b&&(c+="/"+b),this.rootUrl.urlToPath(c)},_createGroupHeader:function(a,b){var c={root:this.rootUrl,users:this._groupUrl(a),edit:this._groupUrl(a,"edit")};return c.users.isCurrent="group_users"===b,c.edit.isCurrent="edit_group"===b,new g({group:a,urls:c})},_onChange:function(){this.flashMessageModel.hide()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/router":228,"../../common/view_factory":237,"./create_group_view":299,"./edit_group_view":300,"./group_header_view":302,"./group_users_view":305,"./groups_index_view":307,"./router_model":311}],311:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../common/view_factory"),f=a("../../common/view_helpers/random_quote");b.exports=d.core.Model.extend({defaults:{view:""},createGroupView:function(a,b,c){var d=this,e=a.newGroupById(b);c=c.bind(this,e);var f=function(){d.set("view",c())};e.get("display_name")?f():(this.createLoadingView("Loading group details"),e.fetch({data:{fetch_users:!0},success:function(){a.add(e),f()},error:this.createErrorView.bind(this)}))},createLoadingView:function(a){this.set("view",e.createByTemplate("common/templates/loading",{title:a,quote:f()}))},createErrorView:function(){this.set("view",e.createByTemplate("common/templates/fail",{msg:""}))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/view_factory":237,"../../common/view_helpers/random_quote":241}],312:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../../../../javascripts/cartodb/common/views/base_dialog/view"),f=a("../icons/organization_icons_view");b.exports=e.extend({className:"Dialog Modal IconPickerDialog",events:e.extendEvents({"click .js-addIcon":"_onAddIconClicked"}),initialize:function(){if(!this.options.orgId)throw new Error("Organization ID is required.");this._orgId=this.options.orgId,this.elder("initialize"),this._template=d.templates.getTemplate("organization/icon_picker/icon_picker_dialog/icon_picker_dialog_template")},render:function(){return this.clearSubViews(),e.prototype.render.call(this),this.$(".content").addClass("Dialog-content--expanded"),this._initViews(),this},_initViews:function(){this.icon_picker=new f({el:this.$(".js-dialogIconPicker"),orgId:this._orgId}),this.addView(this.icon_picker),this.icon_picker.model.on("change:isProcessRunning",this._onIsProcessRunningChanged,this)},_onIsProcessRunningChanged:function(){var a=this.icon_picker.model.get("isProcessRunning");a?this.$el.css("pointer-events","none"):this.$el.css("pointer-events","auto")},render_content:function(){return this._template()},_onAddIconClicked:function(a){this.killEvent(a),this._hideErrorMessage(),this.$(".js-inputFile").trigger("click")},_hideErrorMessage:function(){this._hide(".js-errorMessage")},_hide:function(a){this.$(a).addClass("is-hidden")}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/views/base_dialog/view":242,"../icons/organization_icons_view":317}],313:[function(a,b,c){var d=a("../../../../../javascripts/cartodb/common/views/base_dialog/view");b.exports=d.extend({initialize:function(){if(!this.options.okCallback)throw new Error("Callback for OK action is mandatory.");this.elder("initialize"),this._numOfIcons=this.options.numOfIcons||0,this._okCallback=this.options.okCallback},render_content:function(){return this.getTemplate("organization/icon_picker/icons/delete_icons_modal")({numOfIcons:this._numOfIcons})},ok:function(){this._okCallback(),this.close()}})},{"../../../../../javascripts/cartodb/common/views/base_dialog/view":242}],314:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof c?c.Backbone:null,f=a("./organization_icon_model");b.exports=e.Collection.extend({model:f,url:function(a){var b=d.config.urlVersion("organization-assets",a);return"/api/"+b+"/organization/"+this._orgId+"/assets"},initialize:function(a,b){if(!b.orgId)throw new Error("Organization ID is required");this._orgId=b.orgId}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./organization_icon_model":315}],315:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.Backbone:"undefined"!=typeof a?a.Backbone:null,d="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null;b.exports=c.Model.extend({defaults:{selected:!1,visible:!1,deleted:!1},fileAttribute:"resource",save:function(a,b){return b||(b={}),a||(a=d.clone(this.attributes)),a=d.omit(a,["selected","visible","deleted"]),b.data=JSON.stringify(a),c.Model.prototype.save.call(this,a,b)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],316:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.core.View.extend({tagName:"li",className:"IconList-item IconList-item--small",events:{click:"_onClick"},initialize:function(a){if(c.isUndefined(a.model))throw new Error("An organization icon model is mandatory.");this._template=d.templates.getTemplate("organization/icon_picker/icons/organization_icon"),this._initBinds()},render:function(){return this.$el.html(this._template({url:this.model.get("public_url")})),this},_initBinds:function(){this.model.on("change:selected",this._onSelectedChanged,this),this.model.on("change:deleted",this._onDeletedChanged,this)},_onClick:function(){this.model.set("selected",!this.model.get("selected"))},_onSelectedChanged:function(){this.$el.toggleClass("is-selected",this.model.get("selected"))},_onDeletedChanged:function(){this.model.get("deleted")&&this.$el.remove()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],317:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,f=a("./organization_icon_collection"),g=a("./organization_icon_view"),h=a("./delete_icons_dialog_view");b.exports=e.core.View.extend({events:{"click .js-addIcon":"_onAddIconClicked","click .js-selectAllIcons":"_onSelectAllIconsClicked","click .js-deselectAllIcons":"_onDeselectAllIconsClicked","click .js-deleteIcons":"_onDeleteIconsClicked","change .js-inputFile":"_onFileSelected"},initialize:function(){if(!this.options.orgId)throw new Error("Organization ID is required.");this._orgId=this.options.orgId,this.template=e.templates.getTemplate("organization/icon_picker/icons/organization_icons_template"),this.model=new e.core.Model({isProcessRunning:!1}),this._iconCollection=new f(null,{orgId:this._orgId}),this._numOfUploadingProcesses=0,this._numOfDeletingProcesses=0,this._fetchErrorMessage="Error fetching organization icons. Please refresh the page.",this._runningMessage="",this.render(),this._fetchAllIcons(),this._initBinds()},render:function(){return this.$el.html(this.template()),this},_initBinds:function(){this._iconCollection.on("change:selected",this._refreshActions,this),this.model.on("change:isProcessRunning",this._onProcessRunningChanged,this),this.add_related_model(this._iconCollection)},_fetchAllIcons:function(){this._iconCollection.fetch({success:this._renderAllIcons.bind(this),error:this._onFetchIconsError.bind(this)})},_renderAllIcons:function(){d.each(this._iconCollection.models,function(a){this._addIconElement(a)},this)},_onFetchIconsError:function(){this._showErrorMessage(this._fetchErrorMessage)},_renderIcon:function(a){var b=new g({model:a});b.render(),a.set("visible",!0),this.$(".js-items").append(b.$el)},_addIconElement:function(a){this._renderIcon(a)},_onAddIconClicked:function(a){this.killEvent(a),this._hideErrorMessage(),this.$(".js-inputFile").trigger("click")},_parseResponseText:function(a){if(a&&a.responseText)try{var b=JSON.parse(a.responseText);if(b&&b.errors&&"string"==typeof b.errors)return b.errors}catch(a){}return""},_getSelectedFiles:function(){return this.$(".js-inputFile").prop("files")},_onFileSelected:function(){var a=this._getSelectedFiles();d.each(a,function(a){this._iconCollection.create({kind:"organization_asset",resource:a},{beforeSend:this._beforeIconUpload.bind(this),success:this._onIconUploaded.bind(this),error:this._onIconUploadError.bind(this),complete:this._onIconUploadComplete.bind(this)})},this)},_beforeIconUpload:function(){this._numOfUploadingProcesses++,this._numOfUploadingProcesses>0&&(this._runningMessage="Uploading icons...",this.model.set("isProcessRunning",!0))},_onIconUploaded:function(a){this._resetFileSelection(),this._addIconElement(a)},_onIconUploadError:function(a,b){var c=this._parseResponseText(b);this._resetFileSelection(),this._showErrorMessage(this._uploadErrorMessage(c))},_onIconUploadComplete:function(){this._numOfUploadingProcesses--,this._numOfUploadingProcesses<=0&&this.model.set("isProcessRunning",!1)},_resetFileSelection:function(){this.$(".js-inputFile").val("")},_show:function(a){this.$(a).removeClass("is-hidden")},_hide:function(a){this.$(a).addClass("is-hidden")},_refreshActions:function(){if(!this.model.get("isProcessRunning")){var a=Math.min(this._iconCollection.length),b=this._getNumberOfSelectedIcons(),c=1===b?"1 icon selected":""+b+" icons selected";this.$(".js-iconMainLabel").text(c),0===b?(this.$(".js-iconMainLabel").text(""),this._hide(".js-iconMainLabel, .js-selectAllIcons, .js-deselectAllIcons, .js-deleteIcons"),this._show(".js-iconsInfo")):b<a?(this._show(".js-iconMainLabel, .js-selectAllIcons, .js-deleteIcons"),this._hide(".js-deselectAllIcons, .js-iconsInfo")):(this._show(".js-iconMainLabel, .js-deselectAllIcons, .js-deleteIcons"),this._hide(".js-selectAllIcons, .js-iconsInfo")),b>1?this.$(".js-deleteIcons a").text("Delete icons..."):1===b&&this.$(".js-deleteIcons a").text("Delete icon...")}},_hideActions:function(){this._hide(".js-selectAllIcons, .js-deselectAllIcons, .js-deleteIcons, .js-iconsInfo")},_onDeselectAllIconsClicked:function(a){a.preventDefault(),this._iconCollection.each(function(a){a.set("selected",!1)})},_onSelectAllIconsClicked:function(a){a.preventDefault(),this._iconCollection.each(function(a){a.get("visible")&&a.set("selected",!0)})},_onDeleteIconsClicked:function(a){a.preventDefault(),this._openDeleteIconsDialog()},_bindDeleteIconsDialog:function(){e.god.bind("closeDialogs:delete",this._destroyDeleteIconsDialog,this)},_unbindDeleteIconsDialog:function(){e.god.unbind("closeDialogs:delete",this._destroyDeleteIconsDialog,this)},_openDeleteIconsDialog:function(a){this.killEvent(a),e.god.trigger("closeDialogs:delete"),this.delete_icons_dialog=new h({numOfIcons:this._getNumberOfSelectedIcons(),okCallback:this._deleteIcons.bind(this)}),this.delete_icons_dialog.appendToBody(),this._bindDeleteIconsDialog(),this.addView(this.delete_icons_dialog)},_deleteIcons:function(){this._hideErrorMessage();var a=this._iconCollection.where({selected:!0});d.each(a,function(a){a.destroy({beforeSend:this._beforeIconDelete.bind(this),success:this._onIconDeleted.bind(this),error:this._onIconDeleteError.bind(this),complete:this._onIconDeleteComplete.bind(this)})},this)},_destroyDeleteIconsDialog:function(){this.delete_icons_dialog&&(this._unbindDeleteIconsDialog(),this.delete_icons_dialog.remove(),this.removeView(this.delete_icons_dialog),this.delete_icons_dialog.hide(),delete this.delete_icons_dialog)},_getNumberOfSelectedIcons:function(){return this._iconCollection.where({selected:!0}).length},_beforeIconDelete:function(){this._numOfDeletingProcesses++,this._numOfDeletingProcesses>0&&(this._runningMessage="Deleting icons...",this.model.set("isProcessRunning",!0))},_onIconDeleted:function(a){a.set("deleted",!0),this._addExtraIcon()},_onIconDeleteError:function(a,b){var c=this._parseResponseText(b);this._iconCollection.add(a),this._resetSelection(),this._showErrorMessage(this._deleteErrorMessage(c))},_onIconDeleteComplete:function(){this._numOfDeletingProcesses--,this._numOfDeletingProcesses<=0&&this.model.set("isProcessRunning",!1)},_showSpinner:function(a){a?(this._hide(".js-plusSign"),this._show(".js-spinner")):(this._show(".js-plusSign"),this._hide(".js-spinner"))},_showErrorMessage:function(a){this.$(".js-errorMessage label").text(a),this._show(".js-errorMessage")},_hideErrorMessage:function(){this._hide(".js-errorMessage")},_resetSelection:function(){this._iconCollection.each(function(a){a.set("selected",!1)}),this._refreshActions()},_addExtraIcon:function(){var a=!1;this._iconCollection.each(function(b){b.get("visible")||a||(this._addIconElement(b),a=!0)},this)},_onProcessRunningChanged:function(){var a=this.model.get("isProcessRunning");this._showSpinner(a),a?(this.$el.css("pointer-events","none"),this._hideActions(),this.$(".js-runningInfo").text(this._runningMessage),this._show(".js-runningInfo")):(this.$(".js-runningInfo").text(""),this._hide(".js-runningInfo"),this._refreshActions(),e.god.trigger("refreshCollection",{cid:this.cid}),this.$el.css("pointer-events","auto"))},_uploadErrorMessage:function(a){var b="Error uploading your image. ";return a&&(b+="[ "+a+" ]. "),b+="Please try again."},_deleteErrorMessage:function(a){var b="Error deleting your image. ";return a&&(b+="[ "+a+" ]. "),b+="Please try again."}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./delete_icons_dialog_view":313,"./organization_icon_collection":314,"./organization_icon_view":316}],318:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./icons/organization_icons_view"),f=a("./icons/organization_icon_collection"),g=a("./icons/organization_icon_view"),h=a("./icon_picker_dialog/icon_picker_dialog_view");b.exports=e.extend({events:e.extendEvents({"click .js-viewAllIcons":"_onViewAllIconsClicked"}),initialize:function(){if(!this.options.orgId)throw new Error("Organization ID is required.");this._orgId=this.options.orgId,this._maxIcons=23,this.template=d.templates.getTemplate("organization/icon_picker/organization_icon_picker_template"),this.model=new d.core.Model({isProcessRunning:!1}),this._iconCollection=new f(null,{orgId:this._orgId}),this._numOfUploadingProcesses=0,this._numOfDeletingProcesses=0,this._fetchErrorMessage="Error fetching organization icons. Please refresh the page.",this._runningMessage="",this.render(),this._fetchAllIcons(),this._initBinds()},_initBinds:function(){this._iconCollection.on("change:selected",this._refreshActions,this),this.model.on("change:isProcessRunning",this._onProcessRunningChanged,this),d.god.bind("refreshCollection",this._refreshCollection,this)},_refreshCollection:function(a){a.cid&&this.cid!==a.cid&&(this.render(),this._fetchAllIcons())},_renderIcon:function(a){if(a.get("index")<this._maxIcons){var b=new g({model:a});b.render(),a.set("visible",!0),this.$(".js-items").append(b.$el)}},_addIconElement:function(a){a.set("index",this._getIconIndex(a)),this._renderIcon(a),this._refreshActions()},_refreshActions:function(){if(!this.model.get("isProcessRunning")){var a=Math.min(this._maxIcons,this._iconCollection.length),b=this._getNumberOfSelectedIcons(),c=1===b?"1 icon selected":""+b+" icons selected";this.$(".js-iconMainLabel").text(c),0===b?(this.$(".js-iconMainLabel").text("Icons"),this._hide(".js-selectAllIcons, .js-deselectAllIcons, .js-deleteIcons"),this._show(".js-iconsInfo")):b<a?(this._show(".js-selectAllIcons, .js-deleteIcons"),this._hide(".js-deselectAllIcons, .js-iconsInfo")):(this._hide(".js-selectAllIcons, .js-iconsInfo"),this._show(".js-deselectAllIcons, .js-deleteIcons")),b>1?this.$(".js-deleteIcons a").text("Delete icons..."):1===b&&this.$(".js-deleteIcons a").text("Delete icon..."),this._iconCollection.length>this._maxIcons?this._show(".js-viewAllIcons"):this._hide(".js-viewAllIcons")}},_hideActions:function(){this._hide(".js-selectAllIcons, .js-deselectAllIcons, .js-deleteIcons, .js-iconsInfo, .js-viewAllIcons")},_getIconIndex:function(a){return this._iconCollection.indexOf(a)},_addExtraIcon:function(){var a=!1;this._iconCollection.each(function(b){var c=this._getIconIndex(b);c<this._maxIcons&&!b.get("visible")&&!a&&(this._addIconElement(b),a=!0)},this)},_bindIconsPicker:function(){d.god.bind("closeDialogs:icons",this._destroyPicker,this)},_unbindIconsPicker:function(){d.god.unbind("closeDialogs:icons",this._destroyPicker,this)},_destroyPicker:function(){this.icon_picker_dialog&&(this._unbindIconsPicker(),this.icon_picker_dialog.remove(),this.removeView(this.icon_picker_dialog),this.icon_picker_dialog.hide(),delete this.icon_picker_dialog)},_onViewAllIconsClicked:function(a){this.killEvent(a),d.god.trigger("closeDialogs:icons"),this.icon_picker_dialog=new h({orgId:this._orgId}),this.icon_picker_dialog.appendToBody(),this._bindIconsPicker(),this.addView(this.icon_picker_dialog)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./icon_picker_dialog/icon_picker_dialog_view":312,"./icons/organization_icon_collection":314,"./icons/organization_icon_view":316,"./icons/organization_icons_view":317}],319:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../common/views/base_dialog/view"),f=a("../../common/view_helpers/random_quote"),g=a("../../common/view_factory"),h=a("./invite_users_form_view");b.exports=e.extend({className:"Dialog is-opening InviteUsers",initialize:function(){this.elder("initialize"),this.organization=this.options.organization,this.organizationUsers=this.options.organizationUsers,this.model=new d.admin.Organization.Invites({},{organizationId:this.organization.id,enable_organization_signup:!1}),this.template=d.templates.getTemplate("organization/invite_users/invite_users_dialog_template")},render:function(){return this.clearSubViews(),e.prototype.render.call(this),this.$(".content").addClass("Dialog-content--expanded"),this._initViews(),this},render_content:function(){return this.template()},_initViews:function(){this._panes=new d.ui.common.TabPane({el:this.$(".js-content")}),this._form=new h({model:this.model,organization:this.organization,organizationUsers:this.organizationUsers,el:this.$(".js-form")}),this._form.bind("onSubmit",this._sendInvites,this),this._panes.addTab("form",this._form.render()),this._panes.addTab("loading",g.createByTemplate("common/templates/loading",{title:"Sending invites...",quote:f()}).render()),this._panes.addTab("error",g.createByTemplate("common/templates/fail",{msg:"Sorry, something went wrong."}).render()),this._panes.active("form")},_sendInvites:function(){var a=this;this._panes.active("loading"),this.model.save(null,{success:function(){a.close()},error:function(b,c){try{var d=JSON.parse(c.responseText).errors.users_emails[0];a._form.showSubmitError(d),a._panes.active("form")}catch(b){a._panes.active("error")}}})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/view_factory":237,"../../common/view_helpers/random_quote":241,"../../common/views/base_dialog/view":242,"./invite_users_form_view":320}],320:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window._:"undefined"!=typeof a?a._:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,e="undefined"!=typeof window?window.cdb.Utils:"undefined"!=typeof a?a.cdb.Utils:null;b.exports=d.core.View.extend({events:{"submit .js-invitesForm":"_onSubmit","keyup .js-welcomeText":"_onTextareaChange","click .js-enableSignInButton":"_signInEnabledMessage"},initialize:function(){this.organizationUsers=this.options.organizationUsers,this.organization=this.options.organization,this.template=d.templates.getTemplate("organization/invite_users/invite_users_form_template"),this._initBinds()},render:function(){return this.$el.html(this.template({welcomeText:this.model.get("welcome_text"),signupEnabled:this.organization.get("signup_enabled"),viewerEnabled:this.organization.get("viewer_seats")>0})),this._toggleEmailError(!1),this._initViews(),this},_renderFlashMessage:function(){var a=d.templates.getTemplate("organization/invite_users/invite_users_flash_message_template");this.$(".js-signInMessageContainer").html(a()),this.$(".js-flashSuccess").hide()},_initBinds:function(){this.model.bind("change",this._onChange,this)},_initViews:function(){var a=this,b=this.organizationUsers.pluck("email");this.$(".js-tagsList").tagit({allowSpaces:!0,placeholderText:this.$(".js-tags").data("title"),onBlur:function(){a.$(".js-tags").removeClass("is-focus")},onFocus:function(){a.$(".js-tags").addClass("is-focus")},beforeTagAdded:function(d,f){var g=f.tagLabel;return a._removeSubmitError(),!!e.isValidEmail(g)&&(c.contains(b,g)?(a._toggleEmailError(!0),!1):void a._toggleEmailError(!1))},beforeTagRemoved:function(){a._removeSubmitError()},afterTagRemoved:function(b,c){a._updateUsers()},afterTagAdded:function(b,c){a._updateUsers()},onSubmitTags:function(b,c){return b.preventDefault(),a._onSubmit(),!1}}),this.organization.get("signup_enabled")||this._renderFlashMessage()},_onTextareaChange:function(){this.model.set("welcome_text",this.$(".js-welcomeText").val())},_updateUsers:function(){this.model.set("users_emails",this.$(".js-tagsList").tagit("assignedTags"))},_onSubmit:function(a){a&&this.killEvent(a);var b=this.model.get("users_emails");b.length>0&&(this.model.set("welcome_text",this.$(".js-welcomeText").val()),this.model.set("viewer",this.$("[name=viewer]").get(0).checked),this.trigger("onSubmit",this))},_signInEnabledMessage:function(){this.$(".js-signInMessage").addClass("FlashMessage--success"),this.$(".js-flashNotice").hide(),this.$(".js-flashSuccess").show(),this.model.set("enable_organization_signup",!0)},_toggleEmailError:function(a){this.$(".js-emailError")[a?"show":"hide"]()},showSubmitError:function(a){var b=this.$(".js-serverError");0===b.length&&this.$(".js-emailError").after('<p class="Form-rowInfoText Form-rowInfoText--error Form-rowInfoText--multipleLines js-serverError">'+a+"</p>")},_removeSubmitError:function(){this.$(".js-serverError").remove()},_onChange:function(){var a=this.model.get("users_emails"),b=this.model.get("welcome_text");this.$(".js-submit").toggleClass("is-disabled",0===a.length||!b)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],321:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../../common/views/base_dialog/view"),f=a("../../common/view_helpers/random_quote"),g=a("../../common/view_factory");b.exports=e.extend({options:{authenticityToken:"",organizationUser:{}},events:e.extendEvents({"click .js-ok":"_ok","click .js-cancel":"_cancel"}),className:"Dialog is-opening",initialize:function(){this.elder("initialize"),this.template=d.templates.getTemplate("organization/organization_notification/delete_notification_dialog")},render_content:function(){return this.template({formAction:d.config.prefixUrl()+"/organization/notifications/"+this.options.notificationId,authenticityToken:this.options.authenticityToken})},ok:function(){var a=g.createDialogByTemplate("common/templates/loading",{title:"Removing…",quote:f()});a.appendToBody(),this.submit(),this.close()},submit:function(){this.$("form").submit()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../common/view_factory":237,"../../common/view_helpers/random_quote":241,"../../common/views/base_dialog/view":242}],322:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null,f=a("./delete_notification_dialog_view"),g=a("./send_button_view"),h=a("markdown");b.exports=d.core.View.extend({events:{"click .js-resend":"_onClickResend","click .js-remove":"_onClickRemove","keydown .js-textarea":"_onTextareaKeydown","input .js-textarea":"_updateCounter","propertychange .js-textarea":"_updateCounter"},render:function(){return this.$textarea=this.$("#carto_notification_body"),this._initViews(),this._updateCounter(),this},_initViews:function(){this.sendButton=new g,this.$(".js-send").html(this.sendButton.render().el),this.addView(this.sendButton),this.sendButton.bind("submitForm",this._submitForm,this)},_submitForm:function(){navigator.userAgent.toLowerCase().indexOf("firefox")!==-1?this.$("form").clone().appendTo("body").submit():this.$("form").submit()},_updateCounter:function(){var a=e(h.toHTML(this.$textarea.val())).text().length;this.sendButton.updateCounter(a)},_onClickResend:function(a){var b=e(a.target).closest(".js-NotificationsList-item"),c=b.find(".js-html_body").data("body"),d=b.find(".js-recipients").data("recipients");this.$textarea.val(c),this.$('input[name="carto_notification[recipients]"]').prop("checked",!1),this.$('input[name="carto_notification[recipients]"][value="'+d+'"]').prop("checked",!0),e("body").animate({scrollTop:0}),this._updateCounter()},_onTextareaKeydown:function(a){
13===a.keyCode&&a.metaKey&&this.sendButton.onUpdate()},_destroyRemoveNotificationDialog:function(){this.remove_notification_dialog&&(this._unbindRemoveNotificationDialog(),this.remove_notification_dialog.remove(),this.removeView(this.remove_notification_dialog),this.remove_notification_dialog.hide(),delete this.remove_notification_dialog)},_bindRemoveNotificationDialog:function(){d.god.bind("closeDialogs:delete",this._destroyRemoveNotificationDialog,this)},_unbindRemoveNotificationDialog:function(){d.god.unbind("closeDialogs:delete",this._destroyRemoveNotificationDialog,this)},_onClickRemove:function(a){d.god.trigger("closeDialogs:delete");var b=e(a.target);this.remove_notification_dialog=new f({authenticityToken:this.options.authenticityToken,notificationId:b.data("id")}),this.remove_notification_dialog.appendToBody(),this._bindRemoveNotificationDialog(),this.addView(this.remove_notification_dialog)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./delete_notification_dialog_view":321,"./send_button_view":323,markdown:572}],323:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null,d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof a?a.Backbone:null,e=140;b.exports=c.core.View.extend({className:"FormAccount-rowData",events:{"click .js-button":"onUpdate"},initialize:function(a){this.template=c.templates.getTemplate("organization/organization_notification/send_button"),this.model=new d.Model({status:"idle",counter:0}),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this.template({isLoading:this._isLoading(),isDisabled:this._isDisabled(),isNegative:this._isNegative(),counter:e-this.model.get("counter")})),this},updateCounter:function(a){this.model.set("counter",a)},_initBinds:function(){this.model.bind("change",this.render,this)},_isNegative:function(){return this.model.get("counter")>e},_isDisabled:function(){return 0===this.model.get("counter")||this._isNegative()||this._isLoading()},_isLoading:function(){return"loading"===this.model.get("status")},_submit:function(){this.trigger("submitForm")},onUpdate:function(){return!this._isDisabled()&&(this._submit(),void this.model.set({status:"loading"}))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],324:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./organization_user_quota_slider"),f=a("./organization_user_quota_slider_input");b.exports=d.core.View.extend({initialize:function(){this.userQuotaSlider=new e({el:this.$(".js-userQuotaSlider"),model:this.model}),this.addView(this.userQuotaSlider),this.userQuotaSliderInput=new f({el:this.$(".js-userQuotaSliderInput"),model:this.model}),this.addView(this.userQuotaSliderInput),this._initBinds()},_initBinds:function(){this.model.bind("change:quota_in_bytes",this._onQuotaChange,this)},_onQuotaChange:function(a,b){this.$("#user_quota").val(b)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./organization_user_quota_slider":325,"./organization_user_quota_slider_input":326}],325:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.core.View.extend({events:{"hover .js-quotaProgressSlider":"_showTooltip"},initialize:function(){this._initBinds(),this._initViews()},_initBinds:function(){this.model.bind("change:quota_in_bytes",this._onQuotaChange,this)},_initViews:function(){var a=104857600/this.model.organization.get("available_quota_for_user");this.$(".js-slider").slider({max:100,min:a,step:1,value:this.model.assignedQuotaPercentage(),range:"min",orientation:"horizontal",slide:this._onSlideChange.bind(this)}),c(".ui-slider-handle").addClass("js-quotaProgressSlider")},_onSlideChange:function(a,b){var d=Math.max(Math.floor(this.model.organization.get("available_quota_for_user")*b.value/100),1),e=100*d/this.model.organization.get("available_quota_for_user");if(!(b.value>=this.model.usedQuotaPercentage()))return!1;this.$(".ui-slider-range").css("width",e+"%"),this.$(".js-quotaProgressSlider").css("left",e+"%");var f=c(".js-quotaProgressSlider").offset().left-c(".js-orgUserQuotaTooltip").outerWidth()/2+c(".js-quotaProgressSlider").outerWidth()/2;c(".js-orgUserQuotaTooltip").css("left",f),this.model.set("quota_in_bytes",d)},_onQuotaChange:function(){this.model.assignedQuotaPercentage()>=this.model.usedQuotaPercentage()&&(c(".ui-slider-range").css("width",Math.min(this.model.assignedQuotaPercentage(),100)+"%"),c(".js-quotaProgressSlider").css("left",Math.min(this.model.assignedQuotaPercentage(),100)+"%"))},_showTooltip:function(){var a=this.model;this.addView(new d.common.TipsyTooltip({el:c(".js-quotaProgressSlider"),className:"js-orgUserQuotaTooltip",title:function(){return a.assignedQuotaPercentage().toFixed(0)+"% of the available org quota"}}))}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],326:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;b.exports=d.core.View.extend({events:{"keyup .js-assignedSize":"_onKeyup"},initialize:function(){this._initBinds(),this._initViews()},_initBinds:function(){this.model.bind("change:quota_in_bytes",this._onQuotaChange,this)},_initViews:function(){var a=Math.max(Math.floor(this.model.get("quota_in_bytes")/1024/1024).toFixed(0),1);this.$(".js-assignedSize").val(a)},_onQuotaChange:function(){this.$(".js-assignedSize").val(Math.max(this.model.assignedQuotaInRoundedMb(),1))},_onKeyup:function(){var a=Math.max(Math.floor(1048576*this.$(".js-assignedSize").val()),1048576),b=100*a/this.model.organization.get("available_quota_for_user"),d='<p class="FormAccount-rowInfoText FormAccount-rowInfoText--error js-userQuotaError">Invalid quota, insert a valid one.</p>';isNaN(b)||this.model.set("quota_in_bytes",a),isNaN(b)||this.model.get("quota_in_bytes")>this.model.organization.get("available_quota_for_user")||this.model.get("quota_in_bytes")<this.model.get("db_size_in_bytes")?(this.$(".js-assignedSize").addClass("has-error"),0===this.$(".js-userQuotaError").length&&c(".js-userQuotaSliderInput").append(d)):(this.$(".js-assignedSize").removeClass("has-error"),this.$(".js-userQuotaError").remove())}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],327:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof a?a.cdb:null;c.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof a?a.cdb.admin:null;var d="undefined"!=typeof window?window.$:"undefined"!=typeof a?a.$:null;b.exports=c.admin.DropdownMenu.extend({className:"CDB-Text Dropdown",initialize:function(){this.elder("initialize"),this.template_base=c.templates.getTemplate("public_common/user_settings/dropdown_template"),c.god.bind("closeDialogs",this.hide,this)},render:function(){var a=this.model,b=a.viewUrl();return this.$el.html(this.template_base({name:a.get("name")||a.get("username"),email:a.get("email"),isOrgOwner:a.isOrgOwner(),dashboardUrl:b.dashboard(),publicProfileUrl:b.publicProfile(),accountSettingsUrl:b.accountSettings(),logoutUrl:b.logout()})),d("body").append(this.el),this},clean:function(){d(this.options.target).unbind("click",this._handleClick),this.constructor.__super__.clean.apply(this)}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],328:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("./user_settings/dropdown_view"),f="undefined"!=typeof window?window.$:"undefined"!=typeof c?c.$:null;b.exports=d.core.View.extend({events:{"click .js-dropdown-target":"_createDropdown"},render:function(){var a=this.model.viewUrl().dashboard(),b=a.datasets(),c=a.maps();return this.$el.html(d.templates.getTemplate("public_common/user_settings_template")({avatarUrl:this.model.get("avatar_url"),mapsUrl:c,datasetsUrl:b})),this},_createDropdown:function(a){this.killEvent(a),d.god.trigger("closeDialogs");var b=new e({target:f(a.target),model:this.model,horizontal_offset:18});b.render(),b.on("onDropdownHidden",function(){b.clean()},this),b.open()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./user_settings/dropdown_view":327}],329:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e="undefined"!=typeof window?window._:"undefined"!=typeof c?c._:null,f=a("../common/views/create_default_fallback_map");b.exports=d.core.View.extend({render:function(){this.$el.removeClass("is-pre-loading").addClass("is-loading");var a;a=this.options.createVis?this._createVisMap(this.options.createVis):this._createFallbackMap();var b=this;return a.done(function(){b.$el.removeClass("is-loading"),b.$(".js-spinner").remove()}),this},_createVisMap:function(a){return d.createVis(this.el,a.url,e.defaults(a.opts,{title:!1,header:!1,description:!1,search:!1,layer_selector:!1,text:!1,image:!1,shareable:!1,annotation:!1,zoom:!1,cartodb_logo:!1,scrollwheel:!1,mobile_layout:!0,slides_controller:!1,legends:!1,time_slider:!1,loader:!1,fullscreen:!1,no_cdn:!1}))},_createFallbackMap:function(){return f({el:this.el,baselayer:this.options.fallbackBaselayer}),{done:function(a){a()}}}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../common/views/create_default_fallback_map":243}],330:[function(a,b,c){(function(a){var c="undefined"!=typeof window?window.Backbone:"undefined"!=typeof a?a.Backbone:null;b.exports=c.Collection.extend({url:"/api/v1/viz",parse:function(a){return this.total_entries=a.total_entries,a.visualizations}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],331:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof c?c.cdb:null,e=a("../common/view_factory"),f=a("../common/view_helpers/random_quote"),g=a("../common/views/likes/view"),h=a("../common/views/mapcard_preview"),i=a("./feed_collection");b.exports=d.core.View.extend({tagName:"div",_PAGE:1,_ITEMS_PER_PAGE:8,_SMALL_WIDTH:544,_CARD_HEIGHT:170,_LOADER_TITLE:"Loading visualizations",events:{"click .js-more":"_onClickMore"},initialize:function(){_.bindAll(this,"_initLike","_fetchLike","_onFetchError","_onWindowResize","_renderStaticMaps"),this.maps=[],this._initTemplates(),this._initModels(),this._initBindings()},render:function(){return this.$el.html(this.template()),this._renderLoader(),this._fetchItems({page:this._PAGE}),this},_onWindowResize:function(){var a=$(window).width();a<=this._SMALL_WIDTH?this.model.set("size","small"):this.model.set("size","big"),this._renderStaticMaps()},_initTemplates:function(){this.template=d.templates.getTemplate("user_feed/template"),this.mapTemplate=d.templates.getTemplate("user_feed/map_item_template"),this.datasetTemplate=d.templates.getTemplate("user_feed/dataset_item_template"),this.loaderTemplatePath="user_feed/loading",this.emptyTemplatePath="user_feed/empty",this.errorTemplatePath="user_feed/error"},_initModels:function(){var a="big",b=$(window).width();b<=this._SMALL_WIDTH&&(a="small"),this.model=new d.core.Model({vis_count:0,type:"",size:a,page:0,order_by:"likes"}),this.collection=new i,this.collection.bind("reset",this._renderVisualizations,this)},_initBindings:function(){this.model.bind("change:show_more",this._onChangeShowMore,this),this.model.bind("change:show_loader",this._onChangeShowLoader,this),this.model.bind("change:show_mast",this._onChangeShowMast,this),this.model.bind("change:vis_count",this._onChangeVisCount,this),$(window).bind("resize",this._onWindowResize)},_onChangeVisCount:function(){this.model.get("vis_count")>=this.collection.total_entries?this.model.set({show_more:!1}):this.model.set({show_more:!0})},_onChangeShowMast:function(){this.model.get("show_mast")?this.$(".js-mast").removeClass("is-hidden"):this.$(".js-mast").addClass("is-hidden")},_onChangeShowLoader:function(){this.model.get("show_loader")?this.loader.show():this.loader.hide()},_onChangeShowMore:function(){this.$(".js-more").toggleClass("is-hidden",!this.model.get("show_more"))},_renderLoader:function(){this.loader=e.createByTemplate(this.loaderTemplatePath,{title:this._LOADER_TITLE,quote:f()}),this.$el.append(this.loader.render().$el)},_renderError:function(){this.error=e.createByTemplate(this.errorTemplatePath,{}),this.$el.append(this.error.render().$el)},_renderEmpty:function(){this.empty=e.createByTemplate(this.emptyTemplatePath,{name:config.user_name}),this.$el.append(this.empty.render().$el)},_getDatasetSize:function(a){var b=a.get("table").size;return b?d.Utils.readablizeBytes(b,!0).split(" "):0},_getGeometryType:function(a){if(a&&a.length>0){var b=["point","polygon","line","raster"],c=a[0];return _.find(b,function(a){return c.toLowerCase().indexOf(a)!==-1})}return null},_renderVisualizations:function(){return 0===this.collection.length?(this.model.set({show_loader:!1}),void this._renderEmpty()):(this.model.set({vis_count:this.model.get("vis_count")+this.collection.length,show_loader:!1,show_more:!0,show_filters:!0,show_mast:!0}),void this.collection.each(function(a){var b="derived"===a.get("type")?this.mapTemplate:this.datasetTemplate,c=a.get("table")&&a.get("table").geometry_types?this._getGeometryType(a.get("table").geometry_types):null,e=a.get("permission").owner,f=b({vis:a.attributes,datasetSize:this._getDatasetSize(a),username:e.username,avatar_url:e.avatar_url,table_count:e.table_count,maps_count:e.maps_count,geomType:c,account_host:config.account_host,base_url:d.config.get("url_prefix")});this.$(".js-items").append(f);var g=this.$(".js-items").find('[data-vis-id="'+a.get("id")+'"]');"derived"===a.get("type")&&this.maps.push(a),"derived"!==a.get("type")||a.get("rendered_"+this.model.get("size"))||this._renderStaticMap(a,g),this._initLike(a,g.find(".js-like"))},this))},_renderStaticMaps:function(){_.each(this.maps,function(a){if(!a.get("rendered_"+this.model.get("size"))){var b=this.$(".js-items").find('[data-vis-id="'+a.get("id")+'"]');this._renderStaticMap(a,b)}},this)},_renderStaticMap:function(a,b){var c=a.get("id"),e=a.get("permission").owner.username,f=540,g="is-"+this.model.get("size");"small"===this.model.get("size")&&(f=288),c&&e&&(a.set("rendered_"+this.model.get("size"),!0),new h({el:b.find(".js-header"),width:f,height:this._CARD_HEIGHT,mapsApiResource:d.config.getMapsResourceName(e),username:e,visId:c,className:g}).load())},_getLikesEndpoint:function(a){return"/api/v1/viz/"+a.get("id")+"/like"},_initLike:function(a,b){var c=this.options.authenticatedUser&&this.options.authenticatedUser.get("username"),e=d.admin.Like.newByVisData({likeable:!1,show_label:!0,vis_id:a.get("id"),likes:a.get("likes")}),f=this._getLikesEndpoint(a);c?this._fetchLike(e,f):this.options.authenticatedUser.bind("change",function(){this._fetchLike(e,f)},this);var h=new g({el:b,model:e});h.render()},_fetchLike:function(a,b){this.options.authenticatedUser.get("username")&&(a.bind("loadModelCompleted",function(){a.set("likeable",!0)}),a.url=b,a.sync=Backbone.withCORS,a.fetch())},_fetchItems:function(a){var b=_.extend({types:"table,derived",privacy:"public",exclude_shared:"true",per_page:this._ITEMS_PER_PAGE,order:"updated_at"},a);this.collection.fetch({data:b,error:this._onFetchError})},_onFetchError:function(){this.model.set({show_loader:!1}),this._renderError()},_onClickMore:function(a){this.killEvent(a),this.model.set({show_more:!1,show_loader:!0}),this._fetchItems({page:++this._PAGE})}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../common/view_factory":237,"../common/view_helpers/random_quote":241,"../common/views/likes/view":255,"../common/views/mapcard_preview":256,"./feed_collection":330}],332:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../javascripts/cartodb/common/service_models/service_invalidate_model"),e=a("../../../../javascripts/cartodb/account/service_disconnect_dialog_view");describe("account/service_disconnect_dialog_view",function(){var a;beforeEach(function(){d.prototype.destroy=function(a){a.success(null,{success:!0})},a=new e({model:new c.core.Model({name:"dropbox",title:"Dropbox",state:"idle",revoke_url:"",connected:!1}),clean_on_hide:!0,enter_to_confirm:!1}),spyOn(a,"_reloadWindow"),a.render()}),describe("render",function(){it("should render properly",function(){expect(a.$(".Dialog-header").length).toBe(1),expect(a.$(".Dialog-body").length).toBe(0),expect(a.$(".Dialog-footer").length).toBe(1),expect(a.$(".Dialog-footer .Button").length).toBe(2)}),it("should show revoke button when revoke url is not present",function(){expect(a.$(".js-revoke").length).toBe(1)}),it("should show revoke instructions when revoke url is present",function(){a.model.set("revoke_url","https://carto.com"),a.render(),expect(a.$(".Dialog-body").length).toBe(1),expect(a.$(".js-revoke").length).toBe(0),expect(a.$(".Button[href]").length).toBe(1)}),it("should not display the loading",function(){expect(this.innerHTML(a)).not.toContain("Revoking access")})}),describe("when click revoke",function(){beforeEach(function(){spyOn(d.prototype,"destroy"),a.$(".js-revoke").click()}),it("should change to loading state",function(){expect(this.innerHTML(a)).toContain("Revoking access")}),describe("when revoking goes well",function(){beforeEach(function(){d.prototype.destroy.calls.argsFor(0)[0].success(null,{success:!0})}),it("should reload if everything goes well",function(){expect(a._reloadWindow).toHaveBeenCalled()})}),describe("when revoking fails",function(){beforeEach(function(){spyOn(a,"close"),d.prototype.destroy.calls.argsFor(0)[0].success(null,{success:!1})}),it("should close the dialog",function(){expect(a.close).toHaveBeenCalled()}),it("should set the model state to error",function(){expect(a.model.get("state")).toBe("error")})})}),it("should not have leaks",function(){expect(a).toHaveNoLeaks()}),afterEach(function(){a.close()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/account/service_disconnect_dialog_view":1,"../../../../javascripts/cartodb/common/service_models/service_invalidate_model":231}],333:[function(a,b,c){var d=a("../../../../javascripts/cartodb/account/service_item_view"),e=(a("../../../../javascripts/cartodb/common/service_models/service_oauth_model"),a("../../../../javascripts/cartodb/common/service_models/service_valid_token_model"));describe("account/service_item_view",function(){var a;beforeEach(function(){e.prototype.fetch=function(a){a.success(null,{oauth_valid:!0})},a=new d({model:new cdb.core.Model({name:"dropbox",title:"Dropbox",state:"idle",revoke_url:"",connected:!0})}),spyOn(a,"_checkToken").and.callThrough(),spyOn(a,"_reloadWindow"),a.render()}),it("should check token if it is connected from the beginning",function(){a.initialize(),expect(a._checkToken).toHaveBeenCalled()}),describe("render",function(){it("should render properly",function(){expect(a.$(".FormAccount-input").length).toBe(1),expect(a.$(".FormAccount-input").val().toLowerCase()).toBe("connected"),expect(a.$(".FormAccount-input").hasClass("is-disabled")).toBeTruthy(),expect(a.$(".js-disconnect").length).toBe(1),expect(a.$(".js-disconnect").text().toLowerCase()).toBe("disconnect")}),it("should render when connected is changed",function(){a.model.set("connected",!1),expect(a.$(".FormAccount-input").length).toBe(0),expect(a.$(".js-disconnect").length).toBe(0),expect(a.$(".js-connect").length).toBe(1),expect(a.$(".js-connect").text().toLowerCase()).toContain("connect"),expect(a.$(".js-connect .ServiceIcon").length).toBe(1)}),it("should render when status is changed",function(){a.model.set("state","loading"),expect(a.$(".js-disconnect").length).toBe(0),expect(a.$(".FormAccount-rowInfoText").text().toLowerCase()).toContain("disconnecting..."),a.model.set("connected",!1),expect(a.$(".js-connect").length).toBe(0),expect(a.$(".FormAccount-link").text().toLowerCase()).toContain("connecting...")}),it("should show an error when something is wrong",function(){a.model.set("state","error"),expect(a.$(".FormAccount-rowInfoText--error").length).toBe(1),expect(a.$(".FormAccount-rowInfoText--error .FormAccount-link").length).toBe(2),expect(a.$(".FormAccount-rowInfoText--error .js-disconnect").length).toBe(1),a.model.set("connected",!1),expect(a.$(".js-connect").length).toBe(1)})}),it("should not have leaks",function(){expect(a).toHaveNoLeaks()})})},{"../../../../javascripts/cartodb/account/service_item_view":2,"../../../../javascripts/cartodb/common/service_models/service_oauth_model":232,"../../../../javascripts/cartodb/common/service_models/service_valid_token_model":234}],334:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null,"undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null,a("../../../../javascripts/cartodb/common/avatar_selector_view")),d=a("../../../../javascripts/cartodb/common/asset_model.js");describe("common/avatar_selector_view",function(){beforeEach(function(){this.view=new c({renderModel:new cdb.core.Model({inputName:"user[avatar_url]",name:"test",avatar_url:"avatar-url",id:"uuuu-uuuu"})}),this.view.render()}),it("should render properly",function(){expect(this.view.$(".FormAccount-avatarPreviewImage").length).toBe(1),expect(this.view.$(".js-fileAvatar").length).toBe(1)}),it("should disable input and show loader when file is chosen",function(){d.prototype.save=function(a,b,c){},this.view.$(":file").trigger("change"),expect(this.view.model.get("state")).toBe("loading"),expect(this.view.$(".btn[disabled]").length).toBe(1)}),it("should enable input and remove loader when upload fails",function(a){var b=this;d.prototype.save=function(a,b,c){setTimeout(function(){b.error()},1)},this.view.$(":file").trigger("change"),setTimeout(function(){expect(b.view.model.get("state")).toBe("error"),expect(b.view.$(".btn[disabled]").length).toBe(0),expect(b.view.$(".FormAccount-rowInfoText--error").length).toBe(1),a()},100)}),it("should enable input and remove loader when upload is completed",function(a){var b=this;d.prototype.save=function(a,b,c){setTimeout(function(){b.success(a,{public_url:"hello"})},1)},this.view.$(":file").trigger("change"),setTimeout(function(){expect(b.view.model.get("state")).toBe("success"),expect(b.view.$(".FormAccount-rowInfoText--error").length).toBe(0),expect(b.view.$("img").attr("src")).toBe("hello"),expect(b.view.$(".btn[disabled]").length).toBe(0),a()},100)}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/common/asset_model.js":3,"../../../../javascripts/cartodb/common/avatar_selector_view":4}],335:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../javascripts/cartodb/common/background_polling/models/imports_model"),e=a("../../../../../javascripts/cartodb/common/background_polling/views/imports/background_import_item_view");describe("common/background_polling/background_import_item_view",function(){beforeEach(function(){var a=new c.admin.User({base_url:"http://paco.carto.com",username:"paco"});this.model=new d,spyOn(this.model,"bind").and.callThrough(),this.view=new e({createVis:!1,model:this.model,user:a})}),it("should render properly",function(){this.view.render(),expect(this.view.$el.hasClass("ImportItem")).toBeTruthy(),expect(this.view.$(".ImportItem-text").length).toBe(1)}),it("should bind model changes",function(){expect(this.model.bind.calls.argsFor(0)[0]).toEqual("change"),expect(this.model.bind.calls.argsFor(1)[0]).toEqual("remove")}),it("should stop upload and remove it when upload is aborted",function(){this.view.render(),spyOn(this.view,"clean"),this.model.set("state","uploading"),this.view.$(".js-abort").click(),expect(this.view.clean).toHaveBeenCalled()}),it("should show display_name when it is available from import model",function(){this.model.imp.set({item_queue_id:"hello-id",type:""}),this.model.set("state","importing"),expect(this.view.$(".ImportItem-text").text()).toContain("hello-id"),this.model.imp.set("display_name","table_name_test"),this.model.set("state","geocoding"),expect(this.view.$(".ImportItem-text").text()).toContain("table_name_test"),expect(this.view.$(".ImportItem-text").text()).not.toContain("hello-id")}),it("should have no leaks",function(){this.view.render(),expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/background_polling/models/imports_model":14,"../../../../../javascripts/cartodb/common/background_polling/views/imports/background_import_item_view":25}],336:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.Backbone:"undefined"!=typeof b?b.Backbone:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null),d=a("../../../../../javascripts/cartodb/common/background_polling/models/imports_model"),e=a("../../../../../javascripts/cartodb/common/background_polling/background_polling_view"),f=a("../../../../../javascripts/cartodb/dashboard/background_polling_model"),g=a("../../../../../javascripts/cartodb/common/background_polling/models/imports_collection"),h=a("../../../../../javascripts/cartodb/common/background_polling/models/geocodings_collection");describe("common/background_polling/background_polling_view",function(){beforeEach(function(){this.user=new c.admin.User({base_url:"http://paco.carto.com",username:"paco"}),spyOn(c.god,"bind").and.callThrough(),this.importsCollection=new g(void 0,{user:this.user}),this.geocodingsCollection=new h(void 0,{user:this.user}),this.model=new f({},{user:this.user,importsCollection:this.importsCollection,geocodingsCollection:this.geocodingsCollection}),this.view=new e({model:this.model,createVis:!1,user:this.user}),this.createImportsModel=function(a){return new d({state:a},{user:this.user})}.bind(this)}),it("should render properly",function(){this.view.render(),expect(this.view.$(".BackgroundPolling-header").length).toBe(1),expect(this.view.$(".BackgroundPolling-body").length).toBe(1),expect(this.view.$(".BackgroundPolling-list").length).toBe(1)}),it("should listen for cdb.god events",function(){var a=c.god.bind.calls.argsFor(0);expect(a[0]).toEqual("importByUploadData"),expect(a[1]).toEqual(this.view._addDataset),expect(a[2]).toEqual(this.view);var b=c.god.bind.calls.argsFor(1);expect(b[0]).toEqual("fileDropped"),expect(b[1]).toEqual(this.view._onDroppedFile),expect(b[2]).toEqual(this.view)}),it("should toggle visibility depending the size of the collection",function(){var a=new d;spyOn(this.view,"hide"),spyOn(this.view,"show"),this.model.addImportItem(a),expect(this.view.show).toHaveBeenCalled(),expect(this.view.hide).not.toHaveBeenCalled(),this.model.removeImportItem(a),expect(this.view.show.calls.count()).toEqual(1),expect(this.view.hide).toHaveBeenCalled()}),it("should check if any import has failed when any has changed",function(){this.view.render();var a=new d;this.model.addImportItem(a),expect(this.view.$(".BackgroundPolling-headerBadgeCount").length).toBe(0),a.set("state","error"),expect(this.view.$(".BackgroundPolling-headerBadgeCount").length).toBe(1),expect(this.view.$(".BackgroundPolling-headerBadgeCount").text()).toBe("1");var b=new d;this.model.addImportItem(b),b.set("state","error"),expect(this.view.$(".BackgroundPolling-headerBadgeCount").length).toBe(1),expect(this.view.$(".BackgroundPolling-headerBadgeCount").text()).toBe("2");var c=new d;this.model.addImportItem(c),c.set("state","completed"),expect(this.view.$(".BackgroundPolling-headerBadgeCount").length).toBe(1),expect(this.view.$(".BackgroundPolling-headerBadgeCount").text()).toBe("2"),this.model.removeImportItem(a),expect(this.view.$(".BackgroundPolling-headerBadgeCount").length).toBe(1),expect(this.view.$(".BackgroundPolling-headerBadgeCount").text()).toBe("1"),this.model.removeImportItem(b),expect(this.view.$(".BackgroundPolling-headerBadgeCount").length).toBe(0)}),describe("import limits",function(){beforeEach(function(){this.user.set("limits",{concurrent_imports:2})}),it("should check if user can import before add the item",function(){spyOn(this.model,"canAddImport"),this.view._addDataset({hello:"hello"}),expect(this.model.canAddImport).toHaveBeenCalled(),expect(this.model.canAddImport.calls.count()).toBe(1),this.view._onDroppedFile([{hello:"hello"}]),expect(this.model.canAddImport.calls.count()).toBe(2)}),it("should add limits view when user has reached his/her import quota",function(){_.times(2,function(){this.model.addImportItem(this.createImportsModel("pending"))},this),this.view._addDataset({hello:"hello"}),expect(this.view._importLimit).not.toBe(void 0)}),it("should remove limits view when user has available slots",function(){_.times(2,function(){this.model.addImportItem(this.createImportsModel("pending"))},this),this.view._addDataset({hello:"hello"}),expect(this.view._importLimit).not.toBe(void 0),this.model.importsCollection.each(function(a,b){b<2&&a.set({step:"upload",state:"error"})}),this.view._addDataset({hello:"hello"}),expect(this.view._importLimit).toBe(void 0)})}),it("should have no leaks",function(){this.view.render(),expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/background_polling/background_polling_view":6,"../../../../../javascripts/cartodb/common/background_polling/models/geocodings_collection":10,"../../../../../javascripts/cartodb/common/background_polling/models/imports_collection":13,"../../../../../javascripts/cartodb/common/background_polling/models/imports_model":14,"../../../../../javascripts/cartodb/dashboard/background_polling_model":262}],337:[function(a,b,c){var d=a("../../../../../javascripts/cartodb/common/background_polling/models/geocodings_collection");a("../../../../../javascripts/cartodb/common/background_polling/models/geocoding_model");describe("common/background_polling/geocodings_collection",function(){beforeEach(function(){this.user=new cdb.admin.User({username:"pepe",base_url:"http://pepe.carto.com"}),d.prototype.sync=function(a,b,c){c.success()},this.collection=new d(void 0,{user:this.user})}),describe("polling",function(){beforeEach(function(){this.vis=new cdb.admin.Visualization({type:"derived",name:"my name"});var a=new cdb.admin.CartoDBLayer({table_name:"test_table"});this.vis.map.layers.reset([new cdb.geo.MapLayer,a])}),it("should start polling the model because visualization is not defined",function(){spyOn(this.collection,"add"),this.collection.parse({geocodings:[{id:1}]}),expect(this.collection.add).toHaveBeenCalled()}),it("should start polling the geocoding model because visualization is defined and layer added to it",function(){this.collection.vis=this.vis,spyOn(this.collection,"add"),this.collection.parse({geocodings:[{id:1,table_name:"test_table"}]}),expect(this.collection.add).toHaveBeenCalled()}),it("should not start polling the geocoding model because visualization is defined but layer is not on it",function(){
this.collection.vis=this.vis,spyOn(this.collection,"add"),this.collection.parse({geocodings:[{id:1,table_name:"hello"}]}),expect(this.collection.add).not.toHaveBeenCalled()}),it("should stop polling if there is an error in the poll checker request",function(){this.collection.sync=function(a,b,c){c.error()},this.collection.pollCheck(),expect(this.collection.pollTimer).not.toBeDefined()})}),it("should determine if a new geocoding could be possible",function(){expect(this.collection.canGeocode()).toBeTruthy(),this.collection.reset([{},{state:"failed"},{}]),expect(this.collection.canGeocode()).toBeFalsy(),this.collection.reset([{state:"failed"}]),expect(this.collection.canGeocode()).toBeTruthy()}),it("should return the failed items",function(){expect(this.collection.failedItems()).toEqual([]),this.collection.reset([{},{state:"failed"},{}]),expect(this.collection.failedItems().length).toEqual(1)})})},{"../../../../../javascripts/cartodb/common/background_polling/models/geocoding_model":8,"../../../../../javascripts/cartodb/common/background_polling/models/geocodings_collection":10}],338:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../javascripts/cartodb/common/background_polling/models/geocoding_model");describe("common/background_polling/geocoding_model",function(){beforeEach(function(){var a=new c.admin.User({username:"paco"});d.prototype.sync=function(a,b,c){c.success()},this.model=new d(null,{user:a}),spyOn(this.model,"bind").and.callThrough()}),it("should not start polling when option is not enabled",function(){spyOn(this.model,"fetch"),this.model.options.startPollingAutomatically=!1,this.model.set("id",1),this.model.initialize(),expect(this.model.fetch).not.toHaveBeenCalled()}),it("should save model when it is new",function(){spyOn(this.model,"save"),this.model._checkModel(),expect(this.model.save).toHaveBeenCalled()}),it("should have several change binds",function(){this.model._initBinds(),expect(this.model.bind.calls.argsFor(0)[0]).toEqual("change:id")}),describe(".pollCheck",function(){beforeEach(function(){jasmine.clock().install(),spyOn(this.model,"fetch")}),afterEach(function(){jasmine.clock().uninstall()}),it("should start polling",function(){spyOn(this.model.poller,"start"),this.model.pollCheck(),expect(this.model.poller.start).toHaveBeenCalled()})}),describe(".destroyCheck",function(){beforeEach(function(){jasmine.clock().install(),spyOn(this.model,"fetch")}),afterEach(function(){jasmine.clock().uninstall()}),it("should stop polling",function(){spyOn(this.model.poller,"stop"),this.model.pollCheck(),this.model.destroyCheck(),expect(this.model.poller.stop).toHaveBeenCalled()})}),it("should know when geocoding has finished",function(){expect(this.model.hasCompleted()).toBeFalsy(),this.model.set("state","finished"),expect(this.model.hasCompleted()).toBeTruthy(),this.model.set("state","geocoding"),expect(this.model.hasCompleted()).toBeFalsy()}),it("should know when geocoding has failed",function(){expect(this.model.hasFailed()).toBeFalsy(),this.model.set("state","failed"),expect(this.model.hasFailed()).toBeTruthy(),this.model.set("state","geocoding"),expect(this.model.hasFailed()).toBeFalsy(),this.model.set("state","reset"),expect(this.model.hasFailed()).toBeTruthy(),this.model.set("state","cancelled"),expect(this.model.hasFailed()).toBeTruthy()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/background_polling/models/geocoding_model":8}],339:[function(a,b,c){var d=a("../../../../../javascripts/cartodb/common/background_polling/models/geocoding_model_poller");describe("GeocodingModelPoller",function(){var a;beforeEach(function(){var b=Backbone.Model.extend({url:"/hello"});this.model=new b,this.model.hasFailed=function(){return!1},this.model.hasCompleted=function(){return!1},this.model.sync=function(a,b,c){c.success()},a=this.model.fetch,spyOn(this.model,"fetch").and.callThrough(),this.poller=new d(this.model),jasmine.clock().install()}),afterEach(function(){jasmine.clock().uninstall()}),it("should stop polling when geocoding has failed",function(){this.model.hasFailed=function(){return!0},this.poller.start(),jasmine.clock().tick(4e3),expect(this.model.fetch.calls.count()).toBe(1)}),it("should stop polling when geocoding has completed",function(){this.model.hasCompleted=function(){return!0},this.poller.start(),jasmine.clock().tick(4e3),expect(this.model.fetch.calls.count()).toBe(1)}),it("should trigger a change event if an error occurs",function(){this.model.fetch=a,spyOn(this.model,"fetch");var b=jasmine.createSpy("error");this.model.bind("change",b),this.poller.start(),jasmine.clock().tick(2001),this.model.fetch.calls.mostRecent().args[0].error(),expect(b).toHaveBeenCalled()})})},{"../../../../../javascripts/cartodb/common/background_polling/models/geocoding_model_poller":9}],340:[function(a,b,c){var d=a("../../../../../javascripts/cartodb/common/background_polling/models/import_model_poller");describe("ImportModelPoller",function(){var a;beforeEach(function(){var b=Backbone.Model.extend({url:"/hello"});this.model=new b,this.model.sync=function(a,b,c){c.success()},a=this.model.fetch,spyOn(this.model,"fetch").and.callThrough(),this.poller=new d(this.model),jasmine.clock().install()}),afterEach(function(){jasmine.clock().uninstall()}),it("should stop polling when geocoding has failed",function(){this.model.set("state","failure"),this.poller.start(),jasmine.clock().tick(4e3),expect(this.model.fetch.calls.count()).toBe(1)}),it("should stop polling when geocoding has completed",function(){this.model.set("state","complete"),this.poller.start(),jasmine.clock().tick(4e3),expect(this.model.fetch.calls.count()).toBe(1)}),it("should increment the interval after a number of requests",function(){this.poller.start(),jasmine.clock().tick(6e4),expect(this.model.fetch.calls.count()).toBe(30),jasmine.clock().tick(5001),expect(this.model.fetch.calls.count()).toBe(31)})})},{"../../../../../javascripts/cartodb/common/background_polling/models/import_model_poller":12}],341:[function(a,b,c){var d=a("../../../../../javascripts/cartodb/common/background_polling/models/imports_collection");describe("common/background_polling/imports_collection",function(){beforeEach(function(){this.user=new cdb.admin.User({username:"pepe",base_url:"http://pepe.carto.com"}),this.collection=new d(void 0,{user:this.user})}),describe(".failedItems",function(){it("should return the failed items",function(){expect(this.collection.failedItems()).toEqual([]),this.collection.reset([{},{state:"failure",step:"import"},{}]),expect(this.collection.failedItems().length).toEqual(1)})})})},{"../../../../../javascripts/cartodb/common/background_polling/models/imports_collection":13}],342:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../javascripts/cartodb/common/background_polling/models/imports_model"),e=a("../../../../../javascripts/cartodb/common/background_polling/models/upload_model"),f=a("../../../../../javascripts/cartodb/common/background_polling/models/import_model");describe("common/background_polling/imports_model",function(){beforeEach(function(){var a=new c.admin.User({username:"paco"});this.model=new d(null,{user:a}),this.model.imp.createImport=function(){},this.model.imp.pollCheck=function(){}}),it("should start in upload step",function(){expect(this.model.get("step")).toBe("upload")}),it("should change state when upload or import state change",function(){this.model.upl.set("state","uploading"),expect(this.model.get("state")).toBe("uploading"),expect(this.model.get("step")).toBe("upload"),this.model.upl.set({state:"uploaded",item_queue_id:"vamos-neno"}),expect(this.model.get("state")).toBe("uploaded"),expect(this.model.get("id")).toBe("vamos-neno"),expect(this.model.get("step")).toBe("import"),this.model.imp.set("state","zipping"),expect(this.model.get("state")).toBe("zipping")}),it("should return error info",function(){expect(this.model.getError().title).toBeDefined(),expect(this.model.getError().what_about).toBeDefined(),expect(this.model.getError().error_code).toBeDefined()}),it("should return is import has failed",function(){expect(this.model.hasFailed()).toBeFalsy(),this.model.upl.set("state","error"),expect(this.model.hasFailed()).toBeTruthy(),this.model.upl.set("state","upgraded"),expect(this.model.hasFailed()).toBeFalsy(),this.model.set("id","vamos-neno"),this.model.imp.set("state","failure"),expect(this.model.hasFailed()).toBeTruthy(),this.model.imp.set("state","error"),expect(this.model.hasFailed()).toBeFalsy()}),it("should return is import has been completed",function(){expect(this.model.hasCompleted()).toBeFalsy(),this.model.set("id","vamos-neno"),this.model.imp.set("state","complete"),expect(this.model.hasCompleted()).toBeTruthy(),expect(this.model.get("state")).toBe("complete")}),it("should be able to return import info",function(){this.model.imp.createImport=function(){},this.model.set("id","vamos-neno"),expect(this.model.get("import")).not.toBe(void 0),expect(this.model.get("import").item_queue_id).toBe("vamos-neno")}),it("should be able to return upload info",function(){this.model.imp.createImport=function(){},this.model.upl.set({type:"url",value:"http://fakeurl.es/j.csv"}),expect(this.model.get("upload")).not.toBe(void 0),expect(this.model.get("upload").type).toBe("url"),expect(this.model.get("upload").value).toBe("http://fakeurl.es/j.csv")}),it("should start importing if model id is set",function(){spyOn(this.model.imp,"pollCheck"),this.model.set("id","vamos-neno"),expect(this.model.imp.pollCheck).toHaveBeenCalled()}),it("should stop upload and import when error is set",function(){spyOn(this.model,"stopUpload"),spyOn(this.model,"stopImport"),this.model.setError({error_code:1111}),expect(this.model.stopUpload).toHaveBeenCalled(),expect(this.model.stopImport).toHaveBeenCalled(),expect(this.model.get("state")).toBe("error")}),describe("checkStatus",function(){beforeEach(function(){spyOn(this.model.imp,"set"),spyOn(this.model.imp,"createImport"),spyOn(this.model.upl,"upload")}),it("should stop process when upload is not valid",function(){this.model._checkStatus(),expect(this.model.imp.set).not.toHaveBeenCalled(),expect(this.model.imp.createImport).not.toHaveBeenCalled(),expect(this.model.upl.upload).not.toHaveBeenCalled()}),it("should not stop process when upload is not valid but there is an id already set",function(){this.model.upl.set({type:"url",value:""}),this.model.set("id","idd"),this.model._checkStatus(),expect(this.model.imp.set).toHaveBeenCalled()}),it("should start upload when type is file",function(){this.model.upl.set({type:"file",value:{name:"fake.csv",size:1e3}}),this.model._checkStatus(),expect(this.model.upl.upload).toHaveBeenCalled()}),it("should create an import when type is not file and there is no id defined",function(){this.model.upl.set({type:"url",value:"http://paco.com"}),this.model._checkStatus(),expect(this.model.imp.createImport).toHaveBeenCalled()})}),describe("upload model",function(){beforeEach(function(){var a=new c.admin.User({username:"paco"});this.upload=new e({},{user:a}),spyOn(this.upload,"bind").and.callThrough()}),it("should have progress, change:value and error/invalid binds",function(){this.upload._initBinds();var a=this.upload.bind.calls.argsFor(0);expect(a[0]).toEqual("progress");var b=this.upload.bind.calls.argsFor(1);expect(b[0]).toEqual("change:value");var c=this.upload.bind.calls.argsFor(2);expect(c[0]).toEqual("error invalid")}),it("should set uploading state when progress change",function(){this.upload.set({value:"http://paco.csv",type:"url"}),this.upload.trigger("progress",20),expect(this.upload.get("state")).toBe("uploading")}),it("should have a fileAttribute set",function(){expect(this.upload.fileAttribute).toBe("filename")}),it("should validate the model when changes",function(){spyOn(this.upload,"validate"),this.upload.set({value:"http://marca.com/paco.jjjjj",type:"url"}),expect(this.upload.validate).toHaveBeenCalled()}),it("should change state when validate fails",function(){this.upload.set({type:"url",value:"hello"}),expect(this.upload.get("state")).toBe("error")}),it("should add error code when size validation fails",function(){this.upload.user.set("remaining_byte_quota",1),this.upload.set({type:"file",value:{name:"fake.csv",size:1e3}}),expect(this.upload.get("state")).toBe("error"),expect(this.upload.get("error_code")).toBe(8001),this.upload.set({type:"remote",remote_visualization_id:"iddd",size:1e3}),expect(this.upload.get("state")).toBe("error"),expect(this.upload.get("error_code")).toBe(8001),this.upload.set({type:"url",value:"heyheyhey.org"}),expect(this.upload.get("state")).toBe("error"),expect(this.upload.get("error_code")).toBe("")}),it("should raise an error when file name is not provided",function(){this.upload.set({type:"file",value:{}}),expect(this.upload.get("state")).toBe("error"),expect(this.upload.get("get_error_text").what_about).toBe("File name should be defined")}),describe(".setFresh",function(){beforeEach(function(){spyOn(this.upload,"set"),this.upload.setFresh({foo:"bar",create_vis:!0})}),it("should set the given dataset",function(){expect(this.upload.set).toHaveBeenCalled(),expect(this.upload.set.calls.argsFor(0)[0]).toEqual(jasmine.objectContaining({foo:"bar"}))}),it("should omit the create_vis value since set in constructor",function(){expect(this.upload.set.calls.argsFor(0)[0]).not.toEqual(jasmine.objectContaining({create_vis:!0}))})})}),describe("import model",function(){beforeEach(function(){this.imp=new f,spyOn(this.imp,"bind").and.callThrough()}),it("should have several change binds",function(){this.imp._initBinds();var a=this.imp.bind.calls.argsFor(0);expect(a[0]).toEqual("change:item_queue_id")}),it("should create a sync import when interval is greater than 0",function(){spyOn(this.imp,"_createSyncImport"),spyOn(this.imp,"_createRegularImport"),this.imp.createImport({interval:10}),expect(this.imp._createSyncImport).toHaveBeenCalled(),expect(this.imp._createRegularImport).not.toHaveBeenCalled()}),it("should create a sync import when there's no interval",function(){spyOn(this.imp,"_createSyncImport"),spyOn(this.imp,"_createRegularImport"),this.imp.createImport({interval:null}),expect(this.imp._createSyncImport).toHaveBeenCalled(),expect(this.imp._createRegularImport).not.toHaveBeenCalled()}),it("should create a regular import when interval is 0",function(){spyOn(this.imp,"_createSyncImport"),spyOn(this.imp,"_createRegularImport"),this.imp.createImport({interval:0}),expect(this.imp._createRegularImport).toHaveBeenCalled(),expect(this.imp._createSyncImport).not.toHaveBeenCalled()}),it("should stop polling when import post fails",function(){this.imp.sync=function(a,b,c){c.error()},spyOn(this.imp,"pollCheck"),this.imp.createImport({interval:0}),expect(this.imp.get("state")).toBe("failure"),expect(this.imp.pollCheck).not.toHaveBeenCalled()}),it("should start polling when item_queue_id is set",function(){spyOn(this.imp,"pollCheck"),this.imp.set("item_queue_id","vamos-neno"),expect(this.imp.pollCheck).toHaveBeenCalled()})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/background_polling/models/import_model":11,"../../../../../javascripts/cartodb/common/background_polling/models/imports_model":14,"../../../../../javascripts/cartodb/common/background_polling/models/upload_model":19}],343:[function(a,b,c){var d=a("../../../../../javascripts/cartodb/common/background_polling/models/lon_lat_geocoding_model");describe("common/background_importer/models/lon_lat_geocoding_model",function(){beforeEach(function(){this.table=TestUtil.createTable("test"),spyOn(this.table,"save"),this.model=new d({table:this.table,longitude_column:"lon",latitude_column:"lat",force_all_rows:!1})}),it("should set table name",function(){expect(this.model.get("table_name")).toEqual("test")}),it("should start geocoding immediately",function(){expect(this.table.save).toHaveBeenCalled()}),it("should save table with expected data",function(){var a=this.table.save.calls.argsFor(0);expect(a[0].longitude_column).toEqual("lon"),expect(a[0].latitude_column).toEqual("lat"),expect(a[0].force_all_rows).toEqual(!1)}),it("should have ongoing state",function(){expect(this.model.hasCompleted()).toBeFalsy(),expect(this.model.hasFailed()).toBeFalsy(),expect(this.model.isOngoing()).toBeTruthy()}),describe("when geocoding finished successfully",function(){beforeEach(function(){this.tableDataSpy=jasmine.createSpyObj("table.data()",["fetch"]),spyOn(this.table,"data").and.returnValue(this.tableDataSpy),this.geolocatedSpy=jasmine.createSpy("geolocated"),this.table.bind("geolocated",this.geolocatedSpy),this.table.save.calls.argsFor(0)[1].success()}),it("should trigger a geolocated event on table",function(){expect(this.geolocatedSpy).toHaveBeenCalled()}),it("should fetch table data",function(){expect(this.tableDataSpy.fetch).toHaveBeenCalled()}),it("should change state to completed",function(){expect(this.model.hasCompleted()).toBeTruthy(),expect(this.model.hasFailed()).toBeFalsy(),expect(this.model.isOngoing()).toBeFalsy()})}),describe("when geocoding fails",function(){beforeEach(function(){this.table.save.calls.argsFor(0)[1].error("lol",{responseText:'{ "errors": ["some explanation"] }'})}),it("should set error",function(){expect(this.model.get("error")).toEqual("some explanation")}),it("should change state to completed",function(){expect(this.model.hasCompleted()).toBeFalsy(),expect(this.model.hasFailed()).toBeTruthy(),expect(this.model.isOngoing()).toBeFalsy()})})})},{"../../../../../javascripts/cartodb/common/background_polling/models/lon_lat_geocoding_model":15}],344:[function(a,b,c){var d=a("../../../../../javascripts/cartodb/common/background_polling/models/poller");describe("Poller",function(){var a,b,c;beforeEach(function(){var d=Backbone.Model.extend({url:"/hello"});a=new d,b=a.sync,a.sync=function(a,b,c){c.success()},jasmine.clock().install(),c=a.fetch,spyOn(a,"fetch").and.callThrough()}),afterEach(function(){jasmine.clock().uninstall()}),describe(".start",function(){it("should start fetching periodically after the specified number of seconds",function(){var b=new d(a,{interval:100});b.start(),expect(a.fetch).not.toHaveBeenCalled(),jasmine.clock().tick(100),expect(a.fetch.calls.count()).toEqual(1),jasmine.clock().tick(100),expect(a.fetch.calls.count()).toEqual(2)}),it("should auto start fetching if autoStart option is true",function(){new d(a,{interval:100,autoStart:!0});expect(a.fetch).not.toHaveBeenCalled(),jasmine.clock().tick(100),expect(a.fetch.calls.count()).toEqual(1),jasmine.clock().tick(100),expect(a.fetch.calls.count()).toEqual(2)}),it("should not trigger new requests if previous request haven't succeeded",function(){a.sync=b;var c=new d(a,{interval:100});c.start(),jasmine.clock().tick(100),expect(a.fetch.calls.count()).toEqual(1),a.fetch.calls.mostRecent().args[0].success(),jasmine.clock().tick(2e3),expect(a.fetch.calls.count()).toEqual(2)}),it("should not try to poll if already polling",function(){var b=new d(a,{interval:100});b.start(),b.start(),expect(a.fetch).not.toHaveBeenCalled(),jasmine.clock().tick(100),expect(a.fetch.calls.count()).toEqual(1)}),it("should stop polling when the condition is satisfied",function(){a.set({something:"wadus"});var b=new d(a,{interval:100,stopWhen:function(a){return"wadus"===a.get("something")}});b.start(),expect(a.fetch).not.toHaveBeenCalled(),jasmine.clock().tick(100),expect(a.fetch.calls.count()).toEqual(1),jasmine.clock().tick(100),expect(a.fetch.calls.count()).toEqual(1)}),it("should use the given function to determine the interval",function(){a.sync=function(a,b,c){c.success()};new d(a,{interval:function(a){return 0===a?100:1},autoStart:!0});expect(a.fetch).not.toHaveBeenCalled(),jasmine.clock().tick(100),expect(a.fetch.calls.count()).toEqual(1),jasmine.clock().tick(1),expect(a.fetch.calls.count()).toEqual(2)}),it("should invoke the error callback if the request fails",function(){a.fetch=c,spyOn(a,"fetch");var b=jasmine.createSpy("error"),e=new d(a,{interval:100,error:b});e.start(),jasmine.clock().tick(100),a.fetch.calls.mostRecent().args[0].error(),expect(b).toHaveBeenCalledWith(a)})}),describe(".stop",function(){it("should stop polling",function(){var b=new d(a,{interval:100});b.start(),b.stop(),expect(a.fetch).not.toHaveBeenCalled(),jasmine.clock().tick(1e3),expect(a.fetch).not.toHaveBeenCalled()})})})},{"../../../../../javascripts/cartodb/common/background_polling/models/poller":17}],345:[function(a,b,c){(function(b){var c=a("../../../../javascripts/cartodb/common/batch_process_items"),d="undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null;describe("common/batch_process_items",function(){beforeEach(function(){this.items=d.range(42),this.processItemFn=jasmine.createSpy(),this.howManyInParallel=4;var a=this;c({howManyInParallel:this.howManyInParallel,items:this.items,processItem:this.processItemFn,done:function(){a.finishedAllSuccessfully=!0},fail:function(b){a.somethingFailed=b}})}),it("should have started processing that many items",function(){expect(this.processItemFn.calls.count()).toEqual(this.howManyInParallel)}),it("should not have called any callback until processing finished",function(){expect(this.finishedAllSuccessfully).toBeUndefined(),expect(this.somethingFailed).toBeUndefined()}),it("should have called the process fn with two arguments",function(){expect(this.processItemFn.calls.argsFor(0).length).toEqual(2)}),it("should have called the process fn with the item as 1st arg",function(){var a=3,b=this.processItemFn.calls.argsFor(a)[0];expect(b).toEqual(this.items[a])}),it("should have called the process fn with item result callback fn as 2nd arg",function(){var a=3,b=this.processItemFn.calls.argsFor(a)[1];expect(b).toEqual(jasmine.any(Function))}),describe("given all items finished successfully",function(){it("should wait until all items are processed before calling the done callback",function(){expect(this.finishedAllSuccessfully).toBeUndefined()}),it("should have called the done callback after all finished",function(){d.each(this.items,function(a,b){this.processItemFn.calls.argsFor(b)[1]()},this),expect(this.finishedAllSuccessfully).toBeTruthy()})}),describe("given at least one item fail",function(){beforeEach(function(){this.failIndex=3,this.errorMsg="something fail for processing item "+(this.failIndex+1),this.processItemFn.calls.argsFor(this.failIndex)[1](this.errorMsg)}),it("should have called the fail callback after all finished",function(){expect(this.somethingFailed).toBeTruthy()}),it("should pass error arg to the fail callback",function(){expect(this.somethingFailed).toEqual(this.errorMsg)})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/common/batch_process_items":28}],346:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,e=a("../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/add_custom_basemap_model.js");describe("common/dialog/add_custom_basemap/add_custom_basemap_model",function(){beforeEach(function(){this.baseLayers=new c.admin.UserLayers,this.map=jasmine.createSpyObj("map",["setBounds","changeProvider"]),this.model=new e({map:this.map,baseLayers:this.baseLayers})}),it("should start with tabs for current view",function(){expect(this.model.get("currentView")).toEqual("tabs")}),it("should start on XYZ tab",function(){expect(this.model.get("currentTab")).toEqual("xyz")}),describe(".activeTabModel",function(){it("should return the model for current tab",function(){expect(this.model.activeTabModel()).toEqual(jasmine.any(Object))})}),describe(".canSaveBasemap",function(){it("should return true if there is a layer set on current tab model and is not processing something",function(){expect(this.model.canSaveBasemap()).toBeFalsy(),this.model.activeTabModel().set("layer",{}),expect(this.model.canSaveBasemap()).toBeTruthy(),this.model.set("currentView","not tabs"),expect(this.model.canSaveBasemap()).toBeFalsy()})}),describe(".saveBasemap",function(){beforeEach(function(){this.layer=new c.admin.TileLayer({bounding_boxes:[1,2,3,4]}),this.deferred=d.Deferred(),spyOn(this.layer,"save").and.returnValue(this.deferred),this.model.activeTabModel().set("layer",this.layer)}),describe("when layer has already been added",function(){beforeEach(function(){this.baseLayers.add(this.layer),spyOn(this.model.activeTabModel(),"hasAlreadyAddedLayer").and.returnValue(!0),this.model.saveBasemap()}),it("should call hasAlreadyAddedLayer with baseLayers",function(){expect(this.model.activeTabModel().hasAlreadyAddedLayer).toHaveBeenCalled(),expect(this.model.activeTabModel().hasAlreadyAddedLayer).toHaveBeenCalledWith(this.baseLayers)}),it("should change provider of map",function(){expect(this.map.changeProvider).toHaveBeenCalled(),expect(this.map.changeProvider.calls.argsFor(0)[0]).toEqual("leaflet"),expect(this.map.changeProvider.calls.argsFor(0)[1]instanceof c.admin.TileLayer).toBeTruthy(),expect(this.map.changeProvider.calls.argsFor(0)[1]).not.toBe(this.layer),expect(this.map.changeProvider.calls.argsFor(0)[1].get("id")).toBeUndefined()}),it("should set bounding box on map",function(){expect(this.map.setBounds).toHaveBeenCalled(),expect(this.map.setBounds.calls.argsFor(0)[0]).toEqual([[2,1],[4,3]])}),it("should set current view to done",function(){expect(this.model.get("currentView")).toEqual("saveDone")})}),describe("when layer is new",function(){beforeEach(function(){this.model.saveBasemap()}),it("should add layer to baselayers",function(){expect(this.baseLayers.contains(this.layer)).toBeTruthy()}),it("should call save on layer",function(){expect(this.layer.save).toHaveBeenCalled()}),describe("when save succeeds",function(){beforeEach(function(){this.layer.set("id","abc-123",{silent:!0}),this.deferred.resolve()}),it("should change provider of map",function(){expect(this.map.changeProvider).toHaveBeenCalled(),expect(this.map.changeProvider.calls.argsFor(0)[0]).toEqual("leaflet"),expect(this.map.changeProvider.calls.argsFor(0)[1]instanceof c.admin.TileLayer).toBeTruthy(),expect(this.map.changeProvider.calls.argsFor(0)[1]).not.toBe(this.layer),expect(this.map.changeProvider.calls.argsFor(0)[1].get("id")).toBeUndefined()}),it("should set bounding box on map",function(){expect(this.map.setBounds).toHaveBeenCalled(),expect(this.map.setBounds.calls.argsFor(0)[0]).toEqual([[2,1],[4,3]])}),it("should set current view to done",function(){expect(this.model.get("currentView")).toEqual("saveDone")})}),describe("when save fails",function(){beforeEach(function(){this.deferred.reject()}),it("should remove layer from baselayers",function(){expect(this.baseLayers.contains(this.layer)).toBeFalsy()}),it("should set current view to ",function(){expect(this.model.get("currentView")).toEqual("saveFail")})})})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/add_custom_basemap_model.js":29}],347:[function(a,b,c){(function(b){var c=a("../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/add_custom_basemap_view.js"),d=a("../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/add_custom_basemap_model.js"),e="undefined"!=typeof window?window.Backbone:"undefined"!=typeof b?b.Backbone:null;describe("common/dialog/add_custom_basemap/add_custom_basemap_view",function(){beforeEach(function(){spyOn(d.prototype,"initialize").and.callThrough(),this.map=new cdb.admin.Map,this.baseLayers=new e.Collection({urlRoot:"localhost/user/layers"}),this.view=new c({map:this.map,baseLayers:this.baseLayers}),this.view.render()}),it("should render the tabs",function(){expect(this.innerHTML()).toContain("XYZ")}),it("should create view model with map and baselayers",function(){expect(d.prototype.initialize).toHaveBeenCalled(),expect(d.prototype.initialize).toHaveBeenCalledWith(jasmine.objectContaining({map:this.map})),expect(d.prototype.initialize).toHaveBeenCalledWith(jasmine.objectContaining({baseLayers:this.baseLayers}))}),it("should start on XYZ view",function(){expect(this.innerHTML()).toContain("Insert your XYZ URL")}),it("should hilight the selected tab",function(){expect(this.innerHTML()).toMatch('name="xyz".*is-selected'),expect(this.innerHTML()).not.toMatch('name="wms".*is-selected')}),it("should not have any leaks",function(){expect(this.view).toHaveNoLeaks()}),describe("when clicking on a tab",function(){beforeEach(function(){this.view.$('button[data-name="wms"]').click()}),it("should change tab",function(){expect(this.innerHTML()).toContain("Insert your WMS/WMTS URL")}),it("should highlight new tab",function(){expect(this.innerHTML()).toMatch('name="wms".*is-selected'),expect(this.innerHTML()).not.toMatch('name="xyz".*is-selected')})}),describe("when click OK",function(){beforeEach(function(){spyOn(this.view.model,"canSaveBasemap").and.returnValue(!0),spyOn(this.view.model,"saveBasemap"),this.view.$(".ok").click()}),it("should save new basemap",function(){expect(this.view.model.saveBasemap).toHaveBeenCalled()}),describe("when save succeeds",function(){beforeEach(function(){spyOn(this.view,"close"),this.view.model.set("currentView","saveDone")}),it("should close view",function(){expect(this.view.close).toHaveBeenCalled()})}),describe("when save fails",function(){beforeEach(function(){this.view.model.set("currentView","saveFail")}),it("should show an error explanation",function(){expect(this.innerHTML()).toContain("error")})})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/add_custom_basemap_model.js":29,"../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/add_custom_basemap_view.js":30}],348:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/mapbox/mapbox_model.js");describe("common/dialog/add_custom_basemap/mapbox/mapbox_model",function(){beforeEach(function(){this.model=new d({})}),describe(".hasAlreadyAddedLayer",function(){beforeEach(function(){this.baseLayers=new c.admin.UserLayers,this.baseLayers.add({kind:"tiled",urlTemplate:"https://a.tiles.mapbox.com/v4/username.12ab45c/{z}/{x}/{y}.png?access_token…aBcDC12323abc"})}),it("should return true if layer has already been added",function(){this.model.set("layer",new c.admin.TileLayer({})),expect(this.model.hasAlreadyAddedLayer(this.baseLayers)).toBeFalsy(),this.model.set("layer",this.baseLayers.at(0)),expect(this.model.hasAlreadyAddedLayer(this.baseLayers)).toBeTruthy()})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/mapbox/mapbox_model.js":31}],349:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,e=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/mapbox/mapbox_to_tile_layer_factory");describe("MapboxToTileLayerFactory",function(){beforeEach(function(){this.baseLayers=new d.admin.UserLayers,this.factory=new e({url:"https://a.tiles.mapbox.com/v4/username.123abc45d/",accessToken:"x.y123zwv456"})}),describe("._fixHTTPS",function(){it("should fix mapbox https url",function(){
var a=e.prototype._fixHTTPS("http://a.tiles.mapbox.com/v4/examples.map-4l7djmvo.json",{protocol:"https:"});expect(a).toEqual("https://dnv9my2eseobd.cloudfront.net/v4/examples.map-4l7djmvo.json"),a=e.prototype._fixHTTPS("http://a.tiles.mapbox.com/v4/examples.map-4l7djmvo.json",{protocol:"http:"}),expect(a).toEqual("http://a.tiles.mapbox.com/v4/examples.map-4l7djmvo.json")})}),describe(".createTileLayer",function(){beforeEach(function(){this.successSpy=jasmine.createSpy("success"),this.errorSpy=jasmine.createSpy("error"),this.callbacks={success:this.successSpy,error:this.errorSpy},spyOn(c,"ajax")}),describe("when provided an edit URL",function(){beforeEach(function(){this.username="cartodb",this.mapID="map-eeoepub0",this.mapboxID=this.username+"."+this.mapID,this.accessToken="ACCESS_TOKEN",this.factory.set({url:"https://tiles.mapbox.com/"+this.username+"/edit/"+this.mapID+"#3/0.09/0.00",accessToken:this.accessToken}),this.factory.createTileLayer(this.callbacks)}),describe("when valid URL and access token",function(){beforeEach(function(){c.ajax.calls.argsFor(0)[0].success({attribution:"attribution str",minzoom:2,maxzoom:4})}),it("should call the success callback",function(){expect(this.successSpy).toHaveBeenCalled()}),it("should have an expected urlTemplate value on the returned layer",function(){expect(this.successSpy).toHaveBeenCalledWith(jasmine.any(Object));var a="https://a.tiles.mapbox.com/v4/"+this.mapboxID+"/{z}/{x}/{y}.png?access_token="+this.accessToken;expect(this.successSpy.calls.argsFor(0)[0].get("urlTemplate")).toEqual(a)}),it("should also set expected metadata",function(){var a=this.successSpy.calls.argsFor(0)[0];expect(a.get("attribution")).toEqual("attribution str"),expect(a.get("minZoom")).toEqual(2),expect(a.get("maxZoom")).toEqual(4)})}),describe("when fails to validate URL or access token",function(){beforeEach(function(){c.ajax.calls.argsFor(0)[0].error()}),it("should call error callback with error message",function(){expect(this.errorSpy).toHaveBeenCalled(),expect(this.errorSpy).toHaveBeenCalledWith(jasmine.any(String))})})}),describe("when provided an embed URL",function(){beforeEach(function(){this.mapboxID="cartodb.map-eeoepub0",this.accessToken="ACCESS_TOKEN",this.factory.set({url:"http://a.tiles.mapbox.com/v4/"+this.mapboxID+"/page.html",accessToken:this.accessToken}),this.factory.createTileLayer(this.callbacks)}),describe("when valid URL and access token",function(){beforeEach(function(){c.ajax.calls.argsFor(0)[0].success({attribution:"attribution str",minzoom:2,maxzoom:4})}),it("should call the success callback",function(){expect(this.successSpy).toHaveBeenCalled()}),it("should have an expected urlTemplate value on the returned layer",function(){expect(this.successSpy).toHaveBeenCalledWith(jasmine.any(Object));var a="https://a.tiles.mapbox.com/v4/"+this.mapboxID+"/{z}/{x}/{y}.png?access_token="+this.accessToken;expect(this.successSpy.calls.argsFor(0)[0].get("urlTemplate")).toEqual(a)}),it("should also set expected metadata",function(){var a=this.successSpy.calls.argsFor(0)[0];expect(a.get("attribution")).toEqual("attribution str"),expect(a.get("minZoom")).toEqual(2),expect(a.get("maxZoom")).toEqual(4)})}),describe("when fails to validate URL or access token",function(){beforeEach(function(){c.ajax.calls.argsFor(0)[0].error()}),it("should call error callback with error message",function(){expect(this.errorSpy).toHaveBeenCalled(),expect(this.errorSpy).toHaveBeenCalledWith(jasmine.any(String))})})}),describe("when provided a XYZ URL",function(){beforeEach(function(){this.mapboxID="cartodb.map-eeoepub0",this.accessToken="ACCESS_TOKEN";var a=this;this.img={},spyOn(window,"Image").and.callFake(function(){return a.img}),this.factory.set({url:"https://a.tiles.mapbox.com/v4/"+this.mapboxID+"/{z}/{y}/{x}.png",accessToken:this.accessToken}),this.factory.createTileLayer(this.callbacks)}),describe("when valid URL, access token and tiles",function(){beforeEach(function(){this.img.onload()}),it("should call the success callback",function(){expect(this.successSpy).toHaveBeenCalled()}),it("should have an expected urlTemplate value on the returned layer",function(){expect(this.successSpy).toHaveBeenCalledWith(jasmine.any(Object));var a="https://a.tiles.mapbox.com/v4/"+this.mapboxID+"/{z}/{y}/{x}.png";expect(this.successSpy.calls.argsFor(0)[0].get("urlTemplate")).toEqual(a)}),it("should also set expected metadata",function(){var a=this.successSpy.calls.argsFor(0)[0];expect(a.get("attribution")).toBeNull(),expect(a.get("minZoom")).toEqual(0),expect(a.get("maxZoom")).toEqual(21)})}),describe("when fails to validate URL or access token",function(){beforeEach(function(){this.img.onerror()}),it("should call error callback with error message",function(){expect(this.errorSpy).toHaveBeenCalled(),expect(this.errorSpy).toHaveBeenCalledWith(jasmine.any(String))})})})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/mapbox/mapbox_to_tile_layer_factory":32}],350:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/mapbox/mapbox_model.js"),e=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/mapbox/mapbox_to_tile_layer_factory");describe("common/dialog/add_custom_basemap/mapbox/mapbox_view",function(){beforeEach(function(){this.baseLayers=new c.admin.UserLayers,this.model=new d,this.view=this.model.createView(),this.view.render()}),it("should render the inputs",function(){expect(this.view.$("input").length).toEqual(2)}),describe("when click save",function(){beforeEach(function(){spyOn(e.prototype,"createTileLayer"),spyOn(this.model,"save").and.callThrough(),this.view.$(".js-url").val("mapbox/URL"),this.view.$(".js-access-token").val("abc123"),this.view.$(".js-ok").click()}),it("should call save on model with current values",function(){expect(this.model.save).toHaveBeenCalled(),expect(this.model.save).toHaveBeenCalledWith("mapbox/URL","abc123")}),it("should show the loading message",function(){expect(this.innerHTML()).toContain("Validating"),expect(this.view.$("input").length).toEqual(0)}),describe("when layer is created",function(){beforeEach(function(){this.saveBasemapSpy=jasmine.createSpy("saveBasemap"),this.model.bind("saveBasemap",this.saveBasemapSpy),this.tileLayer=jasmine.createSpy("cdb.admin.TileLayer"),e.prototype.createTileLayer.calls.argsFor(0)[0].success(this.tileLayer)}),it("should set the layer on the model",function(){expect(this.model.get("layer")).toBe(this.tileLayer)}),it("should trigger saveBasemap event",function(){expect(this.saveBasemapSpy).toHaveBeenCalled()})}),describe("when layer fails to be created",function(){beforeEach(function(){e.prototype.createTileLayer.calls.argsFor(0)[0].error("something failed")}),it("should show the start view again",function(){expect(this.view.$("input").length).toEqual(2)})})}),it("should not have any leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/mapbox/mapbox_model.js":31,"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/mapbox/mapbox_to_tile_layer_factory":32}],351:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/nasa/nasa_model.js");describe("common/dialog/add_custom_basemap/nasa/nasa_model",function(){beforeEach(function(){this.baseLayers=new c.admin.UserLayers,this.model=new d({baseLayers:this.baseLayers})}),describe("when model changes",function(){beforeEach(function(){this.model.set({date:"2015-05-25",layerType:"night"})}),it("should set layer",function(){expect(this.model.get("layer")).toEqual(jasmine.any(Object))}),it("should set layer with expected params",function(){var a=this.model.get("layer");expect(a.get("urlTemplate")).toMatch("/2015-05-25/.*{x}"),expect(a.get("attribution")).toEqual(jasmine.any(String)),expect(a.get("maxZoom")).toEqual(jasmine.any(Number)),expect(a.get("minZoom")).toEqual(jasmine.any(Number)),expect(a.get("name")).toMatch(".* 2015-05-25")})}),describe(".hasAlreadyAddedLayer",function(){beforeEach(function(){this.baseLayers=new c.admin.UserLayers}),it("should return true if current layer is already added",function(){this.model.set("layer",new c.admin.TileLayer({urlTemplate:"http://map1.vis.earthdata.nasa.gov/wmts-webmerc/VIIRS_CityLights_2012/default/2015-05-25/GoogleMapsCompatible_Level8/{z}/{y}/{x}.jpeg"})),expect(this.model.hasAlreadyAddedLayer(this.baseLayers)).toBeFalsy(),this.baseLayers.add(this.model.get("layer")),expect(this.model.hasAlreadyAddedLayer(this.baseLayers)).toBeTruthy()})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/nasa/nasa_model.js":34}],352:[function(a,b,c){(function(b){var c=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/nasa/nasa_model.js"),d="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null;describe("common/dialog/add_custom_basemap/nasa/nasa_view",function(){beforeEach(function(){jasmine.clock().install(),this.baseLayers=new cdb.admin.UserLayers,this.model=new c({baseLayers:this.baseLayers}),this.view=this.model.createView(),this.view.render(),d(document.body).append(this.view.el),jasmine.clock().tick(150)}),it("should render day option as pre-selected",function(){expect(this.view.$(".js-day .RadioButton-input").hasClass("is-checked")).toBeTruthy()}),it("should show date picker",function(){expect(this.view.$(".DatePicker").length).toBe(1)}),it("should render date of yesterday as start date",function(){expect(this.innerHTML()).toMatch(/\d{4}-\d{2}-\d{2}/)}),describe("when changing from day to night",function(){beforeEach(function(){this.view.$(".js-night").click()}),it("should disable date picker",function(){expect(this.view.$(".DatePicker .DatePicker-dates").hasClass("is-disabled")).toBeTruthy()}),describe("when changing back to day",function(){beforeEach(function(){this.view.$(".js-day").click()}),it("should enable date picker again",function(){expect(this.view.$(".DatePicker .DatePicker-dates").hasClass("is-disabled")).toBeFalsy()})})}),it("should not have any leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean(),jasmine.clock().uninstall()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/nasa/nasa_model.js":34}],353:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/tile_json/tile_json_view_model.js");describe("common/dialog/add_custom_basemap/tile_json/tile_json_view",function(){beforeEach(function(){this.baseLayers=new c.admin.UserLayers,this.model=new d({baseLayers:this.baseLayers}),this.view=this.model.createView(),this.view.render()}),it("should render the set button as disabled initially",function(){expect(this.view.$(".ok").attr("class")).toContain("is-disabled")}),describe("when user written a URL",function(){beforeEach(function(){jasmine.clock().install(),spyOn(c.admin.TileJSON.prototype,"fetch")}),describe("when URL is half-done",function(){beforeEach(function(){var a=this.view.$(".js-url");a.val("ht"),a.trigger("keydown"),a.val("htt"),a.trigger("keydown"),jasmine.clock().tick(200)}),it("should indicate that it is validating URL",function(){expect(this.innerHTML()).toMatch("js-validating.*display: inline")}),describe("when triggers error",function(){beforeEach(function(){c.admin.TileJSON.prototype.fetch.calls.argsFor(0)[0].error()}),it("should show error",function(){expect(this.view.$(".js-error").attr("class")).toContain("is-visible"),expect(this.innerHTML()).toContain("Invalid URL")}),it("should not indicate validating anymore",function(){expect(this.innerHTML()).not.toMatch("js-validating.*display: inline")}),it("should disable OK button",function(){expect(this.view.$(".ok").attr("class")).toContain("is-disabled")})}),describe("when finally written/pasted a valid URL",function(){beforeEach(function(){this.tileLayer=jasmine.createSpy("cdb.admin.TileLayer"),spyOn(c.admin.TileJSON.prototype,"newTileLayer").and.returnValue(this.tileLayer),jasmine.clock().tick(200),c.admin.TileJSON.prototype.fetch.calls.argsFor(0)[0].success()}),it("should create layer with url",function(){expect(this.model.get("layer")).toBe(this.tileLayer)}),it("should enable save button",function(){expect(this.view.$(".ok").attr("class")).not.toContain("is-disabled")}),it("should hide error",function(){expect(this.view.$(".js-error").attr("class")).not.toContain("is-visible")})})}),afterEach(function(){jasmine.clock().uninstall()})}),it("should not have any leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/tile_json/tile_json_view_model.js":38}],354:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/tile_json/tile_json_view_model.js");describe("common/dialog/add_custom_basemap/tile_json/tile_json_view_model",function(){beforeEach(function(){this.model=new d({})}),describe(".hasAlreadyAddedLayer",function(){beforeEach(function(){this.baseLayers=new c.admin.UserLayers,this.baseLayers.add({kind:"tiled",urlTemplate:'"http://a.tiles.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=B4mp4daM",'})}),it("should return true if layer has already been added",function(){this.model.set("layer",new c.admin.TileLayer({})),expect(this.model.hasAlreadyAddedLayer(this.baseLayers)).toBeFalsy(),this.model.set("layer",this.baseLayers.at(0)),expect(this.model.hasAlreadyAddedLayer(this.baseLayers)).toBeTruthy()})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/tile_json/tile_json_view_model.js":38}],355:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/wms/layers_collection.js");describe("common/dialog/add_custom_basemap/wms/layer_model",function(){beforeEach(function(){this.layers=new d,this.layers.url="WMS URL",this.llbbox=[86.85898,27.92944,86.991206,28.044717],this.layers.reset([{llbbox:this.llbbox,matrix_sets:["GoogleMapsCompatible"],name:"everest",title:"Everest_04262015_R2C2_Fotor",srs:"srs val",layer:"layer val"}]),this.model=this.layers.at(0)}),it("should have idle state by default",function(){expect(this.model.get("state")).toEqual("idle")}),describe(".save",function(){beforeEach(function(){this.statsSpy=jasmine.createSpy("stats"),c.god.bind("metrics",this.statsSpy),this.wms=new c.admin.WMSService,spyOn(this.wms,"save");var a=this;spyOn(c.admin,"WMSService").and.callFake(function(){return a.wms})}),describe("when is a WMS resource",function(){beforeEach(function(){this.model.save()}),it("should change state to saving",function(){expect(this.model.get("state")).toEqual("saving")}),it("should create a WMS Service model w/ URL defined on layers collection the model belongs to",function(){expect(c.admin.WMSService.calls.argsFor(0)[0].wms_url).toEqual("WMS URL")}),it("should create a WMS Service model from given this models attributes",function(){var a=c.admin.WMSService.calls.argsFor(0)[0];expect(a).toEqual(jasmine.objectContaining({title:"Everest_04262015_R2C2_Fotor"})),expect(a).toEqual(jasmine.objectContaining({name:"everest"})),expect(a).toEqual(jasmine.objectContaining({layer:"everest"})),expect(a).toEqual(jasmine.objectContaining({srs:"srs val"})),expect(a).toEqual(jasmine.objectContaining({bounding_boxes:this.llbbox}))}),it("should trigger stats",function(){expect(this.statsSpy).toHaveBeenCalled(),expect(this.statsSpy.calls.argsFor(0)[0]).toEqual("select_wms")}),it("should save the WMS model",function(){expect(this.wms.save).toHaveBeenCalled()}),describe("when save succeeds",function(){beforeEach(function(){this.newModel=new c.admin.WMSService}),describe("when can create tilelayer",function(){beforeEach(function(){this.tileLayer=jasmine.createSpy("tilelayer"),spyOn(this.newModel,"newTileLayer").and.returnValue(this.tileLayer),this.wms.save.calls.argsFor(0)[1].success(this.newModel)}),it("should create a new tile layer",function(){expect(this.model.get("tileLayer")).toBe(this.tileLayer)}),it("should set state to saveDone",function(){expect(this.model.get("state")).toEqual("saveDone")})}),describe("when could not create tilelayer",function(){beforeEach(function(){spyOn(this.newModel,"newTileLayer").and.throwError("meh"),this.wms.save.calls.argsFor(0)[1].success(this.newModel)}),it("should not have any tilelayer set",function(){expect(this.model.get("tileLayer")).toBeUndefined()}),it("should set state to saveDone",function(){expect(this.model.get("state")).toEqual("saveFail")})})}),describe("when save fails",function(){beforeEach(function(){this.wms.save.calls.argsFor(0)[1].error()}),it("should set state to saveFail",function(){expect(this.model.get("state")).toEqual("saveFail")})})}),describe("when is a WMTS resource with unsupported matrix set (e.g. GoogleMapsCompatible)",function(){beforeEach(function(){this.model.set({type:"wmts",url_template:"http://foo.com/bar/%%(z)s/%%(x)s/%%(y)s.png",matrix_sets:["GoogleMapsCompatible"]}),spyOn(c.admin.TileLayer,"byCustomURL").and.callThrough(),this.model.save()}),it("should create the tile layer with a proper XYZ URL",function(){expect(c.admin.TileLayer.byCustomURL).toHaveBeenCalled(),expect(c.admin.TileLayer.byCustomURL.calls.argsFor(0)[0]).toEqual("http://foo.com/bar/{z}/{x}/{y}.png")}),it("should return a tile layer directly instead",function(){expect(this.model.get("tileLayer")instanceof c.admin.TileLayer).toBeTruthy()}),it("should set saveDone",function(){expect(this.model.get("state")).toEqual("saveDone")})})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/wms/layers_collection.js":41}],356:[function(a,b,c){var d=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/wms/layer_view.js"),e=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/wms/layer_model.js");describe("common/dialog/add_custom_basemap/wms/layer_view",function(){beforeEach(function(){this.model=new e({}),this.baseLayers=new cdb.admin.UserLayers,this.view=new d({model:this.model,baseLayers:this.baseLayers}),this.view.render()}),it("should render item title or name",function(){this.model.set("name","Roads"),this.view.render(),expect(this.innerHTML()).toContain("Roads"),this.model.set("title","Title has prio"),this.view.render(),expect(this.innerHTML()).toContain("Title has prio")}),it("should not disable any item by default",function(){expect(this.innerHTML).not.toContain("is-disabled")}),describe("when can not save layer",function(){beforeEach(function(){this.model.set("title","Test"),this.baseLayers.add({kind:"wms",name:"Test"}),this.view.render()}),it("should disable item",function(){expect(this.innerHTML()).toContain("is-disabled")})}),describe("when clicking add this",function(){beforeEach(function(){spyOn(this.model,"save"),spyOn(this.model,"canSave")}),it("should call save on model only if can save",function(){this.model.canSave.and.returnValue(!1),this.view.$(".js-add").click(),expect(this.model.save).not.toHaveBeenCalled(),this.model.canSave.and.returnValue(!0),this.view.$(".js-add").click(),expect(this.model.save).toHaveBeenCalled()})}),it("should not have any leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})},{"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/wms/layer_model.js":39,"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/wms/layer_view.js":40}],357:[function(a,b,c){var d=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/wms/layers_collection.js");describe("common/dialog/add_custom_basemap/wms/layers_collection",function(){beforeEach(function(){this.layers=new d}),describe(".fetch",function(){beforeEach(function(){this.url="http://openlayers.org/en/v3.5.0/examples/data/ogcsample.xml",this.callbackSpy=jasmine.createSpy(),this.wmsService=new cdb.admin.WMSService,this.deferred=$.Deferred(),spyOn(this.wmsService,"fetch").and.returnValue(this.deferred);var a=this;spyOn(cdb.admin,"WMSService").and.callFake(function(){return a.wmsService}),this.layers.fetch(this.url,this.callbackSpy)}),it("should fetch layers from given URL",function(){expect(cdb.admin.WMSService.calls.argsFor(0)[0]).toEqual(jasmine.objectContaining({wms_url:this.url})),expect(this.wmsService.fetch).toHaveBeenCalled()}),it("should not call callback just yet",function(){expect(this.callbackSpy).not.toHaveBeenCalled()}),describe("when layers are fetched",function(){beforeEach(function(){this.wmsService.set("layers",[{},{},{}]),this.deferred.resolve()}),it("should set layers on collection",function(){expect(this.layers.length).toEqual(3)}),it("should call given callback",function(){expect(this.callbackSpy).toHaveBeenCalled()})})})})},{"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/wms/layers_collection.js":41}],358:[function(a,b,c){var d=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/wms/select_layer_view.js"),e=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/wms/wms_model.js");describe("common/dialog/add_custom_basemap/wms/select_layer_view",function(){beforeEach(function(){this.baseLayers=new cdb.admin.UserLayers([{kind:"wms",name:"item #3"}]),this.model=new e({baseLayers:this.baseLayers}),this.view=new d({model:this.model}),this.view.render()}),describe("when there are a bunch of layers and some unavailable ones",function(){beforeEach(function(){this.model.get("layers").reset([{title:"item #1"},{title:"item #2"},{title:"item #3"},{title:"item #4"}]),this.view.render()}),it("should render the amount of layers",function(){expect(this.innerHTML()).toContain("4 layers found"),expect(this.innerHTML()).toContain("3 layers available")}),it("should render the individual items",function(){expect(this.innerHTML()).toContain("item #1"),expect(this.innerHTML()).toContain("item #4")}),it("should not have any leaks",function(){expect(this.view).toHaveNoLeaks()})}),describe("when click back",function(){beforeEach(function(){this.view.$(".js-back").click()}),it("should set current view to go back to enter URL",function(){expect(this.model.get("currentView")).toEqual("enterURL")})}),afterEach(function(){this.view.clean()})})},{"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/wms/select_layer_view.js":42,"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/wms/wms_model.js":43}],359:[function(a,b,c){var d=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/wms/wms_model.js");describe("common/dialog/add_custom_basemap/wms/wms_model",function(){beforeEach(function(){this.model=new d({})}),it("should not have any layers initially",function(){expect(this.model.get("layers").length).toEqual(0)}),it("should have enter URl as initial view",function(){expect(this.model.get("currentView")).toEqual("enterURL")}),describe(".fetchLayers",function(){beforeEach(function(){this.url="http://openlayers.org/en/v3.5.0/examples/data/ogcsample.xml",spyOn(this.model.get("layers"),"fetch"),this.model.fetchLayers(this.url)}),it("should fetch layers from given URL",function(){expect(this.model.get("layers").fetch).toHaveBeenCalled(),expect(this.model.get("layers").fetch.calls.argsFor(0)[0]).toEqual(this.url),expect(this.model.get("layers").fetch.calls.argsFor(0)[1]).toEqual(jasmine.any(Function))}),it("should change view to indicate that layers are being fetched",function(){expect(this.model.get("currentView")).toEqual("fetchingLayers")}),describe("when fetch is done",function(){describe("when there are layers",function(){beforeEach(function(){this.model.get("layers").add({}),this.model.get("layers").fetch.calls.argsFor(0)[1]()}),it("should change view to select layer",function(){expect(this.model.get("currentView")).toEqual("selectLayer")})}),describe("when there are no layer",function(){beforeEach(function(){this.model.get("layers").fetch.calls.argsFor(0)[1]()}),it("should change view back to enter URL",function(){expect(this.model.get("currentView")).toEqual("enterURL")}),it("should indicate that layers were fetched",function(){expect(this.model.get("layersFetched")).toBeTruthy()})})})}),describe("when a layer changes state",function(){beforeEach(function(){this.saveBasemapSpy=jasmine.createSpy("saveBasemap"),this.model.bind("saveBasemap",this.saveBasemapSpy),this.model.get("layers").reset([{},{},{}])}),it("should set the current view appropriately",function(){this.model.get("layers").at(1).set("state","saving"),expect(this.model.get("currentView")).toEqual("savingLayer"),this.model.get("layers").at(1).set("state","saveFail"),expect(this.model.get("currentView")).toEqual("saveFail")}),it("should select layer if state is done",function(){this.tileLayer={},this.model.get("layers").at(1).set({state:"saveDone",tileLayer:this.tileLayer}),expect(this.saveBasemapSpy).toHaveBeenCalled(),expect(this.model.get("layer")).toBe(this.tileLayer)})})})},{"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/wms/wms_model.js":43}],360:[function(a,b,c){var d=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/wms/wms_model.js");describe("common/dialog/add_custom_basemap/wms/wms_view",function(){beforeEach(function(){this.baseLayers=new cdb.admin.UserLayers,this.model=new d({baseLayers:this.baseLayers}),this.view=this.model.createView(),this.view.render()}),it("should render the set button as disabled initially",function(){expect(this.view.$(".js-fetch-layers").attr("class")).toContain("is-disabled")}),describe("when user written a URL",function(){beforeEach(function(){jasmine.clock().install();var a=this.view.$(".js-url");a.val("http://openlayers.org/en/v3.5.0/examples/data/ogcsample.xml"),a.trigger("keydown"),jasmine.clock().tick(200)}),it("should enable get-layers button",function(){expect(this.view.$(".js-fetch-layers").attr("class")).not.toContain("is-disabled")}),describe("when click fetch layers",function(){beforeEach(function(){spyOn(this.model.get("layers"),"fetch"),spyOn(this.model,"fetchLayers").and.callThrough(),this.view.$(".js-fetch-layers").click()}),it("should show fetching layers",function(){expect(this.innerHTML()).toContain("Fetching")}),it("should call fetch layers on view model",function(){expect(this.model.fetchLayers).toHaveBeenCalled()}),describe("when there is at least one layer fetched",function(){beforeEach(function(){this.model.get("layers").add({name:""}),this.model.get("layers").fetch.calls.argsFor(0)[1]()}),it("should change to select layer view",function(){expect(this.innerHTML()).toContain("found")}),it("should show the search form",function(){expect(this.innerHTML()).toContain("Search")})}),describe("when there are several layers fetched",function(){beforeEach(function(){this.model.get("layers").add([{name:"Bageshwar"},{name:"Bagaha"},{name:"Bahadurgarh"},{name:"baharampur"},{name:"Bahraich"},{name:"Chirmiri"}]),this.model.get("layers").fetch.calls.argsFor(0)[1](),this.model.set("layersFetched",!0)}),it("should allow to search",function(){this.view.$el.find(".js-search-input").val("Bah"),this.view.$el.find(".js-search-link").click(),expect(this.innerHTML()).toContain("Bahraich"),expect(this.innerHTML()).toContain("Bahadurgarh"),expect(this.innerHTML()).toContain("baharampur"),expect(this.innerHTML()).not.toContain("Chirmiri")}),it("should show a no result search",function(){this.view.$el.find(".js-search-input").val("León"),this.view.$el.find(".js-search-link").click(),expect(this.innerHTML()).toContain("Unfortunately we couldn't found any layer that matched your search term")}),it("should close the search",function(){this.view.$el.find(".js-search-input").val("Bah"),this.view.$el.find(".js-search-link").click(),this.view.$el.find(".js-clean-search").click(),expect(this.view.$el.find(".js-search-input").val()).toBeFalsy(),expect(this.innerHTML()).toContain("Bageshwar"),expect(this.innerHTML()).toContain("Bagaha"),expect(this.innerHTML()).toContain("Bahraich"),expect(this.innerHTML()).toContain("Bahadurgarh"),expect(this.innerHTML()).toContain("baharampur"),expect(this.innerHTML()).toContain("Chirmiri")})}),describe("when there are no layers fetched",function(){beforeEach(function(){this.model.get("layers").reset(),this.model.get("layers").fetch.calls.argsFor(0)[1](),this.model.set("layersFetched",!0)}),it("should set back to enter url view",function(){expect(this.innerHTML()).toContain("Insert your")}),it("should show an error indicating URL being invalid",function(){expect(this.innerHTML()).toContain("unsupported projections")}),it("shouldn't show the search form",function(){expect(this.innerHTML()).not.toContain("Search")})}),describe("when layer is added",function(){beforeEach(function(){this.model.set("currentView","savingLayer")}),it("should show saving layer indicator",function(){expect(this.innerHTML()).toContain("Saving layer…")}),describe("when layer is not saved",function(){beforeEach(function(){this.model.set("currentView","saveFail")}),it("should show error view",function(){expect(this.innerHTML()).toContain("error")})})})}),afterEach(function(){jasmine.clock().uninstall()})}),it("should not have any leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})},{"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/wms/wms_model.js":43}],361:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/xyz/xyz_model.js");describe("common/dialog/add_custom_basemap/xyz/xyz_model",function(){beforeEach(function(){this.model=new d({})}),describe(".hasAlreadyAddedLayer",function(){beforeEach(function(){this.baseLayers=new c.admin.UserLayers,this.baseLayers.add({kind:"tiled",urlTemplate:"http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png"})}),it("should return true if layer has already been added",function(){this.model.set("layer",new c.admin.TileLayer({})),expect(this.model.hasAlreadyAddedLayer(this.baseLayers)).toBeFalsy(),this.model.set("layer",this.baseLayers.at(0)),expect(this.model.hasAlreadyAddedLayer(this.baseLayers)).toBeTruthy()})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/xyz/xyz_model.js":45}],362:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/xyz/xyz_view.js"),e=a("../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/xyz/xyz_model.js");
describe("common/dialog/add_custom_basemap/xyz/xyz_view",function(){beforeEach(function(){this.baseLayers=new c.admin.UserLayers,this.model=new e({baseLayers:this.baseLayers}),this.view=new d({model:this.model}),this.view.render()}),it("should render the set button as disabled initially",function(){expect(this.view.$(".ok").attr("class")).toContain("is-disabled")}),it("should change TMS checkbox when model changes",function(){expect(this.view.$(".js-tms .Checkbox-input").hasClass("is-checked")).toBeFalsy(),this.view.model.set("tms",!0),expect(this.view.$(".js-tms .Checkbox-input").hasClass("is-checked")).toBeTruthy()}),describe("when user written a URL",function(){beforeEach(function(){jasmine.clock().install()}),describe("when URL is half-done or invalid",function(){beforeEach(function(){var a=this.view.$(".js-url");a.val("ht"),a.trigger("keydown"),a.val("htt"),a.trigger("keydown"),jasmine.clock().tick(200)}),it("should show error",function(){expect(this.view.$(".js-error").attr("class")).toContain("is-visible"),expect(this.innerHTML()).toContain("does not look like a valid XYZ URL")}),it("should disable OK button",function(){expect(this.view.$(".ok").attr("class")).toContain("is-disabled")})}),describe("when finally written/pasted a valid URL",function(){beforeEach(function(){this.layer=new c.admin.TileLayer,spyOn(this.layer,"validateTemplateURL")}),describe("when URL does not have a valid XYZ format",function(){beforeEach(function(){spyOn(c.admin.TileLayer,"byCustomURL").and.throwError(),this.view.$(".js-url").val("http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png").trigger("keydown")}),it("should show error",function(){jasmine.clock().tick(200),expect(this.innerHTML()).toContain("not look like a valid XYZ")})}),describe("when URL has a valid XYZ format",function(){beforeEach(function(){spyOn(c.admin.TileLayer,"byCustomURL").and.returnValue(this.layer),this.view.$(".js-url").val("http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png").trigger("keydown")}),it("should create layer with url",function(){expect(c.admin.TileLayer.byCustomURL).not.toHaveBeenCalled(),jasmine.clock().tick(200),expect(c.admin.TileLayer.byCustomURL).toHaveBeenCalled(),expect(c.admin.TileLayer.byCustomURL).toHaveBeenCalledWith("http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png",!1)}),it("should set the layer on the view model",function(){expect(this.model.get("layer")).toBeUndefined(),jasmine.clock().tick(200),expect(this.model.get("layer")).toBe(this.layer)}),it("should disable the save button",function(){jasmine.clock().tick(200),expect(this.view.$(".ok").attr("class")).toContain("is-disabled")}),it("should hide error",function(){jasmine.clock().tick(200),expect(this.view.$(".js-error").attr("class")).not.toContain("is-visible")}),it("should validate template URL",function(){expect(this.layer.validateTemplateURL).not.toHaveBeenCalled(),jasmine.clock().tick(200),expect(this.layer.validateTemplateURL).toHaveBeenCalled(),expect(this.layer.validateTemplateURL).toHaveBeenCalledWith({success:jasmine.any(Function),error:jasmine.any(Function)})}),describe("when URL is finally validated",function(){beforeEach(function(){jasmine.clock().tick(200),this.layer.validateTemplateURL.calls.argsFor(0)[0].success()}),it("should enable save button",function(){expect(this.view.$(".ok").attr("class")).not.toContain("is-disabled")}),it("should hide error",function(){expect(this.view.$(".js-error").attr("class")).not.toContain("is-visible")})}),describe("when URL fails to be validated",function(){beforeEach(function(){jasmine.clock().tick(200),this.layer.validateTemplateURL.calls.argsFor(0)[0].error()}),it("should enable save button",function(){expect(this.view.$(".ok").attr("class")).not.toContain("is-disabled")}),it("should show error",function(){expect(this.view.$(".js-error").attr("class")).toContain("is-visible"),expect(this.innerHTML()).toContain("couldn't validate this")})})})}),afterEach(function(){jasmine.clock().uninstall()})}),it("should not have any leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/xyz/xyz_model.js":45,"../../../../../../../javascripts/cartodb/common/dialogs/add_custom_basemap/xyz/xyz_view.js":46}],363:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,e=a("../../../../../../javascripts/cartodb/common/dialogs/add_group_users/add_group_users_view");describe("common/dialogs/add_group_users/add_group_users_view",function(){beforeEach(function(){this.user=new d.admin.User({id:123,base_url:"https://carto.com/user/paco",username:"paco",organization:{id:"o1",owner:{id:123}}}),this.orgUsers=this.user.organization.users,spyOn(this.orgUsers,"excludeCurrentUser").and.callThrough(),spyOn(this.orgUsers,"fetch").and.callThrough(),this.orgUsers.sync=function(a,b,c){c.success&&c.success({users:[{id:"abc-123",username:"paco"},{id:"abc-456",username:"pepe"}],total_entries:2,total_user_entries:2})},this.group=new d.admin.Group({id:"g1",organization:this.user.organization,users:[{id:"u1",username:"pachi"}]}),this.view=new e({group:this.group,orgUsers:this.orgUsers}),this.view.render()}),afterEach(function(){this.view.clean()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should include current user",function(){expect(this.orgUsers.excludeCurrentUser).toHaveBeenCalledWith(!1)}),describe("when view is cleaned",function(){beforeEach(function(){spyOn(this.orgUsers,"restoreExcludeCurrentUser").and.callThrough(),spyOn(this.view,"elder"),this.view.clean()}),it("should restore orgUsers",function(){expect(this.orgUsers.restoreExcludeCurrentUser).toHaveBeenCalled()}),it("should call parent clean",function(){expect(this.view.elder).toHaveBeenCalledWith("clean")})}),it("should fetch org users",function(){expect(this.orgUsers.fetch).toHaveBeenCalled()}),it("should render the users",function(){expect(this.innerHTML()).toContain("pepe"),expect(this.innerHTML()).toContain("paco")}),it("should disable ok btn",function(){expect(this.view.$(".ok").hasClass("is-disabled")).toBe(!0)}),describe("when at least 1 user is selected",function(){beforeEach(function(){this.view.$(".OrganizationList-userLink").click()}),it("should enable ok btn",function(){expect(this.view.$(".ok").hasClass("is-disabled")).toBe(!1)}),describe("when click ok",function(){beforeEach(function(){this.jqXHR=c.Deferred(),spyOn(this.group.users,"addInBatch").and.returnValue(this.jqXHR),this.view.$(".ok").click()}),it("should change state to adding users",function(){expect(this.innerHTML()).toContain("Adding")}),describe("when is saved",function(){beforeEach(function(){spyOn(this.view,"close"),this.jqXHR.resolve()}),it("should add users to group",function(){expect(this.group.users.length>0).toBe(!0)}),it("should close modal",function(){expect(this.view.close).toHaveBeenCalled()})}),describe("when fail",function(){beforeEach(function(){this.jqXHR.reject()}),it("should show generic error",function(){console.log(this.innerHTML()),expect(this.innerHTML()).toContain("error")})})})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/add_group_users/add_group_users_view":47}],364:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,e=a("../../../../../../javascripts/cartodb/common/dialogs/change_lock/change_lock_view_model"),f=a("../../../../../../javascripts/cartodb/common/dialogs/change_lock/change_lock_view"),g=function(a){beforeEach(function(){this.selectedItems=[new c.core.Model({name:"1st",locked:a.lockedInitially}),new c.core.Model({name:"2nd",locked:a.lockedInitially})],this.viewModel=new e({items:this.selectedItems,contentType:"datasets"}),this.view=new f({model:this.viewModel}),this.view.render()}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),it('should render a title with "'+a.lockOrUnlockStr+'" + count of items to delete',function(){expect(this.innerHTML()).toContain(a.lockOrUnlockStr.toLowerCase()+" 2 datasets")}),it("should render the lock description",function(){expect(this.innerHTML()).toContain(a.lockOrUnlockStr+"ing")}),it("should have a default template if none is given",function(){expect(this.view.options.template).toEqual(jasmine.any(Function))}),describe('when "OK, '+a.lockOrUnlockStr+'" button is clicked',function(){beforeEach(function(){spyOn(this.view,"close").and.callThrough(),this.selectedItems.forEach(function(a){var b=d.Deferred();spyOn(a,"save").and.returnValue(b.promise())}),this.view.$(".js-ok").click()}),it("should render processing message",function(){expect(this.innerHTML()).toContain(a.lockOrUnlockStr+"ing datasets")}),describe("when change finishes successfully",function(){beforeEach(function(){this.viewModel.set("state","ProcessItemsDone")}),it("should close the dialog",function(){expect(this.view.close).toHaveBeenCalled()})}),describe("when changing lock state fails",function(){beforeEach(function(){this.viewModel.set("state","ProcessItemsFail")}),it("should render error",function(){expect(this.view.close).not.toHaveBeenCalled()})})})};describe("common/dialogs/change_lock/change_lock_view",function(){describe("given a set of unlocked items",function(){g({lockedInitially:!1,lockOrUnlockStr:"Lock"}),it("should indicate that lock is a negative action in styles",function(){expect(this.innerHTML()).toContain("--alert"),expect(this.innerHTML()).not.toContain("--positive")})}),describe("given a set of locked items",function(){g({lockedInitially:!0,lockOrUnlockStr:"Unlock"}),it("should indicate that unlock is a positive action in styles",function(){expect(this.innerHTML()).toContain("--positive"),expect(this.innerHTML()).not.toContain("--alert")}),describe("when given the template for opening item on dashboard",function(){beforeEach(function(){this.view.clean(),this.view=new f({model:this.viewModel,isOwner:!0,ownerName:"cartodb",template:c.templates.getTemplate("common/dialogs/change_lock/templates/unlock_to_editor")}),this.view.render()}),it("should render fine",function(){expect(this.innerHTML()).toContain("is locked"),expect(this.innerHTML()).toContain("That means you need to unlock it")})}),describe("when given the template for opening item from other user on dashboard",function(){beforeEach(function(){this.view.clean(),this.view=new f({model:this.viewModel,isOwner:!1,ownerName:"cartodb",template:c.templates.getTemplate("common/dialogs/change_lock/templates/unlock_to_editor")}),this.view.render()}),it("should render fine",function(){expect(this.innerHTML()).toContain("was locked by cartodb"),expect(this.innerHTML()).toContain("That means you need to unlock it")})})}),afterEach(function(){this.view&&this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/change_lock/change_lock_view":49,"../../../../../../javascripts/cartodb/common/dialogs/change_lock/change_lock_view_model":50}],365:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,e=a("../../../../../../javascripts/cartodb/common/dialogs/change_lock/change_lock_view_model");describe("common/dialogs/change_lock/change_lock_view_model",function(){beforeEach(function(){this.models=[new c.core.Model({locked:!0}),new c.core.Model({locked:!0})],this.viewModel=new e({items:this.models})}),it("should throw error if given models have inconsistent locked values",function(){this.models[0].set("locked",!1),expect(function(){this.createViewModel()}).toThrowError()}),describe("state",function(){it("should have an initial value of confirm-change-lock",function(){expect(this.viewModel.get("state")).toEqual("ConfirmChangeLock")})}),describe("initialLockValue",function(){it("should return the lock value the models have initially",function(){expect(this.viewModel.get("initialLockValue")).toBeTruthy(),this.models[0].set("locked",!1),this.models[1].set("locked",!1),expect(this.viewModel.get("initialLockValue")).toBeTruthy()})}),describe(".inverseLock",function(){beforeEach(function(){this.modelDeferreds=[],this.models.forEach(function(a,b){var c=d.Deferred();spyOn(a,"save").and.returnValue(c.promise()),this.modelDeferreds[b]=c},this),this.changeCount=0,this.viewModel.bind("change",function(){this.changeCount++},this),this.viewModel.inverseLock()}),it("should change state to processing-items",function(){expect(this.viewModel.get("state")).toEqual("ProcessingItems")}),it("should call save on each item with the inverse lock value",function(){this.models.forEach(function(a){expect(a.save).toHaveBeenCalled(),expect(a.save.calls.argsFor(0)[0]).toEqual(jasmine.objectContaining({locked:!1}))},this)}),it("should trigger a change once",function(){expect(this.changeCount).toEqual(1)}),describe("when all items are finished",function(){beforeEach(function(){this.modelDeferreds.forEach(function(a){a.resolve()})}),it("should trigger a change event again",function(){expect(this.changeCount).toEqual(2)}),it("should change state to all done",function(){expect(this.viewModel.get("state")).toEqual("ProcessItemsDone")})}),describe("when an item fail",function(){beforeEach(function(){this.modelDeferreds[0].reject("oups")}),it("should trigger a change event again",function(){expect(this.changeCount).toEqual(2)}),it("should change state to all fail",function(){expect(this.viewModel.get("state")).toEqual("ProcessItemsFail")})})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/change_lock/change_lock_view_model":50}],366:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../javascripts/cartodb/common/dialogs/change_privacy/change_privacy_view"),e=a("../../../../../../javascripts/cartodb/common/dialogs/change_privacy/share/share_view");describe("dashboard/dialogs/change_privacy/change_privacy_view",function(){beforeEach(function(){this.vis=new c.admin.Visualization({type:"derived",privacy:"PUBLIC"}),this.user=new c.admin.User({username:"pepe",actions:{},organization:{users:[{username:"paco"},{username:"pito"}],id:"hello-org-id"}}),this.setupView=function(){this.view&&this.view.clean(),this.view=new d({vis:this.vis,user:this.user}),this.view.render()}}),describe("when can not share vis",function(){beforeEach(function(){this.user.organization=void 0,this.setupView()}),it("should not have any share view",function(){expect(this.innerHTML()).not.toContain("js-share")}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()})}),describe("when can share vis",function(){beforeEach(function(){this.setupView()}),it("should show share link",function(){expect(this.innerHTML()).toContain("js-share")}),describe("when click share",function(){beforeEach(function(){spyOn(this.view,"close");var a=this;spyOn(e.prototype,"appendToBody").and.callFake(function(){a.shareView=this}),this.view.$(".js-share").click()}),it("should opened the share view",function(){expect(e.prototype.appendToBody).toHaveBeenCalled()}),it("should close this view",function(){expect(this.view.close).toHaveBeenCalled()})}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()})}),describe("when click/enter to OK",function(){beforeEach(function(){this.setupView(),this.selectedOption=this.view._privacyOptions.selectedOption(),spyOn(this.selectedOption,"saveToVis"),this.view.$(".ok").click()}),it("should save privacy",function(){expect(this.selectedOption.saveToVis).toHaveBeenCalled(),expect(this.selectedOption.saveToVis.calls.argsFor(0)[0]).toEqual(this.vis)}),it("should render saving view",function(){expect(this.innerHTML()).toContain("Saving privacy…")}),describe("when save succeeds",function(){beforeEach(function(){spyOn(this.view,"close"),this.selectedOption.saveToVis.calls.argsFor(0)[1].success()}),it("should close view",function(){expect(this.view.close).toHaveBeenCalled()})}),describe("when save fails",function(){beforeEach(function(){this.selectedOption.saveToVis.calls.argsFor(0)[1].error()}),it("should show error",function(){expect(this.innerHTML()).toContain("error")})})}),afterEach(function(){this.view&&this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/change_privacy/change_privacy_view":51,"../../../../../../javascripts/cartodb/common/dialogs/change_privacy/share/share_view":60}],367:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/change_privacy/option_model"),e=a("./shared_for_option_model");describe("common/dialogs/change_privacy/option_model",function(){beforeEach(function(){this.model=new d({})}),e.call(this,{expectedSaveAttrs:{privacy:"new-privacy-value",password:void 0}}),describe(".canSave",function(){describe("given option is disabled",function(){beforeEach(function(){this.model.set("disabled",!0)}),it("should return false",function(){expect(this.model.canSave()).toBeFalsy()})}),describe("given option is enabled",function(){beforeEach(function(){this.model.set("disabled",!1)}),it("should return true",function(){expect(this.model.canSave()).toBeTruthy()})})}),describe(".saveToVis",function(){beforeEach(function(){this.vis=jasmine.createSpyObj("cdb.admin.Visualization",["save"]),this.model.set({privacy:"PASSWORD",password:"for this test"}),this.callbacks={success:function(){},error:function(){}},this.model.saveToVis(this.vis,this.callbacks)}),it("should call vis.save",function(){expect(this.vis.save).toHaveBeenCalled()}),it("should save with selected attrs",function(){expect(this.vis.save.calls.argsFor(0)[0]).toEqual({privacy:"PASSWORD",password:"for this test"})}),it("should wait with triggering err",function(){expect(this.vis.save.calls.argsFor(0)[1]).toEqual(jasmine.objectContaining({wait:!0}))}),it("should pass the callbacks to the save call",function(){expect(this.vis.save.calls.argsFor(0)[1]).toEqual(jasmine.objectContaining({success:this.callbacks.success})),expect(this.vis.save.calls.argsFor(0)[1]).toEqual(jasmine.objectContaining({error:this.callbacks.error}))})})})},{"../../../../../../javascripts/cartodb/common/dialogs/change_privacy/option_model":52,"./shared_for_option_model":375}],368:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../javascripts/cartodb/common/dialogs/change_privacy/options_collection");describe("common/dialogs/change_privacy/options_collection",function(){it("should only allow one selected item at a time",function(){this.vis=new c.admin.Visualization({type:"derived",privacy:"PUBLIC"}),this.user=new c.admin.User({actions:{private_tables:!0,private_maps:!0}}),this.privacyOptions=d.byVisAndUser(this.vis,this.user),this.privacyOptions.each(function(a){a.set("selected",!0)});var a=this.privacyOptions.where({selected:!0});expect(a.length).toEqual(1),expect(a[0]).toEqual(this.privacyOptions.last())}),describe(".byVisAndUser",function(){beforeEach(function(){this.vis=new c.admin.Visualization({type:"derived",privacy:"PUBLIC"}),this.user=new c.admin.User({actions:{private_tables:!0,private_maps:!1}}),this.createNewPrivacyOptions=function(){this.privacyOptions=d.byVisAndUser(this.vis,this.user)},this.firstItem=function(a){return this.privacyOptions.where(a)[0]}}),describe("given a visualization",function(){beforeEach(function(){this.vis.set("type","derived")}),describe("and a normal user",function(){beforeEach(function(){this.createNewPrivacyOptions.call(this)}),it("should return all privacy options",function(){expect(this.privacyOptions.length).toEqual(4)}),it("should only have the public option enabled",function(){expect(this.firstItem({privacy:"PUBLIC"}).get("disabled")).toBeFalsy(),expect(this.firstItem({privacy:"LINK"}).get("disabled")).toBeTruthy(),expect(this.firstItem({privacy:"PASSWORD"}).get("disabled")).toBeTruthy(),expect(this.firstItem({privacy:"PRIVATE"}).get("disabled")).toBeTruthy()})}),describe("and an user with private maps enabled",function(){beforeEach(function(){this.user.get("actions").private_maps=!0,this.createNewPrivacyOptions.call(this)}),it("should return all privacy options",function(){expect(this.privacyOptions.length).toEqual(4)}),it("should have all options enabled",function(){expect(this.firstItem({privacy:"PUBLIC"}).get("disabled")).toBeFalsy(),expect(this.firstItem({privacy:"LINK"}).get("disabled")).toBeFalsy(),expect(this.firstItem({privacy:"PASSWORD"}).get("disabled")).toBeFalsy(),expect(this.firstItem({privacy:"PRIVATE"}).get("disabled")).toBeFalsy()})})}),describe("given a table",function(){beforeEach(function(){this.vis.set("type","table")}),describe("and a user with private tables disabled",function(){beforeEach(function(){this.user.get("actions").private_tables=!1,this.createNewPrivacyOptions.call(this)}),it("should return all privacy options except for the password-protection",function(){expect(this.privacyOptions.length).toEqual(3),expect(this.privacyOptions.where({privacy:"PASSWORD"}).length).toEqual(0)}),it("should only have public option enabled",function(){expect(this.firstItem({privacy:"PUBLIC"}).get("disabled")).toBeFalsy(),expect(this.firstItem({privacy:"LINK"}).get("disabled")).toBeTruthy(),expect(this.firstItem({privacy:"PRIVATE"}).get("disabled")).toBeTruthy()})}),describe("and an user with private tables enabled",function(){beforeEach(function(){this.user.get("actions").private_tables=!0,this.createNewPrivacyOptions.call(this)}),it("should return all privacy options except for the password-protection",function(){expect(this.privacyOptions.length).toEqual(3),expect(this.privacyOptions.where({privacy:"PASSWORD"}).length).toEqual(0)}),it("should have all options enabled",function(){expect(this.firstItem({privacy:"PUBLIC"}).get("disabled")).toBeFalsy(),expect(this.firstItem({privacy:"LINK"}).get("disabled")).toBeFalsy(),expect(this.firstItem({privacy:"PRIVATE"}).get("disabled")).toBeFalsy()})})})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/change_privacy/options_collection":53}],369:[function(a,b,c){(function(b){var c=a("../../../../../../javascripts/cartodb/common/dialogs/change_privacy/password_option_model"),d=a("./shared_for_option_model"),e="undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null;describe("common/dialogs/change_privacy/password_option_model",function(){beforeEach(function(){this.model=new c,this.model.set("password","foobar")}),d.call(this,{expectedSaveAttrs:{privacy:"new-privacy-value",password:"foobar"}}),it("should have a fake password set initially",function(){this.model=new c,expect(this.model.get("password")).toEqual(c.DEFAULT_FAKE_PASSWORD)}),describe(".canSave",function(){describe("given option is enabled and has a password string set",function(){beforeEach(function(){this.model.set({disabled:!1,password:"f"})}),it("should return true",function(){expect(this.model.canSave()).toBeTruthy()})}),describe("given option is disabled or has no password set",function(){beforeEach(function(){this.model.set({disabled:!0,password:void 0})}),it("should return false",function(){expect(this.model.canSave()).toBeFalsy(),this.model.set({disabled:!1}),expect(this.model.canSave()).toBeFalsy(),this.model.set({disabled:!1,password:""}),expect(this.model.canSave()).toBeFalsy()})})}),describe(".saveToVis",function(){describe("given password has not changed",function(){beforeEach(function(){this.model=new c({}),this.vis=jasmine.createSpyObj("cdb.admin.Vis",["save"]),this.model.saveToVis(this.vis)}),it("should not send a password value on save",function(){var a=e.keys(this.vis.save.calls.argsFor(0)[0]);expect(a).not.toContain("password")})})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/change_privacy/password_option_model":54,"./shared_for_option_model":375}],370:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../../javascripts/cartodb/common/dialogs/change_privacy/share/grantables_view"),e=a("../../../../../../../javascripts/cartodb/common/dialogs/change_privacy/share/share_model"),f=a("../../../../../../../javascripts/cartodb/common/paged_search_model");describe("common/dialogs/change_privacy/share/grantables_view",function(){beforeEach(function(){this.user=new c.admin.User({id:"user-id",username:"pepe",actions:{},organization:{id:"org-id",users:[{id:"abc-123",username:"paco"},{id:"abc-456",username:"pepe"}]}}),this.grantables=this.user.organization.grantables,this.grantables.sync=function(a,b,c){c.success&&c.success({grantables:[{id:"abc-123",type:"user",model:{id:"abc-123",username:"paco"}},{id:"abc-566",type:"user",model:{id:"abc-456",username:"pepe"}},{id:"g1",type:"group",model:{id:"g1",display_name:"my group"}}],total_entries:2,total_user_entries:2})},this.grantables.fetch(),this.vis=new c.admin.Visualization({type:"derived",privacy:"PUBLIC"}),this.viewModel=new e({vis:this.vis,organization:this.user.organization}),this.pagedSearchModel=new f,this.view=new d({model:this.viewModel,collection:this.grantables,hasSearch:!1,pagedSearchModel:this.pagedSearchModel}),spyOn(this.view,"killEvent"),this.view.render()}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),describe("when has search applied",function(){beforeEach(function(){this.pagedSearchModel.set("q","foo")}),it("should not render the organization permission view",function(){expect(this.innerHTML()).not.toContain("Organization")})}),describe("given there is at least one dependant visualization",function(){beforeEach(function(){this.dependantUser={id:"abc-123"},spyOn(this.vis.tableMetadata(),"dependentVisualizations").and.returnValue([{permission:{owner:this.dependantUser}}])}),it("should render OK",function(){expect(this.view.render()).toBe(this.view)}),it("should render default settings for the organization",function(){expect(this.innerHTML()).toContain("Default settings for your Organization")}),it("should render users",function(){expect(this.innerHTML()).toContain("paco"),expect(this.innerHTML()).toContain("pepe")})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/change_privacy/share/grantables_view":55,"../../../../../../../javascripts/cartodb/common/dialogs/change_privacy/share/share_model":59,"../../../../../../../javascripts/cartodb/common/paged_search_model":227}],371:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null),d=a("../../../../../../../javascripts/cartodb/common/dialogs/change_privacy/share/permission_view");describe("common/dialogs/change_privacy/share/permission_view",function(){beforeEach(function(){this.model=new c.admin.User({id:"abc-123",username:"pepe",name:"Pepe paco",avatar_url:"http://host.ext/path/img.jpg"}),this.permission=new c.admin.Permission({}),spyOn(this.permission,"canChangeReadAccess").and.callThrough(),spyOn(this.permission,"canChangeWriteAccess").and.callThrough(),spyOn(this.permission,"hasReadAccess").and.callThrough(),spyOn(this.permission,"hasWriteAccess").and.callThrough(),spyOn(this.permission,"revokeAccess").and.callThrough(),spyOn(this.permission,"revokeWriteAccess").and.callThrough(),spyOn(this.permission,"grantReadAccess").and.callThrough(),spyOn(this.permission,"grantWriteAccess").and.callThrough(),this.detailsView=new c.core.View,this.detailsView.render=function(){return this.$el.html("**details**"),this},this.view=new d({model:this.model,permission:this.permission,detailsView:this.detailsView,isWriteAccessTogglerAvailable:!1}),this.view.render()}),it("should not have any leaks",function(){expect(this.view).toHaveNoLeaks()}),describe("when can change write access",function(){beforeEach(function(){this.view.options.isWriteAccessTogglerAvailable=!0,this.view.render()}),it("should not disable any toggler",function(){expect(this.innerHTML()).not.toContain("disabled")}),describe("when click write toggle",function(){beforeEach(function(){this.clickWriteToggler=function(){this.view.$(".js-input:first").change()}}),describe("when can not change write access",function(){beforeEach(function(){this.permission.canChangeWriteAccess.and.returnValue(!1),this.clickWriteToggler()}),it("should check if can change state",function(){expect(this.permission.canChangeWriteAccess).toHaveBeenCalled(),expect(this.permission.canChangeWriteAccess).toHaveBeenCalledWith(this.model)}),it("should not change any state though",function(){expect(this.permission.revokeWriteAccess).not.toHaveBeenCalled(),expect(this.permission.grantWriteAccess).not.toHaveBeenCalled()})}),describe("when can change write access",function(){beforeEach(function(){this.permission.canChangeWriteAccess.and.returnValue(!0),this.clickWriteToggler()}),it("should alternative between granting or revoking access for each click",function(){expect(this.permission.grantWriteAccess).toHaveBeenCalled(),expect(this.permission.grantWriteAccess).toHaveBeenCalledWith(this.model),this.clickWriteToggler(),expect(this.permission.revokeWriteAccess).toHaveBeenCalled(),expect(this.permission.revokeWriteAccess).toHaveBeenCalledWith(this.model),expect(this.permission.revokeWriteAccess.calls.count()).toEqual(1),this.clickWriteToggler(),expect(this.permission.grantWriteAccess.calls.count()).toEqual(2),expect(this.permission.revokeWriteAccess.calls.count()).toEqual(1)})})})}),describe("when write toggler is unavailable",function(){beforeEach(function(){this.view.options.isWriteAccessTogglerAvailable=!1,this.view.render()}),it("should not render write toggler",function(){expect(this.innerHTML()).not.toContain("Write"),expect(this.view.$(".js-input").length).toEqual(1)})}),describe("when can change read access",function(){it("should not disable any toggler",function(){expect(this.innerHTML()).not.toContain("disabled")}),describe("when click write toggle",function(){beforeEach(function(){this.clickReadToggler=function(){this.view.$(".js-input:last").change()}}),describe("when can not change read access",function(){beforeEach(function(){this.permission.canChangeReadAccess.and.returnValue(!1),this.clickReadToggler()}),it("should check if can change state",function(){expect(this.permission.canChangeReadAccess).toHaveBeenCalled(),expect(this.permission.canChangeReadAccess).toHaveBeenCalledWith(this.model)}),it("should not change any state though",function(){expect(this.permission.revokeAccess).not.toHaveBeenCalled(),expect(this.permission.grantReadAccess).not.toHaveBeenCalled()})}),describe("when can change read access",function(){beforeEach(function(){this.permission.canChangeReadAccess.and.returnValue(!0),this.clickReadToggler()}),it("should alternative between granting or revoking access for each click",function(){expect(this.permission.grantReadAccess).toHaveBeenCalled(),expect(this.permission.grantReadAccess).toHaveBeenCalledWith(this.model),this.clickReadToggler(),expect(this.permission.revokeAccess).toHaveBeenCalled(),expect(this.permission.revokeAccess).toHaveBeenCalledWith(this.model),
expect(this.permission.revokeAccess.calls.count()).toEqual(1),this.clickReadToggler(),expect(this.permission.grantReadAccess.calls.count()).toEqual(2),expect(this.permission.revokeAccess.calls.count()).toEqual(1)})})})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/change_privacy/share/permission_view":58}],372:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=("undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null,"undefined"!=typeof window?window.Backbone:"undefined"!=typeof b?b.Backbone:null),e=a("../../../../../../../javascripts/cartodb/common/dialogs/change_privacy/share/share_model");describe("common/dialogs/change_privacy/share/share_model",function(){beforeEach(function(){this.vis=new c.admin.Visualization({type:"derived",privacy:"PUBLIC"}),this.organization={users:new d.Collection([{username:"paco"},{username:"pito"}])},this.viewModel=new e({vis:this.vis,organization:this.organization})}),describe("when is a table vis",function(){beforeEach(function(){this.vis.set("type","table"),spyOn(this.vis.tableMetadata(),"fetch"),this.viewModel=new e({vis:this.vis,organization:this.organization})}),it("should fetch table metadata",function(){expect(this.vis.tableMetadata().fetch).toHaveBeenCalled()}),describe("when fetch succeeds",function(){beforeEach(function(){this.allCallback=jasmine.createSpy("all"),this.viewModel.bind("all",this.allCallback),this.vis.tableMetadata().fetch.calls.argsFor(0)[0].success()}),it("should trigger an all event",function(){expect(this.allCallback).toHaveBeenCalled()})})}),describe(".isWriteAccessTogglerAvailable",function(){it("should return true if vis is a table",function(){expect(this.viewModel.isWriteAccessTogglerAvailable()).toBeFalsy(),spyOn(this.vis,"isVisualization").and.returnValue(!1),expect(this.viewModel.isWriteAccessTogglerAvailable()).toBeTruthy()})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/change_privacy/share/share_model":59}],373:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,e=a("../../../../../../../javascripts/cartodb/common/dialogs/change_privacy/share/share_view"),f=a("../../../../../../../javascripts/cartodb/common/dialogs/change_privacy/change_privacy_view");describe("common/dialogs/change_privacy/share/share_view",function(){beforeEach(function(){this.user=new d.admin.User({username:"pepe",actions:{},organization:{users:[{id:"abc-123",username:"paco"},{id:"abc-456",username:"pepe"}],id:"hello-org-id"}}),this.vis=new d.admin.Visualization({type:"derived",privacy:"PUBLIC"}),spyOn(f.prototype,"appendToBody"),this.view=new e({vis:this.vis,user:this.user,ChangePrivacyView:f}),spyOn(this.view,"close"),this.viewModel=this.view.model,spyOn(this.view,"killEvent"),this.view.render()}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should render the header",function(){expect(this.innerHTML()).toContain("Select")}),describe("when click OK",function(){beforeEach(function(){jasmine.clock().install();var a=this;this.deferred=c.Deferred(),spyOn(this.vis.permission,"overwriteAcl").and.callThrough(),spyOn(this.vis.permission,"save").and.callFake(function(){return a.deferred}),this.view.$(".ok").click(),jasmine.clock().tick(1e3)}),afterEach(function(){jasmine.clock().uninstall()}),it("should render sharing...",function(){expect(c(".Dialog").text()).toContain("Sharing")}),it("should overwrite existing ACL",function(){expect(this.vis.permission.overwriteAcl).toHaveBeenCalled(),expect(this.vis.permission.overwriteAcl).toHaveBeenCalledWith(this.viewModel.get("permission"))}),it("should save original permission",function(){expect(this.vis.permission.save).toHaveBeenCalled()}),describe("when save succeeds",function(){beforeEach(function(){this.deferred.resolve(),jasmine.clock().tick(1e3)}),it("should open the privacy dialog",function(){expect(f.prototype.appendToBody).toHaveBeenCalled()}),it("should close this dialog",function(){expect(this.view.close).toHaveBeenCalled()}),it("should not show loading anymore",function(){expect(c(".Dialog").text()).not.toContain("Sharing")})}),describe("when save fails",function(){beforeEach(function(){this.deferred.reject(),jasmine.clock().tick(1e3)}),it("should show error",function(){expect(c(".Dialog").text()).not.toContain("Sharing"),expect(c(".Dialog").text()).toContain("error")})})}),describe("when click back",function(){beforeEach(function(){this.view.$(".js-back").click()}),it("should open privacy dialog again",function(){expect(f.prototype.appendToBody).toHaveBeenCalled()}),it("should close this dialog",function(){expect(this.view.close).toHaveBeenCalled()})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/change_privacy/change_privacy_view":51,"../../../../../../../javascripts/cartodb/common/dialogs/change_privacy/share/share_view":60}],374:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null),d=a("../../../../../../../javascripts/cartodb/common/dialogs/change_privacy/share/user_details_view");describe("common/dialogs/change_privacy/share/user_details_view",function(){beforeEach(function(){return this.model=new c.admin.User({id:"abc-123",username:"pepe",name:"Pepe",email:"pepe@carto.com",avatar_url:"http://host.ext/path/img.jpg"}),this.permission=new c.admin.Permission({}),this.view=new d({model:this.model,permission:this.permission,isUsingVis:!0}),this.view.render()}),it("should not have any leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should render the title",function(){expect(this.innerHTML()).toContain("pepe")}),it("should render the desc",function(){expect(this.innerHTML()).toContain("pepe@carto.com")}),it("should render the avatar",function(){expect(this.innerHTML()).toContain("img.jpg"),expect(this.innerHTML()).not.toContain("CDB-IconFont-people")}),describe("given has no avatar url",function(){beforeEach(function(){this.model.unset("avatar_url"),this.view.render()}),it("should render the default people icon",function(){expect(this.innerHTML()).toContain("CDB-IconFont-people")})}),describe("when is using vis",function(){beforeEach(function(){this.view.options.isUsingVis=!0}),describe("when user can still access item",function(){beforeEach(function(){spyOn(this.permission,"hasReadAccess").and.returnValue(!0),this.view.render(),expect(this.permission.hasReadAccess).toHaveBeenCalledWith(this.model)}),it("should render the info text about usage",function(){expect(this.innerHTML()).toContain("using")})}),describe("when user is getting access revoked",function(){beforeEach(function(){spyOn(this.permission,"hasReadAccess").and.returnValue(!1),this.view.render(),expect(this.permission.hasReadAccess).toHaveBeenCalledWith(this.model)}),it("should warn about destructive change",function(){expect(this.innerHTML()).toContain("will be affected")})})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/change_privacy/share/user_details_view":61}],375:[function(a,b,c){b.exports=function(a){describe("given a disabled item",function(){it("should not be able to set it to be selected",function(){expect(this.model.set("disabled",!0)).toBeTruthy(),expect(this.model.set("selected",!0)).toBeFalsy()})}),describe(".classNames",function(){describe("given both attributes are not set",function(){it("should return empty string",function(){expect(this.model.classNames()).toEqual("")})}),describe("given at least one attr is set to true",function(){it("should return the states in a space-separated string",function(){this.model.set("disabled",!0),expect(this.model.classNames()).toEqual("is-disabled"),this.model.set({disabled:!1,selected:!0}),expect(this.model.classNames()).toEqual("is-selected")})})}),describe(".saveToVis",function(){beforeEach(function(){this.vis=jasmine.createSpyObj("cdb.admin.Visualization",["save"]),this.jqXHR=jasmine.createSpyObj("jqXHR",["done","fail"]),this.vis.save.and.returnValue(this.jqXHR),this.model.set("privacy","new-privacy-value"),this.result=this.model.saveToVis(this.vis)}),it("should set the new privacy setting to the vis model",function(){expect(this.vis.save).toHaveBeenCalled(),expect(this.vis.save.calls.argsFor(0)[0]).toEqual(a.expectedSaveAttrs)}),it("should not update the vis parent collection until jqXHR resolves",function(){expect(this.vis.save.calls.argsFor(0)[1]).toEqual({wait:!0})}),it("should return a jqXHR object",function(){expect(this.result).toBe(this.jqXHR)})})}},{}],376:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,d="undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,f=a("../../../../../../javascripts/cartodb/common/dialogs/change_privacy/start_view"),g=a("../../../../../../javascripts/cartodb/common/dialogs/change_privacy/options_collection");describe("common/dialogs/change_privacy/start_view",function(){beforeEach(function(){this.user=new e.admin.User({username:"pepe",actions:{private_tables:!0,private_maps:!0}}),this.vis=new e.admin.Visualization({type:"derived",privacy:"PUBLIC"}),this.createView=function(){this.view&&this.view.clean(),this.privacyOptions=g.byVisAndUser(this.vis,this.user),this.view=new f({vis:this.vis,user:this.user,privacyOptions:this.privacyOptions}),spyOn(this.view,"killEvent"),this.view.render()},this.createView()}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should have the first (public) option is selected by default",function(){expect(this.innerHTML()).toMatch('is-selected.+data-index="0"')}),it("should not render the upgrade banner by default",function(){expect(this.innerHTML()).not.toContain("upgrade")}),it("should render the password input",function(){expect(this.innerHTML()).toContain("<input")}),it("should not disable the save button",function(){expect(this.innerHTML()).not.toContain("is-disabled")}),it("should not render the share dialog",function(){expect(this.innerHTML()).not.toContain("Share it")}),describe("given user do not have all privacy options available",function(){beforeEach(function(){this.user.get("actions").private_maps=!1,this.createView()}),describe("when has a upgradeUrl",function(){beforeEach(function(){e.config.set("upgrade_url","/account/upgrade"),this.createView()}),it("should render the upgrade banner",function(){expect(this.innerHTML()).toContain("/account/upgrade")}),afterEach(function(){e.config.set("upgrade_url","")})}),describe("and has no upgradeUrl",function(){it("should not render the upgrade banner",function(){expect(this.innerHTML()).not.toContain("upgrade")})})}),describe("given user can share permission",function(){beforeEach(function(){this.user=new e.admin.User({username:"pepe",actions:{},organization:{users:[]}}),this.createView()}),it("should render the share permissions banner",function(){expect(this.innerHTML()).toContain("Share it")}),describe("on click .js-share",function(){beforeEach(function(){this.clickedShare=jasmine.createSpy("clickedShare"),this.view.bind("clickedShare",this.clickedShare),this.view.$(".js-share").click()}),it("should kill event",function(){expect(this.view.killEvent).toHaveBeenCalled()}),it("should trigger clickedShare event",function(){expect(this.clickedShare).toHaveBeenCalled()})}),describe("when shared with organization",function(){beforeEach(function(){spyOn(this.vis.permission,"isSharedWithOrganization").and.returnValue(!0),spyOn(this.vis.permission,"getUsersWithAnyPermission").and.returnValue([new Backbone.Model({name:"buffel&båg",avatar_url:"org-avatar.png"})]),this.view.render()}),it("should render shared with organization",function(){expect(this.innerHTML()).toContain("Shared with your whole organization")}),it("should render the org avatar",function(){expect(this.innerHTML()).toContain("buffel"),expect(this.innerHTML()).toContain("org-avatar.png")})}),describe("when shared with users",function(){beforeEach(function(){spyOn(this.vis.permission,"isSharedWithOrganization").and.returnValue(!1);var a=[];d.times(11,function(b){a.push(new Backbone.Model({username:"User #"+b,avatar_url:"org-avatar"+b+".png"}))}),spyOn(this.vis.permission,"getUsersWithAnyPermission").and.returnValue(a),this.view.render()}),it("should render shared with organization",function(){expect(this.innerHTML()).toContain("Shared with 11 people")}),it("should render the first users",function(){expect(this.innerHTML()).toContain("User #4"),expect(this.innerHTML()).toContain("org-avatar4.png"),expect(this.innerHTML()).not.toContain("User #5"),expect(this.innerHTML()).not.toContain("org-avatar5.png")})})}),describe("on click .js-option",function(){beforeEach(function(){this.select=function(a){c(this.view.$(".js-option")[a]).click()}}),it("should have selected item",function(){var a=this.privacyOptions;expect(a.at(1).get("selected")).toBeFalsy(),this.select(1),expect(a.at(1).get("selected")).toBeTruthy(),this.select(0),expect(a.at(0).get("selected")).toBeTruthy(),expect(a.at(1).get("selected")).toBeFalsy()}),it("should set the .is-selected class on the selected item's DOM",function(){expect(this.innerHTML()).not.toMatch('is-selected.+data-index="1"'),this.select(1),expect(this.innerHTML()).toMatch('is-selected.+data-index="1"'),this.select(0),expect(this.innerHTML()).toMatch('is-selected.+data-index="0"'),expect(this.innerHTML()).not.toMatch('is-selected.+data-index="1"')})}),describe("on select password option",function(){beforeEach(function(){this.passwordOption=this.privacyOptions.where({privacy:"PASSWORD"})[0],this.passwordOption.set("selected",!0)}),it("should render the password input field",function(){expect(this.innerHTML()).toContain("<input ")}),describe("and the password field has no value",function(){beforeEach(function(){this.passwordOption.set("password",void 0)}),it("should disable the save button",function(){expect(this.innerHTML()).toContain("is-disabled")})}),describe("and the password has at least some char",function(){beforeEach(function(){this.passwordOption.set("password","f")}),it("should not disable the save button",function(){expect(this.innerHTML()).not.toContain("is-disabled")})})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/change_privacy/options_collection":53,"../../../../../../javascripts/cartodb/common/dialogs/change_privacy/start_view":62}],377:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../javascripts/cartodb/common/dialogs/create/create_dataset_model"),e=a("./shared_for_create_listing_view_model"),f=a("./listing/shared_for_import_view_model");describe("common/dialogs/create/create_dataset_model",function(){beforeEach(function(){this.user=new c.admin.User({username:"paco",base_url:"http://url.com"}),this.model=new d({},{user:this.user})}),e.call(this),f.call(this),it("should have default values",function(){expect(this.model.get("type")).toBeDefined(),expect(this.model.get("option")).toBeDefined()}),it("should define several local models",function(){expect(this.model.upload).toBeDefined()}),describe(".createFromScratch",function(){it("should change state when dataset creation starts",function(){spyOn(c.admin.CartoDBTableMetadata.prototype,"save"),this.model.createFromScratch(),expect(this.model.get("option")).toBe("loading")}),it("should trigger datasetCreated when it is created",function(){spyOn(c.admin.CartoDBTableMetadata.prototype,"save").and.callFake(function(a,b){b.success()});var a=!1;this.model.bind("datasetCreated",function(){a=!0}),this.model.createFromScratch(),expect(a).toBeTruthy()}),it("should trigger datasetError when it fails",function(){spyOn(c.admin.CartoDBTableMetadata.prototype,"save").and.callFake(function(a,b){b.error()});var a=!1;this.model.bind("datasetError",function(){a=!0}),this.model.createFromScratch(),expect(a).toBeTruthy()})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/create/create_dataset_model":64,"./listing/shared_for_import_view_model":384,"./shared_for_create_listing_view_model":385}],378:[function(a,b,c){(function(b){function c(){return{id:"paco",name:"title",type:"remote",external_source:{size:100}}}var d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,e=("undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null,a("../../../../../../javascripts/cartodb/common/dialogs/create/create_map_model")),f=a("../../../../../../javascripts/cartodb/common/background_polling/models/import_model"),g=a("./shared_for_create_listing_view_model"),h=a("./listing/shared_for_import_view_model");describe("common/dialogs/create/create_map_model",function(){beforeEach(function(){this.user=new d.admin.User({username:"paco",base_url:"http://url.com"}),this.model=new e({},{user:this.user}),this.model.collection.reset([{id:"test",name:"paco"}]),this.model.collection.at(0).set("selected",!0)}),g.call(this),h.call(this),it("should have default values",function(){expect(this.model.get("type")).toBeDefined(),expect(this.model.get("currentImport")).toBeDefined(),expect(this.model.get("tableIdsArray")).toBeDefined()}),it("should define local models",function(){expect(this.model.upload).toBeDefined()}),describe(".viewsReady",function(){describe("when given a set of pre-selected items",function(){beforeEach(function(){spyOn(e.prototype,"createMap"),spyOn(d.admin.Visualizations.prototype,"fetch"),this.model=new e({},{selectedItems:[{foo:"bar"}],user:this.user}),this.model.viewsReady()}),it("should create the map directly",function(){expect(e.prototype.createMap).toHaveBeenCalled()}),it("should not fetch collection for new datasets",function(){expect(d.admin.Visualizations.prototype.fetch).not.toHaveBeenCalled()})})}),describe(".createMap",function(){describe("when remote dataset validation fails",function(){beforeEach(function(){this.model.bind("importingRemote",function(){this.importEvent=!0},this),this.model.bind("importFailed",function(){this.failedEvent=!0},this),this.user.set("remaining_byte_quota",1),this.model.collection.reset([c()]),this.model.collection.at(0).set("selected",!0),this.model.createMap()}),it("should raise an error",function(){expect(this.failedEvent).toBeTruthy(),expect(this.importEvent).toBeTruthy();var a=this.model.get("currentImport").getError();expect(a.error_code).toBe(8001),expect(this.model.get("tableIdsArray").length).toBe(0)})}),describe("when selected non-remote datasets",function(){beforeEach(function(){var a=this;spyOn(d.admin.Visualization.prototype,"save").and.callFake(function(){a.vis=this}),this.model.bind("mapError",function(){this.mapCreateError=!0},this),this.model.createMap()}),it("should create the new map directly if save succeeds",function(){expect(d.admin.Visualization.prototype.save).toHaveBeenCalled();var a=new d.common.MapUrl({base_url:"https://carto.com/user/pepe/viz/abc-123"});spyOn(this.vis,"viewUrl").and.returnValue(a),spyOn(this.model,"_redirectTo"),d.admin.Visualization.prototype.save.calls.argsFor(0)[1].success(),expect(this.model._redirectTo).toHaveBeenCalled(),expect(this.model._redirectTo).toHaveBeenCalledWith("https://carto.com/user/pepe/viz/abc-123/map")}),it("should trigger an error event if save fails",function(){expect(d.admin.Visualization.prototype.save).toHaveBeenCalled(),d.admin.Visualization.prototype.save.calls.argsFor(0)[1].error(),expect(this.mapCreateError).toBeTruthy()})}),describe("when selected remote datasets",function(){beforeEach(function(){this.user.set("remaining_byte_quota",1e4);var a=this;spyOn(d.admin.Visualization.prototype,"save").and.callFake(function(){a.vis=this}),spyOn(f.prototype,"_createRegularImport"),this.model.bind("importCompleted",function(){this.importCompletedEvent=!0},this),this.model.selectedDatasets.reset(),this.model.collection.reset([c(),{id:"hello",name:"paco"}]),this.model.collection.at(0).set("selected",!0),this.model.collection.at(1).set("selected",!0),this.model.createMap();var b=this.model.get("currentImport");b.imp.set("state","complete"),expect(d.admin.Visualization.prototype.save).toHaveBeenCalled();var e=new d.common.MapUrl({base_url:"https://carto.com/user/pepe/viz/abc-123"});spyOn(this.vis,"viewUrl").and.returnValue(e),spyOn(this.model,"_redirectTo"),d.admin.Visualization.prototype.save.calls.argsFor(0)[1].success()}),it("should import the remote datasets and then generate a new map",function(){expect(this.importCompletedEvent).toBeTruthy(),expect(this.model.get("tableIdsArray").length).toBe(2),expect(this.model.get("currentImport")).toBe("")})})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/background_polling/models/import_model":11,"../../../../../../javascripts/cartodb/common/dialogs/create/create_map_model":69,"./listing/shared_for_import_view_model":384,"./shared_for_create_listing_view_model":385}],379:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null;c.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null;var d=("undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null,a("../../../../../../../../../javascripts/cartodb/common/dialogs/create/listing/imports/data_import/data_form_view")),e=a("../../../../../../../../../javascripts/cartodb/common/background_polling/models/upload_model");describe("common/dialogs/create/imports/data_import/data_form_view",function(){beforeEach(function(){this.user=new c.admin.User({username:"pepe",base_url:"http://pepe.carto.com"}),this.model=new e({type:"url",service_name:""},{user:this.user}),spyOn(this.model,"bind").and.callThrough(),this.view=new d({model:this.model,user:this.user,fileEnabled:!0}),this.view.render()}),it("should be rendered properly",function(){expect(this.view.$(".Form").length).toBe(1),expect(this.view.$(".Form-row").length).toBe(1),expect(this.view.$(".Form-upload").length).toBe(1),expect(this.view.$(".js-dropzone").length).toBe(1)}),it("should not render file part if option is disabled",function(){this.view.options.fileEnabled=!1,this.view.render(),expect(this.view.$(".Form-row").length).toBe(1),expect(this.view.$(".js-dropzone").length).toBe(0)}),it("should have change state binding",function(){expect(this.model.bind.calls.argsFor(0)[0]).toEqual("change:state")}),it("should be hidden when state is selected",function(){spyOn(this.view,"hide"),spyOn(this.view,"show"),this.model.set({state:"selected",type:"url",value:"http://cartodb"}),expect(this.view.hide).toHaveBeenCalled(),this.model.set("state","error"),expect(this.view.show).toHaveBeenCalled()}),it("should submit url when it is valid",function(){var a=!1;this.view.bind("urlSelected",function(){a=!0}),this.view.$(".js-textInput").val("https://carto.com").trigger("keyup"),this.view.$(".js-form").submit(),expect(a).toBeTruthy(),expect(this.model.get("state")).toBe("selected")}),it("shouldn't change type attribute when a url is submitted and is valid",function(){this.model.set({type:"service",service_name:"arcgis"}),this.view.render(),this.view.$(".js-textInput").val("https://carto.com").trigger("keyup"),this.view.$(".js-form").submit(),expect(this.model.get("type")).toBe("service")}),it("should show error when url is invalid",function(){spyOn(this.view,"_showTextError"),this.view.$(".js-textInput").val("fake-url").trigger("keyup"),this.view.$(".js-form").submit(),expect(this.view._showTextError).toHaveBeenCalled()}),it("should set selected state when file is selected",function(){spyOn(this.view,"_showFileError"),this.view._onFileChanged([{name:"filename.csv"}]),expect(this.model.get("state")).toBe("selected"),expect(this.view._showFileError).not.toHaveBeenCalled()}),it("should show file error when the selected one is not valid",function(){spyOn(this.view,"_showFileError"),this.view._onFileChanged([{name:"p"}]),expect(this.model.get("state")).not.toBe("selected"),expect(this.view._showFileError).toHaveBeenCalled()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../../../javascripts/cartodb/common/background_polling/models/upload_model":19,"../../../../../../../../../javascripts/cartodb/common/dialogs/create/listing/imports/data_import/data_form_view":80}],380:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null;c.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null;var d=("undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null,a("../../../../../../../../../javascripts/cartodb/common/dialogs/create/listing/imports/data_import/data_header_view")),e=a("../../../../../../../../../javascripts/cartodb/common/background_polling/models/upload_model");describe("common/dialogs/create/imports/data_import/data_header_view",function(){beforeEach(function(){this.user=new c.admin.User({username:"pepe",base_url:"http://pepe.carto.com"}),this.model=new e({type:"url",service_name:""},{user:this.user}),spyOn(this.model,"bind").and.callThrough(),this.view=new d({model:this.model,user:this.user,fileEnabled:!0,acceptSync:!0}),this.view.render()}),it("should be rendered properly",function(){expect(this.view.$(".js-title").length).toBe(1),expect(this.view.$(".js-description").length).toBe(1),expect(this.view.$(".ImportPanel-headerButton").length).toBe(0)}),it("should have change state binding",function(){expect(this.model.bind.calls.argsFor(0)[0]).toEqual("change:state")}),it("should show 'go back' button when import is selected",function(){this.model.set({state:"selected",type:"url",value:"https://carto.com"}),expect(this.view.$(".ImportPanel-headerButton").length).toBe(1),this.view.$(".ImportPanel-headerButton").click(),expect(this.model.get("state")).toBe("idle")}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../../../javascripts/cartodb/common/background_polling/models/upload_model":19,"../../../../../../../../../javascripts/cartodb/common/dialogs/create/listing/imports/data_import/data_header_view":81}],381:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null;c.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null;var d="undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null,e=a("../../../../../../../../javascripts/cartodb/common/dialogs/create/listing/imports/import_data_view");describe("common/dialogs/create/imports/import_data_view",function(){beforeEach(function(){this.user=new c.admin.User({username:"pepe",base_url:"http://pepe.carto.com"}),this.view=new e({user:this.user,name:"file",title:"Data file",type:"url",fileEnabled:!0,acceptSync:!0}),spyOn(this.view.model,"bind").and.callThrough(),this.view.render()}),it("should be rendered properly",function(){expect(this.view.$(".ImportPanel-header").length).toBe(1),expect(this.view.$(".ImportPanel-form").length).toBe(1),expect(this.view.$(".DatasetSelected").length).toBe(1),expect(d.size(this.view._subviews)).toBe(3)}),it("should have change state binding",function(){expect(this.view.model.bind.calls.argsFor(0)[0]).toEqual("change:state")}),it("should return to a default state",function(){this.view.model.set({state:"selected",value:"https://carto.com"}),this.view.model.set({state:"idle"}),expect(this.view.model.get("type")).toEqual(void 0),expect(this.view.model.get("value")).toEqual("")}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../../javascripts/cartodb/common/dialogs/create/listing/imports/import_data_view":84}],382:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null;c.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null;var d=("undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null,a("../../../../../../../../javascripts/cartodb/common/dialogs/create/listing/imports/import_selected_dataset_view")),e=a("../../../../../../../../javascripts/cartodb/common/background_polling/models/upload_model");describe("common/dialogs/create/imports/import_selected_dataset_view",function(){beforeEach(function(){c.config.set("cartodb_com_hosted",!1),this.user=new c.admin.User({username:"pepe",base_url:"http://pepe.carto.com",actions:{sync_tables:!0}}),window.upgrade_url="http://localhost:3000/account/development/upgrade",this.model=new e({type:"url",value:"https://carto.com"},{user:this.user}),spyOn(this.model,"bind").and.callThrough(),this.view=new d({model:this.model,user:this.user,acceptSync:!0,fileAttrs:{}}),this.view.render()}),it("should be rendered properly",function(){expect(this.view.$(".DatasetSelected-item").length).toBe(1),expect(this.view.$(".DatasetSelected-sync").length).toBe(1),expect(this.view.$(".DatasetSelected-upgrade").length).toBe(0)}),it("should have several bindings",function(){expect(this.model.bind.calls.argsFor(0)[0]).toEqual("change:value"),expect(this.model.bind.calls.argsFor(1)[0]).toEqual("change:interval"),expect(this.model.bind.calls.argsFor(2)[0]).toEqual("change:state")}),it("should be able to change view options with a public method",function(){expect(this.view.setOptions).not.toBeUndefined()}),it('should change item interval when any sync "radiobutton" is clicked',function(){expect(this.model.get("interval")).toBe(0),this.view.$(".js-interval-4").click(),expect(this.model.get("interval")).toBe(2592e3)}),it("should hide sync block if option is disabled",function(){this.view.options.acceptSync=!1,this.view.render(),expect(this.view.$(".DatasetSelected-sync").length).toBe(0)}),it("show show upgrade block if user is upgradeable",function(){this.user.set("actions",{sync_tables:!1}),this.view.render(),expect(this.view.$(".DatasetSelected-upgrade").length).toBe(1),expect(this.view.$(".RadioButton.is-disabled").length).toBe(4)}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean(),window.upgrade_url=void 0,delete window.upgrade_url})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../../javascripts/cartodb/common/background_polling/models/upload_model":19,"../../../../../../../../javascripts/cartodb/common/dialogs/create/listing/imports/import_selected_dataset_view":87}],383:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null;c.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null;
var d="undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null,e=a("../../../../../../../../javascripts/cartodb/common/dialogs/create/listing/imports/twitter_import/import_twitter_view");describe("common/dialogs/create/imports/twitter_import_view",function(){beforeEach(function(){this.user=new c.admin.User({username:"pepe",base_url:"http://pepe.carto.com",twitter:{quota:100,monthly_use:0,block_size:10,block_price:1e3,enabled:!0,hard_limit:!1}}),this.view=new e({user:this.user,title:"twitter"}),this.view.render()}),it("should be rendered properly",function(){expect(this.view.$(".ImportTwitterPanel-cagetories").length).toBe(1),expect(this.view.$(".ImportTwitterPanel-datePicker").length).toBe(1),expect(this.view.$(".ImportTwitterPanel-creditsUsage").length).toBe(1)}),describe("twitter categories",function(){beforeEach(function(){this.categories=this.view.categories}),it("should render properly",function(){expect(this.categories.$(".TwitterCategory").length).toBe(1),expect(this.categories.$(".TwitterCategory label").text()).toBe("Category 1")}),it("should create a new category when the before one has any character",function(){this.categories.$(".TwitterCategory .js-terms").val("test"),this.categories.$(".TwitterCategory .js-terms").trigger("keydown"),expect(this.categories.$(".TwitterCategory").length).toBe(2)}),it("should delete the category when it is empty and it is not the first one",function(){this.categories.$(".TwitterCategory .js-terms").val("test"),this.categories.$(".TwitterCategory .js-terms").trigger("keydown"),expect(this.categories.$(".TwitterCategory").length).toBe(2),this.categories.$(".TwitterCategory:eq(0) .js-terms").val(""),this.categories.$(".TwitterCategory:eq(0) .js-terms").trigger("keydown"),expect(this.categories.$(".TwitterCategory").length).toBe(1)}),it("should render 4 categories as max",function(){for(var a=0,b=10;a<b;a++)this.categories.$(".TwitterCategory:eq("+a+") .js-terms").val("test"),this.categories.$(".TwitterCategory:eq("+a+") .js-terms").trigger("keydown");expect(this.categories.$(".TwitterCategory").length).toBe(4)}),it("should return categories as JSON format",function(){this.categories.$(".TwitterCategory .js-terms").val("test"),this.categories.$(".TwitterCategory .js-terms").trigger("keydown");var a=this.categories.getCategories();expect(a.length).toBe(2),expect(a[0].category).toBe("1"),expect(a[0].terms.length).toBe(1),expect(a[0].terms[0]).toBe("test"),expect(a[1].category).toBe("2"),expect(a[1].terms.length).toBe(0)})}),describe("twitter credits",function(){beforeEach(function(){this.creditsUsage=this.view.creditsUsage}),it("should render properly",function(){expect(this.creditsUsage.$(".CreditsUsage-slider").length).toBe(1),expect(this.creditsUsage.$(".CreditsUsage-info").length).toBe(1)}),it("should set as min value 1%, not 0%",function(){this.creditsUsage.$(".js-slider").slider("value",0),expect(this.creditsUsage.model.get("value")).toBe(1)}),it("should start around 80% of quota",function(){var a=100*this.creditsUsage.model.get("value")/this.user.get("twitter").quota;expect(a).toBe(80)}),it("should let choose 'no limits' when user doesn't have hard limits",function(){this.creditsUsage.$(".js-slider").slider("value",101),expect(this.creditsUsage.$(".js-info").text()).toContain("No limits")}),it("shouldn't let choose 'no limits' when user has hard limits",function(){var a=this.user.get("twitter");a.hard_limit=!0,this.user.set("twitter",a),this.creditsUsage.render(),this.creditsUsage.$(".js-slider").slider("value",101),expect(this.creditsUsage.$(".js-info").text()).not.toContain("No limits")}),it("should disable slider when user has reached his/her limits",function(){var a=this.user.get("twitter");a.monthly_use=110,this.user.set("twitter",a),this.view.render(),expect(this.view.$(".js-slider").slider("option","disabled")).toBeTruthy(),expect(this.view.$(".js-info").text()).toContain("credits for this period consumed")}),it("should change text when credits value has changed",function(){expect(this.creditsUsage.$(".js-info").text()).toContain("80%"),this.creditsUsage.model.set("value",30),expect(this.creditsUsage.$(".js-info").text()).toContain("30%")}),it("should change text when credits value has changed",function(){expect(this.creditsUsage.$(".js-info").text()).toContain("80%"),this.creditsUsage.model.set("value",30),expect(this.creditsUsage.$(".js-info").text()).toContain("30%")}),it("should update model when value has changed",function(b){var c=a("../../../../../../../../javascripts/cartodb/common/background_polling/models/upload_model.js");expect(this.creditsUsage.$(".js-info").text()).toContain("80%"),sinon.spy(c.prototype,"validate"),this.creditsUsage.$(".js-slider").slider("value",1),d.defer(function(){expect(c.prototype.validate.getCall(0).args[0].user_defined_limits.twitter_credits_limit).toEqual(1),b()})})}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../../javascripts/cartodb/common/background_polling/models/upload_model.js":19,"../../../../../../../../javascripts/cartodb/common/dialogs/create/listing/imports/twitter_import/import_twitter_view":98}],384:[function(a,b,c){b.exports=function(){describe(".setActiveImportPane",function(){it("should be a function to set which pane is currently active",function(){expect(this.model.setActiveImportPane).toEqual(jasmine.any(Function))})})}},{}],385:[function(a,b,c){b.exports=function(){it("should have listing attr representing current listing view",function(){expect(this.model.get("listing")).toEqual(jasmine.any(String)),expect(this.model.get("listing")).not.toEqual("")}),describe(".showLibrary",function(){it("should return a boolean for if data library should be loaded",function(){expect(this.model.showLibrary()).toEqual(jasmine.any(Boolean))})}),describe(".canSelect",function(){it("should return a boolean for if user can select an item (more)",function(){var a=new cdb.core.Model;expect(this.model.canSelect(a)).toEqual(jasmine.any(Boolean))})}),describe(".showDatasets",function(){it("should return a boolean for whether to show datasets or not",function(){expect(this.model.showDatasets()).toEqual(jasmine.any(Boolean))})})}},{}],386:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/create_vis_first/create_vis_first_view");describe("common/dialogs/create_vis_first/create_vis_first_view",function(){beforeEach(function(){this.successCallback=jasmine.createSpy("success callback"),this.vis=new cdb.admin.Visualization({name:"my_table",type:"table"}),this.router=new cdb.admin.TableRouter,spyOn(this.vis,"changeToVisualization"),spyOn(this.router,"changeToVis"),this.view=new d({model:this.vis,router:this.router,title:"This test expects an title",explanation:"This test expects an explanation",success:this.successCallback}),this.view.render()}),it("should render the confirm view first",function(){expect(this.innerHTML()).toContain("ok")}),it("should render the title and explanation",function(){expect(this.innerHTML()).toContain("This test expects an title"),expect(this.innerHTML()).toContain("This test expects an explanation")}),describe("when confirm/ok to create map first",function(){beforeEach(function(){this.view.$el.find(".ok").click()}),it("should change to the loading view",function(){expect(this.innerHTML()).not.toContain("This test expects"),expect(this.innerHTML()).toContain("Creating map")}),it("should call the change-to-visualization on the model",function(){expect(this.vis.changeToVisualization).toHaveBeenCalled(),expect(this.vis.changeToVisualization).toHaveBeenCalledWith(jasmine.objectContaining({success:jasmine.any(Function),error:jasmine.any(Function)}))}),describe("when successfully changed",function(){beforeEach(function(){spyOn(this.view,"clean"),this.vis.changeToVisualization.calls.argsFor(0)[0].success(this.vis)}),it("should tell router to change to map",function(){expect(this.router.changeToVis).toHaveBeenCalled(),expect(this.router.changeToVis).toHaveBeenCalledWith(this.vis)}),it("should call the given success callback",function(){expect(this.successCallback).toHaveBeenCalled()}),it("should clean this view",function(){expect(this.view.clean).toHaveBeenCalled()})}),describe("when fails to create map",function(){beforeEach(function(){this.vis.changeToVisualization.calls.argsFor(0)[0].error()}),it("should show the fail view",function(){expect(this.innerHTML()).toContain("Could not create map")})})}),afterEach(function(){this.view.clean()})})},{"../../../../../../javascripts/cartodb/common/dialogs/create_vis_first/create_vis_first_view":105}],387:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/delete_column/delete_column_view");describe("common/dialogs/delete_column/delete_column_view",function(){beforeEach(function(){this.table=new cdb.admin.CartoDBTableMetadata({id:"testTable",name:"testTable",schema:[["cartodb_id","number"],["test","string"],["test1","number"],["test2","boolean"],["test3","date"],["the_geom","geometry"]],geometry_types:["ST_MultiPoint"]}),this.columnName="test",this.column=new cdb.admin.Column({table:this.table,name:this.columnName,type:"string"}),spyOn(this.column,"destroy"),this.view=new d({table:this.table,column:this.columnName}),this.view.render()}),it("should render the view",function(){expect(this.innerHTML()).toContain("Ok, delete"),expect(this.innerHTML()).toContain("You are about to delete the '"+this.columnName+"' column"),expect(this.innerHTML()).toContain("Are you sure you want to delete it?")}),describe("when click ok to delete column",function(){it("should call to destroy the model",function(){var a=sinon.fakeServer.create();a.respondWith("DELETE","/api/v1/tables/"+this.table.get("name")+"/columns/test",[200,{"Content-Type":"application/json"},'{"name":"irrelevant1","type":"text","cartodb_type":"string"}']);var b=!1;this.table.bind("columnDelete",function(){b=!0}),this.view.$(".ok").click(),spyOn(this.table._data,"fetch"),a.respond(),expect(b).toBeTruthy(),expect(this.table._data.fetch).toHaveBeenCalled()})}),afterEach(function(){this.view.clean()})})},{"../../../../../../javascripts/cartodb/common/dialogs/delete_column/delete_column_view":106}],388:[function(a,b,c){(function(b){var c=a("../../../../../javascripts/cartodb/common/dialogs/delete_items_view"),d=a("../../../../../javascripts/cartodb/common/dialogs/delete_items_view_model"),e="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null;describe("common/dialogs/delete_items_view",function(){beforeEach(function(){this.user=new e.User({base_url:"http://pepe.carto.com",id:123,name:"pepe"}),this.contentType="datasets",this.models=[],this.createView=function(a){this.viewModel=new d(this.models,{contentType:this.contentType}),spyOn(this.viewModel,"loadPrerequisites"),spyOn(this.viewModel,"errorMessage").and.returnValue("Some error"),this.view=new c({user:this.user,viewModel:this.viewModel}),spyOn(this.view,"_loadMapPreviews"),a&&a(this.view,this.viewModel)}}),it("should load prerequisites when creating the view",function(){this.createView(),expect(this.viewModel.loadPrerequisites).toHaveBeenCalled()}),it("should attempt to load the map previews after the rendering is done",function(){this.createView(function(a,b){b.setState("LoadingPrerequisites"),a.appendToBody()}),expect(this.view._loadMapPreviews).toHaveBeenCalled()}),describe("when loading prerequisites",function(){beforeEach(function(){this.createView(),this.viewModel.setState("LoadingPrerequisites")}),it("should show a message",function(){expect(this.innerHTML()).toContain("Checking what consequences deleting the selected datasets would have...")}),describe("when loading prerequisites fails",function(){beforeEach(function(){this.viewModel.setState("LoadPrerequisitesFail")}),it("should rendered the default error template",function(){expect(this.innerHTML()).toContain("ouch"),expect(this.innerHTML()).toContain("error")})}),describe("when loading prerequisities finished successfully",function(){beforeEach(function(){this.viewModel.setState("ConfirmDeletion")}),it("should not render loader anymore",function(){expect(this.innerHTML()).not.toContain("Checking")}),describe("when items are NOT shared with other users",function(){it("should not render any affected users block",function(){expect(this.innerHTML()).not.toContain("will lose access")}),it("should render a text with amount of items to be deleted",function(){expect(this.innerHTML()).toContain("You are about to delete")}),describe('when "OK, delete" button is clicked',function(){beforeEach(function(){spyOn(this.viewModel,"deleteItems"),spyOn(this.view,"close").and.callThrough(),this.view.$(".ok").click(),this.viewModel.setState("DeletingItems")}),it("should delete items",function(){expect(this.viewModel.deleteItems).toHaveBeenCalled()}),describe("when deletion is done successfully",function(){beforeEach(function(){this.viewModel.setState("DeleteItemsDone")}),it("should close the dialog",function(){expect(this.view.close).toHaveBeenCalled()})}),describe("when deletion fails",function(){beforeEach(function(){this.viewModel.setState("DeleteItemsFail")}),it("should show error message",function(){expect(this.innerHTML()).toContain("Some error")})})})}),describe("when items are shared with other users",function(){beforeEach(function(){var a=function(a){return new e.User({id:a.id,name:"user name "+a.id})};spyOn(this.viewModel,"affectedEntities").and.returnValue([a({id:1}),a({id:2}),a({id:3}),a({id:4})]),this.viewModel.setState("ConfirmDeletion")}),it("should render block of affected users",function(){expect(this.innerHTML()).toContain("Some users will lose access")}),it("should show avatars of a sample of the affected users",function(){expect(this.innerHTML()).toContain("user name 1"),expect(this.innerHTML()).toContain("user name 2"),expect(this.innerHTML()).toContain("user name 3"),expect(this.innerHTML()).not.toContain("user name 4")}),it('should show a "more" avatar representing that there are more users affected that are not displayed',function(){expect(this.innerHTML()).toContain("--moreItems")})}),describe("when there are affected maps",function(){beforeEach(function(){spyOn(this.viewModel,"affectedVisData").and.returnValue([{id:"8b44c8ba-6fcf-11e4-8581-080027880ca6",name:"A walk",updated_at:"2015-01-13T10:16:09+00:00",permission:{id:"7a3946ab-166e-4f55-af75-6964daf11fb2",owner:{id:"c07440fd-5dc2-4c82-9d58-ac8ba5a06ddf",base_url:"http://org.carto.com/u/development",username:"development",avatar_url:"//gravatar.com/avatar/e28c025981d4f16551fff315fdffa498?s=128"}}}]),this.viewModel.setState("ConfirmDeletion")}),it("should render affected map",function(){expect(this.innerHTML()).toContain("MapCard")}),it("should render the id of the visualization",function(){expect(this.innerHTML()).toContain('data-vis-id="8b44c8ba-6fcf-11e4-8581-080027880ca6"')}),it("should be linked to open map in new window",function(){expect(this.innerHTML()).toContain('<a href="http://org.carto.com/u/development/viz/8b44c8ba-6fcf-11e4-8581-080027880ca6/map" target="_blank"')})})})}),afterEach(function(){this.view&&this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/dialogs/delete_items_view":107,"../../../../../javascripts/cartodb/common/dialogs/delete_items_view_model":108}],389:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,e=a("../../../../../javascripts/cartodb/common/dialogs/delete_items_view_model");describe("common/dialogs/delete_items_view_model",function(){beforeEach(function(){this.models=[new d.admin.Visualization({}),new d.admin.Visualization({})],this.opts={contentType:"maps"},this.createViewModel=function(){this.viewModel=new e(this.models,this.opts)}}),describe(".isDeletingDatasets",function(){describe("when content type is datasets",function(){beforeEach(function(){this.opts.contentType="datasets",this.createViewModel()}),it("should return true",function(){expect(this.viewModel.isDeletingDatasets()).toBeTruthy()})}),describe("when content type is maps",function(){beforeEach(function(){this.opts.contentType="maps",this.createViewModel()}),it("should return false",function(){expect(this.viewModel.isDeletingDatasets()).toBeFalsy()})})}),describe(".loadingPrerequisites",function(){describe("when content type is maps",function(){beforeEach(function(){this.opts.contentType="maps",this.createViewModel(),this.viewModel.loadPrerequisites()}),it("should change state to confirm deletion directly",function(){expect(this.viewModel.state()).toEqual("ConfirmDeletion")})}),describe("when content type is datasets",function(){beforeEach(function(){this.opts.contentType="datasets",this.models.forEach(function(a){spyOn(a.tableMetadata(),"fetch")},this),this.createViewModel(),this.changeCount=0,this.viewModel.bind("change",function(){this.changeCount++},this),this.viewModel.bind("ConfirmDeletion",function(){this.confirmDeletionCalled=!0},this),this.viewModel.bind("LoadPrerequisitesFail",function(){this.loadPrerequisitesFailCalled=!0},this),this.viewModel.loadPrerequisites()}),it("should have state set to loading prerequisites",function(){expect(this.viewModel.state()).toEqual("LoadingPrerequisites")}),it("should call .fetch on the metadata models",function(){this.models.forEach(function(a){var b=a.tableMetadata();expect(b.fetch).toHaveBeenCalled(),expect(b.fetch.calls.argsFor(0)[0]).toEqual(jasmine.objectContaining({wait:!0}))},this)}),it("should trigger a change once",function(){expect(this.changeCount).toEqual(1)}),describe("when all prerequisites are loaded",function(){beforeEach(function(){this.models.forEach(function(a){var b=a.tableMetadata();b.fetch.calls.argsFor(0)[0].success()})}),it("should trigger a change event again",function(){expect(this.changeCount).toEqual(2)}),it("should trigger a confirm deletion event",function(){expect(this.confirmDeletionCalled).toBeTruthy()})}),describe("when an prerequisites load fails",function(){beforeEach(function(){this.models.forEach(function(a){var b=a.tableMetadata();b.fetch.calls.argsFor(0)[0].error(a,{responseText:"internal server error, or such"})})}),it("should trigger a change event again",function(){expect(this.changeCount).toEqual(2)}),it("should trigger a fail event",function(){expect(this.loadPrerequisitesFailCalled).toBeTruthy()})})})}),describe(".deleteItems",function(){beforeEach(function(){this.createViewModel(),this.modelDeferreds=[],this.models.forEach(function(a,b){var d=c.Deferred();spyOn(a,"destroy").and.returnValue(d.promise()),this.modelDeferreds[b]=d},this),this.changeCount=0,this.changeSpy=jasmine.createSpy("change"),this.viewModel.bind("change",this.changeSpy),this.deleteItemsDoneSpy=jasmine.createSpy("DeleteItemsDone"),this.deleteItemsFailSpy=jasmine.createSpy("DeleteItemsFail"),this.viewModel.bind("DeleteItemsDone",this.deleteItemsDoneSpy),this.viewModel.bind("DeleteItemsFail",this.deleteItemsFailSpy),this.viewModel.deleteItems()}),it("should change state to deleting deletion",function(){expect(this.viewModel.state()).toEqual("DeletingItems")}),it("should call destroy and wait to be removed from any parent collection until confirmed deletion from server",function(){expect(this.models[0].destroy).toHaveBeenCalled(),expect(this.models[0].destroy.calls.argsFor(0)[0]).toEqual(jasmine.objectContaining({wait:!0})),expect(this.models[1].destroy).not.toHaveBeenCalled(),this.modelDeferreds[0].resolve(),expect(this.models[1].destroy).toHaveBeenCalled()}),it("should trigger a change once",function(){expect(this.changeSpy.calls.count()).toEqual(1)}),describe("when all items are deleted",function(){beforeEach(function(){this.modelDeferreds.forEach(function(a){a.resolve()})}),it("should trigger a change event again",function(){expect(this.changeSpy.calls.count()).toEqual(2)}),it("should trigger a done event",function(){expect(this.deleteItemsDoneSpy).toHaveBeenCalled()})}),describe("when an deletion fail",function(){beforeEach(function(){this.modelDeferreds[0].reject("oups")}),it("should trigger a change event again",function(){expect(this.changeSpy.calls.count()).toEqual(2)}),it("should trigger a fail event",function(){expect(this.deleteItemsFailSpy).toHaveBeenCalled()})})}),describe(".affectedEntities",function(){describe("when there are no users who share item",function(){beforeEach(function(){this.createViewModel()}),it("should return an empty list",function(){expect(this.viewModel.affectedEntities()).toEqual([])})}),describe("when there are users who share item",function(){beforeEach(function(){var a=function(a){return new d.admin.User({id:a.id,name:"user name "+a.id})};this.users=[a({id:1}),a({id:2}),a({id:3}),a({id:4}),a({id:5})],spyOn(this.models[0],"sharedWithEntities").and.returnValue(this.users.slice(0,2)),spyOn(this.models[1],"sharedWithEntities").and.returnValue(this.users.slice(2)),this.createViewModel()}),it("should return a list with them",function(){expect(this.viewModel.affectedEntities()).toEqual(this.users)})})}),describe(".affectedVisData",function(){describe("when there are no affected vis",function(){beforeEach(function(){this.createViewModel()}),it("should return an empty list",function(){expect(this.viewModel.affectedVisData()).toEqual([])})}),describe("when there are affected vis",function(){var a,b,c,e=function(a,b){var c={get:function(c){return"dependent_visualizations"==c?a:"non_dependent_visualizations"==c?b:void 0}};return c};beforeEach(function(){a=new d.admin.Visualization({id:"vis1"}),b=new d.admin.Visualization({id:"vis2"}),c=new d.admin.Visualization({id:"vis3"}),this.models=[a,b,c]}),it("should return a list with the affected vis",function(){spyOn(a,"tableMetadata").and.returnValue(e([{id:"vis2"}],[{id:"vis3"}])),this.createViewModel(),expect(this.viewModel.affectedVisData()).toEqual([{id:"vis2"},{id:"vis3"}])}),it("should NOT return duplicated visualizations",function(){spyOn(a,"tableMetadata").and.returnValue(e([{id:"vis2"}],[{id:"vis3"}])),spyOn(b,"tableMetadata").and.returnValue(e([{id:"vis1"}],[{id:"vis3"}])),this.createViewModel(),expect(this.viewModel.affectedVisData()).toEqual([{id:"vis2"},{id:"vis3"},{id:"vis1"}])})})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/dialogs/delete_items_view_model":108}],390:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/delete_layer/delete_layer_view");describe("common/dialogs/delete_layer/delete_layer_view",function(){beforeEach(function(){this.layer=new cdb.admin.CartoDBLayer({}),spyOn(this.layer,"destroy"),this.view=new d({model:this.layer}),this.view.render()}),it("should render the confirm view first",function(){expect(this.innerHTML()).toContain("ok")}),describe("when click ok to delete layer",function(){beforeEach(function(){this.view.$(".ok").click()}),it("should change to the loading view",function(){expect(this.innerHTML()).not.toContain("ok"),expect(this.innerHTML()).toContain("Deleting layer")}),it("should call to destroy the model",function(){expect(this.layer.destroy).toHaveBeenCalled()}),it("should not remove layer from owning collection until after confirmed deleted",function(){expect(this.layer.destroy.calls.argsFor(0)[0]).toEqual(jasmine.objectContaining({wait:!0}))}),describe("when successfully deleted",function(){beforeEach(function(){spyOn(this.view,"close"),this.layer.destroy.calls.argsFor(0)[0].success()}),it("should close this view",function(a){var b=this;setTimeout(function(){expect(b.view.close).toHaveBeenCalled(),a()},0)})}),describe("when fails to delete layer",function(){beforeEach(function(){this.layer.destroy.calls.argsFor(0)[0].error()}),it("should show the fail view",function(){expect(this.innerHTML()).toContain("Could not delete layer")})})}),afterEach(function(){this.view.clean()})})},{"../../../../../../javascripts/cartodb/common/dialogs/delete_layer/delete_layer_view":109}],391:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/delete_row/delete_row_view");describe("common/dialogs/delete_row/delete_row_view",function(){beforeEach(function(){this.row=new cdb.admin.Row({cartodb_id:100,the_geom:JSON.stringify({type:"point",coordinates:[2,1]})}),this.table=TestUtil.createTable("test",[["the_geom","geometry"]]),this.table.data().add(this.row),spyOn(this.row,"destroy"),this.view=new d({table:this.table,row:this.row}),this.view.render()}),it("should render the view",function(){expect(this.innerHTML()).toContain("Ok, delete"),expect(this.innerHTML()).toContain("You are about to delete a row"),expect(this.innerHTML()).toContain("Are you sure you want to delete it?")}),describe("when click ok to delete row",function(){it("should call to destroy the model",function(){var a=sinon.fakeServer.create();a.respondWith("DELETE","/api/v1/tables/"+this.table.get("name")+"/records/100",[204,{"Content-Type":"application/json"},""]);var b=!1;this.table.bind("removing:row",function(){b=!0}),this.view.$(".ok").click(),a.respond(),expect(b).toBeTruthy()})}),afterEach(function(){this.view.clean()})})},{"../../../../../../javascripts/cartodb/common/dialogs/delete_row/delete_row_view":110}],392:[function(a,b,c){(function(b){var c=a("../../../../../javascripts/cartodb/common/dialogs/duplicate_dataset_view"),d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null;describe("common/dialogs/duplicate_dataset_view",function(){beforeEach(function(){this.table=new d.admin.CartoDBTableMetadata({id:"table_id",name:"table_name"}),this.user=jasmine.createSpy("cdb.admin.User"),spyOn(this.table,"duplicate"),this.view=new c({model:this.table,user:this.user}),this.view.render()}),it("should start the duplication process right away with creating an import",function(){expect(this.table.duplicate).toHaveBeenCalled(),expect(this.table.duplicate.calls.argsFor(0)[0]).toEqual("table_name_copy")}),it("should render the loading initially",function(){expect(this.innerHTML()).toContain("Duplicating your dataset")}),it("should render alternative title if creating from SQL",function(){spyOn(this.table,"isInSQLView").and.returnValue(!0),this.view.initialize(),this.view.render(),expect(this.innerHTML()).not.toContain("Duplicating your dataset"),expect(this.innerHTML()).toContain("Creating dataset from your query")}),describe("when duplication finishes successfully",function(){beforeEach(function(){var a=jasmine.createSpyObj("table",["viewUrl"]);a.viewUrl.and.returnValue("https://carto.com/user/pepe/table/my_table_copy"),spyOn(this.view,"_redirectTo"),this.table.duplicate.calls.argsFor(0)[1].success(a)}),it("should redirect to the new table's edit page",function(){expect(this.view._redirectTo).toHaveBeenCalledWith("https://carto.com/user/pepe/table/my_table_copy")})}),describe("when duplicates fails",function(){beforeEach(function(){this.table.duplicate.calls.argsFor(0)[1].error()}),it("should render the fail view",function(){expect(this.innerHTML()).toContain("Sorry, something went wrong")})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/dialogs/duplicate_dataset_view":111}],393:[function(a,b,c){(function(b){var c=a("../../../../../javascripts/cartodb/common/dialogs/duplicate_vis_view"),d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null;describe("common/dialogs/duplicate_vis_view",function(){beforeEach(function(){this.vis=new d.admin.Visualization({type:"derived",name:"my name"}),this.user=new d.admin.User({username:"pepe"}),spyOn(this.vis,"copy"),this.table=this.vis.tableMetadata(),this.view=new c({model:this.vis,table:this.table,user:this.user}),this.view.render()}),it("should start the duplication process right away",function(){expect(this.vis.copy).toHaveBeenCalled()}),it("should the name of the duplicate vis should be suffixed with copy",function(){expect(this.vis.copy.calls.argsFor(0)[0].name).toEqual("my name copy")}),it("should render the loading initially",function(){expect(this.innerHTML()).toContain("Duplicating your map")}),describe("when duplication successfully finished",function(){beforeEach(function(){this.newVis=new d.admin.Visualization({}),this.url=new d.common.MapUrl({base_url:"https://carto.com/user/pepe/viz/abc-123"}),spyOn(this.newVis,"viewUrl").and.returnValue(this.url),spyOn(this.view,"_redirectTo"),this.vis.copy.calls.argsFor(0)[1].success(this.newVis)}),it("should redirect to the edit url",function(){expect(this.view._redirectTo).toHaveBeenCalledWith(this.url.edit().toString()),expect(this.newVis.viewUrl).toHaveBeenCalledWith(this.user)})}),describe("when duplication fails with a general error",function(){beforeEach(function(){this.vis.copy.calls.argsFor(0)[1].error()}),it("should render a fail template",function(){expect(this.innerHTML()).toContain("Sorry, something went wrong")})}),describe("when duplication fails from import error",function(){beforeEach(function(){var a=new d.admin.Import({item_queue_id:"abc-123",error_code:8003,get_error_text:{title:"Error creating table from SQL query",what_about:"We could not create table from your query."}});this.vis.copy.calls.argsFor(0)[1].error(a)}),it("should render a the more detailed fail template",function(){expect(this.innerHTML()).toContain("Error creating table"),expect(this.innerHTML()).toContain("We could not create table from your query"),expect(this.innerHTML()).toContain("Persisting error?")})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/dialogs/duplicate_vis_view":112}],394:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../javascripts/cartodb/common/dialogs/edit_vis_metadata/edit_vis_metadata_dialog_view");describe("common/dialogs/edit_vis_metadata_dialog",function(){beforeEach(function(){this.vis=new c.admin.Visualization({type:"derived",name:"hello vis",description:"hello hello description",tags:["hello","hey","howdy"],privacy:"PUBLIC"}),this.dataLayer=new c.admin.CartoDBTableMetadata({name:"test"}),this.user=new c.admin.User({base_url:"http://paco.carto.com",username:"paco"}),this.initView=function(){this.view&&this.view.clean(),this.view=new d({user:this.user,dataLayer:this.dataLayer,vis:this.vis,clean_on_hide:!1}),this.model=this.view.model,this.view.render()},this.initView()}),it("should render properly",function(){expect(this.view.$(".js-content").length).toBe(1),expect(this.view.$(".js-form").length).toBe(1),expect(this.view._panes).toBeDefined(),expect(this.view._panes.size()).toBe(3)}),describe("model",function(){it("should generate a proper model",function(){expect(this.model.get("name")).toBe(this.vis.get("name")),expect(this.model.get("description")).toBe(this.vis.get("description")),expect(this.model.get("tags")).toBe(this.vis.get("tags")),expect(this.model.get("privacy")).toBe(this.vis.get("privacy"))}),it("should not have the datasets-only attrs",function(){expect(this.model.get("source")).toBeUndefined(),expect(this.model.get("attributions")).toBeUndefined(),expect(this.model.get("license")).toBeUndefined()}),describe("vis type derived",function(){it("should let edit name and rest of attributes when vis is derived",function(){expect(this.model.isNameEditable()).toBeTruthy(),expect(this.model.isMetadataEditable()).toBeTruthy()})}),describe("vis type table",function(){beforeEach(function(){this.vis.set({type:"table",name:"hello_dataset",source:"http://foobar.com",display_name:"Hello Dataset",attributions:"CC",license:"mit"}),this.initView()}),it("should have additional props on view model",function(){
expect(this.model.get("source")).toBe(this.vis.get("source")),expect(this.model.get("attributions")).toBe(this.vis.get("attributions")),expect(this.model.get("license")).toBe(this.vis.get("license")),expect(this.model.get("display_name")).toBe(this.vis.get("display_name"))}),it("should have additional props on view model with fallback values",function(){this.vis.unset("source"),this.vis.unset("attributions"),this.vis.unset("license"),this.vis.unset("display_name"),this.initView(),expect(this.model.get("source")).toEqual(""),expect(this.model.get("attributions")).toEqual(""),expect(this.model.get("license")).toEqual(""),expect(this.model.get("display_name")).toEqual("")}),it("should let edit name and rest of attributes when vis is table",function(){spyOn(this.dataLayer,"isInSQLView").and.returnValue(!1),spyOn(this.dataLayer,"isReadOnly").and.returnValue(!1),expect(this.model.isNameEditable()).toBeTruthy(),expect(this.model.isMetadataEditable()).toBeTruthy()}),it("shouldn't let edit name but it is possible to edit rest of attributes when dataLayer is synced",function(){spyOn(this.dataLayer,"isInSQLView").and.returnValue(!1),spyOn(this.dataLayer,"isReadOnly").and.returnValue(!0),expect(this.model.isNameEditable()).toBeFalsy(),expect(this.model.isMetadataEditable()).toBeTruthy()}),it("shouldn't let edit anything when table owner is different",function(){spyOn(this.dataLayer.permission,"isOwner").and.returnValue(!1),spyOn(this.dataLayer,"isInSQLView").and.returnValue(!1),spyOn(this.dataLayer,"isReadOnly").and.returnValue(!1),expect(this.model.isNameEditable()).toBeFalsy(),expect(this.model.isMetadataEditable()).toBeFalsy()})}),it("should send set an error when name is blank",function(){var a=!1;this.model.bind("error",function(){a=!0}),this.model.set("name",""),expect(this.model.getError()).toBe("Name can't be blank"),expect(a).toBeTruthy()}),it("should send a valid signal when attributes are valid",function(){var a=!1;this.model.bind("valid",function(){a=!0}),this.model.set("name",""),expect(this.model.getError()).toBe("Name can't be blank"),expect(a).toBeFalsy(),this.model.set("name","paco"),expect(a).toBeTruthy(),expect(this.model.getError()).toBe("")})}),describe("form view",function(){it("should render properly",function(){expect(this.view.$(".js-name").length).toBe(1),expect(this.view.$(".js-name").val()).toBe("hello vis"),expect(this.view.$(".js-description").length).toBe(1),expect(this.view.$(".js-description").val()).toBe("hello hello description"),expect(this.view.$(".js-tags").length).toBe(1),expect(this.view.$(".js-tagsList .tagit-choice").length).toBe(3),expect(this.view.$(".js-privacy").length).toBe(1),expect(this.view.$(".js-privacy").text()).toBe("public")}),it("should not render dataset-only fields",function(){expect(this.view.$(".js-license").length).toBe(0),expect(this.view.$(".js-source").length).toBe(0),expect(this.view.$(".js-attributions").length).toBe(0),expect(this.view.$(".js-displayName").length).toBe(0)}),describe("with table change",function(){beforeEach(function(){this.vis.set({type:"table",name:"hello_dataset",source:"http://foobar.com",attributions:"CC",licence:"mit",display_name:"Hello Dataset"}),this.initView()}),it("should let edit name and rest of attributes",function(){spyOn(this.dataLayer,"isInSQLView").and.returnValue(!1),spyOn(this.dataLayer,"isReadOnly").and.returnValue(!1),this.view.render(),expect(this.view.$(".js-source").length).toBe(1),expect(this.view.$(".js-source").val()).toBe("http://foobar.com"),expect(this.view.$(".js-attributions").length).toBe(1),expect(this.view.$(".js-attributions").val()).toBe("CC"),expect(this.view.$(".js-name").is("[readonly]")).toBeFalsy(),expect(this.view.$(".js-description").is("[readonly]")).toBeFalsy(),expect(this.view.$(".js-source").is("[readonly]")).toBeFalsy(),expect(this.view.$(".js-attributions").is("[readonly]")).toBeFalsy(),expect(this.view.$(".js-license").length).toBe(1),expect(this.view.$(".js-tags").hasClass("is-disabled")).toBeFalsy(),expect(this.view.$(".js-privacy").length).toBe(1)}),it("shouldn't let edit name but it is possible to edit rest of attributes when dataLayer is synced",function(){spyOn(this.dataLayer,"isInSQLView").and.returnValue(!1),spyOn(this.dataLayer,"isReadOnly").and.returnValue(!0),this.view.render(),expect(this.view.$(".js-name").is("[readonly]")).toBeTruthy(),expect(this.view.$(".js-description").is("[readonly]")).toBeFalsy(),expect(this.view.$(".js-source").is("[readonly]")).toBeFalsy(),expect(this.view.$(".js-attributions").is("[readonly]")).toBeFalsy(),expect(this.view.$(".js-tags").hasClass("is-disabled")).toBeFalsy(),expect(this.view.$(".js-privacy").length).toBe(1)}),it("shouldn't let edit anything when table owner is different",function(){spyOn(this.dataLayer.permission,"isOwner").and.returnValue(!1),spyOn(this.dataLayer,"isInSQLView").and.returnValue(!1),spyOn(this.dataLayer,"isReadOnly").and.returnValue(!1),this.view.render(),expect(this.view.$(".js-name").is("[readonly]")).toBeTruthy(),expect(this.view.$(".js-description").is("[readonly]")).toBeTruthy(),expect(this.view.$(".js-source").is("[readonly]")).toBeTruthy(),expect(this.view.$(".js-attributions").is("[readonly]")).toBeTruthy(),expect(this.view.$(".js-tags").hasClass("is-disabled")).toBeTruthy(),expect(this.view.$(".js-privacy").length).toBe(0)}),it("should render display name when user has data_library enabled",function(){spyOn(this.dataLayer.permission,"isOwner").and.returnValue(!0),spyOn(this.dataLayer,"isInSQLView").and.returnValue(!1),spyOn(this.dataLayer,"isReadOnly").and.returnValue(!1),this.view.render(),expect(this.view.$(".js-displayName").length).toBe(0),spyOn(this.user,"featureEnabled").and.returnValue(!0),this.view.render(),expect(this.view.$(".js-displayName").length).toBe(1)})})}),describe("saving state",function(){it("should not save if attributes have not changed",function(){var a=!1;this.vis.sync=function(b,c,d){a=!0},this.view._saveAttributes(),expect(a).toBeFalsy()}),it("should save if attributes have changed",function(){var a=!1;this.vis.sync=function(b,c,d){a=!0},this.model.set("tags",["hey","howdy"]),this.view._saveAttributes(),expect(a).toBeTruthy()}),it("should show loading when model is saving",function(){this.vis.sync=function(a,b,c){},this.model.set("description","paco"),this.view._saveAttributes(),expect(this.view._panes.activeTab).toBe("loading")}),it("should show error state when model save has failed",function(){this.vis.sync=function(a,b,c){c.error()},this.model.set("description","paco"),this.view._saveAttributes(),expect(this.view._panes.activeTab).toBe("error"),expect(this.vis.get("description")).not.toBe("paco")}),it("should hide the dialog when save worked",function(){spyOn(this.view,"hide"),this.vis.sync=function(a,b,c){c.success({})},this.model.set("description","paco"),this.view._saveAttributes(),expect(this.view.hide).toHaveBeenCalled()})}),it("should not have any leak",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/dialogs/edit_vis_metadata/edit_vis_metadata_dialog_view":115}],395:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/export/export_view");describe("common/dialogs/export/export_view",function(){var a;beforeEach(function(){a=new d({model:TestUtil.createTable(),api_key:"testapikey"})}),it("should contain username in export url",function(){a.dataGeoreferenced=!0,a.render();var b=a.$("form").attr("action");expect(b).toEqual("http://test.localhost.lan/api/v2/sql")}),it("should include api key if provided",function(){a.render(),spyOn(a,"_fetchGET"),a._fetch({format:"csv",api_key:"testapikey",filename:"test"},"select * from table"),expect(a._fetchGET).toHaveBeenCalled(),expect(a._fetchGET.calls.argsFor(0)[0].indexOf("api_key=testapikey")!==-1).toEqual(!0)})})},{"../../../../../../javascripts/cartodb/common/dialogs/export/export_view":116}],396:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/export_map/export_map_view");describe("common/dialogs/export/export_view",function(){var a;beforeEach(function(){a=new d({model:new cdb.admin.ExportMapModel({visualization_id:"abcd-1234"}),clean_on_hide:!0,enter_to_confirm:!0})}),it("should show confirmation",function(){a.render(),expect(a.$(".js-ok").text()).toContain("Ok, export")}),it("should show pending state loading window",function(){a.model.set("state","pending"),a.render(),expect(a.$(".CDB-Text").text()).toContain("Pending ...")}),it("should show exporting state loading window",function(){a.model.set("state","exporting"),a.render(),expect(a.$(".CDB-Text").text()).toContain("Exporting ...")}),it("should show uploading state loading window",function(){a.model.set("state","uploading"),a.render(),expect(a.$(".CDB-Text").text()).toContain("Uploading ...")})})},{"../../../../../../javascripts/cartodb/common/dialogs/export_map/export_map_view":117}],397:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../javascripts/cartodb/common/dialogs/feature_data/feature_data_dialog_view");describe("common/dialogs/feature_data_dialog",function(){beforeEach(function(){this.rowModel=new c.admin.Row({cartodb_id:1,test:"test",test1:1,test2:null,test3:null,the_geom:'{ "type": "Point", "coordinates": [100.0, 0.0] }'}),this.table=new c.admin.CartoDBTableMetadata({id:"testTable",name:"testTable",schema:[["cartodb_id","number"],["test","string"],["test1","number"],["test2","boolean"],["test3","date"],["the_geom","geometry"]],geometry_types:["ST_MultiPoint"]}),this.user=new c.admin.User({base_url:"http://paco.carto.com",username:"paco"}),this.view=new d({row:this.rowModel,provider:"leaflet",baseLayer:new c.geo.TileLayer({id:"baselayer_0"}),dataLayer:new c.admin.CartoDBLayer({id:"layer_0"}),currentZoom:8,enter_to_confirm:!1,table:this.table,user:this.user,clean_on_hide:!0}),this.view.render()}),it("should render properly",function(){expect(this.view.$(".js-map").length).toBe(1),expect(this.view.$(".js-form").length).toBe(1),expect(this.view.$(".js-addField").length).toBe(1),expect(this.view.$(".IntermediateInfo").length).toBe(2),expect(this.view.$(".Spinner").length).toBe(1),expect(this.view.$(".LayoutIcon.LayoutIcon--negative").length).toBe(1)}),it("should create panes and needed form",function(){expect(this.view._panes).not.toBeUndefined(),expect(_.size(this.view._panes._subviews)).toBe(3)}),describe("form view",function(){beforeEach(function(){this.form=this.view.form,this.firstFieldView=this.form._subviews[Object.keys(this.form._subviews)[1]]}),it("should render as many fields as row model has",function(){expect(this.form.collection.size(4)),expect(this.form.$(".Form-row").length).toBe(5),expect(this.form.$(".Form-row textarea").length).toBe(1),expect(this.form.$(".Form-row input.is-number").length).toBe(1),expect(this.form.$(".Form-row .RadioButton").length).toBe(3),expect(this.form.$(".Form-row .DatePicker").length).toBe(1),expect(this.form.$(".Form-row .TimeInput").length).toBe(1),expect(this.form.$(".EditField-select").length).toBe(4)}),describe("change column name",function(){beforeEach(function(){this.$columnNameInput=this.firstFieldView.$(".js-columnName")}),it("should change the name of the column if it is valid",function(){c.admin.Column.prototype.sync=function(a,b,d){d.success(new c.core.Model({_name:"paco"}),{_name:"paco"})},this.$columnNameInput.val("paco").focusout(),expect(this.$columnNameInput.val()).toBe("paco"),expect(this.$columnNameInput.hasClass("has-failed")).toBeFalsy()}),it("shouldn't change the name of the column if it is invalid",function(){c.admin.Column.prototype.sync=function(a,b,c){c.error('{"errors": ["this is an error"]}')},this.$columnNameInput.val("paco").focusout(),expect(this.firstFieldView.fieldModel.get("value")).toBe("test")})}),describe("change column type",function(){beforeEach(function(){this.$columnTypeSelect=this.firstFieldView.$(".select2-container")}),it("should change the type of the column if it works",function(){var a=this;c.admin.Column.prototype.sync=function(a,b,d){d.success(new c.core.Model({_name:"paco"}),{_name:"paco"})},spyOn(this.firstFieldView,"_refreshRecordData").and.returnValue(function(){a.firstFieldView.fieldModel.set("readOnly",!1)}),expect(this.firstFieldView.$("textarea").length).toBe(1),this.firstFieldView.fieldModel.set({value:null,type:"date"}),expect(this.firstFieldView.$("textarea").length).toBe(0),expect(this.firstFieldView.$(".DatePicker").length).toBe(1),expect(this.firstFieldView.$(".TimeInput").length).toBe(1)}),it("shouldn't change the column type if it fails",function(){var a=this;c.admin.Column.prototype.sync=function(a,b,c){c.error('{"errors": ["this is an error"]}')},spyOn(this.firstFieldView,"_refreshRecordData").and.returnValue(function(){a.firstFieldView.fieldModel.set("readOnly",!1)}),expect(this.firstFieldView.$("textarea").length).toBe(1),this.firstFieldView.fieldModel.set({value:null,type:"date"}),expect(this.firstFieldView.$("textarea").length).toBe(1),expect(this.firstFieldView.$(".DatePicker").length).toBe(0),expect(this.firstFieldView.$(".TimeInput").length).toBe(0)})}),describe("add column",function(){it("should add a column when link is clicked",function(){var a="";c.admin.Column.prototype.sync=function(b,c,d){a=c.get("_name"),d.success(c)},this.form.$(".js-addColumn").click(),expect(this.form.collection.size(5)),expect(this.form.$(".Form-row").length).toBe(6),expect(this.form.collection.last().get("attribute")).toBe(a),expect(this.form.collection.last().get("value")).toBeNull(),expect(this.form.collection.last().get("type")).toBe("string")}),it("should not add a new column when it fails",function(){c.admin.Column.prototype.sync=function(a,b,c){c.error()},this.form.$(".js-addColumn").click(),expect(this.form.collection.size(4)),expect(this.form.$(".Form-row").length).toBe(5),expect(this.form.$(".DefaultParagraph.DefaultParagraph--error").length).toBe(1),expect(this.form.$(".DefaultParagraph .js-addColumn").length).toBe(1)})})}),describe("saving state",function(){it("should not save if attributes have not changed",function(){var a=!1;this.rowModel.sync=function(b,c,d){a=!0},this.view._changeAttributes({}),expect(a).toBeFalsy()}),it("should save if attributes have changed",function(){var a=!1;this.rowModel.sync=function(b,c,d){a=!0},this.view._changeAttributes([{attribute:"test",value:"phew"}]),expect(a).toBeTruthy()}),it("should not unset reserved columns or model id if attributes have changed",function(){var a={};this.rowModel.save=function(b,c){a=b},this.view._changeAttributes([{attribute:"test",value:"phew"}]),expect(a.id).toBeUndefined(),expect(a.cartodb_id).toBeUndefined(),expect(a.the_geom).toBeUndefined(),expect(a.the_geom_webmercator).toBeUndefined(),expect(a.updated_at).toBeUndefined(),expect(a.created_at).toBeUndefined()}),it("should show loading when model is saving",function(){this.rowModel.sync=function(a,b,c){},this.view._changeAttributes([{attribute:"test",value:"paco"}]),expect(this.view._panes.activeTab).toBe("loading")}),it("should show error state when model save has failed",function(){this.rowModel.sync=function(a,b,c){c.error()},this.view._changeAttributes([{attribute:"test",value:"1"}]),expect(this.view._panes.activeTab).toBe("error"),expect(this.rowModel.get("test")).not.toBe("1")}),it("should trigger onDone when save worked",function(){var a=!1;this.view.options.onDone=function(){a=!0},this.rowModel.sync=function(a,b,c){c.success()},this.view._changeAttributes([{attribute:"test2",value:"lol"}]),expect(a).toBeTruthy()})}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/dialogs/feature_data/feature_data_dialog_view":119}],398:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/admin_regions_model"),e=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/geocode_stuff_model");describe("common/dialog/georeference/admin_regions_model",function(){beforeEach(function(){this.geocodeStuff=new e({tableName:"table_id"}),this.model=new d({geocodeStuff:this.geocodeStuff,columnsNames:["foo","lon","bar","lat"],columns:[["string","foo"],["number","lon"],["boolean","bar"],["number","lat"]]}),this.view=this.model.createView()}),it("should start on step 0",function(){expect(this.model.get("step")).toEqual(0)}),describe(".availableGeometriesFetchData",function(){beforeEach(function(){this.returnVal={};var a=this.model.get("rows").last();a.set("value","loc"),a.set("isFreeText",!0),spyOn(this.geocodeStuff,"availableGeometriesFetchData").and.returnValue(this.returnVal),this.results=this.model.availableGeometriesFetchData()}),it("should call the geocode stuff model with expected args",function(){expect(this.geocodeStuff.availableGeometriesFetchData).toHaveBeenCalled(),expect(this.geocodeStuff.availableGeometriesFetchData.calls.argsFor(0)[0]).toEqual("admin1"),expect(this.geocodeStuff.availableGeometriesFetchData.calls.argsFor(0)[1]).toEqual("loc"),expect(this.geocodeStuff.availableGeometriesFetchData.calls.argsFor(0)[2]).toEqual(!0),expect(this.results).toBe(this.returnVal)})}),describe(".continue",function(){describe("when have selected a column name",function(){beforeEach(function(){this.model.set("canContinue",!0),this.model.get("rows").first().set("value","col"),this.model.continue()}),it("should set the state for next step",function(){expect(this.model.get("step")).toEqual(1),expect(this.model.get("canContinue")).toBe(!1),expect(this.model.get("geometryType")).toEqual("")}),describe("when have selected a geometry type",function(){beforeEach(function(){this.model.set("geometryType","polygon"),this.model.continue()}),it("should set default geocode data",function(){var a=this.model.get("geocodeData");expect(a).toBeDefined(),expect(a.type).toEqual("admin"),expect(a.column_name).toEqual("col"),expect(a.geometry_type).toEqual("polygon")}),it("should set fallback values for location",function(){var a=this.model.get("geocodeData");expect(a.kind).toEqual("admin0"),expect(a.location).toEqual("world"),expect(a.text).toBe(!0)}),describe("when have set a location",function(){beforeEach(function(){this.model.get("rows").last().set("value","loc"),this.model.continue()}),it("should set custom location for geocode data",function(){var a=this.model.get("geocodeData");expect(a.kind).toEqual("admin1"),expect(a.location).toEqual("loc"),expect(a.text).toBeUndefined()})})})})})})},{"../../../../../../javascripts/cartodb/common/dialogs/georeference/admin_regions_model":123,"../../../../../../javascripts/cartodb/common/dialogs/georeference/geocode_stuff_model":127}],399:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,e=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/choose_geometry_view");describe("common/dialog/georeference/choose_geometry_view",function(){beforeEach(function(){this.fetchData={},this.model=new d.core.Model,this.model.availableGeometriesFetchData=jasmine.createSpy("availableGeometriesFetchData").and.returnValue(this.fetchData),this.model.continue=jasmine.createSpy("continue"),spyOn(d.admin.Geocodings.AvailableGeometries.prototype,"fetch"),this.view=new e({model:this.model}),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should render the loading screen",function(){expect(this.innerHTML()).toContain("Checking")}),it("should fetch available geometries",function(){expect(d.admin.Geocodings.AvailableGeometries.prototype.fetch).toHaveBeenCalled(),expect(d.admin.Geocodings.AvailableGeometries.prototype.fetch.calls.argsFor(0)[0].data).toBe(this.fetchData)}),describe("when available geometries are fetched",function(){beforeEach(function(){this.view.availableGeometries.set("available_geometries",["point","polygon"])}),it("should render the available geometries",function(){expect(this.innerHTML()).not.toContain("Checking"),expect(this.innerHTML()).toContain("point"),expect(this.innerHTML()).toContain("administrative region")}),describe("when selected a geometry",function(){beforeEach(function(){c(this.view.$(".OptionCard").first()).click()}),it("should set the selected geometry type on the model",function(){expect(this.model.get("geometryType")).toEqual("point"),expect(this.view.$(".is-selected").length).toEqual(1)}),it("should call continue on the model",function(){expect(this.model.continue).toHaveBeenCalled()})})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/georeference/choose_geometry_view":124}],400:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/city_names_model"),e=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/geocode_stuff_model");describe("common/dialog/georeference/city_names_model",function(){beforeEach(function(){this.geocodeStuff=new e({tableName:"table_id"}),this.model=new d({geocodeStuff:this.geocodeStuff,columnsNames:["foo","lon","bar","lat"],columns:[["string","foo"],["number","lon"],["boolean","bar"],["number","lat"]]}),this.view=this.model.createView()}),it("should start on step 0",function(){expect(this.model.get("step")).toEqual(0)}),describe(".availableGeometriesFetchData",function(){beforeEach(function(){this.returnVal={};var a=this.model._location();a.set("value","loc"),a.set("isFreeText",!0),spyOn(this.geocodeStuff,"availableGeometriesFetchData").and.returnValue(this.returnVal),this.results=this.model.availableGeometriesFetchData()}),it("should call the geocode stuff model with expected args",function(){expect(this.geocodeStuff.availableGeometriesFetchData).toHaveBeenCalled(),expect(this.geocodeStuff.availableGeometriesFetchData.calls.argsFor(0)[0]).toEqual("namedplace"),expect(this.geocodeStuff.availableGeometriesFetchData.calls.argsFor(0)[1]).toEqual("loc"),expect(this.geocodeStuff.availableGeometriesFetchData.calls.argsFor(0)[2]).toEqual(!0),expect(this.results).toBe(this.returnVal)})}),describe(".continue",function(){describe("when have selected a city column name",function(){beforeEach(function(){this.model.set("canContinue",!0),this.model.get("rows").first().set("value","col"),this.model.continue()}),it("should set the state for next step",function(){expect(this.model.get("step")).toEqual(1),expect(this.model.get("canContinue")).toBe(!1),expect(this.model.get("geometryType")).toEqual("")}),describe("when have selected a geometry type",function(){beforeEach(function(){this.model.set({canContinue:!0,geometryType:"point"}),this.model.get("rows").first().set("value","col"),this.model.continue()}),it("should set geocode data",function(){var a=this.model.get("geocodeData");expect(a).toBeDefined(),expect(a.type).toEqual("city"),expect(a.kind).toEqual("namedplace"),expect(a.column_name).toEqual("col"),expect(a.geometry_type).toEqual("point")}),it("should set default location",function(){var a=this.model.get("geocodeData");expect(a.location).toEqual("world"),expect(a.text).toBe(!0)}),it("should not set geocode data with optional stuff",function(){var a=this.model.get("geocodeData");expect(a.region).toBeUndefined(),expect(a.region_text).toBeUndefined()}),describe("when have also set a custom location and region",function(){beforeEach(function(){this.model._location().set("value","loc"),this.model._region().set("value","val")}),it("should set geocode data with region",function(){this.model.continue();var a=this.model.get("geocodeData");expect(a.text).toBeUndefined(),expect(a.location).toEqual("loc"),expect(a.region).toEqual("val"),expect(a.region_text).toBeFalsy(),this.model._region().set("isFreeText",!0),this.model.continue(),a=this.model.get("geocodeData"),expect(a.location).toEqual("loc"),expect(a.text).toBeUndefined(),expect(a.region).toEqual("val"),expect(a.region_text).toBe(!0)})})})})})})},{"../../../../../../javascripts/cartodb/common/dialogs/georeference/city_names_model":125,"../../../../../../javascripts/cartodb/common/dialogs/georeference/geocode_stuff_model":127}],401:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/default_footer_view"),e=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/geocode_stuff_model");describe("common/dialog/georeference/default_footer_view",function(){beforeEach(function(){this.geocodeStuff=new e({tableName:"foobar"}),this.model=new c.core.Model({geocodeStuff:this.geocodeStuff}),this.model.continue=jasmine.createSpy("continue"),this.view=new d({model:this.model}),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),describe("when canContinue changes",function(){it("should update the disabled state on the continue button",function(){this.model.set("canContinue",!0),expect(this.view.$(".ok").hasClass("is-disabled")).toBe(!1),this.model.set("canContinue",!1),expect(this.view.$(".ok").hasClass("is-disabled")).toBe(!0)})}),describe("when hideFooter is changed",function(){it("should hide or show footer",function(){expect(this.view.$el.attr("style")).not.toContain("none"),this.model.set("hideFooter",!0),expect(this.view.$el.attr("style")).toContain("none"),this.model.set("hideFooter",!1),expect(this.view.$el.attr("style")).not.toContain("none")})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/georeference/default_footer_view":126,"../../../../../../javascripts/cartodb/common/dialogs/georeference/geocode_stuff_model":127}],402:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null,d=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/geocode_stuff_model");describe("common/dialog/georeference/geocode_stuff_model",function(){beforeEach(function(){this.geocodeStuff=new d({tableName:"table_name"})}),describe(".isLocationWorld",function(){it("should return true or false depending on given location and if it is a free text value",function(){expect(this.geocodeStuff.isLocationWorld("")).toBe(!0),expect(this.geocodeStuff.isLocationWorld()).toBe(!1),expect(this.geocodeStuff.isLocationWorld("some world we live in",!0)).toBe(!0),expect(this.geocodeStuff.isLocationWorld("some_column")).toBe(!1),expect(this.geocodeStuff.isLocationWorld("some_column",!0)).toBe(!1),expect(this.geocodeStuff.isLocationWorld("some_column",!1)).toBe(!1)})}),describe(".availableGeometriesFetchData",function(){it("should return a object hash with expected props based on given input",function(){expect(this.geocodeStuff.availableGeometriesFetchData("kind")).toEqual(jasmine.objectContaining({kind:"kind",free_text:"World"})),expect(this.geocodeStuff.availableGeometriesFetchData("kind","othercol",!0)).toEqual(jasmine.objectContaining({kind:"kind",free_text:"othercol"}));var a={kind:"kind",column_name:"othercol",table_name:"table_name"};expect(this.geocodeStuff.availableGeometriesFetchData("kind","othercol")).toEqual(jasmine.objectContaining(a)),expect(this.geocodeStuff.availableGeometriesFetchData("kind","othercol",!1)).toEqual(jasmine.objectContaining(a))})}),describe(".geocodingChosenData",function(){beforeEach(function(){this.requiredData={kind:"kind",type:"type",column_name:"colname"}}),it("should return an object hash with expected data",function(){expect(this.geocodeStuff.geocodingChosenData(this.requiredData)).toEqual({table_name:"table_name",kind:"kind",type:"type",column_name:"colname"});var a=this.geocodeStuff.geocodingChosenData({type:"lonlat",longitude:"lon",latitude:"lat"});expect(a).toEqual({table_name:"table_name",type:"lonlat",longitude:"lon",latitude:"lat"}),expect(a.force_all_rows).toBeUndefined()}),describe("when location is a non-world value",function(){it("should return an object that contains the free text location",function(){expect(this.geocodeStuff.geocodingChosenData(c.extend({},this.requiredData,{location:"othercol"}),!0)).toEqual(jasmine.objectContaining({location:"othercol",text:!0}))})}),describe("when forceAllRows is set",function(){beforeEach(function(){this.geocodeStuff.set("forceAllRows",!0)}),it("should set force_all_rows to true",function(){var a=this.geocodeStuff.geocodingChosenData(this.requiredData);expect(a).toEqual(jasmine.objectContaining({force_all_rows:!0}))})})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/georeference/geocode_stuff_model":127}],403:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/georeference_model"),e=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/user_geocoding_model");describe("common/dialog/georeference/georeference_model",function(){beforeEach(function(){this.table=TestUtil.createTable("a",[["cartodb_id","string"],["the_geom","geometry"],["other_geom","geometry"],["lon","number"],["lat","number"],["cartodb_georef_status","string"],["foobar","boolean"],["updated_at","date"],["created_at","date"]]),this.user=new c.admin.User({base_url:"http://pepe.carto.com",actions:{},geocoding:{foo:"bar"}}),this.attrs={table:this.table,user:this.user},spyOn(e.prototype,"initialize").and.callThrough(),spyOn(e.prototype,"hasQuota").and.returnValue(!0),spyOn(e.prototype,"hasReachedMonthlyQuota").and.returnValue(!1),this.model=new d(this.attrs)}),it("should selected 1st lon/lat tab",function(){var a=this.model.get("options"),b=a.where({selected:!0});expect(b.length).toEqual(1),expect(b[0]).toBe(a.first())}),describe("when georef_disabled is set for user",function(){beforeEach(function(){this.user.set("feature_flags",["georef_disabled"]),this.model.initialize(this.attrs)}),it("should disabled all items except 1st tab (lon/lat)",function(){var a=this.model.get("options"),b=a.filter(function(a){return a.get("disabled")});expect(b.length).toEqual(a.length-1),expect(b[0]).not.toBe(a.first())})}),it("should check user geocoding",function(){expect(e.prototype.initialize).toHaveBeenCalled(),expect(e.prototype.initialize).toHaveBeenCalledWith(jasmine.objectContaining({foo:"bar"}))}),it("should disable street addr tab under some circumstances",function(){var a=function(){this.model.initialize(this.attrs);var a=this.model.get("options").last().get("disabled");expect(a).toBeTruthy(),expect(a).toEqual(jasmine.any(String))};e.prototype.hasQuota.calls.reset(),e.prototype.hasQuota.and.returnValue(!1),a.call(this),this.user.get("actions").google_maps_enabled=!0,this.user.get("actions").google_maps_geocoder_enabled=!1,a.call(this),this.user.get("actions").google_maps_enabled=!1,this.user.get("actions").google_maps_geocoder_enabled=!0,a.call(this)}),describe("when user has google maps enabled",function(){beforeEach(function(){this.user.get("actions").google_maps_enabled=!0,this.user.get("actions").google_maps_geocoder_enabled=!0,e.prototype.hasReachedMonthlyQuota.calls.reset(),e.prototype.hasQuota.calls.reset(),this.model.initialize(this.attrs)}),it("should not check any geocoding limits",function(){expect(e.prototype.hasReachedMonthlyQuota).not.toHaveBeenCalled(),expect(e.prototype.hasQuota).not.toHaveBeenCalled()})}),describe(".continue",function(){beforeEach(function(){this.selectedTabModel=this.model.get("options").first(),spyOn(this.selectedTabModel,"continue"),
this.model.continue()}),it("should call continue on the currently selected tab model",function(){expect(this.selectedTabModel.continue).not.toHaveBeenCalled(),this.selectedTabModel.set("canContinue",!0),this.model.continue(),expect(this.selectedTabModel.continue).toHaveBeenCalled()})}),describe("._columnsNames",function(){beforeEach(function(){this.results=this.model._columnsNames()}),it("should return an array with only valid column names to be selectable in UI",function(){expect(this.results).toEqual(["other_geom","lon","lat","foobar"])})}),describe("._filteredColumns",function(){beforeEach(function(){this.results=this.model._filteredColumns()}),it("should return an array with only valid column names to be selectable in UI",function(){expect(this.results).toEqual([["number","lon"],["number","lat"],["boolean","foobar"]])})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/georeference/georeference_model":129,"../../../../../../javascripts/cartodb/common/dialogs/georeference/user_geocoding_model":145}],404:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,e=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/georeference_view");describe("common/dialog/georeference/georeference_view",function(){beforeEach(function(){this.table=TestUtil.createTable("a",[["cartodb_id","string"],["the_geom","geometry"],["lon","number"],["lat","number"],["cartodb_georef_status","string"],["foobar","boolean"],["updated_at","date"],["created_at","date"]]),this.user=new c.admin.User({actions:{},base_url:"http://pepe.carto.com"}),this.view=new e({table:this.table,user:this.user}),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should render the different tabs",function(){expect(this.innerHTML()).toContain("Lon/Lat Columns"),expect(this.innerHTML()).toContain("City Names"),expect(this.innerHTML()).toContain("Admin. Regions"),expect(this.innerHTML()).toContain("Postal Codes"),expect(this.innerHTML()).toContain("IP Addresses"),expect(this.innerHTML()).toContain("Street Addresses")}),it("should start on the lon/lat column",function(){var a=this.view.$(".js-tabs .is-selected");expect(a.length).toEqual(1),expect(a[0].innerHTML).toContain("Lon/Lat"),expect(this.innerHTML()).toContain("Latitude")}),it("should not render the flash message about table not been geocoded yet",function(){expect(this.innerHTML()).not.toContain("FlashMessage")}),describe("when selecting another tab",function(){beforeEach(function(){d(this.view.$(".js-tabs button").get(1)).click()}),it("should unselect current item and select the new one",function(){var a=this.view.$(".js-tabs .is-selected");expect(a.length).toEqual(1),expect(a[0].innerHTML).toContain("City")}),it("should change the content",function(){expect(this.innerHTML()).not.toContain("Latitude")})}),describe("when clicking continue",function(){beforeEach(function(){spyOn(this.view.model,"continue"),this.view.$(".ok").click()}),it("should call continue on the model",function(){expect(this.view.model.continue).toHaveBeenCalled()})}),describe("when geocodeData changes on a tab model",function(){beforeEach(function(){spyOn(this.view,"close"),this.geocodingChosenSpy=jasmine.createSpy("geocodingChosen"),c.god.bind("geocodingChosen",this.geocodingChosenSpy),this.geocodeData={foobar:"baz!"},this.view.model.get("options").first().set("geocodeData",this.geocodeData)}),it("should trigger geocodingChosen event with the data set",function(){expect(this.geocodingChosenSpy).toHaveBeenCalled(),expect(this.geocodingChosenSpy.calls.argsFor(0)[0]).toEqual(this.geocodeData)}),it("should hide the view",function(){expect(this.view.close).toHaveBeenCalled(),expect(this.view.options.clean_on_hide).toBe(!0)})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/georeference/georeference_view":130}],405:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/ip_addresses_model"),e=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/geocode_stuff_model");describe("common/dialog/georeference/ip_addresses_model",function(){beforeEach(function(){this.geocodeStuff=new e({tableName:"table_id"}),this.model=new d({geocodeStuff:this.geocodeStuff,columnsNames:["foo","lon","bar","lat"]}),this.view=this.model.createView()}),describe(".continue",function(){beforeEach(function(){this.model.set("canContinue",!0),this.model.get("rows").first().set("value","col"),this.model.continue(),this.geocodeData=this.model.get("geocodeData")}),it("should set the geocodeData directly",function(){expect(this.geocodeData.type).toEqual("ip"),expect(this.geocodeData.column_name).toEqual("col"),expect(this.geocodeData.kind).toEqual("ipaddress"),expect(this.geocodeData.geometry_type).toEqual("point"),expect(this.geocodeData.location).toBeUndefined(),expect(this.geocodeData.text).toBeUndefined()})})})},{"../../../../../../javascripts/cartodb/common/dialogs/georeference/geocode_stuff_model":127,"../../../../../../javascripts/cartodb/common/dialogs/georeference/ip_addresses_model":131}],406:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/lon_lat_columns_model"),e=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/geocode_stuff_model");describe("common/dialog/georeference/lon_lat_columns_model",function(){beforeEach(function(){this.geocodeStuff=new e({tableName:"table_id"}),this.model=new d({geocodeStuff:this.geocodeStuff,columnsNames:["foo","lon","bar","lat"]}),this.view=this.model.createView()}),describe(".assertIfCanContinue",function(){it("should return true when all rows has a value",function(){this.model.assertIfCanContinue(),expect(this.model.get("canContinue")).toBe(!1);var a=this.model.get("rows");a.first().set("value","lon"),this.model.assertIfCanContinue(),expect(this.model.get("canContinue")).toBe(!1),a.last().set("value","lat"),this.model.assertIfCanContinue(),expect(this.model.get("canContinue")).toBe(!0)})}),describe(".continue",function(){beforeEach(function(){var a=this.model.get("rows");a.first().set("value","lon1"),a.last().set("value","lat2"),this.model.continue(),this.geocodeData=this.model.get("geocodeData")}),it("should set the geocodeData directly",function(){expect(this.geocodeData.type).toEqual("lonlat"),expect(this.geocodeData.longitude).toEqual("lon1"),expect(this.geocodeData.latitude).toEqual("lat2"),expect(this.geocodeData.location).toBeUndefined(),expect(this.geocodeData.text).toBeUndefined()})})})},{"../../../../../../javascripts/cartodb/common/dialogs/georeference/geocode_stuff_model":127,"../../../../../../javascripts/cartodb/common/dialogs/georeference/lon_lat_columns_model":132}],407:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/postal_codes_model"),e=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/geocode_stuff_model");describe("common/dialog/georeference/postal_codes_model",function(){beforeEach(function(){this.geocodeStuff=new e({tableName:"table_id"}),this.model=new d({geocodeStuff:this.geocodeStuff,columnsNames:["foo","lon","bar","lat"],columns:[["string","foo"],["number","lon"],["boolean","bar"],["number","lat"]]}),this.view=this.model.createView()}),it("should start on step 0",function(){expect(this.model.get("step")).toEqual(0)}),describe(".availableGeometriesFetchData",function(){beforeEach(function(){this.returnVal={};var a=this.model._location();a.set("value","loc"),a.set("isFreeText",!0),spyOn(this.geocodeStuff,"availableGeometriesFetchData").and.returnValue(this.returnVal),this.results=this.model.availableGeometriesFetchData()}),it("should call the geocode stuff model with expected args",function(){expect(this.geocodeStuff.availableGeometriesFetchData).toHaveBeenCalled(),expect(this.geocodeStuff.availableGeometriesFetchData.calls.argsFor(0)[0]).toEqual("postalcode"),expect(this.geocodeStuff.availableGeometriesFetchData.calls.argsFor(0)[1]).toEqual("loc"),expect(this.geocodeStuff.availableGeometriesFetchData.calls.argsFor(0)[2]).toEqual(!0),expect(this.results).toBe(this.returnVal)})}),describe(".continue",function(){describe("when have selected a column name",function(){beforeEach(function(){this.model.set("canContinue",!0),this.model.get("rows").first().set("value","col"),this.model.continue()}),it("should set the state for next step",function(){expect(this.model.get("step")).toEqual(1),expect(this.model.get("canContinue")).toBe(!1),expect(this.model.get("geometryType")).toEqual("")}),describe("when have selected a geometry type",function(){beforeEach(function(){this.model.set({canContinue:!0,geometryType:"polygon"}),this.model.get("rows").first().set("value","col"),this.model.continue()}),it("should set geocode data",function(){var a=this.model.get("geocodeData");expect(a).toBeDefined(),expect(a.type).toEqual("postal"),expect(a.kind).toEqual("postalcode"),expect(a.column_name).toEqual("col"),expect(a.geometry_type).toEqual("polygon")}),it("should set fallback value for location",function(){var a=this.model.get("geocodeData");expect(a.location).toEqual("world"),expect(a.text).toBe(!0)}),describe("when have set custom location",function(){beforeEach(function(){this.model._location().set("value","loc"),this.model.continue()}),it("should set custom location value in geocode data",function(){var a=this.model.get("geocodeData");expect(a.location).toEqual("loc"),expect(a.text).toBeUndefined()})})})})})})},{"../../../../../../javascripts/cartodb/common/dialogs/georeference/geocode_stuff_model":127,"../../../../../../javascripts/cartodb/common/dialogs/georeference/postal_codes_model":133}],408:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d="undefined"!=typeof window?window.Backbone:"undefined"!=typeof b?b.Backbone:null,e=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/steps_view"),f=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/row_model");describe("common/dialog/georeference/steps_view",function(){beforeEach(function(){this.rows=new d.Collection([new f({label:"Test label"})]),this.model=new c.core.Model({rows:this.rows}),this.model.availableGeometriesFetchData=jasmine.createSpy("availableGeometriesFetchData"),this.view=new e({title:"my title",desc:"my desc",model:this.model}),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should render the rows",function(){expect(this.innerHTML()).toContain("input"),expect(this.innerHTML()).toContain("Test label")}),it("should render title and desc",function(){expect(this.innerHTML()).toContain("my title"),expect(this.innerHTML()).toContain("my desc")}),describe("when changing step",function(){beforeEach(function(){this.model.set("step",1)}),it("should render view to choose geometry method",function(){expect(this.innerHTML()).toContain("available geometries"),expect(this.innerHTML()).not.toContain("the title")}),it("should not render title and desc",function(){expect(this.innerHTML()).not.toContain("my title"),expect(this.innerHTML()).not.toContain("my desc")})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/georeference/row_model":134,"../../../../../../javascripts/cartodb/common/dialogs/georeference/steps_view":137}],409:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../../javascripts/cartodb/common/dialogs/georeference/street_addresses/estimation_view"),e=a("../../../../../../../javascripts/cartodb/common/dialogs/georeference/user_geocoding_model");describe("common/dialog/georeference/street_addresses/estimation_view",function(){beforeEach(function(){this.model=new c.admin.Geocodings.Estimation,this.userGeocoding=new e({quota:1234,block_price:1e3,monthly_use:0,hard_limit:!1}),this.view=new d({model:this.model,userGeocoding:this.userGeocoding,hasHardLimit:!1}),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should render text about estimating cost",function(){expect(this.innerHTML()).toContain("Estimating possible cost")}),describe("when has an estimation",function(){beforeEach(function(){this.model.set({estimation:1234,rows:101})}),it("should show estimated price",function(){expect(this.innerHTML()).toContain("$13"),expect(this.innerHTML()).toContain("1234 extra credits")}),it("should show block price",function(){expect(this.innerHTML()).toContain("$10/1,000 credits")}),describe("when estimated price is 0",function(){beforeEach(function(){this.model.set("estimation",0)}),it("should state that the geocoding operation has no cost",function(){expect(this.innerHTML()).toContain("will have no cost"),expect(this.innerHTML()).not.toContain("But")}),it("should state soft limit cost",function(){expect(this.innerHTML()).toContain("$10/1,000 credits")}),it("should state that there is nothing to geocode if has no rows",function(){this.model.set("rows",0),expect(this.innerHTML()).toContain("No rows will be geocoded")})}),describe("when hard limit is set",function(){beforeEach(function(){this.view.options.hasHardLimit=!0,this.view.render()}),it("should state that the geocoding operation has no cost",function(){expect(this.innerHTML()).toContain("will have no cost for you"),expect(this.innerHTML()).toContain("But"),expect(this.innerHTML()).not.toContain("$10/1,000 credits")}),it("should state that there is nothing to geocode if has no rows",function(){this.model.set("rows",0),expect(this.innerHTML()).toContain("No rows will be geocoded")})}),describe("when estimation price is unknown",function(){beforeEach(function(){this.model.set("estimation",null)}),it("should state that could not estimate price",function(){expect(this.innerHTML()).toContain("problem estimating cost")})})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/georeference/street_addresses/estimation_view":138,"../../../../../../../javascripts/cartodb/common/dialogs/georeference/user_geocoding_model":145}],410:[function(a,b,c){var d=a("../../../../../../../javascripts/cartodb/common/dialogs/georeference/street_addresses/quota_view"),e=a("../../../../../../../javascripts/cartodb/common/dialogs/georeference/user_geocoding_model");describe("common/dialog/georeference/street_addresses/quota_view",function(){beforeEach(function(){this.model=new e({quota:2250,monthly_use:1e3}),this.view=new d({model:this.model}),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should show the credits left",function(){expect(this.innerHTML()).toContain("1,250 credits left")}),it("should a progress bar",function(){expect(this.innerHTML()).toContain("width: 44")}),afterEach(function(){this.view.clean()})})},{"../../../../../../../javascripts/cartodb/common/dialogs/georeference/street_addresses/quota_view":139,"../../../../../../../javascripts/cartodb/common/dialogs/georeference/user_geocoding_model":145}],411:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("moment"),e=a("../../../../../../../javascripts/cartodb/common/dialogs/georeference/street_addresses/street_addresses_model"),f=a("../../../../../../../javascripts/cartodb/common/dialogs/georeference/geocode_stuff_model"),g=a("../../../../../../../javascripts/cartodb/common/dialogs/georeference/user_geocoding_model");describe("common/dialog/georeference/street_addresses/street_addresses_model",function(){beforeEach(function(){this.geocodeStuff=new f({tableName:"table_id"}),this.userGeocoding=new g,this.model=new e({geocodeStuff:this.geocodeStuff,isGoogleMapsUser:!1,userGeocoding:this.userGeocoding,estimation:new c.admin.Geocodings.Estimation,lastBillingDate:"2015-07-08",columns:[["string","foo"],["number","lon"],["boolean","bar"],["number","lat"]]})}),describe(".daysLeftToNextBilling",function(){beforeEach(function(){var a=d();this.model.set("lastBillingDate",a)}),it("should return the days left to next billing period",function(){expect(this.model.daysLeftToNextBilling()).toEqual(30)})}),describe(".isDisabled",function(){it("should return true if not gmaps user and has reached monthly quota",function(){expect(this.model.isDisabled()).toBe(!1),spyOn(this.userGeocoding,"hasReachedMonthlyQuota").and.returnValue(!0),expect(this.model.isDisabled()).toBe(!0),this.model.set("isGoogleMapsUser",!0),expect(this.model.isDisabled()).toBe(!1)})}),describe(".showCostsInfo",function(){it("should return true as long as user is not a gmaps user",function(){expect(this.model.showCostsInfo()).toBe(!0),this.model.set("isGoogleMapsUser",!0),expect(this.model.showCostsInfo()).toBe(!1)})}),describe(".continue",function(){beforeEach(function(){this.model.set({type:"address",kind:"high-resolution",formatter:"search for something"}),this.expectDesiredGeocodeData=function(){var a=this.model.get("geocodeData");expect(a.type).toEqual("address"),expect(a.kind).toEqual("high-resolution"),expect(a.formatter).toEqual("search for something"),expect(a.location).toBeUndefined(),expect(a.text).toBeUndefined()}}),describe("when do not have to agree to terms-of-service",function(){beforeEach(function(){this.model.set("mustAgreeToTOS",!1),this.model.continue()}),it("should set the geocodeData directly",function(){this.expectDesiredGeocodeData()})}),describe("when must agree to terms-of-service",function(){beforeEach(function(){expect(this.model.get("confirmTOS")).toBeFalsy(),this.model.set("mustAgreeToTOS",!0),this.model.continue()}),it("should set that the user must agree terms-of-service first",function(){expect(this.model.get("confirmTOS")).toBe(!0),expect(this.model.get("geocodeData")).toBeUndefined()}),describe("when user agreed to terms-of-service",function(){beforeEach(function(){expect(this.model.get("hasAgreedToTOS")).toBeFalsy(),this.model.set("hasAgreedToTOS",!0),this.model.continue()}),it("should set the geocodeData",function(){this.expectDesiredGeocodeData()})})})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/georeference/geocode_stuff_model":127,"../../../../../../../javascripts/cartodb/common/dialogs/georeference/street_addresses/street_addresses_model":140,"../../../../../../../javascripts/cartodb/common/dialogs/georeference/user_geocoding_model":145,moment:531}],412:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../../javascripts/cartodb/common/dialogs/georeference/street_addresses/street_addresses_model"),e=a("../../../../../../../javascripts/cartodb/common/dialogs/georeference/geocode_stuff_model"),f=a("../../../../../../../javascripts/cartodb/common/view_factory"),g=a("../../../../../../../javascripts/cartodb/common/dialogs/georeference/user_geocoding_model");describe("common/dialog/georeference/street_addresses/street_addresses_view",function(){beforeEach(function(){this.geocodeStuff=new e({tableName:"table_id"}),this.estimation=new c.admin.Geocodings.Estimation,this.model=new d({geocodeStuff:this.geocodeStuff,isGoogleMapsUser:!1,userGeocoding:new g,estimation:this.estimation,lastBillingDate:"2015-07-08",columns:[["string","foo"],["number","lon"],["boolean","bar"],["number","lat"]]}),this.view=this.model.createView(),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),describe("when forceAllRows changes",function(){beforeEach(function(){spyOn(this.estimation,"fetch"),spyOn(this.model,"showCostsInfo")}),it("should re-fetch estimation but only if showing costs info",function(){this.model.showCostsInfo.and.returnValue(!0),this.geocodeStuff.set("forceAllRows",!this.geocodeStuff.set("forceAllRows")),expect(this.estimation.fetch).toHaveBeenCalled(),this.estimation.fetch.calls.reset(),this.model.showCostsInfo.calls.reset(),this.model.showCostsInfo.and.returnValue(!1),this.geocodeStuff.set("forceAllRows",!this.geocodeStuff.set("forceAllRows")),expect(this.estimation.fetch).not.toHaveBeenCalled()})}),describe("when rows changes",function(){describe("when no rows have any value",function(){it("should set formatter to an empty string or undefined",function(){expect(this.model.get("formatter")).toBeFalsy()}),it("should not be able to continue just yet",function(){expect(this.model.get("canContinue")).toBe(!1)})}),describe("when at least one row has an value",function(){beforeEach(function(){this.model.get("rows").first().set("value","col")}),it("should set formatter to to the value",function(){expect(this.model.get("formatter")).toEqual("{col}")}),it("should be able to continue",function(){expect(this.model.get("canContinue")).toBe(!0)}),describe("when a row has a free text value",function(){beforeEach(function(){this.model.get("rows").last().set({value:" foo bar   ",isFreeText:!0})}),it("should set formatter as a comma separated list with the free text value trimmed",function(){expect(this.model.get("formatter")).toEqual("{col}, foo bar")}),it("should still be able to continue",function(){expect(this.model.get("canContinue")).toBe(!0)})})})}),describe("when add-another-row button is clicked",function(){beforeEach(function(){this.view.$el.appendTo(document.body),this.view.$(".js-add-row").click()}),it("should add another street row",function(){expect(this.innerHTML()).toContain("Additional information to complete street address")}),it("should render one add-more button only",function(){expect(this.view.$(".js-add-row:hidden").length).toEqual(1),expect(this.view.$(".js-add-row:visible").length).toEqual(1)}),it("should hide add-more after 2nd click (since only allow 2)",function(){this.view.$(".js-add-row:visible").click(),expect(this.view.$(".js-add-row:visible").length).toEqual(0),expect(this.view.$(".js-add-row:hidden").length).toEqual(3)})}),describe("when estimation is changed",function(){beforeEach(function(){this.triggerAnyEvent=function(){this.model.get("estimation").trigger("all")}}),it("should not have to agree to terms-of-service if there is no cost for georeference task",function(){this.model.get("userGeocoding").set("hard_limit",!0),this.triggerAnyEvent(),expect(this.model.get("mustAgreeToTOS")).toBe(!1),this.model.get("userGeocoding").set("hard_limit",!1),this.model.get("estimation").set("estimation",0),expect(this.model.get("mustAgreeToTOS")).toBe(!1)}),it("should have to agree to terms-of-service if there might be a charge",function(){this.model.get("estimation").set("estimation",123),expect(this.model.get("mustAgreeToTOS")).toBe(!0),this.model.get("estimation").set("estimation",void 0),expect(this.model.get("mustAgreeToTOS")).toBe(!0)}),describe("when estimation is not known and hard limit is false",function(){beforeEach(function(){this.model.get("userGeocoding").set("hard_limit",!1),this.model.get("estimation").set("estimation",void 0)}),it("should require user to agree to terms-of-service",function(){expect(this.model.get("hasAgreedToTOS")).toBe(!1)})})}),describe("when confirm TOS is changed",function(){beforeEach(function(){var a=f.createDialogByTemplate,b=this;spyOn(f,"createDialogByTemplate").and.callFake(function(){var c=a.apply(f,arguments);return b.dlg=c,c}),spyOn(this.view,"addView")}),describe("when set to false",function(){beforeEach(function(){this.model.set("confirmTOS",!1),this.model.trigger("change:confirmTOS")}),it("should do nothing",function(){expect(f.createDialogByTemplate).not.toHaveBeenCalled(),expect(this.view.addView).not.toHaveBeenCalled()})}),describe("when set to true",function(){beforeEach(function(){this.model.set("confirmTOS",!0)}),it("should have created a child view",function(){expect(f.createDialogByTemplate).toHaveBeenCalled()}),it("should not close the prev modal when opening the confirmation one",function(){expect(this.dlg.options.triggerDialogEvents).toBe(!1)}),it("should clean up modal when the other one is closed",function(){expect(this.dlg.options.clean_on_hide).toBe(!1),expect(this.view.addView).toHaveBeenCalledWith(this.dlg)}),describe("when user agree to TOS",function(){beforeEach(function(){expect(this.model.get("hasAgreedToTOS")).toBe(!1),spyOn(this.model,"continue"),this.dlg.ok()}),it("should set that user has agreed to terms-of-service",function(){expect(this.model.get("hasAgreedToTOS")).toBe(!0)}),it("should called continue on model",function(){expect(this.model.continue).toHaveBeenCalled()})})})}),describe("when user has reached monthly quota",function(){beforeEach(function(){this.originalHosted=c.config.get("cartodb_com_hosted"),spyOn(this.model.get("userGeocoding"),"hasReachedMonthlyQuota").and.returnValue(!0),this.view.render()}),it("should show upgrade call-to-action",function(){expect(this.innerHTML()).toContain("reached the maximum")}),it("should only show the upgrade info if is hosted by cartodb",function(){expect(this.innerHTML()).not.toContain("UPGRADE"),c.config.set("cartodb_com_hosted",!1),c.config.set("upgrade_url","http://upgrade"),this.view.render(),expect(this.innerHTML()).toContain("UPGRADE")}),it("should disable form",function(){expect(this.innerHTML()).toContain("disabled")}),describe("when user is gmaps user",function(){beforeEach(function(){this.model.set("isGoogleMapsUser",!0)}),it("should still allow geocoding",function(){expect(this.innerHTML()).not.toContain("UPGRADE")})}),afterEach(function(){c.config.set("cartodb_com_hosted",this.originalHosted)})}),describe("when user is gmaps user",function(){beforeEach(function(){this.model.set("isGoogleMapsUser",!0)}),it("should not show costs info",function(){expect(this.view.$(".js-costs-info").attr("style")).toContain("display: none")})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/georeference/geocode_stuff_model":127,"../../../../../../../javascripts/cartodb/common/dialogs/georeference/street_addresses/street_addresses_model":140,"../../../../../../../javascripts/cartodb/common/dialogs/georeference/user_geocoding_model":145,"../../../../../../../javascripts/cartodb/common/view_factory":237}],413:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/tab_item_view");describe("common/dialog/georeference/tab_item_view",function(){beforeEach(function(){this.model=new c.core.Model({}),this.model.TAB_LABEL="my-tab",this.view=new d({model:this.model}),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should be rendered with defaults",function(){expect(this.innerHTML()).toContain("my-tab"),expect(this.innerHTML()).not.toContain("disabled"),expect(this.innerHTML()).not.toContain("selected")}),describe("when selected",function(){beforeEach(function(){this.model.set("selected",!0)}),it("should change visual accordingly",function(){expect(this.innerHTML()).toContain("selected")})}),describe("when disabled is set",function(){beforeEach(function(){this.model.set("disabled","some reason"),this.view.render()}),it("should disable the tab",function(){expect(this.innerHTML()).toContain("disabled")})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/georeference/tab_item_view":144}],414:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/georeference/user_geocoding_model");describe("common/dialog/georeference/user_geocoding_model",function(){beforeEach(function(){this.model=new d({quota:null,block_price:null,monthly_use:0,hard_limit:!1})}),describe(".hasQuota",function(){it("should return true if there is a quota value",function(){this.model.set("quota",0),expect(this.model.hasQuota()).toBe(!0),this.model.set("quota",1e3),expect(this.model.hasQuota()).toBe(!0),this.model.set("quota","0"),expect(this.model.hasQuota()).toBe(!0),this.model.set("quota","1000"),expect(this.model.hasQuota()).toBe(!0)}),it("should return false if quota is not set or such",function(){this.model.unset("quota"),expect(this.model.hasQuota()).toBe(!1),this.model.set("quota",null),expect(this.model.hasQuota()).toBe(!1),this.model.set("quota",void 0),expect(this.model.hasQuota()).toBe(!1),this.model.set("quota",""),expect(this.model.hasQuota()).toBe(!1)})}),describe(".quotaLeftThisMonth",function(){describe("when has quota left",function(){beforeEach(function(){this.model.set({quota:1e3,monthly_use:750})}),it("should return the calculated quota left for this month",function(){expect(this.model.quotaLeftThisMonth()).toEqual(250)})}),describe("when monthly usage exceeds quota",function(){beforeEach(function(){this.model.set({quota:10,monthly_use:1e3})}),it("should return a 0",function(){expect(this.model.quotaLeftThisMonth()).toEqual(0)})}),describe("when has no quota info",function(){it("should return a 0",function(){this.model.set({quota:void 0,monthly_use:10}),expect(this.model.quotaLeftThisMonth()).toEqual(0),this.model.set({quota:10,monthly_use:void 0}),expect(this.model.quotaLeftThisMonth()).toEqual(0)})})}),describe(".hasReachedMonthlyQuota",function(){beforeEach(function(){this.model.set("quota",10)}),describe("when hard_limit is set to false",function(){beforeEach(function(){this.model.set("hard_limit",!1)}),it("should always return false",function(){this.model.set("monthly_use",9e3),expect(this.model.hasReachedMonthlyQuota()).toBe(!1),this.model.set("monthly_use",11),expect(this.model.hasReachedMonthlyQuota()).toBe(!1),this.model.set("monthly_use",10),expect(this.model.hasReachedMonthlyQuota()).toBe(!1),this.model.set("monthly_use",9),expect(this.model.hasReachedMonthlyQuota()).toBe(!1)})}),describe("when hard_limit is set to true",function(){beforeEach(function(){this.model.set("hard_limit",!0)}),it("should return true or false depending on monthly usage",function(){this.model.set("monthly_use",9e3),expect(this.model.hasReachedMonthlyQuota()).toBe(!0),this.model.set("monthly_use",11),expect(this.model.hasReachedMonthlyQuota()).toBe(!0),this.model.set("monthly_use",10),expect(this.model.hasReachedMonthlyQuota()).toBe(!0),this.model.set("monthly_use",0),expect(this.model.hasReachedMonthlyQuota()).toBe(!1),this.model.set("monthly_use",9),expect(this.model.hasReachedMonthlyQuota()).toBe(!1)})}),describe("when user has no quota",function(){beforeEach(function(){this.model.set({quota:0,monthly_use:0,hard_limit:!0})}),it("should return true unless has soft limit",function(){expect(this.model.hasReachedMonthlyQuota()).toBe(!0),this.model.set("hard_limit",!1),expect(this.model.hasReachedMonthlyQuota()).toBe(!1)})})})})},{"../../../../../../javascripts/cartodb/common/dialogs/georeference/user_geocoding_model":145}],415:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/map/add_layer_model"),e=a("../create/shared_for_create_listing_view_model"),f=a("../create/listing/shared_for_import_view_model");describe("common/dialogs/map/add_layer_model",function(){beforeEach(function(){this.user=new cdb.admin.User({username:"pepe",base_url:"https://carto.com"}),this.map=jasmine.createSpyObj("cdb.admin.Map",["addCartodbLayerFromTable"]),
this.vis=jasmine.createSpyObj("cdb.admin.Visualization",["tableMetadata"]),this.model=new d({},{map:this.map,vis:this.vis,user:this.user})}),e.call(this),f.call(this),it("should have listing as default content pane",function(){expect(this.model.get("contentPane")).toEqual("listing")}),describe(".canFinish",function(){describe("when listing is import",function(){beforeEach(function(){spyOn(this.model.upload,"isValidToUpload"),this.model.set("listing","import")}),it("should return true only if upload is valid",function(){expect(this.model.canFinish()).toBeFalsy(),this.model.upload.isValidToUpload=function(){return!0},expect(this.model.canFinish()).toBeTruthy()})}),describe("when listing is datasets",function(){beforeEach(function(){this.model.set("listing","datasets")}),it("should return true if there is at least one dataset selected",function(){expect(this.model.canFinish()).toBeFalsy(),this.model.selectedDatasets.add({}),expect(this.model.canFinish()).toBeTruthy()})})}),describe(".canSelect",function(){beforeEach(function(){this.dataset=new cdb.core.Model({selected:!1})}),it("should return true only if there is dataset selected or if wanting to deselect",function(){expect(this.model.canSelect(this.dataset)).toBeTruthy(),this.model.selectedDatasets.add({selected:!0}),expect(this.model.canSelect(this.dataset)).toBeFalsy(),this.dataset.set("selected",!0),expect(this.model.canSelect(this.dataset)).toBeTruthy()})}),describe(".finish",function(){describe("when an dataset is selected",function(){describe("when dataset is a remote one (from library)",function(){beforeEach(function(){cdb.god.bind("importByUploadData",function(a){this.importByUploadData=a},this),this.model.collection.reset([{id:"abc-123",type:"remote",name:"foobar",external_source:{size:1024}}]),this.model.collection.at(0).set("selected",!0),this.model.finish()}),it("should trigger a importByUploadData event on the cdb.god event bus",function(){expect(this.importByUploadData).toBeTruthy()}),it("should pass a metadata object with necessary data to import dataset",function(){expect(this.importByUploadData).toEqual(jasmine.objectContaining({type:"remote"})),expect(this.importByUploadData).toEqual(jasmine.objectContaining({value:"foobar"})),expect(this.importByUploadData).toEqual(jasmine.objectContaining({remote_visualization_id:"abc-123"})),expect(this.importByUploadData).toEqual(jasmine.objectContaining({size:1024})),expect(this.importByUploadData).toEqual(jasmine.objectContaining({create_vis:!1}))})}),describe("when dataset is not a remote one",function(){beforeEach(function(){this.model.bind("addLayerDone",function(){this.addLayerDoneCalled=!0},this),this.map.layers=jasmine.createSpyObj("layers",["saveLayers"]),this.model.collection.reset([{table:{name:"foobar_table"},type:"table"}]),this.model.collection.at(0).set("selected",!0),this.model.finish()}),it("should create layer from dataset",function(){expect(this.map.addCartodbLayerFromTable).toHaveBeenCalled()}),it("should create layer with expected params",function(){expect(this.map.addCartodbLayerFromTable.calls.argsFor(0)[0]).toEqual("foobar_table"),expect(this.map.addCartodbLayerFromTable.calls.argsFor(0)[1]).toEqual("pepe"),expect(this.map.addCartodbLayerFromTable.calls.argsFor(0)[2]).toEqual(jasmine.objectContaining({vis:this.vis}))}),it("should change the content view setting",function(){expect(this.model.get("contentPane")).toEqual("addingNewLayer")}),describe("when adding layer succeeds",function(){beforeEach(function(){expect(this.addLayerDoneCalled).toBeFalsy(),this.map.addCartodbLayerFromTable.calls.argsFor(0)[2].success()}),it("should trigger addLayerDone",function(){expect(this.addLayerDoneCalled).toBeTruthy()}),it("should save layers",function(){expect(this.map.layers.saveLayers).toHaveBeenCalled()})}),describe("when adding layer fails",function(){beforeEach(function(){this.map.addCartodbLayerFromTable.calls.argsFor(0)[2].error()}),it("should change contentPane to addLayerFail",function(){expect(this.model.get("contentPane")).toEqual("addLayerFailed")})})})}),describe(".createFromScratch",function(){beforeEach(function(){var a=this;spyOn(cdb.admin.CartoDBTableMetadata.prototype,"save").and.callFake(function(){return a.table=this,this}),this.model.createFromScratch()}),it("should change to loading state",function(){expect(this.model.get("contentPane")).toEqual("creatingFromScratch")}),it("should save a new dataset table",function(){expect(cdb.admin.CartoDBTableMetadata.prototype.save).toHaveBeenCalled()}),describe("when table is successfully created",function(){beforeEach(function(){this.table.set("name","name-just-for-testing-purposes",{silent:!0}),cdb.admin.CartoDBTableMetadata.prototype.save.calls.argsFor(0)[1].success()}),it("should add the table as new layer",function(){expect(this.map.addCartodbLayerFromTable).toHaveBeenCalled(),expect(this.map.addCartodbLayerFromTable).toHaveBeenCalledWith("name-just-for-testing-purposes","pepe",jasmine.any(Object))})})}),describe("when an upload is set",function(){beforeEach(function(){cdb.god.bind("importByUploadData",function(a){this.importByUploadData=a},this),this.model.set("listing","import"),this.model.finish()}),it("should call cdb.god importByUploadData with expected data",function(){expect(this.importByUploadData).toBeTruthy(),expect(this.importByUploadData).toEqual(jasmine.objectContaining({state:"idle"}))})})})})},{"../../../../../../javascripts/cartodb/common/dialogs/map/add_layer_model":151,"../create/listing/shared_for_import_view_model":384,"../create/shared_for_create_listing_view_model":385}],416:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/map/add_layer_view"),e=a("../../../../../../javascripts/cartodb/common/dialogs/map/add_layer_model");describe("common/dialogs/map/add_layer_view",function(){beforeEach(function(){cdb.config.set("data_library_enabled",!0),this.user=new cdb.admin.User({username:"pepe",base_url:"https://carto.com"}),this.model=new e({},{user:this.user}),spyOn(d.prototype,"close"),this.view=new d({model:this.model,user:this.user}),this.view.render()}),it("should render the view as expected",function(){expect(this.view._contentPane.getActivePane()).toBe(this.view._contentPane.getPane("listing")),expect(this.innerHTML()).toContain("Add a new layer"),expect(this.innerHTML()).toContain("Connect dataset"),expect(this.innerHTML()).toContain("Data library"),expect(this.innerHTML()).toContain("Add an empty layer")}),it("should render the view without data library if disabled",function(){cdb.config.set("data_library_enabled",!1),this.view.render(),expect(this.view._contentPane.getActivePane()).toBe(this.view._contentPane.getPane("listing")),expect(this.innerHTML()).toContain("Add a new layer"),expect(this.innerHTML()).toContain("Connect dataset"),expect(this.innerHTML()).not.toContain("Data library"),expect(this.innerHTML()).toContain("Add an empty layer")}),describe("when model is adding new layer",function(){beforeEach(function(){this.model.set("contentPane","addingNewLayer")}),it("should show the adding-layer view instead",function(){expect(this.view._contentPane.getActivePane()).toBe(this.view._contentPane.getPane("addingNewLayer")),expect(this.view._contentPane.getActivePane()).not.toBe(this.view._contentPane.getPane("listing"))})}),describe("when adding layer is done",function(){beforeEach(function(){this.model.trigger("addLayerDone")}),it("should close the dialog",function(){expect(d.prototype.close).toHaveBeenCalled()})}),describe("when selecting a remote dataset",function(){beforeEach(function(){cdb.god.trigger("importByUploadData")}),it("should close the dialog",function(){expect(d.prototype.close).toHaveBeenCalled()})}),describe("when clicking ok",function(){beforeEach(function(){this.model.set("listing","import"),spyOn(this.model,"finish")}),describe("when no import is selected",function(){beforeEach(function(){this.view.$(".js-ok").click()}),it("should do nothing until there is some upload data ",function(){expect(this.model.finish).not.toHaveBeenCalled()})}),describe("when there is a upload data set",function(){beforeEach(function(){this.model.upload.set("value","foobar"),this.model.finish.and.callThrough(),this.view.$(".js-ok").click()}),it("should add layer from import",function(){expect(this.model.finish).toHaveBeenCalled()}),it("should close the view",function(){expect(this.view.close).toHaveBeenCalled()})})}),afterEach(function(){this.view.clean()})})},{"../../../../../../javascripts/cartodb/common/dialogs/map/add_layer_model":151,"../../../../../../javascripts/cartodb/common/dialogs/map/add_layer_view":152}],417:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/map/image_picker_view");describe("common/dialogs/map/image_picker_view",function(){describe("image_picker_view (with dropbox)",function(){beforeEach(function(){cdb.config.set("dropbox_api_key",1234),this.user=new cdb.admin.User({username:"pepe",id:"1",base_url:"https://carto.com"}),this.view=new d({user:this.user,kind:"marker"}),this.view.render()}),it("should render the view as expected",function(){expect(this.innerHTML()).toContain("Select a marker image"),expect(this.innerHTML()).toContain("Upload your icons or just use our nice selection.")}),it("should toggle the user icons tab depending on the user's assets",function(){expect(this.view.$('button[data-type="your_icons"]').hasClass("is-disabled")).toBe(!0),this.view.collection.reset([{public_url:"http://com.cartodb.assets.dev.s3.amazonaws.com/development/dev/assets/layers.png",kind:"pattern",id:59},{public_url:"http://com.cartodb.assets.dev.s3.amazonaws.com/development/dev/assets/layers.png",kind:"marker",id:57}]),expect(this.view.$('button[data-type="your_icons"]').hasClass("is-disabled")).toBe(!1)}),it("should render the right kind of assets in the user icons pane",function(){this.view.collection.reset([{public_url:"http://com.cartodb.assets.dev.s3.amazonaws.com/development/dev/assets/layers.png",kind:"pattern",id:59},{public_url:"http://com.cartodb.assets.dev.s3.amazonaws.com/development/dev/assets/layers.png",kind:"marker",id:58},{public_url:"http://com.cartodb.assets.dev.s3.amazonaws.com/development/dev/assets/layers.png",kind:"marker",id:57}]),expect(this.view.$(".AssetPane.AssetPane-userIcons .AssetsList li").size()).toBe(2)}),it("should enable the submit button when the user selects an item",function(){this.view.collection.reset([{public_url:"http://com.cartodb.assets.dev.s3.amazonaws.com/development/dev/assets/layers.png",kind:"pattern",id:59},{public_url:"http://com.cartodb.assets.dev.s3.amazonaws.com/development/dev/assets/layers.png",kind:"marker",id:58},{public_url:"http://com.cartodb.assets.dev.s3.amazonaws.com/development/dev/assets/layers.png",kind:"marker",id:57}]),this.view.$(".AssetPane.AssetPane-userIcons .AssetsList li:first-child").click(),expect(this.view.$(".js-ok").hasClass("is-disabled")).toBe(!1),expect(this.view.model.get("submit_enabled")).toBe(!0)}),it("should select the asset url when clicking on an asset",function(){this.view.collection.reset([{public_url:"http://com.cartodb.assets.dev.s3.amazonaws.com/development/dev/assets/layers.png",kind:"pattern",id:59},{public_url:"http://com.cartodb.assets.dev.s3.amazonaws.com/development/dev/assets/layers.png",kind:"marker",id:58},{public_url:"http://com.cartodb.assets.dev.s3.amazonaws.com/development/dev/assets/layers.png",kind:"marker",id:57}]),this.view.$(".AssetPane.AssetPane-userIcons .AssetsList li:first-child").click(),expect(this.view.model.get("value")).toBe("http://com.cartodb.assets.dev.s3.amazonaws.com/development/dev/assets/layers.png")}),it("should have the footer button disabled by default",function(){expect(this.view.$(".js-ok").hasClass("is-disabled")).toBe(!0),expect(this.view.model.get("submit_enabled")).toBe(!1)}),it("should active the simple icon tab",function(){this.view.$('button[data-type="simple_icons"]').click(),expect(this.view.model.get("pane")).toBe("simple_icons"),expect(this.view.$('button[data-type="your_icons"]').hasClass("is-disabled")).toBe(!0)}),it("should active the maki tab",function(){this.view.$('button[data-type="maki_icons"]').click(),expect(this.view.model.get("pane")).toBe("maki_icons")}),it("should active the pin_icons tab",function(){this.view.$('button[data-type="pin_icons"]').click(),expect(this.view.model.get("pane")).toBe("pin_icons")}),it("should active the footer disclaimer depending on the pane",function(){this.view.$('button[data-type="maki_icons"]').click(),expect(this.innerHTML()).toContain('<a href="https://github.com/mapbox/maki" target="_blank">Maki Icons</a>, an open source project by <a href="http://mapbox.com" target="_blank">Mapbox</a>'),this.view.$('button[data-type="pin_icons"]').click(),expect(this.innerHTML()).toContain('<a href="http://www.flaticon.com/packs/pins-of-maps/" target="_blank">Pin Maps</a>, icons by <a href="http://freepik.com" target="_blank">freepik.com</a>')}),afterEach(function(){this.view.clean()})}),describe("image_picker_view (without dropbox)",function(){beforeEach(function(){cdb.config.set("dropbox_api_key",null),this.user=new cdb.admin.User({username:"pepe",id:"1",base_url:"https://carto.com"}),this.view=new d({user:this.user,kind:"marker"}),this.view.render()}),it("shouldn't render the dropbox pane if there's no config key",function(){cdb.config.set("dropbox_api_key"),this.view.render(),expect(this.view.$('button[data-type="dropbox"]').length).toBe(0)}),afterEach(function(){this.view.clean()})})})},{"../../../../../../javascripts/cartodb/common/dialogs/map/image_picker_view":167}],418:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.Backbone:"undefined"!=typeof b?b.Backbone:null,d=a("../../../../../../../javascripts/cartodb/common/dialogs/map/image_picker/assets_item_view");describe("common/dialogs/map/image_picker/assets_item_view",function(){describe(".render",function(){describe("given an model of kind marker and with an image that is smaller than the defined min size",function(){var a,b=function(){return a.$("a.image")};beforeEach(function(e){var f=new c.Model({kind:"marker",public_url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAAaAQMAAACThN6NAAAAA3NCSVQICAjb4U/gAAAABlBMVEX///8AAABVwtN+AAAAAnRSTlP/AOW3MEoAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAAMSURBVAiZY2AYaAAAAIIAAQrotpMAAAAASUVORK5CYII="});a=new d({model:f}),a.render();var g;(g=function(){""!==b().css("background-size")?e():setTimeout(g,50)})()}),it("should render the image with a background-size overriden to the minimum size",function(a){expect(b().css("background-size")).toMatch("32px"),a()}),afterEach(function(){a.clean()})})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/map/image_picker/assets_item_view":153}],419:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/map/scratch_view");describe("common/dialogs/map/scratch_view",function(){beforeEach(function(){this.table=new cdb.core.Model({name:"citibike",row_count:0,size:1e3,geometry_types:["st_point"]}),this.vis=new cdb.admin.Visualization({name:"my_dataset",type:"table",privacy:"PRIVATE",updated_at:(new Date).toISOString(),likes:42,table:this.table,permission:{owner:{base_url:"http://team.carto.com/u/paco",username:"paco"}}}),this.view=new d({table:this.vis.get("table")}),this.view.render()}),it("should render the view as expected",function(){expect(this.innerHTML()).toContain("Start by adding points, lines or polygons"),expect(this.innerHTML()).toContain('Select the geometry type that you want to have in "citibike"'),expect(this.innerHTML()).toContain("Add lines"),expect(this.innerHTML()).toContain("Add points"),expect(this.innerHTML()).toContain("Add polygon")}),it("should trigger an event and send the correct type (point)",function(){var a;this.view.bind("newGeometry",function(b){a=b},this),this.view.$(".OptionCard[data-type='point']").click(),expect(a).toBe("point")}),it("should trigger an event and send the correct type (line)",function(){var a;this.view.bind("newGeometry",function(b){a=b},this),this.view.$(".OptionCard[data-type='line']").click(),expect(a).toBe("line")}),it("should trigger an event and send the correct type (polygon)",function(){var a;this.view.bind("newGeometry",function(b){a=b},this),this.view.$(".OptionCard[data-type='polygon']").click(),expect(a).toBe("polygon")}),afterEach(function(){this.view.clean()})})},{"../../../../../../javascripts/cartodb/common/dialogs/map/scratch_view":168}],420:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,e=a("../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/column_merge/column_merge_model");describe("common/dialog/merge_datasets/column_merge",function(){beforeEach(function(){this.user=new d.admin.User({base_url:"http://pepe.carto.com"});var a=[["left_nr","number"],["left_str","string"],["the_geom","geometry"]];this.table=TestUtil.createTable("a",a),this.columnMergeModel=new e({user:this.user,table:this.table,excludeColumns:["excludethis"]}),this.model=this.columnMergeModel.firstStep(),this.view=this.model.createView(),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should contain the left_table name",function(){expect(this.innerHTML()).toContain(">a</")}),it("should not render the_geom column",function(){expect(this.innerHTML()).not.toContain("the_geom")}),describe(".isAvailable",function(){it("should only return true if there is at least one available column",function(){expect(this.columnMergeModel.isAvailable()).toBeTruthy();var a=new e({user:this.user,table:TestUtil.createTable("a",[["the_geom","geometry"],["exclude_this","string"]]),excludeColumns:["exclude_this"]});expect(a.isAvailable()).toBeFalsy()})}),describe("when a table is selected",function(){beforeEach(function(){this.tableData={name:"b"},spyOn(c,"ajax"),spyOn(this.model,"changeRightTable").and.callThrough(),this.view._onChangeRightTableData(void 0,this.tableData)}),it("should call to fetch corresponding right columns",function(){expect(this.model.changeRightTable).toHaveBeenCalled()}),describe("when right columns are fetched",function(){beforeEach(function(){this.model.get("rightColumns").reset([{name:"right_nr",type:"number"},{name:"right_str",type:"string"},{name:"the_geom",type:"geometry"}])}),it("should render the right columns",function(){expect(this.innerHTML()).toContain("right_str"),expect(this.innerHTML()).toContain("right_nr")}),it("should not render the_geom column for right columns either",function(){expect(this.innerHTML()).not.toContain("the_geom")}),it("should not be ready for next step yet",function(){expect(this.model.get("isReadyForNextStep")).toBeFalsy()}),describe("when selected a key column from both lists",function(){beforeEach(function(){c(this.view.$(".js-left-columns .RadioButton")[1]).click(),c(this.view.$(".js-right-columns .RadioButton")[1]).click()}),it("should be ready for next step",function(){expect(this.model.get("isReadyForNextStep")).toBeTruthy()}),describe("when select a column of different kind on left",function(){beforeEach(function(){c(this.view.$(".js-left-columns .RadioButton")[0]).click()}),it("should unselect the item on the right",function(){expect(this.view.$(".js-right-columns .is-selected").length).toEqual(0),expect(this.view.$(".js-left-columns .is-selected").length).toEqual(1)}),it("should not be ready for next step anymore",function(){expect(this.model.get("isReadyForNextStep")).toBeFalsy()})}),describe("when going to next step",function(){beforeEach(function(){this.view.clean(),this.model=this.model.nextStep(),this.view=this.model.createView(),this.view.render()}),it("should render the seleted tables as pre-selected",function(){expect(this.innerHTML()).toContain(">a</"),expect(this.innerHTML()).toContain(">b</")}),it("should show the geom columns since they should be selectable now",function(){expect(this.innerHTML()).toContain("the_geom")}),it("should sort the columns in alphabetically",function(){expect(this.model.get("leftColumns").pluck("name")).toEqual(["the_geom","left_nr","left_str"]),expect(this.model.get("rightColumns").pluck("name")).toEqual(["the_geom","right_nr","right_str"])}),it("should be ready for next step",function(){expect(this.model.get("isReadyForNextStep")).toBeTruthy()}),describe("when go to next step",function(){beforeEach(function(){spyOn(this.model.constructor,"nextStep"),this.model.nextStep()}),it("should create next step w/ left table name",function(){expect(this.model.constructor.nextStep).toHaveBeenCalled(),expect(this.model.constructor.nextStep.calls.argsFor(0)[0].tableName).toEqual("a")}),it("should generate the SQL based on prior selections",function(){expect(this.model.constructor.nextStep.calls.argsFor(0)[0].sql).toEqual("SELECT CASE WHEN a.the_geom IS NULL THEN b.the_geom ELSE a.the_geom END AS the_geom, a.left_nr, a.left_str, b.right_nr, b.right_str FROM a FULL OUTER JOIN b ON LOWER(TRIM(a.left_str)) = LOWER(TRIM(b.right_str))")}),it("should pass the user model through",function(){expect(this.model.constructor.nextStep.calls.argsFor(0)[0].user).toBe(this.user)})})})})})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/column_merge/column_merge_model":171}],421:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/column_merge/footer_info_view"),e=a("../../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/column_merge/choose_key_columns_model");describe("common/dialog/merge_datasets/column_merge/footer_info_view",function(){describe("when given a model with no pre-selected key columns",function(){beforeEach(function(){this.model=new e({leftTable:TestUtil.createTable("foobar",[["LEFT","string"]])}),this.model.get("rightColumns").add({name:"RIGHT"}),this.view=new d({model:this.model}),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),describe("when change left columns",function(){beforeEach(function(){this.model.get("leftColumns").first().set("selected",!0)}),it("should render the left name",function(){expect(this.innerHTML()).toContain("LEFT")}),it("should contain the placeholder for right column",function(){expect(this.innerHTML()).toContain("is-placeholder")}),describe("when selected a right column",function(){beforeEach(function(){this.model.get("rightColumns").first().set("selected",!0)}),it("should render the right name",function(){expect(this.innerHTML()).toContain("RIGHT")}),it("should contain the placeholder for right column",function(){expect(this.innerHTML()).not.toContain("is-placeholder")})})})}),describe("when given a model with left/right columns from the start",function(){beforeEach(function(){this.model=new c.core.Model({leftKeyColumn:new c.core.Model({name:"LEFT"}),rightKeyColumn:new c.core.Model({name:"RIGHT"})}),spyOn(this.model,"bind"),this.view=new d({model:this.model}),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should renders the names of the given key columns",function(){expect(this.innerHTML()).toContain("LEFT"),expect(this.innerHTML()).toContain("RIGHT")}),it("should not require any listeners by default",function(){expect(this.model.bind).not.toHaveBeenCalled()})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/column_merge/choose_key_columns_model":169,"../../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/column_merge/footer_info_view":172}],422:[function(a,b,c){var d=a("../../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/column_merge/generate_column_merge_sql");describe("common/dialog/merge_datasets/column_merge/generate_column_merge_sql",function(){describe("when given two matching key column types",function(){beforeEach(function(){this.data={leftTableName:"a",leftKeyColumnName:"name",leftKeyColumnType:"string",leftColumnsNames:["area","name"],rightTableName:"b",rightKeyColumnName:"name",rightKeyColumnType:"string",rightColumnsNames:["the_geom","adm0_a3","name"]},this.sql=d(this.data)}),it("should return a valid SQL that rights the two tables",function(){expect(this.sql).toEqual("SELECT a.area, a.name, CASE WHEN b.the_geom IS NULL THEN a.the_geom ELSE b.the_geom END AS the_geom, b.adm0_a3, b.name AS b_name FROM a FULL OUTER JOIN b ON LOWER(TRIM(a.name)) = LOWER(TRIM(b.name))")})}),describe("when given two none-matching key column types",function(){beforeEach(function(){this.data={leftTableName:"a",leftKeyColumnName:"name",leftKeyColumnType:"string",leftColumnsNames:["the_geom","area","name"],rightTableName:"b",rightKeyColumnName:"name",rightKeyColumnType:"number",rightColumnsNames:["adm0_a3","name"]},this.sql=d(this.data)}),it("should return a valid SQL that merges the two tables",function(){expect(this.sql).toEqual("SELECT CASE WHEN a.the_geom IS NULL THEN b.the_geom ELSE a.the_geom END AS the_geom, a.area, a.name, b.adm0_a3, b.name AS b_name FROM a FULL OUTER JOIN b ON a.name = b.name")})})})},{"../../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/column_merge/generate_column_merge_sql":173}],423:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/footer_view");describe("common/dialog/merge_datasets/footer_view",function(){beforeEach(function(){this.model=new c.core.Model,this.view=new d({model:this.model}),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should render label",function(){expect(this.view.$(".js-next").html()).toContain("next")}),it("should set next button state based on model attr",function(){expect(this.view.$(".js-next").hasClass("is-disabled")).toBe(!0),this.model.set("isReadyForNextStep",!0),expect(this.view.$(".js-next").hasClass("is-disabled")).toBe(!1),this.model.set("isReadyForNextStep",!1),expect(this.view.$(".js-next").hasClass("is-disabled")).toBe(!0)}),describe("when click next",function(){it("should set attr on model to goto next step when ready",function(){this.view.$(".js-next").click(),expect(this.model.get("gotoNextStep")).toBeFalsy(),this.model.set("isReadyForNextStep",!0),this.view.$(".js-next").click(),expect(this.model.get("gotoNextStep")).toBe(!0)})}),describe("when created with an info view",function(){beforeEach(function(){this.view.clean(),this.infoView=new c.core.View,this.view=new d({model:this.model,nextLabel:"merge",infoView:this.infoView}),this.view.render()}),it("should render info view",function(){expect(this.view.$(".js-info").html()).toContain("<div>")}),it("should render custom next label since given when created view",function(){expect(this.view.$(".js-next").html()).toContain("merge")})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/footer_view":178}],424:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,a("../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/merge_datasets_model"));describe("common/dialog/merge_datasets/merge_datasets_model",function(){beforeEach(function(){this.user={},this.table=TestUtil.createTable("test"),this.model=new c({user:this.user,table:this.table})}),describe(".headerSteps",function(){it("should return an empty array by default",function(){expect(this.model.headerSteps()).toEqual([])}),describe("when have a current step",function(){beforeEach(function(){this.model.set("currentStep",this.model.get("mergeFlavors").at(0).firstStep()),this.results=this.model.headerSteps()}),it("should return all the steps from there",function(){expect(this.results.length).toBeGreaterThan(0)}),it("should contain title and icon for each step",function(){this.results.forEach(function(a){expect(a.icon).toEqual(jasmine.any(String)),expect(a.title).toEqual(jasmine.any(String)),expect(a.isCurrent).toEqual(jasmine.any(Boolean))})})})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/merge_datasets_model":179}],425:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,e=a("../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/merge_datasets_view");describe("common/dialog/merge_datasets/merge_datasets_view",function(){beforeEach(function(){this.table=TestUtil.createTable("a"),this.user=new d.admin.User({base_url:"http://pepe.carto.com"}),this.view=new e({table:this.table,user:this.user}),this.view.render()}),it("should display start view",function(){expect(this.innerHTML()).toContain("js-flavors"),expect(this.innerHTML()).not.toContain("js-details")}),describe("when a column merge is clicked",function(){beforeEach(function(){this.firstFlavor=this.view.model.get("mergeFlavors").at(0),spyOn(this.firstFlavor,"firstStep").and.callThrough(),c(this.view.$(".OptionCard")[0]).click()}),it("should render the next view",function(){expect(this.firstFlavor.firstStep).toHaveBeenCalled(),expect(this.innerHTML()).not.toContain("js-flavors"),expect(this.innerHTML()).toContain("js-details")}),describe("when click back",function(){beforeEach(function(){this.view.$(".js-back").click()}),it("should display start view again",function(){expect(this.innerHTML()).toContain("js-flavors"),expect(this.innerHTML()).not.toContain("js-details")})}),describe("when current step triggers a gotoNextStep",function(){beforeEach(function(){spyOn(this.view.model,"gotoNextStep"),this.view.model.get("currentStep").set("gotoNextStep",!0)}),it("should tell merge model go to next step",function(){expect(this.view.model.gotoNextStep).toHaveBeenCalled()})}),describe("when change current step",function(){beforeEach(function(){var a=new d.core.View;a.render=function(){return this.$el.html("new step"),this},this.newStep=new d.core.Model({}),this.newStep.createView=jasmine.createSpy("createView").and.returnValue(a),this.prevStep=this.view.model.get("currentStep"),spyOn(this.prevStep,"unbind").and.callThrough(),this.view.model.set("currentStep",this.newStep)}),it("should render the new view",function(){expect(this.innerHTML()).toContain("<div>new step</div>")}),it("should create a new view based on new step",function(){expect(this.newStep.createView).toHaveBeenCalled()}),it("should clean up old model",function(){expect(this.prevStep.unbind).toHaveBeenCalled()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()})}),describe("when change current step and new step has skipDefaultTemplate set to true",function(){beforeEach(function(){var a=new d.core.View;a.render=function(){return this.$el.html("new step"),this},this.newStep=new d.core.Model({skipDefaultTemplate:!0}),this.newStep.createView=jasmine.createSpy("createView").and.returnValue(a),this.view.model.set("currentStep",this.newStep)}),it("should replace dialog content completely with new step content",function(){expect(this.view.$(".content").html()).toEqual("<div>new step</div>")})})}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});
},{"../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/merge_datasets_view":180}],426:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,e=a("../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/merge_step_model");describe("common/dialog/merge_datasets/spatial_merge",function(){beforeEach(function(){this.user=new d.admin.User({base_url:"http://pepe.carto.com"}),this.sql="SELECT something from SOMEWHERE",this.model=new e({user:this.user,tableName:"table_name",sql:this.sql}),spyOn(c,"ajax"),this.view=this.model.createView(),this.view.render()}),it("should render the loading screen",function(){expect(this.innerHTML()).toContain("Spinner"),expect(this.innerHTML()).toContain("Merging datasets"),expect(this.innerHTML()).not.toContain("Step")}),it("should do merge directly",function(){expect(c.ajax).toHaveBeenCalled(),expect(c.ajax.calls.argsFor(0)[0].data).toEqual(jasmine.any(Object)),expect(c.ajax.calls.argsFor(0)[0].data.table_name).toEqual("table_name_merge"),expect(c.ajax.calls.argsFor(0)[0].data.sql).toEqual(this.sql)}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/merge_step_model":182}],427:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/spatial_merge/spatial_merge_model");describe("common/dialog/merge_datasets/spatial_merge",function(){beforeEach(function(){this.user=new cdb.admin.User({base_url:"http://pepe.carto.com"});var a=[["the_geom","geometry"],["left_nr","number"],["left_str","string"]];this.table=TestUtil.createTable("a",a);var b=new d({user:this.user,table:this.table,excludeColumns:["excludethis"]});this.server=sinon.fakeServer.create(),this.server.respondWith(/viz/,function(a){a.respond(200,{"Content-Type":"application/json"},JSON.stringify({visualizations:[{id:"cde-456",name:"c",table:{id:"c1",name:"c"}},{id:"abc-123",name:"b",table:{id:"b1",name:"b"}}]}))}),this.model=b.firstStep(),this.view=this.model.createView(),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should contain the left_table name",function(){expect(this.innerHTML()).toContain(">a</")}),it("should contain the geom as key column",function(){expect(this.innerHTML()).toContain("the_geom")}),describe("when right tables are fetched",function(){beforeEach(function(){this.server.respond()}),it("should render them in tables list",function(){expect(this.innerHTML()).toContain(">b</"),expect(this.innerHTML()).toContain(">c</")}),describe("when selected a table",function(){beforeEach(function(){this.server.respondWith(/tables\/.+callback=([^&]+)/,function(a,b){a.respond(200,{"Content-Type":"application/json"},[b,"(",JSON.stringify({id:"b2",name:"b",schema:[["the_geom","geometry"],["some_str","string"],["some_nr","number"]]}),")"].join(""))}),this.gotoNextStepSpy=jasmine.createSpy("change:gotoNextStep"),this.view.model.bind("change:gotoNextStep",this.gotoNextStepSpy),this.view.$(".js-right-tables option").last().prop("selected",!0).trigger("change"),this.server.respond()}),it("should go to next step directly",function(){expect(this.gotoNextStepSpy).toHaveBeenCalled()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),describe("when rendered 2nd step",function(){beforeEach(function(){this.model=this.model.nextStep(),this.view.clean(),this.view=this.model.createView(),this.view.render()}),it("should rendered merge methods for the right side",function(){expect(this.innerHTML()).toContain("sum"),expect(this.innerHTML()).toContain("avg"),expect(this.innerHTML()).toContain("count")}),it("should not be ready for next step",function(){expect(this.model.get("isReadyForNextStep")).toBeFalsy()}),describe("when selected a right merge column of type number",function(){beforeEach(function(){this.model.get("rightColumns").last().set("selected",!0),this.model.get("leftColumns").last().set("selected",!0)}),it("should not be ready for next step",function(){expect(this.model.get("isReadyForNextStep")).toBeFalsy()}),describe("when selected SUM merge method",function(){beforeEach(function(){this.model.get("mergeMethods").first().set("selected",!0)}),it("should be ready for next step",function(){expect(this.model.get("isReadyForNextStep")).toBeTruthy()}),describe("when going to next step",function(){beforeEach(function(){spyOn(this.model.constructor,"nextStep"),this.model.nextStep()}),it("should create next step w/ left table name",function(){expect(this.model.constructor.nextStep).toHaveBeenCalled(),expect(this.model.constructor.nextStep.calls.argsFor(0)[0].tableName).toEqual("a")}),it("should create next step w/ expected SQL",function(){expect(this.model.constructor.nextStep).toHaveBeenCalled(),expect(this.model.constructor.nextStep.calls.argsFor(0)[0].sql).toEqual("SELECT a.cartodb_id, a.the_geom_webmercator, a.the_geom, a.left_str, (SELECT SUM(b.some_nr) FROM b WHERE ST_Intersects(a.the_geom, b.the_geom) ) AS intersect_sum FROM a")})})}),describe("when selected merge method is AVG",function(){beforeEach(function(){this.model.get("mergeMethods").at(2).set("selected",!0)}),it("should be ready for next step",function(){expect(this.model.get("isReadyForNextStep")).toBeTruthy()}),describe("when going to next step",function(){beforeEach(function(){spyOn(this.model.constructor,"nextStep"),this.model.nextStep()}),it("should create next step w/ left table name",function(){expect(this.model.constructor.nextStep).toHaveBeenCalled(),expect(this.model.constructor.nextStep.calls.argsFor(0)[0].tableName).toEqual("a")}),it("should create next step w/ expected SQL",function(){expect(this.model.constructor.nextStep).toHaveBeenCalled(),expect(this.model.constructor.nextStep.calls.argsFor(0)[0].sql).toEqual("SELECT a.cartodb_id, a.the_geom_webmercator, a.the_geom, a.left_str, (SELECT AVG(b.some_nr) FROM b WHERE ST_Intersects(a.the_geom, b.the_geom) ) AS intersect_avg FROM a")})})})}),describe("when selected merge method is COUNT",function(){beforeEach(function(){this.model.get("mergeMethods").at(1).set("selected",!0),this.model.get("leftColumns").last().set("selected",!0)}),it("should be ready for next step",function(){expect(this.model.get("isReadyForNextStep")).toBeTruthy()}),describe("when going to next step",function(){beforeEach(function(){spyOn(this.model.constructor,"nextStep"),this.model.nextStep()}),it("should create next step w/ left table name",function(){expect(this.model.constructor.nextStep).toHaveBeenCalled(),expect(this.model.constructor.nextStep.calls.argsFor(0)[0].tableName).toEqual("a")}),it("should create next step w/ expected SQL",function(){expect(this.model.constructor.nextStep).toHaveBeenCalled(),expect(this.model.constructor.nextStep.calls.argsFor(0)[0].sql).toEqual("SELECT a.cartodb_id, a.the_geom_webmercator, a.the_geom, a.left_str, (SELECT COUNT(*) FROM b WHERE ST_Intersects(a.the_geom, b.the_geom) ) AS intersect_count FROM a")}),it("should pass the user model through",function(){expect(this.model.constructor.nextStep.calls.argsFor(0)[0].user).toBe(this.user)})})})})})}),afterEach(function(){this.server.restore(),this.view.clean()})})},{"../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/spatial_merge/spatial_merge_model":192}],428:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/tables_selector_view");describe("common/dialog/merge_datasets/tables_selector_view",function(){beforeEach(function(){spyOn(c.admin.Visualizations.prototype,"fetch"),this.view=new d({}),this.view.render()}),it("should fetch tables on startup",function(){expect(c.admin.Visualizations.prototype.fetch).toHaveBeenCalled()}),it("should be disabled initially",function(){expect(this.innerHTML()).toContain("disabled")}),describe("when initialOption is given",function(){beforeEach(function(){this.view.clean(),this.view=new d({initialOption:{label:"foo",value:"bar"}}),this.view.render()}),it("should have the initial option as first option",function(){var a=this.view.$("option").first();expect(a.text()).toEqual("foo"),expect(a.val()).toEqual("bar")})}),describe("when tables are fetched",function(){beforeEach(function(){this.view.model.get("visualizations").reset([new c.admin.Visualization({id:"abc123",type:"table",name:"table_a",table:{id:"tableA"}}),new c.admin.Visualization({id:"cde345",type:"table",name:"table_b",table:{id:"tableB"}})])}),it("should enable the selector",function(){expect(this.view.$el.prop("disabled")).toBeFalsy()}),it("should pre-select first table",function(){expect(this.view.model.get("tableData").id).toEqual("tableA")}),describe("when a table matches exclude filter",function(){beforeEach(function(){this.view.options.excludeFilter=function(a){return"tablex"===a.get("name")},this.view.model.get("visualizations").reset([new c.admin.Visualization({id:"x",name:"tablex"}),new c.admin.Visualization({id:"abc123",type:"table",name:"table_a",table:{id:"tableA"}})])}),it("should pre-select first table that is not matching filter",function(){expect(this.view.model.get("tableData").id).toEqual("tableA")})}),describe("when selecting another table",function(){beforeEach(function(){this.view.trigger("change","cde345")}),it("should set the models table data",function(){expect(this.view.model.get("tableData").id).toEqual("tableB")})})}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/merge_datasets/tables_selector_view":195}],429:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,"undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null),d=a("../../../../../javascripts/cartodb/common/dialogs/pecan/pecan_dialog_view");describe("PecanDialogView",function(){beforeEach(function(){window.user_data={username:"test"},this.user=jasmine.createSpy("cdb.admin.User"),this.user.get=function(a){return 1245},this.table=new c.admin.CartoDBTableMetadata({id:"table_id",name:"ufo_sightings"});var a="/* category style */";a+="#ufo_sightings {",a+=" marker-fill-opacity: 0.9;",a+=" marker-line-color: #FFF;",a+=" marker-line-width: 1;",a+=" marker-line-opacity: 1;",a+=" marker-placement: point;",a+=" marker-type: ellipse;",a+=" marker-width: 10;",a+=" marker-allow-overlap: true;",a+="}",a+='#ufo_sightings[geocode_precision="unmatched"] {',a+=" marker-fill: #A6CEE3;",a+="}",a+='#ufo_sightings[geocode_precision="zip"] {',a+=" marker-fill: #1F78B4;",a+="}";var b=[{table_id:"table_id",css:a,column:"date_sighted",state:"analyzed",geometry_type:"point",success:!1},{table_id:"table_id",css:a,column:"date_reported",state:"analyzed",geometry_type:"point",success:!0},{table_id:"table_id",css:a,column:"duration",state:"analyzed",geometry_type:"point",success:!1},{table_id:"table_id",css:a,column:"city",state:"analyzed",geometry_type:"point",success:!1},{table_id:"table_id",css:a,column:"geocode_score",state:"analyzed",geometry_type:"point",success:!0},{table_id:"table_id",css:a,column:"geocode_precision",state:"analyzed",geometry_type:"point",success:!0}];this.collection=new Backbone.Collection(b),this.vis=new c.admin.Visualization({type:"derived",active_layer_id:0,privacy:"PUBLIC"}),this.vis.table=this.table,this.map=new c.geo.Map,this.vis.tableMetadata().get=function(a){if("row_count"===a)return 1e5},this.vis.map=this.map,this.vis.map.layers.push({id:0}),this.vis.map.layers.at(0).table=this.table,this.fakeMap=sinon.stub(this.map,"getLayerAt"),this.fakeMap.returns({get:function(a){return"http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"}}),this.view=new d({clean_on_hide:!0,vis:this.vis,collection:this.collection,user:this.user})}),describe("View",function(){it("should generate a layer definition",function(){var a=this.view._generateLayerDefinition(this.collection.at(0));expect(a.layers[1].options.cartocss).toBeDefined()}),it("should modify the CSS if the information density is high",function(){var a=this.view._generateLayerDefinition(this.collection.at(0));expect(a.layers[1].options.cartocss).toContain("marker-width: 7;"),expect(a.layers[1].options.cartocss).toContain("marker-line-width: 0.7;")}),it("should return the template if it's supported",function(){this.fakeMap.restore(),this.fakeMap=sinon.stub(this.map,"getLayerAt"),this.fakeMap.returns({get:function(a){return"http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png"}}),expect(this.view._setupTemplate()).toEqual("http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png")}),it("should return the default template if the template is not supported",function(){this.fakeMap.restore(),this.fakeMap=sinon.stub(this.map,"getLayerAt"),this.fakeMap.returns({get:function(a){return"http://{s}.basemaps.cartocdn.com/UNKNOWN_TEMPLATE/{z}/{x}/{y}.png"}}),expect(this.view._setupTemplate()).toEqual(this.view._DEFAULT_BASEMAP_TEMPLATE)}),it("should return the default template if the layer doesn't have one",function(){this.fakeMap.restore(),this.fakeMap=sinon.stub(this.map,"getLayerAt"),this.fakeMap.returns({get:function(a){}}),expect(this.view._setupTemplate()).toEqual(this.view._DEFAULT_BASEMAP_TEMPLATE)}),it("should skip",function(){this.fakeMap.restore(),this.fakeMap=sinon.stub(this.map,"getLayerAt"),this.fakeMap.returns({get:function(a){}}),this.view.cancel();var a="pecan_1245_ufo_sightings";expect(localStorage[a]).toBe("true")})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/dialogs/pecan/pecan_dialog_view":197}],430:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,"undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null),d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,e=a("../../../../../javascripts/cartodb/common/dialogs/pecan/pecan_view"),f=a("../../../../../javascripts/cartodb/common/background_polling/background_polling_model");describe("PecanView",function(){function a(a,b){var c=sinon.stub(a,"data"),d=sinon.stub(a,"isGeoreferenced");d.returns(!(b&&(!b||void 0!==b.isGeoreferenced))||b.isGeoreferenced);var e=b&&b.query_schema?b.query_schema:{cartodb_id:"number",the_geom:"geometry",something:"string",created_at:"number",updated_at:"number"};c.returns({query_schema:e,table:{get:function(a){return"rows_counted"===a?b&&b.row_count?b.row_count:100:"geometry_types"===a?["ST_Point"]:void 0}}})}beforeEach(function(){window.user_data={username:"test"},this.user=jasmine.createSpy("cdb.admin.User"),this.backgroundPollingModel=new f({},{user:this.user}),spyOn(this.backgroundPollingModel,"addAnalysis"),this.table=new d.admin.CartoDBTableMetadata({id:"table_id",name:"table_name"})}),describe("View",function(){it("should exclude certain columns",function(){var a=!1,b=new e({table:this.table,backgroundPollingModel:this.backgroundPollingModel});a=c.every(["id","cartodb_id","lat","lon","lng","long","latitude","longitude"],function(a){return c.contains(b._EXCLUDED_COLUMNS,a)}),expect(a).toEqual(!0)}),it("should create an analysis if the table size is OK",function(){a(this.table,{row_count:100});var b=new e({table:this.table,backgroundPollingModel:this.backgroundPollingModel});expect(b.backgroundPollingModel.addAnalysis).toHaveBeenCalled()}),it("should not create an analysis if the table is not georeferenced",function(){a(this.table,{row_count:100,isGeoreferenced:!1});var b=new e({table:this.table,backgroundPollingModel:this.backgroundPollingModel});expect(b.backgroundPollingModel.addAnalysis).not.toHaveBeenCalled()}),it("should not create an analysis if the numer of rows is > _MAX_ROWS",function(){a(this.table,{row_count:e.prototype._MAX_ROWS+1});var b=new e({table:this.table,backgroundPollingModel:this.backgroundPollingModel});expect(b.backgroundPollingModel.addAnalysis).not.toHaveBeenCalled()}),it("should not create an analysis if the number of columns is > _MAX_COLS",function(){for(var b={cartodb_id:"number",the_geom:"geometry",created_at:"number",updated_at:"number"},d=0;d<e.prototype._MAX_COLS;d++)b["col_"+d]=c.shuffle(["boolean","number","string"])[0];a(this.table,{query_schema:b});var f=new e({table:this.table,backgroundPollingModel:this.backgroundPollingModel});expect(f.backgroundPollingModel.addAnalysis).not.toHaveBeenCalled()}),it("should generate a collection of columns based on the schema",function(){a(this.table);var b=new e({table:this.table,backgroundPollingModel:this.backgroundPollingModel});expect(b.columns.length).toBe(2),expect(b.columns.at(0).get("name")).toBe("the_geom"),expect(b.columns.at(0).get("geometry_type")).toBe("point"),expect(b.columns.at(1).get("name")).toBe("something"),expect(b.columns.at(1).get("geometry_type")).toBe("point")})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/background_polling/background_polling_model":5,"../../../../../javascripts/cartodb/common/dialogs/pecan/pecan_view":198}],431:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../javascripts/cartodb/common/dialogs/publish/publish_view"),e=function(){it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should render fine",function(){expect(this.innerHTML()).toContain("Publish your map")}),it("should render the options",function(){expect(this.innerHTML()).toContain("OptionCard"),expect(this.view.$el.find(".OptionCard").length).toEqual(3)})};describe("common/dialogs/publish/publish_view",function(){beforeEach(function(){this.user=jasmine.createSpy("user"),this.vis=new c.admin.Visualization({id:"abc-123",privacy:"PRIVATE"}),spyOn(this.vis,"embedURL").and.returnValue("https://carto.com/user/pepe/viz/abc-123/embed_map"),spyOn(this.vis,"vizjsonURL").and.returnValue("https://carto.com/user/pepe/api/v2/viz/abc-123/viz.json"),spyOn(this.vis,"publicURL").and.returnValue("https://carto.com/user/pepe/api/v2/viz/abc-123/public_map"),this.view=new d({model:this.vis,user:this.user,clean_on_hide:!0}),this.view.render()}),describe("when map is private",function(){e.call(this),it("should render alternative views for map and embed options",function(){expect(this.innerHTML()).toContain("is private"),expect(this.innerHTML()).toContain("js-change-privacy")}),describe("when clicking any change privacy link",function(){beforeEach(function(){var a=this;this.privacyModal=jasmine.createSpyObj("PrivacyDialog",["appendToBody","unbind","bind","close"]),c.editor.ChangePrivacyView=function(){return a.privacyModal},spyOn(this.view,"close"),spyOn(this.view,"show"),this.view.$el.find(".js-change-privacy").click()}),it("should hide the publish modal but not clean it",function(){expect(this.view.close).toHaveBeenCalled(),expect(this.view.options.clean_on_hide).toBeFalsy()}),it("should show the privacy modal instead",function(){expect(this.privacyModal.appendToBody).toHaveBeenCalled()}),it("should listen to hide event on the privacy modal",function(){expect(this.privacyModal.bind).toHaveBeenCalled(),expect(this.privacyModal.bind.calls.argsFor(0)[0]).toEqual("hide")}),describe("when privacy modal finishs",function(){beforeEach(function(){this.privacyModal.bind.calls.argsFor(0)[1].call(window)}),it("should restore clean_on_hide value",function(){expect(this.view.options.clean_on_hide).toBeTruthy()}),it("should show publish modal again",function(){expect(this.view.show).toHaveBeenCalled()}),it("should clean the privacy modal",function(){expect(this.privacyModal.close).toHaveBeenCalled()}),it("should unbind privayModal",function(){expect(this.privacyModal.unbind).toHaveBeenCalledWith("hide",jasmine.any(Function))}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()})})})}),describe("when map is not private",function(){e.call(this),beforeEach(function(){this.vis.set("privacy","LINK")}),it("should render the embed option",function(){expect(this.innerHTML()).toContain("iframe width=&quot;100%&quot; height=&quot;520&quot; frameborder=&quot;0&quot; src=&quot;https://carto.com/user/pepe/viz/abc-123/embed_map&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen")}),it("should render the dev cartodb.js option",function(){expect(this.innerHTML()).toContain("https://carto.com/user/pepe/api/v2/viz/abc-123/viz.json")})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/publish/publish_view":201}],432:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../javascripts/cartodb/common/dialogs/sync_dataset/sync_dataset_view");describe("common/dialogs/sync_dataset",function(){beforeEach(function(){this.tablemetadata={name:'"paco".my_dataset',row_count:9e3,size:1e3,geometry_types:["st_point"]},this.vis=new c.admin.Visualization({name:"my_dataset",type:"table",privacy:"PRIVATE",updated_at:(new Date).toISOString(),likes:42,table:this.tablemetadata,permission:{owner:{base_url:"http://team.carto.com/u/paco",username:"paco"}}});var a=new c.core.Model({id:1234,interval:3600,name:"citibike_1",quoted_fields_guessing:!0,ran_at:"2015-05-19T09:49:32+00:00",retried_times:0,run_at:"2015-05-19T11:13:09+00:00",service_item_id:"/Public/citibike.csv",service_name:"dropbox",state:"success",type_guessing:!0,fromExternalSource:!1,updated_at:"2015-05-19T10:13:09+00:00",user_id:"a9263a25-2ed0-4688-898a-04f4cffbd736"});a.urlRoot="/",this.vis.get("table").synchronization=a,this.table=this.vis.tableMetadata(),spyOn(this.table,"fetch"),this.view=new d({table:this.table}),this.view.render()}),it("should render the loading screen to start with",function(){expect(this.innerHTML()).not.toContain("Sync dataset options")}),describe("when table fetch fails",function(){beforeEach(function(){this.table.fetch.calls.argsFor(0)[0].error()}),it("should render default error",function(){expect(this.innerHTML()).toContain("error")})}),describe("when table fetch succeeds",function(){beforeEach(function(){this.table.fetch.calls.argsFor(0)[0].success()}),it("should render the view as expected",function(){expect(this.innerHTML()).toContain("Sync dataset options"),expect(this.innerHTML()).toContain("Dropbox file"),expect(this.innerHTML()).toContain("/Public/citibike.csv"),expect(this.innerHTML()).toContain("Every hour"),expect(this.innerHTML()).toContain("Every day"),expect(this.innerHTML()).toContain("Every week"),expect(this.innerHTML()).toContain("Never"),expect(this.view.$(".is-checked").parent().find(".RadioButton-label").text()).toContain("Every hour")}),it("should render when item is an url",function(){this.table.synchronization.set({service_name:"",service_item_id:"",url:"http://fake.url/point.csv"}),this.view.render(),expect(this.innerHTML()).not.toContain("Dropbox file"),expect(this.innerHTML()).toContain("Your dataset is in sync with a  file"),expect(this.innerHTML()).toContain("http://fake.url/point.csv")}),describe("when select an interval",function(){beforeEach(function(){this.view.$(".RadioButton:nth(2) button").click()}),it("should only have one selected",function(){expect(this.view.$(".is-checked").parent().find(".RadioButton-label").text()).toContain("Every week")})}),describe("when click save",function(){beforeEach(function(){spyOn(this.view,"close"),spyOn(this.table.synchronization,"save"),this.view.$(".RadioButton:nth(1) button").click(),this.view.$("button.ok").click()}),describe("when save succeeds",function(){beforeEach(function(){this.table.synchronization.save.calls.argsFor(0)[1].success()}),it("should save the checked interval",function(){expect(this.table.synchronization.save.calls.argsFor(0)[0]).toEqual({interval:86400})}),it("should close view",function(){expect(this.view.close).toHaveBeenCalled()})}),describe("when save fails",function(){beforeEach(function(){this.table.synchronization.save.calls.argsFor(0)[1].error()}),it("should render default error",function(){expect(this.innerHTML()).toContain("error")})})})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/dialogs/sync_dataset/sync_dataset_view":205}],433:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,a("../../../../../javascripts/cartodb/common/edit_fields/edit_field_model")),d=a("../../../../../javascripts/cartodb/common/edit_fields/boolean_field/boolean_field_view");describe("common/edit_fields/boolean_field",function(){beforeEach(function(){this.model=new c({type:"boolean",attribute:"boolean_column",value:null}),this.view=new d({model:this.model}),this.view.render()}),it("should render properly",function(){expect(this.view.$(".RadioButton").length).toBe(3),expect(this.view.$(".RadioButton-input.is-checked").length).toBe(1),expect(this.view.$(".RadioButton-input.is-checked").next().text()).toBe("Null")}),it("should change model when options have changed",function(){this.view.$(".js-true").click(),expect(this.model.get("value")).toBe(!0),expect(this.view.$(".RadioButton-input.is-checked").length).toBe(1),expect(this.view.$(".RadioButton-input.is-checked").next().text()).toBe("True"),this.view.$(".js-false").click(),expect(this.model.get("value")).toBe(!1),expect(this.view.$(".RadioButton-input.is-checked").next().text()).toBe("False")}),it("should disable radio buttons when readOnly is true",function(){this.model.set("readOnly",!0),expect(this.view.$(".RadioButton.is-disabled").length).toBe(3),expect(this.view.$(".RadioButton-input.is-checked").length).toBe(1),this.view.$(".js-true").click(),expect(this.model.get("value")).toBe(null),expect(this.view.$(".RadioButton-input.is-checked").next().text()).toBe("Null"),this.view.$(".js-false").click(),expect(this.model.get("value")).toBe(null),expect(this.view.$(".RadioButton-input.is-checked").next().text()).toBe("Null")}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/edit_fields/boolean_field/boolean_field_view":213,"../../../../../javascripts/cartodb/common/edit_fields/edit_field_model":218}],434:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,a("../../../../../javascripts/cartodb/common/edit_fields/edit_field_model")),d=a("../../../../../javascripts/cartodb/common/edit_fields/date_field/date_field_view"),e=a("moment");describe("common/edit_fields/date_field",function(){beforeEach(function(){this.model=new c({type:"date",attribute:"date_column",value:"2015-10-10T10:10:10Z"}),this.view=new d({model:this.model,showTime:!1}),this.view.render()}),it("should render properly",function(){expect(this.view.$(".DatePicker").length).toBe(1),expect(this.view.$(".TimeInput").length).toBe(0)}),describe("date picker",function(){it("should be able to change date value",function(a){var b=!1,c=this;this.model.bind("change:value",function(){b=!0}),this.view.$(".js-date-picker").click(),setTimeout(function(){$(".datepicker .datepickerSaturday:eq(0) a").click(),c.view.$el.click(),expect(b).toBeTruthy(),a()},200)}),it("shouldn't be able to change date when it is disabled",function(a){var b=!1,c=this;this.model.set("readOnly",!0),this.view.render(),this.view.$(".js-date-picker").click(),setTimeout(function(){expect(c.view.datePicker._calendar).toBeUndefined(),expect(b).toBeFalsy(),a()},100)})}),describe("with time",function(){beforeEach(function(){this.view.options.showTime=!0,this.view.render(),this.$input=this.view.$(".TimeInput input")}),it("should render time input if option is enabled",function(){expect(this.$input.length).toBe(1)}),it("shouldn't let change value when it is disabled",function(){this.model.set("readOnly",!0),this.view.render(),expect(this.$input.hasClass("is-disabled")),this.$input.val("00:00:11").trigger({type:"keyup",which:78,keyCode:78}),expect(this.model.get("value")).not.toBe("2015-10-10T00:00:11Z"),expect(this.model.get("value")).toBe("2015-10-10T10:10:10Z")}),it("should only change time part in the global date",function(){this.$input.val("03:45:11").trigger({type:"keyup",which:78,keyCode:78});var a=e(this.model.get("value")).utc();expect(a.hour()).toBe(3),expect(a.minutes()).toBe(45),expect(a.seconds()).toBe(11),expect(a.date()).toBe(10),expect(a.year()).toBe(2015),expect(a.month()).toBe(9)})}),it("should add is-invalid class to the element when value is invalid",function(){this.view.options.showTime=!0,this.view.render();var a=this.view.$(".TimeInput input");a.val("00:00:1a").trigger("keyup"),expect(this.view.$el.hasClass("is-invalid")).toBeTruthy(),a.val("00:00:01").trigger("keyup"),expect(this.view.$el.hasClass("is-invalid")).toBeFalsy()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/edit_fields/date_field/date_field_view":214,"../../../../../javascripts/cartodb/common/edit_fields/edit_field_model":218,moment:531}],435:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,a("moment")),d=a("../../../../../javascripts/cartodb/common/views/date_pickers/dates_range_picker");describe("Date picker",function(){beforeEach(function(){this.view=new d,this.view.render()}),it("should render properly",function(){expect(this.view.$(".js-dates").length).toBe(1),expect(this.view.$(".DatePicker-dropdown").length).toBe(1)}),it("should set date properly when range is set",function(){var a=c().utc(0),b=c().utc(0).subtract(29,"days");expect(this.view.model.get("fromDate")).toBe(b.format("YYYY-MM-DD")),expect(this.view.model.get("fromHour")).toBe(parseInt(b.format("H"))),expect(this.view.model.get("fromMin")).toBe(parseInt(b.format("m"))),expect(this.view.model.get("toDate")).toBe(a.format("YYYY-MM-DD")),expect(this.view.model.get("toHour")).toBe(parseInt(a.format("H"))),expect(this.view.model.get("toMin")).toBe(parseInt(a.format("m"))),expect(this.view.$(".js-dates").text()).toContain("From "+b.format("YYYY-MM-DD")+" "+b.format("HH:mm")+" to "+a.format("YYYY-MM-DD")+" "+a.format("HH:mm"))}),describe("date shortcuts",function(){beforeEach(function(){this.generateDateText=function(a,b){return"From "+a.format("YYYY-MM-DD")+" "+a.format("HH:mm")+" to "+b.format("YYYY-MM-DD")+" "+b.format("HH:mm")}}),it("should set last 4 hours as date",function(){this.view.$(".js-fourHours").click();var a=c().utc(0),b=c().utc(0).subtract(4,"hours");expect(this.view.model.get("fromDate")).toBe(b.format("YYYY-MM-DD")),expect(this.view.model.get("fromHour")).toBe(parseInt(b.format("H"))),expect(this.view.model.get("fromMin")).toBe(parseInt(b.format("m"))),expect(this.view.model.get("toDate")).toBe(a.format("YYYY-MM-DD")),expect(this.view.model.get("toHour")).toBe(parseInt(a.format("H"))),expect(this.view.model.get("toMin")).toBe(parseInt(a.format("m"))),expect(this.view.$(".js-dates").text()).toContain(this.generateDateText(b,a))}),it("should set last day as date",function(){this.view.$(".js-oneDay").click();var a=c().utc(0),b=c().utc(0).subtract(1,"day");
expect(this.view.$(".js-dates").text()).toContain(this.generateDateText(b,a))}),it("should set last week as date",function(){this.view.$(".js-oneWeek").click();var a=c().utc(0),b=c().utc(0).subtract(1,"week");expect(this.view.$(".js-dates").text()).toContain(this.generateDateText(b,a))})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/views/date_pickers/dates_range_picker":253,moment:531}],436:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,a("../../../../../javascripts/cartodb/common/edit_fields/edit_field_model"));describe("common/edit_fields/edit_field_model",function(){beforeEach(function(){this.model=new c({type:"number",attribute:"hello",value:1})}),it("should have error and valid bindings by default",function(){expect(this.model.validationError).not.toBeUndefined(),spyOn(this.model,"bind").and.callThrough(),this.model.initialize(),expect(this.model.bind.calls.argsFor(0)[0]).toEqual("valid"),expect(this.model.bind.calls.argsFor(1)[0]).toEqual("error")}),describe("number_validation",function(){beforeEach(function(){this.model.set({type:"number"})}),it("should be valid when it is only composed by numbers",function(){this.model.set("value","+123.34"),expect(this.model.isValid()).toBeTruthy(),this.model.set("value","-123.34"),expect(this.model.isValid()).toBeTruthy(),this.model.set("value","34"),expect(this.model.isValid()).toBeTruthy(),this.model.set("value","0"),expect(this.model.isValid()).toBeTruthy(),this.model.set("value","10"),expect(this.model.isValid()).toBeTruthy(),this.model.set("value","01"),expect(this.model.isValid()).toBeTruthy(),this.model.set("value","0.1"),expect(this.model.isValid()).toBeTruthy(),this.model.set("value",".1"),expect(this.model.isValid()).toBeTruthy()}),it("should be unvalid when it is not only composed by numbers or not well formed",function(){this.model.set("value","+1.23.34"),expect(this.model.isValid()).toBeFalsy(),this.model.set("value","e34"),expect(this.model.isValid()).toBeFalsy(),this.model.set("value",!0),expect(this.model.isValid()).toBeFalsy(),this.model.set("value","1.a2"),expect(this.model.isValid()).toBeFalsy()})}),describe("boolean_validation",function(){beforeEach(function(){this.model.set({type:"boolean",value:!0})}),it("should be valid when it is true, false or null",function(){this.model.set("value",!0),expect(this.model.isValid()).toBeTruthy(),this.model.set("value",!1),expect(this.model.isValid()).toBeTruthy(),this.model.set("value",null),expect(this.model.isValid()).toBeTruthy()}),it("should be unvalid when it is not a boolean value",function(){this.model.set("value","true"),expect(this.model.isValid()).toBeFalsy(),this.model.set("value",1),expect(this.model.isValid()).toBeFalsy(),this.model.set("value",0),expect(this.model.isValid()).toBeFalsy(),this.model.set("value","hello"),expect(this.model.isValid()).toBeFalsy(),this.model.set("value","null"),expect(this.model.isValid()).toBeFalsy()})}),it("should return if model is unvalid when validation fails or validationError is not empty",function(){var a=!1;this.model.bind("error",function(){a=!0}),this.model.set("value","paco"),expect(this.model.isValid()).toBe(!1),expect(this.model.validationError).not.toBe(""),expect(a).toBeTruthy()}),it("should return if model is valid when validation passes and validationError is empty",function(){var a=!1;this.model.bind("valid",function(){a=!0}),this.model.set("value","+10.0"),expect(this.model.isValid()).toBe(!0),expect(this.model.validationError).toBe(""),expect(a).toBeTruthy()}),it("should return validationError",function(){this.model.validationError="har",expect(this.model.getError()).toBe("har")})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/edit_fields/edit_field_model":218}],437:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,a("../../../../../javascripts/cartodb/common/edit_fields/edit_field_model")),d=a("../../../../../javascripts/cartodb/common/edit_fields/edit_field_view");describe("common/edit_fields/edit_field",function(){beforeEach(function(){this.model=new c({type:"number",attribute:"hello",value:1}),spyOn(this.model,"bind").and.callThrough(),this.view=new d({model:this.model}),this.view.render()}),it("should have two bindings by default",function(){expect(this.model.bind.calls.argsFor(0)[0]).toEqual("error valid"),expect(this.model.bind.calls.argsFor(1)[0]).toEqual("change:readOnly")}),it("should add invalid class when model throws an error",function(){this.model.set("value","addd"),expect(this.view.$el.hasClass("is-invalid")).toBeTruthy()}),it("should return model validity with a public method",function(){expect(this.view.isValid).not.toBeUndefined(),spyOn(this.model,"isValid"),this.view.isValid(),expect(this.model.isValid).toHaveBeenCalled()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/edit_fields/edit_field_model":218,"../../../../../javascripts/cartodb/common/edit_fields/edit_field_view":219}],438:[function(a,b,c){var d=a("../../../../../javascripts/cartodb/common/edit_fields/edit_field_model"),e=a("../../../../../javascripts/cartodb/common/edit_fields/number_field/number_field_view");describe("common/edit_fields/number_field",function(){beforeEach(function(){this.model=new d({type:"number",attribute:"number_column",value:2.34545}),this.view=new e({model:this.model}),this.view.render()}),it("should render properly",function(){expect(this.view.$(".js-input").length).toBe(1),expect(this.view.$(".js-input").val()).toBe("2.34545"),expect(this.view.$(".js-input").hasClass("is-number")).toBeTruthy()}),it("should change model value when user types something",function(){this.view.$(".js-input").val("-234.2").trigger({type:"keyup",which:78,keyCode:78}).trigger({type:"keydown",which:13,keyCode:13}),expect(this.model.get("value")).toBe("-234.2")}),it("should show invalid class when number value is invalid",function(){this.view.$(".js-input").val("paco").trigger({type:"keyup",which:78,keyCode:78}).trigger({type:"keydown",which:13,keyCode:13}),expect(this.model.get("value")).toBe(2.34545),expect(this.view.$el.hasClass("is-invalid")).toBeTruthy()}),it("should disable input when readOnly is true",function(){this.model.set("readOnly",!0),this.view.$(".js-input").focusin().trigger({type:"keyup",which:78,keyCode:78}).trigger({type:"keydown",which:13,keyCode:13}),expect(this.view.$(".js-input").val()).toBe("2.34545"),expect(this.model.get("value")).toBe(2.34545),expect(this.view.$(".js-input").hasClass("is-disabled")).toBeTruthy()}),it("should store null value when input is empty",function(){this.view.$(".js-input").val(""),this.view.$(".js-input").trigger("keyup"),expect(this.model.get("value")).toBeNull()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()})})},{"../../../../../javascripts/cartodb/common/edit_fields/edit_field_model":218,"../../../../../javascripts/cartodb/common/edit_fields/number_field/number_field_view":220}],439:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,a("../../../../../javascripts/cartodb/common/edit_fields/edit_field_model")),d=a("../../../../../javascripts/cartodb/common/edit_fields/string_field/string_field_view");describe("common/edit_fields/string_field",function(){beforeEach(function(){this.model=new c({type:"string",attribute:"string_column",value:"hellop"}),this.view=new d({model:this.model}),this.view.render()}),it("should render properly",function(){expect(this.view.$("textarea.js-textarea").length).toBe(1),expect(this.view.$("textarea.js-textarea").val()).toBe("hellop")}),it("should change model value when user types something",function(){this.view.$(".js-textarea").val("another text").trigger({type:"keyup",which:27,keyCode:27}).trigger({type:"keydown",which:13,keyCode:13}),expect(this.model.get("value")).toBe("another text")}),it("should disable textarea when readOnly is true",function(){this.model.set("readOnly",!0),expect(this.view.$(".js-textarea[readonly]").length).toBe(1),this.view.$(".js-textarea").focusin().trigger({type:"keydown",which:78,keyCode:78}).trigger({type:"keydown",which:13,keyCode:13}),expect(this.view.$(".js-textarea").val()).toBe("hellop")}),it("should resize textarea when option is enabled",function(){spyOn(this.view,"_resize"),this.view.$(".js-textarea").trigger({type:"keyup",which:27,keyCode:27}),expect(this.view._resize).toHaveBeenCalled()}),it("shouldn't resize textarea when option is disabled",function(){this.view.options.autoResize=!1,spyOn(this.view,"_resize"),this.view.$(".js-textarea").trigger({type:"keydown",which:13,keyCode:13}),expect(this.view._resize).not.toHaveBeenCalled()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/edit_fields/edit_field_model":218,"../../../../../javascripts/cartodb/common/edit_fields/string_field/string_field_view":221}],440:[function(a,b,c){var d=a("../../../../javascripts/cartodb/common/local_storage");describe("common/local_storage",function(){var a;beforeAll(function(){localStorage.removeItem("tests")}),beforeEach(function(){localStorage.clear(),a=new d("tests")}),afterEach(function(){localStorage.clear()}),afterAll(function(){localStorage.removeItem("tests")}),it("should contain an empty array after initialized",function(){expect(a.get()).toEqual({})}),it("add a element to localStorage",function(){var b={test:!0};a.add(b),expect(a.get("test")).toEqual(!0)}),it("should be able to set the whole array",function(){a.set({testing:[1,2,3,4]}),expect(a.get()).toEqual({testing:[1,2,3,4]})}),it("should be able to retrieve the n element",function(){a.add({v1:1}),a.add({v2:2}),a.add({v3:3}),expect(a.get("v1")).toEqual(1),expect(a.get(0)).toEqual(void 0)}),it("should be able to retrieve the n element and transform it on an object",function(){a.add({hello:"bye"}),expect(a.get("hello")).toEqual("bye"),expect(a.get("bye")).not.toEqual("hello")}),it("should persist on localStorage when added",function(){a.add({value:"2"}),expect(localStorage.getItem("tests")).toBeDefined(),expect(localStorage.getItem("tests")).toBe('{"value":"2"}')}),it("should remove an element",function(){a.add({v1:1}),a.add({v2:2}),a.add({v3:3}),a.remove("v1"),expect(a.get()).toEqual({v2:2,v3:3})}),it("should destroy the storage",function(){a.add({value:1}),a.destroy(),expect(localStorage.getItem("tests")).toBeFalsy()})})},{"../../../../javascripts/cartodb/common/local_storage":223}],441:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.Backbone:"undefined"!=typeof b?b.Backbone:null,d=a("../../../../javascripts/cartodb/common/paged_search_model");describe("common/paged_search_model",function(){beforeEach(function(){this.model=new d}),it("should have some default params",function(){expect(this.model.get("per_page")).toMatch(/\d+/),expect(this.model.get("page")).toEqual(1)}),describe(".fetch",function(){beforeEach(function(){this.collection=new c.Collection,this.fetchingSpy=jasmine.createSpy("fetching"),this.collection.on("fetching",this.fetchingSpy),this.jqXHR=$.Deferred(),spyOn(this.collection,"fetch").and.returnValue(this.jqXHR),this.results=this.model.fetch(this.collection)}),it("should call fetch on collection",function(){expect(this.collection.fetch).toHaveBeenCalledWith(jasmine.any(Object))}),it("should trigger a loading event on collection",function(){expect(this.fetchingSpy).toHaveBeenCalled()}),it("should have data params set",function(){expect(this.collection.fetch.calls.argsFor(0)[0].data).toEqual(jasmine.any(Object)),expect(this.collection.fetch.calls.argsFor(0)[0].data.per_page).toMatch(/\d+/),expect(this.collection.fetch.calls.argsFor(0)[0].data.page).toMatch(/\d+/)}),it("should return a deferred object",function(){expect(this.results).toBe(this.jqXHR)})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/common/paged_search_model":227}],442:[function(a,b,c){var d=a("../../../../javascripts/cartodb/common/router");describe("common/router",function(){describe(".supportTrailingSlashes",function(){it("should return an object with routes to callbacks that also contains the routes with trailing slashes",function(){var a=d.supportTrailingSlashes({"":"index",":id/edit":"editSomething"});expect(a).toEqual({"":"index","/":"index",":id/edit":"editSomething",":id/edit/":"editSomething"})})})})},{"../../../../javascripts/cartodb/common/router":228}],443:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null),d=a("../../../../javascripts/cartodb/common/view_factory");describe("common/view_factory",function(){describe(".createByTemplate",function(){beforeEach(function(){this.template=jasmine.createSpy("compiled template"),this.template.and.returnValue("<div>foo bar!</div>"),this.templateData={foo:"bar"},this.view=d.createByTemplate(this.template,this.templateData),spyOn(this.view.$el,"html"),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should render given template with template data",function(){expect(this.template).toHaveBeenCalled(),expect(this.template).toHaveBeenCalledWith(this.templateData)}),it("should inject the rendered results into the view's element",function(){expect(this.view.$el.html).toHaveBeenCalled(),expect(this.view.$el.html).toHaveBeenCalledWith("<div>foo bar!</div>")})}),describe(".createDialogByTemplate",function(){beforeEach(function(){this.template=jasmine.createSpy("compiled template"),this.template.and.returnValue("<div>foo bar!</div>"),this.templateData={foo:"bar"},this.view=d.createDialogByTemplate(this.template,this.templateData,{sticky:!0}),spyOn(this.view.$el,"html"),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should send the dialog options to the view",function(){expect(this.view.options.sticky).toBeTruthy()})}),describe(".createDialogByView",function(){beforeEach(function(){this.contentView=new c.core.View,this.view=d.createDialogByView(this.contentView),this.contentView.render=function(){return this.$el.html("<em>was rendered</em>"),this},spyOn(this.contentView,"render").and.callThrough(),spyOn(this.view,"render_content").and.callThrough(),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should return a dialog view that renders the content view inside it",function(){expect(this.view.appendToBody).toEqual(jasmine.any(Function)),expect(this.contentView.render).toHaveBeenCalled(),expect(this.view.render_content).toHaveBeenCalled(),expect(this.innerHTML()).toContain("was rendered")}),it("should cleans view upon hiding by default",function(){spyOn(this.view,"clean"),expect(this.view.clean).not.toHaveBeenCalled(),this.view.hide(),expect(this.view.clean).toHaveBeenCalled()})}),describe(".createByList",function(){beforeEach(function(){createItemView=function(a){var b=new c.core.View({tagName:"li"});return b.render=function(){return this.$el.html(this.make("div",{},a)),this},b},this.view=d.createByList([createItemView("item #1"),createItemView("item #2"),createItemView("item #3")],{tagName:"ul"}),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should pass the view opts when creating view",function(){expect(this.view.$el.prop("tagName").toLowerCase()).toEqual("ul")}),it("should render the items",function(){expect(this.innerHTML()).toContain("item #1"),expect(this.innerHTML()).toContain("item #2"),expect(this.innerHTML()).toContain("item #3")})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/common/view_factory":237}],444:[function(a,b,c){var d=a("../../../../../javascripts/cartodb/common/view_helpers/bytes_to_size");describe("common/view_helpers/bytes_to_size",function(){describe(".size",function(){[{bytes:0,range:"bytes",expectedSize:0},{bytes:1,range:"bytes",expectedSize:1},{bytes:1024,range:"kilobytes",expectedSize:1},{bytes:Math.pow(1024,2),range:"megabytes",expectedSize:1},{bytes:Math.pow(1024,3),range:"gigabytes",expectedSize:1},{bytes:Math.pow(1024,4),range:"terabytes",expectedSize:1}].forEach(function(a){describe("given a value in "+a.range+" range",function(){it("should return appropriate size within the calculated unit",function(){expect(d(a.bytes).size()).toEqual(a.expectedSize)})})})}),describe(".suffix",function(){[{bytes:0,range:"bytes",expectedSuffix:"B"},{bytes:1,range:"bytes",expectedSuffix:"B"},{bytes:1024,range:"kilobytes",expectedSuffix:"kB"},{bytes:Math.pow(1024,2),range:"megabytes",expectedSuffix:"MB"},{bytes:Math.pow(1024,3),range:"gigabytes",expectedSuffix:"GB"},{bytes:Math.pow(1024,4),range:"terabytes",expectedSuffix:"TB"}].forEach(function(a){describe("given a value in "+a.range+" range",function(){it("should return appropriate suffix",function(){expect(d(a.bytes).suffix()).toEqual(a.expectedSuffix)})})})}),describe(".toString",function(){it("should return a string of the size rounded down to closest full number, suffixed by appropriate unit",function(){expect(d(0).toString()).toEqual("0B"),expect(d(311296).toString()).toEqual("304kB"),expect(d(1048576e6).toString()).toEqual("976GB"),expect(d(10485759).toString()).toEqual("9MB")}),describe("when given 1",function(){it("should return a string with 1 decimal rounded down",function(){expect(d(10485759).toString(1)).toEqual("9.9MB")})}),describe("when given 2",function(){it("should return a string with 2 decimals rounded down",function(){expect(d(10485759).toString(2)).toEqual("9.99MB")})})})})},{"../../../../../javascripts/cartodb/common/view_helpers/bytes_to_size":238}],445:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,e=a("../../../../../../javascripts/cartodb/common/views/base_dialog/view");describe("common/views/base_dialog/view",function(){beforeEach(function(){var a=e.extend({render_content:function(){return'<blink>foobar content</blink><button class="cancel">cancel</button><button class="ok">OK</button>'}});this.view=new a,d.god.bind("dialogOpened",function(){this.dialogOpened=!0},this),d.god.bind("dialogClosed",function(){this.dialogClosed=!0},this),this.view.render()}),it("should render a close button",function(){expect(this.innerHTML()).toContain("close")}),it("should trigger a dialogOpened event on the global eventbus",function(){expect(this.dialogOpened).toBeTruthy()}),it("should render the content of .render_content",function(){expect(this.innerHTML()).toContain("foobar content")}),it("should expected the implementing child view to escape its content",function(){expect(this.innerHTML()).toContain("<blink>")}),it("should return false if is not sticky",function(){expect(this.view._isSticky()).toBeFalsy()}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),describe("sticky",function(){beforeEach(function(){jasmine.clock().install();var a=e.extend({render_content:function(){return'<blink>foobar content</blink><button class="cancel">cancel</button><button class="ok">OK</button>'}});this.stickyView=new a({sticky:!0}),this.stickyView.render(),c("body").append(this.stickyView.$el),this.hideCallback=jasmine.createSpy("hide"),this.stickyView.bind("hide",this.hideCallback),this.stickyView.$(".cancel").click()}),it("should be sticky",function(){expect(this.stickyView._isSticky()).toBeTruthy()}),it("shouldn't trigger a hide event",function(){expect(this.hideCallback).not.toHaveBeenCalled(),jasmine.clock().tick(101),expect(this.hideCallback.calls.count()).toEqual(0)}),it("should add the sticky class",function(){expect(this.stickyView.$el.hasClass("is-sticky")).toBeTruthy()}),afterEach(function(){this.stickyView.clean(),jasmine.clock().uninstall()})}),describe("when click close",function(){beforeEach(function(){jasmine.clock().install(),c("body").append(this.view.$el),this.hideCallback=jasmine.createSpy("hide"),this.view.bind("hide",this.hideCallback),this.view.$(".close").click()}),it("should start the scale-out animation",function(){expect(this.view.el.className).toContain("is-closing")}),it("should hide but after the animation finished",function(){expect(this.view.$el.is(":visible")).toBeTruthy(),jasmine.clock().tick(101),expect(this.view.$el.is(":hidden")).toBeTruthy()}),it("should trigger a hide event but just once",function(){expect(this.hideCallback).toHaveBeenCalled(),jasmine.clock().tick(101),expect(this.hideCallback.calls.count()).toEqual(1)}),it("should trigger a dialogClosed event on the global eventbus",function(){expect(this.dialogClosed).toBeTruthy()}),describe("when there is a cancel callback",function(){beforeEach(function(){this.view.cancel=jasmine.createSpy("cancel callback"),this.view.$(".close").click()}),it("should call cancel callback",function(){expect(this.view.cancel).not.toHaveBeenCalled(),jasmine.clock().tick(101),expect(this.view.cancel).toHaveBeenCalled()})}),afterEach(function(){jasmine.clock().uninstall()})}),describe("when click ok",function(){beforeEach(function(){spyOn(this.view,"close"),this.clickOK=function(){this.view.$el.find(".ok").click()}}),describe("when there is no ok method defined",function(){beforeEach(function(){this.clickOK()}),it("should close the view by default",function(){expect(this.view.close).toHaveBeenCalled()})}),describe("when there is a ok method defined on view",function(){beforeEach(function(){this.view.ok=jasmine.createSpy("ok"),this.clickOK()}),it("should not close the view",function(){expect(this.view.close).not.toHaveBeenCalled()}),it("should have called the ok method instead",function(){expect(this.view.ok).toHaveBeenCalled()})})}),describe(".render",function(){it("should return itself per backbone standard",function(){expect(this.view.render()).toBe(this.view)})}),describe(".open",function(){beforeEach(function(){this.showCallback=jasmine.createSpy("show"),this.view.bind("show",this.showCallback),this.view.open()}),it("should trigger an show event",function(){expect(this.showCallback).toHaveBeenCalled()})}),describe(".close",function(){beforeEach(function(){jasmine.clock().install(),this.view.cancel=jasmine.createSpy("cancel callback"),this.view.close(),jasmine.clock().tick(101)}),it("should not called cancel callback",function(){expect(this.view.cancel).not.toHaveBeenCalled()}),afterEach(function(){jasmine.clock().uninstall()})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/views/base_dialog/view":242}],446:[function(a,b,c){(function(b){var c=a("../../../../../../../javascripts/cartodb/common/views/dashboard_header/breadcrumbs/dropdown_view"),d=a("../../../../../../../javascripts/cartodb/dashboard/router"),e="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null,f=a("../../../../../../../javascripts/cartodb/dashboard/header_view_model");describe("common/views/dashboard_header/breadcrumbs/dropdown_view",function(){beforeEach(function(){window.cdb.god;this.user=new e.User({base_url:"http://pepe.carto.com",username:"pepe"}),this.router=new d({dashboardUrl:this.user.viewUrl().dashboard()}),this.headerViewModel=new f(this.router),spyOn(this.router,"navigate"),spyOn(this.router.model,"get"),this.router.model.get.and.returnValue("maps"),this.view=new c({router:this.router,viewModel:this.headerViewModel,model:this.user,template_base:"common/views/dashboard_header/breadcrumbs/dropdown"}),spyOn(this.view,"hide"),this.view.render()}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should have rendered a URL for maps",function(){expect(this.innerHTML()).toMatch('href="http://pepe.carto.com/dashboard/maps"')}),it("should have rendered a URL for datasets",function(){expect(this.innerHTML()).toMatch('href="http://pepe.carto.com/dashboard/datasets"')}),it("should have rendered a URL for locked datasets",function(){expect(this.innerHTML()).toMatch('href="http://pepe.carto.com/dashboard/datasets/locked"')}),it("should have rendered a URL for locked maps",function(){expect(this.innerHTML()).toMatch('href="http://pepe.carto.com/dashboard/maps/locked"')}),it("should hide when event is triggered on cdb.god model",function(){cdb.god.trigger("closeDialogs"),expect(this.view.hide).toHaveBeenCalled()}),it("should have one selected link at least",function(){expect(this.innerHTML()).toContain("is-selected")}),describe("click on any link",function(){beforeEach(function(){spyOn(this.view,"killEvent")}),describe("given a normal click",function(){beforeEach(function(){this.view.$("a").click(),this.args=this.router.navigate.calls.argsFor(0)}),it("should cancel default link behaviour",function(){expect(this.view.killEvent).toHaveBeenCalled()}),it("should call navigate on the route with the href value",function(){expect(this.args[0]).toMatch("http://pepe.carto.com/dashboard/maps")}),it("should tell router to trigger a change event",function(){expect(this.args[1]).toEqual({trigger:!0})}),it("should close the dialog",function(){expect(this.view.hide).toHaveBeenCalled()})})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/views/dashboard_header/breadcrumbs/dropdown_view":244,"../../../../../../../javascripts/cartodb/dashboard/header_view_model":272,"../../../../../../../javascripts/cartodb/dashboard/router":279}],447:[function(a,b,c){(function(b){var c=a("../../../../../../javascripts/cartodb/common/views/dashboard_header/notifications/dropdown_view"),d=a("../../../../../../javascripts/cartodb/common/views/dashboard_header/notifications/view"),e="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null,f=a("../../../../../../javascripts/cartodb/common/local_storage"),g=(a("../../../../../../javascripts/cartodb/common/views/dashboard_header/notifications/model"),a("../../../../../../javascripts/cartodb/common/views/dashboard_header/notifications/organization-model"));describe("common/views/dashboard_header/notifications/view",function(){var a,b;beforeEach(function(){jasmine.Ajax.install(),jasmine.Ajax.stubRequest(new RegExp("^http(s)?.*/notifications")).andReturn({status:200}),window.organization_notifications=[{id:"n-1",icon:"alert",html_body:"<p>html_body</p>\n",received_at:"2017-03-24T16:58:28+00:00",read_at:null}],this.localStorage=new f("test"),this.localStorage.remove("notification.close_limits"),b=new e.User({base_url:"http://coronelli.carto.com/u/test-user",account_type:"CORONELLI",remaining_byte_quota:900,quota_in_bytes:1e3,trial_ends_at:null,username:"test-user",table_count:1,id:123,api_key:"xyz123"}),spyOn(c.prototype,"initialize").and.callThrough(),spyOn(g.prototype,"initialize").and.callThrough(),spyOn(g.prototype,"markAsRead").and.callThrough(),a=new d({user:b,localStorage:this.localStorage})}),describe("render",function(){it("should render properly",function(){a.render(),expect(a.$el.hasClass("UserNotifications")).toBeTruthy(),expect(a.$(".UserNotifications-Icon").length).toBe(1),expect(a.$(".UserNotifications-badge").length).toBe(1),expect(a.$(".UserNotifications-badge").text()).toBe("1"),expect(a.$el.hasClass("has--alerts")).toBeTruthy(),b.set("remaining_byte_quota",10),expect(a.$(".UserNotifications-badge").length).toBe(1),expect(a.$(".UserNotifications-badge").text()).toBe("2"),expect(a.$el.hasClass("has--alerts")).toBeTruthy(),b.set("remaining_byte_quota",1e3),expect(a.$(".UserNotifications-badge").length).toBe(1),expect(a.$(".UserNotifications-badge").text()).toBe("1"),expect(a.$el.hasClass("has--alerts")).toBeTruthy()}),it("should have no leaks",function(){a.render(),expect(a).toHaveNoLeaks()})}),describe("click",function(){beforeEach(function(){a.render(),spyOn(c.prototype,"render").and.callThrough(),spyOn(c.prototype,"open").and.callThrough(),spyOn(c.prototype,"on"),spyOn(c.prototype,"clean").and.callThrough(),this.clickSettings=function(){a.$el.click()}}),it("should create dropdown view with expected params",function(){this.clickSettings(),expect(c.prototype.initialize).toHaveBeenCalled(),expect(g.prototype.initialize).toHaveBeenCalledTimes(1);var b=c.prototype.initialize.calls.argsFor(0)[0];expect(b.target[0]).toEqual(a.$el[0]),expect(b.template_base).toEqual("common/views/dashboard_header/notifications/templates/dropdown")}),it("should have rendered and opened the dropdown view",function(){this.clickSettings(),expect(c.prototype.render).toHaveBeenCalled(),expect(c.prototype.open).toHaveBeenCalled()}),it("should add the dropdown view to the child views",function(){var b=spyOn(a,"addView");this.clickSettings(),expect(b).toHaveBeenCalled()}),it("should mark organization notification as read after the dropdown is hidden",function(b){expect(a.collection.length).toBe(1),this.clickSettings(),a._onDropdownHidden(a.notification),setTimeout(function(){expect(g.prototype.markAsRead).toHaveBeenCalledTimes(1),expect(a.collection.length).toBe(0),b()},400)}),it("should clean up dropdown view after the dropdown is hidden",function(b){this.clickSettings(),expect(c.prototype.on).toHaveBeenCalledWith("onDropdownHidden",jasmine.any(Function),a),a._onDropdownHidden(a.notification),setTimeout(function(){expect(c.prototype.clean).toHaveBeenCalled(),expect(a.$el.hasClass("has--alerts")).toBeFalsy(),b()},400)}),it("should close any other open dialogs",function(){spyOn(cdb.god,"trigger"),this.clickSettings(),expect(cdb.god.trigger).toHaveBeenCalledWith("closeDialogs")})}),describe("collection",function(){it("should generate collection data",function(){expect(a.collection.size()).toBe(1)}),it("should reset collection data when user data is changed",function(){var c=spyOn(a.collection,"reset");b.set("remaining_byte_quota",10),expect(c).toHaveBeenCalled()})}),afterEach(function(){jasmine.Ajax.uninstall(),a.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/local_storage":223,"../../../../../../javascripts/cartodb/common/views/dashboard_header/notifications/dropdown_view":246,"../../../../../../javascripts/cartodb/common/views/dashboard_header/notifications/model":247,"../../../../../../javascripts/cartodb/common/views/dashboard_header/notifications/organization-model":248,"../../../../../../javascripts/cartodb/common/views/dashboard_header/notifications/view":249}],448:[function(a,b,c){(function(b){var c=a("../../../../../../javascripts/cartodb/common/views/dashboard_header/settings_dropdown_view"),d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,e="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null;describe("common/views/dashboard_header/settings_dropdown_view",function(){beforeEach(function(){this.user=new e.User({base_url:"http://org.carto.com/u/pepe",username:"Pepe",email:"pepe@paco.com",account_type:"Coronelli",db_size_in_bytes:311296,quota_in_bytes:1048576,actions:{engine_enabled:!0}}),window.upgrade_url="http://localhost:3000/account/development/upgrade",this.view=new c({model:this.user
}),spyOn(this.view,"hide"),this.view.render()}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should have rendered a top block with user meta",function(){expect(this.innerHTML()).toContain(this.user.get("username")),expect(this.innerHTML()).toContain(this.user.get("email")),expect(this.innerHTML()).toContain(this.user.get("account_type").toLowerCase())}),it("should have rendered a block with data usage progress bar",function(){expect(this.innerHTML()).toContain("width: 30%")}),it("should have rendered a block with data usage in text",function(){expect(this.innerHTML()).toContain("304kB of 1MB")}),it("should have rendered a upgrade link",function(){expect(this.innerHTML()).toContain("http://localhost:3000/account/development/upgrade")}),it("should hide when event is triggered on cdb.god model",function(){d.god.trigger("closeDialogs"),expect(this.view.hide).toHaveBeenCalled()}),it("should have rendered link to organization settings for admin",function(){this.user.set("org_admin",!0),this.user.organization=new e.Organization,this.view.render(),expect(this.innerHTML()).toContain("Your organization")}),it("should not have rendered link to organization settings for non-admin",function(){expect(this.innerHTML()).not.toContain("Your organization")}),afterEach(function(){this.view.clean(),window.upgrade_url=void 0,delete window.upgrade_url})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/views/dashboard_header/settings_dropdown_view":250}],449:[function(a,b,c){b.exports=function(){["breadcrumbTitle","isBreadcrumbDropdownEnabled","isDisplayingDatasets","isDisplayingMaps","isDisplayingLockedItems"].forEach(function(a){it("should have a "+a+"function",function(){expect(this.viewModel[a]).toEqual(jasmine.any(Function))})},this)}},{}],450:[function(a,b,c){(function(b){var c=a("../../../../../javascripts/cartodb/common/views/dashboard_header_view"),d="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,e="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null;e.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null;var f="undefined"!=typeof window?window.Backbone:"undefined"!=typeof b?b.Backbone:null,g=a("../../../../../javascripts/cartodb/dashboard/router"),h=a("../../../../../javascripts/cartodb/dashboard/header_view_model"),i=a("../../../../../javascripts/cartodb/common/local_storage");describe("common/views/dashboard_header_view",function(){beforeEach(function(){this.$el=d('<div><p class="js-logo"></p><li class="js-breadcrumb-dropdown"></li>\n<a class="js-settings-dropdown" href="#">User settings dropdown</a>\n<div class="Header-settingsItemNotifications js-user-notifications"></div>\n</div>'),this.user=new e.admin.User({base_url:"http://pepe.carto.com",username:"pepe",account_type:"FREE",id:123,api_key:"xyz123",actions:{engine_enabled:!0}}),this.router=new g({dashboardUrl:this.user.viewUrl().dashboard()}),this.router.model.set("content_type","datasets"),this.headerViewModel=new h(this.router),spyOn(this.headerViewModel,"bind"),this.localStorage=new i,this.view=new c({el:this.$el,model:this.user,router:this.router,collection:new f.Collection,viewModel:this.headerViewModel,localStorage:this.localStorage}),d(document.body).append(this.view.render().el)}),it("should render breadcrumb links on change events by view model",function(){var a=this.headerViewModel.bind.calls.argsFor(0);expect(a[0]).toEqual("change"),expect(a[1]).toEqual(this.view._renderBreadcrumbsDropdownLink),expect(a[2]).toEqual(this.view)}),it("should render user notifications",function(){this.view.render(),expect(this.view.el.innerHTML).toContain("UserNotifications")}),describe(".render",function(){it("should have no leaks",function(){this.view.render(),expect(this.view).toHaveNoLeaks()}),it("should clear sub views",function(){var a=spyOn(this.view,"clearSubViews");this.view.render(),expect(a).toHaveBeenCalled()}),it("should render the breadcrumbs dropdown link",function(){this.view.render(),expect(this.innerHTML()).toContain("Datasets")}),it("should render the logo with link",function(){this.view.render(),expect(this.innerHTML()).toMatch('<a class="Logo" href="(.*)/dashboard"')})}),describe("logo loader",function(){xit("should start logo animation when a router change is made (content_type not accepted)",function(){spyOn(this.view,"_startLogoAnimation"),this.view.collection.total_user_entries=10,this.router.model.set({shared:!0}),expect(this.view._startLogoAnimation).toHaveBeenCalled(),this.router.model.set({shared:!1,content_type:"maps"}),expect(this.view._startLogoAnimation.calls.count()).toBe(1),this.router.model.set({library:!0}),expect(this.view._startLogoAnimation.calls.count()).toBe(2)}),xit("should stop logo animation when collection fetch is finished",function(){var a=this.view.$(".Logo");this.view.collection.total_user_entries=10,this.router.model.set({shared:!0}),expect(a.hasClass("is-loading")).toBeTruthy(),this.view.collection.reset([{hello:"hello"}]),expect(a.hasClass("is-loading")).toBeFalsy()}),xit("should stop logo animation if collection fetch fails",function(){var a=this.view.$(".Logo");this.view.collection.total_user_entries=10,this.router.model.set({shared:!0}),expect(a.hasClass("is-loading")).toBeTruthy(),this.view.collection.trigger("error"),expect(a.hasClass("is-loading")).toBeFalsy()})}),describe(".click .js-settings-dropdown",function(){beforeEach(function(){this.view.render(),this.killEventSpy=spyOn(this.view,"killEvent"),this.addViewSpy=spyOn(this.view,"addView"),spyOn(e.god,"trigger"),this.view.$(".js-settings-dropdown").click()}),it("should kill the click event from propagating etc., to not trigger any event listeners on body",function(){expect(this.killEventSpy).toHaveBeenCalled()}),it("should add the dropdown view to the child views",function(){expect(this.addViewSpy).toHaveBeenCalled()}),it("should close any other open dialogs",function(){expect(e.god.trigger).toHaveBeenCalledWith("closeDialogs")})}),describe(".click .js.breadcrumb-dropdown",function(){beforeEach(function(){this.view.render(),this.killEventSpy=spyOn(this.view,"killEvent"),this.addViewSpy=spyOn(this.view,"addView"),spyOn(e.god,"trigger"),this.view.$(".js-breadcrumb-dropdown").click()}),it("should kill the click event from propagating etc., to not trigger any event listeners on body",function(){expect(this.killEventSpy).toHaveBeenCalled()}),it("should add the dropdown view to the child views",function(){expect(this.addViewSpy).toHaveBeenCalled()}),it("should close any other open dialogs",function(){expect(e.god.trigger).toHaveBeenCalledWith("closeDialogs")})}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/local_storage":223,"../../../../../javascripts/cartodb/common/views/dashboard_header_view":252,"../../../../../javascripts/cartodb/dashboard/header_view_model":272,"../../../../../javascripts/cartodb/dashboard/router":279}],451:[function(a,b,c){(function(b){var c=a("../../../../../../javascripts/cartodb/common/views/likes/view"),d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null,describe("common/views/likes/view",function(){beforeEach(function(){this.model=new d.admin.Like({liked:!1,likes:41}),this.view=new c({model:this.model}),this.view.render(),this.html=function(){return $("<div>").append(this.view.$el.clone()).remove().html()}}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should render the likes count",function(){expect(this.html()).toContain("41")}),it("should not rendered the liked state since not liked yet",function(){expect(this.html()).not.toContain("is-liked")}),it("should not animated view since no state change yet",function(){expect(this.html()).not.toContain("is-animated")}),describe("click toggle",function(){beforeEach(function(){!function(a){spyOn(a.model,"toggleLiked").and.callFake(function(){a.model.set({liked:!0,likes:42})})}(this),spyOn(this.view,"killEvent"),spyOn(this.view.$el,"one"),this.view.$el.click()}),it("should prevent event default",function(){expect(this.view.killEvent).toHaveBeenCalledWith(jasmine.any(Object))}),it("should have toggled liked state on model",function(){expect(this.model.toggleLiked).toHaveBeenCalled()}),it("should render the new likes count",function(){expect(this.html()).toContain("42")}),it("should render animate next render",function(){expect(this.html()).toContain("is-animated")}),it("should remove animation once done animating",function(){this.view.$el.one.calls.argsFor(0)[1](),expect(this.html()).not.toContain("is-animated")})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/views/likes/view":255}],452:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.Backbone:"undefined"!=typeof b?b.Backbone:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null),d="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,e=a("../../../../../javascripts/cartodb/common/views/mapcard_preview");describe("common/views/mapcard_preview",function(){beforeEach(function(){this.cardHTML='<div class="MapCard MapCard--selectable"><div class="MapCard-header js-header">  <div class="MapCard-loader"></div></div></div>',this.view=new e({el:d(this.cardHTML).find(".js-header"),visId:"oooo-llll-aaaa-mmmm",mapsApiResource:"javier.hello.com",username:"javier"})}),it("should request an image with default width and height",function(){expect(this.view.options.width).toEqual(300),expect(this.view.options.height).toEqual(170)}),it("should request an image with user defined dimensions",function(){var a=new e({el:d(this.cardHTML).find(".js-header"),visId:"oooo-llll-aaaa-mmmm",mapsApiResource:"hello.com",username:"javier",width:100,height:99});expect(a.options.width).toEqual(100),expect(a.options.height).toEqual(99)}),it("should pass auth tokens if specified",function(){this.view.options.authTokens=["secure","token"],spyOn(this.view,"_loadImage").and.callThrough(),this.view.load(),expect(this.view._loadImage).toHaveBeenCalledWith(jasmine.any(Object),"http://javier.hello.com/api/v1/map/static/named/tpl_oooo_llll_aaaa_mmmm/300/170.png?auth_token=secure&auth_token=token")}),describe("with vis_id",function(){beforeEach(function(){spyOn(this.view,"_loadImage").and.callThrough()}),it("should generate the image template",function(){expect(this.view._generateImageTemplate()).toEqual("tpl_oooo_llll_aaaa_mmmm")}),it("should generate the image url",function(){this.view.load(),expect(this.view._loadImage).toHaveBeenCalledWith(jasmine.any(Object),"http://javier.hello.com/api/v1/map/static/named/tpl_oooo_llll_aaaa_mmmm/300/170.png")}),it("should generate the image URL with the right protocol",function(){spyOn(this.view,"_isHTTPS").and.returnValue(!0),this.view.load(),expect(this.view._loadImage).toHaveBeenCalledWith(jasmine.any(Object),"https://javier.hello.com/api/v1/map/static/named/tpl_oooo_llll_aaaa_mmmm/300/170.png")}),it("should not generate the url with username + maps api host",function(){this.view.options.mapsApiResource="hello.com/user/javier",this.view.load(),expect(this.view._loadImage).toHaveBeenCalledWith(jasmine.any(Object),"http://hello.com/user/javier/api/v1/map/static/named/tpl_oooo_llll_aaaa_mmmm/300/170.png")})}),describe("with vis_id and cdn",function(){beforeEach(function(){c.config.set("cdn_url",{http:"cdn.url.com",https:"cdns.url.com"}),spyOn(this.view,"_loadImage").and.callThrough()}),it("should generate the image url",function(){this.view.load(),expect(this.view._loadImage).toHaveBeenCalledWith(jasmine.any(Object),"http://cdn.url.com/javier/api/v1/map/static/named/tpl_oooo_llll_aaaa_mmmm/300/170.png")}),it("should generate the image URL with the right protocol",function(){spyOn(this.view,"_isHTTPS").and.returnValue(!0),this.view.load(),expect(this.view._loadImage).toHaveBeenCalledWith(jasmine.any(Object),"https://cdns.url.com/javier/api/v1/map/static/named/tpl_oooo_llll_aaaa_mmmm/300/170.png")}),afterEach(function(){c.config.unset("cdn_url")})}),it("should have no leaks",function(){this.view.load(),expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/views/mapcard_preview":256}],453:[function(a,b,c){(function(b){function c(a,b){var c=d.Event("keydown");return c.which=a,c.keyCode=a,b&&(c.metaKey=!0),c}var d="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,e="undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null,f="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,g=a("../../../../../../javascripts/cartodb/common/views/paged_search/paged_search_view"),h=a("../../../../../../javascripts/cartodb/common/paged_search_model.js");describe("common/views/paged_search/paged_search_view",function(){beforeEach(function(){this.user=new f.admin.User({id:"user-id",username:"pepe",actions:{},organization:{id:"org-id",users:[{id:"abc-123",username:"paco"},{id:"abc-456",username:"pepe"}]}}),this.organizationUsers=this.user.organization.users;var a=this;this.fakeUsersView=new f.core.View,this.fakeUsersView.render=function(){return this.$el.html("Users: "+a.organizationUsers.map(function(a){return a.get("username")+", "})),this},this.createListViewSpy=jasmine.createSpy("createUsersView").and.callFake(function(){return a.fakeUsersView}),this.pagedSearchModel=new h,spyOn(this.pagedSearchModel,"fetch"),this.view=new g({pagedSearchModel:this.pagedSearchModel,collection:this.organizationUsers,createListView:this.createListViewSpy}),spyOn(this.view,"killEvent"),this.view.render(),this.contentHTML=function(){return this.view._panes.getActivePane().$el.html()}}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should have a tabs panel",function(){expect(this.view._panes).not.toBeUndefined(),expect(e.size(this.view._panes._subviews)).toBe(4)}),it("should fetch users",function(){expect(this.pagedSearchModel.fetch).toHaveBeenCalled()}),describe("when view is intended to be used inside a dialog",function(){beforeEach(function(){this.view.clean(),this.view=new g({isUsedInDialog:!0,pagedSearchModel:this.pagedSearchModel,collection:this.organizationUsers,createListView:this.createListViewSpy}),this.view.render()}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should render the required .Dialog-* classes to position things as expected",function(){expect(this.view.$el.attr("class")).toContain("Dialog-"),expect(this.innerHTML()).toContain("Dialog-")})}),describe("when users are fetched",function(){beforeEach(function(){this.organizationUsers.sync=function(a,b,c){c.success&&c.success({users:[{id:"p1",username:"pierre"}],total_entries:1,total_user_entries:77})},this.organizationUsers.fetch()}),it("should create list view",function(){expect(this.createListViewSpy).toHaveBeenCalled(),expect(this.contentHTML()).toContain("pierre")})}),describe("when a search is initialized",function(){beforeEach(function(){this.pagedSearchModel.fetch.calls.reset(),this.view._$searchInput().val("str"),this.view.$(".js-search-input").trigger(c(d.ui.keyCode.ENTER))}),it("should call fetch on paged search model",function(){expect(this.pagedSearchModel.fetch).toHaveBeenCalledWith(this.organizationUsers)}),it("should show searching",function(){expect(this.contentHTML()).toContain("Searching")}),describe("when search returns an empty result",function(){beforeEach(function(){this.organizationUsers.sync=function(a,b,c){c.success&&c.success({users:[],total_entries:0,total_user_entries:0})},this.organizationUsers.fetch()}),it("should show no-results block",function(){expect(this.contentHTML()).toContain("No results")})}),describe("when search is successfully done",function(){beforeEach(function(){this.createListViewSpy.calls.reset(),this.organizationUsers.sync=function(a,b,c){c.success&&c.success({users:[{id:"abc-123",username:"paco"},{id:"abc-456",username:"pepe"}],total_entries:2,total_user_entries:2})},this.organizationUsers.fetch()}),it("should show results",function(){expect(this.contentHTML()).toContain("pepe"),expect(this.contentHTML()).toContain("paco")}),it("should show clean search button",function(){expect(this.view.$(".js-clean-search").css("display")).not.toBe("none")}),it("should update pagination model",function(){expect(this.view.paginationModel.get("total_count")).toEqual(2)}),describe("when click clean search",function(){beforeEach(function(){this.view.$(".js-clean-search").click()}),it("should reset search",function(){expect(this.view.$(".js-search-input").val()).toEqual(""),expect(this.view.$(".js-clean-search").css("display")).not.toBe("none")})}),describe("when click ESC on search input",function(){beforeEach(function(){this.view.$(".js-search-input").trigger(c(d.ui.keyCode.ESCAPE))}),it("should clear the search when user hits ESCAPE",function(){expect(this.view.$(".js-search-input").val()).toEqual(""),expect(this.view.$(".js-clean-search").css("display")).not.toBe("none")})})})}),describe("when pagination is changed",function(){beforeEach(function(){this.view.paginationModel.set({current_page:2})}),it("should fetch a new page of organization users",function(){expect(this.pagedSearchModel.get("page")).toBe(2),expect(this.pagedSearchModel.fetch).toHaveBeenCalled()})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/paged_search_model.js":227,"../../../../../../javascripts/cartodb/common/views/paged_search/paged_search_view":257}],454:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/views/pagination/model");describe("common/views/pagination/model",function(){describe(".pagesCount",function(){describe("given there are no items",function(){beforeEach(function(){this.m=new d({total_count:0})}),it("should return at least one page",function(){expect(this.m.pagesCount()).toEqual(1)})}),describe("given there are less items than per page",function(){beforeEach(function(){this.m=new d({total_count:6,per_page:7})}),it("should return that there is just one page",function(){expect(this.m.pagesCount()).toEqual(1)})}),describe("given there are one more item than per page",function(){beforeEach(function(){this.m=new d({total_count:4,per_page:3})}),it("should return the upper amount of pages",function(){expect(this.m.pagesCount()).toEqual(2)})})}),describe(".pagesToDisplay",function(){describe("given there are less pages than expected to be visible",function(){beforeEach(function(){this.m=new d({total_count:30,per_page:10,display_count:5})}),it("should return a sequence of integers starting from first page to the last available page",function(){expect(this.m.pagesToDisplay()).toEqual([1,2,3])})}),describe("given there are more pages than expected to be visible",function(){beforeEach(function(){this.m=new d({total_count:130,per_page:10,display_count:5,extras_display_count:1})}),describe("when current page is with the first visible pages",function(){it("should return a sequence of integers relative to current page",function(){var a=[1,2,3,4,5,-2,13];expect(this.m.set("current_page",1).pagesToDisplay()).toEqual(a),expect(this.m.set("current_page",2).pagesToDisplay()).toEqual(a),expect(this.m.set("current_page",3).pagesToDisplay()).toEqual(a)})}),describe("when current page is within lower threshold for extras",function(){it("should display additional pages too since they are still within the sequence",function(){expect(this.m.set("current_page",4).pagesToDisplay()).toEqual([1,2,3,4,5,6,-2,13]),expect(this.m.set("current_page",5).pagesToDisplay()).toEqual([1,2,3,4,5,6,7,-2,13])})}),describe("when current page is in the middle range of available pages",function(){it("should return a sequence of pages with additional pages separated by undefined",function(){expect(this.m.set("current_page",6).pagesToDisplay()).toEqual([1,-1,4,5,6,7,8,-2,13]),expect(this.m.set("current_page",7).pagesToDisplay()).toEqual([1,-1,5,6,7,8,9,-2,13]),expect(this.m.set("current_page",8).pagesToDisplay()).toEqual([1,-1,6,7,8,9,10,-2,13])})}),describe("when current page is reach threshold",function(){it("should display additional pages too since they are still within the sequence",function(){expect(this.m.set("current_page",9).pagesToDisplay()).toEqual([1,-1,7,8,9,10,11,12,13]),expect(this.m.set("current_page",10).pagesToDisplay()).toEqual([1,-1,8,9,10,11,12,13])})}),describe("when current page is within the upper threshold for extras",function(){it("should return a sequence of integers of the last visible pages",function(){var a=[1,-1,9,10,11,12,13];expect(this.m.set("current_page",11).pagesToDisplay()).toEqual(a),expect(this.m.set("current_page",12).pagesToDisplay()).toEqual(a),expect(this.m.set("current_page",13).pagesToDisplay()).toEqual(a)})})})}),describe(".isCurrentPage",function(){beforeEach(function(){this.m=new d({current_page:42})}),it("should return true if given page is current",function(){expect(this.m.isCurrentPage(42)).toBeTruthy(),expect(this.m.isCurrentPage(-1)).toBeFalsy()})}),describe(".hasUrl",function(){beforeEach(function(){this.newModel=function(a){return new d(a)}}),it("should return true if there is a url_to method set",function(){expect(this.newModel({}).hasUrl()).toBeFalsy(),expect(this.newModel({url_to:!0}).hasUrl()).toBeFalsy(),expect(this.newModel({url_to:{}}).hasUrl()).toBeFalsy(),expect(this.newModel({url_to:function(){}}).hasUrl()).toBeTruthy()})})})},{"../../../../../../javascripts/cartodb/common/views/pagination/model":258}],455:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/views/pagination/model"),e=a("../../../../../../javascripts/cartodb/common/views/pagination/view"),f=a("../../../../../../javascripts/cartodb/common/router.js");describe("common/views/pagination/view",function(){beforeEach(function(){var a=new cdb.common.DashboardUrl({base_url:"http://pepe.carto.com/dashboard/datasets"});this.model=new d({total_count:9e3,per_page:50,current_page:42,url_to:function(b){return a.urlToPath(b)}}),spyOn(this.model,"bind").and.callThrough(),this.router=new f({dashboardUrl:a}),spyOn(this.router,"navigate"),this.createView=function(){this.view=new e({model:this.model,router:this.router})},this.createView(),this.view.render()}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should render current page and the total count",function(){expect(this.innerHTML()).toContain("Page 42 of 180")}),it("should render URLs by provided url_to function",function(){expect(this.innerHTML()).toContain("http://pepe.carto.com/dashboard/datasets/40"),expect(this.innerHTML()).toContain("http://pepe.carto.com/dashboard/datasets/44")}),it("should re-render on model change",function(){expect(this.model.bind).toHaveBeenCalledWith("change",this.view.render,this.view)}),describe("given there are no items",function(){beforeEach(function(){this.model.set({total_count:0,current_page:1})}),it("should not render pagination items at all",function(){expect(this.innerHTML()).not.toContain("Page "),expect(this.innerHTML()).not.toContain("Pagination-label"),expect(this.innerHTML()).not.toContain("Pagination-list")})}),describe("given there is only one page",function(){beforeEach(function(){this.model.set({total_count:this.model.get("per_page"),current_page:1})}),it("should not render pagination label",function(){expect(this.innerHTML()).not.toContain("Page 1 of 1")}),it("should not render pagination list",function(){expect(this.innerHTML()).not.toContain("Pagination-list")})}),describe("given current page is larger than available page",function(){beforeEach(function(){this.model.set({total_count:this.model.get("per_page"),current_page:9e3})}),it("should not render pagination list",function(){expect(this.innerHTML()).not.toContain("Pagination-list")})}),describe("click a link",function(){beforeEach(function(){this.clickLink=function(){this.view.$("a").click()},this.model.bind("change",function(){this.called=!0},this)}),describe("when view is created with a router",function(){beforeEach(function(){this.clickLink()}),it("should navigate through router",function(){expect(this.router.navigate).toHaveBeenCalled()}),it("should update the current page",function(){expect(this.called).toBeTruthy()})}),describe("when view is not created with a router",function(){beforeEach(function(){this.router=void 0,this.createView(),this.view.render(),this.clickLink()}),it("should update the current page",function(){expect(this.called).toBeTruthy()}),describe("when model doesn't have any url method",function(){beforeEach(function(){this.model.set("url_to",void 0),spyOn(this.view,"killEvent").and.callThrough(),spyOn(this.model,"set"),this.view.$("a").click()}),it("should prevent default click behaviour",function(){expect(this.view.killEvent).toHaveBeenCalled(),expect(this.model.set).toHaveBeenCalled()}),it("should update the model with new current page",function(){expect(this.model.set).toHaveBeenCalled(),expect(this.model.set).toHaveBeenCalledWith("current_page",jasmine.any(Number))})})})}),afterEach(function(){this.view.clean()})})},{"../../../../../../javascripts/cartodb/common/router.js":228,"../../../../../../javascripts/cartodb/common/views/pagination/model":258,"../../../../../../javascripts/cartodb/common/views/pagination/view":259}],456:[function(a,b,c){var d=a("../../../../javascripts/cartodb/common/visualizations_fetch_model");describe("common/visualizations_fetch_model",function(){beforeEach(function(){this.model=new d({shared:!1,page:1})}),describe(".isSearching",function(){it("should return true if set to a search or tag query",function(){this.model.set({q:"",tag:""}),expect(this.model.isSearching()).toBeFalsy(),this.model.set({q:"foobar",tag:""}),expect(this.model.isSearching()).toBeTruthy(),this.model.set({q:"",tag:"some-tag"}),expect(this.model.isSearching()).toBeTruthy()})}),describe(".isDeepInsights",function(){it("should return true if content_type is maps and deep-insights are enabled",function(){this.model.set({content_type:"datasets",deepInsights:!0}),expect(this.model.isDeepInsights()).toBeFalsy(),this.model.set({content_type:"maps"}),expect(this.model.isDeepInsights()).toBeTruthy(),this.model.set({deepInsights:!1}),expect(this.model.isDeepInsights()).toBeFalsy()})})})},{"../../../../javascripts/cartodb/common/visualizations_fetch_model":261}],457:[function(a,b,c){var d=a("../../../../javascripts/cartodb/dashboard/background_polling_model"),e=a("../../../../javascripts/cartodb/common/background_polling/models/imports_collection");describe("dashboard/background_polling_model",function(){beforeEach(function(){this.user=new cdb.admin.User({username:"pepe",base_url:"http://pepe.carto.com"}),this.importsCollection=new e(void 0,{user:this.user}),this.model=new d({},{user:this.user,importsCollection:this.importsCollection}),spyOn(this.model,"_redirectTo")}),describe("when an imports model has completed and all is good should redirect directly to the editor of its dataset",function(){beforeEach(function(){this.importsCollection.reset({}),this.importsModel=this.importsCollection.at(0),this.url=new cdb.common.MapUrl({base_url:"http://pepe.carto.com/viz/abc-123"}),spyOn(cdb.admin.Visualization.prototype,"viewUrl").and.returnValue(this.url),this.importsModel.imp.set({tables_created_count:1,service_name:"other",table_name:"foobar"})}),it("should redirect to vis that got imported if was completed, only one table was created, and the service name is not twitter search",function(){this.importsModel.set("step","import"),this.importsModel.imp.set("state","complete"),expect(this.model._redirectTo).toHaveBeenCalled(),expect(this.model._redirectTo.calls.argsFor(0)[0]).toEqual("http://pepe.carto.com/viz/abc-123/map"),expect(cdb.admin.Visualization.prototype.viewUrl).toHaveBeenCalledWith(this.user)}),it("should not redirect if not complete yet",function(){this.importsModel.set("state","whatever"),expect(this.model._redirectTo).not.toHaveBeenCalled()}),it("should not redirect if there is no imported vis",function(){this.model.set("importLimit","whatever"),expect(this.model._redirectTo).not.toHaveBeenCalled()}),it("should not redirect if importLimit is set",function(){this.importsModel.imp.set("tablename",void 0),this.model.set("importLimit","whatever"),expect(this.model._redirectTo).not.toHaveBeenCalled()}),it("should not redirect if more than one table is created",function(){this.importsModel.imp.set("tables_created_count",2),this.importsModel.set("state","complete"),expect(this.model._redirectTo).not.toHaveBeenCalled()}),it("should not redirect if service name is twitter search",function(){this.importsModel.imp.set("service_name","twitter_search"),this.importsModel.set("state","complete"),expect(this.model._redirectTo).not.toHaveBeenCalled()})})})},{"../../../../javascripts/cartodb/common/background_polling/models/imports_collection":13,"../../../../javascripts/cartodb/dashboard/background_polling_model":262}],458:[function(a,b,c){(function(b){var c=a("../../../../javascripts/cartodb/dashboard/content_controller_view"),d=a("../../../../javascripts/cartodb/dashboard/router"),e=a("../../../../javascripts/cartodb/common/local_storage"),f="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null,g="undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null;describe("dashboard/content_controller_view",function(){beforeEach(function(){this.ownerAttrs={base_url:"http://paco.carto.com",username:"paco"},this.user=new f.User(this.ownerAttrs),this.router=new d({dashboardUrl:this.user.viewUrl().dashboard()}),spyOn(this.router.model,"bind").and.callThrough(),this.collection=new f.Visualizations,spyOn(this.collection,"bind").and.callThrough(),this.vis=new f.Visualization({privacy:"public",permission:{owner:this.ownerAttrs}}),this.localStorage=new e("test"),this.view=new c({user:this.user,router:this.router,collection:this.collection,localStorage:this.localStorage}),window.defaultFallbackMapBaselayer={url:""}}),it("should render properly",function(){this.view.render(),expect(g.size(this.view._subviews)).toBe(9)}),describe("router changes",function(){describe("when content type is not defined",function(){it("should show main loader when content_type changes",function(){this.collection.total_user_entries=10,this.router.model.set({content_type:"datasets"}),expect(this.view._isBlockEnabled("main_loader")).toBeTruthy(),this.collection.reset([this.vis]),this.router.model.set({tag:"test"}),expect(this.view._isBlockEnabled("main_loader")).toBeFalsy()})}),describe("when content type has changed",function(){it("should show main loader when content_type changes",function(){this.router.model.set({content_type:"datasets"},{silent:!0}),this.collection.reset([this.vis]),expect(this.view._isBlockEnabled("list")).toBeTruthy(),this.router.model.set({content_type:"maps"}),expect(this.view._isBlockEnabled("main_loader")).toBeTruthy()})}),describe("when content type hasn't changed",function(){it("should show small loader when router changes",function(){this.collection.total_user_entries=3,this.router.model.set({content_type:"datasets"},{silent:!0}),this.collection.reset([this.vis]),this.router.model.set({tag:"paco"}),expect(this.view._isBlockEnabled("main_loader")).toBeFalsy()}),it("should show main loader when content type doesn't change but user didn't have entries",function(){this.router.model.set({
content_type:"datasets"},{silent:!0}),this.collection.total_user_entries=0,this.collection.reset([this.vis]),this.router.model.set({shared:"only"}),expect(this.view._isBlockEnabled("main_loader")).toBeTruthy()})})}),describe("collection changes",function(){it("should show list when collection fetch works",function(){this.router.model.set({content_type:"datasets"}),this.collection.reset([this.vis]),expect(this.view._isBlockEnabled("list")).toBeTruthy(),expect(this.view._isBlockEnabled("content_footer")).toBeTruthy(),expect(this.view._isBlockEnabled("main_loader")).toBeFalsy(),expect(g.size(this.view.enabledViews)).toBe(3)}),it("should show error block when collection fetch fails",function(){this.router.model.set({content_type:"datasets"}),this.collection.trigger("loading"),expect(this.view._isBlockEnabled("error")).toBeFalsy(),this.collection.trigger("error"),expect(this.view._isBlockEnabled("error")).toBeTruthy(),expect(this.view._isBlockEnabled("list")).toBeFalsy(),expect(g.size(this.view.enabledViews)).toBe(2)}),it("shouldn't show error block when collection fetch is aborted",function(){this.router.model.set({content_type:"datasets"}),this.collection.trigger("loading"),expect(this.view._isBlockEnabled("error")).toBeFalsy(),this.collection.trigger("error",this.collection,{statusText:"abort"},{}),expect(this.view._isBlockEnabled("error")).toBeFalsy(),expect(g.size(this.view.enabledViews)).toBe(2)}),it("should redirect to shared route when collection is empty, none of the filters are applied but shared datasets are present, being in datasets",function(){var a,b="";this.router.navigate=function(c,d){b=c,a=d},this.router.model.set({content_type:"datasets"},{silent:!0}),this.collection.total_shared=10,this.collection.reset([]),expect(b.toString().search("shared")!==-1).toBeTruthy(),expect(a).toEqual({trigger:!0})}),it("should redirect to library route when collection is empty and none of the filters are applied, being in datasets",function(){cdb.config.set("data_library_enabled",!0);var a,b="";this.router.navigate=function(c,d){b=c,a=d},this.router.model.set({content_type:"datasets"},{silent:!0}),this.collection.total_shared=0,this.collection.reset([]),expect(b.toString().search("library")!==-1).toBeTruthy(),expect(a).toEqual({trigger:!0})}),it("should show empty datasets when collection is empty, none of the filters are applied and data library is disabled",function(){cdb.config.set("data_library_enabled",!1),this.router.model.set({content_type:"datasets",library:!0}),this.collection.total_user_entries=0,this.collection.reset([]),expect(this.view._isBlockEnabled("no_datasets")).toBeTruthy()}),it("should show empty datasets when visits library and user didn't have any dataset",function(){this.router.model.set({content_type:"datasets",library:!0}),this.collection.total_user_entries=0,this.collection.reset([]),expect(this.view._isBlockEnabled("no_datasets")).toBeTruthy()}),it("should show onboarding map when collection is empty and content_type is in maps",function(){spyOn(cdb,"createVis"),this.router.model.set({content_type:"maps"},{silent:!0}),this.collection.reset([]),expect(this.view._isBlockEnabled("no_results")).toBeFalsy(),expect(this.view._isBlockEnabled("onboarding")).toBeTruthy(),expect(cdb.createVis).toHaveBeenCalled()}),it("should show loading library when collection is empty and trying to see library",function(){this.router.model.set({library:!0,shared:"no"},{silent:!0}),this.collection.reset([]),expect(this.view._isBlockEnabled("loading_library")).toBeTruthy(),expect(this.view._isBlockEnabled("no_datasets")).toBeFalsy()}),it("should show no_results block when collection is empty and any of the filters are enabled",function(){this.router.model.set({content_type:"datasets",tag:"jar"},{silent:!0}),this.collection.reset([]),expect(this.view._isBlockEnabled("no_results")).toBeTruthy(),this.router.model.set({q:"paco"},{silent:!0}),this.collection.reset([]),expect(this.view._isBlockEnabled("no_results")).toBeTruthy()})}),it("should have no leaks",function(){this.view.render(),expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean(),window.defaultFallbackBasemapTemplateUrl=void 0,delete window.defaultFallbackBasemapTemplateUrl})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/common/local_storage":223,"../../../../javascripts/cartodb/dashboard/content_controller_view":263,"../../../../javascripts/cartodb/dashboard/router":279}],459:[function(a,b,c){(function(b){var c=a("../../../../../javascripts/cartodb/common/views/pagination/model"),d=a("../../../../../javascripts/cartodb/common/views/pagination/view"),e=a("../../../../../javascripts/cartodb/dashboard/content_footer/view"),f="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,g=a("../../../../../javascripts/cartodb/dashboard/router"),h="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null;describe("dashboard/content_footer/view",function(){beforeEach(function(){var a=h('<div class="ContentFooter"></div>');this.collection=new f.admin.Visualizations,spyOn(this.collection,"bind").and.callThrough();var b=new f.common.DashboardUrl({base_url:"http://paco.carto.com"});this.router=new g({dashboardUrl:b}),spyOn(this.router.model,"bind").and.callThrough(),spyOn(c.prototype,"initialize").and.callThrough(),spyOn(c.prototype,"set").and.callThrough(),spyOn(d.prototype,"initialize").and.callThrough(),spyOn(d.prototype,"render").and.callThrough(),spyOn(d.prototype,"clean").and.callThrough(),this.view=new e({el:a[0],collection:this.collection,router:this.router}),spyOn(this.view,"clearSubViews").and.callThrough()}),it("should listen to change events on router model",function(){expect(this.router.model.bind).toHaveBeenCalledWith("change",this.view.render,this.view)}),describe("should create a pagination view",function(){it("with a pagination model args",function(){expect(d.prototype.initialize).toHaveBeenCalled();var a=d.prototype.initialize.calls.argsFor(0)[0];expect(a).toEqual(jasmine.objectContaining({model:jasmine.any(Object)})),expect(a).toEqual(jasmine.objectContaining({router:this.router}))}),it("but not render just yet",function(){expect(d.prototype.render).not.toHaveBeenCalled()}),it("which model should be initially configured for routing",function(){var a=c.prototype.initialize.calls.argsFor(0)[0];expect(a).toEqual(jasmine.objectContaining({current_page:jasmine.any(Number)})),expect(a).toEqual(jasmine.objectContaining({url_to:jasmine.any(Function)}))}),it("which updates on collection changes",function(){expect(this.collection.bind).toHaveBeenCalledWith("all",jasmine.any(Function))}),describe("which given a collection change event is triggered",function(){beforeEach(function(){this.collection.trigger("change")}),it("should update the pagination model accordingly",function(){expect(c.prototype.set).toHaveBeenCalledWith(jasmine.objectContaining({per_page:this.collection.options.get("per_page")})),expect(c.prototype.set).toHaveBeenCalledWith(jasmine.objectContaining({total_count:this.collection.total_entries}))})}),describe("which given a router model change event is triggered",function(){beforeEach(function(){this.router.model.set("total_count",0)}),it("should update the pagination model accordingly",function(){expect(c.prototype.set).toHaveBeenCalledWith("current_page",this.router.model.get("page"))})})}),describe(".render",function(){beforeEach(function(){this.view.render()}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should clean subviews on render",function(){expect(this.view.clearSubViews).toHaveBeenCalled()}),it("should render pagination view",function(){expect(d.prototype.render).toHaveBeenCalled()}),it("should append the PaginationView to this el",function(){expect(this.innerHTML()).toContain("Pagination")}),it("should render an empty lockedvis content by default",function(){expect(this.innerHTML()).toContain("filter-shortcut")})}),describe("should not request unlocked/locked info when a filter parameter is applied",function(){beforeEach(function(){spyOn(this.view.filterShortcutVis,"fetch")}),it("for example shared",function(){this.router.model.set("shared","only"),this.collection.reset(),expect(this.view.filterShortcutVis.fetch).not.toHaveBeenCalled(),expect(this.view.clearSubViews).toHaveBeenCalled()}),it("for example library",function(){this.router.model.set("library",!0),this.collection.reset([{a:"a"}]),expect(this.view.filterShortcutVis.fetch).not.toHaveBeenCalled(),expect(this.view.clearSubViews).toHaveBeenCalled()}),it("for example any search",function(){this.router.model.set("q","hello"),this.collection.reset([{a:"a"}]),expect(this.view.filterShortcutVis.fetch).not.toHaveBeenCalled(),expect(this.view.clearSubViews).toHaveBeenCalled(),this.router.model.set({q:"",tag:"hello"}),this.collection.reset(),expect(this.view.filterShortcutVis.fetch).not.toHaveBeenCalled()})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/views/pagination/model":258,"../../../../../javascripts/cartodb/common/views/pagination/view":259,"../../../../../javascripts/cartodb/dashboard/content_footer/view":264,"../../../../../javascripts/cartodb/dashboard/router":279}],460:[function(a,b,c){(function(b){var c=a("../../../../../javascripts/cartodb/dashboard/datasets/datasets_item"),d=a("../../../../../javascripts/cartodb/common/dialogs/sync_dataset/sync_dataset_view"),e=a("../../../../../javascripts/cartodb/dashboard/router"),f="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null;describe("dashboard/datasets/datasets_item",function(){beforeEach(function(){this.tablemetadata={name:'"paco".my_dataset',row_count:9e3,size:1e3,geometry_types:["st_point"]},this.vis=new f.admin.Visualization({name:"my_dataset",type:"table",privacy:"PRIVATE",updated_at:(new Date).toISOString(),likes:42,table:this.tablemetadata,permission:{owner:{base_url:"http://team.carto.com/u/paco",username:"paco"}}}),spyOn(this.vis,"on").and.callThrough(),this.user=new f.admin.User({base_url:"http://team.carto.com/u/pepe",username:"pepe"}),this.router=new e({dashboardUrl:this.user.viewUrl().dashboard()}),this.router.model.set("content_type","datasets"),this.view=new c({model:this.vis,user:this.user,router:this.router}),this.renderView=function(){this.view.render()}}),it("should have no leaks",function(){this.renderView(),expect(this.view).toHaveNoLeaks()}),it("should be a bind listening vis changes",function(){var a=this.vis.on.calls.argsFor(0);expect(a[0]).toEqual("change"),expect(a[1]).toEqual(this.view.render),expect(a[2]).toEqual(this.view)}),it("should render the title",function(){this.renderView(),expect(this.innerHTML()).toContain("my_dataset")}),it("should render the URL to dataset, from the perspective of current user",function(){this.renderView(),expect(this.innerHTML()).toContain("http://team.carto.com/u/pepe/tables/paco.my_dataset")}),it("should render likes count",function(){this.renderView(),expect(this.innerHTML()).toContain("42")}),it("should render row count",function(){this.renderView(),expect(this.innerHTML()).toContain("9,000 Rows")}),it("should render table size",function(){this.renderView(),expect($(this.innerHTML()).find(".js-sizeIndicator").length).toBe(1),expect($(this.innerHTML()).find(".js-sizeIndicator").text()).toContain("1000 bytes")}),it("should render table geometry type",function(){this.renderView(),expect(this.view.$(".DatasetsList-itemCategory").length).toBe(1),expect(this.view.$(".DatasetsList-itemCategory").hasClass("is--pointDataset")).toBeTruthy()}),it("should render raster icon when dataset is raster",function(){this.vis.set("kind","raster"),this.renderView(),expect(this.view.$(".DatasetsList-itemCategory").length).toBe(1),expect(this.view.$(".DatasetsList-itemCategory").hasClass("is--pointDataset")).toBeFalsy(),expect(this.view.$(".DatasetsList-itemCategory").hasClass("is--rasterDataset")).toBeTruthy()}),it("should render privacy",function(){this.renderView(),expect(this.innerHTML()).toContain("private")}),it("should render timediff",function(){this.renderView(),expect(this.innerHTML()).toContain("a few seconds ago")}),it("should render sync info",function(){this.renderView(),expect(this.view.$(".DatasetsList-itemStatus").length).toBe(0),this.vis.set("synchronization",{state:"success",run_at:"2012-2-2"}),this.renderView(),expect(this.view.$(".DatasetsList-itemStatus").length).toBe(1),expect(this.view.$(".DatasetsList-itemStatus").hasClass("CDB-IconFont")).toBeTruthy(),expect(this.view.$(".DatasetsList-itemStatus").hasClass("is-success")).toBeTruthy()}),it("should render sync and public dataset info",function(){this.renderView(),expect(this.view.$(".DatasetsList-itemStatus").length).toBe(0),this.vis.set("synchronization",{from_external_source:!0,state:"success",run_at:"2012-2-2"}),this.renderView(),expect(this.view.$(".DatasetsList-aditionalItemStatus").length).toBe(1),expect(this.view.$(".DatasetsList-itemStatus").length).toBe(2),expect(this.view.$(".DatasetsList-itemStatus").hasClass("CDB-IconFont")).toBeTruthy(),expect(this.view.$(".DatasetsList-itemStatus").hasClass("is-success")).toBeTruthy()}),it("should render an editable field with the description",function(){this.vis.set("description","my desc"),this.renderView(),expect(this.view.$(".DatasetsList-itemDescription.EditableField").length).toBe(1),expect(this.view.$(".js-description").length).toBe(1),expect(this.view.$(".js-description")[0].textContent).toEqual("my desc")}),it("should render an editable field with the tags",function(){this.vis.set("tags",["tag1"]),this.renderView(),expect(this.view.$(".js-item-tags").length).toBe(1),expect(this.view.$(".js-tag-link").length).toBe(1),expect(this.view.$(".js-tag-link")[0].textContent.trim()).toEqual("tag1")}),it("should be able to select the model",function(){this.renderView(),this.view.$el.click(),expect(this.view.$el.hasClass("is--selected")).toBeTruthy()}),describe("given visualization is of kind raster",function(){beforeEach(function(){this.vis.set("kind","raster")}),it("should title as a non-link disabled item",function(){this.renderView(),expect(this.innerHTML()).not.toContain("/tables/my_dataset")})}),describe("given row_count is not set",function(){beforeEach(function(){this.vis.tableMetadata().unset("row_count")}),it("should not render row count",function(){this.renderView(),expect(this.innerHTML()).not.toContain("Rows")})}),describe("given user owns dataset",function(){beforeEach(function(){spyOn(this.vis.permission,"isOwner").and.returnValue(!0)}),it("should not render permission indicator",function(){this.renderView(),expect(this.innerHTML()).not.toContain("PermissionIndicator"),expect(this.innerHTML()).not.toContain("READ")}),it("should not render user avatar",function(){expect(this.innerHTML()).not.toContain("UserAvatar")})}),describe("given user does NOT own dataset",function(){beforeEach(function(){spyOn(this.vis.permission,"isOwner").and.returnValue(!1)}),it("should render user avatar",function(){this.renderView(),expect(this.innerHTML()).toContain("UserAvatar")}),describe("and do not have write access",function(){beforeEach(function(){spyOn(this.vis.permission,"hasWriteAccess").and.returnValue(!1)}),it("should render read-only indicator",function(){this.renderView(),expect(this.vis.permission.hasWriteAccess).toHaveBeenCalledWith(this.user),expect(this.innerHTML()).toContain("READ"),expect(this.innerHTML()).toContain("PermissionIndicator")})})}),describe("given there are at least one tag",function(){beforeEach(function(){this.vis.set("tags",["ole","dole","doff","kinke","lane","koff"])}),it("should only render first three",function(){this.renderView(),expect(this.innerHTML()).toContain("ole"),expect(this.innerHTML()).toContain("dole"),expect(this.innerHTML()).toContain("doff"),expect(this.innerHTML()).not.toContain("kinke"),expect(this.innerHTML()).not.toContain("lane"),expect(this.innerHTML()).not.toContain("koff")}),it("should render a text of how many tags remain",function(){this.renderView(),expect(this.innerHTML()).toContain("and 3 more")}),it("each tag should have a URL to the tag",function(){this.renderView(),expect(this.innerHTML()).toContain("tag/ole"),expect(this.innerHTML()).toContain("tag/dole"),expect(this.innerHTML()).toContain("tag/doff")})}),describe("click item",function(){describe("given clicked target is NOT a link",function(){beforeEach(function(){spyOn(this.view,"killEvent"),this.renderView(),this.clickEl=function(){this.view.$el.click()},this.clickEl()}),it("should kill default event behaviour",function(){expect(this.view.killEvent).toHaveBeenCalledWith(this.view.killEvent.calls.argsFor(0)[0])}),it("should toggle selected state on dataset",function(){expect(this.vis.get("selected")).toBeTruthy(),this.clickEl(),expect(this.vis.get("selected")).toBeFalsy()})})}),describe("when click .js-privacy",function(){beforeEach(function(){this.renderView(),f.god.bind("openPrivacyDialog",function(a){this.openendPrivacyDialog=a},this),this.view.$(".js-privacy").click()}),it("should call global event bus to open privacy dialog",function(){expect(this.openendPrivacyDialog).toBeTruthy()}),it("should created dialog with selected items",function(){expect(this.openendPrivacyDialog).toEqual(this.vis)})}),describe("when click .js-sync",function(){beforeEach(function(){this.vis.set("synchronization",{ran_at:"20150818",state:"synced"}),this.renderView(),spyOn(d.prototype,"initialize").and.callThrough(),spyOn(d.prototype,"appendToBody"),this.view.$(".js-sync").click()}),it("should create a sync dialog and append to body",function(){expect(d.prototype.appendToBody).toHaveBeenCalled()}),it("should create dialog w/ vis table",function(){expect(d.prototype.initialize).toHaveBeenCalledWith(jasmine.objectContaining({table:this.view.model.tableMetadata()}))})}),describe("when click .js-sync in a synced dataset",function(){beforeEach(function(){this.vis.set("synchronization",{ran_at:"20150818",state:"synced",from_external_source:!0}),this.renderView(),spyOn(d.prototype,"initialize").and.callThrough(),spyOn(d.prototype,"appendToBody"),this.view.$(".js-sync").click()}),it("shouldn't create a sync dialog and append to body",function(){expect(d.prototype.appendToBody).not.toHaveBeenCalled()}),it("shouldn't create dialog w/ vis table",function(){expect(d.prototype.initialize).not.toHaveBeenCalledWith(jasmine.objectContaining({table:this.view.model.tableMetadata()}))})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/dialogs/sync_dataset/sync_dataset_view":205,"../../../../../javascripts/cartodb/dashboard/datasets/datasets_item":266,"../../../../../javascripts/cartodb/dashboard/router":279}],461:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../../javascripts/cartodb/common/dialogs/create/create_content"),e=a("../../../../../../javascripts/cartodb/common/dialogs/create/create_map_model"),f="undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null,g="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null;describe("common/dialogs/create/create_content",function(){beforeEach(function(){this.user=new c.admin.User({base_url:"http://paco.carto.com",username:"paco"}),this.model=new e({type:"map",option:"templates"},{user:this.user});var a=g("<div>").append(c.templates.getTemplate("common/views/create/dialog_template")());this.view=new d({el:a,user:this.user,model:this.model}),this.view.render()}),it("should render correctly",function(){expect(f.size(this.view._subviews)).toBe(5),expect(this.view.createPane).toBeDefined(),expect(this.view.$(".Filters--navListing").length).toBe(1),expect(this.view.$(".CreateDialog-listing").length).toBe(1)}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/create/create_content":63,"../../../../../../javascripts/cartodb/common/dialogs/create/create_map_model":69}],462:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/create/create_footer"),e=a("../../../../../../javascripts/cartodb/common/dialogs/create/create_map_model");a("../../../../../../javascripts/cartodb/common/map_templates");describe("common/dialogs/create/create_footer_view",function(){beforeEach(function(){this.user=new cdb.admin.User({base_url:"http://paco.carto.com",username:"paco"}),this.model=new e({type:"dataset",option:"listing"},{user:this.user}),this.view=new d({user:this.user,createModel:this.model,currentUserUrl:this.currentUserUrl}),spyOn(this.model,"bind").and.callThrough(),this.view.render()}),it("should bind createModel attribute changes",function(){this.view._initBinds();var a=this.model.bind.calls.argsFor(0);expect(a[0]).toEqual("change");var b=this.model.bind.calls.argsFor(1);expect(b[0]).toEqual("change:upload");var c=this.model.bind.calls.argsFor(2);expect(c[0]).toEqual("change:option");var d=this.model.bind.calls.argsFor(3);expect(d[0]).toEqual("change:listing")}),describe("guessing toggler",function(){it("should not change guessing model when upload changes",function(){expect(this.view.guessingModel.get("guessing")).toBeTruthy(),expect(this.model.upload.get("type_guessing")).toBeTruthy(),expect(this.model.upload.get("content_guessing")).toBeTruthy(),this.model.upload.setGuessing(!1),expect(this.view.guessingModel.get("guessing")).toBeTruthy(),expect(this.model.upload.get("type_guessing")).toBeFalsy(),expect(this.model.upload.get("content_guessing")).toBeFalsy()}),it("should change guessing values when upload is ready to start",function(){this.view.guessingModel.set("guessing",!0),this.model.upload.set({type:"url",value:"https://carto.com/csv.example"}),this.model.upload.setGuessing(!1),this.view._connectDataset(),expect(this.model.upload.get("type_guessing")).toBeTruthy(),expect(this.model.upload.get("content_guessing")).toBeTruthy()})}),describe("privacy toggler",function(){beforeEach(function(){this.model.set({listing:"import",type:"datasets"})}),it("should not change privacy model when upload changes",function(){expect(this.view.privacyModel.get("privacy")).toBe("PUBLIC"),this.model.upload.set("privacy","PRIVATE"),expect(this.view.privacyModel.get("privacy")).toBe("PUBLIC"),expect(this.model.upload.get("privacy")).toBe("PRIVATE")}),it("should change privacy value when upload is ready to start",function(){this.view.privacyModel.set("privacy","PRIVATE"),this.model.upload.set({type:"url",value:"https://carto.com/csv.example",privacy:"PUBLIC"}),this.view._connectDataset(),expect(this.model.upload.get("privacy")).toBe("PRIVATE")}),it("should not change privacy value if create model is not in import state",function(){this.model.set({listing:"",type:"maps"}),this.view.privacyModel.set("privacy","PRIVATE"),this.model.upload.set({type:"url",value:"https://carto.com/csv.example",privacy:"PUBLIC"}),this.view._connectDataset(),expect(this.model.upload.get("privacy")).not.toBe("PRIVATE")})}),it("should show start tutorial link when there is no datasets selected",function(){this.model.selectedDatasets.reset(),this.view.render(),expect(this.view.$el.text()).toContain("a video tutorial"),expect(this.view.$(".js-videoTutorial").length).toBe(1),this.model.selectedDatasets.reset([{hola:"hola"}]),this.view.render(),expect(this.view.$el.text()).not.toContain("start with a video tutorial"),expect(this.view.$(".js-videoTutorial").length).toBe(0)}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})},{"../../../../../../javascripts/cartodb/common/dialogs/create/create_footer":65,"../../../../../../javascripts/cartodb/common/dialogs/create/create_map_model":69,"../../../../../../javascripts/cartodb/common/map_templates":226}],463:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/create/create_header"),e=a("../../../../../../javascripts/cartodb/common/dialogs/create/create_map_model");describe("common/dialogs/create/create_header_view",function(){beforeEach(function(){cdb.config.set("account_host","paco"),this.user=new cdb.admin.User({username:"paco",base_url:"http://paco.cartdb.com"}),this.model=new e({type:"dataset",option:"listing"},{user:this.user}),this.view=new d({user:this.user,model:this.model}),spyOn(this.model,"bind").and.callThrough(),this.view.render()}),it("should render correctly",function(){expect(this.view.$(".CreateDialog-headerStep").length).toBe(1),expect(this.view.$(".CreateDialog-headerStep").hasClass("is-selected")).toBeTruthy()}),it("should render when state attribute changes",function(){this.view._initBinds();var a=this.model.bind.calls.argsFor(0);expect(a[0]).toEqual("change:option")}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})},{"../../../../../../javascripts/cartodb/common/dialogs/create/create_header":66,"../../../../../../javascripts/cartodb/common/dialogs/create/create_map_model":69}],464:[function(a,b,c){(function(b){var c=a("../../../../../../javascripts/cartodb/common/dialogs/create/create_listing"),d=a("../../../../../../javascripts/cartodb/common/dialogs/create/create_map_model"),e="undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null;describe("common/dialogs/create/create_listing",function(){beforeEach(function(){this.user=new cdb.admin.User({base_url:"http://paco.carto.com",username:"paco"}),this.model=new d({},{user:this.user}),this.view=new c({user:this.user,createModel:this.model,currentUserUrl:this.currentUserUrl}),spyOn(this.model.collection,"fetch"),spyOn(this.view.createModel,"bind").and.callThrough(),spyOn(this.model.visFetchModel,"bind").and.callThrough(),this.view.render()}),it("should render correctly",function(){this.model.set("option","listing"),expect(e.size(this.view._subviews)).toBe(1)}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/common/dialogs/create/create_listing":67,"../../../../../../javascripts/cartodb/common/dialogs/create/create_map_model":69}],465:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/common/dialogs/create/create_view"),e=a("../../../../../../javascripts/cartodb/common/dialogs/create/create_map_model");describe("common/dialogs/create/create_view",function(){beforeEach(function(){this.user=new cdb.admin.User({base_url:"http://paco.carto.com",username:"paco"});var a=new e({},{user:this.user});this.view=new d({model:a,user:this.user,type:"map",currentUserUrl:this.currentUserUrl}),this.view.render()}),it("should render correctly",function(){expect(this.view.$(".CreateDialog-header").length).toBe(1),expect(this.view.$(".Dialog-body--create").length).toBe(1),expect(this.view.$(".CreateDialog-footer").length).toBe(1),expect(this.view.$(".CreateDialog-listing").length).toBe(1)}),it("should have a model included",function(){expect(this.view.model).toBeDefined()}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})},{"../../../../../../javascripts/cartodb/common/dialogs/create/create_map_model":69,"../../../../../../javascripts/cartodb/common/dialogs/create/create_view":70}],466:[function(a,b,c){var d=a("../../../../../../../javascripts/cartodb/common/dialogs/create/footer/guessing_toggler_view"),e=a("../../../../../../../javascripts/cartodb/common/dialogs/create/create_map_model");describe("common/dialogs/create/footer/guessing_toggler",function(){beforeEach(function(){this.user=new cdb.admin.User({base_url:"http://paco.carto.com",username:"paco"}),this.model=new e({type:"map",option:"listing"},{user:this.user}),this.guessingModel=new cdb.core.Model({guessing:!0}),this.view=new d({model:this.guessingModel,createModel:this.model}),spyOn(this.model,"bind").and.callThrough(),this.view.render()}),it("should render properly",function(){expect(this.view.$el.text()).toContain("guess data types and content on import"),expect(this.view.$("button").length).toBe(1),expect(this.view.$("button").hasClass("is-checked")).toBeTruthy()}),it("shouldn't render guessing button when twitter import is selected",function(){this.model.set("option","listing.import.twitter"),expect(this.view.$el.text()).not.toContain("guess data types and content on import"),expect(this.view.$el.text()).toContain("access to historical data"),expect(this.view.$("button").length).toBe(0)}),it("should not change type and content guessing attributes when button is clicked",function(){this.model.upload.set({type:"url",value:"https://carto.com"}),expect(this.model.upload.get("content_guessing")).toBeTruthy(),expect(this.model.upload.get("type_guessing")).toBeTruthy(),expect(this.view.model.get("guessing")).toBeTruthy(),this.view.$(".js-toggle").click(),expect(this.view.model.get("guessing")).toBeFalsy(),expect(this.model.upload.get("content_guessing")).toBeTruthy(),expect(this.model.upload.get("type_guessing")).toBeTruthy()}),it("should not change type and content guessing attributes when upload isn't valid",function(){this.model.upload.set({type:"url",value:"hello"}),this.view.$(".js-toggle").click(),expect(this.view.model.get("guessing")).toBeFalsy(),expect(this.model.upload.get("content_guessing")).toBeTruthy(),expect(this.model.upload.get("type_guessing")).toBeTruthy()}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})},{"../../../../../../../javascripts/cartodb/common/dialogs/create/create_map_model":69,"../../../../../../../javascripts/cartodb/common/dialogs/create/footer/guessing_toggler_view":71}],467:[function(a,b,c){var d=a("../../../../../../../javascripts/cartodb/common/dialogs/create/footer/privacy_toggler_view"),e=a("../../../../../../../javascripts/cartodb/common/dialogs/create/create_map_model");describe("common/dialogs/create/footer/privacy_toggler_view",function(){beforeEach(function(){window.upgrade_url="paco_upgrade",this.user=new cdb.admin.User({base_url:"http://paco.carto.com",username:"paco",actions:{private_tables:!0}}),this.model=new e({type:"maps",option:"listing",listing:"import"},{user:this.user}),this.privacyModel=new cdb.core.Model({privacy:"PUBLIC"}),this.view=new d({user:this.user,model:this.privacyModel,createModel:this.model}),spyOn(this.model,"bind").and.callThrough(),this.view.render()}),it("should render properly",function(){expect(this.view.$(".PrivacyToggler").length).toBe(1),expect(this.view.$(".PrivacyToggler--PUBLIC").length).toBe(1),expect(this.view.$(".PrivacyToggler").hasClass("is-disabled")).toBeFalsy()}),it("should change privacy when it is clicked",function(){expect(this.privacyModel.get("privacy")).toBe("PUBLIC"),expect(this.view.$(".PrivacyToggler--PUBLIC").length).toBe(1),this.view.$(".PrivacyToggler").click(),expect(this.privacyModel.get("privacy")).toBe("PRIVATE"),expect(this.view.$(".PrivacyToggler--PRIVATE").length).toBe(1)}),it("should point to upgrade when user can't change privacy",function(){var a={private_tables:!1};this.user.set("actions",a),this.view.render(),expect(this.view.$("a.PrivacyToggler").length).toBe(1),expect(this.view.$("a.PrivacyToggler").attr("href")).toBe("paco_upgrade"),expect(this.view.$(".PrivacyToggler").hasClass("is-disabled")).toBeTruthy()}),it("should not point to upgrade if user can't change privacy and there is no upgrade url",function(){window.upgrade_url="";var a={
private_tables:!1};this.user.set("actions",a),this.view.render(),expect(this.view.$("a.PrivacyToggler").length).toBe(0),expect(this.view.$("button.PrivacyToggler").length).toBe(1),expect(this.view.$(".PrivacyToggler").hasClass("is-disabled")).toBeTruthy()}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){window.upgrade_url="",this.view.clean()})})},{"../../../../../../../javascripts/cartodb/common/dialogs/create/create_map_model":69,"../../../../../../../javascripts/cartodb/common/dialogs/create/footer/privacy_toggler_view":72}],468:[function(a,b,c){(function(b){var c=a("../../../../../../../javascripts/cartodb/common/dialogs/create/listing/navigation_view"),d=a("../../../../../../../javascripts/cartodb/common/dialogs/create/create_map_model"),e=a("../../../../../../../javascripts/cartodb/common/dialogs/create/create_dataset_model"),f=a("../../../../../../../javascripts/cartodb/common/visualizations_fetch_model"),g="undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null,h="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null;describe("common/dialogs/create/listing/navigation_view",function(){beforeEach(function(){h.config.set("data_library_enabled",!0),h.config.set("account_host","paco"),this.user=new h.admin.User({base_url:"http://paco.carto.com",username:"paco",remaining_byte_quota:10}),this.createModel=new d({},{user:this.user}),this.visFetchModel=new f({content_type:"datasets"}),this.collection=new h.admin.Visualizations,this.collection.fetch=function(){},this.createView=function(){this.view=new c({user:this.user,routerModel:this.visFetchModel,createModel:this.createModel,collection:this.collection})},this.createView(),this.createModel.set("type","dataset"),spyOn(this.createModel,"bind").and.callThrough(),spyOn(this.view.routerModel,"bind").and.callThrough(),spyOn(this.view.collection,"bind").and.callThrough(),this.view.render()}),it("should render correctly",function(){expect(this.view.$(".Filters-searchLink").length).toBe(1),expect(this.view.$(".Filters-typeLink").length).toBe(4)}),it("should not render several links when create dialog type is dataset",function(){this.createModel=new e({},{user:this.user}),this.createView(),this.view.render(),expect(this.view.$(".Filters-searchLink").length).toBe(1),expect(this.view.$(".Filters-typeLink").length).toBe(3)}),it("should render when listing state changes",function(){this.view._initBinds();var a=this.createModel.bind.calls.argsFor(0);expect(a[0]).toEqual("change:listing")}),it("should create from scratch when create empty button is clicked",function(){spyOn(this.view.createModel,"createFromScratch"),this.view.render(),this.view.$(".js-create_empty").click(),expect(this.view.createModel.createFromScratch).toHaveBeenCalled()}),it("should disable connect-dataset option when user can't create more datasets",function(){this.view.createModel.set("listing","datasets"),this.user.set("remaining_byte_quota",0),this.view.render(),expect(this.view.$(".js-connect").hasClass("is-disabled")).toBeTruthy(),this.view.$(".js-connect").click(),expect(this.view.createModel.get("listing")).not.toBe("import")}),it("should disable create empty dataset option when user can't create more datasets",function(){spyOn(this.view.createModel,"createFromScratch"),this.view.createModel.set("listing","datasets"),this.user.set("remaining_byte_quota",0),this.view.render(),expect(this.view.$(".js-create_empty").hasClass("is-disabled")).toBeTruthy(),this.view.$(".js-create_empty").click(),expect(this.view.createModel.createFromScratch).not.toHaveBeenCalled()}),it("should render when router model changes",function(){this.view._initBinds();var a=this.visFetchModel.bind.calls.argsFor(0);expect(a[0]).toEqual("change")}),it("should render when collection changes",function(){this.view._initBinds();var a=this.collection.bind.calls.argsFor(0);expect(a[0]).toEqual("reset")}),it("should search starting for the first page",function(){this.visFetchModel.set("page",2),this.view.$(".js-search-input").val("test"),this.view.$(".js-search-form").submit(),expect(this.visFetchModel.get("page")).toBe(1)}),it("should change router model and listing model when a link is clicked",function(){function a(){b=!1,c=!1}var b=!1,c=!1;this.visFetchModel.bind("change",function(a,c){g.isEmpty(c.changes)||(b=!0)}),this.createModel.bind("change",function(a,b){g.isEmpty(b.changes)||(c=!0)}),a(),this.view.$(".js-connect").click(),expect(b).toBeFalsy(),expect(c).toBeTruthy(),a(),this.view.$(".js-library").click(),expect(b).toBeTruthy(),expect(c).toBeTruthy()}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../../javascripts/cartodb/common/dialogs/create/create_dataset_model":64,"../../../../../../../javascripts/cartodb/common/dialogs/create/create_map_model":69,"../../../../../../../javascripts/cartodb/common/dialogs/create/listing/navigation_view":104,"../../../../../../../javascripts/cartodb/common/visualizations_fetch_model":261}],469:[function(a,b,c){var d=a("../../../../../javascripts/cartodb/common/dialogs/video_tutorial/video_tutorial_view");describe("common/dialogs/video_tutorial",function(){beforeEach(function(){this.view=new d,this.view.render()}),it("should render correctly",function(){expect(_.size(this.view._subviews)).toBe(3),expect(this.view._videoTutorialContent).toBeDefined()}),it("should have a model included",function(){expect(this.view.model).toBeDefined()}),describe("header",function(){it("should back button when video is selected",function(){this.view.model.set("videoId","aaa"),expect(this.view.$(".js-back").length).toBe(1)}),it("should remove videoId from model when back button is clicked",function(){this.view.model.set("videoId","aaa"),this.view.$(".js-back").click(),expect(this.view.model.get("videoId")).toBeUndefined()})}),describe("list",function(){it("should render items properly",function(){expect(this.view.$(".VideoTutorial-item").length).toBe(6)}),it("should trigger template selected when item is clicked",function(){var a=jasmine.createSpy("onTemplateSelected");cdb.god.bind("onTemplateSelected",a,this.view),this.view.$(".VideoTutorial-itemButton:eq(0)").click(),expect(a).toHaveBeenCalled(),cdb.god.unbind(null,null,this.view)})}),describe("footer",function(){it("should be visible only when a video is selected",function(){expect(this.view.$(".js-start").length).toBe(0),this.view.model.set("videoId","aaa"),expect(this.view.$(".js-start").length).toBe(1)}),it("should trigger an event when button is selected",function(){var a=jasmine.createSpy("onStartTutorial");cdb.god.bind("startTutorial",a,this.view),this.view.model.set("videoId","aaa"),this.view.$(".js-start").click(),expect(a).toHaveBeenCalled(),cdb.god.unbind(null,null,this.view)})}),it("should show video preview when videoId is set from the beginning",function(){expect(this.view._videoTutorialContent.activeTab).toBe("list");var a=new d({videoId:"aaa"});a.render(),expect(a._videoTutorialContent.activeTab).toBe("video"),a.clean()}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})},{"../../../../../javascripts/cartodb/common/dialogs/video_tutorial/video_tutorial_view":212}],470:[function(a,b,c){function d(a,b){var c=jQuery.Event("keydown");return c.which=a,c.keyCode=a,b&&(c.metaKey=!0),c}function e(a,b){a.val(b);for(var c=b.split(""),e=0;e<c.length;e++){var f=c[e].charCodeAt(0);a.trigger(d(f))}}var f=a("../../../../../javascripts/cartodb/dashboard/editable_fields/editable_description");describe("dashboard/editable_fields/editable_description",function(){var a,b;beforeEach(function(){a=new Backbone.Model({description:""}),b=new f({model:a}),spyOn(Backbone,"sync"),spyOn(a,"save").and.callThrough()}),it('should add the "EditableField" class to the element',function(){b.render(),expect(b.el.classList).toContain("EditableField")}),it("should render the field when it has some value",function(){a.set({description:"**wadus**"}),b.render(),expect(b.$(".js-description").attr("title")).toEqual("wadus"),expect(b.$(".js-description").html()).toEqual("wadus")}),describe("if the field is editable",function(){beforeEach(function(){b=new f({model:a,editable:!0})}),it("should render a button and edit and save the field when empty",function(){b.render(),expect(b.el.classList).not.toContain("is-editing"),expect(b.$(".js-field-input").val()).toEqual(""),b.$(".js-add-btn").trigger("click"),expect(b.el.classList).toContain("is-editing"),e(b.$(".js-field-input"),"wadus"),b.$(".js-field-input").trigger(d($.ui.keyCode.ENTER)),expect(b.$(".js-description").attr("title")).toEqual("wadus"),expect(b.$(".js-description").html()).toEqual("wadus"),expect(a.save).toHaveBeenCalled(),expect(a.get("description")).toEqual("wadus"),expect(b.el.classList).not.toContain("is-editing")}),it("should cancel edition if esc is pressed",function(){b.render(),expect(b.el.classList).not.toContain("is-editing"),b.$(".js-add-btn").trigger("click"),expect(b.el.classList).toContain("is-editing"),e(b.$(".js-field-input"),"wadus"),b.$(".js-field-input").trigger(d($.ui.keyCode.ESCAPE)),expect(b.el.classList).not.toContain("is-editing"),expect(a.save).not.toHaveBeenCalled()}),it("should cancel edition on blur",function(){b.render(),b.$(".js-add-btn").trigger("click"),expect(b.el.classList).toContain("is-editing"),e(b.$(".js-field-input"),"wadus"),b.$(".js-field-input").trigger(jQuery.Event("blur")),expect(b.el.classList).not.toContain("is-editing")}),it("should introduce new lines if cmd+enter is pressed",function(){b.render(),e(b.$(".js-field-input"),"wadus"),b.$(".js-field-input").trigger(d($.ui.keyCode.ENTER,!0)),expect(b.$(".js-field-input").val()).toEqual("wadus\n"),expect(a.save).not.toHaveBeenCalled(),expect(a.get("description")).toEqual("")}),it("should not save when the user hits enter and the field is empty",function(){b.render(),b.$(".js-field-input").trigger(d($.ui.keyCode.ENTER)),expect(b.$(".js-field-input").val()).toEqual(""),expect(a.save).not.toHaveBeenCalled()})}),describe("if the field is NOT editable",function(){beforeEach(function(){b=new f({model:a,editable:!1})}),it("should render a no-results message if field is empty",function(){b.render(),expect(b.$("div span.NoResults").html()).toEqual("No description")})})})},{"../../../../../javascripts/cartodb/dashboard/editable_fields/editable_description":269}],471:[function(a,b,c){(function(b){function c(a,b){var c=jQuery.Event("keydown");return c.which=a,c.keyCode=a,b&&(c.metaKey=!0),c}function d(a,b){a.val(b);for(var d=b.split(""),e=0;e<d.length;e++){var f=d[e].charCodeAt(0);a.trigger(c(f))}}var e=a("../../../../../javascripts/cartodb/dashboard/editable_fields/editable_tags"),f=a("../../../../../javascripts/cartodb/dashboard/router"),g="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null;describe("dashboard/editable_fields/editable_tags",function(){var a,b,h;beforeEach(function(){a=new Backbone.Model({tags:""});var c=new g.User({base_url:"http://paco.carto.com",username:"paco"});h=new f({dashboardUrl:c.viewUrl().dashboard()}),b=new e({model:a,router:h,editable:!0}),spyOn(Backbone,"sync"),spyOn(a,"save").and.callThrough()}),it('should add the "EditableField" class to the element',function(){b.render(),expect(b.el.classList).toContain("EditableField")}),it("should display up to 3 tags",function(){a.set({tags:["dolorem","ipsum","quia","dolor","sit"]}),b.render();var c=b.$(".CDB-Tag");expect(c.length).toBe(3),expect($(c[0]).attr("href")).toEqual("http://paco.carto.com/dashboard/datasets/tag/dolorem"),expect($(c[1]).attr("href")).toEqual("http://paco.carto.com/dashboard/datasets/tag/ipsum"),expect($(c[2]).attr("href")).toEqual("http://paco.carto.com/dashboard/datasets/tag/quia"),expect(b.$el.html()).toContain("and 2 more"),expect(b.$(".NoResults").length).toEqual(0)}),it("should NOT display empty tags",function(){a.set({tags:["dolorem",""]}),b.render();var c=b.$(".CDB-Tag");expect(c.length).toBe(1),expect($(c[0]).attr("href")).toEqual("http://paco.carto.com/dashboard/datasets/tag/dolorem"),expect(b.$(".NoResults").length).toEqual(0)}),describe("if tags are editable",function(){it("should render a button and save tags when no tags are present",function(){b.render(),expect(b.el.classList).not.toContain("is-editing"),expect(b.$("input[type=hidden][name=tags]").length).toEqual(0),b.$(".js-add-btn").trigger("click"),expect(b.el.classList).toContain("is-editing"),d(b.$(".js-field-input"),"wadus1, wadus2, wadus3"),b.$(".js-field-input").trigger(c($.ui.keyCode.ENTER)),expect(a.save).toHaveBeenCalledWith({tags:["wadus1","wadus2","wadus3"]}),expect(b.el.classList).not.toContain("is-editing"),expect(b.$(".CDB-Tag").length).toBe(3)}),it("should trim tags",function(){b.render(),b.$(".js-add-btn").trigger("click"),expect(b.el.classList).toContain("is-editing"),d(b.$(".js-field-input"),"   wadus1,    wadus2, wadus3    "),b.$(".js-field-input").trigger(c($.ui.keyCode.ENTER)),expect(a.save).toHaveBeenCalledWith({tags:["wadus1","wadus2","wadus3"]})}),it("should strip HTML from tags",function(){b.render(),b.$(".js-add-btn").trigger("click"),expect(b.el.classList).toContain("is-editing"),d(b.$(".js-field-input"),"<p>wadus</p>"),b.$(".js-field-input").trigger(c($.ui.keyCode.ENTER)),expect(a.save).toHaveBeenCalledWith({tags:["wadus"]})}),it("should remove duplicated tags",function(){b.render(),b.$(".js-add-btn").trigger("click"),expect(b.el.classList).toContain("is-editing"),d(b.$(".js-field-input"),"wadus, wadus"),b.$(".js-field-input").trigger(c($.ui.keyCode.ENTER)),expect(a.save).toHaveBeenCalledWith({tags:["wadus"]})}),it("should prevent empty tags from being created",function(){b.render(),b.$(".js-add-btn").trigger("click"),d(b.$(".js-field-input"),",,wadus,"),b.$(".js-field-input").trigger(c($.ui.keyCode.ENTER)),expect(a.save).toHaveBeenCalledWith({tags:["wadus"]})}),it("should not save the tags if no tags have been added",function(){b.render(),b.$(".js-add-btn").trigger("click"),b.$(".js-field-input").trigger(c($.ui.keyCode.ENTER)),expect(a.save).not.toHaveBeenCalledWith()}),it("should cancel tag edition if user hits escape",function(){b.render(),b.$(".js-add-btn").trigger("click"),expect(b.el.classList).toContain("is-editing"),d(b.$(".js-field-input"),"wadus1, wadus2, wadus3"),b.$(".js-field-input").trigger(c($.ui.keyCode.ESCAPE)),expect(a.save).not.toHaveBeenCalled(),expect(b.$(".DefaultTags-item").length).toBe(0)}),it("should cancel tag edition on blur",function(){b.render(),d(b.$(".js-field-input"),"wadus1, wadus2, wadus3"),b.$(".js-field-input").trigger(jQuery.Event("blur")),expect(b.el.classList).not.toContain("is-editing"),expect(a.save).not.toHaveBeenCalled()})}),describe("if tags are NOT editable",function(){beforeEach(function(){b=new e({model:a,router:h,editable:!1})}),it("should display a no tags message",function(){b.render(),expect(b.$(".DefaultTags span.NoResults").html()).toEqual("No tags")})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/dashboard/editable_fields/editable_tags":270,"../../../../../javascripts/cartodb/dashboard/router":279}],472:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,a("../../../../javascripts/cartodb/common/dialogs/delete_items_view")),d=a("../../../../javascripts/cartodb/common/dialogs/change_lock/change_lock_view"),e=a("../../../../javascripts/cartodb/dashboard/filters_view"),f=a("../../../../javascripts/cartodb/dashboard/router"),g=a("../../../../javascripts/cartodb/common/local_storage"),h="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null;describe("dashboard/filters_view",function(){beforeEach(function(){h.config.set("data_library_enabled",!0),this.user=new h.admin.User({limits:{max_layers:5},base_url:"http://paco.carto.com",username:"paco"}),this.router=new f({dashboardUrl:this.user.viewUrl().dashboard()}),this.router.model.set({content_type:"datasets"}),spyOn(this.router.model,"bind").and.callThrough(),this.collection=new h.admin.Visualizations,spyOn(this.collection,"bind").and.callThrough(),this.localStorage=new g("test"),this.view=new e({user:this.user,router:this.router,collection:this.collection,localStorage:this.localStorage}),this.view.render()}),describe(".render",function(){describe("when regular user",function(){it("shouldn't show shared datasets link because user doesn't belong to an org",function(){this.view.render(),expect(this.view.$(".Filters-typeItem").length).toBe(5),expect(this.innerHTML()).not.toContain("datasets/shared"),expect(this.view.$(".Filters-orderItem").length).toBe(4)})}),describe("organization",function(){it("should show shared datasets link if user belongs to an org",function(){var a=sinon.mock(this.user);a.expects("isInsideOrg").returns("true"),this.view.render(),expect(this.view.$(".Filters-typeItem").length).toBe(6),expect(this.innerHTML()).toContain("shared"),expect(this.view.$(".Filters-orderItem").length).toBe(4)})})}),it("should render only number of dashboards when deep-insights is enabled",function(){spyOn(this.router.model,"isDeepInsights").and.returnValue(!0),this.view.render(),expect(this.view.$(".Filters-typeItem").size()).toBe(1),expect(this.view.$(".js-search-enabler").length).toBe(0)}),it("should render on change events by router model",function(){var a=this.router.model.bind.calls.argsFor(0);expect(a[0]).toEqual("change"),expect(a[1]).toEqual(this.view.render),expect(a[2]).toEqual(this.view)}),it("should deselect items when god triggers an event",function(){this.collection.reset({selected:!0},{selected:!0}),h.god.trigger("closeDialogs"),expect(this.collection.where({selected:!0}).length).not.toBe(0),h.god.trigger("unselectAllItems"),expect(this.collection.where({selected:!0}).length).toBe(0)}),it("should not show total figures when content_type router attribute has changed",function(){this.router.model.set("content_type","maps"),expect(this.view.$(".Filters-typeLink").find("strong").length).toBe(0),this.collection.total_user_entries=10,this.collection.total_likes=1,this.collection.total_shared=0,this.router.model.set("q","hello"),expect(this.view.$(".Filters-typeLink").find("strong").length).toBe(2),expect(this.view.$(".js-link:eq(0) strong").text()).toBe("10"),expect(this.view.$(".js-link:eq(1) strong").text()).toBe("1")}),it("should change order with one is clicked",function(){this.view.render(),this.view.$(".Filters-orderLink.js-likes").click(),expect(this.localStorage.get("dashboard.order")).toBe("likes")}),it("should show search when it is present in the route",function(){this.router.model.set("q","test"),expect(this.view.$(".js-search-field").attr("style")).not.toContain("none"),this.router.model.set("q",""),expect(this.view.$(".js-search-field").attr("style")).toContain("none"),this.router.model.set("tag","paco"),expect(this.view.$(".js-search-field").attr("style")).not.toContain("none"),this.router.model.set("tag",""),expect(this.view.$(".js-search-field").attr("style")).toContain("none"),this.router.model.set({tag:"tagg",search:"paco"}),expect(this.view.$(".js-search-field").attr("style")).not.toContain("none")}),it("should hide search when click outside and it is not set",function(){this.view.render(),this.view.$(".Filters-searchLink").click(),expect(this.view.$(".js-search-field").attr("style")).not.toContain("none"),h.god.trigger("closeDialogs"),expect(this.view.$(".js-search-field").attr("style")).toContain("none")}),describe("an item is selected",function(){beforeEach(function(){this.collection.reset({selected:!1}),spyOn(this.view,"_animate").and.callThrough(),this.collection.at(0).set("selected",!0)}),it("should do a animated render",function(){expect(this.view._animate).toHaveBeenCalled()}),it("should mark the item as selected",function(){expect(this.view.$(".Filters-inner").hasClass("show-second-row")).toBeTruthy()}),it("should show delete items",function(){expect(this.innerHTML()).toContain("Delete")}),it('should show "your" word when a search is applied',function(){this.router.model.set("q","paco"),this.collection.reset([{selected:!0}]),expect(this.innerHTML()).toContain("Delete your dataset"),this.collection.reset([{selected:!0},{selected:!0}]),expect(this.innerHTML()).toContain("Delete your datasets"),expect(this.innerHTML()).toContain("Deselect all yours")}),describe("create dataset",function(){beforeEach(function(){spyOn(this.user,"canCreateDatasets").and.returnValue(!0)}),it("should be displayed when only one library dataset is selected",function(){this.router.model.set({content_type:"datasets",library:!1}),this.collection.reset([{selected:!0}]),expect(this.view.$(".js-import_remote").length).toBe(0),this.collection.reset([{type:"remote",selected:!0}]),expect(this.view.$(".js-import_remote").length).toBe(1),this.collection.reset([]),expect(this.view.$(".js-import_remote").length).toBe(0),this.collection.reset([{selected:!0,type:"other"}]),expect(this.view.$(".js-import_remote").length).toBe(0),this.router.model.set({content_type:"maps"}),this.collection.reset([{selected:!0,type:"remote"}]),expect(this.view.$(".js-import_remote").length).toBe(0)}),it("should trigger importByUploadData event when it is clicked",function(){this.router.model.set({content_type:"datasets",library:!0}),this.collection.reset([{selected:!0,type:"remote",name:"hello",table:{size:1e3}}]);var a=!1;h.god.bind("importByUploadData",function(){a=!0}),this.view.$(".js-import_remote").click(),expect(a).toBeTruthy()})}),describe("create map option",function(){it("should be displayed when selected items are datasets",function(){this.collection.reset([{selected:!0}]),this.router.model.set("content_type","datasets"),expect(this.view.$(".js-create_map").length).toBe(1)}),it("should not be displayed when selected items are not datasets",function(){this.router.model.set("content_type","maps"),this.collection.reset([{selected:!0}]),expect(this.view.$(".js-create_map").length).toBe(0)}),it("should not be displayed when user is in liked section",function(){this.router.model.set({content_type:"datasets",liked:!0}),this.collection.reset([{selected:!0}]),expect(this.view.$(".js-create_map").length).toBe(0)}),it("should be displayed when user is in data library section",function(){this.router.model.set({content_type:"datasets",library:!0,liked:!1}),this.collection.reset([{selected:!0}]),expect(this.view.$(".js-create_map").length).toBe(1)}),it("should not be displayed when number of selected items are bigger than available layers per map",function(){this.user.set("limits",{max_layers:1}),this.router.model.set("content_type","datasets"),this.collection.reset([{selected:!0},{selected:!0}]),expect(this.view.$(".js-create_map").length).toBe(0),expect(this.innerHTML()).toContain("Max map layers selected")}),it("should open create dialog once it is clicked",function(){spyOn(this.view,"_openCreateDialog"),this.router.model.set("content_type","datasets"),this.collection.reset([{selected:!0}]),this.view.$(".js-create_map").click(),expect(this.view._openCreateDialog).toHaveBeenCalled()})}),describe("delete_items option",function(){beforeEach(function(){this.selectedItems=[{selected:!1},{selected:!1},{selected:!0}],this.collection.reset(this.selectedItems),spyOn(c.prototype,"initialize").and.callThrough(),spyOn(c.prototype,"appendToBody").and.callThrough()}),it("should be displayed when items belong to the user",function(){expect(this.innerHTML()).toContain("Delete  dataset")}),it("should not be displayed when items don't belong to the user",function(){spyOn(this.collection.at(0).permission,"isOwner").and.returnValue(!1),this.view.render(),expect(this.innerHTML()).not.toContain("Delete datasets")}),it("should not be displayed when any item is remote type",function(){this.collection.at(0).set("type","remote"),this.view.render(),expect(this.innerHTML()).not.toContain("Delete datasets")}),it("should open a delete-items dialog",function(){this.view.$(".js-delete").click(),this.createdWith=c.prototype.initialize.calls.argsFor(0)[0],expect(c.prototype.appendToBody).toHaveBeenCalled()}),it("should created dialog with a view model",function(){this.view.$(".js-delete").click(),this.createdWith=c.prototype.initialize.calls.argsFor(0)[0],expect(this.createdWith).toEqual(jasmine.objectContaining({viewModel:jasmine.any(Object)}))}),it("should created dialog with user",function(){this.view.$(".js-delete").click(),this.createdWith=c.prototype.initialize.calls.argsFor(0)[0],expect(this.createdWith).toEqual(jasmine.objectContaining({user:this.user}))})}),describe("and click lock items",function(){beforeEach(function(){this.selectedItems=[{selected:!1},{selected:!1},{selected:!0}],this.collection.reset(this.selectedItems),spyOn(d.prototype,"initialize").and.callThrough(),spyOn(d.prototype,"appendToBody").and.callThrough(),this.view.$(".js-lock").click(),this.createdWith=d.prototype.initialize.calls.argsFor(0)[0]}),it("should open a lock items dialog",function(){expect(d.prototype.appendToBody).toHaveBeenCalled()}),it("should created dialog with a view model",function(){expect(this.createdWith).toEqual(jasmine.objectContaining({model:jasmine.any(Object)}))})})}),describe("and click .js-privacy",function(){beforeEach(function(){this.selectedItems=[{selected:!1},{selected:!0}],this.collection.reset(this.selectedItems),h.god.bind("openPrivacyDialog",function(a){this.openendPrivacyDialog=a},this),this.view.$(".js-privacy").click()}),it("should call global event bus to open privacy dialog",function(){expect(this.openendPrivacyDialog).toBeTruthy()}),it("should created dialog with selected items",function(){expect(this.openendPrivacyDialog).toEqual(this.collection.at(1))})}),describe("when submit search",function(){beforeEach(function(){spyOn(this.router,"navigate"),this.view.$(".js-search-input").val("fooo"),this.view.$(".js-search-form").submit()}),it("should call currentUrl with new search terms",function(){expect(this.router.navigate).toHaveBeenCalled(),expect(this.router.navigate.calls.argsFor(0)[0].toString()).toContain("/search/fooo")}),it("should request the first page",function(){this.router.model.set("page",2),spyOn(this.view,"_navigateToUrl").and.callThrough(),this.view.$(".js-search-input").val("fooo"),this.view.$(".js-search-form").submit();var a=this.view._navigateToUrl.calls.argsFor(0);expect(a[0].page).toBe(1)}),it("should not search applying any filter",function(){this.router.model.set("shared","yes"),this.view.$(".js-search-form").submit(),expect(this.router.navigate.calls.argsFor(0)[0].toString()).not.toContain("/shared"),this.router.model.set({shared:"no",liked:!0}),this.view.$(".js-search-form").submit(),expect(this.router.navigate.calls.argsFor(0)[0].toString()).not.toContain("/liked"),this.router.model.set({shared:"no",liked:!1,library:!0}),this.view.$(".js-search-form").submit(),expect(this.router.navigate.calls.argsFor(0)[0].toString()).not.toContain("/library"),this.router.model.set({locked:!0}),this.view.$(".js-search-form").submit(),expect(this.router.navigate.calls.argsFor(0)[0].toString()).not.toContain("/locked")})}),describe("when click clear search",function(){beforeEach(function(){spyOn(this.router,"navigate"),this.router.model.set("q","foo"),this.view.render(),this.view.$(".js-clean-search").click()}),it("should reset URL",function(){expect(this.router.navigate).toHaveBeenCalled(),expect(this.router.navigate.calls.argsFor(0)[0].toString()).not.toContain("/search")}),it("should always go to default content-type, not to any filter route",function(){this.router.model.set({shared:!0}),this.view.render(),this.view.$(".js-clean-search").click(),expect(this.router.navigate.calls.argsFor(0)[0].toString()).toContain("dashboard/datasets"),this.router.model.set({shared:"no",liked:!0}),this.view.$(".js-search-form").click(),expect(this.router.navigate.calls.argsFor(0)[0].toString()).toContain("dashboard/datasets"),this.router.model.set({shared:"no",liked:!1,library:!0}),this.view.$(".js-search-form").click(),expect(this.router.navigate.calls.argsFor(0)[0].toString()).toContain("dashboard/datasets")})}),describe("when click search",function(){beforeEach(function(){spyOn(this.router,"navigate"),this.click=function(){this.view.$(".js-search-link").click()}}),it("should toggle search",function(){this.click(),expect(this.router.navigate).not.toHaveBeenCalled(),expect(this.view.$(".js-search-field").attr("style")).not.toContain("none"),this.click(),expect(this.router.navigate).not.toHaveBeenCalled(),expect(this.view.$(".js-search-field").attr("style")).toContain("none"),this.click(),this.router.model.set({q:"test-search-clean"},{silent:!0}),this.click(),expect(this.router.navigate).toHaveBeenCalled(),expect(this.router.navigate.calls.argsFor(0)[0]).not.toContain("search/"),expect(this.view.$(".js-search-field").attr("style")).toContain("none")})}),describe("dataset duplication",function(){beforeEach(function(){this.router.model.set("content_type","datasets"),spyOn(this.user,"canCreateDatasets").and.returnValue(!0),this.collection.reset([{selected:!0}])}),it("should not be displayed when selected items are maps",function(){this.router.model.set({content_type:"maps",liked:!1}),expect(this.view.$(".js-duplicate_dataset").length).toBe(0)}),it("should be displayed when selected items are datasets",function(){this.router.model.set({liked:!1}),expect(this.view.$(".js-duplicate_dataset").length).toBe(1)}),it("should not be displayed when selected items are not datasets",function(){this.router.model.set("content_type","maps"),expect(this.view.$(".js-duplicate_dataset").length).toBe(0)}),it("should not be displayed when user is in liked section",function(){this.router.model.set({liked:!0}),expect(this.view.$(".js-duplicate_dataset").length).toBe(0)}),it("should not be displayed when user is in data library section",function(){this.router.model.set({library:!0}),expect(this.view.$(".js-duplicate_dataset").length).toBe(0)}),it("should be displayed when user is in shared section",function(){this.router.model.set({library:!1,liked:!1,shared:"yes"}),expect(this.view.$(".js-duplicate_dataset").length).toBe(1)}),it("should not be displayed when there are several items selected",function(){this.router.model.set({liked:!1}),this.collection.reset([{selected:!0},{selected:!0}]),expect(this.view.$(".js-duplicate_dataset").length).toBe(0)}),it("should not be displayed when the item is a data-library search result ",function(){this.router.model.set({search:"jar"}),this.collection.reset([{selected:!0,type:"remote"},{selected:!1}]),expect(this.view.$(".js-duplicate_dataset").length).toBe(0)})}),describe("duplicate map",function(){beforeEach(function(){this.router.model.set("content_type","maps"),this.collection.reset([{selected:!0}])}),it("should offer duplicate map",function(){expect(this.view.$(".js-duplicate_map").length).toBe(1)}),it("shouldn't offer duplicate map when content type is datasets",function(){this.router.model.set("content_type","datasets"),this.collection.reset([{selected:!0}]),expect(this.view.$(".js-duplicate_map").length).toBe(0)}),it("shouldn't offer duplicate map when there are several maps selected",function(){this.collection.reset([{selected:!0},{selected:!0}]),expect(this.view.$(".js-duplicate_map").length).toBe(0)}),it("should not offer duplicate map when it is a liked map",function(){this.router.model.set("liked",!0),this.view.render(),expect(this.view.$(".js-duplicate_map").length).toBe(0)})}),it("shouldn't offer select all option when it is viewing liked items",function(){this.router.model.set({content_type:"datasets",liked:!0}),this.selectedItems=[{selected:!1},{selected:!0}],this.collection.reset(this.selectedItems),expect(this.view.$(".js-select_all").length).toBe(0),expect(this.view.$(".js-deselect_all").length).toBe(0)}),it("should have no leaks",function(){
this.view.render(),expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/common/dialogs/change_lock/change_lock_view":49,"../../../../javascripts/cartodb/common/dialogs/delete_items_view":107,"../../../../javascripts/cartodb/common/local_storage":223,"../../../../javascripts/cartodb/dashboard/filters_view":271,"../../../../javascripts/cartodb/dashboard/router":279}],473:[function(a,b,c){(function(b){var c=a("../../../../javascripts/cartodb/dashboard/header_view_model"),d=a("../../../../javascripts/cartodb/dashboard/router"),e="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,f=a("../common/views/dashboard_header/shared_for_view_model");describe("dashboard/header_view_model",function(){beforeEach(function(){var a=new e.common.DashboardUrl({base_url:"http://pepe.carto.com"});this.router=new d({dashboardUrl:a}),this.viewModel=new c(this.router)}),f.call(this),it("re-throws router change events",function(){this.viewModel.bind("change",function(){this.triggeredCallEvent=!0},this),this.router.model.set("something",!0),expect(this.triggeredCallEvent).toBeTruthy()}),describe(".breadcrumbTitle",function(){describe("given no content type is set",function(){it("returns an empty string",function(){expect(this.viewModel.breadcrumbTitle()).toEqual("")})}),describe("given is not viewing locked items",function(){it("returns current content type as a capitalized string",function(){this.router.model.set("content_type","datasets"),expect(this.viewModel.breadcrumbTitle()).toEqual("Datasets"),this.router.model.set("content_type","maps"),expect(this.viewModel.breadcrumbTitle()).toEqual("Maps")})}),describe("given is viewing locked items",function(){beforeEach(function(){this.router.model.set("locked",!0)}),it("returns the current content type prefixed with locked string",function(){this.router.model.set("content_type","datasets"),expect(this.viewModel.breadcrumbTitle()).toEqual("Locked datasets"),this.router.model.set("content_type","maps"),expect(this.viewModel.breadcrumbTitle()).toEqual("Locked maps")})})}),describe(".isDisplayingDatasets",function(){it("returns true if router model is set to datasets",function(){expect(this.viewModel.isDisplayingDatasets()).toBeFalsy(),this.router.model.set("content_type","datasets"),expect(this.viewModel.isDisplayingDatasets()).toBeTruthy()})}),describe(".isDisplayingMaps",function(){it("returns true if router model is set to maps",function(){expect(this.viewModel.isDisplayingMaps()).toBeFalsy(),this.router.model.set("content_type","maps"),expect(this.viewModel.isDisplayingMaps()).toBeTruthy()})}),describe(".isDisplayingLockedItems",function(){it("returns true if router model is set to maps",function(){expect(this.viewModel.isDisplayingLockedItems()).toBeFalsy(),this.router.model.set("locked",!0),expect(this.viewModel.isDisplayingLockedItems()).toBeTruthy()})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/dashboard/header_view_model":272,"../../../../javascripts/cartodb/dashboard/router":279,"../common/views/dashboard_header/shared_for_view_model":449}],474:[function(a,b,c){(function(b){var c=a("../../../../../javascripts/cartodb/dashboard/maps/maps_item"),d=a("../../../../../javascripts/cartodb/dashboard/router"),e="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null;describe("dashboard/maps/maps_item",function(){beforeEach(function(){var a={id:"owner-id",base_url:"http://team.carto.com/u/pepe",username:"pepe"};this.vis=new e.admin.Visualization({id:"8988-8888-8888",name:"map_title",privacy:"PUBLIC",type:"derived",updated_at:(new Date).toISOString(),likes:42,permission:{owner:a}}),spyOn(this.vis,"on"),this.user=new e.admin.User(a),this.router=new d({dashboardUrl:this.user.viewUrl().dashboard()}),this.router.model.set("content_type","maps"),this.view=new c({model:this.vis,user:this.user,router:this.router}),this.renderView=function(){this.view.render()}}),it("should render if privacy changes",function(){expect(this.vis.on).toHaveBeenCalledWith("change:privacy",this.view.render,this.view)}),it("should render the title",function(){this.renderView(),expect(this.innerHTML()).toContain("map_title")}),it("should render the URL to the edit map",function(){this.renderView(),expect(this.innerHTML()).toContain("http://team.carto.com/u/pepe/viz/8988-8888-8888/map")}),it("should render likes count",function(){this.renderView(),expect(this.view.$(".LikesIndicator").length).toBe(1),expect(this.view.$(".LikesIndicator").text()).toContain("42")}),it("should render privacy",function(){this.renderView(),expect(this.view.$(".js-privacy").length).toBe(1),expect(this.view.$(".js-privacy").text()).toBe("public"),expect(this.view.$(".js-privacy").hasClass("is-public")).toBeTruthy()}),it('should add "selectable" class if user is owner of the map',function(){spyOn(this.vis.permission,"isOwner").and.returnValue(!0),this.renderView(),expect(this.view.$(".MapCard").hasClass("MapCard--selectable")).toBeTruthy()}),it('should remove "selectable" class if user is NOT owner of the map',function(){spyOn(this.vis.permission,"isOwner").and.returnValue(!1),this.renderView(),expect(this.view.$(".MapCard").hasClass("MapCard--selectable")).toBeFalsy()}),describe("render owner user info",function(){it("shouldn't render owner info if user is not in a org",function(){this.renderView(),expect(this.view.$(".UserAvatar").length).toBe(0)}),it("shouldn't render owner info if user is the owner of the map",function(){spyOn(this.user,"isInsideOrg").and.returnValue(!0),spyOn(this.vis.permission,"isOwner").and.returnValue(!0),spyOn(this.vis.permission,"hasWriteAccess").and.returnValue(!0),spyOn(this.vis.permission.owner,"get").and.returnValue("paco"),spyOn(this.vis.permission.owner,"renderData").and.returnValue(this.user.toJSON()),this.renderView(),expect(this.view.$(".UserAvatar").length).toBe(0)}),it("should render owner info if user is not the owner of the map",function(){this.vis.permission=new e.admin.Permission;var a=new e.admin.User({username:"whoknows"});spyOn(this.user,"isInsideOrg").and.returnValue(!0),spyOn(this.vis.permission,"isOwner").and.returnValue(!1),spyOn(this.vis.permission,"hasWriteAccess").and.returnValue(!1),spyOn(this.vis.permission.owner,"get").and.returnValue("whoknows"),spyOn(this.vis.permission.owner,"renderData").and.returnValue(a.toJSON()),this.renderView(),expect(this.view.$(".UserAvatar").length).toBe(1),expect(this.view.$(".UserAvatar").attr("data-title")).toBe("whoknows")})}),it("should render timediff",function(){this.renderView(),expect(this.view.$(".MapCard-contentFooterTimeDiff").length).toBe(1),expect(this.view.$(".MapCard-contentFooterTimeDiff").text()).toContain("a few seconds ago")}),it("should render mapviews graph",function(){this.renderView(),expect(this.view.$(".MapviewsGraph").length).toBe(1),expect(this.view.$(".MapviewsGraph svg").length).toBe(1)}),it("should render an editable field with the description",function(){this.vis.set("description","my desc"),this.renderView(),expect(this.view.$(".MapCard-desc.EditableField").length).toBe(1),expect(this.view.$(".js-description").length).toBe(1),expect(this.view.$(".js-description")[0].textContent).toEqual("my desc")}),it("should render an editable field with the tags",function(){this.vis.set("tags",["tag1"]),this.renderView(),expect(this.view.$(".MapCard-tags.EditableField").length).toBe(1),expect(this.view.$(".js-tag-link").length).toBe(1),expect(this.view.$(".js-tag-link")[0].textContent).toEqual("tag1")}),describe("permission",function(){it("shouldn't show permission label when user is not in a org",function(){this.renderView(),expect(this.view.$(".PermissionIndicator").length).toBe(0)}),it("shouldn't show permission label when user is the owner of the vis",function(){spyOn(this.user,"isInsideOrg").and.returnValue(!0),spyOn(this.vis.permission,"isOwner").and.returnValue(!0),spyOn(this.vis.permission,"hasWriteAccess").and.returnValue(!0),spyOn(this.vis.permission.owner,"get").and.returnValue("paco"),spyOn(this.vis.permission.owner,"renderData").and.returnValue(this.user.toJSON()),this.renderView(),expect(this.view.$(".PermissionIndicator").length).toBe(0)}),it("should show permission label when user is not the owner of the vis and he is in a org",function(){this.vis.permission=new e.admin.Permission;var a=new e.admin.User({username:"whoknows"});spyOn(this.user,"isInsideOrg").and.returnValue(!0),spyOn(this.vis.permission,"isOwner").and.returnValue(!1),spyOn(this.vis.permission,"hasWriteAccess").and.returnValue(!1),spyOn(this.vis.permission.owner,"get").and.returnValue("whoknows"),spyOn(this.vis.permission.owner,"renderData").and.returnValue(a.toJSON()),this.renderView(),expect(this.view.$(".PermissionIndicator").length).toBe(1)})}),describe("click item",function(){describe("given clicked target is NOT a link",function(){beforeEach(function(){spyOn(this.view,"killEvent"),this.clickEl=function(){this.view.$el.click()},this.clickEl()}),it("should kill default event behaviour",function(){expect(this.view.killEvent).toHaveBeenCalledWith(this.view.killEvent.calls.argsFor(0)[0])}),describe("should toggle selected state on map card",function(){beforeEach(function(){this.vis.set("selected",!1)}),it("if user is owner of the map",function(){spyOn(this.vis.permission,"isOwner").and.returnValue(!0),this.clickEl(),expect(this.vis.get("selected")).toBeTruthy()}),it("if user is NOT owner of the map",function(){spyOn(this.vis.permission,"isOwner").and.returnValue(!1),this.clickEl(),expect(this.vis.get("selected")).toBeFalsy()})})})}),describe("when click .js-privacy",function(){beforeEach(function(){this.renderView(),e.god.bind("openPrivacyDialog",function(a){this.openendPrivacyDialog=a},this),this.view.$(".js-privacy").click()}),it("should call global event bus to open privacy dialog",function(){expect(this.openendPrivacyDialog).toBeTruthy()}),it("should created dialog with selected items",function(){expect(this.openendPrivacyDialog).toEqual(this.vis)})}),it("should have no leaks",function(){this.renderView(),expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/dashboard/maps/maps_item":275,"../../../../../javascripts/cartodb/dashboard/router":279}],475:[function(a,b,c){var d=a("../../../../javascripts/cartodb/dashboard/router");describe("dashboard/router",function(){beforeEach(function(){var a="http://paco.carto.com",b=new cdb.admin.User({base_url:a,username:"paco"}),c=b.viewUrl().dashboard();this.router=new d({baseUrl:a,dashboardUrl:c})}),it("should have created a router model with dashboardUrl",function(){expect(this.router.model.get("dashboardUrl")).toBe(this.dashboardUrl)}),describe(".currentDashboardUrl",function(){it("should return the root URL of the current content type the dashboard is on",function(){this.router.model.set("content_type","datasets"),expect(this.router.currentDashboardUrl().toString()).toEqual("http://paco.carto.com/dashboard/datasets"),this.router.model.set("content_type","maps"),expect(this.router.currentDashboardUrl().toString()).toEqual("http://paco.carto.com/dashboard/maps")})}),describe(".currentDashboardUrl",function(){it("should return URL to current content type",function(){expect(this.router.currentDashboardUrl().toString()).toEqual("http://paco.carto.com/dashboard/datasets"),this.router.model.set("content_type","maps"),expect(this.router.currentDashboardUrl().toString()).toEqual("http://paco.carto.com/dashboard/maps")})}),describe(".currentUrl",function(){beforeEach(function(){this.router.model.set({content_type:"maps",shared:"only",page:123})}),it("should return URL to current state",function(){expect(this.router.currentUrl().toString()).toEqual("http://paco.carto.com/dashboard/maps/shared/123")})})})},{"../../../../javascripts/cartodb/dashboard/router":279}],476:[function(a,b,c){var d=a("../../../../../javascripts/cartodb/dashboard/router/current_url_model"),e=a("../../../../../javascripts/cartodb/common/visualizations_fetch_model");describe("dashboard/router/current_url_model",function(){beforeEach(function(){var a=new cdb.common.DashboardUrl({base_url:"http://pepe.carto.com/dashboard"});this.visFetchModel=new e({shared:!1,page:1}),this.model=new d({dashboardUrl:a,visFetchModel:this.visFetchModel})}),describe(".forCurrentContentType",function(){it("should return a URL to the current content type",function(){expect(this.model.forCurrentContentType().toString()).toEqual("http://pepe.carto.com/dashboard/datasets"),this.visFetchModel.set("content_type","maps"),expect(this.model.forCurrentContentType().toString()).toEqual("http://pepe.carto.com/dashboard/maps")}),it("should return deep-insights URL if it is enabled",function(){this.visFetchModel.set("content_type","maps"),expect(this.model.forCurrentContentType().toString()).toEqual("http://pepe.carto.com/dashboard/maps"),this.visFetchModel.set("deepInsights",!0),expect(this.model.forCurrentContentType().toString()).toEqual("http://pepe.carto.com/dashboard/deep-insights"),this.visFetchModel.set("content_type","datasets"),expect(this.model.forCurrentContentType().toString()).toEqual("http://pepe.carto.com/dashboard/datasets")})}),describe(".forCurrentState",function(){describe("given no args",function(){it("should return the URL with page 1 ommitted",function(){expect(this.model.forCurrentState().toString()).toEqual("http://pepe.carto.com/dashboard/datasets")}),describe("and default state",function(){it("should return the URL to the contents without any filters",function(){expect(this.model.forCurrentState().toString()).toEqual("http://pepe.carto.com/dashboard/datasets")})}),describe("and router have shared contents",function(){beforeEach(function(){this.visFetchModel.set("shared","only")}),it("should return the URL to the shared contents",function(){expect(this.model.forCurrentState().toString()).toEqual("http://pepe.carto.com/dashboard/datasets/shared")})}),describe("and router have no shared but liked contents",function(){beforeEach(function(){this.visFetchModel.set({shared:"no",liked:!0})}),it("should return the URL to liked conents",function(){expect(this.model.forCurrentState().toString()).toEqual("http://pepe.carto.com/dashboard/datasets/liked")})}),describe("and router have shared and locked contents",function(){beforeEach(function(){this.visFetchModel.set({shared:"only",locked:!0})}),it("should return the URL to the shared and locked contents",function(){expect(this.model.forCurrentState().toString()).toEqual("http://pepe.carto.com/dashboard/datasets/shared/locked")}),it("should return the URL to the shared and locked contents",function(){expect(this.model.forCurrentState().toString()).toEqual("http://pepe.carto.com/dashboard/datasets/shared/locked")})}),describe("and router have library content",function(){beforeEach(function(){this.visFetchModel.set({library:!0})}),it("should return the URL to library content",function(){expect(this.model.forCurrentState().toString()).toEqual("http://pepe.carto.com/dashboard/datasets/library")})}),describe("and page is set",function(){it("should return the URL with page set",function(){this.visFetchModel.set({page:42}),expect(this.model.forCurrentState().toString()).toEqual("http://pepe.carto.com/dashboard/datasets/42")}),it("should return the URL with page ommitted if set to 1",function(){this.visFetchModel.set({page:1}),expect(this.model.forCurrentState().toString()).toEqual("http://pepe.carto.com/dashboard/datasets")})})}),describe("given a search tag",function(){it("should return the URL to see contents tagged with the given tag",function(){expect(this.model.forCurrentState({search:":foobar"}).toString()).toEqual("http://pepe.carto.com/dashboard/datasets/tag/foobar")}),it("should URL encode the search string",function(){expect(this.model.forCurrentState({search:":foobar baz"}).toString()).toEqual("http://pepe.carto.com/dashboard/datasets/tag/foobar%20baz")})}),describe("given a search string",function(){it("should return the URL to see contents w/ name or desc of search string",function(){expect(this.model.forCurrentState({search:"baz"}).toString()).toEqual("http://pepe.carto.com/dashboard/datasets/search/baz")}),it("should URL encode the search string",function(){expect(this.model.forCurrentState({search:"baz baz"}).toString()).toEqual("http://pepe.carto.com/dashboard/datasets/search/baz%20baz")})}),describe("given an empty search str",function(){beforeEach(function(){this.visFetchModel.set("q","prev"),this.visFetchModel.set("tag","tag")}),it("should return a URL w/o search or tag",function(){expect(this.model.forCurrentState({search:""}).toString()).toEqual("http://pepe.carto.com/dashboard/datasets")})}),describe("given a page param",function(){describe("and the page is set to 1",function(){it("should return a URL with the page ommitted",function(){expect(this.model.forCurrentState({page:1}).toString()).toEqual("http://pepe.carto.com/dashboard/datasets")})}),describe("and the page is set to something larger than 1",function(){it("should return a URL with the page set",function(){expect(this.model.forCurrentState({page:42}).toString()).toEqual("http://pepe.carto.com/dashboard/datasets/42")})})}),describe("given a locked param",function(){it("should return a URL with the locked set to the value of locked",function(){expect(this.model.forCurrentState({locked:!0}).toString()).toEqual("http://pepe.carto.com/dashboard/datasets/locked"),expect(this.model.forCurrentState({locked:!1}).toString()).toEqual("http://pepe.carto.com/dashboard/datasets")})}),describe("given a shared param",function(){it("should return a URL without the shared param",function(){this.visFetchModel.set("shared","yes"),expect(this.model.forCurrentState({shared:"no"}).toString()).toEqual("http://pepe.carto.com/dashboard/datasets")})}),describe("given a liked param",function(){it("should return a URL without the liked param",function(){this.visFetchModel.set("liked",!0),expect(this.model.forCurrentState({liked:!1}).toString()).toEqual("http://pepe.carto.com/dashboard/datasets"),this.visFetchModel.set("shared","only"),expect(this.model.forCurrentState({liked:!0}).toString()).toEqual("http://pepe.carto.com/dashboard/datasets/shared")})})})})},{"../../../../../javascripts/cartodb/common/visualizations_fetch_model":261,"../../../../../javascripts/cartodb/dashboard/router/current_url_model":280}],477:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../javascripts/cartodb/common/user_notification/user_notification_model"),e=a("../../../../../javascripts/cartodb/common/user_notification/user_notification_view");describe("dashboard/user_notification/user_notification_view",function(){beforeEach(function(){c.config.set("url_prefix","/u/marieta"),this._notification=new d({},{key:"dashboard",configModel:c.config}),this.view=new e({notification:this._notification}),this.view.render()}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should render template",function(){expect(this.view.$el.html()).toContain("onboardingNotification")}),it("should save notification when js-close is clicked",function(){this.view.$(".js-close").click(),expect(this._notification.get("notifications").builder_activated).toBe(!0)})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/user_notification/user_notification_model":235,"../../../../../javascripts/cartodb/common/user_notification/user_notification_view":236}],478:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null),d=a("../../../../javascripts/cartodb/data_library/datasets_collection"),e=a("../../../../javascripts/cartodb/data_library/filters/view"),f=a("../../../../javascripts/cartodb/data_library/filters/dropdown/view");describe("data_library/filters_view",function(){var a;beforeEach(function(){this.model=new c.core.Model({vis_count:0,show_countries:!1}),spyOn(this.model,"bind").and.callThrough(),this.collection=new d,this.collection.options.set({q:"",order:"updated_at",page:1,tags:"",source:[],type:"table"}),spyOn(this.collection.options,"bind").and.callThrough(),this.view=new e({collection:this.collection,model:this.model})}),describe("render",function(){it("should render properly",function(){this.view.render(),expect(this.view.$(".Filters-typeItem").length).toBe(3)}),it("should have no leaks",function(){this.view.render(),expect(this.view).toHaveNoLeaks()})}),describe("collection changes",function(){it("should change dropdown label when collection changed",function(){var a=spyOn(this.collection.options,"change");this.collection.options.set({tags:"Administrative regions"}),expect(a).toHaveBeenCalled()}),xit("should match dropdown label when collection changed",function(){this.collection.options.set({tags:"Administrative regions"}),this.view.render(),expect(this.view.$(".js-categoriesDropdown-label").text()).toBe("Administrative regions")})}),describe("dropdown",function(){beforeEach(function(){a=this.view,this.view.render(),spyOn(f.prototype,"initialize").and.callThrough(),spyOn(f.prototype,"render").and.callThrough(),spyOn(f.prototype,"open").and.callThrough(),spyOn(f.prototype,"on").and.callThrough(),spyOn(f.prototype,"clean").and.callThrough(),this.clickSettings=function(){a.$(".js-categoriesDropdown").click()}}),it("should create dropdown view",function(){this.clickSettings(),expect(f.prototype.initialize).toHaveBeenCalled()}),it("should have rendered and opened the dropdown view",function(){this.clickSettings(),expect(f.prototype.render).toHaveBeenCalled(),expect(f.prototype.open).toHaveBeenCalled()}),it("should add the dropdown view to the child views",function(){var b=spyOn(a,"addView");this.clickSettings(),expect(b).toHaveBeenCalled()}),it("should clean up dropdown view after the dropdown is hidden",function(a){this.clickSettings(),c.god.trigger("closeDialogs"),setTimeout(function(){expect(f.prototype.clean).toHaveBeenCalled(),a()},400)}),it("should close any other open dialogs",function(){spyOn(c.god,"trigger"),this.clickSettings(),expect(c.god.trigger).toHaveBeenCalledWith("closeDialogs")})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/data_library/datasets_collection":285,"../../../../javascripts/cartodb/data_library/filters/dropdown/view":286,"../../../../javascripts/cartodb/data_library/filters/view":287}],479:[function(a,b,c){(function(b){var c=a("../../../../javascripts/cartodb/data_library/main_view"),d="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null,e="undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null;describe("data_library/view",function(){beforeEach(function(){this.ownerAttrs={base_url:"http://paco.carto.com",username:"paco"},this.vis=new d.Visualization({account_host:"carto.com",date:"2014-09-08T09:51:33+00:00",id:"b718d53c-373d-11e4-add2-0e8d2b608a14",permission:{owner:this.ownerAttrs},table:{size:49152,geometry_types:["point"]}}),this.view=new c({el:this.$map}),this.collection=this.view.collection}),describe("render",function(){it("should render properly",function(){this.view.render(),expect(e.size(this.view._subviews)).toBe(7)}),it("should have no leaks",function(){this.view.render(),expect(this.view).toHaveNoLeaks()})}),describe("collection changes",function(){it("should show list when collection fetch works",function(){this.collection.reset([this.vis]),expect(this.view._isBlockEnabled("list")).toBeTruthy(),expect(this.view._isBlockEnabled("main_loader")).toBeFalsy(),expect(e.size(this.view.enabledViews)).toBe(1)}),it("should show error block when collection fetch fails",function(){this.collection.trigger("loading"),expect(this.view._isBlockEnabled("error")).toBeFalsy(),this.collection.trigger("error"),expect(this.view._isBlockEnabled("error")).toBeTruthy(),expect(this.view._isBlockEnabled("list")).toBeFalsy(),expect(e.size(this.view.enabledViews)).toBe(1)}),it("should show empty datasets when user didn't have any dataset",function(){this.collection.total_user_entries=0,this.collection.reset([]),expect(this.view._isBlockEnabled("no_results")).toBeTruthy()})}),it("should hide the load more button when the limit is reached",function(){for(var a=[],b=0;b<=12;b++)a.push(this.vis);this.collection.reset(a),this.view.$el.find(".js-more").click(),expect(this.view.model.get("show_more")).toBeFalsy(),expect(this.view.$(".js-more").hasClass("is-hidden")).toBeTruthy()}),it("should define a model",function(){expect(this.view.model).toBeDefined(),expect(this.view.model.get("vis_count")).toBeDefined()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/data_library/main_view":289}],480:[function(a,b,c){var d=a("../../../../javascripts/cartodb/editor/background_polling_model"),e=a("../../../../javascripts/cartodb/common/background_polling/models/imports_collection"),f=a("../../../../javascripts/cartodb/common/background_polling/models/imports_model");describe("editor/background_polling_model",function(){beforeEach(function(){this.user=new cdb.admin.User({username:"pepe",base_url:"http://pepe.carto.com"}),this.importsCollection=new e(void 0,{user:this.user}),this.vis=new cdb.admin.Visualization({name:"my-map"}),this.model=new d({},{vis:this.vis,user:this.user,importsCollection:this.importsCollection})}),describe("when an import starts but map doesn't allow more layers",function(){beforeEach(function(){this.user.set("limits",{concurrent_imports:2,max_layers:3})}),it("should set error state for new import",function(){spyOn(this.user,"canAddLayerTo").and.returnValue(!1),this.model.addImportItem(new f({},{upload:{type:"file",value:{name:"fake.csv",size:1}}}));var a=this.importsCollection.at(0),b=a.getError();expect(a.get("state")).toBe("error"),expect(b.error_code).toBe(8005)})}),describe("when an imports model changes state",function(){beforeEach(function(){this.importsCollection.reset({step:"import"}),this.importsModel=this.importsCollection.at(0),this.importsModel.imp.set({tables_created_count:1,service_name:"other",table_name:"foobar"}),spyOn(this.vis.map,"addCartodbLayerFromTable")}),it("should do nothing if import did not complete successfully",function(){this.importsModel.imp.set({step:"import",state:"fail"}),expect(this.vis.map.addCartodbLayerFromTable).not.toHaveBeenCalled()}),describe("when import is completed",function(){beforeEach(function(){this.importsModel.imp.set({step:"import",state:"complete"}),this.args=this.vis.map.addCartodbLayerFromTable.calls.argsFor(0)}),it("should add the imported dataset as a new layer",function(){expect(this.vis.map.addCartodbLayerFromTable).toHaveBeenCalled()}),it("should created layer for current user and vis",function(){expect(this.args[0]).toEqual("foobar"),expect(this.args[1]).toEqual("pepe"),expect(this.args[2].vis).toEqual(this.vis)}),describe("when layer is created successfully",function(){beforeEach(function(){spyOn(this.vis.map.layers,"saveLayers"),this.args[2].success()}),it("should save layers",function(){expect(this.vis.map.layers.saveLayers).toHaveBeenCalled()}),it("should remove the model from the collection",function(){expect(this.importsCollection.length).toEqual(0)})}),describe("when layer could not be create for whatever reason",function(){beforeEach(function(){this.model.bind("importLayerFail",function(a){this.lastErrorMsg=a},this),spyOn(this.vis.map.layers,"saveLayers"),this.args[2].error()}),it("should not tried to save layers",function(){expect(this.vis.map.layers.saveLayers).not.toHaveBeenCalled()}),it("should remove the model from the collection",function(){expect(this.importsCollection.length).toEqual(0)}),it("should set last error",function(){expect(this.lastErrorMsg).toEqual(jasmine.any(String))})})})})})},{"../../../../javascripts/cartodb/common/background_polling/models/imports_collection":13,"../../../../javascripts/cartodb/common/background_polling/models/imports_model":14,"../../../../javascripts/cartodb/editor/background_polling_model":291}],481:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null);c.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null;var d=a("../../../../javascripts/cartodb/explore/feed_collection");describe("explore/feed_collection",function(){beforeEach(function(){this.collection=new d}),it("should generate a query",function(){var a="WITH m As (SELECT max(visualization_likes) As max_likes, max(visualization_mapviews) As max_views FROM visualizations) SELECT user_avatar_url AS avatar_url,user_username AS username,visualization_geometry_types AS geom_types,visualization_id AS id,visualization_likes AS likes,visualization_mapviews AS mapviews,visualization_mapviews::numeric / (1.0 + (now()::date - visualization_created_at::date)::numeric)^2 * 100.0 / m.max_views As mapviews_trend,visualization_likes::numeric / (1.0 + (now()::date - visualization_created_at::date)::numeric)^2 * 100.0 / m.max_likes As likes_trend,visualization_name AS name,visualization_map_datasets AS map_datasets,visualization_table_rows AS rows,visualization_table_size AS table_size,visualization_tags AS tags,visualization_title AS title,visualization_type AS type,visualization_created_at AS created_at,visualization_updated_at AS updated_at FROM visualizations, m  ORDER BY likes_trend DESC, created_at DESC, visualization_id DESC LIMIT 8 OFFSET 0";expect(this.collection._generateQuery(null,"likes",0,8)).toEqual(a)}),it("should generate a query depending on the type",function(){var a="WITH m As (SELECT max(visualization_likes) As max_likes, max(visualization_mapviews) As max_views FROM visualizations) SELECT user_avatar_url AS avatar_url,user_username AS username,visualization_geometry_types AS geom_types,visualization_id AS id,visualization_likes AS likes,visualization_mapviews AS mapviews,visualization_mapviews::numeric / (1.0 + (now()::date - visualization_created_at::date)::numeric)^2 * 100.0 / m.max_views As mapviews_trend,visualization_likes::numeric / (1.0 + (now()::date - visualization_created_at::date)::numeric)^2 * 100.0 / m.max_likes As likes_trend,visualization_name AS name,visualization_map_datasets AS map_datasets,visualization_table_rows AS rows,visualization_table_size AS table_size,visualization_tags AS tags,visualization_title AS title,visualization_type AS type,visualization_created_at AS created_at,visualization_updated_at AS updated_at FROM visualizations, m WHERE visualization_type = 'datasets' ORDER BY mapviews_trend DESC, created_at DESC, visualization_id DESC LIMIT 8 OFFSET 8";expect(this.collection._generateQuery("datasets","mapviews",1,8)).toEqual(a)})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/explore/feed_collection":292}],482:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null);c.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null;var d=a("../../../../javascripts/cartodb/explore/model");describe("explore/model",function(){beforeEach(function(){this.model=new d;
}),it("should generate a query",function(){var a="SELECT visualization_mapviews::numeric/(1.0 + (now()::date - visualization_created_at::date)::numeric)^2 AS mapviews_trend,visualization_name AS name,user_username AS username,visualization_id AS id,visualization_likes AS likes,visualization_title AS title FROM visualizations ORDER BY mapviews_trend DESC LIMIT 1";expect(this.model._generateQuery()).toEqual(a)})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/explore/model":293}],483:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null;d.admin="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null;var e=a("../../../../javascripts/cartodb/user_feed/view"),f=a("../../../../javascripts/cartodb/user_feed/feed_collection");describe("feed/view",function(){afterEach(function(){c(".js-feed").remove()}),beforeEach(function(){d.config.set("url_prefix","base_url"),f.prototype.sync=function(a,b,c){var d=[];d.push({id:1,name:"vis_name",likes:1234,updated_at:"2015-10-11",table:{geometry_types:["ST_Point"]},permission:{owner:{username:"javier",avatar_url:"http://avatar.url",map_count:10}}}),d.push({id:2,name:"vis_name_2",likes:2134,updated_at:"2015-10-11",table:{geometry_types:["ST_MultiPoint"]},permission:{owner:{username:"javier",avatar_url:"http://avatar.url",map_count:20}}}),d.push({id:3,name:"vis_name_2",likes:2134,updated_at:"2015-10-11",table:{geometry_types:["ST_MultiPoint"]},permission:{owner:{username:"javier",avatar_url:"http://avatar.url",map_count:20}}}),d.push({id:4,name:"vis_name_2",likes:2134,updated_at:"2015-10-11",table:{geometry_types:["ST_MultiPoint"]},permission:{owner:{username:"javier",avatar_url:"http://avatar.url",map_count:20}}}),d.push({id:5,name:"vis_name_2",likes:2134,updated_at:"2015-10-11",table:{geometry_types:["ST_MultiPoint"]},permission:{owner:{username:"javier",avatar_url:"http://avatar.url",map_count:20}}}),c.success({visualizations:d.slice(0,4),total_entries:d.length})},this.user=new d.admin.User({base_url:"http://pepe.carto.com",username:"pepe",account_type:"FREE"}),this.authenticatedUser=new d.open.AuthenticatedUser,this.authenticatedUser.set("username",this.user.get("username")),c("body").append('<div class="js-feed"></div>'),this.view=new e({el:c(".js-feed"),authenticatedUser:this.authenticatedUser}),spyOn(this.view,"_fetchLike"),this.view.render()}),it("should fetch a list of visualizations",function(){expect(this.view.el.innerHTML).toContain("vis_name"),expect(this.view.el.innerHTML).toContain("vis_name_2")}),it("should prepend the base_url to the links",function(){expect(this.view.$(".DefaultTitle-link:first").attr("href")).toContain("base_url")}),it("should hide the load more button when the limit is reached",function(){this.view.$el.find(".js-more").click(),expect(this.view.model.get("show_more")).toBeFalsy(),expect(this.view.$(".js-more").hasClass("is-hidden")).toBeTruthy()}),it("should define a model",function(){expect(this.view.model).toBeDefined(),expect(this.view.model.get("vis_count")).toBeDefined(),expect(this.view.model.get("size")).toBeDefined(),expect(this.view.model.get("page")).toEqual(0),expect(this.view.model.get("order_by")).toEqual("likes")}),it("should fetch the likes when the user is authenticated",function(){this.authenticatedUser.set({username:"skull"}),expect(this.view._fetchLike).toHaveBeenCalled()}),it("should allow to toggle the loader",function(){expect(this.view.loader).toBeDefined(),this.view.model.set("show_loader",!1),expect(this.view.loader.$el.css("display")).toEqual("none"),this.view.model.set("show_loader",!0),expect(this.view.loader.$el.css("display")).toEqual("block")}),it("should allow to toggle the mast",function(){this.view.model.set("show_mast",!1),expect(this.view.$(".js-mast").hasClass("is-hidden")).toBeTruthy(),this.view.model.set("show_mast",!0),expect(this.view.$(".js-mast").hasClass("is-hidden")).toBeFalsy()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/user_feed/feed_collection":330,"../../../../javascripts/cartodb/user_feed/view":331}],484:[function(a,b,c){var d=a("../../../../javascripts/cartodb/keys/header_view_model"),e=a("../common/views/dashboard_header/shared_for_view_model");describe("keys/header_view_model",function(){beforeEach(function(){this.viewModel=new d}),e.call(this),describe(".breadcrumbTitle",function(){it("should always return a string",function(){expect(this.viewModel.breadcrumbTitle()).toEqual(jasmine.any(String))})}),describe(".isDisplayingDatasets",function(){it("should always return false",function(){expect(this.viewModel.isDisplayingDatasets()).toBeFalsy()})}),describe(".isDisplayingMaps",function(){it("should always return false",function(){expect(this.viewModel.isDisplayingMaps()).toBeFalsy()})}),describe(".isDisplayingLockedItems",function(){it("should always return false",function(){expect(this.viewModel.isDisplayingLockedItems()).toBeFalsy()})})})},{"../../../../javascripts/cartodb/keys/header_view_model":294,"../common/views/dashboard_header/shared_for_view_model":449}],485:[function(a,b,c){var d=a("../../../../javascripts/cartodb/organization/color_picker_view");describe("organization/color_picker_view",function(){beforeEach(function(){this.view=new d({color:"#3E2"}),this.view.render()}),it("should render properly",function(){this.view.$el.click(),expect(this.view.colorPicker).toBeDefined(),expect(this.view.colorPicker.$("input.text").val()).toBe("#3E2")}),it("should close the picker if it is already opened",function(){this.view.$el.click(),expect(this.view.colorPicker).toBeDefined(),this.view.$el.click(),expect(this.view.colorPicker).not.toBeDefined()}),it("should trigger a signal and change background color when a new color is chosen",function(){var a=this.view.model.get("color");this.view.bind("colorChosen",function(b,c){a=b}),this.view.$el.click(),this.view.colorPicker.$('li a[href="#A53ED5"]').click(),expect(a).toBe("#A53ED5"),expect(this.view.$el.css("background-color")).toBe("rgb(165, 62, 213)"),expect(this.view.model.get("color")).toBe("#A53ED5")}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})},{"../../../../javascripts/cartodb/organization/color_picker_view":295}],486:[function(a,b,c){var d=a("../../../../javascripts/cartodb/organization/flash_message_model"),e=a("../../../../javascripts/cartodb/organization/flash_message_view");describe("organization/flash_message_view",function(){beforeEach(function(){this.model=new d,this.view=new e({model:this.model}),this.view.render()}),it("should not display the view since there is no message",function(){expect(this.view.el.outerHTML).toContain("display: none")}),describe("when model.show is called",function(){beforeEach(function(){this.model.show("ERR!")}),it("should show view",function(){expect(this.view.el.outerHTML).not.toContain("display: none"),expect(this.view.el.outerHTML).toContain("ERR!")}),describe("when model.hide is called",function(){beforeEach(function(){this.model.hide()}),it("should hide view",function(){expect(this.view.el.outerHTML).toContain("display: none")})})})})},{"../../../../javascripts/cartodb/organization/flash_message_model":296,"../../../../javascripts/cartodb/organization/flash_message_view":297}],487:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,e=a("../../../../../javascripts/cartodb/organization/groups_admin/add_or_remove_group_users_filters_extra_view"),f=a("../../../../../javascripts/cartodb/common/dialogs/add_group_users/add_group_users_view.js");describe("organization/groups_admin/add_or_remove_group_users_filters_extra_view",function(){beforeEach(function(){this.user=new d.admin.User({id:"user-id",username:"pepe",actions:{},organization:{id:"org-id",users:[{id:"abc-123",username:"paco"},{id:"abc-456",username:"pepe"}]}}),this.group=new d.admin.Group({id:"g1",organization:this.user.organization,users:[{id:"u1",username:"pachi"}]}),spyOn(f.prototype,"initialize").and.callThrough(),this.view=new e({group:this.group,orgUsers:this.user.organization.users}),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should not open dialog to add users just yet",function(){expect(f.prototype.initialize).not.toHaveBeenCalled()}),it("should show the add users button",function(){expect(this.view.$(".js-add-users").attr("style")).toBeUndefined(),expect(this.view.$(".js-rm-users").attr("style")).toContain("display: none")}),describe("when click add",function(){beforeEach(function(){this.view.$(".js-add-users").click()}),it("should open dialog to add users",function(){expect(f.prototype.initialize).toHaveBeenCalled()})}),describe("when at least one user is selected",function(){beforeEach(function(){this.group.users.first().set("selected",!0)}),it("should change the subheader to show remove button",function(){expect(this.view.$(".js-add-users").attr("style")).toContain("display: none"),expect(this.view.$(".js-rm-users").attr("style")).not.toContain("none")}),describe("when click remove",function(){beforeEach(function(){jasmine.clock().install(),this.jqXHR=c.Deferred(),spyOn(this.group.users,"removeInBatch").and.returnValue(this.jqXHR),this.view.$(".js-rm-users").click(),jasmine.clock().tick(1e3)}),afterEach(function(){jasmine.clock().uninstall()}),it("should call group users collection to remove them in batch",function(){expect(this.group.users.removeInBatch).toHaveBeenCalled(),expect(this.group.users.removeInBatch).toHaveBeenCalledWith(jasmine.any(Array)),expect(this.group.users.removeInBatch).toHaveBeenCalledWith(["u1"])}),it("should show removing users loader in a modal",function(){expect(c(".Dialog").text()).toContain("Removing users")}),describe("when users are removed",function(){beforeEach(function(){this.jqXHR.resolve(),jasmine.clock().tick(1e3)}),it("should close loading modal",function(){expect(c(".Dialog").length).toEqual(0)})}),describe("when fails to remove users",function(){beforeEach(function(){this.jqXHR.reject(),jasmine.clock().tick(1e3)}),it("should close loading modal",function(){expect(c(".Dialog").text()).not.toContain("Removing users")}),it("should show error modal",function(){expect(c(".Dialog").text()).toContain("error")})})})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/common/dialogs/add_group_users/add_group_users_view.js":47,"../../../../../javascripts/cartodb/organization/groups_admin/add_or_remove_group_users_filters_extra_view":298}],488:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../javascripts/cartodb/organization/flash_message_model"),e=a("../../../../../javascripts/cartodb/organization/groups_admin/create_group_view");describe("organization/groups_admin/create_group_view",function(){beforeEach(function(){this.group=new c.admin.Group,spyOn(this.group,"save"),this.onCreatedSpy=jasmine.createSpy("onCreated callback"),this.flashMessageModel=new d,this.view=new e({flashMessageModel:this.flashMessageModel,group:this.group,onCreated:this.onCreatedSpy}),this.view.render()}),it("should render input",function(){expect(this.view.$("input").length>0).toBe(!0)}),describe("when click create group",function(){it("should not try to save group if has no name",function(){this.view.$(".js-create").click(),expect(this.group.save).not.toHaveBeenCalled()}),describe("when has written a name",function(){beforeEach(function(){this.view.$(".js-name").val("foobar"),this.view.$(".js-create").click()}),it("should try to create group",function(){expect(this.group.save).toHaveBeenCalled()}),it("should show loading meanwhile",function(){expect(this.innerHTML()).toContain("Creating group")}),it("should not add to collection until got response",function(){expect(this.group.save.calls.argsFor(0)[1].wait).toBe(!0)}),describe("when create succeeds",function(){beforeEach(function(){this.group.save.calls.argsFor(0)[1].success()}),it("should call onCreated callback",function(){expect(this.onCreatedSpy).toHaveBeenCalled()})}),describe("when create fails",function(){beforeEach(function(){spyOn(this.flashMessageModel,"show"),this.group.save.calls.argsFor(0)[1].error(this.group,{responseText:'{"errors": ["ERR!"]}'})}),it("should show form again",function(){expect(this.innerHTML()).not.toContain("Creating group")}),it("should show error",function(){expect(this.flashMessageModel.show).toHaveBeenCalledWith("ERR!")})})})}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/organization/flash_message_model":296,"../../../../../javascripts/cartodb/organization/groups_admin/create_group_view":299}],489:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../javascripts/cartodb/organization/flash_message_model"),e=a("../../../../../javascripts/cartodb/organization/groups_admin/edit_group_view");describe("organization/groups_admin/edit_group_view",function(){beforeEach(function(){this.group=new c.admin.Group({id:"g1",display_name:"my group"}),spyOn(this.group,"save"),this.onSavedSpy=jasmine.createSpy("onSaved callback"),this.onDeletedSpy=jasmine.createSpy("onDeleted callback"),this.flashMessageModel=new d,this.view=new e({flashMessageModel:this.flashMessageModel,group:this.group,onSaved:this.onSavedSpy,onDeleted:this.onDeletedSpy}),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),describe("when click save",function(){it("should not try to save group if has no name",function(){this.view.$(".js-name").val(""),this.view.$(".js-save").click(),expect(this.group.save).not.toHaveBeenCalled()}),describe("when has changed name",function(){beforeEach(function(){this.view.$(".js-name").val("new name"),this.view.$(".js-save").click()}),it("should try to save group",function(){expect(this.group.save).toHaveBeenCalled(),expect(this.group.save).toHaveBeenCalledWith({display_name:"new name"},jasmine.any(Object))}),it("should show loading meanwhile",function(){expect(this.innerHTML()).toContain("Saving")}),it("should not update model until got response back",function(){expect(this.group.save.calls.argsFor(0)[1].wait).toBe(!0)}),describe("when save succeeds",function(){beforeEach(function(){this.group.set({id:"g1"}),this.group.save.calls.argsFor(0)[1].success()}),it("should call onSaved callback",function(){expect(this.onSavedSpy).toHaveBeenCalled()})}),describe("when save fails",function(){beforeEach(function(){spyOn(this.flashMessageModel,"show"),this.group.save.calls.argsFor(0)[1].error(this.group,{responseText:'{"errors": ["ERR!"]}'})}),it("should show form again",function(){expect(this.view.$("input").length>0).toBe(!0)}),it("should show error",function(){expect(this.flashMessageModel.show).toHaveBeenCalledWith("ERR!")})})})}),describe("when click delete group",function(){beforeEach(function(){spyOn(this.group,"destroy"),this.view.$(".js-delete").click()}),it("should change to loading while destroying",function(){expect(this.innerHTML()).toContain("Deleting")}),it("should not remove from collection until response confirms it deleteted",function(){expect(this.group.destroy.calls.argsFor(0)[0].wait).toBe(!0)}),describe("when deleted",function(){beforeEach(function(){this.group.destroy.calls.argsFor(0)[0].success()}),it("should call onDeleted callback",function(){expect(this.onDeletedSpy).toHaveBeenCalled()})}),describe("when deletion fails",function(){beforeEach(function(){this.group.destroy.calls.argsFor(0)[0].error()}),it("should show form again",function(){expect(this.view.$("input").length>0).toBe(!0)})})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/organization/flash_message_model":296,"../../../../../javascripts/cartodb/organization/groups_admin/edit_group_view":300}],490:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,e=a("../../../../../javascripts/cartodb/organization/groups_admin/empty_group_filters_extra_view");describe("organization/groups_admin/empty_group_filters_extra_view",function(){beforeEach(function(){this.user=new d.admin.User({id:"user-id",username:"pepe",actions:{},organization:{id:"org-id",users:[{id:"ou-1",username:"paco"},{id:"ou-2",username:"pepe"}]}}),this.group=new d.admin.Group({id:"g1",organization:this.user.organization,users:[{id:"gu-1",username:"pachi"}]}),this.groupUsers=this.group.users,spyOn(this.groupUsers,"addInBatch"),this.orgUsers=this.user.organization.users,this.view=new e({groupUsers:this.groupUsers,orgUsers:this.orgUsers}),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should show the add-users button disabled",function(){expect(this.view.$(".js-add-users").hasClass("is-disabled")).toBe(!0)}),it("should do nothing on click add-button",function(){this.view.$(".js-add-users").click(),expect(this.groupUsers.addInBatch).not.toHaveBeenCalled()}),describe("when at least one user is selected",function(){beforeEach(function(){this.orgUsers.first().set("selected",!0)}),it("should change the subheader to show add button",function(){expect(this.view.$(".js-add-users").hasClass("is-disabled")).toBe(!1)}),describe("when click add",function(){beforeEach(function(){jasmine.clock().install(),this.jqXHR=c.Deferred(),this.groupUsers.addInBatch.and.returnValue(this.jqXHR),this.view.$(".js-add-users").click(),jasmine.clock().tick(1e3)}),afterEach(function(){jasmine.clock().uninstall()}),it("should call group users collection to add them in batch",function(){expect(this.group.users.addInBatch).toHaveBeenCalled(),expect(this.group.users.addInBatch).toHaveBeenCalledWith(jasmine.any(Array)),expect(this.group.users.addInBatch).toHaveBeenCalledWith(["ou-1"])}),it("should show removing users loader in a modal",function(){expect(c(".Dialog").text()).toContain("Adding")}),describe("when users are added",function(){beforeEach(function(){this.jqXHR.resolve(),jasmine.clock().tick(1e3)}),it("should close loading modal",function(){expect(c(".Dialog").length).toEqual(0)})}),describe("when fails to add users",function(){beforeEach(function(){this.jqXHR.reject(),jasmine.clock().tick(1e3)}),it("should close loading modal",function(){expect(c(".Dialog").text()).not.toContain("Adding")}),it("should show error modal",function(){expect(c(".Dialog").text()).toContain("error")})})})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/organization/groups_admin/empty_group_filters_extra_view":301}],491:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../javascripts/cartodb/organization/groups_admin/group_header_view");describe("organization/groups_admin/group_header_view",function(){beforeEach(function(){this.setupView=function(){this.group=new c.admin.Group,this.urls={root:new c.common.Url({base_url:"fake-root-url"}),users:new c.common.Url({base_url:"fake-users-url"}),edit:new c.common.Url({base_url:"fake-edit-url"})},this.urls.users.isCurrent=!0,spyOn(d.prototype,"initialize").and.callThrough(),this.view=new d({group:this.group,urls:this.urls}),this.view.render()}}),describe("when group is new",function(){beforeEach(function(){this.setupView()}),it("should render the fallback text as title",function(){expect(this.innerHTML()).toContain("Create new group")}),it("should render back button to root",function(){expect(this.view.$(".Filters-group a.u-actionTextColor").attr("href")).toEqual("fake-root-url")}),it("should not render the users tab",function(){expect(this.innerHTML()).not.toMatch("sUser")}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()})}),describe("when group already exist",function(){beforeEach(function(){this.setupView(),this.group.set({id:"g1",display_name:"my group"})}),it("should render the group display name as title",function(){expect(this.innerHTML()).toContain("my group")}),it("should render back button to root",function(){expect(this.view.$(".Filters-group a.u-actionTextColor").attr("href")).toEqual("fake-root-url")}),it("should render back button to users if is not on users url",function(){this.urls.users.isCurrent=!1,this.view.render(),expect(this.view.$(".Filters-group a.u-actionTextColor").attr("href")).toEqual("fake-users-url")}),it("should render the menu",function(){expect(this.innerHTML()).toContain("User")}),it("should only render users count if has any",function(){expect(this.innerHTML()).not.toContain("0 Users"),this.group.users.reset([{}]),expect(this.innerHTML()).toContain("1 User"),this.group.users.reset([{},{},{}]),expect(this.innerHTML()).toContain("3 Users")}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/organization/groups_admin/group_header_view":302}],492:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null),d=a("../../../../../javascripts/cartodb/organization/groups_admin/group_users_view");describe("organization/groups_admin/group_users_view",function(){beforeEach(function(){this.user=new c.admin.User({id:"user-id",username:"pepe",actions:{},organization:{id:"org-id",users:[{id:"abc-123",username:"paco"},{id:"abc-456",username:"pepe"}]}}),this.group=new c.admin.Group({id:"g1",organization:this.user.organization,users:[{id:"u1",username:"pachi"}]}),this.groupUsers=this.group.users;var a=this;this.groupUsers.sync=function(b,c,d){a.syncOpts=d},this.view=new d({group:this.group,orgUsers:this.user.organization.users}),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should render a loading view initially",function(){expect(this.innerHTML()).toContain("Getting users")}),describe("when group users are fetched",function(){describe("when there are no group users",function(){beforeEach(function(){this.syncOpts.success({users:[],total_user_entries:0,total_entries:0})}),it("should render the empty view",function(){expect(this.innerHTML()).not.toContain("Remove")}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),describe("when group users are added",function(){beforeEach(function(){this.syncOpts.success({users:[{id:"gu-1",username:"pepito"}],total_user_entries:1,total_entries:1}),this.groupUsers.fetch()}),it("should render the group users",function(){expect(this.innerHTML()).toContain("pepito")}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()})})}),describe("when there are at least one group user",function(){beforeEach(function(){this.syncOpts.success({users:[{id:"gu-2",username:"bollibompa"}],total_user_entries:1,total_entries:1})}),it("should render the group users",function(){expect(this.innerHTML()).toContain("bollibompa")}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),describe("when group is emptied",function(){beforeEach(function(){this.syncOpts.success({users:[],total_user_entries:0,total_entries:0}),this.groupUsers.fetch()}),it("should render the empty view",function(){expect(this.innerHTML()).not.toContain("Remove"),expect(this.innerHTML()).not.toContain("bollibompa")})})})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/organization/groups_admin/group_users_view":305}],493:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null),d=a("../../../../../javascripts/cartodb/organization/groups_admin/group_view");describe("organization/groups_admin/group_view",function(){beforeEach(function(){this.group=new c.admin.Group({display_name:"foobar",shared_tables_count:42,shared_maps_count:37,users:[{id:"u1",name:"pepe"}]}),this.view=new d({model:this.group,url:"group-url"}),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should render the title",function(){expect(this.innerHTML()).toContain("foobar")}),it("should render the URL",function(){expect(this.innerHTML()).toContain('href="group-url"')}),it("should render the shared maps/datasets counts",function(){expect(this.innerHTML()).toContain("42 shared datasets"),expect(this.innerHTML()).toContain("37 shared maps")}),it("should render a preview of the users",function(){expect(this.innerHTML()).toContain("pepe")}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/organization/groups_admin/group_view":306}],494:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null),d=a("../../../../../javascripts/cartodb/organization/groups_admin/groups_main_view");describe("organization/groups_admin/groups_main_view",function(){beforeEach(function(){this.contentView=new c.core.View,spyOn(this.contentView,"render").and.callThrough(),this.routerModel=new c.core.Model({view:this.contentView}),this.router=new c.core.Model,this.router.model=this.routerModel,this.view=new d({router:this.router,groups:this.groups}),this.view.render()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should render the view given by router model",function(){expect(this.contentView.render).toHaveBeenCalled(),expect(this.view.el).toEqual(this.contentView.el.parentNode)}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/organization/groups_admin/groups_main_view":309}],495:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../javascripts/cartodb/organization/groups_admin/router"),e=a("../../../../../javascripts/cartodb/organization/flash_message_model");describe("organization/groups_admin/router",function(){beforeEach(function(){var a=new c.admin.User({id:123,base_url:"https://carto.com/user/paco",username:"paco",organization:{owner:{id:123}},org_admin:!0});this.groups=new c.admin.OrganizationGroups([],{organization:a.organization}),this.flashMessageModel=new e,this.router=new d({user:a,flashMessageModel:this.flashMessageModel,rootUrl:a.viewUrl().organization().groups(),groups:this.groups})}),describe(".normalizeFragmentOrUrl",function(){it("should return the normalized pathname for URLs matching current scope",function(){expect(this.router.normalizeFragmentOrUrl("https://carto.com/user/paco/organization/groups/new")).toEqual("/new"),expect(this.router.normalizeFragmentOrUrl("https://carto.com/user/paco/organization/groups/edit/123")).toEqual("/edit/123")}),it("should return full URL for non-matching URLs",function(){expect(this.router.normalizeFragmentOrUrl("https://carto.com/user/paco/somewhere/else")).toEqual("https://carto.com/user/paco/somewhere/else")})}),it("should render a generic loading view for starters",function(){var a=this.router.model.get("view");a.render(),expect(this.innerHTML(a)).toContain("Loading view")})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/organization/flash_message_model":296,"../../../../../javascripts/cartodb/organization/groups_admin/router":310}],496:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../javascripts/cartodb/organization/groups_admin/router_model");describe("organization/groups_admin/router",function(){beforeEach(function(){var a=new c.admin.User({id:123,base_url:"https://carto.com/user/paco",username:"paco",organization:{owner:{id:123}}});this.groups=new c.admin.OrganizationGroups([],{organization:a.organization}),this.model=new d}),describe(".createGroupView",function(){beforeEach(function(){this.groups.add({id:"g1",display_name:"group that i already fetched"}),this.fetchedCallbackSpy=jasmine.createSpy("fetchedCallback")}),describe("when given a id of a group that already is fetched",function(){beforeEach(function(){this.model.createGroupView(this.groups,"g1",this.fetchedCallbackSpy)}),it("should call the fetched callback right away with the corresponding group",function(){expect(this.fetchedCallbackSpy).toHaveBeenCalled(),expect(this.fetchedCallbackSpy).toHaveBeenCalledWith(this.groups.first())})}),describe("when given a id of a group that is not yet fetched",function(){beforeEach(function(){spyOn(c.admin.Group.prototype,"fetch"),this.model.createGroupView(this.groups,"other",this.fetchedCallbackSpy)}),it("should fetch the group first",function(){expect(c.admin.Group.prototype.fetch).toHaveBeenCalled(),expect(this.fetchedCallbackSpy).not.toHaveBeenCalled()}),it("should fetch w/ users",function(){expect(c.admin.Group.prototype.fetch.calls.argsFor(0)[0].data.fetch_users).toBe(!0)}),describe("when fetch succeeds",function(){beforeEach(function(){c.admin.Group.prototype.fetch.calls.argsFor(0)[0].success()}),it("should add the group to the collection",function(){expect(this.groups.get("other")).toBeDefined()}),it("should call the fetched callback with the new group",function(){expect(this.fetchedCallbackSpy).toHaveBeenCalled(),expect(this.fetchedCallbackSpy).toHaveBeenCalledWith(this.groups.get("other"))})}),describe("when fetch fails",function(){beforeEach(function(){c.admin.Group.prototype.fetch.calls.argsFor(0)[0].error()}),it("should create a generic error view",function(){var a=this.model.get("view");a.render(),expect(this.innerHTML(a)).toContain("error")})})})}),describe(".createLoadingView",function(){beforeEach(function(){this.model.createLoadingView("Loading something")}),it("should create a loading view",function(){var a=this.model.get("view");a.render(),expect(this.innerHTML(a)).toContain("Loading something")})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/organization/groups_admin/router_model":311}],497:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null,d=a("../../../../../../javascripts/cartodb/organization/icon_picker/icon_picker_dialog/icon_picker_dialog_view");describe("organization/icon_picker/icon_picker_dialog/icon_picker_dialog_view",function(){var a="5p3c724-1ndv572135";beforeEach(function(){this.view=new d({orgId:a}),this.view.render()}),afterEach(function(){this.view.clean()}),it("should render properly",function(){
expect(this.view.$el.html()).toContain("Organization icons"),expect(this.view.$(".js-dialogIconPicker").length).toBe(1),expect(c.size(this.view._subviews)).toBe(1)}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),describe("._onAddIconClicked",function(){it("should hide error message, trigger input click and prevent default",function(){var a=!1;this.view.$(".js-inputFile").on("click",function(){a=!0}),spyOn(this.view,"_hideErrorMessage"),spyOn(this.view,"killEvent").and.callThrough(),this.view._onAddIconClicked(),expect(this.view._hideErrorMessage).toHaveBeenCalled(),expect(this.view.killEvent).toHaveBeenCalled(),expect(a).toBe(!0)})}),describe("_hideErrorMessage",function(){it("should hide error message",function(){spyOn(this.view,"_hide"),this.view._hideErrorMessage(),expect(this.view._hide).toHaveBeenCalledWith(".js-errorMessage")})}),describe("_hide",function(){it("_hide adds `is-hidden` class",function(){var a=this.view.$(".js-iconsInfo");expect(a.length).toBeGreaterThan(0),expect(a.hasClass("is-hidden")).toBe(!1),this.view._hide(".js-iconsInfo"),expect(a.hasClass("is-hidden")).toBe(!0)})}),describe("._onIsProcessRunningChanged",function(){it("should disable all events if icon picker is running a process",function(){this.view.icon_picker.model.set("isProcessRunning",!0),expect(this.view.$el.css("pointer-events")).toBe("none")}),it("should enable all events if icon picker is not running a process",function(){this.view.icon_picker.model.set("isProcessRunning",!0),this.view.icon_picker.model.set("isProcessRunning",!1),expect(this.view.$el.css("pointer-events")).toBe("auto")})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/organization/icon_picker/icon_picker_dialog/icon_picker_dialog_view":312}],498:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/organization/icon_picker/icons/delete_icons_dialog_view");describe("organization/icon_picker/icons/delete_icons_dialog_view",function(){describe("render",function(){it("should render properly when several icons",function(){var a=new d({numOfIcons:5,okCallback:function(){}});a.render(),expect(a.$(".Badge").text()).toEqual("5"),expect(a.$("h4").text()).toContain("5 icons"),expect(a.$(".Dialog-header p").text()).toContain("these icons")}),it("should render properly when only 1 icon",function(){var a=new d({numOfIcons:1,okCallback:function(){}});a.render(),expect(a.$(".Badge").text()).toEqual("1"),expect(a.$("h4").text()).toContain("1 icon"),expect(a.$(".Dialog-header p").text()).toContain("this icon"),expect(a.$(".Dialog-header p").text()).not.toContain("these icons")}),it("should render properly when no icon",function(){var a=new d({numOfIcons:0,okCallback:function(){}});a.render(),expect(a.$(".Badge").length).toBe(0),expect(a.$("h4").text()).toContain("icons"),expect(a.$(".Dialog-header p").text()).toContain("these icons")}),it("should have no leaks",function(){var a=new d({numOfIcons:5,okCallback:function(){}});expect(a).toHaveNoLeaks()})}),describe("ok",function(){it("should call `ok` callback and close",function(){var a=new d({numOfIcons:5,okCallback:function(){}});spyOn(a,"_okCallback"),spyOn(a,"close"),a.ok(),expect(a._okCallback).toHaveBeenCalled(),expect(a.close).toHaveBeenCalled()})})})},{"../../../../../../javascripts/cartodb/organization/icon_picker/icons/delete_icons_dialog_view":313}],499:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/organization/icon_picker/icons/organization_icon_collection");describe("organization/icon_picker/icons/organization_icon_collection",function(){it("should form the URL properly",function(){var a="5p3c724-1ndv572135",b=new d(null,{orgId:a});expect(b.url()).toEqual("/api/v1/organization/"+a+"/assets")})})},{"../../../../../../javascripts/cartodb/organization/icon_picker/icons/organization_icon_collection":314}],500:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.Backbone:"undefined"!=typeof b?b.Backbone:null,d=a("../../../../../../javascripts/cartodb/organization/icon_picker/icons/organization_icon_model");describe("organization/icon_picker/icons/organization_icon_model",function(){it("should have defaults to false",function(){var a=new d;expect(a.attributes).toEqual({selected:!1,visible:!1,deleted:!1}),expect(a.fileAttribute).toEqual("resource")}),it("save should not serialize only UI attributes",function(){spyOn(c.Model.prototype,"save");var a=new d({garrafa:"XXL"});expect(a.attributes.selected).toBeDefined(),expect(a.attributes.visible).toBeDefined(),expect(a.attributes.deleted).toBeDefined(),a.save();var b=c.Model.prototype.save.calls.mostRecent();expect(b.args[0].garrafa).toBeDefined(),expect(b.args[0].selected).not.toBeDefined(),expect(b.args[0].visible).not.toBeDefined(),expect(b.args[0].deleted).not.toBeDefined()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/organization/icon_picker/icons/organization_icon_model":315}],501:[function(a,b,c){var d=a("../../../../../../javascripts/cartodb/organization/icon_picker/icons/organization_icon_view"),e=a("../../../../../../javascripts/cartodb/organization/icon_picker/icons/organization_icon_model");describe("organization/icon_picker/icons/organization_icon_view",function(){beforeEach(function(){var a="5p3c724-1ndv572135";this.model=new e({public_url:"some_url"},{orgId:a}),this.view=new d({model:this.model})}),describe("initialize",function(){it("should call _initBinds and hook `click`",function(){expect(this.view.events.click).toEqual("_onClick"),expect(this.view.model._callbacks["change:selected"]).toBeDefined(),expect(this.view.model._callbacks["change:deleted"]).toBeDefined()})}),describe("render",function(){it("should render properly",function(){this.view.render(),expect(this.view.$(".IconItem-icon").length).toBe(1),expect(this.view.$("img").attr("src")).toEqual(this.model.get("public_url")),expect(this.view.$("img").attr("crossorigin")).toEqual("anonymous")})}),describe("_onClick",function(){it("should toggle selected state",function(){var a=this.view.model.get("selected");this.view.render(),this.view._onClick(),expect(this.view.model.get("selected")).toBe(!a),this.view._onClick(),expect(this.view.model.get("selected")).toBe(a)})}),describe("_onSelectedChanged",function(){it("should toggle `is-selected` class",function(){spyOn(this.view,"_onSelectedChanged").and.callThrough(),this.view._initBinds(),this.view.render(),expect(this.view.$el.hasClass("is-selected")).toBe(!1),this.view.model.set("selected",!0),expect(this.view.$el.hasClass("is-selected")).toBe(!0),this.view.model.set("selected",!1),expect(this.view.$el.hasClass("is-selected")).toBe(!1),expect(this.view._onSelectedChanged).toHaveBeenCalledTimes(2)})}),describe("_onDeletedChanged",function(){it("should remove element if is rendered and deleted",function(){this.view.render(),spyOn(this.view.$el,"remove").and.callThrough(),this.view.model.set("deleted",!0),expect(this.view.$el.remove).toHaveBeenCalled()}),it("should remove element if is rendered and deleted",function(){this.view.render(),spyOn(this.view.$el,"remove").and.callThrough(),this.view.model.set("deleted",!1),expect(this.view.$el.remove).not.toHaveBeenCalled()})})})},{"../../../../../../javascripts/cartodb/organization/icon_picker/icons/organization_icon_model":315,"../../../../../../javascripts/cartodb/organization/icon_picker/icons/organization_icon_view":316}],502:[function(a,b,c){(function(b){var c=a("../../../../../../javascripts/cartodb/organization/icon_picker/icons/organization_icons_view"),d=a("../../../../../../javascripts/cartodb/organization/icon_picker/icons/organization_icon_model"),e="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null;describe("organization/icon_picker/icons/organization_icons_view",function(){function a(a){var b=new d;return b.set("index",a||1),b}var b="5p3c724-1ndv572135",f={status:200},g=!1,h={preventDefault:function(){g=!0}};beforeEach(function(){jasmine.Ajax.install(),jasmine.Ajax.stubRequest(new RegExp("^http(s)?.*/assets")).andReturn(f),g=!1,this.view=new c({orgId:b})}),afterEach(function(){jasmine.Ajax.uninstall()}),describe(".initialize",function(){it("should initialize properly",function(){expect(this.view.template).toBeDefined(),expect(this.view._orgId).toEqual(b),expect(this.view.model).toBeDefined(),expect(this.view.model.get("isProcessRunning")).toBe(!1),expect(this.view._iconCollection).toBeDefined(),expect(this.view._iconCollection._orgId).toEqual(b),expect(this.view._numOfUploadingProcesses).toBe(0),expect(this.view._numOfDeletingProcesses).toBe(0),expect(this.view._fetchErrorMessage).toEqual("Error fetching organization icons. Please refresh the page."),expect(this.view._runningMessage).toEqual(""),expect(this.view.$(".js-iconMainLabel").length).toBe(1);var a=jasmine.Ajax.requests.filter("/api/v1/organization/"+b+"/assets");expect(a.length).toBe(1),expect(this.view._iconCollection._callbacks["change:selected"]).toBeDefined(),expect(this.view.model._callbacks["change:isProcessRunning"]).toBeDefined()}),it("should fail if no OrgId provided",function(){expect(function(){new c}).toThrowError("Organization ID is required.")})}),describe(".render",function(){it("should have rendered the right template",function(){var a=this.view.$(".FormAccount-rowLabel");expect(a.find(".js-iconMainLabel").length).toBe(1),expect(a.find(".js-iconsInfo").length).toBe(1),expect(a.find(".js-runningInfo").length).toBe(1),expect(a.find(".js-selectAllIcons").length).toBe(1),expect(a.find(".js-deselectAllIcons").length).toBe(1),expect(a.find(".js-deleteIcons").length).toBe(1);var b=this.view.$(".js-asset-icons");expect(b.find(".js-items").length).toBe(1),expect(b.find(".js-addIcon").length).toBe(1),expect(b.find(".js-plusSign").length).toBe(1),expect(b.find(".js-spinner").length).toBe(1),expect(this.view.$(".js-errorMessage").length).toBe(1),expect(this.view.$("input[type=file]").length).toBe(1)})}),describe(".initBinds",function(){it("should hook up ",function(){spyOn(this.view,"_refreshActions"),spyOn(this.view,"_onProcessRunningChanged"),this.view._initBinds(),this.view._iconCollection.trigger("change:selected"),this.view.model.trigger("change:isProcessRunning"),expect(this.view._refreshActions).toHaveBeenCalled(),expect(this.view._onProcessRunningChanged).toHaveBeenCalled()})}),describe("._fetchAllIcons",function(){it("should call success callback if success",function(){spyOn(this.view,"_renderAllIcons"),this.view._iconCollection.fetch=function(a){a.success()},this.view._fetchAllIcons(),expect(this.view._renderAllIcons).toHaveBeenCalled()}),it("should call error callback if error",function(){spyOn(this.view,"_onFetchIconsError"),this.view._iconCollection.fetch=function(a){a.error()},this.view._fetchAllIcons(),expect(this.view._onFetchIconsError).toHaveBeenCalled()})}),describe("._renderAllIcons",function(){it("should call _addIconElement for each collection member",function(){this.view._iconCollection.models=[1,2,3],spyOn(this.view,"_addIconElement"),this.view._renderAllIcons(),expect(this.view._addIconElement).toHaveBeenCalledTimes(3),expect(this.view._addIconElement).toHaveBeenCalledWith(1),expect(this.view._addIconElement).toHaveBeenCalledWith(2),expect(this.view._addIconElement).toHaveBeenCalledWith(3)})}),describe("._onFetchIconsError",function(){it("should call _showErrorMessage with the proper message",function(){spyOn(this.view,"_showErrorMessage"),this.view._onFetchIconsError(),expect(this.view._showErrorMessage).toHaveBeenCalledWith(this.view._fetchErrorMessage)})}),describe("._renderIcon",function(){it("the icon gets rendered",function(){var b=a();expect(b.get("visible")).toBe(!1),this.view._renderIcon(b),expect(this.view.$(".js-items").children().length).toBe(2),expect(b.get("visible")).toBe(!0)})}),describe("._addIconElement",function(){it("should render icon and refresh actions",function(){var b=a();this.view._iconCollection.add(b),spyOn(this.view,"_renderIcon"),this.view._addIconElement(b),expect(this.view._renderIcon).toHaveBeenCalledWith(b)})}),describe("._onAddIconClicked",function(){it("should hide error message, trigger input click and prevent default",function(){var a=!1;this.view.$(".js-inputFile").on("click",function(){a=!0}),spyOn(this.view,"_hideErrorMessage"),spyOn(this.view,"killEvent").and.callThrough(),this.view._onAddIconClicked(),expect(this.view._hideErrorMessage).toHaveBeenCalled(),expect(this.view.killEvent).toHaveBeenCalled(),expect(a).toBe(!0)})}),describe("._parseResponseText",function(){it("should return empty if no response given",function(){var a=this.view._parseResponseText();expect(a).toEqual("")}),it("should return empty if no responseText property is present",function(){var a={},b=this.view._parseResponseText(a);expect(b).toEqual("")}),it("should return errors if property is present",function(){var a={errors:"something happened"},b={responseText:JSON.stringify(a)},c=this.view._parseResponseText(b);expect(c).toEqual(a.errors)}),it("should return empty if property is present but not parseable",function(){var a={responseText:"not valid JSON"},b=this.view._parseResponseText(a);expect(b).toEqual("")})}),describe("._getSelectedFiles",function(){it("should retrieve selected files from input",function(){var a=this.view._getSelectedFiles(),b=Object.getPrototypeOf(a).toString();expect(b.indexOf("FileList")>-1).toBe(!0)})}),describe("._onFileSelected",function(){function a(){this.view._iconCollection.create=function(a,c){var d={kind:a.kind,resource:a.resource,callbacks:c};b.push(d)}}var b=[];it("should create an icon model for each selected file",function(){var c=["one","two"];a.call(this),spyOn(this.view,"_getSelectedFiles").and.returnValue(c),spyOn(this.view,"_beforeIconUpload"),spyOn(this.view,"_onIconUploaded"),spyOn(this.view,"_onIconUploadError"),spyOn(this.view,"_onIconUploadComplete"),this.view._onFileSelected(),expect(b.length).toBe(2),expect(b[0].kind).toEqual("organization_asset"),expect(b[0].resource).toEqual(c[0]),expect(b[1].kind).toEqual("organization_asset"),expect(b[1].resource).toEqual(c[1]),b[0].callbacks.beforeSend(),expect(this.view._beforeIconUpload).toHaveBeenCalled(),b[0].callbacks.success(),expect(this.view._onIconUploaded).toHaveBeenCalled(),b[0].callbacks.error(),expect(this.view._onIconUploadError).toHaveBeenCalled(),b[0].callbacks.complete(),expect(this.view._onIconUploadComplete).toHaveBeenCalled()})}),describe("._beforeIconUpload",function(){it("should set `isProcessRunning` properly",function(){this.view._beforeIconUpload(),expect(this.view._numOfUploadingProcesses).toBe(1),expect(this.view._runningMessage).toEqual("Uploading icons..."),expect(this.view.model.get("isProcessRunning")).toBe(!0)})}),describe("._onIconUploaded",function(){it("should reset selection and add the icon",function(){spyOn(this.view,"_resetFileSelection"),spyOn(this.view,"_addIconElement"),spyOn(this.view,"_refreshActions"),this.view._onIconUploaded("icon"),expect(this.view._resetFileSelection).toHaveBeenCalled(),expect(this.view._addIconElement).toHaveBeenCalledWith("icon")})}),describe("._onIconUploadError",function(){it("should reset selection and show the proper error message",function(){spyOn(this.view,"_parseResponseText").and.returnValue("an error text"),spyOn(this.view,"_resetFileSelection"),spyOn(this.view,"_uploadErrorMessage").and.returnValue("upload error"),spyOn(this.view,"_showErrorMessage"),this.view._onIconUploadError("whatever","response"),expect(this.view._parseResponseText).toHaveBeenCalledWith("response"),expect(this.view._resetFileSelection).toHaveBeenCalled(),expect(this.view._uploadErrorMessage).toHaveBeenCalledWith("an error text"),expect(this.view._showErrorMessage).toHaveBeenCalledWith("upload error")})}),describe("._onIconUploadComplete",function(){it("should set `isProcessRunning` properly",function(){this.view._numOfUploadingProcesses=1,this.view._onIconUploadComplete(),expect(this.view._numOfUploadingProcesses).toBe(0),expect(this.view.model.get("isProcessRunning")).toBe(!1)})}),describe("_show and _hide",function(){it("_show remove `is-hidden` class",function(){var a=this.view.$(".js-selectAllIcons");expect(a.length).toBeGreaterThan(0),expect(a.hasClass("is-hidden")).toBe(!0),this.view._show(".js-selectAllIcons"),expect(a.hasClass("is-hidden")).toBe(!1)}),it("_hide adds `is-hidden` class",function(){var a=this.view.$(".js-iconsInfo");expect(a.length).toBeGreaterThan(0),expect(a.hasClass("is-hidden")).toBe(!1),this.view._hide(".js-iconsInfo"),expect(a.hasClass("is-hidden")).toBe(!0)})}),describe("_refreshActions",function(){function b(a){return this.view.$(a).hasClass("is-hidden")}var c;beforeEach(function(){c=b.bind(this)}),it("should do nothing if some process is running",function(){spyOn(this.view,"_getNumberOfSelectedIcons"),this.view.model.set("isProcessRunning",!0),this.view._refreshActions(),expect(this.view._getNumberOfSelectedIcons).not.toHaveBeenCalled()}),it("should show only info if no icon is selected",function(){spyOn(this.view,"_getNumberOfSelectedIcons").and.returnValue(0),this.view._refreshActions(),expect(this.view.$(".js-iconMainLabel").text()).toEqual(""),expect(c(".js-selectAllIcons")).toBe(!0),expect(c(".js-deselectAllIcons")).toBe(!0),expect(c(".js-deleteIcons")).toBe(!0),expect(c(".js-iconsInfo")).toBe(!1)}),it("should show `select all` and `delete icons` if some icons are selected",function(){spyOn(this.view,"_getNumberOfSelectedIcons").and.returnValue(2),this.view._iconCollection.push(a()),this.view._iconCollection.push(a()),this.view._iconCollection.push(a()),this.view._iconCollection.push(a()),this.view._refreshActions(),expect(this.view.$(".js-iconMainLabel").text()).toEqual("2 icons selected"),expect(c(".js-selectAllIcons")).toBe(!1),expect(c(".js-deselectAllIcons")).toBe(!0),expect(c(".js-deleteIcons")).toBe(!1),expect(c(".js-iconsInfo")).toBe(!0)}),it("should show `deselect all` and `delete icons` if all icons are selected",function(){spyOn(this.view,"_getNumberOfSelectedIcons").and.returnValue(3),this.view._iconCollection.push(a()),this.view._iconCollection.push(a()),this.view._iconCollection.push(a()),this.view._refreshActions(),expect(this.view.$(".js-iconMainLabel").text()).toEqual("3 icons selected"),expect(c(".js-selectAllIcons")).toBe(!0),expect(c(".js-deselectAllIcons")).toBe(!1),expect(c(".js-deleteIcons")).toBe(!1),expect(c(".js-iconsInfo")).toBe(!0)}),describe("delete icon copy",function(){beforeEach(function(){this.view._iconCollection.push(a()),this.view._iconCollection.push(a()),this.view._iconCollection.push(a())}),it("should show `delete icon` if one icon selected",function(){spyOn(this.view,"_getNumberOfSelectedIcons").and.returnValue(1),this.view._refreshActions(),expect(this.view.$(".js-deleteIcons a").text()).toEqual("Delete icon...")}),it("should show `delete icon` if more than one icon selected",function(){spyOn(this.view,"_getNumberOfSelectedIcons").and.returnValue(2),this.view._refreshActions(),expect(this.view.$(".js-deleteIcons a").text()).toEqual("Delete icons...")})}),it("should show `View all icons` if there are more than max",function(){spyOn(this.view,"_getNumberOfSelectedIcons").and.returnValue(0);for(var b=0;b<this.view._maxIcons+1;b++)this.view._iconCollection.push(a());this.view._refreshActions(),expect(c(".js-viewAllIcons")).toBe(!1)})}),describe("_onDeselectAllIconsClicked",function(){it("should prevent default and deselect all icons",function(){this.view._iconCollection.push(a(0).set("selected",!0)),this.view._iconCollection.push(a(1).set("selected",!0)),this.view._onDeselectAllIconsClicked(h),expect(g).toBe(!0),expect(this.view._iconCollection.at(0).get("selected")).toBe(!1),expect(this.view._iconCollection.at(1).get("selected")).toBe(!1)})}),describe("_onSelectAllIconsClicked",function(){it("should prevent default and select all visible icons",function(){this.view._iconCollection.push(a(0).set("visible",!0)),this.view._iconCollection.push(a(1).set("visible",!0)),this.view._iconCollection.push(a(2)),this.view._onSelectAllIconsClicked(h),expect(g).toBe(!0),expect(this.view._iconCollection.at(0).get("selected")).toBe(!0),expect(this.view._iconCollection.at(1).get("selected")).toBe(!0),expect(this.view._iconCollection.at(2).get("selected")).toBe(!1)})}),describe("_onDeleteIconsClicked",function(){it("should prevent default and open delete icons modal dialog",function(){spyOn(this.view,"_openDeleteIconsDialog"),this.view._onDeleteIconsClicked(h),expect(g).toBe(!0),expect(this.view._openDeleteIconsDialog).toHaveBeenCalled()})}),describe("_openDeleteIconsDialog",function(){it("should show modal with right number of icons to delete and call `_deleteIcons` on OK",function(){spyOn(this.view,"_deleteIcons").and.callThrough(),this.view._iconCollection.push(a(0).set("selected",!0)),this.view._iconCollection.push(a(1).set("selected",!0)),this.view._iconCollection.push(a(2)),this.view._openDeleteIconsDialog();var b=document.querySelector(".Dialog-headerIconBadge");expect(b).not.toBe(null),expect(b.textContent).toEqual("2");var c=document.querySelector(".Dialog-footer button.ok"),d=document.createEvent("HTMLEvents");d.initEvent("click",!0,!1),c.dispatchEvent(d),expect(this.view._deleteIcons).toHaveBeenCalled()})}),describe("_deleteIcons",function(){function b(a){a.destroy=function(a){var b={callbacks:a};c.push(b)}}var c=[];it("should hide error message, call `destroy` on every selected icon and hook up callbacks",function(){var d=a(0).set("selected",!0),e=a(1).set("selected",!0),f=a(2);b(d),b(e),b(f),spyOn(this.view,"_hideErrorMessage"),spyOn(this.view,"_beforeIconDelete"),spyOn(this.view,"_onIconDeleted"),spyOn(this.view,"_onIconDeleteError"),spyOn(this.view,"_onIconDeleteComplete"),this.view._iconCollection.push(d),this.view._iconCollection.push(e),this.view._iconCollection.push(f),this.view._deleteIcons(),expect(this.view._hideErrorMessage).toHaveBeenCalled(),expect(c.length).toBe(2),c[0].callbacks.beforeSend(),expect(this.view._beforeIconDelete).toHaveBeenCalled(),c[0].callbacks.success(),expect(this.view._onIconDeleted).toHaveBeenCalled(),c[0].callbacks.error(),expect(this.view._onIconDeleteError).toHaveBeenCalled(),c[0].callbacks.complete(),expect(this.view._onIconDeleteComplete).toHaveBeenCalled()})}),describe("_getNumberOfSelectedIcons",function(){it("should return number of selected icons",function(){this.view._iconCollection.push(a(0).set("selected",!0)),this.view._iconCollection.push(a(1).set("selected",!0)),this.view._iconCollection.push(a(2));var b=this.view._getNumberOfSelectedIcons();expect(b).toBe(2)})}),describe("_beforeIconDelete",function(){it("should increase number of deleting processes and set `isProcessRunning` to true",function(){this.view._beforeIconDelete(),expect(this.view._numOfDeletingProcesses).toBe(1),expect(this.view._runningMessage).toEqual("Deleting icons..."),expect(this.view.model.get("isProcessRunning")).toBe(!0)})}),describe("_onIconDeleted",function(){it("should set icon model to `deleted` and add another icon from the non visible ones",function(){var b=a();spyOn(this.view,"_addExtraIcon"),this.view._onIconDeleted(b),expect(b.get("deleted")).toBe(!0),expect(this.view._addExtraIcon).toHaveBeenCalled()})}),describe("_onIconDeleteError",function(){it("should show error message, reset the selection and add again the icon to the collection",function(){var b=a();spyOn(this.view,"_parseResponseText").and.returnValue("whatever"),spyOn(this.view,"_resetSelection"),spyOn(this.view,"_deleteErrorMessage").and.returnValue("ayo"),spyOn(this.view,"_showErrorMessage"),this.view._onIconDeleteError(b,"response"),expect(this.view._parseResponseText).toHaveBeenCalledWith("response"),expect(this.view._iconCollection.length).toBe(1),expect(this.view._resetSelection).toHaveBeenCalled(),expect(this.view._deleteErrorMessage).toHaveBeenCalledWith("whatever"),expect(this.view._showErrorMessage).toHaveBeenCalledWith("ayo")})}),describe("_onIconDeleteComplete",function(){it("should decrease number of processes running and set `isProcessRunning` properly",function(){this.view._numOfDeletingProcesses=1,this.view._onIconDeleteComplete(),expect(this.view._numOfDeletingProcesses).toBe(0),expect(this.view.model.get("isProcessRunning")).toBe(!1)})}),describe("_showSpinner",function(){it("should toggle spinner and the plus sign if enabled",function(){spyOn(this.view,"_show"),spyOn(this.view,"_hide"),this.view._showSpinner(!0),expect(this.view._show).toHaveBeenCalledWith(".js-spinner"),expect(this.view._hide).toHaveBeenCalledWith(".js-plusSign")}),it("should toggle spinner and the plus sign if disabled",function(){spyOn(this.view,"_show"),spyOn(this.view,"_hide"),this.view._showSpinner(!1),expect(this.view._hide).toHaveBeenCalledWith(".js-spinner"),expect(this.view._show).toHaveBeenCalledWith(".js-plusSign")})}),describe("_showErrorMessage",function(){it("should set error message and show it",function(){var a="Something happened";spyOn(this.view,"_show"),this.view._showErrorMessage(a),expect(this.view.$(".js-errorMessage label").text()).toEqual(a),expect(this.view._show).toHaveBeenCalledWith(".js-errorMessage")})}),describe("_hideErrorMessage",function(){it("should hide error message",function(){spyOn(this.view,"_hide"),this.view._hideErrorMessage(),expect(this.view._hide).toHaveBeenCalledWith(".js-errorMessage")})}),describe("_resetSelection",function(){it("should deselect all icons and refresh action bar",function(){spyOn(this.view,"_refreshActions"),this.view._iconCollection.push(a(0).set("selected",!0)),this.view._iconCollection.push(a(1).set("selected",!0)),this.view._iconCollection.push(a(2)),this.view._resetSelection(),expect(this.view._iconCollection.where({selected:!0}).length).toBe(0),expect(this.view._refreshActions).toHaveBeenCalled()})}),describe("_addExtraIcon",function(){it("should add icon if more than max icons exist",function(){var b=a().set("visible",!0),c=a(),d=a();this.view._iconCollection.push(b),this.view._iconCollection.push(c),this.view._iconCollection.push(d),spyOn(this.view,"_addIconElement"),this.view._addExtraIcon(),expect(this.view._addIconElement).toHaveBeenCalledTimes(1),expect(this.view._addIconElement).toHaveBeenCalledWith(c)}),it("should not add icon if no more than max icons exist",function(){var b=a().set("visible",!0),c=a().set("visible",!0);this.view._iconCollection.push(b),this.view._iconCollection.push(c),spyOn(this.view,"_addIconElement"),this.view._addExtraIcon(),expect(this.view._addIconElement).not.toHaveBeenCalled()})}),describe("_hideActions",function(){it("should hide all actions",function(){spyOn(this.view,"_hide"),this.view._hideActions(),expect(this.view._hide).toHaveBeenCalledWith(".js-selectAllIcons, .js-deselectAllIcons, .js-deleteIcons, .js-iconsInfo")})}),describe("_onProcessRunningChanged",function(){it("should show spinner and running message if process is running",function(){this.view.model.set("isProcessRunning",!0),spyOn(this.view,"_showSpinner"),spyOn(this.view,"_hideActions"),spyOn(this.view,"_show"),this.view._onProcessRunningChanged(),expect(this.view._showSpinner).toHaveBeenCalledWith(!0),expect(this.view.$el.css("pointer-events")).toEqual("none"),expect(this.view._hideActions).toHaveBeenCalled(),expect(this.view.$(".js-runningInfo").text()).toEqual(this.view._runningMessage),expect(this.view._show).toHaveBeenCalledWith(".js-runningInfo")}),it("should hide spinner and running message if process is running",function(){var a=null;e.god.on("refreshCollection",function(b){b.cid&&(a=b.cid)}),this.view.model.set("isProcessRunning",!1),spyOn(this.view,"_showSpinner"),spyOn(this.view,"_refreshActions"),spyOn(this.view,"_hide"),this.view._onProcessRunningChanged(),expect(this.view._showSpinner).toHaveBeenCalledWith(!1),expect(this.view.$el.css("pointer-events")).toEqual("auto"),expect(this.view._refreshActions).toHaveBeenCalled(),expect(this.view.$(".js-runningInfo").text()).toEqual(""),expect(this.view._hide).toHaveBeenCalledWith(".js-runningInfo"),expect(a).toBe(this.view.cid)})}),describe("_uploadErrorMessage",function(){it("should display error detail if provided",function(){var a="404",b=this.view._uploadErrorMessage(a);expect(b).toEqual("Error uploading your image. [ 404 ]. Please try again.")}),it("should display standarn message if no error detail is provided",function(){var a=this.view._uploadErrorMessage();expect(a).toEqual("Error uploading your image. Please try again.")})}),describe("_deleteErrorMessage",function(){it("should display error detail if provided",function(){var a="404",b=this.view._deleteErrorMessage(a);expect(b).toEqual("Error deleting your image. [ 404 ]. Please try again.")}),it("should display standarn message if no error detail is provided",function(){var a=this.view._deleteErrorMessage();expect(a).toEqual("Error deleting your image. Please try again.")})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../../javascripts/cartodb/organization/icon_picker/icons/organization_icon_model":315,"../../../../../../javascripts/cartodb/organization/icon_picker/icons/organization_icons_view":317}],503:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../../javascripts/cartodb/organization/icon_picker/organization_icon_picker_view"),e=a("../../../../../javascripts/cartodb/organization/icon_picker/icons/organization_icon_model");describe("organization/icon_picker/organization_icon_picker_view",function(){function a(a){var b=new e;return b.set("index",a||1),b}var b="5p3c724-1ndv572135",f={status:200};beforeEach(function(){jasmine.Ajax.install(),jasmine.Ajax.stubRequest(new RegExp("^http(s)?.*/assets")).andReturn(f),this.view=new d({orgId:b})}),afterEach(function(){jasmine.Ajax.uninstall()}),describe(".initialize",function(){it("should initialize properly",function(){expect(this.view._maxIcons).toBe(23),expect(this.view.template).toBeDefined(),expect(this.view._orgId).toEqual(b),expect(this.view.model).toBeDefined(),expect(this.view.model.get("isProcessRunning")).toBe(!1),expect(this.view._iconCollection).toBeDefined(),expect(this.view._iconCollection._orgId).toEqual(b),expect(this.view._numOfUploadingProcesses).toBe(0),expect(this.view._numOfDeletingProcesses).toBe(0),expect(this.view._fetchErrorMessage).toEqual("Error fetching organization icons. Please refresh the page."),expect(this.view._runningMessage).toEqual(""),expect(this.view.$(".js-iconMainLabel").length).toBe(1);var a=jasmine.Ajax.requests.filter("/api/v1/organization/"+b+"/assets");expect(a.length).toBe(1),expect(this.view._iconCollection._callbacks["change:selected"]).toBeDefined(),expect(this.view.model._callbacks["change:isProcessRunning"]).toBeDefined()}),it("should fail if no user provided",function(){expect(function(){new d}).toThrowError("Organization ID is required.")})}),describe(".render",function(){it("should have rendered the right template",function(){var a=this.view.$(".FormAccount-rowLabel");expect(a.find(".js-iconMainLabel").length).toBe(1),expect(a.find(".js-viewAllIcons").length).toBe(1),expect(a.find(".js-iconsInfo").length).toBe(1),expect(a.find(".js-runningInfo").length).toBe(1),expect(a.find(".js-selectAllIcons").length).toBe(1),expect(a.find(".js-deselectAllIcons").length).toBe(1),expect(a.find(".js-deleteIcons").length).toBe(1);var b=this.view.$(".js-asset-icons");expect(b.find(".js-items").length).toBe(1),expect(b.find(".js-addIcon").length).toBe(1),expect(b.find(".js-plusSign").length).toBe(1),expect(b.find(".js-spinner").length).toBe(1),expect(this.view.$(".js-errorMessage").length).toBe(1),expect(this.view.$("input[type=file]").length).toBe(1)})}),describe(".initBinds",function(){it("should hook up ",function(){spyOn(this.view,"_refreshActions"),spyOn(this.view,"_onProcessRunningChanged"),this.view._initBinds(),this.view._iconCollection.trigger("change:selected"),
this.view.model.trigger("change:isProcessRunning"),expect(this.view._refreshActions).toHaveBeenCalled(),expect(this.view._onProcessRunningChanged).toHaveBeenCalled()})}),describe("._renderIcon",function(){it("if less than max icons then the icon gets rendered",function(){var b=a();expect(b.get("visible")).toBe(!1),this.view._renderIcon(b),expect(this.view.$(".js-items").children().length).toBe(2),expect(b.get("visible")).toBe(!0)}),it("if more than max icons then the icon gets not rendered",function(){var b=a(this.view._maxIcons+1);this.view._renderIcon(b),expect(this.view.$(".js-items").children().length).toBe(1)})}),describe("._addIconElement",function(){it("should set index, render icon and refresh actions",function(){var b=a(303);this.view._iconCollection.add(b),spyOn(this.view,"_renderIcon"),spyOn(this.view,"_refreshActions"),this.view._addIconElement(b),expect(b.get("index")).toBe(0),expect(this.view._renderIcon).toHaveBeenCalledWith(b),expect(this.view._refreshActions).toHaveBeenCalled()})}),describe("_refreshActions",function(){function b(a){return this.view.$(a).hasClass("is-hidden")}var c;beforeEach(function(){c=b.bind(this)}),it("should do nothing if some process is running",function(){spyOn(this.view,"_getNumberOfSelectedIcons"),this.view.model.set("isProcessRunning",!0),this.view._refreshActions(),expect(this.view._getNumberOfSelectedIcons).not.toHaveBeenCalled()}),it("should show only info if no icon is selected",function(){spyOn(this.view,"_getNumberOfSelectedIcons").and.returnValue(0),this.view._refreshActions(),expect(this.view.$(".js-iconMainLabel").text()).toEqual("Icons"),expect(c(".js-selectAllIcons")).toBe(!0),expect(c(".js-deselectAllIcons")).toBe(!0),expect(c(".js-deleteIcons")).toBe(!0),expect(c(".js-iconsInfo")).toBe(!1)}),it("should show `select all` and `delete icons` if some icons are selected",function(){spyOn(this.view,"_getNumberOfSelectedIcons").and.returnValue(2),this.view._iconCollection.push(a()),this.view._iconCollection.push(a()),this.view._iconCollection.push(a()),this.view._iconCollection.push(a()),this.view._refreshActions(),expect(this.view.$(".js-iconMainLabel").text()).toEqual("2 icons selected"),expect(c(".js-selectAllIcons")).toBe(!1),expect(c(".js-deselectAllIcons")).toBe(!0),expect(c(".js-deleteIcons")).toBe(!1),expect(c(".js-iconsInfo")).toBe(!0)}),it("should show `deselect all` and `delete icons` if all icons are selected",function(){spyOn(this.view,"_getNumberOfSelectedIcons").and.returnValue(3),this.view._iconCollection.push(a()),this.view._iconCollection.push(a()),this.view._iconCollection.push(a()),this.view._refreshActions(),expect(this.view.$(".js-iconMainLabel").text()).toEqual("3 icons selected"),expect(c(".js-selectAllIcons")).toBe(!0),expect(c(".js-deselectAllIcons")).toBe(!1),expect(c(".js-deleteIcons")).toBe(!1),expect(c(".js-iconsInfo")).toBe(!0),expect(c(".js-viewAllIcons")).toBe(!0)}),it("should show `View all icons` if there are more than max",function(){spyOn(this.view,"_getNumberOfSelectedIcons").and.returnValue(0);for(var b=0;b<this.view._maxIcons+1;b++)this.view._iconCollection.push(a());this.view._refreshActions(),expect(c(".js-viewAllIcons")).toBe(!1)})}),describe("_getIconIndex",function(){it("should return the index of the icon within the collection",function(){var b=a(),c=a();expect(this.view._getIconIndex(c)).not.toBe(1),this.view._iconCollection.push(b),this.view._iconCollection.push(c);var d=this.view._getIconIndex(c);expect(d).toBe(1)})}),describe("_addExtraIcon",function(){it("should add icon if more than max icons exist",function(){var b=a().set("visible",!0),c=a(),d=a();this.view._iconCollection.push(b),this.view._iconCollection.push(c),this.view._iconCollection.push(d),spyOn(this.view,"_addIconElement"),this.view._addExtraIcon(),expect(this.view._addIconElement).toHaveBeenCalledTimes(1),expect(this.view._addIconElement).toHaveBeenCalledWith(c)}),it("should not add icon if no more than max icons exist",function(){var b=a().set("visible",!0),c=a().set("visible",!0);this.view._iconCollection.push(b),this.view._iconCollection.push(c),spyOn(this.view,"_addIconElement"),this.view._addExtraIcon(),expect(this.view._addIconElement).not.toHaveBeenCalled()})}),describe("_onViewAllIconsClicked",function(){it("should open `all icons` dialog",function(){spyOn(this.view,"killEvent").and.callThrough(),spyOn(this.view,"_bindIconsPicker"),expect(this.view.icon_picker_dialog).not.toBeDefined(),this.view._onViewAllIconsClicked(),expect(this.view.icon_picker_dialog).toBeDefined(),expect(this.view.killEvent).toHaveBeenCalled(),expect(this.view._bindIconsPicker).toHaveBeenCalled()})}),describe("_hideActions",function(){it("should hide all actions",function(){spyOn(this.view,"_hide"),this.view._hideActions(),expect(this.view._hide).toHaveBeenCalledWith(".js-selectAllIcons, .js-deselectAllIcons, .js-deleteIcons, .js-iconsInfo, .js-viewAllIcons")})}),describe("_bindIconsPicker",function(){it("should bind IconsPicker",function(){spyOn(this.view,"_destroyPicker"),this.view._bindIconsPicker(),c.god.trigger("closeDialogs:icons"),expect(this.view._destroyPicker).toHaveBeenCalled()})}),describe("_unbindIconsPicker",function(){it("should unbind IconsPicker",function(){spyOn(this.view,"_destroyPicker"),this.view._bindIconsPicker(),c.god.trigger("closeDialogs:icons"),this.view._unbindIconsPicker(),c.god.trigger("closeDialogs:icons"),expect(this.view._destroyPicker).toHaveBeenCalledTimes(1)})}),describe("_destroyPicker",function(){it("should destroy IconsPicker",function(){spyOn(this.view,"_unbindIconsPicker"),spyOn(this.view,"removeView");var a=!1,b=!1,c=this.view.icon_picker_dialog={remove:function(){a=!0},hide:function(){b=!0}};expect(a).toBe(!1),expect(b).toBe(!1),expect(this.view.icon_picker_dialog).toBeDefined(),this.view._destroyPicker(),expect(this.view._unbindIconsPicker).toHaveBeenCalled(),expect(a).toBe(!0),expect(this.view.removeView).toHaveBeenCalledWith(c),expect(b).toBe(!0),expect(this.view.icon_picker_dialog).not.toBeDefined()})}),describe("._refreshCollection",function(){it("should be called when god triggers event and refresh if the caller is another view",function(){spyOn(this.view,"_refreshCollection").and.callThrough(),spyOn(this.view,"render"),spyOn(this.view,"_fetchAllIcons"),this.view._initBinds(),c.god.trigger("refreshCollection",{cid:this.view.cid+1}),expect(this.view._refreshCollection).toHaveBeenCalled(),expect(this.view.render).toHaveBeenCalled(),expect(this.view._fetchAllIcons).toHaveBeenCalled()}),it("should be called when god triggers event and not refresh if the caller is itself",function(){spyOn(this.view,"_refreshCollection").and.callThrough(),spyOn(this.view,"render"),spyOn(this.view,"_fetchAllIcons"),this.view._initBinds(),c.god.trigger("refreshCollection",{cid:this.view.cid}),expect(this.view._refreshCollection).toHaveBeenCalled(),expect(this.view.render).not.toHaveBeenCalled(),expect(this.view._fetchAllIcons).not.toHaveBeenCalled()})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/organization/icon_picker/icons/organization_icon_model":315,"../../../../../javascripts/cartodb/organization/icon_picker/organization_icon_picker_view":318}],504:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,d=a("../../../../javascripts/cartodb/organization/invite_users/invite_users_dialog_view");describe("organization/invite_users/invite_users_dialog_view",function(){beforeEach(function(){this.org=new c.admin.Organization({id:"pacoOrg"}),this.orgUsers=new c.admin.Organization.Users(null,{organization:this.org}),this.view=new d({organization:this.org,organizationUsers:this.orgUsers}),this.view.render()}),it("should render properly",function(){expect(this.view._panes).toBeDefined(),expect(this.view._panes.size()).toBe(3)}),describe("form view",function(){beforeEach(function(){this.formView=this.view._panes.getPane("form"),this.$form=this.view.$(".js-form")}),it("should render tag input and welcome textarea",function(){expect(this.$form.find(".js-tagsList").length).toBe(1),expect(this.$form.find(".js-welcomeText").length).toBe(1)}),it("should enable submit button when welcome_text and any email is added",function(){var a=this.$form.find(".js-submit");this.formView.model.set("users_emails",["paco@gmail.com"]),this.formView._onChange(),expect(a.hasClass("is-disabled")).toBeFalsy()}),it("should render enable signup message if org signup is disabled",function(){this.formView.model.set("enable_organization_signup",!0),expect(this.$form.find(".js-signInMessage").length).toBe(1)}),it("should set to true the model enable_organization_signup attribute",function(){var a=this.$form.find(".js-enableSignInButton");a.click(),expect(this.formView.model.get("enable_organization_signup")).toBe(!0)})}),describe("form view submission",function(){beforeEach(function(){this.formView=this.view._panes.getPane("form"),this.$form=this.view.$(".js-invitesForm"),spyOn(this.formView,"trigger").and.callThrough()}),it("should not submit the form if button is disabled",function(){expect(this.$form.find(".js-submit").hasClass("is-disabled")).toBeTruthy(),this.$form.submit(),expect(this.formView.trigger).not.toHaveBeenCalled()}),it("should send a trigger when form is submitted correctly",function(){this.formView.model.set("users_emails",["paco@gmail.com"]),this.$form.submit(),expect(this.formView.trigger).toHaveBeenCalled()})}),describe("on save",function(){it("should show loading state when model is being saved",function(){this.view.model.sync=function(){},this.view.model.set("users_emails",["paco@gmail.com"]),this.view._sendInvites(),expect(this.view._panes.activeTab).toBe("loading")}),it("should show close the dialog when model is properly saved",function(){this.view.model.sync=function(a,b,c){c.success()},spyOn(this.view,"close"),this.view._sendInvites(),expect(this.view.close).toHaveBeenCalled()}),it("should show error state when model saved has any problem",function(){this.view.model.sync=function(a,b,c){c.error()},this.view._sendInvites(),expect(this.view._panes.activeTab).toBe("error")})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/organization/invite_users/invite_users_dialog_view":319}],505:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,d=a("../../../../../javascripts/cartodb/organization/organization_notification/delete_notification_dialog_view");describe("organization/organization_notification/delete_notification_dialog_view",function(){beforeEach(function(){this.view=new d,spyOn(this.view,"submit"),spyOn(this.view,"_cancel"),this.view.undelegateEvents(),this.view.delegateEvents(),this.view.render()}),it("should render properly",function(){expect(this.view.$el.text()).toContain("You are about to remove a notification")}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()}),describe("when click OK",function(){beforeEach(function(){this.view.$(".js-ok").click()}),it("should show loading dialog, submit form, and close dialog",function(){expect(c(".Dialog").text()).toContain("Removing"),expect(this.view.submit).toHaveBeenCalled(),expect(this.view._cancel).toHaveBeenCalled()})}),describe("when click back",function(){beforeEach(function(){this.view.$(".js-cancel").click()}),it("should close this dialog",function(){expect(this.view._cancel).toHaveBeenCalled()})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/organization/organization_notification/delete_notification_dialog_view":321}],506:[function(a,b,c){(function(b){var c="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,d="undefined"!=typeof window?window._:"undefined"!=typeof b?b._:null,e=a("../../../../../javascripts/cartodb/organization/organization_notification/organization_notification_view");describe("organization/organization_notification/organization_notification_view",function(){beforeEach(function(){this.view=new e({el:["<div>","<form>",'<textarea id="carto_notification_body" name="carto_notification[body]" class="js-textarea">title</textarea>','<input type="radio" name="carto_notification[recipients]" value="all" checked="checked">','<input type="radio" name="carto_notification[recipients]" value="builders">',"</form>",'<div class="js-NotificationsList-item">','<div class="js-recipients" data-recipients="builders"></div>','<div class="js-html_body" data-body="**title** _title_ [title](http://title.com/)">','<strong>title</strong> <em>title</em> <a href="http://title.com/">title</a>',"</div>",'<button class="js-resend"></button>','<button class="js-remove"></button>',"</div>","</div>"].join("")}),this.view.render()}),it("should render properly",function(){expect(d.size(this.view._subviews)).toBe(1)}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()}),describe("._onClickRemove",function(){it("should render properly",function(){expect(this.view.remove_notification_dialog).not.toBeDefined(),this.view.$el.find(".js-remove").click(),expect(this.view.remove_notification_dialog).toBeDefined()}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()})}),describe("._onClickResend",function(){it("should check the type and copy the body",function(){spyOn(this.view.sendButton,"updateCounter"),expect(this.view.$el.find('input[name=carto_notification[recipients]][value="all"]').prop("checked")).toBe(!0),expect(this.view.$el.find('input[name=carto_notification[recipients]][value="builders"]').prop("checked")).toBe(!1),this.view.$(".js-resend").click(),expect(this.view.$el.find('input[name="carto_notification[recipients]"][value="all"]').prop("checked")).toBe(!1),expect(this.view.$el.find('input[name="carto_notification[recipients]"][value="builders"]').prop("checked")).toBe(!0),expect(this.view.$el.find("#carto_notification_body").val()).toBe("**title** _title_ [title](http://title.com/)"),expect(this.view.sendButton.updateCounter).toHaveBeenCalledWith(17)})}),describe("._updateCounter",function(){it("should update counter",function(){spyOn(this.view.sendButton,"updateCounter"),this.view.$el.find("#carto_notification_body").trigger("input"),expect(this.view.sendButton.updateCounter).toHaveBeenCalledWith(5)})}),describe("._onTextareaKeydown",function(){it("should submit update",function(){spyOn(this.view.sendButton,"onUpdate");var a=c.Event("keydown");a.keyCode=a.which=13,a.metaKey=!0,this.view.$el.find("#carto_notification_body").trigger(a),expect(this.view.sendButton.onUpdate).toHaveBeenCalled()})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/organization/organization_notification/organization_notification_view":322}],507:[function(a,b,c){var d=a("../../../../../javascripts/cartodb/organization/organization_notification/send_button_view");describe("organization/organization_notification/send_button_view",function(){beforeEach(function(){this.view=new d({$form:{}}),spyOn(this.view,"_submit"),this.view.render()}),it("should render properly",function(){expect(this.view.$el.find(".js-button").text()).toContain("Send")}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()}),describe(".onUpdate",function(){it("should show loader after click",function(){expect(this.view.model.get("status")).toBe("idle"),expect(this.view.$el.find(".js-button").text()).not.toContain("Sending"),this.view.updateCounter(1),this.view.$(".js-button").click(),expect(this.view.model.get("status")).toBe("loading"),expect(this.view.$el.find(".js-button").text()).toContain("Sending"),expect(this.view._submit).toHaveBeenCalled()})}),describe(".updateCounter",function(){it("should not be disabled if length > 0 and length < 140",function(){expect(this.view.$el.find(".js-button").hasClass("is-disabled")).toBe(!0),this.view.updateCounter(1),expect(this.view.$el.find(".js-button").hasClass("is-disabled")).toBe(!1),this.view.$(".js-button").click(),this.view.$(".js-button").click(),this.view.$(".js-button").click(),expect(this.view._submit).toHaveBeenCalledTimes(1)}),it("should be disabled if length == 0 or length > 140 or is loading",function(){expect(this.view.$el.find(".js-button").hasClass("is-disabled")).toBe(!0),this.view.updateCounter(0),expect(this.view.$el.find(".js-button").hasClass("is-disabled")).toBe(!0),this.view.$(".js-button").click(),expect(this.view._submit).not.toHaveBeenCalled(),this.view.updateCounter(141),expect(this.view.$el.find(".js-button").hasClass("is-disabled")).toBe(!0),this.view.$(".js-button").click(),expect(this.view._submit).not.toHaveBeenCalled()}),it("should update counter number",function(){expect(this.view.$el.find(".Md-counter").text()).toContain("140"),this.view.updateCounter(1),expect(this.view.$el.find(".Md-counter").text()).toContain("139")}),it("should update counter number color if is disabled",function(){expect(this.view.$el.find(".Md-counter").hasClass("Md-counter--negative")).toBe(!1),this.view.updateCounter(141),expect(this.view.$el.find(".Md-counter").hasClass("Md-counter--negative")).toBe(!0)})})})},{"../../../../../javascripts/cartodb/organization/organization_notification/send_button_view":323}],508:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null),d=a("../../../../javascripts/cartodb/organization/organization_user_quota");describe("organization/organization_user_quota",function(){beforeEach(function(){this.elHTML='<div class="OrganizationUser-quota js-userQuota"><input type="text" id="user_quota" value="104857600"></div>',this.model=new c.admin.User({quota_in_bytes:104857600,db_size_in_bytes:10485760,organization:{available_quota_for_user:811597824}}),spyOn(this.model,"bind").and.callThrough(),this.view=new d({el:this.elHTML,model:this.model}),this.view.render(),this.model.set("quota_in_bytes",157286400)}),it("should render properly",function(){expect(this.view.$el.hasClass("js-userQuota")).toBeTruthy()}),it("should bind model changes",function(){expect(this.model.bind.calls.argsFor(0)[0]).toEqual("change:quota_in_bytes")}),it("should render the new quota in bytes in the hidden input element",function(){expect(this.view.$el.find("#user_quota").val()).toEqual("157286400")}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/organization/organization_user_quota":324}],509:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null),d=a("../../../../javascripts/cartodb/organization/organization_user_quota_slider");describe("organization/organization_user_quota_slider",function(){beforeEach(function(){this.elHTML='<div class="js-userQuotaSlider"></div>',this.model=new c.admin.User({quota_in_bytes:104857600,db_size_in_bytes:10485760,organization:{available_quota_for_user:811597824}}),spyOn(this.model,"bind").and.callThrough(),this.view=new d({el:this.elHTML,model:this.model}),this.view.render()}),it("should render properly",function(){this.view.render(),expect(this.view.$el.hasClass("js-userQuotaSlider")).toBeTruthy()}),it("should bind model changes",function(){expect(this.model.bind.calls.argsFor(0)[0]).toEqual("change:quota_in_bytes")}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/organization/organization_user_quota_slider":325}],510:[function(a,b,c){(function(b){var c=("undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null,"undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null),d=a("../../../../javascripts/cartodb/organization/organization_user_quota_slider_input");describe("organization/organization_user_quota_slider_input",function(){beforeEach(function(){this.elHTML='<div class="js-userQuotaSliderInput"></div>',this.model=new c.admin.User({quota_in_bytes:104857600,db_size_in_bytes:10485760,organization:{available_quota_for_user:811597824}}),spyOn(this.model,"bind").and.callThrough(),this.view=new d({el:this.elHTML,model:this.model}),this.view.render()}),it("should render properly",function(){this.view.render(),expect(this.view.$el.hasClass("js-userQuotaSliderInput")).toBeTruthy()}),it("should bind model changes",function(){expect(this.model.bind.calls.argsFor(0)[0]).toEqual("change:quota_in_bytes")}),it("should not have leaks",function(){expect(this.view).toHaveNoLeaks()}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/organization/organization_user_quota_slider_input":326}],511:[function(a,b,c){(function(b){var c=a("../../../../javascripts/cartodb/public_dashboard/fav_map_view"),d="undefined"!=typeof window?window.cdb:"undefined"!=typeof b?b.cdb:null,e="undefined"!=typeof window?window.$:"undefined"!=typeof b?b.$:null;describe("public_dashboard/fav_map_view",function(){beforeEach(function(){spyOn(d,"createVis"),this.createdVisSpy=jasmine.createSpyObj("cartodb.js vis",["done"]),d.createVis.and.returnValue(this.createdVisSpy),this.targetId="fav-map-container",this.$target=e('<div id="'+this.targetId+'"></div>'),this.$target.appendTo(document.body),this.attrs={el:"#"+this.targetId},this.createFavMapView=function(){this.view=new c(this.attrs),this.view.render()}}),describe("given args to create map from a visualization",function(){beforeEach(function(){this.attrs.createVis={url:"//host.ext/some/path/vis.json",opts:{}}}),describe("and default opts",function(){beforeEach(function(){this.createFavMapView()}),it("should create a visualization",function(){expect(d.createVis).toHaveBeenCalled()}),it("should render vis in given target element identified by an id",function(){expect(d.createVis.calls.argsFor(0)[0]).toEqual(this.$target[0])}),it("should create vis with given URL",function(){expect(d.createVis.calls.argsFor(0)[1]).toEqual("//host.ext/some/path/vis.json")}),it("should create vis with a bunch of options",function(){expect(d.createVis.calls.argsFor(0)[2]).toEqual(jasmine.any(Object))}),it("should load tiles from CDN by default",function(){expect(d.createVis.calls.argsFor(0)[2]).toEqual(jasmine.objectContaining({no_cdn:!1}))}),it("should set .is-loading class on target element",function(){expect(this.$target.attr("class")).toContain("is-loading")}),describe("and loading finishes",function(){beforeEach(function(){this.createdVisSpy.done.calls.argsFor(0)[0]()}),it("should remove .is-loading class on target element",function(){expect(this.$target.attr("class")).not.toContain("is-loading")})})}),describe("and option to not load tiles from CDN",function(){beforeEach(function(){this.attrs.createVis.opts.no_cdn=!0,this.createFavMapView()}),it("should create vis with not loading tiles from CDN",function(){expect(d.createVis.calls.argsFor(0)[2]).toEqual(jasmine.objectContaining({no_cdn:!0}))})})}),describe("given there is no data to create map from an user visualization",function(){beforeEach(function(){this.attrs.fallbackBaselayer={url:"http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"},this.createFavMapView()}),it("should create a fallback map",function(){expect(d.createVis).toHaveBeenCalled()}),it("should create the fallback map with a given basemap template URL",function(){var a=d.createVis.calls.argsFor(0);expect(a[0]).toBe(this.view.el),expect(a[1].layers[0].urlTemplate).toEqual("http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"),expect(a[1].map_provider).toEqual("leaflet")})}),describe("given there is no data to create map from an user visualization with gmaps",function(){beforeEach(function(){this.attrs.fallbackBaselayer={},this.createFavMapView()}),it("should create a fallback map",function(){expect(d.createVis).toHaveBeenCalled()}),it("should create the fallback map with a gmaps basemap",function(){var a=d.createVis.calls.argsFor(0);expect(a[0]).toBe(this.view.el),expect(a[1].layers[0].type).toEqual("GMapsBase"),expect(a[1].map_provider).toEqual("googlemaps")})}),afterEach(function(){this.$target.remove()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/public_dashboard/fav_map_view":329}],512:[function(a,b,c){(function(b){var c=a("../../../../../javascripts/cartodb/public_common/user_settings/dropdown_view"),d="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null;describe("public_dashboard/user_settings/dropdown_view",function(){beforeEach(function(){this.user=new d.User({base_url:"http://pepe.carto.com",username:"Pepe",email:"pepe@paco.com"}),this.view=new c({model:this.user}),spyOn(this.view,"hide"),this.view.render()}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should have rendered a top block with user meta",function(){expect(this.innerHTML()).toContain(this.user.get("username")),expect(this.innerHTML()).toContain(this.user.get("email"))}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../../javascripts/cartodb/public_common/user_settings/dropdown_view":327}],513:[function(a,b,c){(function(b){var c=a("../../../../javascripts/cartodb/public_common/user_settings_view"),d="undefined"!=typeof window?window.cdb.admin:"undefined"!=typeof b?b.cdb.admin:null;describe("public_dashboard/user_settings_view",function(){beforeEach(function(){this.user=new d.User({base_url:"http://pepe.carto.com",username:"Pepe",email:"pepe@paco.com",avatar_url:"//path/to/img.png"}),this.view=new c({model:this.user}),this.view.render()}),it("should have no leaks",function(){expect(this.view).toHaveNoLeaks()}),it("should have rendered avatar url",function(){expect(this.innerHTML()).toContain('<img src="'+this.user.get("avatar_url")+'"')}),describe("when click .js-dropdown-target",function(){beforeEach(function(){this.view.$(".js-dropdown-target").click()}),it("should open a dropdown",function(){expect(document.body.innerHTML).toContain("Close session")})}),afterEach(function(){this.view.clean()})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../../javascripts/cartodb/public_common/user_settings_view":328}],514:[function(a,b,c){window.location.search.indexOf("disablesourcemaps")===-1&&a("source-map-support").install()},{"source-map-support":567}],515:[function(a,b,c){(function(c,d){"use strict";function e(b,e){function f(a){var b,c;for(b=0;a[b];b+=1)if(c=a[b],"."===c)a.splice(b,1),b-=1;else if(".."===c){if(1===b&&(".."===a[2]||".."===a[0]))break;b>0&&(a.splice(b-1,2),b-=2)}}function g(a,b){var c;return a&&"."===a.charAt(0)&&b&&(c=b.split("/"),c=c.slice(0,c.length-1),c=c.concat(a.split("/")),f(c),a=c.join("/")),a}function h(a){return function(b){return g(b,a)}}function i(a){function b(b){o[a]=b}return b.fromText=function(a,b){throw new Error("amdefine does not implement load.fromText")},b}function j(a,c,f){var g,h,i,j;if(a)h=o[a]={},i={id:a,uri:d,exports:h},g=l(e,h,i,a);else{if(p)throw new Error("amdefine with no module ID cannot be called more than once per file.");p=!0,h=b.exports,i=b,g=l(e,h,i,b.id)}c&&(c=c.map(function(a){return g(a)})),j="function"==typeof f?f.apply(i.exports,c):f,void 0!==j&&(i.exports=j,a&&(o[a]=i.exports))}function k(a,b,c){Array.isArray(a)?(c=b,b=a,a=void 0):"string"!=typeof a&&(c=a,a=b=void 0),b&&!Array.isArray(b)&&(c=b,b=void 0),b||(b=["require","exports","module"]),a?n[a]=[a,b,c]:j(a,b,c)}var l,m,n={},o={},p=!1,q=a("path");return l=function(a,b,d,e){function f(f,g){return"string"==typeof f?m(a,b,d,f,e):(f=f.map(function(c){return m(a,b,d,c,e)}),void(g&&c.nextTick(function(){g.apply(null,f)})))}return f.toUrl=function(a){return 0===a.indexOf(".")?g(a,q.dirname(d.filename)):a},f},e=e||function(){return b.require.apply(b,arguments)},m=function(a,b,c,d,e){var f,k,p=d.indexOf("!"),q=d;if(p===-1){if(d=g(d,e),"require"===d)return l(a,b,c,e);if("exports"===d)return b;if("module"===d)return c;if(o.hasOwnProperty(d))return o[d];if(n[d])return j.apply(null,n[d]),o[d];if(a)return a(q);throw new Error("No module with ID: "+d)}return f=d.substring(0,p),d=d.substring(p+1,d.length),k=m(a,b,c,f,e),d=k.normalize?k.normalize(d,h(e)):g(d,e),o[d]?o[d]:(k.load(d,l(a,b,c,e),i(d),{}),o[d])},k.require=function(a){return o[a]?o[a]:n[a]?(j.apply(null,n[a]),o[a]):void 0},k.amd={},k}b.exports=e}).call(this,a("_process"),"/node_modules/amdefine/amdefine.js")},{_process:556,path:532}],516:[function(a,b,c){"use strict";function d(a){var b=a.length;if(b%4>0)throw new Error("Invalid string. Length must be a multiple of 4");return"="===a[b-2]?2:"="===a[b-1]?1:0}function e(a){return 3*a.length/4-d(a)}function f(a){var b,c,e,f,g,h,i=a.length;g=d(a),h=new l(3*i/4-g),e=g>0?i-4:i;var j=0;for(b=0,c=0;b<e;b+=4,c+=3)f=k[a.charCodeAt(b)]<<18|k[a.charCodeAt(b+1)]<<12|k[a.charCodeAt(b+2)]<<6|k[a.charCodeAt(b+3)],h[j++]=f>>16&255,h[j++]=f>>8&255,h[j++]=255&f;return 2===g?(f=k[a.charCodeAt(b)]<<2|k[a.charCodeAt(b+1)]>>4,h[j++]=255&f):1===g&&(f=k[a.charCodeAt(b)]<<10|k[a.charCodeAt(b+1)]<<4|k[a.charCodeAt(b+2)]>>2,h[j++]=f>>8&255,h[j++]=255&f),h}function g(a){return j[a>>18&63]+j[a>>12&63]+j[a>>6&63]+j[63&a]}function h(a,b,c){for(var d,e=[],f=b;f<c;f+=3)d=(a[f]<<16)+(a[f+1]<<8)+a[f+2],e.push(g(d));return e.join("")}function i(a){for(var b,c=a.length,d=c%3,e="",f=[],g=16383,i=0,k=c-d;i<k;i+=g)f.push(h(a,i,i+g>k?k:i+g));return 1===d?(b=a[c-1],e+=j[b>>2],e+=j[b<<4&63],e+="=="):2===d&&(b=(a[c-2]<<8)+a[c-1],e+=j[b>>10],e+=j[b>>4&63],e+=j[b<<2&63],e+="="),f.push(e),f.join("")}c.byteLength=e,c.toByteArray=f,c.fromByteArray=i;for(var j=[],k=[],l="undefined"!=typeof Uint8Array?Uint8Array:Array,m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=0,o=m.length;n<o;++n)j[n]=m[n],k[m.charCodeAt(n)]=n;k["-".charCodeAt(0)]=62,k["_".charCodeAt(0)]=63},{}],517:[function(a,b,c){},{}],518:[function(a,b,c){(function(b){"use strict";function d(){try{var a=new Uint8Array(1);return a.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===a.foo()&&"function"==typeof a.subarray&&0===a.subarray(1,1).byteLength}catch(a){return!1}}function e(){return g.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function f(a,b){if(e()<b)throw new RangeError("Invalid typed array length");return g.TYPED_ARRAY_SUPPORT?(a=new Uint8Array(b),a.__proto__=g.prototype):(null===a&&(a=new g(b)),a.length=b),a}function g(a,b,c){if(!(g.TYPED_ARRAY_SUPPORT||this instanceof g))return new g(a,b,c);if("number"==typeof a){if("string"==typeof b)throw new Error("If encoding is specified then the first argument must be a string");return k(this,a)}return h(this,a,b,c)}function h(a,b,c,d){if("number"==typeof b)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&b instanceof ArrayBuffer?n(a,b,c,d):"string"==typeof b?l(a,b,c):o(a,b)}function i(a){if("number"!=typeof a)throw new TypeError('"size" argument must be a number');if(a<0)throw new RangeError('"size" argument must not be negative')}function j(a,b,c,d){return i(b),b<=0?f(a,b):void 0!==c?"string"==typeof d?f(a,b).fill(c,d):f(a,b).fill(c):f(a,b);
}function k(a,b){if(i(b),a=f(a,b<0?0:0|p(b)),!g.TYPED_ARRAY_SUPPORT)for(var c=0;c<b;++c)a[c]=0;return a}function l(a,b,c){if("string"==typeof c&&""!==c||(c="utf8"),!g.isEncoding(c))throw new TypeError('"encoding" must be a valid string encoding');var d=0|r(b,c);a=f(a,d);var e=a.write(b,c);return e!==d&&(a=a.slice(0,e)),a}function m(a,b){var c=b.length<0?0:0|p(b.length);a=f(a,c);for(var d=0;d<c;d+=1)a[d]=255&b[d];return a}function n(a,b,c,d){if(b.byteLength,c<0||b.byteLength<c)throw new RangeError("'offset' is out of bounds");if(b.byteLength<c+(d||0))throw new RangeError("'length' is out of bounds");return b=void 0===c&&void 0===d?new Uint8Array(b):void 0===d?new Uint8Array(b,c):new Uint8Array(b,c,d),g.TYPED_ARRAY_SUPPORT?(a=b,a.__proto__=g.prototype):a=m(a,b),a}function o(a,b){if(g.isBuffer(b)){var c=0|p(b.length);return a=f(a,c),0===a.length?a:(b.copy(a,0,0,c),a)}if(b){if("undefined"!=typeof ArrayBuffer&&b.buffer instanceof ArrayBuffer||"length"in b)return"number"!=typeof b.length||Y(b.length)?f(a,0):m(a,b);if("Buffer"===b.type&&_(b.data))return m(a,b.data)}throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}function p(a){if(a>=e())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+e().toString(16)+" bytes");return 0|a}function q(a){return+a!=a&&(a=0),g.alloc(+a)}function r(a,b){if(g.isBuffer(a))return a.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(a)||a instanceof ArrayBuffer))return a.byteLength;"string"!=typeof a&&(a=""+a);var c=a.length;if(0===c)return 0;for(var d=!1;;)switch(b){case"ascii":case"latin1":case"binary":return c;case"utf8":case"utf-8":case void 0:return T(a).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*c;case"hex":return c>>>1;case"base64":return W(a).length;default:if(d)return T(a).length;b=(""+b).toLowerCase(),d=!0}}function s(a,b,c){var d=!1;if((void 0===b||b<0)&&(b=0),b>this.length)return"";if((void 0===c||c>this.length)&&(c=this.length),c<=0)return"";if(c>>>=0,b>>>=0,c<=b)return"";for(a||(a="utf8");;)switch(a){case"hex":return H(this,b,c);case"utf8":case"utf-8":return D(this,b,c);case"ascii":return F(this,b,c);case"latin1":case"binary":return G(this,b,c);case"base64":return C(this,b,c);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return I(this,b,c);default:if(d)throw new TypeError("Unknown encoding: "+a);a=(a+"").toLowerCase(),d=!0}}function t(a,b,c){var d=a[b];a[b]=a[c],a[c]=d}function u(a,b,c,d,e){if(0===a.length)return-1;if("string"==typeof c?(d=c,c=0):c>2147483647?c=2147483647:c<-2147483648&&(c=-2147483648),c=+c,isNaN(c)&&(c=e?0:a.length-1),c<0&&(c=a.length+c),c>=a.length){if(e)return-1;c=a.length-1}else if(c<0){if(!e)return-1;c=0}if("string"==typeof b&&(b=g.from(b,d)),g.isBuffer(b))return 0===b.length?-1:v(a,b,c,d,e);if("number"==typeof b)return b&=255,g.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?e?Uint8Array.prototype.indexOf.call(a,b,c):Uint8Array.prototype.lastIndexOf.call(a,b,c):v(a,[b],c,d,e);throw new TypeError("val must be string, number or Buffer")}function v(a,b,c,d,e){function f(a,b){return 1===g?a[b]:a.readUInt16BE(b*g)}var g=1,h=a.length,i=b.length;if(void 0!==d&&(d=String(d).toLowerCase(),"ucs2"===d||"ucs-2"===d||"utf16le"===d||"utf-16le"===d)){if(a.length<2||b.length<2)return-1;g=2,h/=2,i/=2,c/=2}var j;if(e){var k=-1;for(j=c;j<h;j++)if(f(a,j)===f(b,k===-1?0:j-k)){if(k===-1&&(k=j),j-k+1===i)return k*g}else k!==-1&&(j-=j-k),k=-1}else for(c+i>h&&(c=h-i),j=c;j>=0;j--){for(var l=!0,m=0;m<i;m++)if(f(a,j+m)!==f(b,m)){l=!1;break}if(l)return j}return-1}function w(a,b,c,d){c=Number(c)||0;var e=a.length-c;d?(d=Number(d),d>e&&(d=e)):d=e;var f=b.length;if(f%2!==0)throw new TypeError("Invalid hex string");d>f/2&&(d=f/2);for(var g=0;g<d;++g){var h=parseInt(b.substr(2*g,2),16);if(isNaN(h))return g;a[c+g]=h}return g}function x(a,b,c,d){return X(T(b,a.length-c),a,c,d)}function y(a,b,c,d){return X(U(b),a,c,d)}function z(a,b,c,d){return y(a,b,c,d)}function A(a,b,c,d){return X(W(b),a,c,d)}function B(a,b,c,d){return X(V(b,a.length-c),a,c,d)}function C(a,b,c){return 0===b&&c===a.length?Z.fromByteArray(a):Z.fromByteArray(a.slice(b,c))}function D(a,b,c){c=Math.min(a.length,c);for(var d=[],e=b;e<c;){var f=a[e],g=null,h=f>239?4:f>223?3:f>191?2:1;if(e+h<=c){var i,j,k,l;switch(h){case 1:f<128&&(g=f);break;case 2:i=a[e+1],128===(192&i)&&(l=(31&f)<<6|63&i,l>127&&(g=l));break;case 3:i=a[e+1],j=a[e+2],128===(192&i)&&128===(192&j)&&(l=(15&f)<<12|(63&i)<<6|63&j,l>2047&&(l<55296||l>57343)&&(g=l));break;case 4:i=a[e+1],j=a[e+2],k=a[e+3],128===(192&i)&&128===(192&j)&&128===(192&k)&&(l=(15&f)<<18|(63&i)<<12|(63&j)<<6|63&k,l>65535&&l<1114112&&(g=l))}}null===g?(g=65533,h=1):g>65535&&(g-=65536,d.push(g>>>10&1023|55296),g=56320|1023&g),d.push(g),e+=h}return E(d)}function E(a){var b=a.length;if(b<=aa)return String.fromCharCode.apply(String,a);for(var c="",d=0;d<b;)c+=String.fromCharCode.apply(String,a.slice(d,d+=aa));return c}function F(a,b,c){var d="";c=Math.min(a.length,c);for(var e=b;e<c;++e)d+=String.fromCharCode(127&a[e]);return d}function G(a,b,c){var d="";c=Math.min(a.length,c);for(var e=b;e<c;++e)d+=String.fromCharCode(a[e]);return d}function H(a,b,c){var d=a.length;(!b||b<0)&&(b=0),(!c||c<0||c>d)&&(c=d);for(var e="",f=b;f<c;++f)e+=S(a[f]);return e}function I(a,b,c){for(var d=a.slice(b,c),e="",f=0;f<d.length;f+=2)e+=String.fromCharCode(d[f]+256*d[f+1]);return e}function J(a,b,c){if(a%1!==0||a<0)throw new RangeError("offset is not uint");if(a+b>c)throw new RangeError("Trying to access beyond buffer length")}function K(a,b,c,d,e,f){if(!g.isBuffer(a))throw new TypeError('"buffer" argument must be a Buffer instance');if(b>e||b<f)throw new RangeError('"value" argument is out of bounds');if(c+d>a.length)throw new RangeError("Index out of range")}function L(a,b,c,d){b<0&&(b=65535+b+1);for(var e=0,f=Math.min(a.length-c,2);e<f;++e)a[c+e]=(b&255<<8*(d?e:1-e))>>>8*(d?e:1-e)}function M(a,b,c,d){b<0&&(b=4294967295+b+1);for(var e=0,f=Math.min(a.length-c,4);e<f;++e)a[c+e]=b>>>8*(d?e:3-e)&255}function N(a,b,c,d,e,f){if(c+d>a.length)throw new RangeError("Index out of range");if(c<0)throw new RangeError("Index out of range")}function O(a,b,c,d,e){return e||N(a,b,c,4,3.4028234663852886e38,-3.4028234663852886e38),$.write(a,b,c,d,23,4),c+4}function P(a,b,c,d,e){return e||N(a,b,c,8,1.7976931348623157e308,-1.7976931348623157e308),$.write(a,b,c,d,52,8),c+8}function Q(a){if(a=R(a).replace(ba,""),a.length<2)return"";for(;a.length%4!==0;)a+="=";return a}function R(a){return a.trim?a.trim():a.replace(/^\s+|\s+$/g,"")}function S(a){return a<16?"0"+a.toString(16):a.toString(16)}function T(a,b){b=b||1/0;for(var c,d=a.length,e=null,f=[],g=0;g<d;++g){if(c=a.charCodeAt(g),c>55295&&c<57344){if(!e){if(c>56319){(b-=3)>-1&&f.push(239,191,189);continue}if(g+1===d){(b-=3)>-1&&f.push(239,191,189);continue}e=c;continue}if(c<56320){(b-=3)>-1&&f.push(239,191,189),e=c;continue}c=(e-55296<<10|c-56320)+65536}else e&&(b-=3)>-1&&f.push(239,191,189);if(e=null,c<128){if((b-=1)<0)break;f.push(c)}else if(c<2048){if((b-=2)<0)break;f.push(c>>6|192,63&c|128)}else if(c<65536){if((b-=3)<0)break;f.push(c>>12|224,c>>6&63|128,63&c|128)}else{if(!(c<1114112))throw new Error("Invalid code point");if((b-=4)<0)break;f.push(c>>18|240,c>>12&63|128,c>>6&63|128,63&c|128)}}return f}function U(a){for(var b=[],c=0;c<a.length;++c)b.push(255&a.charCodeAt(c));return b}function V(a,b){for(var c,d,e,f=[],g=0;g<a.length&&!((b-=2)<0);++g)c=a.charCodeAt(g),d=c>>8,e=c%256,f.push(e),f.push(d);return f}function W(a){return Z.toByteArray(Q(a))}function X(a,b,c,d){for(var e=0;e<d&&!(e+c>=b.length||e>=a.length);++e)b[e+c]=a[e];return e}function Y(a){return a!==a}var Z=a("base64-js"),$=a("ieee754"),_=a("isarray");c.Buffer=g,c.SlowBuffer=q,c.INSPECT_MAX_BYTES=50,g.TYPED_ARRAY_SUPPORT=void 0!==b.TYPED_ARRAY_SUPPORT?b.TYPED_ARRAY_SUPPORT:d(),c.kMaxLength=e(),g.poolSize=8192,g._augment=function(a){return a.__proto__=g.prototype,a},g.from=function(a,b,c){return h(null,a,b,c)},g.TYPED_ARRAY_SUPPORT&&(g.prototype.__proto__=Uint8Array.prototype,g.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&g[Symbol.species]===g&&Object.defineProperty(g,Symbol.species,{value:null,configurable:!0})),g.alloc=function(a,b,c){return j(null,a,b,c)},g.allocUnsafe=function(a){return k(null,a)},g.allocUnsafeSlow=function(a){return k(null,a)},g.isBuffer=function(a){return!(null==a||!a._isBuffer)},g.compare=function(a,b){if(!g.isBuffer(a)||!g.isBuffer(b))throw new TypeError("Arguments must be Buffers");if(a===b)return 0;for(var c=a.length,d=b.length,e=0,f=Math.min(c,d);e<f;++e)if(a[e]!==b[e]){c=a[e],d=b[e];break}return c<d?-1:d<c?1:0},g.isEncoding=function(a){switch(String(a).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},g.concat=function(a,b){if(!_(a))throw new TypeError('"list" argument must be an Array of Buffers');if(0===a.length)return g.alloc(0);var c;if(void 0===b)for(b=0,c=0;c<a.length;++c)b+=a[c].length;var d=g.allocUnsafe(b),e=0;for(c=0;c<a.length;++c){var f=a[c];if(!g.isBuffer(f))throw new TypeError('"list" argument must be an Array of Buffers');f.copy(d,e),e+=f.length}return d},g.byteLength=r,g.prototype._isBuffer=!0,g.prototype.swap16=function(){var a=this.length;if(a%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var b=0;b<a;b+=2)t(this,b,b+1);return this},g.prototype.swap32=function(){var a=this.length;if(a%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var b=0;b<a;b+=4)t(this,b,b+3),t(this,b+1,b+2);return this},g.prototype.swap64=function(){var a=this.length;if(a%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var b=0;b<a;b+=8)t(this,b,b+7),t(this,b+1,b+6),t(this,b+2,b+5),t(this,b+3,b+4);return this},g.prototype.toString=function(){var a=0|this.length;return 0===a?"":0===arguments.length?D(this,0,a):s.apply(this,arguments)},g.prototype.equals=function(a){if(!g.isBuffer(a))throw new TypeError("Argument must be a Buffer");return this===a||0===g.compare(this,a)},g.prototype.inspect=function(){var a="",b=c.INSPECT_MAX_BYTES;return this.length>0&&(a=this.toString("hex",0,b).match(/.{2}/g).join(" "),this.length>b&&(a+=" ... ")),"<Buffer "+a+">"},g.prototype.compare=function(a,b,c,d,e){if(!g.isBuffer(a))throw new TypeError("Argument must be a Buffer");if(void 0===b&&(b=0),void 0===c&&(c=a?a.length:0),void 0===d&&(d=0),void 0===e&&(e=this.length),b<0||c>a.length||d<0||e>this.length)throw new RangeError("out of range index");if(d>=e&&b>=c)return 0;if(d>=e)return-1;if(b>=c)return 1;if(b>>>=0,c>>>=0,d>>>=0,e>>>=0,this===a)return 0;for(var f=e-d,h=c-b,i=Math.min(f,h),j=this.slice(d,e),k=a.slice(b,c),l=0;l<i;++l)if(j[l]!==k[l]){f=j[l],h=k[l];break}return f<h?-1:h<f?1:0},g.prototype.includes=function(a,b,c){return this.indexOf(a,b,c)!==-1},g.prototype.indexOf=function(a,b,c){return u(this,a,b,c,!0)},g.prototype.lastIndexOf=function(a,b,c){return u(this,a,b,c,!1)},g.prototype.write=function(a,b,c,d){if(void 0===b)d="utf8",c=this.length,b=0;else if(void 0===c&&"string"==typeof b)d=b,c=this.length,b=0;else{if(!isFinite(b))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");b|=0,isFinite(c)?(c|=0,void 0===d&&(d="utf8")):(d=c,c=void 0)}var e=this.length-b;if((void 0===c||c>e)&&(c=e),a.length>0&&(c<0||b<0)||b>this.length)throw new RangeError("Attempt to write outside buffer bounds");d||(d="utf8");for(var f=!1;;)switch(d){case"hex":return w(this,a,b,c);case"utf8":case"utf-8":return x(this,a,b,c);case"ascii":return y(this,a,b,c);case"latin1":case"binary":return z(this,a,b,c);case"base64":return A(this,a,b,c);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return B(this,a,b,c);default:if(f)throw new TypeError("Unknown encoding: "+d);d=(""+d).toLowerCase(),f=!0}},g.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var aa=4096;g.prototype.slice=function(a,b){var c=this.length;a=~~a,b=void 0===b?c:~~b,a<0?(a+=c,a<0&&(a=0)):a>c&&(a=c),b<0?(b+=c,b<0&&(b=0)):b>c&&(b=c),b<a&&(b=a);var d;if(g.TYPED_ARRAY_SUPPORT)d=this.subarray(a,b),d.__proto__=g.prototype;else{var e=b-a;d=new g(e,void 0);for(var f=0;f<e;++f)d[f]=this[f+a]}return d},g.prototype.readUIntLE=function(a,b,c){a|=0,b|=0,c||J(a,b,this.length);for(var d=this[a],e=1,f=0;++f<b&&(e*=256);)d+=this[a+f]*e;return d},g.prototype.readUIntBE=function(a,b,c){a|=0,b|=0,c||J(a,b,this.length);for(var d=this[a+--b],e=1;b>0&&(e*=256);)d+=this[a+--b]*e;return d},g.prototype.readUInt8=function(a,b){return b||J(a,1,this.length),this[a]},g.prototype.readUInt16LE=function(a,b){return b||J(a,2,this.length),this[a]|this[a+1]<<8},g.prototype.readUInt16BE=function(a,b){return b||J(a,2,this.length),this[a]<<8|this[a+1]},g.prototype.readUInt32LE=function(a,b){return b||J(a,4,this.length),(this[a]|this[a+1]<<8|this[a+2]<<16)+16777216*this[a+3]},g.prototype.readUInt32BE=function(a,b){return b||J(a,4,this.length),16777216*this[a]+(this[a+1]<<16|this[a+2]<<8|this[a+3])},g.prototype.readIntLE=function(a,b,c){a|=0,b|=0,c||J(a,b,this.length);for(var d=this[a],e=1,f=0;++f<b&&(e*=256);)d+=this[a+f]*e;return e*=128,d>=e&&(d-=Math.pow(2,8*b)),d},g.prototype.readIntBE=function(a,b,c){a|=0,b|=0,c||J(a,b,this.length);for(var d=b,e=1,f=this[a+--d];d>0&&(e*=256);)f+=this[a+--d]*e;return e*=128,f>=e&&(f-=Math.pow(2,8*b)),f},g.prototype.readInt8=function(a,b){return b||J(a,1,this.length),128&this[a]?(255-this[a]+1)*-1:this[a]},g.prototype.readInt16LE=function(a,b){b||J(a,2,this.length);var c=this[a]|this[a+1]<<8;return 32768&c?4294901760|c:c},g.prototype.readInt16BE=function(a,b){b||J(a,2,this.length);var c=this[a+1]|this[a]<<8;return 32768&c?4294901760|c:c},g.prototype.readInt32LE=function(a,b){return b||J(a,4,this.length),this[a]|this[a+1]<<8|this[a+2]<<16|this[a+3]<<24},g.prototype.readInt32BE=function(a,b){return b||J(a,4,this.length),this[a]<<24|this[a+1]<<16|this[a+2]<<8|this[a+3]},g.prototype.readFloatLE=function(a,b){return b||J(a,4,this.length),$.read(this,a,!0,23,4)},g.prototype.readFloatBE=function(a,b){return b||J(a,4,this.length),$.read(this,a,!1,23,4)},g.prototype.readDoubleLE=function(a,b){return b||J(a,8,this.length),$.read(this,a,!0,52,8)},g.prototype.readDoubleBE=function(a,b){return b||J(a,8,this.length),$.read(this,a,!1,52,8)},g.prototype.writeUIntLE=function(a,b,c,d){if(a=+a,b|=0,c|=0,!d){var e=Math.pow(2,8*c)-1;K(this,a,b,c,e,0)}var f=1,g=0;for(this[b]=255&a;++g<c&&(f*=256);)this[b+g]=a/f&255;return b+c},g.prototype.writeUIntBE=function(a,b,c,d){if(a=+a,b|=0,c|=0,!d){var e=Math.pow(2,8*c)-1;K(this,a,b,c,e,0)}var f=c-1,g=1;for(this[b+f]=255&a;--f>=0&&(g*=256);)this[b+f]=a/g&255;return b+c},g.prototype.writeUInt8=function(a,b,c){return a=+a,b|=0,c||K(this,a,b,1,255,0),g.TYPED_ARRAY_SUPPORT||(a=Math.floor(a)),this[b]=255&a,b+1},g.prototype.writeUInt16LE=function(a,b,c){return a=+a,b|=0,c||K(this,a,b,2,65535,0),g.TYPED_ARRAY_SUPPORT?(this[b]=255&a,this[b+1]=a>>>8):L(this,a,b,!0),b+2},g.prototype.writeUInt16BE=function(a,b,c){return a=+a,b|=0,c||K(this,a,b,2,65535,0),g.TYPED_ARRAY_SUPPORT?(this[b]=a>>>8,this[b+1]=255&a):L(this,a,b,!1),b+2},g.prototype.writeUInt32LE=function(a,b,c){return a=+a,b|=0,c||K(this,a,b,4,4294967295,0),g.TYPED_ARRAY_SUPPORT?(this[b+3]=a>>>24,this[b+2]=a>>>16,this[b+1]=a>>>8,this[b]=255&a):M(this,a,b,!0),b+4},g.prototype.writeUInt32BE=function(a,b,c){return a=+a,b|=0,c||K(this,a,b,4,4294967295,0),g.TYPED_ARRAY_SUPPORT?(this[b]=a>>>24,this[b+1]=a>>>16,this[b+2]=a>>>8,this[b+3]=255&a):M(this,a,b,!1),b+4},g.prototype.writeIntLE=function(a,b,c,d){if(a=+a,b|=0,!d){var e=Math.pow(2,8*c-1);K(this,a,b,c,e-1,-e)}var f=0,g=1,h=0;for(this[b]=255&a;++f<c&&(g*=256);)a<0&&0===h&&0!==this[b+f-1]&&(h=1),this[b+f]=(a/g>>0)-h&255;return b+c},g.prototype.writeIntBE=function(a,b,c,d){if(a=+a,b|=0,!d){var e=Math.pow(2,8*c-1);K(this,a,b,c,e-1,-e)}var f=c-1,g=1,h=0;for(this[b+f]=255&a;--f>=0&&(g*=256);)a<0&&0===h&&0!==this[b+f+1]&&(h=1),this[b+f]=(a/g>>0)-h&255;return b+c},g.prototype.writeInt8=function(a,b,c){return a=+a,b|=0,c||K(this,a,b,1,127,-128),g.TYPED_ARRAY_SUPPORT||(a=Math.floor(a)),a<0&&(a=255+a+1),this[b]=255&a,b+1},g.prototype.writeInt16LE=function(a,b,c){return a=+a,b|=0,c||K(this,a,b,2,32767,-32768),g.TYPED_ARRAY_SUPPORT?(this[b]=255&a,this[b+1]=a>>>8):L(this,a,b,!0),b+2},g.prototype.writeInt16BE=function(a,b,c){return a=+a,b|=0,c||K(this,a,b,2,32767,-32768),g.TYPED_ARRAY_SUPPORT?(this[b]=a>>>8,this[b+1]=255&a):L(this,a,b,!1),b+2},g.prototype.writeInt32LE=function(a,b,c){return a=+a,b|=0,c||K(this,a,b,4,2147483647,-2147483648),g.TYPED_ARRAY_SUPPORT?(this[b]=255&a,this[b+1]=a>>>8,this[b+2]=a>>>16,this[b+3]=a>>>24):M(this,a,b,!0),b+4},g.prototype.writeInt32BE=function(a,b,c){return a=+a,b|=0,c||K(this,a,b,4,2147483647,-2147483648),a<0&&(a=4294967295+a+1),g.TYPED_ARRAY_SUPPORT?(this[b]=a>>>24,this[b+1]=a>>>16,this[b+2]=a>>>8,this[b+3]=255&a):M(this,a,b,!1),b+4},g.prototype.writeFloatLE=function(a,b,c){return O(this,a,b,!0,c)},g.prototype.writeFloatBE=function(a,b,c){return O(this,a,b,!1,c)},g.prototype.writeDoubleLE=function(a,b,c){return P(this,a,b,!0,c)},g.prototype.writeDoubleBE=function(a,b,c){return P(this,a,b,!1,c)},g.prototype.copy=function(a,b,c,d){if(c||(c=0),d||0===d||(d=this.length),b>=a.length&&(b=a.length),b||(b=0),d>0&&d<c&&(d=c),d===c)return 0;if(0===a.length||0===this.length)return 0;if(b<0)throw new RangeError("targetStart out of bounds");if(c<0||c>=this.length)throw new RangeError("sourceStart out of bounds");if(d<0)throw new RangeError("sourceEnd out of bounds");d>this.length&&(d=this.length),a.length-b<d-c&&(d=a.length-b+c);var e,f=d-c;if(this===a&&c<b&&b<d)for(e=f-1;e>=0;--e)a[e+b]=this[e+c];else if(f<1e3||!g.TYPED_ARRAY_SUPPORT)for(e=0;e<f;++e)a[e+b]=this[e+c];else Uint8Array.prototype.set.call(a,this.subarray(c,c+f),b);return f},g.prototype.fill=function(a,b,c,d){if("string"==typeof a){if("string"==typeof b?(d=b,b=0,c=this.length):"string"==typeof c&&(d=c,c=this.length),1===a.length){var e=a.charCodeAt(0);e<256&&(a=e)}if(void 0!==d&&"string"!=typeof d)throw new TypeError("encoding must be a string");if("string"==typeof d&&!g.isEncoding(d))throw new TypeError("Unknown encoding: "+d)}else"number"==typeof a&&(a&=255);if(b<0||this.length<b||this.length<c)throw new RangeError("Out of range index");if(c<=b)return this;b>>>=0,c=void 0===c?this.length:c>>>0,a||(a=0);var f;if("number"==typeof a)for(f=b;f<c;++f)this[f]=a;else{var h=g.isBuffer(a)?a:T(new g(a,d).toString()),i=h.length;for(f=0;f<c-b;++f)this[f+b]=h[f%i]}return this};var ba=/[^+\/0-9A-Za-z-_]/g}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"base64-js":516,ieee754:529,isarray:530}],519:[function(a,b,c){var d=a("./cartocss/get-geo-attr"),e=a("./cartocss/get-default-css-for-geometry-type"),f=a("./cartocss/color-ramps");b.exports={choropleth:function(a,b,c,f,g){for(var h=d(f),i="#"+b,j=e(f),k="/** choropleth visualization */\n\n"+i+" {\n  "+h+": "+g[0]+";\n"+j.join("\n")+"\n}\n",l=a.length-1;l>=0;--l)void 0!==a[l]&&null!=a[l]&&(k+="\n"+i+"["+c+" <= "+a[l]+"] {\n",k+="  "+h+":"+g[l]+";\n}");return k},categoryMetadata:function(a,b){for(var c=[],d=b&&b.ramp?b.ramp:f.category,e=b&&b.type?b.type:"string",g=0;g<a.length;g++){var h=a[g];g<10&&void 0!==h&&("string"===e&&null!=h||"string"!==e)&&c.push({title:h,title_type:e,value_type:"color",color:d[g]})}return a.length>10&&c.push({title:"Others",value_type:"color",default:!0,color:d[d.length-1]}),c},category:function(a,b,c,g,h){for(var i,j,k=d(g),l="#"+b,m=f.category,n=h&&h.type?h.type:"string",m=h&&h.ramp?h.ramp:f.category,o=e(g),p="/** category visualization */\n\n"+l+" {\n  "+k+": "+m[0]+";\n"+o.join("\n")+"\n}\n",q=0;q<a.length;q++){var r=a[q];"string"===n?(i=r.replace(/\n/g,"\\n").replace(/\"/g,'\\"'),j='"'+i+'"'):j=r,q<10&&void 0!==r&&("string"===n&&null!=r||"string"!==n)&&(p+="\n"+l+"["+c+"="+j+"] {\n",p+="  "+k+":"+m[q]+";\n}")}return a.length>10&&(p+="\n"+l+"{\n",p+="  "+k+": "+m[m.length-1]+";\n}"),p},torque:function(a,b,c){var d="#"+b,e=["/** torque visualization */","Map {","  -torque-time-attribute: "+a.column+";",'  -torque-aggregation-function: "count(cartodb_id)";',"  -torque-frame-count: "+a.steps+";","  -torque-animation-duration: 10;","  -torque-resolution: 2;","}",d+" {","  marker-width: 3;","  marker-fill-opacity: 0.8;","  marker-fill: #0F3B82; ",'  comp-op: "lighten"; ',"  [frame-offset = 1] { marker-width: 10; marker-fill-opacity: 0.05;}","  [frame-offset = 2] { marker-width: 15; marker-fill-opacity: 0.02;}","}"];return e=e.join("\n")},bubble:function(a,b,c){var d="#"+b,f="/** bubble visualization */\n\n"+d+" {\n";f+=e("point").join("\n"),f+="\nmarker-fill: #FF5C00;",f+="\n}\n\n";for(var g=10,h=30,i=[],j=10,k=0;k<j;++k){var l=k/(j-1);i.push(g+l*(h-g))}for(var k=j-1;k>=0;--k)void 0!==a[k]&&null!=a[k]&&(f+="\n#"+b+" [ "+c+" <= "+a[k]+"] {\n",f+="   marker-width: "+i[k].toFixed(1)+";\n}");return f},heatmap:function(a,b,c){var d="#"+b,e=["/** heatmap visualization */","Map {",'  -torque-time-attribute: "cartodb_id";','  -torque-aggregation-function: "count(cartodb_id)";',"  -torque-frame-count: 1;","  -torque-animation-duration: 10;","  -torque-resolution: 2;","}",d+" {","  marker-width: 10;","  marker-fill-opacity: 0.4;","  marker-fill: #0F3B82; ",'  comp-op: "lighten"; ',"  image-filters: colorize-alpha(blue, cyan, lightgreen, yellow , orange, red);","  marker-file: url(http://s3.amazonaws.com/com.cartodb.assets.static/alphamarker.png);","}"];return e=e.join("\n")}}},{"./cartocss/color-ramps":520,"./cartocss/get-default-css-for-geometry-type":521,"./cartocss/get-geo-attr":522}],520:[function(a,b,c){b.exports={bool:["#229A00","#F84F40","#DDDDDD"],green:["#EDF8FB","#D7FAF4","#CCECE6","#66C2A4","#41AE76","#238B45","#005824"],blue:["#FFFFCC","#C7E9B4","#7FCDBB","#41B6C4","#1D91C0","#225EA8","#0C2C84"],pink:["#F1EEF6","#D4B9DA","#C994C7","#DF65B0","#E7298A","#CE1256","#91003F"],black:["#F7F7F7","#D9D9D9","#BDBDBD","#969696","#737373","#525252","#252525"],red:["#FFFFB2","#FED976","#FEB24C","#FD8D3C","#FC4E2A","#E31A1C","#B10026"],category:["#A6CEE3","#1F78B4","#B2DF8A","#33A02C","#FB9A99","#E31A1C","#FDBF6F","#FF7F00","#CAB2D6","#6A3D9A","#DDDDDD"],divergent:["#0080FF","#40A0FF","#7FBFFF","#FFF2CC","#FFA6A6","#FF7A7A","#FF4D4D"]}},{}],521:[function(a,b,c){b.exports=function(a){return"polygon"===a?["polygon-opacity: 0.7;","line-color: #FFF;","line-width: 0.5;","line-opacity: 1;"]:"line"===a?["line-width: 2;","line-opacity: 0.7;"]:["marker-fill-opacity: 0.9;","marker-line-color: #FFF;","marker-line-width: 1;","marker-line-opacity: 1;","marker-placement: point;","marker-type: ellipse;","marker-width: 10;","marker-allow-overlap: true;"]}},{}],522:[function(a,b,c){b.exports=function(a){return{line:"line-color",polygon:"polygon-fill",point:"marker-fill"}[a]}},{}],523:[function(a,b,c){var d=function(a,b){var c={};for(var e in b)if(b.hasOwnProperty(e)){var f,g=b[e];"object"==typeof a&&(f=a[e]),"object"==typeof g&&"object"==typeof f?c[e]=d(f,g):"object"!=typeof g&&void 0!==f?c[e]=f:c[e]=g}return c||{}};b.exports=d},{}],524:[function(a,b,c){var d=a("./cartocss/color-ramps.js");b.exports=function(a){var b,c=d.blue,e="blue";return["A","U"].indexOf(a.dist_type)!=-1?(b=a.jenks,a.min<0&&a.max>0&&(c=d.divergent,e="spectrum2")):"F"===a.dist_type?(b=a.equalint,c=d.red,e="red"):"J"===a.dist_type?(b=a.headtails,c=d.blue,e="blue"):(b=a.headtails,c=d.red,e="red"),{name:e,ramp:c,method:b}}},{"./cartocss/color-ramps.js":520}],525:[function(a,b,c){b.exports=function(a){return{U:.9,A:.9,L:.7,J:.7,S:.5,F:.3}[a]}},{}],526:[function(a,b,c){var d=a("./cartocss/color-ramps"),e=a("./get-weight-from-shape"),f=a("./get-method-properties"),g=a("./deep-defaults"),h=a("./cartocss");b.exports=function(a){var b=a.dependencies.underscore,c=a.tableName,i=g(a.thresholds,{number:{forBubbleMap:{minCalcWeight:.5,maxStatsCount:200},forCategoryOrBubbleMap:{minStatsWeight:.5,distinctPercentage:25,forCategory:{maxDistinctPercentage:1},forBubble:{minDistinctPercentage:1}}}}),j=a.column,k=j.geometryType,l=j.stats,m=l.column,n="choropleth",o=null,p=l.type,q=[],r=l.distinct/l.count*100;if("number"===p){var s=(l.weight+e(l.dist_type))/2;if(s>=i.number.forBubbleMap.minCalcWeight){var t=h.choropleth,u=f(l);l.count<i.number.forBubbleMap.maxStatsCount&&"point"===k&&(n="bubble",t=h.bubble),o=t(u.method,c,m,k,u.ramp)}else if(l.weight>i.number.forCategoryOrBubbleMap.minStatsWeight||r<i.number.forCategoryOrBubbleMap.maxDistinctPercentage)if(r<i.number.forCategoryOrBubbleMap.forCategory.maxDistinctPercentage){n="category";var v=l.cat_hist;v=b.sortBy(v,function(a){return a[1]}).reverse().slice(0,d.category.length),v=b.sortBy(v,function(a){return a[0]}),v=v.map(function(a){return a[0]}),o=h.category(v,c,m,k,{type:p}),q=h.categoryMetadata(v,{type:p})}else if(r>=i.number.forCategoryOrBubbleMap.forBubble.minDistinctPercentage){var t=h.choropleth;"point"===k&&(n="bubble",t=h.bubble);var u=f(l);o=t(u.method,c,m,k,u.ramp)}}else if("string"===p){n="category";var v=l.hist;v=b.sortBy(v,function(a){return a[1]}).reverse().slice(0,d.category.length),v=b.sortBy(v,function(a){return a[0]}),v=v.map(function(a){return a[0]}),o=h.category(v,c,m,k),q=h.categoryMetadata(v)}else if("date"===p)n="torque",o=h.torque(l,c);else if("boolean"===p){n="category";var w=d.bool,v=["true","false",null],x={type:p,ramp:w};o=h.category(v,c,m,k,x),q=h.categoryMetadata(v,x)}else"geom"===l.type&&(n="heatmap",o=h.heatmap(l,c,x));var u={geometryType:k,column:m,bbox:j.bbox,type:p,visualizationType:n};return o?u.css=o:(u.css=null,u.weight=-100),l&&(u.stats=l),q&&(u.metadata=q),u}},{"./cartocss":519,"./cartocss/color-ramps":520,"./deep-defaults":523,"./get-method-properties":524,"./get-weight-from-shape":525}],527:[function(a,b,c){var d=a("./get-weight-from-shape"),e=a("./deep-defaults"),f={geom:function(a){var b=a.stats;return a.isPointGeometryType&&b.cluster_rate*b.density>=a.thresholds.geom.minStatsDensity},string:function(a){return a.stats.weight>=a.thresholds.string.minWeight},number:function(a){var b=a.stats,c=b.distinct/b.count*100,e=(b.weight+d(b.dist_type))/2;return b.weight>=a.thresholds.number.minWeight&&(e>=a.thresholds.number.minCalcWeight||b.weight>a.thresholds.number.minWeightIfNoOtherApplies||c<a.thresholds.number.maxDistinctPercentage)},boolean:function(a){return a.stats.null_ratio<=a.thresholds.boolean.maxNullRatio},date:function(a){return a.isPointGeometryType&&a.stats.null_ratio<=a.thresholds.date.maxNullRatio}};b.exports=function(a){var b=!1,a=a||{};if(a.thresholds=e(a.thresholds,{geom:{minStatsDensity:.1},string:{minWeight:.8},number:{minWeight:.1,minCalcWeight:.5,maxDistinctPercentage:25,minWeightIfNoOtherApplies:.5},boolean:{maxNullRatio:.75},date:{maxNullRatio:.75}}),a&&a.stats){var c=f[a.stats.type];"function"==typeof c&&(b=c.call(this,a))}return b}},{"./deep-defaults":523,"./get-weight-from-shape":525}],528:[function(a,b,c){b.exports={hasEnoughToGuess:a("./has-enough-to-guess"),guessMap:a("./guess-map"),getWeightFromShape:a("./get-weight-from-shape"),getMethodProperties:a("./get-method-properties")}},{"./get-method-properties":524,"./get-weight-from-shape":525,"./guess-map":526,"./has-enough-to-guess":527}],529:[function(a,b,c){c.read=function(a,b,c,d,e){var f,g,h=8*e-d-1,i=(1<<h)-1,j=i>>1,k=-7,l=c?e-1:0,m=c?-1:1,n=a[b+l];for(l+=m,f=n&(1<<-k)-1,n>>=-k,k+=h;k>0;f=256*f+a[b+l],l+=m,k-=8);for(g=f&(1<<-k)-1,f>>=-k,k+=d;k>0;g=256*g+a[b+l],l+=m,k-=8);if(0===f)f=1-j;else{if(f===i)return g?NaN:(n?-1:1)*(1/0);g+=Math.pow(2,d),f-=j}return(n?-1:1)*g*Math.pow(2,f-d)},c.write=function(a,b,c,d,e,f){var g,h,i,j=8*f-e-1,k=(1<<j)-1,l=k>>1,m=23===e?Math.pow(2,-24)-Math.pow(2,-77):0,n=d?0:f-1,o=d?1:-1,p=b<0||0===b&&1/b<0?1:0;for(b=Math.abs(b),isNaN(b)||b===1/0?(h=isNaN(b)?1:0,g=k):(g=Math.floor(Math.log(b)/Math.LN2),b*(i=Math.pow(2,-g))<1&&(g--,i*=2),b+=g+l>=1?m/i:m*Math.pow(2,1-l),b*i>=2&&(g++,i/=2),g+l>=k?(h=0,g=k):g+l>=1?(h=(b*i-1)*Math.pow(2,e),g+=l):(h=b*Math.pow(2,l-1)*Math.pow(2,e),g=0));e>=8;a[c+n]=255&h,n+=o,h/=256,e-=8);for(g=g<<e|h,j+=e;j>0;a[c+n]=255&g,n+=o,g/=256,j-=8);a[c+n-o]|=128*p}},{}],530:[function(a,b,c){var d={}.toString;b.exports=Array.isArray||function(a){return"[object Array]"==d.call(a)}},{}],531:[function(a,b,c){!function(a,d){"object"==typeof c&&"undefined"!=typeof b?b.exports=d():"function"==typeof define&&define.amd?define(d):a.moment=d()}(this,function(){"use strict";function c(){return Jc.apply(null,arguments)}function d(a){Jc=a}function e(a){return"[object Array]"===Object.prototype.toString.call(a)}function f(a){return a instanceof Date||"[object Date]"===Object.prototype.toString.call(a)}function g(a,b){var c,d=[];for(c=0;c<a.length;++c)d.push(b(a[c],c));return d}function h(a,b){return Object.prototype.hasOwnProperty.call(a,b)}function i(a,b){for(var c in b)h(b,c)&&(a[c]=b[c]);return h(b,"toString")&&(a.toString=b.toString),h(b,"valueOf")&&(a.valueOf=b.valueOf),a}function j(a,b,c,d){return Ea(a,b,c,d,!0).utc()}function k(){return{empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1}}function l(a){return null==a._pf&&(a._pf=k()),a._pf}function m(a){if(null==a._isValid){var b=l(a);a._isValid=!(isNaN(a._d.getTime())||!(b.overflow<0)||b.empty||b.invalidMonth||b.invalidWeekday||b.nullInput||b.invalidFormat||b.userInvalidated),a._strict&&(a._isValid=a._isValid&&0===b.charsLeftOver&&0===b.unusedTokens.length&&void 0===b.bigHour)}return a._isValid}function n(a){var b=j(NaN);return null!=a?i(l(b),a):l(b).userInvalidated=!0,b}function o(a,b){var c,d,e;if("undefined"!=typeof b._isAMomentObject&&(a._isAMomentObject=b._isAMomentObject),"undefined"!=typeof b._i&&(a._i=b._i),"undefined"!=typeof b._f&&(a._f=b._f),"undefined"!=typeof b._l&&(a._l=b._l),"undefined"!=typeof b._strict&&(a._strict=b._strict),"undefined"!=typeof b._tzm&&(a._tzm=b._tzm),"undefined"!=typeof b._isUTC&&(a._isUTC=b._isUTC),"undefined"!=typeof b._offset&&(a._offset=b._offset),"undefined"!=typeof b._pf&&(a._pf=l(b)),"undefined"!=typeof b._locale&&(a._locale=b._locale),Lc.length>0)for(c in Lc)d=Lc[c],e=b[d],"undefined"!=typeof e&&(a[d]=e);return a}function p(a){o(this,a),this._d=new Date(null!=a._d?a._d.getTime():NaN),Mc===!1&&(Mc=!0,c.updateOffset(this),Mc=!1)}function q(a){return a instanceof p||null!=a&&null!=a._isAMomentObject}function r(a){return a<0?Math.ceil(a):Math.floor(a)}function s(a){var b=+a,c=0;return 0!==b&&isFinite(b)&&(c=r(b)),c}function t(a,b,c){var d,e=Math.min(a.length,b.length),f=Math.abs(a.length-b.length),g=0;for(d=0;d<e;d++)(c&&a[d]!==b[d]||!c&&s(a[d])!==s(b[d]))&&g++;return g+f}function u(){}function v(a){return a?a.toLowerCase().replace("_","-"):a}function w(a){for(var b,c,d,e,f=0;f<a.length;){for(e=v(a[f]).split("-"),b=e.length,c=v(a[f+1]),c=c?c.split("-"):null;b>0;){if(d=x(e.slice(0,b).join("-")))return d;if(c&&c.length>=b&&t(e,c,!0)>=b-1)break;b--}f++}return null}function x(c){var d=null;if(!Nc[c]&&"undefined"!=typeof b&&b&&b.exports)try{d=Kc._abbr,a("./locale/"+c),y(d)}catch(a){}return Nc[c]}function y(a,b){var c;return a&&(c="undefined"==typeof b?A(a):z(a,b),c&&(Kc=c)),Kc._abbr}function z(a,b){return null!==b?(b.abbr=a,Nc[a]=Nc[a]||new u,Nc[a].set(b),y(a),Nc[a]):(delete Nc[a],null)}function A(a){var b;if(a&&a._locale&&a._locale._abbr&&(a=a._locale._abbr),!a)return Kc;if(!e(a)){if(b=x(a))return b;a=[a]}return w(a)}function B(a,b){var c=a.toLowerCase();Oc[c]=Oc[c+"s"]=Oc[b]=a}function C(a){return"string"==typeof a?Oc[a]||Oc[a.toLowerCase()]:void 0}function D(a){var b,c,d={};for(c in a)h(a,c)&&(b=C(c),b&&(d[b]=a[c]));return d}function E(a,b){return function(d){return null!=d?(G(this,a,d),c.updateOffset(this,b),this):F(this,a)}}function F(a,b){return a._d["get"+(a._isUTC?"UTC":"")+b]()}function G(a,b,c){return a._d["set"+(a._isUTC?"UTC":"")+b](c)}function H(a,b){var c;if("object"==typeof a)for(c in a)this.set(c,a[c]);else if(a=C(a),"function"==typeof this[a])return this[a](b);
return this}function I(a,b,c){var d=""+Math.abs(a),e=b-d.length,f=a>=0;return(f?c?"+":"":"-")+Math.pow(10,Math.max(0,e)).toString().substr(1)+d}function J(a,b,c,d){var e=d;"string"==typeof d&&(e=function(){return this[d]()}),a&&(Sc[a]=e),b&&(Sc[b[0]]=function(){return I(e.apply(this,arguments),b[1],b[2])}),c&&(Sc[c]=function(){return this.localeData().ordinal(e.apply(this,arguments),a)})}function K(a){return a.match(/\[[\s\S]/)?a.replace(/^\[|\]$/g,""):a.replace(/\\/g,"")}function L(a){var b,c,d=a.match(Pc);for(b=0,c=d.length;b<c;b++)Sc[d[b]]?d[b]=Sc[d[b]]:d[b]=K(d[b]);return function(e){var f="";for(b=0;b<c;b++)f+=d[b]instanceof Function?d[b].call(e,a):d[b];return f}}function M(a,b){return a.isValid()?(b=N(b,a.localeData()),Rc[b]=Rc[b]||L(b),Rc[b](a)):a.localeData().invalidDate()}function N(a,b){function c(a){return b.longDateFormat(a)||a}var d=5;for(Qc.lastIndex=0;d>=0&&Qc.test(a);)a=a.replace(Qc,c),Qc.lastIndex=0,d-=1;return a}function O(a){return"function"==typeof a&&"[object Function]"===Object.prototype.toString.call(a)}function P(a,b,c){fd[a]=O(b)?b:function(a){return a&&c?c:b}}function Q(a,b){return h(fd,a)?fd[a](b._strict,b._locale):new RegExp(R(a))}function R(a){return a.replace("\\","").replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(a,b,c,d,e){return b||c||d||e}).replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function S(a,b){var c,d=b;for("string"==typeof a&&(a=[a]),"number"==typeof b&&(d=function(a,c){c[b]=s(a)}),c=0;c<a.length;c++)gd[a[c]]=d}function T(a,b){S(a,function(a,c,d,e){d._w=d._w||{},b(a,d._w,d,e)})}function U(a,b,c){null!=b&&h(gd,a)&&gd[a](b,c._a,c,a)}function V(a,b){return new Date(Date.UTC(a,b+1,0)).getUTCDate()}function W(a){return this._months[a.month()]}function X(a){return this._monthsShort[a.month()]}function Y(a,b,c){var d,e,f;for(this._monthsParse||(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[]),d=0;d<12;d++){if(e=j([2e3,d]),c&&!this._longMonthsParse[d]&&(this._longMonthsParse[d]=new RegExp("^"+this.months(e,"").replace(".","")+"$","i"),this._shortMonthsParse[d]=new RegExp("^"+this.monthsShort(e,"").replace(".","")+"$","i")),c||this._monthsParse[d]||(f="^"+this.months(e,"")+"|^"+this.monthsShort(e,""),this._monthsParse[d]=new RegExp(f.replace(".",""),"i")),c&&"MMMM"===b&&this._longMonthsParse[d].test(a))return d;if(c&&"MMM"===b&&this._shortMonthsParse[d].test(a))return d;if(!c&&this._monthsParse[d].test(a))return d}}function Z(a,b){var c;return"string"==typeof b&&(b=a.localeData().monthsParse(b),"number"!=typeof b)?a:(c=Math.min(a.date(),V(a.year(),b)),a._d["set"+(a._isUTC?"UTC":"")+"Month"](b,c),a)}function $(a){return null!=a?(Z(this,a),c.updateOffset(this,!0),this):F(this,"Month")}function _(){return V(this.year(),this.month())}function aa(a){var b,c=a._a;return c&&l(a).overflow===-2&&(b=c[id]<0||c[id]>11?id:c[jd]<1||c[jd]>V(c[hd],c[id])?jd:c[kd]<0||c[kd]>24||24===c[kd]&&(0!==c[ld]||0!==c[md]||0!==c[nd])?kd:c[ld]<0||c[ld]>59?ld:c[md]<0||c[md]>59?md:c[nd]<0||c[nd]>999?nd:-1,l(a)._overflowDayOfYear&&(b<hd||b>jd)&&(b=jd),l(a).overflow=b),a}function ba(a){c.suppressDeprecationWarnings===!1&&"undefined"!=typeof console&&console.warn&&console.warn("Deprecation warning: "+a)}function ca(a,b){var c=!0;return i(function(){return c&&(ba(a+"\n"+(new Error).stack),c=!1),b.apply(this,arguments)},b)}function da(a,b){qd[a]||(ba(b),qd[a]=!0)}function ea(a){var b,c,d=a._i,e=rd.exec(d);if(e){for(l(a).iso=!0,b=0,c=sd.length;b<c;b++)if(sd[b][1].exec(d)){a._f=sd[b][0];break}for(b=0,c=td.length;b<c;b++)if(td[b][1].exec(d)){a._f+=(e[6]||" ")+td[b][0];break}d.match(cd)&&(a._f+="Z"),xa(a)}else a._isValid=!1}function fa(a){var b=ud.exec(a._i);return null!==b?void(a._d=new Date(+b[1])):(ea(a),void(a._isValid===!1&&(delete a._isValid,c.createFromInputFallback(a))))}function ga(a,b,c,d,e,f,g){var h=new Date(a,b,c,d,e,f,g);return a<1970&&h.setFullYear(a),h}function ha(a){var b=new Date(Date.UTC.apply(null,arguments));return a<1970&&b.setUTCFullYear(a),b}function ia(a){return ja(a)?366:365}function ja(a){return a%4===0&&a%100!==0||a%400===0}function ka(){return ja(this.year())}function la(a,b,c){var d,e=c-b,f=c-a.day();return f>e&&(f-=7),f<e-7&&(f+=7),d=Fa(a).add(f,"d"),{week:Math.ceil(d.dayOfYear()/7),year:d.year()}}function ma(a){return la(a,this._week.dow,this._week.doy).week}function na(){return this._week.dow}function oa(){return this._week.doy}function pa(a){var b=this.localeData().week(this);return null==a?b:this.add(7*(a-b),"d")}function qa(a){var b=la(this,1,4).week;return null==a?b:this.add(7*(a-b),"d")}function ra(a,b,c,d,e){var f,g=6+e-d,h=ha(a,0,1+g),i=h.getUTCDay();return i<e&&(i+=7),c=null!=c?1*c:e,f=1+g+7*(b-1)-i+c,{year:f>0?a:a-1,dayOfYear:f>0?f:ia(a-1)+f}}function sa(a){var b=Math.round((this.clone().startOf("day")-this.clone().startOf("year"))/864e5)+1;return null==a?b:this.add(a-b,"d")}function ta(a,b,c){return null!=a?a:null!=b?b:c}function ua(a){var b=new Date;return a._useUTC?[b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate()]:[b.getFullYear(),b.getMonth(),b.getDate()]}function va(a){var b,c,d,e,f=[];if(!a._d){for(d=ua(a),a._w&&null==a._a[jd]&&null==a._a[id]&&wa(a),a._dayOfYear&&(e=ta(a._a[hd],d[hd]),a._dayOfYear>ia(e)&&(l(a)._overflowDayOfYear=!0),c=ha(e,0,a._dayOfYear),a._a[id]=c.getUTCMonth(),a._a[jd]=c.getUTCDate()),b=0;b<3&&null==a._a[b];++b)a._a[b]=f[b]=d[b];for(;b<7;b++)a._a[b]=f[b]=null==a._a[b]?2===b?1:0:a._a[b];24===a._a[kd]&&0===a._a[ld]&&0===a._a[md]&&0===a._a[nd]&&(a._nextDay=!0,a._a[kd]=0),a._d=(a._useUTC?ha:ga).apply(null,f),null!=a._tzm&&a._d.setUTCMinutes(a._d.getUTCMinutes()-a._tzm),a._nextDay&&(a._a[kd]=24)}}function wa(a){var b,c,d,e,f,g,h;b=a._w,null!=b.GG||null!=b.W||null!=b.E?(f=1,g=4,c=ta(b.GG,a._a[hd],la(Fa(),1,4).year),d=ta(b.W,1),e=ta(b.E,1)):(f=a._locale._week.dow,g=a._locale._week.doy,c=ta(b.gg,a._a[hd],la(Fa(),f,g).year),d=ta(b.w,1),null!=b.d?(e=b.d,e<f&&++d):e=null!=b.e?b.e+f:f),h=ra(c,d,e,g,f),a._a[hd]=h.year,a._dayOfYear=h.dayOfYear}function xa(a){if(a._f===c.ISO_8601)return void ea(a);a._a=[],l(a).empty=!0;var b,d,e,f,g,h=""+a._i,i=h.length,j=0;for(e=N(a._f,a._locale).match(Pc)||[],b=0;b<e.length;b++)f=e[b],d=(h.match(Q(f,a))||[])[0],d&&(g=h.substr(0,h.indexOf(d)),g.length>0&&l(a).unusedInput.push(g),h=h.slice(h.indexOf(d)+d.length),j+=d.length),Sc[f]?(d?l(a).empty=!1:l(a).unusedTokens.push(f),U(f,d,a)):a._strict&&!d&&l(a).unusedTokens.push(f);l(a).charsLeftOver=i-j,h.length>0&&l(a).unusedInput.push(h),l(a).bigHour===!0&&a._a[kd]<=12&&a._a[kd]>0&&(l(a).bigHour=void 0),a._a[kd]=ya(a._locale,a._a[kd],a._meridiem),va(a),aa(a)}function ya(a,b,c){var d;return null==c?b:null!=a.meridiemHour?a.meridiemHour(b,c):null!=a.isPM?(d=a.isPM(c),d&&b<12&&(b+=12),d||12!==b||(b=0),b):b}function za(a){var b,c,d,e,f;if(0===a._f.length)return l(a).invalidFormat=!0,void(a._d=new Date(NaN));for(e=0;e<a._f.length;e++)f=0,b=o({},a),null!=a._useUTC&&(b._useUTC=a._useUTC),b._f=a._f[e],xa(b),m(b)&&(f+=l(b).charsLeftOver,f+=10*l(b).unusedTokens.length,l(b).score=f,(null==d||f<d)&&(d=f,c=b));i(a,c||b)}function Aa(a){if(!a._d){var b=D(a._i);a._a=[b.year,b.month,b.day||b.date,b.hour,b.minute,b.second,b.millisecond],va(a)}}function Ba(a){var b=new p(aa(Ca(a)));return b._nextDay&&(b.add(1,"d"),b._nextDay=void 0),b}function Ca(a){var b=a._i,c=a._f;return a._locale=a._locale||A(a._l),null===b||void 0===c&&""===b?n({nullInput:!0}):("string"==typeof b&&(a._i=b=a._locale.preparse(b)),q(b)?new p(aa(b)):(e(c)?za(a):c?xa(a):f(b)?a._d=b:Da(a),a))}function Da(a){var b=a._i;void 0===b?a._d=new Date:f(b)?a._d=new Date(+b):"string"==typeof b?fa(a):e(b)?(a._a=g(b.slice(0),function(a){return parseInt(a,10)}),va(a)):"object"==typeof b?Aa(a):"number"==typeof b?a._d=new Date(b):c.createFromInputFallback(a)}function Ea(a,b,c,d,e){var f={};return"boolean"==typeof c&&(d=c,c=void 0),f._isAMomentObject=!0,f._useUTC=f._isUTC=e,f._l=c,f._i=a,f._f=b,f._strict=d,Ba(f)}function Fa(a,b,c,d){return Ea(a,b,c,d,!1)}function Ga(a,b){var c,d;if(1===b.length&&e(b[0])&&(b=b[0]),!b.length)return Fa();for(c=b[0],d=1;d<b.length;++d)b[d].isValid()&&!b[d][a](c)||(c=b[d]);return c}function Ha(){var a=[].slice.call(arguments,0);return Ga("isBefore",a)}function Ia(){var a=[].slice.call(arguments,0);return Ga("isAfter",a)}function Ja(a){var b=D(a),c=b.year||0,d=b.quarter||0,e=b.month||0,f=b.week||0,g=b.day||0,h=b.hour||0,i=b.minute||0,j=b.second||0,k=b.millisecond||0;this._milliseconds=+k+1e3*j+6e4*i+36e5*h,this._days=+g+7*f,this._months=+e+3*d+12*c,this._data={},this._locale=A(),this._bubble()}function Ka(a){return a instanceof Ja}function La(a,b){J(a,0,0,function(){var a=this.utcOffset(),c="+";return a<0&&(a=-a,c="-"),c+I(~~(a/60),2)+b+I(~~a%60,2)})}function Ma(a){var b=(a||"").match(cd)||[],c=b[b.length-1]||[],d=(c+"").match(zd)||["-",0,0],e=+(60*d[1])+s(d[2]);return"+"===d[0]?e:-e}function Na(a,b){var d,e;return b._isUTC?(d=b.clone(),e=(q(a)||f(a)?+a:+Fa(a))-+d,d._d.setTime(+d._d+e),c.updateOffset(d,!1),d):Fa(a).local()}function Oa(a){return 15*-Math.round(a._d.getTimezoneOffset()/15)}function Pa(a,b){var d,e=this._offset||0;return null!=a?("string"==typeof a&&(a=Ma(a)),Math.abs(a)<16&&(a*=60),!this._isUTC&&b&&(d=Oa(this)),this._offset=a,this._isUTC=!0,null!=d&&this.add(d,"m"),e!==a&&(!b||this._changeInProgress?db(this,$a(a-e,"m"),1,!1):this._changeInProgress||(this._changeInProgress=!0,c.updateOffset(this,!0),this._changeInProgress=null)),this):this._isUTC?e:Oa(this)}function Qa(a,b){return null!=a?("string"!=typeof a&&(a=-a),this.utcOffset(a,b),this):-this.utcOffset()}function Ra(a){return this.utcOffset(0,a)}function Sa(a){return this._isUTC&&(this.utcOffset(0,a),this._isUTC=!1,a&&this.subtract(Oa(this),"m")),this}function Ta(){return this._tzm?this.utcOffset(this._tzm):"string"==typeof this._i&&this.utcOffset(Ma(this._i)),this}function Ua(a){return a=a?Fa(a).utcOffset():0,(this.utcOffset()-a)%60===0}function Va(){return this.utcOffset()>this.clone().month(0).utcOffset()||this.utcOffset()>this.clone().month(5).utcOffset()}function Wa(){if("undefined"!=typeof this._isDSTShifted)return this._isDSTShifted;var a={};if(o(a,this),a=Ca(a),a._a){var b=a._isUTC?j(a._a):Fa(a._a);this._isDSTShifted=this.isValid()&&t(a._a,b.toArray())>0}else this._isDSTShifted=!1;return this._isDSTShifted}function Xa(){return!this._isUTC}function Ya(){return this._isUTC}function Za(){return this._isUTC&&0===this._offset}function $a(a,b){var c,d,e,f=a,g=null;return Ka(a)?f={ms:a._milliseconds,d:a._days,M:a._months}:"number"==typeof a?(f={},b?f[b]=a:f.milliseconds=a):(g=Ad.exec(a))?(c="-"===g[1]?-1:1,f={y:0,d:s(g[jd])*c,h:s(g[kd])*c,m:s(g[ld])*c,s:s(g[md])*c,ms:s(g[nd])*c}):(g=Bd.exec(a))?(c="-"===g[1]?-1:1,f={y:_a(g[2],c),M:_a(g[3],c),d:_a(g[4],c),h:_a(g[5],c),m:_a(g[6],c),s:_a(g[7],c),w:_a(g[8],c)}):null==f?f={}:"object"==typeof f&&("from"in f||"to"in f)&&(e=bb(Fa(f.from),Fa(f.to)),f={},f.ms=e.milliseconds,f.M=e.months),d=new Ja(f),Ka(a)&&h(a,"_locale")&&(d._locale=a._locale),d}function _a(a,b){var c=a&&parseFloat(a.replace(",","."));return(isNaN(c)?0:c)*b}function ab(a,b){var c={milliseconds:0,months:0};return c.months=b.month()-a.month()+12*(b.year()-a.year()),a.clone().add(c.months,"M").isAfter(b)&&--c.months,c.milliseconds=+b-+a.clone().add(c.months,"M"),c}function bb(a,b){var c;return b=Na(b,a),a.isBefore(b)?c=ab(a,b):(c=ab(b,a),c.milliseconds=-c.milliseconds,c.months=-c.months),c}function cb(a,b){return function(c,d){var e,f;return null===d||isNaN(+d)||(da(b,"moment()."+b+"(period, number) is deprecated. Please use moment()."+b+"(number, period)."),f=c,c=d,d=f),c="string"==typeof c?+c:c,e=$a(c,d),db(this,e,a),this}}function db(a,b,d,e){var f=b._milliseconds,g=b._days,h=b._months;e=null==e||e,f&&a._d.setTime(+a._d+f*d),g&&G(a,"Date",F(a,"Date")+g*d),h&&Z(a,F(a,"Month")+h*d),e&&c.updateOffset(a,g||h)}function eb(a,b){var c=a||Fa(),d=Na(c,this).startOf("day"),e=this.diff(d,"days",!0),f=e<-6?"sameElse":e<-1?"lastWeek":e<0?"lastDay":e<1?"sameDay":e<2?"nextDay":e<7?"nextWeek":"sameElse";return this.format(b&&b[f]||this.localeData().calendar(f,this,Fa(c)))}function fb(){return new p(this)}function gb(a,b){var c;return b=C("undefined"!=typeof b?b:"millisecond"),"millisecond"===b?(a=q(a)?a:Fa(a),+this>+a):(c=q(a)?+a:+Fa(a),c<+this.clone().startOf(b))}function hb(a,b){var c;return b=C("undefined"!=typeof b?b:"millisecond"),"millisecond"===b?(a=q(a)?a:Fa(a),+this<+a):(c=q(a)?+a:+Fa(a),+this.clone().endOf(b)<c)}function ib(a,b,c){return this.isAfter(a,c)&&this.isBefore(b,c)}function jb(a,b){var c;return b=C(b||"millisecond"),"millisecond"===b?(a=q(a)?a:Fa(a),+this===+a):(c=+Fa(a),+this.clone().startOf(b)<=c&&c<=+this.clone().endOf(b))}function kb(a,b,c){var d,e,f=Na(a,this),g=6e4*(f.utcOffset()-this.utcOffset());return b=C(b),"year"===b||"month"===b||"quarter"===b?(e=lb(this,f),"quarter"===b?e/=3:"year"===b&&(e/=12)):(d=this-f,e="second"===b?d/1e3:"minute"===b?d/6e4:"hour"===b?d/36e5:"day"===b?(d-g)/864e5:"week"===b?(d-g)/6048e5:d),c?e:r(e)}function lb(a,b){var c,d,e=12*(b.year()-a.year())+(b.month()-a.month()),f=a.clone().add(e,"months");return b-f<0?(c=a.clone().add(e-1,"months"),d=(b-f)/(f-c)):(c=a.clone().add(e+1,"months"),d=(b-f)/(c-f)),-(e+d)}function mb(){return this.clone().locale("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")}function nb(){var a=this.clone().utc();return 0<a.year()&&a.year()<=9999?"function"==typeof Date.prototype.toISOString?this.toDate().toISOString():M(a,"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]"):M(a,"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]")}function ob(a){var b=M(this,a||c.defaultFormat);return this.localeData().postformat(b)}function pb(a,b){return this.isValid()?$a({to:this,from:a}).locale(this.locale()).humanize(!b):this.localeData().invalidDate()}function qb(a){return this.from(Fa(),a)}function rb(a,b){return this.isValid()?$a({from:this,to:a}).locale(this.locale()).humanize(!b):this.localeData().invalidDate()}function sb(a){return this.to(Fa(),a)}function tb(a){var b;return void 0===a?this._locale._abbr:(b=A(a),null!=b&&(this._locale=b),this)}function ub(){return this._locale}function vb(a){switch(a=C(a)){case"year":this.month(0);case"quarter":case"month":this.date(1);case"week":case"isoWeek":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}return"week"===a&&this.weekday(0),"isoWeek"===a&&this.isoWeekday(1),"quarter"===a&&this.month(3*Math.floor(this.month()/3)),this}function wb(a){return a=C(a),void 0===a||"millisecond"===a?this:this.startOf(a).add(1,"isoWeek"===a?"week":a).subtract(1,"ms")}function xb(){return+this._d-6e4*(this._offset||0)}function yb(){return Math.floor(+this/1e3)}function zb(){return this._offset?new Date(+this):this._d}function Ab(){var a=this;return[a.year(),a.month(),a.date(),a.hour(),a.minute(),a.second(),a.millisecond()]}function Bb(){var a=this;return{years:a.year(),months:a.month(),date:a.date(),hours:a.hours(),minutes:a.minutes(),seconds:a.seconds(),milliseconds:a.milliseconds()}}function Cb(){return m(this)}function Db(){return i({},l(this))}function Eb(){return l(this).overflow}function Fb(a,b){J(0,[a,a.length],0,b)}function Gb(a,b,c){return la(Fa([a,11,31+b-c]),b,c).week}function Hb(a){var b=la(this,this.localeData()._week.dow,this.localeData()._week.doy).year;return null==a?b:this.add(a-b,"y")}function Ib(a){var b=la(this,1,4).year;return null==a?b:this.add(a-b,"y")}function Jb(){return Gb(this.year(),1,4)}function Kb(){var a=this.localeData()._week;return Gb(this.year(),a.dow,a.doy)}function Lb(a){return null==a?Math.ceil((this.month()+1)/3):this.month(3*(a-1)+this.month()%3)}function Mb(a,b){return"string"!=typeof a?a:isNaN(a)?(a=b.weekdaysParse(a),"number"==typeof a?a:null):parseInt(a,10)}function Nb(a){return this._weekdays[a.day()]}function Ob(a){return this._weekdaysShort[a.day()]}function Pb(a){return this._weekdaysMin[a.day()]}function Qb(a){var b,c,d;for(this._weekdaysParse=this._weekdaysParse||[],b=0;b<7;b++)if(this._weekdaysParse[b]||(c=Fa([2e3,1]).day(b),d="^"+this.weekdays(c,"")+"|^"+this.weekdaysShort(c,"")+"|^"+this.weekdaysMin(c,""),this._weekdaysParse[b]=new RegExp(d.replace(".",""),"i")),this._weekdaysParse[b].test(a))return b}function Rb(a){var b=this._isUTC?this._d.getUTCDay():this._d.getDay();return null!=a?(a=Mb(a,this.localeData()),this.add(a-b,"d")):b}function Sb(a){var b=(this.day()+7-this.localeData()._week.dow)%7;return null==a?b:this.add(a-b,"d")}function Tb(a){return null==a?this.day()||7:this.day(this.day()%7?a:a-7)}function Ub(a,b){J(a,0,0,function(){return this.localeData().meridiem(this.hours(),this.minutes(),b)})}function Vb(a,b){return b._meridiemParse}function Wb(a){return"p"===(a+"").toLowerCase().charAt(0)}function Xb(a,b,c){return a>11?c?"pm":"PM":c?"am":"AM"}function Yb(a,b){b[nd]=s(1e3*("0."+a))}function Zb(){return this._isUTC?"UTC":""}function $b(){return this._isUTC?"Coordinated Universal Time":""}function _b(a){return Fa(1e3*a)}function ac(){return Fa.apply(null,arguments).parseZone()}function bc(a,b,c){var d=this._calendar[a];return"function"==typeof d?d.call(b,c):d}function cc(a){var b=this._longDateFormat[a],c=this._longDateFormat[a.toUpperCase()];return b||!c?b:(this._longDateFormat[a]=c.replace(/MMMM|MM|DD|dddd/g,function(a){return a.slice(1)}),this._longDateFormat[a])}function dc(){return this._invalidDate}function ec(a){return this._ordinal.replace("%d",a)}function fc(a){return a}function gc(a,b,c,d){var e=this._relativeTime[c];return"function"==typeof e?e(a,b,c,d):e.replace(/%d/i,a)}function hc(a,b){var c=this._relativeTime[a>0?"future":"past"];return"function"==typeof c?c(b):c.replace(/%s/i,b)}function ic(a){var b,c;for(c in a)b=a[c],"function"==typeof b?this[c]=b:this["_"+c]=b;this._ordinalParseLenient=new RegExp(this._ordinalParse.source+"|"+/\d{1,2}/.source)}function jc(a,b,c,d){var e=A(),f=j().set(d,b);return e[c](f,a)}function kc(a,b,c,d,e){if("number"==typeof a&&(b=a,a=void 0),a=a||"",null!=b)return jc(a,b,c,e);var f,g=[];for(f=0;f<d;f++)g[f]=jc(a,f,c,e);return g}function lc(a,b){return kc(a,b,"months",12,"month")}function mc(a,b){return kc(a,b,"monthsShort",12,"month")}function nc(a,b){return kc(a,b,"weekdays",7,"day")}function oc(a,b){return kc(a,b,"weekdaysShort",7,"day")}function pc(a,b){return kc(a,b,"weekdaysMin",7,"day")}function qc(){var a=this._data;return this._milliseconds=Yd(this._milliseconds),this._days=Yd(this._days),this._months=Yd(this._months),a.milliseconds=Yd(a.milliseconds),a.seconds=Yd(a.seconds),a.minutes=Yd(a.minutes),a.hours=Yd(a.hours),a.months=Yd(a.months),a.years=Yd(a.years),this}function rc(a,b,c,d){var e=$a(b,c);return a._milliseconds+=d*e._milliseconds,a._days+=d*e._days,a._months+=d*e._months,a._bubble()}function sc(a,b){return rc(this,a,b,1)}function tc(a,b){return rc(this,a,b,-1)}function uc(a){return a<0?Math.floor(a):Math.ceil(a)}function vc(){var a,b,c,d,e,f=this._milliseconds,g=this._days,h=this._months,i=this._data;return f>=0&&g>=0&&h>=0||f<=0&&g<=0&&h<=0||(f+=864e5*uc(xc(h)+g),g=0,h=0),i.milliseconds=f%1e3,a=r(f/1e3),i.seconds=a%60,b=r(a/60),i.minutes=b%60,c=r(b/60),i.hours=c%24,g+=r(c/24),e=r(wc(g)),h+=e,g-=uc(xc(e)),d=r(h/12),h%=12,i.days=g,i.months=h,i.years=d,this}function wc(a){return 4800*a/146097}function xc(a){return 146097*a/4800}function yc(a){var b,c,d=this._milliseconds;if(a=C(a),"month"===a||"year"===a)return b=this._days+d/864e5,c=this._months+wc(b),"month"===a?c:c/12;switch(b=this._days+Math.round(xc(this._months)),a){case"week":return b/7+d/6048e5;case"day":return b+d/864e5;case"hour":return 24*b+d/36e5;case"minute":return 1440*b+d/6e4;case"second":return 86400*b+d/1e3;case"millisecond":return Math.floor(864e5*b)+d;default:throw new Error("Unknown unit "+a)}}function zc(){return this._milliseconds+864e5*this._days+this._months%12*2592e6+31536e6*s(this._months/12)}function Ac(a){return function(){return this.as(a)}}function Bc(a){return a=C(a),this[a+"s"]()}function Cc(a){return function(){return this._data[a]}}function Dc(){return r(this.days()/7)}function Ec(a,b,c,d,e){return e.relativeTime(b||1,!!c,a,d)}function Fc(a,b,c){var d=$a(a).abs(),e=me(d.as("s")),f=me(d.as("m")),g=me(d.as("h")),h=me(d.as("d")),i=me(d.as("M")),j=me(d.as("y")),k=e<ne.s&&["s",e]||1===f&&["m"]||f<ne.m&&["mm",f]||1===g&&["h"]||g<ne.h&&["hh",g]||1===h&&["d"]||h<ne.d&&["dd",h]||1===i&&["M"]||i<ne.M&&["MM",i]||1===j&&["y"]||["yy",j];return k[2]=b,k[3]=+a>0,k[4]=c,Ec.apply(null,k)}function Gc(a,b){return void 0!==ne[a]&&(void 0===b?ne[a]:(ne[a]=b,!0))}function Hc(a){var b=this.localeData(),c=Fc(this,!a,b);return a&&(c=b.pastFuture(+this,c)),b.postformat(c)}function Ic(){var a,b,c,d=oe(this._milliseconds)/1e3,e=oe(this._days),f=oe(this._months);a=r(d/60),b=r(a/60),d%=60,a%=60,c=r(f/12),f%=12;var g=c,h=f,i=e,j=b,k=a,l=d,m=this.asSeconds();return m?(m<0?"-":"")+"P"+(g?g+"Y":"")+(h?h+"M":"")+(i?i+"D":"")+(j||k||l?"T":"")+(j?j+"H":"")+(k?k+"M":"")+(l?l+"S":""):"P0D"}var Jc,Kc,Lc=c.momentProperties=[],Mc=!1,Nc={},Oc={},Pc=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Q|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g,Qc=/(\[[^\[]*\])|(\\)?(LTS|LT|LL?L?L?|l{1,4})/g,Rc={},Sc={},Tc=/\d/,Uc=/\d\d/,Vc=/\d{3}/,Wc=/\d{4}/,Xc=/[+-]?\d{6}/,Yc=/\d\d?/,Zc=/\d{1,3}/,$c=/\d{1,4}/,_c=/[+-]?\d{1,6}/,ad=/\d+/,bd=/[+-]?\d+/,cd=/Z|[+-]\d\d:?\d\d/gi,dd=/[+-]?\d+(\.\d{1,3})?/,ed=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,fd={},gd={},hd=0,id=1,jd=2,kd=3,ld=4,md=5,nd=6;J("M",["MM",2],"Mo",function(){return this.month()+1}),J("MMM",0,0,function(a){return this.localeData().monthsShort(this,a)}),J("MMMM",0,0,function(a){return this.localeData().months(this,a)}),B("month","M"),P("M",Yc),P("MM",Yc,Uc),P("MMM",ed),P("MMMM",ed),S(["M","MM"],function(a,b){b[id]=s(a)-1}),S(["MMM","MMMM"],function(a,b,c,d){var e=c._locale.monthsParse(a,d,c._strict);null!=e?b[id]=e:l(c).invalidMonth=a});var od="January_February_March_April_May_June_July_August_September_October_November_December".split("_"),pd="Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),qd={};c.suppressDeprecationWarnings=!1;var rd=/^\s*(?:[+-]\d{6}|\d{4})-(?:(\d\d-\d\d)|(W\d\d$)|(W\d\d-\d)|(\d\d\d))((T| )(\d\d(:\d\d(:\d\d(\.\d+)?)?)?)?([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,sd=[["YYYYYY-MM-DD",/[+-]\d{6}-\d{2}-\d{2}/],["YYYY-MM-DD",/\d{4}-\d{2}-\d{2}/],["GGGG-[W]WW-E",/\d{4}-W\d{2}-\d/],["GGGG-[W]WW",/\d{4}-W\d{2}/],["YYYY-DDD",/\d{4}-\d{3}/]],td=[["HH:mm:ss.SSSS",/(T| )\d\d:\d\d:\d\d\.\d+/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],ud=/^\/?Date\((\-?\d+)/i;c.createFromInputFallback=ca("moment construction falls back to js Date. This is discouraged and will be removed in upcoming major release. Please refer to https://github.com/moment/moment/issues/1407 for more info.",function(a){a._d=new Date(a._i+(a._useUTC?" UTC":""))}),J(0,["YY",2],0,function(){return this.year()%100}),J(0,["YYYY",4],0,"year"),J(0,["YYYYY",5],0,"year"),J(0,["YYYYYY",6,!0],0,"year"),B("year","y"),P("Y",bd),P("YY",Yc,Uc),P("YYYY",$c,Wc),P("YYYYY",_c,Xc),P("YYYYYY",_c,Xc),S(["YYYYY","YYYYYY"],hd),S("YYYY",function(a,b){b[hd]=2===a.length?c.parseTwoDigitYear(a):s(a)}),S("YY",function(a,b){b[hd]=c.parseTwoDigitYear(a)}),c.parseTwoDigitYear=function(a){return s(a)+(s(a)>68?1900:2e3)};var vd=E("FullYear",!1);J("w",["ww",2],"wo","week"),J("W",["WW",2],"Wo","isoWeek"),B("week","w"),B("isoWeek","W"),P("w",Yc),P("ww",Yc,Uc),P("W",Yc),P("WW",Yc,Uc),T(["w","ww","W","WW"],function(a,b,c,d){b[d.substr(0,1)]=s(a)});var wd={dow:0,doy:6};J("DDD",["DDDD",3],"DDDo","dayOfYear"),B("dayOfYear","DDD"),P("DDD",Zc),P("DDDD",Vc),S(["DDD","DDDD"],function(a,b,c){c._dayOfYear=s(a)}),c.ISO_8601=function(){};var xd=ca("moment().min is deprecated, use moment.min instead. https://github.com/moment/moment/issues/1548",function(){var a=Fa.apply(null,arguments);return a<this?this:a}),yd=ca("moment().max is deprecated, use moment.max instead. https://github.com/moment/moment/issues/1548",function(){var a=Fa.apply(null,arguments);return a>this?this:a});La("Z",":"),La("ZZ",""),P("Z",cd),P("ZZ",cd),S(["Z","ZZ"],function(a,b,c){c._useUTC=!0,c._tzm=Ma(a)});var zd=/([\+\-]|\d\d)/gi;c.updateOffset=function(){};var Ad=/(\-)?(?:(\d*)\.)?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?)?/,Bd=/^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/;$a.fn=Ja.prototype;var Cd=cb(1,"add"),Dd=cb(-1,"subtract");c.defaultFormat="YYYY-MM-DDTHH:mm:ssZ";var Ed=ca("moment().lang() is deprecated. Instead, use moment().localeData() to get the language configuration. Use moment().locale() to change languages.",function(a){return void 0===a?this.localeData():this.locale(a)});J(0,["gg",2],0,function(){return this.weekYear()%100}),J(0,["GG",2],0,function(){return this.isoWeekYear()%100}),Fb("gggg","weekYear"),Fb("ggggg","weekYear"),Fb("GGGG","isoWeekYear"),Fb("GGGGG","isoWeekYear"),B("weekYear","gg"),B("isoWeekYear","GG"),P("G",bd),P("g",bd),P("GG",Yc,Uc),P("gg",Yc,Uc),P("GGGG",$c,Wc),P("gggg",$c,Wc),P("GGGGG",_c,Xc),P("ggggg",_c,Xc),T(["gggg","ggggg","GGGG","GGGGG"],function(a,b,c,d){b[d.substr(0,2)]=s(a)}),T(["gg","GG"],function(a,b,d,e){b[e]=c.parseTwoDigitYear(a)}),J("Q",0,0,"quarter"),B("quarter","Q"),P("Q",Tc),S("Q",function(a,b){b[id]=3*(s(a)-1)}),J("D",["DD",2],"Do","date"),B("date","D"),P("D",Yc),P("DD",Yc,Uc),P("Do",function(a,b){return a?b._ordinalParse:b._ordinalParseLenient}),S(["D","DD"],jd),S("Do",function(a,b){b[jd]=s(a.match(Yc)[0],10)});var Fd=E("Date",!0);J("d",0,"do","day"),J("dd",0,0,function(a){return this.localeData().weekdaysMin(this,a)}),J("ddd",0,0,function(a){return this.localeData().weekdaysShort(this,a)}),J("dddd",0,0,function(a){return this.localeData().weekdays(this,a)}),J("e",0,0,"weekday"),J("E",0,0,"isoWeekday"),B("day","d"),B("weekday","e"),B("isoWeekday","E"),P("d",Yc),P("e",Yc),P("E",Yc),P("dd",ed),P("ddd",ed),P("dddd",ed),T(["dd","ddd","dddd"],function(a,b,c){var d=c._locale.weekdaysParse(a);null!=d?b.d=d:l(c).invalidWeekday=a}),T(["d","e","E"],function(a,b,c,d){b[d]=s(a)});var Gd="Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),Hd="Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),Id="Su_Mo_Tu_We_Th_Fr_Sa".split("_");J("H",["HH",2],0,"hour"),J("h",["hh",2],0,function(){return this.hours()%12||12}),Ub("a",!0),Ub("A",!1),B("hour","h"),P("a",Vb),P("A",Vb),P("H",Yc),P("h",Yc),P("HH",Yc,Uc),P("hh",Yc,Uc),S(["H","HH"],kd),S(["a","A"],function(a,b,c){c._isPm=c._locale.isPM(a),c._meridiem=a}),S(["h","hh"],function(a,b,c){b[kd]=s(a),l(c).bigHour=!0});var Jd=/[ap]\.?m?\.?/i,Kd=E("Hours",!0);J("m",["mm",2],0,"minute"),B("minute","m"),P("m",Yc),P("mm",Yc,Uc),S(["m","mm"],ld);var Ld=E("Minutes",!1);J("s",["ss",2],0,"second"),B("second","s"),P("s",Yc),P("ss",Yc,Uc),S(["s","ss"],md);var Md=E("Seconds",!1);J("S",0,0,function(){return~~(this.millisecond()/100)}),J(0,["SS",2],0,function(){return~~(this.millisecond()/10)}),J(0,["SSS",3],0,"millisecond"),J(0,["SSSS",4],0,function(){return 10*this.millisecond()}),J(0,["SSSSS",5],0,function(){return 100*this.millisecond()}),J(0,["SSSSSS",6],0,function(){return 1e3*this.millisecond()}),J(0,["SSSSSSS",7],0,function(){return 1e4*this.millisecond()}),J(0,["SSSSSSSS",8],0,function(){return 1e5*this.millisecond()}),J(0,["SSSSSSSSS",9],0,function(){return 1e6*this.millisecond()}),B("millisecond","ms"),P("S",Zc,Tc),P("SS",Zc,Uc),P("SSS",Zc,Vc);var Nd;for(Nd="SSSS";Nd.length<=9;Nd+="S")P(Nd,ad);for(Nd="S";Nd.length<=9;Nd+="S")S(Nd,Yb);var Od=E("Milliseconds",!1);J("z",0,0,"zoneAbbr"),J("zz",0,0,"zoneName");var Pd=p.prototype;Pd.add=Cd,Pd.calendar=eb,Pd.clone=fb,Pd.diff=kb,Pd.endOf=wb,Pd.format=ob,Pd.from=pb,Pd.fromNow=qb,Pd.to=rb,Pd.toNow=sb,Pd.get=H,Pd.invalidAt=Eb,Pd.isAfter=gb,Pd.isBefore=hb,Pd.isBetween=ib,Pd.isSame=jb,Pd.isValid=Cb,Pd.lang=Ed,Pd.locale=tb,Pd.localeData=ub,Pd.max=yd,Pd.min=xd,Pd.parsingFlags=Db,Pd.set=H,Pd.startOf=vb,Pd.subtract=Dd,Pd.toArray=Ab,Pd.toObject=Bb,Pd.toDate=zb,Pd.toISOString=nb,Pd.toJSON=nb,Pd.toString=mb,Pd.unix=yb,Pd.valueOf=xb,Pd.year=vd,Pd.isLeapYear=ka,Pd.weekYear=Hb,Pd.isoWeekYear=Ib,Pd.quarter=Pd.quarters=Lb,Pd.month=$,Pd.daysInMonth=_,Pd.week=Pd.weeks=pa,Pd.isoWeek=Pd.isoWeeks=qa,Pd.weeksInYear=Kb,Pd.isoWeeksInYear=Jb,Pd.date=Fd,Pd.day=Pd.days=Rb,Pd.weekday=Sb,Pd.isoWeekday=Tb,Pd.dayOfYear=sa,Pd.hour=Pd.hours=Kd,Pd.minute=Pd.minutes=Ld,Pd.second=Pd.seconds=Md,Pd.millisecond=Pd.milliseconds=Od,Pd.utcOffset=Pa,Pd.utc=Ra,Pd.local=Sa,Pd.parseZone=Ta,Pd.hasAlignedHourOffset=Ua,Pd.isDST=Va,Pd.isDSTShifted=Wa,Pd.isLocal=Xa,Pd.isUtcOffset=Ya,Pd.isUtc=Za,Pd.isUTC=Za,Pd.zoneAbbr=Zb,Pd.zoneName=$b,Pd.dates=ca("dates accessor is deprecated. Use date instead.",Fd),Pd.months=ca("months accessor is deprecated. Use month instead",$),Pd.years=ca("years accessor is deprecated. Use year instead",vd),Pd.zone=ca("moment().zone is deprecated, use moment().utcOffset instead. https://github.com/moment/moment/issues/1779",Qa);var Qd=Pd,Rd={sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},Sd={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"},Td="Invalid date",Ud="%d",Vd=/\d{1,2}/,Wd={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},Xd=u.prototype;Xd._calendar=Rd,Xd.calendar=bc,Xd._longDateFormat=Sd,Xd.longDateFormat=cc,Xd._invalidDate=Td,Xd.invalidDate=dc,Xd._ordinal=Ud,Xd.ordinal=ec,Xd._ordinalParse=Vd,Xd.preparse=fc,Xd.postformat=fc,Xd._relativeTime=Wd,Xd.relativeTime=gc,Xd.pastFuture=hc,Xd.set=ic,Xd.months=W,Xd._months=od,Xd.monthsShort=X,Xd._monthsShort=pd,Xd.monthsParse=Y,Xd.week=ma,Xd._week=wd,Xd.firstDayOfYear=oa,Xd.firstDayOfWeek=na,Xd.weekdays=Nb,Xd._weekdays=Gd,Xd.weekdaysMin=Pb,Xd._weekdaysMin=Id,Xd.weekdaysShort=Ob,Xd._weekdaysShort=Hd,Xd.weekdaysParse=Qb,Xd.isPM=Wb,Xd._meridiemParse=Jd,Xd.meridiem=Xb,y("en",{ordinalParse:/\d{1,2}(th|st|nd|rd)/,ordinal:function(a){var b=a%10,c=1===s(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return a+c}}),c.lang=ca("moment.lang is deprecated. Use moment.locale instead.",y),c.langData=ca("moment.langData is deprecated. Use moment.localeData instead.",A);var Yd=Math.abs,Zd=Ac("ms"),$d=Ac("s"),_d=Ac("m"),ae=Ac("h"),be=Ac("d"),ce=Ac("w"),de=Ac("M"),ee=Ac("y"),fe=Cc("milliseconds"),ge=Cc("seconds"),he=Cc("minutes"),ie=Cc("hours"),je=Cc("days"),ke=Cc("months"),le=Cc("years"),me=Math.round,ne={s:45,m:45,h:22,d:26,M:11},oe=Math.abs,pe=Ja.prototype;pe.abs=qc,pe.add=sc,pe.subtract=tc,pe.as=yc,pe.asMilliseconds=Zd,pe.asSeconds=$d,pe.asMinutes=_d,pe.asHours=ae,pe.asDays=be,pe.asWeeks=ce,pe.asMonths=de,pe.asYears=ee,pe.valueOf=zc,pe._bubble=vc,pe.get=Bc,pe.milliseconds=fe,pe.seconds=ge,pe.minutes=he,pe.hours=ie,pe.days=je,pe.weeks=Dc,pe.months=ke,pe.years=le,pe.humanize=Hc,pe.toISOString=Ic,pe.toString=Ic,pe.toJSON=Ic,pe.locale=tb,pe.localeData=ub,pe.toIsoString=ca("toIsoString() is deprecated. Please use toISOString() instead (notice the capitals)",Ic),pe.lang=Ed,J("X",0,0,"unix"),J("x",0,0,"valueOf"),P("x",bd),P("X",dd),S("X",function(a,b,c){c._d=new Date(1e3*parseFloat(a,10))}),S("x",function(a,b,c){c._d=new Date(s(a))}),c.version="2.10.6",d(Fa),c.fn=Qd,c.min=Ha,c.max=Ia,c.utc=j,c.unix=_b,c.months=lc,c.isDate=f,c.locale=y,c.invalid=n,c.duration=$a,c.isMoment=q,c.weekdays=nc,c.parseZone=ac,c.localeData=A,c.isDuration=Ka,c.monthsShort=mc,c.weekdaysMin=pc,c.defineLocale=z,c.weekdaysShort=oc,c.normalizeUnits=C,c.relativeTimeThreshold=Gc;var qe=c;return qe})},{}],532:[function(a,b,c){(function(a){function b(a,b){for(var c=0,d=a.length-1;d>=0;d--){var e=a[d];"."===e?a.splice(d,1):".."===e?(a.splice(d,1),c++):c&&(a.splice(d,1),c--)}if(b)for(;c--;c)a.unshift("..");return a}function d(a,b){if(a.filter)return a.filter(b);for(var c=[],d=0;d<a.length;d++)b(a[d],d,a)&&c.push(a[d]);return c}var e=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,f=function(a){return e.exec(a).slice(1)};c.resolve=function(){for(var c="",e=!1,f=arguments.length-1;f>=-1&&!e;f--){
var g=f>=0?arguments[f]:a.cwd();if("string"!=typeof g)throw new TypeError("Arguments to path.resolve must be strings");g&&(c=g+"/"+c,e="/"===g.charAt(0))}return c=b(d(c.split("/"),function(a){return!!a}),!e).join("/"),(e?"/":"")+c||"."},c.normalize=function(a){var e=c.isAbsolute(a),f="/"===g(a,-1);return a=b(d(a.split("/"),function(a){return!!a}),!e).join("/"),a||e||(a="."),a&&f&&(a+="/"),(e?"/":"")+a},c.isAbsolute=function(a){return"/"===a.charAt(0)},c.join=function(){var a=Array.prototype.slice.call(arguments,0);return c.normalize(d(a,function(a,b){if("string"!=typeof a)throw new TypeError("Arguments to path.join must be strings");return a}).join("/"))},c.relative=function(a,b){function d(a){for(var b=0;b<a.length&&""===a[b];b++);for(var c=a.length-1;c>=0&&""===a[c];c--);return b>c?[]:a.slice(b,c-b+1)}a=c.resolve(a).substr(1),b=c.resolve(b).substr(1);for(var e=d(a.split("/")),f=d(b.split("/")),g=Math.min(e.length,f.length),h=g,i=0;i<g;i++)if(e[i]!==f[i]){h=i;break}for(var j=[],i=h;i<e.length;i++)j.push("..");return j=j.concat(f.slice(h)),j.join("/")},c.sep="/",c.delimiter=":",c.dirname=function(a){var b=f(a),c=b[0],d=b[1];return c||d?(d&&(d=d.substr(0,d.length-1)),c+d):"."},c.basename=function(a,b){var c=f(a)[2];return b&&c.substr(-1*b.length)===b&&(c=c.substr(0,c.length-b.length)),c},c.extname=function(a){return f(a)[3]};var g="b"==="ab".substr(-1)?function(a,b,c){return a.substr(b,c)}:function(a,b,c){return b<0&&(b=a.length+b),a.substr(b,c)}}).call(this,a("_process"))},{_process:556}],533:[function(a,b,c){"use strict";b.exports=a("./src/js/main")},{"./src/js/main":539}],534:[function(a,b,c){"use strict";function d(a,b){var c=a.className.split(" ");c.indexOf(b)<0&&c.push(b),a.className=c.join(" ")}function e(a,b){var c=a.className.split(" "),d=c.indexOf(b);d>=0&&c.splice(d,1),a.className=c.join(" ")}c.add=function(a,b){a.classList?a.classList.add(b):d(a,b)},c.remove=function(a,b){a.classList?a.classList.remove(b):e(a,b)},c.list=function(a){return a.classList?Array.prototype.slice.apply(a.classList):a.className.split(" ")}},{}],535:[function(a,b,c){"use strict";function d(a,b){return window.getComputedStyle(a)[b]}function e(a,b,c){return"number"==typeof c&&(c=c.toString()+"px"),a.style[b]=c,a}function f(a,b){for(var c in b){var d=b[c];"number"==typeof d&&(d=d.toString()+"px"),a.style[c]=d}return a}var g={};g.e=function(a,b){var c=document.createElement(a);return c.className=b,c},g.appendTo=function(a,b){return b.appendChild(a),a},g.css=function(a,b,c){return"object"==typeof b?f(a,b):"undefined"==typeof c?d(a,b):e(a,b,c)},g.matches=function(a,b){return"undefined"!=typeof a.matches?a.matches(b):"undefined"!=typeof a.matchesSelector?a.matchesSelector(b):"undefined"!=typeof a.webkitMatchesSelector?a.webkitMatchesSelector(b):"undefined"!=typeof a.mozMatchesSelector?a.mozMatchesSelector(b):"undefined"!=typeof a.msMatchesSelector?a.msMatchesSelector(b):void 0},g.remove=function(a){"undefined"!=typeof a.remove?a.remove():a.parentNode&&a.parentNode.removeChild(a)},g.queryChildren=function(a,b){return Array.prototype.filter.call(a.childNodes,function(a){return g.matches(a,b)})},b.exports=g},{}],536:[function(a,b,c){"use strict";var d=function(a){this.element=a,this.events={}};d.prototype.bind=function(a,b){"undefined"==typeof this.events[a]&&(this.events[a]=[]),this.events[a].push(b),this.element.addEventListener(a,b,!1)},d.prototype.unbind=function(a,b){var c="undefined"!=typeof b;this.events[a]=this.events[a].filter(function(d){return!(!c||d===b)||(this.element.removeEventListener(a,d,!1),!1)},this)},d.prototype.unbindAll=function(){for(var a in this.events)this.unbind(a)};var e=function(){this.eventElements=[]};e.prototype.eventElement=function(a){var b=this.eventElements.filter(function(b){return b.element===a})[0];return"undefined"==typeof b&&(b=new d(a),this.eventElements.push(b)),b},e.prototype.bind=function(a,b,c){this.eventElement(a).bind(b,c)},e.prototype.unbind=function(a,b,c){this.eventElement(a).unbind(b,c)},e.prototype.unbindAll=function(){for(var a=0;a<this.eventElements.length;a++)this.eventElements[a].unbindAll()},e.prototype.once=function(a,b,c){var d=this.eventElement(a),e=function(a){d.unbind(b,e),c(a)};d.bind(b,e)},b.exports=e},{}],537:[function(a,b,c){"use strict";b.exports=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}()},{}],538:[function(a,b,c){"use strict";var d=a("./class"),e=a("./dom"),f=c.toInt=function(a){return parseInt(a,10)||0},g=c.clone=function(a){if(a){if(Array.isArray(a))return a.map(g);if("object"==typeof a){var b={};for(var c in a)b[c]=g(a[c]);return b}return a}return null};c.debounce=function(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,c||a.apply(e,f)},h=c&&!d;clearTimeout(d),d=setTimeout(g,b),h&&a.apply(e,f)}},c.extend=function(a,b){var c=g(a);for(var d in b)c[d]=g(b[d]);return c},c.isEditable=function(a){return e.matches(a,"input,[contenteditable]")||e.matches(a,"select,[contenteditable]")||e.matches(a,"textarea,[contenteditable]")||e.matches(a,"button,[contenteditable]")},c.removePsClasses=function(a){for(var b=d.list(a),c=0;c<b.length;c++){var e=b[c];0===e.indexOf("ps-")&&d.remove(a,e)}},c.outerWidth=function(a){return f(e.css(a,"width"))+f(e.css(a,"paddingLeft"))+f(e.css(a,"paddingRight"))+f(e.css(a,"borderLeftWidth"))+f(e.css(a,"borderRightWidth"))},c.startScrolling=function(a,b){d.add(a,"ps-in-scrolling"),"undefined"!=typeof b?d.add(a,"ps-"+b):(d.add(a,"ps-x"),d.add(a,"ps-y"))},c.stopScrolling=function(a,b){d.remove(a,"ps-in-scrolling"),"undefined"!=typeof b?d.remove(a,"ps-"+b):(d.remove(a,"ps-x"),d.remove(a,"ps-y"))},c.env={isWebKit:"WebkitAppearance"in document.documentElement.style,supportsTouch:"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch,supportsIePointer:null!==window.navigator.msMaxTouchPoints}},{"./class":534,"./dom":535}],539:[function(a,b,c){"use strict";var d=a("./plugin/destroy"),e=a("./plugin/initialize"),f=a("./plugin/update");b.exports={initialize:e,update:f,destroy:d}},{"./plugin/destroy":542,"./plugin/initialize":550,"./plugin/update":555}],540:[function(a,b,c){"use strict";var d=a("./update"),e=window.MutationObserver,f=a("./instances"),g=function(a){var b=document.createEvent("Event");return b.initEvent(a,!0,!0),b};b.exports=function(a){if(null!==e&&void 0!==e){var b=f.get(a),c=function(){d(a),a.dispatchEvent(g("ps-dom-change"))};b.observer=new e(c),c();var h={childList:!0,subtree:!0};b.observer.observe(a,h)}}},{"./instances":551,"./update":555}],541:[function(a,b,c){"use strict";b.exports={handlers:["click-rail","drag-scrollbar","keyboard","wheel","touch"],maxScrollbarLength:null,minScrollbarLength:null,scrollXMarginOffset:0,scrollYMarginOffset:0,suppressScrollX:!1,suppressScrollY:!1,swipePropagation:!0,useBothWheelAxes:!1,wheelPropagation:!1,wheelSpeed:1,theme:"default",autoupdate:!0}},{}],542:[function(a,b,c){"use strict";var d=a("../lib/helper"),e=a("../lib/dom"),f=a("./instances");b.exports=function(a){var b=f.get(a);b&&(b.observer&&b.observer.disconnect(),b.event.unbindAll(),e.remove(b.scrollbarX),e.remove(b.scrollbarY),e.remove(b.scrollbarXRail),e.remove(b.scrollbarYRail),d.removePsClasses(a),f.remove(a))}},{"../lib/dom":535,"../lib/helper":538,"./instances":551}],543:[function(a,b,c){"use strict";function d(a,b){function c(a){return a.getBoundingClientRect()}var d=function(a){a.stopPropagation()};b.event.bind(b.scrollbarY,"click",d),b.event.bind(b.scrollbarYRail,"click",function(d){var e=d.pageY-window.pageYOffset-c(b.scrollbarYRail).top,h=e>b.scrollbarYTop?1:-1;g(a,"top",a.scrollTop+h*b.containerHeight),f(a),d.stopPropagation()}),b.event.bind(b.scrollbarX,"click",d),b.event.bind(b.scrollbarXRail,"click",function(d){var e=d.pageX-window.pageXOffset-c(b.scrollbarXRail).left,h=e>b.scrollbarXLeft?1:-1;g(a,"left",a.scrollLeft+h*b.containerWidth),f(a),d.stopPropagation()})}var e=a("../instances"),f=a("../update-geometry"),g=a("../update-scroll");b.exports=function(a){var b=e.get(a);d(a,b)}},{"../instances":551,"../update-geometry":553,"../update-scroll":554}],544:[function(a,b,c){"use strict";function d(a,b){function c(c){var e=d+c*b.railXRatio,g=Math.max(0,b.scrollbarXRail.getBoundingClientRect().left)+b.railXRatio*(b.railXWidth-b.scrollbarXWidth);e<0?b.scrollbarXLeft=0:e>g?b.scrollbarXLeft=g:b.scrollbarXLeft=e;var h=f.toInt(b.scrollbarXLeft*(b.contentWidth-b.containerWidth)/(b.containerWidth-b.railXRatio*b.scrollbarXWidth))-b.negativeScrollAdjustment;j(a,"left",h)}var d=null,e=null,h=function(b){c(b.pageX-e),i(a),b.stopPropagation(),b.preventDefault()},k=function(){f.stopScrolling(a,"x"),b.event.unbind(b.ownerDocument,"mousemove",h)};b.event.bind(b.scrollbarX,"mousedown",function(c){e=c.pageX,d=f.toInt(g.css(b.scrollbarX,"left"))*b.railXRatio,f.startScrolling(a,"x"),b.event.bind(b.ownerDocument,"mousemove",h),b.event.once(b.ownerDocument,"mouseup",k),c.stopPropagation(),c.preventDefault()})}function e(a,b){function c(c){var e=d+c*b.railYRatio,g=Math.max(0,b.scrollbarYRail.getBoundingClientRect().top)+b.railYRatio*(b.railYHeight-b.scrollbarYHeight);e<0?b.scrollbarYTop=0:e>g?b.scrollbarYTop=g:b.scrollbarYTop=e;var h=f.toInt(b.scrollbarYTop*(b.contentHeight-b.containerHeight)/(b.containerHeight-b.railYRatio*b.scrollbarYHeight));j(a,"top",h)}var d=null,e=null,h=function(b){c(b.pageY-e),i(a),b.stopPropagation(),b.preventDefault()},k=function(){f.stopScrolling(a,"y"),b.event.unbind(b.ownerDocument,"mousemove",h)};b.event.bind(b.scrollbarY,"mousedown",function(c){e=c.pageY,d=f.toInt(g.css(b.scrollbarY,"top"))*b.railYRatio,f.startScrolling(a,"y"),b.event.bind(b.ownerDocument,"mousemove",h),b.event.once(b.ownerDocument,"mouseup",k),c.stopPropagation(),c.preventDefault()})}var f=a("../../lib/helper"),g=a("../../lib/dom"),h=a("../instances"),i=a("../update-geometry"),j=a("../update-scroll");b.exports=function(a){var b=h.get(a);d(a,b),e(a,b)}},{"../../lib/dom":535,"../../lib/helper":538,"../instances":551,"../update-geometry":553,"../update-scroll":554}],545:[function(a,b,c){"use strict";function d(a,b){function c(c,d){var e=a.scrollTop;if(0===c){if(!b.scrollbarYActive)return!1;if(0===e&&d>0||e>=b.contentHeight-b.containerHeight&&d<0)return!b.settings.wheelPropagation}var f=a.scrollLeft;if(0===d){if(!b.scrollbarXActive)return!1;if(0===f&&c<0||f>=b.contentWidth-b.containerWidth&&c>0)return!b.settings.wheelPropagation}return!0}var d=!1;b.event.bind(a,"mouseenter",function(){d=!0}),b.event.bind(a,"mouseleave",function(){d=!1});var g=!1;b.event.bind(b.ownerDocument,"keydown",function(j){if(!(j.isDefaultPrevented&&j.isDefaultPrevented()||j.defaultPrevented)){var k=f.matches(b.scrollbarX,":focus")||f.matches(b.scrollbarY,":focus");if(d||k){var l=document.activeElement?document.activeElement:b.ownerDocument.activeElement;if(l){if("IFRAME"===l.tagName)l=l.contentDocument.activeElement;else for(;l.shadowRoot;)l=l.shadowRoot.activeElement;if(e.isEditable(l))return}var m=0,n=0;switch(j.which){case 37:m=j.metaKey?-b.contentWidth:j.altKey?-b.containerWidth:-30;break;case 38:n=j.metaKey?b.contentHeight:j.altKey?b.containerHeight:30;break;case 39:m=j.metaKey?b.contentWidth:j.altKey?b.containerWidth:30;break;case 40:n=j.metaKey?-b.contentHeight:j.altKey?-b.containerHeight:-30;break;case 33:n=90;break;case 32:n=j.shiftKey?90:-90;break;case 34:n=-90;break;case 35:n=j.ctrlKey?-b.contentHeight:-b.containerHeight;break;case 36:n=j.ctrlKey?a.scrollTop:b.containerHeight;break;default:return}i(a,"top",a.scrollTop-n),i(a,"left",a.scrollLeft+m),h(a),g=c(m,n),g&&j.preventDefault()}}})}var e=a("../../lib/helper"),f=a("../../lib/dom"),g=a("../instances"),h=a("../update-geometry"),i=a("../update-scroll");b.exports=function(a){var b=g.get(a);d(a,b)}},{"../../lib/dom":535,"../../lib/helper":538,"../instances":551,"../update-geometry":553,"../update-scroll":554}],546:[function(a,b,c){"use strict";function d(a,b){function c(c,d){var e=a.scrollTop;if(0===c){if(!b.scrollbarYActive)return!1;if(0===e&&d>0||e>=b.contentHeight-b.containerHeight&&d<0)return!b.settings.wheelPropagation}var f=a.scrollLeft;if(0===d){if(!b.scrollbarXActive)return!1;if(0===f&&c<0||f>=b.contentWidth-b.containerWidth&&c>0)return!b.settings.wheelPropagation}return!0}function d(a){var b=a.deltaX,c=-1*a.deltaY;return"undefined"!=typeof b&&"undefined"!=typeof c||(b=-1*a.wheelDeltaX/6,c=a.wheelDeltaY/6),a.deltaMode&&1===a.deltaMode&&(b*=10,c*=10),b!==b&&c!==c&&(b=0,c=a.wheelDelta),a.shiftKey?[-c,-b]:[b,c]}function e(b,c){var d=a.querySelector("textarea:hover, select[multiple]:hover, .ps-child:hover");if(d){if(!window.getComputedStyle(d).overflow.match(/(scroll|auto)/))return!1;var e=d.scrollHeight-d.clientHeight;if(e>0&&!(0===d.scrollTop&&c>0||d.scrollTop===e&&c<0))return!0;var f=d.scrollLeft-d.clientWidth;if(f>0&&!(0===d.scrollLeft&&b<0||d.scrollLeft===f&&b>0))return!0}return!1}function h(h){var j=d(h),k=j[0],l=j[1];e(k,l)||(i=!1,b.settings.useBothWheelAxes?b.scrollbarYActive&&!b.scrollbarXActive?(l?g(a,"top",a.scrollTop-l*b.settings.wheelSpeed):g(a,"top",a.scrollTop+k*b.settings.wheelSpeed),i=!0):b.scrollbarXActive&&!b.scrollbarYActive&&(k?g(a,"left",a.scrollLeft+k*b.settings.wheelSpeed):g(a,"left",a.scrollLeft-l*b.settings.wheelSpeed),i=!0):(g(a,"top",a.scrollTop-l*b.settings.wheelSpeed),g(a,"left",a.scrollLeft+k*b.settings.wheelSpeed)),f(a),i=i||c(k,l),i&&(h.stopPropagation(),h.preventDefault()))}var i=!1;"undefined"!=typeof window.onwheel?b.event.bind(a,"wheel",h):"undefined"!=typeof window.onmousewheel&&b.event.bind(a,"mousewheel",h)}var e=a("../instances"),f=a("../update-geometry"),g=a("../update-scroll");b.exports=function(a){var b=e.get(a);d(a,b)}},{"../instances":551,"../update-geometry":553,"../update-scroll":554}],547:[function(a,b,c){"use strict";function d(a,b){b.event.bind(a,"scroll",function(){f(a)})}var e=a("../instances"),f=a("../update-geometry");b.exports=function(a){var b=e.get(a);d(a,b)}},{"../instances":551,"../update-geometry":553}],548:[function(a,b,c){"use strict";function d(a,b){function c(){var a=window.getSelection?window.getSelection():document.getSelection?document.getSelection():"";return 0===a.toString().length?null:a.getRangeAt(0).commonAncestorContainer}function d(){j||(j=setInterval(function(){return f.get(a)?(h(a,"top",a.scrollTop+k.top),h(a,"left",a.scrollLeft+k.left),void g(a)):void clearInterval(j)},50))}function i(){j&&(clearInterval(j),j=null),e.stopScrolling(a)}var j=null,k={top:0,left:0},l=!1;b.event.bind(b.ownerDocument,"selectionchange",function(){a.contains(c())?l=!0:(l=!1,i())}),b.event.bind(window,"mouseup",function(){l&&(l=!1,i())}),b.event.bind(window,"keyup",function(){l&&(l=!1,i())}),b.event.bind(window,"mousemove",function(b){if(l){var c={x:b.pageX,y:b.pageY},f={left:a.offsetLeft,right:a.offsetLeft+a.offsetWidth,top:a.offsetTop,bottom:a.offsetTop+a.offsetHeight};c.x<f.left+3?(k.left=-5,e.startScrolling(a,"x")):c.x>f.right-3?(k.left=5,e.startScrolling(a,"x")):k.left=0,c.y<f.top+3?(f.top+3-c.y<5?k.top=-5:k.top=-20,e.startScrolling(a,"y")):c.y>f.bottom-3?(c.y-f.bottom+3<5?k.top=5:k.top=20,e.startScrolling(a,"y")):k.top=0,0===k.top&&0===k.left?i():d()}})}var e=a("../../lib/helper"),f=a("../instances"),g=a("../update-geometry"),h=a("../update-scroll");b.exports=function(a){var b=f.get(a);d(a,b)}},{"../../lib/helper":538,"../instances":551,"../update-geometry":553,"../update-scroll":554}],549:[function(a,b,c){"use strict";function d(a,b,c,d){function e(c,d){var e=a.scrollTop,f=a.scrollLeft,g=Math.abs(c),h=Math.abs(d);if(h>g){if(d<0&&e===b.contentHeight-b.containerHeight||d>0&&0===e)return!b.settings.swipePropagation}else if(g>h&&(c<0&&f===b.contentWidth-b.containerWidth||c>0&&0===f))return!b.settings.swipePropagation;return!0}function i(b,c){h(a,"top",a.scrollTop-c),h(a,"left",a.scrollLeft-b),g(a)}function j(){u=!0}function k(){u=!1}function l(a){return a.targetTouches?a.targetTouches[0]:a}function m(a){return!(!a.targetTouches||1!==a.targetTouches.length)||!(!a.pointerType||"mouse"===a.pointerType||a.pointerType===a.MSPOINTER_TYPE_MOUSE)}function n(a){if(m(a)){v=!0;var b=l(a);q.pageX=b.pageX,q.pageY=b.pageY,r=(new Date).getTime(),null!==t&&clearInterval(t),a.stopPropagation()}}function o(a){var c=a.target,d=c&&c.getAttribute&&c.getAttribute("class")||"";if(!d.match(/ps-prevent-touchmove/)&&(!v&&b.settings.swipePropagation&&n(a),!u&&v&&m(a))){var f=l(a),g={pageX:f.pageX,pageY:f.pageY},h=g.pageX-q.pageX,j=g.pageY-q.pageY;i(h,j),q=g;var k=(new Date).getTime(),o=k-r;o>0&&(s.x=h/o,s.y=j/o,r=k),e(h,j)&&(a.stopPropagation(),a.preventDefault())}}function p(){!u&&v&&(v=!1,clearInterval(t),t=setInterval(function(){return f.get(a)&&(s.x||s.y)?Math.abs(s.x)<.01&&Math.abs(s.y)<.01?void clearInterval(t):(i(30*s.x,30*s.y),s.x*=.8,void(s.y*=.8)):void clearInterval(t)},10))}var q={},r=0,s={},t=null,u=!1,v=!1;c?(b.event.bind(window,"touchstart",j),b.event.bind(window,"touchend",k),b.event.bind(a,"touchstart",n),b.event.bind(a,"touchmove",o),b.event.bind(a,"touchend",p)):d&&(window.PointerEvent?(b.event.bind(window,"pointerdown",j),b.event.bind(window,"pointerup",k),b.event.bind(a,"pointerdown",n),b.event.bind(a,"pointermove",o),b.event.bind(a,"pointerup",p)):window.MSPointerEvent&&(b.event.bind(window,"MSPointerDown",j),b.event.bind(window,"MSPointerUp",k),b.event.bind(a,"MSPointerDown",n),b.event.bind(a,"MSPointerMove",o),b.event.bind(a,"MSPointerUp",p)))}var e=a("../../lib/helper"),f=a("../instances"),g=a("../update-geometry"),h=a("../update-scroll");b.exports=function(a){if(e.env.supportsTouch||e.env.supportsIePointer){var b=f.get(a);d(a,b,e.env.supportsTouch,e.env.supportsIePointer)}}},{"../../lib/helper":538,"../instances":551,"../update-geometry":553,"../update-scroll":554}],550:[function(a,b,c){"use strict";var d=a("../lib/helper"),e=a("../lib/class"),f=a("./instances"),g=a("./update-geometry"),h=a("./autoupdate"),i=a("./resizer"),j={"click-rail":a("./handler/click-rail"),"drag-scrollbar":a("./handler/drag-scrollbar"),keyboard:a("./handler/keyboard"),wheel:a("./handler/mouse-wheel"),touch:a("./handler/touch"),selection:a("./handler/selection")},k=a("./handler/native-scroll");b.exports=function(a,b){b="object"==typeof b?b:{},e.add(a,"ps-container");var c=f.add(a);c.settings=d.extend(c.settings,b),e.add(a,"ps-theme-"+c.settings.theme),c.settings.handlers.forEach(function(b){j[b](a)}),k(a),g(a),c.settings.autoupdate&&(h(a),i(a))}},{"../lib/class":534,"../lib/helper":538,"./autoupdate":540,"./handler/click-rail":543,"./handler/drag-scrollbar":544,"./handler/keyboard":545,"./handler/mouse-wheel":546,"./handler/native-scroll":547,"./handler/selection":548,"./handler/touch":549,"./instances":551,"./resizer":552,"./update-geometry":553}],551:[function(a,b,c){"use strict";function d(a){function b(){i.add(a,"ps-focus")}function c(){i.remove(a,"ps-focus")}var d=this;d.settings=h.clone(j),d.containerWidth=null,d.containerHeight=null,d.contentWidth=null,d.contentHeight=null,d.isRtl="rtl"===k.css(a,"direction"),d.isNegativeScroll=function(){var b=a.scrollLeft,c=null;return a.scrollLeft=-1,c=a.scrollLeft<0,a.scrollLeft=b,c}(),d.negativeScrollAdjustment=d.isNegativeScroll?a.scrollWidth-a.clientWidth:0,d.event=new l,d.ownerDocument=a.ownerDocument||document,d.scrollbarXRail=k.appendTo(k.e("div","ps-scrollbar-x-rail"),a),d.scrollbarX=k.appendTo(k.e("div","ps-scrollbar-x"),d.scrollbarXRail),d.scrollbarX.setAttribute("tabindex",0),d.event.bind(d.scrollbarX,"focus",b),d.event.bind(d.scrollbarX,"blur",c),d.scrollbarXActive=null,d.scrollbarXWidth=null,d.scrollbarXLeft=null,d.scrollbarXBottom=h.toInt(k.css(d.scrollbarXRail,"bottom")),d.isScrollbarXUsingBottom=d.scrollbarXBottom===d.scrollbarXBottom,d.scrollbarXTop=d.isScrollbarXUsingBottom?null:h.toInt(k.css(d.scrollbarXRail,"top")),d.railBorderXWidth=h.toInt(k.css(d.scrollbarXRail,"borderLeftWidth"))+h.toInt(k.css(d.scrollbarXRail,"borderRightWidth")),k.css(d.scrollbarXRail,"display","block"),d.railXMarginWidth=h.toInt(k.css(d.scrollbarXRail,"marginLeft"))+h.toInt(k.css(d.scrollbarXRail,"marginRight")),k.css(d.scrollbarXRail,"display",""),d.railXWidth=null,d.railXRatio=null,d.scrollbarYRail=k.appendTo(k.e("div","ps-scrollbar-y-rail"),a),d.scrollbarY=k.appendTo(k.e("div","ps-scrollbar-y"),d.scrollbarYRail),d.scrollbarY.setAttribute("tabindex",0),d.event.bind(d.scrollbarY,"focus",b),d.event.bind(d.scrollbarY,"blur",c),d.scrollbarYActive=null,d.scrollbarYHeight=null,d.scrollbarYTop=null,d.scrollbarYRight=h.toInt(k.css(d.scrollbarYRail,"right")),d.isScrollbarYUsingRight=d.scrollbarYRight===d.scrollbarYRight,d.scrollbarYLeft=d.isScrollbarYUsingRight?null:h.toInt(k.css(d.scrollbarYRail,"left")),d.scrollbarYOuterWidth=d.isRtl?h.outerWidth(d.scrollbarY):null,d.railBorderYWidth=h.toInt(k.css(d.scrollbarYRail,"borderTopWidth"))+h.toInt(k.css(d.scrollbarYRail,"borderBottomWidth")),k.css(d.scrollbarYRail,"display","block"),d.railYMarginHeight=h.toInt(k.css(d.scrollbarYRail,"marginTop"))+h.toInt(k.css(d.scrollbarYRail,"marginBottom")),k.css(d.scrollbarYRail,"display",""),d.railYHeight=null,d.railYRatio=null}function e(a){return a.getAttribute("data-ps-id")}function f(a,b){a.setAttribute("data-ps-id",b)}function g(a){a.removeAttribute("data-ps-id")}var h=a("../lib/helper"),i=a("../lib/class"),j=a("./default-setting"),k=a("../lib/dom"),l=a("../lib/event-manager"),m=a("../lib/guid"),n={};c.add=function(a){var b=m();return f(a,b),n[b]=new d(a),n[b]},c.remove=function(a){delete n[e(a)],g(a)},c.get=function(a){return n[e(a)]}},{"../lib/class":534,"../lib/dom":535,"../lib/event-manager":536,"../lib/guid":537,"../lib/helper":538,"./default-setting":541}],552:[function(a,b,c){"use strict";var d=a("./update"),e=a("./instances"),f=a("../lib/helper");b.exports=function(a){var b=e.get(a),c=function(){d(a)};b.event.bind(window,"resize",f.debounce(c,60))}},{"../lib/helper":538,"./instances":551,"./update":555}],553:[function(a,b,c){"use strict";function d(a,b){return a.settings.minScrollbarLength&&(b=Math.max(b,a.settings.minScrollbarLength)),a.settings.maxScrollbarLength&&(b=Math.min(b,a.settings.maxScrollbarLength)),b}function e(a,b){var c={width:b.railXWidth};b.isRtl?c.left=b.negativeScrollAdjustment+a.scrollLeft+b.containerWidth-b.contentWidth:c.left=a.scrollLeft,b.isScrollbarXUsingBottom?c.bottom=b.scrollbarXBottom-a.scrollTop:c.top=b.scrollbarXTop+a.scrollTop,h.css(b.scrollbarXRail,c);var d={top:a.scrollTop,height:b.railYHeight};b.isScrollbarYUsingRight?b.isRtl?d.right=b.contentWidth-(b.negativeScrollAdjustment+a.scrollLeft)-b.scrollbarYRight-b.scrollbarYOuterWidth:d.right=b.scrollbarYRight-a.scrollLeft:b.isRtl?d.left=b.negativeScrollAdjustment+a.scrollLeft+2*b.containerWidth-b.contentWidth-b.scrollbarYLeft-b.scrollbarYOuterWidth:d.left=b.scrollbarYLeft+a.scrollLeft,h.css(b.scrollbarYRail,d),h.css(b.scrollbarX,{left:b.scrollbarXLeft,width:b.scrollbarXWidth-b.railBorderXWidth}),h.css(b.scrollbarY,{top:b.scrollbarYTop,height:b.scrollbarYHeight-b.railBorderYWidth})}var f=a("../lib/helper"),g=a("../lib/class"),h=a("../lib/dom"),i=a("./instances"),j=a("./update-scroll");b.exports=function(a){var b=i.get(a);b.containerWidth=a.clientWidth,b.containerHeight=a.clientHeight,b.contentWidth=a.scrollWidth,b.contentHeight=a.scrollHeight;var c;a.contains(b.scrollbarXRail)||(c=h.queryChildren(a,".ps-scrollbar-x-rail"),c.length>0&&c.forEach(function(a){h.remove(a)}),h.appendTo(b.scrollbarXRail,a)),a.contains(b.scrollbarYRail)||(c=h.queryChildren(a,".ps-scrollbar-y-rail"),c.length>0&&c.forEach(function(a){h.remove(a)}),h.appendTo(b.scrollbarYRail,a)),!b.settings.suppressScrollX&&b.containerWidth+b.settings.scrollXMarginOffset<b.contentWidth?(b.scrollbarXActive=!0,b.railXWidth=b.containerWidth-b.railXMarginWidth,b.railXRatio=b.containerWidth/b.railXWidth,b.scrollbarXWidth=d(b,f.toInt(b.railXWidth*b.containerWidth/b.contentWidth)),b.scrollbarXLeft=f.toInt((b.negativeScrollAdjustment+a.scrollLeft)*(b.railXWidth-b.scrollbarXWidth)/(b.contentWidth-b.containerWidth))):b.scrollbarXActive=!1,!b.settings.suppressScrollY&&b.containerHeight+b.settings.scrollYMarginOffset<b.contentHeight?(b.scrollbarYActive=!0,b.railYHeight=b.containerHeight-b.railYMarginHeight,b.railYRatio=b.containerHeight/b.railYHeight,b.scrollbarYHeight=d(b,f.toInt(b.railYHeight*b.containerHeight/b.contentHeight)),b.scrollbarYTop=f.toInt(a.scrollTop*(b.railYHeight-b.scrollbarYHeight)/(b.contentHeight-b.containerHeight))):b.scrollbarYActive=!1,b.scrollbarXLeft>=b.railXWidth-b.scrollbarXWidth&&(b.scrollbarXLeft=b.railXWidth-b.scrollbarXWidth),b.scrollbarYTop>=b.railYHeight-b.scrollbarYHeight&&(b.scrollbarYTop=b.railYHeight-b.scrollbarYHeight),e(a,b),b.scrollbarXActive?g.add(a,"ps-active-x"):(g.remove(a,"ps-active-x"),b.scrollbarXWidth=0,b.scrollbarXLeft=0,j(a,"left",0)),b.scrollbarYActive?g.add(a,"ps-active-y"):(g.remove(a,"ps-active-y"),b.scrollbarYHeight=0,b.scrollbarYTop=0,j(a,"top",0))}},{"../lib/class":534,"../lib/dom":535,"../lib/helper":538,"./instances":551,"./update-scroll":554}],554:[function(a,b,c){"use strict";var d,e,f=a("./instances"),g=function(a){var b=document.createEvent("Event");return b.initEvent(a,!0,!0),b};b.exports=function(a,b,c){if("undefined"==typeof a)throw"You must provide an element to the update-scroll function";if("undefined"==typeof b)throw"You must provide an axis to the update-scroll function";if("undefined"==typeof c)throw"You must provide a value to the update-scroll function";"top"===b&&c<=0&&(a.scrollTop=c=0,a.dispatchEvent(g("ps-y-reach-start"))),"left"===b&&c<=0&&(a.scrollLeft=c=0,a.dispatchEvent(g("ps-x-reach-start")));var h=f.get(a);"top"===b&&c>=h.contentHeight-h.containerHeight&&(c=h.contentHeight-h.containerHeight,c-a.scrollTop<=1?c=a.scrollTop:a.scrollTop=c,a.dispatchEvent(g("ps-y-reach-end"))),"left"===b&&c>=h.contentWidth-h.containerWidth&&(c=h.contentWidth-h.containerWidth,c-a.scrollLeft<=1?c=a.scrollLeft:a.scrollLeft=c,a.dispatchEvent(g("ps-x-reach-end"))),d||(d=a.scrollTop),e||(e=a.scrollLeft),"top"===b&&c<d&&a.dispatchEvent(g("ps-scroll-up")),"top"===b&&c>d&&a.dispatchEvent(g("ps-scroll-down")),"left"===b&&c<e&&a.dispatchEvent(g("ps-scroll-left")),"left"===b&&c>e&&a.dispatchEvent(g("ps-scroll-right")),"top"===b&&(a.scrollTop=d=c,a.dispatchEvent(g("ps-scroll-y"))),"left"===b&&(a.scrollLeft=e=c,a.dispatchEvent(g("ps-scroll-x")))}},{"./instances":551}],555:[function(a,b,c){"use strict";var d=a("../lib/helper"),e=a("../lib/dom"),f=a("./instances"),g=a("./update-geometry"),h=a("./update-scroll");b.exports=function(a){var b=f.get(a);b&&(b.negativeScrollAdjustment=b.isNegativeScroll?a.scrollWidth-a.clientWidth:0,e.css(b.scrollbarXRail,"display","block"),e.css(b.scrollbarYRail,"display","block"),b.railXMarginWidth=d.toInt(e.css(b.scrollbarXRail,"marginLeft"))+d.toInt(e.css(b.scrollbarXRail,"marginRight")),b.railYMarginHeight=d.toInt(e.css(b.scrollbarYRail,"marginTop"))+d.toInt(e.css(b.scrollbarYRail,"marginBottom")),e.css(b.scrollbarXRail,"display","none"),e.css(b.scrollbarYRail,"display","none"),g(a),h(a,"top",a.scrollTop),h(a,"left",a.scrollLeft),e.css(b.scrollbarXRail,"display",""),e.css(b.scrollbarYRail,"display",""))}},{"../lib/dom":535,"../lib/helper":538,"./instances":551,"./update-geometry":553,"./update-scroll":554}],556:[function(a,b,c){function d(){throw new Error("setTimeout has not been defined")}function e(){throw new Error("clearTimeout has not been defined")}function f(a){if(l===setTimeout)return setTimeout(a,0);if((l===d||!l)&&setTimeout)return l=setTimeout,setTimeout(a,0);try{return l(a,0)}catch(b){try{return l.call(null,a,0)}catch(b){return l.call(this,a,0)}}}function g(a){if(m===clearTimeout)return clearTimeout(a);if((m===e||!m)&&clearTimeout)return m=clearTimeout,clearTimeout(a);try{return m(a)}catch(b){try{return m.call(null,a)}catch(b){return m.call(this,a)}}}function h(){q&&o&&(q=!1,o.length?p=o.concat(p):r=-1,p.length&&i())}function i(){if(!q){var a=f(h);q=!0;for(var b=p.length;b;){for(o=p,p=[];++r<b;)o&&o[r].run();r=-1,b=p.length}o=null,q=!1,g(a)}}function j(a,b){this.fun=a,this.array=b}function k(){}var l,m,n=b.exports={};!function(){try{l="function"==typeof setTimeout?setTimeout:d}catch(a){l=d}try{m="function"==typeof clearTimeout?clearTimeout:e}catch(a){m=e}}();var o,p=[],q=!1,r=-1;n.nextTick=function(a){var b=new Array(arguments.length-1);if(arguments.length>1)for(var c=1;c<arguments.length;c++)b[c-1]=arguments[c];p.push(new j(a,b)),1!==p.length||q||f(i)},j.prototype.run=function(){this.fun.apply(null,this.array)},n.title="browser",n.browser=!0,n.env={},n.argv=[],n.version="",n.versions={},n.on=k,n.addListener=k,n.once=k,n.off=k,n.removeListener=k,n.removeAllListeners=k,n.emit=k,n.prependListener=k,n.prependOnceListener=k,n.listeners=function(a){return[]},n.binding=function(a){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(a){throw new Error("process.chdir is not supported")},n.umask=function(){return 0}},{}],557:[function(a,b,c){!function(a,d){"object"==typeof c&&"undefined"!=typeof b?b.exports=d():"function"==typeof define&&define.amd?define("queue",d):a.queue=d()}(this,function(){"use strict";function a(){}function b(b){function c(){if(!k)for(;k=o&&p<b;){var a=q+p,c=m[a],d=c.length-1,f=c[d];c[d]=g(a),--o,++p,m[a]=f.apply(null,c)||e}}function g(a){return function(b,d){if(!m[a])throw new Error;--p,++q,m[a]=null,null==l&&(null!=b?h(b):(n[a]=d,o?c():p||i()))}}function h(a){l=a,o=NaN,i()}function i(){null!=l?r(l):s?r(null,n):r.apply(null,f.concat(n))}if(!(b>=1))throw new Error;var j,k,l,m=[],n=[],o=0,p=0,q=0,r=a,s=!0;return j={defer:function(b){if(r!==a)throw new Error;var e=d.call(arguments,1);return e.push(b),++o,m.push(e),c(),j},abort:function(){if(null==l){for(var a,b=q+p;--b>=0;)(a=m[b])&&a.abort&&a.abort();h(new Error("abort"))}return j},await:function(b){if(r!==a)throw new Error;return r=b,s=!1,o||p||i(),j},awaitAll:function(b){if(r!==a)throw new Error;return r=b,s=!0,o||p||i(),j}}}function c(a){return b(arguments.length?+a:1/0)}var d=[].slice,e={},f=[null];return c.version="1.2.1",c})},{}],558:[function(a,b,c){c.SourceMapGenerator=a("./source-map/source-map-generator").SourceMapGenerator,c.SourceMapConsumer=a("./source-map/source-map-consumer").SourceMapConsumer,c.SourceNode=a("./source-map/source-node").SourceNode},{"./source-map/source-map-consumer":563,"./source-map/source-map-generator":564,"./source-map/source-node":565}],559:[function(a,b,c){if("function"!=typeof d)var d=a("amdefine")(b,a);d(function(a,b,c){function d(){this._array=[],this._set={}}var e=a("./util");d.fromArray=function(a,b){for(var c=new d,e=0,f=a.length;e<f;e++)c.add(a[e],b);return c},d.prototype.add=function(a,b){var c=this.has(a),d=this._array.length;c&&!b||this._array.push(a),c||(this._set[e.toSetString(a)]=d)},d.prototype.has=function(a){return Object.prototype.hasOwnProperty.call(this._set,e.toSetString(a))},d.prototype.indexOf=function(a){if(this.has(a))return this._set[e.toSetString(a)];throw new Error('"'+a+'" is not in the set.')},d.prototype.at=function(a){if(a>=0&&a<this._array.length)return this._array[a];throw new Error("No element indexed by "+a)},d.prototype.toArray=function(){return this._array.slice()},b.ArraySet=d})},{"./util":566,amdefine:515}],560:[function(a,b,c){if("function"!=typeof d)var d=a("amdefine")(b,a);d(function(a,b,c){function d(a){return a<0?(-a<<1)+1:(a<<1)+0}function e(a){var b=1===(1&a),c=a>>1;return b?-c:c}var f=a("./base64"),g=5,h=1<<g,i=h-1,j=h;b.encode=function(a){var b,c="",e=d(a);do b=e&i,e>>>=g,e>0&&(b|=j),c+=f.encode(b);while(e>0);return c},b.decode=function(a){var b,c,d=0,h=a.length,k=0,l=0;do{if(d>=h)throw new Error("Expected more digits in base 64 VLQ value.");c=f.decode(a.charAt(d++)),b=!!(c&j),c&=i,k+=c<<l,l+=g}while(b);return{value:e(k),rest:a.slice(d)}}})},{"./base64":561,amdefine:515}],561:[function(a,b,c){if("function"!=typeof d)var d=a("amdefine")(b,a);d(function(a,b,c){var d={},e={};"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("").forEach(function(a,b){d[a]=b,e[b]=a}),b.encode=function(a){if(a in e)return e[a];throw new TypeError("Must be between 0 and 63: "+a);
},b.decode=function(a){if(a in d)return d[a];throw new TypeError("Not a valid base 64 digit: "+a)}})},{amdefine:515}],562:[function(a,b,c){if("function"!=typeof d)var d=a("amdefine")(b,a);d(function(a,b,c){function d(a,b,c,e,f){var g=Math.floor((b-a)/2)+a,h=f(c,e[g],!0);return 0===h?e[g]:h>0?b-g>1?d(g,b,c,e,f):e[g]:g-a>1?d(a,g,c,e,f):a<0?null:e[a]}b.search=function(a,b,c){return b.length>0?d(-1,b.length,a,b,c):null}})},{amdefine:515}],563:[function(a,b,c){if("function"!=typeof d)var d=a("amdefine")(b,a);d(function(a,b,c){function d(a){var b=a;"string"==typeof a&&(b=JSON.parse(a.replace(/^\)\]\}'/,"")));var c=e.getArg(b,"version"),d=e.getArg(b,"sources"),f=e.getArg(b,"names",[]),h=e.getArg(b,"sourceRoot",null),i=e.getArg(b,"sourcesContent",null),j=e.getArg(b,"mappings"),k=e.getArg(b,"file",null);if(c!=this._version)throw new Error("Unsupported version: "+c);this._names=g.fromArray(f,!0),this._sources=g.fromArray(d,!0),this.sourceRoot=h,this.sourcesContent=i,this._mappings=j,this.file=k}var e=a("./util"),f=a("./binary-search"),g=a("./array-set").ArraySet,h=a("./base64-vlq");d.fromSourceMap=function(a){var b=Object.create(d.prototype);return b._names=g.fromArray(a._names.toArray(),!0),b._sources=g.fromArray(a._sources.toArray(),!0),b.sourceRoot=a._sourceRoot,b.sourcesContent=a._generateSourcesContent(b._sources.toArray(),b.sourceRoot),b.file=a._file,b.__generatedMappings=a._mappings.slice().sort(e.compareByGeneratedPositions),b.__originalMappings=a._mappings.slice().sort(e.compareByOriginalPositions),b},d.prototype._version=3,Object.defineProperty(d.prototype,"sources",{get:function(){return this._sources.toArray().map(function(a){return this.sourceRoot?e.join(this.sourceRoot,a):a},this)}}),d.prototype.__generatedMappings=null,Object.defineProperty(d.prototype,"_generatedMappings",{get:function(){return this.__generatedMappings||(this.__generatedMappings=[],this.__originalMappings=[],this._parseMappings(this._mappings,this.sourceRoot)),this.__generatedMappings}}),d.prototype.__originalMappings=null,Object.defineProperty(d.prototype,"_originalMappings",{get:function(){return this.__originalMappings||(this.__generatedMappings=[],this.__originalMappings=[],this._parseMappings(this._mappings,this.sourceRoot)),this.__originalMappings}}),d.prototype._parseMappings=function(a,b){for(var c,d,f=1,g=0,i=0,j=0,k=0,l=0,m=/^[,;]/,n=a;n.length>0;)if(";"===n.charAt(0))f++,n=n.slice(1),g=0;else if(","===n.charAt(0))n=n.slice(1);else{if(c={},c.generatedLine=f,d=h.decode(n),c.generatedColumn=g+d.value,g=c.generatedColumn,n=d.rest,n.length>0&&!m.test(n.charAt(0))){if(d=h.decode(n),c.source=this._sources.at(k+d.value),k+=d.value,n=d.rest,0===n.length||m.test(n.charAt(0)))throw new Error("Found a source, but no line and column");if(d=h.decode(n),c.originalLine=i+d.value,i=c.originalLine,c.originalLine+=1,n=d.rest,0===n.length||m.test(n.charAt(0)))throw new Error("Found a source and line, but no column");d=h.decode(n),c.originalColumn=j+d.value,j=c.originalColumn,n=d.rest,n.length>0&&!m.test(n.charAt(0))&&(d=h.decode(n),c.name=this._names.at(l+d.value),l+=d.value,n=d.rest)}this.__generatedMappings.push(c),"number"==typeof c.originalLine&&this.__originalMappings.push(c)}this.__generatedMappings.sort(e.compareByGeneratedPositions),this.__originalMappings.sort(e.compareByOriginalPositions)},d.prototype._findMapping=function(a,b,c,d,e){if(a[c]<=0)throw new TypeError("Line must be greater than or equal to 1, got "+a[c]);if(a[d]<0)throw new TypeError("Column must be greater than or equal to 0, got "+a[d]);return f.search(a,b,e)},d.prototype.originalPositionFor=function(a){var b={generatedLine:e.getArg(a,"line"),generatedColumn:e.getArg(a,"column")},c=this._findMapping(b,this._generatedMappings,"generatedLine","generatedColumn",e.compareByGeneratedPositions);if(c){var d=e.getArg(c,"source",null);return d&&this.sourceRoot&&(d=e.join(this.sourceRoot,d)),{source:d,line:e.getArg(c,"originalLine",null),column:e.getArg(c,"originalColumn",null),name:e.getArg(c,"name",null)}}return{source:null,line:null,column:null,name:null}},d.prototype.sourceContentFor=function(a){if(!this.sourcesContent)return null;if(this.sourceRoot&&(a=e.relative(this.sourceRoot,a)),this._sources.has(a))return this.sourcesContent[this._sources.indexOf(a)];var b;if(this.sourceRoot&&(b=e.urlParse(this.sourceRoot))){var c=a.replace(/^file:\/\//,"");if("file"==b.scheme&&this._sources.has(c))return this.sourcesContent[this._sources.indexOf(c)];if((!b.path||"/"==b.path)&&this._sources.has("/"+a))return this.sourcesContent[this._sources.indexOf("/"+a)]}throw new Error('"'+a+'" is not in the SourceMap.')},d.prototype.generatedPositionFor=function(a){var b={source:e.getArg(a,"source"),originalLine:e.getArg(a,"line"),originalColumn:e.getArg(a,"column")};this.sourceRoot&&(b.source=e.relative(this.sourceRoot,b.source));var c=this._findMapping(b,this._originalMappings,"originalLine","originalColumn",e.compareByOriginalPositions);return c?{line:e.getArg(c,"generatedLine",null),column:e.getArg(c,"generatedColumn",null)}:{line:null,column:null}},d.GENERATED_ORDER=1,d.ORIGINAL_ORDER=2,d.prototype.eachMapping=function(a,b,c){var f,g=b||null,h=c||d.GENERATED_ORDER;switch(h){case d.GENERATED_ORDER:f=this._generatedMappings;break;case d.ORIGINAL_ORDER:f=this._originalMappings;break;default:throw new Error("Unknown order of iteration.")}var i=this.sourceRoot;f.map(function(a){var b=a.source;return b&&i&&(b=e.join(i,b)),{source:b,generatedLine:a.generatedLine,generatedColumn:a.generatedColumn,originalLine:a.originalLine,originalColumn:a.originalColumn,name:a.name}}).forEach(a,g)},b.SourceMapConsumer=d})},{"./array-set":559,"./base64-vlq":560,"./binary-search":562,"./util":566,amdefine:515}],564:[function(a,b,c){if("function"!=typeof d)var d=a("amdefine")(b,a);d(function(a,b,c){function d(a){this._file=f.getArg(a,"file"),this._sourceRoot=f.getArg(a,"sourceRoot",null),this._sources=new g,this._names=new g,this._mappings=[],this._sourcesContents=null}var e=a("./base64-vlq"),f=a("./util"),g=a("./array-set").ArraySet;d.prototype._version=3,d.fromSourceMap=function(a){var b=a.sourceRoot,c=new d({file:a.file,sourceRoot:b});return a.eachMapping(function(a){var d={generated:{line:a.generatedLine,column:a.generatedColumn}};a.source&&(d.source=a.source,b&&(d.source=f.relative(b,d.source)),d.original={line:a.originalLine,column:a.originalColumn},a.name&&(d.name=a.name)),c.addMapping(d)}),a.sources.forEach(function(b){var d=a.sourceContentFor(b);d&&c.setSourceContent(b,d)}),c},d.prototype.addMapping=function(a){var b=f.getArg(a,"generated"),c=f.getArg(a,"original",null),d=f.getArg(a,"source",null),e=f.getArg(a,"name",null);this._validateMapping(b,c,d,e),d&&!this._sources.has(d)&&this._sources.add(d),e&&!this._names.has(e)&&this._names.add(e),this._mappings.push({generatedLine:b.line,generatedColumn:b.column,originalLine:null!=c&&c.line,originalColumn:null!=c&&c.column,source:d,name:e})},d.prototype.setSourceContent=function(a,b){var c=a;this._sourceRoot&&(c=f.relative(this._sourceRoot,c)),null!==b?(this._sourcesContents||(this._sourcesContents={}),this._sourcesContents[f.toSetString(c)]=b):(delete this._sourcesContents[f.toSetString(c)],0===Object.keys(this._sourcesContents).length&&(this._sourcesContents=null))},d.prototype.applySourceMap=function(a,b){b||(b=a.file);var c=this._sourceRoot;c&&(b=f.relative(c,b));var d=new g,e=new g;this._mappings.forEach(function(g){if(g.source===b&&g.originalLine){var h=a.originalPositionFor({line:g.originalLine,column:g.originalColumn});null!==h.source&&(c?g.source=f.relative(c,h.source):g.source=h.source,g.originalLine=h.line,g.originalColumn=h.column,null!==h.name&&null!==g.name&&(g.name=h.name))}var i=g.source;i&&!d.has(i)&&d.add(i);var j=g.name;j&&!e.has(j)&&e.add(j)},this),this._sources=d,this._names=e,a.sources.forEach(function(b){var d=a.sourceContentFor(b);d&&(c&&(b=f.relative(c,b)),this.setSourceContent(b,d))},this)},d.prototype._validateMapping=function(a,b,c,d){if((!(a&&"line"in a&&"column"in a&&a.line>0&&a.column>=0)||b||c||d)&&!(a&&"line"in a&&"column"in a&&b&&"line"in b&&"column"in b&&a.line>0&&a.column>=0&&b.line>0&&b.column>=0&&c))throw new Error("Invalid mapping: "+JSON.stringify({generated:a,source:c,original:b,name:d}))},d.prototype._serializeMappings=function(){var a,b=0,c=1,d=0,g=0,h=0,i=0,j="";this._mappings.sort(f.compareByGeneratedPositions);for(var k=0,l=this._mappings.length;k<l;k++){if(a=this._mappings[k],a.generatedLine!==c)for(b=0;a.generatedLine!==c;)j+=";",c++;else if(k>0){if(!f.compareByGeneratedPositions(a,this._mappings[k-1]))continue;j+=","}j+=e.encode(a.generatedColumn-b),b=a.generatedColumn,a.source&&(j+=e.encode(this._sources.indexOf(a.source)-i),i=this._sources.indexOf(a.source),j+=e.encode(a.originalLine-1-g),g=a.originalLine-1,j+=e.encode(a.originalColumn-d),d=a.originalColumn,a.name&&(j+=e.encode(this._names.indexOf(a.name)-h),h=this._names.indexOf(a.name)))}return j},d.prototype._generateSourcesContent=function(a,b){return a.map(function(a){if(!this._sourcesContents)return null;b&&(a=f.relative(b,a));var c=f.toSetString(a);return Object.prototype.hasOwnProperty.call(this._sourcesContents,c)?this._sourcesContents[c]:null},this)},d.prototype.toJSON=function(){var a={version:this._version,file:this._file,sources:this._sources.toArray(),names:this._names.toArray(),mappings:this._serializeMappings()};return this._sourceRoot&&(a.sourceRoot=this._sourceRoot),this._sourcesContents&&(a.sourcesContent=this._generateSourcesContent(a.sources,a.sourceRoot)),a},d.prototype.toString=function(){return JSON.stringify(this)},b.SourceMapGenerator=d})},{"./array-set":559,"./base64-vlq":560,"./util":566,amdefine:515}],565:[function(a,b,c){if("function"!=typeof d)var d=a("amdefine")(b,a);d(function(a,b,c){function d(a,b,c,d,e){this.children=[],this.sourceContents={},this.line=void 0===a?null:a,this.column=void 0===b?null:b,this.source=void 0===c?null:c,this.name=void 0===e?null:e,null!=d&&this.add(d)}var e=a("./source-map-generator").SourceMapGenerator,f=a("./util");d.fromStringWithSourceMap=function(a,b){function c(a,b){null===a||void 0===a.source?e.add(b):e.add(new d(a.originalLine,a.originalColumn,a.source,b,a.name))}var e=new d,f=a.split("\n"),g=1,h=0,i=null;return b.eachMapping(function(a){if(null===i){for(;g<a.generatedLine;)e.add(f.shift()+"\n"),g++;if(h<a.generatedColumn){var b=f[0];e.add(b.substr(0,a.generatedColumn)),f[0]=b.substr(a.generatedColumn),h=a.generatedColumn}}else if(g<a.generatedLine){var d="";do d+=f.shift()+"\n",g++,h=0;while(g<a.generatedLine);if(h<a.generatedColumn){var b=f[0];d+=b.substr(0,a.generatedColumn),f[0]=b.substr(a.generatedColumn),h=a.generatedColumn}c(i,d)}else{var b=f[0],d=b.substr(0,a.generatedColumn-h);f[0]=b.substr(a.generatedColumn-h),h=a.generatedColumn,c(i,d)}i=a},this),c(i,f.join("\n")),b.sources.forEach(function(a){var c=b.sourceContentFor(a);c&&e.setSourceContent(a,c)}),e},d.prototype.add=function(a){if(Array.isArray(a))a.forEach(function(a){this.add(a)},this);else{if(!(a instanceof d||"string"==typeof a))throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+a);a&&this.children.push(a)}return this},d.prototype.prepend=function(a){if(Array.isArray(a))for(var b=a.length-1;b>=0;b--)this.prepend(a[b]);else{if(!(a instanceof d||"string"==typeof a))throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+a);this.children.unshift(a)}return this},d.prototype.walk=function(a){for(var b,c=0,e=this.children.length;c<e;c++)b=this.children[c],b instanceof d?b.walk(a):""!==b&&a(b,{source:this.source,line:this.line,column:this.column,name:this.name})},d.prototype.join=function(a){var b,c,d=this.children.length;if(d>0){for(b=[],c=0;c<d-1;c++)b.push(this.children[c]),b.push(a);b.push(this.children[c]),this.children=b}return this},d.prototype.replaceRight=function(a,b){var c=this.children[this.children.length-1];return c instanceof d?c.replaceRight(a,b):"string"==typeof c?this.children[this.children.length-1]=c.replace(a,b):this.children.push("".replace(a,b)),this},d.prototype.setSourceContent=function(a,b){this.sourceContents[f.toSetString(a)]=b},d.prototype.walkSourceContents=function(a){for(var b=0,c=this.children.length;b<c;b++)this.children[b]instanceof d&&this.children[b].walkSourceContents(a);for(var e=Object.keys(this.sourceContents),b=0,c=e.length;b<c;b++)a(f.fromSetString(e[b]),this.sourceContents[e[b]])},d.prototype.toString=function(){var a="";return this.walk(function(b){a+=b}),a},d.prototype.toStringWithSourceMap=function(a){var b={code:"",line:1,column:0},c=new e(a),d=!1,f=null,g=null,h=null,i=null;return this.walk(function(a,e){b.code+=a,null!==e.source&&null!==e.line&&null!==e.column?(f===e.source&&g===e.line&&h===e.column&&i===e.name||c.addMapping({source:e.source,original:{line:e.line,column:e.column},generated:{line:b.line,column:b.column},name:e.name}),f=e.source,g=e.line,h=e.column,i=e.name,d=!0):d&&(c.addMapping({generated:{line:b.line,column:b.column}}),f=null,d=!1),a.split("").forEach(function(a){"\n"===a?(b.line++,b.column=0):b.column++})}),this.walkSourceContents(function(a,b){c.setSourceContent(a,b)}),{code:b.code,map:c}},b.SourceNode=d})},{"./source-map-generator":564,"./util":566,amdefine:515}],566:[function(a,b,c){if("function"!=typeof d)var d=a("amdefine")(b,a);d(function(a,b,c){function d(a,b,c){if(b in a)return a[b];if(3===arguments.length)return c;throw new Error('"'+b+'" is a required argument.')}function e(a){var b=a.match(n);return b?{scheme:b[1],auth:b[3],host:b[4],port:b[6],path:b[7]}:null}function f(a){var b=a.scheme+"://";return a.auth&&(b+=a.auth+"@"),a.host&&(b+=a.host),a.port&&(b+=":"+a.port),a.path&&(b+=a.path),b}function g(a,b){var c;return b.match(n)||b.match(o)?b:"/"===b.charAt(0)&&(c=e(a))?(c.path=b,f(c)):a.replace(/\/$/,"")+"/"+b}function h(a){return"$"+a}function i(a){return a.substr(1)}function j(a,b){a=a.replace(/\/$/,"");var c=e(a);return"/"==b.charAt(0)&&c&&"/"==c.path?b.slice(1):0===b.indexOf(a+"/")?b.substr(a.length+1):b}function k(a,b){var c=a||"",d=b||"";return(c>d)-(c<d)}function l(a,b,c){var d;return(d=k(a.source,b.source))?d:(d=a.originalLine-b.originalLine)?d:(d=a.originalColumn-b.originalColumn,d||c?d:(d=k(a.name,b.name))?d:(d=a.generatedLine-b.generatedLine,d?d:a.generatedColumn-b.generatedColumn))}function m(a,b,c){var d;return(d=a.generatedLine-b.generatedLine)?d:(d=a.generatedColumn-b.generatedColumn,d||c?d:(d=k(a.source,b.source))?d:(d=a.originalLine-b.originalLine)?d:(d=a.originalColumn-b.originalColumn,d?d:k(a.name,b.name)))}b.getArg=d;var n=/([\w+\-.]+):\/\/((\w+:\w+)@)?([\w.]+)?(:(\d+))?(\S+)?/,o=/^data:.+\,.+/;b.urlParse=e,b.urlGenerate=f,b.join=g,b.toSetString=h,b.fromSetString=i,b.relative=j,b.compareByOriginalPositions=l,b.compareByGeneratedPositions=m})},{amdefine:515}],567:[function(a,b,c){(function(b,d){function e(){return"browser"===y||"node"!==y&&("undefined"!=typeof window&&"function"==typeof XMLHttpRequest)}function f(){return"object"==typeof b&&null!==b&&"function"==typeof b.on}function g(a){return function(b){for(var c=0;c<a.length;c++){var d=a[c](b);if(d)return d}return null}}function h(a,b){if(!a)return b;var c=t.dirname(a),d=/^\w+:\/\/[^\/]*/.exec(c),e=d?d[0]:"";return e+t.resolve(c.slice(e.length),b)}function i(a){var b;if(e()){var c=new XMLHttpRequest;c.open("GET",a,!1),c.send(null),b=4===c.readyState?c.responseText:null;var d=c.getResponseHeader("SourceMap")||c.getResponseHeader("X-SourceMap");if(d)return d}b=E(a);for(var f,g,h=/(?:\/\/[@#][ \t]+sourceMappingURL=([^\s'"]+?)[ \t]*$)|(?:\/\*[@#][ \t]+sourceMappingURL=([^\*]+?)[ \t]*(?:\*\/)[ \t]*$)/gm;g=h.exec(b);)f=g;return f?f[1]:null}function j(a){var b=A[a.source];if(!b){var c=F(a.source);c?(b=A[a.source]={url:c.url,map:new s(c.map)},b.map.sourcesContent&&b.map.sources.forEach(function(a,c){var d=b.map.sourcesContent[c];if(d){var e=h(b.url,a);z[e]=d}})):b=A[a.source]={url:null,map:null}}if(b&&b.map){var d=b.map.originalPositionFor(a);if(null!==d.source)return d.source=h(b.url,d.source),d}return a}function k(a){var b=/^eval at ([^(]+) \((.+):(\d+):(\d+)\)$/.exec(a);if(b){var c=j({source:b[2],line:b[3],column:b[4]-1});return"eval at "+b[1]+" ("+c.source+":"+c.line+":"+(c.column+1)+")"}return b=/^eval at ([^(]+) \((.+)\)$/.exec(a),b?"eval at "+b[1]+" ("+k(b[2])+")":a}function l(){var a,b="";if(this.isNative())b="native";else{a=this.getScriptNameOrSourceURL(),!a&&this.isEval()&&(b=this.getEvalOrigin(),b+=", "),b+=a?a:"<anonymous>";var c=this.getLineNumber();if(null!=c){b+=":"+c;var d=this.getColumnNumber();d&&(b+=":"+d)}}var e="",f=this.getFunctionName(),g=!0,h=this.isConstructor(),i=!(this.isToplevel()||h);if(i){var j=this.getTypeName(),k=this.getMethodName();f?(j&&0!=f.indexOf(j)&&(e+=j+"."),e+=f,k&&f.indexOf("."+k)!=f.length-k.length-1&&(e+=" [as "+k+"]")):e+=j+"."+(k||"<anonymous>")}else h?e+="new "+(f||"<anonymous>"):f?e+=f:(e+=b,g=!1);return g&&(e+=" ("+b+")"),e}function m(a){var b={};return Object.getOwnPropertyNames(Object.getPrototypeOf(a)).forEach(function(c){b[c]=/^(?:is|get)/.test(c)?function(){return a[c].call(a)}:a[c]}),b.toString=l,b}function n(a){var b=a.getFileName()||a.getScriptNameOrSourceURL();if(b){var c=a.getLineNumber(),d=a.getColumnNumber()-1;1!==c||e()||a.isEval()||(d-=62);var f=j({source:b,line:c,column:d});return a=m(a),a.getFileName=function(){return f.source},a.getLineNumber=function(){return f.line},a.getColumnNumber=function(){return f.column+1},a.getScriptNameOrSourceURL=function(){return f.source},a}var g=a.isEval()&&a.getEvalOrigin();return g?(g=k(g),a=m(a),a.getEvalOrigin=function(){return g},a):a}function o(a,b){return x&&(z={},A={}),a+b.map(function(a){return"\n    at "+n(a)}).join("")}function p(a){var b=/\n    at [^(]+ \((.*):(\d+):(\d+)\)/.exec(a.stack);if(b){var c=b[1],d=+b[2],e=+b[3],f=z[c];if(!f&&u.existsSync(c)&&(f=u.readFileSync(c,"utf8")),f){var g=f.split(/(?:\r\n|\r|\n)/)[d-1];if(g)return c+":"+d+"\n"+g+"\n"+new Array(e).join(" ")+"^"}}return null}function q(a){var c=p(a);c&&(console.error(),console.error(c)),console.error(a.stack),b.exit(1)}function r(){var a=b.emit;b.emit=function(b){if("uncaughtException"===b){var c=arguments[1]&&arguments[1].stack,d=this.listeners(b).length>0;if(c&&!d)return q(arguments[1])}return a.apply(this,arguments)}}var s=a("source-map").SourceMapConsumer,t=a("path"),u=a("fs"),v=!1,w=!1,x=!1,y="auto",z={},A={},B=/^data:application\/json[^,]+base64,/,C=[],D=[],E=g(C);C.push(function(a){if(a=a.trim(),a in z)return z[a];try{if(e()){var b=new XMLHttpRequest;b.open("GET",a,!1),b.send(null);var c=null;4===b.readyState&&200===b.status&&(c=b.responseText)}else var c=u.readFileSync(a,"utf8")}catch(a){var c=null}return z[a]=c});var F=g(D);D.push(function(a){var b=i(a);if(!b)return null;var c;if(B.test(b)){var e=b.slice(b.indexOf(",")+1);c=new d(e,"base64").toString(),b=null}else b=h(a,b),c=E(b);return c?{url:b,map:c}:null}),c.wrapCallSite=n,c.getErrorSource=p,c.mapSourcePosition=j,c.retrieveSourceMap=F,c.install=function(a){if(a=a||{},a.environment&&(y=a.environment,["node","browser","auto"].indexOf(y)===-1))throw new Error("environment "+y+" was unknown. Available options are {auto, browser, node}");if(a.retrieveFile&&(a.overrideRetrieveFile&&(C.length=0),C.unshift(a.retrieveFile)),a.retrieveSourceMap&&(a.overrideRetrieveSourceMap&&(D.length=0),D.unshift(a.retrieveSourceMap)),x||(x="emptyCacheBetweenOperations"in a&&a.emptyCacheBetweenOperations),v||(v=!0,Error.prepareStackTrace=o),!w){var b=!("handleUncaughtExceptions"in a)||a.handleUncaughtExceptions;b&&f()&&(w=!0,r())}}}).call(this,a("_process"),a("buffer").Buffer)},{_process:556,buffer:518,fs:517,path:532,"source-map":558}],568:[function(a,b,c){(function(){function a(a){function b(b,c,d,e,f,g){for(;f>=0&&f<g;f+=a){var h=e?e[f]:f;d=c(d,b[h],h,b)}return d}return function(c,d,e,f){d=v(d,f,4);var g=!C(c)&&u.keys(c),h=(g||c).length,i=a>0?0:h-1;return arguments.length<3&&(e=c[g?g[i]:i],i+=a),b(c,d,e,g,i,h)}}function d(a){return function(b,c,d){c=w(c,d);for(var e=B(b),f=a>0?0:e-1;f>=0&&f<e;f+=a)if(c(b[f],f,b))return f;return-1}}function e(a,b,c){return function(d,e,f){var g=0,h=B(d);if("number"==typeof f)a>0?g=f>=0?f:Math.max(f+h,g):h=f>=0?Math.min(f+1,h):f+h+1;else if(c&&f&&h)return f=c(d,e),d[f]===e?f:-1;if(e!==e)return f=b(m.call(d,g,h),u.isNaN),f>=0?f+g:-1;for(f=a>0?g:h-1;f>=0&&f<h;f+=a)if(d[f]===e)return f;return-1}}function f(a,b){var c=H.length,d=a.constructor,e=u.isFunction(d)&&d.prototype||j,f="constructor";for(u.has(a,f)&&!u.contains(b,f)&&b.push(f);c--;)f=H[c],f in a&&a[f]!==e[f]&&!u.contains(b,f)&&b.push(f)}var g=this,h=g._,i=Array.prototype,j=Object.prototype,k=Function.prototype,l=i.push,m=i.slice,n=j.toString,o=j.hasOwnProperty,p=Array.isArray,q=Object.keys,r=k.bind,s=Object.create,t=function(){},u=function(a){return a instanceof u?a:this instanceof u?void(this._wrapped=a):new u(a)};"undefined"!=typeof c?("undefined"!=typeof b&&b.exports&&(c=b.exports=u),c._=u):g._=u,u.VERSION="1.8.3";var v=function(a,b,c){if(void 0===b)return a;switch(null==c?3:c){case 1:return function(c){return a.call(b,c)};case 2:return function(c,d){return a.call(b,c,d)};case 3:return function(c,d,e){return a.call(b,c,d,e)};case 4:return function(c,d,e,f){return a.call(b,c,d,e,f)}}return function(){return a.apply(b,arguments)}},w=function(a,b,c){return null==a?u.identity:u.isFunction(a)?v(a,b,c):u.isObject(a)?u.matcher(a):u.property(a)};u.iteratee=function(a,b){return w(a,b,1/0)};var x=function(a,b){return function(c){var d=arguments.length;if(d<2||null==c)return c;for(var e=1;e<d;e++)for(var f=arguments[e],g=a(f),h=g.length,i=0;i<h;i++){var j=g[i];b&&void 0!==c[j]||(c[j]=f[j])}return c}},y=function(a){if(!u.isObject(a))return{};if(s)return s(a);t.prototype=a;var b=new t;return t.prototype=null,b},z=function(a){return function(b){return null==b?void 0:b[a]}},A=Math.pow(2,53)-1,B=z("length"),C=function(a){var b=B(a);return"number"==typeof b&&b>=0&&b<=A};u.each=u.forEach=function(a,b,c){b=v(b,c);var d,e;if(C(a))for(d=0,e=a.length;d<e;d++)b(a[d],d,a);else{var f=u.keys(a);for(d=0,e=f.length;d<e;d++)b(a[f[d]],f[d],a)}return a},u.map=u.collect=function(a,b,c){b=w(b,c);for(var d=!C(a)&&u.keys(a),e=(d||a).length,f=Array(e),g=0;g<e;g++){var h=d?d[g]:g;f[g]=b(a[h],h,a)}return f},u.reduce=u.foldl=u.inject=a(1),u.reduceRight=u.foldr=a(-1),u.find=u.detect=function(a,b,c){var d;if(d=C(a)?u.findIndex(a,b,c):u.findKey(a,b,c),void 0!==d&&d!==-1)return a[d]},u.filter=u.select=function(a,b,c){var d=[];return b=w(b,c),u.each(a,function(a,c,e){b(a,c,e)&&d.push(a)}),d},u.reject=function(a,b,c){return u.filter(a,u.negate(w(b)),c)},u.every=u.all=function(a,b,c){b=w(b,c);for(var d=!C(a)&&u.keys(a),e=(d||a).length,f=0;f<e;f++){var g=d?d[f]:f;if(!b(a[g],g,a))return!1}return!0},u.some=u.any=function(a,b,c){b=w(b,c);for(var d=!C(a)&&u.keys(a),e=(d||a).length,f=0;f<e;f++){var g=d?d[f]:f;if(b(a[g],g,a))return!0}return!1},u.contains=u.includes=u.include=function(a,b,c,d){return C(a)||(a=u.values(a)),("number"!=typeof c||d)&&(c=0),u.indexOf(a,b,c)>=0},u.invoke=function(a,b){var c=m.call(arguments,2),d=u.isFunction(b);return u.map(a,function(a){var e=d?b:a[b];return null==e?e:e.apply(a,c)})},u.pluck=function(a,b){return u.map(a,u.property(b))},u.where=function(a,b){return u.filter(a,u.matcher(b))},u.findWhere=function(a,b){return u.find(a,u.matcher(b))},u.max=function(a,b,c){var d,e,f=-(1/0),g=-(1/0);if(null==b&&null!=a){a=C(a)?a:u.values(a);for(var h=0,i=a.length;h<i;h++)d=a[h],d>f&&(f=d)}else b=w(b,c),u.each(a,function(a,c,d){e=b(a,c,d),(e>g||e===-(1/0)&&f===-(1/0))&&(f=a,g=e)});return f},u.min=function(a,b,c){var d,e,f=1/0,g=1/0;if(null==b&&null!=a){a=C(a)?a:u.values(a);for(var h=0,i=a.length;h<i;h++)d=a[h],d<f&&(f=d)}else b=w(b,c),u.each(a,function(a,c,d){e=b(a,c,d),(e<g||e===1/0&&f===1/0)&&(f=a,g=e)});return f},u.shuffle=function(a){for(var b,c=C(a)?a:u.values(a),d=c.length,e=Array(d),f=0;f<d;f++)b=u.random(0,f),b!==f&&(e[f]=e[b]),e[b]=c[f];return e},u.sample=function(a,b,c){return null==b||c?(C(a)||(a=u.values(a)),a[u.random(a.length-1)]):u.shuffle(a).slice(0,Math.max(0,b))},u.sortBy=function(a,b,c){return b=w(b,c),u.pluck(u.map(a,function(a,c,d){return{value:a,index:c,criteria:b(a,c,d)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;if(c!==d){if(c>d||void 0===c)return 1;if(c<d||void 0===d)return-1}return a.index-b.index}),"value")};var D=function(a){return function(b,c,d){var e={};return c=w(c,d),u.each(b,function(d,f){var g=c(d,f,b);a(e,d,g)}),e}};u.groupBy=D(function(a,b,c){u.has(a,c)?a[c].push(b):a[c]=[b]}),u.indexBy=D(function(a,b,c){a[c]=b}),u.countBy=D(function(a,b,c){u.has(a,c)?a[c]++:a[c]=1}),u.toArray=function(a){return a?u.isArray(a)?m.call(a):C(a)?u.map(a,u.identity):u.values(a):[]},u.size=function(a){return null==a?0:C(a)?a.length:u.keys(a).length},u.partition=function(a,b,c){b=w(b,c);var d=[],e=[];return u.each(a,function(a,c,f){(b(a,c,f)?d:e).push(a)}),[d,e]},u.first=u.head=u.take=function(a,b,c){if(null!=a)return null==b||c?a[0]:u.initial(a,a.length-b)},u.initial=function(a,b,c){return m.call(a,0,Math.max(0,a.length-(null==b||c?1:b)))},u.last=function(a,b,c){if(null!=a)return null==b||c?a[a.length-1]:u.rest(a,Math.max(0,a.length-b))},u.rest=u.tail=u.drop=function(a,b,c){return m.call(a,null==b||c?1:b)},u.compact=function(a){return u.filter(a,u.identity)};var E=function(a,b,c,d){for(var e=[],f=0,g=d||0,h=B(a);g<h;g++){var i=a[g];if(C(i)&&(u.isArray(i)||u.isArguments(i))){b||(i=E(i,b,c));var j=0,k=i.length;for(e.length+=k;j<k;)e[f++]=i[j++]}else c||(e[f++]=i)}return e};u.flatten=function(a,b){return E(a,b,!1)},u.without=function(a){return u.difference(a,m.call(arguments,1))},u.uniq=u.unique=function(a,b,c,d){u.isBoolean(b)||(d=c,c=b,b=!1),null!=c&&(c=w(c,d));for(var e=[],f=[],g=0,h=B(a);g<h;g++){var i=a[g],j=c?c(i,g,a):i;b?(g&&f===j||e.push(i),f=j):c?u.contains(f,j)||(f.push(j),e.push(i)):u.contains(e,i)||e.push(i)}return e},u.union=function(){return u.uniq(E(arguments,!0,!0))},u.intersection=function(a){for(var b=[],c=arguments.length,d=0,e=B(a);d<e;d++){var f=a[d];if(!u.contains(b,f)){for(var g=1;g<c&&u.contains(arguments[g],f);g++);g===c&&b.push(f)}}return b},u.difference=function(a){var b=E(arguments,!0,!0,1);return u.filter(a,function(a){return!u.contains(b,a)})},u.zip=function(){return u.unzip(arguments)},u.unzip=function(a){for(var b=a&&u.max(a,B).length||0,c=Array(b),d=0;d<b;d++)c[d]=u.pluck(a,d);return c},u.object=function(a,b){for(var c={},d=0,e=B(a);d<e;d++)b?c[a[d]]=b[d]:c[a[d][0]]=a[d][1];return c},u.findIndex=d(1),u.findLastIndex=d(-1),u.sortedIndex=function(a,b,c,d){c=w(c,d,1);for(var e=c(b),f=0,g=B(a);f<g;){var h=Math.floor((f+g)/2);c(a[h])<e?f=h+1:g=h}return f},u.indexOf=e(1,u.findIndex,u.sortedIndex),u.lastIndexOf=e(-1,u.findLastIndex),u.range=function(a,b,c){null==b&&(b=a||0,a=0),c=c||1;for(var d=Math.max(Math.ceil((b-a)/c),0),e=Array(d),f=0;f<d;f++,a+=c)e[f]=a;return e};var F=function(a,b,c,d,e){if(!(d instanceof b))return a.apply(c,e);var f=y(a.prototype),g=a.apply(f,e);return u.isObject(g)?g:f};u.bind=function(a,b){if(r&&a.bind===r)return r.apply(a,m.call(arguments,1));if(!u.isFunction(a))throw new TypeError("Bind must be called on a function");var c=m.call(arguments,2),d=function(){return F(a,d,b,this,c.concat(m.call(arguments)))};return d},u.partial=function(a){var b=m.call(arguments,1),c=function(){for(var d=0,e=b.length,f=Array(e),g=0;g<e;g++)f[g]=b[g]===u?arguments[d++]:b[g];for(;d<arguments.length;)f.push(arguments[d++]);return F(a,c,this,this,f)};return c},u.bindAll=function(a){var b,c,d=arguments.length;if(d<=1)throw new Error("bindAll must be passed function names");for(b=1;b<d;b++)c=arguments[b],a[c]=u.bind(a[c],a);return a},u.memoize=function(a,b){var c=function(d){var e=c.cache,f=""+(b?b.apply(this,arguments):d);return u.has(e,f)||(e[f]=a.apply(this,arguments)),e[f]};return c.cache={},c},u.delay=function(a,b){var c=m.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)},u.defer=u.partial(u.delay,u,1),u.throttle=function(a,b,c){var d,e,f,g=null,h=0;c||(c={});var i=function(){h=c.leading===!1?0:u.now(),g=null,f=a.apply(d,e),g||(d=e=null)};return function(){var j=u.now();h||c.leading!==!1||(h=j);var k=b-(j-h);return d=this,e=arguments,k<=0||k>b?(g&&(clearTimeout(g),g=null),h=j,f=a.apply(d,e),g||(d=e=null)):g||c.trailing===!1||(g=setTimeout(i,k)),f}},u.debounce=function(a,b,c){var d,e,f,g,h,i=function(){var j=u.now()-g;j<b&&j>=0?d=setTimeout(i,b-j):(d=null,c||(h=a.apply(f,e),d||(f=e=null)))};return function(){f=this,e=arguments,g=u.now();var j=c&&!d;return d||(d=setTimeout(i,b)),j&&(h=a.apply(f,e),f=e=null),h}},u.wrap=function(a,b){return u.partial(b,a)},u.negate=function(a){return function(){return!a.apply(this,arguments)}},u.compose=function(){var a=arguments,b=a.length-1;return function(){for(var c=b,d=a[b].apply(this,arguments);c--;)d=a[c].call(this,d);return d}},u.after=function(a,b){return function(){if(--a<1)return b.apply(this,arguments)}},u.before=function(a,b){var c;return function(){return--a>0&&(c=b.apply(this,arguments)),a<=1&&(b=null),c}},u.once=u.partial(u.before,2);var G=!{toString:null}.propertyIsEnumerable("toString"),H=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];u.keys=function(a){if(!u.isObject(a))return[];if(q)return q(a);var b=[];for(var c in a)u.has(a,c)&&b.push(c);return G&&f(a,b),b},u.allKeys=function(a){if(!u.isObject(a))return[];var b=[];for(var c in a)b.push(c);return G&&f(a,b),b},u.values=function(a){for(var b=u.keys(a),c=b.length,d=Array(c),e=0;e<c;e++)d[e]=a[b[e]];return d},u.mapObject=function(a,b,c){b=w(b,c);for(var d,e=u.keys(a),f=e.length,g={},h=0;h<f;h++)d=e[h],g[d]=b(a[d],d,a);return g},u.pairs=function(a){for(var b=u.keys(a),c=b.length,d=Array(c),e=0;e<c;e++)d[e]=[b[e],a[b[e]]];return d},u.invert=function(a){for(var b={},c=u.keys(a),d=0,e=c.length;d<e;d++)b[a[c[d]]]=c[d];return b},u.functions=u.methods=function(a){var b=[];for(var c in a)u.isFunction(a[c])&&b.push(c);return b.sort()},u.extend=x(u.allKeys),u.extendOwn=u.assign=x(u.keys),u.findKey=function(a,b,c){b=w(b,c);for(var d,e=u.keys(a),f=0,g=e.length;f<g;f++)if(d=e[f],b(a[d],d,a))return d},u.pick=function(a,b,c){var d,e,f={},g=a;if(null==g)return f;u.isFunction(b)?(e=u.allKeys(g),d=v(b,c)):(e=E(arguments,!1,!1,1),d=function(a,b,c){return b in c},g=Object(g));for(var h=0,i=e.length;h<i;h++){var j=e[h],k=g[j];d(k,j,g)&&(f[j]=k)}return f},u.omit=function(a,b,c){if(u.isFunction(b))b=u.negate(b);else{var d=u.map(E(arguments,!1,!1,1),String);b=function(a,b){return!u.contains(d,b)}}return u.pick(a,b,c)},u.defaults=x(u.allKeys,!0),u.create=function(a,b){var c=y(a);return b&&u.extendOwn(c,b),c},u.clone=function(a){return u.isObject(a)?u.isArray(a)?a.slice():u.extend({},a):a},u.tap=function(a,b){return b(a),a},u.isMatch=function(a,b){var c=u.keys(b),d=c.length;if(null==a)return!d;for(var e=Object(a),f=0;f<d;f++){var g=c[f];if(b[g]!==e[g]||!(g in e))return!1}return!0};var I=function(a,b,c,d){if(a===b)return 0!==a||1/a===1/b;if(null==a||null==b)return a===b;a instanceof u&&(a=a._wrapped),b instanceof u&&(b=b._wrapped);var e=n.call(a);if(e!==n.call(b))return!1;switch(e){case"[object RegExp]":case"[object String]":return""+a==""+b;case"[object Number]":return+a!==+a?+b!==+b:0===+a?1/+a===1/b:+a===+b;case"[object Date]":case"[object Boolean]":return+a===+b}var f="[object Array]"===e;if(!f){if("object"!=typeof a||"object"!=typeof b)return!1;var g=a.constructor,h=b.constructor;if(g!==h&&!(u.isFunction(g)&&g instanceof g&&u.isFunction(h)&&h instanceof h)&&"constructor"in a&&"constructor"in b)return!1}c=c||[],d=d||[];for(var i=c.length;i--;)if(c[i]===a)return d[i]===b;if(c.push(a),d.push(b),f){if(i=a.length,i!==b.length)return!1;for(;i--;)if(!I(a[i],b[i],c,d))return!1}else{var j,k=u.keys(a);if(i=k.length,u.keys(b).length!==i)return!1;for(;i--;)if(j=k[i],!u.has(b,j)||!I(a[j],b[j],c,d))return!1}return c.pop(),d.pop(),!0};u.isEqual=function(a,b){return I(a,b)},u.isEmpty=function(a){return null==a||(C(a)&&(u.isArray(a)||u.isString(a)||u.isArguments(a))?0===a.length:0===u.keys(a).length)},u.isElement=function(a){return!(!a||1!==a.nodeType);
},u.isArray=p||function(a){return"[object Array]"===n.call(a)},u.isObject=function(a){var b=typeof a;return"function"===b||"object"===b&&!!a},u.each(["Arguments","Function","String","Number","Date","RegExp","Error"],function(a){u["is"+a]=function(b){return n.call(b)==="[object "+a+"]"}}),u.isArguments(arguments)||(u.isArguments=function(a){return u.has(a,"callee")}),"function"!=typeof/./&&"object"!=typeof Int8Array&&(u.isFunction=function(a){return"function"==typeof a||!1}),u.isFinite=function(a){return isFinite(a)&&!isNaN(parseFloat(a))},u.isNaN=function(a){return u.isNumber(a)&&a!==+a},u.isBoolean=function(a){return a===!0||a===!1||"[object Boolean]"===n.call(a)},u.isNull=function(a){return null===a},u.isUndefined=function(a){return void 0===a},u.has=function(a,b){return null!=a&&o.call(a,b)},u.noConflict=function(){return g._=h,this},u.identity=function(a){return a},u.constant=function(a){return function(){return a}},u.noop=function(){},u.property=z,u.propertyOf=function(a){return null==a?function(){}:function(b){return a[b]}},u.matcher=u.matches=function(a){return a=u.extendOwn({},a),function(b){return u.isMatch(b,a)}},u.times=function(a,b,c){var d=Array(Math.max(0,a));b=v(b,c,1);for(var e=0;e<a;e++)d[e]=b(e);return d},u.random=function(a,b){return null==b&&(b=a,a=0),a+Math.floor(Math.random()*(b-a+1))},u.now=Date.now||function(){return(new Date).getTime()};var J={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},K=u.invert(J),L=function(a){var b=function(b){return a[b]},c="(?:"+u.keys(a).join("|")+")",d=RegExp(c),e=RegExp(c,"g");return function(a){return a=null==a?"":""+a,d.test(a)?a.replace(e,b):a}};u.escape=L(J),u.unescape=L(K),u.result=function(a,b,c){var d=null==a?void 0:a[b];return void 0===d&&(d=c),u.isFunction(d)?d.call(a):d};var M=0;u.uniqueId=function(a){var b=++M+"";return a?a+b:b},u.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var N=/(.)^/,O={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},P=/\\|'|\r|\n|\u2028|\u2029/g,Q=function(a){return"\\"+O[a]};u.template=function(a,b,c){!b&&c&&(b=c),b=u.defaults({},b,u.templateSettings);var d=RegExp([(b.escape||N).source,(b.interpolate||N).source,(b.evaluate||N).source].join("|")+"|$","g"),e=0,f="__p+='";a.replace(d,function(b,c,d,g,h){return f+=a.slice(e,h).replace(P,Q),e=h+b.length,c?f+="'+\n((__t=("+c+"))==null?'':_.escape(__t))+\n'":d?f+="'+\n((__t=("+d+"))==null?'':__t)+\n'":g&&(f+="';\n"+g+"\n__p+='"),b}),f+="';\n",b.variable||(f="with(obj||{}){\n"+f+"}\n"),f="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+f+"return __p;\n";try{var g=new Function(b.variable||"obj","_",f)}catch(a){throw a.source=f,a}var h=function(a){return g.call(this,a,u)},i=b.variable||"obj";return h.source="function("+i+"){\n"+f+"}",h},u.chain=function(a){var b=u(a);return b._chain=!0,b};var R=function(a,b){return a._chain?u(b).chain():b};u.mixin=function(a){u.each(u.functions(a),function(b){var c=u[b]=a[b];u.prototype[b]=function(){var a=[this._wrapped];return l.apply(a,arguments),R(this,c.apply(u,a))}})},u.mixin(u),u.each(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=i[a];u.prototype[a]=function(){var c=this._wrapped;return b.apply(c,arguments),"shift"!==a&&"splice"!==a||0!==c.length||delete c[0],R(this,c)}}),u.each(["concat","join","slice"],function(a){var b=i[a];u.prototype[a]=function(){return R(this,b.apply(this._wrapped,arguments))}}),u.prototype.value=function(){return this._wrapped},u.prototype.valueOf=u.prototype.toJSON=u.prototype.value,u.prototype.toString=function(){return""+this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return u})}).call(this)},{}],569:[function(a,b,c){"function"==typeof Object.create?b.exports=function(a,b){a.super_=b,a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})}:b.exports=function(a,b){a.super_=b;var c=function(){};c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a}},{}],570:[function(a,b,c){b.exports=function(a){return a&&"object"==typeof a&&"function"==typeof a.copy&&"function"==typeof a.fill&&"function"==typeof a.readUInt8}},{}],571:[function(a,b,c){(function(b,d){function e(a,b){var d={seen:[],stylize:g};return arguments.length>=3&&(d.depth=arguments[2]),arguments.length>=4&&(d.colors=arguments[3]),p(b)?d.showHidden=b:b&&c._extend(d,b),v(d.showHidden)&&(d.showHidden=!1),v(d.depth)&&(d.depth=2),v(d.colors)&&(d.colors=!1),v(d.customInspect)&&(d.customInspect=!0),d.colors&&(d.stylize=f),i(d,a,d.depth)}function f(a,b){var c=e.styles[b];return c?"["+e.colors[c][0]+"m"+a+"["+e.colors[c][1]+"m":a}function g(a,b){return a}function h(a){var b={};return a.forEach(function(a,c){b[a]=!0}),b}function i(a,b,d){if(a.customInspect&&b&&A(b.inspect)&&b.inspect!==c.inspect&&(!b.constructor||b.constructor.prototype!==b)){var e=b.inspect(d,a);return t(e)||(e=i(a,e,d)),e}var f=j(a,b);if(f)return f;var g=Object.keys(b),p=h(g);if(a.showHidden&&(g=Object.getOwnPropertyNames(b)),z(b)&&(g.indexOf("message")>=0||g.indexOf("description")>=0))return k(b);if(0===g.length){if(A(b)){var q=b.name?": "+b.name:"";return a.stylize("[Function"+q+"]","special")}if(w(b))return a.stylize(RegExp.prototype.toString.call(b),"regexp");if(y(b))return a.stylize(Date.prototype.toString.call(b),"date");if(z(b))return k(b)}var r="",s=!1,u=["{","}"];if(o(b)&&(s=!0,u=["[","]"]),A(b)){var v=b.name?": "+b.name:"";r=" [Function"+v+"]"}if(w(b)&&(r=" "+RegExp.prototype.toString.call(b)),y(b)&&(r=" "+Date.prototype.toUTCString.call(b)),z(b)&&(r=" "+k(b)),0===g.length&&(!s||0==b.length))return u[0]+r+u[1];if(d<0)return w(b)?a.stylize(RegExp.prototype.toString.call(b),"regexp"):a.stylize("[Object]","special");a.seen.push(b);var x;return x=s?l(a,b,d,p,g):g.map(function(c){return m(a,b,d,p,c,s)}),a.seen.pop(),n(x,r,u)}function j(a,b){if(v(b))return a.stylize("undefined","undefined");if(t(b)){var c="'"+JSON.stringify(b).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return a.stylize(c,"string")}return s(b)?a.stylize(""+b,"number"):p(b)?a.stylize(""+b,"boolean"):q(b)?a.stylize("null","null"):void 0}function k(a){return"["+Error.prototype.toString.call(a)+"]"}function l(a,b,c,d,e){for(var f=[],g=0,h=b.length;g<h;++g)F(b,String(g))?f.push(m(a,b,c,d,String(g),!0)):f.push("");return e.forEach(function(e){e.match(/^\d+$/)||f.push(m(a,b,c,d,e,!0))}),f}function m(a,b,c,d,e,f){var g,h,j;if(j=Object.getOwnPropertyDescriptor(b,e)||{value:b[e]},j.get?h=j.set?a.stylize("[Getter/Setter]","special"):a.stylize("[Getter]","special"):j.set&&(h=a.stylize("[Setter]","special")),F(d,e)||(g="["+e+"]"),h||(a.seen.indexOf(j.value)<0?(h=q(c)?i(a,j.value,null):i(a,j.value,c-1),h.indexOf("\n")>-1&&(h=f?h.split("\n").map(function(a){return"  "+a}).join("\n").substr(2):"\n"+h.split("\n").map(function(a){return"   "+a}).join("\n"))):h=a.stylize("[Circular]","special")),v(g)){if(f&&e.match(/^\d+$/))return h;g=JSON.stringify(""+e),g.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(g=g.substr(1,g.length-2),g=a.stylize(g,"name")):(g=g.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),g=a.stylize(g,"string"))}return g+": "+h}function n(a,b,c){var d=0,e=a.reduce(function(a,b){return d++,b.indexOf("\n")>=0&&d++,a+b.replace(/\u001b\[\d\d?m/g,"").length+1},0);return e>60?c[0]+(""===b?"":b+"\n ")+" "+a.join(",\n  ")+" "+c[1]:c[0]+b+" "+a.join(", ")+" "+c[1]}function o(a){return Array.isArray(a)}function p(a){return"boolean"==typeof a}function q(a){return null===a}function r(a){return null==a}function s(a){return"number"==typeof a}function t(a){return"string"==typeof a}function u(a){return"symbol"==typeof a}function v(a){return void 0===a}function w(a){return x(a)&&"[object RegExp]"===C(a)}function x(a){return"object"==typeof a&&null!==a}function y(a){return x(a)&&"[object Date]"===C(a)}function z(a){return x(a)&&("[object Error]"===C(a)||a instanceof Error)}function A(a){return"function"==typeof a}function B(a){return null===a||"boolean"==typeof a||"number"==typeof a||"string"==typeof a||"symbol"==typeof a||"undefined"==typeof a}function C(a){return Object.prototype.toString.call(a)}function D(a){return a<10?"0"+a.toString(10):a.toString(10)}function E(){var a=new Date,b=[D(a.getHours()),D(a.getMinutes()),D(a.getSeconds())].join(":");return[a.getDate(),J[a.getMonth()],b].join(" ")}function F(a,b){return Object.prototype.hasOwnProperty.call(a,b)}var G=/%[sdj%]/g;c.format=function(a){if(!t(a)){for(var b=[],c=0;c<arguments.length;c++)b.push(e(arguments[c]));return b.join(" ")}for(var c=1,d=arguments,f=d.length,g=String(a).replace(G,function(a){if("%%"===a)return"%";if(c>=f)return a;switch(a){case"%s":return String(d[c++]);case"%d":return Number(d[c++]);case"%j":try{return JSON.stringify(d[c++])}catch(a){return"[Circular]"}default:return a}}),h=d[c];c<f;h=d[++c])g+=q(h)||!x(h)?" "+h:" "+e(h);return g},c.deprecate=function(a,e){function f(){if(!g){if(b.throwDeprecation)throw new Error(e);b.traceDeprecation?console.trace(e):console.error(e),g=!0}return a.apply(this,arguments)}if(v(d.process))return function(){return c.deprecate(a,e).apply(this,arguments)};if(b.noDeprecation===!0)return a;var g=!1;return f};var H,I={};c.debuglog=function(a){if(v(H)&&(H=b.env.NODE_DEBUG||""),a=a.toUpperCase(),!I[a])if(new RegExp("\\b"+a+"\\b","i").test(H)){var d=b.pid;I[a]=function(){var b=c.format.apply(c,arguments);console.error("%s %d: %s",a,d,b)}}else I[a]=function(){};return I[a]},c.inspect=e,e.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},e.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},c.isArray=o,c.isBoolean=p,c.isNull=q,c.isNullOrUndefined=r,c.isNumber=s,c.isString=t,c.isSymbol=u,c.isUndefined=v,c.isRegExp=w,c.isObject=x,c.isDate=y,c.isError=z,c.isFunction=A,c.isPrimitive=B,c.isBuffer=a("./support/isBuffer");var J=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];c.log=function(){console.log("%s - %s",E(),c.format.apply(c,arguments))},c.inherits=a("inherits"),c._extend=function(a,b){if(!b||!x(b))return a;for(var c=Object.keys(b),d=c.length;d--;)a[c[d]]=b[c[d]];return a}}).call(this,a("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./support/isBuffer":570,_process:556,inherits:569}],572:[function(b,c,d){!function(c){function d(){return"Markdown.mk_block( "+uneval(this.toString())+", "+uneval(this.trailing)+", "+uneval(this.lineNumber)+" )"}function e(){var a=b("util");return"Markdown.mk_block( "+a.inspect(this.toString())+", "+a.inspect(this.trailing)+", "+a.inspect(this.lineNumber)+" )"}function f(a){for(var b=0,c=-1;(c=a.indexOf("\n",c+1))!==-1;)b++;return b}function g(a,b){function c(a){this.len_after=a,this.name="close_"+b}var d=a+"_state",e="strong"==a?"em_state":"strong_state";return function(f,g){if(this[d][0]==b)return this[d].shift(),[f.length,new c(f.length-b.length)];var h=this[e].slice(),i=this[d].slice();this[d].unshift(b);var j=this.processInline(f.substr(b.length)),k=j[j.length-1];this[d].shift();if(k instanceof c){j.pop();var l=f.length-k.len_after;return[l,[a].concat(j)]}return this[e]=h,this[d]=i,[b.length,b]}}function h(a){for(var b=a.split(""),c=[""],d=!1;b.length;){var e=b.shift();switch(e){case" ":d?c[c.length-1]+=e:c.push("");break;case"'":case'"':d=!d;break;case"\\":e=b.shift();default:c[c.length-1]+=e}}return c}function i(a){return r(a)&&a.length>1&&"object"==typeof a[1]&&!r(a[1])?a[1]:void 0}function j(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function k(a){if("string"==typeof a)return j(a);var b=a.shift(),c={},d=[];for(!a.length||"object"!=typeof a[0]||a[0]instanceof Array||(c=a.shift());a.length;)d.push(k(a.shift()));var e="";for(var f in c)e+=" "+f+'="'+j(c[f])+'"';return"img"==b||"br"==b||"hr"==b?"<"+b+e+"/>":"<"+b+e+">"+d.join("")+"</"+b+">"}function l(a,b,c){var d;c=c||{};var e=a.slice(0);"function"==typeof c.preprocessTreeNode&&(e=c.preprocessTreeNode(e,b));var f=i(e);if(f){e[1]={};for(d in f)e[1][d]=f[d];f=e[1]}if("string"==typeof e)return e;switch(e[0]){case"header":e[0]="h"+e[1].level,delete e[1].level;break;case"bulletlist":e[0]="ul";break;case"numberlist":e[0]="ol";break;case"listitem":e[0]="li";break;case"para":e[0]="p";break;case"markdown":e[0]="html",f&&delete f.references;break;case"code_block":e[0]="pre",d=f?2:1;var g=["code"];g.push.apply(g,e.splice(d,e.length-d)),e[d]=g;break;case"inlinecode":e[0]="code";break;case"img":e[1].src=e[1].href,delete e[1].href;break;case"linebreak":e[0]="br";break;case"link":e[0]="a";break;case"link_ref":e[0]="a";var h=b[f.ref];if(!h)return f.original;delete f.ref,f.href=h.href,h.title&&(f.title=h.title),delete f.original;break;case"img_ref":e[0]="img";var h=b[f.ref];if(!h)return f.original;delete f.ref,f.src=h.href,h.title&&(f.title=h.title),delete f.original}if(d=1,f){for(var j in e[1]){d=2;break}1===d&&e.splice(d,1)}for(;d<e.length;++d)e[d]=l(e[d],b,c);return e}function m(a){for(var b=i(a)?2:1;b<a.length;)"string"==typeof a[b]?b+1<a.length&&"string"==typeof a[b+1]?a[b]+=a.splice(b+1,1)[0]:++b:(m(a[b]),++b)}var n=c.Markdown=function(a){switch(typeof a){case"undefined":this.dialect=n.dialects.Gruber;break;case"object":this.dialect=a;break;default:if(!(a in n.dialects))throw new Error("Unknown Markdown dialect '"+String(a)+"'");this.dialect=n.dialects[a]}this.em_state=[],this.strong_state=[],this.debug_indent=""};c.parse=function(a,b){var c=new n(b);return c.toTree(a)},c.toHTML=function(a,b,d){var e=c.toHTMLTree(a,b,d);return c.renderJsonML(e)},c.toHTMLTree=function(a,b,c){"string"==typeof a&&(a=this.parse(a,b));var d=i(a),e={};d&&d.references&&(e=d.references);var f=l(a,e,c);return m(f),f};var o=n.mk_block=function(a,b,c){1==arguments.length&&(b="\n\n");var f=new String(a);return f.trailing=b,f.inspect=e,f.toSource=d,void 0!=c&&(f.lineNumber=c),f};n.prototype.split_blocks=function(a,b){a=a.replace(/(\r\n|\n|\r)/g,"\n");var c,d=/([\s\S]+?)($|\n#|\n(?:\s*\n|$)+)/g,e=[],g=1;for(null!=(c=/^(\s*\n)/.exec(a))&&(g+=f(c[0]),d.lastIndex=c[0].length);null!==(c=d.exec(a));)"\n#"==c[2]&&(c[2]="\n",d.lastIndex--),e.push(o(c[1],c[2],g)),g+=f(c[0]);return e},n.prototype.processBlock=function(a,b){var c=this.dialect.block,d=c.__order__;if("__call__"in c)return c.__call__.call(this,a,b);for(var e=0;e<d.length;e++){var f=c[d[e]].call(this,a,b);if(f)return(!r(f)||f.length>0&&!r(f[0]))&&this.debug(d[e],"didn't return a proper array"),f}return[]},n.prototype.processInline=function(a){return this.dialect.inline.__call__.call(this,String(a))},n.prototype.toTree=function(a,b){var c=a instanceof Array?a:this.split_blocks(a),d=this.tree;try{for(this.tree=b||this.tree||["markdown"];c.length;){var e=this.processBlock(c.shift(),c);e.length&&this.tree.push.apply(this.tree,e)}return this.tree}finally{b&&(this.tree=d)}},n.prototype.debug=function(){var a=Array.prototype.slice.call(arguments);a.unshift(this.debug_indent),"undefined"!=typeof print&&print.apply(print,a),"undefined"!=typeof console&&"undefined"!=typeof console.log&&console.log.apply(null,a)},n.prototype.loop_re_over_block=function(a,b,c){for(var d,e=b.valueOf();e.length&&null!=(d=a.exec(e));)e=e.substr(d[0].length),c.call(this,d);return e},n.dialects={},n.dialects.Gruber={block:{atxHeader:function(a,b){var c=a.match(/^(#{1,6})\s*(.*?)\s*#*\s*(?:\n|$)/);if(c){var d=["header",{level:c[1].length}];return Array.prototype.push.apply(d,this.processInline(c[2])),c[0].length<a.length&&b.unshift(o(a.substr(c[0].length),a.trailing,a.lineNumber+2)),[d]}},setextHeader:function(a,b){var c=a.match(/^(.*)\n([-=])\2\2+(?:\n|$)/);if(c){var d="="===c[2]?1:2,e=["header",{level:d},c[1]];return c[0].length<a.length&&b.unshift(o(a.substr(c[0].length),a.trailing,a.lineNumber+2)),[e]}},code:function(a,b){var c=[],d=/^(?: {0,3}\t| {4})(.*)\n?/;if(a.match(d)){a:for(;;){var e=this.loop_re_over_block(d,a.valueOf(),function(a){c.push(a[1])});if(e.length){b.unshift(o(e,a.trailing));break a}if(!b.length)break a;if(!b[0].match(d))break a;c.push(a.trailing.replace(/[^\n]/g,"").substring(2)),a=b.shift()}return[["code_block",c.join("\n")]]}},horizRule:function(a,b){var c=a.match(/^(?:([\s\S]*?)\n)?[ \t]*([-_*])(?:[ \t]*\2){2,}[ \t]*(?:\n([\s\S]*))?$/);if(c){var d=[["hr"]];return c[1]&&d.unshift.apply(d,this.processBlock(c[1],[])),c[3]&&b.unshift(o(c[3])),d}},lists:function(){function a(a){return new RegExp("(?:^("+i+"{0,"+a+"} {0,3})("+f+")\\s+)|(^"+i+"{0,"+(a-1)+"}[ ]{0,4})")}function b(a){return a.replace(/ {0,3}\t/g,"    ")}function c(a,b,c,d){if(b)return void a.push(["para"].concat(c));var e=a[a.length-1]instanceof Array&&"para"==a[a.length-1][0]?a[a.length-1]:a;d&&a.length>1&&c.unshift(d);for(var f=0;f<c.length;f++){var g=c[f],h="string"==typeof g;h&&e.length>1&&"string"==typeof e[e.length-1]?e[e.length-1]+=g:e.push(g)}}function d(a,b){for(var c=new RegExp("^("+i+"{"+a+"}.*?\\n?)*$"),d=new RegExp("^"+i+"{"+a+"}","gm"),e=[];b.length>0&&c.exec(b[0]);){var f=b.shift(),g=f.replace(d,"");e.push(o(g,f.trailing,f.lineNumber))}return e}function e(a,b,c){var d=a.list,e=d[d.length-1];if(!(e[1]instanceof Array&&"para"==e[1][0]))if(b+1==c.length)e.push(["para"].concat(e.splice(1,e.length-1)));else{var f=e.pop();e.push(["para"].concat(e.splice(1,e.length-1)),f)}}var f="[*+-]|\\d+\\.",g=/[*+-]/,h=new RegExp("^( {0,3})("+f+")[ \t]+"),i="(?: {0,3}\\t| {4})";return function(f,i){function j(a){var b=g.exec(a[2])?["bulletlist"]:["numberlist"];return n.push({list:b,indent:a[1]}),b}var k=f.match(h);if(k){for(var l,m,n=[],o=j(k),p=!1,r=[n[0].list];;){for(var s=f.split(/(?=\n)/),t="",u=0;u<s.length;u++){var v="",w=s[u].replace(/^\n/,function(a){return v=a,""}),x=a(n.length);if(k=w.match(x),void 0!==k[1]){t.length&&(c(l,p,this.processInline(t),v),p=!1,t=""),k[1]=b(k[1]);var y=Math.floor(k[1].length/4)+1;if(y>n.length)o=j(k),l.push(o),l=o[1]=["listitem"];else{var z=!1;for(m=0;m<n.length;m++)if(n[m].indent==k[1]){o=n[m].list,n.splice(m+1,n.length-(m+1)),z=!0;break}z||(y++,y<=n.length?(n.splice(y,n.length-y),o=n[y-1].list):(o=j(k),l.push(o))),l=["listitem"],o.push(l)}v=""}w.length>k[0].length&&(t+=v+w.substr(k[0].length))}t.length&&(c(l,p,this.processInline(t),v),p=!1,t="");var A=d(n.length,i);A.length>0&&(q(n,e,this),l.push.apply(l,this.toTree(A,[])));var B=i[0]&&i[0].valueOf()||"";if(!B.match(h)&&!B.match(/^ /))break;f=i.shift();var C=this.dialect.block.horizRule(f,i);if(C){r.push.apply(r,C);break}q(n,e,this),p=!0}return r}}}(),blockquote:function(a,b){if(a.match(/^>/m)){var c=[];if(">"!=a[0]){for(var d=a.split(/\n/),e=[],f=a.lineNumber;d.length&&">"!=d[0][0];)e.push(d.shift()),f++;var g=o(e.join("\n"),"\n",a.lineNumber);c.push.apply(c,this.processBlock(g,[])),a=o(d.join("\n"),a.trailing,f)}for(;b.length&&">"==b[0][0];){var h=b.shift();a=o(a+a.trailing+h,h.trailing,a.lineNumber)}var j=a.replace(/^> ?/gm,""),k=(this.tree,this.toTree(j,["blockquote"])),l=i(k);return l&&l.references&&(delete l.references,s(l)&&k.splice(1,1)),c.push(k),c}},referenceDefn:function(a,b){var c=/^\s*\[(.*?)\]:\s*(\S+)(?:\s+(?:(['"])(.*?)\3|\((.*?)\)))?\n?/;if(a.match(c)){i(this.tree)||this.tree.splice(1,0,{});var d=i(this.tree);void 0===d.references&&(d.references={});var e=this.loop_re_over_block(c,a,function(a){a[2]&&"<"==a[2][0]&&">"==a[2][a[2].length-1]&&(a[2]=a[2].substring(1,a[2].length-1));var b=d.references[a[1].toLowerCase()]={href:a[2]};void 0!==a[4]?b.title=a[4]:void 0!==a[5]&&(b.title=a[5])});return e.length&&b.unshift(o(e,a.trailing)),[]}},para:function(a,b){return[["para"].concat(this.processInline(a))]}}},n.dialects.Gruber.inline={__oneElement__:function(a,b,c){var d,e;b=b||this.dialect.inline.__patterns__;var f=new RegExp("([\\s\\S]*?)("+(b.source||b)+")");if(d=f.exec(a),!d)return[a.length,a];if(d[1])return[d[1].length,d[1]];var e;return d[2]in this.dialect.inline&&(e=this.dialect.inline[d[2]].call(this,a.substr(d.index),d,c||[])),e=e||[d[2].length,d[2]]},__call__:function(a,b){function c(a){"string"==typeof a&&"string"==typeof e[e.length-1]?e[e.length-1]+=a:e.push(a)}for(var d,e=[];a.length>0;)d=this.dialect.inline.__oneElement__.call(this,a,b,e),a=a.substr(d.shift()),q(d,c);return e},"]":function(){},"}":function(){},__escape__:/^\\[\\`\*_{}\[\]()#\+.!\-]/,"\\":function(a){return this.dialect.inline.__escape__.exec(a)?[2,a.charAt(1)]:[1,"\\"]},"![":function(a){var b=a.match(/^!\[(.*?)\][ \t]*\([ \t]*([^")]*?)(?:[ \t]+(["'])(.*?)\3)?[ \t]*\)/);if(b){b[2]&&"<"==b[2][0]&&">"==b[2][b[2].length-1]&&(b[2]=b[2].substring(1,b[2].length-1)),b[2]=this.dialect.inline.__call__.call(this,b[2],/\\/)[0];var c={alt:b[1],href:b[2]||""};return void 0!==b[4]&&(c.title=b[4]),[b[0].length,["img",c]]}return b=a.match(/^!\[(.*?)\][ \t]*\[(.*?)\]/),b?[b[0].length,["img_ref",{alt:b[1],ref:b[2].toLowerCase(),original:b[0]}]]:[2,"!["]},"[":function a(b){var c=String(b),d=n.DialectHelpers.inline_until_char.call(this,b.substr(1),"]");if(!d)return[1,"["];var a,e,f=1+d[0],g=d[1];b=b.substr(f);var h=b.match(/^\s*\([ \t]*([^"']*)(?:[ \t]+(["'])(.*?)\2)?[ \t]*\)/);if(h){var i=h[1];if(f+=h[0].length,i&&"<"==i[0]&&">"==i[i.length-1]&&(i=i.substring(1,i.length-1)),!h[3])for(var j=1,k=0;k<i.length;k++)switch(i[k]){case"(":j++;break;case")":0==--j&&(f-=i.length-k,i=i.substring(0,k))}return i=this.dialect.inline.__call__.call(this,i,/\\/)[0],e={href:i||""},void 0!==h[3]&&(e.title=h[3]),a=["link",e].concat(g),[f,a]}return h=b.match(/^\s*\[(.*?)\]/),h?(f+=h[0].length,e={ref:(h[1]||String(g)).toLowerCase(),original:c.substr(0,f)},a=["link_ref",e].concat(g),[f,a]):1==g.length&&"string"==typeof g[0]?(e={ref:g[0].toLowerCase(),original:c.substr(0,f)},a=["link_ref",e,g[0]],[f,a]):[1,"["]},"<":function(a){var b;return null!=(b=a.match(/^<(?:((https?|ftp|mailto):[^>]+)|(.*?@.*?\.[a-zA-Z]+))>/))?b[3]?[b[0].length,["link",{href:"mailto:"+b[3]},b[3]]]:"mailto"==b[2]?[b[0].length,["link",{href:b[1]},b[1].substr("mailto:".length)]]:[b[0].length,["link",{href:b[1]},b[1]]]:[1,"<"]},"`":function(a){var b=a.match(/(`+)(([\s\S]*?)\1)/);return b&&b[2]?[b[1].length+b[2].length,["inlinecode",b[3]]]:[1,"`"]},"  \n":function(a){return[3,["linebreak"]]}},n.dialects.Gruber.inline["**"]=g("strong","**"),n.dialects.Gruber.inline.__=g("strong","__"),n.dialects.Gruber.inline["*"]=g("em","*"),n.dialects.Gruber.inline._=g("em","_"),n.buildBlockOrder=function(a){var b=[];for(var c in a)"__order__"!=c&&"__call__"!=c&&b.push(c);a.__order__=b},n.buildInlinePatterns=function(a){var b=[];for(var c in a)if(!c.match(/^__.*__$/)){var d=c.replace(/([\\.*+?|()\[\]{}])/g,"\\$1").replace(/\n/,"\\n");b.push(1==c.length?d:"(?:"+d+")")}b=b.join("|"),a.__patterns__=b;var e=a.__call__;a.__call__=function(a,c){return void 0!=c?e.call(this,a,c):e.call(this,a,b)}},n.DialectHelpers={},n.DialectHelpers.inline_until_char=function(a,b){for(var c=0,d=[];;){if(a.charAt(c)==b)return c++,[c,d];if(c>=a.length)return null;var e=this.dialect.inline.__oneElement__.call(this,a.substr(c));c+=e[0],d.push.apply(d,e.slice(1))}},n.subclassDialect=function(a){function b(){}function c(){}return b.prototype=a.block,c.prototype=a.inline,{block:new b,inline:new c}},n.buildBlockOrder(n.dialects.Gruber.block),n.buildInlinePatterns(n.dialects.Gruber.inline),n.dialects.Maruku=n.subclassDialect(n.dialects.Gruber),n.dialects.Maruku.processMetaHash=function(a){for(var b=h(a),c={},d=0;d<b.length;++d)if(/^#/.test(b[d]))c.id=b[d].substring(1);else if(/^\./.test(b[d]))c.class?c.class=c.class+b[d].replace(/./," "):c.class=b[d].substring(1);else if(/\=/.test(b[d])){var e=b[d].split(/\=/);c[e[0]]=e[1]}return c},n.dialects.Maruku.block.document_meta=function(a,b){if(!(a.lineNumber>1)&&a.match(/^(?:\w+:.*\n)*\w+:.*$/)){i(this.tree)||this.tree.splice(1,0,{});var c=a.split(/\n/);for(p in c){var d=c[p].match(/(\w+):\s*(.*)$/),e=d[1].toLowerCase(),f=d[2];this.tree[1][e]=f}return[]}},n.dialects.Maruku.block.block_meta=function(b,c){var d=b.match(/(^|\n) {0,3}\{:\s*((?:\\\}|[^\}])*)\s*\}$/);if(d){var e,f=this.dialect.processMetaHash(d[2]);if(""===d[1]){var g=this.tree[this.tree.length-1];if(e=i(g),"string"==typeof g)return;e||(e={},g.splice(1,0,e));for(a in f)e[a]=f[a];return[]}var h=b.replace(/\n.*$/,""),j=this.processBlock(h,[]);e=i(j[0]),e||(e={},j[0].splice(1,0,e));for(a in f)e[a]=f[a];return j}},n.dialects.Maruku.block.definition_list=function(a,b){var c,d,e=/^((?:[^\s:].*\n)+):\s+([\s\S]+)$/,f=["dl"];if(d=a.match(e)){for(var g=[a];b.length&&e.exec(b[0]);)g.push(b.shift());for(var h=0;h<g.length;++h){var d=g[h].match(e),i=d[1].replace(/\n$/,"").split(/\n/),j=d[2].split(/\n:\s+/);for(c=0;c<i.length;++c)f.push(["dt",i[c]]);for(c=0;c<j.length;++c)f.push(["dd"].concat(this.processInline(j[c].replace(/(\n)\s+/,"$1"))))}return[f]}},n.dialects.Maruku.block.table=function a(b,c){var d,e,f=function(a,b){b=b||"\\s",b.match(/^[\\|\[\]{}?*.+^$]$/)&&(b="\\"+b);for(var c,d=[],e=new RegExp("^((?:\\\\.|[^\\\\"+b+"])*)"+b+"(.*)");c=a.match(e);)d.push(c[1]),a=c[2];return d.push(a),d},g=/^ {0,3}\|(.+)\n {0,3}\|\s*([\-:]+[\-| :]*)\n((?:\s*\|.*(?:\n|$))*)(?=\n|$)/,h=/^ {0,3}(\S(?:\\.|[^\\|])*\|.*)\n {0,3}([\-:]+\s*\|[\-| :]*)\n((?:(?:\\.|[^\\|])*\|.*(?:\n|$))*)(?=\n|$)/;if(e=b.match(g))e[3]=e[3].replace(/^\s*\|/gm,"");else if(!(e=b.match(h)))return;var a=["table",["thead",["tr"]],["tbody"]];e[2]=e[2].replace(/\|\s*$/,"").split("|");var i=[];for(q(e[2],function(a){a.match(/^\s*-+:\s*$/)?i.push({align:"right"}):a.match(/^\s*:-+\s*$/)?i.push({align:"left"}):a.match(/^\s*:-+:\s*$/)?i.push({align:"center"}):i.push({})}),e[1]=f(e[1].replace(/\|\s*$/,""),"|"),d=0;d<e[1].length;d++)a[1][1].push(["th",i[d]||{}].concat(this.processInline(e[1][d].trim())));return q(e[3].replace(/\|\s*$/gm,"").split("\n"),function(b){var c=["tr"];for(b=f(b,"|"),d=0;d<b.length;d++)c.push(["td",i[d]||{}].concat(this.processInline(b[d].trim())));a[2].push(c)},this),[a]},n.dialects.Maruku.inline["{:"]=function(a,b,c){if(!c.length)return[2,"{:"];var d=c[c.length-1];if("string"==typeof d)return[2,"{:"];var e=a.match(/^\{:\s*((?:\\\}|[^\}])*)\s*\}/);if(!e)return[2,"{:"];var f=this.dialect.processMetaHash(e[1]),g=i(d);g||(g={},d.splice(1,0,g));for(var h in f)g[h]=f[h];return[e[0].length,""]},n.dialects.Maruku.inline.__escape__=/^\\[\\`\*_{}\[\]()#\+.!\-|:]/,n.buildBlockOrder(n.dialects.Maruku.block),n.buildInlinePatterns(n.dialects.Maruku.inline);var q,r=Array.isArray||function(a){return"[object Array]"==Object.prototype.toString.call(a)};q=Array.prototype.forEach?function(a,b,c){return a.forEach(b,c)}:function(a,b,c){for(var d=0;d<a.length;d++)b.call(c||a,a[d],d,a)};var s=function(a){for(var b in a)if(hasOwnProperty.call(a,b))return!1;return!0};c.renderJsonML=function(a,b){b=b||{},b.root=b.root||!1;var c=[];if(b.root)c.push(k(a));else for(a.shift(),!a.length||"object"!=typeof a[0]||a[0]instanceof Array||a.shift();a.length;)c.push(k(a.shift()));return c.join("\n\n")}}(function(){return"undefined"==typeof d?(window.markdown={},window.markdown):d}())},{util:571}]},{},[514,290,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,371,372,373,374,376,377,378,379,380,381,382,383,386,387,388,389,390,391,392,393,394,395,396,397,398,399,400,401,402,403,404,405,406,407,408,409,410,411,412,413,414,415,416,417,418,419,420,421,422,423,424,425,426,427,428,429,430,431,432,433,434,435,436,437,438,439,440,441,442,443,444,445,446,447,448,450,451,452,453,454,455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473,474,475,476,477,480,484,485,486,487,488,489,490,491,492,493,494,495,496,497,498,499,500,501,502,503,504,505,506,507,508,509,510,511,512,513,478,479,483,481,482]);
//# sourceMappingURL=specs.js.map