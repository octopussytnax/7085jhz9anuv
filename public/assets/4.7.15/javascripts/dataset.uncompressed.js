(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var CarouselView = require('./custom-carousel/custom-carousel-view');

/**
 *  Carousel form view
 */

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!opts.collection) throw new Error('Carousel collection is required');
    if (!opts.template) throw new Error('template is required');
    this.template = opts.template;
    this._initBinds();
  },

  render: function () {
    var selectedItem = this.collection.getSelected();
    var selectedName = selectedItem && selectedItem.getName();
    this.$el.html(
      this.template({
        name: selectedName
      })
    );
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this.collection.bind('change:highlighted', this._onChangeHighlighted, this);
  },

  _initViews: function () {
    var carousel = new CarouselView(_.extend(this.options, {
      collection: this.collection
    }));

    if (!this.$('.js-selector').length) throw new Error('HTML element with js-selector class is required');

    this.$('.js-selector').append(carousel.render().el);
    carousel.initScroll();
    this.addView(carousel);
  },

  _onChangeHighlighted: function () {
    var item = this.collection.getHighlighted() || this.collection.getSelected();
    if (item) {
      var $el = this.$('.js-highlight');
      if ($el) {
        $el.text(item.getName());
      }
    }
  }

});

},{"./custom-carousel/custom-carousel-view":20,"backbone/core-view":454,"underscore":"underscore"}],2:[function(require,module,exports){
var COLOR_KEYWORDS = require('../../helpers/color-keywords');

/*
  LESS mode - http://www.lesscss.org/
  Ported to CodeMirror by Peter Kroon <plakroon@gmail.com>
  Report bugs/issues here: https://github.com/marijnh/CodeMirror/issues  GitHub: @peterkroon
*/

module.exports = function (CodeMirror) {
  CodeMirror.defineMode('cartocss', function (config) {
    var indentUnit = config.indentUnit;
    var type;

    function ret (style, tp) {
      type = tp;
      return style;
    }
    // html tags
    var tags = 'a abbr acronym address applet area article aside audio b base basefont bdi bdo big blockquote body br button canvas caption cite code col colgroup command datalist dd del details dfn dir div dl dt em embed fieldset figcaption figure font footer form frame frameset h1 h2 h3 h4 h5 h6 head header hgroup hr html i iframe img input ins keygen kbd label legend li link map mark menu meta meter nav noframes noscript object ol optgroup option output p param pre progress q rp rt ruby s samp script section select small source span strike strong style sub summary sup table tbody td textarea tfoot th thead time title tr track tt u ul var video wbr'.split(' ');
    var colorKeywords = keySet(COLOR_KEYWORDS);

    function inTagsArray (val) {
      for (var i = 0; i < tags.length; i++) {
        if (val === tags[i]) return true;
      }
    }

    var selectors = /(^\:root$|^\:nth\-child$|^\:nth\-last\-child$|^\:nth\-of\-type$|^\:nth\-last\-of\-type$|^\:first\-child$|^\:last\-child$|^\:first\-of\-type$|^\:last\-of\-type$|^\:only\-child$|^\:only\-of\-type$|^\:empty$|^\:link|^\:visited$|^\:active$|^\:hover$|^\:focus$|^\:target$|^\:lang$|^\:enabled^\:disabled$|^\:checked$|^\:first\-line$|^\:first\-letter$|^\:before$|^\:after$|^\:not$|^\:required$|^\:invalid$)/;

    function tokenBase (stream, state) {
      var ch = stream.next();

      if (ch === '@') {
        stream.eatWhile(/[\w\-]/);
        return ret('meta', stream.current());
      } else if (ch === '/' && stream.eat('*')) {
        state.tokenize = tokenCComment;
        return tokenCComment(stream, state);
      } else if (ch === '<' && stream.eat('!')) {
        state.tokenize = tokenSGMLComment;
        return tokenSGMLComment(stream, state);
      } else if (ch === '=') ret(null, 'compare');
      else if (ch === '|' && stream.eat('=')) return ret(null, 'compare');
      else if (ch === '\'' || ch === '\'') {
        state.tokenize = tokenString(ch);
        return state.tokenize(stream, state);
      } else if (ch === '/') { // e.g.: .png will not be parsed as a class
        if (stream.eat('/')) {
          state.tokenize = tokenSComment;
          return tokenSComment(stream, state);
        } else {
          if (type === 'string' || type === '(') {
            return ret('string', 'string');
          }
          if (state.stack[state.stack.length - 1] !== undefined) {
            return ret(null, ch);
          }
          stream.eatWhile(/[\a-zA-Z0-9\-_.\s]/);
          if (/\/|\)|#/.test(stream.peek() || (stream.eatSpace() && stream.peek() === ')')) || stream.eol()) {
            return ret('string', 'string'); // let url(/images/logo.png) without quotes return as string
          }
        }
      } else if (ch === '!') {
        stream.match(/^\s*\w*/);
        return ret('keyword', 'important');
      } else if (/\d/.test(ch)) {
        stream.eatWhile(/[\w.%]/);
        return ret('number', 'unit');
      } else if (/[,+<>*\/]/.test(ch)) {
        if (stream.peek() === '=' || type === 'a') {
          return ret('string', 'string');
        }
        return ret(null, 'select-op');
      } else if (/[;{}:\[\]()~\|]/.test(ch)) {
        if (ch === ':') {
          stream.eatWhile(/[a-z\\\-]/);

          if (selectors.test(stream.current())) {
            return ret('tag', 'tag');
          } else if (stream.peek() === ':') { // ::-webkit-search-decoration
            stream.next();
            stream.eatWhile(/[a-z\\\-]/);
            if (stream.current().match(/\:\:\-(o|ms|moz|webkit)\-/)) {
              return ret('string', 'string');
            }
            if (selectors.test(stream.current().substring(1))) {
              return ret('tag', 'tag');
            }
            return ret(null, ch);
          } else {
            return ret(null, ch);
          }
        } else if (ch === '~') {
          if (type === 'r') {
            return ret('string', 'string');
          }
        } else {
          return ret(null, ch);
        }
      } else if (ch === '.') {
        if (type === '(' || type === 'string') {
          return ret('string', 'string'); // allow url(../image.png)
        }
        stream.eatWhile(/[\a-zA-Z0-9\-_]/);
        if (stream.peek() === ' ') {
          stream.eatSpace();
        }
        if (stream.peek() === ')') {
          return ret('number', 'unit'); // rgba(0,0,0,.25);
        }
        return ret('tag', 'tag');
      } else if (ch === '#') {
        // we don't eat white-space, we want the hex color and or id only
        stream.eatWhile(/[A-Za-z0-9]/);
        // check if there is a proper hex color length e.g. #eee || #eeeEEE
        if (stream.current().length === 4 || stream.current().length === 7) {
          if (stream.current().match(/[A-Fa-f0-9]{6}|[A-Fa-f0-9]{3}/, false) != null) { // is there a valid hex color value present in the current stream
            // when not a valid hex value, parse as id
            if (stream.current().substring(1) !== stream.current().match(/[A-Fa-f0-9]{6}|[A-Fa-f0-9]{3}/, false)[0]) {
              return ret('atom', 'tag');
            }
            // eat white-space
            stream.eatSpace();
            // when hex value declaration doesn't end with [;,] but is does with a slash/cc comment treat it as an id, just like the other hex values that don't end with[;,]
            if (/[\/<>.({!$%^&*_\-\\?=+\|#'~`]/.test(stream.peek())) {
              return ret('atom', 'tag');
            } else if (stream.peek() === '}') {
              // #time { color: #aaa }
              return ret('color', 'unit');
            } else if (/[a-zA-Z\\]/.test(stream.peek())) {
              // we have a valid hex color value, parse as id whenever an element/class is defined after the hex(id) value e.g. #eee aaa || #eee .aaa
              return ret('color', 'unit');
            } else if (stream.eol()) {
              // when a hex value is on the end of a line, parse as id
              return ret('color', 'unit');
            } else {
              // default
              return ret('color', 'unit');
            }
          } else { // when not a valid hexvalue in the current stream e.g. #footer
            stream.eatWhile(/[\w\\\-]/);
            return ret('atom', 'tag');
          }
        } else { // when not a valid hexvalue length
          stream.eatWhile(/[\w\\\-]/);
          return ret('atom', 'tag');
        }
      } else if (ch === '&') {
        stream.eatWhile(/[\w\-]/);
        return ret(null, ch);
      } else {
        stream.eatWhile(/[\w\\\-_%.{]/);
        if (type === 'string') {
          return ret('string', 'string');
        } else if (stream.current().match(/(^http$|^https$)/) != null) {
          stream.eatWhile(/[\w\\\-_%.{:\/]/);
          return ret('string', 'string');
        } else if (stream.peek() === '<' || stream.peek() === '>') {
          return ret('tag', 'tag');
        } else if (/\(/.test(stream.peek())) {
          return ret(null, ch);
        } else if (stream.peek() === '/' && state.stack[state.stack.length - 1] !== undefined) { // url(dir/center/image.png)
          return ret('string', 'string');
        } else if (stream.current().match(/\-\d|\-.\d/)) { // match e.g.: -5px -0.4 etc... only colorize the minus sign
          // commment out these 2 comment if you want the minus sign to be parsed as null -500px
          // stream.backUp(stream.current().length-1);
          // return ret(null, ch); //console.log( stream.current() );
          return ret('number', 'unit');
        } else if (inTagsArray(stream.current().toLowerCase())) { // match html tags
          return ret('tag', 'tag');
        } else if (/\/|[\s\)]/.test(stream.peek() || stream.eol() || (stream.eatSpace() && stream.peek() === '/')) && stream.current().indexOf('.') !== -1) {
          if (stream.current().substring(stream.current().length - 1, stream.current().length) === '{') {
            stream.backUp(1);
            return ret('tag', 'tag');
          } // end if
          stream.eatSpace();
          if (/[{<>.a-zA-Z\/]/.test(stream.peek()) || stream.eol()) return ret('tag', 'tag'); // e.g. button.icon-plus
          return ret('string', 'string'); // let url(/images/logo.png) without quotes return as string
        } else if (stream.eol() || stream.peek() === '[' || stream.peek() === '#' || type === 'tag') {
          if (stream.current().substring(stream.current().length - 1, stream.current().length) === '{') stream.backUp(1);
          return ret('tag', 'tag');
        } else if (type === 'compare' || type === 'a' || type === '(') {
          return ret('string', 'string');
        } else if (type === '|' || stream.current() === '-' || type === '[') {
          return ret(null, ch);
        } else if (stream.peek() === ':') {
          stream.next();
          var t_v = stream.peek() === ':';
          if (!t_v) {
            var old_pos = stream.pos;
            var sc = stream.current().length;
            stream.eatWhile(/[a-z\\\-]/);
            var new_pos = stream.pos;
            if (stream.current().substring(sc - 1).match(selectors) != null) {
              stream.backUp(new_pos - (old_pos - 1));
              return ret('tag', 'tag');
            } else stream.backUp(new_pos - (old_pos - 1));
          } else {
            stream.backUp(1);
          }
          if (t_v) return ret('tag', 'tag');
          else return ret('variable', 'variable');

          // It is a color variable?
        } else if (colorKeywords.hasOwnProperty(stream.current())) {
          return ret('color', 'unit');
        } else {
          return ret('variable', 'variable');
        }
      }
    }

    function keySet (array) {
      var keys = {};
      for (var i = 0; i < array.length; ++i) {
        keys[array[i]] = true;
      }
      return keys;
    }

    function tokenSComment (stream, state) { // SComment = Slash comment
      stream.skipToEnd();
      state.tokenize = tokenBase;
      return ret('comment', 'comment');
    }

    function tokenCComment (stream, state) {
      var maybeEnd = false;
      var ch;
      while ((ch = stream.next()) != null) {
        if (maybeEnd && ch === '/') {
          state.tokenize = tokenBase;
          break;
        }
        maybeEnd = (ch === '*');
      }
      return ret('comment', 'comment');
    }

    function tokenSGMLComment (stream, state) {
      var dashes = 0;
      var ch;
      while ((ch = stream.next()) != null) {
        if (dashes >= 2 && ch === '>') {
          state.tokenize = tokenBase;
          break;
        }
        dashes = (ch === '-') ? dashes + 1 : 0;
      }
      return ret('comment', 'comment');
    }

    function tokenString (quote) {
      return function (stream, state) {
        var escaped = false;
        var ch;
        while ((ch = stream.next()) != null) {
          if (ch === quote && !escaped) {
            break;
          }
          escaped = !escaped && ch === '\\';
        }
        if (!escaped) state.tokenize = tokenBase;
        return ret('string', 'string');
      };
    }

    return {
      startState: function (base) {
        return {
          tokenize: tokenBase,
          baseIndent: base || 0,
          stack: []
        };
      },

      token: function (stream, state) {
        if (stream.eatSpace()) return null;
        var style = state.tokenize(stream, state);

        var context = state.stack[state.stack.length - 1];
        if (type === 'hash' && context === 'rule') style = 'atom';
        else if (style === 'variable') {
          if (context === 'rule') style = null; // 'tag'
          else if (!context || context === '@media{') {
            style = stream.current() === 'when' ? 'variable'
            : /[\s,|\s\)|\s]/.test(stream.peek()) ? 'tag' : type;
          }
        }

        if (context === 'rule' && /^[\{\};]$/.test(type)) {
          state.stack.pop();
        }
        if (type === '{') {
          if (context === '@media') state.stack[state.stack.length - 1] = '@media{';
          else state.stack.push('{');
        } else if (type === '}') state.stack.pop();
        else if (type === '@media') state.stack.push('@media');
        else if (context === '{' && type !== 'comment') state.stack.push('rule');
        return style;
      },

      indent: function (state, textAfter) {
        var n = state.stack.length;
        if (/^\}/.test(textAfter)) {
          n -= state.stack[state.stack.length - 1] === 'rule' ? 2 : 1;
        }
        return state.baseIndent + n * indentUnit;
      },

      electricChars: '}'
    };
  });

  CodeMirror.defineMIME('text/x-carto', 'cartocss');
};

},{"../../helpers/color-keywords":425}],3:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<i class="CodeMirror-bullet"></i>';
}
return __p;
};

},{"underscore":"underscore"}],4:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="CodeMirror-error">\n  <li class="CodeMirror-errorMessage u-lSpace--xl u-rSpace--xl">\n    '+
((__t=( _t('components.codemirror.syntax-error') ))==null?'':_.escape(__t))+
'. '+
((__t=( _t('components.codemirror.line') ))==null?'':_.escape(__t))+
' '+
((__t=( line ))==null?'':_.escape(__t))+
': <span>'+
((__t=( message ))==null?'':_.escape(__t))+
'</span>\n  </li>\n</ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],5:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var CodeMirror = require('codemirror');
var ColorPicker = require('./colorpicker.code-mirror');
var template = require('./code-mirror.tpl');
var bulletTemplate = require('./code-mirror-bullet.tpl');
var errorTemplate = require('./code-mirror-error.tpl');

require('./mode/sql')(CodeMirror);
require('./mode/mustache')(CodeMirror);
require('./cartocss.code-mirror')(CodeMirror);
require('./scroll.code-mirror')(CodeMirror);
require('./show-hint.code-mirror')(CodeMirror);
require('./hint/custom-list-hint')(CodeMirror);
require('./searchcursor.code-mirror')(CodeMirror);
require('./placeholder.code-mirror')(CodeMirror);

var ESCAPE_KEY_CODE = 27;
var RETURN_KEY_CODE = 13;

var NOHINT = [ESCAPE_KEY_CODE, RETURN_KEY_CODE];

var ADDONS = {
  'color-picker': ColorPicker
};

module.exports = CoreView.extend({
  className: 'Editor-content',

  options: {
    readonly: false,
    lineNumbers: true,
    autocompleteChars: 3
  },

  initialize: function (opts) {
    if (!opts) throw new Error('options for codemirror are required.');
    if (!opts.model) throw new Error('Model for codemirror is required.');
    if (opts.model.get('content') === void 0 &&
        opts.placeholder === void 0) throw new Error('Content property or placeholder for codemirror is required.');
    if (opts.tip === void 0) throw new Error('tip message is required');

    this._autocompleteChars = opts.autocompleteChars || this.options.autocompleteChars;
    this._mode = opts.mode || 'cartocss';
    this._addons = opts.addons;
    this._hints = opts.hints;
    this._autocompletePrefix = opts.autocompletePrefix;
    this._autocompleteTriggers = opts.autocompleteTriggers;
    this._autocompleteSuffix = opts.autocompleteSuffix;
    this._errorTemplate = opts.errorTemplate || errorTemplate;
    this._tip = opts.tip;
    this._lineWithErrors = [];
    this._onInputRead = _.bind(this._onKeyUpEditor, this);
    this._placeholder = opts.placeholder;
  },

  render: function () {
    this.$el.html(
      template({
        content: this.model.get('content'),
        tip: this._tip
      })
    );

    this._initViews();
    this._bindEvents();
    this._showErrors();
    return this;
  },

  _initViews: function () {
    var options = _.defaults(_.extend({}, this.model.toJSON()), this.options);

    var isReadOnly = options.readonly;
    var hasLineNumbers = options.lineNumbers;

    var extraKeys = {
      'Ctrl-S': this.triggerApplyEvent.bind(this),
      'Cmd-S': this.triggerApplyEvent.bind(this),
      'Ctrl-Space': this._completeIfAfterCtrlSpace.bind(this)
    };

    this.editor = CodeMirror.fromTextArea(this.$('.js-editor').get(0), {
      lineNumbers: hasLineNumbers,
      theme: 'material',
      mode: this._mode,
      scrollbarStyle: 'simple',
      lineWrapping: true,
      readOnly: isReadOnly,
      extraKeys: extraKeys,
      placeholder: this._placeholder
    });
    this.editor.on('change', _.debounce(this._onCodeMirrorChange.bind(this), 150), this);

    if (!_.isEmpty(this._addons)) {
      _.each(this._addons, function (addon) {
        var Class = ADDONS[addon];
        var addonView = new Class({
          editor: this.editor
        });
        addonView.bind('codeSaved', this.triggerApplyEvent, this);
        this.$el.append(addonView.el);
        this.addView(addonView);
      }, this);
    }

    if (this._hints) {
      this.editor.on('keyup', this._onInputRead);
    }

    this._toggleReadOnly();

    setTimeout(function () {
      this.editor.refresh();
    }.bind(this), 0);
  },

  _completeIfAfterCtrlSpace: function (cm) {
    var autocompletePrefix = this._autocompletePrefix;
    var opts = {};
    var cur = cm.getCursor();

    if (autocompletePrefix &&
        cm.getRange(CodeMirror.Pos(cur.line, cur.ch - autocompletePrefix.length), cur) !== autocompletePrefix) {
      opts = { autocompletePrefix: autocompletePrefix };
    }

    return this._completeAfter(cm, opts);
  },

  updateHints: function (hints) {
    this._hints = hints;
  },

  _onKeyUpEditor: function (cm, event) {
    var code = event.keyCode;
    var hints = this._hints;
    var autocompleteChars = this._autocompleteChars - 1;
    var autocompletePrefix = this._autocompletePrefix;

    if (NOHINT.indexOf(code) === -1) {
      var self = this;

      if (this._autocompleteTimeout) clearTimeout(this._autocompleteTimeout);

      this._autocompleteTimeout = setTimeout(function () {
        var opts = {};
        var cur = cm.getCursor();
        var str = cm.getTokenAt(cur).string;
        str = str.toLowerCase();

        if (autocompletePrefix &&
            cm.getRange(CodeMirror.Pos(cur.line, cur.ch - autocompletePrefix.length), cur) !== autocompletePrefix) {
          opts = { autocompletePrefix: autocompletePrefix };
        }

        return self._completeAfter(cm, opts, function () {
          var autocompleteHandler = function (listItem) {
            // every list can be an array of strings or an array of objects {text, type}
            var hit = _.isObject(listItem) ? listItem.text : listItem;
            hit = hit.toLowerCase();
            return hit.indexOf(str) !== -1;
          };

          if (str.length > autocompleteChars) {
            var listHints = _.filter(hints, autocompleteHandler);

            return listHints.length > 0 || autocompletePrefix && autocompletePrefix === str;
          }
        });
      }, 150);
    }
  },

  _onCodeMirrorChange: function () {
    this.trigger('codeChanged');
  },

  _completeAfter: function (cm, opts, pred) {
    if (!pred || pred()) {
      if (!cm.state.completionActive) {
        this._showAutocomplete(cm, _.extend({}, opts));
      }
    }

    return CodeMirror.Pass;
  },

  _showAutocomplete: function (cm, opts) {
    var autocompletePrefix = opts && opts.autocompletePrefix;

    CodeMirror.showHint(cm, CodeMirror.hint['custom-list'], {
      completeSingle: false,
      list: this._hints,
      autocompletePrefix: autocompletePrefix,
      autocompleteSuffix: this._autocompleteSuffix
    });
  },

  _bindEvents: function () {
    var self = this;
    this.editor.on('change', function (editor, changed) {
      self.model.set('content', self.getContent(), {silent: true});
    });

    this.model.on('change:content', function () {
      this.setContent(this.model.get('content'));
    }, this);

    this.model.on('change:readonly', this._toggleReadOnly, this);

    this.model.on('change:errors', function () {
      this._showErrors();
    }, this);

    this.model.on('undo redo', function () {
      this.setContent(this.model.get('content'));
    }, this);
  },

  _toggleReadOnly: function () {
    var isReadOnly = !!this.model.get('readonly');
    this.editor.setOption('readOnly', isReadOnly);
    if (isReadOnly) {
      this.editor.setOption('theme', '');
      this._getInfo().hide();
    } else {
      this.editor.setOption('theme', 'material');
      this._getInfo().show();
    }
  },

  search: function (query, caseInsensitive) {
    var cursor = this.editor.getSearchCursor(query, null, true);
    cursor.find();
    return cursor.pos;
  },

  markReadOnly: function (from, to) {
    var options = {readOnly: true, inclusiveLeft: true};
    this.editor.markText(from, to, options);

    for (var i = from.line; i <= to.line; i++) {
      this.editor.addLineClass(i, 'background', 'CodeMirror-readonlyLine');
    }
  },

  setContent: function (value) {
    this.editor.setValue(value);
  },

  getContent: function () {
    return this.editor.getValue();
  },

  triggerApplyEvent: function () {
    this.trigger('codeSaved', this.getContent(), this);
  },

  destroyEditor: function () {
    this.editor.off('change');
    var el = this.editor.getWrapperElement();
    el.parentNode.removeChild(el);
  },

  _getInfo: function () {
    return this.$('.js-console');
  },

  _getConsole: function () {
    return this.$('.js-console-error');
  },

  _getCode: function () {
    return this.$('.CodeMirror-code');
  },

  _removeErrors: function () {
    this._getConsole().empty();
    _.each(this._lineWithErrors, function ($line) {
      $line.find('.CodeMirror-bullet').remove();
      $line.find('.CodeMirror-linenumber').removeClass('has-error');
    });

    this._lineWithErrors = [];
  },

  _showErrors: function () {
    var errors = this.model.get('errors');
    this._removeErrors();

    if (errors && errors.length > 0) {
      _.each(errors, function (err) {
        this._renderError(err);
        this._renderBullet(err);
      }, this);
    }
  },

  _renderBullet: function (error) {
    var line = error.line;
    var $line;
    if (line) {
      $line = this._getCode().children().eq(+line - 1);
      $line.append(bulletTemplate);
      $line.find('.CodeMirror-linenumber').addClass('has-error');
      this._lineWithErrors.push($line);
    }
  },

  _renderError: function (error) {
    this._getConsole().append(this._errorTemplate(error));
  },

  clean: function () {
    this.destroyEditor();
    CoreView.prototype.clean.apply(this);
  }
});

},{"./cartocss.code-mirror":2,"./code-mirror-bullet.tpl":3,"./code-mirror-error.tpl":4,"./code-mirror.tpl":6,"./colorpicker.code-mirror":7,"./hint/custom-list-hint":8,"./mode/mustache":9,"./mode/sql":10,"./placeholder.code-mirror":11,"./scroll.code-mirror":12,"./searchcursor.code-mirror":13,"./show-hint.code-mirror":14,"backbone/core-view":454,"codemirror":"codemirror","underscore":"underscore"}],6:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CodeMirror-editor">\n  <textarea class="js-editor">'+
((__t=( content ))==null?'':_.escape(__t))+
'</textarea>\n</div>\n\n';
 if (tip) { 
__p+='\n<div class="CodeMirror-console js-console">\n  '+
((__t=( tip ))==null?'':_.escape(__t))+
'\n  <div class="js-console-error"></div>\n</div>\n';
 } 
__p+='';
}
return __p;
};

},{"underscore":"underscore"}],7:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var $ = require('jquery');
var _ = require('underscore');
var ColorPicker = require('../form-components/editors/fill/color-picker/color-picker.js');
var COLOR_KEYWORDS = require('../../helpers/color-keywords');

/**
 *  Show color picker when user clicks over
 *  a color in the Codemirror editor.
 *
 *  new CodemirrorColorPicker({
 *    editor: codemirror-editor...
 *  })
 */

var REQUIRED_OPTS = [
  'editor'
];

var STYLE = _.template('1px solid  <%- color %>');
var COLORPICKER_HEIGHT = 220;

var stopPropagation = function (e) {
  e.stopPropagation();
};

module.exports = CoreView.extend({
  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this._updateColors = _.debounce(this._updateColors, 5).bind(this);
    this._onDocumentClick = this._onDocumentClick.bind(this);
    this._editor = opts.editor;
    this._initBinds();
  },

  _initBinds: function () {
    var self = this;
    var destroyPicker = function () {
      this._destroyPicker();
    }.bind(this);

    this._enableUpdateBind();

    this._editor.on('mousedown', function (cm, ev) {
      _.delay(self._onClick.bind(self, cm, ev), 50);
    });

    this._editor.on('keydown', destroyPicker);
    this._editor.on('viewportChange', destroyPicker);
    this._editor.on('scroll', destroyPicker);

    var wrapper = this._editor.getWrapperElement();
    wrapper.addEventListener('click', stopPropagation);
  },

  _disableBinds: function () {
    var wrapper = this._editor.getWrapperElement();
    wrapper.removeEventListener('click', stopPropagation);
    this._editor.off(null, null, this);
  },

  _enableUpdateBind: function () {
    this._editor.on('update', this._updateColors);
  },

  _disableUpdateBind: function () {
    this._editor.off('update', this._updateColors);
  },

  _onClick: function (cm, ev) {
    var cursor = this._editor.getCursor(true);
    var token = this._editor.getTokenAt(cursor);

    if (token.type === 'color') {
      this._createPicker(ev, cursor, token);
    } else {
      this._destroyPicker();
    }
  },

  _updateColors: function (cm) {
    var wrapper = cm.getWrapperElement();
    _.each(wrapper.querySelectorAll('.cm-color'), function (node) {
      this._paintColor(node.textContent, node);
    }, this);
  },

  _replaceColor: function (color, target) {
    var cursor = this._editor.getCursor();
    var nameMatch = this._getMatch(cursor, 'name');
    var hexMatch = this._getMatch(cursor, 'hex');
    var match = nameMatch || hexMatch;
    var start;
    var end;

    if (match) {
      start = {
        line: cursor.line,
        ch: match.start
      };
      end = {
        line: cursor.line,
        ch: match.end
      };

      this._editor.replaceRange(color, start, end, 'paste');

      var wrapper = this._editor.getWrapperElement();
      _.each(wrapper.querySelectorAll('.cm-color'), function (node) {
        var nodeStyle = node.style;
        var nodeColor = node.innerText;
        if (!nodeStyle || !nodeStyle.borderBottom) {
          this._paintColor(nodeColor, node);
        }
      }, this);
    }
  },

  _paintColor: function (color, target) {
    target.style.borderBottom = STYLE({color: color});
  },

  _getMatch: function (cursor, type) {
    if (!type) return;
    var re;

    switch (type.toLowerCase()) {
      case 'name':
        re = new RegExp(COLOR_KEYWORDS.join('|'), 'g');
        break;
      case 'hsl':
        re = /hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)/g;
        break;
      case 'rgb':
        re = /rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)/;
        break;
      case 'hex':
        re = /#[a-fA-F0-9]{3,6}/g;
        break;
      default:
        console.log('Invalid color match selection');
        return;
    }

    var line = this._editor.getLine(cursor.line);
    var match = re.exec(line);

    while (match) {
      var val = match[0];
      var len = val.length;
      var start = match.index;
      var end = match.index + len;
      if (cursor.ch >= start && cursor.ch <= end) {
        match = null;
        return {
          start: start,
          end: end,
          string: val
        };
      }
      match = re.exec(line);
    }
    return;
  },

  _createPicker: function (ev, cursor, token) {
    var cursorCoords = this._editor.cursorCoords();
    this._destroyPicker();

    this._colorPicker = new ColorPicker({
      className: 'Editor-boxModal ColorPicker--cm Editor-boxModal--darked Editor-FormDialog CDB-Text',
      value: token.string,
      disableOpacity: true
    });
    this._colorPicker.$el.attr('data-colorpicker-cid', this.cid);
    this._colorPicker.bind('change', _.debounce(this._onColorPickerChange.bind(this, ev), 5), this);

    var top = cursorCoords.top + 20;
    var maxTop = $(window).outerHeight();

    if (top + COLORPICKER_HEIGHT > maxTop) {
      top = cursorCoords.top - COLORPICKER_HEIGHT - 20;
    }

    this._colorPicker.$el.css({
      left: cursorCoords.left,
      top: top
    });

    document.body.appendChild(this._colorPicker.render().el);
    document.addEventListener('click', this._onDocumentClick);
  },

  _onDocumentClick: function (e) {
    var $el = $(e.target);
    if ($el.closest('[data-colorpicker-cid="' + this.cid + '"]').length === 0) {
      this._destroyPicker();
    }
  },

  _onColorPickerChange: function (ev, values) {
    this._disableUpdateBind();
    this._replaceColor(values.hex, ev.target);
    this.trigger('codeSaved');
    this._enableUpdateBind();
  },

  _destroyPicker: function () {
    if (this._colorPicker) {
      this.removeView(this._colorPicker);
      this._colorPicker.clean();
      delete this._colorPicker;
    }

    document.removeEventListener('click', this._onDocumentClick);
  },

  clean: function () {
    this._disableBinds();
    CoreView.prototype.clean.call(this);
  }
});

},{"../../helpers/color-keywords":425,"../form-components/editors/fill/color-picker/color-picker.js":69,"backbone/core-view":454,"jquery":"jquery","underscore":"underscore"}],8:[function(require,module,exports){
var _ = require('underscore');

module.exports = function (CodeMirror) {
  var Pos = CodeMirror.Pos;

  function arrayContains (arr, item) {
    return arr.indexOf(item) !== -1;
  }

  function scriptHint (editor, keywords, getToken, options) {
    // Find the token at the cursor
    var cur = editor.getCursor();
    var token = getToken(editor, cur);
    var tprop = token;
    token.state = CodeMirror.innerMode(editor.getMode(), token.state).state;

    // If it's not a 'word-style' token, ignore the token.
    if (!/^[\w$_-]*$/.test(token.string)) {
      token = tprop = {
        start: cur.ch,
        end: cur.ch,
        string: '',
        state: token.state,
        type: token.string === '.' ? 'property' : null
      };
    }
    // If it is a property, find out what it is a property of.
    while (tprop.type === 'property') {
      tprop = getToken(editor, Pos(cur.line, tprop.start));
      if (tprop.string !== '.') return;
      tprop = getToken(editor, Pos(cur.line, tprop.start));
      if (tprop.string === ')') {
        var level = 1;
        do {
          tprop = getToken(editor, Pos(cur.line, tprop.start));
          switch (tprop.string) {
            case ')':
              level++;
              break;
            case '(':
              level--;
              break;
            default:
              break;
          }
        } while (level > 0);
        tprop = getToken(editor, Pos(cur.line, tprop.start));
        if (tprop.type.indexOf('variable') === 0) tprop.type = 'function';
        else return; // no clue
      }
      if (!context) var context = [];
      context.push(tprop);
    }

    return {
      list: getCompletions(token, context, keywords, options),
      from: Pos(cur.line, token.start),
      to: Pos(cur.line, token.end)
    };
  }

  function columnsHint (editor, options) {
    return scriptHint(editor, [], /* javascriptKeywords */
      function (e, cur) {
        return e.getTokenAt(cur);
      },
    options);
  }

  CodeMirror.registerHelper('hint', 'custom-list', columnsHint);

  function getCompletions (token, context, keywords, options) {
    var found = [];
    var start = token.string.toLowerCase();

    function maybeAdd (str) {
      var hit = _.isObject(str) ? str.text : str;
      hit = hit.toLowerCase();
      if (hit.indexOf(start) === 0 && start !== hit && !arrayContains(found, hit)) {
        found.push(str);
      }
    }

    function gatherCompletions (obj) {
      for (var name in obj) {
        maybeAdd(obj[name]);
      }
    }

    gatherCompletions(options.list);
    _.each(keywords, maybeAdd);

    return found;
  }
};

},{"underscore":"underscore"}],9:[function(require,module,exports){
module.exports = function (CodeMirror) {
  CodeMirror.defineMode('mustache', function () {
    return {
      token: function (stream, state) {
        var ch;

        if (stream.match('{{')) {
          ch = stream.peek();
          if (ch == null || ch != null && ch.match(/[{]{1,}/)) {
            stream.next();
            return 'mustache-error';
          } else if (ch != null && ch.match(/[a-zA-Z\u00C0-\u024F_]+/)) {
            return null;
          }
        }

        if (stream.match('}}')) {
          ch = stream.peek();
          if (ch != null && ch.match(/[}]{1,}/)) {
            stream.next();
            return 'mustache-error';
          } else if (ch == null) {
            return null;
          }
        }

        if (stream.match('}')) {
          ch = stream.peek();
          if (ch == null || ch != null && ch.match(/[}]{1,}/)) {
            stream.next();
            return 'mustache-error';
          }
        }

        if (stream.match('{')) {
          ch = stream.peek();
          if (ch == null || ch != null && ch.match(/[{]{1,}/)) {
            stream.next();
            return 'mustache-error';
          }
        }

        // Delimiter character
        if (stream.match(/[a-zA-Z\u00C0-\u024F_]+/, true)) {
          return 'mustache-text';
        }

        // jump to the next item, needed OR CRASH
        stream.next();
      }
    };
  });

  (function () {
    var sqlKeywords = '{{  }}';

    function set (str) {
      var obj = {};
      var words = str.split(' ');
      for (var i = 0; i < words.length; ++i) obj[words[i]] = true;
      return obj;
    }

    CodeMirror.defineMIME('text/mustache', {
      name: 'mustache',
      client: set('source'),
      keywords: set(sqlKeywords)
    });
  }());
};

},{}],10:[function(require,module,exports){
// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

/* eslint-disable */
module.exports = function(CodeMirror) {
"use strict";

CodeMirror.defineMode("sql", function(config, parserConfig) {
  "use strict";

  var client         = parserConfig.client || {},
      atoms          = parserConfig.atoms || {"false": true, "true": true, "null": true},
      builtin        = parserConfig.builtin || {},
      keywords       = parserConfig.keywords || {},
      operatorChars  = parserConfig.operatorChars || /^[*+\-%<>!=&|~^]/,
      support        = parserConfig.support || {},
      hooks          = parserConfig.hooks || {},
      dateSQL        = parserConfig.dateSQL || {"date" : true, "time" : true, "timestamp" : true};

  function tokenBase(stream, state) {
    var ch = stream.next();

    // call hooks from the mime type
    if (hooks[ch]) {
      var result = hooks[ch](stream, state);
      if (result !== false) return result;
    }

    if (support.hexNumber == true &&
      ((ch == "0" && stream.match(/^[xX][0-9a-fA-F]+/))
      || (ch == "x" || ch == "X") && stream.match(/^'[0-9a-fA-F]+'/))) {
      // hex
      // ref: http://dev.mysql.com/doc/refman/5.5/en/hexadecimal-literals.html
      return "number";
    } else if (support.binaryNumber == true &&
      (((ch == "b" || ch == "B") && stream.match(/^'[01]+'/))
      || (ch == "0" && stream.match(/^b[01]+/)))) {
      // bitstring
      // ref: http://dev.mysql.com/doc/refman/5.5/en/bit-field-literals.html
      return "number";
    } else if (ch.charCodeAt(0) > 47 && ch.charCodeAt(0) < 58) {
      // numbers
      // ref: http://dev.mysql.com/doc/refman/5.5/en/number-literals.html
          stream.match(/^[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?/);
      support.decimallessFloat == true && stream.eat('.');
      return "number";
    } else if (ch == "?" && (stream.eatSpace() || stream.eol() || stream.eat(";"))) {
      // placeholders
      return "variable-3";
    } else if (ch == "'" || (ch == '"' && support.doubleQuote)) {
      // strings
      // ref: http://dev.mysql.com/doc/refman/5.5/en/string-literals.html
      state.tokenize = tokenLiteral(ch);
      return state.tokenize(stream, state);
    } else if ((((support.nCharCast == true && (ch == "n" || ch == "N"))
        || (support.charsetCast == true && ch == "_" && stream.match(/[a-z][a-z0-9]*/i)))
        && (stream.peek() == "'" || stream.peek() == '"'))) {
      // charset casting: _utf8'str', N'str', n'str'
      // ref: http://dev.mysql.com/doc/refman/5.5/en/string-literals.html
      return "keyword";
    } else if (/^[\(\),\;\[\]]/.test(ch)) {
      // no highlighting
      return null;
    } else if (support.commentSlashSlash && ch == "/" && stream.eat("/")) {
      // 1-line comment
      stream.skipToEnd();
      return "comment";
    } else if ((support.commentHash && ch == "#")
        || (ch == "-" && stream.eat("-") && (!support.commentSpaceRequired || stream.eat(" ")))) {
      // 1-line comments
      // ref: https://kb.askmonty.org/en/comment-syntax/
      stream.skipToEnd();
      return "comment";
    } else if (ch == "/" && stream.eat("*")) {
      // multi-line comments
      // ref: https://kb.askmonty.org/en/comment-syntax/
      state.tokenize = tokenComment;
      return state.tokenize(stream, state);
    } else if (ch == ".") {
      // .1 for 0.1
      if (support.zerolessFloat == true && stream.match(/^(?:\d+(?:e[+-]?\d+)?)/i)) {
        return "number";
      }
      // .table_name (ODBC)
      // // ref: http://dev.mysql.com/doc/refman/5.6/en/identifier-qualifiers.html
      if (support.ODBCdotTable == true && stream.match(/^[a-zA-Z_]+/)) {
        return "variable-2";
      }
    } else if (operatorChars.test(ch)) {
      // operators
      stream.eatWhile(operatorChars);
      return null;
    } else if (ch == '{' &&
        (stream.match(/^( )*(d|D|t|T|ts|TS)( )*'[^']*'( )*}/) || stream.match(/^( )*(d|D|t|T|ts|TS)( )*"[^"]*"( )*}/))) {
      // dates (weird ODBC syntax)
      // ref: http://dev.mysql.com/doc/refman/5.5/en/date-and-time-literals.html
      return "number";
    } else {
      stream.eatWhile(/^[_\w\d]/);
      var word = stream.current().toLowerCase();
      // dates (standard SQL syntax)
      // ref: http://dev.mysql.com/doc/refman/5.5/en/date-and-time-literals.html
      if (dateSQL.hasOwnProperty(word) && (stream.match(/^( )+'[^']*'/) || stream.match(/^( )+"[^"]*"/)))
        return "number";
      if (atoms.hasOwnProperty(word)) return "atom";
      if (builtin.hasOwnProperty(word)) return "builtin";
      if (keywords.hasOwnProperty(word)) return "keyword";
      if (client.hasOwnProperty(word)) return "string-2";
      return null;
    }
  }

  // 'string', with char specified in quote escaped by '\'
  function tokenLiteral(quote) {
    return function(stream, state) {
      var escaped = false, ch;
      while ((ch = stream.next()) != null) {
        if (ch == quote && !escaped) {
          state.tokenize = tokenBase;
          break;
        }
        escaped = !escaped && ch == "\\";
      }
      return "string";
    };
  }
  function tokenComment(stream, state) {
    while (true) {
      if (stream.skipTo("*")) {
        stream.next();
        if (stream.eat("/")) {
          state.tokenize = tokenBase;
          break;
        }
      } else {
        stream.skipToEnd();
        break;
      }
    }
    return "comment";
  }

  function pushContext(stream, state, type) {
    state.context = {
      prev: state.context,
      indent: stream.indentation(),
      col: stream.column(),
      type: type
    };
  }

  function popContext(state) {
    state.indent = state.context.indent;
    state.context = state.context.prev;
  }

  return {
    startState: function() {
      return {tokenize: tokenBase, context: null};
    },

    token: function(stream, state) {
      if (stream.sol()) {
        if (state.context && state.context.align == null)
          state.context.align = false;
      }
      if (stream.eatSpace()) return null;

      var style = state.tokenize(stream, state);
      if (style == "comment") return style;

      if (state.context && state.context.align == null)
        state.context.align = true;

      var tok = stream.current();
      if (tok == "(")
        pushContext(stream, state, ")");
      else if (tok == "[")
        pushContext(stream, state, "]");
      else if (state.context && state.context.type == tok)
        popContext(state);
      return style;
    },

    indent: function(state, textAfter) {
      var cx = state.context;
      if (!cx) return CodeMirror.Pass;
      var closing = textAfter.charAt(0) == cx.type;
      if (cx.align) return cx.col + (closing ? 0 : 1);
      else return cx.indent + (closing ? 0 : config.indentUnit);
    },

    blockCommentStart: "/*",
    blockCommentEnd: "*/",
    lineComment: support.commentSlashSlash ? "//" : support.commentHash ? "#" : null
  };
});

(function() {
  "use strict";

  // `identifier`
  function hookIdentifier(stream) {
    // MySQL/MariaDB identifiers
    // ref: http://dev.mysql.com/doc/refman/5.6/en/identifier-qualifiers.html
    var ch;
    while ((ch = stream.next()) != null) {
      if (ch == "`" && !stream.eat("`")) return "variable-2";
    }
    stream.backUp(stream.current().length - 1);
    return stream.eatWhile(/\w/) ? "variable-2" : null;
  }

  // variable token
  function hookVar(stream) {
    // variables
    // @@prefix.varName @varName
    // varName can be quoted with ` or ' or "
    // ref: http://dev.mysql.com/doc/refman/5.5/en/user-variables.html
    if (stream.eat("@")) {
      stream.match(/^session\./);
      stream.match(/^local\./);
      stream.match(/^global\./);
    }

    if (stream.eat("'")) {
      stream.match(/^.*'/);
      return "variable-2";
    } else if (stream.eat('"')) {
      stream.match(/^.*"/);
      return "variable-2";
    } else if (stream.eat("`")) {
      stream.match(/^.*`/);
      return "variable-2";
    } else if (stream.match(/^[0-9a-zA-Z$\.\_]+/)) {
      return "variable-2";
    }
    return null;
  };

  // short client keyword token
  function hookClient(stream) {
    // \N means NULL
    // ref: http://dev.mysql.com/doc/refman/5.5/en/null-values.html
    if (stream.eat("N")) {
        return "atom";
    }
    // \g, etc
    // ref: http://dev.mysql.com/doc/refman/5.5/en/mysql-commands.html
    return stream.match(/^[a-zA-Z.#!?]/) ? "variable-2" : null;
  }

  // these keywords are used by all SQL dialects (however, a mode can still overwrite it)
  var sqlKeywords = "alter and as asc between by count create delete desc distinct drop from group having in insert into is join like not on or order select set table union update values where limit ";

  // turn a space-separated list into an array
  function set(str) {
    var obj = {}, words = str.split(" ");
    for (var i = 0; i < words.length; ++i) obj[words[i]] = true;
    return obj;
  }

  CodeMirror.defineMIME("text/x-pgsql", {
    name: "sql",
    client: set("source"),
    // http://www.postgresql.org/docs/9.5/static/sql-keywords-appendix.html
    keywords: set(sqlKeywords + "a abort abs absent absolute access according action ada add admin after aggregate all allocate also always analyse analyze any are array array_agg array_max_cardinality asensitive assertion assignment asymmetric at atomic attribute attributes authorization avg backward base64 before begin begin_frame begin_partition bernoulli binary bit_length blob blocked bom both breadth c cache call called cardinality cascade cascaded case cast catalog catalog_name ceil ceiling chain characteristics characters character_length character_set_catalog character_set_name character_set_schema char_length check checkpoint class class_origin clob close cluster coalesce cobol collate collation collation_catalog collation_name collation_schema collect column columns column_name command_function command_function_code comment comments commit committed concurrently condition condition_number configuration conflict connect connection connection_name constraint constraints constraint_catalog constraint_name constraint_schema constructor contains content continue control conversion convert copy corr corresponding cost covar_pop covar_samp cross csv cube cume_dist current current_catalog current_date current_default_transform_group current_path current_role current_row current_schema current_time current_timestamp current_transform_group_for_type current_user cursor cursor_name cycle data database datalink datetime_interval_code datetime_interval_precision day db deallocate dec declare default defaults deferrable deferred defined definer degree delimiter delimiters dense_rank depth deref derived describe descriptor deterministic diagnostics dictionary disable discard disconnect dispatch dlnewcopy dlpreviouscopy dlurlcomplete dlurlcompleteonly dlurlcompletewrite dlurlpath dlurlpathonly dlurlpathwrite dlurlscheme dlurlserver dlvalue do document domain dynamic dynamic_function dynamic_function_code each element else empty enable encoding encrypted end end-exec end_frame end_partition enforced enum equals escape event every except exception exclude excluding exclusive exec execute exists exp explain expression extension external extract false family fetch file filter final first first_value flag float floor following for force foreign fortran forward found frame_row free freeze fs full function functions fusion g general generated get global go goto grant granted greatest grouping groups handler header hex hierarchy hold hour id identity if ignore ilike immediate immediately immutable implementation implicit import including increment indent index indexes indicator inherit inherits initially inline inner inout input insensitive instance instantiable instead integrity intersect intersection invoker isnull isolation k key key_member key_type label lag language large last last_value lateral lead leading leakproof least left length level library like_regex link listen ln load local localtime localtimestamp location locator lock locked logged lower m map mapping match matched materialized max maxvalue max_cardinality member merge message_length message_octet_length message_text method min minute minvalue mod mode modifies module month more move multiset mumps name names namespace national natural nchar nclob nesting new next nfc nfd nfkc nfkd nil no none normalize normalized nothing notify notnull nowait nth_value ntile null nullable nullif nulls number object occurrences_regex octets octet_length of off offset oids old only open operator option options ordering ordinality others out outer output over overlaps overlay overriding owned owner p pad parameter parameter_mode parameter_name parameter_ordinal_position parameter_specific_catalog parameter_specific_name parameter_specific_schema parser partial partition pascal passing passthrough password percent percentile_cont percentile_disc percent_rank period permission placing plans pli policy portion position position_regex power precedes preceding prepare prepared preserve primary prior privileges procedural procedure program public quote range rank read reads reassign recheck recovery recursive ref references referencing refresh regr_avgx regr_avgy regr_count regr_intercept regr_r2 regr_slope regr_sxx regr_sxy regr_syy reindex relative release rename repeatable replace replica requiring reset respect restart restore restrict result return returned_cardinality returned_length returned_octet_length returned_sqlstate returning returns revoke right role rollback rollup routine routine_catalog routine_name routine_schema row rows row_count row_number rule savepoint scale schema schema_name scope scope_catalog scope_name scope_schema scroll search second section security selective self sensitive sequence sequences serializable server server_name session session_user setof sets share show similar simple size skip snapshot some source space specific specifictype specific_name sql sqlcode sqlerror sqlexception sqlstate sqlwarning sqrt stable standalone start state statement static statistics stddev_pop stddev_samp stdin stdout storage strict strip structure style subclass_origin submultiset substring substring_regex succeeds sum symmetric sysid system system_time system_user t tables tablesample tablespace table_name temp template temporary then ties timezone_hour timezone_minute to token top_level_count trailing transaction transactions_committed transactions_rolled_back transaction_active transform transforms translate translate_regex translation treat trigger trigger_catalog trigger_name trigger_schema trim trim_array true truncate trusted type types uescape unbounded uncommitted under unencrypted unique unknown unlink unlisten unlogged unnamed unnest until untyped upper uri usage user user_defined_type_catalog user_defined_type_code user_defined_type_name user_defined_type_schema using vacuum valid validate validator value value_of varbinary variadic var_pop var_samp verbose version versioning view views volatile when whenever whitespace width_bucket window within work wrapper write xmlagg xmlattributes xmlbinary xmlcast xmlcomment xmlconcat xmldeclaration xmldocument xmlelement xmlexists xmlforest xmliterate xmlnamespaces xmlparse xmlpi xmlquery xmlroot xmlschema xmlserialize xmltable xmltext xmlvalidate year yes loop repeat"),
    // http://www.postgresql.org/docs/9.5/static/datatype.html
    builtin: set("bigint int8 bigserial serial8 bit varying varbit boolean bool box bytea character char varchar cidr circle date double precision float8 inet integer int int4 interval json jsonb line lseg macaddr money numeric decimal path pg_lsn point polygon real float4 smallint int2 smallserial serial2 serial serial4 text time without zone with timetz timestamp timestamptz tsquery tsvector txid_snapshot uuid xml"),
    atoms: set("false true null unknown"),
    operatorChars: /^[*+\-%<>!=&|^]/,
    dateSQL: set("date time timestamp"),
    support: set("ODBCdotTable decimallessFloat zerolessFloat binaryNumber hexNumber nCharCast charsetCast commentHash commentSpaceRequired")
  });
}());

};

/* eslint-enable */

},{}],11:[function(require,module,exports){
// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

/* eslint-disable */
module.exports = function (CodeMirror) {
  CodeMirror.defineOption("placeholder", "", function(cm, val, old) {
    var prev = old && old != CodeMirror.Init;
    if (val && !prev) {
      cm.on("blur", onBlur);
      cm.on("change", onChange);
      cm.on("swapDoc", onChange);
      onChange(cm);
    } else if (!val && prev) {
      cm.off("blur", onBlur);
      cm.off("change", onChange);
      cm.off("swapDoc", onChange);
      clearPlaceholder(cm);
      var wrapper = cm.getWrapperElement();
      wrapper.className = wrapper.className.replace(" CodeMirror-empty", "");
    }

    if (val && !cm.hasFocus()) onBlur(cm);
  });

  function clearPlaceholder(cm) {
    if (cm.state.placeholder) {
      cm.state.placeholder.parentNode.removeChild(cm.state.placeholder);
      cm.state.placeholder = null;
    }
  }
  function setPlaceholder(cm) {
    clearPlaceholder(cm);
    var elt = cm.state.placeholder = document.createElement("pre");
    elt.style.cssText = "height: 0; overflow: visible";
    elt.className = "CodeMirror-placeholder";
    var placeHolder = cm.getOption("placeholder")
    if (typeof placeHolder == "string") placeHolder = document.createTextNode(placeHolder)
    elt.appendChild(placeHolder)
    cm.display.lineSpace.insertBefore(elt, cm.display.lineSpace.firstChild);
  }

  function onBlur(cm) {
    if (isEmpty(cm)) setPlaceholder(cm);
  }
  function onChange(cm) {
    var wrapper = cm.getWrapperElement(), empty = isEmpty(cm);
    wrapper.className = wrapper.className.replace(" CodeMirror-empty", "") + (empty ? " CodeMirror-empty" : "");

    if (empty) setPlaceholder(cm);
    else clearPlaceholder(cm);
  }

  function isEmpty(cm) {
    return (cm.lineCount() === 1) && (cm.getLine(0) === "");
  }
};
/* eslint-enable */

},{}],12:[function(require,module,exports){
// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

module.exports = function (CodeMirror) {
  function Bar (cls, orientation, scroll) {
    this.orientation = orientation;
    this.scroll = scroll;
    this.screen = this.total = this.size = 1;
    this.pos = 0;

    this.node = document.createElement('div');
    this.node.className = cls + '-' + orientation;
    this.inner = this.node.appendChild(document.createElement('div'));

    var self = this;
    CodeMirror.on(this.inner, 'mousedown', function (e) {
      if (e.which !== 1) return;
      CodeMirror.e_preventDefault(e);
      var axis = self.orientation === 'horizontal' ? 'pageX' : 'pageY';
      var start = e[axis];
      var startpos = self.pos;
      function done () {
        CodeMirror.off(document, 'mousemove', move);
        CodeMirror.off(document, 'mouseup', done);
      }
      function move (e) {
        if (e.which !== 1) return done();
        self.moveTo(startpos + (e[axis] - start) * (self.total / self.size));
      }
      CodeMirror.on(document, 'mousemove', move);
      CodeMirror.on(document, 'mouseup', done);
    });

    CodeMirror.on(this.node, 'click', function (e) {
      CodeMirror.e_preventDefault(e);
      var innerBox = self.inner.getBoundingClientRect();
      var where;
      if (self.orientation === 'horizontal') {
        where = e.clientX < innerBox.left ? -1 : e.clientX > innerBox.right ? 1 : 0;
      } else {
        where = e.clientY < innerBox.top ? -1 : e.clientY > innerBox.bottom ? 1 : 0;
      }
      self.moveTo(self.pos + where * self.screen);
    });

    function onWheel (e) {
      var moved = CodeMirror.wheelEventPixels(e)[self.orientation === 'horizontal' ? 'x' : 'y'];
      var oldPos = self.pos;
      self.moveTo(self.pos + moved);
      if (self.pos !== oldPos) {
        CodeMirror.e_preventDefault(e);
      }
    }
    CodeMirror.on(this.node, 'mousewheel', onWheel);
    CodeMirror.on(this.node, 'DOMMouseScroll', onWheel);
  }

  Bar.prototype.setPos = function (pos, force) {
    if (pos < 0) pos = 0;
    if (pos > this.total - this.screen) pos = this.total - this.screen;
    if (!force && pos === this.pos) return false;
    this.pos = pos;
    this.inner.style[this.orientation === 'horizontal' ? 'left' : 'top'] =
      (pos * (this.size / this.total)) + 'px';
    return true;
  };

  Bar.prototype.moveTo = function (pos) {
    if (this.setPos(pos)) this.scroll(pos, this.orientation);
  };

  var minButtonSize = 10;

  Bar.prototype.update = function (scrollSize, clientSize, barSize) {
    var sizeChanged = this.screen !== clientSize || this.total !== scrollSize || this.size !== barSize;
    if (sizeChanged) {
      this.screen = clientSize;
      this.total = scrollSize;
      this.size = barSize;
    }

    var buttonSize = this.screen * (this.size / this.total);
    if (buttonSize < minButtonSize) {
      this.size -= minButtonSize - buttonSize;
      buttonSize = minButtonSize;
    }
    this.inner.style[this.orientation === 'horizontal' ? 'width' : 'height'] =
      buttonSize + 'px';
    this.setPos(this.pos, sizeChanged);
  };

  function SimpleScrollbars (cls, place, scroll) {
    this.addClass = cls;
    this.horiz = new Bar(cls, 'horizontal', scroll);
    place(this.horiz.node);
    this.vert = new Bar(cls, 'vertical', scroll);
    place(this.vert.node);
    this.width = null;
  }

  SimpleScrollbars.prototype.update = function (measure) {
    if (this.width == null) {
      var style = window.getComputedStyle ? window.getComputedStyle(this.horiz.node) : this.horiz.node.currentStyle;
      if (style) {
        this.width = parseInt(style.height, 10);
      }
    }
    var width = this.width || 0;

    var needsH = measure.scrollWidth > measure.clientWidth + 1;
    var needsV = measure.scrollHeight > measure.clientHeight + 1;
    this.vert.node.style.display = needsV ? 'block' : 'none';
    this.horiz.node.style.display = needsH ? 'block' : 'none';

    if (needsV) {
      this.vert.update(measure.scrollHeight, measure.clientHeight,
        measure.viewHeight - (needsH ? width : 0));
      this.vert.node.style.bottom = needsH ? width + 'px' : '0';
    }
    if (needsH) {
      this.horiz.update(measure.scrollWidth, measure.clientWidth,
        measure.viewWidth - (needsV ? width : 0) - measure.barLeft);
      this.horiz.node.style.right = needsV ? width + 'px' : '0';
      this.horiz.node.style.left = measure.barLeft + 'px';
    }

    return {right: needsV ? width : 0, bottom: needsH ? width : 0};
  };

  SimpleScrollbars.prototype.setScrollTop = function (pos) {
    this.vert.setPos(pos);
  };

  SimpleScrollbars.prototype.setScrollLeft = function (pos) {
    this.horiz.setPos(pos);
  };

  SimpleScrollbars.prototype.clear = function () {
    var parent = this.horiz.node.parentNode;
    parent.removeChild(this.horiz.node);
    parent.removeChild(this.vert.node);
  };

  CodeMirror.scrollbarModel.simple = function (place, scroll) {
    return new SimpleScrollbars('CodeMirror-simplescroll', place, scroll);
  };

  CodeMirror.scrollbarModel.overlay = function (place, scroll) {
    return new SimpleScrollbars('CodeMirror-overlayscroll', place, scroll);
  };
};

},{}],13:[function(require,module,exports){
// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

module.exports = function (CodeMirror) {
  /*eslint-disable */
  var Pos = CodeMirror.Pos;

  function SearchCursor(doc, query, pos, caseFold) {
    this.atOccurrence = false; this.doc = doc;
    if (caseFold == null && typeof query == "string") caseFold = false;

    pos = pos ? doc.clipPos(pos) : Pos(0, 0);
    this.pos = {from: pos, to: pos};

    // The matches method is filled in based on the type of query.
    // It takes a position and a direction, and returns an object
    // describing the next occurrence of the query, or null if no
    // more matches were found.
    if (typeof query != "string") { // Regexp match
      if (!query.global) query = new RegExp(query.source, query.ignoreCase ? "ig" : "g");
      this.matches = function(reverse, pos) {
        if (reverse) {
          query.lastIndex = 0;
          var line = doc.getLine(pos.line).slice(0, pos.ch), cutOff = 0, match, start;
          for (;;) {
            query.lastIndex = cutOff;
            var newMatch = query.exec(line);
            if (!newMatch) break;
            match = newMatch;
            start = match.index;
            cutOff = match.index + (match[0].length || 1);
            if (cutOff == line.length) break;
          }
          var matchLen = (match && match[0].length) || 0;
          if (!matchLen) {
            if (start == 0 && line.length == 0) {match = undefined;}
            else if (start != doc.getLine(pos.line).length) {
              matchLen++;
            }
          }
        } else {
          query.lastIndex = pos.ch;
          var line = doc.getLine(pos.line), match = query.exec(line);
          var matchLen = (match && match[0].length) || 0;
          var start = match && match.index;
          if (start + matchLen != line.length && !matchLen) matchLen = 1;
        }
        if (match && matchLen)
          return {from: Pos(pos.line, start),
                  to: Pos(pos.line, start + matchLen),
                  match: match};
      };
    } else { // String query
      var origQuery = query;
      if (caseFold) query = query.toLowerCase();
      var fold = caseFold ? function(str){return str.toLowerCase();} : function(str){return str;};
      var target = query.split("\n");
      // Different methods for single-line and multi-line queries
      if (target.length == 1) {
        if (!query.length) {
          // Empty string would match anything and never progress, so
          // we define it to match nothing instead.
          this.matches = function() {};
        } else {
          this.matches = function(reverse, pos) {
            if (reverse) {
              var orig = doc.getLine(pos.line).slice(0, pos.ch), line = fold(orig);
              var match = line.lastIndexOf(query);
              if (match > -1) {
                match = adjustPos(orig, line, match);
                return {from: Pos(pos.line, match), to: Pos(pos.line, match + origQuery.length)};
              }
             } else {
               var orig = doc.getLine(pos.line).slice(pos.ch), line = fold(orig);
               var match = line.indexOf(query);
               if (match > -1) {
                 match = adjustPos(orig, line, match) + pos.ch;
                 return {from: Pos(pos.line, match), to: Pos(pos.line, match + origQuery.length)};
               }
            }
          };
        }
      } else {
        var origTarget = origQuery.split("\n");
        this.matches = function(reverse, pos) {
          var last = target.length - 1;
          if (reverse) {
            if (pos.line - (target.length - 1) < doc.firstLine()) return;
            if (fold(doc.getLine(pos.line).slice(0, origTarget[last].length)) != target[target.length - 1]) return;
            var to = Pos(pos.line, origTarget[last].length);
            for (var ln = pos.line - 1, i = last - 1; i >= 1; --i, --ln)
              if (target[i] != fold(doc.getLine(ln))) return;
            var line = doc.getLine(ln), cut = line.length - origTarget[0].length;
            if (fold(line.slice(cut)) != target[0]) return;
            return {from: Pos(ln, cut), to: to};
          } else {
            if (pos.line + (target.length - 1) > doc.lastLine()) return;
            var line = doc.getLine(pos.line), cut = line.length - origTarget[0].length;
            if (fold(line.slice(cut)) != target[0]) return;
            var from = Pos(pos.line, cut);
            for (var ln = pos.line + 1, i = 1; i < last; ++i, ++ln)
              if (target[i] != fold(doc.getLine(ln))) return;
            if (fold(doc.getLine(ln).slice(0, origTarget[last].length)) != target[last]) return;
            return {from: from, to: Pos(ln, origTarget[last].length)};
          }
        };
      }
    }
  }

  SearchCursor.prototype = {
    findNext: function() {return this.find(false);},
    findPrevious: function() {return this.find(true);},

    find: function(reverse) {
      var self = this, pos = this.doc.clipPos(reverse ? this.pos.from : this.pos.to);
      function savePosAndFail(line) {
        var pos = Pos(line, 0);
        self.pos = {from: pos, to: pos};
        self.atOccurrence = false;
        return false;
      }

      for (;;) {
        if (this.pos = this.matches(reverse, pos)) {
          this.atOccurrence = true;
          return this.pos.match || true;
        }
        if (reverse) {
          if (!pos.line) return savePosAndFail(0);
          pos = Pos(pos.line-1, this.doc.getLine(pos.line-1).length);
        }
        else {
          var maxLine = this.doc.lineCount();
          if (pos.line == maxLine - 1) return savePosAndFail(maxLine);
          pos = Pos(pos.line + 1, 0);
        }
      }
    },

    from: function() {if (this.atOccurrence) return this.pos.from;},
    to: function() {if (this.atOccurrence) return this.pos.to;},

    replace: function(newText, origin) {
      if (!this.atOccurrence) return;
      var lines = CodeMirror.splitLines(newText);
      this.doc.replaceRange(lines, this.pos.from, this.pos.to, origin);
      this.pos.to = Pos(this.pos.from.line + lines.length - 1,
                        lines[lines.length - 1].length + (lines.length == 1 ? this.pos.from.ch : 0));
    }
  };

  // Maps a position in a case-folded line back to a position in the original line
  // (compensating for codepoints increasing in number during folding)
  function adjustPos(orig, folded, pos) {
    if (orig.length == folded.length) return pos;
    for (var pos1 = Math.min(pos, orig.length);;) {
      var len1 = orig.slice(0, pos1).toLowerCase().length;
      if (len1 < pos) ++pos1;
      else if (len1 > pos) --pos1;
      else return pos1;
    }
  }

  CodeMirror.defineExtension("getSearchCursor", function(query, pos, caseFold) {
    return new SearchCursor(this.doc, query, pos, caseFold);
  });
  CodeMirror.defineDocExtension("getSearchCursor", function(query, pos, caseFold) {
    return new SearchCursor(this, query, pos, caseFold);
  });

  CodeMirror.defineExtension("selectMatches", function(query, caseFold) {
    var ranges = [];
    var cur = this.getSearchCursor(query, this.getCursor("from"), caseFold);
    while (cur.findNext()) {
      if (CodeMirror.cmpPos(cur.to(), this.getCursor("to")) > 0) break;
      ranges.push({anchor: cur.from(), head: cur.to()});
    }
    if (ranges.length)
      this.setSelections(ranges, 0);
  });
  /*eslint-enable */
};

},{}],14:[function(require,module,exports){
// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

/* eslint-disable */
module.exports = function (CodeMirror) {
  "use strict";

  var HINT_ELEMENT_CLASS        = "CodeMirror-hint";
  var ACTIVE_HINT_ELEMENT_CLASS = "CodeMirror-hint-active";

  // This is the old interface, kept around for now to stay
  // backwards-compatible.
  CodeMirror.showHint = function(cm, getHints, options) {
    if (!getHints) return cm.showHint(options);
    if (options && options.async) getHints.async = true;
    var newOpts = {hint: getHints};
    if (options) for (var prop in options) newOpts[prop] = options[prop];
    return cm.showHint(newOpts);
  };

  CodeMirror.defineExtension("showHint", function(options) {
    options = parseOptions(this, this.getCursor("start"), options);
    var selections = this.listSelections()
    if (selections.length > 1) return;
    // By default, don't allow completion when something is selected.
    // A hint function can have a `supportsSelection` property to
    // indicate that it can handle selections.
    if (this.somethingSelected()) {
      if (!options.hint.supportsSelection) return;
      // Don't try with cross-line selections
      for (var i = 0; i < selections.length; i++)
        if (selections[i].head.line != selections[i].anchor.line) return;
    }

    if (this.state.completionActive) this.state.completionActive.close();
    var completion = this.state.completionActive = new Completion(this, options);
    if (!completion.options.hint) return;

    CodeMirror.signal(this, "startCompletion", this);
    completion.update(true);
  });

  function Completion(cm, options) {
    this.cm = cm;
    this.options = options;
    this.widget = null;
    this.debounce = 0;
    this.tick = 0;
    this.startPos = this.cm.getCursor("start");
    this.startLen = this.cm.getLine(this.startPos.line).length - this.cm.getSelection().length;

    var self = this;
    cm.on("cursorActivity", this.activityFunc = function() { self.cursorActivity(); });
  }

  var requestAnimationFrame = window.requestAnimationFrame || function(fn) {
    return setTimeout(fn, 1000/60);
  };
  var cancelAnimationFrame = window.cancelAnimationFrame || clearTimeout;

  Completion.prototype = {
    close: function() {
      if (!this.active()) return;
      this.cm.state.completionActive = null;
      this.tick = null;
      this.cm.off("cursorActivity", this.activityFunc);

      if (this.widget && this.data) CodeMirror.signal(this.data, "close");
      if (this.widget) this.widget.close();
      CodeMirror.signal(this.cm, "endCompletion", this.cm);
    },

    active: function() {
      return this.cm.state.completionActive == this;
    },

    pick: function(data, i) {
      var completion = data.list[i];
      if (completion.hint) completion.hint(this.cm, data, completion);
      else this.cm.replaceRange(getText(completion, this.options), completion.from || data.from,
                                completion.to || data.to, "complete");
      CodeMirror.signal(data, "pick", completion);
      this.close();
    },

    cursorActivity: function() {
      if (this.debounce) {
        cancelAnimationFrame(this.debounce);
        this.debounce = 0;
      }

      var pos = this.cm.getCursor(), line = this.cm.getLine(pos.line);
      if (pos.line != this.startPos.line || line.length - pos.ch != this.startLen - this.startPos.ch ||
          pos.ch < this.startPos.ch || this.cm.somethingSelected() ||
          (pos.ch && this.options.closeCharacters.test(line.charAt(pos.ch - 1)))) {
        this.close();
      } else {
        var self = this;
        this.debounce = requestAnimationFrame(function() {self.update();});
        if (this.widget) this.widget.disable();
      }
    },

    update: function(first) {
      if (this.tick == null) return
      var self = this, myTick = ++this.tick
      fetchHints(this.options.hint, this.cm, this.options, function(data) {
        if (self.tick == myTick) self.finishUpdate(data, first)
      })
    },

    finishUpdate: function(data, first) {
      if (this.data) CodeMirror.signal(this.data, "update");

      var picked = (this.widget && this.widget.picked) || (first && this.options.completeSingle);
      if (this.widget) this.widget.close();

      if (data && this.data && isNewCompletion(this.data, data)) return;
      this.data = data;

      if (data && data.list.length) {
        if (picked && data.list.length == 1) {
          this.pick(data, 0);
        } else {
          this.widget = new Widget(this, data);
          CodeMirror.signal(data, "shown");
        }
      }
    }
  };

  function isNewCompletion(old, nw) {
    var moved = CodeMirror.cmpPos(nw.from, old.from)
    return moved > 0 && old.to.ch - old.from.ch != nw.to.ch - nw.from.ch
  }

  function parseOptions(cm, pos, options) {
    var editor = cm.options.hintOptions;
    var out = {};
    for (var prop in defaultOptions) out[prop] = defaultOptions[prop];
    if (editor) for (var prop in editor)
      if (editor[prop] !== undefined) out[prop] = editor[prop];
    if (options) for (var prop in options)
      if (options[prop] !== undefined) out[prop] = options[prop];
    if (out.hint.resolve) out.hint = out.hint.resolve(cm, pos)
    return out;
  }

  function getText(completion, options) {
    var autocompleteSuffix = options && options.autocompleteSuffix ? options.autocompleteSuffix : '';
    var autocompletePrefix = options && options.autocompletePrefix ? options.autocompletePrefix : '';

    if (typeof completion !== "string") {
      completion = completion.text
    }

    return autocompletePrefix + completion + autocompleteSuffix;
  }

  function getType(completion) {
    if (typeof completion == "string") return '';
    else return completion.type;
  }

  function buildKeyMap(completion, handle) {
    var baseMap = {
      Up: function() {handle.moveFocus(-1);},
      Down: function() {handle.moveFocus(1);},
      PageUp: function() {handle.moveFocus(-handle.menuSize() + 1, true);},
      PageDown: function() {handle.moveFocus(handle.menuSize() - 1, true);},
      Home: function() {handle.setFocus(0);},
      End: function() {handle.setFocus(handle.length - 1);},
      Enter: handle.pick,
      Tab: handle.pick,
      Esc: handle.close
    };
    var custom = completion.options.customKeys;
    var ourMap = custom ? {} : baseMap;
    function addBinding(key, val) {
      var bound;
      if (typeof val != "string")
        bound = function(cm) { return val(cm, handle); };
      // This mechanism is deprecated
      else if (baseMap.hasOwnProperty(val))
        bound = baseMap[val];
      else
        bound = val;
      ourMap[key] = bound;
    }
    if (custom)
      for (var key in custom) if (custom.hasOwnProperty(key))
        addBinding(key, custom[key]);
    var extra = completion.options.extraKeys;
    if (extra)
      for (var key in extra) if (extra.hasOwnProperty(key))
        addBinding(key, extra[key]);
    return ourMap;
  }

  function getHintElement(hintsElement, el) {
    while (el && el != hintsElement) {
      if (el.nodeName.toUpperCase() === "LI" && el.parentNode == hintsElement) return el;
      el = el.parentNode;
    }
  }

  function styleHint(hint) {
    var element = document.createElement(hint.displayText || getText(hint));
    element = document.createElement("span");
    element.className = 'CDB-Size-small has-letter';
    element.innerHTML = hint.displayText || getText(hint);

    var type = getType(hint);
    if (type) {
      element.className = 'CDB-Size-small has-letter';
      element.dataset.type = type;
    }

    return element;
  }

  function Widget(completion, data) {
    this.completion = completion;
    this.data = data;
    this.picked = false;
    var widget = this, cm = completion.cm;

    var hints = this.hints = document.createElement("ul");
    hints.className = "CodeMirror-hints";
    this.selectedHint = data.selectedHint || 0;

    var element;
    var completions = data.list;
    for (var i = 0; i < completions.length; ++i) {
      var elt = hints.appendChild(document.createElement("li")), cur = completions[i];
      var className = HINT_ELEMENT_CLASS + (i != this.selectedHint ? "" : " " + ACTIVE_HINT_ELEMENT_CLASS);
      if (cur.className != null) className = cur.className + " " + className;
      elt.className = className;
      if (cur.render) cur.render(elt, data, cur);
      else {
        element = styleHint(cur);
        elt.appendChild(element);
      }

      elt.hintId = i;
    }

    var pos = cm.cursorCoords(completion.options.alignWithWord ? data.from : null);
    var left = pos.left, top = pos.bottom, below = true;
    hints.style.left = left + "px";
    hints.style.top = top + "px";
    // If we're at the edge of the screen, then we want the menu to appear on the left of the cursor.
    var winW = window.innerWidth || Math.max(document.body.offsetWidth, document.documentElement.offsetWidth);
    var winH = window.innerHeight || Math.max(document.body.offsetHeight, document.documentElement.offsetHeight);
    (completion.options.container || document.body).appendChild(hints);
    var box = hints.getBoundingClientRect(), overlapY = box.bottom - winH;
    if (overlapY > 0) {
      var height = box.bottom - box.top, curTop = pos.top - (pos.bottom - box.top);
      if (curTop - height > 0) { // Fits above cursor
        hints.style.top = (top = pos.top - height) + "px";
        below = false;
      } else if (height > winH) {
        hints.style.height = (winH - 5) + "px";
        hints.style.top = (top = pos.bottom - box.top) + "px";
        var cursor = cm.getCursor();
        if (data.from.ch != cursor.ch) {
          pos = cm.cursorCoords(cursor);
          hints.style.left = (left = pos.left) + "px";
          box = hints.getBoundingClientRect();
        }
      }
    }
    var overlapX = box.right - winW;
    if (overlapX > 0) {
      if (box.right - box.left > winW) {
        hints.style.width = (winW - 5) + "px";
        overlapX -= (box.right - box.left) - winW;
      }
      hints.style.left = (left = pos.left - overlapX) + "px";
    }

    cm.addKeyMap(this.keyMap = buildKeyMap(completion, {
      moveFocus: function(n, avoidWrap) { widget.changeActive(widget.selectedHint + n, avoidWrap); },
      setFocus: function(n) { widget.changeActive(n); },
      menuSize: function() { return widget.screenAmount(); },
      length: completions.length,
      close: function() { completion.close(); },
      pick: function() { widget.pick(); },
      data: data
    }));

    if (completion.options.closeOnUnfocus) {
      var closingOnBlur;
      cm.on("blur", this.onBlur = function() { closingOnBlur = setTimeout(function() { completion.close(); }, 100); });
      cm.on("focus", this.onFocus = function() { clearTimeout(closingOnBlur); });
    }

    var startScroll = cm.getScrollInfo();
    cm.on("scroll", this.onScroll = function() {
      var curScroll = cm.getScrollInfo(), editor = cm.getWrapperElement().getBoundingClientRect();
      var newTop = top + startScroll.top - curScroll.top;
      var point = newTop - (window.pageYOffset || (document.documentElement || document.body).scrollTop);
      if (!below) point += hints.offsetHeight;
      if (point <= editor.top || point >= editor.bottom) return completion.close();
      hints.style.top = newTop + "px";
      hints.style.left = (left + startScroll.left - curScroll.left) + "px";
    });

    CodeMirror.on(hints, "dblclick", function(e) {
      var t = getHintElement(hints, e.target || e.srcElement);
      if (t && t.hintId != null) {widget.changeActive(t.hintId); widget.pick();}
    });

    CodeMirror.on(hints, "click", function(e) {
      var t = getHintElement(hints, e.target || e.srcElement);
      if (t && t.hintId != null) {
        widget.changeActive(t.hintId);
        if (completion.options.completeOnSingleClick) widget.pick();
      }
    });

    CodeMirror.on(hints, "mousedown", function() {
      setTimeout(function(){cm.focus();}, 20);
    });

    CodeMirror.signal(data, "select", completions[0], hints.firstChild);
    return true;
  }

  Widget.prototype = {
    close: function() {
      if (this.completion.widget != this) return;
      this.completion.widget = null;
      this.hints.parentNode.removeChild(this.hints);
      this.completion.cm.removeKeyMap(this.keyMap);

      var cm = this.completion.cm;
      if (this.completion.options.closeOnUnfocus) {
        cm.off("blur", this.onBlur);
        cm.off("focus", this.onFocus);
      }
      cm.off("scroll", this.onScroll);
    },

    disable: function() {
      this.completion.cm.removeKeyMap(this.keyMap);
      var widget = this;
      this.keyMap = {Enter: function() { widget.picked = true; }};
      this.completion.cm.addKeyMap(this.keyMap);
    },

    pick: function() {
      this.completion.pick(this.data, this.selectedHint);
    },

    changeActive: function(i, avoidWrap) {
      if (i >= this.data.list.length)
        i = avoidWrap ? this.data.list.length - 1 : 0;
      else if (i < 0)
        i = avoidWrap ? 0  : this.data.list.length - 1;
      if (this.selectedHint == i) return;
      var node = this.hints.childNodes[this.selectedHint];
      node.className = node.className.replace(" " + ACTIVE_HINT_ELEMENT_CLASS, "");
      node = this.hints.childNodes[this.selectedHint = i];
      node.className += " " + ACTIVE_HINT_ELEMENT_CLASS;
      if (node.offsetTop < this.hints.scrollTop)
        this.hints.scrollTop = node.offsetTop - 3;
      else if (node.offsetTop + node.offsetHeight > this.hints.scrollTop + this.hints.clientHeight)
        this.hints.scrollTop = node.offsetTop + node.offsetHeight - this.hints.clientHeight + 3;
      CodeMirror.signal(this.data, "select", this.data.list[this.selectedHint], node);
    },

    screenAmount: function() {
      return Math.floor(this.hints.clientHeight / this.hints.firstChild.offsetHeight) || 1;
    }
  };

  function applicableHelpers(cm, helpers) {
    if (!cm.somethingSelected()) return helpers
    var result = []
    for (var i = 0; i < helpers.length; i++)
      if (helpers[i].supportsSelection) result.push(helpers[i])
    return result
  }

  function fetchHints(hint, cm, options, callback) {
    if (hint.async) {
      hint(cm, callback, options)
    } else {
      var result = hint(cm, options)
      if (result && result.then) result.then(callback)
      else callback(result)
    }
  }

  function resolveAutoHints(cm, pos) {
    var helpers = cm.getHelpers(pos, "hint"), words
    if (helpers.length) {
      var resolved = function(cm, callback, options) {
        var app = applicableHelpers(cm, helpers);
        function run(i) {
          if (i == app.length) return callback(null)
          fetchHints(app[i], cm, options, function(result) {
            if (result && result.list.length > 0) callback(result)
            else run(i + 1)
          })
        }
        run(0)
      }
      resolved.async = true
      resolved.supportsSelection = true
      return resolved
    } else if (words = cm.getHelper(cm.getCursor(), "hintWords")) {
      return function(cm) { return CodeMirror.hint.fromList(cm, {words: words}) }
    } else if (CodeMirror.hint.anyword) {
      return function(cm, options) { return CodeMirror.hint.anyword(cm, options) }
    } else {
      return function() {}
    }
  }

  CodeMirror.registerHelper("hint", "auto", {
    resolve: resolveAutoHints
  });

  CodeMirror.registerHelper("hint", "fromList", function(cm, options) {
    var cur = cm.getCursor(), token = cm.getTokenAt(cur);
    var to = CodeMirror.Pos(cur.line, token.end);
    if (token.string && /\w/.test(token.string[token.string.length - 1])) {
      var term = token.string, from = CodeMirror.Pos(cur.line, token.start);
    } else {
      var term = "", from = to;
    }
    var found = [];
    for (var i = 0; i < options.words.length; i++) {
      var word = options.words[i];
      if (word.slice(0, term.length) == term)
        found.push(word);
    }

    if (found.length) return {list: found, from: from, to: to};
  });

  CodeMirror.commands.autocomplete = CodeMirror.showHint;

  var defaultOptions = {
    hint: CodeMirror.hint.auto,
    completeSingle: true,
    alignWithWord: true,
    closeCharacters: /[\s()\[\]{};:>,]/,
    closeOnUnfocus: true,
    completeOnSingleClick: true,
    container: null,
    customKeys: null,
    extraKeys: null
  };

  CodeMirror.defineOption("hintOptions", null);
};
/* eslint-enable */

},{}],15:[function(require,module,exports){
var $ = require('jquery');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var CustomListView = require('../custom-list/custom-list-view');
var CustomListItemView = require('../custom-list/custom-list-item-view');
var itemTemplate = require('../custom-list/custom-list-item.tpl');
var magicPositioner = require('../../helpers/magic-positioner');

var ESCAPE_KEY_CODE = 27;

/*
 *  A context menu
 */
module.exports = CoreView.extend({

  options: {
    position: {
      x: 0,
      y: 0
    },
    offset: {
      x: 0,
      y: 15
    },
    itemTemplate: itemTemplate,
    itemView: CustomListItemView
  },

  className: 'CDB-Box-modal CDB-SelectItem CustomList CustomList--small',
  tagName: 'div',

  initialize: function (opts) {
    opts = opts || {};
    if (!opts.collection) throw new Error('collection option is required');
    if (!opts.triggerElementID) throw new Error('element id is required');

    this._triggerElementID = opts.triggerElementID;

    this.model = new Backbone.Model({
      visible: false
    });

    this._onEscapePressed = this._onEscapePressed.bind(this);
    this._onDocumentElementClicked = this._onDocumentElementClicked.bind(this);

    this._initBinds();
  },

  _initBinds: function () {
    this.model.on('change:visible', function (mdl, isVisible) {
      this.render();
      if (isVisible) {
        this._initDocumentBinds();
      } else {
        this._destroyDocumentBinds();
      }
    }, this);
    this.collection.on('change:selected', this.hide, this);
    this.add_related_model(this.collection);
  },

  _initDocumentBinds: function () {
    $(document).on('keydown', this._onEscapePressed);
    $(document).on('mousedown', this._onDocumentElementClicked);
  },

  _destroyDocumentBinds: function () {
    $(document).off('keydown', this._onEscapePressed);
    $(document).off('mousedown', this._onDocumentElementClicked);
  },

  render: function () {
    var $body = $('body');
    var posX = (this.options.position.x || 0) + this.options.offset.x;
    var posY = (this.options.position.y || 0) + this.options.offset.y;

    this.clearSubViews();
    this.$el.empty();
    this._renderList();

    this.$el.toggle(this.isVisible());

    $body.append(this.el);

    this.$el.css(
      magicPositioner({
        parentView: $body,
        posX: posX,
        posY: posY
      })
    );

    return this;
  },

  _onEscapePressed: function (ev) {
    if (ev.which === ESCAPE_KEY_CODE) {
      this.hide();
    }
  },

  _onDocumentElementClicked: function (ev) {
    var $el = $(ev.target);
    if ($el.closest(this.$el).length === 0 && $el.closest($('#' + this._triggerElementID)).length === 0) {
      this.hide();
    }
  },

  _renderList: function () {
    this._listView = new CustomListView({
      model: this.model,
      collection: this.collection,
      typeLabel: '',
      ItemView: this.options.itemView,
      itemTemplate: this.options.itemTemplate,
      size: 5
    });
    this.$el.append(this._listView.render().el);
    this.addView(this._listView);
  },

  show: function () {
    this.model.set('visible', true);
  },

  hide: function () {
    this.model.set('visible', false);
  },

  toggle: function () {
    this.model.set('visible', !this.model.get('visible'));
  },

  isVisible: function () {
    return this.model.get('visible');
  },

  clean: function () {
    this._destroyDocumentBinds();
    CoreView.prototype.clean.apply(this);
  }
});

},{"../../helpers/magic-positioner":428,"../custom-list/custom-list-item-view":26,"../custom-list/custom-list-item.tpl":28,"../custom-list/custom-list-view":33,"backbone":"backbone","backbone/core-view":454,"jquery":"jquery"}],16:[function(require,module,exports){
var Backbone = require('backbone');
var CustomCarouselModel = require('./custom-carousel-item-model');

/*
 *  Custom list collection, it parses pairs like:
 *
 *  [{ val, label }]
 *  ["string"]
 */

module.exports = Backbone.Collection.extend({

  model: function (attrs, opts) {
    var d = {};
    if (typeof attrs === 'string') {
      d.val = attrs;
    } else {
      d = attrs;
    }
    return new CustomCarouselModel(d);
  },

  initialize: function () {
    this._initBinds();
  },

  _initBinds: function () {
    this.bind('change:selected', this._onSelectedChange, this);
  },

  _onSelectedChange: function (changedModel, isSelected) {
    if (isSelected) {
      this.each(function (m) {
        if (m.cid !== changedModel.cid && m.get('selected')) {
          m.set('selected', false);
        }
      });
    }
  },

  getSelected: function () {
    return this.findWhere({ selected: true });
  },

  getSelectedValue: function () {
    var selectedModel = this.getSelected();
    return selectedModel && selectedModel.get('val');
  },

  getHighlighted: function () {
    return this.findWhere({ highlighted: true });
  }

});

},{"./custom-carousel-item-model":17,"backbone":"backbone"}],17:[function(require,module,exports){
var Backbone = require('backbone');

/*
 *  List item model
 *
 */

module.exports = Backbone.Model.extend({

  defaults: {
    selected: false,
    label: '',
    template: function () {
      return '';
    }
  },

  getName: function () {
    return this.get('label') || this.getValue();
  },

  getValue: function () {
    return this.get('val');
  }

});

},{"backbone":"backbone"}],18:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./custom-carousel-item.tpl');

module.exports = CoreView.extend({

  className: 'Carousel-item',
  tagName: 'li',

  events: {
    'mouseenter': '_onMouseEnter',
    'mouseleave': '_onMouseLeave',
    'click': '_onClick'
  },

  initialize: function (opts) {
    this._itemClassName = opts && opts.itemOptions ? opts.itemOptions.className : '';
    this._initBinds();
  },

  render: function () {
    this.$el.html(
      template({
        name: this.model.getName(),
        className: this._itemClassName,
        template: this.model.get('template')()
      })
    );

    if (this.model.getValue()) {
      this.$el.addClass('js-' + this.model.getValue());
    }
    this.$el.toggleClass('is-selected', !!this.model.get('selected'));
    return this;
  },

  _initBinds: function () {
    this.model.bind('change:selected', this.render, this);
  },

  _onMouseEnter: function () {
    this.model.set('highlighted', true);
  },

  _onMouseLeave: function () {
    this.model.set('highlighted', false);
  },

  _onClick: function (e) {
    this.killEvent(e);
    this.model.set('selected', true);
  }
});

},{"./custom-carousel-item.tpl":19,"backbone/core-view":454}],19:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button';
 if (className) { 
__p+=' class="'+
((__t=( className ))==null?'':_.escape(__t))+
'"';
 } 
__p+='>\n  '+
((__t=( template ))==null?'':__t)+
'\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],20:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var Ps = require('perfect-scrollbar');
var template = require('./custom-carousel.tpl');
var CarouselCollection = require('./custom-carousel-collection');
var CarouselItemView = require('./custom-carousel-item-view');
var _ = require('underscore');
/*
 *  A custom carousel selector
 *
 *  It accepts a collection of (val, label) model attributes or a values array
 *  with the same content or only strings.
 *
 *  new CustomCarousel({
 *    options: [
 *      {
 *        val: 'hello',
 *        label: 'hi'
 *      }
 *    ]
 *  });
 */

module.exports = CoreView.extend({

  className: 'Carousel',
  tagName: 'div',

  initialize: function (opts) {
    if (!opts.collection) {
      if (!opts.options) { throw new Error('options array {value, label} is required'); }
      this.collection = new CarouselCollection(opts.options);
      this.options = opts;
    }
    this._bindedCheckShadows = this._checkShadows.bind(this);
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());
    this._renderList();
    this._applyCustomScroll();
    return this;
  },

  _initBinds: function () {
    this.collection.bind('change:selected', this._checkScroll, this);
  },

  _renderList: function () {
    this.collection.each(function (mdl) {
      this._createItem(mdl);
    }, this);
  },

  _createItem: function (mdl) {
    var opts = this.options;
    var className = opts && opts.listItemOptions ? opts.listItemOptions.className : 'Carousel-item';
    var view = new CarouselItemView({
      className: className,
      model: mdl,
      itemOptions: this.options.itemOptions
    });

    this._listContainer().append(view.render().el);
    this.addView(view);
  },

  _applyCustomScroll: function () {
    Ps.initialize(this._listContainer().get(0), {
      wheelSpeed: 1,
      wheelPropagation: false,
      swipePropagation: true,
      suppressScrollY: true,
      stopPropagationOnClick: false,
      minScrollbarLength: 120
    });
    this._checkScroll();
    this._bindScroll();
  },

  _destroyCustomScroll: function () {
    this._unbindScroll();
    Ps.destroy(this._listContainer().get(0));
  },

  _bindScroll: function () {
    this._listContainer()
      .on('ps-x-reach-start', this._bindedCheckShadows)
      .on('ps-x-reach-end', this._bindedCheckShadows)
      .on('ps-scroll-x', this._bindedCheckShadows);
  },

  _unbindScroll: function () {
    this._listContainer()
      .off('ps-x-reach-start', this._bindedCheckShadows)
      .off('ps-x-reach-end', this._bindedCheckShadows)
      .off('ps-scroll-x', this._bindedCheckShadows);
  },

  _checkScroll: function () {
    var position = this.$('.is-selected').position();
    if (position) {
      this._listContainer().scrollLeft(position.left - 20);
      this._bindedCheckShadows();
    }
  },

  _listContainer: function () {
    return this.$('.js-list');
  },

  _checkShadows: function () {
    var currentPos = this._listContainer().scrollLeft();
    var max = this._listContainer().get(0).scrollWidth;
    var width = this._listContainer().outerWidth();
    var maxPos = max - width;

    this.$('.js-leftShadow').toggleClass('is-visible', currentPos > 0);
    this.$('.js-rightShadow').toggleClass('is-visible', currentPos < maxPos);
  },

  clean: function () {
    this._destroyCustomScroll();
    CoreView.prototype.clean.apply(this);
  },

  initScroll: function () {
    setTimeout(_.bind(function () {
      this._checkShadows();
      this._checkScroll();
      Ps.update(this._listContainer().get(0));
    }, this), 0);
  }

});

},{"./custom-carousel-collection":16,"./custom-carousel-item-view":18,"./custom-carousel.tpl":21,"backbone/core-view":454,"perfect-scrollbar":"perfect-scrollbar","underscore":"underscore"}],21:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Carousel-shadow Carousel-shadow--left js-leftShadow"></div>\n<div class="Carousel-shadow Carousel-shadow--right is-visible js-rightShadow"></div>\n<ul class="Carousel-list js-list"></ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],22:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-ListDecoration-item CustomList-item js-listItem">\n  <button type="button" class="CDB-ListDecoration-itemLink CustomList-itemLink js-add-custom-value u-ellipsis" data-val="'+
((__t=( query ))==null?'':_.escape(__t))+
'" title="'+
((__t=( query ))==null?'':_.escape(__t))+
'">\n    <p class="CDB-Text CDB-FontSize-small u-altTextColor">'+
((__t=( _t('components.custom-list.add-custom-result') ))==null?'':_.escape(__t))+
'</p>\n    '+
((__t=( query ))==null?'':_.escape(__t))+
'\n  </button>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],23:[function(require,module,exports){
var Backbone = require('backbone');
var CustomListItemModel = require('./custom-list-item-model');
var _ = require('underscore');

/*
 *  Custom list collection, it parses pairs like:
 *
 *  [{ val, label }]
 *  ["string"]
 */

module.exports = Backbone.Collection.extend({
  sort_key: 'id', // default sort key

  initialize: function (models, options) {
    this.options = _.extend({ silent: true }, options);
    this._initBinds();
  },

  comparator: function (item) {
    return item.get(this.sort_key) ? item.get(this.sort_key).toLowerCase() : item.get(this.sort_key);
  },

  model: function (attrs, opts) {
    var d = {};
    if (typeof attrs === 'string') {
      d.val = attrs;
    } else {
      d = attrs;
    }
    return new CustomListItemModel(d, opts);
  },

  sortByKey: function (key) {
    this.sort_key = key;
    this.sort();
  },

  _initBinds: function () {
    this.bind('change:selected', this._onSelectedChange, this);
  },

  search: function (query) {
    if (!query) return this;
    query = query.toLowerCase();

    return _(this.filter(function (model) {
      var name = model.getName();
      var val = _.isString(name) ? name.toLowerCase() : name;
      return val ? ~val.indexOf(query) : -1;
    }));
  },

  _onSelectedChange: function (changedModel, isSelected) {
    if (isSelected) {
      this.each(function (m) {
        if (m.cid !== changedModel.cid) {
          m.set({
            selected: false
          }, {
            silent: this.options.silent
          });
        }
      }, this);
    }
  },

  getSelectedItem: function () {
    return _.first(
      this.where({ selected: true })
    );
  },

  containsValue: function (value) {
    return this.find(function (mdl) {
      return mdl.getValue() === value;
    });
  },

  setSelected: function (value) {
    var selectedModel;
    var silent = { silent: this.options.silent };

    this.each(function (mdl) {
      if (mdl.getValue() === value) {
        mdl.set({
          selected: true
        }, silent);
        selectedModel = mdl;
      } else {
        mdl.set({
          selected: false
        }, silent);
      }
    });
    return selectedModel;
  },

  removeSelected: function () {
    this.each(function (mdl) {
      mdl.set({
        selected: false
      });
    });
  }
});

},{"./custom-list-item-model":25,"backbone":"backbone","underscore":"underscore"}],24:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CustomList-message">\n  <p class="CustomList-messageText CDB-Text CDB-Size-medium u-secondaryTextColor">\n    ';
 if (query && query.length) { 
__p+='\n      '+
((__t=( _t('components.custom-list.no-results', { typeLabel: typeLabel, query: query }) ))==null?'':_.escape(__t))+
'\n    ';
 } else { 
__p+='\n      '+
((__t=( _t('components.custom-list.no-items', { typeLabel: typeLabel }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  </p>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],25:[function(require,module,exports){
var Backbone = require('backbone');

/*
 *  List item model
 *
 */

module.exports = Backbone.Model.extend({

  defaults: {
    selected: false
  },

  getName: function () {
    return (this.get('label') == null) ? this.getValue() : this.get('label'); // eslint-disable-line
  },

  getValue: function () {
    return this.get('val');
  }

});

},{"backbone":"backbone"}],26:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');

module.exports = CoreView.extend({

  options: {
    template: require('./custom-list-item.tpl')
  },

  className: 'CDB-ListDecoration-item CustomList-item js-listItem',
  tagName: 'li',

  events: {
    'mouseenter': '_onMouseEnter',
    'mouseleave': '_onMouseLeave',
    'click': '_onClick'
  },

  initialize: function (opts) {
    this.options = _.extend({}, this.options, opts);
    this.model.on('change', this.render, this);
  },

  render: function () {
    this.$el.empty();
    this.clearSubViews();

    var name = this.model.getName() == null ? 'null' : this.model.getName();

    this.$el.append(
      this.options.template(
        _.extend({
          typeLabel: this.options.typeLabel,
          isSelected: this.model.get('selected'),
          isDisabled: this.model.get('disabled'),
          isDestructive: this.model.get('destructive'),
          name: name,
          val: this.model.getValue(),
          options: this.model.get('renderOptions')
        })
      )
    );

    this.$el
      .attr('data-val', this.model.getValue())
      .toggleClass('is-disabled', !!this.model.get('disabled'));

    return this;
  },

  _onMouseLeave: function () {
    this.$el.removeClass('is-highlighted');
  },

  _onMouseEnter: function () {
    this.$el.addClass('is-highlighted');
  },

  _onClick: function (ev) {
    this.killEvent(ev);
    this.model.set({
      selectedClass: ev.target.classList,
      selected: true
    });
  }
});

},{"./custom-list-item.tpl":28,"backbone/core-view":454,"underscore":"underscore"}],27:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button type="button" class="CDB-ListDecoration-itemLink u-ellipsis\n  ';
 if (isSelected) { 
__p+=' is-selected ';
 } 
__p+='\n  ';
 if (isDestructive) { 
__p+='\n  u-errorTextColor\n  ';
 } else if (isDisabled) { 
__p+='\n  u-hintTextColor\n  ';
 } else { 
__p+='\n  u-actionTextColor\n  ';
 } 
__p+='\n  " title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">\n\n  <div class="u-iBlock u-rSpace">\n    <input class="CDB-Checkbox js-input" type="checkbox" name="" value="" ';
 if (isSelected) { 
__p+='checked';
 } 
__p+=' ';
 if (isDisabled) { 
__p+='disabled';
 } 
__p+=' />\n    <span class="u-iBlock CDB-Checkbox-face"></span>\n  </div>\n  '+
((__t=( name ))==null?'':_.escape(__t))+
'\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],28:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button type="button" class="CDB-ListDecoration-itemLink u-ellipsis\n    ';
 if (isSelected) { 
__p+=' is-selected ';
 } 
__p+='\n    ';
 if (isDestructive) { 
__p+='\n      u-errorTextColor\n    ';
 } else if (isDisabled) { 
__p+='\n      u-hintTextColor\n    ';
 } else { 
__p+='\n      u-actionTextColor\n    ';
 } 
__p+='\n  " title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">\n  '+
((__t=( name ))==null?'':_.escape(__t))+
'\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],29:[function(require,module,exports){
var _ = require('underscore');
var CustomListCollection = require('./custom-list-collection');

module.exports = CustomListCollection.extend({
  _initBinds: function () { },

  setSelected: function (value) {
    var selectedModel;
    var silentTrue = { silent: true };

    if (_.isArray(value)) {
      this.each(function (mdl) {
        if (_.contains(value, mdl.getValue())) {
          mdl.set({
            selected: true
          }, silentTrue);
          selectedModel = mdl;
        } else {
          mdl.set({
            selected: false
          }, silentTrue);
        }
      });
    } else {
      this.each(function (mdl) {
        if (mdl.getValue() === value) {
          mdl.set({
            selected: true
          }, silentTrue);
          selectedModel = mdl;
        } else {
          mdl.set({
            selected: false
          }, silentTrue);
        }
      });
    }
    return selectedModel;
  }
});

},{"./custom-list-collection":23,"underscore":"underscore"}],30:[function(require,module,exports){
var CustomListItemView = require('./custom-list-item-view');

module.exports = CustomListItemView.extend({
  _onClick: function (ev) {
    this.killEvent(ev);
    this.model.set('selected', !this.model.get('selected'));
  }
});

},{"./custom-list-item-view":26}],31:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./custom-list-search.tpl');

module.exports = CoreView.extend({

  className: 'CustomList-form CDB-Box-modalHeader',
  tagName: 'form',

  events: {
    'keyup .js-search': '_onSearchType',
    'click .js-clear': '_onClickClear',
    'submit': '_submit'
  },

  initialize: function () {
    this.template = this.options.template || template;
    this.searchPlaceholder = this.options.searchPlaceholder || _t('components.custom-list.placeholder', { typeLabel: this.options.typeLabel });
    this._initBinds();
  },

  render: function () {
    this.$el
      .empty()
      .append(
        this.template({
          query: this.model.get('query'),
          searchPlaceholder: this.searchPlaceholder
        })
      );
    return this;
  },

  _initBinds: function () {
    this.model.on('change:query', this._checkButtons, this);
  },

  _checkButtons: function () {
    var query = this.model.get('query');
    this.$('.js-clear').toggle(query.length > 0);
  },

  _onSearchType: function (e) {
    this._submit();
  },

  _onClickClear: function (e) {
    e.stopPropagation();
    this.model.set('query', '');
    this.render();
    this.focus();
  },

  focus: function () {
    this.$('.js-search').focus();
  },

  _submit: function (ev) {
    this.killEvent(ev);
    var query = this.$('.js-search').val();
    this.model.set('query', query);
  }
});

},{"./custom-list-search.tpl":32,"backbone/core-view":454}],32:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeaderItem">\n  <input type="text" name="text" autocomplete="off" placeholder="'+
((__t=( searchPlaceholder ))==null?'':_.escape(__t))+
'" class="CDB-InputTextPlain CDB-Text js-search">\n  <button type="button" style="display:none" class="u-lSpace--xl js-clear">\n    <div class="CDB-Shape">\n      <div class="CDB-Shape-close is-blue is-large"></div>\n    </div>\n  </button>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],33:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var Ps = require('perfect-scrollbar');
var emptyTemplate = require('./custom-list-empty.tpl');
var addTemplate = require('./custom-list-add.tpl');
var template = require('./custom-list.tpl');
var ARROW_DOWN_KEY_CODE = 40;
var Utils = require('../../helpers/utils');
var ARROW_UP_KEY_CODE = 38;
var ENTER_KEY_CODE = 13;

module.exports = CoreView.extend({
  options: {
    size: 3
  },

  className: 'CDB-Text CDB-Size-medium CustomList-listWrapper',

  tagName: 'div',

  events: {
    'click .js-add-custom-value': '_onClickAddCustomValue'
  },

  initialize: function (opts) {
    this.options = _.extend({}, this.options, opts);
    this._onKeyDownBinded = this._onKeyDown.bind(this);
    this._needsMaxSize = true;
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this._removeArrowBinds();
    this._destroyCustomScroll();
    this.$el.empty();

    var query = this.model.get('query');
    var items = this.collection.search(query);

    this.$el.append(template());

    var allowFreeTextInput = this.options.allowFreeTextInput;
    var containsValue = !this.collection.containsValue(query);

    if (allowFreeTextInput && query && !Utils.isBlank(query) && containsValue) {
      this.$el.prepend(
        addTemplate({
          query: query,
          typeLabel: this.options.typeLabel
        })
      );
    }

    if (items.size() > 0) {
      items.each(this._renderItem, this);
      this._applyArrowBinds();
      // Perfect-scroll needs to have the element in the DOM in order to
      // style/positionate the scroll properly, small trick
      setTimeout(this._applyCustomScroll.bind(this), 0);
    } else if (!allowFreeTextInput || Utils.isBlank(query)) {
      this.$el.append(
        emptyTemplate({
          query: query,
          typeLabel: this.options.typeLabel
        })
      );
    }

    return this;
  },

  _renderItem: function (mdl) {
    var ItemViewClass = this.options.ItemView;
    var itemView = new ItemViewClass({
      model: mdl,
      typeLabel: this.options.typeLabel,
      template: this.options.itemTemplate
    });
    this.$('.js-list').append(itemView.render().el);
    this.addView(itemView);

    itemView.bind('customEvent', function (eventName, item) {
      this.trigger('customEvent', eventName, item, this);
    }, this);
  },

  _initBinds: function () {
    this.model.bind('change:query', this.render, this);
  },

  _applyArrowBinds: function () {
    document.addEventListener('keydown', this._onKeyDownBinded);
  },

  _removeArrowBinds: function () {
    document.removeEventListener('keydown', this._onKeyDownBinded);
  },

  _getSelected: function () {
    var selectedModel = this.collection.getSelectedItem();
    var selectedValue;

    if (selectedModel) {
      selectedValue = selectedModel.getValue();
      return this.$("[data-val='" + selectedValue + "']");
    }

    return null;
  },

  _highlightSelected: function (item) {
    var itemHeight = item.outerHeight();
    item.addClass('is-highlighted');
    this.$('.js-list').scrollTop(item.index() * itemHeight);
  },

  _onClickAddCustomValue: function (e) {
    this.killEvent(e);

    var query = this.model.get('query');

    var mdl = this.collection.add({
      val: query,
      label: '' + query + ''
    });

    this.collection.sortByKey('val');
    mdl.set('selected', true);
  },

  _onKeyDown: function (e) {
    if (this.model.get('visible') === false) {
      return;
    }

    var key = e.which;
    var $listItems = this.$('.js-listItem');
    var $highlighted = $listItems.filter('.is-highlighted');
    var $current;
    var mdl;

    $highlighted.removeClass('is-highlighted');

    if (key === ARROW_DOWN_KEY_CODE) {
      if (!$highlighted.length || $highlighted[0] === $listItems.last()[0]) {
        $current = $listItems.eq(0);
      } else {
        $current = $highlighted.next();
      }
    } else if (key === ARROW_UP_KEY_CODE) {
      if (!$highlighted.length || $highlighted[0] === $listItems.first()[0]) {
        $current = $listItems.last();
      } else {
        $current = $highlighted.prev();
      }
    } else if (key === ENTER_KEY_CODE) {
      e.preventDefault();
      if ($highlighted && $highlighted.length) {
        mdl = _.first(this.collection.where({ val: $highlighted.data('val') }));
        if (mdl) {
          mdl.set('selected', true);
        }
        return false;
      }
    }

    $current && this._highlightSelected($current);
  },

  _applyCustomScroll: function () {
    Ps.initialize(this._wrapperContainer().get(0), {
      wheelSpeed: 2,
      wheelPropagation: true,
      stopPropagationOnClick: false,
      minScrollbarLength: 20
    });
  },

  _destroyCustomScroll: function () {
    if (this._wrapperContainer().length > 0) {
      Ps.destroy(this._wrapperContainer().get(0));
    }
  },

  _wrapperContainer: function () {
    return this.$('.js-list');
  },

  clean: function () {
    this._removeArrowBinds();
    this._destroyCustomScroll();
    CoreView.prototype.clean.apply(this);
  },

  highlight: function () {
    var selected = this._getSelected();
    selected && this._highlightSelected(selected);
  }
});

},{"../../helpers/utils":435,"./custom-list-add.tpl":22,"./custom-list-empty.tpl":24,"./custom-list.tpl":34,"backbone/core-view":454,"perfect-scrollbar":"perfect-scrollbar","underscore":"underscore"}],34:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="CustomList-list js-list"></ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],35:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var CustomListCollection = require('./custom-list-collection');
var SearchView = require('./custom-list-search-view');
var CustomListView = require('./custom-list-view');
var itemTemplate = require('./custom-list-item.tpl');
var CustomListItemView = require('./custom-list-item-view');

/*
 *  A custom list with possibility to search within values.
 *
 *  It accepts a collection of (val, label) model attributes or a values array
 *  with the same content or only strings.
 *
 *  new CustomList({
 *    showSearch: false,
 *    itemTemplate: itemTemplate,
 *    values: [
 *      {
 *        val: 'hello',
 *        label: 'hi'
 *      }
 *    ]
 *  });
 */

module.exports = CoreView.extend({

  options: {
    showSearch: true,
    allowFreeTextInput: false,
    typeLabel: 'column',
    itemTemplate: itemTemplate,
    itemView: CustomListItemView
  },

  className: 'CDB-Box-modal CustomList',
  tagName: 'div',

  initialize: function (opts) {
    if (!opts.collection) {
      if (!opts.options) { throw new Error('options array {value, label} is required'); }
      this.collection = new CustomListCollection(opts.options);
    }

    if (opts.position) {
      this.$el.css(opts.position);
    }

    this.options = _.extend({}, this.options, opts);
    this.model = new Backbone.Model({
      query: '',
      visible: false
    });
    this._initBinds();
  },

  render: function () {
    this.$el.empty();
    this.clearSubViews();

    if (this.options.showSearch) {
      this._renderSearch();
    }
    this._renderList();

    if (this.options.showSearch) {
      this._focusSearch();
    }
    return this;
  },

  _initBinds: function () {
    this.model.bind('change:visible', function (mdl, isVisible) {
      this._resetQuery();
      this._toggleVisibility();

      if (!isVisible) {
        this.clearSubViews();
      } else {
        this.render();
      }
    }, this);
  },

  _renderSearch: function () {
    this._searchView = new SearchView({
      template: this.options.searchTemplate,
      typeLabel: this.options.typeLabel,
      searchPlaceholder: this.options.searchPlaceholder,
      model: this.model
    });
    this.$el.prepend(this._searchView.render().el);
    this.addView(this._searchView);
  },

  _focusSearch: function () {
    setTimeout(function () {
      this._searchView && this._searchView.focus();
    }.bind(this), 0);
  },

  _renderList: function () {
    this._listView = new CustomListView({
      model: this.model,
      allowFreeTextInput: this.options.allowFreeTextInput,
      collection: this.collection,
      typeLabel: this.options.typeLabel,
      ItemView: this.options.itemView,
      itemTemplate: this.options.itemTemplate,
      size: this.options.size
    });
    this.$el.append(this._listView.render().el);

    this._listView.highlight();
    this.addView(this._listView);

    this._listView.bind('customEvent', function (eventName, item) {
      this.trigger(eventName, item, this);
    }, this);
  },

  highlight: function () {
    this._listView.highlight();
  },

  _resetQuery: function () {
    this.model.set('query', '');
  },

  show: function () {
    this.model.set('visible', true);
  },

  hide: function () {
    this.trigger('hidden', this);
    this.model.set('visible', false);
  },

  toggle: function () {
    this.model.set('visible', !this.model.get('visible'));
  },

  _toggleVisibility: function () {
    this.$el.toggleClass('is-visible', !!this.model.get('visible'));
  },

  isVisible: function () {
    return this.model.get('visible');
  },

  remove: function () {
    this._listView && this._listView.clean();
    CoreView.prototype.remove.call(this);
  }
});

},{"./custom-list-collection":23,"./custom-list-item-view":26,"./custom-list-item.tpl":28,"./custom-list-search-view":31,"./custom-list-view":33,"backbone":"backbone","backbone/core-view":454,"underscore":"underscore"}],36:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var SQLNotifications = require('../../sql-notifications');
var SQLUtils = require('../../helpers/sql-utils');
var Notifier = require('../../components/notifier/notifier');
var cdb = require('cartodb.js');
var checkAndBuildOpts = require('../../helpers/required-opts');

var REQUIRED_OPTS = [
  'configModel',
  'editorModel',
  'layerDefinitionModel',
  'querySchemaModel'
];

module.exports = CoreView.extend({

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._clearSQLModel = new Backbone.Model({
      visible: false
    });

    this._sqlModel = this._layerDefinitionModel.sqlModel;

    this._SQL = new cdb.SQL({
      user: this._configModel.get('user_name'),
      sql_api_template: this._configModel.get('sql_api_template'),
      api_key: this._configModel.get('api_key')
    });

    this._codemirrorModel = new Backbone.Model({
      content: this._querySchemaModel.get('query'),
      readonly: false
    });

    SQLNotifications.track(this);
  },

  _internalParseSQL: function (callbackAfterAlterSuccess) {
    var appliedQuery = this._querySchemaModel.get('query');
    var currentQuery = this._codemirrorModel.get('content');

    // Remove last character if it has ';'
    if (currentQuery && currentQuery.slice(-1) === ';') {
      currentQuery = currentQuery.slice(0, currentQuery.length - 1);
      this._codemirrorModel.set('content', currentQuery);
    }

    var isSameQuery = SQLUtils.isSameQuery(currentQuery, appliedQuery);
    var altersData = SQLUtils.altersData(currentQuery);

    if (currentQuery === '' || isSameQuery) {
      SQLNotifications.removeNotification();
      return false;
    }

    if (altersData) {
      SQLNotifications.showNotification({
        status: 'loading',
        info: _t('notifications.sql.alter-loading'),
        closable: false
      });

      this._sqlModel.set('content', currentQuery);

      this._SQL.execute(currentQuery, null, {
        success: function () {
          SQLNotifications.showNotification({
            status: 'success',
            info: _t('notifications.sql.alter-success'),
            closable: true,
            delay: Notifier.DEFAULT_DELAY
          });
          this._applyDefaultSQLAfterAlteringData();
          if (typeof callbackAfterAlterSuccess === 'function') {
            callbackAfterAlterSuccess.call(this);
          }
        }.bind(this),
        error: function (errors) {
          errors = errors.responseJSON.error;
          var parsedErrors = this._parseErrors(errors);
          this._codemirrorModel.set('errors', parsedErrors);
          SQLNotifications.showErrorNotification(parsedErrors);
          this._checkClearButton();
        }.bind(this)
      });
    } else {
      this._runQuery(currentQuery, this._saveSQL.bind(this));
    }
  },

  _checkClearButton: function () {
    var customSql = this._codemirrorModel.get('content');
    var isDefaultQuery = SQLUtils.isSameQuery(customSql, this._defaultSQL());
    this._clearSQLModel.set({ visible: !isDefaultQuery });
  },

  _applyDefaultSQLAfterAlteringData: function () {
    var originalQuery = this._defaultSQL();
    this._codemirrorModel.set({
      content: originalQuery,
      errors: []
    });
    this._sqlModel.set('content', originalQuery);
    this._querySchemaModel.set('query_errors', []);
    this._clearSQLModel.set({ visible: false });
    this._querySchemaModel.resetDueToAlteredData();
    this._clearSQL();
  },

  _clearSQL: function () {
    var originalQuery = this._defaultSQL();
    this._codemirrorModel.set({
      content: originalQuery,
      errors: []
    });
    this._runQuery(originalQuery, this._saveSQL.bind(this));
  },

  _showErrors: function (model) {
    var errors = this._querySchemaModel.get('query_errors');
    var hasErrors = errors && errors.length > 0;
    this._codemirrorModel.set('errors', this._parseErrors(errors));
    this._editorModel.set('disabled', hasErrors);

    if (hasErrors) {
      SQLNotifications.showErrorNotification(this._parseErrors(errors));
    }

    this._checkClearButton();
  },

  _parseErrors: function (errors) {
    return errors.map(function (error) {
      return {
        message: error
      };
    });
  }
});

},{"../../components/notifier/notifier":252,"../../helpers/required-opts":432,"../../helpers/sql-utils":433,"../../sql-notifications":448,"backbone":"backbone","backbone/core-view":454,"cartodb.js":"cartodb.js"}],37:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var cdb = require('cartodb.js');
var baseTemplate = require('./error.tpl');

/**
 * A typical error view.
 * @param {Object} options
 * @param {String} options.title If not provided will use a generic text as fallback
 * @param {String} options.desc If not provied will use a generic text as fallback
 */
module.exports = CoreView.extend({

  className: 'IntermediateInfo',

  initialize: function (opts) {
    var attrs = _.defaults(
      _.pick(opts, ['title', 'desc']),
      {
        title: _t('components.error.default-title'),
        desc: _t('components.error.default-desc')
      }
    );
    this._template = this.options && this.options.template || baseTemplate;
    this.model = new Backbone.Model(attrs);
  },

  render: function () {
    this.$el.html(this._html());
    return this;
  },

  _html: function () {
    var m = this.model;
    return this._template({
      title: m.get('title'),
      desc: cdb.core.sanitize.html(m.get('desc'))
    });
  }
});

},{"./error.tpl":38,"backbone":"backbone","backbone/core-view":454,"cartodb.js":"cartodb.js","underscore":"underscore"}],38:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="LayoutIcon LayoutIcon--negative">\n  <i class="CDB-IconFont CDB-IconFont-cockroach"></i>\n</div>\n<h3 class="CDB-Text CDB-Size-large u-mainTextColor u-errorTextColor u-bSpace--m u-tSpace-xl">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h3>\n<p class="CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( desc ))==null?'':__t)+
'</p>\n';
}
return __p;
};

},{"underscore":"underscore"}],39:[function(require,module,exports){
var Backbone = require('backbone');
var $ = require('jquery');
var ESC_KEY_CODE = 27;

Backbone.Form.editors.Base = Backbone.Form.editors.Base.extend({

  applyESCBind: function (callback) {
    this._ESCBindCallback = callback;
    document.addEventListener('keydown', this._onKeyDown.bind(this));
  },

  _onKeyDown: function (ev) {
    var anyModalOpen;
    if (ev.which === ESC_KEY_CODE) {
      anyModalOpen = this._anyModalOpen();
      !anyModalOpen && this._ESCBindCallback();
    }
  },

  applyClickOutsideBind: function (callback) {
    this._clickBindCallback = callback;
    this.$el.attr('data-cid', this.cid);
    document.addEventListener('click', this._onDocumentClick.bind(this));
  },

  _onDocumentClick: function (e) {
    var $el = $(e.target);
    var anyModalOpen = this._anyModalOpen();
    if ($el.closest('[data-cid="' + this.cid + '"]').length === 0 && !anyModalOpen) {
      this._clickBindCallback();
    }
  },

  _anyModalOpen: function () {
    var modals = this.options.modals;
    if (!modals) {
      return false;
    }

    return modals.isOpen();
  },

  remove: function () {
    if (this._ESCBindCallback) {
      document.removeEventListener('keydown', this._onKeyDown.bind(this));
    }
    if (this._clickBindCallback) {
      document.removeEventListener('click', this._onDocumentClick.bind(this));
    }
    Backbone.View.prototype.remove.call(this);
  }

});

},{"backbone":"backbone","jquery":"jquery"}],40:[function(require,module,exports){
var $ = require('jquery');
var Backbone = require('backbone');
var FactoryHints = require('../../../editor/editor-hints/factory-hints');
var CodeMirrorView = require('../../code-mirror/code-mirror-view');

Backbone.Form.editors.CodeEditor = Backbone.Form.editors.TextArea.extend({
  render: function () {
    this.setValue(this.value);

    this._codemirrorModel = new Backbone.Model({
      content: this.value,
      readonly: false,
      lineNumbers: false
    });

    FactoryHints.init({
      tokens: this.options.tokens,
      tableName: false,
      columnsName: false
    });

    this._initViews();

    this._toggleDisableState();

    return this;
  },

  getValue: function () {
    var val = this.$el.val();

    val = this.codeMirrorView.getContent();

    return (val === '') ? null : val;
  },

  _initViews: function () {
    this._destroyEditor();

    var hints = FactoryHints.reset().hints;
    this.codeMirrorView = new CodeMirrorView({
      model: this._codemirrorModel,
      hints: hints,
      mode: 'text/mustache',
      autocompleteChars: 2,
      autocompletePrefix: '{{',
      autocompleteSuffix: '}}',
      placeholder: this.options.placeholder,
      tip: ''
    });
    this.codeMirrorView.bind('codeChanged', function () {
      this.trigger('change', this.codeMirrorView.getContent());
    }, this);

    var $codeMirrorEl = $(this.codeMirrorView.render().el);
    this.$el.replaceWith($codeMirrorEl);
    this.setElement($codeMirrorEl);
    this.$el.addClass('CodeMirror-formInput');
    // The default el is replace it with another dom node
    // we should add tracking class manually again
    this._addTrackingClass();
  },

  _addTrackingClass: function () {
    if (this.options.trackingClass) {
      var trackClasses = this.options.trackingClass + ' track-' + this.options.key + this.options.editorType;
      this.$el.addClass(trackClasses);
    }
  },

  _hasEditor: function () {
    return this.options.editor && !!this.codeMirrorView;
  },

  _destroyEditor: function () {
    if (this._hasEditor()) {
      this.codeMirrorView.remove();
    }
  },

  remove: function () {
    this._destroyEditor();
    Backbone.Form.editors.Base.prototype.remove.apply(this);
  },

  clean: function () {
    this.$el.remove();
  }
});

},{"../../../editor/editor-hints/factory-hints":405,"../../code-mirror/code-mirror-view":5,"backbone":"backbone","jquery":"jquery"}],41:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var checkAndBuildOpts = require('../../../../helpers/required-opts');
var StackLayoutView = require('../../../../components/stack-layout/stack-layout-view');
var MeasurementsView = require('./measurement-list-view');
var FiltersView = require('./filter-list-view');

var REQUIRED_OPTS = [
  'measurementsCollection',
  'filtersCollection'
];

module.exports = CoreView.extend({
  className: 'CDB-Box-modal CustomList',

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    // For internal state
    this.model = new Backbone.Model({
      visible: false
    });

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._generateStackLayoutView();
    return this;
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:visible', function (mdl, isVisible) {
      isVisible ? this.render() : this.clearSubViews();
      this._toggleVisibility();
    });
  },

  _generateStackLayoutView: function () {
    var self = this;

    var stackViewCollection = new Backbone.Collection([{
      createStackView: function (stackLayoutModel, opts) {
        return self._createListView(stackLayoutModel, opts).bind(self);
      }
    }, {
      createStackView: function (stackLayoutModel, opts) {
        return self._createFilterView(stackLayoutModel, opts).bind(self);
      }
    }]);

    this._stackLayoutView = new StackLayoutView({ collection: stackViewCollection });
    this.addView(this._stackLayoutView);
    this.$el.append(this._stackLayoutView.render().$el);
  },

  _createListView: function (stackLayoutModel, opts) {
    var view = new MeasurementsView({
      measurementsCollection: this._measurementsCollection,
      filtersCollection: this._filtersCollection
    });

    view.bind('filters', function () {
      stackLayoutModel.nextStep();
    }, this);

    return view;
  },

  _createFilterView: function (stackLayoutModel, opts) {
    var view = new FiltersView({
      filtersCollection: this._filtersCollection
    });

    view.bind('back', function () {
      stackLayoutModel.prevStep();
    }, this);

    return view;
  },

  hide: function () {
    this.model.set('visible', false);
  },

  toggle: function () {
    this.model.set('visible', !this.model.get('visible'));
  },

  isVisible: function () {
    return this.model.get('visible');
  },

  _toggleVisibility: function () {
    this.$el.toggleClass('is-visible', !!this.isVisible());
  },

  clean: function () {
    // Other ops here
    CoreView.prototype.clean.apply(this, arguments);
  }
});

},{"../../../../components/stack-layout/stack-layout-view":274,"../../../../helpers/required-opts":432,"./filter-list-view":47,"./measurement-list-view":52,"backbone":"backbone","backbone/core-view":454}],42:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (typeof isLoading != 'undefined' && isLoading) { 
__p+='\n  <div class="u-flex">\n    <div class="CDB-LoaderIcon CDB-LoaderIcon--small is-dark">\n      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n      </svg>\n    </div>\n    <span class="u-lSpace u-secondaryTextColor">'+
((__t=( _t('components.backbone-forms.select.loading') ))==null?'':_.escape(__t))+
'</span>\n  </div>\n';
 } else { 
__p+='\n  '+
((__t=( label ))==null?'':_.escape(__t))+
'\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],43:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var template = require('./dropdown.tpl');
var selectedItemTemplate = require('./dropdown-item.tpl');
var DropdownDialogView = require('./dropdown-dialog-view');
var PopupManager = require('../../../popup-manager');
var MeasurementsCollection = require('./measurements-collection');
var FiltersCollection = require('./measurements-filters-collection');

var ENTER_KEY_CODE = 13;
var STATE = {
  idle: 'idle',
  loading: 'loading',
  fetching: 'fetching',
  fetched: 'fetched',
  error: 'error'
};

Backbone.Form.editors.DataObservatoryDropdown = Backbone.Form.editors.Base.extend({

  tagName: 'div',
  className: 'u-ellipsis Editor-formSelect',

  events: {
    'click .js-button': '_onButtonClick',
    'keydown .js-button': '_onButtonKeyDown',
    'focus .js-button': function () {
      this.trigger('focus', this);
    },
    'blur': function () {
      this.trigger('blur', this);
    }
  },

  options: {
    selectedItemTemplate: selectedItemTemplate
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    this.template = opts.template || template;
    this.dialogMode = this.options.dialogMode || 'nested';

    var collectionOptions = {
      configModel: this.options.configModel,
      layerDefinitionModel: this.options.layerDefinitionModel,
      country: this.model.get('country') || null
    };

    this.measurementsCollection = new MeasurementsCollection([], collectionOptions);
    this.filtersCollection = new FiltersCollection([], collectionOptions);

    this._modelView = new Backbone.Model({
      state: STATE.idle
    });

    this._initBinds();

    this._dialogView = new DropdownDialogView({
      measurementsCollection: this.measurementsCollection,
      filtersCollection: this.filtersCollection
    });

    this._fetch();
  },

  render: function () {
    var isLoading = this._isLoading();
    var isEmpty = !this._hasItems();
    var isDisabled = !isEmpty ? this.options.disabled : true;
    var name = this.model.get(this.options.keyAttr);
    var item = this.measurementsCollection.getItem(name);
    var isNull = name === null;
    var label = isNull ? 'null' : (item ? item.get('name') : false);
    var placeholder = this.options.placeholder;

    this.$el.html(
      this.template({
        label: label,
        keyAttr: this.options.keyAttr,
        placeholder: placeholder,
        isDisabled: isDisabled,
        isLoading: isLoading,
        isEmpty: isEmpty,
        isNull: isNull
      })
    );

    this._popupManager = new PopupManager(this.cid, this.$el, this._dialogView.$el);
    this._popupManager.append(this.dialogMode);

    return this;
  },

  _initBinds: function () {
    var hide = function () {
      this._dialogView.hide();
      this._popupManager.untrack();
    }.bind(this);

    this.applyESCBind(hide);
    this.applyClickOutsideBind(hide);

    this.listenTo(this.measurementsCollection, 'change:selected', this._onItemSelected);
    this.listenTo(this._modelView, 'change:state', this.render);
    this.listenTo(this.model, 'change:country', this._fetch);
  },

  _fetch: function () {
    var fetchOptions = {
      success: this._onFetchSuccess.bind(this),
      error: this._onFetchError.bind(this)
    };

    this.measurementsCollection.fetch(fetchOptions);
    this.filtersCollection.fetch(fetchOptions);
    this._modelView.set({state: STATE.loading});

    this.setValue(this.model.get(this.options.keyAttr));
  },

  _onFetchSuccess: function () {
    var measurementsReady = this.measurementsCollection.getState() === STATE.fetched;
    var filtersReady = this.filtersCollection.getState() === STATE.fetched;

    if (filtersReady && measurementsReady) {
      this._modelView.set({state: STATE.fetched});
    }
  },

  _onFetchError: function () {
    this._modelView.set({state: STATE.error});
  },

  _hasItems: function () {
    var state = this.measurementsCollection.getState();
    return state === STATE.fetched && this.measurementsCollection.filter(function (mdl) {
      var filter = mdl.get('filter');
      return filter.length > 0;
    }).length > 0;
  },

  _isLoading: function () {
    var state = this.measurementsCollection.getState();
    return state === STATE.fetching;
  },

  _onItemSelected: function (mdl) {
    this._dialogView.hide();
    this._popupManager.untrack();
    this._renderButton(mdl).focus();
    this.trigger('change', this);
  },

  _onButtonClick: function () {
    if (this._hasItems()) {
      this._dialogView.toggle();
      this._dialogView.isVisible() ? this._popupManager.track() : this._popupManager.untrack();
    }
  },

  _onButtonKeyDown: function (ev) {
    if (ev.which === ENTER_KEY_CODE) {
      ev.preventDefault();
      if (!this._dialogView.isVisible()) {
        ev.stopPropagation();
        this._onButtonClick();
      } else {
        this._popupManager.track();
      }
    }
  },

  getValue: function () {
    var item = this.measurementsCollection.getSelectedItem();
    if (item) {
      return item.getName();
    }
    return;
  },

  setValue: function (value) {
    var selectedModel = this.measurementsCollection.setSelected(value);
    if (selectedModel) {
      this._renderButton(selectedModel);
    }
    this.value = value;
  },

  _renderButton: function (mdl) {
    var button = this.$('.js-button');
    var $html = this.options.selectedItemTemplate({
      label: mdl.getName()
    });

    button
      .removeClass('is-empty')
      .html($html);

    return button;
  },

  remove: function () {
    this._popupManager && this._popupManager.destroy();
    this._dialogView && this._dialogView.clean();
    Backbone.Form.editors.Base.prototype.remove.call(this);
  }

});

},{"../../../popup-manager":263,"../editor-helpers-extend":62,"./dropdown-dialog-view":41,"./dropdown-item.tpl":42,"./dropdown.tpl":44,"./measurements-collection":54,"./measurements-filters-collection":55,"backbone":"backbone"}],44:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-InputText CDB-Text is-cursor js-button u-ellipsis\n  ';
 if (isDisabled) { 
__p+=' is-disabled ';
 } 
__p+='\n  ';
 if (!label) { 
__p+=' is-empty ';
 } 
__p+='\n  ';
 if (isNull) { 
__p+=' is-empty ';
 } 
__p+='"\n  tabindex="0">\n  ';
 if (isLoading) { 
__p+='\n    <div class="CDB-LoaderIcon CDB-LoaderIcon--small is-dark u-iBlock">\n      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n      </svg>\n    </div>\n    <span class="u-lSpace u-secondaryTextColor">'+
((__t=( _t('components.backbone-forms.select.loading') ))==null?'':_.escape(__t))+
'</span>\n  ';
 } else { 
__p+='\n    ';
 if (isEmpty) { 
__p+='\n      '+
((__t=( _t('components.backbone-forms.select.empty') ))==null?'':_.escape(__t))+
'\n    ';
 } else { 
__p+='\n      '+
((__t=( placeholder || label || _t('components.backbone-forms.select.placeholder', { keyAttr: keyAttr }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  ';
 } 
__p+='\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],45:[function(require,module,exports){
var _ = require('underscore');
var CustomListMultiItemView = require('../../../custom-list/custom-list-multi-item-view');

var NAME = _.template('<%-name %> (<%- items %>)');

module.exports = CustomListMultiItemView.extend({
  render: function () {
    this.clearSubViews();
    this.$el.empty();

    var name = this.model.getName() == null ? 'null' : this.model.getName();
    name = name.replace(/"/g, '');

    this.$el.append(
      this.options.template(
        _.extend({
          isSelected: this.model.get('selected'),
          isDisabled: this.model.get('disabled'),
          name: NAME({
            name: name,
            items: this.model.get('items')
          }),
          val: this.model.getValue(),
          description: this.model.get('description')
        })
      )
    );

    this.$el
      .attr('data-val', this.model.getValue())
      .toggleClass('is-disabled', !!this.model.get('disabled'));

    return this;
  }
});

},{"../../../custom-list/custom-list-multi-item-view":30,"underscore":"underscore"}],46:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button type="button" class="CDB-ListDecoration-itemLink\n  ';
 if (isSelected) { 
__p+=' is-selected ';
 } 
__p+='\n  " title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">\n  <div class="u-flex">\n    <div class="u-iBlock u-rSpace--m">\n      <input class="CDB-Checkbox js-input" type="checkbox" name="" value="" ';
 if (isSelected) { 
__p+='checked';
 } 
__p+=' ';
 if (isDisabled) { 
__p+='disabled';
 } 
__p+=' />\n      <span class="u-iBlock CDB-Checkbox-face"></span>\n    </div>\n    <div>\n      <div class="u-bSpace">'+
((__t=( name ))==null?'':_.escape(__t))+
'</div>\n      <div class="CDB-Size-small u-altTextColor">'+
((__t=( description ))==null?'':_.escape(__t))+
'</div>\n    </div>\n  </div>\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],47:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var CustomListView = require('../../../custom-list/custom-view');
var CustomListItemView = require('./filter-list-item-view');
var itemListTemplate = require('./filter-list-item.tpl');
var template = require('./filter-list-view.tpl');
var checkAndBuildOpts = require('../../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'filtersCollection'
];

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_onClickBack'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._initBinds();

    this._listView = new CustomListView({
      className: 'DO-Filters',
      typeLabel: _t('components.backbone-forms.data-observatory.dropdown.filter.filters'),
      showSearch: false,
      collection: this._filtersCollection,
      itemTemplate: itemListTemplate,
      itemView: CustomListItemView
    });

    this.addView(this._listView);
  },

  render: function () {
    this.$el.append(template({
      headerTitle: _t('components.backbone-forms.data-observatory.dropdown.filter.header')
    }));

    this.$('.js-content').append(this._listView.render().$el);

    return this;
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.trigger('back', this);
  },

  _initBinds: function () {
    this.listenTo(this._filtersCollection, 'change:selected', this._onSelectItem, this);
  },

  _onSelectItem: function (item) {
    this.trigger('selectItem', item, this);
  }
});

},{"../../../../helpers/required-opts":432,"../../../custom-list/custom-view":35,"./filter-list-item-view":45,"./filter-list-item.tpl":46,"./filter-list-view.tpl":48,"backbone/core-view":454}],48:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeader">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <button class="u-actionTextColor js-back u-rSpace">\n        <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n      </button>\n      '+
((__t=( headerTitle))==null?'':_.escape(__t))+
'\n    </li>\n  </ul>\n</div>\n<div class="js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],49:[function(require,module,exports){
var _ = require('underscore');
var BaseView = require('../../../custom-list/custom-list-item-view');

module.exports = BaseView.extend({
  render: function () {
    this.$el.empty();
    this.clearSubViews();

    var name = this.model.getName() == null ? 'null' : this.model.getName();

    this.$el.append(
      this.options.template(
        _.extend({
          isSelected: this.model.get('selected'),
          isDisabled: this.model.get('disabled'),
          name: name,
          val: this.model.getValue(),
          description: this.model.get('description')
        })
      )
    );

    this.$el
      .attr('data-val', this.model.getValue())
      .toggleClass('is-disabled', !!this.model.get('disabled'));

    return this;
  }
});

},{"../../../custom-list/custom-list-item-view":26,"underscore":"underscore"}],50:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button type="button" class="CDB-ListDecoration-itemLink\n    ';
 if (isSelected) { 
__p+=' is-selected ';
 } 
__p+='\n  " title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">\n  <div class="u-bSpace">'+
((__t=( name ))==null?'':_.escape(__t))+
'</div>\n  <div class="CDB-Size-small u-altTextColor">'+
((__t=( description ))==null?'':_.escape(__t))+
'</div>\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],51:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeaderItem">\n  <div  class="u-flex u-grow">\n    <div class="u-flex u-grow">\n      <input type="text" name="text" autocomplete="off" placeholder="'+
((__t=( searchPlaceholder ))==null?'':_.escape(__t))+
'" class="CDB-InputTextPlain CDB-Text js-search">\n      <button type="button" style="display:none" class="u-lSpace--xl u-rSpace--xl js-clear">\n        <div class="CDB-Shape">\n          <div class="CDB-Shape-close is-blue is-large"></div>\n        </div>\n      </button>\n    </div>\n\n    <div>\n      <button class="CDB-Text CDB-Size-medium u-actionTextColor js-filters u-rSpace--m">'+
((__t=( _t('analyses.data-observatory-measure.filters') ))==null?'':_.escape(__t))+
'</button>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],52:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var CustomListCollection = require('../../../custom-list/custom-list-collection');
var CustomListView = require('../../../custom-list/custom-view');
var CustomListItemView = require('./measurement-list-item-view');
var itemListTemplate = require('./measurement-list-item.tpl');
var checkAndBuildOpts = require('../../../../helpers/required-opts');
var searchTemplate = require('./measurement-list-search.tpl');

var REQUIRED_OPTS = [
  'measurementsCollection',
  'filtersCollection'
];

module.exports = CoreView.extend({
  events: {
    'click .js-filters': '_onClickFilters'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._initCollection();
    this._initBinds();

    this._listView = new CustomListView({
      className: 'DO-Measurements',
      typeLabel: _t('components.backbone-forms.data-observatory.dropdown.measurement.type'),
      showSearch: true,
      itemView: CustomListItemView,
      searchTemplate: searchTemplate,
      collection: this.collection,
      itemTemplate: itemListTemplate,
      searchPlaceholder: _t('components.backbone-forms.data-observatory.dropdown.measurement.search')
    });

    this.addView(this._listView);
  },

  render: function () {
    this.$el.append(this._listView.render().$el);
    return this;
  },

  _initCollection: function () {
    var filtersApplied = _.map(this._filtersCollection.getSelected(), function (mdl) {
      return mdl.getValue();
    });
    var measurements = this._measurementsCollection.filter(function (mdl) {
      var filters = mdl.get('filter');
      // if filters applied, we look for hits
      // if not, we check if measurement has filter
      if (filtersApplied.length > 0) {
        return _.some(filters, function (filter) {
          return filtersApplied.indexOf(filter.id) >= 0;
        });
      } else {
        return filters.length > 0;
      }
    });

    this.collection = new CustomListCollection(_.map(measurements, function (measurement) {
      return measurement.attributes;
    }));
  },

  _onClickFilters: function (e) {
    this.killEvent(e);
    this.trigger('filters');
  },

  _initBinds: function () {
    this.listenTo(this.collection, 'change:selected', this._onSelectItem);
  },

  _onSelectItem: function (item) {
    this._measurementsCollection.setSelected(item.getValue());
  }
});

},{"../../../../helpers/required-opts":432,"../../../custom-list/custom-list-collection":23,"../../../custom-list/custom-view":35,"./measurement-list-item-view":49,"./measurement-list-item.tpl":50,"./measurement-list-search.tpl":51,"backbone/core-view":454,"underscore":"underscore"}],53:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var cdb = require('cartodb.js');
var errorParse = require('../../../../helpers/error-parser');
var checkAndBuildOpts = require('../../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'configModel',
  'layerDefinitionModel'
];

module.exports = Backbone.Collection.extend({
  initialize: function (models, options) {
    checkAndBuildOpts(options, REQUIRED_OPTS, this);
    this._country = options.country || 'NULL';
    this._querySchemaModel = this._layerDefinitionModel.getAnalysisDefinitionNodeModel().querySchemaModel;

    var configModel = options.configModel;
    this.SQL = new cdb.SQL({
      user: configModel.get('user_name'),
      sql_api_template: configModel.get('sql_api_template'),
      api_key: configModel.get('api_key')
    });

    this._state = 'unfetched';
  },

  fetch: function (options) {
    this._success = options && options.success;
    this._error = options && options.error;
    var table = this._layerDefinitionModel.getTableName();
    var query = this._querySchemaModel.get('query');

    var sqlQuery = this._queryTemplate({
      table: table,
      query: query,
      country: this._country
    });

    if (!this.isFetching()) {
      this._state = 'fetching';
      this.SQL.execute(sqlQuery, null, {
        success: function (data) {
          this._state = 'fetched';
          this._onFetchSuccess(data);
          this._success && this._success();
        }.bind(this),
        error: function (err) {
          this._state = 'error';
          this._error && this._error(errorParse(err));
        }.bind(this)
      });
    }
  },

  _onFetchSuccess: function (data) {
    var models = data.rows;
    this.reset(models);
  },

  isFetching: function () {
    return this.getState() === 'fetching';
  },

  getState: function () {
    return this._state;
  },

  // these methods below is to use this collection as base collection for custom list view.
  getSelectedItem: function () {
    return _.first(this.getSelected());
  },

  getSelected: function () {
    return this.filter(function (mdl) {
      return mdl.get('selected') === true;
    });
  },

  removeSelected: function () {
    this.each(function (mdl) {
      mdl.set({
        selected: false
      });
    });
  }
});

},{"../../../../helpers/error-parser":426,"../../../../helpers/required-opts":432,"backbone":"backbone","cartodb.js":"cartodb.js","underscore":"underscore"}],54:[function(require,module,exports){
var _ = require('underscore');
var BaseCollection = require('./measurements-base-collection');
var BaseModel = require('../../../custom-list/custom-list-item-model');

var MEASUREMENTS_QUERY = 'SELECT * FROM OBS_GetAvailableNumerators((SELECT ST_SetSRID(ST_Extent(the_geom), 4326) FROM (<%- query %>) q), <%- country %>) numers';

module.exports = BaseCollection.extend({
  initialize: function (models, options) {
    this._queryTemplate = _.template(MEASUREMENTS_QUERY);
    BaseCollection.prototype.initialize.call(this, models, options);
  },

  model: function (attrs, opts) {
    var o = {};
    // label and val to custom list compatibility
    o.val = attrs.numer_id;
    o.label = attrs.numer_name;
    o.description = attrs.numer_description;
    // a measurement can belong to more than one category (filter)
    o.filter = [];
    var tags = JSON.parse(attrs.numer_tags);
    for (var key in tags) {
      if (/^subsection/.test(key)) {
        o.filter.push({
          id: key,
          name: tags[key]
        });
      }

      if (/^license/.test(key)) {
        o.license = tags[key];
      }
    }

    return new BaseModel(o);
  },

  getItem: function (value) {
    return this.findWhere({ val: value });
  },

  setSelected: function (value) {
    var selectedModel;
    var silent = { silent: true };

    this.each(function (mdl) {
      if (mdl.getValue() === value) {
        mdl.set({
          selected: true
        });
        selectedModel = mdl;
      } else {
        mdl.set({
          selected: false
        }, silent);
      }
    });
    return selectedModel;
  }
});

},{"../../../custom-list/custom-list-item-model":25,"./measurements-base-collection":53,"underscore":"underscore"}],55:[function(require,module,exports){
var _ = require('underscore');
var BaseCollection = require('./measurements-base-collection');
var BaseModel = require('../../../custom-list/custom-list-item-model');

var FILTERS_QUERY = "SELECT count(*) num_measurements, tag.key subsection_id, tag.value subsection_name FROM OBS_GetAvailableNumerators((SELECT ST_SetSRID(ST_Extent(the_geom), 4326) FROM (<%- query %>) q), <%- country %>) numers, Jsonb_Each(numers.numer_tags) tag WHERE tag.key like 'subsection%' GROUP BY tag.key, tag.value";

module.exports = BaseCollection.extend({
  initialize: function (models, options) {
    this._queryTemplate = _.template(FILTERS_QUERY);
    BaseCollection.prototype.initialize.call(this, models, options);
  },

  model: function (attrs, opts) {
    // label and val to custom list compatibility
    var o = {};
    o.val = attrs.subsection_id;
    o.label = attrs.subsection_name;
    o.items = attrs.num_measurements;

    return new BaseModel(o);
  },

  setSelected: function (value) {
    var silentTrue = { silent: true };

    if (_.isArray(value)) {
      this.each(function (mdl) {
        if (_.contains(value, mdl.getValue())) {
          mdl.set({
            selected: true
          }, silentTrue);
        } else {
          mdl.set({
            selected: false
          }, silentTrue);
        }
      });
    } else {
      this.each(function (mdl) {
        if (mdl.getValue() === value) {
          mdl.set({
            selected: true
          }, silentTrue);
        } else {
          mdl.set({
            selected: false
          }, silentTrue);
        }
      });
    }
  },

  search: function () {
    return _(this.models);
  },

  containsValue: function (value) {
    return this.length > 0;
  }
});

},{"../../../custom-list/custom-list-item-model":25,"./measurements-base-collection":53,"underscore":"underscore"}],56:[function(require,module,exports){
var Backbone = require('backbone');

/**
 * View model of the fill dialog
 */
module.exports = Backbone.Model.extend({

  defaults: {
    show: false
  },

  show: function () {
    this.set('show', true);
  },

  hide: function () {
    this.set('show', false);
  },

  isHidden: function () {
    return !this.get('show');
  },

  /**
   * @override {Backbone.Model.prototype.destroy}
   */
  destroy: function () {
    var args = Array.prototype.slice.call(arguments);
    this.trigger.apply(this, ['destroy'].concat(args));
  }
});

},{"backbone":"backbone"}],57:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var DatetimeEditorView = require('./datetime-editor-view');

module.exports = CoreView.extend({

  className: 'CDB-Box-modal CustomList CustomList--inputs is-visible has-visibility js-datetimePicker',

  initialize: function () {
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();

    this._datetimeEditorView = new DatetimeEditorView({
      model: this.model
    });
    this.addView(this._datetimeEditorView);
    this.$el.append(this._datetimeEditorView.render().el);

    return this;
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:show', this._onShowChange);
    this.listenTo(this.model, 'destroy', this._onDestroy);
  },

  _onShowChange: function (mdl, show) {
    if (show) {
      this.$el.show();
      this.$el.removeClass('is-closing').addClass('is-opening');
    } else {
      this.$el.removeClass('is-opening').addClass('is-closing');
      this.$el.hide();
    }
  },

  show: function () {
    this.model.show();
  },

  hide: function () {
    this.model.hide();
  },

  _onDestroy: function () {
    this.hide();
    this.clean();
  }
});

},{"./datetime-editor-view":59,"backbone/core-view":454}],58:[function(require,module,exports){
var Backbone = require('backbone');
var Utils = require('../../../../helpers/utils');
var moment = require('moment');

var MONTHS = [
  {
    val: 0,
    label: _t('months.january')
  }, {
    val: 1,
    label: _t('months.february')
  }, {
    val: 2,
    label: _t('months.march')
  }, {
    val: 3,
    label: _t('months.april')
  }, {
    val: 4,
    label: _t('months.may')
  }, {
    val: 5,
    label: _t('months.june')
  }, {
    val: 6,
    label: _t('months.july')
  }, {
    val: 7,
    label: _t('months.august')
  }, {
    val: 8,
    label: _t('months.september')
  }, {
    val: 9,
    label: _t('months.october')
  }, {
    val: 10,
    label: _t('months.november')
  }, {
    val: 11,
    label: _t('months.december')
  }
];

module.exports = Backbone.Model.extend({

  initialize: function () {
    this.schema = {
      day: {
        type: 'Text',
        title: '',
        validators: [
          'required',
          /^(([0]?[1-9])|([1-2][0-9])|(3[01]))$/,
          function (value, formValues) {
            var date = moment(Utils.formatDate(formValues));
            if (!date.isValid()) {
              return {
                type: 'date',
                message: _t('components.datepicker.invalid-date')
              };
            }
          }
        ]
      },
      month: {
        type: 'Select',
        title: '',
        position: {
          'left': 0,
          'min-width': '200px'
        },
        options: MONTHS
      },
      year: {
        title: '',
        type: 'Text',
        validators: ['required', /^([0-9]{0,4})$/]
      },
      time: {
        title: '',
        type: 'Text',
        validators: ['required', /^([01]{1}[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/]
      }
    };
  },

  getFormattedDate: function () {
    return Utils.formatDate(this.toJSON());
  }
});

},{"../../../../helpers/utils":435,"backbone":"backbone","moment":"moment"}],59:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var moment = require('moment');
var DatetimeEditorModel = require('./datetime-editor-model');

module.exports = CoreView.extend({

  tagName: 'div',
  className: 'Table-editorDate',

  events: {
    'keyup': '_onKeyUp'
  },

  initialize: function () {
    var dateAttr = this.model.get('value');
    var date = {};

    if (!dateAttr) {
      date = moment().utc();
    } else {
      date = moment(dateAttr).utc();
    }

    this._formModel = new DatetimeEditorModel({
      day: date.date(),
      month: date.month(),
      year: date.year(),
      time: date.format('HH:mm:ss'),
      utcOffset: date.utcOffset()
    });
    this._formModel.bind('change', this._setValue, this);
    this.add_related_model(this._formModel);

    this._setValue();
  },

  render: function () {
    this._formView = new Backbone.Form({
      model: this._formModel
    });

    this._formView.bind('change', function () {
      this.commit();
    });

    this.$el.html(this._formView.render().el);

    return this;
  },

  _setValue: function () {
    this.model.set('value', this._formModel.getFormattedDate());
  },

  _onKeyUp: function () {
    this._setValue();
  },

  clean: function () {
    this._formView.remove();
    CoreView.prototype.clean.apply(this);
  }

});

},{"./datetime-editor-model":58,"backbone":"backbone","backbone/core-view":454,"moment":"moment"}],60:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var moment = require('moment');

var DatetimeDialogModel = require('./datetime-dialog-model');
var DatetimeDialogView = require('./datetime-dialog-view');
var template = require('./datetime.tpl');

var PopupManager = require('../../../popup-manager');

Backbone.Form.editors.DateTime = Backbone.Form.editors.Base.extend({
  className: 'Editor-formInput u-flex u-alignCenter',

  events: {
    'click .js-input': '_onInputClick'
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    this.dialogMode = this.options.dialogMode || 'nested';
    this._initBinds();
    this.render();
  },

  render: function () {
    Backbone.Form.editors.Base.prototype.render.apply(this, arguments);

    this._removeDateTimeDialog();

    this.$el.html(
      template({
        value: this._getFormattedDatetime()
      })
    );

    this._initViews();

    return this;
  },

  _getFormattedDatetime: function () {
    if (this.value) {
      var value = new Date(this.value).toUTCString();
      var momentObj = moment(value).utc();
      return momentObj.format('YYYY-MM-DD') + 'T' + momentObj.format('HH:mm:ss') + 'Z';
    }

    // for datetime type, empty '' value raises an error on Postgres
    return null;
  },

  _initViews: function () {
    if (this.options.editorAttrs && this.options.editorAttrs.disabled) {
      this.$el.addClass('is-disabled');
    }

    this._datetimeDialogModel = new DatetimeDialogModel({
      value: this._getFormattedDatetime()
    });
    this._datetimeDialogModel.bind('change:value', this._onInputChanged, this);

    this._datetimeDialogView = new DatetimeDialogView({
      model: this._datetimeDialogModel
    });

    this._popupManager = new PopupManager(this.cid, this.$el, this._datetimeDialogView.$el);
  },

  _initBinds: function () {
    var hide = function () {
      this._removeDateTimeDialog();
    }.bind(this);
    this.applyESCBind(hide);
    this.applyClickOutsideBind(hide);
  },

  _onInputClick: function () {
    this._datetimeDialogView.render();
    this._popupManager.append(this.dialogMode);
    this._popupManager.track();
  },

  _removeDateTimeDialog: function () {
    if (this._datetimeDialogView) {
      this._popupManager.untrack();
      this._datetimeDialogView.remove();
    }
  },

  _onInputChanged: function (mdl) {
    var value = this._datetimeDialogModel.get('value');
    this.setValue(value);

    this.trigger('change', this);
  },

  _updateInput: function (value) {
    this.$('.js-input')
      .toggleClass('is-empty', !value)
      .text(value);
  },

  getValue: function () {
    return this._datetimeDialogModel.get('value');
  },

  setValue: function (value) {
    this._updateInput(value);
    this.value = value;
  },

  remove: function () {
    this._removeDateTimeDialog();
    this._popupManager && this._popupManager.destroy();
    Backbone.Form.editors.Base.prototype.remove.apply(this);
  }
});

},{"../../../popup-manager":263,"../editor-helpers-extend":62,"./datetime-dialog-model":56,"./datetime-dialog-view":57,"./datetime.tpl":61,"backbone":"backbone","moment":"moment"}],61:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button type="button" class="CDB-InputText\n  ';
 if (!value) { 
__p+=' is-empty ';
 } 
__p+='\n  u-txt-left js-input">'+
((__t=( value ? value : 'null' ))==null?'':_.escape(__t))+
'</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],62:[function(require,module,exports){
var _ = require('underscore');

module.exports = {

  setOptions: function (editor, opts) {
    var validators = [];

    if (opts.schema && opts.schema.validators) {
      validators = validators.concat(opts.schema.validators);
    }

    if (editor.options && editor.options.validators) {
      validators = validators.concat(editor.options.validators);
    }

    editor.validators = validators;

    editor.options = _.extend(
      {},
      _.omit(editor.options, 'validators') || {},
      opts.schema,
      // 'editorAttrs' can appear in schema if it comes from a Backbone form component
      // or in options directly if the component is created without a Backbone form
      opts.schema && opts.schema.editorAttrs || {},
      opts.editorAttrs,
      {
        keyAttr: opts.key
      },
      {
        validators: validators
      },
      _.omit(opts, 'validators')
    );

    if (editor.options.className) {
      editor.$el.addClass(editor.options.className);
    }

    if (editor.options.trackingClass) {
      var trackClasses = editor.options.trackingClass + ' track-' + editor.options.key + editor.options.editorType;
      editor.$el.addClass(trackClasses);
    }
  }
};

},{"underscore":"underscore"}],63:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var $ = require('jquery');
var _ = require('underscore');
var TipsyTooltipView = require('../../../tipsy-tooltip-view');
var template = require('./enabler-editor.tpl');

/**
 *  Creates an element that enables another component, tested with:
 *
 *  select, number and input so far.
 */

Backbone.Form.editors.EnablerEditor = Backbone.Form.editors.Base.extend({
  tagName: 'div',
  className: 'Editor-checker u-flex u-alignCenter',

  events: {
    'click .js-check': '_onCheckClicked'
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    // Disable validators unless it's enabled
    this.validators = null;

    if (!this.options.editor) {
      throw new Error('editor options is required');
    }

    this._editorOptions = this.options.editor;
    this.value = this.model.get(opts.key);
    this._checkModel = new Backbone.Model({
      enabled: !!this.value
    });
    this.template = template;

    this._initBinds();
  },

  render: function () {
    this.$el.html(
      this.template({
        label: this.options.label,
        isChecked: this._isChecked(),
        help: this.options.help || ''
      })
    );

    if (this.options.help) {
      this._helpTooltip = new TipsyTooltipView({
        el: this.$('.js-help'),
        gravity: 's',
        offset: 0,
        title: function () {
          return $(this).data('tooltip');
        }
      });
    }

    this._renderComponent();

    return this;
  },

  _initBinds: function () {
    this._checkModel.bind('change:enabled', function (mdl, isEnabled) {
      this._manageValue(isEnabled);
      this._renderComponent();
      this._triggerChange();
    }, this);
  },

  _manageValue: function (isEnabled) {
    if (isEnabled) {
      this.validators = this.options.validators;
      this.value = this.options.defaultValue || '';
      this._editorComponent.setValue(this.options.defaultValue || '');
    } else {
      this.validators = null;
      this.value = '';
      this._editorComponent.setValue('');
    }
    this.model.set(this.options.keyAttr, this.value);
    this.validate();
  },

  _isChecked: function () {
    return this._checkModel.get('enabled');
  },

  _renderComponent: function () {
    if (this._editorComponent) {
      this._removeComponent();
    }

    var EditorClass = Backbone.Form.editors[this._editorOptions.type];
    var editorAttrs = _.extend(
      this._editorOptions.editorAttrs || {},
      {
        disabled: !this._isChecked()
      }
    );

    this._editorComponent = new EditorClass(
      _.extend(
        {
          model: this.model,
          key: this.options.keyAttr,
          editorAttrs: editorAttrs,
          trackingClass: this.options.trackingClass,
          editorType: this._editorOptions.type
        },
        _.omit(this._editorOptions, 'editorAttrs', 'type')
      )
    );
    this._editorComponent.bind('change', this._setEditorComponentValue, this);
    this.$('.js-editor').html(this._editorComponent.render().el);

    // Not all editor implement the focus method
    try {
      this._editorComponent.focus();
    } catch (e) {}
  },

  _removeComponent: function () {
    this._editorComponent.remove();
    this._editorComponent.unbind('change', this._setEditorComponentValue, this);
  },

  _setEditorComponentValue: function () {
    this.value = this._editorComponent.getValue();
    this._triggerChange();
  },

  _triggerChange: function () {
    this.trigger('change', this);
  },

  getValue: function () {
    if (this._checkModel.get('enabled')) {
      return this._editorComponent && this._editorComponent.getValue() || '';
    } else {
      return '';
    }
  },

  setValue: function (value) {
    this._checkModel.set('enabled', !!value);
    if (this._editorComponent) {
      this._editorComponent.setValue(value);
    }
    this.value = value;
  },

  _onCheckClicked: function (ev) {
    this._checkModel.set('enabled', $(ev.target).is(':checked'));
  },

  remove: function () {
    if (this._editorComponent) {
      this._removeComponent();
    }
    if (this._helpTooltip) {
      this._helpTooltip.clean();
    }
    Backbone.Form.editors.Base.prototype.remove.call(this);
  }

});

},{"../../../tipsy-tooltip-view":325,"../editor-helpers-extend":62,"./enabler-editor.tpl":64,"backbone":"backbone","jquery":"jquery","underscore":"underscore"}],64:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex Editor-checkerInput CDB-Text CDB-Size-medium u-rSpace--xl">\n  <input class="CDB-Checkbox js-check" type="checkbox" name="" value="" ';
 if (isChecked) { 
__p+='checked';
 } 
__p+='>\n  <span class="CDB-Checkbox-face u-rSpace--m"></span>\n  <label class="CDB-Text CDB-Size-small u-ellipsis u-upperCase is-semibold u-flex u-alignCenter Editor-formLabel">\n    <span class="u-ellipsis ';
 if (help) { 
__p+=' js-help is-underlined';
 } 
__p+='" ';
 if (help) { 
__p+=' data-tooltip="'+
((__t=( help ))==null?'':_.escape(__t))+
'"';
 } 
__p+='  title="'+
((__t=( label ))==null?'':_.escape(__t))+
'">'+
((__t=( label ))==null?'':_.escape(__t))+
'</span>\n  </label>\n</div>\n<div class="Editor-checkerComponent js-editor"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],65:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<label class="CDB-Legend u-upperCase CDB-Text is-semibold CDB-Size-small">\n  <div class="u-flex u-alignCenter">\n    <div class="u-iBlock u-rSpace--m">\n      <input class="CDB-Checkbox js-input" type="checkbox" name="" value="" ';
 if (checked) { 
__p+='checked';
 } 
__p+=' ';
 if (disabled) { 
__p+='disabled';
 } 
__p+='>\n      <span class="u-iBlock CDB-Checkbox-face"></span>\n    </div>\n    <span class="';
 if (help) { 
__p+=' js-help is-underlined';
 } 
__p+='" ';
 if (help) { 
__p+=' data-tooltip="'+
((__t=( help ))==null?'':_.escape(__t))+
'"';
 } 
__p+=' >'+
((__t=( label ))==null?'':_.escape(__t))+
'</span>\n  </div>\n</label>\n<div class="Editor-checkerComponent js-editor"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],66:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var $ = require('jquery');
var TipsyTooltipView = require('../../../tipsy-tooltip-view');
var template = require('./enabler.tpl');
var templateReversed = require('./enabler-reversed.tpl');

Backbone.Form.editors.Enabler = Backbone.Form.editors.Base.extend({
  tagName: 'div',

  events: {
    'change .js-input': '_onCheckChange',
    'focus .js-input': function () {
      this.trigger('focus', this);
    },
    'blur .js-input': function () {
      this.trigger('blur', this);
    }
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    this.template = opts.schema && opts.schema.editorAttrs && opts.schema.editorAttrs.reversed ? templateReversed : (opts.template || template);
    this._initViews();
  },

  _initViews: function () {
    this.$el.html(
      this.template({
        checked: this.options.disabled ? false : this.model.get(this.options.key),
        label: this.options.label,
        title: this.options.title,
        help: this.options.help || '',
        disabled: this.options.disabled
      })
    );

    if (this.options.help) {
      this._removeTooltip();

      this._helpTooltip = new TipsyTooltipView({
        el: this.$('.js-help'),
        gravity: 's',
        title: function () {
          return $(this).data('tooltip');
        }
      });
    }

    if (this.options.disabled) {
      this.undelegateEvents();
    }
  },

  _onCheckChange: function () {
    var isEnabled = this.$('.js-input').is(':checked');
    this.model.set('enabler', isEnabled);
    this.trigger('change', this);
  },

  getValue: function () {
    return this.$('.js-input').is(':checked');
  },

  setValue: function (value) {
    this.$('.js-input')[value ? 'attr' : 'removeAttr']('checked', '');
    this.model.set(this.key, value);
  },

  _removeTooltip: function () {
    if (this._helpTooltip) {
      this._helpTooltip.clean();
    }
  },

  remove: function () {
    this._removeTooltip();
    Backbone.Form.editors.Base.prototype.remove.apply(this);
  }

});

},{"../../../tipsy-tooltip-view":325,"../editor-helpers-extend":62,"./enabler-reversed.tpl":65,"./enabler.tpl":67,"backbone":"backbone","jquery":"jquery"}],67:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<label class="CDB-Legend u-upperCase CDB-Text is-semibold CDB-Size-small">\n  <div class="u-flex u-alignCenter">\n    <div class="u-iBlock u-rSpace--m">\n      <input class="CDB-Checkbox js-input" type="checkbox" name="" value="" ';
 if (checked) { 
__p+='checked';
 } 
__p+=' ';
 if (disabled) { 
__p+='disabled';
 } 
__p+='>\n      <span class="u-iBlock CDB-Checkbox-face"></span>\n    </div>\n    <span class="';
 if (help) { 
__p+=' js-help is-underlined';
 } 
__p+='" ';
 if (help) { 
__p+=' data-tooltip="'+
((__t=( help ))==null?'':_.escape(__t))+
'"';
 } 
__p+=' >'+
((__t=( title ))==null?'':_.escape(__t))+
'</span>\n  </div>\n</label>\n<div class="CDB-Text CDB-Size-medium Editor-formInput js-editor"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],68:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="colorpicker dropdown-menu">\n  <div class="colorpicker-saturation">\n    <i><b></b></i>\n  </div>\n  <div class="colorpicker-hue">\n    <i class="ColorPicker-ball"></i>\n  </div>\n  <div class="colorpicker-alpha js-alpha">\n    <i class="ColorPicker-ball"></i>\n  </div>\n  <div class="ColorPicker-colorWrapper">\n    <div class="ColorPicker-color colorpicker-color js-color"></div>\n  </div>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],69:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
require('bootstrap-colorpicker');
var template = require('./template.tpl');
var colorPickerTemplate = require('./color-picker-template.tpl');
var Utils = require('../../../../../helpers/utils');

var ESCAPE_KEY_CODE = 27;

module.exports = CoreView.extend({
  events: {
    'blur .js-hex': '_onChangeHex',
    'blur .js-inputColor': '_onChangeColorValue',
    'blur .js-a': '_onChangeOpacity'
  },

  initialize: function (opts) {
    var opacity = opts.opacity != null ? opts.opacity : 1;

    this.model = new Backbone.Model({
      hex: opts.value,
      opacity: opacity
    });

    this._onEscape = this._onEscapePressed.bind(this);
    this._initBinds();
  },

  render: function () {
    var rgb = Utils.hexToRGB(this.model.get('hex'));

    var color = _.extend(rgb, {
      hex: this.model.get('hex'),
      opacity: this.model.get('opacity'),
      opacityDisabled: this.options.disableOpacity
    });

    this.$el.append(template(color));

    var rgbaTemplate = _.template('rgba(<%- r %>, <%- g %>, <%- b %>, <%- opacity %>)');

    this.$('.js-colorPicker').colorpicker({
      color: rgbaTemplate(color),
      format: 'rgba',
      container: true,
      horizontal: true,
      inline: true,
      customClass: 'ColorPicker',
      template: colorPickerTemplate(),
      slidersHorz: {
        saturation: {
          maxLeft: 206,
          maxTop: 95,
          callLeft: 'setSaturation',
          callTop: 'setBrightness'
        },
        hue: {
          maxLeft: 180,
          maxTop: 0,
          callLeft: 'setHue',
          callTop: false
        },
        alpha: {
          maxLeft: 180,
          maxTop: 0,
          callLeft: 'setAlpha',
          callTop: false
        }
      }
    });

    if (this.options.disableOpacity) {
      this.$('.js-colorPicker .js-alpha').addClass('is-hidden');
    }

    var setNewColor = function (e) {
      var rgb = e.color.toRGB();
      var hex = e.color.toHex();
      this.model.set({ hex: hex, r: rgb.r, g: rgb.g, b: rgb.b, opacity: rgb.a });
      this.$('.js-color').css('opacity', rgb.a);
    }.bind(this);

    this.$('.js-colorPicker').colorpicker().on('changeColor', setNewColor);

    this._initDocumentBinds();
    return this;
  },

  _initBinds: function () {
    this.model.bind('change:hex', this._onChangeColor, this);
    this.model.bind('change:r', this._onChangeColor, this);
    this.model.bind('change:g', this._onChangeColor, this);
    this.model.bind('change:b', this._onChangeColor, this);
    this.model.bind('change:opacity', this._onChangeColor, this);
  },

  _onEscapePressed: function (ev) {
    if (ev.which === ESCAPE_KEY_CODE) {
      this.remove();
    }
  },

  _initDocumentBinds: function () {
    $(document).on('keydown', this._onEscape);
  },

  _destroyDocumentBinds: function () {
    $(document).off('keydown', this._onEscape);
  },

  _onChangeColor: function () {
    this.trigger('change', {
      opacity: this.model.get('opacity'),
      hex: this.model.get('hex')
    }, this);

    this.$('.js-hex').val(this.model.get('hex'));
    this.$('.js-r').val(this.model.get('r'));
    this.$('.js-g').val(this.model.get('g'));
    this.$('.js-b').val(this.model.get('b'));
    this.$('.js-a').val(this.model.get('opacity'));
  },

  _onChangeOpacity: function () {
    var opacity = +this.$('.js-a').val();
    if (_.isNumber(opacity) && opacity >= 0 && opacity <= 1) {
      this.setColor(this.model.get('hex'), opacity);
    }
  },

  _onChangeColorValue: function (e) {
    this.$(e.target).removeClass('has-error');

    var r = +this.$('.js-r').val();
    var g = +this.$('.js-g').val();
    var b = +this.$('.js-b').val();

    var hex = Utils.rgbToHex(r, g, b);

    if (Utils.isValidHex(hex)) {
      this.setColor(hex);
    } else {
      this.$(e.target).addClass('has-error');
    }
  },

  _onChangeHex: function (e) {
    this.$(e.target).removeClass('has-error');

    var hex = this.$('.js-hex').val();

    if (Utils.isValidHex(hex)) {
      this.setColor(hex);
    } else {
      this.$(e.target).addClass('has-error');
    }
  },

  setColor: function (hex, opacity) {
    if (opacity === undefined) {
      opacity = this.model.get('opacity') || 1;
    }

    this.$('.js-colorPicker').colorpicker('setValue', Utils.hexToRGBA(hex, opacity));
  },

  clean: function () {
    this._destroyDocumentBinds();
    CoreView.prototype.clean.apply(this);
  }
});

},{"../../../../../helpers/utils":435,"./color-picker-template.tpl":68,"./template.tpl":70,"backbone":"backbone","backbone/core-view":454,"bootstrap-colorpicker":"bootstrap-colorpicker","jquery":"jquery","underscore":"underscore"}],70:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-boxModalContent">\n  <div class="ColorPicker-pickerWrapper js-colorPicker"></div>\n  <div class="ColorPicker-inputs">\n    <div class="ColorPicker-inputWrapper CDB-Text">\n      <input type="text" class="CDB-Text CDB-InputText ColorPicker-input is-color js-hex" value="'+
((__t=( hex ))==null?'':_.escape(__t))+
'"/>\n      <span class="ColorPicker-inputLabel u-upperCase">HEX</span>\n    </div>\n    <div class="ColorPicker-inputWrapper CDB-Text">\n      <input type="text" class="CDB-Text CDB-InputText ColorPicker-input js-inputColor js-r" value="'+
((__t=( r ))==null?'':_.escape(__t))+
'"/>\n      <span class="ColorPicker-inputLabel u-upperCase">R</span>\n    </div>\n    <div class="ColorPicker-inputWrapper CDB-Text">\n      <input type="text" class="CDB-Text CDB-InputText ColorPicker-input js-inputColor js-g" value="'+
((__t=( g ))==null?'':_.escape(__t))+
'" />\n      <span class="ColorPicker-inputLabel u-upperCase">G</span>\n    </div>\n    <div class="ColorPicker-inputWrapper CDB-Text">\n      <input type="text" class="CDB-Text CDB-InputText ColorPicker-input js-inputColor js-b" value="'+
((__t=( b ))==null?'':_.escape(__t))+
'" />\n      <span class="ColorPicker-inputLabel u-upperCase">B</span>\n    </div>\n    <div class="ColorPicker-inputWrapper CDB-Text">\n      <input type="text" class="CDB-Text CDB-InputText ColorPicker-input js-a';
 if (opacityDisabled) { 
__p+=' is-disabled';
 } 
__p+='" value="'+
((__t=( opacity ))==null?'':_.escape(__t))+
'" ';
 if (opacityDisabled) { 
__p+='disabled';
 } 
__p+=' />\n      <span class="ColorPicker-inputLabel u-upperCase">A</span>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],71:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var CustomListView = require('../../../custom-list/custom-view');
var CustomListCollection = require('../../../custom-list/custom-list-collection');
var template = require('./column-list-view.tpl');

module.exports = CoreView.extend({
  defaults: {
    headerTitle: ''
  },

  events: {
    'click .js-back': '_onClickBack'
  },

  initialize: function (opts) {
    if (!opts.stackLayoutModel) throw new Error('stackLayoutModel is required');
    if (!opts.columns) throw new Error('columns param is required');

    this._stackLayoutModel = opts.stackLayoutModel;
    this._columns = opts.columns;
    this._showSearch = opts.showSearch || false;
    this._typeLabel = opts.typeLabel;
    this._itemTemplate = opts.itemTemplate;

    this.collection = new CustomListCollection(this._columns);
    this.listenTo(this.collection, 'change:selected', this._onSelectItem);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    this.$el.append(
      template({
        headerTitle: this.options.headerTitle
      })
    );

    this._initViews();

    return this;
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.trigger('back', this);
  },

  _initViews: function () {
    this._listView = new CustomListView({
      collection: this.collection,
      showSearch: this._showSearch,
      typeLabel: this._typeLabel,
      itemTemplate: this._itemTemplate
    });
    this.$('.js-content').append(this._listView.render().$el);
    this.addView(this._listView);
  },

  _onSelectItem: function (item) {
    this.trigger('selectItem', item, this);
  }
});

},{"../../../custom-list/custom-list-collection":23,"../../../custom-list/custom-view":35,"./column-list-view.tpl":72,"backbone/core-view":454}],72:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (headerTitle) { 
__p+='\n<div class="CDB-Box-modalHeader">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <button class="u-actionTextColor js-back u-rSpace">\n        <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n      </button>\n      '+
((__t=( headerTitle))==null?'':_.escape(__t))+
'\n    </li>\n  </ul>\n</div>\n';
 } 
__p+='\n<div class="js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],73:[function(require,module,exports){
module.exports={
  "number": {
    "quantifications": {
      "items": ["quantiles", "jenks", "equal", "headtails"],
      "defaultIndex": 0
    },
    "bins": {
      "items": ["2", "3", "4", "5", "6", "7"],
      "defaultIndex": 3
    }
  },
  "color": {
    "quantifications": {
      "items": ["jenks", "equal", "headtails", "quantiles", "category"],
      "defaultIndex": 0
    }
  },
  "color-ramps": {
    "quantifications": {
      "items": ["quantiles", "jenks", "equal", "headtails", "category"],
      "defaultIndex": 0
    },
    "bins": {
      "items": ["2", "3", "4", "5", "6", "7"],
      "defaultIndex": 3
    }
  }
}

},{}],74:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');

/**
 * View model of the fill dialog
 */
module.exports = Backbone.Model.extend({

  defaults: {
    visible: true,
    createContentView: function () {
      return new CoreView();
    }
  },

  createContentView: function () {
    return this.get('createContentView')(this);
  },

  show: function () {
    this.set('visible', true);
  },

  hide: function () {
    this.set('visible', false);
  },

  isHidden: function () {
    return !this.get('visible');
  },

  /**
   * @override {Backbone.Model.prototype.destroy}
   */
  destroy: function () {
    var args = Array.prototype.slice.call(arguments);
    this.trigger.apply(this, ['destroy'].concat(args));
  }
});

},{"backbone":"backbone","backbone/core-view":454}],75:[function(require,module,exports){
var CoreView = require('backbone/core-view');

module.exports = CoreView.extend({
  className: 'Editor-boxModal Editor-FormDialog js-formDialog is-opening',

  initialize: function () {
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this._renderContentView();
    return this;
  },

  _renderContentView: function () {
    var view = this.model.createContentView();
    this.addView(view);
    this.$el.append(view.render().$el);
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:show', this._onShowChange);
    this.listenTo(this.model, 'destroy', this._onDestroy);
  },

  _onShowChange: function (m, show) {
    if (show) {
      this.$el.show();
      this.$el.removeClass('is-closing').addClass('is-opening');
    } else {
      this.$el.removeClass('is-opening').addClass('is-closing');
      this.$el.hide();
    }
  },

  show: function () {
    this.model.show();
  },

  hide: function () {
    this.model.hide();
  },

  _onDestroy: function () {
    this.hide();
    this.clean();
  }
});

},{"backbone/core-view":454}],76:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-boxModalHeader">\n  <nav class="CDB-NavMenu">\n    <ul class="CDB-NavMenu-Inner CDB-NavMenu-inner--no-margin CDB-NavMenu-inner--is-dropdown CDB-Text is-semibold CDB-Size-medium js-menu"></ul>\n  </nav>\n</div>\n<div class="js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],77:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="CDB-OptionInput-container js-content"></ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],78:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');

var FillDialogModel = require('./fill-dialog-model');
var FillDialogView = require('./fill-dialog');

var InputCollection = require('./input-collection');
var InputNumber = require('./input-number/input-number');
var InputColor = require('./input-color/input-color');

var template = require('./fill-template.tpl');

var PopupManager = require('../../../popup-manager');

var INPUT_TYPE_MAP = {
  'size': InputNumber,
  'color': InputColor,
  'image': InputColor
};

var QUANTIFICATION_REF = {
  'Jenks': 'jenks',
  'Equal Interval': 'equal',
  'Heads/Tails': 'headtails',
  'Quantile': 'quantiles'
};

var MIN_IMAGE_SIZE = 20;

Backbone.Form.editors.Fill = Backbone.Form.editors.Base.extend({
  className: 'Form-InputFill CDB-OptionInput CDB-Text js-input',

  events: {
    focus: function () {
      this.trigger('focus', this);
    },
    blur: function () {
      this.trigger('blur', this);
    }
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts); // Options

    this.options = _.extend(
      this.options,
      {
        columns: this.options.options,
        query: this.options.query,
        configModel: this.options.configModel,
        userModel: this.options.userModel,
        editorAttrs: this.options.editorAttrs,
        modals: this.options.modals
      }
    );

    this._keyAttr = opts.key;
    this.dialogMode = this.options.dialogMode || 'nested';

    this._initBinds();
    this._initViews();
  },

  _initViews: function () {
    this.$el.append(template());

    if (this.options.editorAttrs && this.options.editorAttrs.disabled) {
      this.$el.addClass('is-disabled');
    }

    this._initFillDialog();
    this._initInputFields();

    this._popupManager = new PopupManager(this.cid, this.$el, this._fillDialogView.$el);
  },

  _initInputFields: function () {
    var inputKlass;

    this._inputCollection = new InputCollection();

    _.each(this.model.get(this._keyAttr), function (value, key) {
      this._inputCollection.add(_.extend({ type: key }, value));
    }, this);

    this._inputCollection.each(function (inputModel) {
      var type = inputModel.get('type');

      var Klass = INPUT_TYPE_MAP[type];

      if (!Klass) {
        throw new Error(type + ' is not a valid type of constructor');
      }

      if (inputModel.get('quantification') && QUANTIFICATION_REF[inputModel.get('quantification')]) {
        inputModel.set('quantification', QUANTIFICATION_REF[inputModel.get('quantification')], { silent: true });
      }

      inputKlass = new Klass(({
        model: inputModel,
        columns: this.options.columns,
        query: this.options.query,
        configModel: this.options.configModel,
        userModel: this.options.userModel,
        modals: this.options.modals,
        editorAttrs: this.options.editorAttrs ? this.options.editorAttrs[type] : {},
        disabled: this.options.editorAttrs && this.options.editorAttrs.disabled
      }));

      inputKlass.bind('click', this._onInputClick, this);

      this.$('.js-content').append(inputKlass.render().$el);
    }, this);

    this._inputCollection.bind('inputChanged', this._onInputChanged, this);
  },

  _initBinds: function () {
    this.applyESCBind(function () {
      this._removeDialog();
    });
    this.applyClickOutsideBind(function () {
      this._removeDialog();
    });
  },

  _onInputClick: function (inputModel) {
    if (inputModel.get('selected')) {
      this._removeDialog();
      return;
    }

    inputModel.set('selected', true);
    this._fillDialogView.model.set('createContentView', inputModel.get('createContentView'));
    this._fillDialogView.render();
    this._fillDialogView.show();

    this._popupManager.append(this.dialogMode);
    this._popupManager.track();
  },

  _onInputChanged: function (mdl) {
    this._adjustImageSize(mdl);
    this.trigger('change', this);
  },

  _adjustImageSize: function (mdl) {
    if (mdl.get('type') !== 'color' && mdl.get('kind') !== 'marker') {
      return;
    }

    var changedImage = mdl.get('image') && mdl.hasChanged('image') && !mdl.previous('image');

    var hasImages = _.isEmpty(_.compact(mdl.get('images')));
    var hadImages = _.isEmpty(_.compact(mdl.previous('images')));
    var changedImages = !hasImages && mdl.hasChanged('images') && hadImages;

    if (changedImage || changedImages) {
      var size = this._inputCollection.findWhere({ type: 'size' });

      if (size && size.get('fixed') < MIN_IMAGE_SIZE) {
        size.set('fixed', MIN_IMAGE_SIZE);
      }
    }
  },

  _initFillDialog: function () {
    var fillDialogModel = new FillDialogModel();

    this.listenToOnce(fillDialogModel, 'destroy', function () {
      this._fillDialogView = null;
      this.stopListening(fillDialogModel);
    });

    this._fillDialogView = new FillDialogView({
      model: fillDialogModel
    });
  },

  _removeDialog: function (dialog) {
    this._inputCollection.unselect();
    this._fillDialogView.remove();
    this._popupManager.untrack();
  },

  focus: function () {
    if (this.hasFocus) return;
    this.$('.js-fillInput').focus();
  },

  blur: function () {
    if (!this.hasFocus) return;
    this.$('.js-fillInput').blur();
  },

  getValue: function () {
    return this._inputCollection.getValues();
  },

  setValue: function (value) {
    // TODO: add setter
  },

  remove: function () {
    this._removeDialog();
    this._popupManager.destroy();
    this._inputCollection.unbind('inputChanged', this._onInputChanged, this);
    Backbone.Form.editors.Base.prototype.remove.apply(this);
  }
});

},{"../../../popup-manager":263,"../editor-helpers-extend":62,"./fill-dialog":75,"./fill-dialog-model":74,"./fill-template.tpl":77,"./input-collection":79,"./input-color/input-color":121,"./input-number/input-number":137,"backbone":"backbone","underscore":"underscore"}],79:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

var INPUT_TYPE_ORDER = ['size', 'color'];

module.exports = Backbone.Collection.extend({
  constructor: function (models, options) {
    options = _.extend(options || {}, { silent: false });
    Backbone.Collection.prototype.constructor.call(this, models, options);
  },

  comparator: function (m) {
    return INPUT_TYPE_ORDER.indexOf(m.get('type'));
  },

  initialize: function () {
    this.bind('change:selected', this._onSelectedChange, this);
    this.bind('change', this._onModelsChanged, this);
  },

  getSelected: function () {
    return this.find(function (model) {
      return model.get('selected');
    });
  },

  unselect: function () {
    this.each(function (model) {
      model.set('selected', false);
    }, this);
  },

  _onSelectedChange: function (itemModel, isSelected) {
    if (!isSelected) {
      return;
    }

    this.each(function (model) {
      if (model !== itemModel) {
        model.set('selected', false);
      }
    }, this);
  },

  _onModelsChanged: function (mdl) {
    var mdlChanges = mdl.changed;

    // If there is any change about selected, don't propagate it
    if (_.isEmpty(mdlChanges) || (_.size(mdlChanges) === 1 && mdl.changed.hasOwnProperty('selected'))) {
      return;
    }

    this.trigger('inputChanged', mdl, this);
  },

  getValues: function () {
    return this.reduce(function (memo, mdl) {
      var data = {};
      var typeValues = mdl.toJSON();

      if (typeValues.fixed) {
        data.fixed = typeValues.fixed;

        if (typeValues.type === 'color') {
          if (typeValues.image) {
            data.image = typeValues.image;
          }
          if (typeValues.kind) {
            data.kind = typeValues.kind;
          }
          data.opacity = typeValues.opacity;
        }
      } else {
        data = _.omit(typeValues, ['createContentView', 'selected', 'type']);
      }

      memo[typeValues.type] = data;

      return memo;
    }, {});
  }
});

},{"backbone":"backbone","underscore":"underscore"}],80:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var checkAndBuildOpts = require('../../../../../../helpers/required-opts');
var template = require('./asset-header-view.tpl');

var REQUIRED_OPTS = [
  'title',
  'editable'
];

module.exports = CoreView.extend({
  events: {
    'click .js-remove': '_onClickRemove',
    'click .js-select-all': '_onClickSelectAll',
    'click .js-deselect-all': '_onClickDeselectAll'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._assetsCollection = this.options.assetsCollection;

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();

    var selectedCount = this._getSelectedAssetsCount();

    var assetsCount = this._assetsCollection.size();

    this.$el.html(template({
      title: this._title,
      editable: this._editable,
      assetsCount: assetsCount,
      selectedCount: selectedCount,
      allSelected: selectedCount === assetsCount
    }));

    return this;
  },

  _initBinds: function () {
    this.listenTo(this._assetsCollection, 'add change remove', this.render);
  },

  _onClickRemove: function () {
    this.trigger('remove');
  },

  _onClickSelectAll: function () {
    this.trigger('select-all');
  },

  _onClickDeselectAll: function () {
    this.trigger('deselect-all');
  },

  _getSelectedAssetsCount: function () {
    var selectedAssets = this._assetsCollection.where({ state: 'selected' });
    return selectedAssets ? selectedAssets.length : 0;
  }
});

},{"../../../../../../helpers/required-opts":432,"./asset-header-view.tpl":81,"backbone/core-view":454}],81:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul>\n  <li class="CDB-NavSubmenu-item">\n    <h2 class="CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h2>\n  </li>\n  ';
 if (editable && assetsCount > 0) { 
__p+='\n    ';
 if (allSelected) { 
__p+='\n      <li class="CDB-NavSubmenu-item">\n        <button class="CDB-NavSubmenu-itemLink CDB-Text CDB-Size-medium u-actionTextColor js-deselect-all">'+
((__t=( _t('components.modals.assets-picker.deselect-all') ))==null?'':_.escape(__t))+
'</button>\n      </li>\n      ';
 } else if (selectedCount > 0) { 
__p+='\n      <li class="CDB-NavSubmenu-item">\n        <button class="CDB-NavSubmenu-itemLink CDB-Text CDB-Size-medium u-actionTextColor js-select-all">'+
((__t=( _t('components.modals.assets-picker.select-all') ))==null?'':_.escape(__t))+
'</button>\n      </li>\n    ';
 } 
__p+='\n\n    ';
 if (selectedCount > 0) { 
__p+='\n      <li class="CDB-NavSubmenu-item">\n          ';
 if (selectedCount > 1) { 
__p+='\n        <button class="CDB-NavSubmenu-itemLink CDB-Text CDB-Size-medium u-errorTextColor js-remove">'+
((__t=( _t('components.modals.assets-picker.delete-images') ))==null?'':_.escape(__t))+
'</button>\n        ';
 } else { 
__p+='\n        <button class="CDB-NavSubmenu-itemLink CDB-Text CDB-Size-medium u-errorTextColor js-remove">'+
((__t=( _t('components.modals.assets-picker.delete-image') ))==null?'':_.escape(__t))+
'</button>\n        ';
 } 
__p+='\n      </li>\n    ';
 } 
__p+='\n  ';
 } 
__p+='\n</ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],82:[function(require,module,exports){
var CoreView = require('backbone/core-view');

var template = require('./asset-item-view.tpl');

var ASSET_HEIGHT = 24;

module.exports = CoreView.extend({
  tagName: 'li',
  className: 'AssetsList-item AssetsList-item--medium',

  events: {
    'click .js-asset': '_onClick'
  },

  initialize: function (opts) {
    this.listenTo(this.model, 'change:state', this._changeState);
  },

  render: function () {
    this.clearSubViews();

    this.$el.attr('id', this.model.get('id'));

    var type = this.model.get('type') || 'icon';

    this.$el.append(template({
      type: type,
      height: this.options.assetHeight || ASSET_HEIGHT,
      name: this.model.get('name'),
      public_url: this.model.get('public_url')
    }));

    this.$el.addClass('AssetsList-item--' + type);

    return this;
  },

  _onClick: function (e) {
    this.killEvent(e);
    this.trigger('selected', this.model);
  },

  _changeState: function () {
    this.$el.toggleClass('is-selected', this.model.get('state') === 'selected');
  }
});

},{"./asset-item-view.tpl":83,"backbone/core-view":454}],83:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="AssetItem-label CDB-Text CDB-Size-big ';
 if (type === 'icon') { 
__p+='u-mainTextColor';
 } else { 
__p+='u-actionTextColor';
 } 
__p+=' u-upperCase js-asset" title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">\n  ';
 if (type === 'icon' || type === 'file') { 
__p+='\n    <img height="'+
((__t=( height ))==null?'':_.escape(__t))+
'" src="'+
((__t=( public_url ))==null?'':_.escape(__t))+
'" alt="'+
((__t=( name ))==null?'':_.escape(__t))+
'" />\n  ';
 } else { 
__p+='\n    '+
((__t=( name ))==null?'':_.escape(__t))+
'\n  ';
 } 
__p+='\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],84:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var StaticAssetItemView = require('./static-asset-item-view');
var StaticAssetsCollection = require('../../../../../../data/static-assets-collection');
var checkAndBuildOpts = require('../../../../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'icons',
  'selectedAsset'
];

module.exports = CoreView.extend({
  tagName: 'ul',
  className: 'AssetsList',

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this._setupAssets(opts);
  },

  render: function () {
    this.clearSubViews();
    this._renderAssets();
    return this;
  },

  _renderAssets: function () {
    this._assetsCollection.each(function (mdl) {
      var item = new StaticAssetItemView({
        model: mdl
      });

      if (this.model && item.model.getURLFor(mdl.get('icon')) === this.model.get('image')) {
        item.model.set('state', 'selected');
      }

      item.bind('selected', this._selectItem, this);

      this.$el.append(item.render().el);
      this.addView(item);
    }, this);
  },

  _setupAssets: function (opts) {
    if (!_.isEmpty(opts)) {
      this._icons = _.map(this._icons, function (asset) {
        return _.extend(asset, opts);
      });
    }

    var assets = this._icons;

    if (this.options.limit) {
      assets = assets.slice(0, this.options.limit);
    }

    this._assetsCollection = new StaticAssetsCollection(assets);
    this.add_related_model(this._assetsCollection);
  },

  _selectItem: function (m) {
    this._selectedAsset.set({
      url: m.get('public_url'),
      kind: m.get('kind')
    });

    this._assetsCollection.deselectAll(m);
  }
});

},{"../../../../../../data/static-assets-collection":367,"../../../../../../helpers/required-opts":432,"./static-asset-item-view":93,"backbone/core-view":454,"underscore":"underscore"}],85:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var Backbone = require('backbone');

var Utils = require('../../../../../../helpers/utils');
var MakiIcons = require('../assets/maki-icons');
var UserAssetsView = require('./user-assets-tab');
var OrganizationAssetsListView = require('./organization-assets-list-view');
var OrganizationAssetsCollection = require('../../../../../../data/organization-assets-collection');
var UploadAssetsView = require('./upload-assets-tab');

var checkAndBuildOpts = require('../../../../../../helpers/required-opts');
var AssetsCollection = require('../../../../../../data/assets-collection');
var createTextLabelsTabPane = require('../../../../../tab-pane/create-text-labels-tab-pane');
var ScrollView = require('../../../../../scroll/scroll-view');
var AssetsListView = require('./assets-list-view');
var loadingView = require('../../../../../loading/render-loading');

var ErrorView = require('../../../../../error/error-view');
var errorTemplate = require('./upload-assets-error.tpl');
var errorParser = require('../../../../../../helpers/error-parser');

var template = require('./assets-view.tpl');
var tabPaneTemplate = require('./tab-pane-template.tpl');

var KIND = 'custom-marker';

var REQUIRED_OPTS = [
  'modalModel',
  'configModel',
  'userModel'
];

module.exports = CoreView.extend({
  className: 'Dialog-content Dialog-content--expanded',

  events: {
    'click .js-add': '_onSetImage',
    'click .js-upload': '_initUpload',
    'change .js-fileInput': '_onFileSelected',
    'click .js-back': '_onClickBack'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._initModels();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template({
      disclaimer: MakiIcons.disclaimer
    }));

    if (this._hasFetchedAllCollections()) {
      this._initTabPane();
    } else if (this._isLoading()) {
      this._renderLoading();
    } else if (this._hasError()) {
      this._renderError();
    }
    return this;
  },

  _hasFetchedAllCollections: function () {
    return this._stateModel.get('status') === 'show';
  },

  _initModels: function () {
    var self = this;

    this._selectedAsset = new Backbone.Model({
      url: this.model.get('image')
    });

    this._stateModel = new Backbone.Model({
      status: 'loading',
      modalEnabled: false,
      uploads: 0
    });

    this._assetCollections = [];

    this._userAssetCollection = new AssetsCollection(null, {
      configModel: this._configModel,
      userModel: this._userModel
    });

    this._assetCollections.push(this._userAssetCollection);

    if (this._userModel.isInsideOrg()) {
      this._organizationAssetCollection = new OrganizationAssetsCollection(null, {
        configModel: this._configModel,
        orgId: this._userModel.getOrganization().get('id')
      });
      this._assetCollections.push(this._organizationAssetCollection);
    }

    var onFetchAssetCollections = _.invoke(this._assetCollections, 'fetch');
    $.when.apply($, onFetchAssetCollections)
      .then(function () {
        self._stateModel.set('status', 'show');
      }, function (model, response) {
        self._setError(response);
      });
  },

  _initBinds: function () {
    this.listenTo(this._selectedAsset, 'change:url', this._onChangeSelectedAsset);
    this.listenTo(this._stateModel, 'change:status', this.render);
    this.listenTo(this._stateModel, 'change:modalEnabled', this._onChangeSetButton);
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this._stateModel.set('status', 'show');
    this._assetsTabPaneView.setSelectedTabPaneByName('upload-file');
  },

  _upload: function (data) {
    this._userAssetCollection.create(data, {
      beforeSend: this._beforeAssetUpload.bind(this),
      success: this._onAssetUploaded.bind(this),
      error: this._onAssetUploadError.bind(this),
      complete: this._onAssetUploadComplete.bind(this)
    });
  },

  _renderError: function () {
    this._hideDisclaimer();

    this.$('.js-body').html(
      new ErrorView({
        title: Utils.capitalize(this._stateModel.get('error_message')),
        desc: _t('components.modals.assets-picker.error-desc'),
        template: errorTemplate
      }).render().el
    );
  },

  _renderLoading: function () {
    this._hideDisclaimer();

    this.$('.js-body').html(
      loadingView({
        title: _t('components.modals.assets-picker.loading')
      })
    );
  },

  _isLoading: function () {
    return this._stateModel.get('status') === 'loading';
  },

  _hasError: function () {
    return this._stateModel.get('status') === 'error';
  },

  _initTabPane: function () {
    var tabPaneTabs = [{
      name: 'maki-icons',
      label: _t('components.modals.add-asset.icons'),
      createContentView: this._createMakiIconsView.bind(this)
    }, {
      name: 'your-uploads',
      label: _t('components.modals.add-asset.your-uploads'),
      createContentView: this._createYourUploadsView.bind(this)
    }];

    if (this._userModel.isInsideOrg() && this._organizationAssetCollection.length > 0) {
      tabPaneTabs.push({
        name: 'organization-uploads',
        label: _t('components.modals.add-asset.organization-uploads'),
        createContentView: this._createOrganizationUploadsView.bind(this)
      });
    }

    tabPaneTabs.push({
      name: 'upload-file',
      label: _t('components.modals.add-asset.upload-file'),
      createContentView: this._createUploadFileView.bind(this)
    });

    var tabPaneOptions = {
      tabPaneOptions: {
        template: tabPaneTemplate,
        disclaimer: MakiIcons.disclaimer,
        tabPaneItemOptions: {
          tagName: 'li',
          className: 'CDB-NavMenu-item'
        }
      },
      tabPaneItemLabelOptions: {
        tagName: 'button',
        className: 'CDB-NavMenu-link u-upperCase'
      }
    };

    this._assetsTabPaneView = createTextLabelsTabPane(tabPaneTabs, tabPaneOptions);
    this.listenTo(this._assetsTabPaneView.collection, 'change', this._onChangeSelectedTab);

    this.addView(this._assetsTabPaneView);
    this.$('.js-body').append(this._assetsTabPaneView.render().el);

    this._initSetButtonState();
  },

  _onChangeSelectedTab: function () {
    switch (this._assetsTabPaneView.getSelectedTabPaneName()) {
      case 'maki-icons':
        this._setDisclaimer(MakiIcons.disclaimer);
        this._toggleSetButton();
        break;
      case 'upload-file':
        this._hideDisclaimer();
        this._disableSetButton();
        break;
      default:
        this._hideDisclaimer();
        this._toggleSetButton();
        break;
    }
  },

  _toggleSetButton: function () {
    this._stateModel.set('modalEnabled', this._selectedAsset.get('url') !== undefined);
  },

  _initSetButtonState: function () {
    if (!this.model.get('image')) {
      return;
    }

    var selectedAssetExist = false;

    if (this.model.get('kind') === 'marker') {
      selectedAssetExist = true;
    }

    if (!selectedAssetExist) {
      _.each(this._assetCollections, function (assetCollection) {
        if (!selectedAssetExist) {
          selectedAssetExist = assetCollection.some(function (mdl) {
            return this.model.get('image') === mdl.get('public_url');
          }, this);
        }
      }, this);
    }

    if (selectedAssetExist) {
      this._enableSetButton();
    }
  },

  _enableSetButton: function () {
    this._stateModel.set('modalEnabled', true);
  },

  _disableSetButton: function () {
    this._stateModel.set('modalEnabled', false);
  },

  _createYourUploadsView: function () {
    var view = new UserAssetsView({
      model: this.model,
      selectedAsset: this._selectedAsset,
      title: _t('components.modals.add-asset.your-uploads'),
      organizationAssetCollection: this._organizationAssetCollection,
      userAssetCollection: this._userAssetCollection,
      userModel: this._userModel
    }).bind(this);

    this._userAssetsView = view;

    view.bind('init-upload', this._initUpload, this);

    this._hideDisclaimer();

    return this._userAssetsView;
  },

  _createOrganizationUploadsView: function () {
    var view = new ScrollView({
      createContentView: function () {
        return new OrganizationAssetsListView({
          title: _t('components.modals.add-asset.organization-uploads'),
          model: this.model,
          organizationAssetCollection: this._organizationAssetCollection,
          userAssetCollection: this._userAssetCollection,
          selectedAsset: this._selectedAsset
        });
      }.bind(this)
    });

    this._hideDisclaimer();

    return view;
  },

  _createUploadFileView: function () {
    var view = new UploadAssetsView({
      model: this.model,
      userModel: this._userModel,
      configModel: this._configModel
    }).bind(this);

    view.bind('upload-complete', this._onUploadComplete, this);
    view.bind('upload-files', this._uploadFiles, this);
    view.bind('upload-url', this._uploadURL, this);
    return view;
  },

  _createMakiIconsView: function () {
    return new ScrollView({
      createContentView: function () {
        return new AssetsListView({
          model: this.model,
          selectedAsset: this._selectedAsset,
          title: _t('components.modals.add-asset.maki-icons'),
          icons: MakiIcons.icons,
          folder: 'maki-icons',
          kind: 'marker',
          size: '18'
        });
      }.bind(this)
    });
  },

  _onUploadComplete: function () {
    this._assetsTabPaneView.setSelectedTabPaneByName('your-uploads');
  },

  _onChangeSetButton: function () {
    this.$('.js-add').toggleClass('is-disabled', !this._stateModel.get('modalEnabled'));
  },

  _onChangeSelectedAsset: function () {
    if (!this._selectedAsset.get('url')) {
      this.model.unset('image');
      this.model.unset('kind');
    }

    this._stateModel.set('modalEnabled', !!this._selectedAsset.get('url'));
  },

  _initUpload: function (e) {
    this.killEvent(e);
    this.$('.js-fileInput').click();
  },

  _setDisclaimer: function (disclaimer) {
    this.$('.js-disclaimer').html(disclaimer);
  },

  _hideDisclaimer: function () {
    this.$('.js-disclaimer').html('');
  },

  _getSelectedFiles: function () {
    return this.$('.js-fileInput').prop('files');
  },

  _uploadURL: function (url) {
    this._upload({
      type: 'url',
      kind: KIND,
      url: url
    });
  },

  _uploadFiles: function (files) {
    _.each(files, function (file) {
      this._upload({
        kind: KIND,
        type: 'file',
        filename: file
      });
    }, this);
  },

  _onFileSelected: function () {
    this._uploadFiles(this._getSelectedFiles());
  },

  _beforeAssetUpload: function () {
    this._stateModel.set('uploads', this._stateModel.get('uploads') + 1);

    if (this._stateModel.get('uploads') > 0) {
      this._stateModel.set('status', 'loading');
    }
  },

  _onAssetUploaded: function (iconModel) {
    this._resetFileSelection();
  },

  _setError: function (error) {
    this._stateModel.set({
      error_message: errorParser(error),
      status: 'error'
    });
  },

  _onAssetUploadError: function (model, response) {
    this._resetFileSelection();
    this._setError(response);
  },

  _onAssetUploadComplete: function () {
    this._stateModel.set('uploads', this._stateModel.get('uploads') - 1);

    if (this._stateModel.get('uploads') < 1 && !this._hasError()) {
      this._stateModel.set('status', 'show');
      this._onUploadComplete();
    }
  },

  _resetFileSelection: function () {
    this.$('.js-fileInput').val('');
  },

  _onSetImage: function (e) {
    this.killEvent(e);

    if (!this._stateModel.get('modalEnabled')) {
      return;
    }

    this.model.set({
      image: this._selectedAsset.get('url'), // backend serves the url of the asset in `image`
      kind: this._selectedAsset.get('kind')
    });

    this.trigger('change', {
      url: this._selectedAsset.get('url'),
      kind: this._selectedAsset.get('kind')
    }, this);

    this._modalModel.destroy(this.model);
  }
});

},{"../../../../../../data/assets-collection":336,"../../../../../../data/organization-assets-collection":357,"../../../../../../helpers/error-parser":426,"../../../../../../helpers/required-opts":432,"../../../../../../helpers/utils":435,"../../../../../error/error-view":37,"../../../../../loading/render-loading":187,"../../../../../scroll/scroll-view":271,"../../../../../tab-pane/create-text-labels-tab-pane":276,"../assets/maki-icons":102,"./assets-list-view":84,"./assets-view.tpl":86,"./organization-assets-list-view":91,"./tab-pane-template.tpl":95,"./upload-assets-error.tpl":96,"./upload-assets-tab":97,"./user-assets-tab":101,"backbone":"backbone","backbone/core-view":454,"jquery":"jquery","underscore":"underscore"}],86:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Modal">\n  <div class="Modal-header">\n    <div class="Modal-headerContainer">\n      <h2 class="CDB-Text CDB-Size-huge is-light u-bSpace">'+
((__t=( _t('components.modals.add-asset.modal-title') ))==null?'':_.escape(__t))+
'</h2>\n      <h3 class="CDB-Text CDB-Size-medium u-altTextColor"><button class="u-actionTextColor js-upload">'+
((__t=( _t('components.modals.add-asset.upload-asset') ))==null?'':_.escape(__t))+
'</button> '+
((__t=( _t('components.modals.add-asset.modal-desc') ))==null?'':_.escape(__t))+
'</h3>\n    </div>\n  </div>\n\n  <div class="Modal-container js-body"></div>\n\n  <div class="Modal-footer">\n    <div class="Modal-footerContainer u-flex u-justifySpace">\n      <div class="CDB-Text CDB-Size-medium js-disclaimer">\n        ';
 if (disclaimer) { 
__p+='\n        '+
((__t=( disclaimer ))==null?'':__t)+
'\n        ';
 } 
__p+='\n      </div>\n\n      <button class="CDB-Button CDB-Button--primary is-disabled js-add">\n        <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.add-asset.set-image') ))==null?'':_.escape(__t))+
'</span>\n      </button>\n    </div>\n  </div>\n</div>\n\n<form accept-charset="UTF-8" enctype="multipart/form-data" method="post">\n  <input type="file" accept="image/jpeg,image/jpg,image/gif,image/png,image/svg+xml" class="js-fileInput" style="position: absolute; clip: rect(0px 0px 0px 0px); opacity: 0;" multiple="multiple">\n</form>\n';
}
return __p;
};

},{"underscore":"underscore"}],87:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./input-asset-picker-header.tpl');
var ImageLoaderView = require('../../../../../img-loader-view');

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_onClickBack',
    'click .js-colorPicker': '_onClickColorPicker'
  },

  initialize: function (opts) {
    this._imageEnabled = opts.imageEnabled;

    this._initBinds();
  },

  render: function (model, options) {
    this.clearSubViews();
    this.$el.empty();

    var rampItem = this._getRampItem();

    this.$el.append(template({
      index: this.model.get('index') || 0,
      color: rampItem.color || '',
      label: rampItem.title || _t('form-components.editors.fill.input-categories.others'),
      image: rampItem.image || '',
      imageEnabled: this._imageEnabled
    }));

    this._loadImages();

    return this;
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:image', this.render);
  },

  _getRampItem: function () {
    var ramp = this.model.get('ramp');

    if (!ramp) {
      return {
        color: '',
        title: _t('form-components.editors.fill.input-categories.others'),
        image: ''
      };
    }

    return ramp[this.model.get('index')];
  },

  _loadImages: function () {
    var rampItem = this._getRampItem();

    this.iconView = new ImageLoaderView({
      imageClass: 'CDB-Text u-actionTextColor js-assetPicker',
      imageUrl: rampItem.image,
      color: rampItem.color
    });
    this.addView(this.iconView);
    this.$('.js-image-container').append(this.iconView.render().el);
  },

  _onClickBack: function (ev) {
    this.killEvent(ev);
    this.trigger('back', this);
  },

  _onClickColorPicker: function (ev) {
    this.killEvent(ev);
    this.trigger('goToColorPicker', this);
  }
});

},{"../../../../../img-loader-view":180,"./input-asset-picker-header.tpl":88,"backbone/core-view":454}],88:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeader">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemDisplay--flex CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <div class=\'CDB-ListDecoration-secondaryContainer\'>\n        <button class="u-rSpace u-actionTextColor js-back">\n          <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n        </button>\n        <span class="label js-label">'+
((__t=( label ))==null?'':_.escape(__t))+
'</span>\n      </div>\n\n      <div class=\'CDB-ListDecoration-secondaryContainer\'>\n        <nav class=\'CDB-NavMenu\'>\n          <ul class=\'CDB-NavMenu-Inner CDB-NavMenu-inner--no-margin js-menu\'>\n            <li class=\'CDB-NavMenu-item\'>\n              <div class=\'CDB-NavMenu-link CDB-ListDecoration-rampNav-item\'>\n                <button class="ColorBar CDB-ListDecoration-rampItemBar u-rSpace--xl js-colorPicker" style="background-color: '+
((__t=( color ))==null?'':__t)+
';" type="button"></button>\n              </div>\n            </li>\n\n            ';
 if (imageEnabled) { 
__p+='\n              <li class=\'CDB-NavMenu-item is-selected\'>\n                <div class=\'CDB-NavMenu-link CDB-ListDecoration-rampNav-item\'>\n                  ';
 if (image) { 
__p+='\n                    <div class=\'CDB-ListDecoration-rampImg js-image-container\'></div>\n                  ';
 } else { 
__p+='\n                    <span class="CDB-ListDecoration-rampImg CDB-Text js-assetPicker">'+
((__t=( _t('form-components.editors.fill.input-color.img') ))==null?'':__t)+
'</span>\n                  ';
 } 
__p+='\n                </div>\n              </li>\n            ';
 } 
__p+='\n          </ul>\n        </nav>\n      </div>\n    </li>\n  </ul>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],89:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var template = require('./input-asset-picker-view.tpl');
var InputAssetPickerHeader = require('./input-asset-picker-header');
var InputAssetPickerView = require('../input-color-file-view');
var checkAndBuildOpts = require('../../../../../../helpers/required-opts');
var REQUIRED_OPTS = [
  'configModel',
  'modals',
  'ramp',
  'userModel'
];

module.exports = CoreView.extend({
  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this._imageEnabled = opts.imageEnabled;

    this.model = new Backbone.Model({
      index: this.options.index,
      ramp: opts.ramp
    });
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());
    this._initViews();
    return this;
  },

  _initViews: function () {
    this._headerView = new InputAssetPickerHeader({
      model: this.model,
      imageEnabled: this._imageEnabled
    });
    this._headerView.bind('goToColorPicker', this._onGoToColorPicker, this);
    this._headerView.bind('back', this._onClickBack, this);
    this.$('.js-header').append(this._headerView.render().el);
    this.addView(this._headerView);

    this._assetPicker = new InputAssetPickerView({
      model: this.model,
      userModel: this._userModel,
      configModel: this._configModel,
      modals: this._modals,
      imageEnabled: this._imageEnabled
    });
    this._assetPicker.bind('change', _.debounce(this._onChangeImage, 50), this);
    this.$('.js-content').append(this._assetPicker.render().el);
    this.addView(this._assetPicker);
  },

  _getRampItem: function () {
    var ramp = this.model.get('ramp');

    if (!ramp) {
      return {
        color: '',
        title: _t('form-components.editors.fill.input-categories.others'),
        image: ''
      };
    }

    return ramp[this.model.get('index')];
  },

  _onChangeImage: function (data) {
    var url = data && data.url || '';
    var kind = data && data.kind || '';

    this._getRampItem().image = url;
    this.model.trigger('change:image');

    this.trigger('change:image', {
      url: url,
      kind: kind,
      index: this.model.get('index')
    }, this);
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.trigger('back', this);
  },

  _onGoToColorPicker: function (e) {
    this.killEvent(e);
    this.trigger('goToColorPicker', this);
  }
});

},{"../../../../../../helpers/required-opts":432,"../input-color-file-view":113,"./input-asset-picker-header":87,"./input-asset-picker-view.tpl":90,"backbone":"backbone","backbone/core-view":454,"underscore":"underscore"}],90:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-header"></div>\n<div class="js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],91:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var checkAndBuildOpts = require('../../../../../../helpers/required-opts');
var AssetItemView = require('./asset-item-view');
var template = require('./organization-assets-list-view.tpl');

var REQUIRED_OPTS = [
  'userAssetCollection',
  'organizationAssetCollection',
  'selectedAsset'
];

var KIND = 'custom-marker';
var ASSET_HEIGHT = 48;

module.exports = CoreView.extend({
  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template);

    this._organizationAssetCollection.deselectAll();
    this._organizationAssetCollection.each(this._renderAsset, this);

    return this;
  },

  _initBinds: function () {
    this.listenTo(this._organizationAssetCollection, 'reset', this.render);
    this.listenTo(this._organizationAssetCollection, 'change', this._onChangeAssets);
  },

  _getSelectedAsset: function () {
    var selectedAssets = this._organizationAssetCollection.where({ state: 'selected' });
    return selectedAssets && selectedAssets[0];
  },

  _renderAsset: function (assetModel) {
    var assetItemView = new AssetItemView({
      model: assetModel,
      assetHeight: ASSET_HEIGHT,
      selectedAsset: this._selectedAsset
    });

    if (assetModel.get('public_url') === this.model.get('image')) {
      assetModel.set('state', 'selected');
    }

    assetItemView.bind('selected', this._selectAsset, this);

    this.$('.js-assets').append(assetItemView.render().el);
    this.addView(assetItemView);
  },

  _onChangeAssets: function () {
    var selectedAsset = this._getSelectedAsset();

    this._selectedAsset.set({
      url: selectedAsset && selectedAsset.get('public_url'),
      kind: KIND
    });
  },

  _selectAsset: function (m) {
    m.set('state', 'selected');

    this._organizationAssetCollection.deselectAll(m);
    this._userAssetCollection.deselectAll();
  }

});

},{"../../../../../../helpers/required-opts":432,"./asset-item-view":82,"./organization-assets-list-view.tpl":92,"backbone/core-view":454}],92:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="AssetsList js-assets"></ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],93:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./static-asset-item-view.tpl');

module.exports = CoreView.extend({
  tagName: 'li',
  className: 'AssetsList-item AssetsList-item--medium',

  events: {
    'click .js-asset': '_onClick'
  },

  initialize: function () {
    this.listenTo(this.model, 'change:state', this._changeState);
  },

  render: function () {
    this.clearSubViews();

    this.$el.append(template({
      type: 'icon',
      name: this.model.get('name'),
      public_url: this.model.get('public_url')
    }));
    return this;
  },

  _onClick: function (e) {
    this.killEvent(e);
    this.trigger('selected', this.model);
    this.model.set('state', 'selected');
  },

  _changeState: function () {
    this.$el.toggleClass('is-selected', this.model.get('state') === 'selected');
  }
});

},{"./static-asset-item-view.tpl":94,"backbone/core-view":454}],94:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (type === 'icon') { 
__p+='\n<div class="AssetItem-icon js-asset"><img height="24" src="'+
((__t=( public_url ))==null?'':_.escape(__t))+
'" alt="'+
((__t=( name ))==null?'':_.escape(__t))+
'" crossOrigin="anonymous" /></div>\n';
 } else { 
__p+='\n<div class="AssetItem-label CDB-Text CDB-Size-small u-altTextColor u-upperCase js-asset" title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">\n  '+
((__t=( name ))==null?'':_.escape(__t))+
'\n</div>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],95:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Modal-navigation">\n  <ul class="Modal-navigationInner CDB-Text is-semibold CDB-Size-medium js-menu"></ul>\n</div>\n<div class="Tab-paneContent Publish-modalContent Modal-inner Modal-inner--with-navigation js-content">\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],96:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="LayoutIcon LayoutIcon--negative">\n  <i class="CDB-IconFont CDB-IconFont-cockroach"></i>\n</div>\n<h3 class="CDB-Text CDB-Size-large u-mainTextColor u-errorTextColor u-bSpace--m u-tSpace-xl">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h3>\n<p class="CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( desc ))==null?'':__t)+
'</p>\n\n<button class="CDB-Button CDB-Button--primary u-tSpace-xl js-back">\n  <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.assets-picker.go-back') ))==null?'':_.escape(__t))+
'</span>\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],97:[function(require,module,exports){
var $ = require('jquery');
var Backbone = require('backbone');
var Utils = require('../../../../../../helpers/utils');

require('dragster');
var Dropzone = require('dropzone');
var CoreView = require('backbone/core-view');
var checkAndBuildOpts = require('../../../../../../helpers/required-opts');
var AssetsCollection = require('../../../../../../data/assets-collection');
var template = require('./upload-assets-tab.tpl');

var REQUIRED_OPTS = [
  'configModel',
  'userModel'
];

module.exports = CoreView.extend({
  className: 'Form-modal',

  events: {
    'keyup .js-url': '_onURLChanged',
    'click .js-submit': '_onClickSubmit'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._stateModel = new Backbone.Model({
      status: 'show',
      uploads: 0
    });

    this.listenTo(this._stateModel, 'change:status', this.render);

    this._assetCollection = new AssetsCollection(
      null, {
        configModel: this._configModel,
        userModel: this._userModel
      }
    );
  },

  render: function () {
    this.clearSubViews();

    this.$el.html(template());
    this._initDropzone();

    return this;
  },

  _initDropzone: function () {
    var el = $('html')[0];
    var self = this;

    this.dragster = new Dragster(el); // eslint-disable-line

    $(el).bind('dragster:enter', function (e) {
      self._showDropzone();
    });

    $(el).bind('dragster:leave', function (e) {
      self._hideDropzone();
    });

    if (el.dropzone) { // avoid loading the dropzone twice
      return;
    }

    this.dropzone = new Dropzone(el, {
      url: ':)',
      autoProcessQueue: false,
      previewsContainer: false
    });

    this.dropzone.on('dragover', function () {
      self._showDropzone();
    });

    this.dropzone.on('drop', function (e) {
      self.trigger('upload-files', e.dataTransfer.files);
      self._hideDropzone();
    });
  },

  _showDropzone: function () {
    this.$('.Form-upload').addClass('is-dropping');
  },

  _hideDropzone: function () {
    this.$('.Form-upload').removeClass('is-dropping');
  },

  _destroyDropzone: function () {
    var el = $('html')[0];

    if (this.dragster) {
      this.dragster.removeListeners();
      this.dragster.reset();
      $(el).unbind('dragster:enter dragster:leave');
    }

    if (this.dropzone) {
      this.dropzone.destroy();
    }
  },

  _hasError: function () {
    return this._stateModel.get('status') === 'error';
  },

  _onClickSubmit: function (e) {
    this.killEvent(e);

    var url = this._getURL();

    if (!url) {
      this._hideURLError();
      return;
    } else if (!Utils.isURL(url)) {
      this._showURLError();
      return;
    } else {
      this._hideURLError();
    }

    this.trigger('upload-url', url);
  },

  _getURL: function () {
    return this.$('.js-url').val();
  },

  _onURLChanged: function () {
    var url = this._getURL();

    if (!url) {
      this._hideURLError();
    } else if (!Utils.isURL(url)) {
      this._showURLError();
    } else {
      this._hideURLError();
    }
  },

  _showURLError: function () {
    this.$('.js-url-error').addClass('is-visible');
  },

  _hideURLError: function () {
    this.$('.js-url-error').removeClass('is-visible');
  },

  clean: function () {
    this._destroyDropzone();
    CoreView.prototype.clean.apply(this);
  }
});

},{"../../../../../../data/assets-collection":336,"../../../../../../helpers/required-opts":432,"../../../../../../helpers/utils":435,"./upload-assets-tab.tpl":98,"backbone":"backbone","backbone/core-view":454,"dragster":456,"dropzone":457,"jquery":"jquery"}],98:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ImportPanel-header">\n  <h3 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m">\n    '+
((__t=( _t('components.modals.assets-picker.upload-file-url') ))==null?'':_.escape(__t))+
'\n  </h3>\n  <p class="CDB-Text CDB-Size-medium u-altTextColor">\n    '+
((__t=( _t('components.modals.assets-picker.upload-desc') ))==null?'':_.escape(__t))+
'\n  </p>\n</div>\n<div class="Form-row Form-row--centered">\n  <div class="Form-rowData Form-rowData--med Form-rowData--noMargin js-dropzone">\n    <div class="Form-upload">\n      <label class="Form-fileLabel js-fileLabel CDB-Text CDB-Size-medium">'+
((__t=( _t('components.modals.assets-picker.drag-and-drop') ))==null?'':_.escape(__t))+
'</label>\n      <label class="Form-fileLabel Form-fileLabel--error CDB-Text CDB-Size-small js-fileError"></label>\n      <div class="Form-file">\n        <span class="CDB-Button CDB-Button--primary Form-fileButton CDB-Button-Text CDB-Text is-semibold CDB-Size-small u-upperCase js-upload">\n          '+
((__t=( _t('components.modals.assets-picker.browse') ))==null?'':_.escape(__t))+
'\n        </span>\n      </div>\n    </div>\n  </div>\n  <span class="u-lSpace--xl u-rSpace--xl u-flex u-alignCenter CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( _t('components.modals.assets-picker.or') ))==null?'':_.escape(__t))+
'</span>\n  <div class="Form-rowData Form-rowData--noMargin Form-rowData--med">\n    <input type="text" class="Form-input Form-input--med has-submit js-url CDB-Text CDB-Size-medium" value="" placeholder="https://carto.com/markers/pin.png" />\n    <button type="submit" class="CDB-Text CDB-Size-small Form-inputSubmit u-upperCase u-actionTextColor Form-inputSubmit js-submit">\n      <span>'+
((__t=( _t('components.modals.assets-picker.submit') ))==null?'':_.escape(__t))+
'</span>\n    </button>\n    <div class="Form-inputError CDB-Text js-url-error">'+
((__t=( _t('components.modals.assets-picker.incorrect-url') ))==null?'':_.escape(__t))+
'</div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],99:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var AssetItemView = require('./asset-item-view');
var checkAndBuildOpts = require('../../../../../../helpers/required-opts');
var Backbone = require('backbone');
var loadingView = require('../../../../../loading/render-loading');
var AssetHeaderView = require('./asset-header-view');

var ErrorView = require('../../../../../error/error-view');
var errorTemplate = require('./upload-assets-error.tpl');
var template = require('./user-assets-list-view.tpl');

var REQUIRED_OPTS = [
  'userModel',
  'userAssetCollection',
  'selectedAsset'
];

var KIND = 'custom-marker';
var ASSET_HEIGHT = 48;

module.exports = CoreView.extend({
  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    if (this._userModel.isInsideOrg()) {
      if (!opts.organizationAssetCollection) throw new Error('organizationAssetCollection is required');

      this._organizationAssetCollection = opts.organizationAssetCollection;
    }

    this._stateModel = new Backbone.Model();

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template);

    if (this._isLoading()) {
      this._renderLoading();
    } else if (this._hasError()) {
      this._renderError();
    } else {
      this._renderRegularView();
    }

    return this;
  },

  _addHeaderView: function () {
    this._assetHeaderView = new AssetHeaderView({
      editable: true,
      title: this.options.title,
      assetsCollection: this._userAssetCollection
    });

    this.addView(this._assetHeaderView);
    this.$('.js-nav').append(this._assetHeaderView.render().el);

    this._assetHeaderView.bind('select-all', this._selectAllAssets, this);
    this._assetHeaderView.bind('deselect-all', this._deselectAllAssets, this);
    this._assetHeaderView.bind('remove', this._removeSelectedAssets, this);
  },

  _renderRegularView: function () {
    this._addHeaderView();
    this._renderAddButton();

    this._userAssetCollection.deselectAll();
    this._userAssetCollection.each(this._renderAsset, this);
  },

  _renderAddButton: function () {
    var addAssetButton = new AssetItemView({
      model: new Backbone.Model({
        type: 'text',
        name: '+'
      }),
      assetHeight: ASSET_HEIGHT
    });

    addAssetButton.bind('selected', function () {
      this.trigger('init-upload');
    }, this);

    this.addView(addAssetButton);
    this.$('.js-assets').append(addAssetButton.render().$el);
  },

  _initBinds: function () {
    this._keyDown = this._onKeyDown.bind(this);
    $(document).on('keydown', this._keyDown);

    this._keyUp = this._onKeyUp.bind(this);
    $(document).on('keyup', this._keyUp);

    this.listenTo(this._stateModel, 'change:status', this.render);
    this.listenTo(this._userAssetCollection, 'change', this._onChangeAssets);
  },

  _getSelectedAsset: function () {
    return this._userAssetCollection.findWhere({ state: 'selected' });
  },

  _getSelectedAssetsCount: function () {
    var selectedAssets = this._userAssetCollection.where({ state: 'selected' });
    return selectedAssets ? selectedAssets.length : 0;
  },

  _onKeyDown: function (ev) {
    this._shiftKeyPressed = ev.shiftKey;
  },

  _onKeyUp: function (ev) {
    this._shiftKeyPressed = ev.shiftKey;
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this._stateModel.unset('status');
  },

  _renderAsset: function (assetModel) {
    var assetItemView = new AssetItemView({
      model: assetModel,
      assetHeight: ASSET_HEIGHT,
      selectedAsset: this._selectedAsset
    });

    if (assetModel.get('public_url') === this.model.get('image')) {
      assetModel.set('state', 'selected');
    }

    assetItemView.bind('selected', this._selectAsset, this);

    this.$('.js-assets').append(assetItemView.render().el);
    this.addView(assetItemView);
  },

  _onChangeAssets: function () {
    if (this._getSelectedAssetsCount() === 1) {
      var selectedAsset = this._getSelectedAsset();
      this._selectedAsset.set({
        url: selectedAsset && selectedAsset.get('public_url'),
        kind: KIND
      });
    } else {
      this._selectedAsset.set({
        url: '',
        kind: ''
      });
    }
  },

  _selectAllAssets: function () {
    this._userAssetCollection.selectAll();
  },

  _deselectAllAssets: function () {
    this._userAssetCollection.deselectAll();
  },

  _selectAsset: function (m) {
    if (this._shiftKeyPressed) {
      m.set('state', m.get('state') === 'selected' ? '' : 'selected');
    } else {
      m.set('state', 'selected');
    }

    if (!this._shiftKeyPressed) {
      this._userAssetCollection.deselectAll(m);

      if (this._userModel.isInsideOrg()) {
        this._organizationAssetCollection.deselectAll();
      }
    }
  },

  _removeSelectedAssetsFromView: function () {
    var selectedAssets = this._userAssetCollection.select(function (asset) {
      return asset.get('state') === 'selected';
    }, this);

    _.each(selectedAssets, function (asset) {
      this.$('#' + asset.get('id')).remove();
    }, this);
  },

  _removeSelectedAssets: function () {
    this._stateModel.set('status', 'loading');

    var selectedAssets = this._userAssetCollection.select(function (asset) {
      return asset.get('state') === 'selected';
    }, this);

    _.each(selectedAssets, function (asset) {
      asset.destroy({
        complete: this._onDestroyFinished.bind(this)
      });
    }, this);
  },

  _onDestroyFinished: function (response) {
    if (response.status === 200) {
      this._removeSelectedAssetsFromView();
      this._stateModel.unset('status');
      this._selectedAsset.unset('kind');
      this._selectedAsset.unset('url');
    } else {
      this._stateModel.set({
        error_message: response.statusText,
        status: 'error'
      });
    }
  },

  _isLoading: function () {
    return this._stateModel.get('status') === 'loading';
  },

  _hasError: function () {
    return this._stateModel.get('status') === 'error';
  },

  _renderLoading: function () {
    this.$el.html(
      loadingView({
        title: _t('components.modals.assets-picker.loading')
      })
    );
  },

  _renderError: function () {
    this.$el.html(
      new ErrorView({
        title: this._stateModel.get('error_message'),
        desc: _t('components.modals.assets-picker.error-desc'),
        template: errorTemplate
      }).render().el
    );
  },

  _disableBinds: function () {
    $(document).off('keydown', this._keyDown);
    $(document).off('keyup', this._keyUp);
  },

  clean: function () {
    this._disableBinds();
    CoreView.prototype.clean.apply(this);
  }
});

},{"../../../../../../helpers/required-opts":432,"../../../../../error/error-view":37,"../../../../../loading/render-loading":187,"./asset-header-view":80,"./asset-item-view":82,"./upload-assets-error.tpl":96,"./user-assets-list-view.tpl":100,"backbone":"backbone","backbone/core-view":454,"jquery":"jquery","underscore":"underscore"}],100:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<nav class="CDB-NavMenu u-bSpace--m u-inner js-nav"></nav>\n<ul class="AssetsList js-assets"></ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],101:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var checkAndBuildOpts = require('../../../../../../helpers/required-opts');
var ScrollView = require('../../../../../scroll/scroll-view');
var UserAssetsListView = require('./user-assets-list-view');

var REQUIRED_OPTS = [
  'userModel',
  'userAssetCollection',
  'title',
  'selectedAsset'
];

module.exports = CoreView.extend({
  events: {
    'change .js-uploadInput': '_onFileSelected'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    if (this._userModel.isInsideOrg()) {
      if (!opts.organizationAssetCollection) throw new Error('organizationAssetCollection is required');

      this._organizationAssetCollection = opts.organizationAssetCollection;
    }
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._renderAssets();
    return this;
  },

  _renderAssets: function () {
    var view = new ScrollView({
      createContentView: function () {
        var view = new UserAssetsListView({
          title: this._title,
          model: this.model,
          organizationAssetCollection: this._organizationAssetCollection,
          userAssetCollection: this._userAssetCollection,
          selectedAsset: this._selectedAsset,
          userModel: this._userModel
        });

        view.bind('init-upload', function () {
          this.trigger('init-upload');
        }, this);

        return view;
      }.bind(this)
    });

    this.addView(view);
    this.$el.append(view.render().el);
  }
});

},{"../../../../../../helpers/required-opts":432,"../../../../../scroll/scroll-view":271,"./user-assets-list-view":99,"backbone/core-view":454}],102:[function(require,module,exports){
// Maki icons from https://github.com/mapbox/maki
// and https://github.com/mapbox/maki/blob/mb-pages/_includes/maki.json
module.exports = {
  disclaimer: _t('assets.maki-icons.disclaimer'),
  icons: [
    {
      'name': 'Square stroked',
      'icon': 'square-stroked'
    },
    {
      'name': 'Square solid',
      'icon': 'square'
    },
    {
      'name': 'Triangle stroked',
      'icon': 'triangle-stroked'
    },
    {
      'name': 'Triangle solid',
      'icon': 'triangle'
    },
    {
      'name': 'Star stroked',
      'icon': 'star-stroked'
    },
    {
      'name': 'Star solid',
      'icon': 'star'
    },
    {
      'name': 'Cross',
      'icon': 'cross'
    },
    {
      'name': 'Marker Stroke',
      'icon': 'marker-stroked'
    },
    {
      'name': 'Marker Solid',
      'icon': 'marker'
    },
    {
      'name': 'Religious Jewish',
      'icon': 'religious-jewish'
    },
    {
      'name': 'Religious Christian',
      'icon': 'religious-christian'
    },
    {
      'name': 'Religious Muslim',
      'icon': 'religious-muslim'
    },
    {
      'name': 'Cemetery',
      'icon': 'cemetery'
    },
    {
      'name': 'Rocket',
      'icon': 'rocket'
    },
    {
      'name': 'Airport',
      'icon': 'airport'
    },
    {
      'name': 'Heliport',
      'icon': 'heliport'
    },
    {
      'name': 'Rail',
      'icon': 'rail'
    },
    {
      'name': 'Rail Metro',
      'icon': 'rail-metro'
    },
    {
      'name': 'Rail Light',
      'icon': 'rail-light'
    },
    {
      'name': 'Bus',
      'icon': 'bus'
    },
    {
      'name': 'Fuel',
      'icon': 'fuel'
    },
    {
      'name': 'Parking',
      'tags': [
        'parking',
        'transportation'
      ],
      'icon': 'parking'
    },
    {
      'name': 'Parking Garage',
      'tags': [
        'parking',
        'transportation',
        'garage'
      ],
      'icon': 'parking-garage'
    },
    {
      'name': 'Airfield',
      'tags': [
        'airfield',
        'airport',
        'plane',
        'landing strip'
      ],
      'icon': 'airfield'
    },
    {
      'name': 'Roadblock',
      'tags': [
        'roadblock',
        'stop',
        'warning',
        'dead end'
      ],
      'icon': 'roadblock'
    },
    {
      'name': 'Ferry',
      'tags': [
        'ship',
        'boat',
        'water',
        'ferry',
        'transportation'
      ],
      'icon': 'ferry'
    },
    {
      'name': 'Harbor',
      'tags': [
        'marine',
        'dock',
        'water',
        'wharf'
      ],
      'icon': 'harbor'
    },
    {
      'name': 'Bicycle',
      'tags': [
        'cycling',
        'cycle',
        'transportation'
      ],
      'icon': 'bicycle'
    },
    {
      'name': 'Park',
      'tags': [
        'recreation',
        'park',
        'forest',
        'tree',
        'green',
        'woods',
        'nature'
      ],
      'icon': 'park'
    },
    {
      'name': 'Park 2',
      'tags': [
        'recreation',
        'park',
        'forest',
        'tree',
        'green',
        'woods',
        'nature'
      ],
      'icon': 'park2'
    },
    {
      'name': 'Museum',
      'tags': [
        'recreation',
        'museum',
        'tourism'
      ],
      'icon': 'museum'
    },
    {
      'name': 'Lodging',
      'tags': [
        'lodging',
        'hotel',
        'recreation',
        'motel',
        'tourism'
      ],
      'icon': 'lodging'
    },
    {
      'name': 'Monument',
      'tags': [
        'recreation',
        'statue',
        'monument',
        'tourism'
      ],
      'icon': 'monument'
    },
    {
      'name': 'Zoo',
      'tags': [
        'recreation',
        'zoo',
        'animal',
        'giraffe'
      ],
      'icon': 'zoo'
    },
    {
      'name': 'Garden',
      'tags': [
        'recreation',
        'garden',
        'park',
        'flower',
        'nature'
      ],
      'icon': 'garden'
    },
    {
      'name': 'Campsite',
      'tags': [
        'recreation',
        'campsite',
        'camp',
        'camping',
        'tent',
        'nature'
      ],
      'icon': 'campsite'
    },
    {
      'name': 'Theatre',
      'tags': [
        'recreation',
        'theatre',
        'theater',
        'entertainment',
        'play',
        'performance'
      ],
      'icon': 'theatre'
    },
    {
      'name': 'Art gallery',
      'tags': [
        'art',
        'center',
        'museum',
        'gallery',
        'creative',
        'recreation',
        'entertainment',
        'studio'
      ],
      'icon': 'art-gallery'
    },
    {
      'name': 'Pitch',
      'tags': [
        'pitch',
        'track',
        'athletic',
        'sports',
        'field'
      ],
      'icon': 'pitch'
    },
    {
      'name': 'Soccer',
      'tags': [
        'soccer',
        'sports'
      ],
      'icon': 'soccer'
    },
    {
      'name': 'American Football',
      'tags': [
        'football',
        'sports'
      ],
      'icon': 'america-football'
    },
    {
      'name': 'Tennis',
      'tags': [
        'tennis',
        'court',
        'ball',
        'sports'
      ],
      'icon': 'tennis'
    },
    {
      'name': 'Basketball',
      'tags': [
        'basketball',
        'ball',
        'sports'
      ],
      'icon': 'basketball'
    },
    {
      'name': 'Baseball',
      'tags': [
        'baseball',
        'softball',
        'ball',
        'sports'
      ],
      'icon': 'baseball'
    },
    {
      'name': 'Golf',
      'tags': [
        'golf',
        'sports',
        'course'
      ],
      'icon': 'golf'
    },
    {
      'name': 'Swimming',
      'tags': [
        'swimming',
        'water',
        'swim',
        'sports'
      ],
      'icon': 'swimming'
    },
    {
      'name': 'Cricket',
      'tags': [
        'cricket',
        'sports'
      ],
      'icon': 'cricket'
    },
    {
      'name': 'Skiing',
      'tags': [
        'winter',
        'skiing',
        'ski',
        'sports'
      ],
      'icon': 'skiing'
    },
    {
      'name': 'School',
      'tags': [
        'school',
        'highschool',
        'elementary',
        'children',
        'amenity',
        'middle'
      ],
      'icon': 'school'
    },
    {
      'name': 'College',
      'tags': [
        'college',
        'school',
        'amenity',
        'university'
      ],
      'icon': 'college'
    },
    {
      'name': 'Library',
      'tags': [
        'library',
        'books',
        'amenity'
      ],
      'icon': 'library'
    },
    {
      'name': 'Post',
      'tags': [
        'post',
        'office',
        'amenity',
        'mail',
        'letter'
      ],
      'icon': 'post'
    },
    {
      'name': 'Fire station',
      'tags': [
        'fire',
        'station',
        'amenity'
      ],
      'icon': 'fire-station'
    },
    {
      'name': 'Town hall',
      'tags': [
        'townhall',
        'mayor',
        'building',
        'amenity',
        'government'
      ],
      'icon': 'town-hall'
    },
    {
      'name': 'Police',
      'tags': [
        'police',
        'jail',
        'arrest',
        'amenity',
        'station'
      ],
      'icon': 'police'
    },
    {
      'name': 'Prison',
      'tags': [
        'prison',
        'jail',
        'amenity'
      ],
      'icon': 'prison'
    },
    {
      'name': 'Embassy',
      'tags': [
        'embassy',
        'diplomacy',
        'consulate',
        'amenity',
        'flag'
      ],
      'icon': 'embassy'
    },
    {
      'name': 'Beer',
      'tags': [
        'bar',
        'beer',
        'drink',
        'commercial',
        'biergarten',
        'pub'
      ],
      'icon': 'beer'
    },
    {
      'name': 'Restaurant',
      'tags': [
        'restaurant',
        'commercial'
      ],
      'icon': 'restaurant'
    },
    {
      'name': 'Cafe',
      'tags': [
        'cafe',
        'coffee',
        'commercial',
        'tea'
      ],
      'icon': 'cafe'
    },
    {
      'name': 'Shop',
      'tags': [
        'shop',
        'mall',
        'commercial',
        'store'
      ],
      'icon': 'shop'
    },
    {
      'name': 'Fast Food',
      'tags': [
        'food',
        'fast',
        'commercial',
        'burger',
        'drive-through'
      ],
      'icon': 'fast-food'
    },
    {
      'name': 'Bar',
      'tags': [
        'bar',
        'drink',
        'commercial',
        'club',
        'martini',
        'lounge'
      ],
      'icon': 'bar'
    },
    {
      'name': 'Bank',
      'tags': [
        'bank',
        'atm',
        'commercial',
        'money'
      ],
      'icon': 'bank'
    },
    {
      'name': 'Grocery',
      'tags': [
        'food',
        'grocery',
        'commercial',
        'store',
        'market'
      ],
      'icon': 'grocery'
    },
    {
      'name': 'Cinema',
      'tags': [
        'cinema',
        'theatre',
        'film',
        'movie',
        'commercial',
        'theater',
        'entertainment'
      ],
      'icon': 'cinema'
    },
    {
      'name': 'Pharmacy',
      'tags': [
        'pharmacy',
        'drugs',
        'medication',
        'social',
        'medicine',
        'prescription'
      ],
      'icon': 'pharmacy'
    },
    {
      'name': 'Hospital',
      'tags': [
        'hospital',
        'health',
        'medication',
        'social',
        'medicine',
        'medical',
        'clinic'
      ],
      'icon': 'hospital'
    },
    {
      'name': 'Danger',
      'tags': [
        'minefield',
        'landmine',
        'disaster',
        'dangerous',
        'hazard'
      ],
      'icon': 'danger'
    },
    {
      'name': 'Industrial',
      'tags': [
        'industrial',
        'factory',
        'property',
        'building'
      ],
      'icon': 'industrial'
    },
    {
      'name': 'Warehouse',
      'tags': [
        'warehouse',
        'property',
        'storage',
        'building'
      ],
      'icon': 'warehouse'
    },
    {
      'name': 'Commercial',
      'tags': [
        'commercial',
        'property',
        'business',
        'building'
      ],
      'icon': 'commercial'
    },
    {
      'name': 'Building',
      'tags': [
        'building',
        'property',
        'structure',
        'business',
        'building'
      ],
      'icon': 'building'
    },
    {
      'name': 'Place of worship',
      'tags': [
        'religion',
        'ceremony',
        'religious',
        'nondenominational',
        'church',
        'temple'
      ],
      'icon': 'place-of-worship'
    },
    {
      'name': 'Alcohol shop',
      'tags': [
        'alcohol',
        'liquor',
        'store',
        'shop',
        'beer',
        'wine',
        'vodka'
      ],
      'icon': 'alcohol-shop'
    },
    {
      'name': 'Logging',
      'tags': [
        'logger',
        'chainsaw',
        'woods',
        'industry'
      ],
      'icon': 'logging'
    },
    {
      'name': 'Oil well',
      'tags': [
        'oil',
        'natural',
        'environment',
        'industry',
        'resources'
      ],
      'icon': 'oil-well'
    },
    {
      'name': 'Slaughterhouse',
      'tags': [
        'cows',
        'cattle',
        'food',
        'meat',
        'industry',
        'resources'
      ],
      'icon': 'slaughterhouse'
    },
    {
      'name': 'Dam',
      'tags': [
        'water',
        'natural',
        'hydro',
        'hydroelectric',
        'energy',
        'environment',
        'industry',
        'resources'
      ],
      'icon': 'dam'
    },
    {
      'name': 'Water',
      'tags': [
        'water',
        'natural',
        'hydro',
        'lake',
        'river',
        'ocean',
        'resources'
      ],
      'icon': 'water'
    },
    {
      'name': 'Wetland',
      'tags': [
        'water',
        'swamp',
        'natural'
      ],
      'icon': 'wetland'
    },
    {
      'name': 'Disability',
      'tags': [
        'handicap',
        'wheelchair',
        'access'
      ],
      'icon': 'disability'
    },
    {
      'name': 'Telephone',
      'tags': [
        'payphone',
        'call'
      ],
      'icon': 'telephone'
    },
    {
      'name': 'Emergency Telephone',
      'tags': [
        'payphone',
        'danger',
        'safety',
        'call'
      ],
      'icon': 'emergency-telephone'
    },
    {
      'name': 'Toilets',
      'tags': [
        'bathroom',
        'men',
        'women',
        'sink',
        'washroom',
        'lavatory'
      ],
      'icon': 'toilets'
    },
    {
      'name': 'Waste Basket',
      'tags': [
        'trash',
        'rubbish',
        'bin',
        'garbage'
      ],
      'icon': 'waste-basket'
    },
    {
      'name': 'Music',
      'tags': [
        'stage',
        'performance',
        'band',
        'concert',
        'venue'
      ],
      'icon': 'music'
    },
    {
      'name': 'Land Use',
      'tags': [
        'zoning',
        'usage',
        'area'
      ],
      'icon': 'land-use'
    },
    {
      'name': 'City',
      'tags': [
        'area',
        'point',
        'place',
        'urban'
      ],
      'icon': 'city'
    },
    {
      'name': 'Town',
      'tags': [
        'area',
        'point',
        'place',
        'small'
      ],
      'icon': 'town'
    },
    {
      'name': 'Village',
      'tags': [
        'area',
        'point',
        'place',
        'small',
        'rural'
      ],
      'icon': 'village'
    },
    {
      'name': 'Farm',
      'tags': [
        'building',
        'farming',
        'crops',
        'plants',
        'agriculture',
        'rural'
      ],
      'icon': 'farm'
    },
    {
      'name': 'Bakery',
      'tags': [
        'bakery',
        'pastry',
        'croissant',
        'food',
        'shop',
        'bread'
      ],
      'icon': 'bakery'
    },
    {
      'name': 'Dog Park',
      'tags': [
        'dog',
        'pet'
      ],
      'icon': 'dog-park'
    },
    {
      'name': 'Lighthouse',
      'tags': [
        'building',
        'navigation',
        'nautical',
        'ocean',
        'logistics'
      ],
      'icon': 'lighthouse'
    },
    {
      'name': 'Clothing Store',
      'tags': [
        'clothing',
        'store',
        'shop'
      ],
      'icon': 'clothing-store'
    },
    {
      'name': 'Polling Place',
      'icon': 'polling-place'
    },
    {
      'name': 'Playground',
      'icon': 'playground'
    },
    {
      'name': 'Entrance',
      'icon': 'entrance'
    },
    {
      'name': 'Heart',
      'icon': 'heart'
    },
    {
      'name': 'London Underground',
      'icon': 'london-underground'
    },
    {
      'name': 'Minefield',
      'icon': 'minefield'
    },
    {
      'name': 'Rail Underground',
      'icon': 'rail-underground'
    },
    {
      'name': 'Rail Above',
      'icon': 'rail-above'
    },
    {
      'name': 'Camera',
      'icon': 'camera'
    },
    {
      'name': 'Laundry',
      'icon': 'laundry'
    },
    {
      'name': 'Car',
      'icon': 'car'
    },
    {
      'name': 'Suitcase',
      'icon': 'suitcase'
    },
    {
      'name': 'Hairdresser',
      'icon': 'hairdresser'
    },
    {
      'name': 'Chemist',
      'icon': 'chemist'
    },
    {
      'name': 'Mobile phone',
      'icon': 'mobilephone'
    },
    {
      'name': 'Scooter',
      'icon': 'scooter'
    }
  ]
};

},{}],103:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');
var ImageLoaderView = require('../../../../../../img-loader-view');
var CustomListItemView = require('../../../../../../custom-list/custom-list-item-view');

module.exports = CustomListItemView.extend({

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    var name = this.model.getName() == null ? 'null' : this.model.getName();

    this.$el.append(
      this.options.template(
        _.extend({
          typeLabel: this.options.typeLabel,
          isSelected: this.model.get('selected'),
          isDisabled: this.model.get('disabled'),
          isDestructive: this.model.get('destructive'),
          name: name,
          val: this.model.getValue(),
          options: this.model.get('renderOptions'),
          image: this.model.get('image'),
          imageEnabled: this.options.imageEnabled
        })
      )
    );

    this._loadImages();

    this.$el
      .attr('data-val', this.model.getValue())
      .toggleClass('is-disabled', !!this.model.get('disabled'));

    return this;
  },

  _loadImages: function () {
    this.iconView = new ImageLoaderView({
      imageClass: 'CDB-Text u-actionTextColor js-assetPicker',
      imageUrl: this.model.get('image'),
      color: this.model.get('val')
    });
    this.addView(this.iconView);
    this.$('.js-image-container').append(this.iconView.render().el);
  },

  _onClick: function (ev) {
    this.killEvent(ev);
    var $target = $(ev.target);
    var isIconClicked = $target.closest('.js-image-container').length > 0;
    var isImgClicked = $target.closest('.js-assetPicker').length > 0;

    this.model.set({
      selectedClass: isImgClicked || isIconClicked ? ['js-assetPicker'] : [],
      selected: true
    });
  }
});

},{"../../../../../../custom-list/custom-list-item-view":26,"../../../../../../img-loader-view":180,"jquery":"jquery","underscore":"underscore"}],104:[function(require,module,exports){
var CustomListView = require('../../../../../../custom-list/custom-list-view');

module.exports = CustomListView.extend({
  _renderItem: function (mdl) {
    var ItemViewClass = this.options.ItemView;
    var itemView = new ItemViewClass({
      model: mdl,
      typeLabel: this.options.typeLabel,
      template: this.options.itemTemplate,
      imageEnabled: this.options.imageEnabled
    });
    this.$('.js-list').append(itemView.render().el);
    this.addView(itemView);

    // 'customEvent' comes from custom list component
    itemView.bind('customEvent', function (eventName, item) {
      this.trigger('customEvent', eventName, item, this);
    }, this);
  }
});

},{"../../../../../../custom-list/custom-list-view":33}],105:[function(require,module,exports){
var CustomView = require('../../../../../../custom-list/custom-view.js');
var itemTemplate = require('../../../../../../custom-list/custom-list-item.tpl');
var CategoriesListItemView = require('./categories-list-item-view');
var CategoriesListView = require('./categories-list-view');

module.exports = CustomView.extend({
  options: {
    showSearch: true,
    allowFreeTextInput: false,
    typeLabel: 'column',
    itemTemplate: itemTemplate,
    itemView: CategoriesListItemView
  },

  _renderList: function () {
    this._listView = new CategoriesListView({
      model: this.model,
      allowFreeTextInput: this.options.allowFreeTextInput,
      collection: this.collection,
      typeLabel: this.options.typeLabel,
      ItemView: this.options.itemView,
      itemTemplate: this.options.itemTemplate,
      size: this.options.size,
      imageEnabled: this.options.imageEnabled
    });
    this.$el.append(this._listView.render().el);
    this._listView.highlight();
    this.addView(this._listView);

    // 'customEvent' comes from custom list component
    this._listView.bind('customEvent', function (eventName, item) {
      this.trigger(eventName, item, this);
    }, this);
  }
});

},{"../../../../../../custom-list/custom-list-item.tpl":28,"../../../../../../custom-list/custom-view.js":35,"./categories-list-item-view":103,"./categories-list-view":104}],106:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-ListDecoration-itemLink u-flex u-justifySpace u-alignCenter ';
 if (isSelected) { 
__p+=' is-selected ';
 } 
__p+='">\n  <span class="RampItem-text CDB-Text u-ellipsis u-actionTextColor" title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">'+
((__t=( name ))==null?'':_.escape(__t))+
'</span>\n\n  <div class=\'RampItem-secondaryContainer\'>\n    <div class="ColorBar RampItem-bar js-colorPicker" style="background-color: '+
((__t=( val ))==null?'':_.escape(__t))+
';"></div>\n\n    ';
 if (imageEnabled) { 
__p+='\n      <div class=\'RampItem-img\'>\n        ';
 if (image) { 
__p+='\n          <div class=\'js-image-container u-flex\'></div>\n        ';
 } else { 
__p+='\n          <button class="CDB-Text u-actionTextColor js-assetPicker">'+
((__t=( _t('form-components.editors.fill.input-color.img') ))==null?'':__t)+
'</button>\n        ';
 } 
__p+='\n      </div>\n    ';
 } 
__p+='\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],107:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');
var Utils = require('../../../../../../helpers/utils');
var CoreView = require('backbone/core-view');
var CategoriesListView = require('./categories-list/categories-view');
var CustomListCollection = require('../../../../../custom-list/custom-list-collection');
var template = require('./input-color-categories-list-view.tpl');
var itemTemplate = require('./input-color-categories-list-item.tpl');

module.exports = CoreView.extend({
  events: {
    'click .js-color': '_onClickColor'
  },

  initialize: function (opts) {
    this._showSearch = opts.showSearch || false;
    this._typeLabel = opts.typeLabel;
    this._maxValues = opts.maxValues;

    this._setupCollection();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    this.$el.append(template({
      range: this.model.get('range'),
      attribute: this.model.get('attribute')
    }));

    this._listView = new CategoriesListView({
      itemTemplate: itemTemplate,
      collection: this._collection,
      showSearch: this._showSearch,
      typeLabel: this._typeLabel,
      imageEnabled: this.options.imageEnabled
    });

    this.addView(this._listView);

    this.$('.js-content').append(this._listView.render().$el);

    return this;
  },

  _setupCollection: function () {
    this._collection = new CustomListCollection(null, {silent: false});

    var range = this.model.get('range');
    var domain = this.model.get('domain');
    var images = this.model.get('images');

    if (range && range.length && domain && domain.length) {
      var categories = _.map(range, function (color, i) {
        var isNull = domain[i] == null || (_.isString(domain[i]) && Utils.isBlank(domain[i]));
        var label = domain[i];

        if (i >= this._maxValues) {
          label = _t('form-components.editors.fill.input-categories.others');
        } else if (isNull) {
          label = _t('form-components.editors.fill.input-categories.null');
        }

        var attrs = {
          label: label,
          val: color
        };

        if (images && images.length) {
          attrs['image'] = images[i];
        }

        return attrs;
      }, this);

      this._collection.reset(categories);
    }
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.trigger('back', this);
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:range', this.render);
    this.listenTo(this.model, 'change:domain', this.render);
    this.listenTo(this._collection, 'change:selected', this._onSelectItem);
  },

  _onClickColor: function (ev) {
    this.killEvent(ev);
    var index = $(ev.target).index();
    var color = this._collection.at(index);
    color && this._onSelectItem(color);
  },

  _onSelectItem: function (item) {
    var selectedItem = {
      index: this._collection.indexOf(item),
      target: _.contains(item.get('selectedClass'), 'js-assetPicker') ? 'asset' : 'color'
    };

    this.trigger('selectItem', selectedItem, this);
  }
});

},{"../../../../../../helpers/utils":435,"../../../../../custom-list/custom-list-collection":23,"./categories-list/categories-view":105,"./input-color-categories-list-item.tpl":106,"./input-color-categories-list-view.tpl":108,"backbone/core-view":454,"jquery":"jquery","underscore":"underscore"}],108:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeader">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical CDB-Text CDB-Size-medium u-secondaryTextColor u-flex u-alignCenter">\n      <ul class="ColorBarContainer">\n        ';
 _.each(range, function (color) { 
__p+='\n          <li class="ColorBar ColorBar--spaceless ColorBar--clickable js-color" style="background-color: '+
((__t=( color ))==null?'':_.escape(__t))+
';"></li>\n        ';
 }); 
__p+='\n      </ul>\n    </li>\n  </ul>\n</div>\n<div class="js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],109:[function(require,module,exports){
var _ = require('underscore');
var CDB = require('cartodb.js');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var template = require('./input-color-categories.tpl');
var StackLayoutView = require('../../../../../../components/stack-layout/stack-layout-view');
var InputColorPickerView = require('../input-color-picker/input-color-picker-view');
var CategoriesListView = require('./input-color-categories-list-view');
var rampList = require('cartocolor');
var AssetPickerView = require('../assets-picker/input-asset-picker-view');
var MAX_VALUES = 10;
var DEFAULT_COLORS = _.clone(rampList.Prism[MAX_VALUES + 1]); // max values + "others" color
var queryTemplate = _.template('SELECT <%= column %>, count(<%= column %>) FROM (<%= sql %>) _table_sql GROUP BY <%= column %> ORDER BY count DESC, <%= column %> ASC LIMIT <%= max_values %>');
var checkAndBuildOpts = require('../../../../../../helpers/required-opts');
var REQUIRED_OPTS = [
  'columns',
  'configModel',
  'modals',
  'query',
  'userModel'
];

function _quote (c) {
  if (c && c !== true) {
    return '"' + c.toString().replace(/"/g, '\\"').replace(/\n/g, '\\n') + '"';
  }
  return c;
}

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_onClickBack',
    'click .js-quantification': '_onClickQuantification'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this._imageEnabled = opts.imageEnabled;
    this.listenTo(this.model, 'change:attribute', this._fetchColumns);
    this._viewModel = new Backbone.Model({
      step: 0,
      status: 'idle'
    });

    this.listenTo(this._viewModel, 'change:status', this.render);

    // If it comes from a quantification change
    if (this.model.hasChanged('quantification') && this.model.get('quantification') === 'category') {
      this._fetchColumns();
    }
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    var column = this._getColumn();
    var columnType = column && column.type;

    this.$el.append(template({
      status: this._viewModel.get('status'),
      columnType: columnType,
      attribute: this.model.get('attribute'),
      quantification: this.model.get('quantification') || 'category'
    }));

    this._generateStackLayoutView();

    return this;
  },

  _generateStackLayoutView: function () {
    var currentStep = this._viewModel.get('step');

    var stackViewCollection = new Backbone.Collection([{
      selected: currentStep === 0,
      createStackView: function (stackLayoutModel, opts) {
        return this._createRangeListView(stackLayoutModel, opts).bind(this);
      }.bind(this)
    }, {
      selected: currentStep === 1,
      createStackView: function (stackLayoutModel, opts) {
        return this._createColorPickerView(stackLayoutModel, opts).bind(this);
      }.bind(this)
    }]);

    if (this._iconStylingEnabled()) {
      stackViewCollection.add({
        selected: currentStep === 2,
        createStackView: function (stackLayoutModel, opts) {
          return this._createImagePickerView(stackLayoutModel, opts).bind(this);
        }.bind(this)
      });
    }

    this._stackLayoutView = new StackLayoutView({ collection: stackViewCollection });
    this._stackLayoutView.bind('positionChanged', this._onStackLayoutPositionChange, this);

    this.addView(this._stackLayoutView);
    this.$('.js-content').append(this._stackLayoutView.render().$el);
  },

  _onStackLayoutPositionChange: function () {
    this.$('.js-prevStep').toggle(this._stackLayoutView.getCurrentPosition() === 0);
  },

  _iconStylingEnabled: function () {
    return this._imageEnabled;
  },

  _getColumn: function () {
    return _.find(this._columns, function (column) {
      return column.label === this.model.get('attribute');
    }, this);
  },

  _fetchColumns: function () {
    if (!this.model.get('attribute')) {
      return;
    }

    if (this._query) {
      this._setViewStatus('loading');

      var sql = new CDB.SQL({
        user: this._configModel.get('user_name'),
        sql_api_template: this._configModel.get('sql_api_template'),
        api_key: this._configModel.get('api_key')
      });

      sql.execute(
        queryTemplate({
          sql: this._query,
          column: this.model.get('attribute'),
          max_values: MAX_VALUES + 1
        }),
        null,
        {
          success: this._onQueryDone.bind(this),
          error: function () {
            this._setViewStatus('error');
          }.bind(this)
        }
      );
    } else {
      this._onQueryDone();
    }
  },

  _onQueryDone: function (data) {
    data = data || {};
    this._updateRangeAndDomain(data.rows);
    this._setViewStatus('idle');
  },

  _updateRangeAndDomain: function (rows) {
    rows = rows || [];
    var categoryNames = _.pluck(rows, this.model.get('attribute'));

    var domain = _.map(categoryNames, function (name, i) {
      return name;
    }).slice(0, MAX_VALUES);

    if (this.model.get('attribute_type') !== 'number') {
      domain = domain.filter(function (item, pos, self) {
        return self.indexOf(item) === pos;
      }).map(_quote);
    }

    var range = _.map(categoryNames, function (name, i) {
      return (i < MAX_VALUES) ? DEFAULT_COLORS[i] : DEFAULT_COLORS[MAX_VALUES + 1];
    });

    if (this._iconStylingEnabled()) {
      var images = _.map(categoryNames, function () {
        return '';
      });

      this.model.attributes.images = images;
    }

    this.model.set({
      range: range,
      domain: domain
    });
  },

  _setViewStatus: function (status) {
    var attrs = {
      status: status
    };

    if (status === 'loading') {
      attrs.step = 0;
    }

    this._viewModel.set(attrs);
  },

  _getRange: function () {
    return _.map(this.model.get('range'), function (color, i) {
      var range = {
        val: color,
        color: color,
        title: this.model.get('domain')[i]
      };

      if (this._iconStylingEnabled()) {
        range.image = this.model.get('images')[i];
      }

      return range;
    }, this);
  },

  _updateRange: function (categories) {
    var range = _.clone(this.model.get('range'));
    range[this._index] = categories[this._index].color;
    this.model.set('range', range);
  },

  _createColorPickerView: function (stackLayoutModel, opts) {
    var range = this._getRange();

    var opacity = typeof this.model.get('opacity') !== 'undefined' ? this.model.get('opacity') : 1;

    var view = new InputColorPickerView({
      index: this._index,
      ramp: range,
      opacity: opacity,
      imageEnabled: this._iconStylingEnabled()
    });

    view.bind('back', function (value) {
      stackLayoutModel.prevStep();
    }, this);

    view.bind('goToAssetPicker', function () {
      stackLayoutModel.nextStep();
    }, this);

    view.bind('change', this._updateRange, this);
    view.bind('changeIndex', function (index) {
      this._index = index;
    }, this);
    view.bind('change:opacity', function (opacity) {
      this.model.set('opacity', opacity);
    }, this);

    return view;
  },

  _createRangeListView: function (stackLayoutModel, opts) {
    var view = new CategoriesListView({
      maxValues: MAX_VALUES,
      model: this.model,
      imageEnabled: this._iconStylingEnabled()
    });

    view.bind('back', function (value) {
      stackLayoutModel.prevStep();
    }, this);

    view.bind('selectItem', function (item) {
      this._index = item.index;

      if (item.target === 'asset') {
        stackLayoutModel.goToStep(2);
      } else {
        stackLayoutModel.goToStep(1);
      }
    }, this);

    return view;
  },

  _createImagePickerView: function (stackLayoutModel, opts) {
    var range = this._getRange();

    var view = new AssetPickerView({
      userModel: this._userModel,
      configModel: this._configModel,
      index: this._index,
      ramp: range,
      modals: this._modals,
      imageEnabled: this._iconStylingEnabled()
    });

    view.bind('back', function (value) {
      stackLayoutModel.goToStep(0);
    }, this);

    view.bind('goToColorPicker', function () {
      stackLayoutModel.prevStep();
    }, this);

    if (this._iconStylingEnabled()) {
      view.bind('change:image', this._onImageChanged, this);
    }

    return view;
  },

  _onImageChanged: function (data) {
    var images = _.clone(this.model.get('images'));
    images[this._index] = data.url;
    this.model.set('images', images);
  },

  _onClickQuantification: function (e) {
    this.killEvent(e);
    this.trigger('selectQuantification', this);
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.trigger('back', this);
  }
}, {
  MAX_VALUES: MAX_VALUES
});

},{"../../../../../../components/stack-layout/stack-layout-view":274,"../../../../../../helpers/required-opts":432,"../assets-picker/input-asset-picker-view":89,"../input-color-picker/input-color-picker-view":118,"./input-color-categories-list-view":107,"./input-color-categories.tpl":110,"backbone":"backbone","backbone/core-view":454,"cartocolor":"cartocolor","cartodb.js":"cartodb.js","underscore":"underscore"}],110:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeader js-prevStep">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <ul class="u-flex u-justifySpace">\n        <li class="u-flex">\n          <button class="u-rSpace u-actionTextColor js-back">\n            <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n          </button>\n          <span class="label js-label">'+
((__t=( attribute ))==null?'':_.escape(__t))+
'</span>\n        </li>\n        ';
 if (columnType === 'number') { 
__p+='\n          <li class="u-flex">\n            '+
((__t=( _t('form-components.editors.fill.quantification.methods.' + quantification) ))==null?'':_.escape(__t))+
'\n            <button class="CDB-Shape u-lSpace js-quantification">\n              <div class="CDB-Shape-threePoints is-horizontal is-blue is-small">\n                <div class="CDB-Shape-threePointsItem"></div>\n                <div class="CDB-Shape-threePointsItem"></div>\n                <div class="CDB-Shape-threePointsItem"></div>\n              </div>\n            </button>\n          </li>\n        ';
 } 
__p+='\n      </ul>\n    </li>\n  </ul>\n</div>\n\n';
 if (status === 'loading') { 
__p+='\n  <div class="InputColorCategory-loader js-loader">\n    <div class="CDB-LoaderIcon is-dark">\n      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n      </svg>\n    </div>\n  </div>\n';
 } else if (status === 'error') { 
__p+='\n  <div class="u-flex u-alignCenter u-justifyCenter CDB-Text CDB-Size-medium u-bSpace--m u-tSpace--m u-errorTextColor">'+
((__t=( _t('form-components.editors.fill.error') ))==null?'':_.escape(__t))+
'</div>\n';
 } else { 
__p+='\n  <div class="InputColorCategory-content js-content"></div>\n';
 } 
__p+='';
}
return __p;
};

},{"underscore":"underscore"}],111:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var tabPaneTemplate = require('../fill-tab-pane.tpl');
var createTextLabelsTabPane = require('../../../../../components/tab-pane/create-text-labels-tab-pane');
var InputColorFixedContentView = require('./input-color-fixed-content-view');
var InputColorValueContentView = require('./input-color-value-content-view');

module.exports = CoreView.extend({
  initialize: function (opts) {
    if (this.options.editorAttrs) {
      var editorAttrs = this.options.editorAttrs;

      if (editorAttrs.hidePanes) {
        this._hidePanes = editorAttrs.hidePanes;

        if (!_.contains(this._hidePanes, 'value')) {
          if (!opts.configModel) throw new Error('configModel param is required');
          if (!opts.userModel) throw new Error('userModel param is required');
          if (!opts.modals) throw new Error('modals param is required');
          if (!opts.query) throw new Error('query param is required');
        }
      }

      if (editorAttrs.categorizeColumns) {
        this._categorizeColumns = true;
      }

      if (editorAttrs.imageEnabled) {
        this._imageEnabled = true;
      }
    }

    if (!opts.columns) throw new Error('columns is required');

    this._columns = opts.columns;
    this._configModel = opts.configModel;
    this._userModel = opts.userModel;
    this._modals = opts.modals;
    this._query = opts.query;

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this.model.on('change:fixed', function () {
      if (!this.model.get('fixed') || this.model.get('range')) {
        this.model.unset('image', { silent: true });
      }
    }, this);
  },

  _initViews: function () {
    var self = this;

    var fixedPane = {
      name: 'fixed',
      label: _t('form-components.editors.fill.input-color.solid'),
      createContentView: function () {
        return self._generateFixedContentView();
      }
    };

    var valuePane = {
      name: 'value',
      label: _t('form-components.editors.fill.input-color.value'),
      createContentView: function () {
        return self._generateValueContentView();
      }
    };

    this._tabPaneTabs = [];

    if (this._hidePanes) {
      if (!_.contains(this._hidePanes, 'fixed')) {
        this._tabPaneTabs.push(fixedPane);
      }
      if (!_.contains(this._hidePanes, 'value')) {
        this._tabPaneTabs.push(valuePane);
      }
    } else {
      this._tabPaneTabs = [fixedPane, valuePane];
    }

    var tabPaneOptions = {
      tabPaneOptions: {
        template: tabPaneTemplate,
        tabPaneItemOptions: {
          tagName: 'li',
          className: 'CDB-NavMenu-item'
        }
      },
      tabPaneItemLabelOptions: {
        tagName: 'button',
        className: 'CDB-NavMenu-link u-upperCase'
      }
    };

    if (this.model.get('range') && this._tabPaneTabs.length > 1) {
      this._tabPaneTabs[1].selected = true;
    }

    this._tabPaneView = createTextLabelsTabPane(this._tabPaneTabs, tabPaneOptions);
    this._tabPaneView.collection.bind('change:selected', this._onChangeTabPaneViewTab, this);
    this.$el.append(this._tabPaneView.render().$el);
    this.addView(this._tabPaneView);
  },

  _onChangeTabPaneViewTab: function () {
    var selectedTabPaneName = this._tabPaneView.getSelectedTabPaneName();
    var attrsToUnsetIfFixed = ['domain', 'bins', 'attribute', 'quantification'];

    if (selectedTabPaneName === 'fixed') {
      _.each(attrsToUnsetIfFixed, function (attr) {
        this.model.unset(attr, { silent: true });
      }, this);

      if (!this.model.get('fixed')) {
        if (this.model.get('range')) {
          this.model.set('fixed', this.model.get('range')[0]);
          this.model.unset('range');
        } else {
          this.model.set('fixed', '#0303FF');
        }
      }
    }

    this.trigger('change', selectedTabPaneName, this);
  },

  _generateFixedContentView: function () {
    return new InputColorFixedContentView({
      model: this.model,
      configModel: this._configModel,
      userModel: this._userModel,
      modals: this._modals,
      editorAttrs: this.options.editorAttrs
    });
  },

  _generateValueContentView: function () {
    return new InputColorValueContentView({
      model: this.model,
      columns: this._columns,
      configModel: this._configModel,
      categorizeColumns: this._categorizeColumns,
      imageEnabled: this._imageEnabled,
      userModel: this._userModel,
      modals: this._modals,
      hideTabs: this.options.hideTabs,
      query: this._query
    });
  }
});

},{"../../../../../components/tab-pane/create-text-labels-tab-pane":276,"../fill-tab-pane.tpl":76,"./input-color-fixed-content-view":115,"./input-color-value-content-view":120,"backbone/core-view":454,"underscore":"underscore"}],112:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-selector"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],113:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./input-color-file-view.tpl');
var AssetsView = require('./assets-picker/assets-view');
var CarouselFormView = require('../../../../../components/carousel-form-view');
var CarouselCollection = require('../../../../../components/custom-carousel/custom-carousel-collection');
var StaticAssetsCollection = require('../../../../../data/static-assets-collection');
var StaticAssetModel = require('../../../../../data/static-asset-model');
var AssetTemplate = require('./assets-picker/static-asset-item-view.tpl');
var CarouselTemplate = require('./input-color-file-carousel.tpl');
var MakiIcons = require('./assets/maki-icons');

module.exports = CoreView.extend({

  events: {
    'click .js-show-collection': '_onClickShowCollection'
  },

  initialize: function (opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.userModel) throw new Error('userModel is required');
    if (!opts.modals) throw new Error('modals is required');

    this._configModel = opts.configModel;
    this._userModel = opts.userModel;
    this._modals = opts.modals;

    this._initCarouselCollection();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());
    this._renderAssets();
    return this;
  },

  _initBinds: function () {
    this.listenTo(this._carouselCollection, 'change:selected', this._onSelectAsset);
    this.listenTo(this._carouselCollection, 'reset', this.render);
  },

  _resetCarouselCollection: function (url) {
    this._icons.reset(MakiIcons.icons);

    var selectedItem = this._carouselCollection.find(function (m) { return m.get('url') === url; });

    if (selectedItem) {
      selectedItem.set('selected', true);
    }

    this._icons.unshift(this._resetAsset);
    this._carouselCollection.reset(this._getIcons());
  },

  _initCarouselCollection: function () {
    this._icons = new StaticAssetsCollection(MakiIcons.icons);
    this.add_related_model(this._icons);

    this._resetAsset = new StaticAssetModel({
      type: 'none',
      selected: !this._getIconSelected(),
      name: _t('form-components.editors.fill.image.none'),
      action: function (m) {
        this._resetImage(m);
      }.bind(this)
    });

    this._icons.unshift(this._resetAsset);

    this._carouselCollection = new CarouselCollection(this._getIcons());
    this.add_related_model(this._carouselCollection);
  },

  _getIcons: function () {
    var defaultAction = function (m) {
      this._changeIcon(m);
    }.bind(this);

    return this._icons.map(function (icon) {
      var type = icon.get('type') ? icon.get('type') : 'icon';
      var action = icon.get('action') ? icon.get('action') : defaultAction;
      var selectedIcon = this._getIconSelected();

      return {
        selected: icon.get('selected') || icon.getURLFor(icon.get('icon')) === selectedIcon,
        icon: icon,
        type: type,
        name: icon.get('name'),
        url: icon.get('public_url'),
        action: action,
        template: function () {
          return AssetTemplate({ type: type, public_url: icon.get('public_url') + '?req=markup', name: icon.get('name') });
        }
      };
    }, this);
  },

  _getIconSelected: function () {
    if (this.model.get('ramp')) {
      var rampIndex = this.model.get('index') || 0;
      var categoryImage = this.model.get('ramp')[rampIndex].image;

      return categoryImage || '';
    } else {
      return this.model.get('image') || '';
    }
  },

  _renderAssets: function () {
    this.clearSubViews();
    this.$el.html(template());

    var view = new CarouselFormView({
      collection: this._carouselCollection,
      template: CarouselTemplate,
      listItemOptions: {
        className: 'Carousel-item AssetListItem'
      },
      itemOptions: {
        className: 'AssetItem-button'
      }
    });

    this.addView(view);
    this.$('.js-assets').append(view.render().el);
  },

  _onSelectAsset: function (m) {
    m.get('action')(m);
  },

  _changeIcon: function (m) {
    var icon = m.get('icon');

    this.trigger('change', {
      url: icon.get('public_url'),
      kind: icon.get('kind')
    }, this);
  },

  _resetImage: function () {
    this.trigger('change', null, this);
  },

  _onClickShowCollection: function (e) {
    this.killEvent(e);

    var self = this;

    this._modals.create(function (modalModel) {
      var view = new AssetsView({
        model: self.model,
        modalModel: modalModel,
        configModel: self._configModel,
        userModel: self._userModel
      });

      view.bind('change', function (data) {
        this._resetCarouselCollection(data.url);
        this.trigger('change', data, this);
      }, self);

      return view;
    });
  }
});

},{"../../../../../components/carousel-form-view":1,"../../../../../components/custom-carousel/custom-carousel-collection":16,"../../../../../data/static-asset-model":366,"../../../../../data/static-assets-collection":367,"./assets-picker/assets-view":85,"./assets-picker/static-asset-item-view.tpl":94,"./assets/maki-icons":102,"./input-color-file-carousel.tpl":112,"./input-color-file-view.tpl":114,"backbone/core-view":454}],114:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-boxModalContent js-assets">\n  <h2 class="CDB-Text CDB-Size-small u-bSpace--m u-upperCase">\n    '+
((__t=( _t('form-components.editors.fill.image.recently-title') ))==null?'':_.escape(__t))+
'\n  </h2>\n</div>\n<div class="CustomRamp-list">\n  <div class="CustomList-item CustomList-item--add">\n    <button class="CDB-ListDecoration-itemLink CDB-Text CDB-Size-medium u-actionTextColor js-show-collection" type="button">\n      '+
((__t=( _t('form-components.editors.fill.image.show-all') ))==null?'':_.escape(__t))+
'\n    </button>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],115:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var tabPaneTemplate = require('../fill-tab-pane.tpl');
var createMixedLabelsTabPane = require('../../../../../components/tab-pane/create-mixed-labels-tab-pane');
var ColorPicker = require('../color-picker/color-picker');
var InputColorFileView = require('./input-color-file-view');

module.exports = CoreView.extend({
  initialize: function (opts) {
    if (this.options.editorAttrs) {
      var editorAttrs = this.options.editorAttrs;

      this._imageEnabled = editorAttrs.imageEnabled;

      if (editorAttrs.hidePanes) {
        this._hidePanes = editorAttrs.hidePanes;

        if (this._imageEnabled && !_.contains(this._hidePanes, 'file')) {
          if (!opts.configModel) throw new Error('configModel param is required');
          if (!opts.userModel) throw new Error('userModel param is required');
          if (!opts.modals) throw new Error('modals param is required');
        }
      }

      if (editorAttrs.disableOpacity) {
        this._disableOpacity = true;
      }
    }

    this._userModel = opts.userModel;
    this._configModel = opts.configModel;
    this._modals = opts.modals;
    this._query = opts.query;
  },

  render: function () {
    this.clearSubViews();

    if (this._imageEnabled) {
      this._setupTabPanes();
    }

    if (this._tabPaneView) {
      this.$el.append(this._tabPaneView.render().$el);
    } else {
      this.$el.append(this._generateFixedContentView().render().$el);
    }
    return this;
  },

  _setupTabPanes: function () {
    var self = this;

    var fixedPane = {
      name: 'fixed',
      type: 'color',
      label: this.model.get('fixed'),
      createContentView: function () {
        return self._generateFixedContentView();
      }
    };

    var filePane = {
      name: 'file',
      type: this.model.get('image') ? 'image' : 'text',
      label: this.model.get('image') || _t('form-components.editors.fill.input-color.img'),
      kind: this.model.get('kind') || 'marker',
      color: this.model.get('fixed'),
      createContentView: function () {
        return self._generateFileContentView();
      }
    };

    this._tabPaneTabs = [];

    if (this.options.editorAttrs && this.options.editorAttrs.hidePanes) {
      this._hidePanes = this.options.editorAttrs.hidePanes;

      if (!_.contains(this._hidePanes, 'fixed')) {
        this._tabPaneTabs.push(fixedPane);
      }

      if (!_.contains(this._hidePanes, 'file')) {
        this._tabPaneTabs.push(filePane);
      }
    } else {
      this._tabPaneTabs = [fixedPane, filePane];
    }

    var tabPaneOptions = {
      tabPaneOptions: {
        template: tabPaneTemplate,
        tabPaneItemOptions: {
          tagName: 'li',
          className: 'CDB-NavMenu-item'
        }
      },
      tabPaneItemLabelOptions: {
        tagName: 'button',
        className: 'CDB-NavMenu-link u-upperCase'
      }
    };

    if (this.model.get('image') && this._tabPaneTabs.length > 1) {
      this._tabPaneTabs[1].selected = true;
    }
    this.listenTo(this.model, 'change:image', this._updateImageTabPane);
    this.listenTo(this.model, 'change:fixed', this._updateTextTabPane);

    this._tabPaneView = createMixedLabelsTabPane(this._tabPaneTabs, tabPaneOptions);
    this.addView(this._tabPaneView);
  },

  _updateTextTabPane: function () {
    this._updateImageTabPane();
    this._tabPaneView.collection.at(0).set('label', this.model.get('fixed'));
  },

  _updateImageTabPane: function () {
    if (this.model.get('image')) {
      this._tabPaneView.collection.at(1).set({ label: this.model.get('image'), color: this.model.get('fixed') });
    } else {
      this._tabPaneView.collection.at(1).set('label', _t('form-components.editors.fill.input-color.img'));
    }
  },

  _generateFixedContentView: function () {
    var contentView = new ColorPicker({
      value: this.model.get('fixed'),
      opacity: this.model.get('opacity'),
      disableOpacity: this._disableOpacity
    });

    contentView.bind('change', this._onChangeValue, this);
    return contentView;
  },

  _generateFileContentView: function () {
    var contentView = new InputColorFileView({
      model: this.model,
      userModel: this._userModel,
      configModel: this._configModel,
      modals: this._modals
    });

    contentView.bind('change', this._onChangeFile, this);
    return contentView;
  },

  _onChangeFile: function (data) {
    if (data && data.url) {
      this.model.set({
        image: data.url,
        kind: data.kind
      });
    } else {
      this.model.unset('image');
    }
  },

  _onChangeValue: function (color) {
    this.model.set({ fixed: color.hex, opacity: color.opacity });
  }
});

},{"../../../../../components/tab-pane/create-mixed-labels-tab-pane":275,"../color-picker/color-picker":69,"../fill-tab-pane.tpl":76,"./input-color-file-view":113,"backbone/core-view":454,"underscore":"underscore"}],116:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var ImageLoaderView = require('../../../../../img-loader-view');
var template = require('./input-color-picker-header.tpl');
var MAX = 1;

module.exports = CoreView.extend({
  events: {
    'click .js-color': '_onClickColor',
    'click .js-assetPicker': '_onClickAssetPicker',
    'keyup .js-a': '_onChangeOpacity'
  },

  initialize: function (opts) {
    this.listenTo(this.model, 'change', this.render);
  },

  render: function (model, options) {
    if (model && model.changed && typeof model.changed.opacity !== 'undefined') {
      this._reRenderOpacity();
      return this;
    }

    this.clearSubViews();
    this.$el.empty();

    var rampItem = this._getRampItem();
    this.$el.append(template({
      ramp: this.model.get('ramp'),
      index: this.model.get('index'),
      opacity: this.model.get('opacity'),
      label: rampItem.title || _t('form-components.editors.fill.input-categories.others'),
      color: rampItem.color || '',
      iconStylingEnabled: this.options.iconStylingEnabled,
      isCategorized: _.has(rampItem, 'image'),
      image: rampItem.image || '',
      imageEnabled: this.options.imageEnabled
    }));

    this._slider = this.$('.js-slider').slider({
      range: 'min',
      value: this._inverseSliderValue(this.model.get('opacity')),
      min: 0,
      max: MAX,
      step: 0.02,
      orientation: 'horizontal',
      disabled: false,
      slide: this._onSlideChange.bind(this)
    });

    this._loadImages();

    return this;
  },

  _getRampItem: function () {
    var ramp = this.model.get('ramp');

    if (!ramp) {
      return {
        color: '',
        title: _t('form-components.editors.fill.input-categories.others'),
        image: ''
      };
    }

    return ramp[this.model.get('index')];
  },

  _loadImages: function () {
    var rampItem = this._getRampItem();

    this.iconView = new ImageLoaderView({
      imageClass: 'CDB-Text u-actionTextColor js-assetPicker',
      imageUrl: rampItem.image,
      color: rampItem.color
    });
    this.addView(this.iconView);
    this.$('.js-image-container').append(this.iconView.render().el);
  },

  _onClickColor: function (ev) {
    this.killEvent(ev);
    this.model.set('index', $(ev.target).index());
  },

  _onClickBack: function (ev) {
    this.killEvent(ev);
    this.trigger('back', this);
  },

  _onClickAssetPicker: function (ev) {
    this.killEvent(ev);
    this.trigger('goToAssetPicker', this);
  },

  _onSlideChange: function (evt, obj) {
    this.model.set('opacity', this._inverseSliderValue(obj.value));
  },

  _inverseSliderValue: function (value) {
    return parseFloat(Number(MAX - value).toFixed(2));
  },

  _onChangeOpacity: function () {
    var $input = this.$('.js-a');
    var value = $input.val();
    var isValid = this._isValidOpacity(value);
    $input.toggleClass('has-error', !isValid);
    if (isValid) {
      this.model.set('opacity', parseFloat(value));
    }
  },

  _isValidOpacity: function (value) {
    var regex = /^((0(\.\d+)?)|(1(\.0)?))$/;
    return regex.test(value);
  },

  _reRenderOpacity: function () {
    var $input = this.$('.js-a');
    var $slider = this.$('.js-slider');
    var opacity = this.model.get('opacity');
    var inputValue;
    var sliderValue;

    if ($input.length > 0) {
      inputValue = $input.val();
      if (!this._isValidOpacity(inputValue) || (this._isValidOpacity(inputValue) && parseFloat(inputValue) !== opacity)) {
        $input.val(opacity);
      }
    }

    if (typeof $slider.slider('instance') !== 'undefined') {
      sliderValue = $slider.slider('value');
      if (typeof sliderValue !== 'undefined' && sliderValue !== this._inverseSliderValue(opacity)) {
        $slider.slider('value', this._inverseSliderValue(opacity));
      }
    }
  }
});

},{"../../../../../img-loader-view":180,"./input-color-picker-header.tpl":117,"backbone/core-view":454,"jquery":"jquery","underscore":"underscore"}],117:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeader">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemDisplay--flex CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <div class=\'CDB-ListDecoration-secondaryContainer\'>\n        <button class="u-rSpace u-actionTextColor js-back" type="button">\n          <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n        </button>\n        <span class="label js-label">'+
((__t=( label ))==null?'':_.escape(__t))+
'</span>\n      </div>\n\n      ';
 if (isCategorized && imageEnabled) { 
__p+='\n        <div class=\'CDB-ListDecoration-secondaryContainer\'>\n          <nav class=\'CDB-NavMenu\'>\n            <ul class=\'CDB-NavMenu-Inner CDB-NavMenu-inner--no-margin js-menu\'>\n              <li class=\'CDB-NavMenu-item is-selected\'>\n                <div class=\'CDB-NavMenu-link CDB-ListDecoration-rampNav-item\'>\n                  <button class=\'ColorBar CDB-ListDecoration-rampItemBar u-rSpace--xl js-colorPicker\' type="button" style="background-color: '+
((__t=( color ))==null?'':__t)+
';"></button>\n                </div>\n              </li>\n              <li class=\'CDB-NavMenu-item\'>\n                <div class=\'CDB-NavMenu-link CDB-ListDecoration-rampNav-item\'>\n                  ';
 if (image) { 
__p+='\n                    <button class="CDB-ListDecoration-rampImg js-image-container" type="button"></button>\n                  ';
 } else { 
__p+='\n                    <button class="CDB-ListDecoration-rampImg CDB-Text u-actionTextColor js-assetPicker" type="button">'+
((__t=( _t('form-components.editors.fill.input-color.img') ))==null?'':__t)+
'</button>\n                  ';
 } 
__p+='\n                </div>\n              </li>\n            </ul>\n          </nav>\n        </div>\n      ';
 } 
__p+='\n    </li>\n  </ul>\n</div>\n\n<div class="CDB-Box-modalHeader">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <ul class="ColorBarContainer ColorBarContainer--rampEditing">\n        ';
 _.each(ramp, function (color, i) { 
__p+='\n        <li class="ColorBar is-link ColorBar--spaceless ColorBar--clickable js-color'+
((__t=( i === index ? ' is-selected' : '' ))==null?'':_.escape(__t))+
'" data-label="'+
((__t=( color.title ))==null?'':_.escape(__t))+
'" data-color="'+
((__t=( color.color ))==null?'':_.escape(__t))+
'" style="background-color: '+
((__t=( color.color ))==null?'':_.escape(__t))+
';"></li>\n        ';
 }); 
__p+='\n      </ul>\n      <div class="OpacityEditor">\n        <div class="OpacityEditor-slider js-slider"></div>\n        <div class="OpacityEditor-inputWrapper">\n          <input type="text" class="CDB-InputText ColorPicker-input js-a" value="'+
((__t=( opacity ))==null?'':_.escape(__t))+
'">\n        </div>\n      </div>\n    </li>\n  </ul>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],118:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var ColorPicker = require('../../color-picker/color-picker');
var template = require('./input-color-picker-view.tpl');
var InputColorPickerHeader = require('./input-color-picker-header');
var checkAndBuildOpts = require('../../../../../../helpers/required-opts');

var REQUIRED_OPTS = [
  'ramp',
  'opacity'
];

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_onClickBack'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this.model = new Backbone.Model({
      index: this.options.index,
      ramp: opts.ramp,
      opacity: opts.opacity
    });

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:index', this._onChangeIndex);
    this.listenTo(this.model, 'change:opacity', this._onOpacityChanged);
  },

  _initViews: function () {
    this._headerView = new InputColorPickerHeader({
      model: this.model,
      imageEnabled: this.options.imageEnabled
    });

    this.addView(this._headerView);
    this._headerView.bind('goToAssetPicker', this._onGoToAssetPicker, this);
    this.$('.js-header').append(this._headerView.render().$el);

    this._colorPicker = new ColorPicker({
      value: this._getColor(),
      opacity: 1,
      disableOpacity: true
    });

    this.addView(this._colorPicker);
    this._colorPicker.bind('change', this._onChangeValue, this);
    this.$('.js-content').append(this._colorPicker.render().$el);
  },

  _setColor: function (color) {
    var ramp = _.clone(this.model.get('ramp'));
    ramp[this.model.get('index')].color = color;
    this.model.set('ramp', ramp);
    this.model.trigger('change', ramp);
    this.trigger('change', ramp);
  },

  _getColor: function () {
    var ramp = this.model.get('ramp');
    return ramp[this.model.get('index') || 0].color;
  },

  _onChangeIndex: function () {
    this._colorPicker.setColor(this._getColor());
    this.trigger('changeIndex', this.model.get('index'), this);
  },

  _onChangeValue: function (color) {
    this._setColor(color.hex);
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.trigger('back', this);
  },

  _onOpacityChanged: function () {
    var opacity = this.model.get('opacity');
    this.trigger('change:opacity', opacity);
  },

  _onGoToAssetPicker: function () {
    this.trigger('goToAssetPicker');
  }
});

},{"../../../../../../helpers/required-opts":432,"../../color-picker/color-picker":69,"./input-color-picker-header":116,"./input-color-picker-view.tpl":119,"backbone":"backbone","backbone/core-view":454,"underscore":"underscore"}],119:[function(require,module,exports){
arguments[4][90][0].apply(exports,arguments)
},{"dup":90,"underscore":"underscore"}],120:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var StackLayoutView = require('../../../../../components/stack-layout/stack-layout-view');
var ColumnListView = require('../column-list-view');
var quantificationMethodItemTemplate = require('./quantification-method-item.tpl');
var InputColorRamps = require('./input-ramps/input-color-ramps');
var InputColorCategories = require('./input-categories/input-color-categories');
var DefaultFillSettings = require('../default-fill-settings.json');
var checkAndBuildOpts = require('../../../../../helpers/required-opts');

var EXCLUDED_COLUMNS = ['the_geom', 'the_geom_webmercator'];
var REQUIRED_OPTS = [
  'columns',
  'configModel',
  'modals',
  'query',
  'userModel'
];

module.exports = CoreView.extend({
  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._settings = DefaultFillSettings.color;

    this._categorizeColumns = opts.categorizeColumns;
    this._imageEnabled = opts.imageEnabled;

    this._column = this._getColumn();
    this._columnType = this._column && this._column.type;

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:quantification', function () {
      if (this.model.previous('quantification') === 'category') {
        delete this.model.attributes.range;
      }

      if (this.model.get('quantification') !== 'category') {
        this.model.unset('domain');
      }
    });
  },

  _initViews: function () {
    var self = this;

    var stackViewCollection = new Backbone.Collection([{
      createStackView: function (stackLayoutModel, opts) {
        return self._createColumnListView(stackLayoutModel, opts).bind(self);
      }
    }, {
      createStackView: function (stackLayoutModel, opts) {
        return self._createInputColorRamps(stackLayoutModel, opts).bind(self);
      }
    }, {
      createStackView: function (stackLayoutModel, opts) {
        return self._createInputColorCategories(stackLayoutModel, opts).bind(self);
      }
    }, {
      createStackView: function (stackLayoutModel, opts) {
        return self._createQuantificationListView(stackLayoutModel, opts).bind(self);
      }
    }]);

    this._stackLayoutView = new StackLayoutView({
      collection: stackViewCollection
    });

    if (this.model.get('attribute')) {
      var hasDomain = this.model.get('domain') && this.model.get('domain').length;
      var hasRange = this.model.get('range') && this.model.get('range').length;
      var showCategories = (this._columnType === 'string') || (hasDomain && hasRange);

      if (showCategories) {
        this._stackLayoutView.model.set('position', 2);
      } else {
        this._stackLayoutView.model.set('position', 1);
      }
    }

    this.$el.append(this._stackLayoutView.render().$el);
    this.addView(this._stackLayoutView);
  },

  _createInputColorCategories: function (stackLayoutModel, opts) {
    var view = new InputColorCategories({
      model: this.model,
      query: this._query,
      columns: this._columns,
      configModel: this._configModel,
      userModel: this._userModel,
      modals: this._modals,
      imageEnabled: this._imageEnabled
    });

    view.bind('selectQuantification', function (item) {
      stackLayoutModel.goToStep(3);
    }, this);

    view.bind('back', function (value) {
      stackLayoutModel.goToStep(0);
    }, this);

    return view;
  },

  _createQuantificationListView: function (stackLayoutModel, opts) {
    var view = new ColumnListView({
      headerTitle: _t('form-components.editors.fill.quantification.title'),
      stackLayoutModel: stackLayoutModel,
      itemTemplate: quantificationMethodItemTemplate,
      columns: this._settings.quantifications.items,
      showSearch: false
    });

    view.bind('selectItem', function (item) {
      this.model.set('quantification', item.get('val'));
      stackLayoutModel.goToStep(1);
    }, this);

    view.bind('back', function (value) {
      stackLayoutModel.goToStep(0);
    }, this);

    return view;
  },

  _createInputColorRamps: function (stackLayoutModel, opts) {
    var view = new InputColorRamps({
      hideTabs: this.options.hideTabs,
      model: this.model
    });

    view.bind('switch', function () {
      stackLayoutModel.goToStep(2);
    }, this);

    view.bind('back', function (value) {
      stackLayoutModel.prevStep();
    }, this);

    return view;
  },

  _getColumn: function (columnName) {
    return _.find(this._columns, function (column) {
      return column.label === (columnName || this.model.get('attribute'));
    }, this);
  },

  _createColumnListView: function (stackLayoutModel, opts) {
    var columns = _.reject(this._columns, function (column) {
      return column.type === 'geometry' || _.contains(EXCLUDED_COLUMNS, column.label);
    }, this);

    var view = new ColumnListView({
      stackLayoutModel: stackLayoutModel,
      columns: columns,
      showSearch: true,
      typeLabel: 'column'
    });

    view.bind('selectItem', function (item) {
      this._onChangeAttribute(item.get('val'), stackLayoutModel);
    }, this);

    return view;
  },

  _onChangeAttribute: function (columnName, stackLayoutModel) {
    var validCategoryTypes = ['string', 'boolean'];
    var attrsToUnset = ['image', 'fixed', 'quantification', 'opacity'];
    var wasQuantificationCategory = this.model.get('quantification') === 'category';

    this._column = this._getColumn(columnName);
    this._columnType = this._column && this._column.type;

    _.each(attrsToUnset, function (attr) {
      this.model.unset(attr, { silent: true });
    }, this);

    if (_.contains(validCategoryTypes, this._columnType) || this._categorizeColumns) {
      this.model.unset('bins', { silent: true });
      stackLayoutModel.goToStep(2);
    } else if (this._columnType === 'number') {
      this.model.unset('images', { silent: true });
      this.model.unset('domain', { silent: true });

      // Unset range if previous quantification was category
      if (wasQuantificationCategory) {
        this.model.unset('range', { silent: true });
      }

      stackLayoutModel.goToStep(1);
    }

    this.model.set({
      attribute: columnName,
      attribute_type: this._columnType
    });
  }
});

},{"../../../../../components/stack-layout/stack-layout-view":274,"../../../../../helpers/required-opts":432,"../column-list-view":71,"../default-fill-settings.json":73,"./input-categories/input-color-categories":109,"./input-ramps/input-color-ramps":124,"./quantification-method-item.tpl":131,"backbone":"backbone","backbone/core-view":454,"underscore":"underscore"}],121:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./input-color.tpl');
var InputDialogContent = require('./input-color-dialog-content');
var Utils = require('../../../../../helpers/utils');
var rampList = require('./input-ramps/ramps');
var ImageLoaderView = require('../../../../img-loader-view');

module.exports = CoreView.extend({
  tagName: 'li',
  className: 'CDB-OptionInput-item',

  events: {
    'click': '_onClick'
  },

  initialize: function (opts) {
    if (this.options.editorAttrs) {
      this._editorAttrs = this.options.editorAttrs;
      this._imageEnabled = this._editorAttrs.imageEnabled;
      var hidePanes = this._editorAttrs.hidePanes;

      if (hidePanes && !_.contains(hidePanes, 'value')) {
        if (!opts.configModel) throw new Error('configModel param is required');
        if (!opts.userModel) throw new Error('userModel param is required');
        if (!opts.modals) throw new Error('modals param is required');
        if (!opts.query) throw new Error('query param is required');
      }
    }

    if (!opts.columns) throw new Error('columns is required');

    this._columns = opts.columns;
    this._configModel = opts.configModel;
    this._userModel = opts.userModel;
    this._modals = opts.modals;
    this._query = opts.query;

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    if (this.options.disabled) {
      this.$el.addClass('is-disabled');
    }

    var column = this._getColumn();
    var columnType = column && column.type;
    var hasDomain = this.model.get('domain') && this.model.get('domain').length;

    if (this.model.get('range') && _.isString(this.model.get('range'))) {
      this._migrateRange();
    }

    var hasRange = this.model.get('range') && this.model.get('range').length;
    var showCategories = (columnType === 'string') || (hasDomain && hasRange);
    var imageURL = this._getImageURL();
    var categoryImagesPresent = this._iconStylingEnabled() && !this._getImageURL() && this._categoryImagesPresent();

    this.$el.html(template({
      categoryImagesPresent: categoryImagesPresent,
      imageURL: imageURL,
      kind: this._getKind(),
      showCategories: showCategories,
      value: this._getValue(),
      opacity: this._getOpacity()
    }));

    this._loadImages();

    return this;
  },

  _loadImages: function () {
    this.iconView = new ImageLoaderView({
      imageClass: 'Editor-fillImageAsset',
      imageUrl: this._getImageURL(),
      color: this.model.get('fixed')
    });
    this.addView(this.iconView);
    this.$('.js-image-container').append(this.iconView.render().el);
  },

  _categoryImagesPresent: function () {
    var images = this.model.get('images');

    for (var i in images) {
      if (!_.isEmpty(images[i])) {
        return true;
      }
    }

    return false;
  },

  _iconStylingEnabled: function () {
    return this._imageEnabled;
  },

  _getKind: function () {
    return this.model.get('kind') && this._iconStylingEnabled() ? this.model.get('kind') : '';
  },

  _getImageURL: function () {
    return this.model.get('image') && this._iconStylingEnabled() ? this.model.get('image') : '';
  },

  // Converts reference to the old color ramp to the full color list
  _migrateRange: function () {
    var rangeName = this.model.get('range');
    var bins = this.model.get('bins') || 3;

    if (rampList[rangeName] && rampList[rangeName][bins]) {
      this.model.set('range', rampList[rangeName][bins]);
    }
  },

  _getColumn: function () {
    return _.find(this._columns, function (column) {
      return column.label === this.model.get('attribute');
    }, this);
  },

  _createContentView: function () {
    var view = new InputDialogContent({
      configModel: this._configModel,
      userModel: this._userModel,
      modals: this._modals,
      query: this._query,
      model: this.model,
      columns: this._columns,
      editorAttrs: this._editorAttrs
    });

    view.bind('change', this.render, this);

    return view;
  },

  _onClick: function (e) {
    if (this.options.disabled) {
      return;
    }
    this.trigger('click', this.model);
  },

  _initBinds: function () {
    var self = this;

    this.model.set('createContentView', function () {
      return self._createContentView();
    }).bind(this);

    this.model.on('change:images', this.render, this);
    this.model.on('change:selected', this._onToggleSelected, this);
    this.model.on('change:opacity', this.render, this);
    this.model.on('change:fixed', this.render, this);
    this.model.on('change:fixed', this._updateColor, this);
    this.model.on('change:image', this.render, this);
    this.model.on('change:range', this.render, this);
  },

  _updateColor: function () {
    this.iconView && this.iconView.updateImageColor(this.model.get('fixed'));
  },

  _getValue: function () {
    var value = this.model.get('fixed');

    if (value) {
      value = Utils.hexToRGBA(value, this._getOpacity());
    }

    if (this.model.get('range') && this.model.get('range').length) {
      value = _.map(this.model.get('range'), function (color) {
        return Utils.hexToRGBA(color, this._getOpacity());
      }, this);
    }

    return value;
  },

  _getOpacity: function () {
    return this.model.get('opacity') != null ? this.model.get('opacity') : 1;
  },

  _onToggleSelected: function () {
    this.$el.toggleClass('is-active', this.model.get('selected'));
  }
});

},{"../../../../../helpers/utils":435,"../../../../img-loader-view":180,"./input-color-dialog-content":111,"./input-color.tpl":122,"./input-ramps/ramps":130,"backbone/core-view":454,"underscore":"underscore"}],122:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (showCategories) { 
__p+='\n  <ul class="ColorsBar">\n    ';
 _.each(value, function (color) { 
__p+='\n      <li class="ColorBar '+
((__t=( categoryImagesPresent ? 'ColorBar--spaceSmall' : 'ColorBar--spaceMedium' ))==null?'':_.escape(__t))+
'" style="background-color: '+
((__t=( color ))==null?'':_.escape(__t))+
'"></li>\n    ';
 }); 
__p+='\n  </ul>\n';
 } else { 
__p+='\n  <button type="button" class="Editor-fillContainer">\n    <ul class="ColorBarContainer">\n      ';
 if (_.isArray(value)) { 
__p+='\n        <li class="ColorBar ColorBar-gradient" style="background: linear-gradient(90deg,'+
((__t=( value.join(',') ))==null?'':_.escape(__t))+
')"></li>\n      ';
 } else { 
__p+='\n        <li class="ColorBar" style="background-color: '+
((__t=( value ))==null?'':_.escape(__t))+
'"></li>\n      ';
 } 
__p+='\n    </ul>\n  </button>\n';
 } 
__p+='\n\n';
 if (imageURL && kind !== 'custom-marker') { 
__p+='\n<button type="button" class="Editor-fillImage">\n  <div class="js-image-container"></div>\n</button>\n';
 } 
__p+='\n\n';
 if ((!imageURL && categoryImagesPresent) || (imageURL && kind === 'custom-marker')) { 
__p+='\n<button type="button" class="Editor-fillImage">\n  <div class=\'Editor-categoryImagesTag CDB-Text CDB-FontSize-small u-altTextColor is-semibold u-upperCase\'>'+
((__t=( _t('form-components.editors.fill.input-color.img') ))==null?'':__t)+
'</div>\n</button>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],123:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (customRamp && customRamp.length) { 
__p+='\n<li class="CDB-ListDecoration-item CustomList-item CustomRamp js-customRampItem">\n  <div class="CustomRamp-listOptions CDB-ListDecoration-itemLink CDB-ListDecoration-itemLink--double js-customRamp js-listItemLink is-selected">\n    <ul class="ColorBarContainer">\n      ';
 _.each(customRamp, function (color) { 
__p+='\n      <li class="ColorBar ColorBar--spaceless" style="background-color: '+
((__t=( color ))==null?'':_.escape(__t))+
';"></li>\n      ';
 }); 
__p+='\n    </ul>\n  </div>\n  <button class="CDB-ListDecoration-itemLink CustomRamp-clear js-clear">\n    <div class="CDB-Shape">\n      <div class="CDB-Shape-close is-blue is-large"></div>\n    </div>\n  </button>\n</li>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],124:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var StackLayoutView = require('../../../../../../components/stack-layout/stack-layout-view');
var ColumnListView = require('../../column-list-view');
var quantificationMethodItemTemplate = require('../quantification-method-item.tpl');
var InputRampContentView = require('./input-ramp-content-view');
var rampList = require('cartocolor');
var DefaultFillSettings = require('../../default-fill-settings.json');

module.exports = CoreView.extend({
  initialize: function (opts) {
    this._settings = DefaultFillSettings['color-ramps'];

    this._setupModel();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _setupModel: function () {
    var options = {};

    if (!this.model.get('quantification')) {
      options.quantification = this._settings.quantifications.items[this._settings.quantifications.defaultIndex];
    }

    if (!this.model.get('bins')) {
      options.bins = this._settings.bins.items[this._settings.bins.defaultIndex];
    }

    if (+this.model.get('bins') > +this._settings.bins.items[this._settings.bins.items.length - 1]) {
      options.bins = this._settings.bins.items[this._settings.bins.items.length - 1];
    }

    this.model.set(options);
  },

  _initBinds: function () {
    var range = this.model.get('range');

    this.listenTo(this.model, 'change:bins', this._updateRange);
    this.listenTo(this.model, 'change:attribute', this.render);
    this.listenTo(this.model, 'change:quantification', this._onChangeQuantification);

    this.model.unset('fixed');

    if (!range || !this._isValidRange(range)) {
      this.model.set('range', this._getDefaultRamp());
    }
  },

  // range minimun size should be 2
  _isValidRange: function (range) {
    return range && range.length > 1 || false;
  },

  _initViews: function () {
    var self = this;

    var collectionOptions = [
      {
        createStackView: function (stackLayoutModel, opts) {
          return self._createInputRampContentView(stackLayoutModel, opts).bind(self);
        }
      }
    ];

    if (!this.options.hideTabs || !_.contains(this.options.hideTabs, 'quantification')) {
      collectionOptions.push(
        {
          createStackView: function (stackLayoutModel, opts) {
            return self._createQuantificationListView(stackLayoutModel, opts).bind(self);
          }
        }
      );
    }

    if (!this.options.hideTabs || !_.contains(this.options.hideTabs, 'bins')) {
      collectionOptions.push(
        {
          createStackView: function (stackLayoutModel, opts) {
            return self._createBinsListView(stackLayoutModel, opts).bind(self);
          }
        }
      );
    }

    var stackViewCollection = new Backbone.Collection(collectionOptions);

    this._stackLayoutView = new StackLayoutView({
      collection: stackViewCollection
    });

    this.$el.append(this._stackLayoutView.render().$el);
    this.addView(this._stackLayoutView);
  },

  _updateRange: function () {
    var previousBins = this.model.previous('bins');

    if (!previousBins) {
      return;
    }

    var previousRamps = _.find(rampList, function (ramp) {
      var previousRamp = ramp[previousBins];
      var range = this.model.get('range');
      return previousRamp && range && previousRamp.join('').toLowerCase() === range.join('').toLowerCase();
    }, this);

    if (previousRamps) {
      var bins = this.model.get('bins');
      this.model.set('range', previousRamps[bins]);
    }
  },

  _createInputRampContentView: function (stackLayoutModel, opts) {
    var view = new InputRampContentView({
      stackLayoutModel: stackLayoutModel,
      model: this.model
    });

    view.bind('back', function (value) {
      this.trigger('back');
    }, this);

    view.bind('selectItem', function (value) {
      this.model.unset('domain');
      this.model.set('range', value);
    }, this);

    view.bind('selectQuantification', function (value) {
      stackLayoutModel.goToStep(1);
    }, this);

    view.bind('selectBins', function (value) {
      stackLayoutModel.goToStep(2);
    }, this);

    return view;
  },

  _createBinsListView: function (stackLayoutModel, opts) {
    var view = new ColumnListView({
      headerTitle: _t('form-components.editors.fill.bins'),
      stackLayoutModel: stackLayoutModel,
      columns: this._settings.bins.items
    });

    view.bind('selectItem', function (item) {
      this.model.set('bins', item.get('val'));
      stackLayoutModel.goToStep(0);
    }, this);

    view.bind('back', function (value) {
      stackLayoutModel.goToStep(0);
    }, this);

    return view;
  },

  _createQuantificationListView: function (stackLayoutModel, opts) {
    var view = new ColumnListView({
      headerTitle: _t('form-components.editors.fill.quantification.title'),
      stackLayoutModel: stackLayoutModel,
      itemTemplate: quantificationMethodItemTemplate,
      columns: this._settings.quantifications.items,
      showSearch: false
    });

    view.bind('selectItem', function (item) {
      this.model.set('quantification', item.get('val'));
      stackLayoutModel.prevStep();
    }, this);

    view.bind('back', function (value) {
      stackLayoutModel.goToStep(0);
    }, this);

    return view;
  },

  _getDefaultRamp: function () {
    return _.map(rampList, function (ramp) {
      return ramp[this.model.get('bins')];
    }, this)[0];
  },

  _onChangeQuantification: function () {
    if (this.model.get('quantification') === 'category') {
      this.trigger('switch', this);
    }
  },

  remove: function () {
    CoreView.prototype.remove.apply(this);
  }
});

},{"../../../../../../components/stack-layout/stack-layout-view":274,"../../column-list-view":71,"../../default-fill-settings.json":73,"../quantification-method-item.tpl":131,"./input-ramp-content-view":125,"backbone":"backbone","backbone/core-view":454,"cartocolor":"cartocolor","underscore":"underscore"}],125:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var InputRampListView = require('./input-ramp-list-view');
var StackLayoutView = require('../../../../../../components/stack-layout/stack-layout-view');
var InputColorPickerView = require('../input-color-picker/input-color-picker-view');

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_onClickBack'
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initViews: function () {
    var self = this;

    var stackViewCollection = new Backbone.Collection([{
      createStackView: function (stackLayoutModel, opts) {
        return self._createInputRampListView(stackLayoutModel, opts).bind(self);
      }
    }, {
      createStackView: function (stackLayoutModel, opts) {
        return self._createColorPickerView(stackLayoutModel, opts).bind(self);
      }
    }]);

    this._stackLayoutView = new StackLayoutView({
      collection: stackViewCollection
    });

    this.$el.append(this._stackLayoutView.render().$el);
    this.addView(this._stackLayoutView);
  },

  _createColorPickerView: function (stackLayoutModel, opts) {
    var range = _.map(this.model.get('range'), function (color, i) {
      return {
        val: color,
        color: color,
        title: this.model.get('attribute')
      };
    }, this);

    var opacity = (typeof this.model.get('opacity') !== 'undefined') ? this.model.get('opacity') : 1;

    var view = new InputColorPickerView({
      index: 0,
      ramp: range,
      opacity: opacity
    });

    view.bind('back', function (value) {
      stackLayoutModel.prevStep();
    }, this);

    view.bind('change', this._updateRange, this);
    view.bind('change:opacity', function (opacity) {
      this.model.set('opacity', opacity);
    }, this);

    return view;
  },

  _createInputRampListView: function (stackLayoutModel, opts) {
    var view = new InputRampListView({
      model: this.model,
      showSearch: this.options.showSearch || false,
      typeLabel: this.options.typeLabel
    });

    view.bind('customize', function (value) {
      stackLayoutModel.nextStep();
    }, this);

    view.bind('change_ramp', this._updateRamp, this);
    view.bind('change', this._updateRange, this);

    view.bind('back', function (value) {
      this.trigger('back', this);
    }, this);

    view.bind('switch', function (value) {
      this.trigger('switch', this);
    }, this);

    view.bind('selectItem', function (item) {
      this.trigger('selectItem', item.get('val'), this);
    }, this);

    view.bind('selectBins', function (item) {
      this.trigger('selectBins', this);
    }, this);

    view.bind('selectQuantification', function (item) {
      this.trigger('selectQuantification', this);
    }, this);

    return view;
  },

  _updateRamp: function (ramp) {
    this.model.set('range', ramp);
  },

  _updateRange: function (categories) {
    this.model.set('range', _.pluck(categories, 'color'));
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.trigger('back', this);
  }
});


},{"../../../../../../components/stack-layout/stack-layout-view":274,"../input-color-picker/input-color-picker-view":118,"./input-ramp-list-view":129,"backbone":"backbone","backbone/core-view":454,"underscore":"underscore"}],126:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeader">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="InputColor-modalHeader CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <div class="u-flex u-alignStart u-ellipsis">\n        <button class="u-rSpace u-actionTextColor js-back">\n          <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n        </button>\n        <div class="u-ellipsis">\n          '+
((__t=( attribute ))==null?'':_.escape(__t))+
'\n        </div>\n      </div>\n    </li>\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <ul class="u-flex u-justifySpace">\n        <li class="u-flex">\n          '+
((__t=( bins ))==null?'':_.escape(__t))+
' '+
((__t=( _t('form-components.editors.fill.input-ramp.buckets', { smart_count: bins }) ))==null?'':_.escape(__t))+
'\n          <button class="CDB-Shape u-lSpace js-bins">\n            <div class="CDB-Shape-threePoints is-horizontal is-blue is-small">\n              <div class="CDB-Shape-threePointsItem"></div>\n              <div class="CDB-Shape-threePointsItem"></div>\n              <div class="CDB-Shape-threePointsItem"></div>\n            </div>\n          </button>\n        </li>\n        <li class="u-flex">\n          '+
((__t=( _t('form-components.editors.fill.quantification.methods.' + quantification) ))==null?'':_.escape(__t))+
'\n          <button class="CDB-Shape u-lSpace js-quantification">\n            <div class="CDB-Shape-threePoints is-horizontal is-blue is-small">\n              <div class="CDB-Shape-threePointsItem"></div>\n              <div class="CDB-Shape-threePointsItem"></div>\n              <div class="CDB-Shape-threePointsItem"></div>\n            </div>\n          </button>\n        </li>\n      </ul>\n    </li>\n  </ul>\n</div>\n<div class="js-content"></div>\n<div class="CDB-Text CDB-Size-medium CustomRamp-list CustomList-listWrapper">\n  <ul class="CustomList-list js-customList">\n    <li class="CDB-ListDecoration-item CustomList-item CustomList-item--add">\n      <button class="CDB-ListDecoration-itemLink js-listItemLink js-customize u-actionTextColor">'+
((__t=( _t('form-components.editors.fill.customize') ))==null?'':_.escape(__t))+
'</button>\n    </li>\n  </ul>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],127:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ColorBarWrapper--withInvertLink CDB-ListDecoration-itemLink CDB-ListDecoration-itemLink--double js-listItemLink ';
 if (isSelected) { 
__p+=' is-selected ';
 } 
__p+='">\n  <ul class="ColorBarContainer">\n    ';
 _.each(name, function (color) { 
__p+='\n    <li class="ColorBar ColorBar--spaceless" style="background-color: '+
((__t=( color ))==null?'':_.escape(__t))+
';"></li>\n    ';
 }); 
__p+='\n  </ul>\n</div>\n<button class="ColorBar-invertLink js-invert" data-event="invert"></button>\n\n';
}
return __p;
};

},{"underscore":"underscore"}],128:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');

module.exports = CoreView.extend({

  className: 'CDB-ListDecoration-item CustomList-item CustomList-item--invert js-listItem',
  tagName: 'li',

  events: {
    'mouseenter': '_onMouseEnter',
    'mouseleave': '_onMouseLeave',
    'click .js-listItemLink': '_onClick',
    'click .js-invert': '_onClickInvert'
  },

  initialize: function (opts) {
    this.options = _.extend({}, this.options, opts);
    this.listenTo(this.model, 'change', this.render);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    this.$el.append(
      this.options.template(
        _.extend({
          typeLabel: this.options.typeLabel,
          isSelected: this.model.get('selected'),
          isInverted: this.model.get('inverted'),
          isDisabled: this.model.get('disabled'),
          isDestructive: this.model.get('destructive'),
          name: this.model.getName(),
          val: this.model.getValue(),
          options: this.model.get('renderOptions')
        })
      )
    );

    this.$el
      .attr('data-val', this.model.getValue())
      .toggleClass('is-disabled', !!this.model.get('disabled'))
      .toggleClass('is-selected', !!this.model.get('selected'))
      .toggleClass('is-inverted', !!this.model.get('inverted'));

    return this;
  },

  _onMouseLeave: function () {
    this.$el.removeClass('is-highlighted');
  },

  _onMouseEnter: function () {
    this.$el.addClass('is-highlighted');
  },

  _onClick: function (ev) {
    this.killEvent(ev);

    if (this.model.get('selected')) {
      this.trigger('customEvent', 'customize', this.model.get('val'), this);
    } else {
      this.model.set('selected', true);
    }
  },

  _onClickInvert: function (e) {
    this.killEvent(e);
    this.model.set('inverted', !this.model.get('inverted'));
    this.trigger('customEvent', 'invert', this.model, this);
  }
});

},{"backbone/core-view":454,"underscore":"underscore"}],129:[function(require,module,exports){
var _ = require('underscore');
var cdb = require('cartodb.js');
var CoreView = require('backbone/core-view');
var CustomListView = require('../../../../../custom-list/custom-view');
var CustomListCollection = require('../../../../../custom-list/custom-list-collection');
var rampItemTemplate = require('./input-ramp-list-item-template.tpl');
var rampItemView = require('./input-ramp-list-item-view');
var customRampTemplate = require('./custom-ramp-template.tpl');
var rampList = require('cartocolor');
var template = require('./input-ramp-content-view.tpl');

var DEFAULT_RAMP_ITEM_COLOR = '#CCCCCC';

module.exports = CoreView.extend({
  events: {
    'click .js-customize': '_onClickCustomize',
    'click .js-clear': '_onClickClear',
    'click .js-customRamp': '_onClickCustomRamp',
    'click .js-back': '_onClickBack',
    'click .js-switch': '_onClickSwitch',
    'click .js-quantification': '_onClickQuantification',
    'click .js-bins': '_onClickBins'
  },

  initialize: function (opts) {
    this._showSearch = opts.showSearch || false;
    this._typeLabel = opts.typeLabel;

    this._initModels();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    this.$el.append(template({
      bins: this.model.get('bins'),
      attribute: this.model.get('attribute'),
      quantification: this.model.get('quantification')
    }));

    this._initViews();

    var customRamp = this._customRamp.get('range');

    this.$('.js-customList').prepend(customRampTemplate({
      customRamp: customRamp
    }));

    if (customRamp) {
      this.$('.js-customList').addClass('is-customized');
    } else {
      var selectedRamp = this.collection.getSelectedItem();

      if (!selectedRamp) {
        selectedRamp = this.collection.first();
      }

      this._selectRamp(selectedRamp);
    }

    return this;
  },

  _initModels: function () {
    this._customRamp = new cdb.core.Model();
    this._setupCollection();
  },

  _initBinds: function () {
    this.listenTo(this.model, 'change:bins', this._onChangeBins);
    this.listenTo(this.model, 'change:attribute_type', this._updateRampOnAttributeChange);
    this.listenTo(this.collection, 'change:selected', this._onSelectItem);
  },

  _initViews: function () {
    this._listView = new CustomListView({
      collection: this.collection,
      showSearch: this._showSearch,
      typeLabel: this._typeLabel,
      itemTemplate: rampItemTemplate,
      itemView: rampItemView
    });

    this._listView.bind('invert', this._invertRamp, this);
    this._listView.bind('customize', function (ramp) {
      this.trigger('customize', ramp, this);
    }, this);

    this.$('.js-content').append(this._listView.render().el);
    this.addView(this._listView);
  },

  _getRamps: function () {
    var attributeType = this.model.get('attribute_type');
    // select only suitable ramps for the data type
    // number -> ramps
    // string -> category
    var rampTypeFromType = {
      number: ['quantitative', 'diverging'],
      string: ['qualitative']
    };
    var ramps = rampList;
    if (rampTypeFromType[attributeType]) {
      ramps = _.filter(ramps, function (r) {
        // ramp without tags is discarded
        if (r.tags) {
          return _.contains(rampTypeFromType[attributeType], r.tags[0]);
        }
        return false;
      });
    }

    ramps = _.map(ramps, function (rampItem, name) {
      var ramp = rampItem[this.model.get('bins')];
      var range = this.model.get('range');
      var isSelected = false;
      var isInverted = false;

      if (ramp && ramp.length && range && range.length) {
        isSelected = ramp.join().toLowerCase() === range.join().toLowerCase();

        if (!isSelected) {
          isSelected = _.clone(ramp).reverse().join().toLowerCase() === range.join().toLowerCase();
          isInverted = isSelected;
        }
      }

      if (!ramp) {
        return null;
      }

      return {
        selected: isSelected,
        inverted: isInverted,
        name: name,
        val: ramp
      };
    }, this);

    return ramps;
  },

  _setupCollection: function () {
    var ramps = this._getRamps();
    this.collection = new CustomListCollection(_.compact(ramps), { silent: false });
    if (!this.collection.getSelectedItem()) {
      this._customRamp.set('range', this.model.get('range'));
    }
  },

  _updateRampOnAttributeChange: function (m, type) {
    var ramps = this._getRamps();
    // Update the ramps when the attribute changes
    this.collection.reset(_.compact(ramps), {silent: true});
    // and delete the custom ramp
    this._customRamp.set('range', false);

    // apply the first ramp
    var first = this.collection.first();
    first && first.set('selected', true);
    this.render();
  },

  _invertRamp: function (item) {
    if (!item) {
      return;
    }

    this._customRamp.set('range', null);
    item.set('selected', false);
    var ramp = [].concat(item.get('val')).reverse();
    item.set({ val: ramp, selected: true });
    this.model.set('range', ramp);
  },

  _selectRamp: function (item) {
    if (!item) {
      return;
    }

    var range = item.get('val');
    // 'manually' select the item to preserve scroll position
    this.$('.js-listItemLink').removeClass('is-selected');
    this.$('.js-listItem[data-val="' + range.join(',') + '"] .js-listItemLink').addClass('is-selected');
  },

  _onClickClear: function (e) {
    this.killEvent(e);

    this._customRamp.set('range', null);

    if (!this.collection.getSelectedItem()) {
      this.collection.first().set('selected', true);
    }

    this.render();
    this._listView.highlight();
  },

  _onClickCustomRamp: function (e) {
    this.killEvent(e);

    if (this.model.get('range') === this._customRamp.get('range')) {
      this.trigger('customize', this.collection.getSelectedItem(), this);
    } else {
      this.model.set('range', this._customRamp.get('range'));
    }

    this.$('.js-listItemLink').removeClass('is-selected');
    this.$('.js-customRamp').addClass('is-selected');
  },

  _onClickCustomize: function (e) {
    this.killEvent(e);
    var ramp = this.collection.getSelectedItem();
    this._customRamp.set('range', ramp);
    this.trigger('customize', ramp, this);
  },

  _onChangeBins: function () {
    var customRange = this._customRamp.get('range');

    if (customRange) {
      if (this.model.get('bins') > customRange.length) {
        customRange = _.range(this.model.get('bins')).map(function (i) {
          return i >= customRange.length ? DEFAULT_RAMP_ITEM_COLOR : customRange[i];
        });
      } else {
        customRange = customRange.slice(0, this.model.get('bins'));
      }

      this.model.set('range', customRange);
      this._customRamp.set('range', customRange);
    }
  },

  _onSelectItem: function (item) {
    this._selectRamp(item);
    this.trigger('selectItem', item, this);
  },

  _onClickSwitch: function (e) {
    this.killEvent(e);
    this.trigger('switch', this);
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.trigger('back', this);
  },

  _onClickQuantification: function (e) {
    this.killEvent(e);
    this.trigger('selectQuantification', this);
  },

  _onClickBins: function (e) {
    this.killEvent(e);
    this.trigger('selectBins', this);
  }
});

},{"../../../../../custom-list/custom-list-collection":23,"../../../../../custom-list/custom-view":35,"./custom-ramp-template.tpl":123,"./input-ramp-content-view.tpl":126,"./input-ramp-list-item-template.tpl":127,"./input-ramp-list-item-view":128,"backbone/core-view":454,"cartocolor":"cartocolor","cartodb.js":"cartodb.js","underscore":"underscore"}],130:[function(require,module,exports){
module.exports = {
  green: {
    '3': ['#E5F5F9', '#99D8C9', '#2CA25F'],
    '4': ['#EDF8FB', '#B2E2E2', '#66C2A4', '#238B45'],
    '5': ['#EDF8FB', '#B2E2E2', '#66C2A4', '#2CA25F', '#006D2C'],
    '6': ['#EDF8FB', '#CCECE6', '#99D8C9', '#66C2A4', '#2CA25F', '#006D2C'],
    '7': ['#EDF8FB', '#D7FAF4', '#CCECE6', '#66C2A4', '#41AE76', '#238B45', '#005824']
  },
  blue: {
    '3': ['#EDF8B1', '#7FCDBB', '#2C7FB8'],
    '4': ['#FFFFCC', '#A1DAB4', '#41B6C4', '#225EA8'],
    '5': ['#FFFFCC', '#A1DAB4', '#41B6C4', '#2C7FB8', '#253494'],
    '6': ['#FFFFCC', '#C7E9B4', '#7FCDBB', '#41B6C4', '#2C7FB8', '#253494'],
    '7': ['#FFFFCC', '#C7E9B4', '#7FCDBB', '#41B6C4', '#1D91C0', '#225EA8', '#0C2C84']
  },
  pink: {
    '3': ['#E7E1EF', '#C994C7', '#DD1C77'],
    '4': ['#F1EEF6', '#D7B5D8', '#DF65B0', '#CE1256'],
    '5': ['#F1EEF6', '#D7B5D8', '#DF65B0', '#DD1C77', '#980043'],
    '6': ['#F1EEF6', '#D4B9DA', '#C994C7', '#DF65B0', '#DD1C77', '#980043'],
    '7': ['#F1EEF6', '#D4B9DA', '#C994C7', '#DF65B0', '#E7298A', '#CE1256', '#91003F']
  },
  black: {
    '3': ['#F0F0F0', '#BDBDBD', '#636363'],
    '4': ['#F7F7F7', '#CCCCCC', '#969696', '#525252'],
    '5': ['#F7F7F7', '#CCCCCC', '#969696', '#636363', '#252525'],
    '6': ['#F7F7F7', '#D9D9D9', '#BDBDBD', '#969696', '#636363', '#252525'],
    '7': ['#F7F7F7', '#D9D9D9', '#BDBDBD', '#969696', '#737373', '#525252', '#252525']
  },
  red: {
    '3': ['#FFEDA0', '#FEB24C', '#F03B20'],
    '4': ['#FFFFB2', '#FECC5C', '#FD8D3C', '#E31A1C'],
    '5': ['#FFFFB2', '#FECC5C', '#FD8D3C', '#F03B20', '#BD0026'],
    '6': ['#FFFFB2', '#FED976', '#FEB24C', '#FD8D3C', '#F03B20', '#BD0026'],
    '7': ['#FFFFB2', '#FED976', '#FEB24C', '#FD8D3C', '#FC4E2A', '#E31A1C', '#B10026']
  },
  inverted_green: {
    '3': ['#2CA25F', '#99D8C9', '#E5F5F9'],
    '4': ['#238B45', '#66C2A4', '#B2E2E2', '#EDF8FB'],
    '5': ['#006D2C', '#2CA25F', '#66C2A4', '#B2E2E2', '#EDF8FB'],
    '6': ['#006D2C', '#2CA25F', '#66C2A4', '#99D8C9', '#CCECE6', '#EDF8FB'],
    '7': ['#005824', '#238B45', '#41AE76', '#66C2A4', '#CCECE6', '#D7FAF4', '#EDF8FB']
  },
  inverted_blue: {
    '3': ['#2C7FB8', '#7FCDBB', '#EDF8B1'],
    '4': ['#225EA8', '#41B6C4', '#A1DAB4', '#FFFFCC'],
    '5': ['#253494', '#2C7FB8', '#41B6C4', '#A1DAB4', '#FFFFCC'],
    '6': ['#253494', '#2C7FB8', '#41B6C4', '#7FCDBB', '#C7E9B4', '#FFFFCC'],
    '7': ['#0C2C84', '#225EA8', '#1D91C0', '#41B6C4', '#7FCDBB', '#C7E9B4', '#FFFFCC']
  },
  inverted_pink: {
    '3': ['#DD1C77', '#C994C7', '#E7E1EF'],
    '4': ['#CE1256', '#DF65B0', '#D7B5D8', '#F1EEF6'],
    '5': ['#980043', '#DD1C77', '#DF65B0', '#D7B5D8', '#F1EEF6'],
    '6': ['#980043', '#DD1C77', '#DF65B0', '#C994C7', '#D4B9DA', '#F1EEF6'],
    '7': ['#91003F', '#CE1256', '#E7298A', '#DF65B0', '#C994C7', '#D4B9DA', '#F1EEF6']
  },
  inverted_black: {
    '3': ['#636363', '#BDBDBD', '#F0F0F0'],
    '4': ['#525252', '#969696', '#CCCCCC', '#F7F7F7'],
    '5': ['#252525', '#636363', '#969696', '#CCCCCC', '#F7F7F7'],
    '6': ['#252525', '#636363', '#969696', '#BDBDBD', '#D9D9D9', '#F7F7F7'],
    '7': ['#252525', '#525252', '#737373', '#969696', '#BDBDBD', '#D9D9D9', '#F7F7F7']
  },
  inverted_red: {
    '3': ['#F03B20', '#FEB24C', '#FFEDA0'],
    '4': ['#E31A1C', '#FD8D3C', '#FECC5C', '#FFFFB2'],
    '5': ['#BD0026', '#F03B20', '#FD8D3C', '#FECC5C', '#FFFFB2'],
    '6': ['#BD0026', '#F03B20', '#FD8D3C', '#FEB24C', '#FED976', '#FFFFB2'],
    '7': ['#B10026', '#E31A1C', '#FC4E2A', '#FD8D3C', '#FEB24C', '#FED976', '#FFFFB2']
  },
  spectrum1: {
    '3': ['#1a9850', '#fff2cc', '#d73027'],
    '4': ['#1a9850', '#d2ecb4', '#fed6b0', '#d73027'],
    '5': ['#1a9850', '#8cce8a', '#fff2cc', '#f79272', '#d73027'],
    '6': ['#1a9850', '#8cce8a', '#d2ecb4', '#fed6b0', '#f79272', '#d73027'],
    '7': ['#1a9850', '#8cce8a', '#d2ecb4', '#fff2cc', '#fed6b0', '#f79272', '#d73027']
  },
  spectrum2: {
    '3': ['#0080ff', '#fff2cc', '#ff4d4d'],
    '4': ['#0080ff', '#7fbfff', '#ffa6a6', '#ff4d4d'],
    '5': ['#0080ff', '#40a0ff', '#fff2cc', '#ff7a7a', '#ff4d4d'],
    '6': ['#0080ff', '#40a0ff', '#7fbfff', '#ffa6a6', '#ff7a7a', '#ff4d4d'],
    '7': ['#0080ff', '#40a0ff', '#7fbfff', '#fff2cc', '#ffa6a6', '#ff7a7a', '#ff4d4d']
  },
  purple_states: {
    '3': ['#F1E6F1', '#B379B3', '#8A4E8A'],
    '4': ['#F1E6F1', '#D8BBD8', '#A05AA0', '#8A4E8A'],
    '5': ['#F1E6F1', '#D8BBD8', '#B379B3', '#A05AA0', '#8A4E8A'],
    '6': ['#F1E6F1', '#D8BBD8', '#CCA5CC', '#B379B3', '#A05AA0', '#8A4E8A'],
    '7': ['#F1E6F1', '#D8BBD8', '#CCA5CC', '#C08FC0', '#B379B3', '#A05AA0', '#8A4E8A']
  },
  red_states: {
    '3': ['#F2D2D3', '#D4686C', '#C1373C'],
    '4': ['#F2D2D3', '#EBB7B9', '#CC4E52', '#C1373C'],
    '5': ['#F2D2D3', '#EBB7B9', '#D4686C', '#CC4E52', '#C1373C'],
    '6': ['#F2D2D3', '#EBB7B9', '#E39D9F', '#D4686C', '#CC4E52', '#C1373C'],
    '7': ['#F2D2D3', '#EBB7B9', '#E39D9F', '#DB8286', '#D4686C', '#CC4E52', '#C1373C']
  },
  blue_states: {
    '3': ['#ECF0F6', '#6182B5', '#43618F'],
    '4': ['#ECF0F6', '#B2C2DB', '#4E71A6', '#43618F'],
    '5': ['#ECF0F6', '#B2C2DB', '#6182B5', '#4E71A6', '#43618F'],
    '6': ['#ECF0F6', '#B2C2DB', '#9BB0D0', '#6182B5', '#4E71A6', '#43618F'],
    '7': ['#ECF0F6', '#B2C2DB', '#9BB0D0', '#849EC5', '#6182B5', '#4E71A6', '#43618F']
  },
  inverted_purple_states: {
    '3': ['#8A4E8A', '#B379B3', '#F1E6F1'],
    '4': ['#8A4E8A', '#A05AA0', '#D8BBD8', '#F1E6F1'],
    '5': ['#8A4E8A', '#A05AA0', '#B379B3', '#D8BBD8', '#F1E6F1'],
    '6': ['#8A4E8A', '#A05AA0', '#B379B3', '#CCA5CC', '#D8BBD8', '#F1E6F1'],
    '7': ['#8A4E8A', '#A05AA0', '#B379B3', '#C08FC0', '#CCA5CC', '#D8BBD8', '#F1E6F1']
  },
  inverted_red_states: {
    '3': ['#C1373C', '#D4686C', '#F2D2D3'],
    '4': ['#C1373C', '#CC4E52', '#EBB7B9', '#F2D2D3'],
    '5': ['#C1373C', '#CC4E52', '#D4686C', '#EBB7B9', '#F2D2D3'],
    '6': ['#C1373C', '#CC4E52', '#D4686C', '#E39D9F', '#EBB7B9', '#F2D2D3'],
    '7': ['#C1373C', '#CC4E52', '#D4686C', '#DB8286', '#E39D9F', '#EBB7B9', '#F2D2D3']
  },
  inverted_blue_states: {
    '3': ['#43618F', '#6182B5', '#ECF0F6'],
    '4': ['#43618F', '#4E71A6', '#B2C2DB', '#ECF0F6'],
    '5': ['#43618F', '#4E71A6', '#6182B5', '#B2C2DB', '#ECF0F6'],
    '6': ['#43618F', '#4E71A6', '#6182B5', '#9BB0D0', '#B2C2DB', '#ECF0F6'],
    '7': ['#43618F', '#4E71A6', '#6182B5', '#849EC5', '#9BB0D0', '#B2C2DB', '#ECF0F6']
  }
};

},{}],131:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-ListDecoration-itemLink u-flex u-justifySpace u-alignCenter u-actionTextColor ';
 if (isSelected) { 
__p+=' is-selected ';
 } 
__p+='">\n  '+
((__t=( _t('form-components.editors.fill.quantification.methods.' + name) ))==null?'':_.escape(__t))+
'\n</div>\n\n';
}
return __p;
};

},{"underscore":"underscore"}],132:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var template = require('./input-number-value-content-view.tpl');

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_onClickBack',
    'click .js-bins': '_onClickBins',
    'click .js-quantification': '_onClickQuantification'
  },

  render: function () {
    this.clearSubViews();
    this._removeForm();
    this.$el.empty();

    this.$el.append(template({
      bins: this.model.get('bins'),
      attribute: this.model.get('attribute'),
      quantification: this.model.get('quantification')
    }));

    this._initForm();

    return this;
  },

  _calculateRangeFromFixed: function (fixed, percent) {
    percent = percent || 30;

    var span = this.options.max - this.options.min;
    var delta = fixed / span;

    return [
      Math.floor(Math.max(this.options.min, fixed - percent * delta)),
      Math.floor(Math.min(this.options.max, fixed + percent * delta))
    ];
  },

  _initForm: function () {
    var self = this;

    if (this._formView) {
      this._formView.remove();
    }

    // when range min === max means we come from a fixed value
    // calculate the range values based on this
    var range = this.model.get('range');
    var min, max;

    min = max = this.model.get('fixed');

    if (range) {
      min = +range[0];
      max = +range[1];
    }

    if (min === max) {
      var r = this._calculateRangeFromFixed(min);
      // set the range so changes are propagated
      min = r[0];
      max = r[1];
      this.model.set('range', r);
    }

    this._formModel = new Backbone.Model({
      min: min,
      max: max
    });

    this._formModel.schema = {
      min: {
        type: 'Number',
        validators: ['required', {
          type: 'interval',
          min: self.options.min,
          max: self.options.max
        }]
      },
      max: {
        type: 'Number',
        validators: ['required', {
          type: 'interval',
          min: self.options.min,
          max: self.options.max
        }]
      }
    };

    this._formModel.bind('change', function (input) {
      this.model.set('range', [(+input.get('min')), (+input.get('max'))]);
    }, this);

    this._formView = new Backbone.Form({
      className: 'Editor-boxList',
      model: this._formModel
    });

    this._formView.bind('change', function () {
      this.commit();
    });

    this.$('.js-content').append(this._formView.render().$el);
  },

  _removeForm: function () {
    // Backbone.Form removes the view with the following method
    this._formView && this._formView.remove();
  },

  _onClickBack: function (e) {
    this.killEvent(e);
    this.trigger('back', this);
  },

  _onClickQuantification: function (e) {
    this.killEvent(e);
    this.trigger('selectQuantification', this);
  },

  _onClickBins: function (e) {
    this.killEvent(e);
    this.trigger('selectBins', this);
  },

  clean: function () {
    this._removeForm();
    CoreView.prototype.clean.call(this);
  }
});

},{"./input-number-value-content-view.tpl":136,"backbone":"backbone","backbone/core-view":454}],133:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var tabPaneTemplate = require('../fill-tab-pane.tpl');
var createTextLabelsTabPane = require('../../../../../components/tab-pane/create-text-labels-tab-pane');
var InputNumberFixedContentView = require('./input-number-fixed-content-view');
var InputNumberValueContentView = require('./input-number-value-content-view');

var DEFAULT_INPUT_MIN_VALUE = 0;
var DEFAULT_INPUT_MAX_VALUE = 100;
var DEFAULT_INPUT_STEP_VALUE = 1;

module.exports = CoreView.extend({
  initialize: function (opts) {
    if (!opts.columns) throw new Error('columns param is required');
    this._columns = opts.columns;

    this.listenTo(this.model, 'change:attribute', this._updateRangeValue);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initViews: function () {
    var self = this;

    var fixedPane = {
      name: 'fixed',
      label: _t('form-components.editors.fill.input-number.fixed'),
      createContentView: function () {
        return self._generateFixedContentView();
      }
    };

    var valuePane = {
      name: 'value',
      label: _t('form-components.editors.fill.input-number.value'),
      createContentView: function () {
        return self._generateValueContentView();
      }
    };

    this._tabPaneTabs = [];

    if (this.options.editorAttrs && this.options.editorAttrs.hidePanes) {
      var hidePanes = this.options.editorAttrs.hidePanes;
      if (!_.contains(hidePanes, 'fixed')) {
        this._tabPaneTabs.push(fixedPane);
      }
      if (!_.contains(hidePanes, 'value')) {
        this._tabPaneTabs.push(valuePane);
      }
    } else {
      this._tabPaneTabs = [fixedPane, valuePane];
    }

    var tabPaneOptions = {
      tabPaneOptions: {
        template: tabPaneTemplate,
        tabPaneItemOptions: {
          tagName: 'li',
          className: 'CDB-NavMenu-item'
        }
      },
      tabPaneItemLabelOptions: {
        tagName: 'button',
        className: 'CDB-NavMenu-link u-upperCase'
      }
    };

    if (this.model.get('range') && this._tabPaneTabs.length > 1) {
      this._tabPaneTabs[1].selected = true;
    }

    this._tabPaneView = createTextLabelsTabPane(this._tabPaneTabs, tabPaneOptions);
    this.listenTo(this._tabPaneView.collection, 'change:selected', this._onChangeTabPaneViewTab);
    this.addView(this._tabPaneView);
    this.$el.append(this._tabPaneView.render().$el);
  },

  _onChangeTabPaneViewTab: function () {
    var selectedTabPaneName = this._tabPaneView.getSelectedTabPaneName();

    if (selectedTabPaneName === 'fixed') {
      this._updateFixedValue();
    } else {
      this._updateRangeValue();
    }

    this.trigger('change', selectedTabPaneName, this);
  },

  _updateFixedValue: function () {
    if (this.model.get('range')) {
      // when coming from range calculate the average
      var r = this.model.get('range');
      var avg = 0.5 * (+r[0] + +r[1]);
      this.model.set('fixed', avg);
      this.model.unset('range');
    }
  },

  _updateRangeValue: function () {
    if (this.model.get('fixed') !== null && this.model.get('fixed') !== undefined && this.model.get('attribute')) {
      this.model.set('range', [this.model.get('fixed'), this.model.get('fixed')]);
      this.model.unset('fixed');
    }
  },

  _generateFixedContentView: function () {
    var editorAttrs = this.options.editorAttrs;
    return new InputNumberFixedContentView({
      model: this.model,
      min: (editorAttrs && editorAttrs.min) || DEFAULT_INPUT_MIN_VALUE,
      max: (editorAttrs && editorAttrs.max) || DEFAULT_INPUT_MAX_VALUE,
      step: (editorAttrs && editorAttrs.step) || DEFAULT_INPUT_STEP_VALUE
    });
  },

  _generateValueContentView: function () {
    var editorAttrs = this.options.editorAttrs;
    return new InputNumberValueContentView({
      model: this.model,
      columns: this._columns,
      min: (editorAttrs && editorAttrs.min) || DEFAULT_INPUT_MIN_VALUE,
      max: (editorAttrs && editorAttrs.max) || DEFAULT_INPUT_MAX_VALUE
    });
  },

  _onChangeValue: function (input) {
    this.model.set('fixed', input.value);
  }
});

},{"../../../../../components/tab-pane/create-text-labels-tab-pane":276,"../fill-tab-pane.tpl":76,"./input-number-fixed-content-view":134,"./input-number-value-content-view":135,"backbone/core-view":454,"underscore":"underscore"}],134:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');

module.exports = CoreView.extend({
  render: function () {
    this.clearSubViews();
    this._removeForm();
    this.$el.empty();
    this._initForm();
    return this;
  },

  _initForm: function () {
    this._formModel = new Backbone.Model({
      value: this.model.get('fixed')
    });

    this._formModel.schema = {
      value: {
        type: 'Number',
        validators: ['required', {
          type: 'interval',
          min: this.options.min,
          max: this.options.max,
          step: this.options.step
        }]
      }
    };

    this._formModel.bind('change', function (input) {
      this.model.set('fixed', input.get('value'));
    }, this);

    this._formView = new Backbone.Form({
      className: 'CDB-ListDecoration-itemPadding',
      model: this._formModel
    });

    this._formView.bind('change', function () {
      this.commit();
    });

    this.$el.append(this._formView.render().$el);
  },

  _removeForm: function () {
    // Backbone.Form removes the view with the following method
    this._formView && this._formView.remove();
  },

  clean: function () {
    this._removeForm();
    CoreView.prototype.clean.call(this);
  }
});

},{"backbone":"backbone","backbone/core-view":454}],135:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var StackLayoutView = require('../../../../../components/stack-layout/stack-layout-view');
var ColumnListView = require('../column-list-view');
var quantificationMethodItemTemplate = require('./quantification-method-item.tpl');
var InputNumberContentView = require('./input-number-content-view');
var DefaultFillSettings = require('../default-fill-settings.json');

/**
 * add the number of classes
 * change the max depending on the min
 * smaller values on top
 */
var COLUMN_PANE_INDEX = 0;
var MAIN_PAIN_INDEX = 1;
var QUANTIFICATION_PANE_INDEX = 2;

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_onClickBack'
  },

  initialize: function (opts) {
    if (!opts.columns) throw new Error('columns param is required');
    this._columns = opts.columns;

    this._settings = DefaultFillSettings.number;

    this._setupModel();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _setupModel: function () {
    var options = {};

    if (!this.model.get('quantification')) {
      options.quantification = this._settings.quantifications.items[this._settings.quantifications.defaultIndex];
    }

    if (!this.model.get('bins')) {
      options.bins = this._settings.bins.items[this._settings.bins.defaultIndex];
    }

    if (+this.model.get('bins') > +this._settings.bins.items[this._settings.bins.items.length - 1]) {
      options.bins = this._settings.bins.items[this._settings.bins.items.length - 1];
    }

    this.model.set(options);
  },

  _initViews: function () {
    var self = this;

    var stackViewCollection = new Backbone.Collection([{
      createStackView: function (stackLayoutModel, opts) {
        return self._createInputRampContentView(stackLayoutModel, opts).bind(self);
      }
    }, {
      createStackView: function (stackLayoutModel, opts) {
        return self._createInputNumberContentView(stackLayoutModel, opts).bind(self);
      }
    }, {
      createStackView: function (stackLayoutModel, opts) {
        return self._createQuantificationListView(stackLayoutModel, opts).bind(self);
      }
    }, {
      createStackView: function (stackLayoutModel, opts) {
        return self._createBinsListView(stackLayoutModel, opts).bind(self);
      }
    }]);

    this._stackLayoutView = new StackLayoutView({
      collection: stackViewCollection
    });

    var position = MAIN_PAIN_INDEX;

    if (!this.model.get('attribute')) {
      position = COLUMN_PANE_INDEX;
    } else if (!this.model.get('quantification')) {
      position = QUANTIFICATION_PANE_INDEX;
    }

    this._stackLayoutView.model.set('position', position);
    this.$el.append(this._stackLayoutView.render().$el);
    this.addView(this._stackLayoutView);
  },

  _createInputRampContentView: function (stackLayoutModel, opts) {
    var view = new ColumnListView({
      stackLayoutModel: stackLayoutModel,
      columns: this._columns.filter(function (f) {
        return f.type === 'number';
      }),
      showSearch: true,
      typeLabel: 'column'
    });

    view.bind('selectItem', function (item) {
      this.model.set('attribute', item.get('val'));
      var step = MAIN_PAIN_INDEX;
      if (!this.model.get('quantification')) {
        step = QUANTIFICATION_PANE_INDEX;
      }
      this._stackLayoutView.model.goToStep(step);
    }, this);

    return view;
  },

  _createInputNumberContentView: function (stackLayoutModel, opts) {
    var view = new InputNumberContentView({
      stackLayoutModel: stackLayoutModel,
      model: this.model,
      min: this.options.min,
      max: this.options.max
    });

    view.bind('back', function (value) {
      stackLayoutModel.prevStep();
    }, this);

    view.bind('selectQuantification', function (value) {
      stackLayoutModel.goToStep(2);
    }, this);

    view.bind('selectBins', function (value) {
      stackLayoutModel.goToStep(3);
    }, this);

    return view;
  },

  _createQuantificationListView: function (stackLayoutModel, opts) {
    var view = new ColumnListView({
      headerTitle: _t('form-components.editors.fill.quantification.title'),
      stackLayoutModel: stackLayoutModel,
      columns: this._settings.quantifications.items,
      itemTemplate: quantificationMethodItemTemplate,
      showSearch: false
    });

    view.bind('selectItem', function (item) {
      this.model.set('quantification', item.get('val'));
      stackLayoutModel.prevStep();
    }, this);

    view.bind('back', function (value) {
      stackLayoutModel.prevStep();
    }, this);

    return view;
  },

  _createBinsListView: function (stackLayoutModel, opts) {
    var view = new ColumnListView({
      headerTitle: _t('form-components.editors.fill.bins'),
      stackLayoutModel: stackLayoutModel,
      columns: this._settings.bins.items
    });

    view.bind('selectItem', function (item) {
      this.model.set('bins', item.get('val'));
      stackLayoutModel.goToStep(1);
    }, this);

    view.bind('back', function (value) {
      stackLayoutModel.goToStep(1);
    }, this);

    return view;
  },

  _onClickBack: function (e) {
    this.killEvent(e);
  }
});

},{"../../../../../components/stack-layout/stack-layout-view":274,"../column-list-view":71,"../default-fill-settings.json":73,"./input-number-content-view":132,"./quantification-method-item.tpl":139,"backbone":"backbone","backbone/core-view":454}],136:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeader">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="InputColor-modalHeader CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <div class="u-flex u-alignStart u-ellipsis">\n        <button class="u-rSpace u-actionTextColor js-back">\n          <i class="CDB-IconFont CDB-IconFont-arrowPrev Size-large"></i>\n        </button>\n        <div class="u-ellipsis">\n          '+
((__t=( attribute ))==null?'':_.escape(__t))+
'\n        </div>\n      </div>\n    </li>\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical CDB-Text CDB-Size-medium u-secondaryTextColor">\n      <ul class="u-flex u-justifySpace">\n        <li class="u-flex">\n          '+
((__t=( bins ))==null?'':_.escape(__t))+
' '+
((__t=( _t('form-components.editors.fill.input-ramp.buckets', { smart_count: bins }) ))==null?'':_.escape(__t))+
'\n          <button class="CDB-Shape u-lSpace js-bins">\n            <div class="CDB-Shape-threePoints is-horizontal is-blue is-small">\n              <div class="CDB-Shape-threePointsItem"></div>\n              <div class="CDB-Shape-threePointsItem"></div>\n              <div class="CDB-Shape-threePointsItem"></div>\n            </div>\n          </button>\n        </li>\n        <li class="u-flex">\n          '+
((__t=( _t('form-components.editors.fill.quantification.methods.' + quantification) ))==null?'':_.escape(__t))+
'\n          <button class="CDB-Shape u-lSpace js-quantification">\n            <div class="CDB-Shape-threePoints is-horizontal is-blue is-small">\n              <div class="CDB-Shape-threePointsItem"></div>\n              <div class="CDB-Shape-threePointsItem"></div>\n              <div class="CDB-Shape-threePointsItem"></div>\n            </div>\n          </button>\n        </li>\n      </ul>\n    </li>\n  </ul>\n</div>\n<div class="js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],137:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./input-number.tpl');
var InputDialogContent = require('./input-number-dialog-content');

module.exports = CoreView.extend({
  tagName: 'li',
  className: 'CDB-OptionInput-item',

  events: {
    'click': '_onClick'
  },

  initialize: function (opts) {
    if (!opts.columns) throw new Error('columns is required');
    this._columns = opts.columns;

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    if (this.options.disabled) {
      this.$el.addClass('is-disabled');
    }

    this.$el.html(template({
      value: this._getValue()
    }));

    return this;
  },

  _createContentView: function () {
    var view = new InputDialogContent({
      model: this.model,
      columns: this._columns,
      editorAttrs: this.options.editorAttrs
    });

    view.bind('change', this.render, this);

    return view;
  },

  _onClick: function (e) {
    if (this.options.disabled) {
      return;
    }
    this.trigger('click', this.model);
  },

  _initBinds: function () {
    this.model.set('createContentView', function () {
      return this._createContentView();
    }.bind(this));

    this.listenTo(this.model, 'change:selected', this._onToggleSelected);
    this.listenTo(this.model, 'change:fixed', this._onChangeValue);
    this.listenTo(this.model, 'change:range', this._onChangeValue);
  },

  _getValue: function () {
    // 1.0 -> 1
    function dropDecimal (f) {
      return f.replace(/\.0$/, '');
    }

    if (this.model.get('range')) {
      return this.model.get('range').map(function (v) {
        return dropDecimal((+v).toFixed(1));
      }).join('..');
    }
    return dropDecimal((+this.model.get('fixed')).toFixed(1));
  },

  _onChangeValue: function () {
    this.$('.js-value').text(this._getValue());
  },

  _onToggleSelected: function () {
    this.$el.toggleClass('is-active', this.model.get('selected'));
  }
});

},{"./input-number-dialog-content":133,"./input-number.tpl":138,"backbone/core-view":454}],138:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button type="button" class="CDB-OptionInput-content js-value">'+
((__t=( value ))==null?'':_.escape(__t))+
'</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],139:[function(require,module,exports){
arguments[4][131][0].apply(exports,arguments)
},{"dup":131,"underscore":"underscore"}],140:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');

Backbone.Form.editors.List.CategoryModel = Backbone.Form.editors.NestedModel.extend({

  initialize: function (options) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, options);
    EditorHelpers.setOptions(this, options);

    if (!this.form) throw new Error('Missing required option "form"');
    if (!options.schema.model) throw new Error('Missing required "schema.model" option for NestedModel editor');
  },

  render: function () {
    // Get the constructor for creating the nested form; i.e. the same constructor as used by the parent form
    var NestedForm = this.form.constructor;

    var data = this.value || {};
    var NestedModel = this.schema.model;

    // Wrap the data in a model if it isn't already a model instance
    var modelInstance = (data.constructor === NestedModel) ? data : new NestedModel(data, this.options);

    this.nestedForm = new NestedForm({
      model: modelInstance,
      idPrefix: this.id + '_',
      fieldTemplate: 'nestedField'
    });

    this._observeFormEvents();

    // Render form
    this.$el.html(this.nestedForm.render().el);

    if (this.hasFocus) this.trigger('blur', this);

    return this;
  }

});

},{"../editor-helpers-extend":62,"backbone":"backbone"}],141:[function(require,module,exports){
var Backbone = require('backbone');
var $ = require('jquery');
var _ = require('underscore');

/**
 * A single item in the list
 *
 * @param {editors.List} options.list The List editor instance this item belongs to
 * @param {Function} options.Editor   Editor constructor function
 * @param {String} options.key        Model key
 * @param {Mixed} options.value       Value
 * @param {Object} options.schema     Field schema
 */
Backbone.Form.editors.List.Item = Backbone.Form.editors.Base.extend({

  events: {
    'click [data-action="remove"]': function (event) {
      event.preventDefault();
      this.list.removeItem(this);
    },
    'keydown input[type=text]': function (event) {
      if (event.keyCode !== 13) return;
      event.preventDefault();
      this.list.addItem();
      this.list.$list.find('> li:last input').focus();
    }
  },

  initialize: function (options) {
    this.list = options.list;
    this.schema = options.schema || this.list.schema;
    this.value = options.value;
    this.Editor = options.Editor || Backbone.Form.editors.Text;
    this.key = options.key;
    this.template = options.template || this.schema.itemTemplate || this.constructor.template;
    this.errorClassName = options.errorClassName || this.constructor.errorClassName;
    this.form = options.form;
    this.userModel = options.userModel;
    this.configModel = options.configModel;
    this.modals = options.modals;
  },

  render: function () {
    // Create editor
    this.editor = new this.Editor({
      key: this.key,
      schema: this.schema,
      value: this.value,
      list: this.list,
      item: this,
      form: this.form
    }, {
      userModel: this.userModel,
      configModel: this.configModel,
      modals: this.modals
    }).render();

    // Create main element
    var $el = $($.trim(this.template()));

    $el.find('[data-editor]').append(this.editor.el);

    // Replace the entire element so there isn't a wrapper tag
    this.setElement($el);

    return this;
  },

  getValue: function () {
    return this.editor.getValue();
  },

  setValue: function (value) {
    this.editor.setValue(value);
  },

  focus: function () {
    this.editor.focus();
  },

  blur: function () {
    this.editor.blur();
  },

  remove: function () {
    this.editor.remove();

    Backbone.View.prototype.remove.call(this);
  },

  validate: function () {
    var value = this.getValue();
    var formValues = this.list.form ? this.list.form.getValue() : {};
    var validators = this.schema.validators;
    var getValidator = this.getValidator;

    if (!validators) return null;

    // Run through validators until an error is found
    var error = null;
    _.every(validators, function (validator) {
      error = getValidator(validator)(value, formValues);

      return !!error;
    });

    // Show/hide error
    if (error) {
      this.setError(error);
    } else {
      this.clearError();
    }

    // Return error to be aggregated by list
    return error ? error : null; // eslint-disable-line
  },

  /**
   * Show a validation error
   */
  setError: function (err) {
    this.$el.addClass(this.errorClassName);
    this.$el.attr('title', err.message);
  },

  /**
   * Hide validation errors
   */
  clearError: function () {
    this.$el.removeClass(this.errorClassName);
    this.$el.attr('title', null);
  }
}, {

  /*eslint-disable */
  template: _.template('\
      <div>\
        <span data-editor></span>\
        <button type="button" data-action="remove">&times;</button>\
      </div>\
    ', null, Backbone.Form.templateSettings),
  errorClassName: 'error'
  /*eslint-enable */
});

},{"backbone":"backbone","jquery":"jquery","underscore":"underscore"}],142:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var $ = require('jquery');
var _ = require('underscore');

Backbone.Form.editors.List = Backbone.Form.editors.Base.extend({

  events: {
    'click [data-action="add"]': function (event) {
      event.preventDefault();
      this.addItem(null, true);
    }
  },

  initialize: function (options) {
    options = options || {};

    var editors = Backbone.Form.editors;

    editors.Base.prototype.initialize.call(this, options);
    EditorHelpers.setOptions(this, options);

    var schema = this.schema;
    if (!schema) throw new Error("Missing required option 'schema'");

    this.template = options.template || schema.listTemplate || this.constructor.template;

    // Determine the editor to use
    this.Editor = (function () {
      var type = schema.itemType;

      // Default to Text
      if (!type) return editors.Text;

      // Use List-specific version if available
      if (editors.List[type]) return editors.List[type];

      // Or whichever was passed
      return editors[type];
    })();

    this._userModel = this.options.userModel;
    this._configModel = this.options.configModel;
    this._modals = this.options.modals;

    this.items = [];
  },

  render: function () {
    var self = this;
    var value = this.value || [];

    // Create main element
    var $el = $($.trim(this.template()));

    // Store a reference to the list (item container)
    this.$list = $el.is('[data-items]') ? $el : $el.find('[data-items]');

    // Add existing items
    if (value.length) {
      _.each(value, function (itemValue) {
        self.addItem(itemValue);
      });
    } else {
      // If no existing items create an empty one, unless the editor specifies otherwise
      if (!this.Editor.isAsync) this.addItem();
    }

    this.setElement($el);
    this.$el.attr('id', this.id);
    this.$el.attr('name', this.key);

    if (this.hasFocus) this.trigger('blur', this);

    return this;
  },

  /**
   * Add a new item to the list
   * @param {Mixed} [value]           Value for the new item editor
   * @param {Boolean} [userInitiated] If the item was added by the user clicking 'add'
   */
  addItem: function (value, userInitiated) {
    var self = this;
    var editors = Backbone.Form.editors;

    // Create the item
    var item = new editors.List.Item({
      list: this,
      form: this.form,
      schema: this.schema,
      value: value,
      Editor: this.Editor,
      key: this.key,
      userModel: this._userModel,
      configModel: this._configModel,
      modals: this._modals
    }).render();

    var _addItem = function () {
      self.items.push(item);
      self.$list.append(item.el);

      item.editor.on('all', function (event) {
        if (event === 'change') return;

        // args = ["key:change", itemEditor, fieldEditor]
        var args = _.toArray(arguments);
        args[0] = 'item:' + event;
        args.splice(1, 0, self);
        // args = ["item:key:change", this=listEditor, itemEditor, fieldEditor]

        editors.List.prototype.trigger.apply(this, args);
      }, self);

      item.editor.on('change', function () {
        if (!item.addEventTriggered) {
          item.addEventTriggered = true;
          this.trigger('add', this, item.editor);
        }
        this.trigger('item:change', this, item.editor);
        this.trigger('change', this);
      }, self);

      item.editor.on('focus', function () {
        if (this.hasFocus) return;
        this.trigger('focus', this);
      }, self);
      item.editor.on('blur', function () {
        if (!this.hasFocus) return;
        var self = this;
        setTimeout(function () {
          if (_.find(self.items, function (item) {
            return item.editor.hasFocus;
          })) return;
          self.trigger('blur', self);
        }, 0);
      }, self);

      if (userInitiated || value) {
        item.addEventTriggered = true;
      }

      if (userInitiated) {
        self.trigger('add', self, item.editor);
        self.trigger('change', self);
      }
    };

    // Check if we need to wait for the item to complete before adding to the list
    if (this.Editor.isAsync) {
      item.editor.on('readyToAdd', _addItem, this);
    } else {
      // Most editors can be added automatically
      _addItem();
      item.editor.focus();
    }

    return item;
  },

  /**
   * Remove an item from the list
   * @param {List.Item} item
   */
  removeItem: function (item) {
    // Confirm delete
    var confirmMsg = this.schema.confirmDelete;
    if (confirmMsg && !confirm(confirmMsg)) return; // eslint-disable-line

    var index = _.indexOf(this.items, item);

    this.items[index].remove();
    this.items.splice(index, 1);

    if (item.addEventTriggered) {
      this.trigger('remove', this, item.editor);
      this.trigger('change', this);
    }

    if (!this.items.length && !this.Editor.isAsync) this.addItem();
  },

  getValue: function () {
    var values = _.map(this.items, function (item) {
      return item.getValue();
    });

    // Filter empty items
    return _.without(values, undefined, '');
  },

  setValue: function (value) {
    this.value = value;
    this.render();
  },

  focus: function () {
    if (this.hasFocus) return;

    if (this.items[0]) this.items[0].editor.focus();
  },

  blur: function () {
    if (!this.hasFocus) return;

    var focusedItem = _.find(this.items, function (item) {
      return item.editor.hasFocus;
    });

    if (focusedItem) focusedItem.editor.blur();
  },

  /**
   * Override default remove function in order to remove item views
   */
  remove: function () {
    _.invoke(this.items, 'remove');

    Backbone.Form.editors.Base.prototype.remove.call(this);
  },

  /**
   * Run validation
   *
   * @return {Object|Null}
   */
  validate: function () {
    if (!this.validators) return null;

    // Collect errors
    var errors = _.map(this.items, function (item) {
      return item.validate();
    });

    // Check if any item has errors
    var hasErrors = !!_.compact(errors).length;
    if (!hasErrors) return null;

    // If so create a shared error
    var fieldError = {
      type: 'list',
      message: 'Some of the items in the list failed validation',
      errors: errors
    };

    return fieldError;
  }
}, {

  /*eslint-disable */
  template: _.template('\
      <div>\
        <div data-items></div>\
        <button type="button" data-action="add">Add</button>\
      </div>\
    ', null, Backbone.Form.templateSettings)
  /*eslint-enable */
});

},{"../editor-helpers-extend":62,"backbone":"backbone","jquery":"jquery","underscore":"underscore"}],143:[function(require,module,exports){
var CustomListItemView = require('../../../custom-list/custom-list-item-view');
var _ = require('underscore');

module.exports = CustomListItemView.extend({

  render: function () {
    this.$el.empty();
    this.clearSubViews();

    this.$el.append(
      this.options.template(
        _.extend(
          {
            typeLabel: this.options.typeLabel,
            isSelected: this.model.get('selected'),
            name: this.model.getName(),
            val: this.model.getValue()
          },
          this.model.attributes
        )
      )
    );

    this.$el
      .attr('data-val', this.model.getValue())
      .toggleClass('is-disabled', !!this.model.get('disabled'));

    return this;
  }

});

},{"../../../custom-list/custom-list-item-view":26,"underscore":"underscore"}],144:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button type="button" class="CDB-ListDecoration-itemLink u-ellipsis u-actionTextColor" title="'+
((__t=( val ))==null?'':_.escape(__t))+
'">\n  ';
 if (typeof type != 'undefined' && type === 'node') { 
__p+='\n    <div class="u-flex">\n      <span\n        class="SelectorLayer-letter CDB-Text CDB-Size-small u-whiteTextColor u-rSpace u-upperCase"\n        style="background-color: '+
((__t=( color ))==null?'':_.escape(__t))+
';">'+
((__t=( val ))==null?'':_.escape(__t))+
'</span>\n      <p class="CDB-Text CDB-Size-medium u-ellipsis u-flex">\n        '+
((__t=( nodeTitle ))==null?'':_.escape(__t))+
'<span class="u-altTextColor u-lSpace u-ellipsis">'+
((__t=( layerName ))==null?'':_.escape(__t))+
'</span>\n      </p>\n    </div>\n  ';
 } else { 
__p+='\n    '+
((__t=( val ))==null?'':_.escape(__t))+
'\n  ';
 } 
__p+='\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],145:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (typeof isLoading != 'undefined' && isLoading) { 
__p+='\n  <div class="u-flex">\n    <div class="CDB-LoaderIcon CDB-LoaderIcon--small is-dark">\n      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n      </svg>\n    </div>\n    <span class="u-lSpace u-secondaryTextColor">'+
((__t=( _t('components.backbone-forms.select.loading') ))==null?'':_.escape(__t))+
'</span>\n  </div>\n';
 } else { 
__p+='\n  ';
 if (typeof type != 'undefined' && type === 'node') { 
__p+='\n    <div class="u-flex">\n      <span\n        class="SelectorLayer-letter CDB-Text CDB-Size-small u-whiteTextColor u-rSpace u-upperCase"\n        style="background-color: '+
((__t=( color ))==null?'':_.escape(__t))+
';">'+
((__t=( val ))==null?'':_.escape(__t))+
'</span>\n        <p class="CDB-Text CDB-Size-medium u-ellipsis u-flex" title="'+
((__t=( nodeTitle ))==null?'':_.escape(__t))+
' - '+
((__t=( layerName ))==null?'':_.escape(__t))+
'">\n          '+
((__t=( nodeTitle ))==null?'':_.escape(__t))+
' <span class="u-altTextColor u-lSpace u-ellipsis">'+
((__t=( layerName ))==null?'':_.escape(__t))+
'</span>\n        </p>\n    </div>\n  ';
 } else { 
__p+='\n    '+
((__t=( label ))==null?'':_.escape(__t))+
'\n  ';
 } 
__p+='\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],146:[function(require,module,exports){
var Backbone = require('backbone');
var NodeDatasetItemView = require('./node-dataset-item-view');
var nodeDatasetSelectedTemplate = require('./node-dataset-selected.tpl');
var nodeDatasetItemTemplate = require('./node-dataset-item.tpl');

Backbone.Form.editors.NodeDataset = Backbone.Form.editors.Select.extend({

  options: {
    selectedItemTemplate: nodeDatasetSelectedTemplate,
    itemListTemplate: nodeDatasetItemTemplate,
    customListItemView: NodeDatasetItemView
  }

});

},{"./node-dataset-item-view":143,"./node-dataset-item.tpl":144,"./node-dataset-selected.tpl":145,"backbone":"backbone"}],147:[function(require,module,exports){
var Backbone = require('backbone');
var template = require('./number.tpl');
var EditorHelpers = require('../editor-helpers-extend');
require('jquery');
require('jquery-ui');

var UP_ARROW_KEY_CODE = 38;
var BOTTOM_ARROW_KEY_CODE = 40;
var SPACE_KEY_CODE = 32;
var ENTER_KEY_CODE = 13;

var SMALL_INCREMENT = 1;
var BIG_INCREMENT = 10;

Backbone.Form.editors.Number = Backbone.Form.editors.Base.extend({

  tagName: 'ul',
  className: 'CDB-OptionInput-container CDB-OptionInput-container--noMargin u-grow',

  // backbone-forms 0.14.1 has a 'number' validator:
  // https://github.com/powmedia/backbone-forms/blob/v0.14.1/src/validators.js#L64
  // We're on 0.14.0 so we have to use a 'regexp' validator
  options: {
    min: 0,
    max: 10,
    step: 1,
    showSlider: true,
    validators: [{
      type: 'regexp',
      regexp: /^[+-]?((\.\d+)|(\d+(\.\d+)?))$/,
      message: _t('editor.edit-feature.valid')
    }]
  },

  events: {
    'keydown .js-input': '_onInputKeyDown',
    'keyup .js-input': '_onInputKeyUp',
    focus: function () {
      this.trigger('focus', this);
    },
    blur: function () {
      this.trigger('blur', this);
    }
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    // Setting min, max and step from validators, if exists.
    this._validators = opts.validators || (opts.schema && opts.schema.validators);
    if (this._validators && this._validators[1]) {
      this.options.min = this._validators[1].min;
      this.options.max = this._validators[1].max;
      this.options.step = this._validators[1].step;
    }

    this._initViews();
  },

  _initViews: function () {
    var placeholder = (this.value === null) ? 'null' : '';

    this.$el.html(
      template({
        value: this.value,
        isDisabled: this.options.disabled,
        hasSlider: this.options.showSlider,
        isFormatted: this.options.isFormatted,
        placeholder: placeholder
      })
    );

    if (this.options.showSlider) {
      this.$('.js-slider').slider({
        range: 'min',
        value: this.value,
        min: this.options.min,
        max: this.options.max,
        step: this.options.step,
        orientation: 'horizontal',
        disabled: this.options.disabled,
        slide: this._onSlideChange.bind(this),
        stop: this._onSlideStop.bind(this)
      });
    }

    this.$el.toggleClass('CDB-OptionInput-container--noSlider', !!this.options.showSlider);
  },

  _onSlideChange: function (ev, ui) {
    this.value = ui.value;
    this.$('.js-input').val(this.value);
  },

  _onSlideStop: function (ev, ui) {
    this.trigger('change', this);
  },

  _onInputKeyDown: function (e) {
    var value = +this.getValue();
    var inc = SMALL_INCREMENT;
    var $input = this.$('.js-input');

    if (e.shiftKey === true) {
      inc = BIG_INCREMENT;
    }

    switch (e.which) {
      case SPACE_KEY_CODE:
      case ENTER_KEY_CODE:
        return false;
      case UP_ARROW_KEY_CODE:
        value += inc;
        $input.val(value);
        break;
      case BOTTOM_ARROW_KEY_CODE:
        value -= inc;
        $input.val(value);
        break;
      default:
        // Any other case!
    }
  },

  _hasSlider: function () {
    return this.options.showSlider && this.$('.js-slider').data('ui-slider');
  },

  _onInputKeyUp: function () {
    var value = this.$('.js-input').val();
    if (this._hasSlider()) {
      this.$('.js-slider').slider('value', value);
    }

    this.value = value;
    this.trigger('change', this);
  },

  focus: function () {
    if (this.hasFocus) return;
    this.$('.js-input').focus();
  },

  blur: function () {
    if (!this.hasFocus) return;
    this.$('.js-input').blur();
  },

  getValue: function () {
    var val = this.$('.js-input').val();

    return (val === '') ? null : +val;
  },

  setValue: function (value) {
    if (this._hasSlider()) {
      this.$('.js-slider').slider('value', value);
    }

    this.$('.js-input').val(value);
    this.value = value;
  },

  _destroySlider: function () {
    if (this._hasSlider()) {
      this.$('.js-slider').slider('destroy');
    }
  },

  remove: function () {
    this._destroySlider();
    Backbone.Form.editors.Base.prototype.remove.apply(this);
  },

  clean: function () {
    this.$el.remove();
  }
});

},{"../editor-helpers-extend":62,"./number.tpl":148,"backbone":"backbone","jquery":"jquery","jquery-ui":455}],148:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (hasSlider) { 
__p+='\n  <li class="CDB-OptionInput-item CDB-OptionInput-item--noSeparator">\n    <div class="UISlider js-slider"></div>\n  </li>\n';
 } 
__p+='\n<li class="CDB-OptionInput-item">\n  <input type="text" class="CDB-InputText ';
 if (isFormatted) { 
__p+='is-number';
 } 
__p+=' ';
 if (isDisabled) { 
__p+='is-disabled';
 } 
__p+=' js-input" ';
 if (isDisabled) { 
__p+='readonly';
 } 
__p+=' value="'+
((__t=( value ))==null?'':_.escape(__t))+
'" placeholder="'+
((__t=( placeholder ))==null?'':_.escape(__t))+
'" />\n</li>\n';
}
return __p;
};

},{"underscore":"underscore"}],149:[function(require,module,exports){
var CustomListCollection = require('../../../custom-list/custom-list-collection');
var _ = require('underscore');

/*
 *  Custom list collection, it parses pairs like:
 *
 *  [{ val, label }]
 *  ["string"]
 */

module.exports = CustomListCollection.extend({

  search: function (query) {
    query = query.toLowerCase();

    return _(this.filter(function (model) {
      var val = model.getName().toLowerCase();
      var type = model.get('type').toLowerCase();
      return ~val.indexOf(query) && type === 'number';
    }));
  }

});

},{"../../../custom-list/custom-list-collection":23,"underscore":"underscore"}],150:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text CDB-Size-medium u-altTextColor Editor-dropDownInfoText">\n  '+
((__t=( _t('components.backbone-forms.operators.count-message') ))==null?'':_.escape(__t))+
'\n</p>\n';
}
return __p;
};

},{"underscore":"underscore"}],151:[function(require,module,exports){
var Backbone = require('backbone');

module.exports = Backbone.Model.extend({

  defaults: {
    visible: false,
    operator: 'count',
    attribute: ''
  },

  isValidOperator: function () {
    var operator = this.get('operator');
    var attribute = this.get('attribute');

    if (operator === 'count') {
      return true;
    } else {
      if (operator && attribute) {
        return true;
      }
      return false;
    }
  }

});

},{"backbone":"backbone"}],152:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var $ = require('jquery');
var CustomListView = require('../../../custom-list/custom-view');
var OperatorsListModel = require('./operators-list-model');
var emptyTemplate = require('./operators-list-count.tpl');
var template = require('./operators-list.tpl');

module.exports = CoreView.extend({

  className: 'Editor-dropdown Editor-boxModal Editor-dropdownOperators',
  tagName: 'div',

  events: {
    'change input[name="operator"]': '_onOperationChange'
  },

  initialize: function (opts) {
    this.model = new OperatorsListModel({
      operator: opts.operator,
      attribute: opts.attribute,
      visible: false
    });

    if (opts.attribute) {
      this.collection.setSelected(opts.attribute);
    }

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this.$el.append(
      template({
        operator: this.model.get('operator')
      })
    );
    this._renderList();
    return this;
  },

  _initBinds: function () {
    this.model.bind('change:operator change:attribute', _.debounce(this._onModelChange.bind(this), 10));
    this.model.bind('change:visible', function (mdl, isVisible) {
      this._toggleVisibility();

      if (!isVisible) {
        this._destroyList();
        this.$('.js-list').html(emptyTemplate());
      } else {
        this.render();
      }
    }, this);
    this.collection.bind('change:selected', this._onAttributeSelected, this);
    this.add_related_model(this.collection);
  },

  _hasList: function () {
    return !!this._listView;
  },

  _renderList: function () {
    if (this.model.get('operator') !== 'count') {
      if (this._hasList()) {
        return;
      }

      this._listView = new CustomListView({
        className: 'CDB-Dropdown-options CDB-Text CDB-Size-medium',
        collection: this.collection,
        showSearch: true,
        typeLabel: this.options.keyAttr
      });
      this.$('.js-list').html(this._listView.render().el);
    } else {
      this._destroyList();
      this.$('.js-list').html(emptyTemplate());
    }
  },

  _destroyList: function () {
    if (this._hasList()) {
      this.removeView(this._listView);
      this._listView.clean();
      delete this._listView;
    }
  },

  _onModelChange: function () {
    if (this.model.isValidOperator()) {
      this.trigger('change', this.model.toJSON(), this);
    }
  },

  _onOperationChange: function (ev) {
    var $input = $(ev.target);
    var operator = $input.val();

    if (operator === 'count') {
      this.model.set('attribute', '');
      this.collection.removeSelected();
    }

    this.model.set('operator', operator);

    this._renderList();
  },

  _onAttributeSelected: function (mdl) {
    if (mdl.get('selected')) {
      this.model.set('attribute', mdl.getValue());
    }
  },

  _toggleVisibility: function () {
    this.$el.toggleClass('is-visible', !!this.model.get('visible'));
  },

  show: function () {
    this.model.set('visible', true);
  },

  hide: function () {
    this.model.set('visible', false);
  },

  toggle: function () {
    this.model.set('visible', !this.model.get('visible'));
  },

  isVisible: function () {
    return this.model.get('visible');
  },

  remove: function () {
    this._destroyList();
    this.$el.empty();
    CoreView.prototype.remove.call(this);
  }
});

},{"../../../custom-list/custom-view":35,"./operators-list-count.tpl":150,"./operators-list-model":151,"./operators-list.tpl":153,"backbone/core-view":454,"jquery":"jquery","underscore":"underscore"}],153:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="Editor-dropdownCalculations CDB-Text is-semibold">\n  <li class="Editor-dropdownCalculationsElement CDB-Fieldset">\n    <input class="CDB-Radio" type="radio" name="operator" value="count" ';
 if (operator === 'count') { 
__p+='checked';
 } 
__p+='>\n    <span class="u-iBlock CDB-Radio-face"></span>\n    <label class="u-iBlock u-lSpace">'+
((__t=( _t('operators.count') ))==null?'':_.escape(__t))+
'</label>\n  </li>\n  <li class="Editor-dropdownCalculationsElement CDB-Fieldset">\n    <input class="CDB-Radio" type="radio" name="operator" value="sum" ';
 if (operator === 'sum') { 
__p+='checked';
 } 
__p+='>\n    <span class="u-iBlock CDB-Radio-face"></span>\n    <label class="u-iBlock u-lSpace">'+
((__t=( _t('operators.sum') ))==null?'':_.escape(__t))+
'</label>\n  </li>\n  <li class="Editor-dropdownCalculationsElement CDB-Fieldset">\n    <input class="CDB-Radio" type="radio" name="operator" value="avg" ';
 if (operator === 'avg') { 
__p+='checked';
 } 
__p+='>\n    <span class="u-iBlock CDB-Radio-face"></span>\n    <label class="u-iBlock u-lSpace">'+
((__t=( _t('operators.avg') ))==null?'':_.escape(__t))+
'</label>\n  </li>\n  <li class="Editor-dropdownCalculationsElement CDB-Fieldset">\n    <input class="CDB-Radio" type="radio" name="operator" value="max" ';
 if (operator === 'max') { 
__p+='checked';
 } 
__p+='>\n    <span class="u-iBlock CDB-Radio-face"></span>\n    <label class="u-iBlock u-lSpace">'+
((__t=( _t('operators.max') ))==null?'':_.escape(__t))+
'</label>\n  </li>\n  <li class="Editor-dropdownCalculationsElement CDB-Fieldset">\n    <input class="CDB-Radio" type="radio" name="operator" value="min" ';
 if (operator === 'min') { 
__p+='checked';
 } 
__p+='>\n    <span class="u-iBlock CDB-Radio-face"></span>\n    <label class="u-iBlock u-lSpace">'+
((__t=( _t('operators.min') ))==null?'':_.escape(__t))+
'</label>\n  </li>\n</ul>\n<div class="js-list"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],154:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var _ = require('underscore');
var $ = require('jquery');
var OperatorListView = require('./operators-list-view');
var OperatorListCollection = require('./operators-list-collection');
var template = require('./operators.tpl');
var ENTER_KEY_CODE = 13;
var PopupManager = require('../../../popup-manager');

Backbone.Form.editors.Operators = Backbone.Form.editors.Base.extend({

  tagName: 'div',
  className: 'Editor-formSelect u-ellipsis',

  events: {
    'click .js-button': '_onButtonClick',
    'keydown .js-button': '_onButtonKeyDown',
    'focus .js-button': function () {
      this.trigger('focus', this);
    },
    'blur': function () {
      this.trigger('blur', this);
    }
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    this.collection = new OperatorListCollection(this.options.options);
    this.dialogMode = this.options.dialogMode || 'nested';

    this._initViews();
    this.setValue(this.model.get(this.options.keyAttr));
    this._initBinds();
  },

  _initViews: function () {
    var value = this.model.get(this.options.keyAttr);

    this.$el.append(
      $('<div>').addClass('js-operator')
    );

    this._setOperatorTemplate();

    this._operatorsListView = new OperatorListView({
      operator: value.operator,
      attribute: value.attribute,
      collection: this.collection
    });
    this._operatorsListView.bind('change', this._onOperatorsChange, this);

    this._popupManager = new PopupManager(this.cid, this.$el, this._operatorsListView.$el);
    this._popupManager.append(this.dialogMode);

    if (this.options.disabled) {
      this.undelegateEvents();
    }
  },

  _setOperatorTemplate: function () {
    this.$('.js-operator').html(
      template({
        name: this._getOperatorsTextValue(),
        disabled: this.options.disabled,
        keyAttr: this.options.keyAttr
      })
    );
  },

  _initBinds: function () {
    var hide = function () {
      this._operatorsListView.hide();
      this._popupManager.untrack();
    }.bind(this);

    this.applyESCBind(hide);
    this.applyClickOutsideBind(hide);
  },

  _onOperatorsChange: function (data) {
    this.model.set(this.options.keyAttr, data);
    this._setOperatorTemplate();
    this.$('.js-button').focus();
    this.trigger('change', this);
  },

  _getOperatorsTextValue: function () {
    var value = this.model.get(this.options.keyAttr);
    if (value && value.operator) {
      return value.operator.toUpperCase() + (value.attribute ? '(' + value.attribute + ')' : '');
    } else {
      return '';
    }
  },

  _onButtonClick: function (ev) {
    this._operatorsListView.toggle();
    this._operatorsListView.isVisible() ? this._popupManager.track() : this._popupManager.untrack();
  },

  _onButtonKeyDown: function (ev) {
    if (ev.which === ENTER_KEY_CODE) {
      ev.preventDefault();
      if (!this._operatorsListView.isVisible()) {
        ev.stopPropagation();
        this._operatorsListView.toggle();
        this._popupManager.track();
      } else {
        this._popupManager.untrack();
      }
    }
  },

  getValue: function () {
    var data = this.model.get(this.options.keyAttr);
    return _.omit(data, 'visible');
  },

  setValue: function (value) {
    var textValue = this._getOperatorsTextValue();
    this.value = textValue;
    this._setOperatorTemplate();
  },

  remove: function () {
    this._popupManager && this._popupManager.destroy();
    this._operatorsListView && this._operatorsListView.clean();
    Backbone.Form.editors.Base.prototype.remove.call(this);
  }

});

},{"../../../popup-manager":263,"../editor-helpers-extend":62,"./operators-list-collection":149,"./operators-list-view":152,"./operators.tpl":155,"backbone":"backbone","jquery":"jquery","underscore":"underscore"}],155:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-InputText CDB-Text is-cursor js-button u-ellipsis\n  ';
 if (disabled) { 
__p+=' is-disabled ';
 } 
__p+='\n  ';
 if (!name) { 
__p+=' is-empty ';
 } 
__p+='"\n  tabindex="0">\n  '+
((__t=( name || _t('components.backbone-forms.select.placeholder', { keyAttr: keyAttr }) ))==null?'':_.escape(__t))+
'\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],156:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var template = require('./radio.tpl');
var _ = require('underscore');
var $ = require('jquery');
var TipsyTooltipView = require('../../../tipsy-tooltip-view');

Backbone.Form.editors.Radio = Backbone.Form.editors.Radio.extend({

  className: 'CDB-Text CDB-Size-medium u-flex u-alignCenter',

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.apply(this, arguments);
    EditorHelpers.setOptions(this, opts);
  },

  render: function () {
    this.setOptions(this.schema.options); // It comes from the default Select editor (not ours)
    this._setHelp();
    return this;
  },

  _setHelp: function () {
    var containsHelp = _.find(this.schema.options, function (option) {
      return option.help;
    });

    if (containsHelp) {
      this._helpTooltip = this._createTooltip({
        $el: this.$('.js-help')
      });
    }
  },

  _createTooltip: function (opts) {
    return new TipsyTooltipView({
      el: opts.$el || this.$el,
      gravity: opts.gravity || 's',
      className: opts.className || '',
      offset: opts.offset || 0,
      title: function () {
        return opts.msg || $(this).data('tooltip');
      }
    });
  },

  getValue: function () {
    var value = this.$('input[type=radio]:checked').val();

    return (value === '') ? null : value;
  },

  _arrayToHtml: function (array) {
    var selectedVal = this.form.model.get(this.key);

    var items = _.map(array, function (option, index) {
      var val = option.val;

      var item = {
        name: this.getName(),
        value: (val === null) ? '' : val.toString(),
        help: option.help,
        id: this.id,
        label: option.label,
        className: option.className
      };

      // Can't be selected and disabled simultaneously
      if (selectedVal === val) {
        item.selected = true;
      } else {
        item.disabled = option.disabled;
      }

      return item;
    }, this);

    return template({
      items: items
    });
  },

  remove: function () {
    if (this._helpTooltip) {
      this._helpTooltip.clean();
    }
    Backbone.Form.editors.Base.prototype.remove.call(this);
  }
});

},{"../../../tipsy-tooltip-view":325,"../editor-helpers-extend":62,"./radio.tpl":157,"backbone":"backbone","jquery":"jquery","underscore":"underscore"}],157:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 _.each(items, function(item, index) { 
__p+='\n  <li class="u-flex u-alignCenter '+
((__t=( (index === (items.length - 1)) ? '' : 'u-rSpace--xl' ))==null?'':_.escape(__t))+
'">\n    <input type="radio" class="CDB-Radio u-iBlock';
 if (item.className) { 
__p+=' '+
((__t=( item.className ))==null?'':_.escape(__t))+
' ';
 } 
__p+='"\n    name="'+
((__t=( item.name ))==null?'':_.escape(__t))+
'" value="'+
((__t=( item.value ))==null?'':_.escape(__t))+
'" id="'+
((__t=( item.id ))==null?'':_.escape(__t))+
'" \n        ';
 if (item.selected) { 
__p+='\n          checked="checked"\n        ';
 } else if (item.disabled) { 
__p+='\n          disabled="disabled"\n        ';
 } 
__p+='\n      />\n    <span class="u-rSpace CDB-Radio-face"></span>\n      ';
 if (item.help) { 
__p+='\n        <span class="js-help is-underlined u-lSpace" data-tooltip="'+
((__t=( item.help ))==null?'':_.escape(__t))+
'">\n      ';
 } 
__p+='\n      '+
((__t=( item.label ))==null?'':_.escape(__t))+
'\n      ';
 if (item.help) { 
__p+='\n        </span>\n      ';
 } 
__p+='\n  </li>\n';
 }); 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],158:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var _ = require('underscore');
var CustomListView = require('../../../custom-list/custom-view');
var CustomListCollection = require('../../../custom-list/custom-list-multi-collection');
var selectedItemTemplate = require('./select-item.tpl');
var CustomListItemView = require('../../../custom-list/custom-list-multi-item-view');
var itemListTemplate = require('../../../custom-list/custom-list-item-with-checkbox.tpl');
var template = require('./select.tpl');
var PopupManager = require('../../../popup-manager');

var ENTER_KEY_CODE = 13;

Backbone.Form.editors.MultiSelect = Backbone.Form.editors.Base.extend({

  tagName: 'div',
  className: 'u-ellipsis Editor-formSelect',

  events: {
    'click .js-button': '_onButtonClick',
    'keydown .js-button': '_onButtonKeyDown',
    'focus .js-button': function () {
      this.trigger('focus', this);
    },
    'blur': function () {
      this.trigger('blur', this);
    }
  },

  options: {
    selectedItemTemplate: selectedItemTemplate,
    itemListTemplate: itemListTemplate,
    customListItemView: CustomListItemView
  },

  initialize: function (opts) {
    EditorHelpers.setOptions(this, opts);

    this.collection = new CustomListCollection(opts.schema.options);
    this.dialogMode = this.options.dialogMode || 'nested';

    this._initViews();
    this.setValue(this.model.get(opts.key));
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);

    this._initBinds();
  },

  _getLabel: function () {
    var itemCount = _.compact(this.collection.pluck('selected')).length;
    return _t('components.backbone-forms.select.selected', { count: itemCount });
  },

  _initViews: function () {
    var isLoading = this.options.loading;
    var isEmpty = !this.collection.length;
    var isDisabled = !isEmpty ? this.options.disabled : true;
    var name = this._getLabel();
    var isNull = name === null;
    var label = isNull ? 'null' : name;

    this.$el.html(
      template({
        label: label,
        keyAttr: this.options.keyAttr,
        isDisabled: isDisabled,
        isLoading: isLoading,
        isEmpty: isEmpty,
        isNull: isNull,
        placeholder: null
      })
    );

    if (isDisabled) {
      this.undelegateEvents();
    }

    this._listView = new CustomListView({
      collection: this.collection,
      showSearch: this.options.showSearch,
      typeLabel: this.options.keyAttr,
      itemTemplate: this.options.itemListTemplate,
      itemView: this.options.customListItemView,
      searchPlaceholder: null
    });

    this._listView.bind('hidden', this._onHide, this);

    this._popupManager = new PopupManager(this.cid, this.$el, this._listView.$el);
    this._popupManager.append(this.dialogMode);
  },

  _initBinds: function () {
    var hide = function () {
      this._listView.hide();
      this._popupManager.untrack();
    }.bind(this);

    this.collection.bind('change:selected', this._onItemSelected, this);
    this.applyESCBind(hide);
    this.applyClickOutsideBind(hide);
  },

  _onItemSelected: function (mdl) {
    this._renderButton(mdl).focus();
    this.trigger('change', this);
  },

  _onButtonClick: function (ev) {
    this._listView.toggle();
    this._listView.isVisible() ? this._popupManager.track() : this._popupManager.untrack();
  },

  _onButtonKeyDown: function (ev) {
    if (ev.which === ENTER_KEY_CODE) {
      ev.preventDefault();
      if (!this._listView.isVisible()) {
        ev.stopPropagation();
        this._listView.toggle();
        this._popupManager.track();
      } else {
        this._popupManager.untrack();
      }
    }
  },

  _getSelectedValues: function () {
    return this.collection.chain().map(function (m) { return m.get('selected') ? m.get('val') : null; }).compact().value();
  },

  getValue: function () {
    var values = this._getSelectedValues();
    if (values.length > 0) {
      return values;
    }
    return;
  },

  setValue: function (value) {
    if (value) {
      var selectedModel = this.collection.setSelected(value);

      if (selectedModel) {
        this._renderButton(selectedModel);
      }
    }
  },

  _renderButton: function (mdl) {
    var button = this.$('.js-button');
    var data = _.extend({}, mdl.attributes, { label: this._getLabel() });
    var $html = this.options.selectedItemTemplate(data);

    button
      .removeClass('is-empty')
      .html($html);

    return button;
  },

  _onHide: function () {
    if (this._getSelectedValues().length > 0) {
      this.trigger('change', this);
    }
  },

  remove: function () {
    this._popupManager && this._popupManager.destroy();
    this._listView && this._listView.clean();
    Backbone.Form.editors.Base.prototype.remove.call(this);
  }
});

},{"../../../custom-list/custom-list-item-with-checkbox.tpl":27,"../../../custom-list/custom-list-multi-collection":29,"../../../custom-list/custom-list-multi-item-view":30,"../../../custom-list/custom-view":35,"../../../popup-manager":263,"../editor-helpers-extend":62,"./select-item.tpl":159,"./select.tpl":161,"backbone":"backbone","underscore":"underscore"}],159:[function(require,module,exports){
arguments[4][42][0].apply(exports,arguments)
},{"dup":42,"underscore":"underscore"}],160:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var _ = require('underscore');
var CustomListView = require('../../../custom-list/custom-view');
var CustomListCollection = require('../../../custom-list/custom-list-collection');
var selectedItemTemplate = require('./select-item.tpl');
var CustomListItemView = require('../../../custom-list/custom-list-item-view');
var itemListTemplate = require('../../../custom-list/custom-list-item.tpl');
var template = require('./select.tpl');
var PopupManager = require('../../../popup-manager');

var ENTER_KEY_CODE = 13;

Backbone.Form.editors.Select = Backbone.Form.editors.Base.extend({

  tagName: 'div',
  className: 'u-ellipsis Editor-formSelect',

  events: {
    'click .js-button': '_onButtonClick',
    'keydown .js-button': '_onButtonKeyDown',
    'focus .js-button': function () {
      this.trigger('focus', this);
    },
    'blur': function () {
      this.trigger('blur', this);
    }
  },

  options: {
    selectedItemTemplate: selectedItemTemplate,
    itemListTemplate: itemListTemplate,
    customListItemView: CustomListItemView
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    this.template = opts.template || template;
    this.dialogMode = this.options.dialogMode || 'nested';
    this.collection = new CustomListCollection(this.options.options);
    this._initViews();

    this.setValue(this.model.get(this.options.keyAttr));

    this._initBinds();
  },

  _initViews: function () {
    var isLoading = this.options.loading;
    var isEmpty = !this.collection.length;
    var isDisabled = !isEmpty ? this.options.disabled : true;
    var name = this.model.get(this.options.keyAttr);
    var isNull = name === null;
    var label = isNull ? 'null' : name;
    var placeholder = this.options.placeholder;
    var typeLabel = this.options.keyAttr;

    this.$el.html(
      this.template({
        label: label,
        keyAttr: this.options.keyAttr,
        placeholder: placeholder,
        isDisabled: isDisabled,
        isLoading: isLoading,
        isEmpty: isEmpty,
        isNull: isNull
      })
    );

    if (isDisabled) {
      this.undelegateEvents();
    }

    this._listView = new CustomListView({
      collection: this.collection,
      showSearch: this.options.showSearch,
      allowFreeTextInput: this.options.allowFreeTextInput,
      typeLabel: typeLabel,
      itemTemplate: this.options.itemListTemplate,
      itemView: this.options.customListItemView,
      position: this.options.position,
      searchPlaceholder: this.options.searchPlaceholder
    });

    this._popupManager = new PopupManager(this.cid, this.$el, this._listView.$el);
    this._popupManager.append(this.dialogMode);
  },

  _initBinds: function () {
    var hide = function () {
      this._listView.hide();
      this._popupManager.untrack();
    }.bind(this);

    this.collection.bind('change:selected', this._onItemSelected, this);
    this.applyESCBind(hide);
    this.applyClickOutsideBind(hide);
  },

  _onItemSelected: function (mdl) {
    this._listView.hide();
    this._popupManager.untrack();
    this._renderButton(mdl).focus();
    this.trigger('change', this);
  },

  _onButtonClick: function (ev) {
    this._listView.toggle();
    this._listView.isVisible() ? this._popupManager.track() : this._popupManager.untrack();
  },

  _onButtonKeyDown: function (ev) {
    if (ev.which === ENTER_KEY_CODE) {
      ev.preventDefault();
      if (!this._listView.isVisible()) {
        ev.stopPropagation();
        this._listView.toggle();
      } else {
        this._popupManager.track();
      }
    }
  },

  getValue: function () {
    var item = this.collection.getSelectedItem();
    if (item) {
      return item.getValue();
    }
    return;
  },

  setValue: function (value) {
    var selectedModel = this.collection.setSelected(value);
    if (selectedModel) {
      this._renderButton(selectedModel);
    }
    this.value = value;
  },

  _renderButton: function (mdl) {
    var button = this.$('.js-button');
    var data = _.extend({}, {label: mdl.getName()}, mdl.attributes);
    var $html = this.options.selectedItemTemplate(data);

    button
      .removeClass('is-empty')
      .html($html);

    return button;
  },

  remove: function () {
    this._popupManager && this._popupManager.destroy();
    this._listView && this._listView.clean();
    Backbone.Form.editors.Base.prototype.remove.call(this);
  }

});

},{"../../../custom-list/custom-list-collection":23,"../../../custom-list/custom-list-item-view":26,"../../../custom-list/custom-list-item.tpl":28,"../../../custom-list/custom-view":35,"../../../popup-manager":263,"../editor-helpers-extend":62,"./select-item.tpl":159,"./select.tpl":161,"backbone":"backbone","underscore":"underscore"}],161:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-InputText CDB-Text is-cursor js-button u-ellipsis\n  ';
 if (isDisabled) { 
__p+=' is-disabled ';
 } 
__p+='\n  ';
 if (!label) { 
__p+=' is-empty ';
 } 
__p+='\n  ';
 if (isNull) { 
__p+=' is-empty ';
 } 
__p+='"\n  tabindex="0">\n  ';
 if (isLoading) { 
__p+='\n    <div class="CDB-LoaderIcon CDB-LoaderIcon--small is-dark">\n      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n      </svg>\n      <span class="u-lSpace u-secondaryTextColor">'+
((__t=( _t('components.backbone-forms.select.loading') ))==null?'':_.escape(__t))+
'</span>\n    </div>\n  ';
 } else { 
__p+='\n    ';
 if (isEmpty) { 
__p+='\n      '+
((__t=( _t('components.backbone-forms.select.empty') ))==null?'':_.escape(__t))+
'\n    ';
 } else { 
__p+='\n      '+
((__t=( placeholder || label || _t('components.backbone-forms.select.placeholder', { keyAttr: keyAttr }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  ';
 } 
__p+='\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],162:[function(require,module,exports){
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var _ = require('underscore');
var CustomListView = require('../../../custom-list/custom-view');
var CustomListCollection = require('../../../custom-list/custom-list-collection');
var selectedItemTemplate = require('./select-item.tpl');
var CustomListItemView = require('../../../custom-list/custom-list-item-view');
var itemListTemplate = require('../../../custom-list/custom-list-item.tpl');
var template = require('./select.tpl');
var PopupManager = require('../../../popup-manager');

var ENTER_KEY_CODE = 13;

Backbone.Form.editors.Suggest = Backbone.Form.editors.Base.extend({

  tagName: 'div',
  className: 'u-ellipsis Editor-formSelect',

  events: {
    'click .js-button': '_onButtonClick',
    'keydown .js-button': '_onButtonKeyDown',
    'focus .js-button': function () {
      this.trigger('focus', this);
    },
    'blur': function () {
      this.trigger('blur', this);
    }
  },

  options: {
    selectedItemTemplate: selectedItemTemplate,
    itemListTemplate: itemListTemplate,
    customListItemView: CustomListItemView
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    this.template = opts.template || template;
    this.dialogMode = this.options.dialogMode || 'nested';

    this._setupCollection();
    this.setValue(this.model.get(this.options.keyAttr));
    this._initBinds();
  },

  render: function () {
    this.setValue(this.value);

    return this;
  },

  _setupCollection: function () {
    this.collection = new CustomListCollection(this.options.options);

    if (this.options.editorAttrs && this.options.editorAttrs.collectionData) {
      var categories = _.map(this.options.editorAttrs.collectionData, function (d) {
        return { label: d, val: d };
      });

      this.collection.reset(categories);
    }
  },

  _initViews: function () {
    var isLoading = this.options.loading;
    var isEmpty = !this.collection.length;
    var isDisabled = !isEmpty ? this.options.disabled : true;
    var name = this.model.get(this.options.keyAttr);
    var isNull = name === null;
    var label = isNull ? 'null' : name;

    this.$el.html(
      this.template({
        label: label,
        keyAttr: this.options.keyAttr,
        isDisabled: isDisabled,
        isLoading: isLoading,
        isEmpty: isEmpty,
        isNull: isNull,
        placeholder: null
      })
    );

    if (isDisabled) {
      this.undelegateEvents();
    }

    this._listView = new CustomListView({
      collection: this.collection,
      showSearch: this.options.showSearch,
      allowFreeTextInput: this.options.allowFreeTextInput,
      typeLabel: this.options.keyAttr,
      itemTemplate: this.options.itemListTemplate,
      itemView: this.options.customListItemView,
      position: this.options.position,
      searchPlaceholder: null
    });

    this._popupManager = new PopupManager(this.cid, this.$el, this._listView.$el);
    this._popupManager.append(this.dialogMode);
  },

  _initBinds: function () {
    var hide = function () {
      this._listView.hide();
      this._popupManager.untrack();
    }.bind(this);

    this.collection.bind('change:selected', this._onItemSelected, this);
    this.collection.bind('reset', this.render, this);
    this.applyESCBind(hide);
    this.applyClickOutsideBind(hide);
  },

  _onItemSelected: function (mdl) {
    this._listView.hide();
    this._popupManager.untrack();
    this._renderButton(mdl).focus();
    this.trigger('change', this);
  },

  _onButtonClick: function (ev) {
    this._listView.toggle();
    this._listView.isVisible() ? this._popupManager.track() : this._popupManager.untrack();
  },

  _onButtonKeyDown: function (ev) {
    if (ev.which === ENTER_KEY_CODE) {
      ev.preventDefault();
      if (!this._listView.isVisible()) {
        ev.stopPropagation();
        this._listView.toggle();
        this._popupManager.track();
      } else {
        this._popupManager.untrack();
      }
    }
  },

  getValue: function () {
    var item = this.collection.getSelectedItem();

    if (item) {
      return item.getValue();
    }

    return;
  },

  setValue: function (value) {
    var selectedModel = this.collection.setSelected(value);

    if (!selectedModel) {
      this.collection.add({ label: value, val: value });
      selectedModel = this.collection.setSelected(value);
    }

    this._initViews();
    this._renderButton(selectedModel);

    this.value = value;
  },

  _renderButton: function (mdl) {
    var button = this.$('.js-button');
    var name = mdl.getName();
    var isNull = name === null || name === 'null';
    var label = isNull ? 'null' : name;

    var data = _.extend({}, mdl.attributes, { label: label });
    var $html = this.options.selectedItemTemplate(data);

    button
      .html($html)
      .toggleClass('is-empty', isNull);

    return button;
  },

  remove: function () {
    this._popupManager && this._popupManager.destroy();
    this._listView && this._listView.clean();
    Backbone.Form.editors.Base.prototype.remove.call(this);
  },

  clean: function () {
    this._popupManager && this._popupManager.destroy();
  }

});

},{"../../../custom-list/custom-list-collection":23,"../../../custom-list/custom-list-item-view":26,"../../../custom-list/custom-list-item.tpl":28,"../../../custom-list/custom-view":35,"../../../popup-manager":263,"../editor-helpers-extend":62,"./select-item.tpl":159,"./select.tpl":161,"backbone":"backbone","underscore":"underscore"}],163:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var Backbone = require('backbone');
var EditorHelpers = require('../editor-helpers-extend');
var template = require('./slider.tpl');
require('jquery');
require('jquery-ui');

Backbone.Form.editors.Slider = Backbone.Form.editors.Base.extend({

  tagName: 'ul',
  className: 'CDB-OptionInput-container CDB-OptionInput-container--noMargin',

  options: {
    direction: ''
  },

  events: {
    focus: function () {
      this.trigger('focus', this);
    },
    blur: function () {
      this.trigger('blur', this);
    }
  },

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    if (!this.options.labels) {
      throw new Error('labels is required');
    }

    if (this.options.values && this.options.labels.length !== this.options.values.length) {
      throw new Error('values and labels should have the same length');
    }

    this._values = this.options.values;
    this._labels = this.options.labels;

    this._initViews();
  },

  _initViews: function () {
    this.$el.html(
      template({
        direction: this.options.direction
      })
    );

    var step = this._getStepPercentage();
    this._ticks = this._getTicks(step);

    var tickID = this._getInitialTickID();

    this.$('.js-slider').slider({
      range: 'min',
      value: this._ticks[tickID],
      step: step,
      orientation: 'horizontal',
      disabled: this.options.disabled,
      slide: this._onSlideChange.bind(this),
      stop: this._onSlideStop.bind(this)
    });

    this._addTicks(step);
    this._updateUI(tickID);
  },

  _getInitialTickID: function () {
    var value = this.value;

    if (this._values) {
      value = this._values.indexOf(this.value);

      if (value === -1) {
        value = 0;
      }
    } else if (!value) {
      value = 0;
    }

    return value;
  },

  _updateUI: function (tickID) {
    if (tickID === undefined) {
      tickID = 0;
    }

    this._updateLabel(tickID);
    this._highlightTick(tickID);
  },

  _getTickID: function () {
    var v = 0;

    if (this.value && _.isNumber(this.value)) {
      v = this._calculateTickValue(this.value);
    }

    return this._ticks.indexOf(v);
  },

  _addTicks: function (step) {
    _.each(this._ticks, function (amount) {
      $('<div class="UISlider-tick js-tick"></div>')
        .css('left', amount + '%')
        .appendTo(this.$('.js-slider'));
    }, this);
  },

  _highlightTick: function (tickID) {
    this.$('.js-tick').removeClass('is-highlighted');
    $(this.$('.js-tick').get(tickID)).addClass('is-highlighted');
  },

  _updateLabel: function (tickID) {
    this.$('.js-label').text(this._labels[tickID]);
  },

  _getTicks: function (step) {
    var self = this;

    return [0].concat(_(this._labels.length - 1).times(function (n) {
      return self._calculateTickValue(step * (n + 1));
    }));
  },

  _getStepPercentage: function () {
    return (100 / (this._labels.length - 1));
  },

  _calculateTickValue: function (value) {
    return +value.toFixed(2);
  },

  _onSlideChange: function (ev, ui) {
    this.value = ui.value;

    this._updateUI(this._getTickID());
  },

  _onSlideStop: function (ev, ui) {
    this.trigger('change', this);
  },

  _hasSlider: function () {
    return this.$('.js-slider').data('ui-slider');
  },

  getValue: function () {
    var value = this._values ? this._values[this._getTickID()] : this._getTickID();
    return (this.value === '') ? null : value;
  },

  setValue: function (value) {
    this.$('.js-slider').slider('value', value);
    this.value = value;
  },

  _destroySlider: function () {
    if (this._hasSlider()) {
      this.$('.js-slider').slider('destroy');
    }
  },

  remove: function () {
    this._destroySlider();
    Backbone.Form.editors.Base.prototype.remove.apply(this);
  },

  clean: function () {
    this.$el.remove();
  }
});

},{"../editor-helpers-extend":62,"./slider.tpl":164,"backbone":"backbone","jquery":"jquery","jquery-ui":455,"underscore":"underscore"}],164:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<li class="CDB-OptionInput-item CDB-OptionInput-item--noSeparator">\n  ';
 if (direction === 'desc') { 
__p+='\n  <svg class="UISlider-scale" width="160px" height="7px" viewBox="0 0 160 7" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n      <g fill="#EEEEEE">\n        <path d="M0,3.96972188 C0,2.86143684 0.899814069,1.95171147 1.99402962,1.93799103 L158.00597,-0.0182528125 C159.107243,-0.0320617354 160,0.846465216 160,1.95103649 L160,4.98745286 C160,6.08887023 159.100186,6.96483876 158.00597,6.94427947 L1.99402962,4.012961 C0.89275747,3.99226913 0,3.08692473 0,1.96876746 L0,3.96972188 Z" id="Mask" transform="translate(80.000000, 3.458568) scale(-1, 1) translate(-80.000000, -3.458568) "></path>\n      </g>\n    </g>\n  </svg>\n  ';
 } else if (direction === 'asc') { 
__p+='\n  <svg class="UISlider-scale" width="160px" height="7px" viewBox="0 0 160 7" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n      <g transform="translate(80.000000, 4.000000) rotate(-180.000000) translate(-80.000000, -4.000000) " fill-rule="nonzero" fill="#EEEEEE">\n        <path d="M0,4.96972188 C0,3.86143684 0.899814069,2.95171147 1.99402962,2.93799103 L158.00597,0.981747188 C159.107243,0.967938265 160,1.84646522 160,2.95103649 L160,5.98745286 C160,7.08887023 159.100186,7.96483876 158.00597,7.94427947 L1.99402962,5.012961 C0.89275747,4.99226913 0,4.08692473 0,2.96876746 L0,4.96972188 Z" id="Mask" transform="translate(80.000000, 4.463110) scale(-1, 1) translate(-80.000000, -4.463110) "></path>\n      </g>\n    </g>\n  </svg>\n  ';
 } 
__p+='\n  <div class="UISlider is-standalone ';
 if (direction) { 
__p+='without-line';
 } 
__p+=' js-slider"></div>\n  <span class="UISlider-label js-label"></span>\n</li>\n';
}
return __p;
};

},{"underscore":"underscore"}],165:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
require('jquery-ui');

Backbone.Form.editors.SortableList = Backbone.Form.editors.List.extend({
  initialize: function () {
    Backbone.Form.editors.List.prototype.initialize.apply(this, arguments);
  },

  render: function () {
    Backbone.Form.editors.List.prototype.render.apply(this, arguments);
    this._initSortable();
    return this;
  },

  _initSortable: function () {
    this.$list.sortable({
      axis: 'y',
      items: '.js-sortable',
      tolerance: 'pointer',
      containment: this.$list,
      forceHelperSize: true,
      forcePlaceholderSize: true,
      update: this._onSortableUpdate.bind(this)
    });
  },

  _onSortableUpdate: function (event, ui) {
    var sorted = [];
    _.each(this.items, function (item) {
      var index = item.$el.index(this.$list);
      sorted[index] = item;
    });

    this.items = sorted;
    this.commit();
  }
});

},{"backbone":"backbone","jquery-ui":455,"underscore":"underscore"}],166:[function(require,module,exports){
var Backbone = require('backbone');

module.exports = Backbone.Collection.extend({
  removeTag: function (label) {
    var m = this.findWhere({label: label});
    m && this.remove(m);
  },

  addTag: function (label) {
    var m = this.findWhere({label: label});
    !m && this.add({label: label});
  },

  getValue: function () {
    return this.map(function (mdl) {
      return mdl.get('label');
    });
  }
});

},{"backbone":"backbone"}],167:[function(require,module,exports){
var CoreView = require('backbone/core-view');

module.exports = CoreView.extend({
  tagName: 'li',

  initialize: function (opts) {
    if (!opts.label) throw new Error('label is required');
    this._label = opts.label;
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(this._label);
    return this;
  }
});

},{"backbone/core-view":454}],168:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var template = require('./taglist.tpl');
var TagView = require('./taglist-item-view');
var TagCollection = require('./taglist-collection');
var EditorHelpers = require('../editor-helpers-extend');

require('jquery');
require('jquery-ui');
require('tagit');

Backbone.Form.editors.Taglist = Backbone.Form.editors.Base.extend({
  className: 'Form-tags CDB-Text',
  events: {
    'mouseover': '_onMouseOver',
    'mouseout': '_onMouseOut'
  },
  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    this._tagCollection = new TagCollection(this._normalize(opts.schema.options.tags));

    this.isEditable = opts.schema.options.isEditable || opts.schema.options.isEditable === undefined;
  },

  render: function () {
    this._initViews();
    return this;
  },

  _initViews: function () {
    var self = this;
    var tagsPlaceholder = (!this.isEditable && this._tagCollection.length === 0)
                          ? _t('components.taglist.none')
                          : _t('components.taglist.placeholder');

    this.$el.html(template());

    this._tagCollection.each(this._renderTag, this);

    this.$('.js-tagsList').tagit({
      allowSpaces: true,
      caseSensitive: false,
      placeholderText: tagsPlaceholder,
      readOnly: !this.isEditable,
      onBlur: function () {
        self.isEditable && self.$el.removeClass('is-focus');
        self.trigger('blur', self);
      },
      onFocus: function () {
        self.isEditable && self.$el.removeClass('is-hover').addClass('is-focus');
        self.trigger('focus', self);
      },
      afterTagAdded: self._onTagAdded.bind(self),
      afterTagRemoved: self._onTagRemoved.bind(self)
    });
  },

  _renderTag: function (model) {
    var view = new TagView({
      label: model.get('label')
    });

    this.$('.js-tagsList').append(view.render().el);
  },

  focus: function () {
    if (this.hasFocus) return;
    this.$el.focus();
  },

  blur: function () {
    if (!this.hasFocus) return;
    this.$el.blur();
  },

  getValue: function () {
    return this._tagCollection.getValue();
  },

  setValue: function (tags) {
    this._tagCollection.reset(this._normalize(tags));
    this._destroyTagit();
    this.render();
    this.trigger('change', this);
  },

  _onMouseOver: function () {
    !this.$el.hasClass('is-focus') && this.$el.addClass('is-hover');
  },

  _onMouseOut: function () {
    !this.$el.hasClass('is-focus') && this.$el.removeClass('is-hover');
  },

  _onTagRemoved: function (e, ui) {
    var tag = ui.tag.find('.tagit-label').text();
    this._tagCollection.removeTag(tag);
    this.trigger('change', this);
  },

  _onTagAdded: function (e, ui) {
    var tag = ui.tag.find('.tagit-label').text();
    this._tagCollection.addTag(tag);
    this.trigger('change', this);
  },

  _normalize: function (tags) {
    return _.map(tags, function (tag) {
      return {
        label: tag.trim()
      };
    });
  },

  _destroyTagit: function () {
    // cannot call public methods before initilization
    // checking ui-widget class does the trick
    (this.$('.ui-widget').length > 0) && this.$('.js-tagsList').tagit('destroy');
  },

  remove: function () {
    this._destroyTagit();
    Backbone.Form.editors.Base.prototype.remove.apply(this);
  },

  clean: function () {
    this.$el.remove();
  }
});

},{"../editor-helpers-extend":62,"./taglist-collection":166,"./taglist-item-view":167,"./taglist.tpl":169,"backbone":"backbone","jquery":"jquery","jquery-ui":455,"tagit":459,"underscore":"underscore"}],169:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="Form-tagsList js-tagsList"></ul>';
}
return __p;
};

},{"underscore":"underscore"}],170:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var EditorHelpers = require('./editor-helpers-extend');

Backbone.Form.editors.Text = Backbone.Form.editors.Text.extend({
  className: 'CDB-InputText CDB-Text',

  initialize: function (opts) {
    Backbone.Form.editors.Base.prototype.initialize.call(this, opts);
    EditorHelpers.setOptions(this, opts);

    var schema = this.schema;

    // Allow customising text type (email, phone etc.) for HTML5 browsers
    var type = 'text';

    if (schema && schema.editorAttrs && schema.editorAttrs.type) type = schema.editorAttrs.type;
    if (schema && schema.dataType) type = schema.dataType;

    this.$el.attr('type', type);

    this.determineChange = _.debounce(this.determineChange, 200);
  },

  render: function () {
    this.setValue(this.value);
    this._toggleDisableState();

    if (this._isCopyButtonEnabled()) {
      this._toggleClipboardState();
    }

    return this;
  },

  getValue: function () {
    var val = this.$el.val();

    return (val === '') ? null : val;
  },

  _toggleClipboardState: function () {
    this.$el.toggleClass('Share-input-field u-ellipsis', this._isCopyButtonEnabled());
  },

  _togglePlaceholder: function () {
    if (this.options.placeholder) {
      this.$el.attr('placeholder', this.options.placeholder);
    } else {
      var placeholder = (this.value === null) ? 'null' : '';
      this.$el.attr('placeholder', placeholder);
    }
  },

  _toggleDisableState: function () {
    if (this.options.disabled) {
      this.$el.attr('readonly', '');
      this.$el.attr('placeholder', '');

      // if it's disabled AND has copy, leave just readonly
      if (this._isCopyButtonEnabled()) {
        this.$el.removeAttr('disabled');
      }
    } else {
      this.$el.removeAttr('readonly');
      this._togglePlaceholder();
    }

    this.$el.toggleClass('is-disabled', !!this.options.disabled);
  },

  _isCopyButtonEnabled: function () {
    return !!this.options.hasCopyButton;
  }
});

},{"./editor-helpers-extend":62,"backbone":"backbone","underscore":"underscore"}],171:[function(require,module,exports){
var Backbone = require('backbone');

Backbone.Form.editors.TextArea = Backbone.Form.editors.Text.extend({
  tagName: 'textarea',
  className: 'CDB-Textarea',

  render: function () {
    this.setValue(this.value);
    this._toggleDisableState();

    return this;
  },

  getValue: function () {
    var val = this.$el.val();

    return (val === '') ? null : val;
  },

  _toggleDisableState: function () {
    if (this.options.disabled) {
      this.$el.attr('readonly', '');
      this.$el.attr('placeholder', '');
    } else {
      this.$el.removeAttr('readonly');
      this._togglePlaceholder();
    }

    this.$el.toggleClass('is-disabled', !!this.options.disabled);
  }
});

},{"backbone":"backbone"}],172:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var template = require('./toggle.tpl');

Backbone.Form.editors.Toggle = Backbone.Form.editors.Radio.extend({
  className: 'Editor-formLabel CDB-Text CDB-Size-medium u-alignCenter',

  _arrayToHtml: function (array) {
    var name = this.getName();
    var id = this.id;

    var items = _.map(array, function (option, index) {
      var val = this.form.model.get(this.key);
      var item = {
        name: name,
        id: id + '-' + index
      };

      if (_.isObject(option)) {
        item.value = (option.val || option.val === 0) ? option.val : '';
        item.label = option.label;
        item.help = option.help;
        item.labelHTML = option.labelHTML;
        item.selected = (val !== void 0) ? val === option.val : option.selected;
      } else {
        item.value = option;
        item.label = option;
        item.selected = (val !== void 0) ? val === option : option.selected;
      }

      return item;
    }.bind(this));

    return template({ items: items });
  }
});

},{"./toggle.tpl":173,"backbone":"backbone","underscore":"underscore"}],173:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 _.each(items, function(item, index) { 
__p+='\n  ';
 if (item.selected) { 
__p+='\n    <li class="u-tSpace">\n      <input type="radio" class="Editor-toggleRadio" name="'+
((__t=( item.name ))==null?'':__t)+
'" value="'+
((__t=( item.value ))==null?'':_.escape(__t))+
'" id="'+
((__t=( item.id ))==null?'':__t)+
'" checked="checked" />\n      ';
 if (item.help) { 
__p+='<p class="Editor-toggleHelp CDB-Text CDB-Size-small u-altTextColor">'+
((__t=( item.help ))==null?'':__t)+
'</p>';
 } 
__p+='\n    </li>\n  ';
 } else { 
__p+='\n    <li class="u-tSpace u-txt-right">\n      <input type="radio" name="'+
((__t=( item.name ))==null?'':__t)+
'" value="'+
((__t=( item.value ))==null?'':_.escape(__t))+
'" id="'+
((__t=( item.id ))==null?'':__t)+
'" />\n      <label class="u-upperCase u-actionTextColor CDB-Text is-semibold CDB-Size-small u-iBlock" for="'+
((__t=( item.id ))==null?'':__t)+
'">';
 if (item.labelHTML){ 
__p+=''+
((__t=( item.labelHTML ))==null?'':__t)+
'';
 }else{ 
__p+=''+
((__t=( item.label ))==null?'':_.escape(__t))+
'';
 } 
__p+='</label>\n    </li>\n  ';
 } 
__p+='\n';
 }); 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],174:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var $ = require('jquery');
var TipsyTooltipView = require('../tipsy-tooltip-view.js');
var Clipboard = require('clipboard');

Backbone.Form.Field = Backbone.Form.Field.extend({

  initialize: function (options) {
    this.trackingClass = options.trackingClass;
    this.constructor.__super__.initialize.apply(this, arguments);
  },

  render: function () {
    this.constructor.__super__.render.apply(this, arguments);
    if (this.schema.help) {
      this._setHelp();
    }
    if (this._isCopyButtonEnabled()) {
      this._initClipboard();
    }
    return this;
  },

  /**
  * OVERWRITTEN the creation of the full field schema, merging defaults etc.
  *
  * @param {Object|String} schema
  *
  * @return {Object}
  */
  createSchema: function (schema) {
    var editorType = schema.type;
    schema = this.constructor.__super__.createSchema.apply(this, arguments);
    schema.editorType = editorType;
    return schema;
  },

  /**
   * OVERWRITTEN the creation of the editor specified in the schema; either an
   * editor string name or a constructor function
   *
   * @return {View}
   */
  createEditor: function () {
    var options = _.extend(
      _.pick(this, 'schema', 'form', 'key', 'model', 'value', 'trackingClass'),
      { id: this.createEditorId() }
    );

    var ConstructorFn = this.schema.type;

    return new ConstructorFn(options);
  },

  _setHelp: function () {
    this._helpTooltip = this._createTooltip({
      $el: this.$('.js-help')
    });
  },

  // Changed original setError function in order to add
  // the error tooltip
  setError: function (msg) {
    if (this.editor.hasNestedForm) return;
    this.$el.addClass(this.errorClassName);
    this._destroyErrorTooltip();
    this._errorTooltip = this._createTooltip({
      gravity: 'w',
      className: 'is-error',
      msg: msg,
      offset: 5
    });
    this._errorTooltip.showTipsy();
  },

  // Changed original clearError function in order to remove
  // the error tooltip
  clearError: function () {
    this.$el.removeClass(this.errorClassName);
    this._destroyErrorTooltip();
  },

  _initClipboard: function () {
    if (this._clipboard) {
      this._clipboard.destroy();
    }

    var btn = this.$('.js-copy');
    this._clipboard = new Clipboard(btn.get(0));
  },

  _createTooltip: function (opts) {
    return new TipsyTooltipView({
      el: opts.$el || this.$el,
      gravity: opts.gravity || 's',
      className: opts.className || '',
      offset: opts.offset || 0,
      title: function () {
        return opts.msg || $(this).data('tooltip');
      }
    });
  },

  _destroyErrorTooltip: function () {
    if (this._errorTooltip) {
      this._errorTooltip.hideTipsy();
      this._errorTooltip.destroyTipsy();
    }
  },

  _destroyHelpTooltip: function () {
    if (this._helpTooltip) {
      this._helpTooltip.destroyTipsy();
    }
  },

  _destroyClipboard: function () {
    if (this._clipboard) {
      this._clipboard.destroy();
    }
  },

  // Changed original templateData function in order to add a
  // new template attribute (hasNestedForm)
  templateData: function () {
    var schema = this.schema;
    var type;

    try {
      type = this.form.schema[this.key].type;
    } catch (e) {
      type = undefined;
    }

    return {
      help: schema.help || '',
      isCopyButtonEnabled: this._isCopyButtonEnabled(),
      hasNestedForm: this.editor.hasNestedForm,
      title: schema.title,
      fieldAttrs: schema.fieldAttrs,
      editorAttrs: schema.editorAttrs,
      key: this.key,
      type: type,
      editorId: this.editor.id,
      editorType: this.editor.el.type
    };
  },

  _isCopyButtonEnabled: function () {
    return !!this.schema.hasCopyButton;
  },

  remove: function () {
    this._destroyErrorTooltip();
    this._destroyHelpTooltip();
    this._destroyClipboard();
    this.editor.remove();
    Backbone.View.prototype.remove.call(this);
  }

}, {
  template: require('./field.tpl'),
  errorClassName: 'CDB-FieldError'
});

},{"../tipsy-tooltip-view.js":325,"./field.tpl":175,"backbone":"backbone","clipboard":"clipboard","jquery":"jquery","underscore":"underscore"}],175:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Text Editor-formInner';
 if (type){ 
__p+=' Editor-formInner--'+
((__t=( type ))==null?'':_.escape(__t))+
'';
 } 
__p+='">\n  ';
 if (title) { 
__p+='\n    <label class="CDB-Legend ';
 if (editorType){ 
__p+=' CDB-Legend--'+
((__t=( editorType ))==null?'':_.escape(__t))+
'';
 } 
__p+=' u-upperCase CDB-Text is-semibold CDB-Size-small u-rSpace--m" for="'+
((__t=( editorId ))==null?'':_.escape(__t))+
'" title="'+
((__t=( title ))==null?'':_.escape(__t))+
'">\n      <div class="u-ellipsis ';
 if (help) { 
__p+='Editor-formHelp';
 } 
__p+='">\n        <span class="';
 if (help) { 
__p+=' js-help is-underlined';
 } 
__p+='" ';
 if (help) { 
__p+=' data-tooltip="'+
((__t=( help ))==null?'':_.escape(__t))+
'"';
 } 
__p+=' >'+
((__t=( title ))==null?'':_.escape(__t))+
'</span>\n      </div>\n    </label>\n  ';
 } 
__p+='\n  <div class="Editor-formInput u-flex u-alignCenter" data-editor>\n    ';
 if (isCopyButtonEnabled) { 
__p+='\n      <button type="button" class="Share-copy CDB-Button CDB-Button--small js-copy" data-clipboard-target="#'+
((__t=( editorId ))==null?'':_.escape(__t))+
'">\n        <span class="CDB-Button-Text CDB-Text CDB-Size-small u-actionTextColor">'+
((__t=( _t('components.backbone-forms.copy-button') ))==null?'':_.escape(__t))+
'</span>\n      </button>\n    ';
 } 
__p+='\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],176:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

// overwirte template in order to be able to use flex
/*eslint-disable */
Backbone.Form.Fieldset.template = _.template('\
  <div class="Editor-fieldset" data-fields>\
    <% if (legend) { %>\
      <legend><%= legend %></legend>\
    <% } %>\
  </div>\
');
/*eslint-enable */

},{"backbone":"backbone","underscore":"underscore"}],177:[function(require,module,exports){
var Backbone = require('backbone');

Backbone.Form = Backbone.Form.extend({

  initialize: function (options) {
    this.options = options;
    this.constructor.__super__.initialize.apply(this, arguments);
  },

  createField: function (key, schema) {
    var options = {
      form: this,
      key: key,
      schema: schema,
      idPrefix: this.idPrefix,
      trackingClass: this.options.trackingClass
    };

    if (this.model) {
      options.model = this.model;
    } else if (this.data) {
      options.value = this.data[key];
    } else {
      options.value = undefined;
    }

    var field = new this.Field(options);

    this.listenTo(field.editor, 'all', this.handleEditorEvent);

    return field;
  }

});

},{"backbone":"backbone"}],178:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var Backbone = require('backbone');
require('backbone-forms');
Backbone.$ = $;

// Custom validators
_.extend(
  Backbone.Form.validators,
  {
    interval: require('./validators/interval.js')
  }
);

// Requiring custom form components
require('./form.js');
require('./fieldset-template.js');
require('./field.js');
require('./editors/base.js');
require('./editors/text.js');
require('./editors/textarea.js');
require('./editors/number/number.js');
require('./editors/select/select-view.js');
require('./editors/select/multi-select-view.js');
require('./editors/radio/radio.js');
require('./editors/enabler/enabler-view.js');
require('./editors/toggle/toggle.js');
require('./editors/enabler-editor/enabler-editor-view.js');
require('./editors/node-dataset/node-dataset-view.js');
require('./editors/operators/operators-view.js');
require('./editors/list/list.js');
require('./editors/list/list-item.js');
require('./editors/sortable-list.js');
require('./editors/legend/category-item.js');
require('./editors/slider/slider.js');
require('./editors/fill/fill.js');
require('./editors/taglist/taglist.js');
require('./editors/datetime/datetime.js');
require('./editors/select/suggest-view.js');
require('./editors/data-observatory/dropdown-view.js');
require('./editors/code-editor');

},{"./editors/base.js":39,"./editors/code-editor":40,"./editors/data-observatory/dropdown-view.js":43,"./editors/datetime/datetime.js":60,"./editors/enabler-editor/enabler-editor-view.js":63,"./editors/enabler/enabler-view.js":66,"./editors/fill/fill.js":78,"./editors/legend/category-item.js":140,"./editors/list/list-item.js":141,"./editors/list/list.js":142,"./editors/node-dataset/node-dataset-view.js":146,"./editors/number/number.js":147,"./editors/operators/operators-view.js":154,"./editors/radio/radio.js":156,"./editors/select/multi-select-view.js":158,"./editors/select/select-view.js":160,"./editors/select/suggest-view.js":162,"./editors/slider/slider.js":163,"./editors/sortable-list.js":165,"./editors/taglist/taglist.js":168,"./editors/text.js":170,"./editors/textarea.js":171,"./editors/toggle/toggle.js":172,"./field.js":174,"./fieldset-template.js":176,"./form.js":177,"./validators/interval.js":179,"backbone":"backbone","backbone-forms":"backbone-forms","jquery":"jquery","underscore":"underscore"}],179:[function(require,module,exports){
module.exports = function (opts) {
  // get the min value
  var minValue = parseFloat(opts.min) || 0;
  var maxValue = parseFloat(opts.max) || 0;
  var err = {
    type: opts.type,
    message: _t('components.backbone-forms.interval-error', { minValue: opts.min, maxValue: opts.max })
  };
  return function interval (value, attrs) {
    var fieldValue = 0;

    if (value === null || value === undefined || value === '') return err;

    // check if the value is number
    if (!isNaN(parseFloat(value)) && isFinite(value)) {
      fieldValue = parseFloat(value);
    }
    if (minValue > fieldValue || maxValue < fieldValue) {
      return err;
    }
    return;
  };
};

},{}],180:[function(require,module,exports){
var $ = require('jquery');
var CoreView = require('backbone/core-view');
var utils = require('../helpers/utils');
var _ = require('underscore');

var IMAGE_DIM = 18;
var IMAGE_FILE_ATTRS = {
  width: '18px',
  height: '18px'
};

var VIEWBOX = _.template('0 0 <%- w %> <%- h %>');
module.exports = CoreView.extend({
  initialize: function (opts) {
    if (!opts.imageClass) { throw new Error('Image class is mandatory.'); }

    this._imageClass = opts.imageClass;
    this._imageURL = opts.imageUrl;
    this._color = opts.color;

    this._lastImage = {
      url: null,
      content: null
    };
  },

  render: function () {
    this.$el.empty();

    this._loadImage();

    return this;
  },

  _loadImage: function () {
    if (!this._imageURL) { // the URL could be null or undefined
      return;
    }

    var self = this;

    if (this._isSVG(this._imageURL)) {
      this._loadSVG();
    } else {
      var $img = $('<img crossorigin="anonymous"/>');
      $img.attr('class', self._imageClass + ' js-image');
      $img.attr('src', this._imageURL + '?req=markup');

      for (var attribute in IMAGE_FILE_ATTRS) {
        $img.attr(attribute, IMAGE_FILE_ATTRS[attribute]);
      }

      this.$el.append($img);
    }
  },

  _loadSVG: function () {
    var self = this;

    this._requestImageURL(this._imageURL, function (content) {
      var svg = content.cloneNode(true);
      var $svg = $(svg);
      $svg = $svg.removeAttr('xmlns:a');
      $svg.attr('class', self._imageClass + ' js-image');

      var bbox = {
        w: IMAGE_DIM,
        h: IMAGE_DIM
      };

      if (!$svg.attr('viewBox')) {
        if ($svg.attr('height') && $svg.attr('width')) {
          bbox = {
            w: svg.width.baseVal.value,
            h: svg.height.baseVal.value
          };
        }

        $svg.attr('viewBox', VIEWBOX(bbox));
      }

      for (var attribute in IMAGE_FILE_ATTRS) {
        $svg.attr(attribute, IMAGE_FILE_ATTRS[attribute]);
      }

      self.$el.append($svg);

      $svg.css('fill', self._color);
      $svg.find('g').css('fill', 'inherit');
      $svg.find('path').css('fill', 'inherit');
    });
  },

  _requestImageURL: function (url, callback) {
    var self = this;
    var completeUrl = url + '?req=ajax';

    if (this._lastImage.url === completeUrl) {
      callback && callback(this._lastImage.content);
    } else {
      $.ajax(completeUrl)
      .done(function (data) {
        self._lastImage.url = completeUrl;
        var content = self._lastImage.content = data.getElementsByTagName('svg')[0];
        callback && callback(content);
      })
      .fail(function () {
        throw new Error("Couldn't get " + completeUrl + ' file.');
      });
    }
  },

  updateImageColor: function (color) {
    this.$('.js-image').css('fill', color);
  },

  _isSVG: function (url) {
    if (!url) {
      return false;
    }
    var noQueryString = url.split('?')[0];
    return noQueryString && utils.endsWith(noQueryString.toUpperCase(), 'SVG');
  }
});

},{"../helpers/utils":435,"backbone/core-view":454,"jquery":"jquery","underscore":"underscore"}],181:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var checkAndBuildOpts = require('../../helpers/required-opts');

var REQUIRED_OPTS = [
  'infoboxModel',
  'infoboxCollection'
];

module.exports = CoreView.extend({

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._initBinds();
    this._setSelectedModel();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this.listenTo(this._infoboxModel, 'change:state', this._onChangeState);
    this.listenTo(this._infoboxModel, 'change:visible', this.render);
  },

  _initViews: function () {
    var createContentView;

    if (this._selectedModel) {
      createContentView = this._selectedModel.get('createContentView');
      this.infoboxView = createContentView();
      this.$el.append(this.infoboxView.render().el);
      this.addView(this.infoboxView);
      this._initSubviewBinds();
    }
  },

  _setSelectedModel: function () {
    var state = this._infoboxModel.get('state');
    this._selectedModel = this._infoboxCollection.setSelected(state);
  },

  _onChangeState: function () {
    this._setSelectedModel();
    this.render();
  },

  _initSubviewBinds: function () {
    this.listenTo(this.infoboxView, 'action:main', this._onMainAction);
    this.listenTo(this.infoboxView, 'action:second', this._onSecondAction);
    this.listenTo(this.infoboxView, 'action:close', this._onClose);
  },

  _onMainAction: function () {
    var action = this._selectedModel.get('mainAction');
    action && action();
  },

  _onSecondAction: function () {
    var action = this._selectedModel.get('secondAction');
    action && action();
  },

  _onClose: function () {
    var action = this._selectedModel.get('closeAction');
    if (action) {
      action();
    } else {
      // if no action associated, we still need to hide the infobox
      this._infoboxModel.set('state', null);
    }
  }
});

},{"../../helpers/required-opts":432,"backbone/core-view":454}],182:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var utils = require('../../helpers/utils');

var REQUIRED_OPTS = [
  'template',
  'onEdit',
  'renderOptions'
];

var DBLCLICK_TIMEOUT = 200;
var clicks = 0;
var ESCAPE_KEY_CODE = 27;
var ENTER_KEY_CODE = 13;

module.exports = CoreView.extend({
  events: {
    'blur .js-input': 'hide',
    'keyup .js-input': '_onKeyUpInput'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this._onClickHandler = this._onClickHandler.bind(this);
    this.edit = this.edit.bind(this);

    this._timeout = opts.timeout || DBLCLICK_TIMEOUT;
  },

  render: function () {
    this._unbindEvents();
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    this._initBinds();
    return this;
  },

  _initBinds: function () {
    if (this.options.onClick) {
      this._onClick = this.options.onClick;
      this._title().on('click', this._onClickHandler);
    } else {
      this._title().on('dblclick', this.edit);
    }
  },

  _unbindEvents: function () {
    var $title = this._title();
    $title && $title.off('click dblclick');
  },

  _onClickHandler: function (e) {
    var self = this;
    clicks++;
    if (clicks === 1) {
      setTimeout(function () {
        if (clicks === 1) {
          self._onClick && self._onClick(e);
        } else {
          self.edit();
        }
        clicks = 0;
      }, this._timeout);
    }
  },

  _initViews: function () {
    this.$el.append(this._template(this._renderOptions));
    this.setElement(this.$('.Inline-editor'));
  },

  edit: function () {
    this.$('.js-input').prop('readonly', false).show().focus();
    this.$('.js-input').get(0).setSelectionRange(0, this.$('.js-input').val().length);
  },

  getValue: function () {
    var inputValue = this.$('.js-input').val();
    return utils.sanitizeHtml(inputValue);
  },

  _title: function () {
    return this.$('.js-title');
  },

  hide: function () {
    this.$('.js-input').prop('readonly', true).hide();
  },

  clean: function () {
    this._unbindEvents();
    CoreView.prototype.clean.call(this);
  },

  _onKeyUpInput: function (e) {
    if (e.which === ESCAPE_KEY_CODE) {
      this.hide();
    }

    if (e.which === ENTER_KEY_CODE) {
      this._onEdit && this._onEdit(this.getValue());
    }
  }
});

},{"../../helpers/utils":435,"backbone/core-view":454,"underscore":"underscore"}],183:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

var LikeModel = Backbone.Model.extend({
  defaults: {
    likeable: true
  },

  url: function (method) {
    var version = this._configModel.urlVersion('like');
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/' + version + '/viz/' + this.get('vis_id') + '/like';
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    if (!attrs.vis_id) throw new Error('vis_id attribute is required');
    this._configModel = opts.configModel;

    this.on('destroy', function () {
      this.set({
        liked: false,
        likes: this.get('likes') - 1
      });
    }, this);
  },

  _onSaveError: function (model, response) {
    this.trigger('error', {
      status: response.status,
      statusText: response.statusText
    });
  },

  toggleLiked: function () {
    if (this.get('liked')) {
      this.destroy();
    } else {
      this.set({ id: null }, { silent: true });
      this.save({}, {
        error: this._onSaveError.bind(this)
      });
    }
  }

}, {
  newByVisData: function (opts) {
    var d = _.defaults({
      id: opts.liked ? opts.vis_id : null
    }, _.omit(opts, 'url', 'configModel'));

    var m = new LikeModel(d, {
      configModel: opts.configModel
    });

    if (opts.url) {
      m.url = opts.url;
    }

    return m;
  }
});

module.exports = LikeModel;

},{"backbone":"backbone","underscore":"underscore"}],184:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="IntermediateInfo">\n  <div class="CDB-LoaderIcon CDB-LoaderIcon--big is-dark js-loader">\n    <svg class="CDB-LoaderIcon-spinner" viewbox="0 0 50 50">\n      <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"/>\n    </svg>\n  </div>\n  <h4 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m u-tSpace-xl">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h4>\n  <div class="CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( descHTML ))==null?'':__t)+
'</div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],185:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text CDB-Size-medium u-altTextColor">\n  "'+
((__t=( quote ))==null?'':__t)+
'"\n</p>\n';
 if (author) { 
__p+='\n  <p class="CDB-Text CDB-Size-medium u-altTextColor u-tSpace"><i> '+
((__t=( author ))==null?'':_.escape(__t))+
'</i></p>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],186:[function(require,module,exports){
var template = require('./quote.tpl');

var QUOTES = [
  { quote: 'Geographers never get lost. They just do accidental field work.', author: 'Nicholas Chrisman' },
  { quote: 'Geography is just physics slowed down, with a couple of trees stuck in it.', author: 'Terry Pratchett' },
  { quote: 'Not all those who wander are lost.', author: 'J. R. R. Tolkien' },
  { quote: 'In that Empire, the Art of Cartography attained such Perfection that the map of a single Province occupied the entirety of a City.', author: 'Jorge Luis Borges' },
  { quote: 'X marks the spot', author: 'Indiana Jones' },
  { quote: "It's turtles all the way down.", author: null },
  { quote: 'Remember: no matter where you go, there you are.', author: null },
  { quote: "Without geography, you're nowhere!", author: 'Jimmy Buffett' },
  { quote: 'our earth is a globe / whose surface we probe /<br />no map can replace her / but just try to trace her', author: 'Steve Waterman' },
  { quote: 'Everything happens somewhere.', author: 'Doctor Who' },
  { quote: 'A map is the greatest of all epic poems. Its lines and colors show the realization of great dreams.', author: 'Gilbert H. Grosvenor' },
  { quote: 'Everything is related to everything else,<br />but near things are more related than distant things.', author: "Tobler's first law of geography" },
  { quote: 'Hic Sunt Dracones', author: null },
  { quote: 'Here be dragons', author: null },
  { quote: "Stand in the place where you live / Now face North /<br/>Think about direction / Wonder why you haven't before", author: 'R.E.M' },
  { quote: 'The virtue of maps, they show what can be done with limited space, they foresee that everything can happen therein.', author: 'Jos Saramago' }
];

/**
 * Random quote
 */
module.exports = function () {
  var idx = Math.round(Math.random() * (QUOTES.length - 1));

  return template(QUOTES[idx]);
};

},{"./quote.tpl":185}],187:[function(require,module,exports){
var cdb = require('cartodb.js');
var template = require('./loading.tpl');
var randomQuote = require('./random-quote');

/**
 * @param {Object} opts
 * @param {String=} opts.title
 * @param {String=} opts.desc
 */
module.exports = function (opts) {
  var customDesc = opts.desc && cdb.core.sanitize(opts.desc);

  return template({
    title: opts.title || '',
    descHTML: customDesc || randomQuote()
  });
};

},{"./loading.tpl":184,"./random-quote":186,"cartodb.js":"cartodb.js"}],188:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

module.exports = Backbone.Model.extend({

  defaults: {
    eventName: '',
    eventProperties: {}
  },

  url: function () {
    return this._configModel.get('base_url') + '/api/v3/metrics';
  },

  initialize: function (attrs, opts) {
    if (!opts.userId) { throw new Error('userId is required'); }
    if (!opts.visId) { throw new Error('visId is required'); }
    if (!opts.configModel) { throw new Error('configModel is required'); }

    this._userId = opts.userId;
    this._visId = opts.visId;
    this._configModel = opts.configModel;
  },

  toJSON: function () {
    return {
      name: this.get('eventName'),
      properties: _.extend(
        {},
        this.get('eventProperties'),
        {
          visualization_id: this._visId,
          user_id: this._userId
        }
      )
    };
  }
});

},{"backbone":"backbone","underscore":"underscore"}],189:[function(require,module,exports){
var MetricsModel = require('./metrics-model');

/**
 *  Metrics singleton tracker.
 *  It sends any event to metrics endpoint.
 */

module.exports = (function () {
  return {
    init: function (opts) {
      if (!opts) { throw new Error('visId, userId and configModel are required'); }
      if (!opts.userId) { throw new Error('userId is required'); }
      if (!opts.visId) { throw new Error('visId is required'); }
      if (!opts.configModel) { throw new Error('configModel is required'); }

      this._userId = opts.userId;
      this._visId = opts.visId;
      this._configModel = opts.configModel;
    },

    track: function (eventName, eventProperties) {
      if (!eventName) { throw new Error('eventName is required'); }

      var metricModel = new MetricsModel({
        eventName: eventName,
        eventProperties: eventProperties
      }, {
        userId: this._userId,
        visId: this._visId,
        configModel: this._configModel
      });

      metricModel.save();
    }
  };
})();

},{"./metrics-model":188}],190:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var $ = require('jquery');
var _ = require('underscore');
var renderLoading = require('../../loading/render-loading');
var ENTER_KEY_CODE = 13;
var REQUIRED_OPTS = [
  'template',
  'runAction',
  'modalModel'
];

/**
 *  Confirmation modal dialog
 */

module.exports = CoreView.extend({
  className: 'Dialog-content',

  events: {
    'click .js-confirm': '_onConfirm',
    'click .js-cancel': '_onCancel'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    if (opts.loadingTitle) {
      this._hasLoading = true;
      this._loadingTitle = opts.loadingTitle;
    }

    if (opts.renderOpts) {
      this._hasRenderOpts = true;
      this._renderOpts = opts.renderOpts;
    }

    this._onKeyDown = this._onKeyDown.bind(this);
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();

    var html = this._hasRenderOpts ? this._template(this._renderOpts) : this._template();
    this.$el.html(html);

    return this;
  },

  _initBinds: function () {
    $(document).bind('keydown', this._onKeyDown);
  },

  _disableBinds: function () {
    $(document).unbind('keydown', this._onKeyDown);
  },

  _onKeyDown: function (ev) {
    var keyCode = ev.which;
    if (keyCode === ENTER_KEY_CODE) {
      this._onConfirm();
    }
  },

  _renderLoadingView: function () {
    this.$el.html(
      renderLoading({
        title: this._loadingTitle
      })
    );
  },

  _$content: function () {
    return this.$('.js-content');
  },

  _onConfirm: function () {
    if (this._hasLoading) {
      this._renderLoadingView();
    } else {
      this._modalModel.destroy();
    }

    this._runAction();
  },

  _onCancel: function () {
    this._modalModel.destroy();
  },

  clean: function () {
    this._disableBinds();
    CoreView.prototype.clean.apply(this);
  }

});

},{"../../loading/render-loading":187,"backbone/core-view":454,"jquery":"jquery","underscore":"underscore"}],191:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var renderLoading = require('../../loading/render-loading');
var ErrorView = require('../../error/error-view');
var REQUIRED_OPTS = [
  'errorTitle',
  'loadingTitle',
  'runAction',
  'modalModel'
];

/**
 *  Remove confirmation dialog
 */
module.exports = CoreView.extend({
  className: 'Dialog-content',

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(
      renderLoading({
        title: this._loadingTitle
      })
    );
    this._runAction({
      error: this._renderErrorView.bind(this)
    });
    return this;
  },

  _renderErrorView: function (errorMessage) {
    var errorView = new ErrorView({
      title: this._errorTitle,
      desc: errorMessage
    });
    this.$el.html(errorView.render().el);
    this.addView(errorView);
  }

});

},{"../../error/error-view":37,"../../loading/render-loading":187,"backbone/core-view":454,"underscore":"underscore"}],192:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="IntermediateInfo">\n  <div class="Dialog-header Modal-header js-header">\n    <div class="Dialog-headerIcon Dialog-headerIcon--negative">\n      <i class="CDB-IconFont CDB-IconFont-cockroach"></i>\n    </div>\n    <h2 class="CDB-Text CDB-Size-large u-bSpace u-errorTextColor">'+
((__t=( _t('components.modals.dataset-metadata.error.title') ))==null?'':_.escape(__t))+
'</h2>\n    <h3 class="CDB-Text CDB-Size-medium u-secondaryTextColor">'+
((__t=( error ))==null?'':__t)+
'</h3>\n  </div>\n\n  <div class="Modal-body">\n    <div class="Modal-body-inner">\n\n      <div class="js-footer">\n        <ul class="Modal-actions is-narrow">\n          <li class="Modal-actions-button">\n            <button class="CDB-Button CDB-Button--primary js-back">\n              <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.dataset-metadata.back-btn') ))==null?'':_.escape(__t))+
'</span>\n            </button>\n          </li>\n        </ul>\n      </div>\n    </div>\n  </div>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],193:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var VisMetadataModel = require('../../../data/vis-metadata-model');
var template = require('./dataset-metadata.tpl');
var FooterView = require('./footer/footer-view');
var templateError = require('./dataset-metadata-error.tpl');
var templateLoading = require('../../loading/render-loading');
var FormView = require('./form/form-view');
var saveMetadata = require('./save-metadata-dataset');
var errorParser = require('../../../helpers/error-parser');
var Notifier = require('../../../components/notifier/notifier');
var utils = require('../../../helpers/utils');

module.exports = CoreView.extend({
  events: {
    'click .js-back': '_onBackFromError'
  },

  className: 'Dialog-content Dialog-content--expanded',

  initialize: function (opts) {
    if (!opts.modalModel) throw new TypeError('modalModel is required');
    if (!opts.visDefinitionModel) throw new TypeError('visDefinitionModel is required');
    if (!opts.configModel) throw new TypeError('configModel is required');
    if (opts.isLocked === undefined) throw new TypeError('isLocked is required');

    this._modalModel = opts.modalModel;
    this._visDefinitionModel = opts.visDefinitionModel;
    this._configModel = opts.configModel;
    this._isLocked = opts.isLocked;

    this._visMetadataModel = new VisMetadataModel({
      name: this._visDefinitionModel.get('name'),
      description: this._visDefinitionModel.get('description'),
      license: this._visDefinitionModel.get('license'),
      source: this._visDefinitionModel.get('source'),
      attributions: this._visDefinitionModel.get('attributions'),
      tags: this._visDefinitionModel.get('tags')
    });

    this._stateModel = new Backbone.Model({
      status: 'show'
    });

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();

    if (this._hasError()) {
      this._renderError();
    } else if (this._isLoading()) {
      this._renderLoading();
    } else {
      this.$el.html(template());
      this._initViews();
    }
    return this;
  },

  _initViews: function () {
    var formView = new FormView({
      visDefinitionModel: this._visDefinitionModel,
      visMetadataModel: this._visMetadataModel,
      configModel: this._configModel,
      isLocked: this._isLocked
    });

    this.$('.js-content').append(formView.render().el);
    this.addView(formView);

    var footerView = new FooterView({
      visMetadataModel: this._visMetadataModel,
      onSaveAction: this._onSave.bind(this)
    });

    this.$('.js-footer').append(footerView.render().el);
    this.addView(footerView);
  },

  _renderError: function () {
    var error = this._stateModel.get('error');
    this.$el.html(templateError({
      error: _t('components.modals.dataset-metadata.error.subtitle', {error: error})
    }));
  },

  _renderLoading: function () {
    this.$el.html(
      templateLoading({
        title: _t('components.modals.dataset-metadata.loading')
      })
    );
  },

  _initBinds: function () {
    this._stateModel.on('change:status', this.render, this);
    this.add_related_model(this._stateModel);
  },

  _hasError: function () {
    return this._stateModel.get('status') === 'error';
  },

  _isLoading: function () {
    return this._stateModel.get('status') === 'loading';
  },

  _onSave: function () {
    this._stateModel.set({status: 'loading'});

    saveMetadata({
      onSuccess: this._onSuccessSave.bind(this),
      onError: this._onErrorSave.bind(this),
      visDefinitionModel: this._visDefinitionModel,
      name: this._getMetadataName(),
      description: this._getMetadataDescription(),
      tags: this._getMetadataTags(),
      source: this._visMetadataModel.get('source'),
      attributions: this._visMetadataModel.get('attributions'),
      license: this._visMetadataModel.get('license')
    });
  },

  _onSuccessSave: function () {
    var self = this;
    Notifier.addNotification({
      status: 'success',
      info: _t('components.modals.dataset-metadata.success', {
        name: self._getMetadataName()
      }),
      closable: true,
      delay: Notifier.DEFAULT_DELAY
    });

    this._modalModel.destroy();
  },

  _onErrorSave: function (e) {
    this._stateModel.set({
      status: 'error',
      error: errorParser(e)
    });
  },

  _onBackFromError: function () {
    this._stateModel.set({status: 'show'});
  },

  _getMetadataName: function () {
    return utils.sanitizeHtml(this._visMetadataModel.get('name'));
  },

  _getMetadataDescription: function () {
    return utils.sanitizeHtml(this._visMetadataModel.get('description'));
  },

  _getMetadataTags: function () {
    return _.map(this._visMetadataModel.get('tags'), function (tag) {
      return utils.sanitizeHtml(tag);
    });
  }
});

},{"../../../components/notifier/notifier":252,"../../../data/vis-metadata-model":378,"../../../helpers/error-parser":426,"../../../helpers/utils":435,"../../loading/render-loading":187,"./dataset-metadata-error.tpl":192,"./dataset-metadata.tpl":194,"./footer/footer-view":195,"./form/form-view":197,"./save-metadata-dataset":199,"backbone":"backbone","backbone/core-view":454,"underscore":"underscore"}],194:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--grid u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="25px" height="25px" viewBox="0 0 25 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n          <g id="Group" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n              <path d="M16,13 L17,13 L17,5.5 C17,5.433 16.986,5.368 16.961,5.308 C16.936,5.247 16.899,5.192 16.853,5.146 L11.854,0.147 C11.808,0.101 11.753,0.064 11.692,0.039 C11.632,0.014 11.567,0 11.5,0 L0.5,0 C0.224,0 0,0.224 0,0.5 L0,21.5 C0,21.776 0.224,22 0.5,22 L9.5,22 L9.5,21 L1,21 L1,1 L11,1 L11,5.5 C11,5.776 11.224,6 11.5,6 L16,6 L16,13 L16,13 Z M12,1.707 L15.293,5 L12,5 L12,1.707 L12,1.707 Z" id="Shape" fill="#2E3C43"></path>\n              <path d="M23.854,14.646 L21.354,12.146 C21.166,11.958 20.834,11.958 20.647,12.146 L13.146,19.648 C13.089,19.705 13.054,19.773 13.03,19.845 C13.028,19.852 13.021,19.857 13.019,19.865 L12.019,23.365 C11.969,23.539 12.018,23.727 12.146,23.856 C12.241,23.951 12.369,24.002 12.5,24.002 C12.546,24.002 12.592,23.996 12.637,23.983 L16.137,22.983 C16.144,22.981 16.149,22.974 16.157,22.972 C16.229,22.948 16.297,22.913 16.354,22.856 L23.855,15.354 C24.05,15.158 24.05,14.842 23.854,14.646 L23.854,14.646 Z M16,21.795 L14.207,20.002 L19.001,15.207 L20.794,17 L16,21.795 L16,21.795 Z M13.747,20.957 L15.045,22.255 L13.228,22.775 L13.747,20.957 L13.747,20.957 Z M21.501,16.293 L19.708,14.5 L21.001,13.207 L22.794,15 L21.501,16.293 L21.501,16.293 Z" id="Shape" fill="#2E3C43"></path>\n          </g>\n      </svg>\n    </div>\n    <div>\n      <h2 class="CDB-Text CDB-Size-huge is-light u-bSpace--xl">\n        '+
((__t=( _t('components.modals.dataset-metadata.modal-title') ))==null?'':_.escape(__t))+
'\n      </h2>\n      <p class="CDB-Text CDB-Size-large u-altTextColor">\n        '+
((__t=( _t('components.modals.dataset-metadata.modal-desc') ))==null?'':_.escape(__t))+
'\n      </p>\n      <div class="Modal-listTextItem js-content"></div>\n      <div class="js-footer"></div>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],195:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./footer.tpl');

module.exports = CoreView.extend({

  tagName: 'ul',
  className: 'Modal-listActions u-flex u-alignCenter ',

  events: {
    'click .js-save': '_save'
  },

  initialize: function (opts) {
    if (!opts.visMetadataModel) throw new Error('visMetadataModel is required');
    if (!opts.onSaveAction) throw new Error('onSaveAction is required');

    this._visMetadataModel = opts.visMetadataModel;
    this._onSaveAction = opts.onSaveAction;
    this._initBinds();
  },

  _initBinds: function () {
    this._visMetadataModel.on('change', this.render, this);
  },

  render: function () {
    this.$el.html(
      template({
        canFinish: this._visMetadataModel.isValid()
      })
    );
    return this;
  },

  _save: function () {
    this._visMetadataModel.isValid() && this._onSaveAction();
  }

});

},{"./footer.tpl":196,"backbone/core-view":454}],196:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<li class="Modal-listActionsitem">\n  <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-close">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n      '+
((__t=( _t('components.modals.dataset-metadata.cancel-btn') ))==null?'':_.escape(__t))+
'\n    </span>\n  </button>\n</li>\n<li class="Modal-listActionsitem">\n  <button class="CDB-Button CDB-Button--primary CDB-Button--big js-save '+
((__t=( canFinish ? '' : 'is-disabled' ))==null?'':_.escape(__t))+
'">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase ">\n      '+
((__t=( _t('components.modals.dataset-metadata.save-btn') ))==null?'':_.escape(__t))+
'\n    </span>\n  </button>\n</li>\n\n';
}
return __p;
};

},{"underscore":"underscore"}],197:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var templateForm = require('./form.tpl');
require('../../../form-components/index');
var TipsyTooltipView = require('../../../tipsy-tooltip-view');
var utils = require('../../../../helpers/utils');

var REQUIRED_OPTS = [
  'visDefinitionModel',
  'visMetadataModel',
  'configModel'
];

module.exports = CoreView.extend({
  className: 'Metadata-form',

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    if (opts.isLocked === undefined) throw new TypeError('isLocked is required');
    this._isLocked = opts.isLocked;
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(templateForm());
    this._initViews();
    return this;
  },

  _initViews: function () {
    this._addNameView();
    this._addDescriptionView();
    this._addSourceView();
    this._addAttributionView();
    this._addLicenseView();
    this._addTagsView();
    this._addTooltip();
  },

  _addInputView: function (key, view, placeholder, container, disabled) {
    var obj = '_' + view;
    var $view = new Backbone.Form.editors.Text({
      key: key,
      model: this._visMetadataModel,
      schema: {
        options: this._visDefinitionModel.get(key),
        editorAttrs: {
          placeholder: placeholder,
          disabled: disabled || false
        }
      }
    });
    $view.on('change', this._commitView, this);
    this[obj] = $view;
    container.append($view.render().$el);
  },

  _addNameView: function () {
    this._addInputView('name', 'nameInput', _t('components.modals.dataset-metadata.form.name-placeholder'), this.$('.js-name-field'), this._isLocked);
  },

  _addSourceView: function () {
    this._addInputView('source', 'sourceInput', _t('components.modals.dataset-metadata.form.source-placeholder'), this.$('.js-source-field'));
  },

  _addAttributionView: function () {
    this._addInputView('attributions', 'attributionInput', _t('components.modals.dataset-metadata.form.attributions-placeholder'), this.$('.js-attributions-field'));
  },

  _buildLicenseOptions: function () {
    var items = this._configModel.get('licenses');
    var emptyOption = [{
      id: '',
      name: '-'
    }];
    return _.chain(emptyOption.concat(items))
      .compact()
      .map(function (d) {
        return {
          val: d.id,
          label: d.name
        };
      })
      .value();
  },

  _addLicenseView: function () {
    var options = this._buildLicenseOptions();

    this._selectView = new Backbone.Form.editors.Select({
      className: 'u-flex u-alignCenter',
      key: 'license',
      schema: {
        options: options
      },
      model: this._visMetadataModel,
      showSearch: false
    });

    this._selectView.on('change', this._commitView, this);
    this._selectView.setValue(this._visMetadataModel.get('license') || 0);
    this.$('.js-license-field').append(this._selectView.render().$el);
  },

  _addDescriptionView: function () {
    this._descriptionView = new Backbone.Form.editors.TextArea({
      className: 'CDB-Textarea Metadata-textarea',
      key: 'description',
      model: this._visMetadataModel,
      schema: {
        options: this._visDefinitionModel.get('description'),
        editorAttrs: {
          placeholder: _t('components.modals.dataset-metadata.form.description-placeholder')
        }
      }
    });

    this._descriptionView.on('change', this._commitView, this);

    this.$('.js-description-field').append(this._descriptionView.render().$el);
  },

  _addTagsView: function () {
    this._taglistView = new Backbone.Form.editors.Taglist({
      key: 'tags',
      model: this._visMetadataModel,
      schema: {
        options: {
          tags: this._visDefinitionModel.get('tags') || []
        }
      }
    });

    this._taglistView.on('change', this._commitView, this);

    this.$('.js-tags-field').append(this._taglistView.render().$el);
    this.addView(this._taglistView);
  },

  _addTooltip: function () {
    var title = this.$('.js-markdown').data('tooltip');
    this._removeTooltip();

    this._tooltip = new TipsyTooltipView({
      el: this.$('.js-markdown'),
      html: true,
      title: function () {
        return title;
      }
    });
  },

  _commitView: function (view) {
    view.commit();
    // Commit moves values from form to model. We need to override model value after commit()
    if (view.model.changed.hasOwnProperty('name')) {
      this._sanitizeName(view.model.get('name'));
    }
  },

  _sanitizeName: function (name) {
    this._visMetadataModel.set('name', utils.sanitizeHtml(name));
  },

  _removeTooltip: function () {
    if (this._tooltip) {
      this._tooltip.clean();
    }
  },

  _removeBinds: function () {
    this._nameView && this._nameView.off('change', this._commitView, this);
    this._descriptionView && this._descriptionView.off('change', this._commitView, this);
    this._taglistView && this._taglistView.off('change', this._commitView, this);
    this._sourceInput && this._sourceInput.off('change', this._commitView, this);
    this._attributionView && this._attributionView.off('change', this._commitView, this);
    this._selectView && this._selectView.off('change', this._commitView, this);
  },

  clean: function () {
    this._removeBinds();
    CoreView.prototype.clean.call(this);
  }
});

},{"../../../../helpers/utils":435,"../../../form-components/index":178,"../../../tipsy-tooltip-view":325,"./form.tpl":198,"backbone":"backbone","backbone/core-view":454,"underscore":"underscore"}],198:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-tSpace-xl CDB-Text u-flex js-name-field">\n  <label class="Metadata-label CDB-Text CDB-Size-medium is-semibold u-upperCase u-ellipsis">'+
((__t=( _t('components.modals.dataset-metadata.form.name') ))==null?'':_.escape(__t))+
'</label>\n</div>\n\n<div class="u-tSpace-xl CDB-Text u-flex">\n  <label class="Metadata-label CDB-Text CDB-Size-medium is-semibold u-upperCase u-ellipsis">'+
((__t=( _t('components.modals.dataset-metadata.form.description') ))==null?'':_.escape(__t))+
'</label>\n  <div class="u-grow">\n    <div class="js-description-field u-bSpace"></div>\n    <div class="Markdown">\n      <span class="Markdown-tooltip js-markdown" data-tooltip="<em>_italics_</em><br/><b>*bold*</b><br/>[link](http://link.com)">\n        <span class="Markdown-icon">\n          <i class="Markdown-icon-text">M</i>\n          <i class="Markdown-icon-char"></i>\n        </span>\n        '+
((__t=( _t('components.modals.dataset-metadata.form.markdown') ))==null?'':_.escape(__t))+
'\n      </span>\n    </div>\n  </div>\n</div>\n\n<div class="u-tSpace-xl CDB-Text u-flex">\n  <label class="Metadata-label CDB-Text CDB-Size-medium is-semibold u-upperCase u-ellipsis">'+
((__t=( _t('components.modals.dataset-metadata.form.source') ))==null?'':_.escape(__t))+
'</label>\n  <div class="u-grow">\n    <div class="js-source-field u-bSpace"></div>\n  </div>\n</div>\n\n<div class="u-tSpace-xl CDB-Text u-flex">\n  <label class="Metadata-label CDB-Text CDB-Size-medium is-semibold u-upperCase u-ellipsis">'+
((__t=( _t('components.modals.dataset-metadata.form.attributions') ))==null?'':_.escape(__t))+
'</label>\n  <div class="u-grow">\n    <div class="js-attributions-field u-bSpace"></div>\n  </div>\n</div>\n\n<div class="u-tSpace-xl CDB-Text u-flex">\n  <label class="Metadata-label CDB-Text CDB-Size-medium is-semibold u-upperCase u-ellipsis">'+
((__t=( _t('components.modals.dataset-metadata.form.license') ))==null?'':_.escape(__t))+
'</label>\n  <div class="u-grow">\n    <div class="js-license-field u-bSpace Metadata-select"></div>\n  </div>\n</div>\n\n<div class="u-tSpace-xl CDB-Text u-flex u-alignCenter js-tags-field">\n  <label class="Metadata-label CDB-Text CDB-Size-medium is-semibold u-upperCase u-ellipsis">'+
((__t=( _t('components.modals.dataset-metadata.form.tags') ))==null?'':_.escape(__t))+
'</label>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],199:[function(require,module,exports){
var TITLE_SUFIX = require('../visualization-title-suffix-metadata');

module.exports = function (opts) {
  if (!opts.visDefinitionModel) throw new Error('visDefinitionModel is required');
  if (!opts.name) throw new Error('name is required');

  var visDefinitionModel = opts.visDefinitionModel;
  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;
  var name = opts.name;
  var description = opts.description;
  var tags = opts.tags;
  var source = opts.source;
  var license = opts.license;
  var attributions = opts.attributions;

  var oldName = visDefinitionModel.get('name');

  visDefinitionModel.save({
    name: name,
    description: description,
    tags: tags,
    source: source,
    license: license,
    attributions: attributions
  }, {
    wait: true,
    success: function (mdl, attrs) {
      document.title = name + TITLE_SUFIX;
      successCallback && successCallback();
    },
    error: function (mdl, e) {
      document.title = oldName + TITLE_SUFIX;
      errorCallback && errorCallback(e);
    }
  });
};

},{"../visualization-title-suffix-metadata":241}],200:[function(require,module,exports){
var $ = require('jquery');
var CoreView = require('backbone/core-view');
var renderLoading = require('../../loading/render-loading');
var ErrorView = require('../../error/error-view');
var template = require('./modal-export-data.tpl');
var MAX_SQL_GET_LENGTH = 1000;
var CSV_FILTER = 'SELECT * FROM (%%sql%%) as subq ';
var FORMATS = [
  {
    format: 'csv',
    fetcher: 'fetchCSV',
    geomRequired: false
  }, {
    format: 'shp',
    fetcher: 'fetch',
    geomRequired: true
  }, {
    format: 'kml',
    fetcher: 'fetch',
    geomRequired: true
  }, {
    format: 'geojson',
    label: 'geo json',
    fetcher: 'fetch',
    geomRequired: true
  }, {
    format: 'svg',
    fetcher: 'fetchSVG',
    geomRequired: true
  }
];

module.exports = CoreView.extend({
  className: 'Dialog-content',

  events: {
    'click .js-confirm': '_onConfirm',
    'click .js-cancel': '_close'
  },

  options: {
    autoClose: true
  },

  initialize: function (opts) {
    if (!opts.fileName) throw new Error('name is required');
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.queryGeometryModel) throw new Error('queryGeometryModel is required');
    if (!opts.modalModel) throw new Error('modalModel is required');

    this._configModel = opts.configModel;
    this._fileName = opts.fileName;
    this._queryGeometryModel = opts.queryGeometryModel;
    this._modalModel = opts.modalModel;

    this._initBinds();

    if (this._queryGeometryModel.get('status') === 'unfetched') {
      this._queryGeometryModel.fetch();
    }
  },

  render: function () {
    var geom = this._queryGeometryModel.get('simple_geom');

    if (this._queryGeometryModel.get('status') === 'fetched' || this._queryGeometryModel.get('status') === 'unavailable') {
      this.$el.html(
        template({
          formats: FORMATS,
          url: this._configModel.getSqlApiUrl(),
          isGeoreferenced: !!geom
        })
      );
    } else {
      this._renderLoadingContent(_t('components.modals.export-data.loading.geometry'));
    }

    return this;
  },

  _initBinds: function () {
    this._queryGeometryModel.bind('change:status', function () {
      if (this._queryGeometryModel.get('status') !== 'unavailable') {
        this.render();
      } else {
        this.showError(_t('components.modals.export-data.error.geometry-error'));
      }
    }, this);
    this.add_related_model(this._queryGeometryModel);
  },

  /**
   * search a format based on its name in the format array
   * @param  {string} format Format name
   * @return {Object}
   */
  _getFormat: function (format) {
    for (var n in FORMATS) {
      if (FORMATS[n].format === format) {
        return FORMATS[n];
      }
    }
  },

  _onConfirm: function () {
    this._form = this.$('.js-form');
    var formatName = $('.js-format[name=format]:checked', this._form).data('format');
    var format = this._getFormat(formatName);

    this[format.fetcher](formatName);
  },

  /**
   * Create a dictionary with the options shared between all the methods
   * @return {Object}
   */
  getBaseOptions: function () {
    return {
      filename: this._fileName,
      apiKey: this._configModel.get('api_key')
    };
  },

  /**
   * Returns a specific sql filtered by the_geom, used on CSV exports
   * @return {string}
   */
  getGeomFilteredSql: function () {
    var sql = this._queryGeometryModel.get('query');
    var geom = this._queryGeometryModel.get('simple_geom');

    // if we have "the_geom" in our current schema, we apply a custom sql
    if (geom) {
      return CSV_FILTER.replace(/%%sql%%/g, sql);
    }
    // Otherwise, we apply regular sql
    return sql;
  },

  /**
   * Populates the hidden form with the format related values and submits them to get the file
   * @param  {Object} options Base options
   * @param  {String} sql Sql of the document to be retrieved
   */
  _fetch: function (options, sql) {
    this.$('.js-format').val(options.format);
    this.$('.js-q').val(sql);
    this.$('.js-filename').val(options.filename);
    this.$('.js-apiKey').val(options.apiKey);

    var skipFields = ['the_geom_webmercator'];
    if (options.format !== 'csv') {
      skipFields.push('the_geom');
    }
    this.$('.js-skipfields').val(skipFields.join(','));

    // TODO: track metrics

    // check if the sql is big or not, and send the request as a verb or other. This is a HACK.
    if (sql.length < MAX_SQL_GET_LENGTH) {
      var location = this.$('.js-form').attr('action') + '?' + this.$('.js-form').serialize();
      this._fetchGET(location);
    } else {
      // I can't find a way of making the iframe trigger load event when its get a form posted,
      // so we need to leave like it was until
      this.submit();
    }

    this.$('.js-skipfields').attr('disabled', 'disabled');

    if (this.options.autoClose) {
      this._close();
    } else {
      this._renderLoadingContent(_t('components.modals.export-data.loading.preparing'));
    }
  },

  showError: function (errorMessage) {
    var errorView = new ErrorView({
      title: _t('hello'),
      desc: errorMessage
    });
    this.$el.html(errorView.render().el);
    this.addView(errorView);
  },

  _fetchGET: function (url) {
    function getError (content) {
      // sql api returns a json when it fails
      // but if the browser is running some plugin that
      // formats it, the window content is the html
      // so search for the word "error"
      var error = null;
      try {
        var json = JSON.parse(content);
        error = json.error[0];
      } catch (e) {
        if (content && content.indexOf('error') !== -1) {
          error = _t('components.modals.export-data.error.unknown');
        }
      }
      return error;
    }

    var self = this;
    var checkInterval;

    var w = window.open(url);
    w.onload = function () {
      clearInterval(checkInterval);
      var error = getError(w.document.body.textContent);
      if (error) {
        self.showError(error);
      } else {
        self._close();
      }
      w.close();
    };
    window.focus();
    checkInterval = setInterval(function check () {
      // safari needs to check the body because it never
      // calls onload
      if (w.closed || (w.document && w.document.body.textContent.length === 0)) {
        self._close();
        clearInterval(checkInterval);
      }
    }, 100);
  },

  /**
   * Base fetch, for the formats that don't require special threatment
   * @param  {String} formatName
   */
  fetch: function (formatName) {
    var options = this.getBaseOptions();
    options.format = formatName;
    var sql = this._queryGeometryModel.get('query');
    this._fetch(options, sql);
  },

  /**
   * Gets the options needed for csv format and fetch the document
   * @param  {String} formatName
   */
  fetchCSV: function () {
    var options = this.getBaseOptions();
    options.format = 'csv';
    var sql = this.getGeomFilteredSql();
    this.$('.js-skipfields').removeAttr('disabled');
    this._fetch(options, sql);
  },
  /**
   * Gets the options needed for svg format and fetch the document
   * @param  {String} formatName
   */
  fetchSVG: function () {
    this.fetch('svg');
  },

  /**
   * Submits the form. This method is separated to ease the testing
   */
  submit: function () {
    this.$('.js-form').submit();
  },

  _renderLoadingContent: function (title) {
    this.$el.html(
      renderLoading({
        title: title
      })
    );
  },

  _close: function () {
    this._modalModel.destroy();
  }

});

},{"../../error/error-view":37,"../../loading/render-loading":187,"./modal-export-data.tpl":201,"backbone/core-view":454,"jquery":"jquery"}],201:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="24px" height="24px" viewbox="459 348 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <g id="Export-dataset" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(459.000000, 348.000000)">\n          <path d="M1,1 L11,1 L11,5.5 C11,5.776 11.224,6 11.5,6 L16,6 L16,9.5 L17,9.5 L17,5.502 C17,5.502 17,5.502 17,5.501 C17,5.5 17,5.501 17,5.5 C17,5.447 16.985,5.398 16.97,5.35 C16.966,5.337 16.967,5.323 16.962,5.311 C16.936,5.247 16.896,5.19 16.847,5.142 L11.854,0.147 C11.808,0.101 11.753,0.064 11.692,0.039 C11.632,0.014 11.567,0 11.5,0 L0.5,0 C0.224,0 0,0.224 0,0.5 L0,21.5 C0,21.776 0.224,22 0.5,22 L10.5,22 L10.5,21 L1,21 L1,1 L1,1 Z M12,1.708 L15.291,5 L12,5 L12,1.708 L12,1.708 Z" id="Shape" fill="#2E3C43"/>\n          <path d="M17.5,11 C13.916,11 11,13.916 11,17.5 C11,21.084 13.916,24 17.5,24 C21.084,24 24,21.084 24,17.5 C24,13.916 21.084,11 17.5,11 L17.5,11 Z M17.5,23 C14.467,23 12,20.533 12,17.5 C12,14.467 14.467,12 17.5,12 C20.533,12 23,14.467 23,17.5 C23,20.533 20.533,23 17.5,23 L17.5,23 Z" id="Shape" fill="#2E3C43"/>\n          <path d="M17.858,14.425 C17.767,14.331 17.641,14.272 17.5,14.272 C17.359,14.272 17.232,14.331 17.142,14.425 L14.965,16.602 C14.77,16.797 14.77,17.114 14.965,17.309 C15.16,17.504 15.477,17.504 15.672,17.309 L17,15.981 L17,20.226 C17,20.502 17.224,20.726 17.5,20.726 C17.776,20.726 18,20.502 18,20.226 L18,15.981 L19.328,17.309 C19.426,17.407 19.554,17.455 19.682,17.455 C19.81,17.455 19.938,17.406 20.036,17.309 C20.231,17.114 20.231,16.797 20.036,16.602 L17.858,14.425 L17.858,14.425 Z" id="Shape" fill="#2E3C43" transform="translate(17.500500, 17.499000) scale(1, -1) translate(-17.500500, -17.499000) "/>\n        </g>\n      </svg>\n    </div>\n\n    <div>\n      <h2 class="CDB-Text CDB-Size-huge is-light u-bSpace--xl">'+
((__t=( _t('components.modals.export-data.title') ))==null?'':_.escape(__t))+
'</h2>\n      <p class="CDB-Text CDB-Size-large u-altTextColor">'+
((__t=( _t('components.modals.export-data.desc') ))==null?'':_.escape(__t))+
'.</p>\n      ';
 if (!isGeoreferenced) { 
__p+='\n        <p class="CDB-Text CDB-Size-large u-altTextColor u-tSpace-xl">'+
((__t=( _t('components.modals.export-data.no-geometry') ))==null?'':_.escape(__t))+
'</p>\n      ';
 } 
__p+='\n\n      <div class="Modal-listTextItem u-flex u-alignCenter">\n        <h3 class="CDB-Text CDB-Size-medium is-semibold u-upperCase">Select format</h3>\n\n        <form class="js-form" method="POST" action="'+
((__t=( url ))==null?'':_.escape(__t))+
'">\n          <input type="hidden" class="js-filename" name="filename" />\n          <input type="hidden" class="js-q" name="q" />\n          <input type="hidden" class="js-apiKey" name="api_key" />\n          <input type="hidden" class="js-skipfields" name="skipfields" disabled="disabled" value="" />\n          <input type="hidden" class="js-dp" name="dp" value="4" disabled="disabled" />\n\n          <ul class="Modal-listForm u-flex u-alignCenter CDB-Text CDB-Size-medium">\n            ';
 _.each(formats, function (format) { 
__p+='\n            <li class="Modal-listFormItem\n              ';
 if (isGeoreferenced === false && format.geomRequired === true) { 
__p+='\n                is-disabled\n              ';
 } 
__p+='"\n            >\n              <input class="CDB-Radio js-format" type="radio" name="format" data-format="'+
((__t=( format.format ))==null?'':_.escape(__t))+
'"\n                ';
 if (isGeoreferenced === false && format.geomRequired === true) { 
__p+='\n                  disabled\n                ';
 } 
__p+='\n\n                ';
 if (format.format === 'csv') { 
__p+='\n                  checked\n                ';
 } 
__p+='\n              >\n              <span class="u-iBlock CDB-Radio-face"></span>\n              <label class="u-iBlock u-lSpace u-upperCase">'+
((__t=( format.label || format.format ))==null?'':_.escape(__t))+
'</label>\n            </li>\n            ';
 }); 
__p+='\n          </ul>\n        </form>\n\n      </div>\n\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.export-data.cancel') ))==null?'':_.escape(__t))+
'</span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.export-data.download') ))==null?'':_.escape(__t))+
'</span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],202:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');

/**
 * View model of a modal
 */
module.exports = Backbone.Model.extend({

  defaults: {
    show: true,
    createContentView: function () {
      return new CoreView();
    }
  },

  createContentView: function () {
    return this.get('createContentView')(this);
  },

  show: function () {
    this.set('show', true);
  },

  hide: function () {
    this.set('show', false);
  },

  isHidden: function () {
    return !this.get('show');
  },

  /**
   * @override {Backbone.Model.prototype.destroy}
   */
  destroy: function () {
    var args = Array.prototype.slice.call(arguments);
    this.trigger.apply(this, ['destroy'].concat(args));
  }
});

},{"backbone":"backbone","backbone/core-view":454}],203:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./modal.tpl');

// Ought to match the duration of the .Dialog.is-closing animation.
var CLOSE_DELAY_MS = 120;

module.exports = CoreView.extend({
  className: function () {
    if (this.options.escapeOptionsDisabled) {
      return 'Dialog is-white';
    } else {
      return 'Dialog is-opening is-white';
    }
  },

  events: {
    'click .js-close': '_onClose'
  },

  initialize: function () {
    this.listenTo(this.model, 'change:show', this._onShowChange);
    this.listenTo(this.model, 'destroy', this._onDestroy);

    this._escapeOptionsDisabled = this.options.escapeOptionsDisabled;
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(
      template({
        escapeOptionsDisabled: this.options.escapeOptionsDisabled || false
      })
    );

    var view = this.model.createContentView();
    this.addView(view);
    view.render();
    this.$('.js-content').append(view.el);

    return this;
  },

  show: function () {
    this.model.show();
  },

  hide: function () {
    this.model.hide();
  },

  destroy: function () {
    // 'remove' would be a better name ofc, but there is already an internal method with that name in CoreView
    this.model.destroy();
  },

  _onShowChange: function (m, show) {
    if (show) {
      this.$el.show();
      this.$el.removeClass('is-closing').addClass('is-opening');
    } else {
      this.$el.removeClass('is-opening').addClass('is-closing');
      this._delayDueToAnimation(function () {
        this.$el.hide();
      });
    }
  },

  _onClose: function (e) {
    e.stopPropagation();
    this.destroy();
  },

  _onDestroy: function () {
    this.hide();
    _.invoke(this._subviews, 'allOff');
    this._delayDueToAnimation(function () {
      this.clean();
    });
  },

  _delayDueToAnimation: function (fn) {
    setTimeout(fn.bind(this), CLOSE_DELAY_MS);
  }

});

},{"./modal.tpl":204,"backbone/core-view":454,"underscore":"underscore"}],204:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (!escapeOptionsDisabled) { 
__p+='\n  <button class="CDB-Shape js-close Dialog-closeBtn">\n    <div class="CDB-Shape-close is-blue is-huge"></div>\n  </button>\n';
 } 
__p+='\n<div class="Dialog-contentWrapper js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],205:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var ModalView = require('./modal-view');
var ModalViewModel = require('./modal-view-model');

var DESTROYED_MODAL_EVENT = 'destroyedModal';

/**
 * Top-level API to handle modals.
 * Is intended to be instantiated and registered in some top-level namespace to be accessibel within the lifecycle of
 * an client-side application.
 *
 * Example:
 * // In some entry-point:
 * cdb.modals = new ModalsServiceModel();
 *
 * // Later, in any view, calling create will create a new modal viewModel
 * var modalView = cdb.modals.create(fn)
 *
 * You will probably see the name of "Dialog" here and there, it's the old nomenclature for the concept of Modal.
 */
module.exports = Backbone.Model.extend({

  /**
   * Creates a new modal view
   *
   * @param {Function} createContentView
   * @return {View} the new modal view
   */
  create: function (createContentView, escapeOptionsDisabled) {
    if (!_.isFunction(createContentView)) throw new Error('createContentView is required');

    if (escapeOptionsDisabled) {
      this._escapeOptionsDisabled = escapeOptionsDisabled;
    }

    if (!this._modalView) {
      this.trigger('willCreateModal');
      this._modalView = this._newModalView();
      this.trigger('didCreateModal', this._modalView);
      document.body.appendChild(this._modalView.el);
    }

    this._modalView.model.set('createContentView', createContentView);
    this._modalView.render();

    return this._modalView;
  },

  /**
   * Convenience method to add a listener when current modal is destroyed
   *
   * This is the same as doing
   * modals.create(function (model) {
   *   model.once('destroy', callback, context); // <-- same as modals.onDestroyOnce(callback, context);
   *   return new MyView({  });
   * });
   *
   * @param {Function} callback
   * @param {Object} [context = undefined]
   */
  onDestroyOnce: function (callback, context) {
    this.once(DESTROYED_MODAL_EVENT, callback, context);
  },

  destroy: function () {
    if (this._modalView) {
      this._modalView.model.destroy();
    }
  },

  _newModalView: function () {
    var self = this;
    var viewModel = new ModalViewModel();
    this._handleBodyClass(viewModel);

    if (!this._escapeOptionsDisabled) {
      this._destroyOnEsc(viewModel);
    }

    this.listenToOnce(viewModel, 'destroy', function () {
      this._modalView = null;
      this.trigger.apply(this, [DESTROYED_MODAL_EVENT].concat(Array.prototype.slice.call(arguments)));
      this.stopListening(viewModel);
    });
    return new ModalView({
      model: viewModel,
      escapeOptionsDisabled: self._escapeOptionsDisabled
    });
  },

  _destroyOnEsc: function (viewModel) {
    var destroyOnEsc = function (ev) {
      if (ev.keyCode === 27) {
        ev.stopPropagation();
        viewModel.destroy();
      }
    };
    document.addEventListener('keydown', destroyOnEsc);
    this.listenToOnce(viewModel, 'destroy', function () {
      document.removeEventListener('keydown', destroyOnEsc);
    });
  },

  /**
   * TL;DR this method manages document.body class state, to enable scroll inside of an open modal.
   *
   * Some modal content have too much content that can be displayed in the viewport the scroll needs to be enabled.
   * Since the modal is implemented as a fixed positioned element the body needs to be fixated too, for the scroll to
   * be enabled inside the modal instead.
   */
  _handleBodyClass: function (viewModel) {
    var bodyClass = 'is-inDialog';
    document.body.classList.add(bodyClass);
    this.set('open', true);

    this.listenTo(viewModel, 'change:show', function (m, show) {
      document.body.classList[show ? 'add' : 'remove'](bodyClass);
      this.set('open', show);
    });

    this.listenToOnce(viewModel, 'destroy', function () {
      document.body.classList.remove(bodyClass);
      this.set('open', false);
    });
  },

  isOpen: function () {
    return this.get('open') === true;
  }

});

},{"./modal-view":203,"./modal-view-model":202,"backbone":"backbone","underscore":"underscore"}],206:[function(require,module,exports){
var _ = require('underscore');

/**
 * type property should match the value given from the API.
 */
var ALL_OPTIONS = [{
  privacy: 'PUBLIC',
  title: _t('components.modals.publish.privacy.public.title'),
  desc: _t('components.modals.publish.privacy.public.body'),
  alwaysEnabled: true,
  cssClass: 'green'
}, {
  privacy: 'LINK',
  title: _t('components.modals.publish.privacy.link.title'),
  desc: _t('components.modals.publish.privacy.link.body'),
  cssClass: 'orange'
}, {
  privacy: 'PASSWORD',
  title: _t('components.modals.publish.privacy.password.title'),
  desc: _t('components.modals.publish.privacy.password.body'),
  cssClass: 'orange-dark'
}, {
  privacy: 'PRIVATE',
  title: _t('components.modals.publish.privacy.private.title'),
  desc: _t('components.modals.publish.privacy.private.body'),
  cssClass: 'red'
}];

module.exports = function (visDefinitionModel, userModel) {
  var isVisualization = visDefinitionModel.isVisualization();
  var actions = userModel.get('actions');
  var canSelectPremiumOptions = actions[ isVisualization ? 'private_maps' : 'private_tables' ];
  var currentPrivacy = visDefinitionModel.get('privacy');
  var availableOptions = visDefinitionModel.privacyOptions();

  return _.chain(ALL_OPTIONS)
    .filter(function (option) {
      return _.contains(availableOptions, option.privacy);
    })
    .map(function (option) {
      // Set state that depends on vis and user attrs, they should not vary during the lifecycle of this collection
      return _.defaults({
        selected: option.privacy === currentPrivacy,
        disabled: !(option.alwaysEnabled || canSelectPremiumOptions)
      }, option);
    })
    .value();
};

},{"underscore":"underscore"}],207:[function(require,module,exports){
var Backbone = require('backbone');
var PrivacyModel = require('./privacy-model');
var PasswordModel = require('./privacy-password-model');

/**
 * Collection that holds the different privacy options.
 */
module.exports = Backbone.Collection.extend({

  model: function (attrs, options) {
    if (attrs.privacy === 'PASSWORD') {
      return new PasswordModel(attrs, options);
    } else {
      return new PrivacyModel(attrs, options);
    }
  },

  initialize: function () {
    this.bind('change:selected', this._deselectLastSelected, this);
  },

  searchByPrivacy: function (privacy) {
    return this.findWhere({privacy: privacy});
  },

  selectedOption: function () {
    return this.find(function (option) {
      return option.get('selected');
    });
  },

  passwordOption: function () {
    return this.find(function (option) {
      return option.get('privacy') === 'PASSWORD';
    });
  },

  _deselectLastSelected: function (m, isSelected) {
    if (isSelected) {
      this.each(function (option) {
        if (option !== m) {
          option.set({selected: false});
        }
      });
    }
  }
});

},{"./privacy-model":208,"./privacy-password-model":209,"backbone":"backbone"}],208:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

module.exports = Backbone.Model.extend({

  defaults: {
    privacy: 'PUBLIC',
    disabled: false,
    selected: false,
    password: undefined
  },

  validate: function (attrs) {
    if (attrs.disabled && attrs.selected) {
      return 'Option can not be disabled and selected at the same time';
    }
  },

  classNames: function () {
    return _.chain(['disabled', 'selected'])
      .map(function (attr) { return this.attributes[attr] !== undefined ? 'is-' + attr : undefined; }, this)
      .compact().value().join(' ');
  },

  canSave: function () {
    return !this.get('disabled');
  },

  isPassword: function () {
    return false;
  },

  isSelected: function () {
    return this.get('selected') === true;
  },

  saveToVis: function (vis, callbacks) {
    return vis.save(this._attrsToSave(), _.extend({ wait: true }, callbacks));
  },

  _attrsToSave: function () {
    return _.pick(this.attributes, 'privacy', 'password');
  }
});

},{"backbone":"backbone","underscore":"underscore"}],209:[function(require,module,exports){
var _ = require('underscore');
var PrivacyModel = require('./privacy-model');

var FAKE_PASSWORD = '!@#!@#';

/**
 * View model for the special privacy option representing a password protected map.
 * It handles the logic related to the password that needs to be set for the option.
 */
module.exports = PrivacyModel.extend({

  initialize: function () {
    PrivacyModel.prototype.initialize.apply(this, arguments);
    this.set('password', FAKE_PASSWORD);
  },

  /**
   * @override OptionModel.attrsToSave
   */
  _attrsToSave: function () {
    var attrs = PrivacyModel.prototype._attrsToSave.call(this);

    if (attrs.password === FAKE_PASSWORD) {
      delete attrs.password;
    }

    return attrs;
  },

  canSave: function () {
    return !this.get('disabled') && !_.isEmpty(this.get('password'));
  },

  isPassword: function () {
    return true;
  }
});

},{"./privacy-model":208,"underscore":"underscore"}],210:[function(require,module,exports){
var $ = require('jquery');
var moment = require('moment');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var template = require('./publish-button.tpl');

var REQUIRED_OPTS = [
  'visDefinitionModel',
  'mapcapsCollection',
  'configModel'
];

module.exports = CoreView.extend({

  events: {
    'click .js-button': '_onUpdate'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this.model = new Backbone.Model({
      status: 'idle'
    });

    this._initBinds();
  },

  render: function () {
    var publishedOn = this._mapcapsCollection.length > 0
                    ? _t('components.modals.publish.share.last-published', { date:
                        this.model.get('status') === 'updated'
                        ? moment(this._mapcapsCollection.first().get('created_at')).fromNow()
                        : moment(this._mapcapsCollection.first().get('created_at')).format('Do MMMM YYYY, HH:mm')
                      })
                    : _t('components.modals.publish.share.unpublished');

    this.clearSubViews();
    this.$el.html(template({
      isPublished: this._mapcapsCollection.length > 0,
      isLoading: this._isLoading(),
      isDisabled: this._isDisabled(),
      publishedOn: publishedOn
    }));
    return this;
  },

  _initBinds: function () {
    this._mapcapsCollection.on('reset', this.render, this);
    this.add_related_model(this._mapcapsCollection);
    this.model.on('change:status', this.render, this);
  },

  _isLoading: function () {
    return this.model.get('status') === 'loading';
  },

  _isDisabled: function () {
    return this.model.get('status') === 'updated';
  },

  _onUpdate: function () {
    var self = this;
    var url = this._visDefinitionModel.mapcapsURL();
    var data = {
      api_key: this._configModel.get('api_key')
    };

    if (this._isDisabled()) return false;

    self.model.set({status: 'loading'});

    $.post(url, data)
    .done(function (data) {
      self._visDefinitionModel.set('visChanges', 0);
      self._mapcapsCollection.add(data, {at: 0});
      self.model.set({status: 'updated'});
    })
    .fail(function () {
      self.model.set({status: 'error'});
    });
  }
});

},{"./publish-button.tpl":211,"backbone":"backbone","backbone/core-view":454,"jquery":"jquery","moment":"moment","underscore":"underscore"}],211:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button class="Publish-modalButton CDB-Button CDB-Button--primary CDB-Button--small u-rSpace js-button ';
 if (isDisabled) {
__p+='is-disabled';
 } 
__p+='">\n  <div class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small u-upperCase u-flex">\n    ';
 if (isLoading) { 
__p+='\n      <div class="CDB-LoaderIcon CDB-LoaderIcon--small u-iBlock">\n        <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n          <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n        </svg>\n      </div>\n      ';
 if (isPublished) { 
__p+='\n      '+
((__t=( _t('components.modals.publish.updating-btn') ))==null?'':_.escape(__t))+
'\n      ';
 } else { 
__p+='\n      '+
((__t=( _t('components.modals.publish.publishing-btn') ))==null?'':_.escape(__t))+
'\n      ';
 } 
__p+='\n    ';
 } else { 
__p+='\n      ';
 if (isPublished) { 
__p+='\n      '+
((__t=( _t('components.modals.publish.update-btn') ))==null?'':_.escape(__t))+
'\n      ';
 } else { 
__p+='\n      '+
((__t=( _t('components.modals.publish.publish-btn') ))==null?'':_.escape(__t))+
'\n      ';
 } 
__p+='\n    ';
 } 
__p+='\n  </div>\n</button> '+
((__t=( publishedOn ))==null?'':_.escape(__t))+
'';
}
return __p;
};

},{"underscore":"underscore"}],212:[function(require,module,exports){
var _ = require('underscore');
var moment = require('moment');
var CoreView = require('backbone/core-view');
var template = require('./publish.tpl');
var TabPaneTemplate = require('./tab-pane-submenu.tpl');
var createTextLabelsTabPane = require('../../tab-pane/create-text-labels-tab-pane');
var PublishView = require('./publish/publish-view');
var ShareView = require('./share/share-view');
var PrivacyDropdown = require('../../privacy-dropdown/privacy-dropdown-view');
var PublishButton = require('./publish-button-view');
var ShareWith = require('./share-with-view');
var UpgradeView = require('./upgrade-view');

var REQUIRED_OPTS = [
  'modalModel',
  'visDefinitionModel',
  'privacyCollection',
  'userModel',
  'configModel'
];

var MODE_FULL = 'full';
var MODE_SHARE = 'share';
var MODE_PUBLISH = 'publish';

module.exports = CoreView.extend({
  className: 'Publish-modal',

  events: {
    'click .js-done': '_onDone'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    // Optional options
    this._mapcapsCollection = opts.mapcapsCollection;
    this.mode = opts.mode || MODE_FULL;
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template({
      name: this._visDefinitionModel.get('name'),
      isSimple: !this._hasTabs(),
      hasShareStats: this._hasShareStats()
    }));

    this._initViews();

    if (this.mode === MODE_FULL) {
      if (!this._hasOrganization()) {
        this._makePublishView();
      } else {
        this._initTabsViews();
      }
    } else if (this.mode === MODE_SHARE) {
      this._makeShareView();
    } else if (this.mode === MODE_PUBLISH) {
      this._makePublishView();
    }

    return this;
  },

  _hasShareStats: function () {
    return this.mode !== MODE_PUBLISH && this._hasOrganization();
  },

  _hasOrganization: function () {
    return this._userModel.isInsideOrg();
  },

  _hasTabs: function () {
    var hasOrganization = this._hasOrganization();
    return hasOrganization && this.mode === MODE_FULL;
  },

  _makePublishView: function () {
    var view = this._createPublishView();
    this.$('.js-panes').append(view.render().el);
    this.addView(view);
  },

  _makeShareView: function () {
    var view = this._createShareView();
    this.$('.js-panes').append(view.render().el);
    this.addView(view);
  },

  _initViews: function () {
    var dropdown;
    var publishButton;
    var shareWith;
    var upgradeView;
    var publishedOn;

    dropdown = new PrivacyDropdown({
      privacyCollection: this._privacyCollection,
      visDefinitionModel: this._visDefinitionModel,
      userModel: this._userModel,
      configModel: this._configModel
    });

    this.$('.js-dropdown').append(dropdown.render().el);
    this.addView(dropdown);

    if (this._mapcapsCollection !== undefined) {
      publishButton = new PublishButton({
        visDefinitionModel: this._visDefinitionModel,
        mapcapsCollection: this._mapcapsCollection,
        configModel: this._configModel
      });

      this.$('.js-update').append(publishButton.render().el);
      this.addView(publishButton);
    } else {
      publishedOn = _t('components.modals.publish.share.last-published', { date:
                      moment(this._visDefinitionModel.get('updated_at')).format('Do MMMM YYYY, HH:mm')
                    });

      this.$('.js-update').html(publishedOn);
    }

    if (this._hasShareStats()) {
      shareWith = new ShareWith({
        visDefinitionModel: this._visDefinitionModel,
        userModel: this._userModel,
        avatarClass: 'Share-user--big',
        separationClass: 'u-rSpace--xl'
      });
      this.$('.js-share-users').append(shareWith.render().el);
      this.addView(shareWith);
    }

    if (!this._hasOrganization()) {
      upgradeView = new UpgradeView();
      this.$('.js-upgrade').append(upgradeView.render().el);
      this.addView(upgradeView);
    }
  },

  _initTabsViews: function () {
    var self = this;

    var tabPaneTabs = [{
      name: 'share',
      label: _t('components.modals.publish.menu.share'),
      createContentView: self._createShareView.bind(self)
    }, {
      name: 'publish',
      label: _t('components.modals.publish.menu.publish'),
      createContentView: self._createPublishView.bind(self)
    }];

    var tabPaneOptions = {
      tabPaneOptions: {
        template: TabPaneTemplate,
        tabPaneItemOptions: {
          tagName: 'li',
          className: 'CDB-NavSubmenu-item'
        }
      },
      tabPaneItemLabelOptions: {
        tagName: 'button',
        className: 'CDB-NavSubmenu-link u-upperCase Publish-modalLink'
      }
    };

    this._layerTabPaneView = createTextLabelsTabPane(tabPaneTabs, tabPaneOptions);
    this.$('.js-panes').append(this._layerTabPaneView.render().$el);
    this.addView(this._layerTabPaneView);
  },

  _createShareView: function () {
    return new ShareView({
      className: 'Share-wrapper',
      currentUserId: this._userModel.id,
      visDefinitionModel: this._visDefinitionModel,
      organization: this._userModel._organizationModel,
      configModel: this._configModel
    });
  },

  _createPublishView: function () {
    return new PublishView({
      visDefinitionModel: this._visDefinitionModel,
      mapcapsCollection: this._mapcapsCollection,
      userModel: this._userModel
    });
  },

  _onDone: function () {
    this._modalModel.destroy();
  }
});

},{"../../privacy-dropdown/privacy-dropdown-view":268,"../../tab-pane/create-text-labels-tab-pane":276,"./publish-button-view":210,"./publish.tpl":213,"./publish/publish-view":217,"./share-with-view":223,"./share/share-view":228,"./tab-pane-submenu.tpl":234,"./upgrade-view":235,"backbone/core-view":454,"moment":"moment","underscore":"underscore"}],213:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Publish-modalHeader">\n  <div class="u-inner">\n    <div class="CDB-Text CDB-Size-huge is-light u-ellipsis u-bSpace--m">'+
((__t=( name ))==null?'':_.escape(__t))+
'</div>\n    <ul class="u-flex u-alignCenter">\n      <li class="js-dropdown u-rSpace--xl"></li>\n      ';
 if (hasShareStats) { 
__p+='\n      <li class="js-share-users">\n      </li>\n      ';
 } 
__p+='\n      <li class="CDB-Text CDB-Size-medium u-altTextColor js-update">\n      </li>\n  </div>\n</div>\n\n<div class="Publish-modalBody js-panes\n';
 if (isSimple) { 
__p+='is-simple';
 } 
__p+='\n">\n  ';
 if (isSimple) { 
__p+='\n    <div class="Publish-modalShadow"></div>\n  ';
 } 
__p+='\n\n</div>\n\n<div class="Dialog-footer Dialog-footer--expanded CreateDialog-footer Publish-modalFooter">\n  <div>\n    <div class="CreateDialog-footerShadow"></div>\n    <div class="CreateDialog-footerLine"></div>\n    <div class="CreateDialog-footerInner ">\n      <div class="CreateDialog-footerInfo"></div>\n      <div class="CreateDialog-footerActions js-footerActions u-flex u-justifySpace u-grow">\n        <div class="js-upgrade"></div>\n        <button class="CDB-Button CDB-Button--secondary js-done">\n          <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">'+
((__t=( _t('components.modals.publish.done-btn') ))==null?'':_.escape(__t))+
'</span>\n        </button>\n      </div>\n    </div>\n  </div>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],214:[function(require,module,exports){
var linkIconTemplate = require('./icon-link.tpl');
var embedIconTemplate = require('./icon-embed.tpl');

module.exports = function (visDefinitionModel) {
  return [{
    createIcon: function () {
      return linkIconTemplate();
    },
    type: 'get-link',
    content: visDefinitionModel.embedURL(),
    private: visDefinitionModel.get('privacy') === 'PRIVATE'
  }, {
    createIcon: function () {
      return embedIconTemplate();
    },
    type: 'embed',
    content: '<iframe width="100%" height="520" frameborder="0" src="' + encodeURI(visDefinitionModel.embedURL()) + '" allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen></iframe>',
    url: encodeURI(visDefinitionModel.embedURL()),
    private: visDefinitionModel.get('privacy') === 'PRIVATE'
  }];
};

},{"./icon-embed.tpl":215,"./icon-link.tpl":216}],215:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='\n<svg width="25px" height="25px" viewBox="682 469 25 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <path d="M697.141667,478.48556 C695.774797,477.117815 695.774797,474.90231 697.141553,473.535553 L697.495051,473.182056 L697.141609,472.828502 L693.960609,469.646502 L693.607124,469.292907 L693.253515,469.646378 L690.685515,472.213378 L691.039,472.567 L691.469343,472.312431 C691.271611,471.978171 691.043454,471.678347 690.778553,471.413447 C689.020272,469.655166 686.171603,469.655166 684.414333,471.41356 C682.657184,473.170709 682.657184,476.020291 684.414447,477.777553 C684.682252,478.044267 684.982655,478.273359 685.314094,478.468734 L685.568,478.038 L685.214447,477.684447 L682.646447,480.252447 L682.292893,480.606 L682.646447,480.959553 L685.828447,484.141553 L686.181887,484.494994 L686.53544,484.141667 C687.903185,482.774797 690.11869,482.774797 691.485447,484.141553 C692.852184,485.508291 692.852184,487.724709 691.485447,489.091447 L691.131893,489.445 L691.485447,489.798553 L694.667447,492.980553 L695.021,493.334107 L695.374553,492.980553 L697.941553,490.413553 L697.588,490.06 L697.157928,490.315025 C697.3561,490.649221 697.584149,490.948256 697.849447,491.213553 C699.60664,492.971872 702.456485,492.971872 704.21278,491.213327 C705.970872,489.45636 705.970872,486.606515 704.212327,484.85022 C703.948015,484.584823 703.647051,484.355236 703.312906,484.158266 L703.059,484.589 L703.412553,484.942553 L705.979553,482.375553 L706.333107,482.022 L705.979553,481.668447 L702.797553,478.486447 L702.444,478.132893 L702.090447,478.486447 C700.725536,479.851357 698.508943,479.851087 697.141327,478.48522 L697.141667,478.48556 Z M696.434673,479.19278 C698.192747,480.948604 701.042155,480.948952 702.797553,479.193553 L702.090447,479.193553 L705.272447,482.375553 L705.272447,481.668447 L702.705447,484.235447 L702.248976,484.691917 L702.805094,485.019734 C703.068228,485.174844 703.301587,485.35286 703.504724,485.55683 C704.873128,486.923485 704.873128,489.13964 703.50556,490.506333 C702.139515,491.874128 699.92336,491.874128 698.556667,490.50656 C698.35252,490.302414 698.175052,490.069704 698.018072,489.804975 L697.689693,489.2512 L697.234447,489.706447 L694.667447,492.273447 L695.374553,492.273447 L692.192553,489.091447 L692.192553,489.798553 C693.949816,488.041291 693.949816,485.191709 692.192553,483.434447 C690.43531,481.677203 687.586815,481.677203 685.82856,483.434333 L686.535553,483.434447 L683.353553,480.252447 L683.353553,480.959553 L685.921553,478.391553 L686.378024,477.935083 L685.821906,477.607266 C685.560783,477.453341 685.327004,477.275057 685.12083,477.069724 C683.754816,475.703709 683.754816,473.487291 685.121553,472.120553 C686.488397,470.752834 688.703728,470.752834 690.071447,472.120553 C690.274695,472.323801 690.452152,472.557 690.608657,472.821569 L690.936742,473.376188 L691.392485,472.920622 L693.960485,470.353622 L693.253391,470.353498 L696.434391,473.535498 L696.434447,472.828447 C694.677203,474.58569 694.677203,477.434185 696.434333,479.19244 L696.434673,479.19278 Z" id="Embed-it" stroke="none" fill="#AAAAAA" fill-rule="evenodd"></path>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],216:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='  <svg width="23px" height="23px" viewBox="683 470 23 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n      <path d="M696.399947,482.106803 L696.485947,482.192803 C697.462209,483.169066 699.044791,483.169066 700.021053,482.192803 L703.986009,478.228848 C705.34724,476.86645 705.34724,474.642218 703.986356,473.279 L702.227953,471.521596 C700.866908,470.159384 698.640092,470.159384 697.278795,471.521848 L693.313991,475.485652 C692.337722,476.461921 692.337722,478.044329 693.31372,479.021577 L693.40202,479.108865 L694.10498,478.397635 L694.01898,478.312635 C693.435278,477.728171 693.435278,476.778579 694.021053,476.192803 L697.986009,472.228848 C698.956908,471.257116 700.550092,471.257116 701.520795,472.228652 L703.279047,473.985904 C704.24976,474.958282 704.24976,476.55005 703.278795,477.521848 L699.313991,481.485652 C698.728209,482.071434 697.778791,482.071434 697.193053,481.485697 L697.107053,481.399697 L696.399947,482.106803 L696.399947,482.106803 Z M692.10498,480.397635 L692.01898,480.312635 C691.044791,479.338434 689.462209,479.338434 688.485947,480.314697 L684.520991,484.278652 C683.159735,485.641076 683.159735,487.866424 684.520795,489.228652 L686.279047,490.985904 C687.640092,492.348116 689.866908,492.348116 691.228205,490.985652 L695.193009,487.021848 C696.169278,486.045579 696.169278,484.463171 695.19328,483.485923 L695.107053,483.399697 L694.399947,484.106803 L694.485947,484.192803 C695.071722,484.779329 695.071722,485.728921 694.485947,486.314697 L690.520991,490.278652 C689.550092,491.250384 687.956908,491.250384 686.986205,490.278848 L685.227953,488.521596 C684.257265,487.550076 684.257265,485.957424 685.228205,484.985652 L689.193009,481.021848 C689.778791,480.436066 690.728209,480.436066 691.313947,481.021803 L691.40202,481.108865 L692.10498,480.397635 L692.10498,480.397635 Z M690.718053,485.495803 L698.496053,477.717803 L697.788947,477.010697 L690.010947,484.788697 L690.718053,485.495803 L690.718053,485.495803 Z" id="Get-link" stroke="none" fill="#AAAAAA" fill-rule="evenodd"></path>\n  </svg>';
}
return __p;
};

},{"underscore":"underscore"}],217:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var CreateShareOptions = require('./create-share-options');
var ShareCollection = require('./share-collection');
var ShareItemView = require('./share-item-view');
var template = require('./publish.tpl');

var REQUIRED_OPTS = [
  'visDefinitionModel',
  'mapcapsCollection',
  'userModel'
];

module.exports = CoreView.extend({
  className: 'Publish-modalShare u-inner',

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this.hasOrganization = this._userModel.isInsideOrg();

    var shareOptions = CreateShareOptions(this._visDefinitionModel);
    this._shareCollection = new ShareCollection(shareOptions);

    this._initBinds();
  },

  render: function () {
    var isPublished = this._mapcapsCollection.length > 0;
    this.clearSubViews();
    this.$el.html(template({
      isPublished: isPublished
    }));
    this._initViews();
    return this;
  },

  _initViews: function () {
    var renderItemView = this._renderItemView.bind(this);
    this._shareCollection.each(renderItemView);
  },

  _renderItemView: function (model) {
    var self = this;
    var isPublished = this._mapcapsCollection.length > 0;
    var view = new ShareItemView({
      model: model,
      isPublished: isPublished,
      hasOrganization: self.hasOrganization
    });

    this.$('.js-list').append(view.render().el);
    this.addView(view);
  },

  _revampPrivacyOptions: function () {
    var shareOptions = CreateShareOptions(this._visDefinitionModel);
    this._shareCollection.reset(shareOptions);
  },

  _initBinds: function () {
    this._visDefinitionModel.on('sync', this._revampPrivacyOptions, this);
    this.add_related_model(this._visDefinitionModel);

    this._shareCollection.on('reset', this.render, this);
    this.add_related_model(this._shareCollection);

    this._mapcapsCollection.on('reset add', this.render, this);
    this.add_related_model(this._mapcapsCollection);
  }
});

},{"./create-share-options":214,"./publish.tpl":218,"./share-collection":219,"./share-item-view":220,"backbone/core-view":454,"underscore":"underscore"}],218:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="Publish-optionsList u-flex u-justifySpace js-list"></ul>\n';
 if (!isPublished) { 
__p+='\n<div class="Share-info">\n  <div>\n    <h2 class="CDB-Text CDB-Size-large u-secondaryTextColor u-bSpace is-light">'+
((__t=( _t('components.modals.publish.share.unpublished-header') ))==null?'':_.escape(__t))+
'</h2>\n    <p class="CDB-Text CDB-Size-medium is-light">'+
((__t=( _t('components.modals.publish.share.unpublished-subheader') ))==null?'':_.escape(__t))+
'</p>\n  </div>\n</div>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],219:[function(require,module,exports){
var Backbone = require('backbone');
var ShareModel = require('./share-model');

module.exports = Backbone.Collection.extend({
  model: ShareModel
});

},{"./share-model":222,"backbone":"backbone"}],220:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var Clipboard = require('clipboard');
var template = require('./share-item.tpl');
var browserDetect = require('../../../../helpers/browser-detect');

var PRIVATE_LABEL_TEMPLATE = _.template("<span class='CDB-Text CDB-Size-small is-semibold u-errorTextColor'><%- private %></span>.<br>")({
  private: _t('components.modals.publish.share.private')
});

module.exports = CoreView.extend({
  className: 'Card',
  tagName: 'li',

  events: {
    'click .js-change-privacy': '_onChangePrivacyClick'
  },

  initialize: function (opts) {
    if (!opts.model) throw new Error('model is required');
    if (opts.isPublished == null) throw new Error('isPublished is required');

    this._isPublished = opts.isPublished;
    this._type = this.model.type();
    this._hasOrganization = opts.hasOrganization;
    this._title = _t('components.modals.publish.share.' + this._type + '.title');

    if (this.model.isPrivate()) {
      this._body = _t('components.modals.publish.share.' + this._type + '.private.body', {
        private: PRIVATE_LABEL_TEMPLATE
      });
    } else {
      this._body = _t('components.modals.publish.share.' + this._type + '.body');
    }

    this._link = _t('components.modals.publish.share.' + this._type + '.link');
    this._copy = this._getButtonLabel();
    this.$el.toggleClass('is-disabled', this.model.isPrivate());
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    if (!this.model.isPrivate() && this._isPublished) {
      this._initClipboard();
    }
    return this;
  },

  _getButtonLabel: function () {
    var browser = browserDetect();
    var label = _t('components.modals.publish.share.' + this._type + '.copy');
    if (browser.name === 'Safari') {
      label = _t('components.modals.publish.share.' + this._type + '.select');
    }

    return label;
  },

  getValue: function () {
    return this.$('.js-input').val();
  },

  _initViews: function () {
    var view = template({
      id: this.cid,
      isPrivate: this.model.isPrivate(),
      type: this._type,
      title: this._title,
      body: this._body,
      content: this.model.content(),
      link: this._link,
      copy: this._copy,
      url: this.model.url(),
      isPublished: this._isPublished
    });

    this.$el.append(view);

    var iconTemplate = this.model.createIcon();
    this.$('.js-icon').append(iconTemplate());
  },

  _initClipboard: function () {
    if (this._clipboard) {
      this._clipboard.destroy();
    }

    var btn = this.$('.js-copy');
    this._clipboard = new Clipboard(btn.get(0));
  },

  _onChangePrivacyClick: function (e) {
    this.killEvent(e);
    this.options.onChangePrivacy && this.options.onChangePrivacy();
  },

  clean: function () {
    this._clipboard && this._clipboard.destroy();
    CoreView.prototype.clean.call(this);
  }
});

},{"../../../../helpers/browser-detect":424,"./share-item.tpl":221,"backbone/core-view":454,"clipboard":"clipboard","underscore":"underscore"}],221:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Card-icon u-bSpace--xl js-icon"></div>\n\n<div class="Card-body u-bSpace--xl">\n  ';
 if (isPrivate) { 
__p+='\n    <h3 class="CDB-Text CDB-Size-large u-altTextColor u-bSpace--m">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h3>\n  ';
 } else { 
__p+='\n    <h3 class="CDB-Text CDB-Size-large u-mainTextColor u-bSpace--m">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h3>\n  ';
 } 
__p+='\n  <div class="CDB-Text CDB-Size-medium u-altTextColor">\n    '+
((__t=( body ))==null?'':__t)+
'\n    <br/>\n    ';
 if (url && !isPrivate) { 
__p+='\n    <a href="'+
((__t=( url ))==null?'':_.escape(__t))+
'" class="Share-link js-link">'+
((__t=( link ))==null?'':_.escape(__t))+
'</a>\n    ';
 } 
__p+='\n  </div>\n</div>\n\n';
 if (!isPrivate && isPublished) { 
__p+='\n  <div class="Share-input">\n    <input type="text" id="'+
((__t=( id ))==null?'':_.escape(__t))+
'" value="'+
((__t=( content ))==null?'':_.escape(__t))+
'" class="Share-input-field CDB-InputText is-disabled CDB-Text CDB-Size-medium u-ellipsis js-input" readonly>\n    <button class="Share-copy CDB-Button CDB-Button--small js-copy" data-clipboard-target="#'+
((__t=( id ))==null?'':_.escape(__t))+
'">\n      <span class="CDB-Button-Text CDB-Text CDB-Size-small u-actionTextColor">'+
((__t=( copy ))==null?'':_.escape(__t))+
'</span>\n    </button>\n  </div>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],222:[function(require,module,exports){
var Backbone = require('backbone');

module.exports = Backbone.Model.extend({
  createIcon: function () {
    return this.get('createIcon');
  },

  type: function () {
    return this.get('type');
  },

  content: function () {
    return this.get('content');
  },

  url: function () {
    return this.get('url');
  },

  isPrivate: function () {
    return this.get('private');
  }
});

},{"backbone":"backbone"}],223:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var template = require('./share-with.tpl');

var REQUIRED_OPTS = [
  'visDefinitionModel',
  'userModel'
];

module.exports = CoreView.extend({
  className: 'Share-with u-flex u-alignCenter',

  events: {
    'click .js-action': '_onAction'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this.separationClass = opts.separationClass || '';
    this.avatarClass = opts.avatarClass || '';

    this._acl = this._visDefinitionModel._permissionModel.acl;
    this._initBinds();
  },

  render: function () {
    var people = this._getPeople();
    var hasAction = this.options.action !== undefined && this._hasOrganization();

    this.clearSubViews();
    this.$el.html(template({
      avatar: this._userModel.get('avatar_url'),
      people: people,
      avatarClass: this.avatarClass,
      separationClass: this.separationClass,
      hasAction: hasAction
    }));
    return this;
  },

  _getPeople: function () {
    var types = this._acl.pluck('type');
    if (types.indexOf('org') > -1) {
      return this._userModel.getOrganization().get('user_count') - 1;
    } else {
      var users = [];

      // Grab all ids from every group
      _.each(this._acl.where({type: 'group'}), function (group) {
        var entity = group.get('entity');
        Array.prototype.push.apply(users, entity.users.pluck('id'));
      }, this);

      // Grab all ids from every user
      _.each(this._acl.where({type: 'user'}), function (group) {
        var entity = group.get('entity');
        users.push(entity.get('id'));
      }, this);

      // remove current user id because it can be part of a group
      users = _.without(users, this._userModel.id);

      // counts unique ids
      return _.unique(users).length;
    }
  },

  _hasOrganization: function () {
    return this._userModel.isInsideOrg();
  },

  _initBinds: function () {
    this._acl.on('fetch', this.render, this);
    this.add_related_model(this._acl);
  },

  _onAction: function () {
    this.options.action && this.options.action();
  }
});

},{"./share-with.tpl":224,"backbone/core-view":454,"underscore":"underscore"}],224:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (people > 0) { 
__p+='\n<div class="Share-user '+
((__t=( avatarClass ))==null?'':_.escape(__t))+
' u-rSpace u-iBlock" style="background-image: url('+
((__t=( avatar ))==null?'':_.escape(__t))+
')"></div>\n<span class="u-secondaryTextColor CDB-Text CDB-Size-small '+
((__t=( separationClass ))==null?'':_.escape(__t))+
'">+ '+
((__t=( people ))==null?'':_.escape(__t))+
'</span>\n';
 } else { 
__p+='\n  ';
 if (hasAction) { 
__p+='\n  <button class="CDB-Text CDB-Size-small u-upperCase u-actionTextColor js-action '+
((__t=( separationClass ))==null?'':_.escape(__t))+
'">'+
((__t=( _t('components.modals.publish.share.add-people') ))==null?'':_.escape(__t))+
'</button>\n  ';
 } 
__p+='\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],225:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var PermissionView = require('./share-permission-view');

var REQUIRED_OPTS = [
  'collection',
  'currentUserId',
  'organization',
  'hasOrganization',
  'sharePermissionModel',
  'isVisualization'
];

module.exports = CoreView.extend({
  className: 'Share-list',

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    // To avoid jumps in rendering when the user gets permission
    // we sort the collection only the first time
    this._sortedCollection = this._sortCollection();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this._sharePermissionModel.acl.on('add remove reset change', this.render, this);
    this.add_related_model(this._sharePermissionModel);
  },

  _initViews: function () {
    if (this._hasOrganization) {
      this._renderOrganization();
    }

    _.each(this._sortedCollection, this._renderItem, this);
  },

  _sortCollection: function () {
    // sharing first
    var sharing = this._collection.filter(function (model) {
      var permission = this._sharePermissionModel;
      var hasWriteAccess = permission.hasWriteAccess(model);
      var hasReadAccess = permission.hasReadAccess(model);
      return hasWriteAccess || hasReadAccess;
    }, this);

    var noSharing = this._collection.filter(function (model) {
      var permission = this._sharePermissionModel;
      var hasWriteAccess = permission.hasWriteAccess(model);
      var hasReadAccess = permission.hasReadAccess(model);
      return !hasWriteAccess && !hasReadAccess;
    }, this);

    return sharing.concat(noSharing);
  },

  _renderOrganization: function () {
    var self = this;
    var organization = this._organization;
    var permission = this._sharePermissionModel;
    var hasWriteAccessAvailable = !self._isVisualization;
    var canChangeWriteAccess = permission.canChangeWriteAccess(organization);
    var hasWriteAccess = permission.hasWriteAccess(organization);
    var canChangeReadAccess = permission.canChangeReadAccess(organization);
    var hasReadAccess = permission.hasReadAccess(organization);

    var view = new PermissionView({
      model: organization,
      permission: permission,
      avatar: organization.get('avatar_url'),
      description: _t('components.modals.publish.share.organization.desc'),
      name: _t('components.modals.publish.share.organization.title'),
      canChangeReadAccess: canChangeReadAccess,
      hasReadAccess: hasReadAccess,
      hasWriteAccessAvailable: hasWriteAccessAvailable,
      canChangeWriteAccess: canChangeWriteAccess,
      hasWriteAccess: hasWriteAccess,
      isSelected: hasReadAccess || hasWriteAccess
    });

    this.$el.append(view.render().$el);
    this.addView(view);
  },

  _renderItem: function (model) {
    var self = this;
    var view;
    var o = model.get('model');
    var permission = this._sharePermissionModel;
    var hasWriteAccessAvailable = !self._isVisualization;
    var canChangeWriteAccess = permission.canChangeWriteAccess(model);
    var hasWriteAccess = permission.hasWriteAccess(model);
    var canChangeReadAccess = permission.canChangeReadAccess(model);
    var hasReadAccess = permission.hasReadAccess(model);
    var role = this._getRole(o);

    if (model.id !== this._currentUserId) {
      view = new PermissionView({
        model: model,
        permission: permission,
        name: model.get('name'),
        avatar: model.get('avatar_url'),
        role: role,
        users: o.users,
        canChangeReadAccess: canChangeReadAccess,
        hasReadAccess: hasReadAccess,
        hasWriteAccessAvailable: hasWriteAccessAvailable,
        canChangeWriteAccess: canChangeWriteAccess,
        hasWriteAccess: hasWriteAccess,
        isSelected: hasReadAccess || hasWriteAccess
      });

      this.$el.append(view.render().$el);
      this.addView(view);
    }
  },

  _getRole: function (d) {
    if (d.viewer !== undefined) {
      return d.viewer === true ? _t('components.modals.publish.share.role.viewer')
                               : _t('components.modals.publish.share.role.builder');
    }

    return false;
  }
});

},{"./share-permission-view":226,"backbone/core-view":454,"underscore":"underscore"}],226:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./share-permission.tpl');
var TipsyTooltipView = require('../../../tipsy-tooltip-view.js');
var $ = require('jquery');
var UsersGroup = require('./users-group-view');

var REQUIRED_OPTS = [
  'model',
  'permission',
  'name',
  'canChangeReadAccess',
  'hasReadAccess',
  'hasWriteAccessAvailable',
  'canChangeWriteAccess',
  'hasWriteAccess',
  'isSelected'
];

var OPTIONALS_OPT = [
  'description',
  'role',
  'avatar',
  'users'
];

module.exports = CoreView.extend({
  className: 'Share-permission',

  events: {
    'change .js-read': '_onChangeRead',
    'change .js-write': '_onChangeWrite',
    'mouseover .js-toggler.is-disabled': '_onHoverDisabledToggler',
    'mouseout .js-toggler': '_destroyTooltip',
    'mouseleave .js-toggler': '_destroyTooltip'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    _.each(OPTIONALS_OPT, function (item) {
      this['_' + item] = opts[item];
    }, this);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template({
      name: this._name,
      avatar: this._avatar,
      role: this._role,
      users: this._users,
      description: this._description,
      canChangeReadAccess: this._canChangeReadAccess,
      hasReadAccess: this._hasReadAccess,
      hasWriteAccessAvailable: this._hasWriteAccessAvailable,
      canChangeWriteAccess: this._canChangeWriteAccess,
      hasWriteAccess: this._hasWriteAccess
    }));

    if (this._users) {
      this._renderUsers();
    }

    this.$el.toggleClass('is-selected', this._isSelected);
    return this;
  },

  _renderUsers: function () {
    var view = new UsersGroup({
      className: 'u-flex u-alignCenter',
      users: this._users
    });

    this.$('.js-users').append(view.render().el);
    this.addView(view);
  },

  _onChangeWrite: function () {
    var p = this._permission;
    if (p.canChangeWriteAccess(this._model)) {
      if (p.hasWriteAccess(this._model)) {
        p.revokeWriteAccess(this._model);
      } else {
        p.grantWriteAccess(this._model);
      }
    }
  },

  _onChangeRead: function () {
    var p = this._permission;
    if (p.canChangeReadAccess(this._model)) {
      if (p.hasReadAccess(this._model)) {
        p.revokeAccess(this._model);
      } else {
        p.grantReadAccess(this._model);
      }
    }
  },

  _onHoverDisabledToggler: function (e) {
    var aclItem = this._permission.findRepresentableAclItem(this._model);
    var msg;
    var $el;

    if (aclItem && !aclItem.isOwn(this._model)) {
      msg = this._inheritedAccessTooltipText(aclItem);
      $el = $(e.currentTarget);

      this._tooltip = this._createTooltip({
        $el: $el,
        msg: msg
      });
      this._tooltip.showTipsy();
    }
  },

  _createTooltip: function (opts) {
    return new TipsyTooltipView({
      el: opts.$el,
      title: function () {
        return opts.msg;
      }
    });
  },

  _destroyTooltip: function () {
    if (this._tooltip) {
      this._tooltip.hideTipsy();
      this._tooltip.destroyTipsy();
    }
  },

  _inheritedAccessTooltipText: function (aclItem) {
    var type = aclItem.get('type');

    switch (type) {
      case 'group':
        return _t('components.modals.publish.share.tooltip.group', {
          name: aclItem.get('entity').get('name')
        });
      case 'org':
        return _t('components.modals.publish.share.tooltip.org');
      default:
        console.error('Trying to display inherited access for an unrecognized type ' + type);
        return '';
    }
  }

});

},{"../../../tipsy-tooltip-view.js":325,"./share-permission.tpl":227,"./users-group-view":232,"backbone/core-view":454,"jquery":"jquery","underscore":"underscore"}],227:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Share-permissionInfo">\n  <div class="Share-permissionIcon">\n    ';
 if (avatar) { 
__p+='\n      <div class="Share-user Share-user--huge" style="background-image: url('+
((__t=( avatar ))==null?'':_.escape(__t))+
')"></div>\n    ';
 } else { 
__p+='\n        <i class="CDB-IconFont CDB-IconFont-people"></i>\n    ';
 } 
__p+='\n  </div>\n  <div>\n    <div class="CDB-Text u-mainTextColor CDB-Size-medium is-semibold u-ellipsis">\n      '+
((__t=( name ))==null?'':_.escape(__t))+
'\n    </div>\n\n\n    <div class="CDB-Text u-mainTextColor u-tSpace CDB-Size-medium u-ellipsis">\n      ';
 if (role) { 
__p+='\n        <i class="Tag Tag--outline Tag--'+
((__t=( role ))==null?'':_.escape(__t))+
' CDB-Text CDB-Size-small u-upperCase">'+
((__t=( role ))==null?'':_.escape(__t))+
'</i>\n      ';
 } 
__p+='\n\n      ';
 if (users) { 
__p+='\n        <div class="js-users"></div>\n      ';
 } 
__p+='\n    </div>\n\n\n    ';
 if (description) { 
__p+='\n    <div class="CDB-Text u-mainTextColor u-tSpace CDB-Size-medium u-ellipsis">\n      '+
((__t=( description ))==null?'':_.escape(__t))+
'\n    </div>\n    ';
 } 
__p+='\n  </div>\n</div>\n<div class="Share-togglers">\n  ';
 if (hasWriteAccessAvailable) { 
__p+='\n    <div class="CDB-Text CDB-Size-medium u-rSpace--xl Share-toggler js-toggler ';
 if (!canChangeWriteAccess) { 
__p+='is-disabled';
 } 
__p+='">\n      <input class="CDB-Toggle u-iBlock js-write" type="checkbox"\n        ';
 if (!canChangeWriteAccess) { 
__p+='disabled="disabled"';
 } 
__p+='\n        ';
 if (hasWriteAccess) { 
__p+=' checked ';
 } 
__p+='\n      />\n      <span class="u-iBlock CDB-ToggleFace"></span>\n      <label class="u-iBlock u-altTextColor ">'+
((__t=( _t('components.modals.publish.share.toggle.write') ))==null?'':_.escape(__t))+
'</label>\n    </div>\n  ';
 } 
__p+='\n  <div class="CDB-Text CDB-Size-medium Share-toggler js-toggler ';
 if (!canChangeReadAccess) { 
__p+='is-disabled';
 } 
__p+='">\n    <input class="CDB-Toggle u-iBlock js-read" type="checkbox"\n      ';
 if (hasReadAccess) { 
__p+=' checked ';
 } 
__p+='\n      ';
 if (!canChangeReadAccess) { 
__p+='disabled="disabled"';
 } 
__p+='\n    />\n    <span class="u-iBlock CDB-ToggleFace"></span>\n    <label class="u-iBlock u-altTextColor ">'+
((__t=( _t('components.modals.publish.share.toggle.read') ))==null?'':_.escape(__t))+
'</label>\n  </div>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],228:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./share.tpl');
var GrantableCollection = require('../../../../data/grantables-collection');
var SearchPaginationView = require('../../../../components/pagination-search/pagination-search-view');
var ListView = require('./share-list-view');

var REQUIRED_OPTS = [
  'configModel',
  'currentUserId',
  'organization',
  'visDefinitionModel'
];

module.exports = CoreView.extend({
  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this._grantablesCollection = new GrantableCollection([], {
      currentUserId: this._currentUserId,
      organization: this._organization,
      configModel: this._configModel
    });

    this._sharePermissionModel = this._visDefinitionModel.getPermissionModel().clone();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template({
      name: this._visDefinitionModel.get('name')
    }));
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this._sharePermissionModel.acl.on('add remove reset change', this._onSave, this);
    this.add_related_model(this._sharePermissionModel.acl);
  },

  _initViews: function () {
    var self = this;

    this._searchPaginationView = new SearchPaginationView({
      className: 'u-inner',
      listCollection: this._grantablesCollection,
      createContentView: function (opts) {
        return new ListView(_.extend({}, opts, {
          collection: self._grantablesCollection,
          currentUserId: self._currentUserId,
          sharePermissionModel: self._sharePermissionModel,
          organization: self._organization,
          isVisualization: self._visDefinitionModel.isVisualization()
        }));
      }
    });
    this.addView(this._searchPaginationView);
    this.$('.js-body').html(this._searchPaginationView.render().el);
  },

  _onCancel: function () {
    this._modalModel.destroy();
  },

  _onBack: function () {
    this._modalModel.destroy();
    this._onBack();
  },

  _onSave: function () {
    var permission = this._visDefinitionModel.getPermissionModel();
    permission.overwriteAcl(this._sharePermissionModel);
    // Show loading here
    permission.save()
      .fail(this._searchPaginationView.showError.bind(this._searchPaginationView));
  }
});

},{"../../../../components/pagination-search/pagination-search-view":257,"../../../../data/grantables-collection":350,"./share-list-view":225,"./share.tpl":229,"backbone/core-view":454,"underscore":"underscore"}],229:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-body">\n\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],230:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./user.tpl');
var TipsyTooltipView = require('../../../tipsy-tooltip-view');

var REQUIRED_OPTS = [
  'username',
  'avatar'
];

module.exports = CoreView.extend({

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template({
      avatar: this._avatar,
      username: this._username
    }));

    this._initViews();
    return this;
  },

  _initViews: function () {
    var tooltip = new TipsyTooltipView({
      el: this.$('.js-avatar'),
      title: function () {
        return $(this).attr('data-title');
      }
    });

    this.addView(tooltip);
  }
});

},{"../../../tipsy-tooltip-view":325,"./user.tpl":231,"backbone/core-view":454,"jquery":"jquery","underscore":"underscore"}],231:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Share-user u-rSpace js-avatar" style="background-image: url('+
((__t=( avatar ))==null?'':_.escape(__t))+
')" data-title="'+
((__t=( username ))==null?'':_.escape(__t))+
'"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],232:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var template = require('./users-group.tpl');
var UserView = require('./user-view');

var REQUIRED_OPTS = [
  'users'
];

var MAX_USERS_TO_SHOW = 3;

module.exports = CoreView.extend({
  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template({
      people: this._getRemainsPeople()
    }));
    this._renderUsers();
    return this;
  },

  _getRemainsPeople: function () {
    return Math.max(0, this._users.length - MAX_USERS_TO_SHOW);
  },

  _renderUsers: function () {
    _.each(this._users.slice(0, MAX_USERS_TO_SHOW), this._renderUser, this);
  },

  _renderUser: function (user) {
    var view = new UserView({
      username: user.username,
      avatar: user.avatar_url
    });

    this.$('.js-content').append(view.render().el);
    this.addView(view);
  }
});

},{"./user-view":230,"./users-group.tpl":233,"backbone/core-view":454,"underscore":"underscore"}],233:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex js-content"></div>\n';
 if (people > 0) { 
__p+='\n  <div class="u-secondaryTextColor CDB-Text CDB-Size-small u-lSpace">+ '+
((__t=( people ))==null?'':_.escape(__t))+
'</div>\n';
 } 
__p+='';
}
return __p;
};

},{"underscore":"underscore"}],234:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Publish-modalMenu u-tSpace-xl">\n  <nav class="CDB-NavMenu u-inner">\n    <ul class="CDB-Size-medium CDB-Text is-semibold js-menu"></ul>\n  </nav>\n</div>\n\n<div class="Tab-paneContent Publish-modalContent js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],235:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./upgrade.tpl');

var CONTACT_LINK_TEMPLATE = _.template("<a href='mailto:<%- mail %>'><%- contact %></a>")({
  contact: _t('components.modals.publish.privacy.upgrade.contact'),
  mail: _t('components.modals.publish.privacy.upgrade.mail')
});

module.exports = CoreView.extend({
  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initViews: function () {
    var html = template({
      title: _t('components.modals.publish.privacy.upgrade.title'),
      desc: _t('components.modals.publish.privacy.upgrade.desc', {
        contact: CONTACT_LINK_TEMPLATE
      })
    });
    this.$el.html(html);
  }
});

},{"./upgrade.tpl":236,"backbone/core-view":454,"underscore":"underscore"}],236:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-alignCenter">\n  <div class="Upgrade-icon u-rSpace--xl">\n    <svg width="16px" height="16px" viewBox="578 456 16 16">\n      <g id="present" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(578.000000, 456.000000)">\n        <path d="M10.0946667,4.4109223 C10.8886667,4.1368747 11.6846667,3.80147316 12.0073333,3.4715253 C12.7866667,2.67392407 12.7866667,1.37662907 12.0073333,0.579027844 C11.2513333,-0.193350099 9.934,-0.192668389 9.17866667,0.579027844 C8.74133333,1.0262299 8.29266667,2.36033726 8,3.37608583 C7.70666667,2.36033726 7.25866667,1.0262299 6.82133333,0.579027844 C6.066,-0.193350099 4.748,-0.192668389 3.99266667,0.579027844 C3.21266667,1.37662907 3.21266667,2.67392407 3.99266667,3.4715253 C4.316,3.80147316 5.11133333,4.1368747 5.90533333,4.4109223 L0.333333333,4.4109223 C0.149333333,4.4109223 0,4.56362544 0,4.75177753 L0,7.47861934 C0,7.66677142 0.149333333,7.81947456 0.333333333,7.81947456 L0.666666667,7.81947456 L0.666666667,15.6591448 C0.666666667,15.8472969 0.816,16 1,16 L15,16 C15.184,16 15.3333333,15.8472969 15.3333333,15.6591448 L15.3333333,7.81947456 L15.6666667,7.81947456 C15.8506667,7.81947456 16,7.66677142 16,7.47861934 L16,4.75177753 C16,4.56362544 15.8506667,4.4109223 15.6666667,4.4109223 L10.0946667,4.4109223 Z M6,6.95652174 L6,4.86956522 L10,4.86956522 L10,6.95652174 L6,6.95652174 L6,6.95652174 Z M10,7.65217391 L10,15.3043478 L6,15.3043478 L6,7.65217391 L10,7.65217391 L10,7.65217391 Z M9.80833133,1.08822938 C10.0510474,0.834996985 10.3727426,0.695652174 10.7169115,0.695652174 C11.0597961,0.695652174 11.3821334,0.834996985 11.6248495,1.08755946 C12.1250502,1.6101025 12.1250502,2.46023983 11.6248495,2.98278288 C11.2729754,3.34990286 9.79227867,3.85636766 8.66666667,4.17391304 C8.97102496,2.99953105 9.45581507,1.45534937 9.80833133,1.08822938 L9.80833133,1.08822938 Z M4.37515049,1.08822938 C4.6178666,0.834996985 4.94020387,0.695652174 5.28373064,0.695652174 C5.6266153,0.695652174 5.94895256,0.834996985 6.19166867,1.08755946 C6.54354282,1.45467944 7.02833293,2.99886112 7.33333333,4.17391304 C6.20707922,3.85569773 4.72638253,3.34990286 4.37515049,2.98278288 C3.87494984,2.46090976 3.87494984,1.61077243 4.37515049,1.08822938 L4.37515049,1.08822938 Z M0.666666667,4.86956522 L5.33333333,4.86956522 L5.33333333,6.95652174 L1,6.95652174 L0.666666667,6.95652174 L0.666666667,4.86956522 L0.666666667,4.86956522 Z M1.33333333,7.65217391 L5.33333333,7.65217391 L5.33333333,15.3043478 L1.33333333,15.3043478 L1.33333333,7.65217391 L1.33333333,7.65217391 Z M14.6666667,15.3043478 L10.6666667,15.3043478 L10.6666667,7.65217391 L14.6666667,7.65217391 L14.6666667,15.3043478 L14.6666667,15.3043478 Z M15.3333333,6.95652174 L15,6.95652174 L10.6666667,6.95652174 L10.6666667,4.86956522 L15.3333333,4.86956522 L15.3333333,6.95652174 L15.3333333,6.95652174 Z" id="Shape" fill="#9BC63B"></path>\n      </g>\n    </svg>\n  </div>\n  <div class="Upgrade-body">\n    <h2 class="CDB-Text CDB-Size-large">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h2>\n    <p class="CDB-Text CDB-Size-medium u-altTextColor ">'+
((__t=( desc ))==null?'':__t)+
'</p>\n  </div>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],237:[function(require,module,exports){
var _ = require('underscore');
var moment = require('moment');
var ConfirmationView = require('../confirmation/modal-confirmation-view');
var VisDefinitionModel = require('../../../data/vis-definition-model');
var MapcardPreview = require('../../../helpers/mapcard-preview');
var ErrorView = require('../../error/error-view');
var renderLoading = require('../../loading/render-loading');
var tableDeleteOperation = require('../../../dataset/operations/table-delete-operation');
var template = require('./remove-dataset.tpl');
var errorParser = require('../../../helpers/error-parser');
var REQUIRED_OPTS = [
  'modalModel',
  'userModel',
  'visModel',
  'tableModel',
  'configModel'
];
var AFFECTED_VIS_COUNT = 3;
var AFFECTED_ENTITIES_SAMPLE_COUNT = 20;

/**
 *  Remove dataset modal dialog
 */
module.exports = ConfirmationView.extend({
  className: 'Dialog-content',

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this._acl = this._visModel._permissionModel.acl;
  },

  render: function () {
    var affectedVisData = this._tableModel.get('accessible_dependent_derived_maps');
    var affectedEntitiesData = this._prepareVisibleAffectedEntities();

    this.clearSubViews();

    this.$el.html(
      template({
        modalModel: this._modalModel,
        tableName: this._tableModel.getUnquotedName(),
        affectedVisCount: affectedVisData.length,
        visibleAffectedVis: this._prepareVisibleAffectedVis(affectedVisData.slice(0, AFFECTED_VIS_COUNT)),
        organizationAffected: affectedEntitiesData.organizationAffected,
        affectedEntitiesCount: affectedEntitiesData.count,
        visibleAffectedEntities: affectedEntitiesData.data.slice(0, AFFECTED_ENTITIES_SAMPLE_COUNT),
        maxVisCount: AFFECTED_VIS_COUNT,
        maxEntitiesCount: AFFECTED_ENTITIES_SAMPLE_COUNT
      })
    );
    return this;
  },

  _prepareVisibleAffectedVis: function (visibleAffectedVisData) {
    return visibleAffectedVisData.map(function (visData) {
      var vis = new VisDefinitionModel(visData, {
        configModel: this._configModel
      });
      var owner = vis._permissionModel.get('owner');

      return {
        visId: vis.get('id'),
        name: vis.get('name'),
        url: vis.builderURL(),
        ownerName: owner.username,
        timeDiff: moment(vis.get('updated_at')).fromNow(),
        previewUrl: MapcardPreview.urlForStaticMap(this._configModel.get('maps_api_template'), vis, 304, 96)
      };
    }, this);
  },

  _prepareVisibleAffectedEntities: function () {
    var types = this._acl.pluck('type');
    var affectedEntities = {
      organizationAffected: false,
      count: 0,
      data: []
    };
    var organization;

    if (types.indexOf('org') > -1) {
      organization = this._userModel.getOrganization();
      affectedEntities.organizationAffected = true;
      affectedEntities.count = organization.get('user_count') - 1;
      if (organization.get('avatar_url')) {
        affectedEntities.data.push({
          avatarUrl: organization.get('avatar_url'),
          username: organization.get('display_name')
        });
      }
    } else {
      var users = [];
      var uniqueUsers = [];
      var userName = this._userModel.get('username');

      // Grab all ids from every group
      _.each(this._acl.where({type: 'group'}), function (group) {
        var entity = group.get('entity');
        var groupUsers = _.map(entity.users.models, function (user) {
          return {
            username: user.get('username'),
            avatarUrl: user.get('avatar_url')
          };
        });
        users = users.concat(groupUsers);
      }, this);

      // Grab all ids from every user
      _.each(this._acl.where({type: 'user'}), function (group) {
        var entity = group.get('entity');
        users.push({
          username: entity.get('username'),
          avatarUrl: entity.get('avatar_url')
        });
      }, this);

      // remove current user id because it can be part of a group
      users = _.filter(users, function (user) {
        return user.username !== userName;
      });

      // return only uniques
      uniqueUsers = _.uniq(users, function (item) {
        return item.username;
      });

      affectedEntities.count = uniqueUsers.length;
      affectedEntities.data = uniqueUsers;
    }

    return affectedEntities;
  },

  _runAction: function () {
    this._renderLoadingView();

    tableDeleteOperation({
      onSuccess: this._onSuccessDestroyDataset.bind(this, this._modalModel),
      onError: this._onErrorDestroyDataset.bind(this),
      visModel: this._visModel
    });
  },

  _renderLoadingView: function () {
    this.$el.html(
      renderLoading({
        title: _t('dataset.delete.loading', { tableName: this._tableModel.getUnquotedName() })
      })
    );
  },

  _onSuccessDestroyDataset: function () {
    window.location = this._configModel.get('base_url') + '/dashboard';
  },

  _onErrorDestroyDataset: function (mdl, e) {
    var errorMessage = errorParser(e);
    var errorView = new ErrorView({
      title: _t('dataset.delete.error', {
        tableName: this._tableModel.getUnquotedName(),
        error: errorMessage
      }),
      desc: errorMessage || _t('components.error.default-desc')
    });
    this.$el.html(errorView.render().el);
    this.addView(errorView);
  }
});

},{"../../../data/vis-definition-model":377,"../../../dataset/operations/table-delete-operation":402,"../../../helpers/error-parser":426,"../../../helpers/mapcard-preview":429,"../../error/error-view":37,"../../loading/render-loading":187,"../confirmation/modal-confirmation-view":190,"./remove-dataset.tpl":238,"moment":"moment","underscore":"underscore"}],238:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="24px" height="25px" viewbox="521 436 24 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <path d="M524.5,440 L540.5,440 L540.5,460 L524.5,460 L524.5,440 Z M528.5,437 L536.5,437 L536.5,440 L528.5,440 L528.5,437 Z M522,440 L544,440 L522,440 Z M528.5,443.5 L528.5,455.5 L528.5,443.5 Z M532.5,443.5 L532.5,455.5 L532.5,443.5 Z M536.5,443.5 L536.5,455.5 L536.5,443.5 Z" id="Shape" stroke="#F19243" stroke-width="1" fill="none"/>\n      </svg>\n    </div>\n    <div>\n      <h2 class="CDB-Text CDB-Size-huge is-light u-bSpace--xl">\n        '+
((__t=( _t('dataset.delete.title', { tableName: tableName }) ))==null?'':__t)+
'\n      </h2>\n      <p class="CDB-Text CDB-Size-large u-secondaryTextColor">'+
((__t=( _t('dataset.delete.desc') ))==null?'':_.escape(__t))+
'</p>\n\n      ';
 if (affectedVisCount > 0) { 
__p+='\n        <div class="Modal-listActions js-affectedVis">\n          <p class="CDB-Text CDB-Size-large u-altTextColor">\n            ';
 if (affectedVisCount > maxVisCount) {
__p+='\n              '+
((__t=( _t('dataset.delete.affected-vis-count-extended', {affectedVisCount: affectedVisCount}) ))==null?'':__t)+
'\n            ';
 } else { 
__p+='\n              '+
((__t=( _t('dataset.delete.affected-vis-count', {smart_count: affectedVisCount}) ))==null?'':__t)+
'\n            ';
 } 
__p+='\n          </p>\n\n          <ul class="u-flex u-justifyStart u-tSpace-xl">\n            ';
 visibleAffectedVis.forEach(function(vis) { 
__p+='\n              <li class="MapsList-item MapsList-item--wRightMargins">\n                <div class="MapCard" data-vis-id="'+
((__t=( vis.visId ))==null?'':_.escape(__t))+
'" data-vis-owner-name="'+
((__t=( vis.ownerName ))==null?'':_.escape(__t))+
'">\n                  <a href="'+
((__t=( vis.url ))==null?'':_.escape(__t))+
'" target="_blank" class="MapCard-header MapCard-header--mCompact js-header">\n                    <img class="MapCard-preview" src="'+
((__t=( vis.previewUrl ))==null?'':_.escape(__t))+
'" style="display: inline;">\n                    <div class="MapCard-loader"></div>\n                  </a>\n                  <div class="MapCard-content MapCard-content--compact">\n                    <div class="MapCard-contentBody">\n                      <div class="MapCard-contentBodyRow MapCard-contentBodyRow--flex">\n                        <h3 class="CDB-Text CDB-Size-large u-bSpace u-ellipsis">\n                          <a href="'+
((__t=( vis.url ))==null?'':_.escape(__t))+
'" target="_blank" title="'+
((__t=( vis.name ))==null?'':_.escape(__t))+
'" class="u-mainTextColor">'+
((__t=( vis.name ))==null?'':_.escape(__t))+
'</a>\n                        </h3>\n                      </div>\n                      <p class="MapCard-contentBodyTimeDiff DefaultTimeDiff CDB-Text CDB-Size-medium u-altTextColor">\n                        '+
((__t=( vis.timeDiff ))==null?'':_.escape(__t))+
'\n                      </p>\n                    </div>\n                  </div>\n                </div>\n              </li>\n            ';
 }); 
__p+='\n          </ul>\n        </div>\n      ';
 } 
__p+='\n\n      ';
 if (affectedEntitiesCount > 0 || organizationAffected) { 
__p+='\n        <div class="Modal-listActions js-affectedEntities">\n          <p class="CDB-Text CDB-Size-large u-altTextColor">\n            ';
 if (organizationAffected) { 
__p+='\n              '+
((__t=( _t('dataset.delete.whole-organization-affected') ))==null?'':__t)+
'\n            ';
 } else if (affectedEntitiesCount > maxEntitiesCount && visibleAffectedEntities.length > 0) {
__p+='\n              '+
((__t=( _t('dataset.delete.affected-entities-count-extended', {affectedEntitiesCount: affectedEntitiesCount}) ))==null?'':__t)+
'\n            ';
 } else { 
__p+='\n              '+
((__t=( _t('dataset.delete.affected-entities-count', {smart_count: affectedEntitiesCount}) ))==null?'':__t)+
'\n            ';
 } 
__p+='\n          </p>\n\n          <ul class="u-flex u-justifyStart u-tSpace-xl">\n          ';
 visibleAffectedEntities.forEach(function(entity) { 
__p+='\n            ';
 if (entity.avatarUrl) { 
__p+=' \n              <li class="u-rSpace--m">\n                <div class="Share-user Share-user--medium" style="background-image: url('+
((__t=( entity.avatarUrl ))==null?'':_.escape(__t))+
')" data-username="'+
((__t=( entity.username ))==null?'':_.escape(__t))+
'" title="'+
((__t=( entity.username ))==null?'':_.escape(__t))+
'"></div>\n              </li>\n            ';
 } 
__p+='\n          ';
 }); 
__p+='\n        </ul>\n        </div>\n      ';
 } 
__p+='\n\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--medium js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small u-upperCase">\n              '+
((__t=( _t('dataset.delete.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--medium js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small u-upperCase">\n              '+
((__t=( _t('dataset.delete.confirm') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],239:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./sync-options-modal.tpl');
var renderLoading = require('../../loading/render-loading');
var ErrorView = require('../../error/error-view');
var errorParser = require('../../../helpers/error-parser');

module.exports = CoreView.extend({
  className: 'Dialog-content',

  events: {
    'click .js-confirm': '_onConfirm',
    'click .js-cancel': '_onCancel'
  },

  initialize: function (opts) {
    if (!opts.modalModel) throw new Error('modalModel is required');
    if (!opts.syncModel) throw new Error('syncModel is required');
    if (!opts.tableName) throw new Error('tableName is required');

    this._syncModel = opts.syncModel;
    this._modalModel = opts.modalModel;
    this._tableName = opts.tableName;
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(
      template({
        interval: this._syncModel.get('interval'),
        service: this._syncModel.get('service_name') || '',
        isExternalSource: this._syncModel.get('from_external_source'),
        url: this._getServiceURL()
      })
    );
  },

  _renderErrorView: function (errorMessage) {
    var errorView = new ErrorView({
      title: _t('dataset.sync.error'),
      desc: errorMessage
    });
    this.$el.html(errorView.render().el);
    this.addView(errorView);
  },

  _renderLoadingView: function () {
    this.$el.html(
      renderLoading({
        title: _t('dataset.sync.loading', { tableName: this._tableName })
      })
    );
  },

  _getServiceURL: function () {
    if (this._syncModel.get('service_name') || this._syncModel.get('service_item_id')) {
      return this._syncModel.get('service_item_id');
    }
    return this._syncModel.get('url');
  },

  _onConfirm: function () {
    var interval = parseInt(this.$('[name="interval"]:checked').val(), 10);
    var opts = {
      wait: true,
      success: function () {
        this._modalModel.destroy();
      }.bind(this),
      error: function (mdl, e) {
        this._renderErrorView(errorParser(e));
      }.bind(this)
    };

    this._renderLoadingView();

    if (this._syncModel.get('interval') !== interval) {
      if (!interval) {
        this._syncModel.destroy(opts);
      } else {
        this._syncModel.save({
          interval: interval
        }, opts);
      }
    } else {
      this._modalModel.destroy();
    }
  },

  _onCancel: function () {
    this._modalModel.destroy();
  }

});

},{"../../../helpers/error-parser":426,"../../error/error-view":37,"../../loading/render-loading":187,"./sync-options-modal.tpl":240,"backbone/core-view":454}],240:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--full u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="24px" height="20px" viewBox="0 8 24 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n          <g id="Icon" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(0.000000, 8.000000)">\n              <path d="M19.591513,9.26858726 C19.7142261,9.39218837 19.8745043,9.45462604 20.0347826,9.45462604 C20.1950609,9.45462604 20.3553391,9.39218837 20.4780522,9.26858726 C20.7222261,9.0201108 20.7222261,8.61617729 20.4780522,8.36770083 C20.1988174,8.08354571 19.908313,7.81468144 19.6065391,7.56365651 C19.5652174,7.52925208 19.5201391,7.4999446 19.4775652,7.46554017 C17.3914435,5.76952909 14.824487,4.84060942 12.1147826,4.84060942 L12.1122783,4.84060942 L12.1097739,4.84060942 C8.95053913,4.84060942 5.98038261,6.0931856 3.74775652,8.36770083 C3.50358261,8.61617729 3.50358261,9.0201108 3.74775652,9.26858726 C3.87046957,9.3934626 4.03074783,9.45462604 4.19102609,9.45462604 C4.35130435,9.45462604 4.51158261,9.39218837 4.63304348,9.26858726 C6.63151304,7.23490305 9.28737391,6.11484765 12.1122783,6.11484765 C14.9371826,6.11484765 17.5930435,7.23490305 19.591513,9.26858726 L19.591513,9.26858726 Z" id="Shape" fill="#2E3C43"></path>\n              <path d="M22.7607652,5.95695291 C22.8834783,6.08182825 23.0437565,6.14299169 23.2040348,6.14299169 C23.364313,6.14299169 23.5245913,6.08055402 23.6473043,5.95695291 C23.8914783,5.70847645 23.8914783,5.30454294 23.6473043,5.05606648 C17.2862609,-1.41706371 6.93704348,-1.41451524 0.578504348,5.05606648 C0.334330435,5.30454294 0.334330435,5.70847645 0.578504348,5.95695291 C0.822678261,6.20542936 1.21961739,6.20542936 1.4637913,5.95695291 C7.33398261,-0.0179501385 16.8905739,-0.0166759003 22.7607652,5.95695291 L22.7607652,5.95695291 Z" id="Shape" fill="#2E3C43"></path>\n              <path d="M9.58789565,9.966759 C8.61495652,10.3273684 7.69586087,10.8854848 6.91575652,11.6793352 C6.67158261,11.9278116 6.67158261,12.3317452 6.91575652,12.5802216 C7.03846957,12.705097 7.19874783,12.7662604 7.35902609,12.7662604 C7.51930435,12.7662604 7.67958261,12.7038227 7.80229565,12.5802216 C10.1789217,10.1642659 14.046887,10.1642659 16.4247652,12.5802216 C16.5474783,12.705097 16.7077565,12.7662604 16.8680348,12.7662604 C17.028313,12.7662604 17.1885913,12.7038227 17.3113043,12.5802216 C17.5554783,12.3317452 17.5554783,11.9278116 17.3113043,11.6793352 C15.2239304,9.55645429 12.1924174,8.99961219 9.58789565,9.966759 L9.58789565,9.966759 Z" id="Shape" fill="#2E3C43"></path>\n              <path d="M12.1122783,14.1359557 C10.5307826,14.1359557 9.2448,15.4445983 9.2448,17.052687 C9.2448,18.6620499 10.5307826,19.9706925 12.1122783,19.9706925 C13.6925217,19.9706925 14.9785043,18.6620499 14.9785043,17.052687 C14.9785043,15.4458726 13.6925217,14.1359557 12.1122783,14.1359557 L12.1122783,14.1359557 Z M12.1122783,18.6977285 C11.2219826,18.6977285 10.4969739,17.9599446 10.4969739,17.0539612 C10.4969739,16.1479778 11.2219826,15.4114681 12.1122783,15.4114681 C13.0025739,15.4114681 13.7263304,16.1479778 13.7263304,17.0539612 C13.7263304,17.9599446 13.0025739,18.6977285 12.1122783,18.6977285 L12.1122783,18.6977285 Z" id="Shape" fill="#2E3C43"></path>\n          </g>\n      </svg>\n    </div>\n    <div>\n      <h2 class="CDB-Text CDB-Size-huge is-light u-bSpace--m">\n        '+
((__t=( _t('dataset.sync.title') ))==null?'':_.escape(__t))+
'\n     </h2>\n      <p class="CDB-Text CDB-Size-medium u-altTextColor">\n        '+
((__t=( _t('dataset.sync.desc', {
          service: service,
          url: url
        }) ))==null?'':__t)+
'\n      </p>\n      <div class="Modal-listTextItem u-flex u-alignCenter">\n        <h3 class="CDB-Text CDB-Size-small is-semibold u-upperCase">'+
((__t=( _t('dataset.sync.label') ))==null?'':_.escape(__t))+
'</h3>\n        <ul class="Modal-listForm u-flex u-alignCenter CDB-Text CDB-Size-small js-intervals">\n          <li class="Modal-listFormItem">\n            <input class="CDB-Radio" type="radio" name="interval" value="3600"\n              ';
 if (interval === 3600) { 
__p+='\n                checked\n              ';
 } 
__p+='\n\n              ';
 if (isExternalSource) { 
__p+='\n                disabled\n              ';
 } 
__p+='\n            >\n            <span class="u-iBlock CDB-Radio-face"></span>\n            <label class="u-iBlock u-lSpace u-upperCase">Every hour</label>\n          </li>\n          <li class="Modal-listFormItem">\n            <input class="CDB-Radio" type="radio" name="interval" value="86400"\n              ';
 if (interval === 86400) { 
__p+='\n                checked\n              ';
 } 
__p+='\n\n              ';
 if (isExternalSource) { 
__p+='\n                disabled\n              ';
 } 
__p+='\n            >\n            <span class="u-iBlock CDB-Radio-face"></span>\n            <label class="u-iBlock u-lSpace u-upperCase">Every day</label>\n          </li>\n          <li class="Modal-listFormItem">\n            <input class="CDB-Radio" type="radio" name="interval" value="604800"\n              ';
 if (interval === 604800) { 
__p+='\n                checked\n              ';
 } 
__p+='\n\n              ';
 if (isExternalSource) { 
__p+='\n                disabled\n              ';
 } 
__p+='\n            >\n            <span class="u-iBlock CDB-Radio-face"></span>\n            <label class="u-iBlock u-lSpace u-upperCase">Every week</label>\n          </li>\n          <li class="Modal-listFormItem">\n            <input class="CDB-Radio" type="radio" name="interval" value="2592000"\n              ';
 if (interval === 2592000) { 
__p+='\n                checked\n              ';
 } 
__p+='\n            >\n            <span class="u-iBlock CDB-Radio-face"></span>\n            <label class="u-iBlock u-lSpace u-upperCase">Every month</label>\n          </li>\n          <li class="Modal-listFormItem">\n            <input class="CDB-Radio" type="radio" name="interval" value="0"\n              ';
 if (interval === 0) { 
__p+='\n                checked\n              ';
 } 
__p+='\n            >\n            <span class="u-iBlock CDB-Radio-face"></span>\n            <label class="u-iBlock u-lSpace u-upperCase">Never</label>\n          </li>\n        </ul>\n      </div>\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('dataset.sync.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('dataset.sync.confirm') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n\n\n';
}
return __p;
};

},{"underscore":"underscore"}],241:[function(require,module,exports){
module.exports = ' | CARTO';

},{}],242:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="IntermediateInfo">\n  <div class="LayoutIcon">\n    <i class="CDB-IconFont '+
((__t=( icon ))==null?'':_.escape(__t))+
'"></i>\n  </div>\n  <h4 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m u-tSpace-xl">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h4>\n  <p class="CDB-Text CDB-Size-medium u-altTextColor">\n    '+
((__t=( desc ))==null?'':_.escape(__t))+
'\n  </p>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],243:[function(require,module,exports){
var template = require('./no-results.tpl');

/**
 * @param {Object} opts
 * @param {String=} opts.icon
 * @param {String=} opts.title
 * @param {String=} opts.desc
 */

module.exports = function (opts) {
  return template({
    icon: opts.icon || 'CDB-IconFont-cockroach',
    title: opts.title || '',
    desc: opts.desc
  });
};

},{"./no-results.tpl":242}],244:[function(require,module,exports){
var CoreView = require('backbone/core-view');

module.exports = CoreView.extend({
  tagName: 'button',

  initialize: function (opts) {
    if (!opts.template) throw new Error('template is required');
    if (!opts.editorModel) throw new Error('editorModel is required');
    this.template = opts.template;
    this._editorModel = opts.editorModel;
    this._data = {};
    if (opts.model) {
      this._data = opts.model.toJSON();
    }
    this._initBinds();
  },

  _initBinds: function () {
    this.listenTo(this._editorModel, 'change:edition', this._changeStyle);
    this.add_related_model(this._editorModel);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this.$el.append(this.template(this._data));
    return this;
  },

  _changeStyle: function () {
    this.$('.js-theme').toggleClass('is-white', this._editorModel.isEditing());
  }
});

},{"backbone/core-view":454}],245:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<span data-action="'+
((__t=( button ))==null?'':_.escape(__t))+
'" class="CDB-Text is-semibold u-lSpace u-actionTextColor u-upperCase">'+
((__t=( button ))==null?'':_.escape(__t))+
'</span>';
}
return __p;
};

},{"underscore":"underscore"}],246:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Shape-close is-blue is-large js-theme"></div>';
}
return __p;
};

},{"underscore":"underscore"}],247:[function(require,module,exports){
var Backbone = require('backbone');
var NotifierModel = require('./notifier-model');

module.exports = Backbone.Collection.extend({
  model: function (attrs, opts) {
    return new NotifierModel(attrs, opts);
  },

  findById: function (id) {
    return this.findWhere({id: id});
  }
});

},{"./notifier-model":250,"backbone":"backbone"}],248:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var Template = require('./notifier-item.tpl');
var ActionView = require('./notifier-action-view');
var closeTemplate = require('./notifier-close.tpl');
var actionTemplate = require('./notifier-action.tpl');

module.exports = CoreView.extend({
  className: 'Notifier-inner',
  tagName: 'li',
  events: {
    'click .js-close': '_closeHandler',
    'click .js-action': '_actionHandler'
  },

  initialize: function (opts) {
    if (!opts.notifierModel) throw new Error('notifierModel is required');
    if (!opts.editorModel) throw new Error('editorModel is required');

    this._editorModel = opts.editorModel;
    this.template = this.options.template || Template;
    this._notifierModel = opts.notifierModel;
    this.$el.attr('id', this._notifierModel.get('id'));

    this._delay = this._notifierModel.get('delay') || this._notifierModel.get('defaultDelay');

    if (this._notifierModel.get('delay') && this._notifierModel.get('closable') !== false) {
      this._timeout = setTimeout(this._autoClose.bind(this), this._delay);
    }

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    this._changeStyle();
    return this;
  },

  _initBinds: function () {
    this.listenTo(this._notifierModel, 'change', this.render);
    this.listenTo(this._notifierModel, 'change:status', this._onChangeStatus);
    this.add_related_model(this._notifierModel);

    this.listenTo(this._editorModel, 'change:edition', this._changeStyle);
    this.add_related_model(this._editorModel);
  },

  _initViews: function () {
    var actionable = this._notifierModel.getButton();
    var closable = this._notifierModel.isClosable();
    var view = this.template({
      status: this._notifierModel.getStatus(),
      info: this._notifierModel.getInfo(),
      isActionable: actionable,
      isClosable: closable
    });

    this.$el.append(view);

    if (actionable) {
      this._createActionView(actionable);
    }

    if (closable) {
      this._createCloseView();
    }
  },

  _createActionView: function (action) {
    var actionView = new ActionView({
      template: actionTemplate,
      className: 'js-action',
      model: this._notifierModel,
      editorModel: this._editorModel
    });

    this.$('.js-actionButton').append(actionView.render().el);
    this.addView(actionView);
  },

  _createCloseView: function () {
    var actionView = new ActionView({
      template: closeTemplate,
      className: 'CDB-Shape js-close',
      editorModel: this._editorModel
    });

    this.$('.js-closeButton').append(actionView.render().el);
    this.addView(actionView);
  },

  _closeHandler: function () {
    var status = this._notifierModel.getStatus();
    var action = this._notifierModel.getAction();
    this._notifierModel.trigger('notification:close', action || status);
    clearTimeout(this._timeout);
    if (this._notifierModel && this._notifierModel.collection) {
      this._notifierModel.collection.remove(this._notifierModel);
    }
  },

  _actionHandler: function () {
    var status = this._notifierModel.getStatus();
    var action = this._notifierModel.getAction();
    this._notifierModel.trigger('notification:action', action || status);
  },

  _changeStyle: function () {
    this.$('.Notifier-info').toggleClass('u-whiteTextColor', this._editorModel.isEditing());
    this.$('.Notifier-actions .CDB-Shape-close').toggleClass('is-blue', !this._editorModel.isEditing());
    this.$('.Notifier-actions .CDB-Shape-close').toggleClass('is-white', this._editorModel.isEditing());
  },

  _autoClose: function () {
    this._notifierModel.set({action: 'autoclose'}, {silent: true});
    this._closeHandler();
  },

  _onChangeStatus: function (model, status) {
    if ((status === 'success' || status === 'error') && this._notifierModel.get('closable') !== false && this._notifierModel.get('autoclosable') !== false) {
      this._timeout = setTimeout(this._autoClose.bind(this), this._delay);
    }
  }
});

},{"./notifier-action-view":244,"./notifier-action.tpl":245,"./notifier-close.tpl":246,"./notifier-item.tpl":249,"backbone/core-view":454}],249:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Notifier-item Notifier-item--'+
((__t=( status ))==null?'':_.escape(__t))+
'">\n\n  ';
 if (status === 'loading') { 
__p+='\n  <div class="Notifier-icon CDB-LoaderIcon is-blue js-theme u-rSpace--m">\n    <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n      <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n    </svg>\n  </div>\n  ';
 } 
__p+='\n\n  ';
 if (status === 'success') { 
__p+='\n  <div class="Notifier-icon CDB-Shape u-rSpace--m">\n    <div class="CDB-Shape-CircleItem CDB-Shape-CircleItem--fill is-green">\n      <div class="CDB-Shape-tick is-medium is-white"></div>\n    </div>\n  </div>\n  ';
 } 
__p+='\n\n  ';
 if (status === 'error' || status === 'warning') { 
__p+='\n  <div class="Notifier-icon CDB-Shape u-rSpace--m">\n    <div class="CDB-Shape-CircleItem CDB-Shape-CircleItem--fill is-red">\n      <div class="CDB-Shape-close is-medium is-white"></div>\n    </div>\n  </div>\n  ';
 } 
__p+='\n\n  <div class="Notifier-info">\n    <p class="CDB-Text CDB-Size-medium">'+
((__t=( info ))==null?'':__t)+
' ';
 if (isActionable) { 
__p+=' <span class="js-actionButton"></span> ';
 } 
__p+='</p>\n  </div>\n\n  ';
 if (isClosable) { 
__p+='\n    <div class="Notifier-actions js-closeButton"></div>\n  ';
 } 
__p+='\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],250:[function(require,module,exports){
var Backbone = require('backbone');

module.exports = Backbone.Model.extend({
  defaults: {
    status: 'idle',
    info: '',
    closable: true
  },

  initialize: function (attrs, opts) {
    if (attrs.id === undefined) {
      this.set('id', 'notifier' + this.cid);
    }

    this.set('defaultDelay', opts.delay);

    if (opts.visDefinitionModel) {
      this._retriggerEvent(opts.visDefinitionModel, 'vis:reload');
      this._retriggerEvent(opts.visDefinitionModel, 'vis:error');
    }
  },

  isClosable: function () {
    return this.get('closable') === true;
  },

  updateClosable: function (val) {
    this.set({closable: val});
  },

  getButton: function () {
    return this.get('button');
  },

  updateButton: function (val) {
    this.set({button: val});
  },

  getStatus: function () {
    return this.get('status');
  },

  updateStatus: function (val) {
    this.set({status: val});
  },

  getInfo: function () {
    return this.get('info');
  },

  getAction: function () {
    return this.get('action');
  },

  setAction: function (val) {
    this.set({action: val});
  },

  updateInfo: function (val) {
    this.set({info: val});
  },

  update: function (state) {
    this.set(state);
  },

  _retriggerEvent: function (model, event) {
    model.on(event, function () {
      this.trigger(event, arguments);
    }, this);
  }
});

},{"backbone":"backbone"}],251:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var NotifierItemView = require('./notifier-item-view');
var template = require('./notifier.tpl');

module.exports = CoreView.extend({
  className: 'Notifier',

  initialize: function (opts) {
    if (!opts.collection) throw new Error('collection is mandatory');
    if (!opts.editorModel) throw new Error('editorModel is mandatory');

    this._editorModel = opts.editorModel;
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template());
    this._renderAllSubviews();
    this._renderLoading();
    return this;
  },

  rebindEvents: function () {
    // Just in case
    this.stopListening(this.collection);
    this.stopListening(this._editorModel);
    this._initBinds();
    return this;
  },

  _initBinds: function () {
    this.listenTo(this.collection, 'reset update change:status', this.render);
    this.add_related_model(this.collection);

    this.listenTo(this._editorModel, 'change:edition', this._changeStyle);
    this.add_related_model(this._editorModel);
  },

  _renderAllSubviews: function () {
    this.collection.each(this._renderSubview, this);
  },

  _renderSubview: function (model) {
    var view = new NotifierItemView({
      notifierModel: model,
      editorModel: this._editorModel
    });

    var status = model.get('status');
    var container = (status === 'success' || status === 'error')
                    ? this._getDoneContainer()
                    : this._getLoadingContainer();
    container.append(view.render().el);
    this.addView(view);
  },

  _removeSubview: function (model) {
    var id = model.get('id');
    var view = _.first(_.filter(this._subviews, function (subview) {
      return subview._notifierModel.get('id') === id;
    }));

    if (view) {
      this.removeView(view);
      view.remove();
    }
  },

  _renderLoading: function () {
    this._getLoader().toggleClass('is-visible', this._anyNotificationLoading());
  },

  _anyNotificationLoading: function () {
    return this.collection.any(function (model) {
      return !_.contains(['success', 'error', 'warning'], model.get('status'));
    });
  },

  _changeStyle: function () {
    this.$el.toggleClass('is-dark', this._editorModel.isEditing());
  },

  _getDoneContainer: function () {
    return this.$('.js-status-done');
  },

  _getLoadingContainer: function () {
    return this.$('.js-status-loading');
  },

  _getLoader: function () {
    return this.$('.js-loader');
  }
});

},{"./notifier-item-view":248,"./notifier.tpl":253,"backbone/core-view":454,"underscore":"underscore"}],252:[function(require,module,exports){
var NotifierView = require('./notifier-view');
var NotifierCollection = require('./notifier-collection');

var manager = (function () {
  var initialized = false;
  var notifierView;
  var collection = new NotifierCollection();
  var editorModel;

  function init (opts) {
    if (!editorModel && !opts) {
      throw new Error('editorModel is required');
    }

    if (!editorModel && opts && opts.editorModel) {
      editorModel = opts.editorModel;
    }

    initialized = true;
    notifierView = new NotifierView({
      collection: collection,
      editorModel: editorModel
    });
  }

  return {
    DEFAULT_DELAY: 5000,
    init: function (opts) {
      if (opts.visDefinitionModel) {
        this._visDefinitionModel = opts.visDefinitionModel;
      }
      init(opts);
    },

    getView: function () {
      if (!initialized) init();
      return notifierView.rebindEvents();
    },

    getCollection: function () {
      return collection;
    },

    getNotification: function (model) {
      var notification;
      if (typeof model === 'string') {
        notification = collection.findById(model);
      } else {
        notification = collection.findById(model.id);
      }
      return notification;
    },

    addNotification: function (attrs) {
      return collection.add(attrs, {
        visDefinitionModel: this._visDefinitionModel,
        delay: this.DEFAULT_DELAY
      });
    },

    removeNotification: function (model) {
      var notification;
      if (typeof model === 'string') {
        notification = collection.findById(model);
      } else {
        notification = collection.findById(model.id);
      }
      return collection.remove(notification);
    }
  };
})();

module.exports = manager;

},{"./notifier-collection":247,"./notifier-view":251}],253:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Loader js-loader"></div>\n<ul class="Notifier-list js-status-loading"></ul>\n<ul class="Notifier-list js-status-done"></ul>';
}
return __p;
};

},{"underscore":"underscore"}],254:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var $ = require('jquery');
var template = require('./builder-activated-notification.tpl');
var DASHBOARD_NOTIFICATION_KEY = 'builder_activated';

module.exports = CoreView.extend({
  className: 'js-builderNotification',
  events: {
    'click .js-close': '_onClose'
  },

  initialize: function () {
    if (!this.options.builderActivatedNotification) { throw new Error('builderActivatedNotification is required'); }
    this._notification = this.options.builderActivatedNotification;

    this.render();
  },

  render: function () {
    this.$el.html(template());
    $('body').prepend(this.$el);

    return this;
  },

  _onClose: function () {
    this._notification.setKey(DASHBOARD_NOTIFICATION_KEY, true);
    this._notification.save();

    this.clean();
  },

  clean: function () {
    this.constructor.__super__.clean.apply(this);
  }
});

},{"./builder-activated-notification.tpl":255,"backbone/core-view":454,"jquery":"jquery"}],255:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="onboardingNotification Color-MainDark CDB-Text CDB-Size-medium u-flex u-justifyCenter">\n  <p>'+
((__t=( _t('builder-activated-notification.message') ))==null?'':__t)+
'</p>\n\n  <button class="onboardingNotification-closeButton js-close">\n    <div class="CDB-Shape-close is-large is-white"></div>\n  </button>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],256:[function(require,module,exports){
var Backbone = require('backbone');

/**
 * Model representing the query string params for a "paged search" of a collection (matching the server-side APIs).
 *
 * @example usage
 *   pagedSearch = new PaginationSearchModel({  })
 *   pagedSearch.fetch(collection) // => jqXHR, GET /collection/123?page=1&per_page20
 *   pagedSearch.set({ page: 2, per_page: 10, q: 'test' });
 *   pagedSearch.fetch(collection) // => GET /collection/123?page=2&per_page10&q=test
 */
module.exports = Backbone.Model.extend({

  defaults: {
    per_page: 20,
    page: 1,
    q: ''
  },

  initialize: function (attrs, opts) {
    if (!opts.collection) throw new Error('collection is required');
    if (!opts.collection.totalCount) throw new Error('collection requires to implement totalCount method');

    this.collection = opts.collection;
    this._initBinds();
  },

  _initBinds: function () {
    this.collection.on('sync', this._updateStateFetched, this);
    this.collection.on('error', this._updateStateError, this);
  },

  fetch: function () {
    this.trigger('fetching', this);
    return this.collection.fetch({
      data: this.attributes
    }, {reset: true});
  },

  _updateStateFetched: function () {
    this.trigger('fetched', this);
  },

  _updateStateError: function () {
    this.trigger('error', this);
  }
});

},{"backbone":"backbone"}],257:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var PaginationModel = require('../pagination/pagination-model');
var PaginationSearchModel = require('./pagination-search-model');
var renderLoading = require('../loading/render-loading');
var renderNoResults = require('../no-results/render-no-results');
var ErrorView = require('../error/error-view');
var template = require('./pagination-search.tpl');
var Utils = require('../../helpers/utils');
var PaginationView = require('../pagination/pagination-view');
var paginationTemplate = require('./pagination.tpl');

/**
 * View to render a searchable/pageable collection.
 * Also allows to filter/search list.
 *
 */

var REQUIRED_OPTS = [
  'listCollection',
  'createContentView'
];

var ENTER_KEY_CODE = 13;
var ESCAPE_KEY_CODE = 27;

module.exports = CoreView.extend({

  events: {
    'click .js-search-link': '_onSearchClick',
    'click .js-clean-search': '_onCleanSearchClick',
    'keydown .js-search-input': '_onKeyDown'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this._paginationModel = new PaginationModel({
      current_page: 1
    });

    this._paginationSearchModel = new PaginationSearchModel({}, {
      collection: this._listCollection
    });

    this._stateModel = new Backbone.Model({
      state: 'idle'
    });

    this._initBinds();
    this._initPagination();
    this._paginationSearchModel.fetch();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(template({
      q: this._paginationSearchModel.get('q')
    }));
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this._paginationSearchModel.on('fetching', this.showLoading, this);
    this._paginationSearchModel.on('fetched', this._updateStateFetched, this);
    this._paginationSearchModel.on('error', this.showError, this);

    this._paginationModel.bind('change:current_page', this._fetchByPagination, this);

    this._stateModel.on('change:state', this.render, this);

    this.add_related_model(this._paginationModel);
    this.add_related_model(this._stateModel);
    this.add_related_model(this._stateModel);
  },

  _fetchByPagination: function () {
    this._paginationSearchModel.set('page', this._paginationModel.get('current_page'));
    this._paginationSearchModel.fetch();
  },

  showError: function () {
    this._stateModel.set('state', 'error');
  },

  showLoading: function () {
    this._stateModel.set('state', 'loading');
  },

  _updateStateFetched: function () {
    this._paginationModel.set({
      per_page: this._paginationSearchModel.get('per_page'),
      total_count: this._listCollection.totalCount()
    });
    if (this._listCollection.length > 0) {
      this._stateModel.set('state', 'show');
    } else {
      this._stateModel.set('state', 'no-results');
    }
  },

  _initPagination: function () {
    this._paginationView = new PaginationView({
      className: 'Pagination Pagination--search Pagination--searchShare',
      model: this._paginationModel,
      template: paginationTemplate
    });
    this.addView(this._paginationView);
  },

  _initViews: function () {
    var state = this._stateModel.get('state');
    var view;

    this.$el.append(this._paginationView.render().el);

    if (state === 'loading') {
      this._content().html(renderLoading({
        title: _t('components.pagination-search.loading.title')
      }));
    }

    if (state === 'error') {
      var errorView = new ErrorView({
        title: _t('components.pagination-search.error.title'),
        desc: _t('components.pagination-search.error.desc')
      });
      this._content().html(errorView.render().el);
      this.addView(errorView);
    }

    if (state === 'show') {
      view = this._createContentView({
        hasOrganization: this._paginationSearchModel.get('q') === ''
      });
      this._content().html(view.render().el);
      this.addView(view);
    }

    if (state === 'no-results') {
      this._content().html(renderNoResults({
        icon: 'CDB-IconFont-defaultUser',
        title: _t('components.pagination-search.no-results.title'),
        desc: _t('components.pagination-search.no-results.desc')
      }));
    }
  },

  _focusSearchInput: function () {
    this._searchInput().focus().val();
  },

  _onSearchClick: function (e) {
    this.killEvent(e);
    this._searchInput().focus();
  },

  _onCleanSearchClick: function (e) {
    this.killEvent(e);
    this._cleanSearch();
  },

  _onKeyDown: function (e) {
    if (e.which === ENTER_KEY_CODE) {
      this.killEvent(e);
      this._submitSearch();
    } else if (e.which === ESCAPE_KEY_CODE) {
      if (this._paginationSearchModel.get('q')) {
        this.killEvent(e);
        this._cleanSearch();
      }
    }
  },

  _submitSearch: function (e) {
    this._makeNewSearch(Utils.stripHTML(this._searchInput().val().trim()));
  },

  _cleanSearch: function () {
    this._searchInput().val('');
    this._makeNewSearch('');
  },

  _makeNewSearch: function (query) {
    this._paginationSearchModel.set({
      q: query,
      page: 1
    });

    this._paginationSearchModel.fetch();
  },

  _searchInput: function () {
    return this.$('.js-search-input');
  },

  _cleanSearchBtn: function () {
    return this.$('.js-clean-search');
  },

  _content: function () {
    return this.$('.js-content');
  }

});

},{"../../helpers/utils":435,"../error/error-view":37,"../loading/render-loading":187,"../no-results/render-no-results":243,"../pagination/pagination-model":260,"../pagination/pagination-view":261,"./pagination-search-model":256,"./pagination-search.tpl":258,"./pagination.tpl":259,"backbone":"backbone","backbone/core-view":454,"underscore":"underscore"}],258:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Filters is-relative">\n  <div class="Filters-inner">\n    <div class="Filters-row Share-filtersRow js-filters">\n      <div class="Filters-typeItem Filters-typeItem--searchEnabler">\n        <p class="Filters-searchLink js-search-link u-alignCenter CDB-Text CDB-Size-medium u-upperCase">\n          <i class="Filters-searchLinkIcon CDB-IconFont CDB-IconFont-lens u-rSpace--xl"></i> '+
((__t=( _t('components.pagination-search.filter.search') ))==null?'':_.escape(__t))+
'\n        </p>\n      </div>\n      <div class="Filters-typeItem Filters-typeItem--searchField">\n        <input class="Filters-searchInput CDB-Text CDB-Size-medium js-search-input" type="text" value="'+
((__t=( q ))==null?'':_.escape(__t))+
'" placeholder="'+
((__t=( _t('components.pagination-search.filter.placeholder') ))==null?'':_.escape(__t))+
'" />\n        ';
 if (q !== '') { 
__p+='\n        <button type="button" class="CDB-Shape Filters-cleanSearch js-clean-search u-actionTextColor">\n          <div class="CDB-Shape-close is-blue is-large"></div>\n        </button>\n        ';
 } 
__p+='\n      </div>\n    </div>\n  </div>\n</div>\n<div class="js-content"></div>';
}
return __p;
};

},{"underscore":"underscore"}],259:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<span class="CDB-Text CDB-Size-medium u-altTextColor Pagination-label">\n  Page '+
((__t=( currentPage ))==null?'':_.escape(__t))+
' of '+
((__t=( pagesCount ))==null?'':_.escape(__t))+
'\n</span>\n<ul class="Pagination-list CDB-Text CDB-Size-medium">\n  ';
 m.pagesToDisplay().forEach(function(page) { 
__p+='\n    ';
 if (page > 0) { 
__p+='\n      <li class="Pagination-listItem '+
((__t=( m.isCurrentPage(page) ? 'is-current' : '' ))==null?'':_.escape(__t))+
'">\n        <button class="Pagination-listItemInner Pagination-listItemInner--link u-actionTextColor js-listItem" data-page="'+
((__t=( page ))==null?'':_.escape(__t))+
'">'+
((__t=( page ))==null?'':_.escape(__t))+
'</button>\n      </li>\n    ';
 } else { 
__p+='\n      <li class="Pagination-listItem Pagination-listItem">\n        <span class="Pagination-listItemInner Pagination-listItemInner--more">&hellip;</span>\n      </li>\n    ';
 } 
__p+='\n  ';
 }) 
__p+='\n</ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],260:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

/**
 * View model intended to be responsible for pagination logic, and to be used in conjunction with a Pagination view.
 */
module.exports = Backbone.Model.extend({
  defaults: {
    total_count: 0,
    per_page: 10,
    current_page: 1,
    display_count: 5,
    extras_display_count: 1,
    url_to: undefined
  },

  pagesCount: function () {
    return Math.max(
      Math.ceil(
        this.get('total_count') / this.get('per_page')
      ), 1);
  },

  isCurrentPage: function (page) {
    return this.get('current_page') === page;
  },

  shouldBeVisible: function () {
    var pagesCount = this.pagesCount();
    return this.get('total_count') > 0 && pagesCount > 1 && this.get('current_page') <= pagesCount;
  },

  urlTo: function (page) {
    if (this.hasUrl()) {
      return this.get('url_to')(page);
    }
  },

  hasUrl: function () {
    return typeof this.get('url_to') === 'function';
  },

  /**
   * Get the pages that are expected to be displayed.
   * The current page will be in the middle of the returned sequence.
   *
   * @returns {number[]} a sequence of Numbers
   */
  pagesToDisplay: function () {
    var rangeStart;

    if (this._inLowRange()) {
      rangeStart = 1;
    } else if (this._inHighRange()) {
      rangeStart = this.get('current_page') - this._startOffset();
    } else {
      // Somewhere between the low and high boundary
      rangeStart = this.pagesCount() - this.get('display_count') + 1;
    }
    rangeStart = Math.max(rangeStart, 1);

    return this._withExtraPages(
      _.range(rangeStart, this._rangeEnd(rangeStart))
    );
  },

  _withExtraPages: function (pagesRelativeToCurrentPage) {
    var lastPage = this.pagesCount();
    var extraCount = this.get('extras_display_count');
    var extraStartPages = _.range(1, extraCount + 1);
    var extraEndPages = _.range(lastPage - extraCount + 1, lastPage + 1);

    var startPagesDiff = pagesRelativeToCurrentPage[0] - extraStartPages.slice(-1)[0];
    if (startPagesDiff === 2) {
      // There is only one missing page in the gap, so add it
      extraStartPages.push(pagesRelativeToCurrentPage[0] - 1);
    } else if (startPagesDiff > 2) {
      // There are more hidden pages at low range, add padding at end
      extraStartPages.push(-1);
    }

    var endPagesDiff = extraEndPages[0] - pagesRelativeToCurrentPage.slice(-1);
    if (endPagesDiff === 2) {
      // There is only one missing page in the gap, so add it
      extraEndPages.unshift(extraEndPages[0] - 1);
    } if (endPagesDiff > 2) {
      // There are more hidden pages at high range, add padding at beginning
      extraEndPages.unshift(-2);
    }

    return _.union(extraStartPages, pagesRelativeToCurrentPage, extraEndPages);
  },

  _inLowRange: function () {
    return this.get('current_page') < this._startOffset();
  },

  _inHighRange: function () {
    return this.get('current_page') < this._highBoundary();
  },

  _highBoundary: function () {
    return this.pagesCount() - this._startOffset();
  },

  _startOffset: function () {
    return Math.floor(this.get('display_count') / 2);
  },

  _rangeEnd: function (rangeStart) {
    // If we are too close to the range end then cap to the pages count.
    return Math.min(rangeStart + this.get('display_count'), this.pagesCount() + 1);
  }
});

},{"backbone":"backbone","underscore":"underscore"}],261:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var $ = require('jquery');
var navigateThroughRouter = require('../../helpers/navigate-through-router');
var template = require('./pagination.tpl');

/**
 * Responsible for pagination.
 *
 * Expected to be created with a pagination model, see the model for available params, here we create w/ the minimum:
 *   new PaginationView({
 *     model: new PaginationModel({
 *       // Compulsory:
 *       urlTo:  function(page) { return '/?page='+ page },

         // Optional, to router clicks on <a> tags through router.navigate by default
 *       routerModel: new Router(...)
 *     })
 *   });
 */
module.exports = CoreView.extend({
  className: 'Pagination',

  events: {
    'click .js-listItem': '_paginate'
  },

  initialize: function (opts) {
    this._routerModel = opts.routerModel; // Optional

    if (this.router && !this.model.hasUrl()) {
      throw new Error('since router is set the model must have a url method set too');
    }

    this.template = opts.template || template;
    this.model.bind('change', this.render, this);
  },

  render: function () {
    if (this.model.shouldBeVisible()) {
      this.$el.html(
        this.template({
          m: this.model,
          pagesCount: this.model.pagesCount(),
          currentPage: this.model.get('current_page')
        })
      );
      this.$el.addClass(this.className);
      this.delegateEvents();
    } else {
      this.$el.html('');
    }

    return this;
  },

  _paginate: function (ev) {
    if (this._routerModel) {
      navigateThroughRouter.apply(this, arguments);
    } else if (!this.model.hasUrl()) {
      this.killEvent(ev);
    }

    var page = $(ev.target).data('page');
    this.model.set('current_page', page);
  }
});

},{"../../helpers/navigate-through-router":430,"./pagination.tpl":262,"backbone/core-view":454,"jquery":"jquery"}],262:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<span class="CDB-Text CDB-Size-medium u-altTextColor Pagination-label">\n  Page '+
((__t=( currentPage ))==null?'':_.escape(__t))+
' of '+
((__t=( pagesCount ))==null?'':_.escape(__t))+
'\n</span>\n<ul class="Pagination-list CDB-Text CDB-Size-medium">\n  ';
 m.pagesToDisplay().forEach(function(page) { 
__p+='\n    ';
 if (page > 0) { 
__p+='\n      <li class="Pagination-listItem '+
((__t=( m.isCurrentPage(page) ? 'is-current' : '' ))==null?'':_.escape(__t))+
'">\n        <a class="Pagination-listItemInner Pagination-listItemInner--link js-listItem" href="'+
((__t=( m.urlTo(page) ))==null?'':_.escape(__t))+
'" data-page="'+
((__t=( page ))==null?'':_.escape(__t))+
'">'+
((__t=( page ))==null?'':_.escape(__t))+
'</a>\n      </li>\n    ';
 } else { 
__p+='\n      <li class="Pagination-listItem Pagination-listItem">\n        <span class="Pagination-listItemInner Pagination-listItemInner--more">&hellip;</span>\n      </li>\n    ';
 } 
__p+='\n  ';
 }) 
__p+='\n</ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],263:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');

var MutationObserver = window.MutationObserver;

var MARGINS = {
  top: 8,
  bottom: 8
};

var initObserver = function (popup, onChangeMutation) {
  var config = {
    childList: true,
    subtree: true
  };

  if (!MutationObserver) {
    return;
  }

  var observer = new MutationObserver(onChangeMutation);
  observer.observe(popup.get ? popup.get(0) : popup, config);
  return observer;
};

var initScroll = function (reference) {
  return reference.closest('.js-perfect-scroll');
};

var Manager = function (id, reference, popup) {
  this.id = id;
  this.reference = reference;
  this.popup = popup;
  this.state = {
    position: 'bottom',
    scroll: 0
  };

  // to capture click events and avoid close the dialog
  popup.attr('data-cid', id);
  popup.attr('data-dialog', id);
};

Manager.prototype = {
  append: function (mode) {
    this.mode = mode;
    var popup = this.popup.get(0);
    var ref = this.reference.get(0);
    if (mode === 'float') {
      document.body.appendChild(popup);
    } else {
      ref.appendChild(popup);
    }
  },

  track: function () {
    if (this.mode !== 'float') {
      return;
    }

    // we need to watch when the dialog's height changes in order to reposition it again
    this.observer = initObserver(this.popup, this.onChangeMutation.bind(this));
    this.emitter = initScroll(this.reference);
    this.repositionBinded = _.throttle(this.reposition.bind(this), 15);

    if (this.emitter) {
      this.emitter
        .on('ps-scroll-x', this.repositionBinded)
        .on('ps-scroll-y', this.repositionBinded);
    }

    this.reposition();
  },

  onChangeMutation: function (mutations) {
    _.each(mutations, function (mutation) {
      var target = $(mutation.target);
      var id = target.attr('data-cid');

      if (!id) {
        id = target.closest('[data-cid]').attr('data-cid');
      }

      if (id === this.id) {
        this.repositionBinded();
      }
    }, this);
  },

  reposition: function () {
    if (this.mode !== 'float' || !this.emitter) {
      return;
    }

    var scroll = this.emitter.get(0).scrollTop;

    var dh = $(window).height();
    var ref = this.reference;
    var popup = this.popup;
    var state = this.state;

    var refPosition = ref.offset();
    var ph = popup.outerHeight();

    var onBottom = refPosition.top + ref.outerHeight() + MARGINS.top;
    var onTop = refPosition.top - ph - MARGINS.bottom;
    var top;

    // If this condition matches, the dialog has changed its size
    if (state.scroll === scroll) {
      // We maintain position unless there is no space
      if (state.position === 'top') {
        if (onTop <= 0) {
          top = onBottom;
          state.position = 'bottom';
        } else {
          top = onTop;
        }
      } else {
        if (onBottom + ph + MARGINS.bottom >= dh) {
          top = onTop;
          state.position = 'top';
        } else {
          top = onBottom;
        }
      }
    } else {
      if (onBottom + ph + MARGINS.bottom >= dh) {
        top = onTop;
        state.position = 'top';
      } else {
        top = onBottom;
        state.position = 'bottom';
      }
    }

    // Boundries come from document height to avoid scroll
    if (top < 0) {
      top = MARGINS.top;
    } else {
      top = Math.min(top, dh - ph - MARGINS.bottom);
    }

    popup.css({
      top: top,
      left: refPosition.left
    });

    state.scroll = scroll;
  },

  untrack: function () {
    this.observer && this.observer.disconnect();
    if (this.emitter) {
      this.emitter
        .off('ps-scroll-x', this.repositionBinded)
        .off('ps-scroll-y', this.repositionBinded);
    }
  },

  destroy: function () {
    this.untrack();

    var el = document.querySelector('[data-dialog=' + this.id + ']');
    if (el) {
      el.parentNode.removeChild(el);
    }

    this.emitter = null;
    this.reference = null;
    this.popup = null;
  }
};

module.exports = Manager;

},{"jquery":"jquery","underscore":"underscore"}],264:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./password-dialog.tpl');
var _ = require('underscore');

var REQUIRED_OPTS = [
  'onBack',
  'onEdit'
];

var ESCAPE_KEY_CODE = 27;
var ENTER_KEY_CODE = 13;

module.exports = CoreView.extend({
  className: 'Editor-boxModal Editor-PrivacyDialog',

  events: {
    'click .js-back': '_onClickBack',
    'keyup .js-input': '_onKeyUpInput'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);
  },

  render: function () {
    this.$el.empty();
    this.$el.html(template());
    return this;
  },

  _onKeyUpInput: function (e) {
    if (e.which === ESCAPE_KEY_CODE) {
      this._onBack();
    }

    if (e.which === ENTER_KEY_CODE) {
      this._onEdit && this._onEdit(this.getValue());
    }
  },

  _onClickBack: function () {
    this._onBack();
  },

  getValue: function () {
    return this.$('.js-input').val();
  }
});

},{"./password-dialog.tpl":265,"backbone/core-view":454,"underscore":"underscore"}],265:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Box-modalHeader">\n  <ul class="CDB-Box-modalHeaderItem CDB-Box-modalHeaderItem--block CDB-Box-modalHeaderItem--paddingHorizontal">\n    <li class="CDB-ListDecoration-item CDB-ListDecoration-itemPadding--vertical">\n      <button class="u-actionTextColor js-back CDB-Size-medium u-rSpace">\n        <i class="CDB-IconFont CDB-IconFont-arrowPrev"></i>\n      </button>\n      <span class="CDB-Text CDB-Size-medium">\n        '+
((__t=( _t('components.modals.publish.privacy.password.title') ))==null?'':_.escape(__t))+
'\n      </span>\n    </li>\n  </ul>\n</div>\n<ul class="CustomList-list js-customList">\n  <li class="Privacy-passwordField CustomList-item">\n    <input type="password" class="CDB-Text CDB-InputText js-input" placeholder="'+
((__t=( _t('components.modals.publish.privacy.password.placeholder') ))==null?'':_.escape(__t))+
'">\n  </li>\n</ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],266:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Privacy-cta u-flex">\n  <svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n      <path d="M10.0946667,4.4109223 C10.8886667,4.1368747 11.6846667,3.80147316 12.0073333,3.4715253 C12.7866667,2.67392407 12.7866667,1.37662907 12.0073333,0.579027844 C11.2513333,-0.193350099 9.934,-0.192668389 9.17866667,0.579027844 C8.74133333,1.0262299 8.29266667,2.36033726 8,3.37608583 C7.70666667,2.36033726 7.25866667,1.0262299 6.82133333,0.579027844 C6.066,-0.193350099 4.748,-0.192668389 3.99266667,0.579027844 C3.21266667,1.37662907 3.21266667,2.67392407 3.99266667,3.4715253 C4.316,3.80147316 5.11133333,4.1368747 5.90533333,4.4109223 L0.333333333,4.4109223 C0.149333333,4.4109223 0,4.56362544 0,4.75177753 L0,7.47861934 C0,7.66677142 0.149333333,7.81947456 0.333333333,7.81947456 L0.666666667,7.81947456 L0.666666667,15.6591448 C0.666666667,15.8472969 0.816,16 1,16 L15,16 C15.184,16 15.3333333,15.8472969 15.3333333,15.6591448 L15.3333333,7.81947456 L15.6666667,7.81947456 C15.8506667,7.81947456 16,7.66677142 16,7.47861934 L16,4.75177753 C16,4.56362544 15.8506667,4.4109223 15.6666667,4.4109223 L10.0946667,4.4109223 Z M6,6.95652174 L6,4.86956522 L10,4.86956522 L10,6.95652174 L6,6.95652174 L6,6.95652174 Z M10,7.65217391 L10,15.3043478 L6,15.3043478 L6,7.65217391 L10,7.65217391 L10,7.65217391 Z M9.80833133,1.08822938 C10.0510474,0.834996985 10.3727426,0.695652174 10.7169115,0.695652174 C11.0597961,0.695652174 11.3821334,0.834996985 11.6248495,1.08755946 C12.1250502,1.6101025 12.1250502,2.46023983 11.6248495,2.98278288 C11.2729754,3.34990286 9.79227867,3.85636766 8.66666667,4.17391304 C8.97102496,2.99953105 9.45581507,1.45534937 9.80833133,1.08822938 L9.80833133,1.08822938 Z M4.37515049,1.08822938 C4.6178666,0.834996985 4.94020387,0.695652174 5.28373064,0.695652174 C5.6266153,0.695652174 5.94895256,0.834996985 6.19166867,1.08755946 C6.54354282,1.45467944 7.02833293,2.99886112 7.33333333,4.17391304 C6.20707922,3.85569773 4.72638253,3.34990286 4.37515049,2.98278288 C3.87494984,2.46090976 3.87494984,1.61077243 4.37515049,1.08822938 L4.37515049,1.08822938 Z M0.666666667,4.86956522 L5.33333333,4.86956522 L5.33333333,6.95652174 L1,6.95652174 L0.666666667,6.95652174 L0.666666667,4.86956522 L0.666666667,4.86956522 Z M1.33333333,7.65217391 L5.33333333,7.65217391 L5.33333333,15.3043478 L1.33333333,15.3043478 L1.33333333,7.65217391 L1.33333333,7.65217391 Z M14.6666667,15.3043478 L10.6666667,15.3043478 L10.6666667,7.65217391 L14.6666667,7.65217391 L14.6666667,15.3043478 L14.6666667,15.3043478 Z M15.3333333,6.95652174 L15,6.95652174 L10.6666667,6.95652174 L10.6666667,4.86956522 L15.3333333,4.86956522 L15.3333333,6.95652174 L15.3333333,6.95652174 Z" id="Shape" fill="#9BC63B"></path>\n    </g>\n  </svg>\n  <div class="CDB-Text CDB-Size CDB-Size-small u-lSpace--xl">\n    <h3 class="u-secondaryTextColor">'+
((__t=( _t('components.modals.publish.privacy.cta.title') ))==null?'':_.escape(__t))+
'</h3>\n    <a href="'+
((__t=( upgradeURL ))==null?'':_.escape(__t))+
'">\n      '+
((__t=( _t( 'components.modals.publish.privacy.cta.desc-' + (showTrial ? 'trial' : 'notrial') ) ))==null?'':_.escape(__t))+
'\n    </a>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],267:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var CustomListView = require('../custom-list/custom-list-view');
var CustomListItemView = require('../custom-list/custom-list-item-view');
var privacyCTATemplate = require('./privacy-cta.tpl');
var _ = require('underscore');

var REQUIRED_OPTS = [
  'model',
  'collection',
  'userModel',
  'configModel'
];

module.exports = CoreView.extend({
  className: 'Editor-boxModal Privacy-dialog',

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (opts[item] === undefined) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);
  },

  render: function () {
    this.$el.empty();
    this.clearSubViews();
    this._renderList();
    return this;
  },

  _renderList: function () {
    var disabledOptions = this._collection.where({ disabled: true });
    var customInstall = this._configModel.get('cartodb_com_hosted');
    var upgradeURL = this._configModel.get('upgrade_url');

    var listView = new CustomListView({
      model: this._model,
      collection: this._collection,
      ItemView: CustomListItemView
    });
    this.$el.append(listView.render().el);
    this.addView(listView);

    if (disabledOptions.length > 0 && !customInstall && upgradeURL) {
      this.$el.append(
        privacyCTATemplate({
          upgradeURL: upgradeURL,
          showTrial: this._userModel.canStartTrial()
        })
      );
    }
  }
});

},{"../custom-list/custom-list-item-view":26,"../custom-list/custom-list-view":33,"./privacy-cta.tpl":266,"backbone/core-view":454,"underscore":"underscore"}],268:[function(require,module,exports){
var $ = require('jquery');
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');
var PrivacyDialogView = require('./privacy-dialog-view');
var PasswordDialogView = require('./password-dialog-view');
var TabPaneView = require('../tab-pane/tab-pane-view');
var TabPaneCollection = require('../tab-pane/tab-pane-collection');
var CustomListCollection = require('../custom-list/custom-list-collection');
var template = require('./privacy-dropdown.tpl');
var templateTabPane = require('./tab-pane.tpl');

var _ = require('underscore');

var ESCAPE_KEY_CODE = 27;

var REQUIRED_OPTS = [
  'visDefinitionModel',
  'userModel',
  'privacyCollection',
  'configModel'
];

var PRIVACY_MAP = {
  public: 'green',
  link: 'orange',
  password: 'orange-dark',
  private: 'red'
};

module.exports = CoreView.extend({

  events: {
    'click .js-toggle': '_onToggleDialogClicked'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this._triggerElementID = 'toggle' + this.cid;

    this.model = new Backbone.Model({
      privacy: opts.visDefinitionModel.get('privacy'),
      state: 'show'
    });

    this._onEscapePressed = this._onEscapePressed.bind(this);
    this._onDocumentElementClicked = this._onDocumentElementClicked.bind(this);

    this._configPrivacyCollection();
    this._configPanes();
    this._initBinds();
  },

  render: function () {
    var privacy = this.model.get('privacy');
    var cssClass = PRIVACY_MAP[privacy.toLowerCase()];

    this.clearSubViews();
    this._hideDialog();
    this.$el.html(template({
      privacy: privacy,
      cssClass: cssClass,
      isLoading: this.model.get('state') === 'loading'
    }));
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this._customCollection.on('change:selected', function (menuItem) {
      if (menuItem.get('disabled')) {
        return;
      }

      if (menuItem.get('val') === 'password') {
        this._showPasswordDialog();
      } else {
        this._onToggleDialogClicked();
        this._setPrivacy(menuItem.get('val'));
      }
    }, this);

    this.add_related_model(this._customCollection);

    this.model.on('change:privacy', this._savePrivacy, this);
    this.model.on('change:state', this.render, this);
    this.add_related_model(this.model); // explicit
  },

  _makePrivacyDialog: function () {
    return new PrivacyDialogView({
      model: this.model,
      collection: this._customCollection,
      userModel: this._userModel,
      configModel: this._configModel
    });
  },

  _makePasswordDialog: function () {
    return new PasswordDialogView({
      onBack: this._showPrivacyDialog.bind(this),
      onEdit: this._setPassword.bind(this)
    });
  },

  _setPrivacy: function (privacy) {
    this.model.set({privacy: privacy});
  },

  _setPassword: function (password) {
    if (password !== '') {
      this._privacyCollection.passwordOption().set({
        password: password
      });

      this.model.set({
        privacy: 'password',
        password: password
      });
    }
  },

  _savePrivacy: function () {
    var self = this;
    var privacy = this.model.get('privacy').toUpperCase();
    var vis = this._visDefinitionModel;
    this.model.set({state: 'loading'});
    this._privacyCollection.searchByPrivacy(privacy).saveToVis(vis, {
      success: function () {
        self.model.set({state: 'show'});
      },
      error: function () {
        self.model.set({state: 'error'});
      }
    });
  },

  _transformPrivacyOptions: function () {
    return this._privacyCollection.map(function (item) {
      return {
        label: item.get('title'),
        val: item.get('privacy').toLowerCase(),
        disabled: item.get('disabled'),
        selected: item.get('selected'),
        renderOptions: {
          cssClass: item.get('cssClass')
        }
      };
    }).filter(Boolean);
  },

  _configPrivacyCollection: function () {
    var models = this._transformPrivacyOptions();
    this._customCollection = new CustomListCollection(models);
  },

  _configPanes: function () {
    var self = this;
    var tabPaneTabs = [{
      createContentView: self._showNoneDialog
    }, {
      createContentView: self._makePrivacyDialog.bind(self)
    }, {
      createContentView: self._makePasswordDialog.bind(self)
    }];

    this._collectionPane = new TabPaneCollection(tabPaneTabs);
  },

  _showNoneDialog: function () {
    return false;
  },

  _showPasswordDialog: function () {
    this._collectionPane.at(2).set({selected: true});
  },

  _showPrivacyDialog: function () {
    this._customCollection.each(function (m) {
      m.set({selected: false}, {silent: true});
    });

    this._collectionPane.at(1).set({selected: true});
  },

  _onToggleDialogClicked: function () {
    if (this._isDialogVisible()) {
      this._hideDialog();
    } else {
      this._initDocumentBinds();
      this._showPrivacyDialog();
    }
  },

  _isDialogVisible: function () {
    return this._collectionPane.at(0).get('selected') === false;
  },

  _hideDialog: function () {
    this._destroyDocumentBinds();
    this._collectionPane.at(0).set({selected: true});
  },

  _showDialog: function () {
    this._showPrivacyDialog();
  },

  _initViews: function () {
    var view = new TabPaneView({
      collection: this._collectionPane,
      template: templateTabPane
    });
    this.$('.js-dialog').append(view.render().$el);
    this.addView(view);
  },

  _initDocumentBinds: function () {
    $(document).on('keydown', this._onEscapePressed);
    $(document).on('mousedown', this._onDocumentElementClicked);
  },

  _destroyDocumentBinds: function () {
    $(document).off('keydown', this._onEscapePressed);
    $(document).off('mousedown', this._onDocumentElementClicked);
  },

  _onEscapePressed: function (ev) {
    if (ev.which === ESCAPE_KEY_CODE) {
      this._hideDialog();
    }
  },

  _onDocumentElementClicked: function (ev) {
    var $el = $(ev.target);
    if ($el.closest(this.$el).length === 0 && $el.closest($('#' + this._triggerElementID)).length === 0) {
      this._hideDialog();
    }
  },

  clean: function () {
    this._destroyDocumentBinds();
    CoreView.prototype.clean.apply(this);
  }
});

},{"../custom-list/custom-list-collection":23,"../tab-pane/tab-pane-collection":277,"../tab-pane/tab-pane-view":285,"./password-dialog-view":264,"./privacy-dialog-view":267,"./privacy-dropdown.tpl":269,"./tab-pane.tpl":270,"backbone":"backbone","backbone/core-view":454,"jquery":"jquery","underscore":"underscore"}],269:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Privacy-dropdown">\n  <button class="Privacy-dropdownTrigger Tag Tag-fill Tag-fill--'+
((__t=( cssClass ))==null?'':_.escape(__t))+
' CDB-Text CDB-Size-small u-upperCase js-toggle">\n    ';
 if (isLoading) { 
__p+='\n      <div class="CDB-LoaderIcon CDB-LoaderIcon--small u-flex">\n        <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">\n          <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>\n        </svg>\n      </div>\n    ';
 } else { 
__p+='\n      '+
((__t=( privacy ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  </button>\n\n  <div class="js-dialog"></div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],270:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Tab-paneContent js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],271:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var Ps = require('perfect-scrollbar');
var template = require('./scroll.tpl');
var MutationObserver = window.MutationObserver;

module.exports = CoreView.extend({
  tagName: 'div',
  className: 'ScrollView',

  initialize: function (opts) {
    if (!opts.createContentView) throw new Error('A factory createContentView function is required');
    this.options = opts || {};
    this._type = opts.type || 'vertical'; // vertical or horizontal
    this._maxScroll = 0;
    this._bindedCheckShadows = this._checkShadows.bind(this);
  },

  render: function () {
    this.clearSubViews();
    this._html();

    var view = this.options.createContentView.call(this);
    this._contentContainer().append(view.render().el);
    this.addView(view);
    this._applyScroll();
    this._updateScrollWhenExist();
    return this;
  },

  _html: function () {
    this.$el.html(template({
      type: this._type
    }));

    (this._type === 'horizontal') && this.$el.addClass('ScrollView--horizontal');
  },

  _contentContainer: function () {
    return this.$('.js-content');
  },

  _wrapperContainer: function () {
    return this.$('.js-wrapper');
  },

  _updateScrollWhenExist: function () {
    // Phantom doesn't provide this api for window.
    if (!MutationObserver) return;

    // even with the changes in PS, we need to check when this element is added to the dom
    // in order to trigger manually an update.
    var element = document.body;
    var self = this._wrapperContainer().get(0);
    var onMutationObserver = function () {
      if (element.contains(self)) {
        Ps.update(self);
        observer.disconnect();
      }
    };

    var observer = new MutationObserver(onMutationObserver);
    onMutationObserver();

    var config = { subtree: true, childList: true };
    observer.observe(element, config);
  },

  _applyScroll: function () {
    Ps.initialize(this._wrapperContainer().get(0), {
      wheelSpeed: 2,
      wheelPropagation: true,
      stopPropagationOnClick: false,
      minScrollbarLength: 20,
      suppressScrollX: this._type === 'vertical',
      suppressScrollY: this._type === 'horizontal'
    });

    this._bindScroll();
  },

  _bindScroll: function () {
    this._wrapperContainer()
      .on('ps-dom-change', this._bindedCheckShadows)
      .on('ps-x-reach-start', this._bindedCheckShadows)
      .on('ps-x-reach-end', this._bindedCheckShadows)
      .on('ps-y-reach-start', this._bindedCheckShadows)
      .on('ps-y-reach-end', this._bindedCheckShadows)
      .on('ps-scroll-x', this._bindedCheckShadows)
      .on('ps-scroll-y', this._bindedCheckShadows);
  },

  _unbindScroll: function () {
    this._wrapperContainer()
      .off('ps-dom-change', this._bindedCheckShadows)
      .off('ps-x-reach-start', this._bindedCheckShadows)
      .off('ps-x-reach-end', this._bindedCheckShadows)
      .off('ps-y-reach-start', this._bindedCheckShadows)
      .off('ps-y-reach-end', this._bindedCheckShadows)
      .off('ps-scroll-x', this._bindedCheckShadows)
      .off('ps-scroll-y', this._bindedCheckShadows);
  },

  _checkShadows: function () {
    var currentPos;
    var max;
    var width;
    var height;
    var maxPos;

    if (this._type === 'horizontal') {
      currentPos = this._wrapperContainer().scrollLeft();
      max = this._wrapperContainer().get(0).scrollWidth;
      width = this._wrapperContainer().outerWidth();
      maxPos = max - width;

      this.$('> .js-leftShadow').toggleClass('is-visible', currentPos > 0);
      this.$('> .js-rightShadow').toggleClass('is-visible', currentPos < maxPos);
    } else {
      currentPos = this._wrapperContainer().scrollTop();
      max = this._wrapperContainer().get(0).scrollHeight;
      height = this._wrapperContainer().outerHeight();
      maxPos = max - height;

      // We use the direct descendant selector to avoid affect others nested view with scroll
      this.$('> .js-topShadow').toggleClass('is-visible', currentPos > 0);
      this.$('> .js-bottomShadow').toggleClass('is-visible', currentPos < maxPos);
    }
  },

  destroyScroll: function () {
    this._unbindScroll();
    Ps.destroy(this._wrapperContainer().get(0));
  },

  clean: function () {
    this.destroyScroll();
    CoreView.prototype.clean.apply(this, arguments);
  }
});

},{"./scroll.tpl":272,"backbone/core-view":454,"perfect-scrollbar":"perfect-scrollbar"}],272:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (type === 'vertical') { 
__p+='\n<div class="ScrollView-shadow ScrollView-shadow--top js-topShadow"></div>\n<div class="ScrollView-shadow ScrollView-shadow--bottom js-bottomShadow"></div>\n';
 } else { 
__p+='\n<div class="Carousel-shadow Carousel-shadow--left js-leftShadow"></div>\n<div class="Carousel-shadow Carousel-shadow--right js-rightShadow"></div>\n';
 } 
__p+='\n<div class="ScrollView-wrapper js-wrapper js-perfect-scroll">\n  <div class="ScrollView-content js-content"></div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],273:[function(require,module,exports){
var Backbone = require('backbone');

/**
 *  Stack layout model checks and decides if next or previous
 *  positions are possible.
 */

module.exports = Backbone.Model.extend({

  defaults: {
    position: 0
  },

  initialize: function (attrs, opts) {
    this.stackLayoutItems = opts.stackLayoutItems;
  },

  goToStep: function (position) {
    var stackLayoutItemsSize = this.stackLayoutItems.size();

    if (position >= stackLayoutItemsSize) {
      throw new Error('There is no ' + position + ' stack view in the collection');
    } else {
      this.set({
        position: position
      }, {
        silent: true
      });
      this._rememberStep.apply(this, arguments);
      this._triggerPositionChanged(position, Array.prototype.slice.call(arguments, 1));
    }
  },

  nextStep: function () {
    var currentPos = this.get('position');
    var nextPosition = ++currentPos;
    this.goToStep.apply(this, Array.prototype.concat.apply([nextPosition], arguments));
  },

  prevStep: function () {
    var currentPos = this.get('position');
    var prevPosition = --currentPos;
    this.goToStep.apply(this, Array.prototype.concat.apply([prevPosition], arguments));
  },

  goBack: function () {
    if (this._goBackToArguments) {
      this.goToStep.apply(this, this._goBackToArguments);
    }
  },

  _triggerPositionChanged: function (position, args) {
    this.trigger('positionChanged', position, Array.prototype.slice.call(args));
  },

  _rememberStep: function () {
    this._goBackToArguments = this._lastStepArguments || [ 0 ];
    this._lastStepArguments = arguments;
  }
});

},{"backbone":"backbone"}],274:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var StackLayoutModel = require('./stack-layout-model');
var _ = require('underscore');

/**
 *  Stack layout view manages a "carousel" of views.
 *  They can go forward or backward.
 */

module.exports = CoreView.extend({

  initialize: function (opts) {
    if (!this.collection || !this.collection.size()) {
      throw new Error('A collection of stack views should be provided');
    }
    this.model = new StackLayoutModel({}, {
      stackLayoutItems: this.collection
    });
    this.model.bind('positionChanged', this._onPositionChange, this);
  },

  render: function () {
    this.clearSubViews();
    this._genNewStackView();
    return this;
  },

  _onPositionChange: function (newPos, opts) {
    this._removeOldStackView();
    this._genNewStackView(_.flatten(opts));
    this.trigger('positionChanged', this);
  },

  getCurrentPosition: function () {
    return this.model.get('position');
  },

  _removeOldStackView: function () {
    var oldView = this._getCurrentView();
    if (oldView) {
      oldView.clean();
      this.removeView(oldView);
    }
  },

  _getCurrentView: function () {
    for (var key in this._subviews) break;
    return this._subviews[key];
  },

  _genNewStackView: function () {
    var args = [this.model].concat([_.flatten(arguments)]);
    var nextView = this.collection.at(this.model.get('position')).get('createStackView').apply(this, args);
    this.$el.html(nextView.render().el);

    this.addView(nextView);
  }
});

},{"./stack-layout-model":273,"backbone/core-view":454,"underscore":"underscore"}],275:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var TabPaneView = require('./tab-pane-view.js');
var TabPaneCollection = require('./tab-pane-collection');
var MixedLabelView = require('./tab-pane-mixed-view');
var ColorView = require('./tab-pane-color-view');

/**
 * Creates a tab pane, where the menu consists of text labels.
 *
 * Example usage:
 * {
 *   label: 'My label',
 *   createContentView: CoreView(),
 *   selected: false
 * }
 *
 * @param {Array} paneItems
 * @param {Object} options
 * @return {Object} instance of CoreView
 */
module.exports = function (paneItems, options) {
  options = options || {};
  var tabPaneItemLabelOptions = options.tabPaneItemLabelOptions;

  var items = paneItems.map(function (paneItem) {
    ['label', 'createContentView'].forEach(function (check) {
      if (!paneItem[check]) {
        throw new Error(check + ' should be provided');
      }
    });

    return {
      name: paneItem.name,
      selected: paneItem.selected,
      label: paneItem.label,
      color: paneItem.color,
      kind: paneItem.kind,
      selectedChild: paneItem.selectedChild,
      createButtonView: function () {
        if (paneItem.type === 'color') {
          return new ColorView(_.extend({ model: this }, tabPaneItemLabelOptions));
        } else {
          return new MixedLabelView(_.extend({ model: this, type: paneItem.type }, tabPaneItemLabelOptions));
        }
      },
      createContentView: function () {
        return paneItem.createContentView && paneItem.createContentView() || new CoreView();
      }
    };
  });

  this.collection = new TabPaneCollection(items);

  var tabPaneOptions = options.tabPaneOptions;

  return new TabPaneView(
    _.extend(
      { collection: this.collection },
      tabPaneOptions
    )
  );
};

},{"./tab-pane-collection":277,"./tab-pane-color-view":278,"./tab-pane-mixed-view":284,"./tab-pane-view.js":285,"backbone/core-view":454,"underscore":"underscore"}],276:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var TabPaneView = require('./tab-pane-view.js');
var TabPaneCollection = require('./tab-pane-collection');
var LabelView = require('./tab-pane-label-view');

/**
 * Creates a tab pane, where the menu consists of text labels.
 *
 * Example usage:
 * {
 *   label: 'My label',
 *   createContentView: CoreView(),
 *   selected: false
 * }
 *
 * @param {Array} paneItems
 * @param {Object} options
 * @return {Object} instance of CoreView
 */
module.exports = function (paneItems, options) {
  options = options || {};
  var tabPaneItemLabelOptions = options.tabPaneItemLabelOptions;

  var items = paneItems.map(function (paneItem) {
    ['label', 'createContentView'].forEach(function (check) {
      if (!paneItem[check]) {
        throw new Error(check + ' should be provided');
      }
    });

    return {
      name: paneItem.name,
      selected: paneItem.selected,
      label: paneItem.label,
      selectedChild: paneItem.selectedChild,
      createButtonView: function () {
        return new LabelView(_.extend({ model: this }, tabPaneItemLabelOptions));
      },
      createContentView: function () {
        return paneItem.createContentView && paneItem.createContentView() || new CoreView();
      }
    };
  });

  this.collection = new TabPaneCollection(items);

  var tabPaneOptions = options.tabPaneOptions;

  return new TabPaneView(
    _.extend(
      { collection: this.collection },
      tabPaneOptions
    )
  );
};

},{"./tab-pane-collection":277,"./tab-pane-label-view":282,"./tab-pane-view.js":285,"backbone/core-view":454,"underscore":"underscore"}],277:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

module.exports = Backbone.Collection.extend({
  constructor: function (models, options) {
    options = _.extend(options || {}, { silent: false });
    Backbone.Collection.prototype.constructor.call(this, models, options);
  },

  initialize: function () {
    this.bind('reset', this._setSelected, this);
    this.bind('change:selected', this._onSelectedChange, this);
    this._setSelected();
  },

  getSelected: function () {
    return this.find(function (model) {
      return model.get('selected');
    });
  },

  _setSelected: function () {
    var isSelected = this.getSelected();

    if (!isSelected && this.size() > 0) {
      this.at(0).set('selected', true);
    }
  },

  _onSelectedChange: function (itemModel, isSelected) {
    if (!isSelected) {
      return;
    }

    this.each(function (model) {
      if (model !== itemModel) {
        model.set('selected', false);
      }
    }, this);
  },

  select: function (name, value) {
    var model = this.find(function (m) {
      return m.get(name) === value;
    }, this);

    if (model) {
      model.set('selected', true);
    }
  }
});

},{"backbone":"backbone","underscore":"underscore"}],278:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./tab-pane-color.tpl');

/**
 *  Label component
 */

module.exports = CoreView.extend({
  className: 'Label',

  initialize: function () {
    if (!this.model) {
      throw new Error('A model should be provided');
    }
    this.model.bind('change:label', this.render, this);
  },

  render: function () {
    this.clearSubViews();

    this.$el.html(template({
      color: this.model.get('label'),
      selectedChild: this.model.get('selectedChild') || ''
    }));
    return this;
  }
});

},{"./tab-pane-color.tpl":279,"backbone/core-view":454}],279:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="ColorBar ColorBar--inline" style="background-color: '+
((__t=( color ))==null?'':_.escape(__t))+
';"></div> ';
 if (selectedChild) { 
__p+=' <span class="CDB-NavSubmenu-status js-NavSubmenu-status u-hintTextColor">'+
((__t=( selectedChild ))==null?'':_.escape(__t))+
'</span>';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],280:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (type === 'text') { 
__p+='\n'+
((__t=( label ))==null?'':_.escape(__t))+
'';
 if (selectedChild) { 
__p+=' <span class="CDB-NavSubmenu-status js-NavSubmenu-status u-hintTextColor">'+
((__t=( selectedChild ))==null?'':_.escape(__t))+
'</span>';
 } 
__p+='\n';
 } else if (kind === 'custom-marker') { 
__p+='\n<div class=\'Editor-categoryImagesTag CDB-Text CDB-FontSize-small u-altTextColor is-semibold u-upperCase\'>'+
((__t=( _t('form-components.editors.fill.input-color.img') ))==null?'':_.escape(__t))+
'</div>\n';
 } else { 
__p+='\n<div class="Tab-paneLabelImageContainer js-image-container"></div>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],281:[function(require,module,exports){
var CoreView = require('backbone/core-view');

/**
 *  TabPaneItem component
 */

module.exports = CoreView.extend({
  tagName: 'button',

  events: {
    'click': '_onButtonClicked'
  },

  initialize: function () {
    if (!this.model) {
      throw new Error('A model should be provided');
    }

    this.model.bind('change:selected', this._onChangeSelected, this);
  },

  render: function () {
    var view = this.model.get('createButtonView').call(this.model);
    this.addView(view);
    this.$el.append(view.render().$el);
    this.$el.toggleClass('is-selected', !!this.model.get('selected'));

    return this;
  },

  _onChangeSelected: function () {
    this.$el.toggleClass('is-selected', !!this.model.get('selected'));
  },

  _onButtonClicked: function (e) {
    e.preventDefault();
    this.model.set('selected', true);
  }
});

},{"backbone/core-view":454}],282:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./tab-pane-label.tpl');

/**
 *  Label component
 */

module.exports = CoreView.extend({
  className: 'Label',

  initialize: function () {
    if (!this.model) {
      throw new Error('A model should be provided');
    }
  },

  render: function () {
    this.$el.html(template({
      label: this.model.get('label'),
      selectedChild: this.model.get('selectedChild') || ''
    }));
    return this;
  }
});

},{"./tab-pane-label.tpl":283,"backbone/core-view":454}],283:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+=''+
((__t=( label ))==null?'':_.escape(__t))+
'';
 if (selectedChild) { 
__p+=' <span class="CDB-NavSubmenu-status js-NavSubmenu-status u-hintTextColor">'+
((__t=( selectedChild ))==null?'':_.escape(__t))+
'</span>';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],284:[function(require,module,exports){
var template = require('./tab-pane-file.tpl');
var CoreView = require('backbone/core-view');
var ImageLoaderView = require('../img-loader-view');

/**
 *  File component
 */

module.exports = CoreView.extend({
  tagName: 'i',

  className: 'CDB-IconFont',

  initialize: function (options) {
    if (!this.model) throw new Error('A model should be provided');

    this.model.bind('change:label', this.render, this);
    this.model.bind('change:color', this._updateColor, this);
  },

  render: function () {
    this.clearSubViews();

    var labelType = this._getLabelType();

    this.$el.html(template({
      type: labelType,
      label: this.model.get('label'),
      kind: this.model.get('kind'),
      selectedChild: this.model.get('selectedChild') || ''
    }));

    if (labelType === 'file') {
      this._loadImages();
    }

    return this;
  },

  _loadImages: function () {
    this.iconView = new ImageLoaderView({
      imageClass: 'Tab-paneLabelImage',
      imageUrl: this._getImageURL(),
      color: this.model.get('color')
    });
    this.addView(this.iconView);
    this.$('.js-image-container').append(this.iconView.render().el);
  },

  _updateColor: function () {
    this.iconView && this.iconView.updateImageColor(this.model.get('color'));
  },

  _getLabelType: function () {
    var label = this.model.get('label');
    return label && label.match(/^http/) ? 'file' : 'text';
  },

  _getImageURL: function () {
    return this.model.get('label');
  }
});

},{"../img-loader-view":180,"./tab-pane-file.tpl":280,"backbone/core-view":454}],285:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var TabPaneItem = require('./tab-pane-item-view.js');
var Template = require('./tab-pane.tpl');

/**
 *  TabPane component
 */

module.exports = CoreView.extend({
  className: 'Tab-pane',

  initialize: function (options) {
    if (!this.collection) {
      throw new Error('A TabPaneCollection should be provided');
    }

    this._tabPaneItemOptions = this.options.tabPaneItemOptions;
    this._createContentKey = this.options.createContentKey || 'createContentView';
    this.template = this.options.template || Template;

    this.collection.bind('change:selected', this._renderSelected, this);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();

    this.$el.html(this.template(this.options));

    this._renderCollection();

    var model = this.getSelectedTabPane();

    if (model) {
      this._renderSelected(model, true);
    }

    return this;
  },

  getSelectedTabPane: function () {
    return this.collection.getSelected();
  },

  getTabPane: function (name) {
    return _.first(this.collection.where({ name: name }));
  },

  getSelectedTabPaneName: function () {
    var selectedTab = this.getSelectedTabPane();
    return selectedTab ? selectedTab.get('name') : null;
  },

  setSelectedTabPaneByName: function (name) {
    return this.collection.select('name', name);
  },

  _renderSelected: function (model, isSelected) {
    if (isSelected) {
      if (this._selectedView) {
        this._selectedView.clean();
        this.removeView(this._selectedView);
      }

      this._selectedView = this._renderTabPaneContentView(model);
    }
  },

  _renderCollection: function () {
    this.collection.each(function (paneModel) {
      if (paneModel.get('createButtonView')) {
        this._renderTabPaneItemView(paneModel);
      }
    }, this);
  },

  _renderTabPaneItemView: function (model) {
    var tabPaneItemView = new TabPaneItem(_.extend({ model: model }, this._tabPaneItemOptions));
    this.addView(tabPaneItemView);
    this.$('.js-menu').append(tabPaneItemView.render().el);
  },

  _renderTabPaneContentView: function (model) {
    var tabPaneContentView = model.get(this._createContentKey).call(model);
    if (tabPaneContentView) {
      this.addView(tabPaneContentView);
      this.$('.js-content').append(tabPaneContentView.render().el);
    }
    return tabPaneContentView;
  },

  changeStyleMenu: function (m) {
    this.$('.js-theme').toggleClass('is-dark', m.isEditing());
  }
});

},{"./tab-pane-item-view.js":281,"./tab-pane.tpl":286,"backbone/core-view":454,"underscore":"underscore"}],286:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-menu"></div>\n<div class="Tab-paneContent js-content"></div>\n';
}
return __p;
};

},{"underscore":"underscore"}],287:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--grid u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="24px" height="25px" viewbox="521 436 24 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <path d="M524.5,440 L540.5,440 L540.5,460 L524.5,460 L524.5,440 Z M528.5,437 L536.5,437 L536.5,440 L528.5,440 L528.5,437 Z M522,440 L544,440 L522,440 Z M528.5,443.5 L528.5,455.5 L528.5,443.5 Z M532.5,443.5 L532.5,455.5 L532.5,443.5 Z M536.5,443.5 L536.5,455.5 L536.5,443.5 Z" id="Shape" stroke="#F19243" stroke-width="1" fill="none"/>\n      </svg>\n    </div>\n    <div>\n      <h2 class=" CDB-Text CDB-Size-huge is-light u-bSpace--xl">\n        '+
((__t=( _t('components.table.rows.destroy.title', { cartodb_id: cartodb_id }) ))==null?'':_.escape(__t))+
'\n      </h2>\n      <p class="CDB-Text CDB-Size-large u-altTextColor">'+
((__t=( _t('components.table.rows.destroy.desc') ))==null?'':_.escape(__t))+
'</p>\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.table.rows.destroy.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.table.rows.destroy.confirm') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],288:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<td class="Table-cellItem" data-attribute="'+
((__t=( columnName ))==null?'':_.escape(__t))+
'" title="'+
((__t=( value ))==null?'':_.escape(__t))+
'" data-clipboard-text=\''+
((__t=( value ))==null?'':_.escape(__t))+
'\'>\n  <div class="\n      Table-cell u-flex u-justifySpace\n      '+
((__t=( columnName === 'cartodb_id' ||(type === 'geometry' && geometry !== 'point') ? 'Table-cell--short' : '' ))==null?'':_.escape(__t))+
'\n    ">\n    <p class="\n      CDB-Text CDB-Size-medium\n      u-ellipsis u-rSpace--xl\n      '+
((__t=( type === 'number' && columnName !== 'cartodb_id' ? 'is-number' : '' ))==null?'':_.escape(__t))+
'\n      '+
((__t=( value === null ? 'is-null' : '' ))==null?'':_.escape(__t))+
'\n      '+
((__t=( columnName === 'cartodb_id' ? 'is-cartodbId' : '' ))==null?'':_.escape(__t))+
'\n      js-value\n    ">\n      '+
((__t=( value === null ? 'null' : formattedValue ))==null?'':_.escape(__t))+
'\n    </p>\n\n    ';
 if (columnName !== 'cartodb_id') { 
__p+='\n      <button class="CDB-Shape-threePoints is-blue is-small Table-cellItemOptions js-cellOptions">\n        <div class="CDB-Shape-threePointsItem"></div>\n        <div class="CDB-Shape-threePointsItem"></div>\n        <div class="CDB-Shape-threePointsItem"></div>\n      </button>\n    ';
 } 
__p+='\n  </div>\n</td>\n';
}
return __p;
};

},{"underscore":"underscore"}],289:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var cellTemplate = require('./table-body-cell.tpl');
var pointGeojsonParser = require('../../../helpers/point-geojson-parser');

var FORMATTED_TYPE_VALUES = {
  'geometry': pointGeojsonParser
};

/*
 *  Table body row view
 */

module.exports = CoreView.extend({

  className: 'Table-row',
  tagName: 'tr',

  options: {
    simpleGeometry: ''
  },

  initialize: function (opts) {
    if (!opts.columnsCollection) throw new Error('columnsCollection is required');
    if (!opts.tableViewModel) throw new Error('tableViewModel is required');

    this._columnsCollection = opts.columnsCollection;
    this._tableViewModel = opts.tableViewModel;

    this.el.setAttribute('data-model', this.model.cid);

    this._initBinds();
  },

  render: function () {
    this.$el.empty();
    this._generateRowsHTML();
    return this;
  },

  _initBinds: function () {
    this.model.bind('change', this.render, this);
    this.model.bind('destroy', this.remove, this);
  },

  _generateRowsHTML: function () {
    var r = [];

    for (var i = 0, l = this._columnsCollection.size(); i < l; i++) {
      var mdl = this._columnsCollection.at(i);
      var columnName = mdl.get('name');

      if (columnName !== 'the_geom_webmercator' || (this._tableViewModel.isDisabled() && columnName === 'the_geom_webmercator')) {
        r[i] = this._generateCellHTML(columnName);
      }
    }

    this.el.innerHTML = r.join('');
  },

  _generateCellHTML: function (columnName) {
    var simpleGeometry = this.options.simpleGeometry;
    var columnModel = _.first(this._columnsCollection.where({ name: columnName }));
    var columnType = columnModel.get('type');
    var value = this.model.get(columnName);
    var formattedValue = value;

    if (columnType === 'geometry') {
      if (simpleGeometry === 'point') {
        formattedValue = FORMATTED_TYPE_VALUES[columnType](value);
      } else {
        formattedValue = simpleGeometry && (simpleGeometry.charAt(0).toUpperCase() + simpleGeometry.slice(1));
      }
    } else if (FORMATTED_TYPE_VALUES[columnType]) {
      formattedValue = FORMATTED_TYPE_VALUES[columnType](value);
    }

    return cellTemplate({
      value: value,
      formattedValue: formattedValue,
      type: columnType,
      columnName: columnName,
      geometry: simpleGeometry
    });
  }
});

},{"../../../helpers/point-geojson-parser":431,"./table-body-cell.tpl":288,"backbone/core-view":454,"underscore":"underscore"}],290:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var $ = require('jquery');
var _ = require('underscore');
var Clipboard = require('clipboard');
var TableBodyRowView = require('./table-body-row-view');
var ContextMenuView = require('../../context-menu/context-menu-view');
var CustomListCollection = require('../../custom-list/custom-list-collection');
var addTableRowOperation = require('../operations/table-add-row');
var removeTableRowOperation = require('../operations/table-remove-row');
var editCellOperation = require('../operations/table-edit-cell');
var ConfirmationModalView = require('../../modals/confirmation/modal-confirmation-view');
var TablePaginatorView = require('../paginator/table-paginator-view');
var tableBodyTemplate = require('./table-body.tpl');
var renderLoading = require('../../loading/render-loading');
var ErrorView = require('../../error/error-view');
var tableNoRowsTemplate = require('./table-no-rows.tpl');
var EditorsServiceModel = require('../editors/editors-service-model');
var EditorsModel = require('../editors/types/editor-model');
var errorParser = require('../../../helpers/error-parser');
var magicPositioner = require('../../../helpers/magic-positioner');
var checkAndBuildOpts = require('../../../helpers/required-opts');

var EDITORS_MAP = {
  'string': require('../editors/types/editor-string-view'),
  'number': require('../editors/types/editor-base-view'),
  'boolean': require('../editors/types/editor-boolean-view'),
  'date': require('../editors/types/editor-date-view'),
  'default': require('../editors/types/editor-string-view')
};

var REQUIRED_OPTS = [
  'columnsCollection',
  'modals',
  'queryGeometryModel',
  'querySchemaModel',
  'rowsCollection',
  'tableViewModel'
];

/*
 *  Table body view
 */

module.exports = CoreView.extend({

  className: 'Table-body',
  tagName: 'div',

  events: {
    'click': '_onClick',
    'dblclick': '_onDblClick'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._editors = new EditorsServiceModel();

    this._closeEditor = this._closeEditor.bind(this);
    this._hideContextMenu = this._hideContextMenu.bind(this);

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this._destroyScrollBinding();
    this.$el.empty();

    // Render results when we have the schema and goemetry is not being fetched
    if (this._querySchemaModel.isFetched() && !this._queryGeometryModel.isFetching() && !this._rowsCollection.isFetching()) {
      if (!this._rowsCollection.size()) {
        this._renderNoRows();
      } else {
        this.$el.html(tableBodyTemplate());
        this._rowsCollection.each(this._renderBodyRow, this);
        this._initPaginator();
      }
    } else {
      this._renderQueryState();
    }

    this.$el.toggleClass('Table-body--relative', !!this._tableViewModel.get('relativePositionated'));

    return this;
  },

  _initBinds: function () {
    this._queryGeometryModel.bind('change:status', this.render, this);
    this._querySchemaModel.bind('change:status', this.render, this);
    this._rowsCollection.bind('reset', _.debounce(this.render.bind(this), 20), this);
    this._rowsCollection.bind('add', function (model) {
      if (this._rowsCollection.size() === 1) {
        this.render();
      } else {
        this._renderBodyRow(model);
        this._scrollToBottom();
      }
    }, this);
    this._rowsCollection.bind('remove', this._onRemoveRow, this);
    this._rowsCollection.bind('fail', function (mdl, response) {
      if (!response || (response && response.statusText !== 'abort')) {
        this._renderError(errorParser(response));
      }
    }, this);
    this.add_related_model(this._queryGeometryModel);
    this.add_related_model(this._querySchemaModel);
    this.add_related_model(this._rowsCollection);
  },

  _renderQueryState: function () {
    var querySchemaStatus = this._querySchemaModel.get('status');
    var nodeReady = this._querySchemaModel.get('ready');
    var geometryStatus = this._queryGeometryModel.get('status');

    if (nodeReady) {
      if (querySchemaStatus === 'unavailable' && geometryStatus === 'unavailable') {
        this._renderError(this._querySchemaModel.get('query_errors'));
      } else {
        this._renderLoading();
      }
    } else {
      this._renderLoading();
    }
  },

  _renderLoading: function () {
    this.$el.html(
      renderLoading({
        title: _t('components.table.rows.loading.title')
      })
    );
  },

  _renderError: function (desc) {
    var view = new ErrorView({
      title: _t('components.table.rows.error.title'),
      desc: desc || _t('components.table.rows.error.desc')
    });
    this.addView(view);
    this.$el.html(view.render().el);
  },

  _renderNoRows: function () {
    this.$el.html(
      tableNoRowsTemplate({
        page: this._tableViewModel.get('page'),
        customQuery: this._tableViewModel.isCustomQueryApplied()
      })
    );
  },

  _initPaginator: function () {
    var paginatorView = new TablePaginatorView({
      rowsCollection: this._rowsCollection,
      tableViewModel: this._tableViewModel
    });

    // Bug in Chrome with position:fixed :(, so we have to choose body as
    // parent
    var $el = $('body');
    // But if we have chosen relativePositionated, we should add close
    // to the table view
    if (this._tableViewModel.get('relativePositionated')) {
      $el = this.$el.closest('.Table').parent();
    }

    $el.append(paginatorView.render().el);
    this.addView(paginatorView);
  },

  _initScrollBinding: function () {
    $('.Table').scroll(this._hideContextMenu);
    this.$('.js-tbody').scroll(this._hideContextMenu);
  },

  _destroyScrollBinding: function () {
    $('.Table').off('scroll', this._hideContextMenu);
    this.$('.js-tbody').off('scroll', this._hideContextMenu);
  },

  _renderBodyRow: function (mdl) {
    var view = new TableBodyRowView({
      model: mdl,
      columnsCollection: this._columnsCollection,
      simpleGeometry: this._queryGeometryModel.get('simple_geom'),
      tableViewModel: this._tableViewModel
    });
    this.addView(view);
    this.$('.js-tbody').append(view.render().el);
  },

  _onRemoveRow: function () {
    if (!this._rowsCollection.size()) {
      this._rowsCollection.resetFetch();

      var page = this._tableViewModel.get('page');
      if (page > 0) {
        this._tableViewModel.set('page', page - 1);
      } else {
        this.render();
      }
    }
  },

  _hasContextMenu: function () {
    return this._menuView;
  },

  _hideContextMenu: function () {
    this._unhighlightCell();
    this._destroyScrollBinding();
    this._menuView.collection.unbind(null, null, this);
    this.removeView(this._menuView);
    this._menuView.clean();
    delete this._menuView;
  },

  _highlightCell: function ($tableCellItem, $tableRow) {
    $tableCellItem.addClass('is-highlighted');
    $tableRow.addClass('is-highlighted');
  },

  _unhighlightCell: function () {
    this.$('.Table-cellItem.is-highlighted, .Table-row.is-highlighted').removeClass('is-highlighted');
  },

  _showContextMenu: function (ev) {
    var self = this;
    var position = { x: ev.clientX, y: ev.clientY };
    var $tableRow = $(ev.target).closest('.Table-row');
    var $tableCellItem = $(ev.target).closest('.Table-cellItem');
    var modelCID = $tableRow.data('model');
    var attribute = $tableCellItem.data('attribute');
    var rowModel = self._rowsCollection.get({ cid: modelCID });
    var menuItems = [];

    menuItems.push({
      label: _t('components.table.rows.options.copy'),
      val: 'copy',
      action: function () {
        self._copyValue($tableCellItem);
      }
    });

    if (!this._tableViewModel.isDisabled()) {
      menuItems = [
        {
          label: _t('components.table.rows.options.edit'),
          val: 'edit',
          action: function () {
            self._editCell(rowModel, attribute);
          }
        }, {
          label: _t('components.table.rows.options.create'),
          val: 'create',
          action: function () {
            self._addRow();
          }
        }
      ].concat(menuItems);

      menuItems.push({
        label: _t('components.table.rows.options.delete'),
        val: 'delete',
        destructive: true,
        action: function () {
          self._removeRow(rowModel);
        }
      });
    }

    // No options?, don't open anything
    if (!menuItems.length) {
      return false;
    }

    var collection = new CustomListCollection(menuItems);

    this._menuView = new ContextMenuView({
      className: 'Table-rowMenu ' + ContextMenuView.prototype.className,
      collection: collection,
      triggerElementID: modelCID,
      position: position
    });

    this._menuView.$el.css(
      magicPositioner({
        parentView: $('body'),
        posX: position.x,
        posY: position.y
      })
    );

    collection.bind('change:selected', function (menuItem) {
      var action = menuItem.get('action');
      action && action();
    }, this);

    this._menuView.model.bind('change:visible', function (model, isContextMenuVisible) {
      if (this._hasContextMenu() && !isContextMenuVisible) {
        this._hideContextMenu();
      }
    }, this);

    this._menuView.show();
    this.addView(this._menuView);

    this._highlightCell($tableCellItem, $tableRow);
    this._initScrollBinding();
  },

  _onClick: function (ev) {
    var isCellOptions = $(ev.target).hasClass('js-cellOptions');
    if (isCellOptions) {
      if (this._hasContextMenu()) {
        this._hideContextMenu();
      } else {
        this._showContextMenu(ev);
      }
    }
  },

  _onDblClick: function (ev) {
    var $tableCellItem = $(ev.target).closest('.Table-cellItem');
    var isCellOptions = $(ev.target).hasClass('js-cellOptions');

    if ($tableCellItem && !isCellOptions) {
      var $tableRow = $tableCellItem.closest('.Table-row');
      var modelCID = $tableRow.data('model');
      var attribute = $tableCellItem.data('attribute');
      var rowModel = this._rowsCollection.get({ cid: modelCID });

      if (!this._tableViewModel.isDisabled() && rowModel && attribute && attribute !== 'cartodb_id') {
        this._editCell(rowModel, attribute);
      }
    }
  },

  _copyValue: function ($el) {
    // Work-around for Clipboard \o/
    this._clipboard = new Clipboard($el.get(0));
    $el.click();
    this._clipboard.destroy();
  },

  _addRow: function () {
    addTableRowOperation({
      rowsCollection: this._rowsCollection
    });
  },

  _initEditorScrollBinding: function () {
    $('.Table').scroll(this._closeEditor);
    this.$('.js-tbody').scroll(this._closeEditor);
  },

  _destroyEditorScrollBinding: function () {
    $('.Table').unbind('scroll', this._closeEditor);
    this.$('.js-tbody').unbind('scroll', this._closeEditor);
  },

  _closeEditor: function () {
    this._unhighlightCell();
    this._destroyEditorScrollBinding();
    this._editors.unbind(null, null, this);
    this._editors.destroy();
  },

  _saveValue: function (rowModel, attribute, newValue) {
    if (rowModel.get(attribute) !== newValue) {
      editCellOperation({
        rowModel: rowModel,
        attribute: attribute,
        newValue: newValue
      });
    }
  },

  _doCellEdition: function (rowModel, attribute) {
    var $tableRow = this.$('[data-model="' + rowModel.cid + '"]');
    var $tableCell = $tableRow.find('[data-attribute="' + attribute + '"]');
    var $options = $tableCell.find('.js-cellOptions');
    var columnModel = _.first(this._columnsCollection.where({ name: attribute }));
    var type = columnModel.get('type');

    this._highlightCell($tableCell, $tableRow);
    this._initEditorScrollBinding();

    var model = new EditorsModel({
      type: type,
      value: rowModel.get(attribute)
    });

    this._editors.bind('destroyedEditor', this._closeEditor, this);
    this._editors.bind('confirmedEditor', function () {
      if (model.isValid()) {
        this._saveValue(
          rowModel,
          attribute,
          model.get('value')
        );
      }
    }, this);

    var position = $options.offset();

    if ($tableCell.index() > 1) {
      position.right = window.innerWidth - position.left;
      delete position.left;
    }

    if (this._rowsCollection.size() > 4 && ($tableRow.index() + 2) >= (this._rowsCollection.size() - 1)) {
      position.bottom = window.innerHeight - position.top;
      delete position.top;
    } else {
      position.top = position.top + 20;
    }

    var View = EDITORS_MAP[type];

    if (!View) {
      View = EDITORS_MAP['default'];
    }

    this._editors.create(
      function (editorModel) {
        return new View({
          editorModel: editorModel,
          model: model
        });
      },
      position
    );
  },

  _editCell: function (rowModel, attribute) {
    var callback = this._doCellEdition.bind(this, rowModel, attribute);
    rowModel.fetchRowIfGeomIsNotLoaded(callback);
  },

  _removeRow: function (rowModel) {
    var self = this;

    this._modals.create(
      function (modalModel) {
        return new ConfirmationModalView({
          modalModel: modalModel,
          template: require('./modals-templates/remove-table-row.tpl'),
          renderOpts: {
            cartodb_id: rowModel.get('cartodb_id')
          },
          loadingTitle: _t('components.table.rows.destroy.loading', {
            cartodb_id: rowModel.get('cartodb_id')
          }),
          runAction: function () {
            removeTableRowOperation({
              tableViewModel: self._tableViewModel,
              rowModel: rowModel,
              onSuccess: function () {
                modalModel.destroy();
              },
              onError: function (e) {
                modalModel.destroy();
              }
            });
          }
        });
      }
    );
  },

  _scrollToBottom: function () {
    var tbodyHeight = this.$('.js-tbody').get(0).scrollHeight;
    this.$('.js-tbody').animate({
      scrollTop: tbodyHeight
    }, 'slow');
  },

  clean: function () {
    this._destroyScrollBinding();
    CoreView.prototype.clean.apply(this);
  }

});

},{"../../../helpers/error-parser":426,"../../../helpers/magic-positioner":428,"../../../helpers/required-opts":432,"../../context-menu/context-menu-view":15,"../../custom-list/custom-list-collection":23,"../../error/error-view":37,"../../loading/render-loading":187,"../../modals/confirmation/modal-confirmation-view":190,"../editors/editors-service-model":295,"../editors/types/editor-base-view":296,"../editors/types/editor-boolean-view":297,"../editors/types/editor-date-view":300,"../editors/types/editor-model":301,"../editors/types/editor-string-view":302,"../operations/table-add-row":313,"../operations/table-edit-cell":315,"../operations/table-remove-row":317,"../paginator/table-paginator-view":320,"./modals-templates/remove-table-row.tpl":287,"./table-body-row-view":289,"./table-body.tpl":291,"./table-no-rows.tpl":292,"backbone/core-view":454,"clipboard":"clipboard","jquery":"jquery","underscore":"underscore"}],291:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<table>\n  <tbody class="js-tbody"></tbody>\n</table>\n';
}
return __p;
};

},{"underscore":"underscore"}],292:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="IntermediateInfo">\n  <div class="LayoutIcon">\n    <i class="CDB-IconFont CDB-IconFont-rows"></i>\n  </div>\n  <h3 class="CDB-Text CDB-Size-large u-mainTextColor u-secondaryTextColor u-bSpace--m u-tSpace-xl">\n    ';
 if (page !== 0) { 
__p+='\n      '+
((__t=( _t('components.table.rows.result.no-page-title', { page: page }) ))==null?'':_.escape(__t))+
'\n    ';
 } else { 
__p+='\n      '+
((__t=( _t('components.table.rows.result.no-results-title') ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  </h3>\n  <p class="CDB-Text CDB-Size-medium u-altTextColor">\n    ';
 if (page !== 0) { 
__p+='\n      '+
((__t=( _t('components.table.rows.result.no-page-desc', { page: page }) ))==null?'':_.escape(__t))+
'\n    ';
 } else { 
__p+='\n      '+
((__t=( _t('components.table.rows.result.no-results-desc', {
        addRow: _t('components.table.rows.result.no-results-button')
      }) ))==null?'':_.escape(__t))+
'\n    ';
 } 
__p+='\n  </p>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],293:[function(require,module,exports){
var Backbone = require('backbone');
var CoreView = require('backbone/core-view');

/**
 * View model of an editor
 */
module.exports = Backbone.Model.extend({

  defaults: {
    show: true,
    createContentView: function () {
      return new CoreView();
    }
  },

  createContentView: function () {
    return this.get('createContentView')(this);
  },

  show: function () {
    this.set('show', true);
  },

  hide: function () {
    this.set('show', false);
  },

  isHidden: function () {
    return !this.get('show');
  },

  confirm: function () {
    var args = Array.prototype.slice.call(arguments);
    this.trigger.apply(this, ['confirm'].concat(args));
  },

  /**
   * @override {Backbone.Model.prototype.destroy}
   */
  destroy: function () {
    var args = Array.prototype.slice.call(arguments);
    this.trigger.apply(this, ['destroy'].concat(args));
  }
});

},{"backbone":"backbone","backbone/core-view":454}],294:[function(require,module,exports){
var CoreView = require('backbone/core-view');

module.exports = CoreView.extend({
  className: 'CDB-Box-modal Table-editor',

  initialize: function () {
    this.listenTo(this.model, 'change:show', this._onShowChange);
    this.listenTo(this.model, 'destroy', this._onDestroy);
  },

  render: function () {
    this.clearSubViews();

    var view = this.model.createContentView();
    this.addView(view);
    view.render();
    this.$el.append(view.el);
    this.$el.css(this.options.position);

    return this;
  },

  show: function () {
    this.model.show();
  },

  hide: function () {
    this.model.hide();
  },

  destroy: function () {
    this.model.destroy();
  },

  _onShowChange: function (m, show) {
    this.$el[show ? 'show' : 'hide']();
  },

  _onClose: function () {
    this.destroy();
  },

  _onDestroy: function () {
    this.hide();
    this.clean();
  }

});

},{"backbone/core-view":454}],295:[function(require,module,exports){
var _ = require('underscore');
var $ = require('jquery');
var Backbone = require('backbone');
var EditorView = require('./editor-view');
var EditorViewModel = require('./editor-view-model');
var ESC_KEY_CODE = 27;
var DESTROYED_EDITOR_EVENT = 'destroyedEditor';
var CONFIRMED_EDITOR_EVENT = 'confirmedEditor';

/**
 * Top-level API to handle editor views.
 *
 * Example:
 * // In some entry-point:
 * table.editors = new EditorsServiceModel();
 *
 * // Later, in any view, calling create will create a new editor viewModel
 * var editorView = table.editors.create(fn);
 *
 * Same concept @viddo introduced with Modals.
 */
module.exports = Backbone.Model.extend({

  /**
   * Creates a new editor view
   *
   * @param {Function} createContentView
   * @return {View} the new editor view
   */
  create: function (createContentView, position) {
    if (!_.isFunction(createContentView)) throw new Error('createContentView is required');
    position = position || {
      left: '50%',
      top: '50%'
    };

    if (!this._editorView) {
      this._editorView = this._newEditorView(position);
      document.body.appendChild(this._editorView.el);
    }

    this._editorView.model.set('createContentView', createContentView);
    this._editorView.render();

    return this._editorView;
  },

  /**
   * Convenience method to add a listener when current editor is destroyed
   *
   * This is the same as doing
   * editors.create(function (model) {
   *   model.once('destroy', callback, context);
   *   return new MyView({  });
   * });
   *
   * @param {Function} callback
   * @param {Object} [context = undefined]
   */

  confirm: function () {
    if (this._editorView) {
      this._editorView.model.confirm();
    }
  },

  destroy: function () {
    if (this._editorView) {
      this._editorView.model.destroy();
    }
  },

  _newEditorView: function (position) {
    var viewModel = new EditorViewModel();
    this._destroyOnEsc(viewModel);
    this.listenToOnce(viewModel, 'destroy', function () {
      this._editorView = null;
      this.trigger.apply(this, [DESTROYED_EDITOR_EVENT].concat(Array.prototype.slice.call(arguments)));
      this.stopListening(viewModel);
    });
    this.listenToOnce(viewModel, 'confirm', function () {
      this.trigger.apply(this, [CONFIRMED_EDITOR_EVENT].concat(Array.prototype.slice.call(arguments)));
      this.destroy();
    });
    var view = new EditorView({
      model: viewModel,
      position: position
    });
    this._destroyOnClickOutside(view);
    return view;
  },

  _destroyOnClickOutside: function (view) {
    var destroyOnClickOutside = function (ev) {
      if ($(ev.target).closest(view.el).length === 0) {
        view.model.confirm();
      }
    };
    document.addEventListener('click', destroyOnClickOutside);
    this.listenToOnce(view.model, 'destroy', function () {
      document.removeEventListener('click', destroyOnClickOutside);
    });
  },

  _destroyOnEsc: function (viewModel) {
    var destroyOnEsc = function (ev) {
      if (ev.which === ESC_KEY_CODE) {
        viewModel.destroy();
      }
    };
    document.addEventListener('keydown', destroyOnEsc);
    this.listenToOnce(viewModel, 'destroy', function () {
      document.removeEventListener('keydown', destroyOnEsc);
    });
  }

});

},{"./editor-view":294,"./editor-view-model":293,"backbone":"backbone","jquery":"jquery","underscore":"underscore"}],296:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var $ = require('jquery');
var ENTER_KEY_CODE = 13;

module.exports = CoreView.extend({

  tagName: 'input',
  className: 'CDB-InputText CDB-Text',

  events: {
    'keyup': '_onValueChange',
    'change': '_onValueChange'
  },

  initialize: function (opts) {
    if (!opts.editorModel) throw new Error('editorModel is required');
    this._editorModel = opts.editorModel;
    this._onKeyPressed = this._onKeyPressed.bind(this);
    this._onValueChange = this._onValueChange.bind(this);
  },

  render: function () {
    this.$el.val(
      this.model.get('value')
    );
    this._setFocus();
    this._initDocumentBind();
    return this;
  },

  _setFocus: function () {
    setTimeout(function () {
      this.$el.focus();
    }.bind(this), 100);
  },

  _initDocumentBind: function () {
    $(document).bind('keydown', this._onKeyPressed);
  },

  _destroyDocumentBind: function () {
    $(document).unbind('keydown', this._onKeyPressed);
  },

  _onKeyPressed: function (ev) {
    if (ev.which === ENTER_KEY_CODE) {
      if (this.model.isValid()) {
        this._editorModel.confirm();
      } else {
        return false;
      }
    }
  },

  _onValueChange: function () {
    this._setValue();
    this._checkValidity();
  },

  _setValue: function () {
    this.model.set('value', this.$el.val());
  },

  _checkValidity: function () {
    this.$el.toggleClass('has-error', !this.model.isValid());
  },

  clean: function () {
    this._destroyDocumentBind();
    CoreView.prototype.clean.apply(this);
  }

});

},{"backbone/core-view":454,"jquery":"jquery"}],297:[function(require,module,exports){
var EditorBaseView = require('./editor-base-view');
var $ = require('jquery');
var template = require('./editor-boolean.tpl');

module.exports = EditorBaseView.extend({

  tagName: 'div',
  className: 'u-flex',

  events: {
    'change input:radio': '_onRadioChanged'
  },

  render: function () {
    var value = this.model.get('value');
    this.$el.html(
      template({
        value: value !== null ? value.toString() : 'null'
      })
    );
    return this;
  },

  _onRadioChanged: function (ev) {
    var value = $(ev.target).val();
    switch (value) {
      case 'true':
        value = true;
        break;
      case 'false':
        value = false;
        break;
      default:
        value = null;
    }
    this.model.set('value', value);
    this._editorModel.confirm();
  }

});

},{"./editor-base-view":296,"./editor-boolean.tpl":298,"jquery":"jquery"}],298:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-iBlock CDB-Text CDB-Size-medium u-rSpace--xl">\n  <input class="CDB-Radio" type="radio" name="value" value="true" ';
 if (value === 'true') { 
__p+='checked';
 } 
__p+='>\n  <span class="u-iBlock CDB-Radio-face"></span>\n  <label class="u-iBlock u-lSpace">True</label>\n</div>\n<div class="u-iBlock CDB-Text CDB-Size-medium u-rSpace--xl">\n  <input class="CDB-Radio" type="radio" name="value" value="false" ';
 if (value === 'false') { 
__p+='checked';
 } 
__p+='>\n  <span class="u-iBlock CDB-Radio-face"></span>\n  <label class="u-iBlock u-lSpace">False</label>\n</div>\n<div class="u-iBlock CDB-Text CDB-Size-medium u-rSpace--xl">\n  <input class="CDB-Radio" type="radio" name="value" value="null" ';
 if (value === 'null') { 
__p+='checked';
 } 
__p+='>\n  <span class="u-iBlock CDB-Radio-face"></span>\n  <label class="u-iBlock u-lSpace">Null</label>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],299:[function(require,module,exports){
var Backbone = require('backbone');
var moment = require('moment');
var Utils = require('../../../../helpers/utils');
var MONTHS = [
  {
    val: 0,
    label: _t('months.january')
  }, {
    val: 1,
    label: _t('months.february')
  }, {
    val: 2,
    label: _t('months.march')
  }, {
    val: 3,
    label: _t('months.april')
  }, {
    val: 4,
    label: _t('months.may')
  }, {
    val: 5,
    label: _t('months.june')
  }, {
    val: 6,
    label: _t('months.july')
  }, {
    val: 7,
    label: _t('months.august')
  }, {
    val: 8,
    label: _t('months.september')
  }, {
    val: 9,
    label: _t('months.october')
  }, {
    val: 10,
    label: _t('months.november')
  }, {
    val: 11,
    label: _t('months.december')
  }
];

module.exports = Backbone.Model.extend({

  parse: function (attrs) {
    var date;

    if (!attrs.date) {
      date = moment().utc();
    } else {
      date = moment(attrs.date).utc();
    }

    return {
      day: date.date(),
      month: date.month(),
      year: date.year(),
      time: date.format('HH:mm:ss'),
      utcOffset: date.utcOffset()
    };
  },

  initialize: function () {
    this.schema = {
      day: {
        title: '',
        type: 'Text',
        validators: [
          'required',
          /^([12]?\d{0,1}|3[01]{0,2})$/,
          function (value, formValues) {
            var date = moment(Utils.formatDate(formValues));
            if (!date.isValid()) {
              return {
                type: 'date',
                message: _t('components.datepicker.invalid-date')
              };
            }
          }
        ]
      },
      month: {
        type: 'Select',
        title: '',
        options: MONTHS
      },
      year: {
        title: '',
        type: 'Text',
        validators: ['required', /^([0-9]{0,4})$/]
      },
      time: {
        title: '',
        type: 'Text',
        validators: ['required', /^([01]{1}[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/]
      }
    };
  },

  getFormattedDate: function () {
    return Utils.formatDate(this.toJSON());
  }

});

},{"../../../../helpers/utils":435,"backbone":"backbone","moment":"moment"}],300:[function(require,module,exports){
var Backbone = require('backbone');
var EditorBaseView = require('./editor-base-view');
var EditorDateFormModel = require('./editor-date-form-model');
require('../../../form-components/index');

module.exports = EditorBaseView.extend({

  tagName: 'div',
  className: 'Table-editorDate',

  initialize: function (opts) {
    EditorBaseView.prototype.initialize.apply(this, arguments);

    this._formModel = new EditorDateFormModel({
      date: this.model.get('value')
    }, {
      parse: true
    });

    this._setValue();
    this._formModel.bind('change', this._setValue, this);
    this.add_related_model(this._formModel);
  },

  render: function () {
    this._formView = new Backbone.Form({
      model: this._formModel
    });

    this._formView.bind('change', function () {
      this.commit();
    });

    this.$el.html(this._formView.render().el);

    return this;
  },

  _setValue: function () {
    this.model.set('value', this._formModel.getFormattedDate());
  },

  clean: function () {
    this._formView.remove();
    EditorBaseView.prototype.clean.apply(this);
  }

});

},{"../../../form-components/index":178,"./editor-base-view":296,"./editor-date-form-model":299,"backbone":"backbone"}],301:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

module.exports = Backbone.Model.extend({

  // Error labels will not be showed, not needed to be translated
  validate: function (attrs, opts) {
    if (attrs.type === 'number' && isNaN(attrs.value)) {
      return 'Number not valid';
    }

    if (attrs.type === 'boolean' && (!_.isBoolean(attrs.value) && attrs.value !== null)) {
      return 'Boolean not valid';
    }
  }

});

},{"backbone":"backbone","underscore":"underscore"}],302:[function(require,module,exports){
var EditorBaseView = require('./editor-base-view');
var ENTER_KEY_CODE = 13;

module.exports = EditorBaseView.extend({

  tagName: 'textarea',
  className: 'Table-editorTextarea CDB-Textarea CDB-Text',

  _onKeyPressed: function (ev) {
    if (!ev.shiftKey && ev.which === ENTER_KEY_CODE) {
      this._onValueChange();
      this._editorModel.confirm();
    }
  }

});

},{"./editor-base-view":296}],303:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--grid u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="25px" height="25px" viewBox="-1 4 25 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <g id="Outline_Icons" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(-1.000000, 4.000000)">\n          <path d="M1.9477838,21.5 C1.6977511,21.5 1.5,21.3016354 1.5,21.0431048 L1.5,1.95689523 C1.5,1.70555616 1.70315066,1.5 1.94113901,1.5 L16.058861,1.5 C16.2975949,1.5 16.5,1.70783627 16.5,1.96250326 L16.5,13.2661378 L17.5,13.2661378 L17.5,1.96250326 C17.5,1.16139088 16.8558926,0.5 16.058861,0.5 L1.94113901,0.5 C1.14821378,0.5 0.5,1.15588925 0.5,1.95689523 L0.5,21.0431048 C0.5,21.8532278 1.1447717,22.5 1.9477838,22.5 L10.0155676,22.5 L10.0155676,21.5 L1.9477838,21.5 Z" id="path-1" fill="#F19243"></path>\n          <rect id="Rectangle-2" fill="#F19243" x="1" y="5" width="16" height="1"></rect>\n          <path d="M23.854,14.646 L21.354,12.146 C21.166,11.958 20.834,11.958 20.647,12.146 L13.146,19.648 C13.089,19.705 13.054,19.773 13.03,19.845 C13.028,19.852 13.021,19.857 13.019,19.865 L12.019,23.365 C11.969,23.539 12.018,23.727 12.146,23.856 C12.241,23.951 12.369,24.002 12.5,24.002 C12.546,24.002 12.592,23.996 12.637,23.983 L16.137,22.983 C16.144,22.981 16.149,22.974 16.157,22.972 C16.229,22.948 16.297,22.913 16.354,22.856 L23.855,15.354 C24.05,15.158 24.05,14.842 23.854,14.646 L23.854,14.646 L23.854,14.646 Z M16,21.795 L14.207,20.002 L19.001,15.207 L20.794,17 L16,21.795 L16,21.795 L16,21.795 Z M13.747,20.957 L15.045,22.255 L13.228,22.775 L13.747,20.957 L13.747,20.957 L13.747,20.957 Z M21.501,16.293 L19.708,14.5 L21.001,13.207 L22.794,15 L21.501,16.293 L21.501,16.293 L21.501,16.293 Z" id="Shape" fill="#F19243"></path>\n        </g>\n      </svg>\n    </div>\n    <div>\n      <h2 class=" CDB-Text CDB-Size-huge is-light u-bSpace--xl">\n        '+
((__t=( _t('components.table.columns.change-type.title', { columnName: columnName, newType: newType }) ))==null?'':_.escape(__t))+
'\n      </h2>\n      <p class="CDB-Text CDB-Size-large u-altTextColor">\n        '+
((__t=( _t('components.table.columns.change-type.desc') ))==null?'':_.escape(__t))+
'\n      </p>\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.table.columns.change-type.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.table.columns.change-type.confirm') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],304:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--grid u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="24px" height="25px" viewbox="521 436 24 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <path d="M524.5,440 L540.5,440 L540.5,460 L524.5,460 L524.5,440 Z M528.5,437 L536.5,437 L536.5,440 L528.5,440 L528.5,437 Z M522,440 L544,440 L522,440 Z M528.5,443.5 L528.5,455.5 L528.5,443.5 Z M532.5,443.5 L532.5,455.5 L532.5,443.5 Z M536.5,443.5 L536.5,455.5 L536.5,443.5 Z" id="Shape" stroke="#F19243" stroke-width="1" fill="none"/>\n      </svg>\n    </div>\n    <div>\n      <h2 class=" CDB-Text CDB-Size-huge is-light u-bSpace--xl">\n        '+
((__t=( _t('components.table.columns.destroy.title', { columnName: name }) ))==null?'':_.escape(__t))+
'\n      </h2>\n      <p class="CDB-Text CDB-Size-large u-altTextColor">'+
((__t=( _t('components.table.columns.destroy.desc') ))==null?'':_.escape(__t))+
'</p>\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.table.columns.destroy.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.table.columns.destroy.confirm') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],305:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--grid u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="25px" height="25px" viewBox="67 153 25 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <g id="Group-Copy" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(67.000000, 153.000000)">\n          <path d="M16,13 L17,13 L17,5.5 C17,5.433 16.986,5.368 16.961,5.308 C16.936,5.247 16.899,5.192 16.853,5.146 L11.854,0.147 C11.808,0.101 11.753,0.064 11.692,0.039 C11.632,0.014 11.567,0 11.5,0 L0.5,0 C0.224,0 0,0.224 0,0.5 L0,21.5 C0,21.776 0.224,22 0.5,22 L9.5,22 L9.5,21 L1,21 L1,1 L11,1 L11,5.5 C11,5.776 11.224,6 11.5,6 L16,6 L16,13 L16,13 Z M12,1.707 L15.293,5 L12,5 L12,1.707 L12,1.707 Z" id="Shape" fill="#F19243"></path>\n          <path d="M23.854,14.646 L21.354,12.146 C21.166,11.958 20.834,11.958 20.647,12.146 L13.146,19.648 C13.089,19.705 13.054,19.773 13.03,19.845 C13.028,19.852 13.021,19.857 13.019,19.865 L12.019,23.365 C11.969,23.539 12.018,23.727 12.146,23.856 C12.241,23.951 12.369,24.002 12.5,24.002 C12.546,24.002 12.592,23.996 12.637,23.983 L16.137,22.983 C16.144,22.981 16.149,22.974 16.157,22.972 C16.229,22.948 16.297,22.913 16.354,22.856 L23.855,15.354 C24.05,15.158 24.05,14.842 23.854,14.646 L23.854,14.646 Z M16,21.795 L14.207,20.002 L19.001,15.207 L20.794,17 L16,21.795 L16,21.795 Z M13.747,20.957 L15.045,22.255 L13.228,22.775 L13.747,20.957 L13.747,20.957 Z M21.501,16.293 L19.708,14.5 L21.001,13.207 L22.794,15 L21.501,16.293 L21.501,16.293 Z" id="Shape" fill="#F19243"></path>\n        </g>\n      </svg>\n    </div>\n    <div>\n      <h2 class=" CDB-Text CDB-Size-huge is-light u-bSpace--m">\n        '+
((__t=( _t('components.table.columns.rename.title', {
          columnName: columnName,
          newName: newName
        }) ))==null?'':_.escape(__t))+
'\n      </h2>\n      <p class="CDB-Text CDB-Size-medium u-altTextColor">\n        '+
((__t=( _t('components.table.columns.rename.desc', {
              columnName: columnName,
              newName: newName
        }) ))==null?'':_.escape(__t))+
'\n      </p>\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.table.columns.rename.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('components.table.columns.rename.confirm') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],306:[function(require,module,exports){
var $ = require('jquery');
var CoreView = require('backbone/core-view');
var template = require('./table-head-item.tpl');
var ContextMenuView = require('../../context-menu/context-menu-view');
var CustomListCollection = require('../../custom-list/custom-list-collection');
var TableHeadOptionsItemView = require('./table-head-options-item-view');
var tableHeadOptionsItemTemplate = require('./table-head-options-item.tpl');
var ConfirmationModalView = require('../../modals/confirmation/modal-confirmation-view');
var QueryColumnModel = require('../../../data/query-column-model');
var addColumnOperation = require('../operations/table-add-column');
var renameColumnOperation = require('../operations/table-rename-column');
var changeColumnTypeOperation = require('../operations/table-change-column-type');
var removeTableColumnOperation = require('../operations/table-remove-column');
var ENTER_KEY_CODE = 13;
var ESC_KEY_CODE = 27;

/*
 *  Main table view
 */

module.exports = CoreView.extend({

  className: 'Table-headItem',
  tagName: 'th',

  events: {
    'dblclick .js-attribute': '_onAttributeDblClicked',
    'focusout .js-attribute': '_saveNewName',
    'click .js-columnOptions': '_showContextMenu'
  },

  initialize: function (opts) {
    if (!opts.tableViewModel) throw new Error('tableViewModel is required');
    if (!opts.columnsCollection) throw new Error('columnsCollection is required');
    if (!opts.modals) throw new Error('modals is required');

    this._tableViewModel = opts.tableViewModel;
    this._columnsCollection = opts.columnsCollection;
    this._modals = opts.modals;

    this._hideContextMenu = this._hideContextMenu.bind(this);
    this._onKeyDown = this._onKeyDown.bind(this);
  },

  render: function () {
    this.clearSubViews();
    var columnName = this.model.get('name');
    this.$el.html(
      template({
        name: columnName,
        type: this.model.get('type'),
        isOrderBy: this._tableViewModel.get('order_by') === columnName,
        sortBy: this._tableViewModel.get('sort_order'),
        geometry: this.options.simpleGeometry
      })
    );
    return this;
  },

  _hasContextMenu: function () {
    return this._menuView;
  },

  _hideContextMenu: function () {
    this._unhighlightHead();
    this._destroyScrollBinding();
    this._menuView.collection.unbind(null, null, this);
    this.removeView(this._menuView);
    this._menuView.clean();
    delete this._menuView;
  },

  _highlightHead: function () {
    this.$el.addClass('is-highlighted');
  },

  _unhighlightHead: function () {
    this.$el.removeClass('is-highlighted');
  },

  _initScrollBinding: function () {
    $('.Table').scroll(this._hideContextMenu);
  },

  _destroyScrollBinding: function () {
    $('.Table').off('scroll', this._hideContextMenu);
  },

  _showContextMenu: function (ev) {
    var self = this;
    var position = { x: ev.clientX, y: ev.clientY };
    var elementIndex = this.$el.index();
    var modelCID = this.model.cid;
    var columnName = this.model.get('name');

    this._highlightHead();

    var menuItems = [{
      label: _t('components.table.columns.options.order'),
      val: 'order',
      isOrderBy: this._tableViewModel.get('order_by') === columnName,
      sortBy: this._tableViewModel.get('sort_order'),
      action: function (mdl) {
        self._tableViewModel.set({
          sort_order: mdl.get('sort'),
          order_by: columnName
        });
      }
    }];

    if (!this._tableViewModel.isDisabled()) {
      if (!this.model.isCartoDBIDColumn() && !this.model.isGeometryColumn()) {
        menuItems = menuItems.concat([
          {
            label: _t('components.table.columns.options.rename'),
            val: 'rename',
            action: function () {
              self._startEditing();
            }
          }, {
            label: _t('components.table.columns.options.change'),
            type: this.model.get('type'),
            isLastColumns: (this._columnsCollection.size() - elementIndex) < 3,
            val: 'change',
            action: function (mdl) {
              self._changeColumnType(mdl.get('type'));
            }
          }
        ]);
      }

      menuItems.push({
        label: _t('components.table.columns.options.create'),
        val: 'create',
        action: function () {
          self._addColumn();
        }
      });

      if (!this.model.isCartoDBIDColumn() && !this.model.isGeometryColumn()) {
        menuItems.push(
          {
            label: _t('components.table.columns.options.delete'),
            val: 'delete',
            destructive: true,
            action: function () {
              self._removeColumn();
            }
          }
        );
      }
    }

    var collection = new CustomListCollection(menuItems);

    this._menuView = new ContextMenuView({
      className: ContextMenuView.prototype.className + ' Table-columnMenu',
      collection: collection,
      itemTemplate: tableHeadOptionsItemTemplate,
      itemView: TableHeadOptionsItemView,
      triggerElementID: modelCID,
      position: position
    });

    collection.bind('change:selected', function (menuItem) {
      var action = menuItem.get('action');
      action && action(menuItem);
    }, this);

    this._menuView.model.bind('change:visible', function (model, isContextMenuVisible) {
      if (this._hasContextMenu() && !isContextMenuVisible) {
        this._hideContextMenu();
      }
    }, this);

    this._menuView.show();
    this.addView(this._menuView);

    this._initScrollBinding();
  },

  _addColumn: function () {
    addColumnOperation({
      tableViewModel: this._tableViewModel,
      columnsCollection: this._columnsCollection
    });
  },

  _changeColumnType: function (newType) {
    var self = this;
    var oldType = this.model.get('type');
    var isTypeChangeDestructive = QueryColumnModel.isTypeChangeDestructive(oldType, newType);
    if (!isTypeChangeDestructive) {
      changeColumnTypeOperation({
        columnModel: this.model,
        newType: newType
      });
    } else {
      this._modals.create(
        function (modalModel) {
          return new ConfirmationModalView({
            modalModel: modalModel,
            template: require('./modals-templates/change-table-column-type.tpl'),
            renderOpts: {
              columnName: self.model.get('name'),
              newType: newType
            },
            loadingTitle: _t('components.table.columns.change-type.loading', {
              columnName: self.model.get('name')
            }),
            runAction: function () {
              changeColumnTypeOperation({
                columnModel: self.model,
                newType: newType,
                onSuccess: function () {
                  modalModel.destroy();
                },
                onError: function (e) {
                  modalModel.destroy();
                }
              });
            }
          });
        }
      );
    }
  },

  _removeColumn: function () {
    var self = this;
    this._modals.create(
      function (modalModel) {
        return new ConfirmationModalView({
          modalModel: modalModel,
          template: require('./modals-templates/remove-table-column.tpl'),
          renderOpts: {
            name: self.model.get('name')
          },
          loadingTitle: _t('components.table.columns.destroy.loading', {
            columnName: self.model.get('name')
          }),
          runAction: function () {
            removeTableColumnOperation({
              columnModel: self.model,
              onSuccess: function () {
                modalModel.destroy();
              },
              onError: function (e) {
                modalModel.destroy();
              }
            });
          }
        });
      }
    );
  },

  _onAttributeDblClicked: function () {
    if (this.model.isEditable() && !this._tableViewModel.isDisabled()) {
      this._startEditing();
    }
  },

  _initRenameBinds: function () {
    $(document).bind('keydown', this._onKeyDown);
  },

  _destroyRenameBinds: function () {
    $(document).unbind('keydown', this._onKeyDown);
  },

  _onKeyDown: function (ev) {
    var keyCode = ev.which;
    if (keyCode === ENTER_KEY_CODE) {
      this._saveNewName();
    } else if (keyCode === ESC_KEY_CODE) {
      this._finishEditing();
    }
  },

  _startEditing: function () {
    this.$('.js-attribute')
      .addClass('is-active')
      .removeAttr('readonly');

    this._initRenameBinds();
  },

  _finishEditing: function () {
    this.$('.js-attribute')
      .val(this.model.get('name'))
      .removeClass('is-active')
      .attr('readonly', '');

    this._destroyRenameBinds();
  },

  _saveNewName: function () {
    if (this.model.isEditable()) {
      var newName = this.$('.js-attribute').val();
      var columnModel = this.model;
      var oldName = columnModel.get('name');

      if (oldName !== newName && newName !== '') {
        this._modals.create(
          function (modalModel) {
            return new ConfirmationModalView({
              modalModel: modalModel,
              template: require('./modals-templates/rename-table-column.tpl'),
              renderOpts: {
                columnName: oldName,
                newName: newName
              },
              loadingTitle: _t('components.table.columns.rename.loading', {
                columnName: oldName,
                newName: newName
              }),
              runAction: function () {
                renameColumnOperation({
                  columnModel: columnModel,
                  newName: newName,
                  onSuccess: function () {
                    modalModel.destroy();
                  },
                  onError: function (e) {
                    modalModel.destroy();
                  }
                });
              }
            });
          }
        );
      }
    }

    // Setting old name just in case user cancel it
    this._finishEditing();
  },

  clean: function () {
    this._destroyRenameBinds();
    this._destroyScrollBinding();
    CoreView.prototype.clean.apply(this);
  }

});

},{"../../../data/query-column-model":360,"../../context-menu/context-menu-view":15,"../../custom-list/custom-list-collection":23,"../../modals/confirmation/modal-confirmation-view":190,"../operations/table-add-column":312,"../operations/table-change-column-type":314,"../operations/table-remove-column":316,"../operations/table-rename-column":318,"./modals-templates/change-table-column-type.tpl":303,"./modals-templates/remove-table-column.tpl":304,"./modals-templates/rename-table-column.tpl":305,"./table-head-item.tpl":307,"./table-head-options-item-view":308,"./table-head-options-item.tpl":309,"backbone/core-view":454,"jquery":"jquery"}],307:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="\n    Table-headItemWrapper\n    '+
((__t=( name === 'cartodb_id' ||(type === 'geometry' && geometry !== 'point') ? 'Table-headItemWrapper--short' : '' ))==null?'':_.escape(__t))+
'\n  ">\n  <div class="u-flex u-justifySpace">\n    <input class="Table-headItemName CDB-Text CDB-Size-medium is-semibold u-ellipsis js-attribute" value="'+
((__t=( name ))==null?'':_.escape(__t))+
'" title="'+
((__t=( name ))==null?'':_.escape(__t))+
'" readonly />\n\n    ';
 if (isOrderBy) { 
__p+='\n      <i class="CDB-Size CDB-Size-small CDB-IconFont CDB-IconFont-arrowNext\n        Table-columnSorted\n        Table-columnSorted--';
 if (sortBy === 'asc') {
__p+='asc';
 } else {
__p+='desc';
 } 
__p+='\n        u-rSpace u-altTextColor\n      "></i>\n    ';
 } 
__p+='\n\n    <button class="CDB-Shape-threePoints is-blue is-small js-columnOptions">\n      <div class="CDB-Shape-threePointsItem"></div>\n      <div class="CDB-Shape-threePointsItem"></div>\n      <div class="CDB-Shape-threePointsItem"></div>\n    </button>\n  </div>\n  <p class="CDB-Size-small Table-headItemInfo u-altTextColor">'+
((__t=( type ))==null?'':_.escape(__t))+
'</p>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],308:[function(require,module,exports){
var _ = require('underscore');
var CustomListItemView = require('../../custom-list/custom-list-item-view');
var CustomListView = require('../../custom-list/custom-view');
var QueryColumnModel = require('../../../data/query-column-model');

module.exports = CustomListItemView.extend({

  events: _.extend(
    CustomListItemView.prototype.events,
    {
      'click .js-desc': '_onDescClick',
      'click .js-asc': '_onAscClick',
      'click .js-order': 'killEvent'
    }
  ),

  render: function () {
    this.$el.empty();
    this.clearSubViews();

    this.$el.append(
      this.options.template(
        {
          typeLabel: this.options.typeLabel,
          isSelected: this.model.get('selected'),
          isDisabled: this.model.get('disabled'),
          isDestructive: this.model.get('destructive'),
          isOrderBy: this.model.get('isOrderBy'),
          sortBy: this.model.get('sortBy'),
          name: this.model.getName(),
          val: this.model.getValue()
        }
      )
    );

    this.$el
      .attr('data-val', this.model.getValue())
      .toggleClass('is-disabled', !!this.model.get('disabled'));

    return this;
  },

  _onClick: function (ev) {
    this.killEvent(ev);

    if (this.model.getValue() === 'change') {
      this._openSubContextMenu(ev);
    } else {
      this.model.set('selected', true);
    }
  },

  _hideSubContextMenu: function () {
    if (this._subContextMenu) {
      this._subContextMenu.clean();
      this.removeView(this._subContextMenu);
      delete this.collection;
      delete this._subContextMenu;
    }
  },

  _openSubContextMenu: function (ev) {
    if (this._subContextMenu) {
      this._hideSubContextMenu();
    }

    var subContextClassName = 'Table-columnTypeMenu ';
    if (this.model.get('isLastColumns')) {
      subContextClassName += ' Table-columnTypeMenu--toLeft ';
    }

    this._subContextMenu = new CustomListView({
      className: subContextClassName + CustomListView.prototype.className,
      options: [
        {
          label: _t('components.table.columns.types.number'),
          disabled: !QueryColumnModel.isTypeChangeAllowed(this.model.get('type'), 'number'),
          val: 'number'
        }, {
          label: _t('components.table.columns.types.string'),
          disabled: !QueryColumnModel.isTypeChangeAllowed(this.model.get('type'), 'string'),
          val: 'string'
        }, {
          label: _t('components.table.columns.types.date'),
          disabled: !QueryColumnModel.isTypeChangeAllowed(this.model.get('type'), 'date'),
          val: 'date'
        }, {
          label: _t('components.table.columns.types.boolean'),
          disabled: !QueryColumnModel.isTypeChangeAllowed(this.model.get('type'), 'boolean'),
          val: 'boolean'
        }
      ],
      showSearch: false,
      typeLabel: ''
    });

    this._subContextMenu.collection.bind('change:selected', function (menuItem) {
      if (!menuItem.get('disabled')) {
        this.model.set({
          type: menuItem.getValue(),
          selected: true
        });
      }
    }, this);

    this.$el.closest('.Table-columnMenu').append(this._subContextMenu.render().el);
    this._subContextMenu.show();
    this.addView(this._subContextMenu);
  },

  _onAscClick: function (ev) {
    this.killEvent(ev);
    this.model.set({
      sort: 'asc',
      selected: true
    });
  },

  _onDescClick: function (ev) {
    this.killEvent(ev);
    this.model.set({
      sort: 'desc',
      selected: true
    });
  }

});

},{"../../../data/query-column-model":360,"../../custom-list/custom-list-item-view":26,"../../custom-list/custom-view":35,"underscore":"underscore"}],309:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (val === 'order') { 
__p+='\n  <div class="u-flex u-justifySpace CDB-ListDecoration-itemLink js-order">\n    <p class="CDB-Text CDB-Size-medium">'+
((__t=( name ))==null?'':_.escape(__t))+
'</p>\n    <ul class="u-flex">\n      <li class="js-asc">\n        <i class="CDB-Text CDB-IconFont\n          CDB-IconFont-arrowNext u-actionTextColor\n          Table-columnSorted\n          Table-columnSorted--asc\n           ';
 if (isOrderBy && sortBy === 'asc') { 
__p+='is-disabled';
 } 
__p+='\n           ';
 if (isOrderBy && sortBy === 'desc') { 
__p+='is-semibold';
 } 
__p+='\n        "></i>\n      </li>\n      <li class="js-desc u-lSpace--xl">\n        <i class="CDB-Text CDB-IconFont\n          CDB-IconFont-arrowNext u-actionTextColor\n          Table-columnSorted\n          Table-columnSorted--desc\n           ';
 if (isOrderBy && sortBy === 'desc') { 
__p+='is-disabled';
 } 
__p+='\n           ';
 if (isOrderBy && sortBy === 'asc') { 
__p+='is-semibold';
 } 
__p+='\n        "></i>\n      </li>\n    </ul>\n  </div>\n';
 } else if (val === 'change') { 
__p+='\n  <div class="CDB-ListDecoration-itemLink u-actionTextColor u-flex u-justifySpace u-alignCenter" title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">\n    <span>'+
((__t=( name ))==null?'':_.escape(__t))+
'</span>\n    <i class="CDB-Text CDB-Size-small is-semibold CDB-IconFont CDB-IconFont-rArrowLight"></i>\n  </div>\n';
 } else { 
__p+='\n  <div class="CDB-ListDecoration-itemLink\n    ';
 if (isDestructive) { 
__p+='  u-errorTextColor ';
 } else { 
__p+=' u-actionTextColor ';
 } 
__p+='\n    ';
 if (val === 'change') { 
__p+=' u-flex ';
 } 
__p+='\n    " title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">\n    '+
((__t=( name ))==null?'':_.escape(__t))+
'\n    ';
 if (val === 'change') { 
__p+='\n      <span>\n        <i class="CDB-Text CDB-Size-small is-semibold CDB-IconFont CDB-IconFont-rArrowLight"></i>\n      </span>\n    ';
 } 
__p+='\n  </div>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],310:[function(require,module,exports){
var $ = require('jquery');
var CoreView = require('backbone/core-view');
var TableHeadItemView = require('./table-head-item-view');
var template = require('./table-head.tpl');

/*
 *  Main table head view
 */

module.exports = CoreView.extend({
  className: 'Table-head',
  tagName: 'table',

  initialize: function (opts) {
    if (!opts.columnsCollection) throw new Error('columnsCollection is required');
    if (!opts.tableViewModel) throw new Error('tableViewModel is required');
    if (!opts.queryGeometryModel) throw new Error('queryGeometryModel is required');
    if (!opts.modals) throw new Error('modals is required');

    this._columnsCollection = opts.columnsCollection;
    this._tableViewModel = opts.tableViewModel;
    this._queryGeometryModel = opts.queryGeometryModel;
    this._modals = opts.modals;

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this.$el.append(template());
    this._columnsCollection.each(this._renderColumnHead, this);
    return this;
  },

  _initBinds: function () {
    this._queryGeometryModel.bind('change:simple_geom', this.render, this);
    this.add_related_model(this._queryGeometryModel);
    this._tableViewModel.bind('change:sort_order change:order_by', this.render, this);
    this.add_related_model(this._tableViewModel);
    this._columnsCollection.bind('reset', function () {
      this.render();

      if (this._newColumn) {
        var scrollWidth = this.$el.get(0).scrollWidth;

        setTimeout(function () {
          this._scrollToLeft({
            pos: scrollWidth
          });
        }.bind(this), 500);

        delete this._newColumn;
      }
    }, this);
    this._columnsCollection.bind('add', function (mdl) {
      this._newColumn = mdl;
    }, this);
    this.add_related_model(this._columnsCollection);
  },

  _renderColumnHead: function (mdl) {
    if (!this._tableViewModel.isDisabled() && mdl.get('name') === 'the_geom_webmercator') {
      return;
    }

    var view = new TableHeadItemView({
      model: mdl,
      modals: this._modals,
      columnsCollection: this._columnsCollection,
      tableViewModel: this._tableViewModel,
      simpleGeometry: this._queryGeometryModel.get('simple_geom')
    });
    this.$('.js-headRow').append(view.render().el);
    this.addView(view);
  },

  _scrollToLeft: function (opts) {
    opts = opts || {};
    $('.Table').animate({
      scrollLeft: opts.pos || 0
    }, opts.speed || 'slow');
  }

});

},{"./table-head-item-view":306,"./table-head.tpl":311,"backbone/core-view":454,"jquery":"jquery"}],311:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<thead>\n  <tr class="js-headRow"></tr>\n</thead>\n';
}
return __p;
};

},{"underscore":"underscore"}],312:[function(require,module,exports){
var Notifier = require('../../../components/notifier/notifier');
var errorParser = require('../../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.columnsCollection) throw new Error('columnsCollection is required');

  var columnsCollection = opts.columnsCollection;
  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;
  var notification = Notifier.addNotification({
    status: 'loading',
    info: _t('components.table.columns.create.loading'),
    closable: false
  });

  columnsCollection.addColumn({
    success: function (mdl, attrs) {
      successCallback && successCallback(mdl, attrs);
      notification.set({
        status: 'success',
        info: _t('components.table.columns.create.success', { columnName: attrs.name }),
        closable: true
      });
    },
    error: function (mdl, e) {
      errorCallback && errorCallback(mdl, e);
      notification.set({
        status: 'error',
        info: _t('components.table.columns.create.error', { error: errorParser(e) }),
        closable: true
      });
    }
  });
};

},{"../../../components/notifier/notifier":252,"../../../helpers/error-parser":426}],313:[function(require,module,exports){
var Notifier = require('../../../components/notifier/notifier');
var errorParser = require('../../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.rowsCollection) { throw new Error('rowsCollection is required'); }

  var rowsCollection = opts.rowsCollection;
  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;
  var notification = Notifier.addNotification({
    status: 'loading',
    info: _t('components.table.rows.create.loading'),
    closable: false
  });

  rowsCollection.addRow({
    success: function (mdl, attrs) {
      successCallback && successCallback(mdl, attrs);
      notification.set({
        status: 'success',
        info: _t('components.table.rows.create.success'),
        closable: true
      });
    },
    error: function (mdl, e) {
      errorCallback && errorCallback(mdl, e);
      notification.set({
        status: 'error',
        info: _t('components.table.rows.create.error', { error: errorParser(e) }),
        closable: true
      });
    }
  });
};

},{"../../../components/notifier/notifier":252,"../../../helpers/error-parser":426}],314:[function(require,module,exports){
var Notifier = require('../../../components/notifier/notifier');
var errorParser = require('../../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.columnModel) { throw new Error('columnModel is required'); }
  if (!opts.newType) { throw new Error('newType is required'); }

  var columnModel = opts.columnModel;
  var newType = opts.newType;

  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;

  var notification = Notifier.addNotification({
    status: 'loading',
    info: _t('components.table.columns.change-type.loading', {
      columnName: columnModel.get('name')
    }),
    closable: false
  });

  columnModel.save({
    type: newType
  }, {
    wait: true,
    success: function (mdl, attrs) {
      successCallback && successCallback(mdl, attrs);
      notification.set({
        status: 'success',
        info: _t('components.table.columns.change-type.success', {
          columnName: columnModel.get('name'),
          newType: newType
        }),
        closable: true
      });
    },
    error: function (mdl, e) {
      errorCallback && errorCallback(mdl, e);
      notification.set({
        status: 'error',
        info: _t('components.table.columns.change-type.error', {
          columnName: columnModel.get('name'),
          newType: newType,
          error: errorParser(e)
        }),
        closable: true
      });
    }
  });
};

},{"../../../components/notifier/notifier":252,"../../../helpers/error-parser":426}],315:[function(require,module,exports){
var Notifier = require('../../../components/notifier/notifier');
var errorParser = require('../../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.rowModel) throw new Error('rowModel is required');
  if (opts.newValue === undefined) throw new Error('newValue is required');
  if (!opts.attribute) throw new Error('attribute is required');

  var rowModel = opts.rowModel;
  var newValue = opts.newValue;
  var attribute = opts.attribute;
  var cartodbId = rowModel.get('cartodb_id');
  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;
  var notification = Notifier.addNotification({
    status: 'loading',
    info: _t('components.table.rows.edit.loading', {
      attribute: attribute,
      cartodbId: cartodbId
    }),
    closable: false
  });

  // In order to preserve "previous" attribute
  rowModel.set(attribute, newValue);
  rowModel.save(null, {
    success: function (mdl, attrs) {
      successCallback && successCallback(mdl, attrs);
      notification.set({
        status: 'success',
        info: _t('components.table.rows.edit.success', {
          attribute: attribute,
          cartodbId: cartodbId
        }),
        closable: true
      });
    },
    error: function (mdl, e) {
      errorCallback && errorCallback(mdl, e);
      notification.set({
        status: 'error',
        info: _t('components.table.rows.edit.error', {
          attribute: attribute,
          cartodbId: cartodbId,
          error: errorParser(e)
        }),
        closable: true
      });
    }
  });
};

},{"../../../components/notifier/notifier":252,"../../../helpers/error-parser":426}],316:[function(require,module,exports){
var Notifier = require('../../../components/notifier/notifier');
var errorParser = require('../../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.columnModel) { throw new Error('columnModel is required'); }

  var columnModel = opts.columnModel;
  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;
  var notification = Notifier.addNotification({
    status: 'loading',
    info: _t('components.table.columns.destroy.loading', { columnName: columnModel.get('name') }),
    closable: false
  });

  columnModel.destroy({
    wait: true,
    success: function (mdl, attrs) {
      successCallback && successCallback(mdl, attrs);
      notification.set({
        status: 'success',
        info: _t('components.table.columns.destroy.success', { columnName: columnModel.get('name') }),
        closable: true
      });
    },
    error: function (mdl, e) {
      errorCallback && errorCallback(mdl, e);
      notification.set({
        status: 'error',
        info: _t('components.table.columns.destroy.error', {
          columnName: columnModel.get('name'),
          error: errorParser(e)
        }),
        closable: true
      });
    }
  });
};

},{"../../../components/notifier/notifier":252,"../../../helpers/error-parser":426}],317:[function(require,module,exports){
var Notifier = require('../../../components/notifier/notifier');
var errorParser = require('../../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.rowModel) { throw new Error('rowModel is required'); }

  var rowModel = opts.rowModel;
  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;
  var cartodbId = rowModel.get('cartodb_id');
  var notification = Notifier.addNotification({
    status: 'loading',
    info: _t('components.table.rows.destroy.loading', { cartodb_id: cartodbId }),
    closable: false
  });

  rowModel.destroy({
    wait: true,
    success: function (mdl, attrs) {
      successCallback && successCallback(mdl, attrs);
      notification.set({
        status: 'success',
        info: _t('components.table.rows.destroy.success', { cartodb_id: cartodbId }),
        closable: true
      });
    },
    error: function (mdl, e) {
      errorCallback && errorCallback(mdl, e);
      notification.set({
        status: 'error',
        info: _t('components.table.rows.destroy.error', { cartodb_id: cartodbId, error: errorParser(e) }),
        closable: true
      });
    }
  });
};

},{"../../../components/notifier/notifier":252,"../../../helpers/error-parser":426}],318:[function(require,module,exports){
var Notifier = require('../../../components/notifier/notifier');
var errorParser = require('../../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.columnModel) { throw new Error('columnModel is required'); }
  if (!opts.newName) { throw new Error('newName is required'); }

  var columnModel = opts.columnModel;
  var oldName = columnModel.get('name');
  var newName = opts.newName;

  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;

  var notification = Notifier.addNotification({
    status: 'loading',
    info: _t('components.table.columns.rename.loading', { oldName: oldName, newName: newName }),
    closable: false
  });

  columnModel.save({
    new_name: newName,
    old_name: columnModel.get('name')
  }, {
    wait: true,
    success: function (mdl, attrs) {
      successCallback && successCallback(mdl, attrs);
      notification.set({
        status: 'success',
        info: _t('components.table.columns.rename.success', {
          columnName: oldName,
          newName: newName
        }),
        closable: true
      });
    },
    error: function (mdl, e) {
      errorCallback && errorCallback(mdl, e);
      notification.set({
        status: 'error',
        info: _t('components.table.columns.rename.error', {
          columnName: oldName,
          newName: newName,
          error: errorParser(e)
        }),
        closable: true
      });
    }
  });
};

},{"../../../components/notifier/notifier":252,"../../../helpers/error-parser":426}],319:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-LoaderIcon is-dark">\n  <svg class="CDB-LoaderIcon-spinner" viewbox="0 0 50 50">\n    <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"/>\n  </svg>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],320:[function(require,module,exports){
var _ = require('underscore');
var CoreView = require('backbone/core-view');
var template = require('./table-paginator.tpl');
var templateLoader = require('./table-paginator-loader.tpl');
var Notifier = require('../../../components/notifier/notifier');
var errorParser = require('../../../helpers/error-parser');

module.exports = CoreView.extend({

  tagName: 'div',
  className: 'Table-paginator js-tablePaginator',

  events: {
    'click .js-prev': '_onPrevPage',
    'click .js-next': '_onNextPage'
  },

  initialize: function (opts) {
    if (!opts.rowsCollection) throw new Error('rowsCollection is required');
    if (!opts.tableViewModel) throw new Error('tableViewModel is required');

    this._tableViewModel = opts.tableViewModel;
    this._rowsCollection = opts.rowsCollection;

    this._rowsCollection.bind('loading', function (item) {
      // Don't take into account row model loading triggers
      if (item.models) {
        this._isLoading = true;
      }
    }, this);
    this._rowsCollection.bind('add remove', this.render, this);
    this._tableViewModel.bind('change:page', this._onTablePageChange, this);
    this.add_related_model(this._tableViewModel);
    this.add_related_model(this._rowsCollection);
  },

  render: function () {
    var rowsSize = this._rowsCollection.size();
    var page = this._tableViewModel.get('page');
    var maxRowsPerPage = this._rowsCollection.DEFAULT_FETCH_OPTIONS.rows_per_page;

    this.$el.html(
      template({
        page: this._tableViewModel.get('page'),
        size: rowsSize,
        isNextAvailable: rowsSize >= maxRowsPerPage,
        isPrevAvailable: page > 0
      })
    );

    this.$el.toggleClass('Table-paginator--relative', !!this._tableViewModel.get('relativePositionated'));
    return this;
  },

  _onTablePageChange: function () {
    this._rowsCollection.fetch({
      data: _.extend(
        this._tableViewModel.pick('page', 'order_by', 'sort_order'),
        {
          exclude: !this._tableViewModel.isCustomQueryApplied() ? ['the_geom_webmercator'] : []
        }
      ),
      error: function (mdl, response) {
        this._isLoading = false;
        this.render();

        Notifier.addNotification({
          status: 'error',
          info: _t('components.table.rows.paginator.error', { error: errorParser(response) }),
          closable: true
        });
      }.bind(this)
    });
  },

  _onPrevPage: function (ev) {
    if (!this._isLoading) {
      this.$('.js-prev').html(templateLoader());
      this._tableViewModel.set('page', this._tableViewModel.get('page') - 1);
    }
  },

  _onNextPage: function (ev) {
    if (!this._isLoading) {
      this.$('.js-next').html(templateLoader());
      this._tableViewModel.set('page', this._tableViewModel.get('page') + 1);
    }
  }

});

},{"../../../components/notifier/notifier":252,"../../../helpers/error-parser":426,"./table-paginator-loader.tpl":319,"./table-paginator.tpl":321,"backbone/core-view":454,"underscore":"underscore"}],321:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<button class="Table-paginatorButton Table-paginatorButton--prev\n  ';
 if (isPrevAvailable) { 
__p+='\n    js-prev\n  ';
 } 
__p+='\n">\n  <i class="CDB-Text is-semibold CDB-IconFont CDB-IconFont-lArrowLight CDB-Size-small\n  ';
 if (isPrevAvailable) { 
__p+='\n    u-actionTextColor\n  ';
 } else { 
__p+='\n    u-hintTextColor\n  ';
 } 
__p+='\n  "></i>\n</button>\n<p class="Table-paginatorText CDB-Text CDB-Size-small is-semibold u-upperCase">\n  ';
 if (!size) {
__p+='\n   <span class="u-mainTextColor"></span>\n  ';
 } else { 
__p+='\n    <span class="u-mainTextColor">'+
((__t=( (page * 40) + 1 ))==null?'':_.escape(__t))+
'</span>\n    <span class="u-altTextColor u-lSpace u-rSpace">'+
((__t=( _t('components.table.rows.paginator.to') ))==null?'':_.escape(__t))+
'</span>\n    <span class="u-mainTextColor">'+
((__t=( (page * 40) + size ))==null?'':_.escape(__t))+
'</span>\n  ';
 } 
__p+='\n</p>\n<button class="Table-paginatorButton Table-paginatorButton--next\n  ';
 if (isNextAvailable) { 
__p+='\n    js-next\n  ';
 } 
__p+='\n">\n  <i class="CDB-Text is-semibold CDB-IconFont CDB-IconFont-rArrowLight CDB-Size-small\n  ';
 if (isNextAvailable) { 
__p+='\n    u-actionTextColor\n  ';
 } else { 
__p+='\n    u-hintTextColor\n  ';
 } 
__p+='\n  "></i>\n</button>\n';
}
return __p;
};

},{"underscore":"underscore"}],322:[function(require,module,exports){
var TableView = require('./table-view');
var QueryColumnsCollection = require('../../data/query-columns-collection');
var TableNameUtils = require('../../helpers/table-name-utils');
var checkAndBuildOpts = require('../../helpers/required-opts');

var REQUIRED_OPTS = [
  'analysisDefinitionNodeModel',
  'configModel',
  'modals',
  'userModel'
];

/**
 *  Table manager that generates necessary models/collections
 *  for the view
 *
 */

module.exports = {
  create: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    // Adds the owner username if it's in an organization and the table name is not already qualified
    var tableName = this._analysisDefinitionNodeModel.get('table_name');
    var userName = TableNameUtils.getUsername(tableName) || this._userModel.get('username');
    tableName = TableNameUtils.getQualifiedTableName(
      tableName,
      userName,
      this._userModel.isInsideOrg()
    );

    var querySchemaModel = this._analysisDefinitionNodeModel.querySchemaModel;

    var columnsCollection = new QueryColumnsCollection(
      querySchemaModel.columnsCollection.toJSON(),
      {
        configModel: this._configModel,
        tableName: tableName,
        querySchemaModel: querySchemaModel
      }
    );

    return new TableView({
      relativePositionated: opts.relativePositionated,
      modals: this._modals,
      analysisDefinitionNodeModel: this._analysisDefinitionNodeModel,
      columnsCollection: columnsCollection,
      tableName: tableName
    });
  },

  destroy: function (tableView) {
    if (!tableView) throw new Error('tableView object is needed');
    tableView.clean();
  }
};

},{"../../data/query-columns-collection":361,"../../helpers/required-opts":432,"../../helpers/table-name-utils":434,"./table-view":324}],323:[function(require,module,exports){
var Backbone = require('backbone');

/**
 *  Table view model
 */

module.exports = Backbone.Model.extend({
  defaults: {
    page: 0,
    order_by: '',
    sort_order: '',
    readonly: false,
    tableName: ''
  },

  initialize: function (attrs, opts) {
    if (!opts.analysisDefinitionNodeModel) throw new Error('analysisDefinitionNodeModel is required');
    if (!opts.columnsCollection) throw new Error('columnsCollection is required');

    this._analysisDefinitionNodeModel = opts.analysisDefinitionNodeModel;
    this._columnsCollection = opts.columnsCollection;

    this._setOrderAndSort();

    this.listenTo(this._columnsCollection, 'reset', this._setOrderAndSort);
  },

  _setOrderAndSort: function () {
    var hasCartodbId = this._columnsCollection.where({name: 'cartodb_id'}).length;

    if (hasCartodbId && !this.isCustomQueryApplied()) {
      this.set({
        'order_by': 'cartodb_id',
        'sort_order': 'asc'
      }, {
        silent: true
      });
    }
  },

  resetFetchDefaults: function () {
    this.set({
      page: this.defaults.page,
      order_by: '',
      sort_order: ''
    }, {
      silent: true
    });
  },

  isDisabled: function () {
    return this._analysisDefinitionNodeModel.isReadOnly();
  },

  isCustomQueryApplied: function () {
    return this._analysisDefinitionNodeModel.isCustomQueryApplied();
  }
});

},{"backbone":"backbone"}],324:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var $ = require('jquery');
var TableViewModel = require('./table-view-model.js');
var TableHeadView = require('./head/table-head-view');
var TableBodyView = require('./body/table-body-view');
var addTableRow = require('./operations/table-add-row');
var addTableColumn = require('./operations/table-add-column');
var SQLUtils = require('../../helpers/sql-utils');
var checkAndBuildOpts = require('../../helpers/required-opts');

var REQUIRED_OPTS = [
  'analysisDefinitionNodeModel',
  'columnsCollection',
  'modals'
];

/*
 *  Main table view
 */

module.exports = CoreView.extend({

  className: 'Table-wrapper',
  tagName: 'div',

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._rowsCollection = this._analysisDefinitionNodeModel.queryRowsCollection;
    this._queryGeometryModel = this._analysisDefinitionNodeModel.queryGeometryModel;
    this._querySchemaModel = this._analysisDefinitionNodeModel.querySchemaModel;
    this._tableModel = this._analysisDefinitionNodeModel.isSourceType() && this._analysisDefinitionNodeModel.getTableModel();

    this._tableViewModel = new TableViewModel({
      relativePositionated: opts.relativePositionated,
      tableName: opts.tableName
    }, {
      analysisDefinitionNodeModel: this._analysisDefinitionNodeModel,
      columnsCollection: this._columnsCollection
    });

    this._initBinds();

    if (this._queryGeometryModel.shouldFetch()) {
      this._queryGeometryModel.fetch();
    }

    if (this._querySchemaModel.shouldFetch()) {
      this._querySchemaModel.fetch();
    } else if (this._rowsCollection.shouldFetch()) {
      this._fetchRowsData();
    }
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    var tableElement = $('<div>').addClass('Table js-table');
    this.$el.append(tableElement);
    this._initViews();

    this.$('.js-table').toggleClass('Table--relative', !!this._tableViewModel.get('relativePositionated'));
    this._setDisableState();
    return this;
  },

  _initBinds: function () {
    this._onChangeQueryOrStatus = this._onChangeQueryOrStatus.bind(this);

    this.listenTo(this._querySchemaModel, 'change:query change:status', _.debounce(this._onChangeQueryOrStatus, 100));
    this.listenTo(this._querySchemaModel, 'change:status', this._setDisableState);
    this.listenTo(this._querySchemaModel, 'change:query', this._onQueryChanged);
    this.listenTo(this._querySchemaModel, 'change:status', this._fetchRowsData);
    this.listenTo(this._tableViewModel, 'change:sort_order change:order_by', this._fetchRowsData);

    if (this._tableModel && this._tableModel.isSync()) {
      var syncModel = this._tableModel.getSyncModel();
      this.listenTo(syncModel, 'destroy', this.render);
    }
  },

  _setDisableState: function () {
    this.$('.js-table').toggleClass('is-disabled', !!this._tableViewModel.isDisabled());
  },

  _fetchRowsData: function (mdl) {
    var attrsChanged = mdl && _.keys(mdl.changed);
    var altersData = SQLUtils.altersData(this._querySchemaModel.get('query'));
    var isCustomQueryApplied = this._tableViewModel.isCustomQueryApplied();
    var changeComeFromSortOrOrder = false;

    if (attrsChanged && (_.contains(attrsChanged, 'sort_order') || _.contains(attrsChanged, 'order_by'))) {
      changeComeFromSortOrOrder = true;
    }

    if (this._querySchemaModel.isFetched() && !altersData) {
      this._rowsCollection.fetch({
        data: {
          page: this._tableViewModel.get('page'),
          order_by: !isCustomQueryApplied || changeComeFromSortOrOrder ? this._tableViewModel.get('order_by') : '',
          sort_order: !isCustomQueryApplied || changeComeFromSortOrOrder ? this._tableViewModel.get('sort_order') : '',
          exclude: !isCustomQueryApplied || changeComeFromSortOrOrder ? ['the_geom_webmercator'] : []
        }
      });
    }
  },

  _initViews: function () {
    var tableHeadView = new TableHeadView({
      modals: this._modals,
      queryGeometryModel: this._queryGeometryModel,
      columnsCollection: this._columnsCollection,
      tableViewModel: this._tableViewModel
    });

    this.addView(tableHeadView);
    this.$('.js-table').append(tableHeadView.render().el);

    var tableBodyView = new TableBodyView({
      modals: this._modals,
      columnsCollection: this._columnsCollection,
      rowsCollection: this._rowsCollection,
      queryGeometryModel: this._queryGeometryModel,
      querySchemaModel: this._querySchemaModel,
      tableViewModel: this._tableViewModel
    });

    this.addView(tableBodyView);
    this.$('.js-table').append(tableBodyView.render().el);
  },

  _onChangeQueryOrStatus: function () {
    var schemaStatus = this._querySchemaModel.get('status');
    var geometryStatus = this._queryGeometryModel.get('status');

    if (schemaStatus === 'unfetched' && this._querySchemaModel.canFetch()) {
      this._querySchemaModel.fetch();
    }

    if (geometryStatus === 'unfetched' && this._queryGeometryModel.canFetch()) {
      this._queryGeometryModel.fetch();
    }
  },

  addRow: function () {
    addTableRow({
      tableViewModel: this._tableViewModel,
      rowsCollection: this._rowsCollection
    });
  },

  addColumn: function () {
    addTableColumn({
      tableViewModel: this._tableViewModel,
      columnsCollection: this._columnsCollection
    });
  },

  getColumnsCollection: function () {
    return this._columnsCollection;
  },

  _onQueryChanged: function () {
    this._tableViewModel.resetFetchDefaults();
  },

  // Remove elements that are not applied in the view
  remove: function () {
    $('.Table-paginator').remove();
    CoreView.prototype.remove.apply(this);
  }

});

},{"../../helpers/required-opts":432,"../../helpers/sql-utils":433,"./body/table-body-view":290,"./head/table-head-view":310,"./operations/table-add-column":312,"./operations/table-add-row":313,"./table-view-model.js":323,"backbone/core-view":454,"jquery":"jquery","underscore":"underscore"}],325:[function(require,module,exports){
var CoreView = require('backbone/core-view');
require('tipsy');

/**
 *  Tipsy tooltip view.
 *
 *  - Needs an element to work.
 *  - Inits tipsy library.
 *  - Clean bastard tipsy bindings easily.
 *
 */

module.exports = CoreView.extend({
  options: {
    gravity: 's',
    opacity: 1,
    fade: true
  },

  initialize: function (opts) {
    if (!opts.el) throw new Error('Element is needed to have tipsy tooltip working');
    this._tipsyOpenedManually = opts.trigger === 'manual';
    this._initTipsy();
  },

  _initTipsy: function () {
    this.$el.tipsy(this.options);
    this.tipsy = this.$el.data('tipsy');
  },

  showTipsy: function () {
    this.$el.tipsy('show');
  },

  hideTipsy: function () {
    this.$el.tipsy('hide');
  },

  destroyTipsy: function () {
    if (this.tipsy) {
      // tipsy does not return this
      this.tipsy.hide();
      this.$el.unbind('mouseleave mouseenter');
    }
    if (this._tipsyOpenedManually) {
      this.$el.tipsy('hide');
    }

    this.$el.removeData('tipsy');
    delete this.tipsy;
  },

  clean: function () {
    this.destroyTipsy();
  }
});

},{"backbone/core-view":454,"tipsy":458}],326:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./toggler.tpl');

module.exports = CoreView.extend({

  className: 'Toggle',

  events: {
    'click .js-input': '_onClick'
  },

  initialize: function (opts) {
    if (!opts.editorModel) throw new Error('editorModel should be provided');

    this._editorModel = opts.editorModel;
    this._labelsArray = opts.labels;
    this._isDisableable = opts.isDisableable;

    this.listenTo(this._editorModel, 'change:edition', this.render);
    this.listenTo(this._editorModel, 'change:disabled', this.render);
    this.add_related_model(this._editorModel);
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initViews: function () {
    var checked = this._editorModel.get('edition');
    var disabled = this._editorModel.get('disabled') && this._isDisableable;

    var _template = template({
      labels: this._labelsArray,
      checked: checked,
      disabled: disabled
    });

    this.$el.append(_template);
    return this;
  },

  _onClick: function () {
    var checked = this._editorModel.get('edition');
    this._editorModel.set({ edition: !checked });
  }
});

},{"./toggler.tpl":327,"backbone/core-view":454}],327:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="CDB-Text CDB-Size-small is-semibold u-rSpace--xl';
 if (disabled) { 
__p+=' is-disabled';
 } 
__p+='">\n  <label class="u-iBlock u-upperCase">'+
((__t=( labels[0] ))==null?'':_.escape(__t))+
'</label>\n  <input class="CDB-Toggle u-iBlock js-input" type="checkbox"\n    ';
 if (disabled) { 
__p+=' disabled';
 } 
__p+='\n    ';
 if (checked) { 
__p+=' checked ';
 } 
__p+=' >\n  <span class="u-iBlock CDB-ToggleFace"></span>\n  <label class="u-iBlock u-upperCase">'+
((__t=( labels[1] ))==null?'':_.escape(__t))+
'</label>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],328:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./undo-redo.tpl');

module.exports = CoreView.extend({
  events: {
    'click .js-redo': '_onRedoClick',
    'click .js-undo': '_onUndoClick',
    'click .js-apply': '_onApplyClick',
    'click .js-clear': '_onClearClick'
  },

  options: {
    applyButton: false,
    cancelButton: false
  },

  initialize: function (opts) {
    if (!opts.editorModel) throw new Error('editorModel is required');
    if (!opts.trackModel) throw new Error('trackModel is required');

    this._trackModel = opts.trackModel;
    this._editorModel = opts.editorModel;
    this._clearModel = opts.clearModel;

    this._initBinds();
  },

  render: function () {
    var canClear = false;
    if (this._clearModel) {
      canClear = this._clearModel.get('visible') === true;
    }

    this.$el.html(
      template({
        canUndo: this._trackModel.canUndo(),
        canRedo: this._trackModel.canRedo(),
        canApply: this.options.applyButton && this._editorModel.isEditing(),
        canClear: canClear
      })
    );
    this._checkButtonsStyle();
    return this;
  },

  _initBinds: function () {
    this._trackModel.bind('undo redo', this.render, this);
    this._trackModel.bind('unredoChanged', this.render, this);
    this._editorModel.bind('change:edition', this._checkButtonsStyle, this);
    this.add_related_model(this._trackModel);
    this.add_related_model(this._editorModel);

    if (this._clearModel) {
      this._clearModel.bind('change', this.render, this);
      this.add_related_model(this._clearModel);
    }
  },

  _onUndoClick: function () {
    if (this._trackModel.canUndo()) {
      this._trackModel.undo();
    }
  },

  _onRedoClick: function () {
    if (this._trackModel.canRedo()) {
      this._trackModel.redo();
    }
  },

  _onApplyClick: function () {
    if (this.options.applyButton && this.options.onApplyClick) {
      this.options.onApplyClick();
    }
  },

  _onClearClick: function () {
    if (this.options.clearButton && this.options.onClearClick) {
      this.options.onClearClick();
    }
  },

  _checkButtonsStyle: function (m) {
    var editing = this._editorModel.isEditing();
    this._getIcons().toggleClass('u-whiteTextColor', editing);
  },

  _getIcons: function () {
    return this.$('.js-theme');
  }
});

},{"./undo-redo.tpl":329,"backbone/core-view":454}],329:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-alignCenter">\n  <button class="js-undo">\n    <i class="CDB-IconFont CDB-IconFont-undo Size-large u-actionTextColor js-theme ';
 if (!canUndo) { 
__p+='is-disabled';
 } 
__p+='"></i>\n  </button>\n  <button class="u-lSpace--xl js-redo">\n    <i class="CDB-IconFont CDB-IconFont-redo Size-large u-actionTextColor js-theme ';
 if (!canRedo) { 
__p+='is-disabled';
 } 
__p+='"></i>\n  </button>\n  ';
 if (canClear) { 
__p+='\n  <button class="u-lSpace--xl CDB-Button CDB-Button--secondary CDB-Button--white js-clear">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small">'+
((__t=( _t('components.undo-redo.clear') ))==null?'':_.escape(__t))+
'</span>\n  </button>\n  ';
 } 
__p+='\n  ';
 if (canApply) { 
__p+='\n  <button class="u-lSpace--xl CDB-Button CDB-Button--primary js-apply">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small">'+
((__t=( _t('components.undo-redo.apply') ))==null?'':_.escape(__t))+
'</span>\n  </button>\n  ';
 } 
__p+='\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],330:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./panel-with-options.tpl');
var InfoboxView = require('../../components/infobox/infobox-view');

module.exports = CoreView.extend({
  initialize: function (opts) {
    if (!opts.createContentView) throw new Error('createContentView factory function is mandatory');
    if (!opts.editorModel) throw new Error('editorModel is required');

    this.template = this.options.template || template;

    this._createContentView = opts.createContentView;
    this._editorModel = opts.editorModel;
    this._createControlView = opts.createControlView;
    this._createActionView = opts.createActionView;
    this._infoboxModel = opts.infoboxModel;
    this._infoboxCollection = opts.infoboxCollection;

    this._editorModel.on('change:edition', this._setStyleMenu, this);
    this.add_related_model(this._editorModel);
  },

  render: function () {
    var contentView;
    var controlView;
    var actionView;
    var infoboxView;

    this.clearSubViews();
    this.$el.empty();

    this.$el.html(this.template());

    contentView = this._createContentView();

    this._content().html(contentView.render().el);
    this.addView(contentView);

    if (this._infoboxModel) {
      infoboxView = new InfoboxView({
        infoboxModel: this._infoboxModel,
        infoboxCollection: this._infoboxCollection
      });

      this._info().html(infoboxView.render().el);
      this.addView(infoboxView);
    }

    if (this._createControlView) {
      controlView = this._createControlView();
      this._controls().html(controlView.render().el);
      this.addView(controlView);
    }

    if (this._createActionView) {
      actionView = this._createActionView();
      this._actions().html(actionView.render().el);
      this.addView(actionView);
    }

    this._setStyleMenu();

    return this;
  },

  _content: function () {
    return this.$('.js-content');
  },

  _controls: function () {
    return this.$('.js-controls');
  },

  _actions: function () {
    return this.$('.js-actions');
  },

  _info: function () {
    return this.$('.js-info');
  },

  _setStyleMenu: function () {
    this.$('.js-theme').toggleClass('is-dark', this._editorModel.isEditing());
  }
});

},{"../../components/infobox/infobox-view":181,"./panel-with-options.tpl":331,"backbone/core-view":454}],331:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-content js-content"></div>\n<div class="js-info"></div>\n<ul class="Options-bar u-flex u-justifySpace js-theme js-optionsBar">\n  <li class="CDB-InfoBox-footerItem js-controls"></li>\n  <li class="CDB-InfoBox-footerItem CDB-InfoBox-footerItem--right js-actions"></li>\n</ul>';
}
return __p;
};

},{"underscore":"underscore"}],332:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var PermissionModel = require('./permission-model');
var OWN_ATTR_NAMES = ['id', 'username', 'avatar_url', 'name'];

module.exports = Backbone.Model.extend({
  defaults: {
    access: 'r'
  },

  isOwn: function (model) {
    return model.id === this.get('entity').id;
  },

  validate: function (attrs, options) {
    if (attrs.access !== PermissionModel.READ_ONLY && attrs.access !== PermissionModel.READ_WRITE) {
      return "access can't take 'r' or 'rw' values";
    }
  },

  toJSON: function () {
    var entity = _.pick(this.get('entity').toJSON(), OWN_ATTR_NAMES);
    // translate name to username
    if (!entity.username) {
      entity.username = entity.name;
      delete entity.name;
    }
    return {
      type: this.get('type') || 'user',
      entity: entity,
      access: this.get('access')
    };
  }
});

},{"./permission-model":359,"backbone":"backbone","underscore":"underscore"}],333:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var camshaftReference = require('./camshaft-reference');
var QueryGeometryModel = require('./query-geometry-model');
var QuerySchemaModel = require('./query-schema-model');
var nodeIds = require('../value-objects/analysis-node-ids');
var checkAndBuildOpts = require('../helpers/required-opts');
var QueryRowsCollection = require('./query-rows-collection');
var fetchAllQueryObjects = require('../helpers/fetch-all-query-objects');

var REQUIRED_OPTS = [
  'configModel'
];

/**
 *  Base model for an analysis definition node.
 *  May point to one or multiple nodes in turn (referenced by ids).
 *
 *
 *  Analysis-definition-node-model
 *    Query-Schema-Model
 *    Query-Geometry-Model
 *    Query-Rows-Collection
 */
module.exports = Backbone.Model.extend({

  initialize: function (attrs, opts) {
    if (!this.id) throw new Error('id is required');

    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    var modelOpts = {
      configModel: this._configModel,
      userModel: opts.userModel
    };

    var simpleGeom = this.get('simple_geom');

    this.querySchemaModel = new QuerySchemaModel(undefined, modelOpts);

    this.queryGeometryModel = new QueryGeometryModel({
      simple_geom: simpleGeom,
      status: simpleGeom ? 'fetched' : 'unfetched'
    }, modelOpts);

    this.queryRowsCollection = new QueryRowsCollection([], {
      configModel: this._configModel,
      userModel: opts.userModel,
      tableName: '',
      querySchemaModel: this.querySchemaModel
    });

    this.listenTo(this.queryGeometryModel, 'change:simple_geom', this._onGeometryTypeChanged);
  },

  fetchQueryObjects: function () {
    if (this.get('status') === 'ready' && !this.get('error')) {
      fetchAllQueryObjects({
        queryGeometryModel: this.queryGeometryModel,
        querySchemaModel: this.querySchemaModel,
        queryRowsCollection: this.queryRowsCollection
      });
    }
  },

  /**
   * @override {Backbone.prototype.parse}  flatten the provided analysis data and create source nodes if there are any.
   */
  parse: function (r, opts) {
    // Allow omitting type when merging into an existing node
    var sourceNames = (!r.type && opts.merge) ? [] : camshaftReference.getSourceNamesForAnalysisType(r.type);

    var parsedParams = _.reduce(r.params, function (memo, val, name) {
      var sourceName = sourceNames[sourceNames.indexOf(name)];

      if (sourceName) {
        this.collection.add(val, opts);
        memo[name] = val.id;
      } else {
        memo[name] = val;
      }

      return memo;
    }, {}, this);

    var parsedOptions = _.reduce(r.options, function (memo, val, name) {
      memo[name] = val;
      return memo;
    }, {}, this);

    return _.defaults(
      _.omit(r, 'params', 'options'),
      parsedOptions,
      parsedParams
    );
  },

  /**
   * @override {Backbone.prototype.toJSON} unflatten the internal structure to the expected nested JSON data structure.
   * @param {Object} options
   * @param {Boolean} options.skipOptions - Add or not analysis options to the definition
   */
  toJSON: function (options) {
    options = options || {};

    var analysisParams = [];
    var paramsforJSON = {};
    var paramsForType = camshaftReference.paramsForType(this.get('type'));

    // Undo the parsing of the params previously done in .parse() (when model was created)
    for (var name in paramsForType) {
      var param = paramsForType[name];
      var val = this.get(name);
      var includeParamInJSON = true;

      if (param.type === 'node') {
        var node = this.collection.get(val);
        if (node) {
          val = node.toJSON(options);
        } else if (param.optional) { // Node has no value but is optional. We don't serialize it.
          includeParamInJSON = false;
        } else { // Node has no value and is required. Throw error.
          throw new Error('no node found for param "' + name + '" with id "' + val + '" in node ' + JSON.stringify(this.attributes));
        }
      }

      if (includeParamInJSON) {
        paramsforJSON[name] = val;
        analysisParams.push(name);
      }
    }

    var json = {
      id: this.get('id'),
      type: this.get('type'),
      params: paramsforJSON
    };

    // style_history is not sent at all (neither inside params nor options). It is always set by the backend.
    var optionsAttrs = _.omit(this.attributes, analysisParams.concat('id', 'type', 'status', 'style_history'));
    if (!(options.skipOptions || _.isEmpty(optionsAttrs))) {
      json['options'] = optionsAttrs;
    }

    return json;
  },

  /**
   * @override {Backbone.prototype.isNew} for this.destroy() to work (not try to send DELETE request)
   */
  isNew: function () {
    return true;
  },

  isReadOnly: function () {
    // By default, any node should be read only by default, except the source node (with exceptions)
    return true;
  },

  isCustomQueryApplied: function () {
    // By default, any node shouldn't have a custom query applied, except the source node
    return false;
  },

  canBeDeletedByUser: function () {
    return this.hasPrimarySource();
  },

  hasFailed: function () {
    return this.get('status') === 'failed';
  },

  isDone: function () {
    return this.get('status') === 'ready';
  },

  destroy: function () {
    if (this.querySchemaModel) {
      this.querySchemaModel.destroy();
      this.querySchemaModel = null;
    }

    return Backbone.Model.prototype.destroy.apply(this, arguments);
  },

  /**
   * Creates a new node that have same params as the current node, with only the id differing.
   * @param {String} newId - e.g. 'b1'
   * @return {Object} instance of analysis-definition-node-model
   */
  clone: function (newId) {
    if (!newId) throw new Error('newId is required');
    if (!_.isString(newId) || newId.length < 2) throw new Error('newId is required as a non-empty string');
    if (newId === this.id) throw new Error('newId must be different from current id, ' + this.id);

    var attrs = this.toJSON();
    attrs.id = newId;
    return this.collection.add(attrs);
  },

  linkedListBySameLetter: function () {
    var list = [this];
    var prev = this;
    var letter = this.letter();

    while (true) {
      var current = prev.getPrimarySource();
      if (current && current.letter() === letter) {
        list.push(current);
        prev = current;
      } else {
        break;
      }
    }

    return list;
  },

  /**
   * @return {Boolean, null} null if the geoemtry type of this node is not known,
   *   this is to indicate that the query model is not ready yet, up to caller to make the call or not
   */
  isValidAsInputForType: function (analysisType) {
    if (analysisType === 'source') return false;

    var geometry = this.queryGeometryModel.get('simple_geom');
    return geometry
      ? camshaftReference.isValidInputGeometryForType(geometry, analysisType)
      : null;
  },

  containsNode: function (other) {
    if (!other) return false;
    return this.id === other.id || this._sourcesContains(other);
  },

  hasPrimarySource: function () {
    return !!this.getPrimarySource();
  },

  hasSecondarySource: function () {
    return !!this.getSecondarySource();
  },

  getPrimarySource: function () {
    return this.collection.get(this._getPrimarySourceId());
  },

  getSecondarySource: function () {
    // Assumption: there are only 1-2 sources, so secondary is the one that's not the primary
    var primarySourceId = this._getPrimarySourceId();
    var secondarySourceId = _.find(this.sourceIds(), function (sourceId) {
      return sourceId !== primarySourceId;
    });
    return this.collection.get(secondarySourceId);
  },

  // Default query by default is the query already applied in the node.
  // For source node is totally different
  getDefaultQuery: function () {
    return this.get('query');
  },

  /**
   * @return {Array} e.g. ['c3', 'b2']
   */
  sourceIds: function () {
    return _.map(this._sourceNames(), function (sourceName) {
      return this.get(sourceName);
    }, this);
  },

  changeSourceIds: function (currentId, newId, silenty) {
    this._sourceNames().forEach(function (sourceName) {
      if (this.get(sourceName) === currentId) {
        this.set(sourceName, newId, { silent: silenty });
      }
    }, this);
  },

  isSourceType: function () {
    return this.get('type') === 'source';
  },

  letter: function () {
    return nodeIds.letter(this.id);
  },

  getStyleHistoryForLayer: function (layer_id) {
    var styleHistory = this.get('style_history');
    return styleHistory && styleHistory[layer_id];
  },

  // Private methods

  _sourcesContains: function (other) {
    var primarySource = this.getPrimarySource();
    var secondarySource = this.getSecondarySource();
    return !!(
      (primarySource && primarySource.containsNode(other)) ||
      (secondarySource && secondarySource.containsNode(other))
    );
  },

  _getPrimarySourceId: function () {
    var primarySourceName = this.get('primary_source_name') || this._sourceNames()[0];
    return this.get(primarySourceName);
  },

  /**
   * @return {Array} e.g. ['polygons_source', 'points_source']
   */
  _sourceNames: function () {
    return camshaftReference.getSourceNamesForAnalysisType(this.get('type'));
  },

  _onGeometryTypeChanged: function (m, value) {
    this.set('simple_geom', value);
  }

});

},{"../helpers/fetch-all-query-objects":427,"../helpers/required-opts":432,"../value-objects/analysis-node-ids":449,"./camshaft-reference":341,"./query-geometry-model":362,"./query-rows-collection":364,"./query-schema-model":365,"backbone":"backbone","underscore":"underscore"}],334:[function(require,module,exports){
var AnalysisDefinitionNodeModel = require('./analysis-definition-node-model');
var TableModel = require('./table-model');
var SQLUtils = require('../helpers/sql-utils');

/**
 *  Case of a node model representing a source node.
 *  - It should provide new info about if the node is read only or not.
 *
 *  Analysis-definition-node-source-model
 *    Query-Schema-Model
 *    Query-Geometry-Model
 *    Table-Model
 */
module.exports = AnalysisDefinitionNodeModel.extend({

  defaults: {
    status: 'ready'
  },

  /**
   * @override AnalysisDefinitionNodeModel.prototype.initialize
   */
  initialize: function (attrs, opts) {
    if (!opts.userModel) throw new Error('userModel is required');

    this._userModel = opts.userModel;
    AnalysisDefinitionNodeModel.prototype.initialize.apply(this, arguments);

    var query = this.get('query');
    this.querySchemaModel.set({
      query: query,
      ready: true
    }, { silent: true });

    this.queryGeometryModel.set({
      query: query,
      ready: true
    }, { silent: true });

    // TODO: we should check if it is necessary to check if we have to overwrite the whole
    //       initialize or with this change is enough.
    this.queryRowsCollection._tableName = this.get('table_name');

    var tableData = opts.tableData || { name: this.get('table_name') };
    this.tableModel = new TableModel(tableData, {
      configModel: opts.configModel,
      parse: true
    });
  },

  getDefaultQuery: function () {
    return SQLUtils.getDefaultSQL(
      this.get('table_name'),
      this.tableModel.getOwnerName(),
      this._userModel.isInsideOrg()
    );
  },

  isCustomQueryApplied: function () {
    return !SQLUtils.isSameQuery(
      this.querySchemaModel.get('query'),
      this.getDefaultQuery()
    );
  },

  isReadOnly: function () {
    var isTableReadOnly = this.tableModel.isReadOnly(this._userModel);
    var hasCustomQuery = this.isCustomQueryApplied();
    return isTableReadOnly || hasCustomQuery;
  },

  getTableModel: function () {
    return this.tableModel;
  },

  fetchTable: function () {
    if (!this.tableModel.get('id')) {
      this.tableModel.fetch();
    }
  },

  setTableName: function (name) {
    if (!name) throw new Error('name is required');

    this.set('table_name', name);
    this.tableModel.set('name', name);
    this.queryRowsCollection.setTableName(name);
    this.querySchemaModel.set({
      status: 'unfetched',
      query: this.getDefaultQuery()
    });
  }

});

},{"../helpers/sql-utils":433,"./analysis-definition-node-model":333,"./table-model":370}],335:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var Utils = require('../helpers/utils');

require('backbone-model-file-upload');

module.exports = Backbone.Model.extend({
  fileAttribute: 'filename',

  defaults: {
    type: '',
    filename: '',
    interval: 0,
    progress: 0,
    state: 'idle',
    option: ''
  },

  _initBinds: function () {
    this.bind('progress', function (progress) {
      this.set({
        progress: progress * 100,
        state: 'uploading'
      });
    }, this);

    this.bind('change:filename change:url', function () {
      if (this.get('state') === 'error') {
        this.set({ state: 'idle' });
        this.unset('get_error_text', { silent: true });
      }
    }, this);

    this.bind('error invalid', function (m, d) {
      this.set({
        state: 'error',
        error_code: (d && d.error_code) || '',
        get_error_text: {
          title: _t('componentes.data.asset-model.invalid-import'),
          what_about: (d && d.msg) || ''
        }
      }, { silent: true });
      // We need this, if not validate will run again and again and again... :(
      this.trigger('change');
    }, this);
  },

  validate: function (attrs) {
    if (!attrs) {
      return;
    }

    if (attrs.type === 'filename') { // Number of files
      if (attrs.filename && attrs.filename.length) {
        return {
          msg: _t('componentes.data.asset-model.one-file-per-upload')
        };
      }
      // File extension
      var name = attrs.filename.name;
      var ext = name.substr(name.lastIndexOf('.') + 1);

      if (ext) {
        ext = ext.toLowerCase();
      }

      if (!_.contains(['jpg', 'png', 'gif', 'svg'], ext)) {
        return {
          msg: _t('componentes.data.asset-model.invalid-extension')
        };
      }
    }

    if (attrs.type === 'url') { // Valid URL?
      if (!Utils.isURL(attrs.url)) {
        return {
          msg: _t('componentes.data.asset-model.invalid-url')
        };
      }
    }
  },

  isValid: function () {
    return (this.get('filename') || this.get('url')) && this.get('state') !== 'error';
  },

  upload: function () {
    var self = this;

    var options = {
      kind: this.get('kind')
    };

    if (this.get('type') === 'file') {
      options.filename = this.get('filename');
    } else if (this.get('type') === 'url') {
      options.filename = this.get('filename');
    }

    this.xhr = this.save(options, {
      success: function (m) {
        m.set('state', 'uploaded');
      },

      error: function (m, msg) {
        var response;
        var message = _t('componentes.data.asset-model.connection-error');

        if (msg && msg.status === 429) {
          response = JSON.parse(msg.responseText);
          message = response.error;
        } else if (msg && msg.status === 400) {
          response = JSON.parse(msg.responseText);
          message = response.error;
        }

        self.set({
          state: 'error',
          get_error_text: { title: _t('componentes.data.asset-model.error'), what_about: message }
        });
      },

      complete: function () {
        delete self.xhr;
      }
    });
  },

  stopUpload: function () {
    if (this.xhr) this.xhr.abort();
  }
});

},{"../helpers/utils":435,"backbone":"backbone","backbone-model-file-upload":"backbone-model-file-upload","underscore":"underscore"}],336:[function(require,module,exports){
var Backbone = require('backbone');
var AssetModel = require('./asset-model');
var checkAndBuildOpts = require('../helpers/required-opts');

var REQUIRED_OPTS = [
  'configModel',
  'userModel'
];

module.exports = Backbone.Collection.extend({
  model: AssetModel,

  url: function (method) {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('asset', method);
    return baseUrl + '/api/' + version + '/users/' + this._userModel.get('id') + '/assets';
  },

  initialize: function (models, opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
  },

  parse: function (resp, xhr) {
    return resp.assets;
  },

  selectAll: function () {
    this.each(function (mdl) {
      mdl.set('state', 'selected');
    });
  },

  deselectAll: function (m) {
    this.each(function (mdl) {
      if (mdl !== m && mdl.get('state') === 'selected') {
        mdl.set('state', '');
      }
    });
  }
});

},{"../helpers/required-opts":432,"./asset-model":335,"backbone":"backbone"}],337:[function(require,module,exports){
var Backbone = require('backbone');

/**
 * Custom sync method to only allow a single request at a time,
 * any prev ongoing request at a time of a sync call will be aborted.
 *
 * @example
 *   var MyModel = Backbone.Model.extend({
 *     // 
 *     sync: syncAbort,
 */
module.exports = function (method, self, opts) {
  if (this._xhr) {
    this._xhr.abort();
  }

  var xhr = this._xhr = Backbone.Model.prototype.sync.apply(this, arguments);
  xhr.always(function () {
    self._xhr = null;
  });

  return xhr;
};

},{"backbone":"backbone"}],338:[function(require,module,exports){
var _ = require('underscore');
var Poller = require('./poller');

var ImportModelPoller = function (model) {
  var POLLING_INTERVAL = 2000; // Interval time between poll checkings
  var POLLING_INTERVAL_MULTIPLIER = 2.5;  // Multiply interval by this number
  var POLLING_REQUESTS_BEFORE_INTERVAL_CHANGE = 30; // Max tries until interval change

  var options = {
    interval: function (numberOfRequests) {
      if (numberOfRequests >= POLLING_REQUESTS_BEFORE_INTERVAL_CHANGE) {
        return POLLING_INTERVAL * POLLING_INTERVAL_MULTIPLIER;
      }
      return POLLING_INTERVAL;
    },
    stopWhen: function (model) {
      var state = model.get('state');
      return (state === 'complete' || state === 'failure');
    }
  };

  Poller.call(this, model, options);
};

ImportModelPoller.prototype = _.extend({}, Poller.prototype);

module.exports = ImportModelPoller;

},{"./poller":340,"underscore":"underscore"}],339:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var ImportModelPoller = require('./import-model-poller');
var SynchronizationModel = require('../synchronization-model');

/**
 *  New import model that controls
 *  the state of an import
 *
 */
module.exports = Backbone.Model.extend({

  idAttribute: 'item_queue_id',

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;

    this._initBinds();
    this.poller = new ImportModelPoller(this);
  },

  urlRoot: function () {
    var version = this._configModel.urlVersion('import');
    var baseUrl = this._configModel.get('base_url');

    return baseUrl + '/api/' + version + '/imports';
  },

  _initBinds: function () {
    this.bind('change:item_queue_id', this._checkQueueId, this);
  },

  createImport: function (data) {
    var d = this._prepareData(data);
    this[d.interval === 0 ? '_createRegularImport' : '_createSyncImport'](d);
  },

  _checkQueueId: function () {
    if (this.get('item_queue_id')) {
      this.pollCheck();
    }
  },

  _prepareData: function (data) {
    var d = {
      create_vis: data.create_vis,
      privacy: data.privacy
    };

    var type = data.type;

    if (type !== 'remote') {
      _.extend(d, {
        type_guessing: data.type_guessing,
        content_guessing: data.content_guessing,
        interval: data.interval
      });
    }

    var service = data.service_name;

    if (type === 'url') {
      _.extend(d, {
        url: data.value
      });
    }

    if (type === 'remote') {
      _.extend(d, {
        type: 'remote',
        interval: null,
        remote_visualization_id: data.remote_visualization_id,
        create_vis: false,
        value: data.value
      });
    }

    if (type === 'sql') {
      _.extend(d, {
        table_name: data.table_name,
        sql: data.value
      });
    }

    if (type === 'duplication') {
      _.extend(d, {
        table_name: data.table_name,
        table_copy: data.value
      });
    }

    if (type === 'service') {
      // If service is Twitter, service_item_id should be
      // sent stringified
      var service_item_id = (service === 'twitter_search') ? JSON.stringify(data.service_item_id) : data.service_item_id;

      if (data.user_defined_limits) {
        d.user_defined_limits = data.user_defined_limits;
      }

      _.extend(d, {
        value: data.value,
        service_name: data.service_name,
        service_item_id: service_item_id
      });
    }

    return d;
  },

  _createSyncImport: function (d) {
    var self = this;
    this._synchronizationModel = new SynchronizationModel(d, {
      configModel: this._configModel
    });

    this._synchronizationModel.save(null, {
      success: function (m) {
        self.set('item_queue_id', m.get('data_import').item_queue_id);
      },
      error: function (mdl, r, opts) {
        self._setErrorState(r);
      }
    });
  },

  _createRegularImport: function (d) {
    var self = this;

    this.save(d, {
      error: function (mdl, r, opts) {
        self._setErrorState(r);
      }
    });
  },

  _setErrorState: function (r) {
    var msg;
    try {
      msg = r && JSON.parse(r.responseText).errors.imports;
    } catch (err) {
      msg = _t('data.import-model.error-starting-import');
    }
    this.set({
      state: 'failure',
      get_error_text: {
        title: _t('data.import-model.error-title'),
        what_about: msg
      }
    });
  },

  pollCheck: function () {
    this.poller.start();
  },

  destroyCheck: function () {
    this.poller.stop();
  }
});

},{"../synchronization-model":368,"./import-model-poller":338,"backbone":"backbone","underscore":"underscore"}],340:[function(require,module,exports){
var _ = require('underscore');

/*
 * Periodically fetches a model/collection. It waits for ongoing
 * fetch requests before trying to fetch again. A stop condition
 * can be specified.
 *
 * Usage example:
 *
 * var poller = new Poller(model, {
 *   interval: 1000,
 *   stopWhen: function (model) {
 *     return model.get('state') === 'completed';
 *   }
 * });
 *
 * poller.start();
 *
 * // ...
 *
 * poller.stop();
 *
 */
var Poller = function (model, opts) {
  this.model = model;
  this.numberOfRequests = 0;
  this.polling = false;
  this.interval = opts.interval;
  if (typeof this.interval !== 'function') {
    this.interval = function () { return opts.interval; };
  }
  this.stopWhen = opts.stopWhen;
  this.error = opts.error;
  this.autoStart = opts.autoStart;

  if (this.autoStart) {
    this.start();
  }
};

Poller.prototype.start = function () {
  if (this.timeout) {
    return;
  }

  this._scheduleFetch();
};

Poller.prototype._scheduleFetch = function () {
  this.timeout = setTimeout(this._fetch.bind(this), this.interval(this.numberOfRequests));
};

Poller.prototype._fetch = function () {
  var self = this;
  if (!self.polling) {
    self.polling = true;
    self.model.fetch({
      success: function () {
        self.polling = false;
        self.numberOfRequests++;
        if (self._continuePolling()) {
          self._scheduleFetch();
        }
      },
      error: function (e) {
        _.isFunction(self.error) && self.error(self.model);
      }
    });
  }
};

Poller.prototype._continuePolling = function () {
  return !this.stopWhen ||
    (_.isFunction(this.stopWhen) && !this.stopWhen(this.model));
};

Poller.prototype.stop = function () {
  this.polling = false;
  clearTimeout(this.timeout);
  delete this.timeout;
};

module.exports = Poller;

},{"underscore":"underscore"}],341:[function(require,module,exports){
var _ = require('underscore');
var camshaftReference = require('camshaft-reference').getVersion('latest');
var DefaultCartography = require('./default-cartography.json');

var SOURCE_NAMES_MAP = {}; // string -> array, e.g. {'intersection': ['source', 'target']}
var DEFAULT_MISSING_PARAM_VALUES = [undefined, null, '', NaN];

module.exports = {
  hasType: function (type) {
    return !!camshaftReference.analyses[type];
  },

  paramsForType: function (type) {
    if (!this.hasType(type)) throw new Error('no analysis params found for type: ' + type);

    return _.clone(camshaftReference.analyses[type].params);
  },

  /**
   * Validate raw form attrs
   * @param {Object} formAttrs - e.g. {type: 'buffer', source: 'a0', radius: 'meh'}
   * @return {Object, undefined} returns an object with keys as faulty input, e.g. {radius: 'invalid-value'} for above
   */
  validate: function (formAttrs) {
    var errors = {};

    var parsedAttrs = this.parse(formAttrs);
    var params = this.paramsForType(formAttrs.type);

    for (var name in params) {
      var param = params[name];
      var val = parsedAttrs[name];

      if (!param.optional || val !== undefined) {
        switch (param.type) {
          case 'node':
            if (!val) {
              errors[name] = _t('data.analysis-definition-node-model.validation.invalid-source');
            }
            break;
          case 'number':
            if (isNaN(val)) {
              errors[name] = _t('data.analysis-definition-node-model.validation.invalid-value');
            }
            break;
          case 'enum':
            if (!_.contains(param.values, val)) {
              errors[name] = _t('data.analysis-definition-node-model.validation.invalid-enum', {expectedValues: JSON.stringify(param.values)});
            }
            break;
          default:
            if (val === null) {
              errors[name] = _t('data.analysis-definition-node-model.validation.missing-required');
            }
        }
      }
    }

    if (!_.isEmpty(errors)) {
      return errors;
    }
  },

  /**
   * Get type-parsed attrs from the raw form attrs
   * @param {Object} formAttrs - e.g. {type: 'buffer', source: 'a0 ', radius: '123', dissolved: 'false'}
   * @return {Object} e.g. {type: 'buffer', source: 'a0', radius: 123, dissolved: false}
   */
  parse: function (formAttrs) {
    var parsedAttrs = _.extend({}, formAttrs);
    var params = this.paramsForType(formAttrs.type);

    for (var name in params) {
      var param = params[name];
      var val = parsedAttrs[name];

      if (param.optional && _.contains(DEFAULT_MISSING_PARAM_VALUES, val)) {
        delete parsedAttrs[name];
      } else {
        switch (param.type) {
          case 'node':
            parsedAttrs[name] = (val || '').trim();
            break;
          case 'number':
            parsedAttrs[name] = parseFloat(val, 10);
            break;
          case 'boolean':
            parsedAttrs[name] = val === 'true' || val === true;
            break;
          default:
            if (_.contains(DEFAULT_MISSING_PARAM_VALUES, val)) {
              parsedAttrs[name] = null;
            } else if (_.isString(val)) {
              parsedAttrs[name] = val.trim();
            }
        }
      }
    }

    return parsedAttrs;
  },

  getSourceNamesForAnalysisType: function (type) {
    if (!SOURCE_NAMES_MAP[type]) {
      var sourceNames = [];
      var params = this.paramsForType(type);

      for (var name in params) {
        var param = params[name];
        if (param.type === 'node') {
          sourceNames.push(name);
        }
      }

      SOURCE_NAMES_MAP[type] = sourceNames;
    }

    return SOURCE_NAMES_MAP[type];
  },

  getDefaultCartoCSSForType: function () {
    return _.template([
      "#layer['mapnik::geometry_type'=1] {",
      '  marker-width: <%= point.fill.size.fixed %>;',
      '  marker-fill: <%= point.fill.color.fixed %>;',
      '  marker-fill-opacity: <%= point.fill.color.opacity %>;',
      '  marker-line-color: <%= point.stroke.color.fixed %>;',
      '  marker-line-width: <%= point.stroke.size.fixed %>;',
      '  marker-line-opacity: <%= point.stroke.color.opacity %>;',
      '  marker-placement: point;',
      '  marker-type: ellipse;',
      '  marker-allow-overlap: true;',
      '}',
      "#layer['mapnik::geometry_type'=2] {",
      '  line-color: <%= line.stroke.color.fixed %>;',
      '  line-width: <%= line.stroke.size.fixed %>;',
      '  line-opacity: 1;',
      '}',
      "#layer['mapnik::geometry_type'=3] {",
      '  polygon-fill: <%= polygon.fill.color.fixed %>;',
      '  polygon-opacity: <%= polygon.fill.color.opacity %>;',
      '  polygon-gamma: 0.5;',
      '  line-color: <%= polygon.stroke.color.fixed%>;',
      '  line-width: <%= polygon.stroke.size.fixed %>;',
      '  line-opacity: <%= polygon.stroke.color.opacity %>;',
      '  line-comp-op: soft-light;',
      '}'
    ].join('\n'))(DefaultCartography.simple);
  },

  isValidInputGeometryForType: function (simpleGeometryType, analysisType) {
    var validGeometries = this.getValidInputGeometriesForType(analysisType);
    return _.contains(validGeometries, simpleGeometryType) || _.contains(validGeometries, '*');
  },

  getValidInputGeometriesForType: function (analysisType) {
    var params = this.paramsForType(analysisType);

    var geometries = [];

    for (var name in params) {
      var param = params[name];
      if (param.type === 'node') {
        geometries = _.union(geometries, param.geometry);
      }
    }

    return geometries;
  }
};

},{"./default-cartography.json":346,"camshaft-reference":"camshaft-reference","underscore":"underscore"}],342:[function(require,module,exports){
var Backbone = require('backbone');

module.exports = Backbone.Model.extend({
  idAttribute: 'name'
});

},{"backbone":"backbone"}],343:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

/**
 * Model for general frontend configuration.
 * Ported from old cdb.config, since we can't reuse the older model that's tied to v3 of cartodb.js
 *
 * Also, rather than putting it as a global object, it's intended to be instantiated at the entry point and passed as
 * a collaborator object the models that needs it, e.g.:
 * var myModel = new MyModel({ id: 123,  }, {
 *   configModel: configModel
 * })
 */
module.exports = Backbone.Model.extend({

  defaults: {
    base_url: '/CHANGEME' // expected to be set when model is created
  },

  urlVersion: function (modelName, method, defaultVersion) {
    method = method || '';
    var version = this.get(modelName + '_' + method + '_url_version');
    return version || defaultVersion || 'v1';
  },

  /**
   * @param {String} [version=v2] Version of API to use
   * @return {String} the full sql api url, including the api endpoint, e.g. http://user.carto.com/api/v2/sql
   */
  getSqlApiUrl: function (version) {
    version = version || 'v2';
    return this._getSqlApiBaseUrl() + '/api/' + version + '/sql';
  },

  /**
   * @return {String} returns the base url to compose the final url, e.g. http://user.carto.com/
   */
  _getSqlApiBaseUrl: function () {
    var url;
    if (this.get('sql_api_template')) {
      url = this.get('sql_api_template').replace('{user}', this.get('user_name'));
    } else {
      url = this.get('sql_api_protocol') + '://' +
        this.get('user_name') + '.' +
        this.get('sql_api_domain') + ':' +
        this.get('sql_api_port');
    }
    return url;
  },

  dataServiceEnabled: function (name) {
    var dataServices = this.get('dataservices_enabled');
    if (!dataServices || !_.size(dataServices) || !name) {
      return false;
    }
    return !!dataServices[name];
  }
});

},{"backbone":"backbone","underscore":"underscore"}],344:[function(require,module,exports){
/* global Image */

var Backbone = require('backbone');
var _ = require('underscore');

module.exports = Backbone.Model.extend({

  getAttributes: function () {
    return JSON.parse(JSON.stringify(this.attributes));
  },

  _generateClassName: function (urlTemplate) {
    if (urlTemplate) {
      return urlTemplate.replace(/\s+/g, '').replace(/[^a-zA-Z_0-9 ]/g, '').toLowerCase();
    } else return '';
  },

  parse: function (data) {
    var attrs = {};

    _.extend(attrs, data.options, {
      id: data.id,
      className: this._generateClassName(data.options.urlTemplate),
      type: 'Tiled',
      order: data.order,
      parent_id: data.parent_id
    });

    return attrs;
  },

  toJSON: function () {
    var layerOptions = _.clone(_.omit(this.attributes, ['order', 'id']));
    var json = {
      kind: 'tiled',
      options: layerOptions,
      order: this.get('order'),
      id: this.id
    };

    return json;
  },

  getValue: function () {
    return this.get('val');
  },

  /**
   * validateTemplateURL - Validates current urlTemplate of layer.
   *
   * @param {Object} callbacks with success and error functions defined to be called depending on validation outcome.
   */
  validateTemplateURL: function (callbacks) {
    var subdomains = ['a', 'b', 'c'];
    var image = new Image();
    image.onload = callbacks.success;
    image.onerror = callbacks.error;
    image.src = this.get('urlTemplate').replace(/\{s\}/g, function () {
      return subdomains[Math.floor(Math.random() * 3)];
    })
      .replace(/\{x\}/g, '0')
      .replace(/\{y\}/g, '0')
      .replace(/\{z\}/g, '0');
  }

});

},{"backbone":"backbone","underscore":"underscore"}],345:[function(require,module,exports){
var Backbone = require('backbone');
var CustomBaselayerModel = require('./custom-baselayer-model');
var checkAndBuildOpts = require('../helpers/required-opts');

var REQUIRED_OPTS = [
  'configModel',
  'currentUserId'
];

module.exports = Backbone.Collection.extend({

  model: function (d, opts) {
    var self = opts.collection;

    var m = new CustomBaselayerModel(d, {
      parse: true,
      collection: self
    });

    return m;
  },

  url: function () {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('user');
    return baseUrl + '/api/' + version + '/users/' + this._currentUserId + '/layers';
  },

  initialize: function (models, opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
  },

  isCustomCategory: function () {
    var custom = this.where(function (mdl) {
      return ['NASA', 'TileJSON', 'WMS', 'Mapbox', 'Custom', undefined].some(function (category) {
        return mdl.get('category') === category;
      });
    });
    return custom;
  },

  getSelected: function () {
    return this.findWhere({ selected: true });
  },

  hasCustomBaseLayer: function (className) {
    if (!className) return;

    var customBaseLayer = this.where({ className: className });

    return customBaseLayer.length > 0;
  }

});

},{"../helpers/required-opts":432,"./custom-baselayer-model":344,"backbone":"backbone"}],346:[function(require,module,exports){
module.exports={
  "simple": {

    "point": {
      "fill": {
        "size": {
          "fixed": 7
        },
        "color": {
          "fixed": "#FFB927",
          "opacity": 0.9
        }
      },
      "stroke": {
        "size": {
          "fixed": 1
        },
        "color": {
          "fixed": "#FFF",
          "opacity": 1
        }
      }
    },

    "line": {
      "fill": {},
      "stroke": {
        "size": {
          "fixed": 1.5
        },
        "color": {
          "fixed": "#3EBCAE",
          "opacity": 1
        }
      }
    },

    "polygon": {
      "fill": {
        "color": {
          "fixed": "#374C70",
          "opacity": 0.9
        }
      },
      "stroke": {
        "size": {
          "fixed": 1
        },
        "color": {
          "fixed": "#FFF",
          "opacity": 0.5
        }
      }
    }
  }
}

},{}],347:[function(require,module,exports){
module.exports={
  "fill": {
    "size": {
      "fixed": 7
    },
    "color": {
      "fixed": "#FFB927",
      "opacity": 0.9
    }
  },
  "stroke": {
    "size": {
      "fixed": 1
    },
    "color": {
      "fixed": "#FFF",
      "opacity": 1
    }
  },
  "blending": "none",
  "aggregation": {},
  "labels": {
    "enabled": false,
    "attribute": null,
    "font": "DejaVu Sans Book",
    "fill": {
      "size": {
        "fixed": 10
      },
      "color": {
        "fixed": "#FFFFFF",
        "opacity": 1
      }
    },
    "halo": {
      "size": {
        "fixed": 1
      },
      "color": {
        "fixed": "#6F808D",
        "opacity": 1
      }
    },
    "offset": -10,
    "overlap": true,
    "placement": "point"
  }
}

},{}],348:[function(require,module,exports){
var Backbone = require('backbone');

/**
 * Model for general editor configuration.
 */
module.exports = Backbone.Model.extend({
  defaults: {
    edition: false,
    disabled: false
  },
  isEditing: function () {
    return !!this.get('edition');
  },
  isDisabled: function () {
    return !!this.get('disabled');
  }
});

},{"backbone":"backbone"}],349:[function(require,module,exports){
var MAP = {
  'st_multipolygon': 'polygon',
  'st_polygon': 'polygon',
  'st_multilinestring': 'line',
  'st_linestring': 'line',
  'st_multipoint': 'point',
  'st_point': 'point'
};

/**
 * @param {String} val e.g. 'ST_MultiPoint'
 * @return {String} e.g. 'point'
 */
module.exports = function (val) {
  return MAP[val.toLowerCase()];
};

},{}],350:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var syncAbort = require('./backbone/sync-abort');
var UserModel = require('./user-model');
var GroupModel = require('./group-model');

/**
 * A collection of Grantable objects.
 */
module.exports = Backbone.Collection.extend({

  model: function (attrs, options) {
    var type = attrs.type;
    var configModel = attrs.configModel;
    options = _.extend(options, {
      configModel: configModel
    });

    if (attrs.model) {
      attrs = _.extend({}, attrs, attrs.model);
    }

    if (type === 'user') {
      return new UserModel(_.omit(attrs, 'configModel'), options);
    } else if (type === 'group') {
      return new GroupModel(_.omit(attrs, 'configModel'), options);
    }
  },

  sync: syncAbort,

  url: function (method) {
    var baseUrl = this.configModel.get('base_url');
    var version = this.configModel.urlVersion('organizationGrantables', method);
    return baseUrl + '/api/' + version + '/organization/' + this.organization.id + '/grantables';
  },

  initialize: function (users, opts) {
    if (!opts.organization) throw new Error('Organization is required');
    if (!opts.currentUserId) throw new Error('currentUserId is required');
    if (!opts.configModel) throw new Error('configModel is required');

    this.configModel = opts.configModel;
    this.organization = opts.organization;
    this.currentUserId = opts.currentUserId;
  },

  parse: function (response) {
    this.trigger('fetched', this);
    this.total_entries = response.total_entries;

    return _.reduce(response.grantables, function (memo, m) {
      if (m.id === this.currentUserId) {
        this.total_entries--;
      } else {
        m.organization = this.organization;
        m.configModel = this.configModel;
        memo.push(m);
      }
      return memo;
    }, [], this);
  },

  fetch: function (opts) {
    opts = opts || {};
    this.trigger('fetching', this);
    opts.error = function (model, response) {
      this.trigger('error', this);
    }.bind(this);

    return Backbone.Collection.prototype.fetch.call(this, opts);
  },

  totalCount: function () {
    return this.total_entries;
  }

});

},{"./backbone/sync-abort":337,"./group-model":351,"./user-model":373,"backbone":"backbone","underscore":"underscore"}],351:[function(require,module,exports){
var Backbone = require('backbone');
var UsersGroup = require('./users-group-collection');

/**
 * Model representing a group.
 * Expected to be used in the context of a groups collection (e.g. OrganizationGroups),
 * which defines its API endpoint path.
 */

module.exports = Backbone.Model.extend({

  defaults: {
    display_name: ''
  },

  initialize: function (attrs, opts) {
    this.parse(attrs || {}, opts); // handle given attrs in the same way as for .fetch()
  },

  parse: function (attrs, opts) {
    this.users = new UsersGroup(attrs.users, {
      group: this,
      configModel: opts.configModel,
      organization: opts.organization
    });

    return attrs;
  }
});

},{"./users-group-collection":375,"backbone":"backbone"}],352:[function(require,module,exports){
var InfowindowDefinitionModel = require('./infowindow-definition-model');

module.exports = InfowindowDefinitionModel.extend({

  defaults: {
    template_name: '',
    latlng: [0, 0],
    offset: [28, 0], // offset of the tip calculated from the bottom left corner
    maxHeight: 180, // max height of the content, not the whole infowindow
    autoPan: true,
    template: '',
    content: '',
    visibility: false,
    alternative_names: { },
    fields: null, // contains the fields displayed in the infowindow,
    width: 226,
    headerColor: {
      color: {
        fixed: '#35AAE5',
        opacity: 1
      }
    }
  },

  TEMPLATES: {
    infowindow_light: require('../mustache-templates/infowindows/infowindow_light.jst.mustache'),
    infowindow_dark: require('../mustache-templates/infowindows/infowindow_dark.jst.mustache'),
    infowindow_color: require('../mustache-templates/infowindows/infowindow_color.jst.mustache'),
    infowindow_header_with_image: require('../mustache-templates/infowindows/infowindow_header_with_image.jst.mustache'),
    custom_infowindow_light: require('../mustache-templates/infowindows_custom/infowindow_light.jst.mustache'),
    custom_infowindow_dark: require('../mustache-templates/infowindows_custom/infowindow_dark.jst.mustache'),
    custom_infowindow_color: require('../mustache-templates/infowindows_custom/infowindow_color.jst.mustache'),
    custom_infowindow_header_with_image: require('../mustache-templates/infowindows_custom/infowindow_header_with_image.jst.mustache')
  },

  _transformTemplate: function (template) {
    var fixed = this.get('headerColor').color.fixed;

    return template.replace('background: #35AAE5', 'background: ' + fixed);
  },

  setTemplate: function (templateName) {
    var template = (typeof (this.TEMPLATES[templateName]) === 'undefined') ? '' : this.TEMPLATES[templateName];

    if (templateName === 'infowindow_color') {
      template = this._transformTemplate(template);
    }

    var attrs = {
      'template_name': templateName,
      'template': template,
      'template_type': 'mustache'
    };

    if (templateName === '') {
      attrs.fields = [];
    }

    this.set(attrs);
  },

  isEmptyTemplate: function () {
    var isEmpty = this.fieldCount() === 0;
    return this.hasTemplate() && isEmpty;
  },

  setDefault: function () {
    this.setTemplate(this.defaults.template_name);
  }

});

},{"../mustache-templates/infowindows/infowindow_color.jst.mustache":436,"../mustache-templates/infowindows/infowindow_dark.jst.mustache":437,"../mustache-templates/infowindows/infowindow_header_with_image.jst.mustache":438,"../mustache-templates/infowindows/infowindow_light.jst.mustache":439,"../mustache-templates/infowindows_custom/infowindow_color.jst.mustache":440,"../mustache-templates/infowindows_custom/infowindow_dark.jst.mustache":441,"../mustache-templates/infowindows_custom/infowindow_header_with_image.jst.mustache":442,"../mustache-templates/infowindows_custom/infowindow_light.jst.mustache":443,"./infowindow-definition-model":353}],353:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var $ = require('jquery');

module.exports = Backbone.Model.extend({

  SYSTEM_COLUMNS: ['the_geom', 'the_geom_webmercator', 'created_at', 'updated_at', 'cartodb_id', 'cartodb_georef_status'],

  TEMPLATES: {},

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;
  },

  clearFields: function () {
    this.set({ 'fields': [] });
  },

  saveFields: function (where) {
    where = where || 'old_fields';
    this.set(where, _.clone(this.get('fields')));
  },

  fieldCount: function () {
    var fields = this.get('fields');
    if (!fields) return 0;
    return fields.length;
  },

  restoreFields: function (whiteList, from) {
    from = from || 'old_fields';
    var fields = this.get(from);
    if (whiteList) {
      fields = fields.filter(function (f) {
        return _.contains(whiteList, f.name);
      });
    }
    if (fields && fields.length) {
      this._setFields(fields);
    }
    this.unset(from);
  },

  containsField: function (fieldName) {
    var fields = this.get('fields') || [];
    return _.contains(_(fields).pluck('name'), fieldName);
  },

  getFieldProperty: function (fieldName, k) {
    if (this.containsField(fieldName)) {
      var fields = this.get('fields') || [];
      var idx = _.indexOf(_(fields).pluck('name'), fieldName);
      return fields[idx][k];
    }
    return null;
  },

  setFieldProperty: function (fieldName, k, v) {
    if (this.containsField(fieldName)) {
      var fields = this._cloneFields() || [];
      var idx = _.indexOf(_(fields).pluck('name'), fieldName);
      fields[idx][k] = v;
      this._setFields(fields);
    }
    return this;
  },

  _cloneFields: function () {
    return _(this.get('fields')).map(function (v) {
      return _.clone(v);
    });
  },

  _setFields: function (f) {
    f.sort(function (a, b) { return a.position - b.position; });
    this.set({ 'fields': f });
  },

  sortFields: function () {
    this.get('fields').sort(function (a, b) { return a.position - b.position; });
  },

  _addField: function (fieldName, at) {
    var dfd = $.Deferred();
    if (!this.containsField(fieldName)) {
      var fields = this.get('fields');

      if (fields) {
        at = at === undefined ? fields.length : at;
        fields.push({ name: fieldName, title: true, position: at });
      } else {
        at = at === undefined ? 0 : at;
        this.set('fields', [{ name: fieldName, title: true, position: at }], { silent: true });
      }
    }
    dfd.resolve();
    return dfd.promise();
  },

  addField: function (fieldName, at) {
    var self = this;
    $.when(this._addField(fieldName, at)).then(function () {
      self.sortFields();
      self.trigger('add:fields');
      self.trigger('change:fields', self, self.get('fields'));
      self.trigger('change', self);
    });
    return this;
  },

  removeField: function (fieldName) {
    if (this.containsField(fieldName)) {
      var fields = this._cloneFields() || [];
      var idx = _.indexOf(_(fields).pluck('name'), fieldName);
      if (idx >= 0) {
        fields.splice(idx, 1);
      }
      this._setFields(fields);
      this.trigger('remove:fields');
    }
    return this;
  },

  getAlternativeName: function (fieldName) {
    return this.get('alternative_names') && this.get('alternative_names')[fieldName];
  },

  setAlternativeName: function (fieldName, alternativeName) {
    var alternativeNames = _.clone(this.get('alternative_names') || {});

    alternativeNames[fieldName] = alternativeName;
    this.set({ 'alternative_names': alternativeNames });
    this.trigger('change:alternative_names');
  },

  getFieldPos: function (fieldName) {
    var p = this.getFieldProperty(fieldName, 'position');
    if (p === undefined) {
      return Number.MAX_VALUE;
    }
    return p;
  },

  unsetTemplate: function () {
    this.setTemplate('');
  },

  setTemplate: function (templateName) {
    var template = (typeof (this.TEMPLATES[templateName]) === 'undefined') ? '' : this.TEMPLATES[templateName];

    var attrs = {
      'template_name': templateName,
      'template': template,
      'template_type': 'mustache'
    };

    if (templateName === '') {
      attrs.fields = [];
    }

    this.set(attrs);
  },

  getTemplate: function () {
    var template_name = this.get('template_name');

    if (template_name !== '') {
      return this.TEMPLATES['custom_' + template_name];
    } else {
      return this.get('template');
    }
  },

  hasTemplate: function () {
    return !!this.get('template_name') && this.TEMPLATES[this.get('template_name')];
  },

  isCustomTemplate: function () {
    return this.get('template_name') === '' && this.get('template') !== '';
  }

});

},{"backbone":"backbone","jquery":"jquery","underscore":"underscore"}],354:[function(require,module,exports){
var InfowindowDefinitionModel = require('./infowindow-definition-model');

module.exports = InfowindowDefinitionModel.extend({

  defaults: {
    vertical_offset: 0,
    horizontal_offset: 0,
    position: 'top|center',
    template_name: '',
    template: ''
  },

  TEMPLATES: {
    tooltip_dark: require('../mustache-templates/tooltips/tooltip_dark.jst.mustache'),
    tooltip_light: require('../mustache-templates/tooltips/tooltip_light.jst.mustache'),
    custom_tooltip_dark: require('../mustache-templates/tooltips_custom/tooltip_dark.jst.mustache'),
    custom_tooltip_light: require('../mustache-templates/tooltips_custom/tooltip_light.jst.mustache')
  },

  setDefault: function () {
    this.setTemplate(this.defaults.template_name);
  }

});

},{"../mustache-templates/tooltips/tooltip_dark.jst.mustache":444,"../mustache-templates/tooltips/tooltip_light.jst.mustache":445,"../mustache-templates/tooltips_custom/tooltip_dark.jst.mustache":446,"../mustache-templates/tooltips_custom/tooltip_light.jst.mustache":447,"./infowindow-definition-model":353}],355:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var syncAbort = require('./backbone/sync-abort');
var StyleDefinitionModel = require('../editor/style/style-definition-model');
var StyleCartoCSSModel = require('../editor/style/style-cartocss-model');
var DataSQLModel = require('../editor/layers/layer-content-views/data/data-sql-model');
var layerTypesAndKinds = require('./layer-types-and-kinds');
var InfowindowModel = require('./infowindow-click-model');
var TooltipModel = require('./infowindow-hover-model');
var TableNameUtils = require('../helpers/table-name-utils');

// from_layer_id and from_letter are not attributes for the model, but are sent to the layer creation
// endpoint when creating a layer from an existing analysis node (see user-actions)
var OWN_ATTR_NAMES = ['id', 'order', 'infowindow', 'tooltip', 'error', 'from_layer_id', 'from_letter'];

/**
 * Model to edit a layer definition.
 * Should always exist as part of a LayerDefinitionsCollection, so its URL is given from there.
 */
module.exports = Backbone.Model.extend({

  /**
   * @override {Backbone.prototype.sync} abort ongoing request if there is any
   */
  sync: syncAbort,

  parse: function (r, opts) {
    r.options = r.options || {};

    // Flatten the attrs, to avoid having this.get('options').foobar internally
    var attrs = _
      .defaults(
        _.pick(r, OWN_ATTR_NAMES),
        _.omit(r.options, ['query', 'tile_style'])
    );

    // Only use type on the frontend, it will be mapped back when the model is serialized (see .toJSON)
    attrs.type = attrs.type || layerTypesAndKinds.getType(r.kind);

    // Map API endpoint attrs to the new names used client-side (cartodb.js in particular)
    if (r.options.tile_style) {
      attrs.cartocss = r.options.tile_style;
    }
    if (r.options.query) {
      attrs.sql = r.options.query;
    }

    if (r.infowindow) {
      if (!this.infowindowModel) {
        this.infowindowModel = new InfowindowModel(r.infowindow, {
          configModel: opts.configModel || this._configModel
        });
      }
    }
    if (r.tooltip) {
      if (!this.tooltipModel) {
        this.tooltipModel = new TooltipModel(r.tooltip, {
          configModel: opts.configModel || this._configModel
        });
      }
    }
    if (r.options.table_name) {
      // Set autostyle as false if it doesn't contain any id
      attrs.autoStyle = attrs.autoStyle || false;

      if (!this.styleModel) {
        this.styleModel = new StyleDefinitionModel(r.options.style_properties, {
          parse: true
        });

        this.cartocssModel = new StyleCartoCSSModel({
          content: attrs.cartocss
        }, {
          history: r.options.cartocss_history || r.options.tile_style_history
        });
      }

      if (!this.sqlModel) {
        this.sqlModel = new DataSQLModel({
          content: attrs.sql
        }, {
          history: r.options.sql_history
        });
      }
    }

    // Flatten the rest of the attributes
    return attrs;
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;

    this.on('change:source change:sql', this._onPosibleLayerSchemaChanged, this);

    if (this.styleModel) {
      this.styleModel.bind('change:type change:animated', function () {
        if (this.styleModel.isAggregatedType() || this.styleModel.isAnimation()) {
          // setTemplate will clear fields
          this.infowindowModel && this.infowindowModel.unsetTemplate();
          this.tooltipModel && this.tooltipModel.unsetTemplate();
        }
      }, this);
    }
  },

  save: function (attrs, options) {
    // We assume that if the layer is saved, we have to disable autostyle
    var autoStyleAttrs = {
      autoStyle: false
    };

    // But if the layer is saved with shouldPreserveAutoStyle option, we should preserve autostyle
    if (options && options.shouldPreserveAutoStyle) {
      delete autoStyleAttrs.autoStyle;
    } else if (this.get('autoStyle')) {
      this.styleModel && this.styleModel.resetPropertiesFromAutoStyle();
    }

    attrs = _.extend(
      {},
      autoStyleAttrs,
      attrs
    );

    return Backbone.Model.prototype.save.apply(this, [attrs, options]);
  },

  toJSON: function () {
    // Un-flatten the internal attrs to the datastructure that's expected by the API endpoint
    var options = _.omit(this.attributes, OWN_ATTR_NAMES.concat(['cartocss', 'sql', 'autoStyle']));

    // Map back internal attrs to the expected attrs names by the API endpoint
    var cartocss = this.get('cartocss');

    if (cartocss) {
      options.tile_style = cartocss;
    }
    var sql = this.get('sql');
    if (sql) {
      options.query = sql;
    }

    var d = {
      kind: layerTypesAndKinds.getKind(this.get('type')),
      options: options
    };

    var infowindowData = this.infowindowModel && this.infowindowModel.toJSON();
    if (!_.isEmpty(infowindowData)) {
      d.infowindow = this.infowindowModel.toJSON();
    }

    var tooltipData = this.tooltipModel && this.tooltipModel.toJSON();
    if (!_.isEmpty(tooltipData)) {
      d.tooltip = this.tooltipModel.toJSON();
    }

    if (this.styleModel && !this.styleModel.isAutogenerated()) {
      d.options.style_properties = this.styleModel.toJSON();
    }

    if (this.cartocssModel) {
      d.options.cartocss_history = this.cartocssModel.getHistory();
    }

    if (this.sqlModel) {
      d.options.sql_history = this.sqlModel.getHistory();
    }

    var attributes = _.omit(this.attributes, 'infowindow', 'tooltip', 'options', 'error', 'autoStyle');

    return _.defaults(
      d,
      _.pick(attributes, OWN_ATTR_NAMES)
    );
  },

  canBeDeletedByUser: function () {
    return this.collection.getNumberOfDataLayers() > 1 && this.isDataLayer() &&
      (this._canBeFoldedUnderAnotherLayer() || !this._isAllDataLayersDependingOnAnyAnalysisOfThisLayer());
  },

  isOwnerOfAnalysisNode: function (nodeModel) {
    return nodeModel && nodeModel.letter() === this.get('letter');
  },

  ownedPrimaryAnalysisNodes: function () {
    var nodeDefModel = this.getAnalysisDefinitionNodeModel();
    return this.isOwnerOfAnalysisNode(nodeDefModel)
      ? nodeDefModel.linkedListBySameLetter()
      : [];
  },

  getName: function () {
    return this.get('name') ||
    this.get('table_name_alias') ||
    this.get('table_name');
  },

  getTableName: function () {
    return this.get('table_name') || '';
  },

  containsNode: function (other) {
    var nodeDefModel = this.getAnalysisDefinitionNodeModel();
    return nodeDefModel && nodeDefModel.containsNode(other);
  },

  getAnalysisDefinitionNodeModel: function () {
    return this.findAnalysisDefinitionNodeModel(this.get('source'));
  },

  findAnalysisDefinitionNodeModel: function (id) {
    return this.collection && this.collection.findAnalysisDefinitionNodeModel(id);
  },

  _onPosibleLayerSchemaChanged: function (eventName, attrs, options) {
    // Used to avoid resetting styles on source_id changes when we have saved styles for the node
    if (options && options.ignoreSchemaChange) {
      return;
    }

    if (this.infowindowModel) {
      this.infowindowModel.clearFields();
    }
    if (this.tooltipModel) {
      this.tooltipModel.clearFields();
    }
    if (this.styleModel) {
      this.styleModel.resetStyles();
    }
  },

  toggleVisible: function () {
    this.set('visible', !this.get('visible'));
  },

  toggleCollapse: function () {
    this.set('collapsed', !this.get('collapsed'));
  },

  hasAnalyses: function () {
    return this.getNumberOfAnalyses() > 0;
  },

  getNumberOfAnalyses: function () {
    var analysisNode = this.getAnalysisDefinitionNodeModel();
    var count = 0;

    while (analysisNode && this.isOwnerOfAnalysisNode(analysisNode)) {
      analysisNode = analysisNode.getPrimarySource();

      if (analysisNode) {
        count += 1;
      }
    }

    return count;
  },

  getQualifiedTableName: function () {
    var userName = this.get('user_name') || this.collection.userModel.get('username');
    return TableNameUtils.getQualifiedTableName(
      this.getTableName(),
      userName,
      this.collection.userModel.isInsideOrg()
    );
  },

  getColumnNamesFromSchema: function () {
    return this._getQuerySchemaModel().getColumnNames();
  },

  _getQuerySchemaModel: function () {
    var nodeDefModel = this.getAnalysisDefinitionNodeModel();
    return nodeDefModel.querySchemaModel;
  },

  isDataLayer: function () {
    var layerType = this.get('type');
    return layerTypesAndKinds.isCartoDBType(layerType) ||
      layerTypesAndKinds.isTorqueType(layerType);
  },

  isTorqueLayer: function () {
    return this.get('type') === 'torque';
  },

  _canBeFoldedUnderAnotherLayer: function () {
    var thisNodeDefModel = this.getAnalysisDefinitionNodeModel();

    return this.collection.any(function (m) {
      if (m !== this && m.isDataLayer()) {
        var otherNodeDefModel = m.getAnalysisDefinitionNodeModel();
        if (otherNodeDefModel === thisNodeDefModel) return true;

        var lastNode = _.last(otherNodeDefModel.linkedListBySameLetter());
        return lastNode.getPrimarySource() === thisNodeDefModel;
      }
    }, this);
  },

  _isAllDataLayersDependingOnAnyAnalysisOfThisLayer: function () {
    var nodeDefModel = this.getAnalysisDefinitionNodeModel();
    if (!nodeDefModel) return false;
    if (!this.isOwnerOfAnalysisNode(nodeDefModel)) return false;

    var linkedNodesList = nodeDefModel.linkedListBySameLetter();

    return this.collection.chain()
      .filter(function (m) {
        return m !== this && !!m.get('source');
      }, this)
      .all(function (m) {
        return _.any(linkedNodesList, function (node) {
          return m.containsNode(node);
        });
      }, this)
      .value();
  },

  getAllDependentLayers: function () {
    var self = this;
    var layersCount = 0;

    var layerDefinitionsCollectionModels = self.collection.models;

    for (var i = 0; i < layerDefinitionsCollectionModels.length; i++) {
      var layer = layerDefinitionsCollectionModels[i];
      var dependentAnalysis = false;

      if (layer !== self) {
        var analysisNode = layer.getAnalysisDefinitionNodeModel();

        while (analysisNode) {
          if (self.isOwnerOfAnalysisNode(analysisNode)) {
            dependentAnalysis = true;
          }
          analysisNode = analysisNode.getPrimarySource();
        }

        if (dependentAnalysis) {
          layersCount += 1;
        }
      }
    }
    return layersCount;
  },

  matchesAttrs: function (otherAttrs) {
    if (this.get('type') !== otherAttrs.type) {
      return false;
    }

    if (layerTypesAndKinds.isTiledType(otherAttrs.type)) {
      return this.get('name') === otherAttrs.name &&
        this.get('urlTemplate') === otherAttrs.urlTemplate;
    }

    if (layerTypesAndKinds.isGMapsBase(otherAttrs.type)) {
      return this.get('name') === otherAttrs.name &&
        this.get('baseType') === otherAttrs.baseType &&
          this.get('style') === otherAttrs.style;
    }

    if (layerTypesAndKinds.isPlainType(otherAttrs.type)) {
      return this.get('color') === otherAttrs.color;
    }

    return false;
  },

  canBeGeoreferenced: function () {
    var hasGeocodingAnalysisApplied = function () {
      var analysisNode = this.getAnalysisDefinitionNodeModel();

      if (analysisNode && analysisNode.get('type') === 'geocoding') {
        return true;
      }

      while (analysisNode && this.isOwnerOfAnalysisNode(analysisNode)) {
        analysisNode = analysisNode.getPrimarySource();

        if (analysisNode && analysisNode.get('type') === 'geocoding') {
          return true;
        }
      }

      return false;
    }.bind(this);

    var analysisDefinitionNodeModel = this.getAnalysisDefinitionNodeModel();
    return !hasGeocodingAnalysisApplied() &&
           !analysisDefinitionNodeModel.queryGeometryModel.hasValue() &&
           !analysisDefinitionNodeModel.isCustomQueryApplied() &&
           !analysisDefinitionNodeModel.queryRowsCollection.isEmpty();
  }
});

},{"../editor/layers/layer-content-views/data/data-sql-model":407,"../editor/style/style-cartocss-model":408,"../editor/style/style-definition-model":416,"../helpers/table-name-utils":434,"./backbone/sync-abort":337,"./infowindow-click-model":352,"./infowindow-hover-model":354,"./layer-types-and-kinds":356,"backbone":"backbone","underscore":"underscore"}],356:[function(require,module,exports){
// Types
var PLAIN = 'Plain';
var CARTODB = 'CartoDB';
var TILED = 'Tiled';
var TORQUE = 'torque';
var GMAPSBASE = 'GMapsBase';
var WMS = 'WMS';

// Values of `kind` attribute that the backend/DB knows about
var KIND_TO_TYPE_MAP = {
  'background': PLAIN,
  'carto': CARTODB,
  'gmapsbase': GMAPSBASE,
  'tiled': TILED,
  'torque': TORQUE,
  'wms': WMS
};

module.exports = {
  getType: function (kind) {
    var type = KIND_TO_TYPE_MAP[kind];

    if (!type) {
      throw new Error('no type found for given kind ' + kind);
    }

    return type;
  },

  getKind: function (type) {
    if (!type) {
      throw new Error('no kind found for given type ' + type);
    }

    var kind;
    for (kind in KIND_TO_TYPE_MAP) {
      if (KIND_TO_TYPE_MAP[kind] === type) {
        break;
      }
    }

    return kind;
  },

  isKindDataLayer: function (kind) {
    var type = KIND_TO_TYPE_MAP[kind];
    return this.isTypeDataLayer(type);
  },

  isTypeDataLayer: function (type) {
    return this.isCartoDBType(type) || this.isTorqueType(type);
  },

  isCartoDBType: function (type) {
    return type === CARTODB;
  },

  isTorqueType: function (type) {
    return type === TORQUE;
  },

  isTiledType: function (type) {
    return type === TILED;
  },

  isPlainType: function (type) {
    return type === PLAIN;
  },

  isGMapsBase: function (type) {
    return type === GMAPSBASE;
  }
};

},{}],357:[function(require,module,exports){
var Backbone = require('backbone');
var AssetModel = require('./asset-model');
var checkAndBuildOpts = require('../helpers/required-opts');

var REQUIRED_OPTS = [
  'configModel',
  'orgId'
];

module.exports = Backbone.Collection.extend({
  model: AssetModel,

  url: function (method) {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('organization-assets', method);
    return baseUrl + '/api/' + version + '/organization/' + this._orgId + '/assets';
  },

  initialize: function (models, opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
  },

  deselectAll: function (m) {
    this.each(function (mdl) {
      if (mdl !== m && mdl.get('state') === 'selected') {
        mdl.set('state', '');
      }
    });
  }

});

},{"../helpers/required-opts":432,"./asset-model":335,"backbone":"backbone"}],358:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

/**
 *  Organization info model
 *
 */
module.exports = Backbone.Model.extend({

  url: function () {
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/v1/org';
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;

    if (!_.isEmpty(this.get('owner'))) {
      this._ownerModel = new Backbone.Model(
        _.omit(this.get('owner'), 'organization')
      );
    }
  },

  getOwnerId: function () {
    return this._ownerModel && this._ownerModel.get('id');
  },

  getOwnerEmail: function () {
    return this._ownerModel && this._ownerModel.get('email');
  },

  isOrgAdmin: function (user) {
    return this.getOwnerId() === user.get('id') || !!_.find(this.get('admins'), function (u) {
      return u.id === user.get('id');
    });
  }
});

},{"backbone":"backbone","underscore":"underscore"}],359:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var Utils = require('../helpers/utils');
var UserModel = require('./user-model');
var OrganizationModel = require('./organization-model');
var GroupModel = require('./group-model');
var ACLItemModel = require('./acl-item-model');
var READ_ONLY = 'r';
var READ_WRITE = 'rw';

/**
 * manages a cartodb permission object, it contains:
 * - owner: an UserModel instance
 * - acl: a collection which includes the user and their permission.
 *
 *   see https://github.com/Vizzuality/cartodb-management/wiki/multiuser-REST-API#permissions-object
 *
 *   this object is not created to work alone, it should be a member of
 *   an object like visualization table
 *
 */
var PermissionModel = module.exports = Backbone.Model.extend({
  urlRoot: function () {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('perm');
    return baseUrl + '/api/' + version + '/perm';
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;
    this.acl = new Backbone.Collection();
    this.owner = opts._userModel;
    this._generateOwner();
    this._generateAcl();
    this._initBinds();
  },

  _initBinds: function () {
    this.bind('change:owner', this._generateOwner, this);
    this.bind('change:acl', this._generateAcl, this);
  },

  _generateOwner: function () {
    if (!this.owner) {
      this.owner = new UserModel(null, {
        configModel: this._configModel
      });
    }
    this.owner.set(this.get('owner'));
  },

  getOwner: function () {
    return this.owner;
  },

  _generateAcl: function () {
    var self = this;
    this.acl.reset([], { silent: true });
    _.each(this.get('acl'), function (aclItem) {
      var model;
      switch (aclItem.type) {
        case 'user':
          model = new UserModel(aclItem.entity, {
            configModel: self._configModel
          });
          break;
        case 'org':
          model = new OrganizationModel(aclItem.entity, {
            configModel: self._configModel
          });
          break;
        case 'group':
          model = new GroupModel(aclItem.entity, {
            configModel: self._configModel
          });
          break;
        default:
          throw new Error('Unknown ACL item type: ' + aclItem.type);
      }
      this._grantAccess(model, aclItem.access);
    }, this);
  },

  cleanPermissions: function () {
    this.acl.reset();
  },

  hasAccess: function (model) {
    // Having at least read access is the same as having any access
    return this.hasReadAccess(model);
  },

  hasReadAccess: function (model) {
    // If there is a representable ACL item it must be one of at least READ_ONLY access
    return !!this.findRepresentableAclItem(model);
  },

  hasWriteAccess: function (model) {
    var access = Utils.result(this.findRepresentableAclItem(model), 'get', 'access');
    return access === READ_WRITE;
  },

  canChangeReadAccess: function (model) {
    return this._canChangeAccess(model);
  },

  canChangeWriteAccess: function (model) {
    return (!model.isBuilder || model.isBuilder()) && this._canChangeAccess(model, function (representableAclItem) {
      return Utils.result(representableAclItem, 'get', 'access') !== READ_WRITE;
    });
  },

  _canChangeAccess: function (model) {
    var representableAclItem = this.findRepresentableAclItem(model);
    return this.isOwner(model) || !representableAclItem ||
    representableAclItem === this._ownAclItem(model) || Utils.result(arguments, 1, representableAclItem) || false;
  },

  grantWriteAccess: function (model) {
    this._grantAccess(model, READ_WRITE);
  },

  grantReadAccess: function (model) {
    this._grantAccess(model, READ_ONLY);
  },

  revokeWriteAccess: function (model) {
    // Effectively "downgrades" to READ_ONLY
    this.grantReadAccess(model);
  },

  /**
   * Revokes access to a set of items
   * @param {Object} model A single model or an array of models
   */
  revokeAccess: function (model) {
    var aclItem = this._ownAclItem(model);
    if (aclItem) {
      this.acl.remove(aclItem);
    }
  },

  isOwner: function (model) {
    return _.result(this.owner, 'id') === _.result(model, 'id');
  },

  toJSON: function () {
    return {
      entity: this.get('entity'),
      acl: this.acl.toJSON()
    };
  },

  getUsersWithAnyPermission: function () {
    return this.acl.chain()
      .filter(this._hasTypeUser)
      .map(this._getEntity)
      .value();
  },

  isSharedWithOrganization: function () {
    return this.acl.any(this._hasTypeOrg);
  },

  clone: function () {
    var attrs = _.clone(this.attributes);
    delete attrs.id;
    return new PermissionModel(attrs, {
      configModel: this._configModel
    });
  },

  /**
   * Overwrite this ACL list from other permission object
   * @param otherPermission {Object} instance of PermissionModel
   */
  overwriteAcl: function (otherPermission) {
    this.acl.reset(otherPermission.acl.models);
  },

  // Note that this may return an inherited ACL item
  // use ._ownAclItem instead if only model's own is wanted (if there is any)
  findRepresentableAclItem: function (model) {
    if (this.isOwner(model)) {
      return this._newAclItem(model, READ_WRITE);
    } else {
      var checkList = ['_ownAclItem', '_organizationAclItem', '_mostPrivilegedGroupAclItem'];
      return this._findMostPrivilegedAclItem(checkList, function (fnName) {
        return this[fnName](model);
      });
    }
  },

  _hasTypeUser: function (m) {
    return m.get('type') === 'user';
  },

  _getEntity: function (m) {
    return m.get('entity');
  },

  _hasTypeOrg: function (m) {
    return m.get('type') === 'org';
  },

  _isOrganization: function (object) {
    return object instanceof OrganizationModel;
  },

  _ownAclItem: function (model) {
    if (!model || !_.isFunction(model.isNew)) {
      console.log('model is required to find an ACL item');
    }
    if (!model.isNew()) {
      return this.acl.find(function (aclItem) {
        return aclItem.get('entity').id === model.id;
      });
    }
  },

  _organizationAclItem: function (m) {
    var org = _.result(m.collection, 'organization') || m.organization;
    if (org) {
      return this._ownAclItem(org);
    }
  },

  _mostPrivilegedGroupAclItem: function (m) {
    var groups = _.result(m.groups, 'models');
    if (groups) {
      return this._findMostPrivilegedAclItem(groups, this._ownAclItem);
    }
  },

  /**
   * Iterates over a items in given list using the iteratee, stops and returns when found the ACL item with best access (i.e. READ_WRITE), or the
   * list is completed.
   * @param {Array} list
   * @param {Function} iteratee that takes an item from list and returns an access
   *   iteratee is called in context of this model.
   * @Return {String} 'r', 'rw', or undefined if there were no access for given item
   */
  _findMostPrivilegedAclItem: function (list, iteratee) {
    var aclItem;
    for (var i = 0, x = list[i]; x && Utils.result(aclItem, 'get', 'access') !== READ_WRITE; x = list[++i]) {
      // Keep last ACL item if iteratee returns nothing
      aclItem = iteratee.call(this, x) || aclItem;
    }
    return aclItem;
  },

  /**
   * Grants access to a set of items
   * @param {Object} model
   * @param {String} access can take the following values:
   * - 'r': read only
   * - 'rw': read and write permission
   */
  _grantAccess: function (model, access) {
    var aclItem = this._ownAclItem(model);
    if (aclItem) {
      aclItem.set('access', access);
    } else {
      aclItem = this._newAclItem(model, access);
      if (aclItem.isValid()) {
        this.acl.add(aclItem);
      } else {
        throw new Error(access + ' is not a valid ACL access');
      }
    }
  },

  _newAclItem: function (model, access) {
    var type;
    if (model instanceof UserModel) {
      type = 'user';
    } else if (model instanceof GroupModel) {
      type = 'group';
    } else if (this._isOrganization(model)) {
      type = 'org';
    } else {
      throw new Error('model not recognized as a valid ACL entity ' + model);
    }

    return new ACLItemModel({
      type: type,
      entity: model,
      access: access
    });
  }
});

exports.READ_ONLY = READ_ONLY;
exports.READ_WRITE = READ_WRITE;

},{"../helpers/utils":435,"./acl-item-model":332,"./group-model":351,"./organization-model":358,"./user-model":373,"backbone":"backbone","underscore":"underscore"}],360:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var DEACTIVATE_MATRIX = {
  'number': ['date'],
  'boolean': ['date'],
  'date': ['boolean']
};
var DESTRUCTIVE_MATRIX = {
  'string': {
    'string': false,
    'number': true,
    'date': true,
    'boolean': true
  },
  'number': {
    'string': false,
    'number': false,
    'date': true,
    'boolean': true
  },
  'date': {
    'string': false,
    'number': true,
    'date': false,
    'boolean': true
  },
  'boolean': {
    'string': false,
    'number': false,
    'date': true,
    'boolean': false
  }
};
var NON_EDITABLE_ATTRIBUTES = [
  'the_geom_webmercator',
  'cartodb_id',
  'the_geom'
];

module.exports = Backbone.Model.extend({

  url: function () {
    if (this._tableName) {
      var baseUrl = this._configModel.get('base_url');
      var version = this._configModel.urlVersion('column');
      var url = baseUrl + '/api/' + version + '/tables/' + this._tableName + '/columns/';

      if (!this.isNew()) {
        // If name changes, we should point to the "old" name
        // in order to make the correct call
        url += this.previous('name') || this.get('name');
      }

      return url;
    }

    return false;
  },

  parse: function (attrs) {
    return {
      name: attrs.name,
      type: attrs.cartodb_type || attrs.type,
      isNew: false
    };
  },

  initialize: function (models, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._tableName = opts.tableName;
    this._configModel = opts.configModel;
  },

  isNew: function () {
    return this.get('isNew');
  },

  isEditable: function () {
    return !_.contains(NON_EDITABLE_ATTRIBUTES, this.get('name'));
  },

  // This is relative becuase we could set any value to cartodb_id
  isCartoDBIDColumn: function () {
    return this.get('name') === 'cartodb_id' && this.get('type') === 'number';
  },

  isGeometryColumn: function () {
    return this.get('type') === 'geometry';
  }
}, {
  isTypeChangeDestructive: function (type, newType) {
    return DESTRUCTIVE_MATRIX[type][newType];
  },

  isTypeChangeAllowed: function (type, newType) {
    var deactivated = DEACTIVATE_MATRIX[type] || [];
    deactivated = deactivated.concat([type]);
    return !_.contains(deactivated, newType);
  }
});

},{"backbone":"backbone","underscore":"underscore"}],361:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var QueryColumnModel = require('./query-column-model');

module.exports = Backbone.Collection.extend({

  model: function (attrs, opts) {
    var self = opts.collection;
    return new QueryColumnModel(attrs, {
      configModel: self._configModel,
      tableName: self._tableName
    });
  },

  url: function () {
    if (this._tableName) {
      var baseUrl = this._configModel.get('base_url');
      var version = this._configModel.urlVersion('column');
      return baseUrl + '/api/' + version + '/tables/' + this._tableName + '/columns';
    }

    return false;
  },

  initialize: function (models, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.querySchemaModel) throw new Error('querySchemaModel is required');

    this._tableName = opts.tableName;
    this._querySchemaModel = opts.querySchemaModel;
    this._configModel = opts.configModel;
    this._initBinds();
  },

  _initBinds: function () {
    this.bind('add remove change:type change:name', function () {
      this.reset();
      this._querySchemaModel.set('status', 'unfetched');
      this._querySchemaModel.fetch();
    }, this);
    this._querySchemaModel.bind('change:status', function (mdl, status) {
      if (status === 'fetched') {
        this.reset(this._querySchemaModel.columnsCollection.toJSON());
      }
    }, this);
  },

  setTableName: function (name) {
    if (!name) return;

    if (this._tableName) {
      this._tableName = name;

      this.each(function (columnModel) {
        columnModel._tableName = name;
      });
    }
  },

  addColumn: function (opts) {
    opts = opts || {};
    this.create(
      {
        name: 'column_' + new Date().getTime(),
        type: 'string',
        isNew: true
      },
      _.extend(
        opts,
        {
          wait: true,
          parse: false
        }
      )
    );
  }

});

},{"./query-column-model":360,"backbone":"backbone","underscore":"underscore"}],362:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var syncAbort = require('./backbone/sync-abort');
/* eslint-disable */
var template = _.template("" +
"SELECT CASE LOWER(ST_GeometryType(<%= geom_column %>)) " +
"     WHEN 'st_polygon' THEN 'polygon' " +
"     WHEN 'st_multipolygon' THEN 'polygon' " +
"     WHEN 'st_multilinestring' THEN 'line' " +
"     WHEN 'st_linestring' THEN 'line' " +
"     WHEN 'st_multipoint' THEN 'point' " +
"     WHEN 'st_point' THEN 'point' " +
"     ELSE '' " +
"  END AS the_geom FROM (<%= sql %>) __wrapped WHERE <%= geom_column %> IS NOT NULL"
/* eslint-enable */
);

var THE_GEOM_NOT_FOUND_ERROR = 'column \"the_geom\" does not exist';
var MAX_GET_LENGTH = 1024;
var PARAMS = {
  sort_order: 'asc',
  rows_per_page: 40,
  page: 0
};
var STATUS = {
  unavailable: 'unavailable',
  unfetched: 'unfetched',
  fetching: 'fetching',
  fetched: 'fetched'
};

/**
 * Model to represent a schema of a SQL query.
 */
module.exports = Backbone.Model.extend({

  defaults: {
    query: '',
    status: STATUS.unavailable, // , unfetched, fetching, fetched
    simple_geom: '', // , 'point', 'polygon', 'line'
    ready: false // until true there's no data available on the table(s) used in the query
  },

  /**
   * @override {Backbone.prototype.sync} abort ongoing request if there is any
   */
  sync: syncAbort,

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;

    this._addChangeListener();
  },

  url: function () {
    return this._configModel.getSqlApiUrl();
  },

  _addChangeListener: function () {
    this.bind('change', this._onChange, this);
  },

  _removeChangeListener: function () {
    this.unbind('change', this._onChange, this);
  },

  isFetched: function () {
    return this.get('status') === STATUS.fetched;
  },

  isFetching: function () {
    return this.get('status') === STATUS.fetching;
  },

  canFetch: function () {
    return this.hasQuery() && this.get('ready');
  },

  hasQuery: function () {
    return !!this.get('query');
  },

  shouldFetch: function () {
    return this.canFetch() && !this.isFetched() && !this.isFetching();
  },

  resetFetch: function () {
    this.set('status', STATUS.unfetched);
  },

  fetch: function (opts) {
    if (!this.canFetch()) return;

    this.set('status', STATUS.fetching);

    opts = opts || {};
    var errorCallback = opts && opts.error;

    opts.data = _.extend(
      opts.data || {},
      {
        api_key: this._configModel.get('api_key'),
        q: this._getSqlApiQueryParam(opts.geomColumnName)
      },
      PARAMS
    );

    opts.method = this._httpMethod();

    opts.error = function (model, response) {
      if (response && response.statusText !== 'abort') {
        var error = response.responseText ? JSON.parse(response.responseText).error : [];
        // in case we get an error of the_geom does not exists try with the_geom_webmercator to get the geometry type
        if (error.length === 1 && error[0] === THE_GEOM_NOT_FOUND_ERROR) {
          this.fetch(_.extend({}, opts, { geomColumnName: 'the_geom_webmercator' }));
        } else {
          errorCallback && errorCallback(error);
          this.set({
            simple_geom: '',
            query_errors: error,
            status: STATUS.unavailable
          });
        }
      }
    }.bind(this);

    return Backbone.Model.prototype.fetch.call(this, opts);
  },

  parse: function (r) {
    var simpleGeom;

    _.some(r.rows, function (row) {
      return !!(simpleGeom = row.the_geom); // to stop when found a valid simple geom
    });

    return {
      status: STATUS.fetched,
      simple_geom: simpleGeom || ''
    };
  },

  isNew: function () {
    return true; // override Backbone.Model.prototype.isNew for this.destroy() to do its w/o sending a DELETE request
  },

  hasValue: function () {
    return !!this.get('simple_geom');
  },

  _onChange: function () {
    this._removeChangeListener();

    if (!this.hasChanged('status') && this.get('status') === STATUS.fetching) {
      // If it is already fetching just redo the fetch with latest attrs
      // in case the query has changed
      if (this.hasChanged('query')) {
        this.fetch();
      }
    } else if (this.hasChanged('query') || this.hasChanged('ready')) {
      this.set('status', this.get('query') ? STATUS.unfetched : STATUS.unavailable);
    }

    this._addChangeListener();
  },

  _getSqlApiQueryParam: function (geomColumnName) {
    return template({
      geom_column: geomColumnName || 'the_geom',
      sql: this.get('query')
    });
  },

  _httpMethod: function () {
    return this._getSqlApiQueryParam().length > MAX_GET_LENGTH
      ? 'POST'
      : 'GET';
  }

});

},{"./backbone/sync-abort":337,"backbone":"backbone","underscore":"underscore"}],363:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');

module.exports = Backbone.Model.extend({

  // In case that there is already an id attribute
  idAttribute: '__id',

  url: function () {
    if (this._tableName && this._configModel) {
      var baseUrl = this._configModel.get('base_url');
      var version = this._configModel.urlVersion('record');
      var url = baseUrl + '/api/' + version + '/tables/';

      if (this.hasWriteAccess(this._userModel) && !this.isOwner(this._userModel)) {
        var owner = this._permissionModel.getOwner();
        var ownerUsername = owner.get('username');

        url += ownerUsername + '.' + this._tableName + '/records';
      } else {
        url += this._tableName + '/records';
      }

      if (!this.isNew()) {
        url += '/' + this.get('cartodb_id');
      }

      return url;
    }

    return false;
  },

  initialize: function (attrs, opts) {
    this.collection = this.collection || {};

    this._tableName = opts.tableName || this.collection._tableName;
    this._configModel = opts.configModel || this.collection._configModel;
    this._permissionModel = opts.permissionModel || this.collection._permissionModel;
    this._userModel = opts.userModel || this.collection._userModel;

    this._initBinds();
  },

  _initBinds: function () {
    this.bind('error', this._onError, this);
  },

  hasWriteAccess: function (userModel) {
    if (!userModel || !this._permissionModel) {
      return false;
    }
    return this._permissionModel.hasWriteAccess(userModel);
  },

  isOwner: function (userModel) {
    if (!userModel || !this._permissionModel) {
      return false;
    }
    return this._permissionModel.isOwner(userModel);
  },

  isNew: function () {
    return !this.has('cartodb_id');
  },

  isGeomLoaded: function () {
    try {
      JSON.parse(this.get('the_geom'));
      return true;
    } catch (e) {
      return false;
    }
  },

  fetchRowIfGeomIsNotLoaded: function (callback) {
    if (this.isGeomLoaded()) {
      callback();
      return;
    }

    this.fetch({
      success: callback
    });
  },

  _onError: function () {
    this.set(this.previousAttributes());
  },

  sync: function () {
    this.trigger('loading', this);
    Backbone.Model.prototype.sync.apply(this, arguments);
  },

  parse: function (attrs) {
    if (!attrs.__id) {
      attrs.__id = _.uniqueId();
    }
    return attrs;
  },

  toJSON: function () {
    return _.omit(
      this.attributes,
      '__id',
      'the_geom_webmercator'
    );
  }

});

},{"backbone":"backbone","underscore":"underscore"}],364:[function(require,module,exports){
var Backbone = require('backbone');
var QueryRowModel = require('./query-row-model');
var syncAbort = require('./backbone/sync-abort');
var _ = require('underscore');

var MAX_GET_LENGTH = 1024;
var WRAP_SQL_TEMPLATE = 'select <%= selectedColumns %> from (<%= sql %>) __wrapped';

var STATUS = {
  unavailable: 'unavailable',
  unfetched: 'unfetched',
  fetching: 'fetching',
  fetched: 'fetched'
};

module.exports = Backbone.Collection.extend({

  DEFAULT_FETCH_OPTIONS: {
    rows_per_page: 40,
    sort_order: 'asc',
    page: 0
  },

  // Due to a problem how Backbone checks if there is a duplicated model
  // or not, we can't create the model with a function + its necessary options
  model: QueryRowModel,

  sync: syncAbort,

  url: function () {
    return this._configModel.getSqlApiUrl();
  },

  initialize: function (models, opts) {
    opts = opts || {};

    this._tableName = opts.tableName;
    this._querySchemaModel = opts.querySchemaModel;
    this._configModel = opts.configModel;

    this.statusModel = new Backbone.Model({
      status: STATUS.unavailable
    });

    this._initBinds();
  },

  _initBinds: function () {
    this.listenTo(this._querySchemaModel, 'change:query', this._onQuerySchemaQueryChange);
  },

  isFetched: function () {
    return this.statusModel.get('status') === STATUS.fetched;
  },

  isFetching: function () {
    return this.statusModel.get('status') === STATUS.fetching;
  },

  shouldFetch: function () {
    return !this.isFetched() && !this.isFetching() && this.canFetch();
  },

  resetFetch: function () {
    this.statusModel.set('status', STATUS.unfetched);
  },

  isEmpty: function () {
    return this.size() === 0;
  },

  canFetch: function () {
    return !!this._querySchemaModel.get('query') && this._querySchemaModel.get('ready') && this._querySchemaModel.isFetched();
  },

  _onQuerySchemaQueryChange: function () {
    this.statusModel.set('status', 'unfetched');
    this.reset([], { silent: true });
  },

  _geometryColumnSQL: function (column) {
    /* eslint-disable */
    return [
      "CASE",
      "WHEN GeometryType(" + column + ") = 'POINT' THEN",
        "ST_AsGeoJSON(" + column + ",8)",
      "WHEN (" + column + " IS NULL) THEN",
        "NULL",
      "ELSE",
        "GeometryType(" + column + ")",
      "END " + column
    ].join(' ');
    /* eslint-enable */
  },

  // return wrapped SQL removing the_geom and the_geom_webmercator
  // to avoid fetching those columns.
  // So for a sql like
  // select * from table the returned value is
  // select column1, column2, column3... from table
  _getWrappedSQL: function (excludeColumns) {
    var self = this;
    var schema = this._querySchemaModel.columnsCollection.toJSON();

    var selectedColumns = _
      .chain(schema)
      .omit(function (item) {
        return _.contains(excludeColumns, item.name);
      })
      .map(function (item, index) {
        if (item.type === 'geometry') {
          return self._geometryColumnSQL(item.name);
        }
        return '"' + item.name + '"';
      })
      .value();

    return _.template(WRAP_SQL_TEMPLATE)({
      selectedColumns: selectedColumns.join(','),
      sql: this._querySchemaModel.get('query')
    });
  },

  _httpMethod: function () {
    return this._querySchemaModel.get('query').length > MAX_GET_LENGTH
      ? 'POST'
      : 'GET';
  },

  fetch: function (opts) {
    opts = opts || {};

    this.statusModel.set('status', STATUS.fetching);

    var excludeColumns = (opts.data && opts.data.exclude) || [];

    opts = opts || {};
    opts.data = _.extend(
      {},
      this.DEFAULT_FETCH_OPTIONS,
      opts.data && _.omit(opts.data, 'exclude') || {},
      {
        api_key: this._configModel.get('api_key'),
        q: this._getWrappedSQL(excludeColumns)
      }
    );

    opts.method = this._httpMethod();
    var errorCallback = opts.error;
    opts.error = function (coll, resp) {
      this.trigger('fail', coll, resp);
      this.statusModel.set('status', STATUS.unavailable);
      errorCallback && errorCallback(coll, resp);
    }.bind(this);

    var successCallback = opts.success;
    opts.success = function (coll, resp) {
      this.statusModel.set('status', STATUS.fetched);
      successCallback && successCallback(coll, resp);
    }.bind(this);

    // Needed to reset the whole collection when a fetch is done
    opts.reset = true;

    return Backbone.Collection.prototype.fetch.call(this, opts);
  },

  parse: function (r) {
    return this._parseWithID(r.rows);
  },

  reset: function (result, opts) {
    var items = [];

    if (result && result.rows) {
      // If reset comes from a fetch, we need to parse the rows
      items = result.rows;
    } else {
      // If it comes directly from a simple reset function
      items = result;
    }

    Backbone.Collection.prototype.reset.apply(this, [this._parseWithID(items)]);
  },

  _parseWithID: function (array) {
    return _.map(array, function (attrs) {
      attrs.__id = _.uniqueId();
      return attrs;
    });
  },

  addRow: function (opts) {
    opts = opts || {};
    this.create(
      {
        __id: _.uniqueId()
      },
      _.extend(
        opts,
        {
          wait: true,
          parse: true
        }
      )
    );
  },

  setTableName: function (name) {
    if (!name) return;

    if (this._tableName) {
      this._tableName = name;

      this.each(function (rowModel) {
        rowModel._tableName = name;
      });
    }
  }
});

},{"./backbone/sync-abort":337,"./query-row-model":363,"backbone":"backbone","underscore":"underscore"}],365:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var syncAbort = require('./backbone/sync-abort');
var QueryRowsCollection = require('./query-rows-collection');
var SQLUtils = require('../helpers/sql-utils');

var DEFAULT_TABLE_QUERY_TEMPLATE = _.template('SELECT * FROM <%= tableName %>');
var WRAPPED_SQL_QUERY_TEMPLATE = _.template('SELECT * FROM (<%= sql %>) __wrapped');

var MAX_GET_LENGTH = 1024;
var STATUS = {
  unavailable: 'unavailable',
  unfetched: 'unfetched',
  fetching: 'fetching',
  fetched: 'fetched'
};

/**
 * Model to represent a schema of a SQL query.
 */
module.exports = Backbone.Model.extend({

  defaults: {
    query: '',
    sort_order: 'asc',
    rows_per_page: 0,
    page: 0,
    status: STATUS.unavailable, // unfetched, fetching, fetched
    ready: false // until true there's no data available on the table(s) used in the query
  },

  sync: syncAbort, // override {Backbone.prototype.sync} abort ongoing request if there is any

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;
    this.columnsCollection = new Backbone.Collection([]);
    this.rowsCollection = new QueryRowsCollection([]);

    if (this.get('status') === STATUS.unavailable) {
      this._setStatusPerQueryValue();
    }

    this._addChangeListener();
  },

  url: function () {
    return this._configModel.getSqlApiUrl();
  },

  _addChangeListener: function () {
    this.bind('change', this._onChange, this);
  },

  _removeChangeListener: function () {
    this.unbind('change', this._onChange, this);
  },

  isFetched: function () {
    return this.get('status') === STATUS.fetched;
  },

  isFetching: function () {
    return this.get('status') === STATUS.fetching;
  },

  canFetch: function () {
    return this.hasQuery() && this.get('ready');
  },

  hasQuery: function () {
    return !!this.get('query');
  },

  shouldFetch: function () {
    return this.canFetch() && !this.isFetched() && !this.isFetching();
  },

  fetch: function (opts) {
    if (!this.canFetch()) return;

    this.set('status', STATUS.fetching);

    opts = opts || {};
    var errorCallback = opts && opts.error;

    opts.data = _.extend(
      opts.data || {},
      {
        sort_order: this.get('sort_order'),
        rows_per_page: this.get('rows_per_page'),
        page: this.get('page'),
        api_key: this._configModel.get('api_key'),
        q: this._getSqlApiQueryParam()
      }
    );

    opts.method = this._httpMethod();

    opts.error = function (model, response) {
      if (response && response.statusText !== 'abort') {
        var error = response.responseText ? JSON.parse(response.responseText).error : [];
        errorCallback && errorCallback(error);
        this.set({
          query_errors: error,
          status: STATUS.unavailable
        });
      }
    }.bind(this);

    return Backbone.Model.prototype.fetch.call(this, opts);
  },

  parse: function (r) {
    this.rowsCollection.reset(r.rows);

    this.columnsCollection.reset(
      _.map(r.fields, function (d, name) {
        return {
          name: name,
          type: d.type
        };
      })
    );

    return { status: STATUS.fetched };
  },

  /**
   * @override {Backbone.prototype.isNew} for this.destroy() to work (not try to send DELETE request)
   */
  isNew: function () {
    return true;
  },

  hasDefaultQueryFor: function (tableName) {
    if (!this.hasQuery()) {
      return false;
    }
    var defaultQueryForTableName = DEFAULT_TABLE_QUERY_TEMPLATE({ tableName: tableName });
    return SQLUtils.isSameQuery(this.get('query'), defaultQueryForTableName);
  },

  getColumnNames: function () {
    return this.columnsCollection.pluck('name');
  },

  _onChange: function () {
    this._removeChangeListener();

    if (!this.hasChanged('status') && this.get('status') === STATUS.fetching) {
      this.fetch(); // If is already fetching just redo the fetch with latest attrs
    } else {
      if (this.hasChanged('query')) {
        this.columnsCollection.reset();
        this._setStatusPerQueryValue();
      }
    }

    this._addChangeListener();
  },

  _setStatusPerQueryValue: function () {
    this.set('status', this.get('query') ? STATUS.unfetched : STATUS.unavailable);
  },

  // Basically checks if an schema is different than the current one
  hasDifferentSchemaThan: function (schemaArray) {
    return !_.every(schemaArray, function (columnObj) {
      var columnModel = this.columnsCollection.findWhere({ name: columnObj.name });
      return columnModel && (columnModel.get('type') === columnObj.type || columnObj.type == null);
    }, this);
  },

  resetDueToAlteredData: function () {
    this.set('status', STATUS.unfetched);
    this.trigger('resetDueToAlteredData');
    this.fetch();
  },

  _getSqlApiQueryParam: function () {
    return WRAPPED_SQL_QUERY_TEMPLATE({
      sql: this.get('query')
    });
  },

  _httpMethod: function () {
    return this._getSqlApiQueryParam().length > MAX_GET_LENGTH
      ? 'POST'
      : 'GET';
  },

  resetFetch: function () {
    this.set('status', STATUS.unfetched);
  }

});

},{"../helpers/sql-utils":433,"./backbone/sync-abort":337,"./query-rows-collection":364,"backbone":"backbone","underscore":"underscore"}],366:[function(require,module,exports){
var _ = require('underscore');
var AssetModel = require('./asset-model');

module.exports = AssetModel.extend({

  defaults: {
    ext: 'svg',
    folder: 'maki-icons',
    host: 'https://s3.amazonaws.com',
    bucket: 'com.cartodb.users-assets.production',
    kind: 'marker',
    name: '',
    public_url: '',
    size: '18',
    state: 'idle'
  },

  getURLFor: function (name) {
    var url = this.get('host') + '/' + this.get('bucket') + '/' + this.get('folder') + '/' + name;
    var size = this.get('size') ? '-' + this.get('size') : '';
    return url + size + '.' + this.get('ext');
  },

  toJSON: function () {
    var c = _.clone(this.attributes);

    c['public_url'] = this.getURLFor(c['icon']);
    return c;
  },

  get: function (attr) {
    var r = this.attributes[attr];

    if (attr === 'public_url') {
      r = this.getURLFor(this.attributes['icon']);
    }

    return r;
  }
});

},{"./asset-model":335,"underscore":"underscore"}],367:[function(require,module,exports){
var StaticAssetModel = require('./static-asset-model');
var AssetsCollection = require('./assets-collection');

module.exports = AssetsCollection.extend({
  model: StaticAssetModel,

  url: function () {
    return '';
  },

  initialize: function (models, opts) {

  },

  parse: function (resp, xhr) {
    return [];
  }
});

},{"./assets-collection":336,"./static-asset-model":366}],368:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var $ = require('jquery');
var MULTIPLIER = 1.2; // Multiply current interval for this number
var INTERVAL = 1500; // Interval time between poll checkings
var SYNC_GAP = 900000; // Gap (in ms) necessary to perform next synchronization
var POLLING_GAP = 15000; // Gap (in seconds) necessary to start polling and checking synchronization

/**
 *  Synced table model
 */

module.exports = Backbone.Model.extend({
  defaults: {
    name: '',
    url: '',
    state: '',
    run_at: 0,
    ran_at: 0,
    retried_times: 0,
    interval: 0,
    error_code: 0,
    error_message: '',
    service_name: '',
    service_item_id: '',
    content_guessing: true,
    type_guessing: true
  },

  urlRoot: function () {
    var version = this._configModel.urlVersion('synchronizations');
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/' + version + '/synchronizations/';
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    this._configModel = opts.configModel;

    this.bind('destroy', function () {
      this.unset('id');
    });

    this._checkState();

    this.bind('change:error_code change:error_message change:state', this._checkState, this);
  },

  toJSON: function () {
    var c = _.clone(this.attributes);

    var d = {
      url: c.url,
      interval: c.interval,
      content_guessing: c.content_guessing,
      type_guessing: c.type_guessing,
      create_vis: c.create_vis
    };

    if (c.type === 'remote') {
      _.extend(d, {
        remote_visualization_id: c.remote_visualization_id,
        create_vis: false,
        value: c.value
      });
    }

    if (c.id !== undefined) {
      d.id = c.id;
    }

    // Comes from a service?
    if (c.service_name) {
      d.service_name = c.service_name;
      d.service_item_id = c.service_item_id;
    }

    return d;
  },

  _checkState: function () {
    if (this.get('error_code') || this.get('error_message')) {
      this.set('state', 'failure');
    }
  },

  syncNow: function (callback) {
    if (!callback) throw new Error('callback is required');

    $.ajax({
      url: this.url() + '/sync_now',
      type: 'PUT'
    }).always(callback);
  },

  // Checks for poll to finish
  pollCheck: function (i) {
    var self = this;
    var interval = INTERVAL;

    this.pollTimer = setInterval(request, interval);

    function request () {
      self.destroyCheck();

      self.fetch({
        error: function (m, e) {
          self.set({
            error_message: e.statusText || '',
            state: 'failure'
          });
        }
      });

      interval = interval * MULTIPLIER;

      self.pollTimer = setInterval(request, interval);
    }
  },

  destroyCheck: function () {
    clearInterval(this.pollTimer);
  },

  isSync: function () {
    return !this.isNew() && this.get('interval') > 0;
  },

  isSyncing: function () {
    return this.get('state') === 'syncing' || this.get('state') === 'queued';
  },

  canSyncNow: function () {
    var ranAt = new Date(this.get('ran_at'));
    var now = new Date();
    var gap = SYNC_GAP; // Importer needs some time to perform the next sync, set 15 min as default.

    if (this.isSyncing()) {
      return false;
    }

    return (now.getTime() - ranAt.getTime()) > gap;
  },

  linkToTable: function (tableModel) {
    var self = this;
    if (tableModel.has('synchronization')) {
      this.set(tableModel.get('synchronization'));
    }

    tableModel.bind('change:synchronization', function () {
      self.set(tableModel.get('synchronization'));
    }, tableModel);

    tableModel.bind('destroy', function destroy () {
      self.unbind(null, null, tableModel);
      self.destroy();
    }, tableModel);
  }
}, {
  SYNC_GAP: SYNC_GAP,
  POLLING_GAP: POLLING_GAP
});

},{"backbone":"backbone","jquery":"jquery","underscore":"underscore"}],369:[function(require,module,exports){
var Backbone = require('backbone');
var ColumnModel = require('./column-model');

/**
 * A collection of table columns
 */
module.exports = Backbone.Collection.extend({

  model: ColumnModel,

  initialize: function (models, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    if (!opts.tableModel) throw new Error('tableModel is required');

    this._configModel = opts.configModel;
    this._tableModel = opts.tableModel;
  },

  url: function () {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('column');
    return baseUrl + '/api/' + version + '/tables/' + this._tableModel.get('name') + '/columns';
  }

});

},{"./column-model":342,"backbone":"backbone"}],370:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');
var TableColumnsCollection = require('./table-columns-collection');
var getSimpleGeometryType = require('./get-simple-geometry-type');
var PermissionModel = require('./permission-model');
var SyncModel = require('./synchronization-model');
var TableNameUtils = require('../helpers/table-name-utils');

/**
 * Model representing a table.
 */
module.exports = Backbone.Model.extend({

  idAttribute: 'name',

  defaults: {
    // always not fetched to begin with, since the only way to currently get table data is by an individual request
    fetched: false,
    schema: []
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;
  },

  urlRoot: function () {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('table');
    return baseUrl + '/api/' + version + '/tables';
  },

  parse: function (r, opts) {
    var configModel = (opts && opts.configModel) || this._configModel;

    // "Sometimes" table presenter returns the needed data within table_visualization
    // attribute, because it returns the canonical visualization data. So we have to take
    // the data from there.
    if (r.table_visualization && !_.isEmpty(r.table_visualization)) {
      r = _.extend(
        {},
        r.table_visualization,
        {
          geometry_types: r.geometry_types
        }
      );
    }

    if (r.synchronization) {
      if (!this._syncModel) {
        this._syncModel = new SyncModel(r.synchronization, {
          configModel: configModel
        });
      } else {
        this._syncModel.set(r.synchronization);
      }
    }

    if (r.permission) {
      if (!this._permissionModel) {
        this._permissionModel = new PermissionModel(r.permission, {
          configModel: configModel
        });
      } else {
        this._permissionModel.set(r.permission);
      }
    }

    var attrs = _.defaults({
      fetched: true
    }, r);

    var columnsAttrs = _.map(r.schema, function (d) {
      return {
        name: d[0],
        type: d[1]
      };
    }, this);

    if (!this.columnsCollection) {
      this.columnsCollection = new TableColumnsCollection(columnsAttrs, {
        configModel: configModel,
        tableModel: this
      });
    } else {
      this.columnsCollection.reset(columnsAttrs);
    }

    return attrs;
  },

  isOwner: function (userModel) {
    if (!userModel || !this._permissionModel) {
      return false;
    }
    return this._permissionModel.isOwner(userModel);
  },

  getUnqualifiedName: function () {
    return TableNameUtils.getUnqualifiedName(this.get('name'));
  },

  getOwnerName: function () {
    var name = this.get('name');
    if (!name) return null;
    var tk = name.split('.');
    if (tk.length === 2) {
      return tk[0].replace(/"/g, '');
    } else if (this._permissionModel) {
      var ownerModel = this._permissionModel.getOwner();
      return ownerModel.get('username');
    } else {
      return '';
    }
  },

  // "user".table -> user.table
  getUnquotedName: function () {
    var name = this.get('name');
    return name && name.replace(/"/g, '');
  },

  getGeometryType: function () {
    var types = this.get('geometry_types');
    var geomTypes = [];
    if (!_.isArray(types)) {
      return [];
    }

    for (var t in types) {
      var type = types[t];
      // when there are rows with no geo type null is returned as geotype
      if (type) {
        var a = getSimpleGeometryType(type.toLowerCase());
        if (a) {
          geomTypes.push(a);
        }
      }
    }

    return _.uniq(geomTypes);
  },

  getPermissionModel: function () {
    return this._permissionModel;
  },

  isReadOnly: function (userModel) {
    return this.isSync() || !this.hasWriteAccess(userModel);
  },

  isSync: function () {
    var syncModel = this.getSyncModel();
    var isSync = syncModel && syncModel.get('id');

    return !!isSync;
  },

  hasWriteAccess: function (userModel) {
    if (!userModel || !this._permissionModel) {
      return false;
    }
    return this._permissionModel.hasWriteAccess(userModel);
  },

  getSyncModel: function () {
    return this._syncModel;
  }

});

},{"../helpers/table-name-utils":434,"./get-simple-geometry-type":349,"./permission-model":359,"./synchronization-model":368,"./table-columns-collection":369,"backbone":"backbone","underscore":"underscore"}],371:[function(require,module,exports){
var _ = require('underscore');
var BackboneUndo = require('backbone-undo');
var MAXIMUM_STACK_LENGTH = 30;

module.exports = {
  init: function (model, opts) {
    if (!model) throw new Error('model is required to initialize undoManager');

    opts = opts || {};
    this.model = model;

    this.model._undoManager = this.undoManager = new BackboneUndo({
      maximumStackLength: opts.maximumStackLength || MAXIMUM_STACK_LENGTH,
      register: this.model,
      track: opts.track
    });

    this._trackEvents();
    this._addMethods();

    if (!_.isEmpty(opts.history)) {
      opts.track && this.undoManager.stopTracking();
      this._addHistory(opts.history);
      opts.track && this.undoManager.startTracking();
    }
  },

  _trackEvents: function () {
    _.each(['undo', 'redo'], function (eventType) {
      this.undoManager.bind(eventType, function () {
        this.trigger(eventType, this.changed, this);
      }, this.model);
    }, this);

    this.undoManager.stack.bind('add remove reset', function () {
      this.trigger('unredoChanged', this.changed, this);
    }, this.model);
  },

  _addHistory: function (history) {
    var stack = this.undoManager.stack;

    _.each(history, function (attrs, i) {
      if (history[i + 1]) {
        stack.add({
          after: history[i + 1],
          before: attrs,
          type: 'change',
          undoTypes: this.undoManager.undoTypes,
          object: this.model,
          magicFusionIndex: 0
        });
      }
    }, this);

    stack.pointer = stack.length - 1;
  },

  _addMethods: function () {
    _.extend(
      this.model,
      {
        undo: function () {
          this._undoManager.undo();
        },

        redo: function () {
          this._undoManager.redo();
        },

        canUndo: function () {
          return this._undoManager.isAvailable('undo');
        },

        canRedo: function () {
          return this._undoManager.isAvailable('redo');
        },

        getUndoHistory: function () {
          var list = this._undoManager.stack.toJSON();
          var data = _.reduce(list, function (memo, attrs, i) {
            memo.push(attrs.before);
            return memo;
          }, [], this);
          data.push(this.attributes);
          return data;
        }
      }
    );
  }
};

},{"backbone-undo":"backbone-undo","underscore":"underscore"}],372:[function(require,module,exports){
var Backbone = require('backbone');
var GroupModel = require('./group-model');

/**
 * Collection of a User's groups.
 */
module.exports = Backbone.Collection.extend({
  model: GroupModel,

  initialize: function (models, opts) {
    this.organization = opts.organization;
  }
});

},{"./group-model":351,"backbone":"backbone"}],373:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var OrganizationModel = require('./organization-model');
var UserGroups = require('./user-groups-collection');
var CustomBaselayersCollection = require('./custom-baselayers-collection');

/**
 *  User model
 *
 */

var UserModel = Backbone.Model.extend({
  urlRoot: function () {
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/v1/users';
  },

  defaults: {
    avatar_url: 'http://cartodb.s3.amazonaws.com/static/public_dashboard_default_avatar.png',
    username: '',
    email: ''
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    this._configModel = opts.configModel;
    attrs = attrs || {};

    if (!_.isEmpty(this.get('organization'))) {
      this._organizationModel = new OrganizationModel(
        this.get('organization'),
        {
          configModel: this._configModel,
          currentUserId: this.id
        }
      );
    }

    if (this.get('layers')) {
      this.layers = new CustomBaselayersCollection(this.get('layers'), {
        configModel: this._configModel,
        currentUserId: this.id
      });
    }

    this.groups = new UserGroups(attrs.groups, {
      organization: this._organizationModel
    });
  },

  isViewer: function () {
    return this.get('viewer') === true;
  },

  isBuilder: function () {
    return !this.isViewer();
  },

  canCreateDatasets: function () {
    if (!this.get('remaining_byte_quota') || this.get('remaining_byte_quota') <= 0) {
      return false;
    }
    return true;
  },

  hasCreateMapsFeature: function () {
    return this.isBuilder();
  },

  canCreateTwitterDataset: function () {
    return !((this.get('twitter').quota - this.get('twitter').monthly_use) <= 0 && this.get('twitter').hard_limit);
  },

  canStartTrial: function () {
    return !this.isInsideOrg() && this.get('account_type') === 'FREE' && this.get('table_count') > 0;
  },

  isActionEnabled: function (action) {
    return this.get('actions') && this.get('actions')[action];
  },

  canCreatePrivateDatasets: function () {
    var actions = this.get('actions');
    return actions && actions.private_tables;
  },

  isInsideOrg: function () {
    if (this._organizationModel) {
      return !!this._organizationModel.id || this.isOrgOwner();
    }
    return false;
  },

  isOrgOwner: function () {
    if (this._organizationModel) {
      return this._organizationModel.getOwnerId() === this.get('id');
    }
    return false;
  },

  isOrgAdmin: function () {
    if (this._organizationModel) {
      return this._organizationModel.isOrgAdmin(this);
    }
    return false;
  },

  featureEnabled: function (name) {
    var featureFlags = this.get('feature_flags');
    if (!featureFlags || featureFlags.length === 0 || !name) {
      return false;
    }
    return _.contains(featureFlags, name);
  },

  upgradeContactEmail: function () {
    if (this.isInsideOrg()) {
      if (this.isOrgOwner()) {
        return 'enterprise-support@carto.com';
      } else {
        return this._organizationModel.getOwnerEmail();
      }
    } else {
      return 'support@carto.com';
    }
  },

  nameOrUsername: function () {
    return this.get('name') || this.get('username');
  },

  getMaxConcurrentImports: function () {
    return (this.get('limits') && this.get('limits').concurrent_imports) || 1;
  },

  getSchemaName: function () {
    return this.isInsideOrg() ? this.get('username') : 'public';
  },

  renderData: function (currentUser) {
    var name = this.get('username');
    if (currentUser && currentUser.id === this.id) {
      name = _t('user.you');
    }
    return {
      username: name,
      avatar_url: this.get('avatar_url')
    };
  },

  clone: function () {
    var attrs = _.clone(this.attributes);
    delete attrs.id;
    return new UserModel(attrs, {
      configModel: this._configModel
    });
  },

  getOrganization: function () {
    return this._organizationModel;
  }
});

module.exports = UserModel;

},{"./custom-baselayers-collection":345,"./organization-model":358,"./user-groups-collection":372,"backbone":"backbone","underscore":"underscore"}],374:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');

/**
 *  User Notifications
 *
 */

var UserNotifications = Backbone.Model.extend({
  sync: function (method, model, options) {
    return Backbone.sync('update', model, options);
  },

  url: function () {
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/v3/notifications/' + this.get('key');
  },

  initialize: function (attrs, opts) {
    if (!opts.key) throw new Error('key is required');
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;
    this.attributes = _.extend({ notifications: attrs }, { key: opts.key });
  },

  getKey: function (key) {
    var notifications = this.get('notifications') || {};
    return notifications[key];
  },

  setKey: function (key, value) {
    var notifications = this.get('notifications') || {};
    notifications[key] = value;
    this.set('notifications', notifications);
  }
});

module.exports = UserNotifications;

},{"backbone":"backbone","underscore":"underscore"}],375:[function(require,module,exports){
var Backbone = require('backbone');
var syncAbort = require('./backbone/sync-abort');

/**
 * A collection representing a set of users in a group.
 */
module.exports = Backbone.Collection.extend({

  sync: syncAbort,

  initialize: function (models, opts) {
    if (!opts.group) throw new Error('group is required');
    this.group = opts.group;
    this.configModel = opts.configModel;
    this.organization = opts.organization;
  },

  url: function (method) {
    var baseUrl = this.configModel.get('base_url');
    var version = this.configModel.urlVersion('organizationGroups', method);
    return baseUrl + '/api/' + version + '/organization/' + this.organization.id + '/groups/' + this.group.id + '/users';
  },

  parse: function (response) {
    this.total_entries = response.total_entries;
    this.total_user_entries = response.total_user_entries;

    return response.users;
  },

  totalCount: function () {
    return this.total_user_entries;
  }

});

},{"./backbone/sync-abort":337,"backbone":"backbone"}],376:[function(require,module,exports){
var $ = require('jquery');
var _ = require('underscore');
var UsersGroup = require('./users-group-collection');

// This module fetch the user for every group present
// in the ACL permission collection. The vizjson doesn't
// provide and we need it for the sharing stats in the header.

module.exports = {
  track: function (opts) {
    this.acl = opts.acl;
    this.configModel = opts.configModel;
    this.userModel = opts.userModel;

    this.acl.on('reset', this.fetchUsers, this);
    this.fetchUsers();
  },

  fetchUsers: function () {
    var self = this;
    var promises = [];

    promises = _.map(this.acl.where({type: 'group'}), function (group) {
      var entity = group.get('entity');
      var deferred = new $.Deferred();

      if (!entity.users || entity.users.length === 0) {
        entity.users = new UsersGroup([], {
          group: entity,
          configModel: self.configModel,
          organization: self.userModel.getOrganization()
        });

        entity.users.fetch({
          success: function () {
            deferred.resolve();
          }
        });
      } else {
        deferred.resolve();
      }

      return deferred.promise();
    }, this);

    $.when.apply($, promises).done(function () {
      self.acl.trigger('fetch');
    });
  }
};

},{"./users-group-collection":375,"jquery":"jquery","underscore":"underscore"}],377:[function(require,module,exports){
var Backbone = require('backbone');
var PermissionModel = require('./permission-model');

/**
 * Model that represents a visualization (v3)
 *
 * Even though a table might be represented as a Visualization in some cases, please use TableModel if you want to work
 * with the table data instead of adding table-specific methods here.
 */

var PRIVACY_OPTIONS = ['PUBLIC', 'LINK', 'PRIVATE', 'PASSWORD'];

module.exports = Backbone.Model.extend({
  defaults: {
    visChanges: 0
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');

    this._configModel = opts.configModel;

    if (this.get('permission')) {
      this._permissionModel = new PermissionModel(this.get('permission'), {
        configModel: opts.configModel
      });
      this.unset('permission');
    }
  },

  urlRoot: function () {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('visualization');
    return baseUrl + '/api/' + version + '/viz';
  },

  mapcapsURL: function () {
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/v3/viz/' + this.id + '/mapcaps';
  },

  embedURL: function () {
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/builder/' + this.id + '/embed';
  },

  builderURL: function () {
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/builder/' + this.id + '/';
  },

  vizjsonURL: function () {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('vizjson', 'read', 'v3');
    return baseUrl + '/api/' + version + '/viz/' + this.id + '/viz.json';
  },

  stateURL: function () {
    var baseUrl = this._configModel.get('base_url');
    return baseUrl + '/api/v3/viz/' + this.id + '/state';
  },

  isVisualization: function () {
    return this.get('type') === 'derived';
  },

  privacyOptions: function () {
    return PRIVACY_OPTIONS;
  },

  recordChange: function () {
    var visChanges = this.get('visChanges');
    this.set('visChanges', visChanges + 1);
  },

  resetChanges: function () {
    this.set('visChanges', 0);
  },

  getPermissionModel: function () {
    return this._permissionModel;
  }
});

},{"./permission-model":359,"backbone":"backbone"}],378:[function(require,module,exports){
var Backbone = require('backbone');

/**
 *  Edit vis metadata dialog model
 *  to control if name and metadata
 *  are editable or not.
 *
 */

module.exports = Backbone.Model.extend({

  defaults: {
    name: ''
  },

  validate: function (attrs) {
    if (!attrs) return;
    if (!attrs.name) {
      return _t('components.modals.maps-metadata.validation.error.name');
    }
  }
});

},{"backbone":"backbone"}],379:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var TableModel = require('./table-model');
var PermissionModel = require('./permission-model');
var SynchronizationModel = require('./synchronization-model');
var LikesModel = require('../components/likes/likes-model');

/**
 * Model that represents a table visualization (v3)
 *
 */

var PRIVACY_OPTIONS = ['PUBLIC', 'LINK', 'PRIVATE'];

module.exports = Backbone.Model.extend({

  urlRoot: function () {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('visualization');
    return baseUrl + '/api/' + version + '/viz';
  },

  initialize: function (attrs, opts) {
    if (!opts.configModel) throw new Error('configModel is required');
    this._configModel = opts.configModel;

    this._initModels();
  },

  _initModels: function () {
    var d = this.get('table');
    if (!_.isEmpty(this.get('external_source'))) {
      d = this.get('external_source');
    }
    this._tableModel = new TableModel(d, {
      configModel: this._configModel,
      parse: true
    });

    if (this.get('permission')) {
      this._permissionModel = new PermissionModel(this.get('permission'), {
        configModel: this._configModel
      });
      this.unset('permission');
    }

    this._likesModel = LikesModel.newByVisData({
      vis_id: this.id,
      liked: this.get('liked'),
      likes: this.get('likes'),
      configModel: this._configModel
    });

    if (this.get('synchronization')) {
      this._synchronizationModel = new SynchronizationModel(this.get('synchronization'), {
        configModel: this._configModel
      });
      this._synchronizationModel.linkToTable(this._tableModel);
    }
  },

  isVisualization: function () {
    return false;
  },

  getTableModel: function () {
    return this._tableModel;
  },

  getLikesModel: function () {
    return this._likesModel;
  },

  getPermissionModel: function () {
    return this._permissionModel;
  },

  getSynchronizationModel: function () {
    return this._synchronizationModel;
  },

  vizjsonURL: function () {
    var baseUrl = this._configModel.get('base_url');
    var version = this._configModel.urlVersion('vizjson', 'read', 'v3');
    return baseUrl + '/api/' + version + '/viz/' + this.id + '/viz.json';
  },

  isRaster: function () {
    return this.get('kind') === 'raster';
  },

  datasetURL: function () {
    var baseUrl = this._configModel.get('base_url');
    var tableName = this.getTableModel().getUnquotedName();
    return baseUrl + '/dataset/' + tableName;
  },

  privacyOptions: function () {
    return PRIVACY_OPTIONS;
  },

  toJSON: function () {
    return _.omit(this.attributes, 'synchronization', 'stats', 'table');
  }
});

},{"../components/likes/likes-model":183,"./permission-model":359,"./synchronization-model":368,"./table-model":370,"backbone":"backbone","underscore":"underscore"}],380:[function(require,module,exports){
var ACTIVE_LOCALE = window.ACTIVE_LOCALE;
if (ACTIVE_LOCALE !== 'en') {
  require('moment/locale/' + ACTIVE_LOCALE);
}
var Locale = require('../../locale/index');
var Polyglot = require('node-polyglot');
var polyglot = new Polyglot({
  locale: ACTIVE_LOCALE, // Needed for pluralize behaviour
  phrases: Locale[ACTIVE_LOCALE]
});
window._t = polyglot.t.bind(polyglot);

var $ = require('jquery');
var _ = require('underscore');
var Backbone = require('backbone');
var ConfigModel = require('./data/config-model');
var DatasetContentView = require('./dataset/dataset-content/dataset-content-view');
var DatasetOptionsView = require('./dataset/dataset-options/dataset-options-view');
var ModalsServiceModel = require('./components/modals/modals-service-model');
var MetricsTracker = require('./components/metrics/metrics-tracker');
var AnalysisDefinitionNodeSourceModel = require('./data/analysis-definition-node-source-model');
var LayerDefinitionModel = require('./data/layer-definition-model');
var TableModel = require('./data/table-model');
var VisTableModel = require('./data/visualization-table-model');
var DatasetUnlockModalView = require('./dataset/dataset-unlock-modal-view');
var EditorModel = require('./data/editor-model');
var UserModel = require('./data/user-model');
var HeaderView = require('./dataset/dataset-header/dataset-header-view');
var Notifier = require('./components/notifier/notifier');
var UserGroupFetcher = require('./data/users-group-fetcher');
var SQLUtils = require('./helpers/sql-utils');
var BuilderActivatedNotification = require('./components/onboardings/builder-activated/builder-activated-notification-view');
var UserNotifications = require('./data/user-notifications');
var layerTypesAndKinds = require('./data/layer-types-and-kinds');

var userData = window.userData;
var visData = window.visualizationData;
var tableData = window.tableData;
var layersData = window.layersData;
var frontendConfig = window.frontendConfig;
var authTokens = window.authTokens;
var dashboardNotifications = window.dashboardNotifications;

var configModel = new ConfigModel(
  _.defaults(
    {
      base_url: userData.base_url,
      api_key: userData.api_key,
      auth_tokens: authTokens
    },
    frontendConfig
  )
);
var userModel = new UserModel(userData, { configModel: configModel });
var modals = new ModalsServiceModel();
var tableModel = new TableModel(tableData, { parse: true, configModel: configModel });
var editorModel = new EditorModel();
var Router = new Backbone.Router();
var visModel = new VisTableModel(visData, { configModel: configModel });
var layersCollection = new Backbone.Collection(layersData);
var layerDataModel = layersCollection.find(function (mdl) {
  var kind = mdl.get('kind');
  return layerTypesAndKinds.isKindDataLayer(kind);
});

var layerModel = new LayerDefinitionModel(layerDataModel.toJSON(), {
  configModel: configModel,
  parse: true
});

layerModel.url = function () {
  var baseUrl = configModel.get('base_url');
  return baseUrl + '/api/v1/maps/' + visData.map_id + '/layers/' + layerModel.id;
};

// It is possible that a layer doesn't contain
if (!layerModel.get('sql')) {
  var defaultQuery = SQLUtils.getDefaultSQL(
    tableModel.getUnqualifiedName(),
    tableModel.get('permission').owner.username,
    userModel.isInsideOrg()
  );
  layerModel.set('sql', defaultQuery);
}

var analysisDefinitionNodeModel = new AnalysisDefinitionNodeSourceModel({
  table_name: tableData.name,
  query: layerModel.get('sql'),
  type: 'source',
  id: 'dummy-id'
}, {
  configModel: configModel,
  userModel: userModel,
  tableData: _.extend(
    tableData,
    {
      synchronization: visData.synchronization || {}
    }
  )
});

UserGroupFetcher.track({
  userModel: userModel,
  configModel: configModel,
  acl: visModel.getPermissionModel().acl
});

// Request geometries is case that the sql is custom, if not, follow
// what table info provides
var queryGeometryModel = analysisDefinitionNodeModel.queryGeometryModel;

if (!analysisDefinitionNodeModel.isCustomQueryApplied()) {
  var simpleGeom = tableModel.getGeometryType();
  queryGeometryModel.set({
    status: 'fetched',
    simple_geom: simpleGeom && simpleGeom[0]
  });
} else {
  queryGeometryModel.fetch();
}

Notifier.init({
  editorModel: editorModel
});

MetricsTracker.init({
  userId: userModel.get('id'),
  visId: visModel.get('id'),
  configModel: configModel
});

var headerView = new HeaderView({
  router: Router,
  modals: modals,
  configModel: configModel,
  userModel: userModel,
  visModel: visModel,
  analysisDefinitionNodeModel: analysisDefinitionNodeModel,
  layerDefinitionModel: layerModel
});
$('.js-info').append(headerView.render().el);

var datasetContentView = new DatasetContentView({
  el: $('.js-table'),
  modals: modals,
  userModel: userModel,
  visModel: visModel,
  analysisDefinitionNodeModel: analysisDefinitionNodeModel,
  configModel: configModel
});
datasetContentView.render();

var datasetOptionsView = new DatasetOptionsView({
  el: $('.js-datasetOptions'),
  editorModel: editorModel,
  router: Router,
  modals: modals,
  configModel: configModel,
  userModel: userModel,
  visModel: visModel,
  analysisDefinitionNodeModel: analysisDefinitionNodeModel,
  layerDefinitionModel: layerModel
});

datasetOptionsView.render();

var notifierView = Notifier.getView();
$('.js-notifier').append(notifierView.render().el);

var rootUrl = configModel.get('base_url').replace(window.location.origin, '') + '/dataset/';
Backbone.history.start({
  pushState: true,
  root: rootUrl
});

if (tableModel.isOwner(userModel) && visModel.get('locked')) {
  modals.create(function (modalModel) {
    return new DatasetUnlockModalView({
      modalModel: modalModel,
      visModel: visModel,
      configModel: configModel,
      tableName: tableModel.getUnquotedName()
    });
  });
}

if (!configModel.get('cartodb_com_hosted')) {
  if (userModel.get('actions').builder_enabled && userModel.get('show_builder_activated_message') &&
      _.isEmpty(dashboardNotifications)) {
    var builderActivatedNotification = new UserNotifications(dashboardNotifications, {
      key: 'dashboard',
      configModel: configModel
    });

    var builderActivatedNotificationView = new BuilderActivatedNotification({
      builderActivatedNotification: builderActivatedNotification
    });

    $('.js-editor').addClass('Editor--topBar');
    builderActivatedNotificationView.bind('clean', function () {
      $('.js-editor').removeClass('Editor--topBar');
    }, this);
  }
}

},{"../../locale/index":452,"./components/metrics/metrics-tracker":189,"./components/modals/modals-service-model":205,"./components/notifier/notifier":252,"./components/onboardings/builder-activated/builder-activated-notification-view":254,"./data/analysis-definition-node-source-model":334,"./data/config-model":343,"./data/editor-model":348,"./data/layer-definition-model":355,"./data/layer-types-and-kinds":356,"./data/table-model":370,"./data/user-model":373,"./data/user-notifications":374,"./data/users-group-fetcher":376,"./data/visualization-table-model":379,"./dataset/dataset-content/dataset-content-view":386,"./dataset/dataset-header/dataset-header-view":388,"./dataset/dataset-options/dataset-options-view":396,"./dataset/dataset-unlock-modal-view":400,"./helpers/sql-utils":433,"backbone":"backbone","jquery":"jquery","node-polyglot":"node-polyglot","underscore":"underscore"}],381:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var UndoManager = require('../data/undo-manager.js');

/**
 *  Data SQL Undo-redo model
 */
module.exports = Backbone.Model.extend({

  defaults: {
    content: ''
  },

  initialize: function (attrs, opts) {
    this._history = this._generateHistory(opts && opts.history);

    UndoManager.init(this, {
      track: true,
      history: this._history
    });
  },

  _generateHistory: function (history) {
    if (history && history.length) {
      var data = _.reduce(history, function (memo, sql) {
        memo.push({
          content: sql
        });
        return memo;
      }, [], this);
      return data;
    }

    return false;
  },

  getHistory: function () {
    return _.pluck(
      this.getUndoHistory(),
      'content'
    );
  }
});

},{"../data/undo-manager.js":371,"backbone":"backbone","underscore":"underscore"}],382:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var ModalExportDataView = require('../../components/modals/export-data/modal-export-data-view');
var SyncInfoView = require('./dataset-content-sync-view');
var template = require('./dataset-content-options.tpl');
var checkAndBuildOpts = require('../../helpers/required-opts');

var REQUIRED_OPTS = [
  'analysisDefinitionNodeModel',
  'configModel',
  'modals',
  'userModel'
];

module.exports = CoreView.extend({

  className: 'Dataset-viewOptions u-flex u-justifySpace u-alignCenter',

  events: {
    'click .js-addRow': '_onAddRowClick',
    'click .js-addColumn': '_onAddColumnClick',
    'click .js-export': '_onExportClick'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._tableModel = this._analysisDefinitionNodeModel.getTableModel();
    this._querySchemaModel = this._analysisDefinitionNodeModel.querySchemaModel;
    this._queryGeometryModel = this._analysisDefinitionNodeModel.queryGeometryModel;
    this._syncModel = this._tableModel.getSyncModel();

    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(
      template({
        isEditable: !this._analysisDefinitionNodeModel.isReadOnly(),
        isCustomQueryApplied: this._analysisDefinitionNodeModel.isCustomQueryApplied()
      })
    );
    this._initViews();
    return this;
  },

  _initBinds: function () {
    this.listenTo(this._querySchemaModel, 'change:query', this.render);
    this.listenTo(this._syncModel, 'destroy', this.render);
  },

  _initViews: function () {
    if (this._tableModel.isSync() && this._tableModel.isOwner(this._userModel)) {
      var syncInfo = new SyncInfoView({
        modals: this._modals,
        syncModel: this._syncModel,
        tableModel: this._tableModel,
        querySchemaModel: this._querySchemaModel
      });

      this.$('.js-sync').html(syncInfo.render().el);
      this.addView(syncInfo);
    }
  },

  _onExportClick: function () {
    this._modals.create(function (modalModel) {
      return new ModalExportDataView({
        modalModel: modalModel,
        configModel: this._configModel,
        fileName: this._tableModel.getUnquotedName(),
        queryGeometryModel: this._queryGeometryModel
      });
    }.bind(this));
  },

  _onAddRowClick: function () {
    this.trigger('addRow', this);
  },

  _onAddColumnClick: function () {
    this.trigger('addColumn', this);
  }
});

},{"../../components/modals/export-data/modal-export-data-view":200,"../../helpers/required-opts":432,"./dataset-content-options.tpl":383,"./dataset-content-sync-view":384,"backbone/core-view":454}],383:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="js-sync"></div>\n<div class="js-dataset">\n  <ul class="u-flex u-justifySpace">\n    ';
 if (isEditable) { 
__p+='\n      <li>\n        <button class="CDB-Text CDB-Size-small is-semibold u-actionTextColor u-upperCase js-addRow">\n          <div class="u-flex u-alignCenter">\n            <svg width="16px" height="18px" viewBox="0 0 16 6" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n              <defs>\n                <path d="M4,3 L4,0 L3,0 L3,3 L0,3 L0,4 L3,4 L3,7 L4,7 L4,4 L7,4 L7,3 L4,3 Z" id="path-1"></path>\n                <mask id="mask-2" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="7" height="7" fill="white">\n                    <use xlink:href="#path-1"></use>\n                </mask>\n              </defs>\n              <g id="Add-Row" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n                <use id="Combined-Shape" stroke="#1181FB" mask="url(#mask-2)" stroke-width="2" xlink:href="#path-1"></use>\n                <path d="M16,0 L16,3 L9,3 L9,0 L16,0 Z M10.0020142,1 L10.000989,2.01795972 L14.9926249,2.00301586 L14.9962966,1.00580263 L10.0020142,1 Z" id="Combined-Shape" fill="#1181FB"></path>\n                <path d="M16,4 L16,7 L9,7 L9,4 L16,4 Z M10.0020142,5 L10.000989,6.01795972 L14.9926249,6.00301586 L14.9962966,5.00580263 L10.0020142,5 Z" id="Combined-Shape-Copy" fill="#1181FB"></path>\n              </g>\n            </svg>\n            <span class="u-lSpace">\n              '+
((__t=( _t('dataset.options.add-row') ))==null?'':_.escape(__t))+
'\n            </span>\n          </div>\n        </button>\n      </li>\n      <li class="u-lSpace--xl">\n        <button class="CDB-Text CDB-Size-small is-semibold u-actionTextColor u-upperCase js-addColumn">\n          <div class="u-flex u-alignCenter">\n            <svg width="16px" height="18px" viewBox="0 4 16 6" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n              <g id="Add-Column" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(0.000000, 4.000000)">\n                <path d="M4,3 L4,0 L3,0 L3,3 L0,3 L0,4 L3,4 L3,7 L4,7 L4,4 L7,4 L7,3 L4,3 Z" id="Combined-Shape" fill="#1181FB"></path>\n                <path d="M9,0 L12,0 L12,7 L9,7 L9,0 Z M10,1 L11,1 L11,6 L10,6 L10,1 Z" id="Combined-Shape" fill="#1181FB"></path>\n                <path d="M13,0 L16,0 L16,7 L13,7 L13,0 Z M14,1 L15,1 L15,6 L14,6 L14,1 Z" id="Combined-Shape-Copy-2" fill="#1181FB"></path>\n              </g>\n            </svg>\n            <span class="u-lSpace">\n              '+
((__t=( _t('dataset.options.add-column') ))==null?'':_.escape(__t))+
'\n            </span>\n          </div>\n        </button>\n      </li>\n    ';
 } 
__p+='\n    <li class="u-lSpace--xl">\n      <button class="CDB-Text CDB-Size-small is-semibold u-actionTextColor u-upperCase is-disabled js-export">\n        <div class="u-flex u-alignCenter">\n          <svg width="11px" height="18px" viewBox="-1 2 11 10" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n            <g id="Esport" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(0.000000, 3.000000)" stroke-linecap="square">\n              <path d="M4.5,0.5 L4.5,6.5" id="Line" stroke="#1181FB"></path>\n              <path d="M4.5,7.5 L8.5,3.5" id="Line" stroke="#1181FB"></path>\n              <path d="M4.5,7.5 L0.5,3.5" id="Line" stroke="#1181FB"></path>\n            </g>\n          </svg>\n          <span class="u-lSpace">\n            '+
((__t=( _t('dataset.options.export') ))==null?'':_.escape(__t))+
'\n          </span>\n        </div>\n      </button>\n    </li>\n  </ul>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],384:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var TipsyTooltipView = require('../../components/tipsy-tooltip-view');
var CreationModalView = require('../../components/modals/creation/modal-creation-view');
var SyncOptionsModalView = require('../../components/modals/sync-options/sync-options-modal-view');
var SyncModel = require('../../data/synchronization-model');
var template = require('./dataset-content-sync.tpl');
var moment = require('moment');
var checkAndBuildOpts = require('../../helpers/required-opts');

var REQUIRED_OPTS = [
  'syncModel',
  'tableModel',
  'querySchemaModel',
  'modals'
];

module.exports = CoreView.extend({
  tagName: 'div',
  className: 'SyncInfo',

  events: {
    'click .js-options': '_onClickOptions',
    'click .js-syncNow': '_onClickSyncNow'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this._startSync = this._startSync.bind(this);

    this._initBinds();

    // Check sync now button
    if (this._syncModel.isSyncing()) {
      this._showSyncNowModal();
    }
  },

  render: function () {
    this.clearSubViews();
    var runAt = this._syncModel.get('run_at');

    var d = {
      canSyncNow: this._syncModel.canSyncNow(),
      fromExternalSource: this._syncModel.get('from_external_source'),
      ranAt: moment(this._syncModel.get('ran_at') || new Date()).fromNow(),
      runAt: moment(runAt).fromNow(),
      state: this._syncModel.get('state'),
      errorCode: this._syncModel.get('error_code'),
      errorMessage: this._syncModel.get('error_message')
    };

    // Due to the time we need to polling, we have to display to the user
    // that the sync will be in a moment
    if (!runAt || (new Date(runAt) <= new Date())) {
      d.runAt = _t('dataset.sync.in-a-moment');
    }

    this.$el
      .html(template(d))
      .removeClass()
      .addClass(this.className + ' ' + 'is-' + d.state);

    // Tipsy
    var tooltip = new TipsyTooltipView({
      el: this.$('.js-syncNowDisabled'),
      title: function () {
        return _t('dataset.sync.disabled', {
          gap: SyncModel.SYNC_GAP / (1000 * 60)
        });
      }
    });
    this.addView(tooltip);

    return this;
  },

  _initBinds: function () {
    // Unbind in clean method
    this._syncModel.bind('change', this.render, this);
  },

  _bindChangeSyncEvent: function () {
    this._syncModel.bind('change:state', this._finishSync, this);
  },

  _unbindChangeSyncEvent: function () {
    this._syncModel.unbind(null, null, this);
  },

  _onClickSyncNow: function (e) {
    if (e) this.killEvent(e);

    if (this._syncModel.canSyncNow()) {
      this._showSyncNowModal();
    }
  },

  _onClickOptions: function (e) {
    var self = this;
    var tableName = this._tableModel.getUnqualifiedName();

    this._modals.create(function (modalModel) {
      return new SyncOptionsModalView({
        modalModel: modalModel,
        syncModel: self._syncModel,
        tableName: tableName
      });
    });
  },

  _startSync: function () {
    this.render();
    this._bindChangeSyncEvent();
    this._syncModel.pollCheck();
  },

  _finishSync: function () {
    if (!this._syncModel.isSyncing()) {
      this._unbindChangeSyncEvent();
      this._syncModel.destroyCheck();

      // Reload table
      this._querySchemaModel.set({
        status: 'unfetched',
        query: 'SELECT * FROM ' + this._tableModel.getUnquotedName()
      });

      this.render();
    }
  },

  _showSyncNowModal: function (e) {
    var self = this;
    var tableName = this._tableModel.getUnqualifiedName();

    this._modals.create(function (modalModel) {
      return new CreationModalView({
        modalModel: modalModel,
        loadingTitle: _t('dataset.sync.loading', { tableName: tableName }),
        errorTitle: _t('dataset.sync.error', { tableName: tableName }),
        runAction: function (opts) {
          self._syncModel.set({
            state: 'syncing',
            error_code: '',
            error_message: ''
          });

          self._syncModel.bind('change:state', function () {
            if (!self._syncModel.isSyncing()) {
              modalModel.destroy();
            }
          }, self);

          self._syncModel.syncNow(self._startSync);
        }
      });
    });
  },

  clean: function () {
    this._unbindChangeSyncEvent();
    CoreView.prototype.clean.apply(this);
  }

});

},{"../../components/modals/creation/modal-creation-view":191,"../../components/modals/sync-options/sync-options-modal-view":239,"../../components/tipsy-tooltip-view":325,"../../data/synchronization-model":368,"../../helpers/required-opts":432,"./dataset-content-sync.tpl":385,"backbone/core-view":454,"moment":"moment"}],385:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<p class="CDB-Text CDB-Size-small u-secondaryTextColor">\n  <span class="SyncInfo-state SyncInfo-state--small SyncInfo-state--'+
((__t=( state ))==null?'':_.escape(__t))+
' u-rSpace--s"></span>\n  <span class="u-upperCase">\n    ';
 if (state === "success") { 
__p+='\n      '+
((__t=( _t('dataset.sync.synced', { ranAt: ranAt }) ))==null?'':_.escape(__t))+
'.\n    ';
 } else if (state === "syncing") { 
__p+='\n      '+
((__t=( _t('dataset.sync.syncing') ))==null?'':_.escape(__t))+
'...\n    ';
 } else if (state === "failure") { 
__p+='\n      '+
((__t=( _t('dataset.sync.sync-failed') ))==null?'':_.escape(__t))+
'.\n    ';
 } 
__p+='\n  </span>\n\n  ';
 if (state === "success") { 
__p+='\n    '+
((__t=( _t('dataset.sync.next', { runAt: runAt }) ))==null?'':_.escape(__t))+
'.\n  ';
 } else if (state === "syncing") { 
__p+='\n    ';
 /* There's no need to add extra text in this case. */ 
__p+='\n  ';
 } else if (errorCode || errorMessage) { 
__p+='\n    '+
((__t=( _t('dataset.sync.error-code', { errorCode: errorCode }) ))==null?'':_.escape(__t))+
': '+
((__t=( errorMessage ))==null?'':_.escape(__t))+
'.\n  ';
 } 
__p+='\n\n  ';
 if (!fromExternalSource) { 
__p+='\n    ';
 if (state !== "syncing") { 
__p+='\n      <button class="';
 if (canSyncNow) { 
__p+='u-actionTextColor js-syncNow';
 } else { 
__p+='is-disabled js-syncNowDisabled';
 } 
__p+='">'+
((__t=( _t('dataset.sync.sync-now') ))==null?'':_.escape(__t))+
'</button>.\n    ';
 } 
__p+='\n  ';
 } 
__p+='\n\n  ';
 if (state !== "syncing") { 
__p+='\n    <button class="js-options u-actionTextColor">'+
((__t=( _t('dataset.sync.view-options') ))==null?'':_.escape(__t))+
'</button>.\n  ';
 } 
__p+='\n</p>\n';
}
return __p;
};

},{"underscore":"underscore"}],386:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var TableManager = require('../../components/table/table-manager');
var DatasetContentOptionsView = require('./dataset-content-options-view');
var checkAndBuildOpts = require('../../helpers/required-opts');

var REQUIRED_OPTS = [
  'analysisDefinitionNodeModel',
  'configModel',
  'modals',
  'userModel',
  'visModel'
];

module.exports = CoreView.extend({

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);
    this.listenTo(this._visModel, 'change:name', this._onChangeTableVisName);
  },

  render: function () {
    this.clearSubViews();
    this._initViews();
    return this;
  },

  _initViews: function () {
    this._tableView = TableManager.create({
      relativePositionated: true,
      analysisDefinitionNodeModel: this._analysisDefinitionNodeModel,
      configModel: this._configModel,
      modals: this._modals,
      userModel: this._userModel
    });
    this.addView(this._tableView);
    this.$el.append(this._tableView.render().el);

    var datasetContentOptionsView = new DatasetContentOptionsView({
      modals: this._modals,
      userModel: this._userModel,
      analysisDefinitionNodeModel: this._analysisDefinitionNodeModel,
      configModel: this._configModel
    });
    datasetContentOptionsView.bind('addColumn', function () {
      this._tableView.addColumn();
    }, this);
    datasetContentOptionsView.bind('addRow', function () {
      this._tableView.addRow();
    }, this);

    this.addView(datasetContentOptionsView);
    this.$el.prepend(datasetContentOptionsView.render().el);
  },

  _onChangeTableVisName: function () {
    // Although all operations related with table rename are managed in the analysis-definition-source-node-model
    // this columnsCollection doesn't belong to it and we need to take from it is generated.
    this._tableView && this._tableView.getColumnsCollection().setTableName(this._visModel.get('name'));
  }
});

},{"../../components/table/table-manager":322,"../../helpers/required-opts":432,"./dataset-content-options-view":382,"backbone/core-view":454}],387:[function(require,module,exports){
var _ = require('underscore');
var ContextMenuView = require('../../components/context-menu/context-menu-view');
var CustomListCollection = require('../../components/custom-list/custom-list-collection');
var REQUIRED_OPTS = [
  'ev',
  'isTableOwner',
  'isSync',
  'isCustomQuery',
  'triggerElementID'
];

module.exports = function (opts) {
  _.each(REQUIRED_OPTS, function (item) {
    if (opts[item] === undefined) throw new Error(item + ' is required');
    this['_' + item] = opts[item];
  }, this);

  var position = { x: this._ev.clientX, y: this._ev.clientY };
  var menuItems = [
    {
      label: _t('dataset.duplicate.' + (this._isCustomQuery ? 'customOption' : 'option')),
      val: 'duplicate',
      action: function () {
        this.trigger('duplicate', this);
      }
    }
  ];

  if (this._isTableOwner) {
    if (!this._isSync) {
      menuItems.push({
        label: _t('dataset.rename.option'),
        val: 'rename',
        action: function () {
          this.trigger('rename', this);
        }
      });
    }

    menuItems = menuItems.concat([
      {
        label: _t('dataset.metadata.option'),
        val: 'metadata',
        action: function () {
          this.trigger('metadata', this);
        }
      }, {
        label: _t('dataset.lock.option'),
        val: 'lock',
        action: function () {
          this.trigger('lock', this);
        }
      }, {
        label: _t('dataset.delete.option'),
        val: 'delete',
        destructive: true,
        action: function () {
          this.trigger('delete', this);
        }
      }
    ]);
  }

  var collection = new CustomListCollection(menuItems);

  var view = new ContextMenuView({
    collection: collection,
    triggerElementID: this._triggerElementID,
    position: position
  });

  collection.bind('change:selected', function (menuItem) {
    var action = menuItem.get('action');
    action && action.bind(view)(menuItem);
  }, view);

  view.model.bind('change:visible', function (model, isContextMenuVisible) {
    if (view && !isContextMenuVisible) {
      collection.unbind(null, null, view);
      view.model.unbind(null, null, view);
      view.remove();
    }
  }, view);

  return view;
};

},{"../../components/context-menu/context-menu-view":15,"../../components/custom-list/custom-list-collection":23,"underscore":"underscore"}],388:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./dataset-header.tpl');
var moment = require('moment');
var InlineEditorView = require('../../components/inline-editor/inline-editor-view');
var TipsyTooltipView = require('../../components/tipsy-tooltip-view');
var renameTableOperation = require('../operations/table-rename-operation');
var templateInlineEditor = require('./inline-editor.tpl');
var ConfirmationModalView = require('../../components/modals/confirmation/modal-confirmation-view');
var RemoveDatasetModalView = require('../../components/modals/remove-dataset/remove-dataset-view');
var PublishView = require('../../components/modals/publish/publish-view');
var PrivacyDropdown = require('../../components/privacy-dropdown/privacy-dropdown-view');
var PrivacyCollection = require('../../components/modals/publish/privacy-collection');
var CreatePrivacyOptions = require('../../components/modals/publish/create-privacy-options');
var ShareWith = require('../../components/modals/publish/share-with-view');
var CreationModalView = require('../../components/modals/creation/modal-creation-view');
var EditMetadataView = require('../../components/modals/dataset-metadata/dataset-metadata-view');
var VisTableModel = require('../../data/visualization-table-model');
var templateConfirmation = require('./rename-confirmation-modal.tpl');
var createContextMenu = require('./create-context-menu');
var tableDuplicationOperation = require('../operations/table-duplication-operation');
var checkAndBuildOpts = require('../../helpers/required-opts');
var TITLE_SUFFIX = ' | CARTO';

var PRIVACY_MAP = {
  public: 'green',
  link: 'orange',
  private: 'red'
};

var REQUIRED_OPTS = [
  'analysisDefinitionNodeModel',
  'configModel',
  'layerDefinitionModel',
  'modals',
  'router',
  'userModel',
  'visModel'
];

module.exports = CoreView.extend({

  className: 'Editor-HeaderInfoEditor',

  events: {
    'click .js-options': '_showContextMenu',
    'click .js-privacy': '_onPrivacyClick'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    var privacyOptions = CreatePrivacyOptions(this._visModel, this._userModel);
    this._querySchemaModel = this._analysisDefinitionNodeModel.querySchemaModel;
    this._tableModel = this._analysisDefinitionNodeModel.getTableModel();
    this._syncModel = this._tableModel.getSyncModel();
    this._privacyCollection = new PrivacyCollection(privacyOptions);

    this._setDocumentTitle();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    var privacy = this._visModel.get('privacy');
    var isOwner = this._tableModel.isOwner(this._userModel);
    var permissionModel = this._tableModel._permissionModel;
    var hasWriteAccess = permissionModel.isOwner(this._userModel) || permissionModel.hasWriteAccess(this._userModel);

    this.$el.html(
      template({
        title: this._tableModel.getUnqualifiedName(),
        privacy: privacy,
        isOwner: this._tableModel.isOwner(this._userModel),
        isCustomQueryApplied: this._isCustomQueryApplied(),
        privacyDOMElement: isOwner ? 'button' : 'span',
        isSync: this._tableModel.isSync(),
        syncState: this._syncModel.get('state'),
        cssClass: PRIVACY_MAP[privacy.toLowerCase()],
        ago: moment(this._visModel.get('updated_at')).fromNow(),
        avatar: this._userModel.get('avatar_url'),
        isInsideOrg: this._userModel.isInsideOrg(),
        hasWriteAccess: hasWriteAccess
      })
    );

    this._initViews();
    return this;
  },

  _initBinds: function () {
    this.listenTo(this._syncModel, 'change:state change:interval destroy', this.render);
    this.listenTo(this._visModel, 'change:name', this._onChangeName);
    this.listenTo(this._visModel, 'change:privacy change:name', this.render);
    this.listenTo(this._querySchemaModel, 'change:query', this.render);
  },

  _initViews: function () {
    var privacyDropdown;
    var shareWith;
    var isOwner = this._tableModel.isOwner(this._userModel);

    if (this._isDatasetOwner() && !this._tableModel.isSync()) {
      this._inlineEditor = new InlineEditorView({
        template: templateInlineEditor,
        renderOptions: {
          name: this._tableModel.getUnqualifiedName()
        },
        onEdit: this._onRenameTable.bind(this)
      });

      this.$('.js-name').html(this._inlineEditor.render().el);
      this.addView(this._inlineEditor);
    }

    if (!this._userModel.isInsideOrg()) {
      privacyDropdown = new PrivacyDropdown({
        privacyCollection: this._privacyCollection,
        visDefinitionModel: this._visModel,
        userModel: this._userModel,
        configModel: this._configModel
      });

      this.$('.js-privacyDropdown').html(privacyDropdown.render().el);
      this.addView(privacyDropdown);
    }

    if (isOwner && this._userModel.isInsideOrg()) {
      shareWith = new ShareWith({
        visDefinitionModel: this._visModel,
        userModel: this._userModel,
        action: this._onPrivacyClick.bind(this),
        separationClass: 'u-rSpace--m'
      });
      this.$('.js-share-users').append(shareWith.render().el);
      this.addView(shareWith);
    }

    if (this._tableModel.isSync() && this.$('.js-syncState').length) {
      var tooltip = new TipsyTooltipView({
        el: this.$('.js-syncState'),
        gravity: 'n',
        title: function () {
          return this._getSyncInfo();
        }.bind(this)
      });
      this.addView(tooltip);
    }
  },

  _showContextMenu: function (ev) {
    var isTableOwner = this._tableModel.isOwner(this._userModel);
    var isSync = this._tableModel.isSync();
    var triggerElementID = 'context-menu-trigger-' + this._tableModel.cid;
    this.$('.js-options').attr('id', triggerElementID);

    if (this._menuView && this._menuView.isVisible()) {
      this._menuView.hide();
      this._menuView.clean();
      delete this._menuView;
      return;
    }

    this._menuView = createContextMenu({
      ev: ev,
      isTableOwner: isTableOwner,
      isCustomQuery: this._isCustomQueryApplied(),
      isSync: isSync,
      triggerElementID: triggerElementID
    });
    this._menuView.bind('rename', function () {
      this._inlineEditor && this._inlineEditor.edit();
    }, this);
    this._menuView.bind('delete', this._deleteDataset, this);
    this._menuView.bind('duplicate', this._duplicateDataset, this);
    this._menuView.bind('lock', this._lockDataset, this);
    this._menuView.bind('metadata', this._metadataDataset, this);

    this._menuView.show();
    this.addView(this._menuView);
  },

  _deleteDataset: function () {
    var self = this;

    this._modals.create(function (modalModel) {
      return new RemoveDatasetModalView({
        modalModel: modalModel,
        userModel: self._userModel,
        visModel: self._visModel,
        tableModel: self._tableModel,
        configModel: self._configModel
      });
    });
  },

  _duplicateDataset: function () {
    var self = this;
    var tableName = this._tableModel.getUnquotedName();
    var name = this._isCustomQueryApplied() ? _t('dataset.duplicate.query') : tableName;

    this._modals.create(function (modalModel) {
      return new CreationModalView({
        modalModel: modalModel,
        loadingTitle: _t('dataset.duplicate.loading', { name: name }),
        errorTitle: _t('dataset.duplicate.error', { name: name }),
        runAction: function (opts) {
          tableDuplicationOperation({
            query: self._querySchemaModel.get('query'),
            tableModel: self._tableModel,
            configModel: self._configModel,
            onSuccess: function (importModel) {
              var tableName = importModel.get('table_name');
              var visTableModel = new VisTableModel({
                id: tableName,
                table: {
                  name: tableName
                }
              }, {
                configModel: self._configModel
              });

              window.location = visTableModel.datasetURL();
            },
            onError: function (importModel) {
              var error = importModel.get('get_error_text');
              var errorMessage = error && error.title;
              opts.error && opts.error(errorMessage);
            }
          });
        }
      });
    });
  },

  _lockDataset: function () {
    var self = this;
    var tableName = this._tableModel.getUnquotedName();

    this._modals.create(function (modalModel) {
      return new CreationModalView({
        modalModel: modalModel,
        loadingTitle: _t('dataset.lock.loading', { tableName: tableName }),
        errorTitle: _t('dataset.lock.error', { tableName: tableName }),
        runAction: function (opts) {
          self._visModel.save({
            locked: true
          }, {
            wait: true,
            success: function () {
              window.location = self._configModel.get('base_url') + '/dashboard/datasets';
            },
            error: function () {
              opts.error && opts.error();
            }
          });
        }
      });
    });
  },

  _metadataDataset: function () {
    var isLocked = this._tableModel.isSync();
    var self = this;
    this._modals.create(function (modalModel) {
      return new EditMetadataView({
        modalModel: modalModel,
        visDefinitionModel: self._visModel,
        configModel: self._configModel,
        isLocked: isLocked
      });
    });
  },

  _onRenameTable: function (newName) {
    var self = this;
    this._inlineEditor.hide();

    if (newName === this._visModel.get('name')) {
      return;
    }

    this._modals.create(function (modalModel) {
      return new ConfirmationModalView({
        modalModel: modalModel,
        template: templateConfirmation,
        renderOpts: {
          tableName: self._visModel.get('name')
        },
        runAction: function () {
          modalModel.destroy();

          renameTableOperation({
            visModel: self._visModel,
            newName: newName,
            onError: self._onRenameFailed.bind(self)
          });
        }
      });
    });
  },

  _onRenameFailed: function () {
    this._visModel.set('name', this._visModel.previous('name'), { silent: true });
    this.render();
  },

  _onChangeName: function () {
    var name = this._visModel.get('name');
    this._analysisDefinitionNodeModel.setTableName(name);

    this._setDocumentTitle();

    this._layerDefinitionModel.save({
      sql: this._analysisDefinitionNodeModel.getDefaultQuery()
    });

    this._router.navigate(name, {
      replace: true
    });
  },

  _onPrivacyClick: function () {
    var self = this;

    this._modals.create(function (modalModel) {
      return new PublishView({
        mapcapsCollection: self._mapcapsCollection,
        modalModel: modalModel,
        visDefinitionModel: self._visModel,
        privacyCollection: self._privacyCollection,
        userModel: self._userModel,
        configModel: self._configModel,
        mode: 'share'
      });
    });
  },

  _getSyncInfo: function () {
    var state = this._syncModel.get('state');
    if (state === 'success') {
      return _t('dataset.sync.synced', { ranAt: moment(this._syncModel.get('ran_at') || new Date()).fromNow() });
    } else if (state === 'failure') {
      var errorCode = this._syncModel.get('error_code');
      var errorMessage = this._syncModel.get('error_message');
      return _t('dataset.sync.error-code', { errorCode: errorCode }) + ':' + errorMessage;
    } else {
      return _t('dataset.sync.syncing');
    }
  },

  _setDocumentTitle: function () {
    document.title = this._tableModel.get('name') + TITLE_SUFFIX;
  },

  _isCustomQueryApplied: function () {
    return this._analysisDefinitionNodeModel.isCustomQueryApplied();
  },

  _isEditable: function () {
    return !this._analysisDefinitionNodeModel.isReadOnly();
  },

  _isDatasetOwner: function () {
    return this._tableModel.isOwner(this._userModel);
  }

});

},{"../../components/inline-editor/inline-editor-view":182,"../../components/modals/confirmation/modal-confirmation-view":190,"../../components/modals/creation/modal-creation-view":191,"../../components/modals/dataset-metadata/dataset-metadata-view":193,"../../components/modals/publish/create-privacy-options":206,"../../components/modals/publish/privacy-collection":207,"../../components/modals/publish/publish-view":212,"../../components/modals/publish/share-with-view":223,"../../components/modals/remove-dataset/remove-dataset-view":237,"../../components/privacy-dropdown/privacy-dropdown-view":268,"../../components/tipsy-tooltip-view":325,"../../data/visualization-table-model":379,"../../helpers/required-opts":432,"../operations/table-duplication-operation":403,"../operations/table-rename-operation":404,"./create-context-menu":387,"./dataset-header.tpl":389,"./inline-editor.tpl":390,"./rename-confirmation-modal.tpl":391,"backbone/core-view":454,"moment":"moment"}],389:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Editor-HeaderInfo-inner">\n  <div class="Editor-HeaderInfo-title u-bSpace--m u-flex u-alignCenter">\n    ';
 if (isSync && isOwner) { 
__p+='\n      <div class="Editor-HeaderInfo-actions">\n        <span class="SyncInfo-state SyncInfo-state--'+
((__t=( syncState ))==null?'':_.escape(__t))+
' u-rSpace--m js-syncState"></span>\n      </div>\n    ';
 } 
__p+='\n\n    <div class="Editor-HeaderInfo-titleText is-larger js-name">\n      <h2 class="u-ellipsis CDB-Text CDB-Size-huge is-light">'+
((__t=( title ))==null?'':_.escape(__t))+
'</h2>\n    </div>\n\n    <div class="Editor-HeaderInfo-details u-lSpace">\n      ';
 if (!hasWriteAccess) { 
__p+='\n        <span class="Tag CDB-Text CDB-Size-small u-rSpace u-upperCase js-readPermissionTag">'+
((__t=( _t('dataset.read') ))==null?'':_.escape(__t))+
'</span>\n      ';
 } 
__p+='\n\n      ';
 if (isCustomQueryApplied) { 
__p+='\n        <span class="Tag Tag--outline Tag-outline--dark CDB-Text CDB-Size-small u-secondaryTextColor u-rSpace">'+
((__t=( _t('dataset.sql') ))==null?'':_.escape(__t))+
'</span>\n      ';
 } 
__p+='\n\n      <button class="CDB-Shape js-options">\n        <div class="CDB-Shape-threePoints is-blue is-small">\n          <div class="CDB-Shape-threePointsItem"></div>\n          <div class="CDB-Shape-threePointsItem"></div>\n          <div class="CDB-Shape-threePointsItem"></div>\n        </div>\n      </button>\n    </div>\n  </div>\n\n  <div class="u-bSpace--xl u-flex u-alignCenter">\n    <div class="js-privacyDropdown u-rSpace--m">\n      <'+
((__t=( privacyDOMElement ))==null?'':_.escape(__t))+
' class="u-actionTextColor ';
 if (isOwner) { 
__p+='js-privacy';
 } 
__p+='">\n        <i class="Tag Tag--big Tag-fill Tag-fill--'+
((__t=( cssClass ))==null?'':_.escape(__t))+
' CDB-Text CDB-Size-small u-upperCase">'+
((__t=( privacy ))==null?'':_.escape(__t))+
'</i>\n      </'+
((__t=( privacyDOMElement ))==null?'':_.escape(__t))+
'>\n    </div>\n    ';
 if (isOwner && isInsideOrg) { 
__p+='\n      <div class="js-share-users"></div>\n    ';
 } 
__p+='\n    <span class="CDB-Text CDB-Size-medium u-altTextColor">'+
((__t=( _t('dataset.updated', { ago: ago }) ))==null?'':_.escape(__t))+
'</span>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],390:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="Inline-editor" title="'+
((__t=( name ))==null?'':_.escape(__t))+
'">\n  <h2 class="CDB-Text CDB-Size-huge is-light u-ellipsis js-title Inline-editor-text is-larger">'+
((__t=( name ))==null?'':_.escape(__t))+
'</h2>\n  <input type="text" name="text" class="Inline-editor-input Inline-editor-input--small CDB-Text CDB-InputText js-input" value="'+
((__t=( name ))==null?'':_.escape(__t))+
'" readonly>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],391:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--grid u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="12px" height="23px" viewBox="0 0 12 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <path d="M3.85948829,15.9093411 L3.85948829,15.113874 C3.85948829,13.9648603 4.03625698,13.0196388 4.38979966,12.2781813 C4.74334234,11.5367237 5.40131468,10.7535402 6.36373642,9.92860729 C7.6993421,8.79923484 8.54144849,7.94976308 8.89008086,7.38016654 C9.23871322,6.81057 9.41302679,6.12313622 9.41302679,5.31784456 C9.41302679,4.3161403 9.09140598,3.54277728 8.44815472,2.99773232 C7.80490345,2.45268735 6.87932296,2.18016896 5.67138547,2.18016896 C4.8955557,2.18016896 4.13937853,2.27100842 3.40283128,2.45269008 C2.66628403,2.63437173 1.82172252,2.96581302 0.869121409,3.44702389 L0,1.45835626 C1.85609907,0.486113893 3.7956444,0 5.81869418,0 C7.69443451,0 9.15277619,0.461562686 10.193763,1.38470191 C11.2347497,2.30784113 11.7552353,3.60905508 11.7552353,5.28838281 C11.7552353,6.0052888 11.6594856,6.63625482 11.4679833,7.18129978 C11.2764811,7.72634475 10.9941422,8.24192009 10.6209582,8.72804127 C10.2477743,9.21416246 9.44249472,9.99734595 8.20509534,11.0776153 C7.21321171,11.9221894 6.55769449,12.6243539 6.23852401,13.1841299 C5.91935354,13.7439058 5.7597707,14.4902624 5.7597707,15.4232223 L5.7597707,15.9093411 L3.85948829,15.9093411 Z M2.95990869,20.3988536 C2.95990869,19.3235103 3.49337277,18.7858468 4.56031694,18.7858468 C5.07600662,18.7858468 5.47388191,18.9242161 5.75395476,19.2009588 C6.0340276,19.4777016 6.17406192,19.8769958 6.17406192,20.3988536 C6.17406192,20.9048974 6.03180483,21.2982616 5.74728639,21.5789578 C5.46276794,21.859654 5.06711542,22 4.56031694,22 C4.09797446,22 3.71565854,21.8754676 3.41335769,21.6263992 C3.11105685,21.3773307 2.95990869,20.9681529 2.95990869,20.3988536 Z" stroke="none" fill="#FEB100" fill-rule="evenodd" opacity="1"></path>\n      </svg>\n    </div>\n    <div>\n      <h2 class=" CDB-Text CDB-Size-huge is-light u-bSpace--xl">\n        '+
((__t=( _t('dataset.rename.title', { tableName: tableName }) ))==null?'':_.escape(__t))+
'\n      </h2>\n      <p class="CDB-Text CDB-Size-large u-altTextColor">'+
((__t=( _t('dataset.rename.desc') ))==null?'':_.escape(__t))+
'</p>\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('dataset.rename.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('dataset.rename.confirm') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>';
}
return __p;
};

},{"underscore":"underscore"}],392:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<ul class="CodeMirror-error">\n  <li class="CodeMirror-errorMessage u-lSpace--xl u-rSpace--xl">\n    '+
((__t=( _t('components.codemirror.syntax-error') ))==null?'':_.escape(__t))+
': <span>'+
((__t=( message ))==null?'':_.escape(__t))+
'</span>\n  </li>\n  <li class="CodeMirror-errorDocs">\n    <a href="https://carto.com/docs/cartodb-platform/sql-api/" target="_black">'+
((__t=( _t('components.codemirror.docs') ))==null?'':_.escape(__t))+
'</a>\n  </li>\n</ul>\n';
}
return __p;
};

},{"underscore":"underscore"}],393:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var template = require('./dataset-actions.tpl');
var UndoButtons = require('../../components/undo-redo/undo-redo-view');
var checkAndBuildOpts = require('../../helpers/required-opts');

var REQUIRED_OPTS = [
  'mapAction',
  'previewAction',
  'trackModel',
  'editorModel',
  'queryGeometryModel',
  'onApply',
  'onClear',
  'clearSQLModel'
];

module.exports = CoreView.extend({
  className: 'Dataset-options-actions',

  events: {
    'click .js-createMap': '_onCreateMap',
    'click .js-previewMap': '_onPreviewMap'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._queryGeometryModel.bind('change:status', this.render, this);
    this.add_related_model(this._queryGeometryModel);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(
      template({
        hasGeometry: this._queryGeometryModel.hasValue(),
        canCreateMap: true
      })
    );
    this._initViews();
    return this;
  },

  _initViews: function () {
    var view = new UndoButtons({
      className: 'u-rSpace--xl',
      trackModel: this._trackModel,
      editorModel: this._editorModel,
      clearModel: this._clearSQLModel,
      applyButton: true,
      clearButton: true,
      onApplyClick: this._onApply.bind(this),
      onClearClick: this._onClear.bind(this)
    });

    this.$('.js-createMap').before(view.render().el);
    this.addView(view);
  },

  _onApply: function () {
    this._onApply && this._onApply();
  },

  _onClear: function () {
    this._onClear && this._onClear();
  },

  _onCreateMap: function () {
    this._mapAction && this._mapAction();
  },

  _onPreviewMap: function () {
    this._previewAction && this._previewAction();
  }
});

},{"../../components/undo-redo/undo-redo-view":328,"../../helpers/required-opts":432,"./dataset-actions.tpl":395,"backbone/core-view":454}],394:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var _ = require('underscore');
var template = require('./dataset-actions.tpl');

// 'mapAction' is not required  because a viewer user can't create maps
var OPTS = {
  previewAction: true,
  queryGeometryModel: true,
  mapAction: false
};

module.exports = CoreView.extend({
  className: 'Dataset-options-actions',

  events: {
    'click .js-createMap': '_onCreateMap',
    'click .js-previewMap': '_onPreviewMap'
  },

  initialize: function (opts) {
    _.each(OPTS, function (isRequired, item) {
      if (opts[item]) {
        this['_' + item] = opts[item];
      } else if (isRequired) {
        throw new Error(item + ' is required');
      }
    }, this);

    this._queryGeometryModel.bind('change:status', this.render, this);
    this.add_related_model(this._queryGeometryModel);
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(
      template({
        hasGeometry: this._queryGeometryModel.hasValue(),
        canCreateMap: !!this._mapAction
      })
    );
    return this;
  },

  _onPreviewMap: function () {
    this._previewAction && this._previewAction();
  },

  _onCreateMap: function () {
    this._mapAction && this._mapAction();
  }
});

},{"./dataset-actions.tpl":395,"backbone/core-view":454,"underscore":"underscore"}],395:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='';
 if (hasGeometry) { 
__p+='\n  <button class="u-rSpace--xl Dataset-tablePreview js-previewMap">\n    <span class="u-upperCase CDB-Button-Text CDB-Text CDB-Size-small">'+
((__t=( _t('dataset.preview-map.preview') ))==null?'':_.escape(__t))+
'</span>\n  </button>\n';
 } 
__p+='\n';
 if (canCreateMap) { 
__p+='\n  <button class="CDB-Button CDB-Button--primary u-upperCase js-createMap">\n    <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-small">'+
((__t=( _t('dataset.create-map.title') ))==null?'':_.escape(__t))+
'</span>\n  </button>\n';
 } 
__p+='\n';
}
return __p;
};

},{"underscore":"underscore"}],396:[function(require,module,exports){
var $ = require('jquery');
var CoreView = require('backbone/core-view');
var VisDefinitionModel = require('../../data/vis-definition-model');
var CreationModalView = require('../../components/modals/creation/modal-creation-view');
var DatasetBaseView = require('../../components/dataset/dataset-base-view');
var errorParser = require('../../helpers/error-parser');
var PanelWithOptionsView = require('../../components/view-options/panel-with-options-view');
var TabPaneView = require('../../components/tab-pane/tab-pane-view');
var TabPaneCollection = require('../../components/tab-pane/tab-pane-collection');
var Toggler = require('../../components/toggler/toggler-view');
var DatasetEditorView = require('./dataset-sql-view');
var ActionView = require('./dataset-actions-view');
var PreviewMapView = require('./preview-map-view');
var ActionViewEdition = require('./dataset-actions-edition-view');
var DataSQLModel = require('../data-sql-model');
var SQLNotifications = require('../../sql-notifications');
var MetricsTracker = require('../../components/metrics/metrics-tracker');
var checkAndBuildOpts = require('../../helpers/required-opts');

var REQUIRED_OPTS = [
  'analysisDefinitionNodeModel',
  'configModel',
  'editorModel',
  'layerDefinitionModel',
  'modals',
  'router',
  'userModel',
  'visModel'
];

module.exports = DatasetBaseView.extend({

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._querySchemaModel = this._analysisDefinitionNodeModel.querySchemaModel;

    if (!this._layerDefinitionModel.sqlModel) {
      var sqlHistory = this._layerDefinitionModel.options && this._layerDefinitionModel.options.sql_history;
      this._layerDefinitionModel.sqlModel = new DataSQLModel({
        content: this._querySchemaModel.get('query')
      }, {
        history: sqlHistory || []
      });
    }

    DatasetBaseView.prototype.initialize.call(this, {
      layerDefinitionModel: this._layerDefinitionModel,
      editorModel: this._editorModel,
      configModel: this._configModel,
      querySchemaModel: this._querySchemaModel
    });

    this._tableModel = this._analysisDefinitionNodeModel.getTableModel();
    this._queryGeometryModel = this._analysisDefinitionNodeModel.queryGeometryModel;
    this._canCreateMap = this._userModel.hasCreateMapsFeature();
    this._parseSQL = this._internalParseSQL.bind(this);

    SQLNotifications.track(this);

    this._configPanes();
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    this._checkClearButton();
    return this;
  },

  _initBinds: function () {
    this.listenTo(this._editorModel, 'change:edition', this._onChangeEdition);
    this.listenTo(this._querySchemaModel, 'change:query_errors', this._showErrors);
    this.listenTo(this._visModel, 'change:name', this._onChangeName);
    this.listenTo(this._sqlModel, 'undo redo', function () {
      this._codemirrorModel.set('content', this._sqlModel.get('content'));
    });
  },

  _onChangeName: function (model, name) {
    this._codemirrorModel.set('content', this._analysisDefinitionNodeModel.getDefaultQuery());
  },

  _initViews: function () {
    var self = this;

    var panelWithOptionsView = new PanelWithOptionsView({
      editorModel: self._editorModel,
      createContentView: function () {
        return new TabPaneView({
          collection: self._collectionPane
        });
      },
      createControlView: function () {
        return new Toggler({
          editorModel: self._editorModel,
          labels: [_t('dataset.data'), _t('dataset.sql')]
        });
      },
      createActionView: function () {
        return new TabPaneView({
          collection: self._collectionPane,
          createContentKey: 'createActionView'
        });
      }
    });

    this.$el.append(panelWithOptionsView.render().el);
    this.addView(panelWithOptionsView);
  },

  _onChangeEdition: function () {
    this.$el.toggleClass('is-dark', this._editorModel.isEditing());

    var edition = this._editorModel.get('edition');
    var index = edition ? 1 : 0;
    this._collectionPane.at(index).set({ selected: true });
  },

  _configPanes: function () {
    var self = this;
    var tabPaneTabs = [{
      selected: !this._editorModel.get('edition'),
      createContentView: function () {
        return new CoreView();
      },
      createActionView: function () {
        var actionViewOptions = {
          queryGeometryModel: self._queryGeometryModel,
          previewAction: self._previewMap.bind(self)
        };
        if (self._canCreateMap) {
          actionViewOptions.mapAction = self._createMap.bind(self);
        }
        return new ActionView(actionViewOptions);
      }
    }, {
      selected: this._editorModel.get('edition'),
      createContentView: function () {
        return new DatasetEditorView({
          editorModel: self._editorModel,
          codemirrorModel: self._codemirrorModel,
          onApplyEvent: self._parseSQL,
          layerDefinitionModel: self._layerDefinitionModel,
          querySchemaModel: self._querySchemaModel
        });
      },
      createActionView: function () {
        var actionViewOptions = {
          clearSQLModel: self._clearSQLModel,
          trackModel: self._sqlModel,
          editorModel: self._editorModel,
          queryGeometryModel: self._queryGeometryModel,
          onApply: self._parseSQL,
          previewAction: self._previewMap.bind(self),
          onClear: self._clearSQL.bind(self)
        };
        if (self._canCreateMap) {
          actionViewOptions.mapAction = self._createMap.bind(self);
        }
        return new ActionViewEdition(actionViewOptions);
      }
    }];

    this._collectionPane = new TabPaneCollection(tabPaneTabs);
  },

  _runQuery: function (query, callback) {
    this._querySchemaModel.set({
      query: query,
      status: 'unfetched'
    });

    this._queryGeometryModel.set({
      query: query,
      simple_geom: '',
      status: 'unfetched'
    }, {
      silent: true
    });

    this._querySchemaModel.fetch({
      success: callback
    });

    this._queryGeometryModel.fetch();
  },

  _saveSQL: function () {
    var content = this._codemirrorModel.get('content');
    this._sqlModel.set('content', content);
    this._querySchemaModel.set('query_errors', []);

    if (this._tableModel.hasWriteAccess(this._userModel)) {
      this._layerDefinitionModel.save({
        sql: content
      });

      MetricsTracker.track('Applied sql', {
        dataset_id: this._tableModel.get('id'),
        sql: content
      });
    }

    SQLNotifications.showNotification({
      status: 'success',
      info: _t('notifications.sql.success'),
      closable: true
    });

    this._checkClearButton();
  },

  _defaultSQL: function () {
    return this._analysisDefinitionNodeModel.getDefaultQuery();
  },

  _previewMap: function () {
    var previewMap = new PreviewMapView({
      analysisDefinitionNodeModel: this._analysisDefinitionNodeModel,
      configModel: this._configModel,
      modals: this._modals,
      userModel: this._userModel,
      visModel: this._visModel
    });
    $('body').append(previewMap.render().el);
    this.addView(previewMap);
  },

  _createMap: function () {
    var self = this;
    var tableName = this._tableModel.getUnquotedName();

    this._modals.create(function (modalModel) {
      return new CreationModalView({
        modalModel: modalModel,
        loadingTitle: _t('dataset.create-map.loading', { tableName: tableName }),
        errorTitle: _t('dataset.create-map.error', { tableName: tableName }),
        runAction: function (opts) {
          var newVisModel = new VisDefinitionModel({
            name: self._visModel.get('name') + ' ' + _t('editor.map')
          }, {
            configModel: self._configModel
          });

          newVisModel.save({
            source_visualization_id: self._visModel.get('id')
          }, {
            success: function (visModel) {
              window.location = visModel.builderURL();
            },
            error: function (mdl, e) {
              opts.error && opts.error(errorParser(e));
            }
          });
        }
      });
    });
  }
});

},{"../../components/dataset/dataset-base-view":36,"../../components/metrics/metrics-tracker":189,"../../components/modals/creation/modal-creation-view":191,"../../components/tab-pane/tab-pane-collection":277,"../../components/tab-pane/tab-pane-view":285,"../../components/toggler/toggler-view":326,"../../components/view-options/panel-with-options-view":330,"../../data/vis-definition-model":377,"../../helpers/error-parser":426,"../../helpers/required-opts":432,"../../sql-notifications":448,"../data-sql-model":381,"./dataset-actions-edition-view":393,"./dataset-actions-view":394,"./dataset-sql-view":397,"./preview-map-view":398,"backbone/core-view":454,"jquery":"jquery"}],397:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var CodeMirrorView = require('../../components/code-mirror/code-mirror-view');
var ErrorTemplate = require('./code-mirror-error.tpl');
var FactoryHints = require('../../editor/editor-hints/factory-hints');
var SQLHints = require('../../editor/editor-hints/sql-hints');

module.exports = CoreView.extend({

  className: 'Editor-content Dataset-editor',

  initialize: function (opts) {
    if (!opts.codemirrorModel) throw new Error('codemirrorModel is required');
    if (!opts.onApplyEvent) throw new Error('onApplyEvent');
    if (!opts.querySchemaModel) throw new Error('querySchemaModel is required');
    if (!opts.layerDefinitionModel) throw new Error('layerDefinitionModel is required');

    this._codemirrorModel = opts.codemirrorModel;
    this._querySchemaModel = opts.querySchemaModel;
    this._layerDefinitionModel = opts.layerDefinitionModel;

    FactoryHints.init({
      querySchemaModel: this._querySchemaModel,
      layerDefinitionModel: this._layerDefinitionModel,
      tokens: SQLHints
    });
  },

  render: function () {
    this.clearSubViews();
    this.$el.empty();
    this._initViews();
    return this;
  },

  _initViews: function () {
    var hints = FactoryHints.reset().hints;
    this.codeMirrorView = new CodeMirrorView({
      className: 'Dataset-codemirror',
      model: this._codemirrorModel,
      hints: hints,
      mode: 'text/x-pgsql',
      tip: _t('editor.data.code-mirror.tip'),
      errorTemplate: ErrorTemplate
    });

    this.codeMirrorView.bind('codeSaved', this._triggerCodeSaved, this);
    this.addView(this.codeMirrorView);
    this.$el.append(this.codeMirrorView.render().el);
  },

  _triggerCodeSaved: function (code, view) {
    this.options.onApplyEvent && this.options.onApplyEvent();
  }

});

},{"../../components/code-mirror/code-mirror-view":5,"../../editor/editor-hints/factory-hints":405,"../../editor/editor-hints/sql-hints":406,"./code-mirror-error.tpl":392,"backbone/core-view":454}],398:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var $ = require('jquery');
var cdb = require('cartodb.js');
var CreationModalView = require('../../components/modals/creation/modal-creation-view');
var VisDefinitionModel = require('../../data/vis-definition-model');
var errorParser = require('../../helpers/error-parser');
var template = require('./preview-map.tpl');
var checkAndBuildOpts = require('../../helpers/required-opts');
var ESC_KEY_CODE = 27;

var REQUIRED_OPTS = [
  'analysisDefinitionNodeModel',
  'configModel',
  'modals',
  'userModel',
  'visModel'
];

module.exports = CoreView.extend({

  className: 'PreviewMap',

  events: {
    'click .js-back': 'clean',
    'click .js-createMap': '_createMap'
  },

  initialize: function (opts) {
    checkAndBuildOpts(opts, REQUIRED_OPTS, this);

    this._tableModel = this._analysisDefinitionNodeModel.getTableModel();
    this._querySchemaModel = this._analysisDefinitionNodeModel.querySchemaModel;
    this._syncModel = this._tableModel.getSyncModel();
    this._canCreateMap = this._userModel.hasCreateMapsFeature();
    this._onKeyDown = this._onKeyDown.bind(this);

    this._initKeydownBinds();
  },

  render: function () {
    this.$el.html(
      template({
        isOwner: this._tableModel.isOwner(this._userModel),
        isSync: this._tableModel.isSync(),
        syncState: this._syncModel.get('state'),
        name: this._tableModel.get('name'),
        isCustomQueryApplied: this._analysisDefinitionNodeModel.isCustomQueryApplied(),
        canCreateMap: this._canCreateMap
      })
    );
    this._initViews();
    return this;
  },

  _initViews: function () {
    this._map = cdb.createVis(
      this.$('.js-map'),
      this._visModel.vizjsonURL(),
      {
        legends: false,
        authToken: this._configModel.get('auth_tokens')
      }
    );
  },

  _initKeydownBinds: function () {
    $(document).bind('keydown', this._onKeyDown);
  },

  _destroyKeydownBinds: function () {
    $(document).unbind('keydown', this._onKeyDown);
  },

  _onKeyDown: function (ev) {
    var keyCode = ev.which;
    if (keyCode === ESC_KEY_CODE) {
      this.clean();
    }
  },

  _createMap: function () {
    var self = this;
    var tableName = this._tableModel.getUnquotedName();

    this._modals.create(function (modalModel) {
      return new CreationModalView({
        modalModel: modalModel,
        loadingTitle: _t('dataset.create-map.loading', { tableName: tableName }),
        errorTitle: _t('dataset.create-map.error', { tableName: tableName }),
        runAction: function (opts) {
          var newVisModel = new VisDefinitionModel({
            name: self._visModel.get('name') + ' ' + _t('editor.map')
          }, {
            configModel: self._configModel
          });

          newVisModel.save({
            source_visualization_id: self._visModel.get('id')
          }, {
            success: function (visModel) {
              window.location = visModel.builderURL();
            },
            error: function (mdl, e) {
              opts.error && opts.error(errorParser(e));
            }
          });
        }
      });
    });
  },

  clean: function () {
    this._destroyKeydownBinds();
    CoreView.prototype.clean.call(this);
  }

});

},{"../../components/modals/creation/modal-creation-view":191,"../../data/vis-definition-model":377,"../../helpers/error-parser":426,"../../helpers/required-opts":432,"./preview-map.tpl":399,"backbone/core-view":454,"cartodb.js":"cartodb.js","jquery":"jquery"}],399:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="PreviewMap-canvas">\n  <div class="PreviewMap-map js-map"></div>\n  <div class="PreviewMap-info u-flex u-justifySpace u-alignCenter js-info">\n    <div class="PreviewMap-infoName u-flex u-alignCenter">\n      ';
 if (isSync && isOwner) { 
__p+='\n        <span class="SyncInfo-state SyncInfo-state--'+
((__t=( syncState ))==null?'':_.escape(__t))+
' u-rSpace--m js-syncState"></span>\n      ';
 } 
__p+='\n      <h2 class="u-ellipsis CDB-Text CDB-Size-large u-rSpace--m is-light">'+
((__t=( name ))==null?'':_.escape(__t))+
'</h2>\n      ';
 if (isCustomQueryApplied) { 
__p+='\n        <span class="CDB-Tag CDB-Tag--opaque u-secondaryTextColor CDB-Text CDB-Size-medium u-upperCase">'+
((__t=( _t('dataset.sql') ))==null?'':_.escape(__t))+
'</span>\n      ';
 } 
__p+='\n    </div>\n    <div class="PreviewMap-infoActions">\n      <button class="u-upperCase CDB-Text CDB-Size-small u-lSpace--xl u-actionTextColor js-back">\n        '+
((__t=( _t('dataset.preview-map.back') ))==null?'':_.escape(__t))+
'\n      </button>\n      ';
 if (canCreateMap) { 
__p+='\n        <button class="CDB-Button CDB-Button--primary u-upperCase u-lSpace--xl js-createMap">\n          <span class="CDB-Button-Text CDB-Text CDB-Size-small">'+
((__t=( _t('dataset.create-map.title') ))==null?'':_.escape(__t))+
'</span>\n        </button>\n      ';
 } 
__p+='\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],400:[function(require,module,exports){
var CoreView = require('backbone/core-view');
var $ = require('jquery');
var _ = require('underscore');
var errorParser = require('../helpers/error-parser');
var template = require('./dataset-unlock-modal.tpl');
var renderLoading = require('../components/loading/render-loading');
var ErrorView = require('../components/error/error-view');

var REQUIRED_OPTS = [
  'tableName',
  'visModel',
  'configModel',
  'modalModel'
];

/**
 *  Remove confirmation dialog
 */
module.exports = CoreView.extend({
  className: 'Dialog-content',

  events: {
    'click .js-confirm': '_onConfirm',
    'click .js-cancel': '_onCancel'
  },

  initialize: function (opts) {
    _.each(REQUIRED_OPTS, function (item) {
      if (!opts[item]) throw new Error(item + ' is required');
      this['_' + item] = opts[item];
    }, this);

    this._onKeyDown = this._onKeyDown.bind(this);
    this._initBinds();
  },

  render: function () {
    this.clearSubViews();
    this.$el.html(
      template({
        tableName: this._tableName
      })
    );
    return this;
  },

  _initBinds: function () {
    $(document).bind('keydown', this._onKeyDown);

    this._modalModel.bind('change:show', function () {
      if (this._visModel.get('locked')) {
        this._onCancel();
      }
    }, this);
    this.add_related_model(this._modalModel);
  },

  _disableBinds: function () {
    $(document).unbind('keydown', this._onKeyDown);
  },

  _onKeyDown: function (ev) {
    var keyCode = ev.which;
    if (keyCode === $.ui.keyCode.ENTER) {
      this._onConfirm();
    }
  },

  _renderLoadingView: function () {
    this.$el.html(
      renderLoading({
        title: _t('dataset.unlock.loading', { tableName: this._tableName })
      })
    );
  },

  _renderErrorView: function (errorMessage) {
    var errorView = new ErrorView({
      title: _t('dataset.unlock.error', { tableName: this._tableName }),
      desc: errorMessage
    });
    this.$el.html(errorView.render().el);
    this.addView(errorView);
  },

  _$content: function () {
    return this.$('.js-content');
  },

  _onConfirm: function () {
    this._renderLoadingView();

    this._visModel.save({
      locked: false
    }, {
      wait: true,
      success: function () {
        this._modalModel.destroy();
      }.bind(this),
      error: function (mdl, e) {
        this._renderErrorView(errorParser(e));
      }.bind(this)
    });
  },

  _onCancel: function () {
    window.location = this._configModel.get('base_url');
  },

  clean: function () {
    this._disableBinds();
    CoreView.prototype.clean.apply(this);
  }

});

},{"../components/error/error-view":37,"../components/loading/render-loading":187,"../helpers/error-parser":426,"./dataset-unlock-modal.tpl":401,"backbone/core-view":454,"jquery":"jquery","underscore":"underscore"}],401:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<div class="u-flex u-justifyCenter">\n  <div class="Modal-inner Modal-inner--grid u-flex u-justifyCenter">\n    <div class="Modal-icon">\n      <svg width="16px" height="24px" viewBox="0 5 16 24" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <g id="lock-open" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(0.000000, 5.000000)">\n          <path d="M14,10.727 L14,5.5 C14,2.467 11.532,0 8.5,0 C5.468,0 3,2.467 3,5.5 L4,5.5 C4,3.019 6.019,1 8.5,1 C10.981,1 13,3.019 13,5.5 L13,9.765 C11.629,8.663 9.892,8 8,8 C3.589,8 0,11.589 0,16 C0,20.411 3.589,24 8,24 C12.411,24 16,20.411 16,16 C16,13.979 15.24,12.136 14,10.727 L14,10.727 Z M8,23 C4.141,23 1,19.86 1,16 C1,12.14 4.141,9 8,9 C11.859,9 15,12.14 15,16 C15,19.86 11.859,23 8,23 L8,23 Z" id="Shape" fill="#000000 "></path>\n          <path d="M8,15 C7.448,15 7,15.449 7,16 C7,16.365 7.207,16.672 7.5,16.847 L7.5,19.5 C7.5,19.776 7.724,20 8,20 C8.276,20 8.5,19.776 8.5,19.5 L8.5,16.847 C8.793,16.672 9,16.365 9,16 C9,15.449 8.552,15 8,15 L8,15 Z" id="Shape" fill="#000000 "></path>\n        </g>\n      </svg>\n    </div>\n    <div>\n      <h2 class=" CDB-Text CDB-Size-huge is-light u-bSpace--xl">'+
((__t=( _t('dataset.unlock.title', { tableName: tableName }) ))==null?'':_.escape(__t))+
'</h2>\n      <p class="CDB-Text CDB-Size-large u-altTextColor">'+
((__t=( _t('dataset.unlock.desc') ))==null?'':_.escape(__t))+
'</p>\n      <ul class="Modal-listActions u-flex u-alignCenter">\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--secondary CDB-Button--big js-cancel">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('dataset.unlock.cancel') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n        <li class="Modal-listActionsitem">\n          <button class="CDB-Button CDB-Button--primary CDB-Button--big js-confirm">\n            <span class="CDB-Button-Text CDB-Text is-semibold CDB-Size-medium u-upperCase">\n              '+
((__t=( _t('dataset.unlock.confirm') ))==null?'':_.escape(__t))+
'\n            </span>\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n';
}
return __p;
};

},{"underscore":"underscore"}],402:[function(require,module,exports){
var Notifier = require('../../components/notifier/notifier');
var errorParser = require('../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.visModel) { throw new Error('visModel is required'); }

  var visModel = opts.visModel;
  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;

  visModel.destroy({
    wait: true,
    success: function (mdl, attrs) {
      successCallback && successCallback(mdl, attrs);
    },
    error: function (mdl, e) {
      errorCallback && errorCallback(mdl, e);
      Notifier.addNotification({
        status: 'error',
        info: _t('dataset.delete.error', {
          tableName: visModel.get('name'),
          error: errorParser(e)
        }),
        closable: true
      });
    }
  });
};

},{"../../components/notifier/notifier":252,"../../helpers/error-parser":426}],403:[function(require,module,exports){
var ImportModel = require('../../data/background-importer/import-model');

module.exports = function (opts) {
  if (!opts.tableModel) throw new Error('tableModel is required');
  if (!opts.query) throw new Error('query is required');
  if (!opts.configModel) throw new Error('configModel is required');

  var tableModel = opts.tableModel;
  var configModel = opts.configModel;
  var query = opts.query;
  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;
  var attrs = {
    table_name: tableModel.getUnqualifiedName() + '_copy',
    sql: query
  };

  var importModel = new ImportModel({}, {
    configModel: configModel
  });
  importModel.save(attrs, {
    error: errorCallback && errorCallback,
    success: function (model, changes) {
      model.bind('change:state', function () {
        var state = this.get('state');
        var success = this.get('success');
        if (state === 'failure') {
          errorCallback && errorCallback(model);
        } else if (state === 'complete' && success) {
          successCallback && successCallback(model);
        }
      }, model);
    }
  });
};

},{"../../data/background-importer/import-model":339}],404:[function(require,module,exports){
var Notifier = require('../../components/notifier/notifier');
var errorParser = require('../../helpers/error-parser');

module.exports = function (opts) {
  if (!opts.visModel) { throw new Error('visModel is required'); }
  if (!opts.newName) { throw new Error('newName is required'); }

  var visModel = opts.visModel;
  var newName = opts.newName;
  var successCallback = opts.onSuccess;
  var errorCallback = opts.onError;
  var notification = Notifier.addNotification({
    status: 'loading',
    info: _t('dataset.rename.loading', { tableName: visModel.get('name') }),
    closable: false
  });

  visModel.save({ name: newName }, {
    wait: true,
    success: function (mdl, attrs) {
      successCallback && successCallback(mdl, attrs);
      notification.set({
        status: 'success',
        info: _t('dataset.rename.success', { tableName: visModel.get('name') }),
        closable: true
      });
    },
    error: function (mdl, e) {
      errorCallback && errorCallback(mdl, e);
      notification.set({
        status: 'error',
        info: _t('dataset.rename.error', {
          tableName: visModel.get('name'),
          error: errorParser(e)
        }),
        closable: true
      });
    }
  });
};

},{"../../components/notifier/notifier":252,"../../helpers/error-parser":426}],405:[function(require,module,exports){
var _ = require('underscore');
var TableNameUtils = require('../../helpers/table-name-utils');

var memo = {};

var OPTIONAL_OPTS = [
  'querySchemaModel',
  'layerDefinitionModel',
  'tokens'
];

var defaults = {
  tableName: true,
  columnsName: true,
  keywords: true
};

module.exports = {
  init: function (opts) {
    if (!opts) throw new Error('options are required for hints');

    this.options = _.defaults(
      _.pick(opts, ['tableName', 'columnsName', 'keywords'])
      , defaults
    );

    _.each(OPTIONAL_OPTS, function (item) {
      this['_' + item] = opts[item];
    }, this);
  },

  hints: function () {
    // array of objects {text, type}
    return this.hints;
  },

  reset: function () {
    this.hints = _.union(this._getTableName(), this._getColumns(), this._getKeywords());
    return this;
  },

  _getKeywords: function () {
    if (this.options.keywords) {
      return this._tokens && this._memo(this._tokens);
    } else {
      return [];
    }
  },

  _getColumns: function () {
    if (!this.options.columnsName) {
      return [];
    }

    var columns = this._querySchemaModel.columnsCollection;
    return columns.map(function (mdl) {
      var columnName = mdl.get('name');
      return {
        text: columnName,
        type: 'Column_name'
      };
    });
  },

  _getTableName: function () {
    if (!this.options.tableName) {
      return [];
    }

    var tableName = this._layerDefinitionModel.getTableName();
    tableName = TableNameUtils.getUnqualifiedName(tableName);
    return [{
      text: tableName,
      type: 'Table_name'
    }];
  },

  _memo: function (str, type) {
    if (str in memo) {
      return memo[str];
    } else {
      return (memo[str] = this._make(str, type));
    }
  },

  _make: function (str, type) {
    return _.chain(str).map(function (set) {
      return set.keywords.split(' ').map(function (item) {
        return {
          text: item,
          type: set.type
        };
      });
    }).flatten().value();
  }
};

},{"../../helpers/table-name-utils":434,"underscore":"underscore"}],406:[function(require,module,exports){
module.exports = [{
  keywords: 'alter and as asc between by count create delete desc distinct drop from group having in insert into is join like not on or order select set table union update values where limit',
  type: 'Sql'
}, {
  keywords: 'ST_GeometryType ST_polygon ST_multipolygon ST_multilinestring ST_linestring ST_multipoint ST_point',
  type: 'Postgis'
}];

},{}],407:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var UndoManager = require('../../../../data/undo-manager.js');

/**
 *  Data SQL Undo-redo model
 */
module.exports = Backbone.Model.extend({

  defaults: {
    content: ''
  },

  initialize: function (attrs, opts) {
    this._history = this._generateHistory(opts && opts.history);

    UndoManager.init(this, {
      track: true,
      history: this._history
    });
  },

  _generateHistory: function (history) {
    if (history && history.length) {
      var data = _.reduce(history, function (memo, sql) {
        memo.push({
          content: sql
        });
        return memo;
      }, [], this);
      return data;
    }

    return false;
  },

  getHistory: function () {
    return _.pluck(
      this.getUndoHistory(),
      'content'
    );
  }
});

},{"../../../../data/undo-manager.js":371,"backbone":"backbone","underscore":"underscore"}],408:[function(require,module,exports){
var Backbone = require('backbone');
var UndoManager = require('../../data/undo-manager.js');
var _ = require('underscore');

/**
 *  CartoCSS Undo-redo model
 */
module.exports = Backbone.Model.extend({

  defaults: {
    content: ''
  },

  initialize: function (attrs, opts) {
    this._history = this._generateHistory(opts && opts.history);

    UndoManager.init(this, {
      track: true,
      history: this._history
    });
  },

  _generateHistory: function (history) {
    if (history && history.length) {
      var data = _.reduce(history, function (memo, cartocss) {
        memo.push({
          content: cartocss
        });
        return memo;
      }, [], this);
      return data;
    }

    return false;
  },

  getHistory: function () {
    return _.pluck(
      this.getUndoHistory(),
      'content'
    );
  }
});

},{"../../data/undo-manager.js":371,"backbone":"backbone","underscore":"underscore"}],409:[function(require,module,exports){
var _ = require('underscore');
var SimpleStyleDefaults = require('./simple-style-defaults');

module.exports = _.defaults({

  generateAttributes: function (geometryType) {
    return _.extend(
      this._getStyleTypeAttrs(),
      this._getFillAttrs(geometryType),
      this._getStrokeAttrs(geometryType),
      {
        blending: 'lighter'
      },
      this._getAggrAttrs(geometryType),
      this._getAnimatedAttrs(geometryType)
    );
  },

  _getStyleTypeAttrs: function () {
    return {
      style: 'simple'
    };
  },

  _getAnimatedAttrs: function (geometryType) {
    return {
      animated: {
        attribute: null,
        overlap: false,
        duration: 30,
        steps: 256,
        trails: 2,
        resolution: 4
      }
    };
  },

  _getAggrAttrs: function (geometryType) {
    return {
      aggregation: {}
    };
  }
}, SimpleStyleDefaults);

},{"./simple-style-defaults":413,"underscore":"underscore"}],410:[function(require,module,exports){
var _ = require('underscore');
var SimpleStyleDefaults = require('./simple-style-defaults');
var rampList = require('cartocolor');

module.exports = _.defaults({

  generateAttributes: function (geometryType) {
    return _.extend(
      this._getFillAttrs(geometryType),
      this._getAggrAttrs(),
      this._getAnimatedAttrs(),
      this._getLabelsAttrs()
    );
  },

  _getFillAttrs: function (geometryType) {
    var attrs = {
      fill: {
        'size': {
          fixed: 45
        },
        'color': {
          attribute: 'cartodb_id',
          range: rampList.ag_Sunset[7],
          bins: 6
        }
      }
    };

    return attrs;
  },

  _getAggrAttrs: function () {
    return {
      aggregation: {}
    };
  },

  _getAnimatedAttrs: function (geometryType) {
    return {
      animated: {
        attribute: 'cartodb_id',
        overlap: false,
        duration: 30,
        steps: 1,
        trails: 0,
        resolution: 4
      }
    };
  },

  _getLabelsAttrs: function () {
    return {
      labels: {}
    };
  }

}, SimpleStyleDefaults);

},{"./simple-style-defaults":413,"cartocolor":"cartocolor","underscore":"underscore"}],411:[function(require,module,exports){
var _ = require('underscore');
var SimpleStyleDefaults = require('./simple-style-defaults');
var DefaultFormValues = require('../../../data/default-form-styles.json');
var Utils = require('../../../helpers/utils');
var rampList = require('cartocolor');

module.exports = _.defaults({

  _getAggrAttrs: function (geometryType) {
    return {
      aggregation: {
        size: 10,
        value: {
          operator: 'count',
          attribute: ''
        }
      }
    };
  },

  _getStrokeAttrs: function (geometryType) {
    var strokeAttrs = DefaultFormValues['stroke'];
    return {
      stroke: Utils.cloneObject(strokeAttrs)
    };
  },

  _getFillAttrs: function (geometryType) {
    var colors = rampList['ag_GrnYl'][5];
    return {
      fill: {
        'color': {
          attribute: 'agg_value',
          bins: '5',
          quantification: 'quantiles',
          // TODO: flip the ramp when basemap is black
          // range: rampList.ag_GrnYl[5].reverse()
          range: Utils.cloneObject(colors)
        }
      }
    };
  }

}, SimpleStyleDefaults);

},{"../../../data/default-form-styles.json":347,"../../../helpers/utils":435,"./simple-style-defaults":413,"cartocolor":"cartocolor","underscore":"underscore"}],412:[function(require,module,exports){
var _ = require('underscore');
var SimpleStyleDefaults = require('./simple-style-defaults');
var rampList = require('cartocolor');

module.exports = _.defaults({
  _getAggrAttrs: function (geometryType) {
    return {
      aggregation: {
        dataset: 'countries',
        change: 'manual',
        value: {
          operator: 'count',
          attribute: ''
        }
      }
    };
  },

  _getFillAttrs: function (geometryType) {
    return {
      fill: {
        'color': {
          attribute: 'agg_value_density',
          bins: '5',
          quantification: 'quantiles',
          range: _.clone(rampList.Emrld[5])
        }
      }
    };
  }

}, SimpleStyleDefaults);

},{"./simple-style-defaults":413,"cartocolor":"cartocolor","underscore":"underscore"}],413:[function(require,module,exports){
var _ = require('underscore');
var StyleDefaults = require('./style-defaults');
var DefaultCartography = require('../../../data/default-cartography.json');
var DefaultFormValues = require('../../../data/default-form-styles.json');
var Utils = require('../../../helpers/utils');

module.exports = _.defaults({

  generateAttributes: function (geometryType) {
    return _.extend(
      {},
      this._getFillAttrs(geometryType),
      this._getStrokeAttrs(geometryType),
      {
        blending: DefaultFormValues['blending']
      },
      this._getAggrAttrs(geometryType),
      this._getLabelsAttrs()
    );
  },

  _getFillAttrs: function (geometryType) {
    var fillAttrs = DefaultCartography['simple'][geometryType]['fill'];
    return {
      fill: Utils.cloneObject(fillAttrs)
    };
  },

  _getStrokeAttrs: function (geometryType) {
    var strokeAttrs = DefaultCartography['simple'][geometryType]['stroke'];
    return {
      stroke: Utils.cloneObject(strokeAttrs)
    };
  },

  _getAggrAttrs: function () {
    var aggrAttrs = DefaultFormValues['aggregation'];
    return {
      aggregation: Utils.cloneObject(aggrAttrs)
    };
  },

  _getLabelsAttrs: function () {
    var labelsAttrs = DefaultFormValues['labels'];
    return {
      labels: Utils.cloneObject(labelsAttrs)
    };
  }
}, StyleDefaults);

},{"../../../data/default-cartography.json":346,"../../../data/default-form-styles.json":347,"../../../helpers/utils":435,"./style-defaults":415,"underscore":"underscore"}],414:[function(require,module,exports){
var _ = require('underscore');
var HexabinsAggregationDefaults = require('./hexabins-aggregation-style-defaults');

module.exports = _.defaults({

  _getAggrAttrs: function (geometryType) {
    return {
      aggregation: {
        size: 12,
        value: {
          operator: 'count',
          attribute: ''
        }
      }
    };
  }

}, HexabinsAggregationDefaults);

},{"./hexabins-aggregation-style-defaults":411,"underscore":"underscore"}],415:[function(require,module,exports){
module.exports = {
  generateAttributes: function (geometryType) {
    return {
      fill: null,
      stroke: null,
      blending: null,
      aggregation: {},
      labels: {}
    };
  }
};

},{}],416:[function(require,module,exports){
var Backbone = require('backbone');
var _ = require('underscore');
var StylesFactory = require('./styles-factory');
var UndoManager = require('../../data/undo-manager');

module.exports = Backbone.Model.extend({

  parse: function (r) {
    r = r || {};
    return _.extend(
      {
        type: r.type,
        autogenerated: r && r.autogenerated
      },
      r.properties
    );
  },

  initialize: function (attrs, opts) {
    if (!this.get('type')) {
      this.setDefaultPropertiesByType('simple', 'point');
    }

    UndoManager.init(this, { track: true });
  },

  resetPropertiesFromAutoStyle: function () {
    if (this._stylesPreAutoStyle) {
      delete this.attributes.autoStyle;
      this.set(this._stylesPreAutoStyle);
      this.removeStylesPreAutoStyle();
    }
  },

  removeStylesPreAutoStyle: function () {
    delete this._stylesPreAutoStyle;
  },

  setPropertiesFromAutoStyle: function (params) {
    if (!params.definition) throw new Error('definition is required');
    if (!params.geometryType) throw new Error('geometryType is required');
    if (!params.widgetId) throw new Error('widgetId is required');

    if (!this._stylesPreAutoStyle) {
      this._stylesPreAutoStyle = JSON.parse(JSON.stringify(this.attributes));
    }

    // In order to trigger a proper change at the end of this function, we have
    // to make a clear change in the attributes, like delete the autoStyle property.
    delete this.attributes.autoStyle;

    var extendAutoStyleProperties = function (attribute, newProperties) {
      var properties = this.get(attribute);
      // Check domain quotes
      if (newProperties.color && newProperties.color.domain) {
        var quotedDomain = _.compact(
          _.map(newProperties.color.domain, function (name) {
            if (name && name !== true) {
              return '"' + name.toString().replace(/"/g, '\\"').replace(/\n/g, '\\n') + '"';
            } else {
              return name;
            }
          })
        );
        newProperties.color.static = true;
        newProperties.color.domain = quotedDomain;
        newProperties.color.quantification = 'category';
        newProperties.color.attribute_type = 'string';
      } else {
        newProperties.color.bins = newProperties.color.range.length;
        newProperties.color.quantification = 'quantiles';
        newProperties.color.attribute_type = 'number';
      }

      properties = _.extend(
        properties,
        newProperties
      );

      return properties;
    }.bind(this);

    var currentAttrs = JSON.parse(JSON.stringify(this.attributes));
    if (params.geometryType === 'line') {
      currentAttrs.stroke = extendAutoStyleProperties('stroke', params.definition[params.geometryType]);
    } else {
      currentAttrs.fill = extendAutoStyleProperties('fill', params.definition[params.geometryType]);
    }

    this.set(
      _.extend(
        {
          type: 'simple',
          autoStyle: params.widgetId
        },
        currentAttrs
      )
    );
  },

  setDefaultPropertiesByType: function (styleType, geometryType, silently) {
    // Get default aggregation and properties from factory and apply them
    this.set(
      _.extend(
        {
          type: styleType
        },
        StylesFactory.getDefaultStyleAttrsByType(styleType, geometryType)
      ), {
        silently: !!silently
      }
    );

    // Although we want to make the change silently, we have several places listening
    // for style changes, so we trigger this custom event
    if (silently) {
      this.trigger('style:update');
    }
  },

  setFill: function (type) {
    var simpleFill = StylesFactory.getDefaultStyleAttrsByType(type, 'point');
    this.set('fill', simpleFill.fill);
  },

  applyLastState: function () {
    this._undoManager.stopTracking();
    this.trigger('change');
    this._undoManager.startTracking();
  },

  resetStyles: function () {
    this.setDefaultPropertiesByType('none', '');
  },

  // Backend will migrate current wizard properties to style properties,
  // providing a flag which indicates if it is generated by them
  isAutogenerated: function () {
    return this.get('autogenerated');
  },

  isAggregatedType: function () {
    return _.contains(StylesFactory.getAggregationTypes(), this.get('type'));
  },

  isAnimation: function () {
    return this.get('type') === 'animation';
  },

  hasNoneStyles: function () {
    return this.get('type') === 'none';
  },

  canApplyAutoStyle: function () {
    return this.get('type') === 'simple';
  },

  getColumnsUsedForStyle: function () {
    var columns = [];
    // Fill (size and color)
    var fill = this.get('fill');
    if (fill && fill.color && fill.color.attribute) {
      columns.push({
        name: fill.color.attribute,
        type: fill.color.attribute_type || 'string'
      });
    }
    if (fill && fill.size && fill.size.attribute) {
      columns.push({
        name: fill.size.attribute,
        type: 'number'
      });
    }

    // Stroke (size and color)
    var stroke = this.get('stroke');
    if (stroke && stroke.color && stroke.color.attribute) {
      columns.push({
        name: stroke.color.attribute,
        type: stroke.color.attribute_type || 'string'
      });
    }
    if (stroke && stroke.size && stroke.size.attribute) {
      columns.push({
        name: stroke.size.attribute,
        type: 'number'
      });
    }

    // Labels
    var labels = this.get('labels');
    if (labels && labels.attribute && labels.enabled) {
      columns.push({
        name: labels.attribute
      });
    }

    // Aggregation
    var aggregation = this.get('aggregation');
    if (aggregation && aggregation.value && aggregation.value.attribute) {
      columns.push({
        name: aggregation.value.attribute,
        type: aggregation.value.attribute_type || 'string'
      });
    }

    return columns;
  },

  // Unflatten attributes
  toJSON: function () {
    return {
      type: this.get('type'),
      properties: _.omit(this.attributes, 'type', 'autogenerated')
    };
  }
});

},{"../../data/undo-manager":371,"./styles-factory":423,"backbone":"backbone","underscore":"underscore"}],417:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="56px" height="16px" viewBox="718 455 56 16">\n    <g id="animated" transform="translate(718.000000, 455.000000)" class="Style-fill">\n        <rect id="Rectangle-649" x="40" y="0" width="16" height="16" rx="8"></rect>\n        <rect id="Rectangle-649" opacity="0.8" x="30" y="0" width="16" height="16" rx="8"></rect>\n        <rect id="Rectangle-649" opacity="0.6" x="20" y="0" width="16" height="16" rx="8"></rect>\n        <rect id="Rectangle-649" opacity="0.4" x="10" y="0" width="16" height="16" rx="8"></rect>\n        <rect id="Rectangle-649" opacity="0.2" x="0" y="0" width="16" height="16" rx="8"></rect>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],418:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="56px" height="25px" viewBox="0 0 56 25">\n    <g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n        <g id="Aggregation-/-Heatmap" transform="translate(-15.000000, -16.000000)">\n            <g id="Group-7">\n                <g transform="translate(15.000000, 16.000000)">\n                    <g id="Group-2" style="mix-blend-mode: luminosity;" transform="translate(28.000000, 12.500000) rotate(-90.000000) translate(-28.000000, -12.500000) translate(15.500000, -15.500000)" class="Style-fill">\n                        <g id="heat-copy-2" transform="translate(0.000000, 36.000000)">\n                            <circle id="Oval-120" opacity="0.4" cx="6" cy="6" r="6"></circle>\n                            <circle id="Oval-120-Copy" opacity="0.6" cx="6.5" cy="5.5" r="4.03333333"></circle>\n                            <path d="M6.5,8.06666667 C7.91753086,8.06666667 9.06666667,6.91753086 9.06666667,5.5 C9.06666667,4.08246914 7.91753086,2.93333333 6.5,2.93333333 C5.08246914,2.93333333 3.93333333,4.08246914 3.93333333,5.5 C3.93333333,6.91753086 5.08246914,8.06666667 6.5,8.06666667 Z" id="Oval-120-Copy-2" opacity="0.8"></path>\n                            <circle id="Oval-120-Copy-3" cx="6.5" cy="5.5" r="1.1"></circle>\n                        </g>\n                        <g id="heat-copy-2" transform="translate(13.000000, 48.000000)">\n                            <circle id="Oval-120" opacity="0.4" cx="4" cy="4" r="4"></circle>\n                            <circle id="Oval-120-Copy" opacity="0.6" cx="4" cy="4" r="2.93333333"></circle>\n                            <path d="M4,5.86666667 C5.03093153,5.86666667 5.86666667,5.03093153 5.86666667,4 C5.86666667,2.96906847 5.03093153,2.13333333 4,2.13333333 C2.96906847,2.13333333 2.13333333,2.96906847 2.13333333,4 C2.13333333,5.03093153 2.96906847,5.86666667 4,5.86666667 Z" id="Oval-120-Copy-2" opacity="0.8"></path>\n                            <circle id="Oval-120-Copy-3" cx="4" cy="4" r="0.8"></circle>\n                        </g>\n                        <g id="heat-copy-3" transform="translate(0.500000, 0.500000)">\n                            <circle id="Oval-120" opacity="0.4" cx="12" cy="12" r="12"></circle>\n                            <ellipse id="Oval-120-Copy" opacity="0.6" cx="12" cy="12" rx="8.8" ry="8.8"></ellipse>\n                            <path d="M12,17.6 C15.0927946,17.6 17.6,15.0927946 17.6,12 C17.6,8.9072054 15.0927946,6.4 12,6.4 C8.9072054,6.4 6.4,8.9072054 6.4,12 C6.4,15.0927946 8.9072054,17.6 12,17.6 Z" id="Oval-120-Copy-2" opacity="0.8"></path>\n                            <circle id="Oval-120-Copy-3" cx="12" cy="12" r="2.4"></circle>\n                        </g>\n                        <g id="heat" transform="translate(8.000000, 25.000000)">\n                            <path d="M0.0682602115,8.5161863 C0.564222232,12.1776805 3.7025171,15 7.5,15 C11.6421356,15 15,11.6421356 15,7.5 C15,3.35786438 11.6421356,0 7.5,0 C3.35786438,0 0,3.35786438 0,7.5 C0,7.84465272 0.0232475903,8.18387567 0.0682602115,8.5161863 Z" id="Oval-120" opacity="0.4"></path>\n                            <circle id="Oval-120-Copy" opacity="0.6" cx="7.5" cy="7.5" r="5.5"></circle>\n                            <path d="M7.5,11 C9.43299662,11 11,9.43299662 11,7.5 C11,5.56700338 9.43299662,4 7.5,4 C5.56700338,4 4,5.56700338 4,7.5 C4,9.43299662 5.56700338,11 7.5,11 Z" id="Oval-120-Copy-2" opacity="0.8"></path>\n                            <circle id="Oval-120-Copy-3" cx="7.5" cy="7.5" r="1.5"></circle>\n                        </g>\n                    </g>\n                    <g id="Group-8" style="mix-blend-mode: luminosity;" transform="translate(15.000000, 4.000000)">\n                        <path opacity="0.4" d="M6,0.5 C6,0.5 10,4 13,0 C12,2.5 11.5,4.5 11.5,4.5 L10.5,6.5 L7,3.5 L6,0.5 Z" id="Path-494" class="Style-fill"></path>\n                        <path opacity="0.4" d="M21.2158501,6.00893743 C21.2158501,6.00893743 25.2158501,9.50893743 28.2158501,5.50893743 C27.2158501,8.00893743 26.7158501,10.0089374 26.7158501,10.0089374 L25.7158501,12.0089374 L22.2158501,9.00893743 L21.2158501,6.00893743 Z" id="Path-494" class="Style-fill" transform="translate(24.715850, 8.758937) rotate(52.000000) translate(-24.715850, -8.758937) "></path>\n                        <path opacity="0.4" d="M16.9683476,9.30864826 C16.9683476,9.30864826 22.1000758,13.6622016 25.1000758,9.66220164 C24.1000758,12.1622016 23.8307892,14.1229281 23.8307892,14.1229281 L22.8307892,16.1229281 L17.6754544,11.4299685 L16.9683476,9.30864826 Z" id="Path-494" class="Style-fill" transform="translate(21.034212, 12.715788) rotate(-135.000000) translate(-21.034212, -12.715788) "></path>\n                        <path opacity="0.4" d="M6.01244045,6.22463473 C6.01244045,6.22463473 9.69418934,8.6717337 12.6941893,4.6717337 C11.6941893,7.1717337 11.1941893,9.1717337 11.1941893,9.1717337 L10.8665273,11.557349 L9.7765744,13.8621271 L6.01244045,6.22463473 Z" id="Path-494" class="Style-fill" transform="translate(9.353315, 9.266930) rotate(-194.000000) translate(-9.353315, -9.266930) "></path>\n                        <path opacity="0.6" d="M6,7.5 C5.85295664,5.882523 3.5,2.5 3.5,2.5 C3.5,2.5 6.5,5 9,5 C11.5,5 14.5,1 14.5,1 C14.5,1 12.5,4.25504557 12.5,6 C12.5,7.25504557 14.5,10 14.5,10 C14.5,10 12,8 9.5,8 C7,8 4.5,13.5 4.5,13.5 C4.5,13.5 6.18628997,9.54918967 6,7.5 Z" id="Path-497" class="Style-fill"></path>\n                        <path opacity="0.6" d="M19.7830175,9.69012543 C19.6894445,8.07264843 16.7664559,5.429802 16.7664559,5.429802 C16.7664559,5.429802 20.2086087,8.27970692 21.7995178,8.27970692 C23.3904269,8.27970692 26.4566805,5.77970692 26.4566805,5.77970692 C26.4566805,5.77970692 24.4742142,8.43779004 24.4742142,10.1827445 C24.4742142,11.43779 25.8285796,12.5099091 25.8285796,12.5099091 C25.8285796,12.5099091 23.7086087,11.2797069 22.1176996,11.2797069 C20.5267905,11.2797069 17.9729009,15.2555074 17.9729009,15.2555074 C17.9729009,15.2555074 19.9015657,11.7393151 19.7830175,9.69012543 Z" id="Path-497" class="Style-fill" transform="translate(21.611568, 10.342655) rotate(52.000000) translate(-21.611568, -10.342655) "></path>\n                        <path id="Path-499" stroke="#979797"></path>\n                        <polygon id="Path-500" class="Style-fill" points="0.5 12.5 5 7.5 1 4"></polygon>\n                    </g>\n                </g>\n            </g>\n        </g>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],419:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="52px" height="23px" viewBox="0 0 52 23">\n    <g id="Symbols">\n        <g id="Aggregation-/-Hexabins" transform="translate(-15.000000, -17.000000)" class="Style-fill">\n            <g id="Hexabins">\n                <g transform="translate(15.000000, 17.000000)">\n                    <polygon id="Polygon-1-Copy-4" points="23 11 28 14 28 20 23 23 18 20 18 14"></polygon>\n                    <polygon id="Polygon-1-Copy-8" points="17 0 22 3 22 9 17 12 12 9 12 3"></polygon>\n                    <polygon id="Polygon-1-Copy-8" points="5 0 10 3 10 9 5 12 -1.15463195e-13 9 3.85466323e-09 3"></polygon>\n                    <polygon id="Polygon-1-Copy-13" points="29 0 34 3 34 9 29 12 24 9 24 3"></polygon>\n                    <polygon id="Polygon-1-Copy-15" points="41 0 46 3 46 9 41 12 36 9 36 3"></polygon>\n                    <polygon id="Polygon-1-Copy-14" points="35 11 40 14 40 20 35 23 30 20 30 14"></polygon>\n                    <polygon id="Polygon-1-Copy-14" points="47 11 52 14 52 20 47 23 42 20 42 14"></polygon>\n                </g>\n            </g>\n        </g>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],420:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="56px" height="24px" viewBox="16 16 56 24">\n    <g id="points" transform="translate(16.000000, 16.000000)"  class="Style-fill">\n        <path d="M6,10 C8.209139,10 10,8.209139 10,6 C10,3.790861 8.209139,2 6,2 C3.790861,2 2,3.790861 2,6 C2,8.209139 3.790861,10 6,10 Z" id="Oval-59"></path>\n        <path d="M52,8 C54.209139,8 56,6.209139 56,4 C56,1.790861 54.209139,0 52,0 C49.790861,0 48,1.790861 48,4 C48,6.209139 49.790861,8 52,8 Z" id="Oval-59-Copy-2"></path>\n        <path d="M52,22 C54.209139,22 56,20.209139 56,18 C56,15.790861 54.209139,14 52,14 C49.790861,14 48,15.790861 48,18 C48,20.209139 49.790861,22 52,22 Z" id="Oval-59-Copy-3"></path>\n        <path d="M4,24 C6.209139,24 8,22.209139 8,20 C8,17.790861 6.209139,16 4,16 C1.790861,16 0,17.790861 0,20 C0,22.209139 1.790861,24 4,24 Z" id="Oval-59-Copy"></path>\n        <path d="M28,8 C30.209139,8 32,6.209139 32,4 C32,1.790861 30.209139,0 28,0 C25.790861,0 24,1.790861 24,4 C24,6.209139 25.790861,8 28,8 Z" id="Oval-59-Copy-4"></path>\n        <path d="M24,20 C26.209139,20 28,18.209139 28,16 C28,13.790861 26.209139,12 24,12 C21.790861,12 20,13.790861 20,16 C20,18.209139 21.790861,20 24,20 Z" id="Oval-59-Copy-4"></path>\n        <path d="M16,16 C18.209139,16 20,14.209139 20,12 C20,9.790861 18.209139,8 16,8 C13.790861,8 12,9.790861 12,12 C12,14.209139 13.790861,16 16,16 Z" id="Oval-59-Copy-4"></path>\n        <path d="M44,12 C46.209139,12 48,10.209139 48,8 C48,5.790861 46.209139,4 44,4 C41.790861,4 40,5.790861 40,8 C40,10.209139 41.790861,12 44,12 Z" id="Oval-59-Copy-4"></path>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],421:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="56px" height="24px" viewBox="0 0 56 24">\n    <g id="Symbols">\n        <g id="Aggregation-/-Admin-Regions" transform="translate(-16.000000, -16.000000)" class="Style-fill">\n            <g id="regions">\n                <g transform="translate(16.000000, 16.000000)">\n                    <polygon id="Rectangle-649" points="9 8 1 0 27 0 27 17 36 17 36.0065918 23.9934082 25 24 9 16"></polygon>\n                    <polygon id="Rectangle-649" points="0 2 7 9 7 17 21 24 0 24 0 15"></polygon>\n                    <polygon id="Rectangle-649" points="29 0 50 0 50 6 56 6 56 24 48 24 38 24 38 15 29 15"></polygon>\n                    <rect id="Rectangle-1933" x="52" y="0" width="4" height="4"></rect>\n                </g>\n            </g>\n        </g>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],422:[function(require,module,exports){
var _ = require('underscore');
module.exports = function(obj){
var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
with(obj||{}){
__p+='<svg width="58px" height="28px" viewBox="0 0 58 28">\n    <g id="Symbols">\n        <g id="Aggregation-/-Squares" transform="translate(-15.000000, -14.000000)" class="Style-fill">\n            <g id="squares">\n                <g transform="translate(15.000000, 14.000000)">\n                    <rect id="Rectangle-847-Copy-2" x="10" y="0" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-5" x="30" y="20" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-12" x="40" y="20" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-13" x="40" y="10" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-8" x="20" y="10" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-6" x="30" y="10" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-9" x="20" y="20" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-10" x="10" y="10" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-10" x="0" y="10" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-10" x="50" y="20" width="8" height="8" rx="1"></rect>\n                    <rect id="Rectangle-847-Copy-11" x="20" y="0" width="8" height="8" rx="1"></rect>\n                </g>\n            </g>\n        </g>\n    </g>\n</svg>';
}
return __p;
};

},{"underscore":"underscore"}],423:[function(require,module,exports){
var _ = require('underscore');
var StyleDefaults = require('./style-defaults/style-defaults');
var SimpleStyleDefaults = require('./style-defaults/simple-style-defaults');
var HeatmapDefaults = require('./style-defaults/heatmap-style-defaults');
var AnimationDefaults = require('./style-defaults/animation-style-defaults');
var SquareAggregationDefaults = require('./style-defaults/squares-aggregation-style-defaults');
var HexabinsAggregationDefaults = require('./style-defaults/hexabins-aggregation-style-defaults');
var RegionsAggregationDefaults = require('./style-defaults/regions-aggregation-style-defaults');

var STYLE_MAP = {
  'none': {
    labelTranslationKey: 'editor.style.types.none',
    checkIfValid: function (geometryType) {
      return !geometryType;
    },
    defaultStyles: StyleDefaults
  },
  'simple': {
    labelTranslationKey: 'editor.style.types.simple',
    iconTemplate: require('./style-icons/points.tpl'),
    checkIfValid: function (geometryType) {
      return !!geometryType;
    },
    defaultStyles: SimpleStyleDefaults
  },
  'squares': {
    labelTranslationKey: 'editor.style.types.squares',
    iconTemplate: require('./style-icons/squares.tpl'),
    checkIfValid: function (geometryType) {
      return geometryType === 'point';
    },
    defaultStyles: SquareAggregationDefaults
  },
  'hexabins': {
    labelTranslationKey: 'editor.style.types.hexabins',
    iconTemplate: require('./style-icons/hexabins.tpl'),
    checkIfValid: function (geometryType) {
      return geometryType === 'point';
    },
    defaultStyles: HexabinsAggregationDefaults
  },
  'regions': {
    labelTranslationKey: 'editor.style.types.regions',
    iconTemplate: require('./style-icons/regions.tpl'),
    checkIfValid: function (geometryType) {
      return geometryType === 'point';
    },
    defaultStyles: RegionsAggregationDefaults
  },
  'animation': {
    labelTranslationKey: 'editor.style.types.animation',
    iconTemplate: require('./style-icons/animated.tpl'),
    checkIfValid: function (geometryType) {
      return geometryType === 'point';
    },
    defaultStyles: AnimationDefaults
  },
  'heatmap': {
    labelTranslationKey: 'editor.style.types.heatmap',
    iconTemplate: require('./style-icons/heatmap.tpl'),
    checkIfValid: function (geometryType) {
      return geometryType === 'point';
    },
    defaultStyles: HeatmapDefaults
  }
};

module.exports = {
  getDefaultStyleAttrsByType: function (styleType, geometryType) {
    var StyleDefaultsKlass = STYLE_MAP[styleType].defaultStyles;
    return StyleDefaultsKlass.generateAttributes(geometryType);
  },

  getStyleTypes: function (currentType, geometryType) {
    return _.reduce(STYLE_MAP, function (memo, val, key) {
      if (currentType === key || (val.checkIfValid ? val.checkIfValid(geometryType) : true)) {
        memo.push({
          value: key,
          label: _t(val.labelTranslationKey),
          iconTemplate: val.iconTemplate
        });
      }
      return memo;
    }, []);
  },

  getFormTemplateByType: function (styleType) {
    return STYLE_MAP[styleType].formTemplate;
  },

  getAggregationTypes: function () {
    return ['squares', 'hexabins', 'regions'];
  }
};

},{"./style-defaults/animation-style-defaults":409,"./style-defaults/heatmap-style-defaults":410,"./style-defaults/hexabins-aggregation-style-defaults":411,"./style-defaults/regions-aggregation-style-defaults":412,"./style-defaults/simple-style-defaults":413,"./style-defaults/squares-aggregation-style-defaults":414,"./style-defaults/style-defaults":415,"./style-icons/animated.tpl":417,"./style-icons/heatmap.tpl":418,"./style-icons/hexabins.tpl":419,"./style-icons/points.tpl":420,"./style-icons/regions.tpl":421,"./style-icons/squares.tpl":422,"underscore":"underscore"}],424:[function(require,module,exports){
/**
 * Just provide info about the current browser
 */

module.exports = function () {
  var ua = navigator.userAgent;
  var tem;
  var M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
  if (/trident/i.test(M[1])) {
    tem = /\brv[ :]+(\d+)/g.exec(ua) || [];
    return {
      name: 'IE ',
      version: (tem[1] || '')
    };
  }
  if (M[1] === 'Chrome') {
    tem = ua.match(/\bOPR\/(\d+)/);
    if (tem != null) {
      return {
        name: 'Opera',
        version: tem[1]
      };
    }
  }
  M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
  if ((tem = ua.match(/version\/(\d+)/i)) != null) {
    M.splice(1, 1, tem[1]);
  }

  return {
    name: M[0],
    version: M[1]
  };
};

},{}],425:[function(require,module,exports){
module.exports = [
  'aliceblue', 'antiquewhite', 'aqua', 'aquamarine', 'azure', 'beige',
  'bisque', 'black', 'blanchedalmond', 'blue', 'blueviolet', 'brown',
  'burlywood', 'cadetblue', 'chartreuse', 'chocolate', 'coral', 'cornflowerblue',
  'cornsilk', 'crimson', 'cyan', 'darkblue', 'darkcyan', 'darkgoldenrod',
  'darkgray', 'darkgreen', 'darkkhaki', 'darkmagenta', 'darkolivegreen',
  'darkorange', 'darkorchid', 'darkred', 'darksalmon', 'darkseagreen',
  'darkslateblue', 'darkslategray', 'darkturquoise', 'darkviolet',
  'deeppink', 'deepskyblue', 'dimgray', 'dodgerblue', 'firebrick',
  'floralwhite', 'forestgreen', 'fuchsia', 'gainsboro', 'ghostwhite',
  'gold', 'goldenrod', 'gray', 'grey', 'green', 'greenyellow', 'honeydew',
  'hotpink', 'indianred', 'indigo', 'ivory', 'khaki', 'lavender',
  'lavenderblush', 'lawngreen', 'lemonchiffon', 'lightblue', 'lightcoral',
  'lightcyan', 'lightgoldenrodyellow', 'lightgray', 'lightgreen', 'lightpink',
  'lightsalmon', 'lightseagreen', 'lightskyblue', 'lightslategray',
  'lightsteelblue', 'lightyellow', 'lime', 'limegreen', 'linen', 'magenta',
  'maroon', 'mediumaquamarine', 'mediumblue', 'mediumorchid', 'mediumpurple',
  'mediumseagreen', 'mediumslateblue', 'mediumspringgreen', 'mediumturquoise',
  'mediumvioletred', 'midnightblue', 'mintcream', 'mistyrose', 'moccasin',
  'navajowhite', 'navy', 'oldlace', 'olive', 'olivedrab', 'orange', 'orangered',
  'orchid', 'palegoldenrod', 'palegreen', 'paleturquoise', 'palevioletred',
  'papayawhip', 'peachpuff', 'peru', 'pink', 'plum', 'powderblue',
  'purple', 'red', 'rosybrown', 'royalblue', 'saddlebrown', 'salmon',
  'sandybrown', 'seagreen', 'seashell', 'sienna', 'silver', 'skyblue',
  'slateblue', 'slategray', 'snow', 'springgreen', 'steelblue', 'tan',
  'teal', 'thistle', 'tomato', 'turquoise', 'violet', 'wheat', 'white',
  'whitesmoke', 'yellow', 'yellowgreen'
];

},{}],426:[function(require,module,exports){
var _ = require('underscore');
var DEFAULT_ERROR_MSG = '';

/**
 *  Return error message when backend request fails
 *  It tries to get responseText > errors and error arrays, if not gets `statusText`.
 */

module.exports = function (e) {
  if (!e) { throw new Error('error is required'); }

  try {
    var responseText = e.responseText && e.responseText.trim() && JSON.parse(e.responseText);
    var errorMessage = e.statusText || DEFAULT_ERROR_MSG;

    if (responseText) {
      var errors = _.compact(
        _.map(['errors', 'error'], function (type) {
          return responseText[type] && responseText[type].join(', ');
        })
      );
      errorMessage = errors.join(', ');
    }

    return errorMessage;
  } catch (err) {
    return DEFAULT_ERROR_MSG;
  }
};

},{"underscore":"underscore"}],427:[function(require,module,exports){
/**
 *  Fetch all query objects (querySchemaModel, queryGeometryModel, queryRowsCollection)
 *  if necessary
 */

module.exports = function (params, callback) {
  if (!params) throw new Error('all query objects are required');
  if (!params.querySchemaModel) throw new Error('querySchemaModel is required');
  if (!params.queryGeometryModel) throw new Error('queryGeometryModel is required');
  if (!params.queryRowsCollection) throw new Error('queryRowsCollection is required');

  var allFetched = function () {
    return params.querySchemaModel.isFetched() &&
           params.queryGeometryModel.isFetched() &&
           params.queryRowsCollection.isFetched();
  };

  var checkQueryRowsCollectionFetch = function () {
    if (params.queryRowsCollection.shouldFetch()) {
      var opts = {};
      if (callback) {
        opts.success = callback;
      }
      params.queryRowsCollection.fetch(opts);
    } else {
      // we need to check if all are fetched because shouldFetch include the fetching state
      allFetched() && callback && callback();
    }
  };

  var rows = params.queryRowsCollection.size();

  // we need to check if besides queryGeometryModel, there is any row, because the user could have deleted them
  if (params.queryGeometryModel.shouldFetch() || (rows === 0 && params.queryRowsCollection.shouldFetch())) {
    params.queryGeometryModel.fetch();
  }

  if (params.querySchemaModel.shouldFetch()) {
    params.querySchemaModel.fetch({
      success: checkQueryRowsCollectionFetch
    });
  } else {
    checkQueryRowsCollectionFetch();
  }
};

},{}],428:[function(require,module,exports){
var _ = require('underscore');
var DEFAULT_VALUES = {
  top: 0,
  left: 0
};
var MIN_GAP = 10;
var MIN_HEIGHT = 205;
var MIN_WIDTH = 244;

/**
 * Would you like to know where to open a context menu?
 * Just provide:
 * @param {Object} options.parentView               Parent element view
 * @param {Number} options.posX                     Position X of the context menu
 * @param {Number} options.posY                     Position Y of the context menu
 * @param {Number} options.elementWidth (optional)  Context menu width
 * @param {Number} options.elementHeight (optional) Context menu height
 * @param {Number} options.offsetX (optional)       Context menu offsetX
 * @param {Number} options.offsetY (optional)       Context menu offsetY
 *
 * By default, it will try to positionate to the right (inside) and to
 * the top (below).
 */

var MagicPositioner = function (params) {
  if (!params.parentView) throw new Error('parentView within params is required');
  if (!_.isNumber(params.posX)) throw new Error('posX within params is required');
  if (!_.isNumber(params.posY)) throw new Error('posY within params is required');

  var $parentView = params.parentView;
  var parentViewHeight = $parentView.outerHeight();
  var parentViewWidth = $parentView.outerWidth();
  var posX = params.posX;
  var posY = params.posY;
  var offsetX = params.offsetX || 0;
  var offsetY = params.offsetY || 0;
  var elementWidth = params.elementWidth || MIN_WIDTH;
  var elementHeight = params.elementHeight || MIN_HEIGHT;
  var cssProps = DEFAULT_VALUES;

  if ((posX - elementWidth) > MIN_GAP) {
    cssProps.left = 'auto';
    cssProps.right = (parentViewWidth - posX + offsetX) + 'px';
  } else if ((posX + elementWidth) > elementWidth) {
    cssProps.right = 'auto';
    cssProps.left = (posX + offsetX) + 'px';
  }

  if ((posY + elementHeight) < parentViewHeight) {
    cssProps.bottom = 'auto';
    cssProps.top = (posY + offsetY) + 'px';
  } else if ((posY + elementHeight) > parentViewHeight) {
    cssProps.top = 'auto';
    cssProps.bottom = (parentViewHeight - posY + offsetY) + 'px';
  }

  return cssProps;
};

module.exports = MagicPositioner;

},{"underscore":"underscore"}],429:[function(require,module,exports){
var _ = require('underscore');
/**
* Mapcard preview url generator
*/

module.exports = {
  urlForStaticMap: function (mapsApiTemplate, visualization, width, height) {
    var formattedMapsApiTemplate = mapsApiTemplate.replace('{user}', visualization._permissionModel.get('owner').username);
    var template = 'tpl_' + visualization.get('id').replace(/-/g, '_');

    var imageUrl = formattedMapsApiTemplate + '/api/v1/map/static/named/' + template + '/' + width + '/' + height + '.png' + this._generateAuthTokensParams(visualization);

    return imageUrl;
  },

  _generateAuthTokensParams: function (visualization) {
    var authTokens = visualization.get('auth_tokens');
    if (authTokens && authTokens.length > 0) {
      return '?' + _.map(authTokens, function (t) {
        return 'auth_token=' + t;
      }).join('&');
    } else {
      return '';
    }
  }
};

},{"underscore":"underscore"}],430:[function(require,module,exports){
var $ = require('jquery');

/**
 * Check if Linux user used right/middle click at the time of the event
 *
 * @param ev {Event}
 * @returns {boolean}
 */
function isLinuxMiddleOrRightClick (ev) {
  return ev.which === 2 || ev.which === 3;
}

/**
 * Check if Mac user used CMD key at the time of the event Mac user used CMD key at the time of the event.
 *
 * @param ev {Event}
 * @returns {boolean}
 */
function isMacCmdKeyPressed (ev) {
  return ev.metaKey;
}

function isCtrlKeyPressed (ev) {
  return ev.ctrlKey;
}

/**
 * Click handler for a cartodb.js view, to navigate event target's href URL through the view's router.navigate method.
 *
 * The default behavior is:
 * Unless cmd/ctrl keys are pressed it will cancel the default link behavior and instead navigate to the URL set in the
 * target's href attribute.
 *
 * Prerequisities:
 *  - view has a this.router instance.
 *
 * Example of how to use:
 *   - In a template:
 *     <a href="/some/uri" id="#my-link" ...
 *     <a href="/special/uri" id="#my-special-link" ...
 *
 *   - In the view file:
 *     var navigateThroughRouter = require('--/--/common/view_helpers/navigateThroughRouter');
 *     module.exports = new CoreView.extend({
 *       events: {
 *         'click a#my-link': navigateThroughRouter
 *         'click a#my-special-link': this._myCustomRoute
 *       }
 *
 *       _myCustomRoute: function(ev) {
 *         // Here you can do you custom logic before/after the routing, e.g.:
 *         console.log('before changing route');
 *         navigateThroughRouter.apply(this, arguments);
 *         console.log('after changing route');
 *       }
 *
 * @param ev {Event}
 */
module.exports = function (ev) {
  // We always kill the default behaviour of the event, since container around view might have other click behavior.
  // In case of a cmd/ctrl click by an user.
  this.killEvent(ev);
  var url = $(ev.target).closest('a').attr('href');

  if (!url) {
    return false;
  }

  if (!isLinuxMiddleOrRightClick(ev) && !isMacCmdKeyPressed(ev)) {
    var routerModel = (this.routerModel || this.options.routerModel);
    if (!routerModel) {
      throw new Error('routerModel is required');
    }

    routerModel.navigate(url, { trigger: true });
  } else if (isCtrlKeyPressed(ev) || isMacCmdKeyPressed(ev)) {
    window.open(url, '_blank');
  }
};

},{"jquery":"jquery"}],431:[function(require,module,exports){
// Get coordinates from a GeoJSON

module.exports = function (geometry) {
  try {
    var geojson = JSON.parse(geometry);
    return geojson.coordinates.join(', ');
  } catch (e) {
    return false;
  }
};

},{}],432:[function(require,module,exports){
var _ = require('underscore');

module.exports = function checkAndBuildRequiredOpts (actualOpts, requiredOpts, context) {
  if (requiredOpts === void 0) {
    throw new Error('Opts are required');
  }

  _.each(requiredOpts, function (item) {
    if (actualOpts[item] === void 0) throw new Error(item + ' is required');
    context['_' + item] = actualOpts[item];
  }, context);
};

},{"underscore":"underscore"}],433:[function(require,module,exports){
/**
 *  Checks properties from a SQL
 */

var TableNameUtils = require('./table-name-utils');

module.exports = {
  isSameQuery: function (originalQuery, customQuery) {
    if (originalQuery == null || customQuery == null) { // eslint-disable-line
      throw new Error('Needed parameters not provided');
    }

    var parseQuery = function (query) {
      return query
        .toLowerCase()
        .replace(/\"/g, '') // Remove quoted things like "pepe".tableName
        .replace(/;/g, '');
    };

    return parseQuery(originalQuery) === parseQuery(customQuery);
  },

  // return true if the sql query alters table schema in some way
  altersSchema: function (sql) {
    if (!sql) {
      return false;
    }

    // Remove all line breaks in order to prevent
    // search pattern problems
    sql = this._removeLineBreaks(sql.trim());

    return sql.search(/alter\s+[\w\."]+\s+/i) !== -1 ||
      sql.search(/drop\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/^vacuum\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/^create\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/^reindex\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/^grant\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/^revoke\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/^cluster\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/^comment\s+on\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/^explain\s+[\w\.\"]+/i) !== -1;
  },

  // return true if the sql query alters table data
  altersData: function (sql) {
    if (!sql) {
      return false;
    }

    // Remove all line breaks in order to prevent
    // search pattern problems
    sql = this._removeLineBreaks(sql.trim());

    return this.altersSchema(sql) ||
      sql.search(/^refresh\s+materialized\s+view\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/^truncate\s+[\w\.\"]+/i) !== -1 ||
      sql.search(/insert\s+into/i) !== -1 ||
      sql.search(/update\s+[\w\.\-"]+\s+.*set/i) !== -1 ||
      sql.search(/delete\s+from/i) !== -1;
  },

  _removeLineBreaks: function (sql) {
    return sql.replace(/\r?\n|\r/g, ' ');
  },

  getDefaultSQL: function (tableName, userName, inOrganization) {
    return this.getDefaultSQLFromTableName(TableNameUtils.getQualifiedTableName(tableName, userName, inOrganization));
  },

  getDefaultSQLFromTableName: function (tableName) {
    return 'SELECT * FROM ' + tableName;
  }
};

},{"./table-name-utils":434}],434:[function(require,module,exports){
/**
 *  Functions to work with SQL table names
 */

module.exports = {
  getUnqualifiedName: function (tablename) {
    if (!tablename) return null;
    var tk = tablename.split('.');
    if (tk.length === 2) {
      return this._getUnquotedName(tk[1]);
    }
    return this._getUnquotedName(tablename);
  },

  getUsername: function (tablename) {
    if (!tablename) return null;
    var tk = tablename.split('.');
    if (tk.length === 2) {
      return this._getUnquotedName(tk[0]);
    }
    return '';
  },

  _getUnquotedName: function (tablename) {
    return tablename && tablename.replace(/"/g, '');
  },

  _quoteIfNeeded: function (name) {
    var VALID_IDENTIFIER = /^[a-zA-Z_][a-zA-Z0-9_$]*$/;
    name = this._getUnquotedName(name);
    if (!VALID_IDENTIFIER.test(name)) {
      name = '"' + name + '"';
    }
    return name;
  },

  getQualifiedTableName: function (tableName, userName, inOrganization) {
    var schemaPrefix = (inOrganization && userName) ? this._quoteIfNeeded(userName) + '.' : '';
    return schemaPrefix + this._quoteIfNeeded(this.getUnqualifiedName(tableName));
  },

  isSameTableName: function (firstTableName, secondTableName, ownerUsername) {
    var firstParts = this._getTableNameParts(firstTableName, ownerUsername);
    var secondParts = this._getTableNameParts(secondTableName, ownerUsername);

    return firstParts[0] === secondParts[0] && firstParts[1] === secondParts[1];
  },

  _getTableNameParts: function (tableName, ownerUsername) {
    var table = this.getUnqualifiedName(tableName);
    var username = this.getUsername(tableName) || ownerUsername;

    return [username, table];
  }
};

},{}],435:[function(require,module,exports){
var _ = require('underscore');
var cdb = require('cartodb.js');

/*
 *  Util functions
 */

module.exports = {
  /*
   *  Simple regex to check if string is an url/ftp
   *  input ->  string with input text (example: 'https://carto.com')
   *
   *  return -> true
   */
  isURL: function (input) {
    var urlregex = /^((http|https|ftp)\:\/\/)/g;
    if (input) {
      return urlregex.test(input);
    } else {
      return false;
    }
  },

  /*
   *  check if string is blank (i.e.: str === "")
   *  input ->  string with input text
   *
   * @return a boolean
   */
  isBlank: function (str) {
    return (!str || /^\s*$/.test(str));
  },
  /*
   *  Transform bytes to a readable format, like MB, GB
   *  input ->  34234244
   *
   *  return -> 3 MB
   */
  readablizeBytes: function (bytes, round) {
    if (!bytes || isNaN(bytes)) {
      return 0;
    }
    var s = ['bytes', 'kB', 'MB', 'GB', 'TB', 'PB'];
    var e = Math.floor(Math.log(bytes) / Math.log(1024));
    var value = (bytes / Math.pow(1024, Math.floor(e))).toFixed(2);

    if (round) {
      value = parseInt(value, 10);
    }

    return value + ' ' + s[e];
  },

  /**
   *  Convert long numbers to
   *  readizable numbers.
   *
   */
  readizableNumber: function (num) {
    if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'G';
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num;
  },

  /*
   * formatNumber: adds thousands separators
   * @return a string
   *
   */
  formatNumber: function (x) {
    if (!x) return '0';
    var parts = x.toString().split('.');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    return parts.join('.');
  },

  /**
   * Similar to _.result, but also allows passing arbitrary arguments to the property if it's function.
   * This makes code more terse  when one just wants to use a value if it's available, no if-checks required.
   *
   * @example Expected output
   *   model.set('something', 'yay');
   *   cdb.Utils.result(model, 'get', 'something') // => 'yay'
   *   cdb.Utils.result(model, 'nonexisting', 'else') // => undefined
   *   cdb.Utils.result(undefinedVar, 'get') // => null
   *
   * @example Of usage
   *  return cdb.Utils.result(model, 'get', 'mightNotExist') === 'OK'
   *
   * @param {*} maybeFn
   * @return {*} Result from called maybeFn if a function, null otherwise
   */
  result: function (object, property) {
    if (object == null) return null;
    var value = object[property];
    return _.isFunction(value) ? value.apply(object, Array.prototype.slice.call(arguments, 2)) : value;
  },

  /**
   *  Get the extension of a string
   *
   */
  getFileExtension: function (str) {
    if (!str) return '';
    return str.substr(str.lastIndexOf('.') + 1);
  },

  /**
   *  Add leading zeros to numbers
   *
   */
  pad: function (num, size) {
    var s = num + '';
    while (s.length < size) s = '0' + s;
    return s;
  },

  formatDate: function (opts) {
    if (!opts.time) throw new Error();
    if (opts.month === undefined) throw new Error();
    if (opts.year === undefined) throw new Error();
    if (!opts.day) throw new Error();

    // Month in Date format should be specified as an index
    var month = parseInt(opts.month + 1, 10);
    var padZero = function (digit) {
      digit = String(digit);
      if (digit < 10 && digit.length === 1) {
        return '0' + digit;
      }
      return digit;
    };

    return '' +
      opts.year + '-' +
      padZero(month) + '-' +
      padZero(opts.day) + 'T' +
      opts.time + 'Z';
      // Not adding any info about timezone
  },

  /*
   * rgbToHex
   *
   */
  rgbToHex: function (r, g, b) {
    function componentToHex (c) {
      var hex = c.toString(16);
      return hex.length === 1 ? '0' + hex : hex;
    }

    return '#' + componentToHex(r) + componentToHex(g) + componentToHex(b);
  },

  /*
   *  Returns true if the hex color passed as an input is valid
   *  input -> hex (#FF00FF)
   *  output -> true
   *
   * @return a boolean
   */
  isValidHex: function (hex) {
    return !!hex.match(/(^#?[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i);
  },

  /*
   *  Transforms an hex color into its RGB representation
   *  input ->  hex (#FF00FF)
   *  output ->  { r: 255, g: 0, b: 255 }
   *
   * @return a hash
   */
  hexToRGB: function (hex) {
    if (!hex) {
      hex = '#FFFFFF';
    }

    var shortRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;

    hex = hex.replace(shortRegex, function (m, r, g, b) {
      return r + r + g + g + b + b;
    });

    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);

    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : null;
  },
  /*
   *  Transforms an hex color an a opacity value to a rgba string
   *  input ->  hex (#FF00FF) and opacity (0.4)
   *  output -> 'rgba(255,0,255,0.4)'
   *
   * @return a string
   */
  hexToRGBA: function (hex, opacity) {
    function roundToTwo (num) {
      return +(Math.round(num + 'e+2') + 'e-2');
    }

    var rgb = this.hexToRGB(hex);
    opacity = opacity != null ? roundToTwo(opacity) : 1;
    if (rgb) {
      return 'rgba(' + [rgb.r, rgb.g, rgb.b, opacity].join(', ') + ')';
    } else {
      return hex;
    }
  },

  /*
   *  Strip html tags from a value.
   *  input ->  string with input text (example: '<a href="#whoknows">Jamon</a> </br> <p>Vamos</p>')
   *  allowed -> allowed html tags in the result (example: '<a>')
   *
   *  return -> '<a href="#whoknows">Jamon</a> Vamos'
   */
  stripHTML: function (input, allowed) {
    allowed = (((allowed || '') + '').toLowerCase().match(/<[a-z][a-z0-9]*>/g) || []).join('');
    var tags = /<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;
    if (!input || (typeof input !== 'string')) return '';
    return input.replace(tags, function ($0, $1) {
      return allowed.indexOf('<' + $1.toLowerCase() + '>') > -1 ? $0 : '';
    });
  },

  /**
   *  Remove all non-common characters like spaces, quotes, accents, etc. and
   *  joins strings with underscore symbols
   *
   */
  sanitizeString: function (str) {
    return str.replace(/[^a-z0-9\s]/gi, '').replace(/[_\s]/g, '_');
  },

  /**
   *  Returns true is value is a valid number. Based on jQuery isNumeric
   */
  isNumeric: function (value) {
    return !isNaN(parseFloat(value)) && isFinite(value);
  },

  /**
   * Formats a number that to include up to 2 decimal positions if less than 10
   * and up to 1 if greater than 10.
   */
  formatDecimalPositions: function (value) {
    // we are using here the unary operator because parseInt fails to handle exponential number
    var converted = +value;
    var p = 0;
    var abs_v;

    if (isNaN(converted) || converted === 0) {
      return value;
    }

    abs_v = Math.abs(converted);

    if (abs_v > 10) {
      p = 1;
    } else if (abs_v > 0.01) {
      p = Math.min(Math.ceil(Math.abs(Math.log(abs_v) / Math.log(10))) + 2, 2);
    }

    value = value.toFixed(p);
    var m = value.match(/(\.0+)$/);
    if (m) {
      value = value.replace(m[0], '');
    }

    return value;
  },

  /**
   *  Remove new lines from string
   *
   */
  removeNewLines: function (str) {
    return str.replace(/(\r\n|\n|\r)/gm, '');
  },

  /**
   * Returns true if the string ends with provided suffix
   */
  endsWith: function (str, suffix) {
    return str.indexOf(suffix, str.length - suffix.length) !== -1;
  },

  cloneObject: function (obj) {
    if (!obj) {
      return obj;
    }
    return JSON.parse(JSON.stringify(obj));
  },

  /**
   *  Capitalize first letter of string
   *
   */
  capitalize: function (str) {
    if (!str) {
      return str;
    }
    return str.charAt(0).toUpperCase() + str.slice(1);
  },

  sanitizeHtml: function (text) {
    return cdb.core.sanitize.sanitize(text || '');
  }
};

},{"cartodb.js":"cartodb.js","underscore":"underscore"}],436:[function(require,module,exports){
module.exports = "<div class=\"CDB-infowindow CDB-infowindow--light js-infowindow\">\n  <div class=\"CDB-infowindow-close js-close\"></div>\n  <div class=\"CDB-infowindow-container\">\n    <div class=\"CDB-infowindow-header CDB-infowindow-headerBg CDB-infowindow-headerBg--light js-header\" style=\"background: #35AAE5;\">\n      {{#loading}}{{/loading}}\n      <ul class=\"CDB-infowindow-list\">\n        {{#content.fields}}\n          {{^index}}\n            <li class=\"CDB-infowindow-listItem\">\n              {{#title}}<h5 class=\"CDB-infowindow-subtitle\">{{title}}</h5>{{/title}}\n              {{#value}}<h4 class=\"CDB-infowindow-title {{#type}}{{ type }}{{/type}}\">{{{ value }}}</h4>{{/value}}\n            </li>\n            {{^value}}{{/value}}\n          {{/index}}\n        {{/content.fields}}\n      </ul>\n    </div>\n    <div class=\"CDB-infowindow-inner js-inner\">\n      {{#loading}}\n        <div class=\"CDB-Loader js-loader is-visible\"></div>\n      {{/loading}}\n      <ul class=\"CDB-infowindow-list js-content\">\n        {{#content.fields}}\n          {{#index}}\n            <li class=\"CDB-infowindow-listItem\">\n              {{#title}}\n                <h5 class=\"CDB-infowindow-subtitle\">{{title}}</h5>\n              {{/title}}\n              {{#value}}\n                <h4 class=\"CDB-infowindow-title\">{{{ value }}}</h4>\n              {{/value}}\n              {{^value}}\n                <h4 class=\"CDB-infowindow-title\">NULL</h4>\n              {{/value}}\n            </li>\n          {{/index}}\n        {{/content.fields}}\n      </ul>\n    </div>\n    <div class=\"CDB-hook\">\n      <div class=\"CDB-hook-inner\"></div>\n    </div>\n  </div>\n</div>\n";

},{}],437:[function(require,module,exports){
module.exports = "<div class=\"CDB-infowindow CDB-infowindow--dark js-infowindow\" style=\"background:#2E3C43\">\n  <div class=\"CDB-infowindow-close js-close\"></div>\n  <div class=\"CDB-infowindow-container\">\n    <div class=\"CDB-infowindow-bg\">\n      <div class=\"CDB-infowindow-inner\">\n        {{#loading}}\n          <div class=\"CDB-Loader js-loader is-visible\"></div>\n        {{/loading}}\n        <ul class=\"CDB-infowindow-list js-content\">\n          {{#content.fields}}\n          <li class=\"CDB-infowindow-listItem\">\n            {{#title}}<h5 class=\"CDB-infowindow-subtitle\">{{title}}</h5>{{/title}}\n            {{#value}}<h4 class=\"CDB-infowindow-title\">{{{ value }}}</h4>{{/value}}\n            {{^value}}<h4 class=\"CDB-infowindow-title\">null</h4>{{/value}}\n          </li>\n          {{/content.fields}}\n        </ul>\n      </div>\n    </div>\n    <div class=\"CDB-hook\">\n      <div class=\"CDB-hook-inner\"></div>\n    </div>\n  </div>\n</div>\n";

},{}],438:[function(require,module,exports){
module.exports = "<div class=\"CDB-infowindow CDB-infowindow--light js-infowindow\" data-cover=\"true\">\n  <div class=\"CDB-infowindow-close js-close\"></div>\n  <div class=\"CDB-infowindow-container\">\n    <div class=\"CDB-infowindow-header CDB-infowindow-headerMedia js-header js-cover\">\n      {{#loading}}<div class=\"CDB-Loader js-loader\"></div>{{/loading}}\n      <div class=\"CDB-infowindow-mediaTitle\">\n        {{#content.fields.1}}\n          {{#value}}\n            <h4 class=\"CDB-infowindow-title\">\n              <span>{{{ value }}}</span>\n            </h4>\n          {{/value}}\n        {{/content.fields.1}}\n      </div>\n    </div>\n    <div class=\"CDB-infowindow-inner js-inner\">\n      {{#loading}}<div class=\"CDB-Loader js-loader\"></div>{{/loading}}\n      <div class=\"CDB-infowindow-list js-content\">\n        {{#content.fields}}\n          {{#index}}\n            <div class=\"CDB-infowindow-listItem CDB-infowindow-listItem--order{{index}}\">\n              {{#title}}<h5 class=\"CDB-infowindow-subtitle\">{{title}}</h5>{{/title}}\n              {{#value}}<h4 class=\"CDB-infowindow-title\">{{{ value }}}</h4>{{/value}}\n              {{^value}}<h4 class=\"CDB-infowindow-title\">null</h4>{{/value}}\n            </div>\n          {{/index}}\n        {{/content.fields}}\n      </div>\n    </div>\n    <div class=\"CDB-hook\">\n      <div class=\"CDB-hook-inner\"></div>\n    </div>\n  </div>\n</div>\n";

},{}],439:[function(require,module,exports){
module.exports = "<div class=\"CDB-infowindow CDB-infowindow--light js-infowindow\">\n  <div class=\"CDB-infowindow-close js-close\"></div>\n  <div class=\"CDB-infowindow-container\">\n    <div class=\"CDB-infowindow-bg\">\n      <div class=\"CDB-infowindow-inner\">\n        {{#loading}}\n          <div class=\"CDB-Loader js-loader is-visible\"></div>\n        {{/loading}}\n        <ul class=\"CDB-infowindow-list js-content\">\n          {{#content.fields}}\n          <li class=\"CDB-infowindow-listItem\">\n            {{#title}}<h5 class=\"CDB-infowindow-subtitle\">{{title}}</h5>{{/title}}\n            {{#value}}<h4 class=\"CDB-infowindow-title\">{{{ value }}}</h4>{{/value}}\n            {{^value}}<h4 class=\"CDB-infowindow-title\">null</h4>{{/value}}\n          </li>\n          {{/content.fields}}\n        </ul>\n      </div>\n    </div>\n    <div class=\"CDB-hook\">\n      <div class=\"CDB-hook-inner\"></div>\n    </div>\n  </div>\n</div>\n";

},{}],440:[function(require,module,exports){
module.exports = "<div class=\"CDB-infowindow CDB-infowindow--light js-infowindow\">\n  <div class=\"CDB-infowindow-close js-close\"></div>\n  <div class=\"CDB-infowindow-container\">\n    <div class=\"CDB-infowindow-header CDB-infowindow-headerBg CDB-infowindow-headerBg--light js-header\" style=\"background: #35AAE5;\">\n      {{#loading}}{{/loading}}\n      <ul class=\"CDB-infowindow-list\">\n        {{#content.fields}}\n          {{^position}}\n        <li class=\"CDB-infowindow-listItem\">\n          {{#title}}\n            {{#alternative_name}}\n          <h5 class=\"CDB-infowindow-subtitle\">{{{alternative_name}}}</h5>\n            {{/alternative_name}}\n            {{^alternative_name}}\n          <h5 class=\"CDB-infowindow-subtitle\">{{{name}}}</h5>\n            {{/alternative_name}}\n          {{/title}}\n          {{#name}}\n          <h4 class=\"CDB-infowindow-title {{#type}}{{=<% %>=}}{{<%={{ }}=%>{{{ type }}}{{=<% %>=}}}}<%={{ }}=%>{{/type}}\">\n            {{=<% %>=}}{{<%={{ }}=%>{{{ name }}}{{=<% %>=}}}}<%={{ }}=%>\n          </h4>\n          {{/name}}\n        </li>\n          {{/position}}\n        {{/content.fields}}\n      </ul>\n    </div>\n    <div class=\"CDB-infowindow-inner js-inner\">\n      {{#loading}}\n        <div class=\"CDB-Loader js-loader is-visible\"></div>\n      {{/loading}}\n      <ul class=\"CDB-infowindow-list js-content\">\n        {{#content.fields}}\n          {{#position}}\n        <li class=\"CDB-infowindow-listItem\">\n          {{#title}}\n            {{#alternative_name}}\n          <h5 class=\"CDB-infowindow-subtitle\">{{{alternative_name}}}</h5>\n            {{/alternative_name}}\n            {{^alternative_name}}\n          <h5 class=\"CDB-infowindow-subtitle\">{{{name}}}</h5>\n            {{/alternative_name}}\n          {{/title}}\n          <h4 class=\"CDB-infowindow-title\">{{=<% %>=}}{{<%={{ }}=%>{{{ name }}}{{=<% %>=}}}}<%={{ }}=%></h4>\n        </li>\n          {{/position}}\n        {{/content.fields}}\n      </ul>\n    </div>\n    <div class=\"CDB-hook\">\n      <div class=\"CDB-hook-inner\"></div>\n    </div>\n  </div>\n</div>\n";

},{}],441:[function(require,module,exports){
module.exports = "<div class=\"CDB-infowindow CDB-infowindow--dark js-infowindow\" style=\"background:#2E3C43\">\n  <div class=\"CDB-infowindow-close js-close\"></div>\n  <div class=\"CDB-infowindow-container\">\n    <div class=\"CDB-infowindow-bg\">\n      <div class=\"CDB-infowindow-inner\">\n        {{#loading}}\n          <div class=\"CDB-Loader js-loader is-visible\"></div>\n        {{/loading}}\n        <ul class=\"CDB-infowindow-list js-content\">\n          {{#content.fields}}\n          <li class=\"CDB-infowindow-listItem\">\n            {{#title}}\n              {{#alternative_name}}\n              <h5 class=\"CDB-infowindow-subtitle\">{{alternative_name}}</h5>\n              {{/alternative_name}}\n              {{^alternative_name}}\n              <h5 class=\"CDB-infowindow-subtitle\">{{name}}</h5>\n              {{/alternative_name}}\n            {{/title}}\n            <h4 class=\"CDB-infowindow-title\">{{=<% %>=}}{{<%={{ }}=%>{{{ name }}}{{=<% %>=}}}}<%={{ }}=%></h4>\n          </li>\n          {{/content.fields}}\n        </ul>\n      </div>\n    </div>\n    <div class=\"CDB-hook\">\n      <div class=\"CDB-hook-inner\"></div>\n    </div>\n  </div>\n</div>\n";

},{}],442:[function(require,module,exports){
module.exports = "<div class=\"CDB-infowindow CDB-infowindow--light js-infowindow\" data-cover=\"true\">\n  <div class=\"CDB-infowindow-close js-close\"></div>\n  <div class=\"CDB-infowindow-container\">\n    <div class=\"CDB-infowindow-header CDB-infowindow-headerMedia js-header js-cover\">\n      {{#loading}}<div class=\"CDB-Loader js-loader\"></div>{{/loading}}\n      <div class=\"CDB-infowindow-mediaTitle\">\n        {{#content.fields.1}}\n        <h4 class=\"CDB-infowindow-title\">\n          <span>{{=<% %>=}}{{<%={{ }}=%>{{{ name }}}{{=<% %>=}}}}<%={{ }}=%></span>\n        </h4>\n        {{/content.fields.1}}\n      </div>\n    </div>\n    <div class=\"CDB-infowindow-inner js-inner\">\n      {{#loading}}<div class=\"CDB-Loader js-loader\"></div>{{/loading}}\n      <div class=\"CDB-infowindow-list js-content\">\n        {{#content.fields}}\n          {{#position}}\n        <div class=\"CDB-infowindow-listItem CDB-infowindow-listItem--order{{position}}\">\n            {{#title}}\n              {{#alternative_name}}\n          <h5 class=\"CDB-infowindow-subtitle\">{{{alternative_name}}}</h5>\n              {{/alternative_name}}\n              {{^alternative_name}}\n          <h5 class=\"CDB-infowindow-subtitle\">{{{name}}}</h5>\n              {{/alternative_name}}\n            {{/title}}\n          <h4 class=\"CDB-infowindow-title\">{{=<% %>=}}{{<%={{ }}=%>{{{ name }}}{{=<% %>=}}}}<%={{ }}=%></h4>\n        </div>\n          {{/position}}\n        {{/content.fields}}\n      </div>\n    </div>\n    <div class=\"CDB-hook\">\n      <div class=\"CDB-hook-inner\"></div>\n    </div>\n  </div>\n</div>\n";

},{}],443:[function(require,module,exports){
module.exports = "<div class=\"CDB-infowindow CDB-infowindow--light js-infowindow\">\n  <div class=\"CDB-infowindow-close js-close\"></div>\n  <div class=\"CDB-infowindow-container\">\n    <div class=\"CDB-infowindow-bg\">\n      <div class=\"CDB-infowindow-inner\">\n        {{#loading}}\n          <div class=\"CDB-Loader js-loader is-visible\"></div>\n        {{/loading}}\n        <ul class=\"CDB-infowindow-list js-content\">\n          {{#content.fields}}\n          <li class=\"CDB-infowindow-listItem\">\n            {{#title}}\n              {{#alternative_name}}\n              <h5 class=\"CDB-infowindow-subtitle\">{{alternative_name}}</h5>\n              {{/alternative_name}}\n              {{^alternative_name}}\n              <h5 class=\"CDB-infowindow-subtitle\">{{name}}</h5>\n              {{/alternative_name}}\n            {{/title}}\n            <h4 class=\"CDB-infowindow-title\">{{=<% %>=}}{{<%={{ }}=%>{{{ name }}}{{=<% %>=}}}}<%={{ }}=%></h4>\n          </li>\n          {{/content.fields}}\n        </ul>\n      </div>\n    </div>\n    <div class=\"CDB-hook\">\n      <div class=\"CDB-hook-inner\"></div>\n    </div>\n  </div>\n</div>\n";

},{}],444:[function(require,module,exports){
module.exports = "<div class=\"CDB-Tooltip CDB-Tooltip--isDark\">\n  <ul class=\"CDB-Tooltip-list\">\n    {{#fields}}\n      <li class=\"CDB-Tooltip-listItem\">\n        {{#title}}\n          <h3 class=\"CDB-Tooltip-listTitle\">{{{ title }}}</h3>\n        {{/title}}\n        <h4 class=\"CDB-Tooltip-listText\">{{{ value }}}</h4>\n      </li>\n    {{/fields}}\n  </ul>\n</div>\n";

},{}],445:[function(require,module,exports){
module.exports = "<div class=\"CDB-Tooltip CDB-Tooltip--isLight\">\n  <ul class=\"CDB-Tooltip-list\">\n    {{#fields}}\n      <li class=\"CDB-Tooltip-listItem\">\n        {{#title}}\n          <h3 class=\"CDB-Tooltip-listTitle\">{{{ title }}}</h3>\n        {{/title}}\n        <h4 class=\"CDB-Tooltip-listText\">{{{ value }}}</h4>\n      </li>\n    {{/fields}}\n  </ul>\n</div>\n";

},{}],446:[function(require,module,exports){
module.exports = "<div class=\"CDB-Tooltip CDB-Tooltip--isDark\">\n  <ul class=\"CDB-Tooltip-list\">\n    {{#content.fields}}\n      <li class=\"CDB-Tooltip-listItem\">\n        {{#title}}\n          <h3 class=\"CDB-Tooltip-listTitle\">{{{ name }}}</h3>\n        {{/title}}\n        <h4 class=\"CDB-Tooltip-listText\">{{=<% %>=}}{{<%={{ }}=%>{{{ name }}}{{=<% %>=}}}}<%={{ }}=%></h4>\n      </li>\n    {{/content.fields}}\n  </ul>\n</div>\n";

},{}],447:[function(require,module,exports){
module.exports = "<div class=\"CDB-Tooltip CDB-Tooltip--isLight\">\n  <ul class=\"CDB-Tooltip-list\">\n    {{#content.fields}}\n      <li class=\"CDB-Tooltip-listItem\">\n        {{#title}}\n          <h3 class=\"CDB-Tooltip-listTitle\">{{{ name }}}</h3>\n        {{/title}}\n        <h4 class=\"CDB-Tooltip-listText\">{{=<% %>=}}{{<%={{ }}=%>{{{ name }}}{{=<% %>=}}}}<%={{ }}=%></h4>\n      </li>\n    {{/content.fields}}\n  </ul>\n</div>\n";

},{}],448:[function(require,module,exports){
var _ = require('underscore');
var Notifier = require('./components/notifier/notifier');

var NOTIFICATION_ERROR_TEMPLATE = _.template("<span class='CDB-Text u-errorTextColor'><%- title %></span>");
var NOTIFICATION_PREFIX = 'sql-notifications';

var SQLNotifications = {
  track: function (view) {
    // In order to not bloat the notification center we will create
    // only one notification, and update it along the way
    this._notificationId = NOTIFICATION_PREFIX;
  },

  removeNotification: function () {
    Notifier.removeNotification(this._notificationId);
  },

  showNotification: function (attrs) {
    this._addOrUpdateNotification(this._notificationId, attrs);
  },

  showErrorNotification: function (errors) {
    var notificationAttrs = {
      status: 'error',
      info: _t('notifications.sql.error.body', {
        body: NOTIFICATION_ERROR_TEMPLATE({
          title: _t('notifications.sql.error.title')
        }),
        error: this._transformErrors(errors)
      }),
      closable: false
    };

    this._addOrUpdateNotification(this._notificationId, notificationAttrs);
  },

  _transformErrors: function (errors) {
    return _.map(errors, function (err) {
      return err.message;
    }, this).join('. ');
  },

  _addOrUpdateNotification: function (notificationId, notificationAttrs) {
    var notification = this._getNotification(notificationId);
    if (notification) {
      notification.set(notificationAttrs);
    } else {
      this._addNotification(notificationId, notificationAttrs);
    }
  },

  _addNotification: function (notificationId, notificationAttrs) {
    notificationAttrs = _.extend({
      id: notificationId
    }, notificationAttrs);
    Notifier.addNotification(notificationAttrs);
  },

  _getNotification: function (notificationId) {
    return Notifier.getNotification(notificationId);
  }
};

module.exports = SQLNotifications;

},{"./components/notifier/notifier":252,"underscore":"underscore"}],449:[function(require,module,exports){
var _ = require('underscore');

var SOURCE_ID_REGEX = /^([a-z]+)(\d*)$/; // matches a string with one or more letters + numbers, e.g. 'b2'

var newId = function (id, seqChange) {
  if (!id || !id.match) throw new Error('invalid id');

  var matches = id.match(SOURCE_ID_REGEX);
  matches[2] = matches[2] || -1;

  if (matches && matches.length === 3) {
    // letter + next number
    var letter = matches[1];
    var seq = parseInt(matches[2], 10) + seqChange;
    return letter + Math.max(seq, 0);
  } else {
    throw new Error('invalid id');
  }
};

/**
 * Encapsulates logic related to the nodes' IDs.
 */
module.exports = {

  /**
   * Get next id in sequence of given source id.
   * @param {String} id, e.g. 'c2'
   * @return {String} e.g. 'c3'
   */
  next: function (id) {
    return newId(id, 1);
  },

  prev: function (id) {
    return newId(id, -1);
  },

  /**
   * Get the letter representation.
   * @param {String, Object} sourceId or backbone model that have id. e.g. 'c2'
   * @return {String} e.g. 'c' or an empty string if there is no letter in the given id
   */
  letter: function (sourceId) {
    if (!sourceId || !_.isString(sourceId)) return '';
    var match = sourceId.match(/^([a-z]+)/);
    return _.isArray(match) && match[0] || '';
  },

  /**
   * Get the sequence representation.
   * @param {String, Object} sourceId or backbone model that have id. e.g. 'c2'
   * @return {Number} e.g. 2 or undefined if there is no sequence
   */
  sequence: function (sourceId) {
    if (!sourceId || !_.isString(sourceId)) return;
    var match = sourceId.match(/(\d+$)/);
    return _.isArray(match) && match[0] || undefined;
  },

  changeLetter: function (id, newLetter) {
    var seq = id.match(/(\d+)$/)[0];
    return newLetter + seq;
  }

};

},{"underscore":"underscore"}],450:[function(require,module,exports){
module.exports={
  "feedback": "Give us feedback!",
  "user": {
    "you": "You"
  },
  "months": {
    "january": "January",
    "february": "February",
    "march": "March",
    "april": "April",
    "may": "May",
    "june": "June",
    "july": "July",
    "august": "August",
    "september": "September",
    "october": "October",
    "november": "November",
    "december": "December"
  },
  "assets": {
    "maki-icons": {
      "disclaimer": "<a href='https://github.com/mapbox/maki' target='_blank'>Maki Icons</a>, an open source project by <a href='http://mapbox.com' target='_blank'>Mapbox</a>"
    }
  },
  "operators": {
    "count": "COUNT",
    "sum": "SUM",
    "avg": "AVG",
    "min": "MIN",
    "max": "MAX"
  },
  "builder-activated-notification": {
    "message": "CARTO Builder has been activated in your account. <a href='https://carto.com/learn/guides' class='onboardingNotification-link'>Learn more</a> about it and let us know what you think or <a href='mailto:builder-support@carto.com' class='onboardingNotification-link'>contact us</a>. Happy mapping!"
  },
  "builder-onboarding": {
    "title": "Welcome to Builder,",
    "description": "Discover the new and exciting analyses you can perform with location intelligence.",
    "take-tour": "Take a tour",
    "edit-map": "Edit your map",
    "toolbar": {
      "title": "Toolbar",
      "description": "The toolbar provides options to access your dashboard, edit your map, and configure its settings."
    },
    "configurator": {
      "title": "Edit pane",
      "description": "Manage all the components of your map: add layers and widgets, import datasets, customize analyses, and change styles."
    },
    "map": {
      "title": "Map",
      "description": "Your map reflects changes instantly."
    },
    "widgets": {
      "title": "Widgets pane",
      "description": "The widgets you add to your map appear directly on your visualization."
    },
    "skip": "skip",
    "next": "next"
  },
  "data-onboarding": {
    "title": "Welcome to the layer pane",
    "description": "Analyze, style, and enhance your data with pop-ups and&nbsp;legends.",
    "take-tour": "Take the tour",
    "edit-layer": "Edit layer",
    "layer-options": {
      "title": "Layer options",
      "description": "Layers can be renamed by double-clicking on the layer name, centered by clicking in the crosshair, and exported through their contextual menu."
    },
    "data-tab": {
      "title": "Data tab",
      "description": "Style, add analysis, pop-ups, and legends to layers. To further explore your data, add widgets."
    },
    "sql-editor": {
      "title": "SQL View",
      "description": "Data layers can be edited and processed by using the SQL view at the bottom of the screen."
    },
    "add-geometry": {
      "title": "Add geometries and switch to dataset view",
      "description": "You can switch between map or data view. In map view, you can add points, lines, and polygons.",
      "edit-layer": "Edit layer"
    },
    "exit": "Exit tour",
    "next": "Next"
  },
  "analysis-onboarding": {
    "title": "The Art of Analysis",
    "description": "Build reproducible workflows for analyzing and explaining your data. Analyses turn your maps into Location Intelligence apps.",
    "description-list": {
      "item1": "Different analyses can be chained",
      "item2": "Analyses are dynamic. When the data changes, the analysis is&nbsp;refreshed.",
      "item3": "The original data is not modified by the analysis workflow.",
      "item4": "Some analysis queries add calculated results to columns in your dataset."
    },
    "done": "Done",
    "add-analysis": "Add analysis",
    "never-show-message": "Don't show me this again."
  },
  "style-onboarding": {
    "title": "Style this map!",
    "description": "Apply aggregation styling to maps and define options by geometry attributes or by a column value.",
    "aggregation": {
      "title": "How would you like to aggregate your data?",
      "description": "Map types are called \"Aggregation\". Add Torque, Heatmap, and other aggregation styles to data."
    },
    "style": {
      "title": "Make it beautiful!",
      "description": "Use these options to style your data in beautiful ways. For example, you can create thematic maps by altering the FILL option by value.",
      "short-description": "Use these options to style your data in beautiful ways."
    },
    "cartocss": {
      "title": "Dress it up with CartoCSS",
      "description": "Further style data by using the CartoCSS view at the bottom of the screen."
    },
    "take-tour": "Take the tour",
    "style-layer": "Style layer",
    "never-show-message": "Don't show me this again.",
    "exit": "Exit tour",
    "next": "Next"
  },
  "analyses-onboarding": {
    "placeholders": {
      "layer-name": "NAME OF THE LAYER",
      "clusters": "CLUSTERS",
      "method": "METHOD",
      "percentage": "PERCENTAGE"
    },
    "done": "Done",
    "finished": "has finished",
    "style-analysis": "Style this analysis",
    "read-more": "Read more in documentation",
    "learn-more": "Learn more",
    "never-show-message": "Don't show me this again.",
    "no-new-columns": "No new columns were created.",
    "geometries-updated": "The geometries in your table were updated",
    "new-column-added": "A new column has been added to your dataset.",
    "new-columns-created": "New columns have been created as a new dataset.",
    "new-column-included": "A new column has been included with your original data.",
    "new-columns-included": "New columns has been included with your original data.",
    "new-columns-included-based-on-input": "New columns have been included with your original data based on the columns chosen for the input.",
    "sampling": {
      "title": "Subsample of rows",
      "description": "A sample of your original table was randomly selected to give approximately a percentage of the rows from your input dataset."
    },
    "merge": {
      "title": "Join columns from 2nd layer",
      "description": "This analysis performed a columnar JOIN in order to get columns from two different tables."
    },
    "intersection": {
      "title": "Filter points in polygons",
      "description": "This analysis performs a spatial intersection, returning only the rows from the target layer which intersect with geometries in the source layer.",
      "source-cartodb-id": "This number represents the cartodb_id of the source geometry"
    },
    "area-of-influence": {
      "title": "Create areas of influence",
      "description": "Area of influence creates polygons according to the parameters set by the user.",
      "the-geom": "This column was updated to show the area of influence requested."
    },
    "aggregate-intersection": {
      "title": "Intersect second layer",
      "description": "This operation performs a spatial intersection and aggregates the geometry values from the target layer that intersect with the geometry of the source layer.",
      "count-vals-density": "This column is added if COUNT was chosen as the aggregation operation",
      "extra-column": "This column is added if {operation_type} is chosen with column {column_name}"
    },
    "filter": {
      "title": "Row filtering",
      "description": "Row filtering allows you to quickly narrow down the total data you display on a map or input into an analysis node."
    },
    "filter-by-node-column": {
      "title": "Filter by layer",
      "description": "Filter by layer allows you to filter the data in your layer by propagating the filters in the attached layer. Now if you filter on widgets added to the first node, the results in the second node would be also filtered."
    },
    "spatial-markov-trend": {
      "trend": "The normalized trend for each geometry",
      "trend_up": "The probability that a geometry's value will move to a higher class",
      "trend_down": "The probability that a geometry's value will move to a lower class",
      "volatility": "A measure of the potential for a geometry to possess values in other classes",
      "description": "Trends and volatility are calculated based on the time series data input. Trends calculated from inputs with a longer history are more precise. Inputs for the time column should equally spaced (e.g., all one week/month/year apart)."
    },
    "moran": {
      "title": "Detect outliers and clusters",
      "description": "Detect outliers and clusters finds areas in your data where clusters of high values or low values exist, as well as areas which are dissimilar from their neighbors.",
      "quads": "Classification of the geometry from the analysis",
      "significance": "The statistical significance of the geometry's classification of one of four quadrant types.",
      "moran": "The local statistic calculated from the Moran's I analysis for each geometry/value in the dataset.",
      "rowid": "The original row id of the geometry (cartodb_id)."
    },
    "kmeans": {
      "title": "Calculating point clusters",
      "cluster-no": "A numeric identifier for each cluster in your dataset. Values start at 1 and go up to the %{clusters} clusters you requested (or max rows if less).",
      "description": "Point clustering is uses k-means to calculate a predefined number of clusters from your data."
    },
    "data-observatory-measure": {
      "title": "Enrich from the Data Observatory",
      "custom-column": "This column contains the data requested from the Data Observatory",
      "description": "The Data Observatory enrichment is the result of the geometry location and the measure requested."
    },
    "connect-with-lines": {
      "title": "Connect with lines",
      "description": "Create lines from point datasets using a variety of methods",
      "the-geom": "This column was updated to be lines according to the method chosen.",
      "line-sequential": "This analysis creates a line by connecting all points in the dataset in a specified order",
      "line-source-to-target": "Link a source point to a target point based on a shared attribute",
      "line-to-column": "Create lines from a point to to a geometry stored in another column",
      "line-to-single-point": "Connect the coordinate from latitude and longitude columns to the point geometry (`the_geom`) in your dataset."
    },
    "group-points": {
      "title": "Group points into polygons",
      "the-geom": "This column was updated to polygons encompassing the input points.",
      "category": "This will be the category over which the polygons were calculated",
      "description": "Group points into polygons to create new polygons."
    },
    "georeference": {
      "title": "Georeference",
      "the-geom": "This column, which stores the geographic information in your dataset, has been updated to reflect the boundaries or locations from the inputs specified.",
      "description": "Georeferencing data is a service that uses information from many sources to get the geographical information associated with latitude/longitude columns, city names, postal codes, administrative boundaries, IP addresses, or street addresses."
    },
    "centroid": {
      "title": "Calculating centroids from geometries",
      "description": "Centroids are calculated from all, groups, or singular geometries. Using the optional parameters of Category, Aggregate, and Weight you can change how they are calculated and what information the result will contain. ",
      "the-geom": "Point geometries representing the centroid(s) of your input data.",
      "aggregated-value": "Stores the aggregate value for each centroid.",
      "non-aggregated-value": "Contains the count of features considered for each centroid",
      "category": "Stores the category value for each centroid from the source dataset"
    },
    "closest": {
      "description": "Find nearest analysis locates the closest points between two tables.",
      "source_cdb_id": "This column has been created with the related points id from the source table.",
      "the-geom": "This column has been updated with the target table geometries.",
      "title": "Find nearest"
    }
  },
  "analyses": {
    "connect-with-lines": {
      "title": "Connect with lines",
      "short-title": "Connect with lines"
    },
    "georeference": {
      "title": "Georeference",
      "short-title": "Georeference"
    },
    "data-observatory-measure": {
      "title": "Enrich from Data Observatory",
      "short-title": "Data observatory",
      "age-and-gender": "Age and Gender",
      "boundaries": "Boundaries",
      "education": "Education",
      "employment": "Employment",
      "families": "Families",
      "housing": "Housing",
      "income": "Income",
      "language": "Language",
      "migration": "Migration",
      "nationality": "Nationality",
      "population-segments": "Population segments",
      "race-and-ethnicity": "Race and Ethnicity",
      "religion": "Religion",
      "transportation": "Transportation",
      "filters": "Filters"
    },
    "merge": {
      "title": "Join columns from 2nd layer",
      "short-title": "Join columns"
    },
    "filter-by-node-column": {
      "title": "Filter by layer",
      "short-title": "Filter by layer"
    },
    "centroid": {
      "title": "Centroid from geometries",
      "short-title": "Centroid"
    },
    "group-points": {
      "title": "Group points into polygons",
      "short-title": "Group points"
    },
    "convex-hull": {
      "title": "Convex Hull",
      "short-title": "Convex Hull"
    },
    "concave-hull": {
      "title": "Concave Hull",
      "short-title": "Concave Hull"
    },
    "bounding-box": {
      "title": "Bounding Box",
      "short-title": "Bounding Box"
    },
    "bounding-circle": {
      "title": "Bounding Circle",
      "short-title": "Bounding Circle"
    },
    "area-of-influence": {
      "title": "Create areas of influence",
      "short-title": "AOI"
    },
    "filter-intersection": {
      "title": "Filter points in polygons",
      "short-title": "Filter points in polygons"
    },
    "aggregate-intersection": {
      "title": "Aggregate intersection",
      "short-title": "Aggregate intersection"
    },
    "filter": {
      "title": "Filter by column value",
      "short-title": "Filter"
    },
    "sampling": {
      "title": "Subsample percent of rows",
      "short-title": "Sampling"
    },
    "kmeans": {
      "title": "Calculate clusters of points",
      "short-title": "Clusters"
    },
    "moran-cluster": {
      "title": "Detect outliers and clusters",
      "short-title": "Outliers & clusters"
    },
    "spatial-markov-trend": {
      "title": "Predict trends and volatility",
      "short-title": "Trends"
    },
    "source": "Source",
    "routing": {
      "short-title": "Routing"
    }
  },
  "analysis-category": {
    "all": "All",
    "analyze-predict": "Analyze and predict",
    "create-clean": "Create and clean",
    "data-transformation": "Transform"
  },
  "form-components": {
    "editors": {
      "radio": {
        "true": "True",
        "false": "False",
        "null": "Null"
      },
      "fill": {
        "customize": "Custom color set",
        "quantification": {
          "title": "Quantification",
          "methods": {
            "jenks": "Jenks",
            "equal": "Equal Interval",
            "headtails": "Heads/Tails",
            "quantiles": "Quantiles",
            "category": "Category"
          }
        },
        "bins": "Buckets",
        "input-color": {
          "solid": "Solid",
          "value": "By value",
          "img": "Img"
        },
        "input-number": {
          "fixed": "Fixed",
          "value": "By value"
        },
        "input-ramp": {
          "buckets": "bucket |||| buckets"
        },
        "input-categories": {
          "null": "null",
          "others": "Others"
        },
        "image": {
          "recently-title": "Most used",
          "none": "None",
          "show-all": "Show full collections"
        }
      }
    }
  },
  "data": {
    "import-model": {
      "error-title": "There was an error",
      "error-starting-import": "Unfortunately, there was an error starting the import"
    },
    "upload-model": {
      "invalid-import": "Invalid import",
      "one-file": "Unfortunately, only one file is allowed per upload",
      "file-defined": "File name should be defined",
      "file-extension": "Unfortunately, this file extension is not allowed",
      "file-size": "Unfortunately, the size of the file is bigger than your remaining quota",
      "visualization-id": "The remote visualization id was not specified",
      "remote-file-size": "Unfortunately, the size of the remote dataset is bigger than your remaining quota",
      "url-invalid": "Unfortunately, the URL provided is not valid",
      "error-happened": "There was an error",
      "connection-error": "Unfortunately, there was a connection error",
      "twitter-dates-invalid": "Twitter dates are not valid",
      "twitter-dates-empty": "Twitter dates are empty",
      "twitter-categories-invalid": "Twitter categories are not valid",
      "twitter-data": "Twitter data is empty",
      "dataset-copy-undefined": "Dataset copy is not defined",
      "query-undefined": "Query is not provided"
    },
    "analysis-definition-node-model": {
      "validation": {
        "missing-required": "Required",
        "invalid-source": "Invalid source",
        "invalid-value": "Invalid value",
        "invalid-enum": "Invalid value, must be any of %{expectedValues}"
      }
    }
  },
  "components": {
    "geocoding": {
      "geocoding-error-details": {
        "close": "close",
        "description": "There was a problem georeferencing your data",
        "title": "Geocoding Error",
        "try-again": "Please try again and if the problem persists, <a href='mailto:support@carto.com?subject=Geocoding error with id:%{id}'>contact us</a> with the following code:",
        "view-dataset": "view dataset"
      },
      "geocoding-success-detail": {
        "amount-charged": "<strong>$%{price}</strong> will be charged to your account",
        "credits-consumed": "You have consumed all your credits during this billing cycle, price is $%{price} / 1,000 extra credits.",
        "description": "We've successfully geocoded <%- realRowsFormatted %> <%- geometryType %> of <%- processableRowsFormatted %>. |||| We've successfully geocoded <%- realRowsFormatted %> <%- geometryType %>s of <%- processableRowsFormatted %>.",
        "explanation": "Rows that are not geocoded could have errors in their column values, or dont exist in our data. Try geocoding again and check the 'override all values' to try again.",
        "no-extra-charge": "No extra charges have been done",
        "remainingQuotaFormatted": "You still have %{remainingQuotaFormatted} credits left for this month.",
        "title": "Data geocoded",
        "try-again": "Unsuccessful rows don't count against your quota, so we encourage you to take a look and try again.",
        "view-dataset": "view dataset"
      },
      "geocoding-no-result-details": {
        "close": "close",
        "description": "These rows contained empty values or perhaps we just didn't know what the values meant. We encourage you to take a look and try again.",
        "title": "No rows were georeferenced",
        "view-dataset": "view dataset"
      }
    },
    "background-importer": {
      "background-importer-item": {
        "completed": "completed",
        "error-connecting": "<span class='u-errorTextColor'>Error connecting</span> %{name}",
        "from": "from",
        "show": "show"
      },
      "warnings-details": {
        "continue-btn": "Continue",
        "find-connected-datasets": "You can find all the connected datasets under the datasets section.",
        "no-more-datasets": "No more than %{maxTablesPerImport} datasets can be imported from a single file.",
        "unable-to-import-datasets": "Unable to import all datasets in file"
      },
      "partial-import-details": {
        "find-connected-datasets": "You can find all the connected datasets under the datasets section.",
        "continue-btn": "Continue",
        "too-many-datasets": "NOTE: The file you uploaded contained too many datasets. No more than %{maxTablesPerImport} datasets can be imported from a single file.",
        "unable-to-import-as-layers": "Unable to add all imported datasets as layers",
        "upgrade-your-account": "<a href='https://carto.com/pricing/'>Upgrade your account</a> to add more than %{userMaxLayers} layers to your maps."
      },
      "connector-warning-details": {
        "continue-btn": "Continue",
        "too-many-rows": "You may have reached the maximum limit.",
        "unable-to-import-all-rows": "For a database connector import, the number of rows allowed is %{maxRowsPerConnectorImport}. Some of your data may not be imported."
      },
      "error-details": {
        "check-errors": "Check errors",
        "check-url": "Check that the URL you provided is OK",
        "close": "close",
        "dont-panic": "Dont panic, here's some info that might help",
        "remote-server-code": "The remote server returned a <span class='ErrorDetails-itemTextStrong'>%{httpResponseCode}</span> code.",
        "send-us-the-error-code": "Persisting error? Please <a href='mailto:support@carto.com'>send us</a> the following code",
        "unknown-error": "An unknown error has happened"
      },
      "upgrade-errors": {
        "8001": {
          "description": "Remove some of your datasets to gain available space or upgrade your account",
          "info": "Keep your data and get a larger quota by upgrading your plan",
          "title": "Your quota has run out"
        },
        "8005": {
          "description": "Remove any layer or upgrade your account",
          "info": "Keep your maps and get more layer count quota by upgrading your plan",
          "title": "You have reached your layer count limit"
        },
        "upgrade": "upgrade"
      },
      "twitter-import-details": {
        "new-type-created": "We've created a new dataset containing a total of %{datasetTotalRowsFormatted}<br/>tweet%{tweetPlural} with your search terms",
        "credit-left": "You still have %{availableTweetsFormatted} credit left for this billing cycle.",
        "credits-left": "You still have %{availableTweetsFormatted} credits left for this billing cycle.",
        "no-more-credits": "You have consumed all your credits during this billing cycle (price is $%{blockPriceFormatted}/%{blockSizeFormatted} extra credits).",
        "twitter-import-title": "Your Twitter dataset is created",
        "tweet-cost": {
          "free": "No extra charges have been applied",
          "paid": "$%{tweetsCostFormatted} will be charged to your account"
        },
        "errors": {
          "no-results": "Your search query was correct but returned no results, \n please try with a different set of parameters before running it again"
        }
      },
      "background-geocoding-item": {
        "geocoded": "%{realRowsFormatted}/%{processableRowsFormatted} row geocoded |||| %{realRowsFormatted}/%{processableRowsFormatted} rows geocoded",
        "geocoded-by-lat-lng": "Geocoded by latitude and longitude",
        "geocoding": "Geocoding %{tableName} dataset",
        "show": "show",
        "rows-geocoded": {
          "without-dataset": "%{realRowsFormatted} row geocoded |||| %{realRowsFormatted} rows geocoded",
          "in-dataset": "%{realRowsFormatted} row geocoded in %{tableName} dataset|||| %{realRowsFormatted} rows geocoded in %{tableName} dataset"
        },
        "errors": {
          "no-rows-geocoded": {
            "without-dataset": "No rows geocoded",
            "in-dataset": "No rows geocoded in %{tableName} dataset"
          },
          "geocoding-layer": "Ouch! There was an error geocoding %{tableName} layer"
        }
      },
      "background-import-limit": {
        "hurry": "In a hurry? <a href='%{upgradeUrl}'>Upgrade your account</a> to import several files at a time",
        "one-file": "Unfortunately, you can only import up to %{importQuota} files at the same time"
      },
      "free-trial": "Get a %{days} day free trial",
      "connecting": "Connecting",
      "dataset": "dataset",
      "geocoding": "Geocoding",
      "working": "Working"
    },
    "likes-pluralize": "like |||| likes",
    "custom-list": {
      "placeholder": "Search by %{typeLabel}",
      "no-items": "There are no %{typeLabel} items",
      "no-results": "No %{typeLabel} results found with '%{query}'",
      "add-custom-result": "Add custom value"
    },
    "datepicker": {
      "dates-placeholder": "Choose your dates",
      "get-last": "Get last",
      "hour": "hour",
      "min": "min",
      "from": "from",
      "to": "to",
      "or": "or",
      "days-pluralize": "1 day |||| %{smart_count} days",
      "weeks-pluralize": "1 week |||| %{smart_count} weeks",
      "hours-pluralize": "hour week |||| %{smart_count} hours",
      "gmt-convertion": "Date will be converted to GMT +0",
      "invalid-date": "Invalid date"
    },
    "taglist": {
      "none": "No tags",
      "placeholder": "Add tags"
    },
    "pagination-search": {
      "filter": {
        "search": "Search",
        "placeholder": "Search by username or email"
      },
      "loading": {
        "title": "Loading..."
      },
      "error": {
        "title": "Error",
        "desc": "Oops there was an error."
      },
      "no-results": {
        "title": "Oh! No results",
        "desc": "Unfortunately we could not find anything with these parameters"
      }
    },
    "modals": {
      "editor-vis-warning": {
        "title": "You are about to open an Editor map with the new Builder",
        "explanation": "Builder offers an easy-to-use and intuitive drag and drop functionality to analyze and visualize your data. However, some of the old Editor features, such as overlays, are not currently available in Builder.",
        "question": "Opening your map in Builder may cause the loss of any feature not supported yet. Are you sure you want to continue?",
        "go-back": "No, go back to dashboard",
        "open": "Yes, open with Builder",
        "duplicate": "duplicate and open with Builder",
        "opening-title": "Opening %{name} with Builder"
      },
      "add-basemap": {
        "modal-title": "Add a custom basemap",
        "modal-desc": "Select from these great resources",
        "adding-basemap": "Adding new basemap",
        "add-basemap-error": "Could not add basemap",
        "add-btn": "Add basemap",
        "cancel-btn": "Cancel",
        "validating": "Validating",
        "saving": "Saving layer",
        "fetching": "Fetching layers",
        "get-layers": "Get layers",
        "xyz": {
          "insert": "Insert your XYZ URL",
          "enter": "Enter a URL",
          "not-valid": "Insert a valid XYZ URL",
          "eg": "E.g.",
          "tms": "TMS",
          "couldnt-validate": "We couldn't validate this. If you're sure it contains data click \"add basemap\""
        },
        "mapbox": {
          "insert": "Insert your Mapbox URL",
          "enter": "Enter your map ID/URL",
          "enter-token": "Enter your access token",
          "error": "Error retrieving your basemap. Please check your access token.",
          "invalid": "This URL is not valid."
        },
        "wms": {
          "insert": "Insert your WMS/WMTS URL",
          "invalid": "The URL is either invalid or contains unsupported projections",
          "see-docs": "see docs",
          "oh-no": "Oh! No results",
          "unfortunately": "Unfortunately, we couldn't find a layer that matched your search term",
          "tables-pluralize": "table |||| tables",
          "placeholder": "%{layersFoundCount} %{layersFoundCountPluralize} found, %{layersAvailableCount} %{layersAvailableCountPluralize} available"
        },
        "tilejson": {
          "insert": "Insert your TileJSON URL",
          "invalid": "Invalid URL, please make sure it is correct"
        },
        "nasa": {
          "select": "Select a date from which you want a NASA Worldview basemap",
          "day": "Day",
          "night": "Night",
          "cant-select": "You can't select a date in night mode"
        }
      },
      "export-data": {
        "title": "Export data",
        "desc": "Select the preferred file format",
        "no-geometry": "To download any geospatial format like SHP, KML or GeoJSON don't forget to select the_geom on your query.",
        "loading": {
          "geometry": "Checking geometries...",
          "preparing": "Preparing content..."
        },
        "errors": {
          "title": "There was an error",
          "geometry-error": "We can't read data geometries",
          "unknown": "An error occurred"
        },
        "cancel": "Cancel",
        "download": "Download"
      },
      "maps-metadata": {
        "modal-title": "Map metadata",
        "modal-desc": "Edit the attributes of your map",
        "back-btn": "GO BACK",
        "save-btn": "Save",
        "cancel-btn": "Cancel",
        "form": {
          "name": "Map Name",
          "name-placeholder": "Type your name here",
          "description": "Description",
          "description-placeholder": "Type your description here",
          "tags": "Tags",
          "markdown": "Markdown supported"
        },
        "validation": {
          "error": {
            "name": "Name can't be blank"
          }
        },
        "error": {
          "title": "We couldn't save your data",
          "subtitle": "We had an error trying to save your data: <span class='CDB-Text is-semibold'>%{error}</span>"
        },
        "loading": "Saving your data...",
        "success": "<span class='CDB-Text is-semibold'>Metadata</span> for %{name} map <span class='CDB-Text is-semibold'>was saved</span>."
      },
      "dataset-metadata": {
        "modal-title": "Dataset metadata",
        "modal-desc": "Edit the attributes of your dataset",
        "back-btn": "GO BACK",
        "save-btn": "Save",
        "cancel-btn": "Cancel",
        "form": {
          "name": "Dataset Name",
          "name-placeholder": "Type your name here",
          "description": "Description",
          "description-placeholder": "Type your description here",
          "attributions": "Attributions",
          "attributions-placeholder": "Type your attributions here",
          "tags": "Tags",
          "source": "Source",
          "source-placeholder": "Enter the source of the data",
          "license": "License",
          "markdown": "Markdown supported"
        },
        "validation": {
          "error": {
            "name": "Name can't be blank"
          }
        },
        "error": {
          "title": "We couldn't save your data",
          "subtitle": "We had an error trying to save your data: <span class='CDB-Text is-semibold'>%{error}</span>"
        },
        "loading": "Saving your data...",
        "success": "<span class='CDB-Text is-semibold'>Metadata</span> for %{name} dataset <span class='CDB-Text is-semibold'>was saved</span>."
      },
      "publish": {
        "done-btn": "Done",
        "update-btn": "Update",
        "publish-btn": "Publish",
        "publishing-btn": "Publishing",
        "updating-btn": "Updating",
        "menu": {
          "share": "Share with colleagues",
          "publish": "publish"
        },
        "privacy": {
          "privacy": "privacy",
          "cta": {
            "title": "Want some privacy?",
            "desc-trial": "Check our plans with 14 days trial",
            "desc-notrial": "Upgrade your account!"
          },
          "public": {
            "type": "PUBLIC",
            "title": "Public",
            "body": "Everyone can view your table and download it"
          },
          "link": {
            "type": "LINK",
            "title": "Only accessible with link",
            "body": "Only the people with a shared link can view the data"
          },
          "password": {
            "type": "PASSWORD",
            "title": "Password",
            "body": "Set a password and share only with specific people",
            "placeholder": "Type your password"
          },
          "private": {
            "type": "PRIVATE",
            "title": "Private",
            "body": "Nobody can access this dataset"
          },
          "error": {
            "title": "We couldn't save your data",
            "subtitle": "We had an internal error trying to save your data. We recommend you try again."
          },
          "upgrade": {
            "title": "Interested in sharing within your organization?",
            "desc": "%{contact} to try one of our Enterprise plans",
            "contact": "Contact us",
            "mail": "sales@carto.com"
          },
          "loading": "Saving your data..."
        },
        "share": {
          "published": "Published %{when}",
          "unpublished": "Never published.",
          "last-published": "Last updated %{date}",
          "unpublished-header": "Click on Publish to start sharing your map on the web",
          "unpublished-subheader": "From the moment you click on publish, you will need to use this window to update your changes on the public version.",
          "upgradeLabel": "Upgrade",
          "upgradeLink": "https://carto.com/pricing/#pricing-standard",
          "upgrade": "%{upgradeLink} to share with your colleagues?",
          "private": "PRIVATE",
          "get-link": {
            "title": "Get the link",
            "body": "Send to your friends, coworkers, or post it in your social networks.",
            "link": "",
            "copy": "COPY",
            "select": "SELECT",
            "private": {
              "body": "Your map is %{private} Change privacy to get the link"
            }
          },
          "embed": {
            "title": "Embed it",
            "body": "Insert your map into your blog, website, or simple application.",
            "link": "Get a simple URL.",
            "copy": "COPY",
            "select": "SELECT",
            "private": {
              "body": "Your map is %{private} Change privacy to embed map"
            }
          },
          "cartodbjs": {
            "title": "CARTO.js",
            "body": "Add your map to your applications using this URL.",
            "link": "Read more.",
            "copy": "COPY",
            "select": "SELECT"
          },
          "mobile-sdk": {
            "title": "CARTO Mobile SDK",
            "body": "Add your map to your native mobile applications using this line of code.",
            "link": "Read more.",
            "copy": "COPY",
            "select": "SELECT"
          },
          "error": {
            "title": "We couldn't save your data",
            "subtitle": "We had an internal error trying to save your data. We recommend you try again."
          },
          "loading": "Saving your data...",
          "organization": {
            "title": "Default settings for your Organization",
            "desc": "New users will have this permission"
          },
          "role": {
            "viewer": "Viewer",
            "builder": "Builder"
          },
          "tooltip": {
            "group": "Access is inherited from group %{name}",
            "org": "Access is inherited from organization"
          },
          "toggle": {
            "read": "Read",
            "write": "Write"
          },
          "add-people": "Add people"
        }
      },
      "assets-picker": {
        "browse": "Browse",
        "delete-image": "Delete image",
        "delete-images": "Delete images",
        "deselect-all": "Deselect all",
        "drag-and-drop": "Drag & drop your file",
        "error-desc": "Please, go back and try again. If the problem persists contact us at <a href='mailto:support@carto.com'>support@carto.com</a>",
        "go-back": "Go back",
        "incorrect-url": "Error. Your URL doesnt look correct.",
        "loading": "Loading",
        "or": "or",
        "select-all": "Select all",
        "submit": "submit",
        "upload-desc": "Paste a URL or select a file like JPG, GIF, PNG, SVG",
        "upload-file-url": "Upload a file or a URL"
      },
      "add-asset": {
        "icons": "Icons",
        "modal-desc": "or just use our nice selection",
        "modal-title": "Select marker image",
        "set-image": "Set image",
        "upload-file": "Upload file",
        "upload-asset": "Upload asset",
        "upload-image": "Upload your image",
        "your-uploads": "Your uploads",
        "organization-uploads": "Organization uploads"
      },
      "add-analysis": {
        "modal-title": "Add a new analysis",
        "modal-desc": "Select the analysis you want to add",
        "loading-title": "Loading options",
        "add-btn": "Add analysis",
        "disabled-option-desc": "Your layer's geometries are %{simpleGeometryType} and this analysis needs %{requiredInputGeometries}",
        "unknown-geometry-type": "unknown",
        "info-analysis": "Info about analysis",
        "option-types": {
          "connect-with-lines": {
            "title": "Connect with lines",
            "desc": "Create lines from point datasets using a variety of methods"
          },
          "group-points": {
            "title": "Group points into polygons",
            "desc": "Aggregate points into polygons such as convex hulls or bounding boxes."
          },
          "aggregate-intersection": {
            "title": "Intersect second layer",
            "desc": "Intersect with a second layer and calculate aggregations on the fly."
          },
          "area-of-influence": {
            "title": "Create areas of influence",
            "desc": "Use travel time (e.g. walking or driving) or distance to calculate areas of influence from points."
          },
          "georeference": {
            "title": "Georeference",
            "desc": "Use street addresses, city names, or other location text to generate point geometries."
          },
          "filter-intersection": {
            "title": "Filter points in polygons",
            "desc": "Filter points intersecting your polygons layer, and augment those with your polygons columns."
          },
          "filter": {
            "title": "Filter by column value",
            "desc": "Keep or discard rows according to a custom criteria."
          },
          "merge": {
            "title": "Join columns from 2nd layer",
            "desc": "Join columns from a second layer by linking a shared value found in both datasets."
          },
          "moran-cluster": {
            "title": "Detect outliers and clusters",
            "desc": "Use Moran's I to find high (HL) and low (LH) outliers and high (HH) and low (LL) clusters.",
            "high-low": "High-Low (HL)",
            "high-high": "High-High (HH)",
            "low-high": "Low-High (LH)",
            "low-low": "Low-Low (LL)"
          },
          "kmeans": {
            "title": "Calculate clusters of points",
            "desc": "Spatially separate a layer of points into a specified number (N) of groups."
          },
          "centroid": {
            "title": "Find centroid of geometries",
            "desc": "Calculate a direct or weighted centroid based on all rows of a layer or by categories."
          },
          "filter-by-node-column": {
            "title": "Filter by layer",
            "desc": "Filter your layer depending on a second layer such that widgets will effect both."
          },
          "sampling": {
            "title": "Subsample percent of rows",
            "desc": "Subsample the rows in a dataset based on a specified percent."
          },
          "spatial-markov-trend": {
            "title": "Predict trends and volatility",
            "desc": "Predict probability of upward and downward trends using spatial Markov chains."
          },
          "data-observatory-measure": {
            "title": "Enrich from Data Observatory",
            "desc": "Add a new column with contextual demographic and economic measures."
          },
          "deprecated-sql-function": {
            "title": "SQL Function",
            "desc": "Run your custom SQL function"
          }
        }
      },
      "add-widgets": {
        "modal-title": "Add new widgets",
        "modal-desc": "Select the widgets you want to add",
        "continue-btn": "Continue",
        "loading-title": "Loading columns",
        "tab-pane": {
          "histogram-label": "Histogram",
          "category-label": "Category",
          "formula-label": "Formula",
          "time-series-label": "Time-series"
        },
        "percentage-in-top-cats": "% in top 10 cat",
        "time-series-no-option-title": "None",
        "time-series-no-option-desc": "This option won't show your time-series widget"
      },
      "add-layer": {
        "modal-title": "Add a new layer",
        "modal-desc": "Select an existing dataset or connect a new one",
        "navigation": {
          "search": "Search",
          "search-placeholder": "by name, description, or :tag",
          "connect-dataset": "Connect dataset",
          "shared-with-you": "Shared with you",
          "data-library": "Data library",
          "create-empty-map": "Create empty map",
          "create-empty-dataset": "Create empty dataset",
          "create-empty-addLayer": "Add an empty layer",
          "dataset-pluralize": "Dataset |||| Datasets"
        },
        "create-loading-title": "Creating an empty dataset",
        "adding-new-layer": "Adding new layer",
        "add-layer-error": "Could not add layer",
        "imports": {
          "ask-for-demo": "ask for demo",
          "connector": "connector",
          "demo-email-title": "I am interested in the %{name} connector",
          "demo-email-desc": "Hi, I am interested in testing the %{name} connector. Please contact me to schedule a demo of this feature.",
          "tab-options-error": {
            "no-key": "%{name} key is not specified and the panel can't be enabled",
            "not-allowed": "%{name} data source is not available for your plan. Please upgrade.",
            "limits-reached": "You've reached the limits for your account. Please upgrade.",
            "no-credits": "You've reached the available %{name} credits for your account this month."
          },
          "member-pluralize": "member |||| members",
          "item-pluralize": "item |||| items",
          "form-import": {
            "browse": "Browse",
            "drag-and-drop": "Drag & drop your file",
            "error-desc": "Error. Your URL doesnt look correct.",
            "format": "Format",
            "or": "or",
            "title": "Enter a URL",
            "desc": "Paste a URL and start the import",
            "submit": "submit"
          },
          "header-import": {
            "import-url": "Import your data from a %{brand} URL",
            "file-selected": "File selected",
            "paste-url": "Paste a URL %{fileEnabled} ",
            "select-a-file": "or select a file like CSV, XLS, ZIP, KML, GPX,",
            "see-all-formats": "see all formats",
            "sync-enabled": "Keep it synchronized with the source",
            "sync-disabled": "Sync options are not available",
            "type-selected": "%{brand} selected",
            "type-import": "%{brand} import",
            "upload-file-url": "Upload a file or a URL |||| Upload a URL"
          },
          "service-import": {
            "and": "and",
            "account-connected": "Account connected",
            "connect-with": "Connect with %{title}",
            "choose": "Choose",
            "connect": "Connect",
            "found-in": "%{size} %{pluralize} found in %{title}",
            "item-selected": "Item selected",
            "many-more-formats": "many more formats",
            "no-results-title": "Oouch! There are no results",
            "no-results-desc": "We haven't found any valid file from your account",
            "state-idle-login": "Login to your account and select any item.",
            "state-error": "We are sorry that you cant connect to your %{title} account. Be sure you have any pop-up blockers deactivated for this website.",
            "state-token": "Checking Token.",
            "state-oauth": "Requesting oAuth.",
            "state-retrieving": "A list of your %{title} files will be displayed in a moment.",
            "state-selected-sync": "You can choose when to sync the file.",
            "state-selected-instagram": "A map containing all your georeferenced photos will be created",
            "state-selected-no-sync": "Sync options are not available.",
            "supported": "supported",
            "try-again": "Try again"
          },
          "selected-state": {
            "sync-my-data": "Sync my data",
            "never": "Never",
            "every-hour": "Every hour",
            "every-day": "Every day",
            "every-week": "Every week",
            "every-month": "Every month",
            "free-trial": "%{days} day free trial",
            "more-features": "more features",
            "upgrade-desc": "Upgrade your account to get sync options and %{features}",
            "upgrade": "upgrade"
          },
          "twitter": {
            "category": "Category",
            "credits-consumed": "Twitter credits for this period consumed - %{extraTweets} will be charged",
            "credits-left": "%{per}% of your %{remainingFormatted} Twitter credits left",
            "credits-no-limit": "No limits - %{extraTweets} will be charged",
            "extra-tweets": "extra tweets",
            "fallback-title": "Enable the %{brand} connector",
            "fallback-desc": "The %{brand} connector allows you to map %{brand} data activity related to your brand, event, or any term you may be interested in.",
            "from-to": "From / to",
            "terms-desc": "Enter up to four search terms using the category fields.",
            "terms-placeholder": "Insert your terms separated by commas",
            "title": "Twitter trends",
            "twitter-gmt": "Time is in GMT+0",
            "use": "Use",
            "your-gmt": "You are in GMT"
          },
          "arcgis": {
            "fallback-desc": "Enable the %{brand} connector in your account to connect your %{brand} data to CARTO and mantain it in sync with the source.",
            "input-placeholder": "Paste your %{brand} table URL here",
            "url-desc": "To retrieve a particular layer, add the layer index at the end of the URL",
            "import-data": "Import your data from a %{brand} instance",
            "sync-options": "Sync options only available for a layer"
          },
          "instagram": {
            "fallback-desc": "Enable the %{brand} connector to map your photos or videos from your account in CARTO."
          },
          "box": {
            "fallback-desc": "Enable the %{brand} connector in your account to map your %{brand} files in CARTO or mantain your CARTO maps in sync with your Box data."
          },
          "mailchimp": {
            "campaign-selected": "%{brand} campaign selected",
            "fallback-desc": "Enable the %{brand} connector in your account to map your user lists from %{brand} in CARTO or mantain your CARTO maps in sync with your %{brand} data.",
            "map-campaign": "Map your %{brand} campaigns",
            "state-idle": "Connect your %{brand} account to select any of your campaigns.",
            "state-error": "We are sorry, there has been an error while connecting to your %{brand} account. Just in case it helps, be sure you have the pop-up blocker deactivated for this website.",
            "state-token": "Checking %{brand} token.",
            "state-oauth": "Requesting oAuth.",
            "state-retrieving": "A list of your %{brand} campaigns will be displayed in a moment.",
            "state-selected": "Campaign selected."
          },
          "salesforce": {
            "fallback-desc": "Enable the %{brand} connector in your account to map your user lists from %{brand} in CARTO or mantain your CARTO maps in sync with your %{brand} data.",
            "input-placeholder": "Paste your %{brand} URL here"
          }
        },
        "datasets": {
          "item": {
            "sync-failed": "Sync failed, the last attempt was",
            "syncing": "Syncing",
            "synced": "Synced",
            "read": "read",
            "from": "from",
            "by": "by",
            "no-description": "No description",
            "rows-pluralize": "row |||| rows",
            "tags-more": "and %{tagsCount} more",
            "no-tags": "No tags"
          },
          "loading": "Loading",
          "searching": "Searching",
          "error": {
            "title": "Ouch! There has been an error loading your datasets",
            "desc": "If the problem persists contact us at"
          },
          "no-datasets": {
            "title": "You have not connected any datasets yet",
            "desc": "You can %{connectDataset} or %{search} in all our data library",
            "connect-datasets": "connect datasets",
            "search": "search"
          },
          "no-results": {
            "desc": "There are no results in this page",
            "found": "found",
            "there-are-no": "There are no",
            "no-fun": "No %{type}, no fun"
          }
        },
        "footer": {
          "guessing-desc": "Let CARTO automatically guess data types and content on import.",
          "twitter-desc": "To get access to historical data (older than 30 days) you need to",
          "contact-team": "contact our team",
          "privacy-upgrade": "You cannot change the privacy of your new datasets. Click here to upgrade your account.",
          "privacy-change": "Your new dataset will be %{privacy}",
          "privacy-click": "Click to change it to %{nextPrivacy}",
          "privacy-change-banned": "You cannot change the privacy of your new datasets.",
          "add-layer": "Add layer"
        }
      },
      "edit-feature": {
        "confirmation": {
          "title": "This geometry is too big to edit from the web",
          "desc": "Editing this geometry could freeze or crash your browser, and you could lose your work. We encourage you to edit this feature through the API.",
          "cancel": "Cancel",
          "continue": "Ok, continue"
        },
        "delete": {
          "title": "You are about to delete a feature",
          "desc": "Are you sure you want to delete it?",
          "cancel": "Cancel",
          "confirm": "Ok, delete it"
        }
      }
    },
    "error": {
      "default-title": "Oops, there was a problem",
      "default-desc": "Reload the page again. If the problem persists contact us at <a href='mailto:support@carto.com'>support@carto.com</a>"
    },
    "backbone-forms": {
      "select": {
        "placeholder": "Select a %{keyAttr}",
        "loading": "loading",
        "empty": "No values",
        "selected": "%{count} selected"
      },
      "operators": {
        "count-message": "If you select 'COUNT' all columns are selected"
      },
      "interval-error": "Value must be between %{minValue} and %{maxValue}",
      "copy-button": "COPY",
      "data-observatory": {
        "dropdown": {
          "measurement": {
            "search": "Search...",
            "type": "measurements"
          },
          "filter": {
            "header": "Filter measurements by",
            "type": "filters"
          }
        }
      }
    },
    "codemirror": {
      "no-errors": "No errors",
      "docs": "DOCS",
      "syntax-error": "Syntax error",
      "line": "Line"
    },
    "undo-redo": {
      "clear": "CLEAR",
      "apply": "APPLY"
    },
    "table": {
      "columns": {
        "change-type": {
          "confirm": "ok, change it",
          "cancel": "Cancel",
          "desc": "Maps using this column will be affected and unconvertible data will be lost. Are you sure?",
          "error": "There was an error changing %{columnName} column: %{error}",
          "loading": "Changing %{columnName} column...",
          "title": "%{columnName} column will change to %{newType}",
          "success": "Column %{columnName} changed to %{newType}"
        },
        "create": {
          "loading": "Adding new column...",
          "error": "Error adding new column: %{error}",
          "success": "%{columnName} column added"
        },
        "destroy": {
          "cancel": "Cancel",
          "confirm": "Ok, delete it",
          "desc": "Maps using this column will be affected, are you sure you want to delete it?",
          "error": "Error deleting %{columnName} column: %{error}",
          "loading": "Removing your column %{columnName}...",
          "success": "%{columnName} column deleted",
          "title": "You are about to delete %{columnName} column "
        },
        "rename": {
          "cancel": "Cancel",
          "confirm": "ok, rename it",
          "desc": "Maps using this column will be affected, are you sure you want to rename it?",
          "error": "Error renaming column %{columnName} to %{newName}: %{error}",
          "loading": "Renaming your column %{columnName} to %{newName}...",
          "success": "Column %{columnName} renamed to %{newName}",
          "title": "You are about to rename column %{columnName} to %{newName}"
        },
        "options": {
          "order": "Order",
          "rename": "Rename column",
          "change": "Change data type",
          "create": "Add new column",
          "delete": "Delete this column..."
        },
        "types": {
          "boolean": "Boolean",
          "date": "Date",
          "number": "Number",
          "string": "String"
        }
      },
      "rows": {
        "loading": {
          "title": "Loading rows..."
        },
        "error": {
          "title": "There was an error...",
          "desc": "It was not possible to obtain any results, check the query applied"
        },
        "result": {
          "no-page-title": "Ouch! Sorry",
          "no-page-desc": "This page %{page} doesn't contain any results...",
          "no-results-title": "There is no data",
          "no-results-desc": "",
          "no-results-button": ""
        },
        "options": {
          "copy": "Copy cell value",
          "create": "Add new row",
          "edit": "Edit this cell",
          "delete": "Delete this row..."
        },
        "create": {
          "loading": "Adding new row...",
          "error": "Error adding new row: %{error}",
          "success": "New row added"
        },
        "edit": {
          "loading": "Editing %{attribute} with cartodb_id %{cartodbId}...",
          "error": "Error editing %{attribute} with cartodb_id %{cartodbId}: %{error}",
          "success": "Edited %{attribute} with cartodb_id %{cartodbId}"
        },
        "destroy": {
          "cancel": "Cancel",
          "confirm": "ok, delete",
          "desc": "Are you sure you want to delete it?",
          "error": "Error deleting row with cartodb_id %{cartodb_id}: %{error}",
          "loading": "Removing your row with cartodb_id %{cartodb_id}...",
          "success": "Row with cartodb_id %{cartodb_id} deleted",
          "title": "You are about to delete row with cartodb_id %{cartodb_id}"
        },
        "paginator": {
          "error": "There was an error with pagination: %{error}",
          "to": "to"
        }
      }
    }
  },
  "dataset": {
    "sql": "SQL",
    "data": "Metadata",
    "updated": "Updated %{ago}",
    "read": "Read",
    "options": {
      "add-row": "Add row",
      "add-column": "Add column",
      "export": "Export"
    },
    "preview-map": {
      "preview": "preview",
      "back": "back"
    },
    "create-map": {
      "title": "Create map",
      "loading": "Creating a map from %{tableName}",
      "error": "There was an error creating the map"
    },
    "delete": {
      "option": "Delete dataset...",
      "cancel": "Cancel",
      "confirm": "Ok, delete it",
      "desc": "The deleted dataset cannot be recovered, be sure before proceeding. We recommend you to export your dataset before deleting it.",
      "error": "Error deleting %{tableName}: %{error}",
      "loading": "Deleting your dataset %{tableName}...",
      "title": "You are about to delete the %{tableName} dataset",
      "affected-vis-count": "%{smart_count} map affected |||| %{smart_count} maps affected",
      "affected-vis-count-extended": "%{affectedVisCount} maps affected, some of them are",
      "affected-entities-count": "%{smart_count} user will lose access |||| %{smart_count} users will lose access",
      "affected-entities-count-extended": "%{affectedEntitiesCount} users will lose access, some of them are",
      "whole-organization-affected": "All users from your organization will be affected"
    },
    "metadata": {
      "option": "Edit metadata",
      "error": "There was an error edititng metadata of your dataset %{name}",
      "loading": "Editing metadata of your dataset %{name}..."
    },
    "duplicate": {
      "option": "Duplicate dataset",
      "query": "applied query",
      "customOption": "Create Dataset from query",
      "error": "There was an error duplicating %{name}",
      "loading": "Duplicating your dataset %{name}..."
    },
    "lock": {
      "option": "Lock dataset",
      "error": "There was an error locking %{tableName}",
      "loading": "Locking your dataset %{tableName}..."
    },
    "rename": {
      "option": "Rename dataset",
      "cancel": "Cancel",
      "confirm": "ok, rename it",
      "desc": "If you are accessing this dataset via API, don't forget to use the new name in your API calls afterwards.",
      "error": "Error renaming %{tableName}: %{error}",
      "loading": "Renaming your dataset %{tableName}...",
      "success": "Dataset %{tableName} renamed",
      "title": "Renaming %{tableName} will affect your API calls, maps, analyses, ..."
    },
    "sync": {
      "in-a-moment": "in a few moments",
      "synced": "Synced %{ranAt}",
      "syncing": "Syncing",
      "loading": "Syncing dataset %{tableName}",
      "sync-failed": "Sync failed",
      "next": "Next will be %{runAt}",
      "error-code": "Error code %{errorCode}",
      "sync-now": "Sync now",
      "view-options": "View options",
      "disabled": "You will be able to sync manually %{gap} minutes after your last synchronization",
      "title": "Sync dataset options",
      "desc": "Your dataset is in sync with a %{service} file: <br/>%{url}",
      "label": "Sync my data",
      "error": "There was an error setting the interval",
      "confirm": "Save",
      "cancel": "Cancel"
    },
    "unlock": {
      "cancel": "back to dashboard",
      "confirm": "ok, unlock it",
      "desc": "That means you need to unlock it before doing anything. Are you sure?",
      "error": "Error unlocking %{tableName}: %{error}",
      "loading": "Unlocking your dataset %{tableName}...",
      "success": "Dataset %{tableName} unlocked",
      "title": "Your dataset %{tableName} is locked."
    }
  },
  "editor": {
    "map": "map",
    "map_name": "%{name} map",
    "published": "Published %{when}",
    "unpublished": "Map not published yet",
    "map_pluralize": "%{smart_count} map |||| %{smart_count} maps",
    "button_add": "Add",
    "button_share": "SHARE",
    "unpublished-changes": "Unpublished changes",
    "error-query": {
      "body": "Errors found in your SQL query. %{action} before continuing.",
      "label": "Fix them"
    },
    "settings": {
      "menu-tab-pane-labels": {
        "preview": "Preview",
        "snapshots": "Snapshots"
      },
      "preview": {
        "mode": {
          "title": "Mode"
        },
        "options": {
          "title": "Map Options",
          "subtitle": "Components that are shown in the map",
          "description": {
            "title": "Components",
            "subtitle": "Change map elements"
          },
          "elements": {
            "search": "Search box",
            "zoom": "Zoom controls",
            "fullscreen": "Fullscreen",
            "scrollwheel": "Scroll wheel zoom",
            "layer_selector": "Layer selector",
            "logo": "CARTO Logo",
            "widgets": "Widgets column",
            "legends": "Legends",
            "dashboard_menu": "Show toolbar"
          }
        }
      }
    },
    "maps": {
      "options": {
        "duplicate": "Duplicate",
        "edit-metadata": "Edit metadata",
        "export-image": "Export image",
        "export-map": "Download map",
        "remove": "Delete map",
        "rename": "Rename"
      },
      "duplicate": {
        "error": "There was an error duplicating %{name}",
        "loading": "Duplicating your map %{name}..."
      },
      "delete": {
        "confirm": "Ok, delete it",
        "cancel": "Cancel",
        "desc": "The deleted map cannot be recovered, be sure before proceeding.",
        "title": "You are about to delete map %{name}",
        "error": "Error deleting map %{name}: %{error}",
        "loading": "Removing the map %{name}...",
        "success": "Map %{name} deleted"
      },
      "export-image": {
        "title": "Export as image",
        "export": "Export",
        "generating": "Generating",
        "disclaimer": {
          "title": "Disclaimer",
          "body": "Legends and widgets won't be exported as part of the image"
        },
        "download": "Download",
        "errors": {
          "try-again": "Please, try again. If the problem persists, contact support",
          "error-attribution": "Error generating attribution.",
          "error-basemap": "Error loading basemap.",
          "error-image": "Error generating image."
        }
      },
      "export": {
        "confirmation": {
          "confirm": "Download",
          "cancel": "Cancel",
          "desc": "This map, and the connected data, will be downloaded as a .carto file",
          "title": "Download \"%{name}\""
        },
        "download": {
          "confirm": "Download",
          "tip": "Tip: Allow pop-ups from CARTO in your web browser.",
          "desc": "Click Download to begin the .carto file download.",
          "title": "Ready to Download"
        },
        "error": {
          "title": "An error occured while exporting your map",
          "desc": "Please try again. If the problem persists, please contact support"
        }
      },
      "rename": {
        "loading": "Renaming map...",
        "success": "Map renamed to %{name}",
        "error": "Error renaming map %{name}: %{error}"
      }
    },
    "tab-pane": {
      "layers": {
        "title-label": "Layers",
        "georeference": {
          "title": "Layer not georeferenced",
          "body": "The layer <span class='CDB-Text is-semibold'>%{name}</span> include non-georeferenced data."
        }
      },
      "elements": {
        "title-label": "Elements"
      },
      "widgets": {
        "title-label": "Widgets"
      }
    },
    "elements": {
      "message": "Unfortunately, map overlays are not available yet, but they will be very soon. Stay tuned!"
    },
    "layers": {
      "options": {
        "rename": "Rename",
        "delete": "Delete layer",
        "collapse": "Collapse",
        "expand": "Expand",
        "export": "Export data",
        "hide": "Hide layer",
        "show": "Show layer",
        "edit": "Edit layer",
        "center-map": "Center map on layer"
      },
      "drag-n-drop-analysis": {
        "upgrade-max-layers-err": "%{a_start}Upgrade your account%{a_end} to add more than %{userMaxLayers} layers to your maps."
      },
      "rename": {
        "loading": "Renaming layer",
        "success": "Layer renamed to %{name}",
        "error": "<span class='u-errorTextColor'>Error renaming layer</span> %{name}: %{error}"
      },
      "moveTorqueLayer": {
        "loading": "Moving torque layer to first position...",
        "success": "Layer moved",
        "error": "Error moving the layer..."
      },
      "delete": {
        "confirm": "Ok, delete it",
        "cancel": "Cancel",
        "desc": "<span class='CDB-Text u-mainTextColor is-semibold'>%{layerVisName}</span> will be affected, are you sure you want to delete it?",
        "title": "You are about to delete the layer %{layerName}",
        "error": "<span class='u-errorTextColor'>Error deleting layer</span>: %{error}",
        "loading": "Removing layer",
        "success": "Layer deleted correctly.",
        "widgets": "one widget |||| %{smart_count} widgets",
        "analyses": "one analysis |||| %{smart_count} analyses",
        "layers": "one layer |||| %{smart_count} layers",
        "affected-items": "Deleting this layer affects",
        "and": "and",
        "link-to-export": "Before deleting the layer, you can <a href='#' data-event='exportMapAction'>export as .CARTO file</a>"
      },
      "layer": {
        "animated": "Animated",
        "heatmap": "Pixel",
        "analysis": "Analysis",
        "add-analysis": "Add analysis",
        "analyses-count": "%{smart_count} Analysis |||| %{smart_count} Analyses",
        "widgets-count": "%{smart_count} Widget |||| %{smart_count} Widgets",
        "add-layer": "Add layer",
        "delete": "Delete",
        "cancel-delete-analysis": "Cancel"
      },
      "basemap": {
        "remove-baselayer": "Remove baselayer",
        "custom-basemap": "Custom basemap",
        "title-label": "Basemap",
        "by": "by",
        "category": {
          "title-label": "Source",
          "select-category": "Select source"
        },
        "style": {
          "title-label": "Style",
          "select-style": "Select style",
          "color": "Color"
        },
        "saving": {
          "loading": "Saving new basemap...",
          "error": "Error saving new basemap.",
          "success": "Basemap saved successfully."
        }
      },
      "labels": {
        "title-label": "Labels"
      },
      "color": {
        "title-label": "Color"
      },
      "image": {
        "title-label": "Image"
      },
      "gmaps": {
        "title-label": "Google Maps"
      },
      "menu-tab-pane-labels": {
        "data": "Data",
        "analyses": "Analysis",
        "style": "Style",
        "infowindow": "Pop-up",
        "legends": "Legend"
      },
      "infowindow-menu-tab-pane-labels": {
        "click": "Click",
        "hover": "Hover"
      },
      "analysis-form": {
        "merge-type": {
          "left": "Returns all rows from #1, with the matching rows in #2 or NULL when there is no match.",
          "inner": "Returns the result of #1 intersecting #2 (i.e. the inner part of a Venn diagram intersection)"
        },
        "admin-region": "Admin. Region",
        "aggregate": "Aggregate",
        "aggregate-by": "Aggregate by",
        "aggregate-by-help": "Will calculate aggregate values for each centroid",
        "aggregate-column": "Aggregate column",
        "all-to-all": "All to all",
        "allow-holes": "Allow holes",
        "apply-btn": "Apply",
        "asc": "ASC",
        "bicycle": "Bicycle",
        "boundaries": "Boundaries",
        "bounding-box": "Bounding Box",
        "bounding-circle": "Bounding Circle",
        "by": "By",
        "by-bike": "bike",
        "by-car": "car",
        "by-walk": "walk",
        "car": "Car",
        "categorize-by": "Categorize by",
        "categorize-by-help": "If selected a centroid will be found for each category",
        "category-column": "Category column",
        "city": "City",
        "clusters-num": "# of clusters",
        "column": "Column",
        "columns": "Columns",
        "concave-hull": "Concave Hull",
        "confirm-analysis": "Confirm",
        "convex-hull": "Convex Hull",
        "country": "Country",
        "create-btn": "Apply",
        "data-observatory-measurement-area": "Country",
        "data-observatory-measurement-column": "New col. name",
        "data-observatory-measurement-column-help": "Adds a new column to your layer to store result",
        "data-observatory-measurement-desc": "enrich your data",
        "data-observatory-measurement-measurement": "Measurement",
        "data-observatory-measurement-refine": "Choose a measure",
        "data-observatory-measurement-segments": "Segments",
        "define-columns": "Define column to find similarities with",
        "define-reference-and-target": "Define reference and target layers",
        "define-two-layers": "Define two layers",
        "denominator": "Denominator",
        "denominator-help": "A column to normalize the target column",
        "deprecated-sql-function": {
          "choose-function": "Choose the function to run on this node",
          "choose-function-small": "Choose function",
          "define-params": "define your parameters below",
          "function": "function",
          "input": "input",
          "params": "Your Function's Parameters",
          "target": "target node",
          "title": "SQL Function"
        },
        "desc": "DESC",
        "direction": "Direction",
        "disabled-by-config": "This analysis type is disabled",
        "dissolved": "Dissolved",
        "dissolved-help": "Combine polygons tracts which have equal ranges",
        "distance": "Distance",
        "enter-latitude": "Enter latitude",
        "enter-longitude": "Enter longitude",
        "filter": "Filter",
        "filter-aggregate": "Aggregate your results",
        "filter-column": "Filter column",
        "foreign-keys": "Foreign Keys",
        "geometry-from": "Geometry from",
        "georeference": {
          "postal-code-help": "Select a column with postal codes",
          "admin-region-help": "Select a column with region names",
          "admin-region-extended-help": "Specify an admin. region or select a column with region names",
          "admin-region": "Admin. Regions",
          "city-help": "Select a column with city names",
          "city-extended-help": "Specify a city or select a column with city names",
          "city": "Cities",
          "country-help": "Select a column with country names",
          "country-extended-help": "Specify a country or select a column with country names",
          "country": "Countries",
          "enter-city-name": "Or enter city name",
          "enter-country-name": "Or enter country name",
          "enter-region-name": "Or enter region name",
          "enter-state-name": "Or enter state name",
          "ip-address-column": "IP Address",
          "ip-address-help": "Select a column with IP addresses",
          "ip-address": "IP Addresses",
          "long-lat": "Longitude and Latitude",
          "postal-code": "Postal Codes",
          "select-a-country": "Select a country column",
          "select-admin": "Select a region column",
          "select-city": "Select a city column",
          "select-country": "Select country column",
          "select-ip": "Select an IP column",
          "select-latitude": "Select a latitude column",
          "select-longitude": "Select a longitude column",
          "select-postal-code": "Select a postal code column",
          "select-state": "Select state column",
          "select-street-address": "Select an address column",
          "state-help": "Specify a state or select a column with state names",
          "street-address-column": "Street Address",
          "street-address-column-help": "Select a column with street addresses",
          "street-address-help": "Use columns or free text to compose your address schema. <a href='https://carto.com/learn/guides/analysis/geocode-street-addresses-into-point-geometries' target='_blank'>More info.</a>",
          "street-address": "Street Addresses",
          "advance": "Advanced mode",
          "normal": "Normal mode"
        },
        "group-by": "Group by",
        "hide": "Hide",
        "inner": "Inner",
        "input": "Input",
        "input-layer": "Define your input layer",
        "input-num": "Input #%{num}",
        "intact": "Intact",
        "intact-help": "Keep all polygon tracts as individual polygons",
        "join-type": "Join Type",
        "keep-columns": "Select the columns you want to keep",
        "key-columns": "Key columns",
        "key-columns-desc": "Choose similar columns to relate them",
        "kilometers": "km",
        "latitude": "Latitude",
        "left": "Left",
        "line-sequential": "Sequential",
        "line-source-to-target": "To Source",
        "line-to-column": "To Column",
        "line-to-single-point": "To Single Point",
        "link-layer": "Link to col.",
        "link-layer-desc": "Specify a second layer to filter by",
        "linked-layer": "Filter by layer",
        "loading": "loading",
        "longitude": "Longitude",
        "max": "Max",
        "measure-by": "Measure by",
        "meters": "m",
        "method": "Method",
        "miles": "mi",
        "min": "Min",
        "mode": "Mode",
        "find-nearest": {
          "categorized": "Per group",
          "categorized-help": "Calculate results per each category of the chosen column",
          "criteria": "Select the target point layer",
          "define-params": "Define your parameters",
          "define-params-desc": "Define and categorize the number of results",
          "input": "input",
          "max-results": "max results",
          "modal-desc": "Find nearest analysis locates the closest points between two tables.",
          "modal-title": "Find nearest",
          "target": "target",
          "title": "Find nearest"
        },
        "neighbors": "Neighbors",
        "neighbors-help": "Define the local neighborhood as this many nearest-neighbors",
        "no": "No",
        "no-coincidence": "When no coincidence no row will be added",
        "should-match": "Column types should match",
        "numerator": "Target column",
        "numerator-help": "Measure spatial autocorrelation of this column",
        "operation": "Operation",
        "order": "Order",
        "order-by": "Order by",
        "order-results": "Order your results",
        "parameters": "Parameters",
        "parameters-description": "Tune your analysis",
        "permutations": "Permutations",
        "placeholder-text": "You have not added any analysis yet. Add an analysis to discover new things.",
        "points_source": "Point source",
        "polygons_source": "Polygon source",
        "postal-code": "Postal Code",
        "quota": {
          "title": "confirm your analysis",
          "loading": "Obtaining your quotas...",
          "credits-left-body": "This might incur into an extra cost. Extra credits will be charged at $%{blockPrice}/%{blockSize}.",
          "credits-left-message": "%{smart_count} credit left |||| %{smart_count} credits left",
          "enough-quota": "You need to use approximately %{credits} of your credits.",
          "hard-limit-not-enough-quota": "We're sorry the current quota is insufficient to enrich your data. Rows will be set to null and analysis may not complete. Please %{contact} us to extend your quota for this function.",
          "soft-limit-enough-quota": "We're sorry the current quota is insufficient to enrich your data. This might need about %{credits} extra credits. Extra credits will be charged at $%{blockPrice}/%{blockSize}.",
          "no-quota-assigned-body": "To get access to the %{analysis} function, %{contact}.",
          "no-credits-body": "You have consumed all your credits during this billing cycle. %{contact} to get some more.",
          "no-credits-message": "No credits available",
          "contact-message": {
            "no-credits": {
              "regular": "Contact us",
              "organization": "Contact your organization admin"
            },
            "no-quota-assigned": {
              "regular": "contact our team",
              "organization": "contact your organization admin"
            }
          },
          "emails": {
            "support": "support@carto.com",
            "saas": "sales@carto.com"
          },
          "quota-error-title": "Error",
          "quota-fetch-error": "There was an error obtaining your quota: %{error}.",
          "quota-dataservice-down": "Dataservices API unreacheable.",
          "cancel": "Cancel",
          "confirm": "confirm",
          "analysis-type": {
            "routing": "Routing",
            "trade-area": "Trade area",
            "georeference-street-address": "Georeference street address",
            "data-observatory-measure": "Data Observatory"
          }
        },
        "public_transport": "Public transport",
        "radius": "Distance",
        "reference-layer-pluralize": "Define your reference layer |||| Define your reference layers",
        "result": "Result",
        "right": "Right",
        "sampling": "Sampling",
        "sampling-desc": "Select a sample of the data",
        "sampling-rate": "% of data ",
        "search-by-column-name": "Search by column name",
        "second-geom-required": "This analysis requires a second geometry column",
        "select-column": "Select a column",
        "select-type": "Select data type",
        "setup-analysis": "Setup analysis",
        "show": "Show",
        "significance": "Significance",
        "significance-help": "Filter outliers and clusters to this significance. Smaller numbers are more significant.",
        "source": "Source",
        "source-col": "Source col.",
        "source-column": "Source column",
        "spatial-markov-trend-desc": "select a column for each time period",
        "spatial-markov-trend-time-columns": "Input columns",
        "spatial-markov-trend-time-columns-help": "Each column should contain values for a time period",
        "state": "State",
        "target": "Target",
        "target-layer": "Target layer",
        "intersection-layer": "Intersect layer",
        "filtering-layer": "Filtering layer",
        "base-layer": "Base layer",
        "target-col": "Target col.",
        "target-column": "Target column",
        "target-percent": "Target percent",
        "target-percent-help": "Convex hull lookalike",
        "time": "Time",
        "time-seconds": "Time (Seconds)",
        "to-closest": "To closest",
        "top-range": "Top range",
        "tracts": "Tracts",
        "tracts-help": "Number of AOIs evenly spaced between 0 and RADIUS",
        "tune-analysis": "Tune your analysis",
        "tune-centroid": "Tune your centroid",
        "tune-clusters": "Tune your clusters",
        "units": "Units",
        "type": "Type",
        "value": "Value",
        "value-aggregation": "Value aggregation",
        "value-aggregation-desc": "Aggregate the desired value in your polygon(s)",
        "value-aggregation-centroids": "Aggregate the desired value in your centroid(s)",
        "valid-type": "This kind of data is not valid for this type",
        "walk": "Walk",
        "weight": "Weight",
        "weight-column": "Weight column",
        "weight-type": "Weight type",
        "weighted-by": "Weighted by",
        "weighted-by-help": "Weights contribution by a value for each point",
        "workflow": "Your workflow",
        "write-max-value": "Write max value",
        "write-min-value": "Write min value",
        "yes": "Yes"
      },
      "infowindow": {
        "select-fields": "Select fields",
        "no-fields": "You havent selected any fields to be shown in the popup.",
        "placeholder-interactivity-text": "Popups are disabled because interactivity is not available for this layer.",
        "placeholder-columns-text": "Popups are disabled because there are no columns available for this layer.",
        "placeholder-geometry": "There's no geometry in your data to add a popup.",
        "style": {
          "title-label": "Style",
          "select-style": "Select style",
          "window-size": "Window size",
          "header-color": "Header color",
          "none": "None",
          "custom": "Custom",
          "infowindow_light": "Light",
          "infowindow_dark": "Dark",
          "infowindow_color": "Color",
          "infowindow_header_with_image": "Image"
        },
        "items": {
          "title-label": "Show items",
          "description": "Add items"
        }
      },
      "tooltip": {
        "style": {
          "none": "None",
          "custom": "Custom",
          "tooltip_light": "Light",
          "tooltip_dark": "Dark"
        },
        "items": {
          "title-label": "Show items",
          "description": "Add items"
        }
      },
      "filter-options": {
        "top": "Top",
        "bottom": "Bottom",
        "between": "Between",
        "is-equal-to": "Is equal to",
        "is-greater-than": "Is greater than",
        "is-less-than": "Is less than"
      },
      "notifier": {
        "center-map": {
          "loading": "Calculating coordinates...",
          "success": "Map centered",
          "error": "Error centering map"
        }
      },
      "georeference": {
        "manually-add": "Please georeference or manually add data to visualize.",
        "georeference-button": "Georeference",
        "visualize": "Layer doesn't have geometry"
      }
    },
    "data": {
      "no-geometry-data": "Your dataset doesn't contain any geometry data.",
      "stats": {
        "add-widget": "Add as a widget",
        "edit": "EDIT",
        "top-cat": "% in top 10 cat.",
        "trues": "% true",
        "null": "% null",
        "number-of": "%{geometry} count",
        "geometry-fallback": "features"
      },
      "data-toggle": {
        "values": "VALUES",
        "cartocss": "SQL"
      },
      "code-mirror": {
        "tip": "CMD + S to apply your query. CTRL + Space to autocomplete."
      },
      "notifier": {
        "sql-alter-loading": "Modifying table",
        "sql-alter-error": "Error in SQL query.",
        "sql-alter-success": "Modification applied.",
        "sql-applying": "Applying query",
        "sql-error": "Error in SQL query.",
        "sql-success": "SQL query applied."
      },
      "messages": {
        "sql-readonly": {
          "title": "SQL READ-ONLY",
          "body": "You just applied an analysis to this layer. The SQL is now read- only.",
          "accept": "CLOSE"
        },
        "empty-data": {
          "title": "NO DATA AVAILABLE",
          "body": "There is no data available to be displayed."
        }
      }
    },
    "infowindow": {
      "apply": "APPLY",
      "html-toggle": {
        "values": "VALUES",
        "html": "HTML"
      },
      "code-mirror": {
        "save": "CMD + S to apply your html.",
        "errors": {
          "empty": "Template can't be empty."
        }
      },
      "messages": {
        "custom-html-applied": {
          "title": "CUSTOM HTML APPLIED",
          "body": "You just applied custom html with HTML editor. You can continue and clean all html.",
          "accept": "CONTINUE"
        },
        "layer-hidden": {
          "title": "LAYER HIDDEN",
          "body": "This layer is hidden, changes will not be shown until you make it visible.",
          "show": "SHOW"
        }
      }
    },
    "export-image": {
      "invalid-dimension": "Invalid dimension (%{limit}x%{limit}px)",
      "properties": {
        "width": "width",
        "height": "height",
        "size": "Size",
        "size-subtitle": "Manually enter the image size",
        "format": "Format",
        "format-subtitle": "Choose a lossless (PNG) or lossy (JPG) format",
        "options": "Options",
        "options-subtitle": "Configure display options"
      }
    },
    "legend": {
      "no-geometry-data": "There's no geometry in your data to add a legend.",
      "data-toggle": {
        "values": "VALUES",
        "html": "HTML"
      },
      "code-mirror": {
        "save": "CMD + S to apply your html.",
        "errors": {
          "empty": "Template can't be empty."
        },
        "pre-html": "<!-- insert your custom html code above this line -->",
        "post-html": "<!-- insert your custom html code below this line -->"
      },
      "menu-tab-pane-labels": {
        "color": "color",
        "size": "size"
      },
      "messages": {
        "custom-legend": {
          "title": "CUSTOM LEGEND APPLIED",
          "body": "You just applied custom html with HTML editor. You can continue and clean all html.",
          "accept": "Delete custom html"
        },
        "layer-hidden": {
          "title": "LAYER HIDDEN",
          "body": "This layer is hidden. Changes won't be shown until you make it visible.",
          "show": "SHOW"
        },
        "legends-disabled": {
          "title": "LEGENDS DISABLED",
          "body": "The legends setting is disabled. Changes made will not be shown until you enable legends.",
          "show": "ENABLE"
        }
      },
      "types": {
        "none": "none",
        "category": "category",
        "gradient": "gradient",
        "bubble": "bubble",
        "custom": "custom"
      },
      "legend-form": {
        "type": {
          "title": "Select Style"
        },
        "properties": {
          "title": "Creating your legend",
          "subtitle": "Add items"
        },
        "add": "Add item",
        "title": "Title",
        "fill": "Fill",
        "by-size": "By Size",
        "by-color": "By Color",
        "untitled": "Untitled",
        "prefix": "Prefix",
        "suffix": "Suffix",
        "left-label": "Left Label",
        "right-label": "Right Label",
        "top-label": "Top Label",
        "bottom-label": "Bottom Label",
        "custom-label-placeholder": "Override dynamic value"
      },
      "pixel-title": "Amount"
    },
    "style": {
      "types": {
        "none": "-",
        "simple": "none",
        "hexabins": "hexbins",
        "squares": "squares",
        "regions": "Adm. Regions",
        "heatmap": "pixel",
        "animation": "animated"
      },
      "style-form": {
        "type": {
          "title-label": "Aggregation"
        },
        "aggregation": {
          "title-label": "Aggregation Options",
          "desc": "Configure how the aggregation works"
        },
        "properties": {
          "title-label-point": "Style",
          "title-label-line": "Lines style",
          "title-label-polygon": "Polygons style",
          "placeholder-text": "There's no geometry in your data that could be styled.",
          "georeference": "Georeference",
          "desc": "Change the visualization"
        },
        "unanimatable": {
          "desc": "Not any numeric or date column found in your data.",
          "body": "You can change your column's type in the %{link}.",
          "label": "table view"
        }
      },
      "code-mirror": {
        "save": "CMD + S to apply your styles."
      },
      "style-toggle": {
        "values": "VALUES",
        "cartocss": "CARTOCSS"
      },
      "messages": {
        "fetched": "Schema fetched, select a style",
        "fetching": "Schema is being fetched, when it is done, different styles will be avaiable",
        "unavailable": "There was a problem getting schema, try to reload",
        "none": "Your styles were reset, choose new styles for your layer, or go back to your previous style.",
        "cartocss-applied": {
          "title": "CARTOCSS APPLIED",
          "body": "You just applied styles with CartoCSS. You can continue or clear all styles.",
          "continue": "CONTINUE",
          "clear": "CLEAR"
        },
        "layer-hidden": {
          "title": "LAYER HIDDEN",
          "body": "This layer is hidden, changes won't be shown until you make it visible.",
          "show": "SHOW"
        },
        "torque-exists": {
          "title": "TORQUE LAYER",
          "body": "There is already a torque layer in the layers collection. If you continue, this layer will use the default style.",
          "continue": "CONTINUE",
          "cancel": "CANCEL"
        }
      },
      "components": {
        "fill": "Fill",
        "stroke": {
          "label": "Stroke",
          "fetching": "Loading node schema...",
          "unavailable": "Error getting node schema",
          "error": "There was an error fetching node schema..."
        },
        "blending": {
          "label": "Blending",
          "options": {
            "none": "none",
            "darken": "darken",
            "lighten": "lighten",
            "lighter": "lighter",
            "color-dodge": "color-dodge",
            "color-burn": "color-burn",
            "multiply": "multiply",
            "screen": "screen",
            "overlay": "overlay",
            "src-over": "src-over",
            "source-over": "source-over",
            "xor": "xor"
          }
        },
        "type": {
          "label": "Type",
          "options": {
            "heatmap": "Heatmap",
            "points": "Points"
          }
        },
        "aggregation-value": "Operation",
        "aggregation-size": {
          "label": "Size",
          "help": "In pixels"
        },
        "aggregation-dataset": "Admin. level",
        "labels-enabled": {
          "label": "labels",
          "not-with-animated": "It won't be available with animations"
        },
        "labels-attribute": {
          "label": "column",
          "fetching": "Loading node schema...",
          "unavailable": "Error getting node schema",
          "error": "There was an error fetching node schema..."
        },
        "labels-font": "font",
        "labels-offset": "offset",
        "labels-fill": "size/color",
        "labels-overlap": {
          "label": "overlap",
          "options": {
            "true": "True",
            "false": "False"
          }
        },
        "labels-halo": "halo",
        "labels-placement": {
          "label": "placement",
          "options": {
            "point": "point",
            "line": "line",
            "vertex": "vertex",
            "interior": "interior"
          }
        },
        "animated-enabled": {
          "label": "animated",
          "already-one-torque": "There is already a torque layer in your map",
          "not-with-labels": "It won't be available with labels"
        },
        "animated-attribute": {
          "label": "column",
          "fetching": "Loading node schema...",
          "unavailable": "Error getting node schema",
          "error": "There was an error fetching node schema..."
        },
        "animated-overlap": {
          "label": "overlap",
          "options": {
            "true": "Accum.",
            "false": "None"
          }
        },
        "animated-trails": "trails",
        "animated-resolution": "resolution",
        "animated-steps": "steps",
        "animated-duration": "duration"
      }
    },
    "widgets": {
      "no-geometry-data": "Your dataset lacks geometry data, it is not possible to add a widget.",
      "options": {
        "remove": "Delete...",
        "rename": "Rename",
        "edit": "Edit"
      },
      "delete": {
        "confirm": "Ok, delete it",
        "cancel": "Cancel",
        "desc": "The widget cannot be recovered, be sure before proceeding.",
        "title": "You are about to delete the widget %{name}",
        "error": "Error deleting widget %{name}: %{error}",
        "loading": "Removing the widget %{name}...",
        "success": "Widget %{name} deleted"
      },
      "widgets-view": {
        "add_widget": "Add widget"
      },
      "widgets-types": {
        "histogram": "Histogram",
        "category": "Category",
        "formula": "Formula",
        "time-series": "Time series"
      },
      "widgets-form": {
        "placeholder-text": "You have not added any widgets yet. Add widgets to discover new things.",
        "type": {
          "title-label": "Type",
          "description": "Choose the widget type",
          "category": "Category",
          "formula": "Formula",
          "histogram": "Histogram",
          "time_series": "Time Series"
        },
        "data": {
          "columns-unavailable": "No columns available",
          "aggregation": "Aggregation",
          "aggregation_column": "Aggregation Column",
          "bins": "Buckets",
          "column": "Column",
          "description": "Configure your values",
          "end": "End",
          "loading": "loading",
          "operation": "Operation",
          "prefix": "Prefix",
          "start": "Start",
          "suffix": "Suffix",
          "title": "Title",
          "title-label": "Data",
          "value": "Value",
          "aggregate-by": "aggregate by",
          "operation-column": "operation column"
        },
        "style": {
          "custom-categories": "Custom categ.",
          "custom-disabled": "If an aggregated style is applied, auto style is disabled",
          "custom-help": "Represent the widget's values with custom colors in the map",
          "custom-ramp": "Custom ramp",
          "define": "Define how your widget interacts with the data",
          "description": "Description",
          "fill": "Fill",
          "no": "No",
          "sync_on_bbox_change": "Dynamic",
          "sync_on_data_change": "Unfiltered",
          "title-label": "Behavior",
          "yes": "Yes"
        }
      }
    },
    "edit-feature": {
      "features": {
        "point": "point",
        "line": "line",
        "polygon": "polygon"
      },
      "loading-state": "Requesting feature data...",
      "error-state": "There was an error requesting feature data",
      "overlay-text": "Start clicking on the map to draw your %{featureType}",
      "add": "Add",
      "save": "Save",
      "attributes": "Attributes",
      "attributes-columns": "Change column names and type in table mode",
      "cancel": "Cancel",
      "geometry": "Geometry",
      "geometry-edit": "You can also edit it on the map",
      "geometry-disabled": "Not available for hidden or read only layers",
      "out-of-bounds-lng": "Longitude is out of bounds [-180, 180]",
      "out-of-bounds-lat": "Latitude is out of bounds [-90, 90]",
      "valid-lng": "Must be a valid longitude",
      "valid-lat": "Must be a valid latitude",
      "valid": "Only numbers allowed",
      "delete": "Delete %{featureType}",
      "edit": "Edit %{featureType}",
      "analysis": "layers with analysis nodes",
      "custom-sql": "layers with custom SQL applied",
      "sync": "read only layers",
      "disabled": "Feature editing is disabled in %{disabledLayerType}. To edit the data, export this layer and import it as a new layer."
    }
  },
  "notifications": {
    "vis": {
      "failed": {
        "title": "This map couldn't be rendered",
        "body": "Please refresh the page and contact us if the error persists"
      }
    },
    "analysis": {
      "waiting": "Analysis %{nodeId} enqueued...",
      "running": "Analysis %{nodeId} running...",
      "completed": "Analysis %{nodeId} completed",
      "failed": "Analysis %{nodeId} failed",
      "removed": "Analysis %{nodeId} deleted",
      "contact": {
        "label": "contact us",
        "mail": "support@carto.com"
      },
      "sample": "sample",
      "errors": {
        "timeout": "Your analysis has taken too long. Try to %{sample} your data or %{contact} for further assistance",
        "without-geom-webmercator": "The column \"the_geom_webmercator\" does not exist"
      }
    },
    "widgets": {
      "delete": "Widget deleted correctly.",
      "success": "Widget successfully added",
      "error": {
        "title": "Error adding widget:",
        "body": "%{body} %{error}"
      },
      "loading": "Adding widget",
      "updating": "Updating widget",
      "restoring": "Restoring widgets",
      "restored": "Widgets restored"
    },
    "layer": {
      "error": "Layer error: %{error}",
      "added": "Layer added successfully"
    },
    "cartocss": {
      "error": {
        "body": "%{body} %{error}",
        "title": "Error in CartoCSS styles:"
      },
      "success": "CartoCSS applied"
    },
    "sql": {
      "alter-loading": "Modifying table",
      "alter-success": "Modification applied",
      "applying": "Applying query",
      "error": {
        "body": "%{body} %{error}",
        "title": "Error in SQL query:"
      },
      "success": "SQL query applied"
    },
    "edit-feature": {
      "edit": {
        "loading": "Requesting geometry data...",
        "error": "There was an error requesting geometry data"
      },
      "error": {
        "body": "%{body} %{error}"
      },
      "destroy": {
        "loading": "Deleting geometry",
        "error": "Error deleting geometry",
        "success": "Geometry deleted correctly"
      },
      "save": {
        "loading": "Saving geometry",
        "error": "Error saving geometry",
        "success": "Geometry successfully saved"
      },
      "adding": "Adding geometry"
    }
  }
}

},{}],451:[function(require,module,exports){
module.exports={
  "editor": {
    "map": "mapa",
    "map_name": "%{name} mapa",
    "map_pluralize": "%{smart_count} mapa |||| %{smart_count} mapas"
  }
}

},{}],452:[function(require,module,exports){
module.exports = {
  en: require('./en.json'),
  sw: require('./sw.json'),
  es: require('./es.json')
};

},{"./en.json":450,"./es.json":451,"./sw.json":453}],453:[function(require,module,exports){
module.exports={
  "editor": {
    "map": "karta",
    "map_name": "%{name} karta",
    "map_pluralize": "%{smart_count} karta |||| %{smart_count} kartor"
  }
}

},{}],454:[function(require,module,exports){
var _ = require('underscore');
var Backbone = require('backbone');

/**
 * NOTE! Migrated as-is from https://github.com/CartoDB/cartodb.js/blob/470399abb12b40d5476ab6bbfd792d95aa819f50/src/core/view.js 2016-06-03
 * Base View for all CartoDB views.
 * DO NOT USE Backbone.View directly
 */
var View = Backbone.View.extend({
  classLabel: 'cdb.core.View',

  constructor: function (options) {
    this.options = _.defaults(options, this.options);
    this._models = [];
    this._subviews = {};
    Backbone.View.call(this, options);
    View.viewCount++;
    View.views[this.cid] = this;
    this._created_at = new Date();
  },

  add_related_model: function (m) {
    if (!m) throw new Error('added non valid model');
    this._models.push(m);
  },

  addView: function (v) {
    this._subviews[v.cid] = v;
    v._parent = this;
  },

  removeView: function (v) {
    delete this._subviews[v.cid];
  },

  clearSubViews: function () {
    _(this._subviews).each(function (v) {
      v.clean();
    });
    this._subviews = {};
  },

  /**
   * this methid clean removes the view
   * and clean and events associated. call it when
   * the view is not going to be used anymore
   */
  clean: function () {
    this.trigger('clean');
    this.clearSubViews();
    // remove from parent
    if (this._parent) {
      this._parent.removeView(this);
      this._parent = null;
    }
    this.remove();
    this.allOff();
    View.viewCount--;
    delete View.views[this.cid];
    return this;
  },

  /**
   * Remove all event listeners on related models
   */
  allOff: function () {
    this.off();

    if (this.model && this.model.off) this.model.off(null, null, this);

    var self = this;
    _(this._models).each(function (m) {
      m.off(null, null, self);
    });
    this._models = [];
  },

  show: function () {
    this.$el.show();
  },

  hide: function () {
    this.$el.hide();
  },

  /**
  * Listen for an event on another object and triggers on itself, with the same name or a new one
  * @method retrigger
  * @param ev {String} event who triggers the action
  * @param obj {Object} object where the event happens
  * @param obj {Object} [optional] name of the retriggered event
  */
  retrigger: function (ev, obj, retrigEvent) {
    if (!retrigEvent) {
      retrigEvent = ev;
    }
    var self = this;
    obj.bind && obj.bind(ev, function () {
      self.trigger(retrigEvent);
    }, self);
    // add it as related model//object
    this.add_related_model(obj);
  },
  /**
  * Captures an event and prevents the default behaviour and stops it from bubbling
  * @method killEvent
  * @param event {Event}
  */
  killEvent: function (ev) {
    if (ev && ev.preventDefault) {
      ev.preventDefault();
    }
    if (ev && ev.stopPropagation) {
      ev.stopPropagation();
    }
  },

  /**
  * Remove all the tipsy tooltips from the document
  * @method cleanTooltips
  */
  cleanTooltips: function () {
    this.$('.tipsy').remove();
  }

}, {
  viewCount: 0,
  views: {},

  /**
   * when a view with events is inherit and you want to add more events
   * this helper can be used:
   * var MyView = new core.View({
   *  events: View.extendEvents({
   *      'click': 'fn'
   *  })
   * })
   */
  extendEvents: function (newEvents) {
    return function () {
      return _.extend(newEvents, this.constructor.__super__.events);
    };
  },

  /**
   * search for views in a view and check if they are added as subviews
   */
  runChecker: function () {
    _.each(View.views, function (view) {
      _.each(view, function (prop, k) {
        if (k !== '_parent' &&
          view.hasOwnProperty(k) &&
          prop instanceof View &&
          view._subviews[prop.cid] === undefined) {
          console.log('=========');
          console.log('untracked view: ');
          console.log(prop.el);
          console.log('parent');
          console.log(view.el);
          console.log(' ');
        }
      });
    });
  }
});

module.exports = View;

},{"backbone":"backbone","underscore":"underscore"}],455:[function(require,module,exports){
/*! jQuery UI - v1.11.4 - 2015-03-11
* http://jqueryui.com
* Includes: core.js, widget.js, mouse.js, position.js, accordion.js, autocomplete.js, button.js, datepicker.js, dialog.js, draggable.js, droppable.js, effect.js, effect-blind.js, effect-bounce.js, effect-clip.js, effect-drop.js, effect-explode.js, effect-fade.js, effect-fold.js, effect-highlight.js, effect-puff.js, effect-pulsate.js, effect-scale.js, effect-shake.js, effect-size.js, effect-slide.js, effect-transfer.js, menu.js, progressbar.js, resizable.js, selectable.js, selectmenu.js, slider.js, sortable.js, spinner.js, tabs.js, tooltip.js
* Copyright 2015 jQuery Foundation and other contributors; Licensed MIT */

(function( factory ) {
	if ( typeof define === "function" && define.amd ) {

		// AMD. Register as an anonymous module.
		define([ "jquery" ], factory );
	} else {

		// Browser globals
		factory( jQuery );
	}
}(function( $ ) {
/*!
 * jQuery UI Core 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/category/ui-core/
 */


// $.ui might exist from components with no dependencies, e.g., $.ui.position
$.ui = $.ui || {};

$.extend( $.ui, {
	version: "1.11.4",

	keyCode: {
		BACKSPACE: 8,
		COMMA: 188,
		DELETE: 46,
		DOWN: 40,
		END: 35,
		ENTER: 13,
		ESCAPE: 27,
		HOME: 36,
		LEFT: 37,
		PAGE_DOWN: 34,
		PAGE_UP: 33,
		PERIOD: 190,
		RIGHT: 39,
		SPACE: 32,
		TAB: 9,
		UP: 38
	}
});

// plugins
$.fn.extend({
	scrollParent: function( includeHidden ) {
		var position = this.css( "position" ),
			excludeStaticParent = position === "absolute",
			overflowRegex = includeHidden ? /(auto|scroll|hidden)/ : /(auto|scroll)/,
			scrollParent = this.parents().filter( function() {
				var parent = $( this );
				if ( excludeStaticParent && parent.css( "position" ) === "static" ) {
					return false;
				}
				return overflowRegex.test( parent.css( "overflow" ) + parent.css( "overflow-y" ) + parent.css( "overflow-x" ) );
			}).eq( 0 );

		return position === "fixed" || !scrollParent.length ? $( this[ 0 ].ownerDocument || document ) : scrollParent;
	},

	uniqueId: (function() {
		var uuid = 0;

		return function() {
			return this.each(function() {
				if ( !this.id ) {
					this.id = "ui-id-" + ( ++uuid );
				}
			});
		};
	})(),

	removeUniqueId: function() {
		return this.each(function() {
			if ( /^ui-id-\d+$/.test( this.id ) ) {
				$( this ).removeAttr( "id" );
			}
		});
	}
});

// selectors
function focusable( element, isTabIndexNotNaN ) {
	var map, mapName, img,
		nodeName = element.nodeName.toLowerCase();
	if ( "area" === nodeName ) {
		map = element.parentNode;
		mapName = map.name;
		if ( !element.href || !mapName || map.nodeName.toLowerCase() !== "map" ) {
			return false;
		}
		img = $( "img[usemap='#" + mapName + "']" )[ 0 ];
		return !!img && visible( img );
	}
	return ( /^(input|select|textarea|button|object)$/.test( nodeName ) ?
		!element.disabled :
		"a" === nodeName ?
			element.href || isTabIndexNotNaN :
			isTabIndexNotNaN) &&
		// the element and all of its ancestors must be visible
		visible( element );
}

function visible( element ) {
	return $.expr.filters.visible( element ) &&
		!$( element ).parents().addBack().filter(function() {
			return $.css( this, "visibility" ) === "hidden";
		}).length;
}

$.extend( $.expr[ ":" ], {
	data: $.expr.createPseudo ?
		$.expr.createPseudo(function( dataName ) {
			return function( elem ) {
				return !!$.data( elem, dataName );
			};
		}) :
		// support: jQuery <1.8
		function( elem, i, match ) {
			return !!$.data( elem, match[ 3 ] );
		},

	focusable: function( element ) {
		return focusable( element, !isNaN( $.attr( element, "tabindex" ) ) );
	},

	tabbable: function( element ) {
		var tabIndex = $.attr( element, "tabindex" ),
			isTabIndexNaN = isNaN( tabIndex );
		return ( isTabIndexNaN || tabIndex >= 0 ) && focusable( element, !isTabIndexNaN );
	}
});

// support: jQuery <1.8
if ( !$( "<a>" ).outerWidth( 1 ).jquery ) {
	$.each( [ "Width", "Height" ], function( i, name ) {
		var side = name === "Width" ? [ "Left", "Right" ] : [ "Top", "Bottom" ],
			type = name.toLowerCase(),
			orig = {
				innerWidth: $.fn.innerWidth,
				innerHeight: $.fn.innerHeight,
				outerWidth: $.fn.outerWidth,
				outerHeight: $.fn.outerHeight
			};

		function reduce( elem, size, border, margin ) {
			$.each( side, function() {
				size -= parseFloat( $.css( elem, "padding" + this ) ) || 0;
				if ( border ) {
					size -= parseFloat( $.css( elem, "border" + this + "Width" ) ) || 0;
				}
				if ( margin ) {
					size -= parseFloat( $.css( elem, "margin" + this ) ) || 0;
				}
			});
			return size;
		}

		$.fn[ "inner" + name ] = function( size ) {
			if ( size === undefined ) {
				return orig[ "inner" + name ].call( this );
			}

			return this.each(function() {
				$( this ).css( type, reduce( this, size ) + "px" );
			});
		};

		$.fn[ "outer" + name] = function( size, margin ) {
			if ( typeof size !== "number" ) {
				return orig[ "outer" + name ].call( this, size );
			}

			return this.each(function() {
				$( this).css( type, reduce( this, size, true, margin ) + "px" );
			});
		};
	});
}

// support: jQuery <1.8
if ( !$.fn.addBack ) {
	$.fn.addBack = function( selector ) {
		return this.add( selector == null ?
			this.prevObject : this.prevObject.filter( selector )
		);
	};
}

// support: jQuery 1.6.1, 1.6.2 (http://bugs.jquery.com/ticket/9413)
if ( $( "<a>" ).data( "a-b", "a" ).removeData( "a-b" ).data( "a-b" ) ) {
	$.fn.removeData = (function( removeData ) {
		return function( key ) {
			if ( arguments.length ) {
				return removeData.call( this, $.camelCase( key ) );
			} else {
				return removeData.call( this );
			}
		};
	})( $.fn.removeData );
}

// deprecated
$.ui.ie = !!/msie [\w.]+/.exec( navigator.userAgent.toLowerCase() );

$.fn.extend({
	focus: (function( orig ) {
		return function( delay, fn ) {
			return typeof delay === "number" ?
				this.each(function() {
					var elem = this;
					setTimeout(function() {
						$( elem ).focus();
						if ( fn ) {
							fn.call( elem );
						}
					}, delay );
				}) :
				orig.apply( this, arguments );
		};
	})( $.fn.focus ),

	disableSelection: (function() {
		var eventType = "onselectstart" in document.createElement( "div" ) ?
			"selectstart" :
			"mousedown";

		return function() {
			return this.bind( eventType + ".ui-disableSelection", function( event ) {
				event.preventDefault();
			});
		};
	})(),

	enableSelection: function() {
		return this.unbind( ".ui-disableSelection" );
	},

	zIndex: function( zIndex ) {
		if ( zIndex !== undefined ) {
			return this.css( "zIndex", zIndex );
		}

		if ( this.length ) {
			var elem = $( this[ 0 ] ), position, value;
			while ( elem.length && elem[ 0 ] !== document ) {
				// Ignore z-index if position is set to a value where z-index is ignored by the browser
				// This makes behavior of this function consistent across browsers
				// WebKit always returns auto if the element is positioned
				position = elem.css( "position" );
				if ( position === "absolute" || position === "relative" || position === "fixed" ) {
					// IE returns 0 when zIndex is not specified
					// other browsers return a string
					// we ignore the case of nested elements with an explicit value of 0
					// <div style="z-index: -10;"><div style="z-index: 0;"></div></div>
					value = parseInt( elem.css( "zIndex" ), 10 );
					if ( !isNaN( value ) && value !== 0 ) {
						return value;
					}
				}
				elem = elem.parent();
			}
		}

		return 0;
	}
});

// $.ui.plugin is deprecated. Use $.widget() extensions instead.
$.ui.plugin = {
	add: function( module, option, set ) {
		var i,
			proto = $.ui[ module ].prototype;
		for ( i in set ) {
			proto.plugins[ i ] = proto.plugins[ i ] || [];
			proto.plugins[ i ].push( [ option, set[ i ] ] );
		}
	},
	call: function( instance, name, args, allowDisconnected ) {
		var i,
			set = instance.plugins[ name ];

		if ( !set ) {
			return;
		}

		if ( !allowDisconnected && ( !instance.element[ 0 ].parentNode || instance.element[ 0 ].parentNode.nodeType === 11 ) ) {
			return;
		}

		for ( i = 0; i < set.length; i++ ) {
			if ( instance.options[ set[ i ][ 0 ] ] ) {
				set[ i ][ 1 ].apply( instance.element, args );
			}
		}
	}
};


/*!
 * jQuery UI Widget 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/jQuery.widget/
 */


var widget_uuid = 0,
	widget_slice = Array.prototype.slice;

$.cleanData = (function( orig ) {
	return function( elems ) {
		var events, elem, i;
		for ( i = 0; (elem = elems[i]) != null; i++ ) {
			try {

				// Only trigger remove when necessary to save time
				events = $._data( elem, "events" );
				if ( events && events.remove ) {
					$( elem ).triggerHandler( "remove" );
				}

			// http://bugs.jquery.com/ticket/8235
			} catch ( e ) {}
		}
		orig( elems );
	};
})( $.cleanData );

$.widget = function( name, base, prototype ) {
	var fullName, existingConstructor, constructor, basePrototype,
		// proxiedPrototype allows the provided prototype to remain unmodified
		// so that it can be used as a mixin for multiple widgets (#8876)
		proxiedPrototype = {},
		namespace = name.split( "." )[ 0 ];

	name = name.split( "." )[ 1 ];
	fullName = namespace + "-" + name;

	if ( !prototype ) {
		prototype = base;
		base = $.Widget;
	}

	// create selector for plugin
	$.expr[ ":" ][ fullName.toLowerCase() ] = function( elem ) {
		return !!$.data( elem, fullName );
	};

	$[ namespace ] = $[ namespace ] || {};
	existingConstructor = $[ namespace ][ name ];
	constructor = $[ namespace ][ name ] = function( options, element ) {
		// allow instantiation without "new" keyword
		if ( !this._createWidget ) {
			return new constructor( options, element );
		}

		// allow instantiation without initializing for simple inheritance
		// must use "new" keyword (the code above always passes args)
		if ( arguments.length ) {
			this._createWidget( options, element );
		}
	};
	// extend with the existing constructor to carry over any static properties
	$.extend( constructor, existingConstructor, {
		version: prototype.version,
		// copy the object used to create the prototype in case we need to
		// redefine the widget later
		_proto: $.extend( {}, prototype ),
		// track widgets that inherit from this widget in case this widget is
		// redefined after a widget inherits from it
		_childConstructors: []
	});

	basePrototype = new base();
	// we need to make the options hash a property directly on the new instance
	// otherwise we'll modify the options hash on the prototype that we're
	// inheriting from
	basePrototype.options = $.widget.extend( {}, basePrototype.options );
	$.each( prototype, function( prop, value ) {
		if ( !$.isFunction( value ) ) {
			proxiedPrototype[ prop ] = value;
			return;
		}
		proxiedPrototype[ prop ] = (function() {
			var _super = function() {
					return base.prototype[ prop ].apply( this, arguments );
				},
				_superApply = function( args ) {
					return base.prototype[ prop ].apply( this, args );
				};
			return function() {
				var __super = this._super,
					__superApply = this._superApply,
					returnValue;

				this._super = _super;
				this._superApply = _superApply;

				returnValue = value.apply( this, arguments );

				this._super = __super;
				this._superApply = __superApply;

				return returnValue;
			};
		})();
	});
	constructor.prototype = $.widget.extend( basePrototype, {
		// TODO: remove support for widgetEventPrefix
		// always use the name + a colon as the prefix, e.g., draggable:start
		// don't prefix for widgets that aren't DOM-based
		widgetEventPrefix: existingConstructor ? (basePrototype.widgetEventPrefix || name) : name
	}, proxiedPrototype, {
		constructor: constructor,
		namespace: namespace,
		widgetName: name,
		widgetFullName: fullName
	});

	// If this widget is being redefined then we need to find all widgets that
	// are inheriting from it and redefine all of them so that they inherit from
	// the new version of this widget. We're essentially trying to replace one
	// level in the prototype chain.
	if ( existingConstructor ) {
		$.each( existingConstructor._childConstructors, function( i, child ) {
			var childPrototype = child.prototype;

			// redefine the child widget using the same prototype that was
			// originally used, but inherit from the new version of the base
			$.widget( childPrototype.namespace + "." + childPrototype.widgetName, constructor, child._proto );
		});
		// remove the list of existing child constructors from the old constructor
		// so the old child constructors can be garbage collected
		delete existingConstructor._childConstructors;
	} else {
		base._childConstructors.push( constructor );
	}

	$.widget.bridge( name, constructor );

	return constructor;
};

$.widget.extend = function( target ) {
	var input = widget_slice.call( arguments, 1 ),
		inputIndex = 0,
		inputLength = input.length,
		key,
		value;
	for ( ; inputIndex < inputLength; inputIndex++ ) {
		for ( key in input[ inputIndex ] ) {
			value = input[ inputIndex ][ key ];
			if ( input[ inputIndex ].hasOwnProperty( key ) && value !== undefined ) {
				// Clone objects
				if ( $.isPlainObject( value ) ) {
					target[ key ] = $.isPlainObject( target[ key ] ) ?
						$.widget.extend( {}, target[ key ], value ) :
						// Don't extend strings, arrays, etc. with objects
						$.widget.extend( {}, value );
				// Copy everything else by reference
				} else {
					target[ key ] = value;
				}
			}
		}
	}
	return target;
};

$.widget.bridge = function( name, object ) {
	var fullName = object.prototype.widgetFullName || name;
	$.fn[ name ] = function( options ) {
		var isMethodCall = typeof options === "string",
			args = widget_slice.call( arguments, 1 ),
			returnValue = this;

		if ( isMethodCall ) {
			this.each(function() {
				var methodValue,
					instance = $.data( this, fullName );
				if ( options === "instance" ) {
					returnValue = instance;
					return false;
				}
				if ( !instance ) {
					return $.error( "cannot call methods on " + name + " prior to initialization; " +
						"attempted to call method '" + options + "'" );
				}
				if ( !$.isFunction( instance[options] ) || options.charAt( 0 ) === "_" ) {
					return $.error( "no such method '" + options + "' for " + name + " widget instance" );
				}
				methodValue = instance[ options ].apply( instance, args );
				if ( methodValue !== instance && methodValue !== undefined ) {
					returnValue = methodValue && methodValue.jquery ?
						returnValue.pushStack( methodValue.get() ) :
						methodValue;
					return false;
				}
			});
		} else {

			// Allow multiple hashes to be passed on init
			if ( args.length ) {
				options = $.widget.extend.apply( null, [ options ].concat(args) );
			}

			this.each(function() {
				var instance = $.data( this, fullName );
				if ( instance ) {
					instance.option( options || {} );
					if ( instance._init ) {
						instance._init();
					}
				} else {
					$.data( this, fullName, new object( options, this ) );
				}
			});
		}

		return returnValue;
	};
};

$.Widget = function( /* options, element */ ) {};
$.Widget._childConstructors = [];

$.Widget.prototype = {
	widgetName: "widget",
	widgetEventPrefix: "",
	defaultElement: "<div>",
	options: {
		disabled: false,

		// callbacks
		create: null
	},
	_createWidget: function( options, element ) {
		element = $( element || this.defaultElement || this )[ 0 ];
		this.element = $( element );
		this.uuid = widget_uuid++;
		this.eventNamespace = "." + this.widgetName + this.uuid;

		this.bindings = $();
		this.hoverable = $();
		this.focusable = $();

		if ( element !== this ) {
			$.data( element, this.widgetFullName, this );
			this._on( true, this.element, {
				remove: function( event ) {
					if ( event.target === element ) {
						this.destroy();
					}
				}
			});
			this.document = $( element.style ?
				// element within the document
				element.ownerDocument :
				// element is window or document
				element.document || element );
			this.window = $( this.document[0].defaultView || this.document[0].parentWindow );
		}

		this.options = $.widget.extend( {},
			this.options,
			this._getCreateOptions(),
			options );

		this._create();
		this._trigger( "create", null, this._getCreateEventData() );
		this._init();
	},
	_getCreateOptions: $.noop,
	_getCreateEventData: $.noop,
	_create: $.noop,
	_init: $.noop,

	destroy: function() {
		this._destroy();
		// we can probably remove the unbind calls in 2.0
		// all event bindings should go through this._on()
		this.element
			.unbind( this.eventNamespace )
			.removeData( this.widgetFullName )
			// support: jquery <1.6.3
			// http://bugs.jquery.com/ticket/9413
			.removeData( $.camelCase( this.widgetFullName ) );
		this.widget()
			.unbind( this.eventNamespace )
			.removeAttr( "aria-disabled" )
			.removeClass(
				this.widgetFullName + "-disabled " +
				"ui-state-disabled" );

		// clean up events and states
		this.bindings.unbind( this.eventNamespace );
		this.hoverable.removeClass( "ui-state-hover" );
		this.focusable.removeClass( "ui-state-focus" );
	},
	_destroy: $.noop,

	widget: function() {
		return this.element;
	},

	option: function( key, value ) {
		var options = key,
			parts,
			curOption,
			i;

		if ( arguments.length === 0 ) {
			// don't return a reference to the internal hash
			return $.widget.extend( {}, this.options );
		}

		if ( typeof key === "string" ) {
			// handle nested keys, e.g., "foo.bar" => { foo: { bar: ___ } }
			options = {};
			parts = key.split( "." );
			key = parts.shift();
			if ( parts.length ) {
				curOption = options[ key ] = $.widget.extend( {}, this.options[ key ] );
				for ( i = 0; i < parts.length - 1; i++ ) {
					curOption[ parts[ i ] ] = curOption[ parts[ i ] ] || {};
					curOption = curOption[ parts[ i ] ];
				}
				key = parts.pop();
				if ( arguments.length === 1 ) {
					return curOption[ key ] === undefined ? null : curOption[ key ];
				}
				curOption[ key ] = value;
			} else {
				if ( arguments.length === 1 ) {
					return this.options[ key ] === undefined ? null : this.options[ key ];
				}
				options[ key ] = value;
			}
		}

		this._setOptions( options );

		return this;
	},
	_setOptions: function( options ) {
		var key;

		for ( key in options ) {
			this._setOption( key, options[ key ] );
		}

		return this;
	},
	_setOption: function( key, value ) {
		this.options[ key ] = value;

		if ( key === "disabled" ) {
			this.widget()
				.toggleClass( this.widgetFullName + "-disabled", !!value );

			// If the widget is becoming disabled, then nothing is interactive
			if ( value ) {
				this.hoverable.removeClass( "ui-state-hover" );
				this.focusable.removeClass( "ui-state-focus" );
			}
		}

		return this;
	},

	enable: function() {
		return this._setOptions({ disabled: false });
	},
	disable: function() {
		return this._setOptions({ disabled: true });
	},

	_on: function( suppressDisabledCheck, element, handlers ) {
		var delegateElement,
			instance = this;

		// no suppressDisabledCheck flag, shuffle arguments
		if ( typeof suppressDisabledCheck !== "boolean" ) {
			handlers = element;
			element = suppressDisabledCheck;
			suppressDisabledCheck = false;
		}

		// no element argument, shuffle and use this.element
		if ( !handlers ) {
			handlers = element;
			element = this.element;
			delegateElement = this.widget();
		} else {
			element = delegateElement = $( element );
			this.bindings = this.bindings.add( element );
		}

		$.each( handlers, function( event, handler ) {
			function handlerProxy() {
				// allow widgets to customize the disabled handling
				// - disabled as an array instead of boolean
				// - disabled class as method for disabling individual parts
				if ( !suppressDisabledCheck &&
						( instance.options.disabled === true ||
							$( this ).hasClass( "ui-state-disabled" ) ) ) {
					return;
				}
				return ( typeof handler === "string" ? instance[ handler ] : handler )
					.apply( instance, arguments );
			}

			// copy the guid so direct unbinding works
			if ( typeof handler !== "string" ) {
				handlerProxy.guid = handler.guid =
					handler.guid || handlerProxy.guid || $.guid++;
			}

			var match = event.match( /^([\w:-]*)\s*(.*)$/ ),
				eventName = match[1] + instance.eventNamespace,
				selector = match[2];
			if ( selector ) {
				delegateElement.delegate( selector, eventName, handlerProxy );
			} else {
				element.bind( eventName, handlerProxy );
			}
		});
	},

	_off: function( element, eventName ) {
		eventName = (eventName || "").split( " " ).join( this.eventNamespace + " " ) +
			this.eventNamespace;
		element.unbind( eventName ).undelegate( eventName );

		// Clear the stack to avoid memory leaks (#10056)
		this.bindings = $( this.bindings.not( element ).get() );
		this.focusable = $( this.focusable.not( element ).get() );
		this.hoverable = $( this.hoverable.not( element ).get() );
	},

	_delay: function( handler, delay ) {
		function handlerProxy() {
			return ( typeof handler === "string" ? instance[ handler ] : handler )
				.apply( instance, arguments );
		}
		var instance = this;
		return setTimeout( handlerProxy, delay || 0 );
	},

	_hoverable: function( element ) {
		this.hoverable = this.hoverable.add( element );
		this._on( element, {
			mouseenter: function( event ) {
				$( event.currentTarget ).addClass( "ui-state-hover" );
			},
			mouseleave: function( event ) {
				$( event.currentTarget ).removeClass( "ui-state-hover" );
			}
		});
	},

	_focusable: function( element ) {
		this.focusable = this.focusable.add( element );
		this._on( element, {
			focusin: function( event ) {
				$( event.currentTarget ).addClass( "ui-state-focus" );
			},
			focusout: function( event ) {
				$( event.currentTarget ).removeClass( "ui-state-focus" );
			}
		});
	},

	_trigger: function( type, event, data ) {
		var prop, orig,
			callback = this.options[ type ];

		data = data || {};
		event = $.Event( event );
		event.type = ( type === this.widgetEventPrefix ?
			type :
			this.widgetEventPrefix + type ).toLowerCase();
		// the original event may come from any element
		// so we need to reset the target on the new event
		event.target = this.element[ 0 ];

		// copy original event properties over to the new event
		orig = event.originalEvent;
		if ( orig ) {
			for ( prop in orig ) {
				if ( !( prop in event ) ) {
					event[ prop ] = orig[ prop ];
				}
			}
		}

		this.element.trigger( event, data );
		return !( $.isFunction( callback ) &&
			callback.apply( this.element[0], [ event ].concat( data ) ) === false ||
			event.isDefaultPrevented() );
	}
};

$.each( { show: "fadeIn", hide: "fadeOut" }, function( method, defaultEffect ) {
	$.Widget.prototype[ "_" + method ] = function( element, options, callback ) {
		if ( typeof options === "string" ) {
			options = { effect: options };
		}
		var hasOptions,
			effectName = !options ?
				method :
				options === true || typeof options === "number" ?
					defaultEffect :
					options.effect || defaultEffect;
		options = options || {};
		if ( typeof options === "number" ) {
			options = { duration: options };
		}
		hasOptions = !$.isEmptyObject( options );
		options.complete = callback;
		if ( options.delay ) {
			element.delay( options.delay );
		}
		if ( hasOptions && $.effects && $.effects.effect[ effectName ] ) {
			element[ method ]( options );
		} else if ( effectName !== method && element[ effectName ] ) {
			element[ effectName ]( options.duration, options.easing, callback );
		} else {
			element.queue(function( next ) {
				$( this )[ method ]();
				if ( callback ) {
					callback.call( element[ 0 ] );
				}
				next();
			});
		}
	};
});

var widget = $.widget;


/*!
 * jQuery UI Mouse 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/mouse/
 */


var mouseHandled = false;
$( document ).mouseup( function() {
	mouseHandled = false;
});

var mouse = $.widget("ui.mouse", {
	version: "1.11.4",
	options: {
		cancel: "input,textarea,button,select,option",
		distance: 1,
		delay: 0
	},
	_mouseInit: function() {
		var that = this;

		this.element
			.bind("mousedown." + this.widgetName, function(event) {
				return that._mouseDown(event);
			})
			.bind("click." + this.widgetName, function(event) {
				if (true === $.data(event.target, that.widgetName + ".preventClickEvent")) {
					$.removeData(event.target, that.widgetName + ".preventClickEvent");
					event.stopImmediatePropagation();
					return false;
				}
			});

		this.started = false;
	},

	// TODO: make sure destroying one instance of mouse doesn't mess with
	// other instances of mouse
	_mouseDestroy: function() {
		this.element.unbind("." + this.widgetName);
		if ( this._mouseMoveDelegate ) {
			this.document
				.unbind("mousemove." + this.widgetName, this._mouseMoveDelegate)
				.unbind("mouseup." + this.widgetName, this._mouseUpDelegate);
		}
	},

	_mouseDown: function(event) {
		// don't let more than one widget handle mouseStart
		if ( mouseHandled ) {
			return;
		}

		this._mouseMoved = false;

		// we may have missed mouseup (out of window)
		(this._mouseStarted && this._mouseUp(event));

		this._mouseDownEvent = event;

		var that = this,
			btnIsLeft = (event.which === 1),
			// event.target.nodeName works around a bug in IE 8 with
			// disabled inputs (#7620)
			elIsCancel = (typeof this.options.cancel === "string" && event.target.nodeName ? $(event.target).closest(this.options.cancel).length : false);
		if (!btnIsLeft || elIsCancel || !this._mouseCapture(event)) {
			return true;
		}

		this.mouseDelayMet = !this.options.delay;
		if (!this.mouseDelayMet) {
			this._mouseDelayTimer = setTimeout(function() {
				that.mouseDelayMet = true;
			}, this.options.delay);
		}

		if (this._mouseDistanceMet(event) && this._mouseDelayMet(event)) {
			this._mouseStarted = (this._mouseStart(event) !== false);
			if (!this._mouseStarted) {
				event.preventDefault();
				return true;
			}
		}

		// Click event may never have fired (Gecko & Opera)
		if (true === $.data(event.target, this.widgetName + ".preventClickEvent")) {
			$.removeData(event.target, this.widgetName + ".preventClickEvent");
		}

		// these delegates are required to keep context
		this._mouseMoveDelegate = function(event) {
			return that._mouseMove(event);
		};
		this._mouseUpDelegate = function(event) {
			return that._mouseUp(event);
		};

		this.document
			.bind( "mousemove." + this.widgetName, this._mouseMoveDelegate )
			.bind( "mouseup." + this.widgetName, this._mouseUpDelegate );

		event.preventDefault();

		mouseHandled = true;
		return true;
	},

	_mouseMove: function(event) {
		// Only check for mouseups outside the document if you've moved inside the document
		// at least once. This prevents the firing of mouseup in the case of IE<9, which will
		// fire a mousemove event if content is placed under the cursor. See #7778
		// Support: IE <9
		if ( this._mouseMoved ) {
			// IE mouseup check - mouseup happened when mouse was out of window
			if ($.ui.ie && ( !document.documentMode || document.documentMode < 9 ) && !event.button) {
				return this._mouseUp(event);

			// Iframe mouseup check - mouseup occurred in another document
			} else if ( !event.which ) {
				return this._mouseUp( event );
			}
		}

		if ( event.which || event.button ) {
			this._mouseMoved = true;
		}

		if (this._mouseStarted) {
			this._mouseDrag(event);
			return event.preventDefault();
		}

		if (this._mouseDistanceMet(event) && this._mouseDelayMet(event)) {
			this._mouseStarted =
				(this._mouseStart(this._mouseDownEvent, event) !== false);
			(this._mouseStarted ? this._mouseDrag(event) : this._mouseUp(event));
		}

		return !this._mouseStarted;
	},

	_mouseUp: function(event) {
		this.document
			.unbind( "mousemove." + this.widgetName, this._mouseMoveDelegate )
			.unbind( "mouseup." + this.widgetName, this._mouseUpDelegate );

		if (this._mouseStarted) {
			this._mouseStarted = false;

			if (event.target === this._mouseDownEvent.target) {
				$.data(event.target, this.widgetName + ".preventClickEvent", true);
			}

			this._mouseStop(event);
		}

		mouseHandled = false;
		return false;
	},

	_mouseDistanceMet: function(event) {
		return (Math.max(
				Math.abs(this._mouseDownEvent.pageX - event.pageX),
				Math.abs(this._mouseDownEvent.pageY - event.pageY)
			) >= this.options.distance
		);
	},

	_mouseDelayMet: function(/* event */) {
		return this.mouseDelayMet;
	},

	// These are placeholder methods, to be overriden by extending plugin
	_mouseStart: function(/* event */) {},
	_mouseDrag: function(/* event */) {},
	_mouseStop: function(/* event */) {},
	_mouseCapture: function(/* event */) { return true; }
});


/*!
 * jQuery UI Position 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/position/
 */

(function() {

$.ui = $.ui || {};

var cachedScrollbarWidth, supportsOffsetFractions,
	max = Math.max,
	abs = Math.abs,
	round = Math.round,
	rhorizontal = /left|center|right/,
	rvertical = /top|center|bottom/,
	roffset = /[\+\-]\d+(\.[\d]+)?%?/,
	rposition = /^\w+/,
	rpercent = /%$/,
	_position = $.fn.position;

function getOffsets( offsets, width, height ) {
	return [
		parseFloat( offsets[ 0 ] ) * ( rpercent.test( offsets[ 0 ] ) ? width / 100 : 1 ),
		parseFloat( offsets[ 1 ] ) * ( rpercent.test( offsets[ 1 ] ) ? height / 100 : 1 )
	];
}

function parseCss( element, property ) {
	return parseInt( $.css( element, property ), 10 ) || 0;
}

function getDimensions( elem ) {
	var raw = elem[0];
	if ( raw.nodeType === 9 ) {
		return {
			width: elem.width(),
			height: elem.height(),
			offset: { top: 0, left: 0 }
		};
	}
	if ( $.isWindow( raw ) ) {
		return {
			width: elem.width(),
			height: elem.height(),
			offset: { top: elem.scrollTop(), left: elem.scrollLeft() }
		};
	}
	if ( raw.preventDefault ) {
		return {
			width: 0,
			height: 0,
			offset: { top: raw.pageY, left: raw.pageX }
		};
	}
	return {
		width: elem.outerWidth(),
		height: elem.outerHeight(),
		offset: elem.offset()
	};
}

$.position = {
	scrollbarWidth: function() {
		if ( cachedScrollbarWidth !== undefined ) {
			return cachedScrollbarWidth;
		}
		var w1, w2,
			div = $( "<div style='display:block;position:absolute;width:50px;height:50px;overflow:hidden;'><div style='height:100px;width:auto;'></div></div>" ),
			innerDiv = div.children()[0];

		$( "body" ).append( div );
		w1 = innerDiv.offsetWidth;
		div.css( "overflow", "scroll" );

		w2 = innerDiv.offsetWidth;

		if ( w1 === w2 ) {
			w2 = div[0].clientWidth;
		}

		div.remove();

		return (cachedScrollbarWidth = w1 - w2);
	},
	getScrollInfo: function( within ) {
		var overflowX = within.isWindow || within.isDocument ? "" :
				within.element.css( "overflow-x" ),
			overflowY = within.isWindow || within.isDocument ? "" :
				within.element.css( "overflow-y" ),
			hasOverflowX = overflowX === "scroll" ||
				( overflowX === "auto" && within.width < within.element[0].scrollWidth ),
			hasOverflowY = overflowY === "scroll" ||
				( overflowY === "auto" && within.height < within.element[0].scrollHeight );
		return {
			width: hasOverflowY ? $.position.scrollbarWidth() : 0,
			height: hasOverflowX ? $.position.scrollbarWidth() : 0
		};
	},
	getWithinInfo: function( element ) {
		var withinElement = $( element || window ),
			isWindow = $.isWindow( withinElement[0] ),
			isDocument = !!withinElement[ 0 ] && withinElement[ 0 ].nodeType === 9;
		return {
			element: withinElement,
			isWindow: isWindow,
			isDocument: isDocument,
			offset: withinElement.offset() || { left: 0, top: 0 },
			scrollLeft: withinElement.scrollLeft(),
			scrollTop: withinElement.scrollTop(),

			// support: jQuery 1.6.x
			// jQuery 1.6 doesn't support .outerWidth/Height() on documents or windows
			width: isWindow || isDocument ? withinElement.width() : withinElement.outerWidth(),
			height: isWindow || isDocument ? withinElement.height() : withinElement.outerHeight()
		};
	}
};

$.fn.position = function( options ) {
	if ( !options || !options.of ) {
		return _position.apply( this, arguments );
	}

	// make a copy, we don't want to modify arguments
	options = $.extend( {}, options );

	var atOffset, targetWidth, targetHeight, targetOffset, basePosition, dimensions,
		target = $( options.of ),
		within = $.position.getWithinInfo( options.within ),
		scrollInfo = $.position.getScrollInfo( within ),
		collision = ( options.collision || "flip" ).split( " " ),
		offsets = {};

	dimensions = getDimensions( target );
	if ( target[0].preventDefault ) {
		// force left top to allow flipping
		options.at = "left top";
	}
	targetWidth = dimensions.width;
	targetHeight = dimensions.height;
	targetOffset = dimensions.offset;
	// clone to reuse original targetOffset later
	basePosition = $.extend( {}, targetOffset );

	// force my and at to have valid horizontal and vertical positions
	// if a value is missing or invalid, it will be converted to center
	$.each( [ "my", "at" ], function() {
		var pos = ( options[ this ] || "" ).split( " " ),
			horizontalOffset,
			verticalOffset;

		if ( pos.length === 1) {
			pos = rhorizontal.test( pos[ 0 ] ) ?
				pos.concat( [ "center" ] ) :
				rvertical.test( pos[ 0 ] ) ?
					[ "center" ].concat( pos ) :
					[ "center", "center" ];
		}
		pos[ 0 ] = rhorizontal.test( pos[ 0 ] ) ? pos[ 0 ] : "center";
		pos[ 1 ] = rvertical.test( pos[ 1 ] ) ? pos[ 1 ] : "center";

		// calculate offsets
		horizontalOffset = roffset.exec( pos[ 0 ] );
		verticalOffset = roffset.exec( pos[ 1 ] );
		offsets[ this ] = [
			horizontalOffset ? horizontalOffset[ 0 ] : 0,
			verticalOffset ? verticalOffset[ 0 ] : 0
		];

		// reduce to just the positions without the offsets
		options[ this ] = [
			rposition.exec( pos[ 0 ] )[ 0 ],
			rposition.exec( pos[ 1 ] )[ 0 ]
		];
	});

	// normalize collision option
	if ( collision.length === 1 ) {
		collision[ 1 ] = collision[ 0 ];
	}

	if ( options.at[ 0 ] === "right" ) {
		basePosition.left += targetWidth;
	} else if ( options.at[ 0 ] === "center" ) {
		basePosition.left += targetWidth / 2;
	}

	if ( options.at[ 1 ] === "bottom" ) {
		basePosition.top += targetHeight;
	} else if ( options.at[ 1 ] === "center" ) {
		basePosition.top += targetHeight / 2;
	}

	atOffset = getOffsets( offsets.at, targetWidth, targetHeight );
	basePosition.left += atOffset[ 0 ];
	basePosition.top += atOffset[ 1 ];

	return this.each(function() {
		var collisionPosition, using,
			elem = $( this ),
			elemWidth = elem.outerWidth(),
			elemHeight = elem.outerHeight(),
			marginLeft = parseCss( this, "marginLeft" ),
			marginTop = parseCss( this, "marginTop" ),
			collisionWidth = elemWidth + marginLeft + parseCss( this, "marginRight" ) + scrollInfo.width,
			collisionHeight = elemHeight + marginTop + parseCss( this, "marginBottom" ) + scrollInfo.height,
			position = $.extend( {}, basePosition ),
			myOffset = getOffsets( offsets.my, elem.outerWidth(), elem.outerHeight() );

		if ( options.my[ 0 ] === "right" ) {
			position.left -= elemWidth;
		} else if ( options.my[ 0 ] === "center" ) {
			position.left -= elemWidth / 2;
		}

		if ( options.my[ 1 ] === "bottom" ) {
			position.top -= elemHeight;
		} else if ( options.my[ 1 ] === "center" ) {
			position.top -= elemHeight / 2;
		}

		position.left += myOffset[ 0 ];
		position.top += myOffset[ 1 ];

		// if the browser doesn't support fractions, then round for consistent results
		if ( !supportsOffsetFractions ) {
			position.left = round( position.left );
			position.top = round( position.top );
		}

		collisionPosition = {
			marginLeft: marginLeft,
			marginTop: marginTop
		};

		$.each( [ "left", "top" ], function( i, dir ) {
			if ( $.ui.position[ collision[ i ] ] ) {
				$.ui.position[ collision[ i ] ][ dir ]( position, {
					targetWidth: targetWidth,
					targetHeight: targetHeight,
					elemWidth: elemWidth,
					elemHeight: elemHeight,
					collisionPosition: collisionPosition,
					collisionWidth: collisionWidth,
					collisionHeight: collisionHeight,
					offset: [ atOffset[ 0 ] + myOffset[ 0 ], atOffset [ 1 ] + myOffset[ 1 ] ],
					my: options.my,
					at: options.at,
					within: within,
					elem: elem
				});
			}
		});

		if ( options.using ) {
			// adds feedback as second argument to using callback, if present
			using = function( props ) {
				var left = targetOffset.left - position.left,
					right = left + targetWidth - elemWidth,
					top = targetOffset.top - position.top,
					bottom = top + targetHeight - elemHeight,
					feedback = {
						target: {
							element: target,
							left: targetOffset.left,
							top: targetOffset.top,
							width: targetWidth,
							height: targetHeight
						},
						element: {
							element: elem,
							left: position.left,
							top: position.top,
							width: elemWidth,
							height: elemHeight
						},
						horizontal: right < 0 ? "left" : left > 0 ? "right" : "center",
						vertical: bottom < 0 ? "top" : top > 0 ? "bottom" : "middle"
					};
				if ( targetWidth < elemWidth && abs( left + right ) < targetWidth ) {
					feedback.horizontal = "center";
				}
				if ( targetHeight < elemHeight && abs( top + bottom ) < targetHeight ) {
					feedback.vertical = "middle";
				}
				if ( max( abs( left ), abs( right ) ) > max( abs( top ), abs( bottom ) ) ) {
					feedback.important = "horizontal";
				} else {
					feedback.important = "vertical";
				}
				options.using.call( this, props, feedback );
			};
		}

		elem.offset( $.extend( position, { using: using } ) );
	});
};

$.ui.position = {
	fit: {
		left: function( position, data ) {
			var within = data.within,
				withinOffset = within.isWindow ? within.scrollLeft : within.offset.left,
				outerWidth = within.width,
				collisionPosLeft = position.left - data.collisionPosition.marginLeft,
				overLeft = withinOffset - collisionPosLeft,
				overRight = collisionPosLeft + data.collisionWidth - outerWidth - withinOffset,
				newOverRight;

			// element is wider than within
			if ( data.collisionWidth > outerWidth ) {
				// element is initially over the left side of within
				if ( overLeft > 0 && overRight <= 0 ) {
					newOverRight = position.left + overLeft + data.collisionWidth - outerWidth - withinOffset;
					position.left += overLeft - newOverRight;
				// element is initially over right side of within
				} else if ( overRight > 0 && overLeft <= 0 ) {
					position.left = withinOffset;
				// element is initially over both left and right sides of within
				} else {
					if ( overLeft > overRight ) {
						position.left = withinOffset + outerWidth - data.collisionWidth;
					} else {
						position.left = withinOffset;
					}
				}
			// too far left -> align with left edge
			} else if ( overLeft > 0 ) {
				position.left += overLeft;
			// too far right -> align with right edge
			} else if ( overRight > 0 ) {
				position.left -= overRight;
			// adjust based on position and margin
			} else {
				position.left = max( position.left - collisionPosLeft, position.left );
			}
		},
		top: function( position, data ) {
			var within = data.within,
				withinOffset = within.isWindow ? within.scrollTop : within.offset.top,
				outerHeight = data.within.height,
				collisionPosTop = position.top - data.collisionPosition.marginTop,
				overTop = withinOffset - collisionPosTop,
				overBottom = collisionPosTop + data.collisionHeight - outerHeight - withinOffset,
				newOverBottom;

			// element is taller than within
			if ( data.collisionHeight > outerHeight ) {
				// element is initially over the top of within
				if ( overTop > 0 && overBottom <= 0 ) {
					newOverBottom = position.top + overTop + data.collisionHeight - outerHeight - withinOffset;
					position.top += overTop - newOverBottom;
				// element is initially over bottom of within
				} else if ( overBottom > 0 && overTop <= 0 ) {
					position.top = withinOffset;
				// element is initially over both top and bottom of within
				} else {
					if ( overTop > overBottom ) {
						position.top = withinOffset + outerHeight - data.collisionHeight;
					} else {
						position.top = withinOffset;
					}
				}
			// too far up -> align with top
			} else if ( overTop > 0 ) {
				position.top += overTop;
			// too far down -> align with bottom edge
			} else if ( overBottom > 0 ) {
				position.top -= overBottom;
			// adjust based on position and margin
			} else {
				position.top = max( position.top - collisionPosTop, position.top );
			}
		}
	},
	flip: {
		left: function( position, data ) {
			var within = data.within,
				withinOffset = within.offset.left + within.scrollLeft,
				outerWidth = within.width,
				offsetLeft = within.isWindow ? within.scrollLeft : within.offset.left,
				collisionPosLeft = position.left - data.collisionPosition.marginLeft,
				overLeft = collisionPosLeft - offsetLeft,
				overRight = collisionPosLeft + data.collisionWidth - outerWidth - offsetLeft,
				myOffset = data.my[ 0 ] === "left" ?
					-data.elemWidth :
					data.my[ 0 ] === "right" ?
						data.elemWidth :
						0,
				atOffset = data.at[ 0 ] === "left" ?
					data.targetWidth :
					data.at[ 0 ] === "right" ?
						-data.targetWidth :
						0,
				offset = -2 * data.offset[ 0 ],
				newOverRight,
				newOverLeft;

			if ( overLeft < 0 ) {
				newOverRight = position.left + myOffset + atOffset + offset + data.collisionWidth - outerWidth - withinOffset;
				if ( newOverRight < 0 || newOverRight < abs( overLeft ) ) {
					position.left += myOffset + atOffset + offset;
				}
			} else if ( overRight > 0 ) {
				newOverLeft = position.left - data.collisionPosition.marginLeft + myOffset + atOffset + offset - offsetLeft;
				if ( newOverLeft > 0 || abs( newOverLeft ) < overRight ) {
					position.left += myOffset + atOffset + offset;
				}
			}
		},
		top: function( position, data ) {
			var within = data.within,
				withinOffset = within.offset.top + within.scrollTop,
				outerHeight = within.height,
				offsetTop = within.isWindow ? within.scrollTop : within.offset.top,
				collisionPosTop = position.top - data.collisionPosition.marginTop,
				overTop = collisionPosTop - offsetTop,
				overBottom = collisionPosTop + data.collisionHeight - outerHeight - offsetTop,
				top = data.my[ 1 ] === "top",
				myOffset = top ?
					-data.elemHeight :
					data.my[ 1 ] === "bottom" ?
						data.elemHeight :
						0,
				atOffset = data.at[ 1 ] === "top" ?
					data.targetHeight :
					data.at[ 1 ] === "bottom" ?
						-data.targetHeight :
						0,
				offset = -2 * data.offset[ 1 ],
				newOverTop,
				newOverBottom;
			if ( overTop < 0 ) {
				newOverBottom = position.top + myOffset + atOffset + offset + data.collisionHeight - outerHeight - withinOffset;
				if ( newOverBottom < 0 || newOverBottom < abs( overTop ) ) {
					position.top += myOffset + atOffset + offset;
				}
			} else if ( overBottom > 0 ) {
				newOverTop = position.top - data.collisionPosition.marginTop + myOffset + atOffset + offset - offsetTop;
				if ( newOverTop > 0 || abs( newOverTop ) < overBottom ) {
					position.top += myOffset + atOffset + offset;
				}
			}
		}
	},
	flipfit: {
		left: function() {
			$.ui.position.flip.left.apply( this, arguments );
			$.ui.position.fit.left.apply( this, arguments );
		},
		top: function() {
			$.ui.position.flip.top.apply( this, arguments );
			$.ui.position.fit.top.apply( this, arguments );
		}
	}
};

// fraction support test
(function() {
	var testElement, testElementParent, testElementStyle, offsetLeft, i,
		body = document.getElementsByTagName( "body" )[ 0 ],
		div = document.createElement( "div" );

	//Create a "fake body" for testing based on method used in jQuery.support
	testElement = document.createElement( body ? "div" : "body" );
	testElementStyle = {
		visibility: "hidden",
		width: 0,
		height: 0,
		border: 0,
		margin: 0,
		background: "none"
	};
	if ( body ) {
		$.extend( testElementStyle, {
			position: "absolute",
			left: "-1000px",
			top: "-1000px"
		});
	}
	for ( i in testElementStyle ) {
		testElement.style[ i ] = testElementStyle[ i ];
	}
	testElement.appendChild( div );
	testElementParent = body || document.documentElement;
	testElementParent.insertBefore( testElement, testElementParent.firstChild );

	div.style.cssText = "position: absolute; left: 10.7432222px;";

	offsetLeft = $( div ).offset().left;
	supportsOffsetFractions = offsetLeft > 10 && offsetLeft < 11;

	testElement.innerHTML = "";
	testElementParent.removeChild( testElement );
})();

})();

var position = $.ui.position;


/*!
 * jQuery UI Accordion 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/accordion/
 */


var accordion = $.widget( "ui.accordion", {
	version: "1.11.4",
	options: {
		active: 0,
		animate: {},
		collapsible: false,
		event: "click",
		header: "> li > :first-child,> :not(li):even",
		heightStyle: "auto",
		icons: {
			activeHeader: "ui-icon-triangle-1-s",
			header: "ui-icon-triangle-1-e"
		},

		// callbacks
		activate: null,
		beforeActivate: null
	},

	hideProps: {
		borderTopWidth: "hide",
		borderBottomWidth: "hide",
		paddingTop: "hide",
		paddingBottom: "hide",
		height: "hide"
	},

	showProps: {
		borderTopWidth: "show",
		borderBottomWidth: "show",
		paddingTop: "show",
		paddingBottom: "show",
		height: "show"
	},

	_create: function() {
		var options = this.options;
		this.prevShow = this.prevHide = $();
		this.element.addClass( "ui-accordion ui-widget ui-helper-reset" )
			// ARIA
			.attr( "role", "tablist" );

		// don't allow collapsible: false and active: false / null
		if ( !options.collapsible && (options.active === false || options.active == null) ) {
			options.active = 0;
		}

		this._processPanels();
		// handle negative values
		if ( options.active < 0 ) {
			options.active += this.headers.length;
		}
		this._refresh();
	},

	_getCreateEventData: function() {
		return {
			header: this.active,
			panel: !this.active.length ? $() : this.active.next()
		};
	},

	_createIcons: function() {
		var icons = this.options.icons;
		if ( icons ) {
			$( "<span>" )
				.addClass( "ui-accordion-header-icon ui-icon " + icons.header )
				.prependTo( this.headers );
			this.active.children( ".ui-accordion-header-icon" )
				.removeClass( icons.header )
				.addClass( icons.activeHeader );
			this.headers.addClass( "ui-accordion-icons" );
		}
	},

	_destroyIcons: function() {
		this.headers
			.removeClass( "ui-accordion-icons" )
			.children( ".ui-accordion-header-icon" )
				.remove();
	},

	_destroy: function() {
		var contents;

		// clean up main element
		this.element
			.removeClass( "ui-accordion ui-widget ui-helper-reset" )
			.removeAttr( "role" );

		// clean up headers
		this.headers
			.removeClass( "ui-accordion-header ui-accordion-header-active ui-state-default " +
				"ui-corner-all ui-state-active ui-state-disabled ui-corner-top" )
			.removeAttr( "role" )
			.removeAttr( "aria-expanded" )
			.removeAttr( "aria-selected" )
			.removeAttr( "aria-controls" )
			.removeAttr( "tabIndex" )
			.removeUniqueId();

		this._destroyIcons();

		// clean up content panels
		contents = this.headers.next()
			.removeClass( "ui-helper-reset ui-widget-content ui-corner-bottom " +
				"ui-accordion-content ui-accordion-content-active ui-state-disabled" )
			.css( "display", "" )
			.removeAttr( "role" )
			.removeAttr( "aria-hidden" )
			.removeAttr( "aria-labelledby" )
			.removeUniqueId();

		if ( this.options.heightStyle !== "content" ) {
			contents.css( "height", "" );
		}
	},

	_setOption: function( key, value ) {
		if ( key === "active" ) {
			// _activate() will handle invalid values and update this.options
			this._activate( value );
			return;
		}

		if ( key === "event" ) {
			if ( this.options.event ) {
				this._off( this.headers, this.options.event );
			}
			this._setupEvents( value );
		}

		this._super( key, value );

		// setting collapsible: false while collapsed; open first panel
		if ( key === "collapsible" && !value && this.options.active === false ) {
			this._activate( 0 );
		}

		if ( key === "icons" ) {
			this._destroyIcons();
			if ( value ) {
				this._createIcons();
			}
		}

		// #5332 - opacity doesn't cascade to positioned elements in IE
		// so we need to add the disabled class to the headers and panels
		if ( key === "disabled" ) {
			this.element
				.toggleClass( "ui-state-disabled", !!value )
				.attr( "aria-disabled", value );
			this.headers.add( this.headers.next() )
				.toggleClass( "ui-state-disabled", !!value );
		}
	},

	_keydown: function( event ) {
		if ( event.altKey || event.ctrlKey ) {
			return;
		}

		var keyCode = $.ui.keyCode,
			length = this.headers.length,
			currentIndex = this.headers.index( event.target ),
			toFocus = false;

		switch ( event.keyCode ) {
			case keyCode.RIGHT:
			case keyCode.DOWN:
				toFocus = this.headers[ ( currentIndex + 1 ) % length ];
				break;
			case keyCode.LEFT:
			case keyCode.UP:
				toFocus = this.headers[ ( currentIndex - 1 + length ) % length ];
				break;
			case keyCode.SPACE:
			case keyCode.ENTER:
				this._eventHandler( event );
				break;
			case keyCode.HOME:
				toFocus = this.headers[ 0 ];
				break;
			case keyCode.END:
				toFocus = this.headers[ length - 1 ];
				break;
		}

		if ( toFocus ) {
			$( event.target ).attr( "tabIndex", -1 );
			$( toFocus ).attr( "tabIndex", 0 );
			toFocus.focus();
			event.preventDefault();
		}
	},

	_panelKeyDown: function( event ) {
		if ( event.keyCode === $.ui.keyCode.UP && event.ctrlKey ) {
			$( event.currentTarget ).prev().focus();
		}
	},

	refresh: function() {
		var options = this.options;
		this._processPanels();

		// was collapsed or no panel
		if ( ( options.active === false && options.collapsible === true ) || !this.headers.length ) {
			options.active = false;
			this.active = $();
		// active false only when collapsible is true
		} else if ( options.active === false ) {
			this._activate( 0 );
		// was active, but active panel is gone
		} else if ( this.active.length && !$.contains( this.element[ 0 ], this.active[ 0 ] ) ) {
			// all remaining panel are disabled
			if ( this.headers.length === this.headers.find(".ui-state-disabled").length ) {
				options.active = false;
				this.active = $();
			// activate previous panel
			} else {
				this._activate( Math.max( 0, options.active - 1 ) );
			}
		// was active, active panel still exists
		} else {
			// make sure active index is correct
			options.active = this.headers.index( this.active );
		}

		this._destroyIcons();

		this._refresh();
	},

	_processPanels: function() {
		var prevHeaders = this.headers,
			prevPanels = this.panels;

		this.headers = this.element.find( this.options.header )
			.addClass( "ui-accordion-header ui-state-default ui-corner-all" );

		this.panels = this.headers.next()
			.addClass( "ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom" )
			.filter( ":not(.ui-accordion-content-active)" )
			.hide();

		// Avoid memory leaks (#10056)
		if ( prevPanels ) {
			this._off( prevHeaders.not( this.headers ) );
			this._off( prevPanels.not( this.panels ) );
		}
	},

	_refresh: function() {
		var maxHeight,
			options = this.options,
			heightStyle = options.heightStyle,
			parent = this.element.parent();

		this.active = this._findActive( options.active )
			.addClass( "ui-accordion-header-active ui-state-active ui-corner-top" )
			.removeClass( "ui-corner-all" );
		this.active.next()
			.addClass( "ui-accordion-content-active" )
			.show();

		this.headers
			.attr( "role", "tab" )
			.each(function() {
				var header = $( this ),
					headerId = header.uniqueId().attr( "id" ),
					panel = header.next(),
					panelId = panel.uniqueId().attr( "id" );
				header.attr( "aria-controls", panelId );
				panel.attr( "aria-labelledby", headerId );
			})
			.next()
				.attr( "role", "tabpanel" );

		this.headers
			.not( this.active )
			.attr({
				"aria-selected": "false",
				"aria-expanded": "false",
				tabIndex: -1
			})
			.next()
				.attr({
					"aria-hidden": "true"
				})
				.hide();

		// make sure at least one header is in the tab order
		if ( !this.active.length ) {
			this.headers.eq( 0 ).attr( "tabIndex", 0 );
		} else {
			this.active.attr({
				"aria-selected": "true",
				"aria-expanded": "true",
				tabIndex: 0
			})
			.next()
				.attr({
					"aria-hidden": "false"
				});
		}

		this._createIcons();

		this._setupEvents( options.event );

		if ( heightStyle === "fill" ) {
			maxHeight = parent.height();
			this.element.siblings( ":visible" ).each(function() {
				var elem = $( this ),
					position = elem.css( "position" );

				if ( position === "absolute" || position === "fixed" ) {
					return;
				}
				maxHeight -= elem.outerHeight( true );
			});

			this.headers.each(function() {
				maxHeight -= $( this ).outerHeight( true );
			});

			this.headers.next()
				.each(function() {
					$( this ).height( Math.max( 0, maxHeight -
						$( this ).innerHeight() + $( this ).height() ) );
				})
				.css( "overflow", "auto" );
		} else if ( heightStyle === "auto" ) {
			maxHeight = 0;
			this.headers.next()
				.each(function() {
					maxHeight = Math.max( maxHeight, $( this ).css( "height", "" ).height() );
				})
				.height( maxHeight );
		}
	},

	_activate: function( index ) {
		var active = this._findActive( index )[ 0 ];

		// trying to activate the already active panel
		if ( active === this.active[ 0 ] ) {
			return;
		}

		// trying to collapse, simulate a click on the currently active header
		active = active || this.active[ 0 ];

		this._eventHandler({
			target: active,
			currentTarget: active,
			preventDefault: $.noop
		});
	},

	_findActive: function( selector ) {
		return typeof selector === "number" ? this.headers.eq( selector ) : $();
	},

	_setupEvents: function( event ) {
		var events = {
			keydown: "_keydown"
		};
		if ( event ) {
			$.each( event.split( " " ), function( index, eventName ) {
				events[ eventName ] = "_eventHandler";
			});
		}

		this._off( this.headers.add( this.headers.next() ) );
		this._on( this.headers, events );
		this._on( this.headers.next(), { keydown: "_panelKeyDown" });
		this._hoverable( this.headers );
		this._focusable( this.headers );
	},

	_eventHandler: function( event ) {
		var options = this.options,
			active = this.active,
			clicked = $( event.currentTarget ),
			clickedIsActive = clicked[ 0 ] === active[ 0 ],
			collapsing = clickedIsActive && options.collapsible,
			toShow = collapsing ? $() : clicked.next(),
			toHide = active.next(),
			eventData = {
				oldHeader: active,
				oldPanel: toHide,
				newHeader: collapsing ? $() : clicked,
				newPanel: toShow
			};

		event.preventDefault();

		if (
				// click on active header, but not collapsible
				( clickedIsActive && !options.collapsible ) ||
				// allow canceling activation
				( this._trigger( "beforeActivate", event, eventData ) === false ) ) {
			return;
		}

		options.active = collapsing ? false : this.headers.index( clicked );

		// when the call to ._toggle() comes after the class changes
		// it causes a very odd bug in IE 8 (see #6720)
		this.active = clickedIsActive ? $() : clicked;
		this._toggle( eventData );

		// switch classes
		// corner classes on the previously active header stay after the animation
		active.removeClass( "ui-accordion-header-active ui-state-active" );
		if ( options.icons ) {
			active.children( ".ui-accordion-header-icon" )
				.removeClass( options.icons.activeHeader )
				.addClass( options.icons.header );
		}

		if ( !clickedIsActive ) {
			clicked
				.removeClass( "ui-corner-all" )
				.addClass( "ui-accordion-header-active ui-state-active ui-corner-top" );
			if ( options.icons ) {
				clicked.children( ".ui-accordion-header-icon" )
					.removeClass( options.icons.header )
					.addClass( options.icons.activeHeader );
			}

			clicked
				.next()
				.addClass( "ui-accordion-content-active" );
		}
	},

	_toggle: function( data ) {
		var toShow = data.newPanel,
			toHide = this.prevShow.length ? this.prevShow : data.oldPanel;

		// handle activating a panel during the animation for another activation
		this.prevShow.add( this.prevHide ).stop( true, true );
		this.prevShow = toShow;
		this.prevHide = toHide;

		if ( this.options.animate ) {
			this._animate( toShow, toHide, data );
		} else {
			toHide.hide();
			toShow.show();
			this._toggleComplete( data );
		}

		toHide.attr({
			"aria-hidden": "true"
		});
		toHide.prev().attr({
			"aria-selected": "false",
			"aria-expanded": "false"
		});
		// if we're switching panels, remove the old header from the tab order
		// if we're opening from collapsed state, remove the previous header from the tab order
		// if we're collapsing, then keep the collapsing header in the tab order
		if ( toShow.length && toHide.length ) {
			toHide.prev().attr({
				"tabIndex": -1,
				"aria-expanded": "false"
			});
		} else if ( toShow.length ) {
			this.headers.filter(function() {
				return parseInt( $( this ).attr( "tabIndex" ), 10 ) === 0;
			})
			.attr( "tabIndex", -1 );
		}

		toShow
			.attr( "aria-hidden", "false" )
			.prev()
				.attr({
					"aria-selected": "true",
					"aria-expanded": "true",
					tabIndex: 0
				});
	},

	_animate: function( toShow, toHide, data ) {
		var total, easing, duration,
			that = this,
			adjust = 0,
			boxSizing = toShow.css( "box-sizing" ),
			down = toShow.length &&
				( !toHide.length || ( toShow.index() < toHide.index() ) ),
			animate = this.options.animate || {},
			options = down && animate.down || animate,
			complete = function() {
				that._toggleComplete( data );
			};

		if ( typeof options === "number" ) {
			duration = options;
		}
		if ( typeof options === "string" ) {
			easing = options;
		}
		// fall back from options to animation in case of partial down settings
		easing = easing || options.easing || animate.easing;
		duration = duration || options.duration || animate.duration;

		if ( !toHide.length ) {
			return toShow.animate( this.showProps, duration, easing, complete );
		}
		if ( !toShow.length ) {
			return toHide.animate( this.hideProps, duration, easing, complete );
		}

		total = toShow.show().outerHeight();
		toHide.animate( this.hideProps, {
			duration: duration,
			easing: easing,
			step: function( now, fx ) {
				fx.now = Math.round( now );
			}
		});
		toShow
			.hide()
			.animate( this.showProps, {
				duration: duration,
				easing: easing,
				complete: complete,
				step: function( now, fx ) {
					fx.now = Math.round( now );
					if ( fx.prop !== "height" ) {
						if ( boxSizing === "content-box" ) {
							adjust += fx.now;
						}
					} else if ( that.options.heightStyle !== "content" ) {
						fx.now = Math.round( total - toHide.outerHeight() - adjust );
						adjust = 0;
					}
				}
			});
	},

	_toggleComplete: function( data ) {
		var toHide = data.oldPanel;

		toHide
			.removeClass( "ui-accordion-content-active" )
			.prev()
				.removeClass( "ui-corner-top" )
				.addClass( "ui-corner-all" );

		// Work around for rendering bug in IE (#5421)
		if ( toHide.length ) {
			toHide.parent()[ 0 ].className = toHide.parent()[ 0 ].className;
		}
		this._trigger( "activate", null, data );
	}
});


/*!
 * jQuery UI Menu 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/menu/
 */


var menu = $.widget( "ui.menu", {
	version: "1.11.4",
	defaultElement: "<ul>",
	delay: 300,
	options: {
		icons: {
			submenu: "ui-icon-carat-1-e"
		},
		items: "> *",
		menus: "ul",
		position: {
			my: "left-1 top",
			at: "right top"
		},
		role: "menu",

		// callbacks
		blur: null,
		focus: null,
		select: null
	},

	_create: function() {
		this.activeMenu = this.element;

		// Flag used to prevent firing of the click handler
		// as the event bubbles up through nested menus
		this.mouseHandled = false;
		this.element
			.uniqueId()
			.addClass( "ui-menu ui-widget ui-widget-content" )
			.toggleClass( "ui-menu-icons", !!this.element.find( ".ui-icon" ).length )
			.attr({
				role: this.options.role,
				tabIndex: 0
			});

		if ( this.options.disabled ) {
			this.element
				.addClass( "ui-state-disabled" )
				.attr( "aria-disabled", "true" );
		}

		this._on({
			// Prevent focus from sticking to links inside menu after clicking
			// them (focus should always stay on UL during navigation).
			"mousedown .ui-menu-item": function( event ) {
				event.preventDefault();
			},
			"click .ui-menu-item": function( event ) {
				var target = $( event.target );
				if ( !this.mouseHandled && target.not( ".ui-state-disabled" ).length ) {
					this.select( event );

					// Only set the mouseHandled flag if the event will bubble, see #9469.
					if ( !event.isPropagationStopped() ) {
						this.mouseHandled = true;
					}

					// Open submenu on click
					if ( target.has( ".ui-menu" ).length ) {
						this.expand( event );
					} else if ( !this.element.is( ":focus" ) && $( this.document[ 0 ].activeElement ).closest( ".ui-menu" ).length ) {

						// Redirect focus to the menu
						this.element.trigger( "focus", [ true ] );

						// If the active item is on the top level, let it stay active.
						// Otherwise, blur the active item since it is no longer visible.
						if ( this.active && this.active.parents( ".ui-menu" ).length === 1 ) {
							clearTimeout( this.timer );
						}
					}
				}
			},
			"mouseenter .ui-menu-item": function( event ) {
				// Ignore mouse events while typeahead is active, see #10458.
				// Prevents focusing the wrong item when typeahead causes a scroll while the mouse
				// is over an item in the menu
				if ( this.previousFilter ) {
					return;
				}
				var target = $( event.currentTarget );
				// Remove ui-state-active class from siblings of the newly focused menu item
				// to avoid a jump caused by adjacent elements both having a class with a border
				target.siblings( ".ui-state-active" ).removeClass( "ui-state-active" );
				this.focus( event, target );
			},
			mouseleave: "collapseAll",
			"mouseleave .ui-menu": "collapseAll",
			focus: function( event, keepActiveItem ) {
				// If there's already an active item, keep it active
				// If not, activate the first item
				var item = this.active || this.element.find( this.options.items ).eq( 0 );

				if ( !keepActiveItem ) {
					this.focus( event, item );
				}
			},
			blur: function( event ) {
				this._delay(function() {
					if ( !$.contains( this.element[0], this.document[0].activeElement ) ) {
						this.collapseAll( event );
					}
				});
			},
			keydown: "_keydown"
		});

		this.refresh();

		// Clicks outside of a menu collapse any open menus
		this._on( this.document, {
			click: function( event ) {
				if ( this._closeOnDocumentClick( event ) ) {
					this.collapseAll( event );
				}

				// Reset the mouseHandled flag
				this.mouseHandled = false;
			}
		});
	},

	_destroy: function() {
		// Destroy (sub)menus
		this.element
			.removeAttr( "aria-activedescendant" )
			.find( ".ui-menu" ).addBack()
				.removeClass( "ui-menu ui-widget ui-widget-content ui-menu-icons ui-front" )
				.removeAttr( "role" )
				.removeAttr( "tabIndex" )
				.removeAttr( "aria-labelledby" )
				.removeAttr( "aria-expanded" )
				.removeAttr( "aria-hidden" )
				.removeAttr( "aria-disabled" )
				.removeUniqueId()
				.show();

		// Destroy menu items
		this.element.find( ".ui-menu-item" )
			.removeClass( "ui-menu-item" )
			.removeAttr( "role" )
			.removeAttr( "aria-disabled" )
			.removeUniqueId()
			.removeClass( "ui-state-hover" )
			.removeAttr( "tabIndex" )
			.removeAttr( "role" )
			.removeAttr( "aria-haspopup" )
			.children().each( function() {
				var elem = $( this );
				if ( elem.data( "ui-menu-submenu-carat" ) ) {
					elem.remove();
				}
			});

		// Destroy menu dividers
		this.element.find( ".ui-menu-divider" ).removeClass( "ui-menu-divider ui-widget-content" );
	},

	_keydown: function( event ) {
		var match, prev, character, skip,
			preventDefault = true;

		switch ( event.keyCode ) {
		case $.ui.keyCode.PAGE_UP:
			this.previousPage( event );
			break;
		case $.ui.keyCode.PAGE_DOWN:
			this.nextPage( event );
			break;
		case $.ui.keyCode.HOME:
			this._move( "first", "first", event );
			break;
		case $.ui.keyCode.END:
			this._move( "last", "last", event );
			break;
		case $.ui.keyCode.UP:
			this.previous( event );
			break;
		case $.ui.keyCode.DOWN:
			this.next( event );
			break;
		case $.ui.keyCode.LEFT:
			this.collapse( event );
			break;
		case $.ui.keyCode.RIGHT:
			if ( this.active && !this.active.is( ".ui-state-disabled" ) ) {
				this.expand( event );
			}
			break;
		case $.ui.keyCode.ENTER:
		case $.ui.keyCode.SPACE:
			this._activate( event );
			break;
		case $.ui.keyCode.ESCAPE:
			this.collapse( event );
			break;
		default:
			preventDefault = false;
			prev = this.previousFilter || "";
			character = String.fromCharCode( event.keyCode );
			skip = false;

			clearTimeout( this.filterTimer );

			if ( character === prev ) {
				skip = true;
			} else {
				character = prev + character;
			}

			match = this._filterMenuItems( character );
			match = skip && match.index( this.active.next() ) !== -1 ?
				this.active.nextAll( ".ui-menu-item" ) :
				match;

			// If no matches on the current filter, reset to the last character pressed
			// to move down the menu to the first item that starts with that character
			if ( !match.length ) {
				character = String.fromCharCode( event.keyCode );
				match = this._filterMenuItems( character );
			}

			if ( match.length ) {
				this.focus( event, match );
				this.previousFilter = character;
				this.filterTimer = this._delay(function() {
					delete this.previousFilter;
				}, 1000 );
			} else {
				delete this.previousFilter;
			}
		}

		if ( preventDefault ) {
			event.preventDefault();
		}
	},

	_activate: function( event ) {
		if ( !this.active.is( ".ui-state-disabled" ) ) {
			if ( this.active.is( "[aria-haspopup='true']" ) ) {
				this.expand( event );
			} else {
				this.select( event );
			}
		}
	},

	refresh: function() {
		var menus, items,
			that = this,
			icon = this.options.icons.submenu,
			submenus = this.element.find( this.options.menus );

		this.element.toggleClass( "ui-menu-icons", !!this.element.find( ".ui-icon" ).length );

		// Initialize nested menus
		submenus.filter( ":not(.ui-menu)" )
			.addClass( "ui-menu ui-widget ui-widget-content ui-front" )
			.hide()
			.attr({
				role: this.options.role,
				"aria-hidden": "true",
				"aria-expanded": "false"
			})
			.each(function() {
				var menu = $( this ),
					item = menu.parent(),
					submenuCarat = $( "<span>" )
						.addClass( "ui-menu-icon ui-icon " + icon )
						.data( "ui-menu-submenu-carat", true );

				item
					.attr( "aria-haspopup", "true" )
					.prepend( submenuCarat );
				menu.attr( "aria-labelledby", item.attr( "id" ) );
			});

		menus = submenus.add( this.element );
		items = menus.find( this.options.items );

		// Initialize menu-items containing spaces and/or dashes only as dividers
		items.not( ".ui-menu-item" ).each(function() {
			var item = $( this );
			if ( that._isDivider( item ) ) {
				item.addClass( "ui-widget-content ui-menu-divider" );
			}
		});

		// Don't refresh list items that are already adapted
		items.not( ".ui-menu-item, .ui-menu-divider" )
			.addClass( "ui-menu-item" )
			.uniqueId()
			.attr({
				tabIndex: -1,
				role: this._itemRole()
			});

		// Add aria-disabled attribute to any disabled menu item
		items.filter( ".ui-state-disabled" ).attr( "aria-disabled", "true" );

		// If the active item has been removed, blur the menu
		if ( this.active && !$.contains( this.element[ 0 ], this.active[ 0 ] ) ) {
			this.blur();
		}
	},

	_itemRole: function() {
		return {
			menu: "menuitem",
			listbox: "option"
		}[ this.options.role ];
	},

	_setOption: function( key, value ) {
		if ( key === "icons" ) {
			this.element.find( ".ui-menu-icon" )
				.removeClass( this.options.icons.submenu )
				.addClass( value.submenu );
		}
		if ( key === "disabled" ) {
			this.element
				.toggleClass( "ui-state-disabled", !!value )
				.attr( "aria-disabled", value );
		}
		this._super( key, value );
	},

	focus: function( event, item ) {
		var nested, focused;
		this.blur( event, event && event.type === "focus" );

		this._scrollIntoView( item );

		this.active = item.first();
		focused = this.active.addClass( "ui-state-focus" ).removeClass( "ui-state-active" );
		// Only update aria-activedescendant if there's a role
		// otherwise we assume focus is managed elsewhere
		if ( this.options.role ) {
			this.element.attr( "aria-activedescendant", focused.attr( "id" ) );
		}

		// Highlight active parent menu item, if any
		this.active
			.parent()
			.closest( ".ui-menu-item" )
			.addClass( "ui-state-active" );

		if ( event && event.type === "keydown" ) {
			this._close();
		} else {
			this.timer = this._delay(function() {
				this._close();
			}, this.delay );
		}

		nested = item.children( ".ui-menu" );
		if ( nested.length && event && ( /^mouse/.test( event.type ) ) ) {
			this._startOpening(nested);
		}
		this.activeMenu = item.parent();

		this._trigger( "focus", event, { item: item } );
	},

	_scrollIntoView: function( item ) {
		var borderTop, paddingTop, offset, scroll, elementHeight, itemHeight;
		if ( this._hasScroll() ) {
			borderTop = parseFloat( $.css( this.activeMenu[0], "borderTopWidth" ) ) || 0;
			paddingTop = parseFloat( $.css( this.activeMenu[0], "paddingTop" ) ) || 0;
			offset = item.offset().top - this.activeMenu.offset().top - borderTop - paddingTop;
			scroll = this.activeMenu.scrollTop();
			elementHeight = this.activeMenu.height();
			itemHeight = item.outerHeight();

			if ( offset < 0 ) {
				this.activeMenu.scrollTop( scroll + offset );
			} else if ( offset + itemHeight > elementHeight ) {
				this.activeMenu.scrollTop( scroll + offset - elementHeight + itemHeight );
			}
		}
	},

	blur: function( event, fromFocus ) {
		if ( !fromFocus ) {
			clearTimeout( this.timer );
		}

		if ( !this.active ) {
			return;
		}

		this.active.removeClass( "ui-state-focus" );
		this.active = null;

		this._trigger( "blur", event, { item: this.active } );
	},

	_startOpening: function( submenu ) {
		clearTimeout( this.timer );

		// Don't open if already open fixes a Firefox bug that caused a .5 pixel
		// shift in the submenu position when mousing over the carat icon
		if ( submenu.attr( "aria-hidden" ) !== "true" ) {
			return;
		}

		this.timer = this._delay(function() {
			this._close();
			this._open( submenu );
		}, this.delay );
	},

	_open: function( submenu ) {
		var position = $.extend({
			of: this.active
		}, this.options.position );

		clearTimeout( this.timer );
		this.element.find( ".ui-menu" ).not( submenu.parents( ".ui-menu" ) )
			.hide()
			.attr( "aria-hidden", "true" );

		submenu
			.show()
			.removeAttr( "aria-hidden" )
			.attr( "aria-expanded", "true" )
			.position( position );
	},

	collapseAll: function( event, all ) {
		clearTimeout( this.timer );
		this.timer = this._delay(function() {
			// If we were passed an event, look for the submenu that contains the event
			var currentMenu = all ? this.element :
				$( event && event.target ).closest( this.element.find( ".ui-menu" ) );

			// If we found no valid submenu ancestor, use the main menu to close all sub menus anyway
			if ( !currentMenu.length ) {
				currentMenu = this.element;
			}

			this._close( currentMenu );

			this.blur( event );
			this.activeMenu = currentMenu;
		}, this.delay );
	},

	// With no arguments, closes the currently active menu - if nothing is active
	// it closes all menus.  If passed an argument, it will search for menus BELOW
	_close: function( startMenu ) {
		if ( !startMenu ) {
			startMenu = this.active ? this.active.parent() : this.element;
		}

		startMenu
			.find( ".ui-menu" )
				.hide()
				.attr( "aria-hidden", "true" )
				.attr( "aria-expanded", "false" )
			.end()
			.find( ".ui-state-active" ).not( ".ui-state-focus" )
				.removeClass( "ui-state-active" );
	},

	_closeOnDocumentClick: function( event ) {
		return !$( event.target ).closest( ".ui-menu" ).length;
	},

	_isDivider: function( item ) {

		// Match hyphen, em dash, en dash
		return !/[^\-\u2014\u2013\s]/.test( item.text() );
	},

	collapse: function( event ) {
		var newItem = this.active &&
			this.active.parent().closest( ".ui-menu-item", this.element );
		if ( newItem && newItem.length ) {
			this._close();
			this.focus( event, newItem );
		}
	},

	expand: function( event ) {
		var newItem = this.active &&
			this.active
				.children( ".ui-menu " )
				.find( this.options.items )
				.first();

		if ( newItem && newItem.length ) {
			this._open( newItem.parent() );

			// Delay so Firefox will not hide activedescendant change in expanding submenu from AT
			this._delay(function() {
				this.focus( event, newItem );
			});
		}
	},

	next: function( event ) {
		this._move( "next", "first", event );
	},

	previous: function( event ) {
		this._move( "prev", "last", event );
	},

	isFirstItem: function() {
		return this.active && !this.active.prevAll( ".ui-menu-item" ).length;
	},

	isLastItem: function() {
		return this.active && !this.active.nextAll( ".ui-menu-item" ).length;
	},

	_move: function( direction, filter, event ) {
		var next;
		if ( this.active ) {
			if ( direction === "first" || direction === "last" ) {
				next = this.active
					[ direction === "first" ? "prevAll" : "nextAll" ]( ".ui-menu-item" )
					.eq( -1 );
			} else {
				next = this.active
					[ direction + "All" ]( ".ui-menu-item" )
					.eq( 0 );
			}
		}
		if ( !next || !next.length || !this.active ) {
			next = this.activeMenu.find( this.options.items )[ filter ]();
		}

		this.focus( event, next );
	},

	nextPage: function( event ) {
		var item, base, height;

		if ( !this.active ) {
			this.next( event );
			return;
		}
		if ( this.isLastItem() ) {
			return;
		}
		if ( this._hasScroll() ) {
			base = this.active.offset().top;
			height = this.element.height();
			this.active.nextAll( ".ui-menu-item" ).each(function() {
				item = $( this );
				return item.offset().top - base - height < 0;
			});

			this.focus( event, item );
		} else {
			this.focus( event, this.activeMenu.find( this.options.items )
				[ !this.active ? "first" : "last" ]() );
		}
	},

	previousPage: function( event ) {
		var item, base, height;
		if ( !this.active ) {
			this.next( event );
			return;
		}
		if ( this.isFirstItem() ) {
			return;
		}
		if ( this._hasScroll() ) {
			base = this.active.offset().top;
			height = this.element.height();
			this.active.prevAll( ".ui-menu-item" ).each(function() {
				item = $( this );
				return item.offset().top - base + height > 0;
			});

			this.focus( event, item );
		} else {
			this.focus( event, this.activeMenu.find( this.options.items ).first() );
		}
	},

	_hasScroll: function() {
		return this.element.outerHeight() < this.element.prop( "scrollHeight" );
	},

	select: function( event ) {
		// TODO: It should never be possible to not have an active item at this
		// point, but the tests don't trigger mouseenter before click.
		this.active = this.active || $( event.target ).closest( ".ui-menu-item" );
		var ui = { item: this.active };
		if ( !this.active.has( ".ui-menu" ).length ) {
			this.collapseAll( event, true );
		}
		this._trigger( "select", event, ui );
	},

	_filterMenuItems: function(character) {
		var escapedCharacter = character.replace( /[\-\[\]{}()*+?.,\\\^$|#\s]/g, "\\$&" ),
			regex = new RegExp( "^" + escapedCharacter, "i" );

		return this.activeMenu
			.find( this.options.items )

			// Only match on items, not dividers or other content (#10571)
			.filter( ".ui-menu-item" )
			.filter(function() {
				return regex.test( $.trim( $( this ).text() ) );
			});
	}
});


/*!
 * jQuery UI Autocomplete 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/autocomplete/
 */


$.widget( "ui.autocomplete", {
	version: "1.11.4",
	defaultElement: "<input>",
	options: {
		appendTo: null,
		autoFocus: false,
		delay: 300,
		minLength: 1,
		position: {
			my: "left top",
			at: "left bottom",
			collision: "none"
		},
		source: null,

		// callbacks
		change: null,
		close: null,
		focus: null,
		open: null,
		response: null,
		search: null,
		select: null
	},

	requestIndex: 0,
	pending: 0,

	_create: function() {
		// Some browsers only repeat keydown events, not keypress events,
		// so we use the suppressKeyPress flag to determine if we've already
		// handled the keydown event. #7269
		// Unfortunately the code for & in keypress is the same as the up arrow,
		// so we use the suppressKeyPressRepeat flag to avoid handling keypress
		// events when we know the keydown event was used to modify the
		// search term. #7799
		var suppressKeyPress, suppressKeyPressRepeat, suppressInput,
			nodeName = this.element[ 0 ].nodeName.toLowerCase(),
			isTextarea = nodeName === "textarea",
			isInput = nodeName === "input";

		this.isMultiLine =
			// Textareas are always multi-line
			isTextarea ? true :
			// Inputs are always single-line, even if inside a contentEditable element
			// IE also treats inputs as contentEditable
			isInput ? false :
			// All other element types are determined by whether or not they're contentEditable
			this.element.prop( "isContentEditable" );

		this.valueMethod = this.element[ isTextarea || isInput ? "val" : "text" ];
		this.isNewMenu = true;

		this.element
			.addClass( "ui-autocomplete-input" )
			.attr( "autocomplete", "off" );

		this._on( this.element, {
			keydown: function( event ) {
				if ( this.element.prop( "readOnly" ) ) {
					suppressKeyPress = true;
					suppressInput = true;
					suppressKeyPressRepeat = true;
					return;
				}

				suppressKeyPress = false;
				suppressInput = false;
				suppressKeyPressRepeat = false;
				var keyCode = $.ui.keyCode;
				switch ( event.keyCode ) {
				case keyCode.PAGE_UP:
					suppressKeyPress = true;
					this._move( "previousPage", event );
					break;
				case keyCode.PAGE_DOWN:
					suppressKeyPress = true;
					this._move( "nextPage", event );
					break;
				case keyCode.UP:
					suppressKeyPress = true;
					this._keyEvent( "previous", event );
					break;
				case keyCode.DOWN:
					suppressKeyPress = true;
					this._keyEvent( "next", event );
					break;
				case keyCode.ENTER:
					// when menu is open and has focus
					if ( this.menu.active ) {
						// #6055 - Opera still allows the keypress to occur
						// which causes forms to submit
						suppressKeyPress = true;
						event.preventDefault();
						this.menu.select( event );
					}
					break;
				case keyCode.TAB:
					if ( this.menu.active ) {
						this.menu.select( event );
					}
					break;
				case keyCode.ESCAPE:
					if ( this.menu.element.is( ":visible" ) ) {
						if ( !this.isMultiLine ) {
							this._value( this.term );
						}
						this.close( event );
						// Different browsers have different default behavior for escape
						// Single press can mean undo or clear
						// Double press in IE means clear the whole form
						event.preventDefault();
					}
					break;
				default:
					suppressKeyPressRepeat = true;
					// search timeout should be triggered before the input value is changed
					this._searchTimeout( event );
					break;
				}
			},
			keypress: function( event ) {
				if ( suppressKeyPress ) {
					suppressKeyPress = false;
					if ( !this.isMultiLine || this.menu.element.is( ":visible" ) ) {
						event.preventDefault();
					}
					return;
				}
				if ( suppressKeyPressRepeat ) {
					return;
				}

				// replicate some key handlers to allow them to repeat in Firefox and Opera
				var keyCode = $.ui.keyCode;
				switch ( event.keyCode ) {
				case keyCode.PAGE_UP:
					this._move( "previousPage", event );
					break;
				case keyCode.PAGE_DOWN:
					this._move( "nextPage", event );
					break;
				case keyCode.UP:
					this._keyEvent( "previous", event );
					break;
				case keyCode.DOWN:
					this._keyEvent( "next", event );
					break;
				}
			},
			input: function( event ) {
				if ( suppressInput ) {
					suppressInput = false;
					event.preventDefault();
					return;
				}
				this._searchTimeout( event );
			},
			focus: function() {
				this.selectedItem = null;
				this.previous = this._value();
			},
			blur: function( event ) {
				if ( this.cancelBlur ) {
					delete this.cancelBlur;
					return;
				}

				clearTimeout( this.searching );
				this.close( event );
				this._change( event );
			}
		});

		this._initSource();
		this.menu = $( "<ul>" )
			.addClass( "ui-autocomplete ui-front" )
			.appendTo( this._appendTo() )
			.menu({
				// disable ARIA support, the live region takes care of that
				role: null
			})
			.hide()
			.menu( "instance" );

		this._on( this.menu.element, {
			mousedown: function( event ) {
				// prevent moving focus out of the text field
				event.preventDefault();

				// IE doesn't prevent moving focus even with event.preventDefault()
				// so we set a flag to know when we should ignore the blur event
				this.cancelBlur = true;
				this._delay(function() {
					delete this.cancelBlur;
				});

				// clicking on the scrollbar causes focus to shift to the body
				// but we can't detect a mouseup or a click immediately afterward
				// so we have to track the next mousedown and close the menu if
				// the user clicks somewhere outside of the autocomplete
				var menuElement = this.menu.element[ 0 ];
				if ( !$( event.target ).closest( ".ui-menu-item" ).length ) {
					this._delay(function() {
						var that = this;
						this.document.one( "mousedown", function( event ) {
							if ( event.target !== that.element[ 0 ] &&
									event.target !== menuElement &&
									!$.contains( menuElement, event.target ) ) {
								that.close();
							}
						});
					});
				}
			},
			menufocus: function( event, ui ) {
				var label, item;
				// support: Firefox
				// Prevent accidental activation of menu items in Firefox (#7024 #9118)
				if ( this.isNewMenu ) {
					this.isNewMenu = false;
					if ( event.originalEvent && /^mouse/.test( event.originalEvent.type ) ) {
						this.menu.blur();

						this.document.one( "mousemove", function() {
							$( event.target ).trigger( event.originalEvent );
						});

						return;
					}
				}

				item = ui.item.data( "ui-autocomplete-item" );
				if ( false !== this._trigger( "focus", event, { item: item } ) ) {
					// use value to match what will end up in the input, if it was a key event
					if ( event.originalEvent && /^key/.test( event.originalEvent.type ) ) {
						this._value( item.value );
					}
				}

				// Announce the value in the liveRegion
				label = ui.item.attr( "aria-label" ) || item.value;
				if ( label && $.trim( label ).length ) {
					this.liveRegion.children().hide();
					$( "<div>" ).text( label ).appendTo( this.liveRegion );
				}
			},
			menuselect: function( event, ui ) {
				var item = ui.item.data( "ui-autocomplete-item" ),
					previous = this.previous;

				// only trigger when focus was lost (click on menu)
				if ( this.element[ 0 ] !== this.document[ 0 ].activeElement ) {
					this.element.focus();
					this.previous = previous;
					// #6109 - IE triggers two focus events and the second
					// is asynchronous, so we need to reset the previous
					// term synchronously and asynchronously :-(
					this._delay(function() {
						this.previous = previous;
						this.selectedItem = item;
					});
				}

				if ( false !== this._trigger( "select", event, { item: item } ) ) {
					this._value( item.value );
				}
				// reset the term after the select event
				// this allows custom select handling to work properly
				this.term = this._value();

				this.close( event );
				this.selectedItem = item;
			}
		});

		this.liveRegion = $( "<span>", {
				role: "status",
				"aria-live": "assertive",
				"aria-relevant": "additions"
			})
			.addClass( "ui-helper-hidden-accessible" )
			.appendTo( this.document[ 0 ].body );

		// turning off autocomplete prevents the browser from remembering the
		// value when navigating through history, so we re-enable autocomplete
		// if the page is unloaded before the widget is destroyed. #7790
		this._on( this.window, {
			beforeunload: function() {
				this.element.removeAttr( "autocomplete" );
			}
		});
	},

	_destroy: function() {
		clearTimeout( this.searching );
		this.element
			.removeClass( "ui-autocomplete-input" )
			.removeAttr( "autocomplete" );
		this.menu.element.remove();
		this.liveRegion.remove();
	},

	_setOption: function( key, value ) {
		this._super( key, value );
		if ( key === "source" ) {
			this._initSource();
		}
		if ( key === "appendTo" ) {
			this.menu.element.appendTo( this._appendTo() );
		}
		if ( key === "disabled" && value && this.xhr ) {
			this.xhr.abort();
		}
	},

	_appendTo: function() {
		var element = this.options.appendTo;

		if ( element ) {
			element = element.jquery || element.nodeType ?
				$( element ) :
				this.document.find( element ).eq( 0 );
		}

		if ( !element || !element[ 0 ] ) {
			element = this.element.closest( ".ui-front" );
		}

		if ( !element.length ) {
			element = this.document[ 0 ].body;
		}

		return element;
	},

	_initSource: function() {
		var array, url,
			that = this;
		if ( $.isArray( this.options.source ) ) {
			array = this.options.source;
			this.source = function( request, response ) {
				response( $.ui.autocomplete.filter( array, request.term ) );
			};
		} else if ( typeof this.options.source === "string" ) {
			url = this.options.source;
			this.source = function( request, response ) {
				if ( that.xhr ) {
					that.xhr.abort();
				}
				that.xhr = $.ajax({
					url: url,
					data: request,
					dataType: "json",
					success: function( data ) {
						response( data );
					},
					error: function() {
						response([]);
					}
				});
			};
		} else {
			this.source = this.options.source;
		}
	},

	_searchTimeout: function( event ) {
		clearTimeout( this.searching );
		this.searching = this._delay(function() {

			// Search if the value has changed, or if the user retypes the same value (see #7434)
			var equalValues = this.term === this._value(),
				menuVisible = this.menu.element.is( ":visible" ),
				modifierKey = event.altKey || event.ctrlKey || event.metaKey || event.shiftKey;

			if ( !equalValues || ( equalValues && !menuVisible && !modifierKey ) ) {
				this.selectedItem = null;
				this.search( null, event );
			}
		}, this.options.delay );
	},

	search: function( value, event ) {
		value = value != null ? value : this._value();

		// always save the actual value, not the one passed as an argument
		this.term = this._value();

		if ( value.length < this.options.minLength ) {
			return this.close( event );
		}

		if ( this._trigger( "search", event ) === false ) {
			return;
		}

		return this._search( value );
	},

	_search: function( value ) {
		this.pending++;
		this.element.addClass( "ui-autocomplete-loading" );
		this.cancelSearch = false;

		this.source( { term: value }, this._response() );
	},

	_response: function() {
		var index = ++this.requestIndex;

		return $.proxy(function( content ) {
			if ( index === this.requestIndex ) {
				this.__response( content );
			}

			this.pending--;
			if ( !this.pending ) {
				this.element.removeClass( "ui-autocomplete-loading" );
			}
		}, this );
	},

	__response: function( content ) {
		if ( content ) {
			content = this._normalize( content );
		}
		this._trigger( "response", null, { content: content } );
		if ( !this.options.disabled && content && content.length && !this.cancelSearch ) {
			this._suggest( content );
			this._trigger( "open" );
		} else {
			// use ._close() instead of .close() so we don't cancel future searches
			this._close();
		}
	},

	close: function( event ) {
		this.cancelSearch = true;
		this._close( event );
	},

	_close: function( event ) {
		if ( this.menu.element.is( ":visible" ) ) {
			this.menu.element.hide();
			this.menu.blur();
			this.isNewMenu = true;
			this._trigger( "close", event );
		}
	},

	_change: function( event ) {
		if ( this.previous !== this._value() ) {
			this._trigger( "change", event, { item: this.selectedItem } );
		}
	},

	_normalize: function( items ) {
		// assume all items have the right format when the first item is complete
		if ( items.length && items[ 0 ].label && items[ 0 ].value ) {
			return items;
		}
		return $.map( items, function( item ) {
			if ( typeof item === "string" ) {
				return {
					label: item,
					value: item
				};
			}
			return $.extend( {}, item, {
				label: item.label || item.value,
				value: item.value || item.label
			});
		});
	},

	_suggest: function( items ) {
		var ul = this.menu.element.empty();
		this._renderMenu( ul, items );
		this.isNewMenu = true;
		this.menu.refresh();

		// size and position menu
		ul.show();
		this._resizeMenu();
		ul.position( $.extend({
			of: this.element
		}, this.options.position ) );

		if ( this.options.autoFocus ) {
			this.menu.next();
		}
	},

	_resizeMenu: function() {
		var ul = this.menu.element;
		ul.outerWidth( Math.max(
			// Firefox wraps long text (possibly a rounding bug)
			// so we add 1px to avoid the wrapping (#7513)
			ul.width( "" ).outerWidth() + 1,
			this.element.outerWidth()
		) );
	},

	_renderMenu: function( ul, items ) {
		var that = this;
		$.each( items, function( index, item ) {
			that._renderItemData( ul, item );
		});
	},

	_renderItemData: function( ul, item ) {
		return this._renderItem( ul, item ).data( "ui-autocomplete-item", item );
	},

	_renderItem: function( ul, item ) {
		return $( "<li>" ).text( item.label ).appendTo( ul );
	},

	_move: function( direction, event ) {
		if ( !this.menu.element.is( ":visible" ) ) {
			this.search( null, event );
			return;
		}
		if ( this.menu.isFirstItem() && /^previous/.test( direction ) ||
				this.menu.isLastItem() && /^next/.test( direction ) ) {

			if ( !this.isMultiLine ) {
				this._value( this.term );
			}

			this.menu.blur();
			return;
		}
		this.menu[ direction ]( event );
	},

	widget: function() {
		return this.menu.element;
	},

	_value: function() {
		return this.valueMethod.apply( this.element, arguments );
	},

	_keyEvent: function( keyEvent, event ) {
		if ( !this.isMultiLine || this.menu.element.is( ":visible" ) ) {
			this._move( keyEvent, event );

			// prevents moving cursor to beginning/end of the text field in some browsers
			event.preventDefault();
		}
	}
});

$.extend( $.ui.autocomplete, {
	escapeRegex: function( value ) {
		return value.replace( /[\-\[\]{}()*+?.,\\\^$|#\s]/g, "\\$&" );
	},
	filter: function( array, term ) {
		var matcher = new RegExp( $.ui.autocomplete.escapeRegex( term ), "i" );
		return $.grep( array, function( value ) {
			return matcher.test( value.label || value.value || value );
		});
	}
});

// live region extension, adding a `messages` option
// NOTE: This is an experimental API. We are still investigating
// a full solution for string manipulation and internationalization.
$.widget( "ui.autocomplete", $.ui.autocomplete, {
	options: {
		messages: {
			noResults: "No search results.",
			results: function( amount ) {
				return amount + ( amount > 1 ? " results are" : " result is" ) +
					" available, use up and down arrow keys to navigate.";
			}
		}
	},

	__response: function( content ) {
		var message;
		this._superApply( arguments );
		if ( this.options.disabled || this.cancelSearch ) {
			return;
		}
		if ( content && content.length ) {
			message = this.options.messages.results( content.length );
		} else {
			message = this.options.messages.noResults;
		}
		this.liveRegion.children().hide();
		$( "<div>" ).text( message ).appendTo( this.liveRegion );
	}
});

var autocomplete = $.ui.autocomplete;


/*!
 * jQuery UI Button 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/button/
 */


var lastActive,
	baseClasses = "ui-button ui-widget ui-state-default ui-corner-all",
	typeClasses = "ui-button-icons-only ui-button-icon-only ui-button-text-icons ui-button-text-icon-primary ui-button-text-icon-secondary ui-button-text-only",
	formResetHandler = function() {
		var form = $( this );
		setTimeout(function() {
			form.find( ":ui-button" ).button( "refresh" );
		}, 1 );
	},
	radioGroup = function( radio ) {
		var name = radio.name,
			form = radio.form,
			radios = $( [] );
		if ( name ) {
			name = name.replace( /'/g, "\\'" );
			if ( form ) {
				radios = $( form ).find( "[name='" + name + "'][type=radio]" );
			} else {
				radios = $( "[name='" + name + "'][type=radio]", radio.ownerDocument )
					.filter(function() {
						return !this.form;
					});
			}
		}
		return radios;
	};

$.widget( "ui.button", {
	version: "1.11.4",
	defaultElement: "<button>",
	options: {
		disabled: null,
		text: true,
		label: null,
		icons: {
			primary: null,
			secondary: null
		}
	},
	_create: function() {
		this.element.closest( "form" )
			.unbind( "reset" + this.eventNamespace )
			.bind( "reset" + this.eventNamespace, formResetHandler );

		if ( typeof this.options.disabled !== "boolean" ) {
			this.options.disabled = !!this.element.prop( "disabled" );
		} else {
			this.element.prop( "disabled", this.options.disabled );
		}

		this._determineButtonType();
		this.hasTitle = !!this.buttonElement.attr( "title" );

		var that = this,
			options = this.options,
			toggleButton = this.type === "checkbox" || this.type === "radio",
			activeClass = !toggleButton ? "ui-state-active" : "";

		if ( options.label === null ) {
			options.label = (this.type === "input" ? this.buttonElement.val() : this.buttonElement.html());
		}

		this._hoverable( this.buttonElement );

		this.buttonElement
			.addClass( baseClasses )
			.attr( "role", "button" )
			.bind( "mouseenter" + this.eventNamespace, function() {
				if ( options.disabled ) {
					return;
				}
				if ( this === lastActive ) {
					$( this ).addClass( "ui-state-active" );
				}
			})
			.bind( "mouseleave" + this.eventNamespace, function() {
				if ( options.disabled ) {
					return;
				}
				$( this ).removeClass( activeClass );
			})
			.bind( "click" + this.eventNamespace, function( event ) {
				if ( options.disabled ) {
					event.preventDefault();
					event.stopImmediatePropagation();
				}
			});

		// Can't use _focusable() because the element that receives focus
		// and the element that gets the ui-state-focus class are different
		this._on({
			focus: function() {
				this.buttonElement.addClass( "ui-state-focus" );
			},
			blur: function() {
				this.buttonElement.removeClass( "ui-state-focus" );
			}
		});

		if ( toggleButton ) {
			this.element.bind( "change" + this.eventNamespace, function() {
				that.refresh();
			});
		}

		if ( this.type === "checkbox" ) {
			this.buttonElement.bind( "click" + this.eventNamespace, function() {
				if ( options.disabled ) {
					return false;
				}
			});
		} else if ( this.type === "radio" ) {
			this.buttonElement.bind( "click" + this.eventNamespace, function() {
				if ( options.disabled ) {
					return false;
				}
				$( this ).addClass( "ui-state-active" );
				that.buttonElement.attr( "aria-pressed", "true" );

				var radio = that.element[ 0 ];
				radioGroup( radio )
					.not( radio )
					.map(function() {
						return $( this ).button( "widget" )[ 0 ];
					})
					.removeClass( "ui-state-active" )
					.attr( "aria-pressed", "false" );
			});
		} else {
			this.buttonElement
				.bind( "mousedown" + this.eventNamespace, function() {
					if ( options.disabled ) {
						return false;
					}
					$( this ).addClass( "ui-state-active" );
					lastActive = this;
					that.document.one( "mouseup", function() {
						lastActive = null;
					});
				})
				.bind( "mouseup" + this.eventNamespace, function() {
					if ( options.disabled ) {
						return false;
					}
					$( this ).removeClass( "ui-state-active" );
				})
				.bind( "keydown" + this.eventNamespace, function(event) {
					if ( options.disabled ) {
						return false;
					}
					if ( event.keyCode === $.ui.keyCode.SPACE || event.keyCode === $.ui.keyCode.ENTER ) {
						$( this ).addClass( "ui-state-active" );
					}
				})
				// see #8559, we bind to blur here in case the button element loses
				// focus between keydown and keyup, it would be left in an "active" state
				.bind( "keyup" + this.eventNamespace + " blur" + this.eventNamespace, function() {
					$( this ).removeClass( "ui-state-active" );
				});

			if ( this.buttonElement.is("a") ) {
				this.buttonElement.keyup(function(event) {
					if ( event.keyCode === $.ui.keyCode.SPACE ) {
						// TODO pass through original event correctly (just as 2nd argument doesn't work)
						$( this ).click();
					}
				});
			}
		}

		this._setOption( "disabled", options.disabled );
		this._resetButton();
	},

	_determineButtonType: function() {
		var ancestor, labelSelector, checked;

		if ( this.element.is("[type=checkbox]") ) {
			this.type = "checkbox";
		} else if ( this.element.is("[type=radio]") ) {
			this.type = "radio";
		} else if ( this.element.is("input") ) {
			this.type = "input";
		} else {
			this.type = "button";
		}

		if ( this.type === "checkbox" || this.type === "radio" ) {
			// we don't search against the document in case the element
			// is disconnected from the DOM
			ancestor = this.element.parents().last();
			labelSelector = "label[for='" + this.element.attr("id") + "']";
			this.buttonElement = ancestor.find( labelSelector );
			if ( !this.buttonElement.length ) {
				ancestor = ancestor.length ? ancestor.siblings() : this.element.siblings();
				this.buttonElement = ancestor.filter( labelSelector );
				if ( !this.buttonElement.length ) {
					this.buttonElement = ancestor.find( labelSelector );
				}
			}
			this.element.addClass( "ui-helper-hidden-accessible" );

			checked = this.element.is( ":checked" );
			if ( checked ) {
				this.buttonElement.addClass( "ui-state-active" );
			}
			this.buttonElement.prop( "aria-pressed", checked );
		} else {
			this.buttonElement = this.element;
		}
	},

	widget: function() {
		return this.buttonElement;
	},

	_destroy: function() {
		this.element
			.removeClass( "ui-helper-hidden-accessible" );
		this.buttonElement
			.removeClass( baseClasses + " ui-state-active " + typeClasses )
			.removeAttr( "role" )
			.removeAttr( "aria-pressed" )
			.html( this.buttonElement.find(".ui-button-text").html() );

		if ( !this.hasTitle ) {
			this.buttonElement.removeAttr( "title" );
		}
	},

	_setOption: function( key, value ) {
		this._super( key, value );
		if ( key === "disabled" ) {
			this.widget().toggleClass( "ui-state-disabled", !!value );
			this.element.prop( "disabled", !!value );
			if ( value ) {
				if ( this.type === "checkbox" || this.type === "radio" ) {
					this.buttonElement.removeClass( "ui-state-focus" );
				} else {
					this.buttonElement.removeClass( "ui-state-focus ui-state-active" );
				}
			}
			return;
		}
		this._resetButton();
	},

	refresh: function() {
		//See #8237 & #8828
		var isDisabled = this.element.is( "input, button" ) ? this.element.is( ":disabled" ) : this.element.hasClass( "ui-button-disabled" );

		if ( isDisabled !== this.options.disabled ) {
			this._setOption( "disabled", isDisabled );
		}
		if ( this.type === "radio" ) {
			radioGroup( this.element[0] ).each(function() {
				if ( $( this ).is( ":checked" ) ) {
					$( this ).button( "widget" )
						.addClass( "ui-state-active" )
						.attr( "aria-pressed", "true" );
				} else {
					$( this ).button( "widget" )
						.removeClass( "ui-state-active" )
						.attr( "aria-pressed", "false" );
				}
			});
		} else if ( this.type === "checkbox" ) {
			if ( this.element.is( ":checked" ) ) {
				this.buttonElement
					.addClass( "ui-state-active" )
					.attr( "aria-pressed", "true" );
			} else {
				this.buttonElement
					.removeClass( "ui-state-active" )
					.attr( "aria-pressed", "false" );
			}
		}
	},

	_resetButton: function() {
		if ( this.type === "input" ) {
			if ( this.options.label ) {
				this.element.val( this.options.label );
			}
			return;
		}
		var buttonElement = this.buttonElement.removeClass( typeClasses ),
			buttonText = $( "<span></span>", this.document[0] )
				.addClass( "ui-button-text" )
				.html( this.options.label )
				.appendTo( buttonElement.empty() )
				.text(),
			icons = this.options.icons,
			multipleIcons = icons.primary && icons.secondary,
			buttonClasses = [];

		if ( icons.primary || icons.secondary ) {
			if ( this.options.text ) {
				buttonClasses.push( "ui-button-text-icon" + ( multipleIcons ? "s" : ( icons.primary ? "-primary" : "-secondary" ) ) );
			}

			if ( icons.primary ) {
				buttonElement.prepend( "<span class='ui-button-icon-primary ui-icon " + icons.primary + "'></span>" );
			}

			if ( icons.secondary ) {
				buttonElement.append( "<span class='ui-button-icon-secondary ui-icon " + icons.secondary + "'></span>" );
			}

			if ( !this.options.text ) {
				buttonClasses.push( multipleIcons ? "ui-button-icons-only" : "ui-button-icon-only" );

				if ( !this.hasTitle ) {
					buttonElement.attr( "title", $.trim( buttonText ) );
				}
			}
		} else {
			buttonClasses.push( "ui-button-text-only" );
		}
		buttonElement.addClass( buttonClasses.join( " " ) );
	}
});

$.widget( "ui.buttonset", {
	version: "1.11.4",
	options: {
		items: "button, input[type=button], input[type=submit], input[type=reset], input[type=checkbox], input[type=radio], a, :data(ui-button)"
	},

	_create: function() {
		this.element.addClass( "ui-buttonset" );
	},

	_init: function() {
		this.refresh();
	},

	_setOption: function( key, value ) {
		if ( key === "disabled" ) {
			this.buttons.button( "option", key, value );
		}

		this._super( key, value );
	},

	refresh: function() {
		var rtl = this.element.css( "direction" ) === "rtl",
			allButtons = this.element.find( this.options.items ),
			existingButtons = allButtons.filter( ":ui-button" );

		// Initialize new buttons
		allButtons.not( ":ui-button" ).button();

		// Refresh existing buttons
		existingButtons.button( "refresh" );

		this.buttons = allButtons
			.map(function() {
				return $( this ).button( "widget" )[ 0 ];
			})
				.removeClass( "ui-corner-all ui-corner-left ui-corner-right" )
				.filter( ":first" )
					.addClass( rtl ? "ui-corner-right" : "ui-corner-left" )
				.end()
				.filter( ":last" )
					.addClass( rtl ? "ui-corner-left" : "ui-corner-right" )
				.end()
			.end();
	},

	_destroy: function() {
		this.element.removeClass( "ui-buttonset" );
		this.buttons
			.map(function() {
				return $( this ).button( "widget" )[ 0 ];
			})
				.removeClass( "ui-corner-left ui-corner-right" )
			.end()
			.button( "destroy" );
	}
});

var button = $.ui.button;


/*!
 * jQuery UI Datepicker 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/datepicker/
 */


$.extend($.ui, { datepicker: { version: "1.11.4" } });

var datepicker_instActive;

function datepicker_getZindex( elem ) {
	var position, value;
	while ( elem.length && elem[ 0 ] !== document ) {
		// Ignore z-index if position is set to a value where z-index is ignored by the browser
		// This makes behavior of this function consistent across browsers
		// WebKit always returns auto if the element is positioned
		position = elem.css( "position" );
		if ( position === "absolute" || position === "relative" || position === "fixed" ) {
			// IE returns 0 when zIndex is not specified
			// other browsers return a string
			// we ignore the case of nested elements with an explicit value of 0
			// <div style="z-index: -10;"><div style="z-index: 0;"></div></div>
			value = parseInt( elem.css( "zIndex" ), 10 );
			if ( !isNaN( value ) && value !== 0 ) {
				return value;
			}
		}
		elem = elem.parent();
	}

	return 0;
}
/* Date picker manager.
   Use the singleton instance of this class, $.datepicker, to interact with the date picker.
   Settings for (groups of) date pickers are maintained in an instance object,
   allowing multiple different settings on the same page. */

function Datepicker() {
	this._curInst = null; // The current instance in use
	this._keyEvent = false; // If the last event was a key event
	this._disabledInputs = []; // List of date picker inputs that have been disabled
	this._datepickerShowing = false; // True if the popup picker is showing , false if not
	this._inDialog = false; // True if showing within a "dialog", false if not
	this._mainDivId = "ui-datepicker-div"; // The ID of the main datepicker division
	this._inlineClass = "ui-datepicker-inline"; // The name of the inline marker class
	this._appendClass = "ui-datepicker-append"; // The name of the append marker class
	this._triggerClass = "ui-datepicker-trigger"; // The name of the trigger marker class
	this._dialogClass = "ui-datepicker-dialog"; // The name of the dialog marker class
	this._disableClass = "ui-datepicker-disabled"; // The name of the disabled covering marker class
	this._unselectableClass = "ui-datepicker-unselectable"; // The name of the unselectable cell marker class
	this._currentClass = "ui-datepicker-current-day"; // The name of the current day marker class
	this._dayOverClass = "ui-datepicker-days-cell-over"; // The name of the day hover marker class
	this.regional = []; // Available regional settings, indexed by language code
	this.regional[""] = { // Default regional settings
		closeText: "Done", // Display text for close link
		prevText: "Prev", // Display text for previous month link
		nextText: "Next", // Display text for next month link
		currentText: "Today", // Display text for current month link
		monthNames: ["January","February","March","April","May","June",
			"July","August","September","October","November","December"], // Names of months for drop-down and formatting
		monthNamesShort: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"], // For formatting
		dayNames: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"], // For formatting
		dayNamesShort: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"], // For formatting
		dayNamesMin: ["Su","Mo","Tu","We","Th","Fr","Sa"], // Column headings for days starting at Sunday
		weekHeader: "Wk", // Column header for week of the year
		dateFormat: "mm/dd/yy", // See format options on parseDate
		firstDay: 0, // The first day of the week, Sun = 0, Mon = 1, ...
		isRTL: false, // True if right-to-left language, false if left-to-right
		showMonthAfterYear: false, // True if the year select precedes month, false for month then year
		yearSuffix: "" // Additional text to append to the year in the month headers
	};
	this._defaults = { // Global defaults for all the date picker instances
		showOn: "focus", // "focus" for popup on focus,
			// "button" for trigger button, or "both" for either
		showAnim: "fadeIn", // Name of jQuery animation for popup
		showOptions: {}, // Options for enhanced animations
		defaultDate: null, // Used when field is blank: actual date,
			// +/-number for offset from today, null for today
		appendText: "", // Display text following the input box, e.g. showing the format
		buttonText: "...", // Text for trigger button
		buttonImage: "", // URL for trigger button image
		buttonImageOnly: false, // True if the image appears alone, false if it appears on a button
		hideIfNoPrevNext: false, // True to hide next/previous month links
			// if not applicable, false to just disable them
		navigationAsDateFormat: false, // True if date formatting applied to prev/today/next links
		gotoCurrent: false, // True if today link goes back to current selection instead
		changeMonth: false, // True if month can be selected directly, false if only prev/next
		changeYear: false, // True if year can be selected directly, false if only prev/next
		yearRange: "c-10:c+10", // Range of years to display in drop-down,
			// either relative to today's year (-nn:+nn), relative to currently displayed year
			// (c-nn:c+nn), absolute (nnnn:nnnn), or a combination of the above (nnnn:-n)
		showOtherMonths: false, // True to show dates in other months, false to leave blank
		selectOtherMonths: false, // True to allow selection of dates in other months, false for unselectable
		showWeek: false, // True to show week of the year, false to not show it
		calculateWeek: this.iso8601Week, // How to calculate the week of the year,
			// takes a Date and returns the number of the week for it
		shortYearCutoff: "+10", // Short year values < this are in the current century,
			// > this are in the previous century,
			// string value starting with "+" for current year + value
		minDate: null, // The earliest selectable date, or null for no limit
		maxDate: null, // The latest selectable date, or null for no limit
		duration: "fast", // Duration of display/closure
		beforeShowDay: null, // Function that takes a date and returns an array with
			// [0] = true if selectable, false if not, [1] = custom CSS class name(s) or "",
			// [2] = cell title (optional), e.g. $.datepicker.noWeekends
		beforeShow: null, // Function that takes an input field and
			// returns a set of custom settings for the date picker
		onSelect: null, // Define a callback function when a date is selected
		onChangeMonthYear: null, // Define a callback function when the month or year is changed
		onClose: null, // Define a callback function when the datepicker is closed
		numberOfMonths: 1, // Number of months to show at a time
		showCurrentAtPos: 0, // The position in multipe months at which to show the current month (starting at 0)
		stepMonths: 1, // Number of months to step back/forward
		stepBigMonths: 12, // Number of months to step back/forward for the big links
		altField: "", // Selector for an alternate field to store selected dates into
		altFormat: "", // The date format to use for the alternate field
		constrainInput: true, // The input is constrained by the current date format
		showButtonPanel: false, // True to show button panel, false to not show it
		autoSize: false, // True to size the input for the date format, false to leave as is
		disabled: false // The initial disabled state
	};
	$.extend(this._defaults, this.regional[""]);
	this.regional.en = $.extend( true, {}, this.regional[ "" ]);
	this.regional[ "en-US" ] = $.extend( true, {}, this.regional.en );
	this.dpDiv = datepicker_bindHover($("<div id='" + this._mainDivId + "' class='ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all'></div>"));
}

$.extend(Datepicker.prototype, {
	/* Class name added to elements to indicate already configured with a date picker. */
	markerClassName: "hasDatepicker",

	//Keep track of the maximum number of rows displayed (see #7043)
	maxRows: 4,

	// TODO rename to "widget" when switching to widget factory
	_widgetDatepicker: function() {
		return this.dpDiv;
	},

	/* Override the default settings for all instances of the date picker.
	 * @param  settings  object - the new settings to use as defaults (anonymous object)
	 * @return the manager object
	 */
	setDefaults: function(settings) {
		datepicker_extendRemove(this._defaults, settings || {});
		return this;
	},

	/* Attach the date picker to a jQuery selection.
	 * @param  target	element - the target input field or division or span
	 * @param  settings  object - the new settings to use for this date picker instance (anonymous)
	 */
	_attachDatepicker: function(target, settings) {
		var nodeName, inline, inst;
		nodeName = target.nodeName.toLowerCase();
		inline = (nodeName === "div" || nodeName === "span");
		if (!target.id) {
			this.uuid += 1;
			target.id = "dp" + this.uuid;
		}
		inst = this._newInst($(target), inline);
		inst.settings = $.extend({}, settings || {});
		if (nodeName === "input") {
			this._connectDatepicker(target, inst);
		} else if (inline) {
			this._inlineDatepicker(target, inst);
		}
	},

	/* Create a new instance object. */
	_newInst: function(target, inline) {
		var id = target[0].id.replace(/([^A-Za-z0-9_\-])/g, "\\\\$1"); // escape jQuery meta chars
		return {id: id, input: target, // associated target
			selectedDay: 0, selectedMonth: 0, selectedYear: 0, // current selection
			drawMonth: 0, drawYear: 0, // month being drawn
			inline: inline, // is datepicker inline or not
			dpDiv: (!inline ? this.dpDiv : // presentation div
			datepicker_bindHover($("<div class='" + this._inlineClass + " ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all'></div>")))};
	},

	/* Attach the date picker to an input field. */
	_connectDatepicker: function(target, inst) {
		var input = $(target);
		inst.append = $([]);
		inst.trigger = $([]);
		if (input.hasClass(this.markerClassName)) {
			return;
		}
		this._attachments(input, inst);
		input.addClass(this.markerClassName).keydown(this._doKeyDown).
			keypress(this._doKeyPress).keyup(this._doKeyUp);
		this._autoSize(inst);
		$.data(target, "datepicker", inst);
		//If disabled option is true, disable the datepicker once it has been attached to the input (see ticket #5665)
		if( inst.settings.disabled ) {
			this._disableDatepicker( target );
		}
	},

	/* Make attachments based on settings. */
	_attachments: function(input, inst) {
		var showOn, buttonText, buttonImage,
			appendText = this._get(inst, "appendText"),
			isRTL = this._get(inst, "isRTL");

		if (inst.append) {
			inst.append.remove();
		}
		if (appendText) {
			inst.append = $("<span class='" + this._appendClass + "'>" + appendText + "</span>");
			input[isRTL ? "before" : "after"](inst.append);
		}

		input.unbind("focus", this._showDatepicker);

		if (inst.trigger) {
			inst.trigger.remove();
		}

		showOn = this._get(inst, "showOn");
		if (showOn === "focus" || showOn === "both") { // pop-up date picker when in the marked field
			input.focus(this._showDatepicker);
		}
		if (showOn === "button" || showOn === "both") { // pop-up date picker when button clicked
			buttonText = this._get(inst, "buttonText");
			buttonImage = this._get(inst, "buttonImage");
			inst.trigger = $(this._get(inst, "buttonImageOnly") ?
				$("<img/>").addClass(this._triggerClass).
					attr({ src: buttonImage, alt: buttonText, title: buttonText }) :
				$("<button type='button'></button>").addClass(this._triggerClass).
					html(!buttonImage ? buttonText : $("<img/>").attr(
					{ src:buttonImage, alt:buttonText, title:buttonText })));
			input[isRTL ? "before" : "after"](inst.trigger);
			inst.trigger.click(function() {
				if ($.datepicker._datepickerShowing && $.datepicker._lastInput === input[0]) {
					$.datepicker._hideDatepicker();
				} else if ($.datepicker._datepickerShowing && $.datepicker._lastInput !== input[0]) {
					$.datepicker._hideDatepicker();
					$.datepicker._showDatepicker(input[0]);
				} else {
					$.datepicker._showDatepicker(input[0]);
				}
				return false;
			});
		}
	},

	/* Apply the maximum length for the date format. */
	_autoSize: function(inst) {
		if (this._get(inst, "autoSize") && !inst.inline) {
			var findMax, max, maxI, i,
				date = new Date(2009, 12 - 1, 20), // Ensure double digits
				dateFormat = this._get(inst, "dateFormat");

			if (dateFormat.match(/[DM]/)) {
				findMax = function(names) {
					max = 0;
					maxI = 0;
					for (i = 0; i < names.length; i++) {
						if (names[i].length > max) {
							max = names[i].length;
							maxI = i;
						}
					}
					return maxI;
				};
				date.setMonth(findMax(this._get(inst, (dateFormat.match(/MM/) ?
					"monthNames" : "monthNamesShort"))));
				date.setDate(findMax(this._get(inst, (dateFormat.match(/DD/) ?
					"dayNames" : "dayNamesShort"))) + 20 - date.getDay());
			}
			inst.input.attr("size", this._formatDate(inst, date).length);
		}
	},

	/* Attach an inline date picker to a div. */
	_inlineDatepicker: function(target, inst) {
		var divSpan = $(target);
		if (divSpan.hasClass(this.markerClassName)) {
			return;
		}
		divSpan.addClass(this.markerClassName).append(inst.dpDiv);
		$.data(target, "datepicker", inst);
		this._setDate(inst, this._getDefaultDate(inst), true);
		this._updateDatepicker(inst);
		this._updateAlternate(inst);
		//If disabled option is true, disable the datepicker before showing it (see ticket #5665)
		if( inst.settings.disabled ) {
			this._disableDatepicker( target );
		}
		// Set display:block in place of inst.dpDiv.show() which won't work on disconnected elements
		// http://bugs.jqueryui.com/ticket/7552 - A Datepicker created on a detached div has zero height
		inst.dpDiv.css( "display", "block" );
	},

	/* Pop-up the date picker in a "dialog" box.
	 * @param  input element - ignored
	 * @param  date	string or Date - the initial date to display
	 * @param  onSelect  function - the function to call when a date is selected
	 * @param  settings  object - update the dialog date picker instance's settings (anonymous object)
	 * @param  pos int[2] - coordinates for the dialog's position within the screen or
	 *					event - with x/y coordinates or
	 *					leave empty for default (screen centre)
	 * @return the manager object
	 */
	_dialogDatepicker: function(input, date, onSelect, settings, pos) {
		var id, browserWidth, browserHeight, scrollX, scrollY,
			inst = this._dialogInst; // internal instance

		if (!inst) {
			this.uuid += 1;
			id = "dp" + this.uuid;
			this._dialogInput = $("<input type='text' id='" + id +
				"' style='position: absolute; top: -100px; width: 0px;'/>");
			this._dialogInput.keydown(this._doKeyDown);
			$("body").append(this._dialogInput);
			inst = this._dialogInst = this._newInst(this._dialogInput, false);
			inst.settings = {};
			$.data(this._dialogInput[0], "datepicker", inst);
		}
		datepicker_extendRemove(inst.settings, settings || {});
		date = (date && date.constructor === Date ? this._formatDate(inst, date) : date);
		this._dialogInput.val(date);

		this._pos = (pos ? (pos.length ? pos : [pos.pageX, pos.pageY]) : null);
		if (!this._pos) {
			browserWidth = document.documentElement.clientWidth;
			browserHeight = document.documentElement.clientHeight;
			scrollX = document.documentElement.scrollLeft || document.body.scrollLeft;
			scrollY = document.documentElement.scrollTop || document.body.scrollTop;
			this._pos = // should use actual width/height below
				[(browserWidth / 2) - 100 + scrollX, (browserHeight / 2) - 150 + scrollY];
		}

		// move input on screen for focus, but hidden behind dialog
		this._dialogInput.css("left", (this._pos[0] + 20) + "px").css("top", this._pos[1] + "px");
		inst.settings.onSelect = onSelect;
		this._inDialog = true;
		this.dpDiv.addClass(this._dialogClass);
		this._showDatepicker(this._dialogInput[0]);
		if ($.blockUI) {
			$.blockUI(this.dpDiv);
		}
		$.data(this._dialogInput[0], "datepicker", inst);
		return this;
	},

	/* Detach a datepicker from its control.
	 * @param  target	element - the target input field or division or span
	 */
	_destroyDatepicker: function(target) {
		var nodeName,
			$target = $(target),
			inst = $.data(target, "datepicker");

		if (!$target.hasClass(this.markerClassName)) {
			return;
		}

		nodeName = target.nodeName.toLowerCase();
		$.removeData(target, "datepicker");
		if (nodeName === "input") {
			inst.append.remove();
			inst.trigger.remove();
			$target.removeClass(this.markerClassName).
				unbind("focus", this._showDatepicker).
				unbind("keydown", this._doKeyDown).
				unbind("keypress", this._doKeyPress).
				unbind("keyup", this._doKeyUp);
		} else if (nodeName === "div" || nodeName === "span") {
			$target.removeClass(this.markerClassName).empty();
		}

		if ( datepicker_instActive === inst ) {
			datepicker_instActive = null;
		}
	},

	/* Enable the date picker to a jQuery selection.
	 * @param  target	element - the target input field or division or span
	 */
	_enableDatepicker: function(target) {
		var nodeName, inline,
			$target = $(target),
			inst = $.data(target, "datepicker");

		if (!$target.hasClass(this.markerClassName)) {
			return;
		}

		nodeName = target.nodeName.toLowerCase();
		if (nodeName === "input") {
			target.disabled = false;
			inst.trigger.filter("button").
				each(function() { this.disabled = false; }).end().
				filter("img").css({opacity: "1.0", cursor: ""});
		} else if (nodeName === "div" || nodeName === "span") {
			inline = $target.children("." + this._inlineClass);
			inline.children().removeClass("ui-state-disabled");
			inline.find("select.ui-datepicker-month, select.ui-datepicker-year").
				prop("disabled", false);
		}
		this._disabledInputs = $.map(this._disabledInputs,
			function(value) { return (value === target ? null : value); }); // delete entry
	},

	/* Disable the date picker to a jQuery selection.
	 * @param  target	element - the target input field or division or span
	 */
	_disableDatepicker: function(target) {
		var nodeName, inline,
			$target = $(target),
			inst = $.data(target, "datepicker");

		if (!$target.hasClass(this.markerClassName)) {
			return;
		}

		nodeName = target.nodeName.toLowerCase();
		if (nodeName === "input") {
			target.disabled = true;
			inst.trigger.filter("button").
				each(function() { this.disabled = true; }).end().
				filter("img").css({opacity: "0.5", cursor: "default"});
		} else if (nodeName === "div" || nodeName === "span") {
			inline = $target.children("." + this._inlineClass);
			inline.children().addClass("ui-state-disabled");
			inline.find("select.ui-datepicker-month, select.ui-datepicker-year").
				prop("disabled", true);
		}
		this._disabledInputs = $.map(this._disabledInputs,
			function(value) { return (value === target ? null : value); }); // delete entry
		this._disabledInputs[this._disabledInputs.length] = target;
	},

	/* Is the first field in a jQuery collection disabled as a datepicker?
	 * @param  target	element - the target input field or division or span
	 * @return boolean - true if disabled, false if enabled
	 */
	_isDisabledDatepicker: function(target) {
		if (!target) {
			return false;
		}
		for (var i = 0; i < this._disabledInputs.length; i++) {
			if (this._disabledInputs[i] === target) {
				return true;
			}
		}
		return false;
	},

	/* Retrieve the instance data for the target control.
	 * @param  target  element - the target input field or division or span
	 * @return  object - the associated instance data
	 * @throws  error if a jQuery problem getting data
	 */
	_getInst: function(target) {
		try {
			return $.data(target, "datepicker");
		}
		catch (err) {
			throw "Missing instance data for this datepicker";
		}
	},

	/* Update or retrieve the settings for a date picker attached to an input field or division.
	 * @param  target  element - the target input field or division or span
	 * @param  name	object - the new settings to update or
	 *				string - the name of the setting to change or retrieve,
	 *				when retrieving also "all" for all instance settings or
	 *				"defaults" for all global defaults
	 * @param  value   any - the new value for the setting
	 *				(omit if above is an object or to retrieve a value)
	 */
	_optionDatepicker: function(target, name, value) {
		var settings, date, minDate, maxDate,
			inst = this._getInst(target);

		if (arguments.length === 2 && typeof name === "string") {
			return (name === "defaults" ? $.extend({}, $.datepicker._defaults) :
				(inst ? (name === "all" ? $.extend({}, inst.settings) :
				this._get(inst, name)) : null));
		}

		settings = name || {};
		if (typeof name === "string") {
			settings = {};
			settings[name] = value;
		}

		if (inst) {
			if (this._curInst === inst) {
				this._hideDatepicker();
			}

			date = this._getDateDatepicker(target, true);
			minDate = this._getMinMaxDate(inst, "min");
			maxDate = this._getMinMaxDate(inst, "max");
			datepicker_extendRemove(inst.settings, settings);
			// reformat the old minDate/maxDate values if dateFormat changes and a new minDate/maxDate isn't provided
			if (minDate !== null && settings.dateFormat !== undefined && settings.minDate === undefined) {
				inst.settings.minDate = this._formatDate(inst, minDate);
			}
			if (maxDate !== null && settings.dateFormat !== undefined && settings.maxDate === undefined) {
				inst.settings.maxDate = this._formatDate(inst, maxDate);
			}
			if ( "disabled" in settings ) {
				if ( settings.disabled ) {
					this._disableDatepicker(target);
				} else {
					this._enableDatepicker(target);
				}
			}
			this._attachments($(target), inst);
			this._autoSize(inst);
			this._setDate(inst, date);
			this._updateAlternate(inst);
			this._updateDatepicker(inst);
		}
	},

	// change method deprecated
	_changeDatepicker: function(target, name, value) {
		this._optionDatepicker(target, name, value);
	},

	/* Redraw the date picker attached to an input field or division.
	 * @param  target  element - the target input field or division or span
	 */
	_refreshDatepicker: function(target) {
		var inst = this._getInst(target);
		if (inst) {
			this._updateDatepicker(inst);
		}
	},

	/* Set the dates for a jQuery selection.
	 * @param  target element - the target input field or division or span
	 * @param  date	Date - the new date
	 */
	_setDateDatepicker: function(target, date) {
		var inst = this._getInst(target);
		if (inst) {
			this._setDate(inst, date);
			this._updateDatepicker(inst);
			this._updateAlternate(inst);
		}
	},

	/* Get the date(s) for the first entry in a jQuery selection.
	 * @param  target element - the target input field or division or span
	 * @param  noDefault boolean - true if no default date is to be used
	 * @return Date - the current date
	 */
	_getDateDatepicker: function(target, noDefault) {
		var inst = this._getInst(target);
		if (inst && !inst.inline) {
			this._setDateFromField(inst, noDefault);
		}
		return (inst ? this._getDate(inst) : null);
	},

	/* Handle keystrokes. */
	_doKeyDown: function(event) {
		var onSelect, dateStr, sel,
			inst = $.datepicker._getInst(event.target),
			handled = true,
			isRTL = inst.dpDiv.is(".ui-datepicker-rtl");

		inst._keyEvent = true;
		if ($.datepicker._datepickerShowing) {
			switch (event.keyCode) {
				case 9: $.datepicker._hideDatepicker();
						handled = false;
						break; // hide on tab out
				case 13: sel = $("td." + $.datepicker._dayOverClass + ":not(." +
									$.datepicker._currentClass + ")", inst.dpDiv);
						if (sel[0]) {
							$.datepicker._selectDay(event.target, inst.selectedMonth, inst.selectedYear, sel[0]);
						}

						onSelect = $.datepicker._get(inst, "onSelect");
						if (onSelect) {
							dateStr = $.datepicker._formatDate(inst);

							// trigger custom callback
							onSelect.apply((inst.input ? inst.input[0] : null), [dateStr, inst]);
						} else {
							$.datepicker._hideDatepicker();
						}

						return false; // don't submit the form
				case 27: $.datepicker._hideDatepicker();
						break; // hide on escape
				case 33: $.datepicker._adjustDate(event.target, (event.ctrlKey ?
							-$.datepicker._get(inst, "stepBigMonths") :
							-$.datepicker._get(inst, "stepMonths")), "M");
						break; // previous month/year on page up/+ ctrl
				case 34: $.datepicker._adjustDate(event.target, (event.ctrlKey ?
							+$.datepicker._get(inst, "stepBigMonths") :
							+$.datepicker._get(inst, "stepMonths")), "M");
						break; // next month/year on page down/+ ctrl
				case 35: if (event.ctrlKey || event.metaKey) {
							$.datepicker._clearDate(event.target);
						}
						handled = event.ctrlKey || event.metaKey;
						break; // clear on ctrl or command +end
				case 36: if (event.ctrlKey || event.metaKey) {
							$.datepicker._gotoToday(event.target);
						}
						handled = event.ctrlKey || event.metaKey;
						break; // current on ctrl or command +home
				case 37: if (event.ctrlKey || event.metaKey) {
							$.datepicker._adjustDate(event.target, (isRTL ? +1 : -1), "D");
						}
						handled = event.ctrlKey || event.metaKey;
						// -1 day on ctrl or command +left
						if (event.originalEvent.altKey) {
							$.datepicker._adjustDate(event.target, (event.ctrlKey ?
								-$.datepicker._get(inst, "stepBigMonths") :
								-$.datepicker._get(inst, "stepMonths")), "M");
						}
						// next month/year on alt +left on Mac
						break;
				case 38: if (event.ctrlKey || event.metaKey) {
							$.datepicker._adjustDate(event.target, -7, "D");
						}
						handled = event.ctrlKey || event.metaKey;
						break; // -1 week on ctrl or command +up
				case 39: if (event.ctrlKey || event.metaKey) {
							$.datepicker._adjustDate(event.target, (isRTL ? -1 : +1), "D");
						}
						handled = event.ctrlKey || event.metaKey;
						// +1 day on ctrl or command +right
						if (event.originalEvent.altKey) {
							$.datepicker._adjustDate(event.target, (event.ctrlKey ?
								+$.datepicker._get(inst, "stepBigMonths") :
								+$.datepicker._get(inst, "stepMonths")), "M");
						}
						// next month/year on alt +right
						break;
				case 40: if (event.ctrlKey || event.metaKey) {
							$.datepicker._adjustDate(event.target, +7, "D");
						}
						handled = event.ctrlKey || event.metaKey;
						break; // +1 week on ctrl or command +down
				default: handled = false;
			}
		} else if (event.keyCode === 36 && event.ctrlKey) { // display the date picker on ctrl+home
			$.datepicker._showDatepicker(this);
		} else {
			handled = false;
		}

		if (handled) {
			event.preventDefault();
			event.stopPropagation();
		}
	},

	/* Filter entered characters - based on date format. */
	_doKeyPress: function(event) {
		var chars, chr,
			inst = $.datepicker._getInst(event.target);

		if ($.datepicker._get(inst, "constrainInput")) {
			chars = $.datepicker._possibleChars($.datepicker._get(inst, "dateFormat"));
			chr = String.fromCharCode(event.charCode == null ? event.keyCode : event.charCode);
			return event.ctrlKey || event.metaKey || (chr < " " || !chars || chars.indexOf(chr) > -1);
		}
	},

	/* Synchronise manual entry and field/alternate field. */
	_doKeyUp: function(event) {
		var date,
			inst = $.datepicker._getInst(event.target);

		if (inst.input.val() !== inst.lastVal) {
			try {
				date = $.datepicker.parseDate($.datepicker._get(inst, "dateFormat"),
					(inst.input ? inst.input.val() : null),
					$.datepicker._getFormatConfig(inst));

				if (date) { // only if valid
					$.datepicker._setDateFromField(inst);
					$.datepicker._updateAlternate(inst);
					$.datepicker._updateDatepicker(inst);
				}
			}
			catch (err) {
			}
		}
		return true;
	},

	/* Pop-up the date picker for a given input field.
	 * If false returned from beforeShow event handler do not show.
	 * @param  input  element - the input field attached to the date picker or
	 *					event - if triggered by focus
	 */
	_showDatepicker: function(input) {
		input = input.target || input;
		if (input.nodeName.toLowerCase() !== "input") { // find from button/image trigger
			input = $("input", input.parentNode)[0];
		}

		if ($.datepicker._isDisabledDatepicker(input) || $.datepicker._lastInput === input) { // already here
			return;
		}

		var inst, beforeShow, beforeShowSettings, isFixed,
			offset, showAnim, duration;

		inst = $.datepicker._getInst(input);
		if ($.datepicker._curInst && $.datepicker._curInst !== inst) {
			$.datepicker._curInst.dpDiv.stop(true, true);
			if ( inst && $.datepicker._datepickerShowing ) {
				$.datepicker._hideDatepicker( $.datepicker._curInst.input[0] );
			}
		}

		beforeShow = $.datepicker._get(inst, "beforeShow");
		beforeShowSettings = beforeShow ? beforeShow.apply(input, [input, inst]) : {};
		if(beforeShowSettings === false){
			return;
		}
		datepicker_extendRemove(inst.settings, beforeShowSettings);

		inst.lastVal = null;
		$.datepicker._lastInput = input;
		$.datepicker._setDateFromField(inst);

		if ($.datepicker._inDialog) { // hide cursor
			input.value = "";
		}
		if (!$.datepicker._pos) { // position below input
			$.datepicker._pos = $.datepicker._findPos(input);
			$.datepicker._pos[1] += input.offsetHeight; // add the height
		}

		isFixed = false;
		$(input).parents().each(function() {
			isFixed |= $(this).css("position") === "fixed";
			return !isFixed;
		});

		offset = {left: $.datepicker._pos[0], top: $.datepicker._pos[1]};
		$.datepicker._pos = null;
		//to avoid flashes on Firefox
		inst.dpDiv.empty();
		// determine sizing offscreen
		inst.dpDiv.css({position: "absolute", display: "block", top: "-1000px"});
		$.datepicker._updateDatepicker(inst);
		// fix width for dynamic number of date pickers
		// and adjust position before showing
		offset = $.datepicker._checkOffset(inst, offset, isFixed);
		inst.dpDiv.css({position: ($.datepicker._inDialog && $.blockUI ?
			"static" : (isFixed ? "fixed" : "absolute")), display: "none",
			left: offset.left + "px", top: offset.top + "px"});

		if (!inst.inline) {
			showAnim = $.datepicker._get(inst, "showAnim");
			duration = $.datepicker._get(inst, "duration");
			inst.dpDiv.css( "z-index", datepicker_getZindex( $( input ) ) + 1 );
			$.datepicker._datepickerShowing = true;

			if ( $.effects && $.effects.effect[ showAnim ] ) {
				inst.dpDiv.show(showAnim, $.datepicker._get(inst, "showOptions"), duration);
			} else {
				inst.dpDiv[showAnim || "show"](showAnim ? duration : null);
			}

			if ( $.datepicker._shouldFocusInput( inst ) ) {
				inst.input.focus();
			}

			$.datepicker._curInst = inst;
		}
	},

	/* Generate the date picker content. */
	_updateDatepicker: function(inst) {
		this.maxRows = 4; //Reset the max number of rows being displayed (see #7043)
		datepicker_instActive = inst; // for delegate hover events
		inst.dpDiv.empty().append(this._generateHTML(inst));
		this._attachHandlers(inst);

		var origyearshtml,
			numMonths = this._getNumberOfMonths(inst),
			cols = numMonths[1],
			width = 17,
			activeCell = inst.dpDiv.find( "." + this._dayOverClass + " a" );

		if ( activeCell.length > 0 ) {
			datepicker_handleMouseover.apply( activeCell.get( 0 ) );
		}

		inst.dpDiv.removeClass("ui-datepicker-multi-2 ui-datepicker-multi-3 ui-datepicker-multi-4").width("");
		if (cols > 1) {
			inst.dpDiv.addClass("ui-datepicker-multi-" + cols).css("width", (width * cols) + "em");
		}
		inst.dpDiv[(numMonths[0] !== 1 || numMonths[1] !== 1 ? "add" : "remove") +
			"Class"]("ui-datepicker-multi");
		inst.dpDiv[(this._get(inst, "isRTL") ? "add" : "remove") +
			"Class"]("ui-datepicker-rtl");

		if (inst === $.datepicker._curInst && $.datepicker._datepickerShowing && $.datepicker._shouldFocusInput( inst ) ) {
			inst.input.focus();
		}

		// deffered render of the years select (to avoid flashes on Firefox)
		if( inst.yearshtml ){
			origyearshtml = inst.yearshtml;
			setTimeout(function(){
				//assure that inst.yearshtml didn't change.
				if( origyearshtml === inst.yearshtml && inst.yearshtml ){
					inst.dpDiv.find("select.ui-datepicker-year:first").replaceWith(inst.yearshtml);
				}
				origyearshtml = inst.yearshtml = null;
			}, 0);
		}
	},

	// #6694 - don't focus the input if it's already focused
	// this breaks the change event in IE
	// Support: IE and jQuery <1.9
	_shouldFocusInput: function( inst ) {
		return inst.input && inst.input.is( ":visible" ) && !inst.input.is( ":disabled" ) && !inst.input.is( ":focus" );
	},

	/* Check positioning to remain on screen. */
	_checkOffset: function(inst, offset, isFixed) {
		var dpWidth = inst.dpDiv.outerWidth(),
			dpHeight = inst.dpDiv.outerHeight(),
			inputWidth = inst.input ? inst.input.outerWidth() : 0,
			inputHeight = inst.input ? inst.input.outerHeight() : 0,
			viewWidth = document.documentElement.clientWidth + (isFixed ? 0 : $(document).scrollLeft()),
			viewHeight = document.documentElement.clientHeight + (isFixed ? 0 : $(document).scrollTop());

		offset.left -= (this._get(inst, "isRTL") ? (dpWidth - inputWidth) : 0);
		offset.left -= (isFixed && offset.left === inst.input.offset().left) ? $(document).scrollLeft() : 0;
		offset.top -= (isFixed && offset.top === (inst.input.offset().top + inputHeight)) ? $(document).scrollTop() : 0;

		// now check if datepicker is showing outside window viewport - move to a better place if so.
		offset.left -= Math.min(offset.left, (offset.left + dpWidth > viewWidth && viewWidth > dpWidth) ?
			Math.abs(offset.left + dpWidth - viewWidth) : 0);
		offset.top -= Math.min(offset.top, (offset.top + dpHeight > viewHeight && viewHeight > dpHeight) ?
			Math.abs(dpHeight + inputHeight) : 0);

		return offset;
	},

	/* Find an object's position on the screen. */
	_findPos: function(obj) {
		var position,
			inst = this._getInst(obj),
			isRTL = this._get(inst, "isRTL");

		while (obj && (obj.type === "hidden" || obj.nodeType !== 1 || $.expr.filters.hidden(obj))) {
			obj = obj[isRTL ? "previousSibling" : "nextSibling"];
		}

		position = $(obj).offset();
		return [position.left, position.top];
	},

	/* Hide the date picker from view.
	 * @param  input  element - the input field attached to the date picker
	 */
	_hideDatepicker: function(input) {
		var showAnim, duration, postProcess, onClose,
			inst = this._curInst;

		if (!inst || (input && inst !== $.data(input, "datepicker"))) {
			return;
		}

		if (this._datepickerShowing) {
			showAnim = this._get(inst, "showAnim");
			duration = this._get(inst, "duration");
			postProcess = function() {
				$.datepicker._tidyDialog(inst);
			};

			// DEPRECATED: after BC for 1.8.x $.effects[ showAnim ] is not needed
			if ( $.effects && ( $.effects.effect[ showAnim ] || $.effects[ showAnim ] ) ) {
				inst.dpDiv.hide(showAnim, $.datepicker._get(inst, "showOptions"), duration, postProcess);
			} else {
				inst.dpDiv[(showAnim === "slideDown" ? "slideUp" :
					(showAnim === "fadeIn" ? "fadeOut" : "hide"))]((showAnim ? duration : null), postProcess);
			}

			if (!showAnim) {
				postProcess();
			}
			this._datepickerShowing = false;

			onClose = this._get(inst, "onClose");
			if (onClose) {
				onClose.apply((inst.input ? inst.input[0] : null), [(inst.input ? inst.input.val() : ""), inst]);
			}

			this._lastInput = null;
			if (this._inDialog) {
				this._dialogInput.css({ position: "absolute", left: "0", top: "-100px" });
				if ($.blockUI) {
					$.unblockUI();
					$("body").append(this.dpDiv);
				}
			}
			this._inDialog = false;
		}
	},

	/* Tidy up after a dialog display. */
	_tidyDialog: function(inst) {
		inst.dpDiv.removeClass(this._dialogClass).unbind(".ui-datepicker-calendar");
	},

	/* Close date picker if clicked elsewhere. */
	_checkExternalClick: function(event) {
		if (!$.datepicker._curInst) {
			return;
		}

		var $target = $(event.target),
			inst = $.datepicker._getInst($target[0]);

		if ( ( ( $target[0].id !== $.datepicker._mainDivId &&
				$target.parents("#" + $.datepicker._mainDivId).length === 0 &&
				!$target.hasClass($.datepicker.markerClassName) &&
				!$target.closest("." + $.datepicker._triggerClass).length &&
				$.datepicker._datepickerShowing && !($.datepicker._inDialog && $.blockUI) ) ) ||
			( $target.hasClass($.datepicker.markerClassName) && $.datepicker._curInst !== inst ) ) {
				$.datepicker._hideDatepicker();
		}
	},

	/* Adjust one of the date sub-fields. */
	_adjustDate: function(id, offset, period) {
		var target = $(id),
			inst = this._getInst(target[0]);

		if (this._isDisabledDatepicker(target[0])) {
			return;
		}
		this._adjustInstDate(inst, offset +
			(period === "M" ? this._get(inst, "showCurrentAtPos") : 0), // undo positioning
			period);
		this._updateDatepicker(inst);
	},

	/* Action for current link. */
	_gotoToday: function(id) {
		var date,
			target = $(id),
			inst = this._getInst(target[0]);

		if (this._get(inst, "gotoCurrent") && inst.currentDay) {
			inst.selectedDay = inst.currentDay;
			inst.drawMonth = inst.selectedMonth = inst.currentMonth;
			inst.drawYear = inst.selectedYear = inst.currentYear;
		} else {
			date = new Date();
			inst.selectedDay = date.getDate();
			inst.drawMonth = inst.selectedMonth = date.getMonth();
			inst.drawYear = inst.selectedYear = date.getFullYear();
		}
		this._notifyChange(inst);
		this._adjustDate(target);
	},

	/* Action for selecting a new month/year. */
	_selectMonthYear: function(id, select, period) {
		var target = $(id),
			inst = this._getInst(target[0]);

		inst["selected" + (period === "M" ? "Month" : "Year")] =
		inst["draw" + (period === "M" ? "Month" : "Year")] =
			parseInt(select.options[select.selectedIndex].value,10);

		this._notifyChange(inst);
		this._adjustDate(target);
	},

	/* Action for selecting a day. */
	_selectDay: function(id, month, year, td) {
		var inst,
			target = $(id);

		if ($(td).hasClass(this._unselectableClass) || this._isDisabledDatepicker(target[0])) {
			return;
		}

		inst = this._getInst(target[0]);
		inst.selectedDay = inst.currentDay = $("a", td).html();
		inst.selectedMonth = inst.currentMonth = month;
		inst.selectedYear = inst.currentYear = year;
		this._selectDate(id, this._formatDate(inst,
			inst.currentDay, inst.currentMonth, inst.currentYear));
	},

	/* Erase the input field and hide the date picker. */
	_clearDate: function(id) {
		var target = $(id);
		this._selectDate(target, "");
	},

	/* Update the input field with the selected date. */
	_selectDate: function(id, dateStr) {
		var onSelect,
			target = $(id),
			inst = this._getInst(target[0]);

		dateStr = (dateStr != null ? dateStr : this._formatDate(inst));
		if (inst.input) {
			inst.input.val(dateStr);
		}
		this._updateAlternate(inst);

		onSelect = this._get(inst, "onSelect");
		if (onSelect) {
			onSelect.apply((inst.input ? inst.input[0] : null), [dateStr, inst]);  // trigger custom callback
		} else if (inst.input) {
			inst.input.trigger("change"); // fire the change event
		}

		if (inst.inline){
			this._updateDatepicker(inst);
		} else {
			this._hideDatepicker();
			this._lastInput = inst.input[0];
			if (typeof(inst.input[0]) !== "object") {
				inst.input.focus(); // restore focus
			}
			this._lastInput = null;
		}
	},

	/* Update any alternate field to synchronise with the main field. */
	_updateAlternate: function(inst) {
		var altFormat, date, dateStr,
			altField = this._get(inst, "altField");

		if (altField) { // update alternate field too
			altFormat = this._get(inst, "altFormat") || this._get(inst, "dateFormat");
			date = this._getDate(inst);
			dateStr = this.formatDate(altFormat, date, this._getFormatConfig(inst));
			$(altField).each(function() { $(this).val(dateStr); });
		}
	},

	/* Set as beforeShowDay function to prevent selection of weekends.
	 * @param  date  Date - the date to customise
	 * @return [boolean, string] - is this date selectable?, what is its CSS class?
	 */
	noWeekends: function(date) {
		var day = date.getDay();
		return [(day > 0 && day < 6), ""];
	},

	/* Set as calculateWeek to determine the week of the year based on the ISO 8601 definition.
	 * @param  date  Date - the date to get the week for
	 * @return  number - the number of the week within the year that contains this date
	 */
	iso8601Week: function(date) {
		var time,
			checkDate = new Date(date.getTime());

		// Find Thursday of this week starting on Monday
		checkDate.setDate(checkDate.getDate() + 4 - (checkDate.getDay() || 7));

		time = checkDate.getTime();
		checkDate.setMonth(0); // Compare with Jan 1
		checkDate.setDate(1);
		return Math.floor(Math.round((time - checkDate) / 86400000) / 7) + 1;
	},

	/* Parse a string value into a date object.
	 * See formatDate below for the possible formats.
	 *
	 * @param  format string - the expected format of the date
	 * @param  value string - the date in the above format
	 * @param  settings Object - attributes include:
	 *					shortYearCutoff  number - the cutoff year for determining the century (optional)
	 *					dayNamesShort	string[7] - abbreviated names of the days from Sunday (optional)
	 *					dayNames		string[7] - names of the days from Sunday (optional)
	 *					monthNamesShort string[12] - abbreviated names of the months (optional)
	 *					monthNames		string[12] - names of the months (optional)
	 * @return  Date - the extracted date value or null if value is blank
	 */
	parseDate: function (format, value, settings) {
		if (format == null || value == null) {
			throw "Invalid arguments";
		}

		value = (typeof value === "object" ? value.toString() : value + "");
		if (value === "") {
			return null;
		}

		var iFormat, dim, extra,
			iValue = 0,
			shortYearCutoffTemp = (settings ? settings.shortYearCutoff : null) || this._defaults.shortYearCutoff,
			shortYearCutoff = (typeof shortYearCutoffTemp !== "string" ? shortYearCutoffTemp :
				new Date().getFullYear() % 100 + parseInt(shortYearCutoffTemp, 10)),
			dayNamesShort = (settings ? settings.dayNamesShort : null) || this._defaults.dayNamesShort,
			dayNames = (settings ? settings.dayNames : null) || this._defaults.dayNames,
			monthNamesShort = (settings ? settings.monthNamesShort : null) || this._defaults.monthNamesShort,
			monthNames = (settings ? settings.monthNames : null) || this._defaults.monthNames,
			year = -1,
			month = -1,
			day = -1,
			doy = -1,
			literal = false,
			date,
			// Check whether a format character is doubled
			lookAhead = function(match) {
				var matches = (iFormat + 1 < format.length && format.charAt(iFormat + 1) === match);
				if (matches) {
					iFormat++;
				}
				return matches;
			},
			// Extract a number from the string value
			getNumber = function(match) {
				var isDoubled = lookAhead(match),
					size = (match === "@" ? 14 : (match === "!" ? 20 :
					(match === "y" && isDoubled ? 4 : (match === "o" ? 3 : 2)))),
					minSize = (match === "y" ? size : 1),
					digits = new RegExp("^\\d{" + minSize + "," + size + "}"),
					num = value.substring(iValue).match(digits);
				if (!num) {
					throw "Missing number at position " + iValue;
				}
				iValue += num[0].length;
				return parseInt(num[0], 10);
			},
			// Extract a name from the string value and convert to an index
			getName = function(match, shortNames, longNames) {
				var index = -1,
					names = $.map(lookAhead(match) ? longNames : shortNames, function (v, k) {
						return [ [k, v] ];
					}).sort(function (a, b) {
						return -(a[1].length - b[1].length);
					});

				$.each(names, function (i, pair) {
					var name = pair[1];
					if (value.substr(iValue, name.length).toLowerCase() === name.toLowerCase()) {
						index = pair[0];
						iValue += name.length;
						return false;
					}
				});
				if (index !== -1) {
					return index + 1;
				} else {
					throw "Unknown name at position " + iValue;
				}
			},
			// Confirm that a literal character matches the string value
			checkLiteral = function() {
				if (value.charAt(iValue) !== format.charAt(iFormat)) {
					throw "Unexpected literal at position " + iValue;
				}
				iValue++;
			};

		for (iFormat = 0; iFormat < format.length; iFormat++) {
			if (literal) {
				if (format.charAt(iFormat) === "'" && !lookAhead("'")) {
					literal = false;
				} else {
					checkLiteral();
				}
			} else {
				switch (format.charAt(iFormat)) {
					case "d":
						day = getNumber("d");
						break;
					case "D":
						getName("D", dayNamesShort, dayNames);
						break;
					case "o":
						doy = getNumber("o");
						break;
					case "m":
						month = getNumber("m");
						break;
					case "M":
						month = getName("M", monthNamesShort, monthNames);
						break;
					case "y":
						year = getNumber("y");
						break;
					case "@":
						date = new Date(getNumber("@"));
						year = date.getFullYear();
						month = date.getMonth() + 1;
						day = date.getDate();
						break;
					case "!":
						date = new Date((getNumber("!") - this._ticksTo1970) / 10000);
						year = date.getFullYear();
						month = date.getMonth() + 1;
						day = date.getDate();
						break;
					case "'":
						if (lookAhead("'")){
							checkLiteral();
						} else {
							literal = true;
						}
						break;
					default:
						checkLiteral();
				}
			}
		}

		if (iValue < value.length){
			extra = value.substr(iValue);
			if (!/^\s+/.test(extra)) {
				throw "Extra/unparsed characters found in date: " + extra;
			}
		}

		if (year === -1) {
			year = new Date().getFullYear();
		} else if (year < 100) {
			year += new Date().getFullYear() - new Date().getFullYear() % 100 +
				(year <= shortYearCutoff ? 0 : -100);
		}

		if (doy > -1) {
			month = 1;
			day = doy;
			do {
				dim = this._getDaysInMonth(year, month - 1);
				if (day <= dim) {
					break;
				}
				month++;
				day -= dim;
			} while (true);
		}

		date = this._daylightSavingAdjust(new Date(year, month - 1, day));
		if (date.getFullYear() !== year || date.getMonth() + 1 !== month || date.getDate() !== day) {
			throw "Invalid date"; // E.g. 31/02/00
		}
		return date;
	},

	/* Standard date formats. */
	ATOM: "yy-mm-dd", // RFC 3339 (ISO 8601)
	COOKIE: "D, dd M yy",
	ISO_8601: "yy-mm-dd",
	RFC_822: "D, d M y",
	RFC_850: "DD, dd-M-y",
	RFC_1036: "D, d M y",
	RFC_1123: "D, d M yy",
	RFC_2822: "D, d M yy",
	RSS: "D, d M y", // RFC 822
	TICKS: "!",
	TIMESTAMP: "@",
	W3C: "yy-mm-dd", // ISO 8601

	_ticksTo1970: (((1970 - 1) * 365 + Math.floor(1970 / 4) - Math.floor(1970 / 100) +
		Math.floor(1970 / 400)) * 24 * 60 * 60 * 10000000),

	/* Format a date object into a string value.
	 * The format can be combinations of the following:
	 * d  - day of month (no leading zero)
	 * dd - day of month (two digit)
	 * o  - day of year (no leading zeros)
	 * oo - day of year (three digit)
	 * D  - day name short
	 * DD - day name long
	 * m  - month of year (no leading zero)
	 * mm - month of year (two digit)
	 * M  - month name short
	 * MM - month name long
	 * y  - year (two digit)
	 * yy - year (four digit)
	 * @ - Unix timestamp (ms since 01/01/1970)
	 * ! - Windows ticks (100ns since 01/01/0001)
	 * "..." - literal text
	 * '' - single quote
	 *
	 * @param  format string - the desired format of the date
	 * @param  date Date - the date value to format
	 * @param  settings Object - attributes include:
	 *					dayNamesShort	string[7] - abbreviated names of the days from Sunday (optional)
	 *					dayNames		string[7] - names of the days from Sunday (optional)
	 *					monthNamesShort string[12] - abbreviated names of the months (optional)
	 *					monthNames		string[12] - names of the months (optional)
	 * @return  string - the date in the above format
	 */
	formatDate: function (format, date, settings) {
		if (!date) {
			return "";
		}

		var iFormat,
			dayNamesShort = (settings ? settings.dayNamesShort : null) || this._defaults.dayNamesShort,
			dayNames = (settings ? settings.dayNames : null) || this._defaults.dayNames,
			monthNamesShort = (settings ? settings.monthNamesShort : null) || this._defaults.monthNamesShort,
			monthNames = (settings ? settings.monthNames : null) || this._defaults.monthNames,
			// Check whether a format character is doubled
			lookAhead = function(match) {
				var matches = (iFormat + 1 < format.length && format.charAt(iFormat + 1) === match);
				if (matches) {
					iFormat++;
				}
				return matches;
			},
			// Format a number, with leading zero if necessary
			formatNumber = function(match, value, len) {
				var num = "" + value;
				if (lookAhead(match)) {
					while (num.length < len) {
						num = "0" + num;
					}
				}
				return num;
			},
			// Format a name, short or long as requested
			formatName = function(match, value, shortNames, longNames) {
				return (lookAhead(match) ? longNames[value] : shortNames[value]);
			},
			output = "",
			literal = false;

		if (date) {
			for (iFormat = 0; iFormat < format.length; iFormat++) {
				if (literal) {
					if (format.charAt(iFormat) === "'" && !lookAhead("'")) {
						literal = false;
					} else {
						output += format.charAt(iFormat);
					}
				} else {
					switch (format.charAt(iFormat)) {
						case "d":
							output += formatNumber("d", date.getDate(), 2);
							break;
						case "D":
							output += formatName("D", date.getDay(), dayNamesShort, dayNames);
							break;
						case "o":
							output += formatNumber("o",
								Math.round((new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime() - new Date(date.getFullYear(), 0, 0).getTime()) / 86400000), 3);
							break;
						case "m":
							output += formatNumber("m", date.getMonth() + 1, 2);
							break;
						case "M":
							output += formatName("M", date.getMonth(), monthNamesShort, monthNames);
							break;
						case "y":
							output += (lookAhead("y") ? date.getFullYear() :
								(date.getYear() % 100 < 10 ? "0" : "") + date.getYear() % 100);
							break;
						case "@":
							output += date.getTime();
							break;
						case "!":
							output += date.getTime() * 10000 + this._ticksTo1970;
							break;
						case "'":
							if (lookAhead("'")) {
								output += "'";
							} else {
								literal = true;
							}
							break;
						default:
							output += format.charAt(iFormat);
					}
				}
			}
		}
		return output;
	},

	/* Extract all possible characters from the date format. */
	_possibleChars: function (format) {
		var iFormat,
			chars = "",
			literal = false,
			// Check whether a format character is doubled
			lookAhead = function(match) {
				var matches = (iFormat + 1 < format.length && format.charAt(iFormat + 1) === match);
				if (matches) {
					iFormat++;
				}
				return matches;
			};

		for (iFormat = 0; iFormat < format.length; iFormat++) {
			if (literal) {
				if (format.charAt(iFormat) === "'" && !lookAhead("'")) {
					literal = false;
				} else {
					chars += format.charAt(iFormat);
				}
			} else {
				switch (format.charAt(iFormat)) {
					case "d": case "m": case "y": case "@":
						chars += "0123456789";
						break;
					case "D": case "M":
						return null; // Accept anything
					case "'":
						if (lookAhead("'")) {
							chars += "'";
						} else {
							literal = true;
						}
						break;
					default:
						chars += format.charAt(iFormat);
				}
			}
		}
		return chars;
	},

	/* Get a setting value, defaulting if necessary. */
	_get: function(inst, name) {
		return inst.settings[name] !== undefined ?
			inst.settings[name] : this._defaults[name];
	},

	/* Parse existing date and initialise date picker. */
	_setDateFromField: function(inst, noDefault) {
		if (inst.input.val() === inst.lastVal) {
			return;
		}

		var dateFormat = this._get(inst, "dateFormat"),
			dates = inst.lastVal = inst.input ? inst.input.val() : null,
			defaultDate = this._getDefaultDate(inst),
			date = defaultDate,
			settings = this._getFormatConfig(inst);

		try {
			date = this.parseDate(dateFormat, dates, settings) || defaultDate;
		} catch (event) {
			dates = (noDefault ? "" : dates);
		}
		inst.selectedDay = date.getDate();
		inst.drawMonth = inst.selectedMonth = date.getMonth();
		inst.drawYear = inst.selectedYear = date.getFullYear();
		inst.currentDay = (dates ? date.getDate() : 0);
		inst.currentMonth = (dates ? date.getMonth() : 0);
		inst.currentYear = (dates ? date.getFullYear() : 0);
		this._adjustInstDate(inst);
	},

	/* Retrieve the default date shown on opening. */
	_getDefaultDate: function(inst) {
		return this._restrictMinMax(inst,
			this._determineDate(inst, this._get(inst, "defaultDate"), new Date()));
	},

	/* A date may be specified as an exact value or a relative one. */
	_determineDate: function(inst, date, defaultDate) {
		var offsetNumeric = function(offset) {
				var date = new Date();
				date.setDate(date.getDate() + offset);
				return date;
			},
			offsetString = function(offset) {
				try {
					return $.datepicker.parseDate($.datepicker._get(inst, "dateFormat"),
						offset, $.datepicker._getFormatConfig(inst));
				}
				catch (e) {
					// Ignore
				}

				var date = (offset.toLowerCase().match(/^c/) ?
					$.datepicker._getDate(inst) : null) || new Date(),
					year = date.getFullYear(),
					month = date.getMonth(),
					day = date.getDate(),
					pattern = /([+\-]?[0-9]+)\s*(d|D|w|W|m|M|y|Y)?/g,
					matches = pattern.exec(offset);

				while (matches) {
					switch (matches[2] || "d") {
						case "d" : case "D" :
							day += parseInt(matches[1],10); break;
						case "w" : case "W" :
							day += parseInt(matches[1],10) * 7; break;
						case "m" : case "M" :
							month += parseInt(matches[1],10);
							day = Math.min(day, $.datepicker._getDaysInMonth(year, month));
							break;
						case "y": case "Y" :
							year += parseInt(matches[1],10);
							day = Math.min(day, $.datepicker._getDaysInMonth(year, month));
							break;
					}
					matches = pattern.exec(offset);
				}
				return new Date(year, month, day);
			},
			newDate = (date == null || date === "" ? defaultDate : (typeof date === "string" ? offsetString(date) :
				(typeof date === "number" ? (isNaN(date) ? defaultDate : offsetNumeric(date)) : new Date(date.getTime()))));

		newDate = (newDate && newDate.toString() === "Invalid Date" ? defaultDate : newDate);
		if (newDate) {
			newDate.setHours(0);
			newDate.setMinutes(0);
			newDate.setSeconds(0);
			newDate.setMilliseconds(0);
		}
		return this._daylightSavingAdjust(newDate);
	},

	/* Handle switch to/from daylight saving.
	 * Hours may be non-zero on daylight saving cut-over:
	 * > 12 when midnight changeover, but then cannot generate
	 * midnight datetime, so jump to 1AM, otherwise reset.
	 * @param  date  (Date) the date to check
	 * @return  (Date) the corrected date
	 */
	_daylightSavingAdjust: function(date) {
		if (!date) {
			return null;
		}
		date.setHours(date.getHours() > 12 ? date.getHours() + 2 : 0);
		return date;
	},

	/* Set the date(s) directly. */
	_setDate: function(inst, date, noChange) {
		var clear = !date,
			origMonth = inst.selectedMonth,
			origYear = inst.selectedYear,
			newDate = this._restrictMinMax(inst, this._determineDate(inst, date, new Date()));

		inst.selectedDay = inst.currentDay = newDate.getDate();
		inst.drawMonth = inst.selectedMonth = inst.currentMonth = newDate.getMonth();
		inst.drawYear = inst.selectedYear = inst.currentYear = newDate.getFullYear();
		if ((origMonth !== inst.selectedMonth || origYear !== inst.selectedYear) && !noChange) {
			this._notifyChange(inst);
		}
		this._adjustInstDate(inst);
		if (inst.input) {
			inst.input.val(clear ? "" : this._formatDate(inst));
		}
	},

	/* Retrieve the date(s) directly. */
	_getDate: function(inst) {
		var startDate = (!inst.currentYear || (inst.input && inst.input.val() === "") ? null :
			this._daylightSavingAdjust(new Date(
			inst.currentYear, inst.currentMonth, inst.currentDay)));
			return startDate;
	},

	/* Attach the onxxx handlers.  These are declared statically so
	 * they work with static code transformers like Caja.
	 */
	_attachHandlers: function(inst) {
		var stepMonths = this._get(inst, "stepMonths"),
			id = "#" + inst.id.replace( /\\\\/g, "\\" );
		inst.dpDiv.find("[data-handler]").map(function () {
			var handler = {
				prev: function () {
					$.datepicker._adjustDate(id, -stepMonths, "M");
				},
				next: function () {
					$.datepicker._adjustDate(id, +stepMonths, "M");
				},
				hide: function () {
					$.datepicker._hideDatepicker();
				},
				today: function () {
					$.datepicker._gotoToday(id);
				},
				selectDay: function () {
					$.datepicker._selectDay(id, +this.getAttribute("data-month"), +this.getAttribute("data-year"), this);
					return false;
				},
				selectMonth: function () {
					$.datepicker._selectMonthYear(id, this, "M");
					return false;
				},
				selectYear: function () {
					$.datepicker._selectMonthYear(id, this, "Y");
					return false;
				}
			};
			$(this).bind(this.getAttribute("data-event"), handler[this.getAttribute("data-handler")]);
		});
	},

	/* Generate the HTML for the current state of the date picker. */
	_generateHTML: function(inst) {
		var maxDraw, prevText, prev, nextText, next, currentText, gotoDate,
			controls, buttonPanel, firstDay, showWeek, dayNames, dayNamesMin,
			monthNames, monthNamesShort, beforeShowDay, showOtherMonths,
			selectOtherMonths, defaultDate, html, dow, row, group, col, selectedDate,
			cornerClass, calender, thead, day, daysInMonth, leadDays, curRows, numRows,
			printDate, dRow, tbody, daySettings, otherMonth, unselectable,
			tempDate = new Date(),
			today = this._daylightSavingAdjust(
				new Date(tempDate.getFullYear(), tempDate.getMonth(), tempDate.getDate())), // clear time
			isRTL = this._get(inst, "isRTL"),
			showButtonPanel = this._get(inst, "showButtonPanel"),
			hideIfNoPrevNext = this._get(inst, "hideIfNoPrevNext"),
			navigationAsDateFormat = this._get(inst, "navigationAsDateFormat"),
			numMonths = this._getNumberOfMonths(inst),
			showCurrentAtPos = this._get(inst, "showCurrentAtPos"),
			stepMonths = this._get(inst, "stepMonths"),
			isMultiMonth = (numMonths[0] !== 1 || numMonths[1] !== 1),
			currentDate = this._daylightSavingAdjust((!inst.currentDay ? new Date(9999, 9, 9) :
				new Date(inst.currentYear, inst.currentMonth, inst.currentDay))),
			minDate = this._getMinMaxDate(inst, "min"),
			maxDate = this._getMinMaxDate(inst, "max"),
			drawMonth = inst.drawMonth - showCurrentAtPos,
			drawYear = inst.drawYear;

		if (drawMonth < 0) {
			drawMonth += 12;
			drawYear--;
		}
		if (maxDate) {
			maxDraw = this._daylightSavingAdjust(new Date(maxDate.getFullYear(),
				maxDate.getMonth() - (numMonths[0] * numMonths[1]) + 1, maxDate.getDate()));
			maxDraw = (minDate && maxDraw < minDate ? minDate : maxDraw);
			while (this._daylightSavingAdjust(new Date(drawYear, drawMonth, 1)) > maxDraw) {
				drawMonth--;
				if (drawMonth < 0) {
					drawMonth = 11;
					drawYear--;
				}
			}
		}
		inst.drawMonth = drawMonth;
		inst.drawYear = drawYear;

		prevText = this._get(inst, "prevText");
		prevText = (!navigationAsDateFormat ? prevText : this.formatDate(prevText,
			this._daylightSavingAdjust(new Date(drawYear, drawMonth - stepMonths, 1)),
			this._getFormatConfig(inst)));

		prev = (this._canAdjustMonth(inst, -1, drawYear, drawMonth) ?
			"<a class='ui-datepicker-prev ui-corner-all' data-handler='prev' data-event='click'" +
			" title='" + prevText + "'><span class='ui-icon ui-icon-circle-triangle-" + ( isRTL ? "e" : "w") + "'>" + prevText + "</span></a>" :
			(hideIfNoPrevNext ? "" : "<a class='ui-datepicker-prev ui-corner-all ui-state-disabled' title='"+ prevText +"'><span class='ui-icon ui-icon-circle-triangle-" + ( isRTL ? "e" : "w") + "'>" + prevText + "</span></a>"));

		nextText = this._get(inst, "nextText");
		nextText = (!navigationAsDateFormat ? nextText : this.formatDate(nextText,
			this._daylightSavingAdjust(new Date(drawYear, drawMonth + stepMonths, 1)),
			this._getFormatConfig(inst)));

		next = (this._canAdjustMonth(inst, +1, drawYear, drawMonth) ?
			"<a class='ui-datepicker-next ui-corner-all' data-handler='next' data-event='click'" +
			" title='" + nextText + "'><span class='ui-icon ui-icon-circle-triangle-" + ( isRTL ? "w" : "e") + "'>" + nextText + "</span></a>" :
			(hideIfNoPrevNext ? "" : "<a class='ui-datepicker-next ui-corner-all ui-state-disabled' title='"+ nextText + "'><span class='ui-icon ui-icon-circle-triangle-" + ( isRTL ? "w" : "e") + "'>" + nextText + "</span></a>"));

		currentText = this._get(inst, "currentText");
		gotoDate = (this._get(inst, "gotoCurrent") && inst.currentDay ? currentDate : today);
		currentText = (!navigationAsDateFormat ? currentText :
			this.formatDate(currentText, gotoDate, this._getFormatConfig(inst)));

		controls = (!inst.inline ? "<button type='button' class='ui-datepicker-close ui-state-default ui-priority-primary ui-corner-all' data-handler='hide' data-event='click'>" +
			this._get(inst, "closeText") + "</button>" : "");

		buttonPanel = (showButtonPanel) ? "<div class='ui-datepicker-buttonpane ui-widget-content'>" + (isRTL ? controls : "") +
			(this._isInRange(inst, gotoDate) ? "<button type='button' class='ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all' data-handler='today' data-event='click'" +
			">" + currentText + "</button>" : "") + (isRTL ? "" : controls) + "</div>" : "";

		firstDay = parseInt(this._get(inst, "firstDay"),10);
		firstDay = (isNaN(firstDay) ? 0 : firstDay);

		showWeek = this._get(inst, "showWeek");
		dayNames = this._get(inst, "dayNames");
		dayNamesMin = this._get(inst, "dayNamesMin");
		monthNames = this._get(inst, "monthNames");
		monthNamesShort = this._get(inst, "monthNamesShort");
		beforeShowDay = this._get(inst, "beforeShowDay");
		showOtherMonths = this._get(inst, "showOtherMonths");
		selectOtherMonths = this._get(inst, "selectOtherMonths");
		defaultDate = this._getDefaultDate(inst);
		html = "";
		dow;
		for (row = 0; row < numMonths[0]; row++) {
			group = "";
			this.maxRows = 4;
			for (col = 0; col < numMonths[1]; col++) {
				selectedDate = this._daylightSavingAdjust(new Date(drawYear, drawMonth, inst.selectedDay));
				cornerClass = " ui-corner-all";
				calender = "";
				if (isMultiMonth) {
					calender += "<div class='ui-datepicker-group";
					if (numMonths[1] > 1) {
						switch (col) {
							case 0: calender += " ui-datepicker-group-first";
								cornerClass = " ui-corner-" + (isRTL ? "right" : "left"); break;
							case numMonths[1]-1: calender += " ui-datepicker-group-last";
								cornerClass = " ui-corner-" + (isRTL ? "left" : "right"); break;
							default: calender += " ui-datepicker-group-middle"; cornerClass = ""; break;
						}
					}
					calender += "'>";
				}
				calender += "<div class='ui-datepicker-header ui-widget-header ui-helper-clearfix" + cornerClass + "'>" +
					(/all|left/.test(cornerClass) && row === 0 ? (isRTL ? next : prev) : "") +
					(/all|right/.test(cornerClass) && row === 0 ? (isRTL ? prev : next) : "") +
					this._generateMonthYearHeader(inst, drawMonth, drawYear, minDate, maxDate,
					row > 0 || col > 0, monthNames, monthNamesShort) + // draw month headers
					"</div><table class='ui-datepicker-calendar'><thead>" +
					"<tr>";
				thead = (showWeek ? "<th class='ui-datepicker-week-col'>" + this._get(inst, "weekHeader") + "</th>" : "");
				for (dow = 0; dow < 7; dow++) { // days of the week
					day = (dow + firstDay) % 7;
					thead += "<th scope='col'" + ((dow + firstDay + 6) % 7 >= 5 ? " class='ui-datepicker-week-end'" : "") + ">" +
						"<span title='" + dayNames[day] + "'>" + dayNamesMin[day] + "</span></th>";
				}
				calender += thead + "</tr></thead><tbody>";
				daysInMonth = this._getDaysInMonth(drawYear, drawMonth);
				if (drawYear === inst.selectedYear && drawMonth === inst.selectedMonth) {
					inst.selectedDay = Math.min(inst.selectedDay, daysInMonth);
				}
				leadDays = (this._getFirstDayOfMonth(drawYear, drawMonth) - firstDay + 7) % 7;
				curRows = Math.ceil((leadDays + daysInMonth) / 7); // calculate the number of rows to generate
				numRows = (isMultiMonth ? this.maxRows > curRows ? this.maxRows : curRows : curRows); //If multiple months, use the higher number of rows (see #7043)
				this.maxRows = numRows;
				printDate = this._daylightSavingAdjust(new Date(drawYear, drawMonth, 1 - leadDays));
				for (dRow = 0; dRow < numRows; dRow++) { // create date picker rows
					calender += "<tr>";
					tbody = (!showWeek ? "" : "<td class='ui-datepicker-week-col'>" +
						this._get(inst, "calculateWeek")(printDate) + "</td>");
					for (dow = 0; dow < 7; dow++) { // create date picker days
						daySettings = (beforeShowDay ?
							beforeShowDay.apply((inst.input ? inst.input[0] : null), [printDate]) : [true, ""]);
						otherMonth = (printDate.getMonth() !== drawMonth);
						unselectable = (otherMonth && !selectOtherMonths) || !daySettings[0] ||
							(minDate && printDate < minDate) || (maxDate && printDate > maxDate);
						tbody += "<td class='" +
							((dow + firstDay + 6) % 7 >= 5 ? " ui-datepicker-week-end" : "") + // highlight weekends
							(otherMonth ? " ui-datepicker-other-month" : "") + // highlight days from other months
							((printDate.getTime() === selectedDate.getTime() && drawMonth === inst.selectedMonth && inst._keyEvent) || // user pressed key
							(defaultDate.getTime() === printDate.getTime() && defaultDate.getTime() === selectedDate.getTime()) ?
							// or defaultDate is current printedDate and defaultDate is selectedDate
							" " + this._dayOverClass : "") + // highlight selected day
							(unselectable ? " " + this._unselectableClass + " ui-state-disabled": "") +  // highlight unselectable days
							(otherMonth && !showOtherMonths ? "" : " " + daySettings[1] + // highlight custom dates
							(printDate.getTime() === currentDate.getTime() ? " " + this._currentClass : "") + // highlight selected day
							(printDate.getTime() === today.getTime() ? " ui-datepicker-today" : "")) + "'" + // highlight today (if different)
							((!otherMonth || showOtherMonths) && daySettings[2] ? " title='" + daySettings[2].replace(/'/g, "&#39;") + "'" : "") + // cell title
							(unselectable ? "" : " data-handler='selectDay' data-event='click' data-month='" + printDate.getMonth() + "' data-year='" + printDate.getFullYear() + "'") + ">" + // actions
							(otherMonth && !showOtherMonths ? "&#xa0;" : // display for other months
							(unselectable ? "<span class='ui-state-default'>" + printDate.getDate() + "</span>" : "<a class='ui-state-default" +
							(printDate.getTime() === today.getTime() ? " ui-state-highlight" : "") +
							(printDate.getTime() === currentDate.getTime() ? " ui-state-active" : "") + // highlight selected day
							(otherMonth ? " ui-priority-secondary" : "") + // distinguish dates from other months
							"' href='#'>" + printDate.getDate() + "</a>")) + "</td>"; // display selectable date
						printDate.setDate(printDate.getDate() + 1);
						printDate = this._daylightSavingAdjust(printDate);
					}
					calender += tbody + "</tr>";
				}
				drawMonth++;
				if (drawMonth > 11) {
					drawMonth = 0;
					drawYear++;
				}
				calender += "</tbody></table>" + (isMultiMonth ? "</div>" +
							((numMonths[0] > 0 && col === numMonths[1]-1) ? "<div class='ui-datepicker-row-break'></div>" : "") : "");
				group += calender;
			}
			html += group;
		}
		html += buttonPanel;
		inst._keyEvent = false;
		return html;
	},

	/* Generate the month and year header. */
	_generateMonthYearHeader: function(inst, drawMonth, drawYear, minDate, maxDate,
			secondary, monthNames, monthNamesShort) {

		var inMinYear, inMaxYear, month, years, thisYear, determineYear, year, endYear,
			changeMonth = this._get(inst, "changeMonth"),
			changeYear = this._get(inst, "changeYear"),
			showMonthAfterYear = this._get(inst, "showMonthAfterYear"),
			html = "<div class='ui-datepicker-title'>",
			monthHtml = "";

		// month selection
		if (secondary || !changeMonth) {
			monthHtml += "<span class='ui-datepicker-month'>" + monthNames[drawMonth] + "</span>";
		} else {
			inMinYear = (minDate && minDate.getFullYear() === drawYear);
			inMaxYear = (maxDate && maxDate.getFullYear() === drawYear);
			monthHtml += "<select class='ui-datepicker-month' data-handler='selectMonth' data-event='change'>";
			for ( month = 0; month < 12; month++) {
				if ((!inMinYear || month >= minDate.getMonth()) && (!inMaxYear || month <= maxDate.getMonth())) {
					monthHtml += "<option value='" + month + "'" +
						(month === drawMonth ? " selected='selected'" : "") +
						">" + monthNamesShort[month] + "</option>";
				}
			}
			monthHtml += "</select>";
		}

		if (!showMonthAfterYear) {
			html += monthHtml + (secondary || !(changeMonth && changeYear) ? "&#xa0;" : "");
		}

		// year selection
		if ( !inst.yearshtml ) {
			inst.yearshtml = "";
			if (secondary || !changeYear) {
				html += "<span class='ui-datepicker-year'>" + drawYear + "</span>";
			} else {
				// determine range of years to display
				years = this._get(inst, "yearRange").split(":");
				thisYear = new Date().getFullYear();
				determineYear = function(value) {
					var year = (value.match(/c[+\-].*/) ? drawYear + parseInt(value.substring(1), 10) :
						(value.match(/[+\-].*/) ? thisYear + parseInt(value, 10) :
						parseInt(value, 10)));
					return (isNaN(year) ? thisYear : year);
				};
				year = determineYear(years[0]);
				endYear = Math.max(year, determineYear(years[1] || ""));
				year = (minDate ? Math.max(year, minDate.getFullYear()) : year);
				endYear = (maxDate ? Math.min(endYear, maxDate.getFullYear()) : endYear);
				inst.yearshtml += "<select class='ui-datepicker-year' data-handler='selectYear' data-event='change'>";
				for (; year <= endYear; year++) {
					inst.yearshtml += "<option value='" + year + "'" +
						(year === drawYear ? " selected='selected'" : "") +
						">" + year + "</option>";
				}
				inst.yearshtml += "</select>";

				html += inst.yearshtml;
				inst.yearshtml = null;
			}
		}

		html += this._get(inst, "yearSuffix");
		if (showMonthAfterYear) {
			html += (secondary || !(changeMonth && changeYear) ? "&#xa0;" : "") + monthHtml;
		}
		html += "</div>"; // Close datepicker_header
		return html;
	},

	/* Adjust one of the date sub-fields. */
	_adjustInstDate: function(inst, offset, period) {
		var year = inst.drawYear + (period === "Y" ? offset : 0),
			month = inst.drawMonth + (period === "M" ? offset : 0),
			day = Math.min(inst.selectedDay, this._getDaysInMonth(year, month)) + (period === "D" ? offset : 0),
			date = this._restrictMinMax(inst, this._daylightSavingAdjust(new Date(year, month, day)));

		inst.selectedDay = date.getDate();
		inst.drawMonth = inst.selectedMonth = date.getMonth();
		inst.drawYear = inst.selectedYear = date.getFullYear();
		if (period === "M" || period === "Y") {
			this._notifyChange(inst);
		}
	},

	/* Ensure a date is within any min/max bounds. */
	_restrictMinMax: function(inst, date) {
		var minDate = this._getMinMaxDate(inst, "min"),
			maxDate = this._getMinMaxDate(inst, "max"),
			newDate = (minDate && date < minDate ? minDate : date);
		return (maxDate && newDate > maxDate ? maxDate : newDate);
	},

	/* Notify change of month/year. */
	_notifyChange: function(inst) {
		var onChange = this._get(inst, "onChangeMonthYear");
		if (onChange) {
			onChange.apply((inst.input ? inst.input[0] : null),
				[inst.selectedYear, inst.selectedMonth + 1, inst]);
		}
	},

	/* Determine the number of months to show. */
	_getNumberOfMonths: function(inst) {
		var numMonths = this._get(inst, "numberOfMonths");
		return (numMonths == null ? [1, 1] : (typeof numMonths === "number" ? [1, numMonths] : numMonths));
	},

	/* Determine the current maximum date - ensure no time components are set. */
	_getMinMaxDate: function(inst, minMax) {
		return this._determineDate(inst, this._get(inst, minMax + "Date"), null);
	},

	/* Find the number of days in a given month. */
	_getDaysInMonth: function(year, month) {
		return 32 - this._daylightSavingAdjust(new Date(year, month, 32)).getDate();
	},

	/* Find the day of the week of the first of a month. */
	_getFirstDayOfMonth: function(year, month) {
		return new Date(year, month, 1).getDay();
	},

	/* Determines if we should allow a "next/prev" month display change. */
	_canAdjustMonth: function(inst, offset, curYear, curMonth) {
		var numMonths = this._getNumberOfMonths(inst),
			date = this._daylightSavingAdjust(new Date(curYear,
			curMonth + (offset < 0 ? offset : numMonths[0] * numMonths[1]), 1));

		if (offset < 0) {
			date.setDate(this._getDaysInMonth(date.getFullYear(), date.getMonth()));
		}
		return this._isInRange(inst, date);
	},

	/* Is the given date in the accepted range? */
	_isInRange: function(inst, date) {
		var yearSplit, currentYear,
			minDate = this._getMinMaxDate(inst, "min"),
			maxDate = this._getMinMaxDate(inst, "max"),
			minYear = null,
			maxYear = null,
			years = this._get(inst, "yearRange");
			if (years){
				yearSplit = years.split(":");
				currentYear = new Date().getFullYear();
				minYear = parseInt(yearSplit[0], 10);
				maxYear = parseInt(yearSplit[1], 10);
				if ( yearSplit[0].match(/[+\-].*/) ) {
					minYear += currentYear;
				}
				if ( yearSplit[1].match(/[+\-].*/) ) {
					maxYear += currentYear;
				}
			}

		return ((!minDate || date.getTime() >= minDate.getTime()) &&
			(!maxDate || date.getTime() <= maxDate.getTime()) &&
			(!minYear || date.getFullYear() >= minYear) &&
			(!maxYear || date.getFullYear() <= maxYear));
	},

	/* Provide the configuration settings for formatting/parsing. */
	_getFormatConfig: function(inst) {
		var shortYearCutoff = this._get(inst, "shortYearCutoff");
		shortYearCutoff = (typeof shortYearCutoff !== "string" ? shortYearCutoff :
			new Date().getFullYear() % 100 + parseInt(shortYearCutoff, 10));
		return {shortYearCutoff: shortYearCutoff,
			dayNamesShort: this._get(inst, "dayNamesShort"), dayNames: this._get(inst, "dayNames"),
			monthNamesShort: this._get(inst, "monthNamesShort"), monthNames: this._get(inst, "monthNames")};
	},

	/* Format the given date for display. */
	_formatDate: function(inst, day, month, year) {
		if (!day) {
			inst.currentDay = inst.selectedDay;
			inst.currentMonth = inst.selectedMonth;
			inst.currentYear = inst.selectedYear;
		}
		var date = (day ? (typeof day === "object" ? day :
			this._daylightSavingAdjust(new Date(year, month, day))) :
			this._daylightSavingAdjust(new Date(inst.currentYear, inst.currentMonth, inst.currentDay)));
		return this.formatDate(this._get(inst, "dateFormat"), date, this._getFormatConfig(inst));
	}
});

/*
 * Bind hover events for datepicker elements.
 * Done via delegate so the binding only occurs once in the lifetime of the parent div.
 * Global datepicker_instActive, set by _updateDatepicker allows the handlers to find their way back to the active picker.
 */
function datepicker_bindHover(dpDiv) {
	var selector = "button, .ui-datepicker-prev, .ui-datepicker-next, .ui-datepicker-calendar td a";
	return dpDiv.delegate(selector, "mouseout", function() {
			$(this).removeClass("ui-state-hover");
			if (this.className.indexOf("ui-datepicker-prev") !== -1) {
				$(this).removeClass("ui-datepicker-prev-hover");
			}
			if (this.className.indexOf("ui-datepicker-next") !== -1) {
				$(this).removeClass("ui-datepicker-next-hover");
			}
		})
		.delegate( selector, "mouseover", datepicker_handleMouseover );
}

function datepicker_handleMouseover() {
	if (!$.datepicker._isDisabledDatepicker( datepicker_instActive.inline? datepicker_instActive.dpDiv.parent()[0] : datepicker_instActive.input[0])) {
		$(this).parents(".ui-datepicker-calendar").find("a").removeClass("ui-state-hover");
		$(this).addClass("ui-state-hover");
		if (this.className.indexOf("ui-datepicker-prev") !== -1) {
			$(this).addClass("ui-datepicker-prev-hover");
		}
		if (this.className.indexOf("ui-datepicker-next") !== -1) {
			$(this).addClass("ui-datepicker-next-hover");
		}
	}
}

/* jQuery extend now ignores nulls! */
function datepicker_extendRemove(target, props) {
	$.extend(target, props);
	for (var name in props) {
		if (props[name] == null) {
			target[name] = props[name];
		}
	}
	return target;
}

/* Invoke the datepicker functionality.
   @param  options  string - a command, optionally followed by additional parameters or
					Object - settings for attaching new datepicker functionality
   @return  jQuery object */
$.fn.datepicker = function(options){

	/* Verify an empty collection wasn't passed - Fixes #6976 */
	if ( !this.length ) {
		return this;
	}

	/* Initialise the date picker. */
	if (!$.datepicker.initialized) {
		$(document).mousedown($.datepicker._checkExternalClick);
		$.datepicker.initialized = true;
	}

	/* Append datepicker main container to body if not exist. */
	if ($("#"+$.datepicker._mainDivId).length === 0) {
		$("body").append($.datepicker.dpDiv);
	}

	var otherArgs = Array.prototype.slice.call(arguments, 1);
	if (typeof options === "string" && (options === "isDisabled" || options === "getDate" || options === "widget")) {
		return $.datepicker["_" + options + "Datepicker"].
			apply($.datepicker, [this[0]].concat(otherArgs));
	}
	if (options === "option" && arguments.length === 2 && typeof arguments[1] === "string") {
		return $.datepicker["_" + options + "Datepicker"].
			apply($.datepicker, [this[0]].concat(otherArgs));
	}
	return this.each(function() {
		typeof options === "string" ?
			$.datepicker["_" + options + "Datepicker"].
				apply($.datepicker, [this].concat(otherArgs)) :
			$.datepicker._attachDatepicker(this, options);
	});
};

$.datepicker = new Datepicker(); // singleton instance
$.datepicker.initialized = false;
$.datepicker.uuid = new Date().getTime();
$.datepicker.version = "1.11.4";

var datepicker = $.datepicker;


/*!
 * jQuery UI Draggable 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/draggable/
 */


$.widget("ui.draggable", $.ui.mouse, {
	version: "1.11.4",
	widgetEventPrefix: "drag",
	options: {
		addClasses: true,
		appendTo: "parent",
		axis: false,
		connectToSortable: false,
		containment: false,
		cursor: "auto",
		cursorAt: false,
		grid: false,
		handle: false,
		helper: "original",
		iframeFix: false,
		opacity: false,
		refreshPositions: false,
		revert: false,
		revertDuration: 500,
		scope: "default",
		scroll: true,
		scrollSensitivity: 20,
		scrollSpeed: 20,
		snap: false,
		snapMode: "both",
		snapTolerance: 20,
		stack: false,
		zIndex: false,

		// callbacks
		drag: null,
		start: null,
		stop: null
	},
	_create: function() {

		if ( this.options.helper === "original" ) {
			this._setPositionRelative();
		}
		if (this.options.addClasses){
			this.element.addClass("ui-draggable");
		}
		if (this.options.disabled){
			this.element.addClass("ui-draggable-disabled");
		}
		this._setHandleClassName();

		this._mouseInit();
	},

	_setOption: function( key, value ) {
		this._super( key, value );
		if ( key === "handle" ) {
			this._removeHandleClassName();
			this._setHandleClassName();
		}
	},

	_destroy: function() {
		if ( ( this.helper || this.element ).is( ".ui-draggable-dragging" ) ) {
			this.destroyOnClear = true;
			return;
		}
		this.element.removeClass( "ui-draggable ui-draggable-dragging ui-draggable-disabled" );
		this._removeHandleClassName();
		this._mouseDestroy();
	},

	_mouseCapture: function(event) {
		var o = this.options;

		this._blurActiveElement( event );

		// among others, prevent a drag on a resizable-handle
		if (this.helper || o.disabled || $(event.target).closest(".ui-resizable-handle").length > 0) {
			return false;
		}

		//Quit if we're not on a valid handle
		this.handle = this._getHandle(event);
		if (!this.handle) {
			return false;
		}

		this._blockFrames( o.iframeFix === true ? "iframe" : o.iframeFix );

		return true;

	},

	_blockFrames: function( selector ) {
		this.iframeBlocks = this.document.find( selector ).map(function() {
			var iframe = $( this );

			return $( "<div>" )
				.css( "position", "absolute" )
				.appendTo( iframe.parent() )
				.outerWidth( iframe.outerWidth() )
				.outerHeight( iframe.outerHeight() )
				.offset( iframe.offset() )[ 0 ];
		});
	},

	_unblockFrames: function() {
		if ( this.iframeBlocks ) {
			this.iframeBlocks.remove();
			delete this.iframeBlocks;
		}
	},

	_blurActiveElement: function( event ) {
		var document = this.document[ 0 ];

		// Only need to blur if the event occurred on the draggable itself, see #10527
		if ( !this.handleElement.is( event.target ) ) {
			return;
		}

		// support: IE9
		// IE9 throws an "Unspecified error" accessing document.activeElement from an <iframe>
		try {

			// Support: IE9, IE10
			// If the <body> is blurred, IE will switch windows, see #9520
			if ( document.activeElement && document.activeElement.nodeName.toLowerCase() !== "body" ) {

				// Blur any element that currently has focus, see #4261
				$( document.activeElement ).blur();
			}
		} catch ( error ) {}
	},

	_mouseStart: function(event) {

		var o = this.options;

		//Create and append the visible helper
		this.helper = this._createHelper(event);

		this.helper.addClass("ui-draggable-dragging");

		//Cache the helper size
		this._cacheHelperProportions();

		//If ddmanager is used for droppables, set the global draggable
		if ($.ui.ddmanager) {
			$.ui.ddmanager.current = this;
		}

		/*
		 * - Position generation -
		 * This block generates everything position related - it's the core of draggables.
		 */

		//Cache the margins of the original element
		this._cacheMargins();

		//Store the helper's css position
		this.cssPosition = this.helper.css( "position" );
		this.scrollParent = this.helper.scrollParent( true );
		this.offsetParent = this.helper.offsetParent();
		this.hasFixedAncestor = this.helper.parents().filter(function() {
				return $( this ).css( "position" ) === "fixed";
			}).length > 0;

		//The element's absolute position on the page minus margins
		this.positionAbs = this.element.offset();
		this._refreshOffsets( event );

		//Generate the original position
		this.originalPosition = this.position = this._generatePosition( event, false );
		this.originalPageX = event.pageX;
		this.originalPageY = event.pageY;

		//Adjust the mouse offset relative to the helper if "cursorAt" is supplied
		(o.cursorAt && this._adjustOffsetFromHelper(o.cursorAt));

		//Set a containment if given in the options
		this._setContainment();

		//Trigger event + callbacks
		if (this._trigger("start", event) === false) {
			this._clear();
			return false;
		}

		//Recache the helper size
		this._cacheHelperProportions();

		//Prepare the droppable offsets
		if ($.ui.ddmanager && !o.dropBehaviour) {
			$.ui.ddmanager.prepareOffsets(this, event);
		}

		// Reset helper's right/bottom css if they're set and set explicit width/height instead
		// as this prevents resizing of elements with right/bottom set (see #7772)
		this._normalizeRightBottom();

		this._mouseDrag(event, true); //Execute the drag once - this causes the helper not to be visible before getting its correct position

		//If the ddmanager is used for droppables, inform the manager that dragging has started (see #5003)
		if ( $.ui.ddmanager ) {
			$.ui.ddmanager.dragStart(this, event);
		}

		return true;
	},

	_refreshOffsets: function( event ) {
		this.offset = {
			top: this.positionAbs.top - this.margins.top,
			left: this.positionAbs.left - this.margins.left,
			scroll: false,
			parent: this._getParentOffset(),
			relative: this._getRelativeOffset()
		};

		this.offset.click = {
			left: event.pageX - this.offset.left,
			top: event.pageY - this.offset.top
		};
	},

	_mouseDrag: function(event, noPropagation) {
		// reset any necessary cached properties (see #5009)
		if ( this.hasFixedAncestor ) {
			this.offset.parent = this._getParentOffset();
		}

		//Compute the helpers position
		this.position = this._generatePosition( event, true );
		this.positionAbs = this._convertPositionTo("absolute");

		//Call plugins and callbacks and use the resulting position if something is returned
		if (!noPropagation) {
			var ui = this._uiHash();
			if (this._trigger("drag", event, ui) === false) {
				this._mouseUp({});
				return false;
			}
			this.position = ui.position;
		}

		this.helper[ 0 ].style.left = this.position.left + "px";
		this.helper[ 0 ].style.top = this.position.top + "px";

		if ($.ui.ddmanager) {
			$.ui.ddmanager.drag(this, event);
		}

		return false;
	},

	_mouseStop: function(event) {

		//If we are using droppables, inform the manager about the drop
		var that = this,
			dropped = false;
		if ($.ui.ddmanager && !this.options.dropBehaviour) {
			dropped = $.ui.ddmanager.drop(this, event);
		}

		//if a drop comes from outside (a sortable)
		if (this.dropped) {
			dropped = this.dropped;
			this.dropped = false;
		}

		if ((this.options.revert === "invalid" && !dropped) || (this.options.revert === "valid" && dropped) || this.options.revert === true || ($.isFunction(this.options.revert) && this.options.revert.call(this.element, dropped))) {
			$(this.helper).animate(this.originalPosition, parseInt(this.options.revertDuration, 10), function() {
				if (that._trigger("stop", event) !== false) {
					that._clear();
				}
			});
		} else {
			if (this._trigger("stop", event) !== false) {
				this._clear();
			}
		}

		return false;
	},

	_mouseUp: function( event ) {
		this._unblockFrames();

		//If the ddmanager is used for droppables, inform the manager that dragging has stopped (see #5003)
		if ( $.ui.ddmanager ) {
			$.ui.ddmanager.dragStop(this, event);
		}

		// Only need to focus if the event occurred on the draggable itself, see #10527
		if ( this.handleElement.is( event.target ) ) {
			// The interaction is over; whether or not the click resulted in a drag, focus the element
			this.element.focus();
		}

		return $.ui.mouse.prototype._mouseUp.call(this, event);
	},

	cancel: function() {

		if (this.helper.is(".ui-draggable-dragging")) {
			this._mouseUp({});
		} else {
			this._clear();
		}

		return this;

	},

	_getHandle: function(event) {
		return this.options.handle ?
			!!$( event.target ).closest( this.element.find( this.options.handle ) ).length :
			true;
	},

	_setHandleClassName: function() {
		this.handleElement = this.options.handle ?
			this.element.find( this.options.handle ) : this.element;
		this.handleElement.addClass( "ui-draggable-handle" );
	},

	_removeHandleClassName: function() {
		this.handleElement.removeClass( "ui-draggable-handle" );
	},

	_createHelper: function(event) {

		var o = this.options,
			helperIsFunction = $.isFunction( o.helper ),
			helper = helperIsFunction ?
				$( o.helper.apply( this.element[ 0 ], [ event ] ) ) :
				( o.helper === "clone" ?
					this.element.clone().removeAttr( "id" ) :
					this.element );

		if (!helper.parents("body").length) {
			helper.appendTo((o.appendTo === "parent" ? this.element[0].parentNode : o.appendTo));
		}

		// http://bugs.jqueryui.com/ticket/9446
		// a helper function can return the original element
		// which wouldn't have been set to relative in _create
		if ( helperIsFunction && helper[ 0 ] === this.element[ 0 ] ) {
			this._setPositionRelative();
		}

		if (helper[0] !== this.element[0] && !(/(fixed|absolute)/).test(helper.css("position"))) {
			helper.css("position", "absolute");
		}

		return helper;

	},

	_setPositionRelative: function() {
		if ( !( /^(?:r|a|f)/ ).test( this.element.css( "position" ) ) ) {
			this.element[ 0 ].style.position = "relative";
		}
	},

	_adjustOffsetFromHelper: function(obj) {
		if (typeof obj === "string") {
			obj = obj.split(" ");
		}
		if ($.isArray(obj)) {
			obj = { left: +obj[0], top: +obj[1] || 0 };
		}
		if ("left" in obj) {
			this.offset.click.left = obj.left + this.margins.left;
		}
		if ("right" in obj) {
			this.offset.click.left = this.helperProportions.width - obj.right + this.margins.left;
		}
		if ("top" in obj) {
			this.offset.click.top = obj.top + this.margins.top;
		}
		if ("bottom" in obj) {
			this.offset.click.top = this.helperProportions.height - obj.bottom + this.margins.top;
		}
	},

	_isRootNode: function( element ) {
		return ( /(html|body)/i ).test( element.tagName ) || element === this.document[ 0 ];
	},

	_getParentOffset: function() {

		//Get the offsetParent and cache its position
		var po = this.offsetParent.offset(),
			document = this.document[ 0 ];

		// This is a special case where we need to modify a offset calculated on start, since the following happened:
		// 1. The position of the helper is absolute, so it's position is calculated based on the next positioned parent
		// 2. The actual offset parent is a child of the scroll parent, and the scroll parent isn't the document, which means that
		//    the scroll is included in the initial calculation of the offset of the parent, and never recalculated upon drag
		if (this.cssPosition === "absolute" && this.scrollParent[0] !== document && $.contains(this.scrollParent[0], this.offsetParent[0])) {
			po.left += this.scrollParent.scrollLeft();
			po.top += this.scrollParent.scrollTop();
		}

		if ( this._isRootNode( this.offsetParent[ 0 ] ) ) {
			po = { top: 0, left: 0 };
		}

		return {
			top: po.top + (parseInt(this.offsetParent.css("borderTopWidth"), 10) || 0),
			left: po.left + (parseInt(this.offsetParent.css("borderLeftWidth"), 10) || 0)
		};

	},

	_getRelativeOffset: function() {
		if ( this.cssPosition !== "relative" ) {
			return { top: 0, left: 0 };
		}

		var p = this.element.position(),
			scrollIsRootNode = this._isRootNode( this.scrollParent[ 0 ] );

		return {
			top: p.top - ( parseInt(this.helper.css( "top" ), 10) || 0 ) + ( !scrollIsRootNode ? this.scrollParent.scrollTop() : 0 ),
			left: p.left - ( parseInt(this.helper.css( "left" ), 10) || 0 ) + ( !scrollIsRootNode ? this.scrollParent.scrollLeft() : 0 )
		};

	},

	_cacheMargins: function() {
		this.margins = {
			left: (parseInt(this.element.css("marginLeft"), 10) || 0),
			top: (parseInt(this.element.css("marginTop"), 10) || 0),
			right: (parseInt(this.element.css("marginRight"), 10) || 0),
			bottom: (parseInt(this.element.css("marginBottom"), 10) || 0)
		};
	},

	_cacheHelperProportions: function() {
		this.helperProportions = {
			width: this.helper.outerWidth(),
			height: this.helper.outerHeight()
		};
	},

	_setContainment: function() {

		var isUserScrollable, c, ce,
			o = this.options,
			document = this.document[ 0 ];

		this.relativeContainer = null;

		if ( !o.containment ) {
			this.containment = null;
			return;
		}

		if ( o.containment === "window" ) {
			this.containment = [
				$( window ).scrollLeft() - this.offset.relative.left - this.offset.parent.left,
				$( window ).scrollTop() - this.offset.relative.top - this.offset.parent.top,
				$( window ).scrollLeft() + $( window ).width() - this.helperProportions.width - this.margins.left,
				$( window ).scrollTop() + ( $( window ).height() || document.body.parentNode.scrollHeight ) - this.helperProportions.height - this.margins.top
			];
			return;
		}

		if ( o.containment === "document") {
			this.containment = [
				0,
				0,
				$( document ).width() - this.helperProportions.width - this.margins.left,
				( $( document ).height() || document.body.parentNode.scrollHeight ) - this.helperProportions.height - this.margins.top
			];
			return;
		}

		if ( o.containment.constructor === Array ) {
			this.containment = o.containment;
			return;
		}

		if ( o.containment === "parent" ) {
			o.containment = this.helper[ 0 ].parentNode;
		}

		c = $( o.containment );
		ce = c[ 0 ];

		if ( !ce ) {
			return;
		}

		isUserScrollable = /(scroll|auto)/.test( c.css( "overflow" ) );

		this.containment = [
			( parseInt( c.css( "borderLeftWidth" ), 10 ) || 0 ) + ( parseInt( c.css( "paddingLeft" ), 10 ) || 0 ),
			( parseInt( c.css( "borderTopWidth" ), 10 ) || 0 ) + ( parseInt( c.css( "paddingTop" ), 10 ) || 0 ),
			( isUserScrollable ? Math.max( ce.scrollWidth, ce.offsetWidth ) : ce.offsetWidth ) -
				( parseInt( c.css( "borderRightWidth" ), 10 ) || 0 ) -
				( parseInt( c.css( "paddingRight" ), 10 ) || 0 ) -
				this.helperProportions.width -
				this.margins.left -
				this.margins.right,
			( isUserScrollable ? Math.max( ce.scrollHeight, ce.offsetHeight ) : ce.offsetHeight ) -
				( parseInt( c.css( "borderBottomWidth" ), 10 ) || 0 ) -
				( parseInt( c.css( "paddingBottom" ), 10 ) || 0 ) -
				this.helperProportions.height -
				this.margins.top -
				this.margins.bottom
		];
		this.relativeContainer = c;
	},

	_convertPositionTo: function(d, pos) {

		if (!pos) {
			pos = this.position;
		}

		var mod = d === "absolute" ? 1 : -1,
			scrollIsRootNode = this._isRootNode( this.scrollParent[ 0 ] );

		return {
			top: (
				pos.top	+																// The absolute mouse position
				this.offset.relative.top * mod +										// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.top * mod -										// The offsetParent's offset without borders (offset + border)
				( ( this.cssPosition === "fixed" ? -this.offset.scroll.top : ( scrollIsRootNode ? 0 : this.offset.scroll.top ) ) * mod)
			),
			left: (
				pos.left +																// The absolute mouse position
				this.offset.relative.left * mod +										// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.left * mod	-										// The offsetParent's offset without borders (offset + border)
				( ( this.cssPosition === "fixed" ? -this.offset.scroll.left : ( scrollIsRootNode ? 0 : this.offset.scroll.left ) ) * mod)
			)
		};

	},

	_generatePosition: function( event, constrainPosition ) {

		var containment, co, top, left,
			o = this.options,
			scrollIsRootNode = this._isRootNode( this.scrollParent[ 0 ] ),
			pageX = event.pageX,
			pageY = event.pageY;

		// Cache the scroll
		if ( !scrollIsRootNode || !this.offset.scroll ) {
			this.offset.scroll = {
				top: this.scrollParent.scrollTop(),
				left: this.scrollParent.scrollLeft()
			};
		}

		/*
		 * - Position constraining -
		 * Constrain the position to a mix of grid, containment.
		 */

		// If we are not dragging yet, we won't check for options
		if ( constrainPosition ) {
			if ( this.containment ) {
				if ( this.relativeContainer ){
					co = this.relativeContainer.offset();
					containment = [
						this.containment[ 0 ] + co.left,
						this.containment[ 1 ] + co.top,
						this.containment[ 2 ] + co.left,
						this.containment[ 3 ] + co.top
					];
				} else {
					containment = this.containment;
				}

				if (event.pageX - this.offset.click.left < containment[0]) {
					pageX = containment[0] + this.offset.click.left;
				}
				if (event.pageY - this.offset.click.top < containment[1]) {
					pageY = containment[1] + this.offset.click.top;
				}
				if (event.pageX - this.offset.click.left > containment[2]) {
					pageX = containment[2] + this.offset.click.left;
				}
				if (event.pageY - this.offset.click.top > containment[3]) {
					pageY = containment[3] + this.offset.click.top;
				}
			}

			if (o.grid) {
				//Check for grid elements set to 0 to prevent divide by 0 error causing invalid argument errors in IE (see ticket #6950)
				top = o.grid[1] ? this.originalPageY + Math.round((pageY - this.originalPageY) / o.grid[1]) * o.grid[1] : this.originalPageY;
				pageY = containment ? ((top - this.offset.click.top >= containment[1] || top - this.offset.click.top > containment[3]) ? top : ((top - this.offset.click.top >= containment[1]) ? top - o.grid[1] : top + o.grid[1])) : top;

				left = o.grid[0] ? this.originalPageX + Math.round((pageX - this.originalPageX) / o.grid[0]) * o.grid[0] : this.originalPageX;
				pageX = containment ? ((left - this.offset.click.left >= containment[0] || left - this.offset.click.left > containment[2]) ? left : ((left - this.offset.click.left >= containment[0]) ? left - o.grid[0] : left + o.grid[0])) : left;
			}

			if ( o.axis === "y" ) {
				pageX = this.originalPageX;
			}

			if ( o.axis === "x" ) {
				pageY = this.originalPageY;
			}
		}

		return {
			top: (
				pageY -																	// The absolute mouse position
				this.offset.click.top	-												// Click offset (relative to the element)
				this.offset.relative.top -												// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.top +												// The offsetParent's offset without borders (offset + border)
				( this.cssPosition === "fixed" ? -this.offset.scroll.top : ( scrollIsRootNode ? 0 : this.offset.scroll.top ) )
			),
			left: (
				pageX -																	// The absolute mouse position
				this.offset.click.left -												// Click offset (relative to the element)
				this.offset.relative.left -												// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.left +												// The offsetParent's offset without borders (offset + border)
				( this.cssPosition === "fixed" ? -this.offset.scroll.left : ( scrollIsRootNode ? 0 : this.offset.scroll.left ) )
			)
		};

	},

	_clear: function() {
		this.helper.removeClass("ui-draggable-dragging");
		if (this.helper[0] !== this.element[0] && !this.cancelHelperRemoval) {
			this.helper.remove();
		}
		this.helper = null;
		this.cancelHelperRemoval = false;
		if ( this.destroyOnClear ) {
			this.destroy();
		}
	},

	_normalizeRightBottom: function() {
		if ( this.options.axis !== "y" && this.helper.css( "right" ) !== "auto" ) {
			this.helper.width( this.helper.width() );
			this.helper.css( "right", "auto" );
		}
		if ( this.options.axis !== "x" && this.helper.css( "bottom" ) !== "auto" ) {
			this.helper.height( this.helper.height() );
			this.helper.css( "bottom", "auto" );
		}
	},

	// From now on bulk stuff - mainly helpers

	_trigger: function( type, event, ui ) {
		ui = ui || this._uiHash();
		$.ui.plugin.call( this, type, [ event, ui, this ], true );

		// Absolute position and offset (see #6884 ) have to be recalculated after plugins
		if ( /^(drag|start|stop)/.test( type ) ) {
			this.positionAbs = this._convertPositionTo( "absolute" );
			ui.offset = this.positionAbs;
		}
		return $.Widget.prototype._trigger.call( this, type, event, ui );
	},

	plugins: {},

	_uiHash: function() {
		return {
			helper: this.helper,
			position: this.position,
			originalPosition: this.originalPosition,
			offset: this.positionAbs
		};
	}

});

$.ui.plugin.add( "draggable", "connectToSortable", {
	start: function( event, ui, draggable ) {
		var uiSortable = $.extend( {}, ui, {
			item: draggable.element
		});

		draggable.sortables = [];
		$( draggable.options.connectToSortable ).each(function() {
			var sortable = $( this ).sortable( "instance" );

			if ( sortable && !sortable.options.disabled ) {
				draggable.sortables.push( sortable );

				// refreshPositions is called at drag start to refresh the containerCache
				// which is used in drag. This ensures it's initialized and synchronized
				// with any changes that might have happened on the page since initialization.
				sortable.refreshPositions();
				sortable._trigger("activate", event, uiSortable);
			}
		});
	},
	stop: function( event, ui, draggable ) {
		var uiSortable = $.extend( {}, ui, {
			item: draggable.element
		});

		draggable.cancelHelperRemoval = false;

		$.each( draggable.sortables, function() {
			var sortable = this;

			if ( sortable.isOver ) {
				sortable.isOver = 0;

				// Allow this sortable to handle removing the helper
				draggable.cancelHelperRemoval = true;
				sortable.cancelHelperRemoval = false;

				// Use _storedCSS To restore properties in the sortable,
				// as this also handles revert (#9675) since the draggable
				// may have modified them in unexpected ways (#8809)
				sortable._storedCSS = {
					position: sortable.placeholder.css( "position" ),
					top: sortable.placeholder.css( "top" ),
					left: sortable.placeholder.css( "left" )
				};

				sortable._mouseStop(event);

				// Once drag has ended, the sortable should return to using
				// its original helper, not the shared helper from draggable
				sortable.options.helper = sortable.options._helper;
			} else {
				// Prevent this Sortable from removing the helper.
				// However, don't set the draggable to remove the helper
				// either as another connected Sortable may yet handle the removal.
				sortable.cancelHelperRemoval = true;

				sortable._trigger( "deactivate", event, uiSortable );
			}
		});
	},
	drag: function( event, ui, draggable ) {
		$.each( draggable.sortables, function() {
			var innermostIntersecting = false,
				sortable = this;

			// Copy over variables that sortable's _intersectsWith uses
			sortable.positionAbs = draggable.positionAbs;
			sortable.helperProportions = draggable.helperProportions;
			sortable.offset.click = draggable.offset.click;

			if ( sortable._intersectsWith( sortable.containerCache ) ) {
				innermostIntersecting = true;

				$.each( draggable.sortables, function() {
					// Copy over variables that sortable's _intersectsWith uses
					this.positionAbs = draggable.positionAbs;
					this.helperProportions = draggable.helperProportions;
					this.offset.click = draggable.offset.click;

					if ( this !== sortable &&
							this._intersectsWith( this.containerCache ) &&
							$.contains( sortable.element[ 0 ], this.element[ 0 ] ) ) {
						innermostIntersecting = false;
					}

					return innermostIntersecting;
				});
			}

			if ( innermostIntersecting ) {
				// If it intersects, we use a little isOver variable and set it once,
				// so that the move-in stuff gets fired only once.
				if ( !sortable.isOver ) {
					sortable.isOver = 1;

					// Store draggable's parent in case we need to reappend to it later.
					draggable._parent = ui.helper.parent();

					sortable.currentItem = ui.helper
						.appendTo( sortable.element )
						.data( "ui-sortable-item", true );

					// Store helper option to later restore it
					sortable.options._helper = sortable.options.helper;

					sortable.options.helper = function() {
						return ui.helper[ 0 ];
					};

					// Fire the start events of the sortable with our passed browser event,
					// and our own helper (so it doesn't create a new one)
					event.target = sortable.currentItem[ 0 ];
					sortable._mouseCapture( event, true );
					sortable._mouseStart( event, true, true );

					// Because the browser event is way off the new appended portlet,
					// modify necessary variables to reflect the changes
					sortable.offset.click.top = draggable.offset.click.top;
					sortable.offset.click.left = draggable.offset.click.left;
					sortable.offset.parent.left -= draggable.offset.parent.left -
						sortable.offset.parent.left;
					sortable.offset.parent.top -= draggable.offset.parent.top -
						sortable.offset.parent.top;

					draggable._trigger( "toSortable", event );

					// Inform draggable that the helper is in a valid drop zone,
					// used solely in the revert option to handle "valid/invalid".
					draggable.dropped = sortable.element;

					// Need to refreshPositions of all sortables in the case that
					// adding to one sortable changes the location of the other sortables (#9675)
					$.each( draggable.sortables, function() {
						this.refreshPositions();
					});

					// hack so receive/update callbacks work (mostly)
					draggable.currentItem = draggable.element;
					sortable.fromOutside = draggable;
				}

				if ( sortable.currentItem ) {
					sortable._mouseDrag( event );
					// Copy the sortable's position because the draggable's can potentially reflect
					// a relative position, while sortable is always absolute, which the dragged
					// element has now become. (#8809)
					ui.position = sortable.position;
				}
			} else {
				// If it doesn't intersect with the sortable, and it intersected before,
				// we fake the drag stop of the sortable, but make sure it doesn't remove
				// the helper by using cancelHelperRemoval.
				if ( sortable.isOver ) {

					sortable.isOver = 0;
					sortable.cancelHelperRemoval = true;

					// Calling sortable's mouseStop would trigger a revert,
					// so revert must be temporarily false until after mouseStop is called.
					sortable.options._revert = sortable.options.revert;
					sortable.options.revert = false;

					sortable._trigger( "out", event, sortable._uiHash( sortable ) );
					sortable._mouseStop( event, true );

					// restore sortable behaviors that were modfied
					// when the draggable entered the sortable area (#9481)
					sortable.options.revert = sortable.options._revert;
					sortable.options.helper = sortable.options._helper;

					if ( sortable.placeholder ) {
						sortable.placeholder.remove();
					}

					// Restore and recalculate the draggable's offset considering the sortable
					// may have modified them in unexpected ways. (#8809, #10669)
					ui.helper.appendTo( draggable._parent );
					draggable._refreshOffsets( event );
					ui.position = draggable._generatePosition( event, true );

					draggable._trigger( "fromSortable", event );

					// Inform draggable that the helper is no longer in a valid drop zone
					draggable.dropped = false;

					// Need to refreshPositions of all sortables just in case removing
					// from one sortable changes the location of other sortables (#9675)
					$.each( draggable.sortables, function() {
						this.refreshPositions();
					});
				}
			}
		});
	}
});

$.ui.plugin.add("draggable", "cursor", {
	start: function( event, ui, instance ) {
		var t = $( "body" ),
			o = instance.options;

		if (t.css("cursor")) {
			o._cursor = t.css("cursor");
		}
		t.css("cursor", o.cursor);
	},
	stop: function( event, ui, instance ) {
		var o = instance.options;
		if (o._cursor) {
			$("body").css("cursor", o._cursor);
		}
	}
});

$.ui.plugin.add("draggable", "opacity", {
	start: function( event, ui, instance ) {
		var t = $( ui.helper ),
			o = instance.options;
		if (t.css("opacity")) {
			o._opacity = t.css("opacity");
		}
		t.css("opacity", o.opacity);
	},
	stop: function( event, ui, instance ) {
		var o = instance.options;
		if (o._opacity) {
			$(ui.helper).css("opacity", o._opacity);
		}
	}
});

$.ui.plugin.add("draggable", "scroll", {
	start: function( event, ui, i ) {
		if ( !i.scrollParentNotHidden ) {
			i.scrollParentNotHidden = i.helper.scrollParent( false );
		}

		if ( i.scrollParentNotHidden[ 0 ] !== i.document[ 0 ] && i.scrollParentNotHidden[ 0 ].tagName !== "HTML" ) {
			i.overflowOffset = i.scrollParentNotHidden.offset();
		}
	},
	drag: function( event, ui, i  ) {

		var o = i.options,
			scrolled = false,
			scrollParent = i.scrollParentNotHidden[ 0 ],
			document = i.document[ 0 ];

		if ( scrollParent !== document && scrollParent.tagName !== "HTML" ) {
			if ( !o.axis || o.axis !== "x" ) {
				if ( ( i.overflowOffset.top + scrollParent.offsetHeight ) - event.pageY < o.scrollSensitivity ) {
					scrollParent.scrollTop = scrolled = scrollParent.scrollTop + o.scrollSpeed;
				} else if ( event.pageY - i.overflowOffset.top < o.scrollSensitivity ) {
					scrollParent.scrollTop = scrolled = scrollParent.scrollTop - o.scrollSpeed;
				}
			}

			if ( !o.axis || o.axis !== "y" ) {
				if ( ( i.overflowOffset.left + scrollParent.offsetWidth ) - event.pageX < o.scrollSensitivity ) {
					scrollParent.scrollLeft = scrolled = scrollParent.scrollLeft + o.scrollSpeed;
				} else if ( event.pageX - i.overflowOffset.left < o.scrollSensitivity ) {
					scrollParent.scrollLeft = scrolled = scrollParent.scrollLeft - o.scrollSpeed;
				}
			}

		} else {

			if (!o.axis || o.axis !== "x") {
				if (event.pageY - $(document).scrollTop() < o.scrollSensitivity) {
					scrolled = $(document).scrollTop($(document).scrollTop() - o.scrollSpeed);
				} else if ($(window).height() - (event.pageY - $(document).scrollTop()) < o.scrollSensitivity) {
					scrolled = $(document).scrollTop($(document).scrollTop() + o.scrollSpeed);
				}
			}

			if (!o.axis || o.axis !== "y") {
				if (event.pageX - $(document).scrollLeft() < o.scrollSensitivity) {
					scrolled = $(document).scrollLeft($(document).scrollLeft() - o.scrollSpeed);
				} else if ($(window).width() - (event.pageX - $(document).scrollLeft()) < o.scrollSensitivity) {
					scrolled = $(document).scrollLeft($(document).scrollLeft() + o.scrollSpeed);
				}
			}

		}

		if (scrolled !== false && $.ui.ddmanager && !o.dropBehaviour) {
			$.ui.ddmanager.prepareOffsets(i, event);
		}

	}
});

$.ui.plugin.add("draggable", "snap", {
	start: function( event, ui, i ) {

		var o = i.options;

		i.snapElements = [];

		$(o.snap.constructor !== String ? ( o.snap.items || ":data(ui-draggable)" ) : o.snap).each(function() {
			var $t = $(this),
				$o = $t.offset();
			if (this !== i.element[0]) {
				i.snapElements.push({
					item: this,
					width: $t.outerWidth(), height: $t.outerHeight(),
					top: $o.top, left: $o.left
				});
			}
		});

	},
	drag: function( event, ui, inst ) {

		var ts, bs, ls, rs, l, r, t, b, i, first,
			o = inst.options,
			d = o.snapTolerance,
			x1 = ui.offset.left, x2 = x1 + inst.helperProportions.width,
			y1 = ui.offset.top, y2 = y1 + inst.helperProportions.height;

		for (i = inst.snapElements.length - 1; i >= 0; i--){

			l = inst.snapElements[i].left - inst.margins.left;
			r = l + inst.snapElements[i].width;
			t = inst.snapElements[i].top - inst.margins.top;
			b = t + inst.snapElements[i].height;

			if ( x2 < l - d || x1 > r + d || y2 < t - d || y1 > b + d || !$.contains( inst.snapElements[ i ].item.ownerDocument, inst.snapElements[ i ].item ) ) {
				if (inst.snapElements[i].snapping) {
					(inst.options.snap.release && inst.options.snap.release.call(inst.element, event, $.extend(inst._uiHash(), { snapItem: inst.snapElements[i].item })));
				}
				inst.snapElements[i].snapping = false;
				continue;
			}

			if (o.snapMode !== "inner") {
				ts = Math.abs(t - y2) <= d;
				bs = Math.abs(b - y1) <= d;
				ls = Math.abs(l - x2) <= d;
				rs = Math.abs(r - x1) <= d;
				if (ts) {
					ui.position.top = inst._convertPositionTo("relative", { top: t - inst.helperProportions.height, left: 0 }).top;
				}
				if (bs) {
					ui.position.top = inst._convertPositionTo("relative", { top: b, left: 0 }).top;
				}
				if (ls) {
					ui.position.left = inst._convertPositionTo("relative", { top: 0, left: l - inst.helperProportions.width }).left;
				}
				if (rs) {
					ui.position.left = inst._convertPositionTo("relative", { top: 0, left: r }).left;
				}
			}

			first = (ts || bs || ls || rs);

			if (o.snapMode !== "outer") {
				ts = Math.abs(t - y1) <= d;
				bs = Math.abs(b - y2) <= d;
				ls = Math.abs(l - x1) <= d;
				rs = Math.abs(r - x2) <= d;
				if (ts) {
					ui.position.top = inst._convertPositionTo("relative", { top: t, left: 0 }).top;
				}
				if (bs) {
					ui.position.top = inst._convertPositionTo("relative", { top: b - inst.helperProportions.height, left: 0 }).top;
				}
				if (ls) {
					ui.position.left = inst._convertPositionTo("relative", { top: 0, left: l }).left;
				}
				if (rs) {
					ui.position.left = inst._convertPositionTo("relative", { top: 0, left: r - inst.helperProportions.width }).left;
				}
			}

			if (!inst.snapElements[i].snapping && (ts || bs || ls || rs || first)) {
				(inst.options.snap.snap && inst.options.snap.snap.call(inst.element, event, $.extend(inst._uiHash(), { snapItem: inst.snapElements[i].item })));
			}
			inst.snapElements[i].snapping = (ts || bs || ls || rs || first);

		}

	}
});

$.ui.plugin.add("draggable", "stack", {
	start: function( event, ui, instance ) {
		var min,
			o = instance.options,
			group = $.makeArray($(o.stack)).sort(function(a, b) {
				return (parseInt($(a).css("zIndex"), 10) || 0) - (parseInt($(b).css("zIndex"), 10) || 0);
			});

		if (!group.length) { return; }

		min = parseInt($(group[0]).css("zIndex"), 10) || 0;
		$(group).each(function(i) {
			$(this).css("zIndex", min + i);
		});
		this.css("zIndex", (min + group.length));
	}
});

$.ui.plugin.add("draggable", "zIndex", {
	start: function( event, ui, instance ) {
		var t = $( ui.helper ),
			o = instance.options;

		if (t.css("zIndex")) {
			o._zIndex = t.css("zIndex");
		}
		t.css("zIndex", o.zIndex);
	},
	stop: function( event, ui, instance ) {
		var o = instance.options;

		if (o._zIndex) {
			$(ui.helper).css("zIndex", o._zIndex);
		}
	}
});

var draggable = $.ui.draggable;


/*!
 * jQuery UI Resizable 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/resizable/
 */


$.widget("ui.resizable", $.ui.mouse, {
	version: "1.11.4",
	widgetEventPrefix: "resize",
	options: {
		alsoResize: false,
		animate: false,
		animateDuration: "slow",
		animateEasing: "swing",
		aspectRatio: false,
		autoHide: false,
		containment: false,
		ghost: false,
		grid: false,
		handles: "e,s,se",
		helper: false,
		maxHeight: null,
		maxWidth: null,
		minHeight: 10,
		minWidth: 10,
		// See #7960
		zIndex: 90,

		// callbacks
		resize: null,
		start: null,
		stop: null
	},

	_num: function( value ) {
		return parseInt( value, 10 ) || 0;
	},

	_isNumber: function( value ) {
		return !isNaN( parseInt( value, 10 ) );
	},

	_hasScroll: function( el, a ) {

		if ( $( el ).css( "overflow" ) === "hidden") {
			return false;
		}

		var scroll = ( a && a === "left" ) ? "scrollLeft" : "scrollTop",
			has = false;

		if ( el[ scroll ] > 0 ) {
			return true;
		}

		// TODO: determine which cases actually cause this to happen
		// if the element doesn't have the scroll set, see if it's possible to
		// set the scroll
		el[ scroll ] = 1;
		has = ( el[ scroll ] > 0 );
		el[ scroll ] = 0;
		return has;
	},

	_create: function() {

		var n, i, handle, axis, hname,
			that = this,
			o = this.options;
		this.element.addClass("ui-resizable");

		$.extend(this, {
			_aspectRatio: !!(o.aspectRatio),
			aspectRatio: o.aspectRatio,
			originalElement: this.element,
			_proportionallyResizeElements: [],
			_helper: o.helper || o.ghost || o.animate ? o.helper || "ui-resizable-helper" : null
		});

		// Wrap the element if it cannot hold child nodes
		if (this.element[0].nodeName.match(/^(canvas|textarea|input|select|button|img)$/i)) {

			this.element.wrap(
				$("<div class='ui-wrapper' style='overflow: hidden;'></div>").css({
					position: this.element.css("position"),
					width: this.element.outerWidth(),
					height: this.element.outerHeight(),
					top: this.element.css("top"),
					left: this.element.css("left")
				})
			);

			this.element = this.element.parent().data(
				"ui-resizable", this.element.resizable( "instance" )
			);

			this.elementIsWrapper = true;

			this.element.css({
				marginLeft: this.originalElement.css("marginLeft"),
				marginTop: this.originalElement.css("marginTop"),
				marginRight: this.originalElement.css("marginRight"),
				marginBottom: this.originalElement.css("marginBottom")
			});
			this.originalElement.css({
				marginLeft: 0,
				marginTop: 0,
				marginRight: 0,
				marginBottom: 0
			});
			// support: Safari
			// Prevent Safari textarea resize
			this.originalResizeStyle = this.originalElement.css("resize");
			this.originalElement.css("resize", "none");

			this._proportionallyResizeElements.push( this.originalElement.css({
				position: "static",
				zoom: 1,
				display: "block"
			}) );

			// support: IE9
			// avoid IE jump (hard set the margin)
			this.originalElement.css({ margin: this.originalElement.css("margin") });

			this._proportionallyResize();
		}

		this.handles = o.handles ||
			( !$(".ui-resizable-handle", this.element).length ?
				"e,s,se" : {
					n: ".ui-resizable-n",
					e: ".ui-resizable-e",
					s: ".ui-resizable-s",
					w: ".ui-resizable-w",
					se: ".ui-resizable-se",
					sw: ".ui-resizable-sw",
					ne: ".ui-resizable-ne",
					nw: ".ui-resizable-nw"
				} );

		this._handles = $();
		if ( this.handles.constructor === String ) {

			if ( this.handles === "all") {
				this.handles = "n,e,s,w,se,sw,ne,nw";
			}

			n = this.handles.split(",");
			this.handles = {};

			for (i = 0; i < n.length; i++) {

				handle = $.trim(n[i]);
				hname = "ui-resizable-" + handle;
				axis = $("<div class='ui-resizable-handle " + hname + "'></div>");

				axis.css({ zIndex: o.zIndex });

				// TODO : What's going on here?
				if ("se" === handle) {
					axis.addClass("ui-icon ui-icon-gripsmall-diagonal-se");
				}

				this.handles[handle] = ".ui-resizable-" + handle;
				this.element.append(axis);
			}

		}

		this._renderAxis = function(target) {

			var i, axis, padPos, padWrapper;

			target = target || this.element;

			for (i in this.handles) {

				if (this.handles[i].constructor === String) {
					this.handles[i] = this.element.children( this.handles[ i ] ).first().show();
				} else if ( this.handles[ i ].jquery || this.handles[ i ].nodeType ) {
					this.handles[ i ] = $( this.handles[ i ] );
					this._on( this.handles[ i ], { "mousedown": that._mouseDown });
				}

				if (this.elementIsWrapper && this.originalElement[0].nodeName.match(/^(textarea|input|select|button)$/i)) {

					axis = $(this.handles[i], this.element);

					padWrapper = /sw|ne|nw|se|n|s/.test(i) ? axis.outerHeight() : axis.outerWidth();

					padPos = [ "padding",
						/ne|nw|n/.test(i) ? "Top" :
						/se|sw|s/.test(i) ? "Bottom" :
						/^e$/.test(i) ? "Right" : "Left" ].join("");

					target.css(padPos, padWrapper);

					this._proportionallyResize();
				}

				this._handles = this._handles.add( this.handles[ i ] );
			}
		};

		// TODO: make renderAxis a prototype function
		this._renderAxis(this.element);

		this._handles = this._handles.add( this.element.find( ".ui-resizable-handle" ) );
		this._handles.disableSelection();

		this._handles.mouseover(function() {
			if (!that.resizing) {
				if (this.className) {
					axis = this.className.match(/ui-resizable-(se|sw|ne|nw|n|e|s|w)/i);
				}
				that.axis = axis && axis[1] ? axis[1] : "se";
			}
		});

		if (o.autoHide) {
			this._handles.hide();
			$(this.element)
				.addClass("ui-resizable-autohide")
				.mouseenter(function() {
					if (o.disabled) {
						return;
					}
					$(this).removeClass("ui-resizable-autohide");
					that._handles.show();
				})
				.mouseleave(function() {
					if (o.disabled) {
						return;
					}
					if (!that.resizing) {
						$(this).addClass("ui-resizable-autohide");
						that._handles.hide();
					}
				});
		}

		this._mouseInit();
	},

	_destroy: function() {

		this._mouseDestroy();

		var wrapper,
			_destroy = function(exp) {
				$(exp)
					.removeClass("ui-resizable ui-resizable-disabled ui-resizable-resizing")
					.removeData("resizable")
					.removeData("ui-resizable")
					.unbind(".resizable")
					.find(".ui-resizable-handle")
						.remove();
			};

		// TODO: Unwrap at same DOM position
		if (this.elementIsWrapper) {
			_destroy(this.element);
			wrapper = this.element;
			this.originalElement.css({
				position: wrapper.css("position"),
				width: wrapper.outerWidth(),
				height: wrapper.outerHeight(),
				top: wrapper.css("top"),
				left: wrapper.css("left")
			}).insertAfter( wrapper );
			wrapper.remove();
		}

		this.originalElement.css("resize", this.originalResizeStyle);
		_destroy(this.originalElement);

		return this;
	},

	_mouseCapture: function(event) {
		var i, handle,
			capture = false;

		for (i in this.handles) {
			handle = $(this.handles[i])[0];
			if (handle === event.target || $.contains(handle, event.target)) {
				capture = true;
			}
		}

		return !this.options.disabled && capture;
	},

	_mouseStart: function(event) {

		var curleft, curtop, cursor,
			o = this.options,
			el = this.element;

		this.resizing = true;

		this._renderProxy();

		curleft = this._num(this.helper.css("left"));
		curtop = this._num(this.helper.css("top"));

		if (o.containment) {
			curleft += $(o.containment).scrollLeft() || 0;
			curtop += $(o.containment).scrollTop() || 0;
		}

		this.offset = this.helper.offset();
		this.position = { left: curleft, top: curtop };

		this.size = this._helper ? {
				width: this.helper.width(),
				height: this.helper.height()
			} : {
				width: el.width(),
				height: el.height()
			};

		this.originalSize = this._helper ? {
				width: el.outerWidth(),
				height: el.outerHeight()
			} : {
				width: el.width(),
				height: el.height()
			};

		this.sizeDiff = {
			width: el.outerWidth() - el.width(),
			height: el.outerHeight() - el.height()
		};

		this.originalPosition = { left: curleft, top: curtop };
		this.originalMousePosition = { left: event.pageX, top: event.pageY };

		this.aspectRatio = (typeof o.aspectRatio === "number") ?
			o.aspectRatio :
			((this.originalSize.width / this.originalSize.height) || 1);

		cursor = $(".ui-resizable-" + this.axis).css("cursor");
		$("body").css("cursor", cursor === "auto" ? this.axis + "-resize" : cursor);

		el.addClass("ui-resizable-resizing");
		this._propagate("start", event);
		return true;
	},

	_mouseDrag: function(event) {

		var data, props,
			smp = this.originalMousePosition,
			a = this.axis,
			dx = (event.pageX - smp.left) || 0,
			dy = (event.pageY - smp.top) || 0,
			trigger = this._change[a];

		this._updatePrevProperties();

		if (!trigger) {
			return false;
		}

		data = trigger.apply(this, [ event, dx, dy ]);

		this._updateVirtualBoundaries(event.shiftKey);
		if (this._aspectRatio || event.shiftKey) {
			data = this._updateRatio(data, event);
		}

		data = this._respectSize(data, event);

		this._updateCache(data);

		this._propagate("resize", event);

		props = this._applyChanges();

		if ( !this._helper && this._proportionallyResizeElements.length ) {
			this._proportionallyResize();
		}

		if ( !$.isEmptyObject( props ) ) {
			this._updatePrevProperties();
			this._trigger( "resize", event, this.ui() );
			this._applyChanges();
		}

		return false;
	},

	_mouseStop: function(event) {

		this.resizing = false;
		var pr, ista, soffseth, soffsetw, s, left, top,
			o = this.options, that = this;

		if (this._helper) {

			pr = this._proportionallyResizeElements;
			ista = pr.length && (/textarea/i).test(pr[0].nodeName);
			soffseth = ista && this._hasScroll(pr[0], "left") ? 0 : that.sizeDiff.height;
			soffsetw = ista ? 0 : that.sizeDiff.width;

			s = {
				width: (that.helper.width()  - soffsetw),
				height: (that.helper.height() - soffseth)
			};
			left = (parseInt(that.element.css("left"), 10) +
				(that.position.left - that.originalPosition.left)) || null;
			top = (parseInt(that.element.css("top"), 10) +
				(that.position.top - that.originalPosition.top)) || null;

			if (!o.animate) {
				this.element.css($.extend(s, { top: top, left: left }));
			}

			that.helper.height(that.size.height);
			that.helper.width(that.size.width);

			if (this._helper && !o.animate) {
				this._proportionallyResize();
			}
		}

		$("body").css("cursor", "auto");

		this.element.removeClass("ui-resizable-resizing");

		this._propagate("stop", event);

		if (this._helper) {
			this.helper.remove();
		}

		return false;

	},

	_updatePrevProperties: function() {
		this.prevPosition = {
			top: this.position.top,
			left: this.position.left
		};
		this.prevSize = {
			width: this.size.width,
			height: this.size.height
		};
	},

	_applyChanges: function() {
		var props = {};

		if ( this.position.top !== this.prevPosition.top ) {
			props.top = this.position.top + "px";
		}
		if ( this.position.left !== this.prevPosition.left ) {
			props.left = this.position.left + "px";
		}
		if ( this.size.width !== this.prevSize.width ) {
			props.width = this.size.width + "px";
		}
		if ( this.size.height !== this.prevSize.height ) {
			props.height = this.size.height + "px";
		}

		this.helper.css( props );

		return props;
	},

	_updateVirtualBoundaries: function(forceAspectRatio) {
		var pMinWidth, pMaxWidth, pMinHeight, pMaxHeight, b,
			o = this.options;

		b = {
			minWidth: this._isNumber(o.minWidth) ? o.minWidth : 0,
			maxWidth: this._isNumber(o.maxWidth) ? o.maxWidth : Infinity,
			minHeight: this._isNumber(o.minHeight) ? o.minHeight : 0,
			maxHeight: this._isNumber(o.maxHeight) ? o.maxHeight : Infinity
		};

		if (this._aspectRatio || forceAspectRatio) {
			pMinWidth = b.minHeight * this.aspectRatio;
			pMinHeight = b.minWidth / this.aspectRatio;
			pMaxWidth = b.maxHeight * this.aspectRatio;
			pMaxHeight = b.maxWidth / this.aspectRatio;

			if (pMinWidth > b.minWidth) {
				b.minWidth = pMinWidth;
			}
			if (pMinHeight > b.minHeight) {
				b.minHeight = pMinHeight;
			}
			if (pMaxWidth < b.maxWidth) {
				b.maxWidth = pMaxWidth;
			}
			if (pMaxHeight < b.maxHeight) {
				b.maxHeight = pMaxHeight;
			}
		}
		this._vBoundaries = b;
	},

	_updateCache: function(data) {
		this.offset = this.helper.offset();
		if (this._isNumber(data.left)) {
			this.position.left = data.left;
		}
		if (this._isNumber(data.top)) {
			this.position.top = data.top;
		}
		if (this._isNumber(data.height)) {
			this.size.height = data.height;
		}
		if (this._isNumber(data.width)) {
			this.size.width = data.width;
		}
	},

	_updateRatio: function( data ) {

		var cpos = this.position,
			csize = this.size,
			a = this.axis;

		if (this._isNumber(data.height)) {
			data.width = (data.height * this.aspectRatio);
		} else if (this._isNumber(data.width)) {
			data.height = (data.width / this.aspectRatio);
		}

		if (a === "sw") {
			data.left = cpos.left + (csize.width - data.width);
			data.top = null;
		}
		if (a === "nw") {
			data.top = cpos.top + (csize.height - data.height);
			data.left = cpos.left + (csize.width - data.width);
		}

		return data;
	},

	_respectSize: function( data ) {

		var o = this._vBoundaries,
			a = this.axis,
			ismaxw = this._isNumber(data.width) && o.maxWidth && (o.maxWidth < data.width),
			ismaxh = this._isNumber(data.height) && o.maxHeight && (o.maxHeight < data.height),
			isminw = this._isNumber(data.width) && o.minWidth && (o.minWidth > data.width),
			isminh = this._isNumber(data.height) && o.minHeight && (o.minHeight > data.height),
			dw = this.originalPosition.left + this.originalSize.width,
			dh = this.position.top + this.size.height,
			cw = /sw|nw|w/.test(a), ch = /nw|ne|n/.test(a);
		if (isminw) {
			data.width = o.minWidth;
		}
		if (isminh) {
			data.height = o.minHeight;
		}
		if (ismaxw) {
			data.width = o.maxWidth;
		}
		if (ismaxh) {
			data.height = o.maxHeight;
		}

		if (isminw && cw) {
			data.left = dw - o.minWidth;
		}
		if (ismaxw && cw) {
			data.left = dw - o.maxWidth;
		}
		if (isminh && ch) {
			data.top = dh - o.minHeight;
		}
		if (ismaxh && ch) {
			data.top = dh - o.maxHeight;
		}

		// Fixing jump error on top/left - bug #2330
		if (!data.width && !data.height && !data.left && data.top) {
			data.top = null;
		} else if (!data.width && !data.height && !data.top && data.left) {
			data.left = null;
		}

		return data;
	},

	_getPaddingPlusBorderDimensions: function( element ) {
		var i = 0,
			widths = [],
			borders = [
				element.css( "borderTopWidth" ),
				element.css( "borderRightWidth" ),
				element.css( "borderBottomWidth" ),
				element.css( "borderLeftWidth" )
			],
			paddings = [
				element.css( "paddingTop" ),
				element.css( "paddingRight" ),
				element.css( "paddingBottom" ),
				element.css( "paddingLeft" )
			];

		for ( ; i < 4; i++ ) {
			widths[ i ] = ( parseInt( borders[ i ], 10 ) || 0 );
			widths[ i ] += ( parseInt( paddings[ i ], 10 ) || 0 );
		}

		return {
			height: widths[ 0 ] + widths[ 2 ],
			width: widths[ 1 ] + widths[ 3 ]
		};
	},

	_proportionallyResize: function() {

		if (!this._proportionallyResizeElements.length) {
			return;
		}

		var prel,
			i = 0,
			element = this.helper || this.element;

		for ( ; i < this._proportionallyResizeElements.length; i++) {

			prel = this._proportionallyResizeElements[i];

			// TODO: Seems like a bug to cache this.outerDimensions
			// considering that we are in a loop.
			if (!this.outerDimensions) {
				this.outerDimensions = this._getPaddingPlusBorderDimensions( prel );
			}

			prel.css({
				height: (element.height() - this.outerDimensions.height) || 0,
				width: (element.width() - this.outerDimensions.width) || 0
			});

		}

	},

	_renderProxy: function() {

		var el = this.element, o = this.options;
		this.elementOffset = el.offset();

		if (this._helper) {

			this.helper = this.helper || $("<div style='overflow:hidden;'></div>");

			this.helper.addClass(this._helper).css({
				width: this.element.outerWidth() - 1,
				height: this.element.outerHeight() - 1,
				position: "absolute",
				left: this.elementOffset.left + "px",
				top: this.elementOffset.top + "px",
				zIndex: ++o.zIndex //TODO: Don't modify option
			});

			this.helper
				.appendTo("body")
				.disableSelection();

		} else {
			this.helper = this.element;
		}

	},

	_change: {
		e: function(event, dx) {
			return { width: this.originalSize.width + dx };
		},
		w: function(event, dx) {
			var cs = this.originalSize, sp = this.originalPosition;
			return { left: sp.left + dx, width: cs.width - dx };
		},
		n: function(event, dx, dy) {
			var cs = this.originalSize, sp = this.originalPosition;
			return { top: sp.top + dy, height: cs.height - dy };
		},
		s: function(event, dx, dy) {
			return { height: this.originalSize.height + dy };
		},
		se: function(event, dx, dy) {
			return $.extend(this._change.s.apply(this, arguments),
				this._change.e.apply(this, [ event, dx, dy ]));
		},
		sw: function(event, dx, dy) {
			return $.extend(this._change.s.apply(this, arguments),
				this._change.w.apply(this, [ event, dx, dy ]));
		},
		ne: function(event, dx, dy) {
			return $.extend(this._change.n.apply(this, arguments),
				this._change.e.apply(this, [ event, dx, dy ]));
		},
		nw: function(event, dx, dy) {
			return $.extend(this._change.n.apply(this, arguments),
				this._change.w.apply(this, [ event, dx, dy ]));
		}
	},

	_propagate: function(n, event) {
		$.ui.plugin.call(this, n, [ event, this.ui() ]);
		(n !== "resize" && this._trigger(n, event, this.ui()));
	},

	plugins: {},

	ui: function() {
		return {
			originalElement: this.originalElement,
			element: this.element,
			helper: this.helper,
			position: this.position,
			size: this.size,
			originalSize: this.originalSize,
			originalPosition: this.originalPosition
		};
	}

});

/*
 * Resizable Extensions
 */

$.ui.plugin.add("resizable", "animate", {

	stop: function( event ) {
		var that = $(this).resizable( "instance" ),
			o = that.options,
			pr = that._proportionallyResizeElements,
			ista = pr.length && (/textarea/i).test(pr[0].nodeName),
			soffseth = ista && that._hasScroll(pr[0], "left") ? 0 : that.sizeDiff.height,
			soffsetw = ista ? 0 : that.sizeDiff.width,
			style = { width: (that.size.width - soffsetw), height: (that.size.height - soffseth) },
			left = (parseInt(that.element.css("left"), 10) +
				(that.position.left - that.originalPosition.left)) || null,
			top = (parseInt(that.element.css("top"), 10) +
				(that.position.top - that.originalPosition.top)) || null;

		that.element.animate(
			$.extend(style, top && left ? { top: top, left: left } : {}), {
				duration: o.animateDuration,
				easing: o.animateEasing,
				step: function() {

					var data = {
						width: parseInt(that.element.css("width"), 10),
						height: parseInt(that.element.css("height"), 10),
						top: parseInt(that.element.css("top"), 10),
						left: parseInt(that.element.css("left"), 10)
					};

					if (pr && pr.length) {
						$(pr[0]).css({ width: data.width, height: data.height });
					}

					// propagating resize, and updating values for each animation step
					that._updateCache(data);
					that._propagate("resize", event);

				}
			}
		);
	}

});

$.ui.plugin.add( "resizable", "containment", {

	start: function() {
		var element, p, co, ch, cw, width, height,
			that = $( this ).resizable( "instance" ),
			o = that.options,
			el = that.element,
			oc = o.containment,
			ce = ( oc instanceof $ ) ? oc.get( 0 ) : ( /parent/.test( oc ) ) ? el.parent().get( 0 ) : oc;

		if ( !ce ) {
			return;
		}

		that.containerElement = $( ce );

		if ( /document/.test( oc ) || oc === document ) {
			that.containerOffset = {
				left: 0,
				top: 0
			};
			that.containerPosition = {
				left: 0,
				top: 0
			};

			that.parentData = {
				element: $( document ),
				left: 0,
				top: 0,
				width: $( document ).width(),
				height: $( document ).height() || document.body.parentNode.scrollHeight
			};
		} else {
			element = $( ce );
			p = [];
			$([ "Top", "Right", "Left", "Bottom" ]).each(function( i, name ) {
				p[ i ] = that._num( element.css( "padding" + name ) );
			});

			that.containerOffset = element.offset();
			that.containerPosition = element.position();
			that.containerSize = {
				height: ( element.innerHeight() - p[ 3 ] ),
				width: ( element.innerWidth() - p[ 1 ] )
			};

			co = that.containerOffset;
			ch = that.containerSize.height;
			cw = that.containerSize.width;
			width = ( that._hasScroll ( ce, "left" ) ? ce.scrollWidth : cw );
			height = ( that._hasScroll ( ce ) ? ce.scrollHeight : ch ) ;

			that.parentData = {
				element: ce,
				left: co.left,
				top: co.top,
				width: width,
				height: height
			};
		}
	},

	resize: function( event ) {
		var woset, hoset, isParent, isOffsetRelative,
			that = $( this ).resizable( "instance" ),
			o = that.options,
			co = that.containerOffset,
			cp = that.position,
			pRatio = that._aspectRatio || event.shiftKey,
			cop = {
				top: 0,
				left: 0
			},
			ce = that.containerElement,
			continueResize = true;

		if ( ce[ 0 ] !== document && ( /static/ ).test( ce.css( "position" ) ) ) {
			cop = co;
		}

		if ( cp.left < ( that._helper ? co.left : 0 ) ) {
			that.size.width = that.size.width +
				( that._helper ?
					( that.position.left - co.left ) :
					( that.position.left - cop.left ) );

			if ( pRatio ) {
				that.size.height = that.size.width / that.aspectRatio;
				continueResize = false;
			}
			that.position.left = o.helper ? co.left : 0;
		}

		if ( cp.top < ( that._helper ? co.top : 0 ) ) {
			that.size.height = that.size.height +
				( that._helper ?
					( that.position.top - co.top ) :
					that.position.top );

			if ( pRatio ) {
				that.size.width = that.size.height * that.aspectRatio;
				continueResize = false;
			}
			that.position.top = that._helper ? co.top : 0;
		}

		isParent = that.containerElement.get( 0 ) === that.element.parent().get( 0 );
		isOffsetRelative = /relative|absolute/.test( that.containerElement.css( "position" ) );

		if ( isParent && isOffsetRelative ) {
			that.offset.left = that.parentData.left + that.position.left;
			that.offset.top = that.parentData.top + that.position.top;
		} else {
			that.offset.left = that.element.offset().left;
			that.offset.top = that.element.offset().top;
		}

		woset = Math.abs( that.sizeDiff.width +
			(that._helper ?
				that.offset.left - cop.left :
				(that.offset.left - co.left)) );

		hoset = Math.abs( that.sizeDiff.height +
			(that._helper ?
				that.offset.top - cop.top :
				(that.offset.top - co.top)) );

		if ( woset + that.size.width >= that.parentData.width ) {
			that.size.width = that.parentData.width - woset;
			if ( pRatio ) {
				that.size.height = that.size.width / that.aspectRatio;
				continueResize = false;
			}
		}

		if ( hoset + that.size.height >= that.parentData.height ) {
			that.size.height = that.parentData.height - hoset;
			if ( pRatio ) {
				that.size.width = that.size.height * that.aspectRatio;
				continueResize = false;
			}
		}

		if ( !continueResize ) {
			that.position.left = that.prevPosition.left;
			that.position.top = that.prevPosition.top;
			that.size.width = that.prevSize.width;
			that.size.height = that.prevSize.height;
		}
	},

	stop: function() {
		var that = $( this ).resizable( "instance" ),
			o = that.options,
			co = that.containerOffset,
			cop = that.containerPosition,
			ce = that.containerElement,
			helper = $( that.helper ),
			ho = helper.offset(),
			w = helper.outerWidth() - that.sizeDiff.width,
			h = helper.outerHeight() - that.sizeDiff.height;

		if ( that._helper && !o.animate && ( /relative/ ).test( ce.css( "position" ) ) ) {
			$( this ).css({
				left: ho.left - cop.left - co.left,
				width: w,
				height: h
			});
		}

		if ( that._helper && !o.animate && ( /static/ ).test( ce.css( "position" ) ) ) {
			$( this ).css({
				left: ho.left - cop.left - co.left,
				width: w,
				height: h
			});
		}
	}
});

$.ui.plugin.add("resizable", "alsoResize", {

	start: function() {
		var that = $(this).resizable( "instance" ),
			o = that.options;

		$(o.alsoResize).each(function() {
			var el = $(this);
			el.data("ui-resizable-alsoresize", {
				width: parseInt(el.width(), 10), height: parseInt(el.height(), 10),
				left: parseInt(el.css("left"), 10), top: parseInt(el.css("top"), 10)
			});
		});
	},

	resize: function(event, ui) {
		var that = $(this).resizable( "instance" ),
			o = that.options,
			os = that.originalSize,
			op = that.originalPosition,
			delta = {
				height: (that.size.height - os.height) || 0,
				width: (that.size.width - os.width) || 0,
				top: (that.position.top - op.top) || 0,
				left: (that.position.left - op.left) || 0
			};

			$(o.alsoResize).each(function() {
				var el = $(this), start = $(this).data("ui-resizable-alsoresize"), style = {},
					css = el.parents(ui.originalElement[0]).length ?
							[ "width", "height" ] :
							[ "width", "height", "top", "left" ];

				$.each(css, function(i, prop) {
					var sum = (start[prop] || 0) + (delta[prop] || 0);
					if (sum && sum >= 0) {
						style[prop] = sum || null;
					}
				});

				el.css(style);
			});
	},

	stop: function() {
		$(this).removeData("resizable-alsoresize");
	}
});

$.ui.plugin.add("resizable", "ghost", {

	start: function() {

		var that = $(this).resizable( "instance" ), o = that.options, cs = that.size;

		that.ghost = that.originalElement.clone();
		that.ghost
			.css({
				opacity: 0.25,
				display: "block",
				position: "relative",
				height: cs.height,
				width: cs.width,
				margin: 0,
				left: 0,
				top: 0
			})
			.addClass("ui-resizable-ghost")
			.addClass(typeof o.ghost === "string" ? o.ghost : "");

		that.ghost.appendTo(that.helper);

	},

	resize: function() {
		var that = $(this).resizable( "instance" );
		if (that.ghost) {
			that.ghost.css({
				position: "relative",
				height: that.size.height,
				width: that.size.width
			});
		}
	},

	stop: function() {
		var that = $(this).resizable( "instance" );
		if (that.ghost && that.helper) {
			that.helper.get(0).removeChild(that.ghost.get(0));
		}
	}

});

$.ui.plugin.add("resizable", "grid", {

	resize: function() {
		var outerDimensions,
			that = $(this).resizable( "instance" ),
			o = that.options,
			cs = that.size,
			os = that.originalSize,
			op = that.originalPosition,
			a = that.axis,
			grid = typeof o.grid === "number" ? [ o.grid, o.grid ] : o.grid,
			gridX = (grid[0] || 1),
			gridY = (grid[1] || 1),
			ox = Math.round((cs.width - os.width) / gridX) * gridX,
			oy = Math.round((cs.height - os.height) / gridY) * gridY,
			newWidth = os.width + ox,
			newHeight = os.height + oy,
			isMaxWidth = o.maxWidth && (o.maxWidth < newWidth),
			isMaxHeight = o.maxHeight && (o.maxHeight < newHeight),
			isMinWidth = o.minWidth && (o.minWidth > newWidth),
			isMinHeight = o.minHeight && (o.minHeight > newHeight);

		o.grid = grid;

		if (isMinWidth) {
			newWidth += gridX;
		}
		if (isMinHeight) {
			newHeight += gridY;
		}
		if (isMaxWidth) {
			newWidth -= gridX;
		}
		if (isMaxHeight) {
			newHeight -= gridY;
		}

		if (/^(se|s|e)$/.test(a)) {
			that.size.width = newWidth;
			that.size.height = newHeight;
		} else if (/^(ne)$/.test(a)) {
			that.size.width = newWidth;
			that.size.height = newHeight;
			that.position.top = op.top - oy;
		} else if (/^(sw)$/.test(a)) {
			that.size.width = newWidth;
			that.size.height = newHeight;
			that.position.left = op.left - ox;
		} else {
			if ( newHeight - gridY <= 0 || newWidth - gridX <= 0) {
				outerDimensions = that._getPaddingPlusBorderDimensions( this );
			}

			if ( newHeight - gridY > 0 ) {
				that.size.height = newHeight;
				that.position.top = op.top - oy;
			} else {
				newHeight = gridY - outerDimensions.height;
				that.size.height = newHeight;
				that.position.top = op.top + os.height - newHeight;
			}
			if ( newWidth - gridX > 0 ) {
				that.size.width = newWidth;
				that.position.left = op.left - ox;
			} else {
				newWidth = gridX - outerDimensions.width;
				that.size.width = newWidth;
				that.position.left = op.left + os.width - newWidth;
			}
		}
	}

});

var resizable = $.ui.resizable;


/*!
 * jQuery UI Dialog 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/dialog/
 */


var dialog = $.widget( "ui.dialog", {
	version: "1.11.4",
	options: {
		appendTo: "body",
		autoOpen: true,
		buttons: [],
		closeOnEscape: true,
		closeText: "Close",
		dialogClass: "",
		draggable: true,
		hide: null,
		height: "auto",
		maxHeight: null,
		maxWidth: null,
		minHeight: 150,
		minWidth: 150,
		modal: false,
		position: {
			my: "center",
			at: "center",
			of: window,
			collision: "fit",
			// Ensure the titlebar is always visible
			using: function( pos ) {
				var topOffset = $( this ).css( pos ).offset().top;
				if ( topOffset < 0 ) {
					$( this ).css( "top", pos.top - topOffset );
				}
			}
		},
		resizable: true,
		show: null,
		title: null,
		width: 300,

		// callbacks
		beforeClose: null,
		close: null,
		drag: null,
		dragStart: null,
		dragStop: null,
		focus: null,
		open: null,
		resize: null,
		resizeStart: null,
		resizeStop: null
	},

	sizeRelatedOptions: {
		buttons: true,
		height: true,
		maxHeight: true,
		maxWidth: true,
		minHeight: true,
		minWidth: true,
		width: true
	},

	resizableRelatedOptions: {
		maxHeight: true,
		maxWidth: true,
		minHeight: true,
		minWidth: true
	},

	_create: function() {
		this.originalCss = {
			display: this.element[ 0 ].style.display,
			width: this.element[ 0 ].style.width,
			minHeight: this.element[ 0 ].style.minHeight,
			maxHeight: this.element[ 0 ].style.maxHeight,
			height: this.element[ 0 ].style.height
		};
		this.originalPosition = {
			parent: this.element.parent(),
			index: this.element.parent().children().index( this.element )
		};
		this.originalTitle = this.element.attr( "title" );
		this.options.title = this.options.title || this.originalTitle;

		this._createWrapper();

		this.element
			.show()
			.removeAttr( "title" )
			.addClass( "ui-dialog-content ui-widget-content" )
			.appendTo( this.uiDialog );

		this._createTitlebar();
		this._createButtonPane();

		if ( this.options.draggable && $.fn.draggable ) {
			this._makeDraggable();
		}
		if ( this.options.resizable && $.fn.resizable ) {
			this._makeResizable();
		}

		this._isOpen = false;

		this._trackFocus();
	},

	_init: function() {
		if ( this.options.autoOpen ) {
			this.open();
		}
	},

	_appendTo: function() {
		var element = this.options.appendTo;
		if ( element && (element.jquery || element.nodeType) ) {
			return $( element );
		}
		return this.document.find( element || "body" ).eq( 0 );
	},

	_destroy: function() {
		var next,
			originalPosition = this.originalPosition;

		this._untrackInstance();
		this._destroyOverlay();

		this.element
			.removeUniqueId()
			.removeClass( "ui-dialog-content ui-widget-content" )
			.css( this.originalCss )
			// Without detaching first, the following becomes really slow
			.detach();

		this.uiDialog.stop( true, true ).remove();

		if ( this.originalTitle ) {
			this.element.attr( "title", this.originalTitle );
		}

		next = originalPosition.parent.children().eq( originalPosition.index );
		// Don't try to place the dialog next to itself (#8613)
		if ( next.length && next[ 0 ] !== this.element[ 0 ] ) {
			next.before( this.element );
		} else {
			originalPosition.parent.append( this.element );
		}
	},

	widget: function() {
		return this.uiDialog;
	},

	disable: $.noop,
	enable: $.noop,

	close: function( event ) {
		var activeElement,
			that = this;

		if ( !this._isOpen || this._trigger( "beforeClose", event ) === false ) {
			return;
		}

		this._isOpen = false;
		this._focusedElement = null;
		this._destroyOverlay();
		this._untrackInstance();

		if ( !this.opener.filter( ":focusable" ).focus().length ) {

			// support: IE9
			// IE9 throws an "Unspecified error" accessing document.activeElement from an <iframe>
			try {
				activeElement = this.document[ 0 ].activeElement;

				// Support: IE9, IE10
				// If the <body> is blurred, IE will switch windows, see #4520
				if ( activeElement && activeElement.nodeName.toLowerCase() !== "body" ) {

					// Hiding a focused element doesn't trigger blur in WebKit
					// so in case we have nothing to focus on, explicitly blur the active element
					// https://bugs.webkit.org/show_bug.cgi?id=47182
					$( activeElement ).blur();
				}
			} catch ( error ) {}
		}

		this._hide( this.uiDialog, this.options.hide, function() {
			that._trigger( "close", event );
		});
	},

	isOpen: function() {
		return this._isOpen;
	},

	moveToTop: function() {
		this._moveToTop();
	},

	_moveToTop: function( event, silent ) {
		var moved = false,
			zIndices = this.uiDialog.siblings( ".ui-front:visible" ).map(function() {
				return +$( this ).css( "z-index" );
			}).get(),
			zIndexMax = Math.max.apply( null, zIndices );

		if ( zIndexMax >= +this.uiDialog.css( "z-index" ) ) {
			this.uiDialog.css( "z-index", zIndexMax + 1 );
			moved = true;
		}

		if ( moved && !silent ) {
			this._trigger( "focus", event );
		}
		return moved;
	},

	open: function() {
		var that = this;
		if ( this._isOpen ) {
			if ( this._moveToTop() ) {
				this._focusTabbable();
			}
			return;
		}

		this._isOpen = true;
		this.opener = $( this.document[ 0 ].activeElement );

		this._size();
		this._position();
		this._createOverlay();
		this._moveToTop( null, true );

		// Ensure the overlay is moved to the top with the dialog, but only when
		// opening. The overlay shouldn't move after the dialog is open so that
		// modeless dialogs opened after the modal dialog stack properly.
		if ( this.overlay ) {
			this.overlay.css( "z-index", this.uiDialog.css( "z-index" ) - 1 );
		}

		this._show( this.uiDialog, this.options.show, function() {
			that._focusTabbable();
			that._trigger( "focus" );
		});

		// Track the dialog immediately upon openening in case a focus event
		// somehow occurs outside of the dialog before an element inside the
		// dialog is focused (#10152)
		this._makeFocusTarget();

		this._trigger( "open" );
	},

	_focusTabbable: function() {
		// Set focus to the first match:
		// 1. An element that was focused previously
		// 2. First element inside the dialog matching [autofocus]
		// 3. Tabbable element inside the content element
		// 4. Tabbable element inside the buttonpane
		// 5. The close button
		// 6. The dialog itself
		var hasFocus = this._focusedElement;
		if ( !hasFocus ) {
			hasFocus = this.element.find( "[autofocus]" );
		}
		if ( !hasFocus.length ) {
			hasFocus = this.element.find( ":tabbable" );
		}
		if ( !hasFocus.length ) {
			hasFocus = this.uiDialogButtonPane.find( ":tabbable" );
		}
		if ( !hasFocus.length ) {
			hasFocus = this.uiDialogTitlebarClose.filter( ":tabbable" );
		}
		if ( !hasFocus.length ) {
			hasFocus = this.uiDialog;
		}
		hasFocus.eq( 0 ).focus();
	},

	_keepFocus: function( event ) {
		function checkFocus() {
			var activeElement = this.document[0].activeElement,
				isActive = this.uiDialog[0] === activeElement ||
					$.contains( this.uiDialog[0], activeElement );
			if ( !isActive ) {
				this._focusTabbable();
			}
		}
		event.preventDefault();
		checkFocus.call( this );
		// support: IE
		// IE <= 8 doesn't prevent moving focus even with event.preventDefault()
		// so we check again later
		this._delay( checkFocus );
	},

	_createWrapper: function() {
		this.uiDialog = $("<div>")
			.addClass( "ui-dialog ui-widget ui-widget-content ui-corner-all ui-front " +
				this.options.dialogClass )
			.hide()
			.attr({
				// Setting tabIndex makes the div focusable
				tabIndex: -1,
				role: "dialog"
			})
			.appendTo( this._appendTo() );

		this._on( this.uiDialog, {
			keydown: function( event ) {
				if ( this.options.closeOnEscape && !event.isDefaultPrevented() && event.keyCode &&
						event.keyCode === $.ui.keyCode.ESCAPE ) {
					event.preventDefault();
					this.close( event );
					return;
				}

				// prevent tabbing out of dialogs
				if ( event.keyCode !== $.ui.keyCode.TAB || event.isDefaultPrevented() ) {
					return;
				}
				var tabbables = this.uiDialog.find( ":tabbable" ),
					first = tabbables.filter( ":first" ),
					last = tabbables.filter( ":last" );

				if ( ( event.target === last[0] || event.target === this.uiDialog[0] ) && !event.shiftKey ) {
					this._delay(function() {
						first.focus();
					});
					event.preventDefault();
				} else if ( ( event.target === first[0] || event.target === this.uiDialog[0] ) && event.shiftKey ) {
					this._delay(function() {
						last.focus();
					});
					event.preventDefault();
				}
			},
			mousedown: function( event ) {
				if ( this._moveToTop( event ) ) {
					this._focusTabbable();
				}
			}
		});

		// We assume that any existing aria-describedby attribute means
		// that the dialog content is marked up properly
		// otherwise we brute force the content as the description
		if ( !this.element.find( "[aria-describedby]" ).length ) {
			this.uiDialog.attr({
				"aria-describedby": this.element.uniqueId().attr( "id" )
			});
		}
	},

	_createTitlebar: function() {
		var uiDialogTitle;

		this.uiDialogTitlebar = $( "<div>" )
			.addClass( "ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix" )
			.prependTo( this.uiDialog );
		this._on( this.uiDialogTitlebar, {
			mousedown: function( event ) {
				// Don't prevent click on close button (#8838)
				// Focusing a dialog that is partially scrolled out of view
				// causes the browser to scroll it into view, preventing the click event
				if ( !$( event.target ).closest( ".ui-dialog-titlebar-close" ) ) {
					// Dialog isn't getting focus when dragging (#8063)
					this.uiDialog.focus();
				}
			}
		});

		// support: IE
		// Use type="button" to prevent enter keypresses in textboxes from closing the
		// dialog in IE (#9312)
		this.uiDialogTitlebarClose = $( "<button type='button'></button>" )
			.button({
				label: this.options.closeText,
				icons: {
					primary: "ui-icon-closethick"
				},
				text: false
			})
			.addClass( "ui-dialog-titlebar-close" )
			.appendTo( this.uiDialogTitlebar );
		this._on( this.uiDialogTitlebarClose, {
			click: function( event ) {
				event.preventDefault();
				this.close( event );
			}
		});

		uiDialogTitle = $( "<span>" )
			.uniqueId()
			.addClass( "ui-dialog-title" )
			.prependTo( this.uiDialogTitlebar );
		this._title( uiDialogTitle );

		this.uiDialog.attr({
			"aria-labelledby": uiDialogTitle.attr( "id" )
		});
	},

	_title: function( title ) {
		if ( !this.options.title ) {
			title.html( "&#160;" );
		}
		title.text( this.options.title );
	},

	_createButtonPane: function() {
		this.uiDialogButtonPane = $( "<div>" )
			.addClass( "ui-dialog-buttonpane ui-widget-content ui-helper-clearfix" );

		this.uiButtonSet = $( "<div>" )
			.addClass( "ui-dialog-buttonset" )
			.appendTo( this.uiDialogButtonPane );

		this._createButtons();
	},

	_createButtons: function() {
		var that = this,
			buttons = this.options.buttons;

		// if we already have a button pane, remove it
		this.uiDialogButtonPane.remove();
		this.uiButtonSet.empty();

		if ( $.isEmptyObject( buttons ) || ($.isArray( buttons ) && !buttons.length) ) {
			this.uiDialog.removeClass( "ui-dialog-buttons" );
			return;
		}

		$.each( buttons, function( name, props ) {
			var click, buttonOptions;
			props = $.isFunction( props ) ?
				{ click: props, text: name } :
				props;
			// Default to a non-submitting button
			props = $.extend( { type: "button" }, props );
			// Change the context for the click callback to be the main element
			click = props.click;
			props.click = function() {
				click.apply( that.element[ 0 ], arguments );
			};
			buttonOptions = {
				icons: props.icons,
				text: props.showText
			};
			delete props.icons;
			delete props.showText;
			$( "<button></button>", props )
				.button( buttonOptions )
				.appendTo( that.uiButtonSet );
		});
		this.uiDialog.addClass( "ui-dialog-buttons" );
		this.uiDialogButtonPane.appendTo( this.uiDialog );
	},

	_makeDraggable: function() {
		var that = this,
			options = this.options;

		function filteredUi( ui ) {
			return {
				position: ui.position,
				offset: ui.offset
			};
		}

		this.uiDialog.draggable({
			cancel: ".ui-dialog-content, .ui-dialog-titlebar-close",
			handle: ".ui-dialog-titlebar",
			containment: "document",
			start: function( event, ui ) {
				$( this ).addClass( "ui-dialog-dragging" );
				that._blockFrames();
				that._trigger( "dragStart", event, filteredUi( ui ) );
			},
			drag: function( event, ui ) {
				that._trigger( "drag", event, filteredUi( ui ) );
			},
			stop: function( event, ui ) {
				var left = ui.offset.left - that.document.scrollLeft(),
					top = ui.offset.top - that.document.scrollTop();

				options.position = {
					my: "left top",
					at: "left" + (left >= 0 ? "+" : "") + left + " " +
						"top" + (top >= 0 ? "+" : "") + top,
					of: that.window
				};
				$( this ).removeClass( "ui-dialog-dragging" );
				that._unblockFrames();
				that._trigger( "dragStop", event, filteredUi( ui ) );
			}
		});
	},

	_makeResizable: function() {
		var that = this,
			options = this.options,
			handles = options.resizable,
			// .ui-resizable has position: relative defined in the stylesheet
			// but dialogs have to use absolute or fixed positioning
			position = this.uiDialog.css("position"),
			resizeHandles = typeof handles === "string" ?
				handles	:
				"n,e,s,w,se,sw,ne,nw";

		function filteredUi( ui ) {
			return {
				originalPosition: ui.originalPosition,
				originalSize: ui.originalSize,
				position: ui.position,
				size: ui.size
			};
		}

		this.uiDialog.resizable({
			cancel: ".ui-dialog-content",
			containment: "document",
			alsoResize: this.element,
			maxWidth: options.maxWidth,
			maxHeight: options.maxHeight,
			minWidth: options.minWidth,
			minHeight: this._minHeight(),
			handles: resizeHandles,
			start: function( event, ui ) {
				$( this ).addClass( "ui-dialog-resizing" );
				that._blockFrames();
				that._trigger( "resizeStart", event, filteredUi( ui ) );
			},
			resize: function( event, ui ) {
				that._trigger( "resize", event, filteredUi( ui ) );
			},
			stop: function( event, ui ) {
				var offset = that.uiDialog.offset(),
					left = offset.left - that.document.scrollLeft(),
					top = offset.top - that.document.scrollTop();

				options.height = that.uiDialog.height();
				options.width = that.uiDialog.width();
				options.position = {
					my: "left top",
					at: "left" + (left >= 0 ? "+" : "") + left + " " +
						"top" + (top >= 0 ? "+" : "") + top,
					of: that.window
				};
				$( this ).removeClass( "ui-dialog-resizing" );
				that._unblockFrames();
				that._trigger( "resizeStop", event, filteredUi( ui ) );
			}
		})
		.css( "position", position );
	},

	_trackFocus: function() {
		this._on( this.widget(), {
			focusin: function( event ) {
				this._makeFocusTarget();
				this._focusedElement = $( event.target );
			}
		});
	},

	_makeFocusTarget: function() {
		this._untrackInstance();
		this._trackingInstances().unshift( this );
	},

	_untrackInstance: function() {
		var instances = this._trackingInstances(),
			exists = $.inArray( this, instances );
		if ( exists !== -1 ) {
			instances.splice( exists, 1 );
		}
	},

	_trackingInstances: function() {
		var instances = this.document.data( "ui-dialog-instances" );
		if ( !instances ) {
			instances = [];
			this.document.data( "ui-dialog-instances", instances );
		}
		return instances;
	},

	_minHeight: function() {
		var options = this.options;

		return options.height === "auto" ?
			options.minHeight :
			Math.min( options.minHeight, options.height );
	},

	_position: function() {
		// Need to show the dialog to get the actual offset in the position plugin
		var isVisible = this.uiDialog.is( ":visible" );
		if ( !isVisible ) {
			this.uiDialog.show();
		}
		this.uiDialog.position( this.options.position );
		if ( !isVisible ) {
			this.uiDialog.hide();
		}
	},

	_setOptions: function( options ) {
		var that = this,
			resize = false,
			resizableOptions = {};

		$.each( options, function( key, value ) {
			that._setOption( key, value );

			if ( key in that.sizeRelatedOptions ) {
				resize = true;
			}
			if ( key in that.resizableRelatedOptions ) {
				resizableOptions[ key ] = value;
			}
		});

		if ( resize ) {
			this._size();
			this._position();
		}
		if ( this.uiDialog.is( ":data(ui-resizable)" ) ) {
			this.uiDialog.resizable( "option", resizableOptions );
		}
	},

	_setOption: function( key, value ) {
		var isDraggable, isResizable,
			uiDialog = this.uiDialog;

		if ( key === "dialogClass" ) {
			uiDialog
				.removeClass( this.options.dialogClass )
				.addClass( value );
		}

		if ( key === "disabled" ) {
			return;
		}

		this._super( key, value );

		if ( key === "appendTo" ) {
			this.uiDialog.appendTo( this._appendTo() );
		}

		if ( key === "buttons" ) {
			this._createButtons();
		}

		if ( key === "closeText" ) {
			this.uiDialogTitlebarClose.button({
				// Ensure that we always pass a string
				label: "" + value
			});
		}

		if ( key === "draggable" ) {
			isDraggable = uiDialog.is( ":data(ui-draggable)" );
			if ( isDraggable && !value ) {
				uiDialog.draggable( "destroy" );
			}

			if ( !isDraggable && value ) {
				this._makeDraggable();
			}
		}

		if ( key === "position" ) {
			this._position();
		}

		if ( key === "resizable" ) {
			// currently resizable, becoming non-resizable
			isResizable = uiDialog.is( ":data(ui-resizable)" );
			if ( isResizable && !value ) {
				uiDialog.resizable( "destroy" );
			}

			// currently resizable, changing handles
			if ( isResizable && typeof value === "string" ) {
				uiDialog.resizable( "option", "handles", value );
			}

			// currently non-resizable, becoming resizable
			if ( !isResizable && value !== false ) {
				this._makeResizable();
			}
		}

		if ( key === "title" ) {
			this._title( this.uiDialogTitlebar.find( ".ui-dialog-title" ) );
		}
	},

	_size: function() {
		// If the user has resized the dialog, the .ui-dialog and .ui-dialog-content
		// divs will both have width and height set, so we need to reset them
		var nonContentHeight, minContentHeight, maxContentHeight,
			options = this.options;

		// Reset content sizing
		this.element.show().css({
			width: "auto",
			minHeight: 0,
			maxHeight: "none",
			height: 0
		});

		if ( options.minWidth > options.width ) {
			options.width = options.minWidth;
		}

		// reset wrapper sizing
		// determine the height of all the non-content elements
		nonContentHeight = this.uiDialog.css({
				height: "auto",
				width: options.width
			})
			.outerHeight();
		minContentHeight = Math.max( 0, options.minHeight - nonContentHeight );
		maxContentHeight = typeof options.maxHeight === "number" ?
			Math.max( 0, options.maxHeight - nonContentHeight ) :
			"none";

		if ( options.height === "auto" ) {
			this.element.css({
				minHeight: minContentHeight,
				maxHeight: maxContentHeight,
				height: "auto"
			});
		} else {
			this.element.height( Math.max( 0, options.height - nonContentHeight ) );
		}

		if ( this.uiDialog.is( ":data(ui-resizable)" ) ) {
			this.uiDialog.resizable( "option", "minHeight", this._minHeight() );
		}
	},

	_blockFrames: function() {
		this.iframeBlocks = this.document.find( "iframe" ).map(function() {
			var iframe = $( this );

			return $( "<div>" )
				.css({
					position: "absolute",
					width: iframe.outerWidth(),
					height: iframe.outerHeight()
				})
				.appendTo( iframe.parent() )
				.offset( iframe.offset() )[0];
		});
	},

	_unblockFrames: function() {
		if ( this.iframeBlocks ) {
			this.iframeBlocks.remove();
			delete this.iframeBlocks;
		}
	},

	_allowInteraction: function( event ) {
		if ( $( event.target ).closest( ".ui-dialog" ).length ) {
			return true;
		}

		// TODO: Remove hack when datepicker implements
		// the .ui-front logic (#8989)
		return !!$( event.target ).closest( ".ui-datepicker" ).length;
	},

	_createOverlay: function() {
		if ( !this.options.modal ) {
			return;
		}

		// We use a delay in case the overlay is created from an
		// event that we're going to be cancelling (#2804)
		var isOpening = true;
		this._delay(function() {
			isOpening = false;
		});

		if ( !this.document.data( "ui-dialog-overlays" ) ) {

			// Prevent use of anchors and inputs
			// Using _on() for an event handler shared across many instances is
			// safe because the dialogs stack and must be closed in reverse order
			this._on( this.document, {
				focusin: function( event ) {
					if ( isOpening ) {
						return;
					}

					if ( !this._allowInteraction( event ) ) {
						event.preventDefault();
						this._trackingInstances()[ 0 ]._focusTabbable();
					}
				}
			});
		}

		this.overlay = $( "<div>" )
			.addClass( "ui-widget-overlay ui-front" )
			.appendTo( this._appendTo() );
		this._on( this.overlay, {
			mousedown: "_keepFocus"
		});
		this.document.data( "ui-dialog-overlays",
			(this.document.data( "ui-dialog-overlays" ) || 0) + 1 );
	},

	_destroyOverlay: function() {
		if ( !this.options.modal ) {
			return;
		}

		if ( this.overlay ) {
			var overlays = this.document.data( "ui-dialog-overlays" ) - 1;

			if ( !overlays ) {
				this.document
					.unbind( "focusin" )
					.removeData( "ui-dialog-overlays" );
			} else {
				this.document.data( "ui-dialog-overlays", overlays );
			}

			this.overlay.remove();
			this.overlay = null;
		}
	}
});


/*!
 * jQuery UI Droppable 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/droppable/
 */


$.widget( "ui.droppable", {
	version: "1.11.4",
	widgetEventPrefix: "drop",
	options: {
		accept: "*",
		activeClass: false,
		addClasses: true,
		greedy: false,
		hoverClass: false,
		scope: "default",
		tolerance: "intersect",

		// callbacks
		activate: null,
		deactivate: null,
		drop: null,
		out: null,
		over: null
	},
	_create: function() {

		var proportions,
			o = this.options,
			accept = o.accept;

		this.isover = false;
		this.isout = true;

		this.accept = $.isFunction( accept ) ? accept : function( d ) {
			return d.is( accept );
		};

		this.proportions = function( /* valueToWrite */ ) {
			if ( arguments.length ) {
				// Store the droppable's proportions
				proportions = arguments[ 0 ];
			} else {
				// Retrieve or derive the droppable's proportions
				return proportions ?
					proportions :
					proportions = {
						width: this.element[ 0 ].offsetWidth,
						height: this.element[ 0 ].offsetHeight
					};
			}
		};

		this._addToManager( o.scope );

		o.addClasses && this.element.addClass( "ui-droppable" );

	},

	_addToManager: function( scope ) {
		// Add the reference and positions to the manager
		$.ui.ddmanager.droppables[ scope ] = $.ui.ddmanager.droppables[ scope ] || [];
		$.ui.ddmanager.droppables[ scope ].push( this );
	},

	_splice: function( drop ) {
		var i = 0;
		for ( ; i < drop.length; i++ ) {
			if ( drop[ i ] === this ) {
				drop.splice( i, 1 );
			}
		}
	},

	_destroy: function() {
		var drop = $.ui.ddmanager.droppables[ this.options.scope ];

		this._splice( drop );

		this.element.removeClass( "ui-droppable ui-droppable-disabled" );
	},

	_setOption: function( key, value ) {

		if ( key === "accept" ) {
			this.accept = $.isFunction( value ) ? value : function( d ) {
				return d.is( value );
			};
		} else if ( key === "scope" ) {
			var drop = $.ui.ddmanager.droppables[ this.options.scope ];

			this._splice( drop );
			this._addToManager( value );
		}

		this._super( key, value );
	},

	_activate: function( event ) {
		var draggable = $.ui.ddmanager.current;
		if ( this.options.activeClass ) {
			this.element.addClass( this.options.activeClass );
		}
		if ( draggable ){
			this._trigger( "activate", event, this.ui( draggable ) );
		}
	},

	_deactivate: function( event ) {
		var draggable = $.ui.ddmanager.current;
		if ( this.options.activeClass ) {
			this.element.removeClass( this.options.activeClass );
		}
		if ( draggable ){
			this._trigger( "deactivate", event, this.ui( draggable ) );
		}
	},

	_over: function( event ) {

		var draggable = $.ui.ddmanager.current;

		// Bail if draggable and droppable are same element
		if ( !draggable || ( draggable.currentItem || draggable.element )[ 0 ] === this.element[ 0 ] ) {
			return;
		}

		if ( this.accept.call( this.element[ 0 ], ( draggable.currentItem || draggable.element ) ) ) {
			if ( this.options.hoverClass ) {
				this.element.addClass( this.options.hoverClass );
			}
			this._trigger( "over", event, this.ui( draggable ) );
		}

	},

	_out: function( event ) {

		var draggable = $.ui.ddmanager.current;

		// Bail if draggable and droppable are same element
		if ( !draggable || ( draggable.currentItem || draggable.element )[ 0 ] === this.element[ 0 ] ) {
			return;
		}

		if ( this.accept.call( this.element[ 0 ], ( draggable.currentItem || draggable.element ) ) ) {
			if ( this.options.hoverClass ) {
				this.element.removeClass( this.options.hoverClass );
			}
			this._trigger( "out", event, this.ui( draggable ) );
		}

	},

	_drop: function( event, custom ) {

		var draggable = custom || $.ui.ddmanager.current,
			childrenIntersection = false;

		// Bail if draggable and droppable are same element
		if ( !draggable || ( draggable.currentItem || draggable.element )[ 0 ] === this.element[ 0 ] ) {
			return false;
		}

		this.element.find( ":data(ui-droppable)" ).not( ".ui-draggable-dragging" ).each(function() {
			var inst = $( this ).droppable( "instance" );
			if (
				inst.options.greedy &&
				!inst.options.disabled &&
				inst.options.scope === draggable.options.scope &&
				inst.accept.call( inst.element[ 0 ], ( draggable.currentItem || draggable.element ) ) &&
				$.ui.intersect( draggable, $.extend( inst, { offset: inst.element.offset() } ), inst.options.tolerance, event )
			) { childrenIntersection = true; return false; }
		});
		if ( childrenIntersection ) {
			return false;
		}

		if ( this.accept.call( this.element[ 0 ], ( draggable.currentItem || draggable.element ) ) ) {
			if ( this.options.activeClass ) {
				this.element.removeClass( this.options.activeClass );
			}
			if ( this.options.hoverClass ) {
				this.element.removeClass( this.options.hoverClass );
			}
			this._trigger( "drop", event, this.ui( draggable ) );
			return this.element;
		}

		return false;

	},

	ui: function( c ) {
		return {
			draggable: ( c.currentItem || c.element ),
			helper: c.helper,
			position: c.position,
			offset: c.positionAbs
		};
	}

});

$.ui.intersect = (function() {
	function isOverAxis( x, reference, size ) {
		return ( x >= reference ) && ( x < ( reference + size ) );
	}

	return function( draggable, droppable, toleranceMode, event ) {

		if ( !droppable.offset ) {
			return false;
		}

		var x1 = ( draggable.positionAbs || draggable.position.absolute ).left + draggable.margins.left,
			y1 = ( draggable.positionAbs || draggable.position.absolute ).top + draggable.margins.top,
			x2 = x1 + draggable.helperProportions.width,
			y2 = y1 + draggable.helperProportions.height,
			l = droppable.offset.left,
			t = droppable.offset.top,
			r = l + droppable.proportions().width,
			b = t + droppable.proportions().height;

		switch ( toleranceMode ) {
		case "fit":
			return ( l <= x1 && x2 <= r && t <= y1 && y2 <= b );
		case "intersect":
			return ( l < x1 + ( draggable.helperProportions.width / 2 ) && // Right Half
				x2 - ( draggable.helperProportions.width / 2 ) < r && // Left Half
				t < y1 + ( draggable.helperProportions.height / 2 ) && // Bottom Half
				y2 - ( draggable.helperProportions.height / 2 ) < b ); // Top Half
		case "pointer":
			return isOverAxis( event.pageY, t, droppable.proportions().height ) && isOverAxis( event.pageX, l, droppable.proportions().width );
		case "touch":
			return (
				( y1 >= t && y1 <= b ) || // Top edge touching
				( y2 >= t && y2 <= b ) || // Bottom edge touching
				( y1 < t && y2 > b ) // Surrounded vertically
			) && (
				( x1 >= l && x1 <= r ) || // Left edge touching
				( x2 >= l && x2 <= r ) || // Right edge touching
				( x1 < l && x2 > r ) // Surrounded horizontally
			);
		default:
			return false;
		}
	};
})();

/*
	This manager tracks offsets of draggables and droppables
*/
$.ui.ddmanager = {
	current: null,
	droppables: { "default": [] },
	prepareOffsets: function( t, event ) {

		var i, j,
			m = $.ui.ddmanager.droppables[ t.options.scope ] || [],
			type = event ? event.type : null, // workaround for #2317
			list = ( t.currentItem || t.element ).find( ":data(ui-droppable)" ).addBack();

		droppablesLoop: for ( i = 0; i < m.length; i++ ) {

			// No disabled and non-accepted
			if ( m[ i ].options.disabled || ( t && !m[ i ].accept.call( m[ i ].element[ 0 ], ( t.currentItem || t.element ) ) ) ) {
				continue;
			}

			// Filter out elements in the current dragged item
			for ( j = 0; j < list.length; j++ ) {
				if ( list[ j ] === m[ i ].element[ 0 ] ) {
					m[ i ].proportions().height = 0;
					continue droppablesLoop;
				}
			}

			m[ i ].visible = m[ i ].element.css( "display" ) !== "none";
			if ( !m[ i ].visible ) {
				continue;
			}

			// Activate the droppable if used directly from draggables
			if ( type === "mousedown" ) {
				m[ i ]._activate.call( m[ i ], event );
			}

			m[ i ].offset = m[ i ].element.offset();
			m[ i ].proportions({ width: m[ i ].element[ 0 ].offsetWidth, height: m[ i ].element[ 0 ].offsetHeight });

		}

	},
	drop: function( draggable, event ) {

		var dropped = false;
		// Create a copy of the droppables in case the list changes during the drop (#9116)
		$.each( ( $.ui.ddmanager.droppables[ draggable.options.scope ] || [] ).slice(), function() {

			if ( !this.options ) {
				return;
			}
			if ( !this.options.disabled && this.visible && $.ui.intersect( draggable, this, this.options.tolerance, event ) ) {
				dropped = this._drop.call( this, event ) || dropped;
			}

			if ( !this.options.disabled && this.visible && this.accept.call( this.element[ 0 ], ( draggable.currentItem || draggable.element ) ) ) {
				this.isout = true;
				this.isover = false;
				this._deactivate.call( this, event );
			}

		});
		return dropped;

	},
	dragStart: function( draggable, event ) {
		// Listen for scrolling so that if the dragging causes scrolling the position of the droppables can be recalculated (see #5003)
		draggable.element.parentsUntil( "body" ).bind( "scroll.droppable", function() {
			if ( !draggable.options.refreshPositions ) {
				$.ui.ddmanager.prepareOffsets( draggable, event );
			}
		});
	},
	drag: function( draggable, event ) {

		// If you have a highly dynamic page, you might try this option. It renders positions every time you move the mouse.
		if ( draggable.options.refreshPositions ) {
			$.ui.ddmanager.prepareOffsets( draggable, event );
		}

		// Run through all droppables and check their positions based on specific tolerance options
		$.each( $.ui.ddmanager.droppables[ draggable.options.scope ] || [], function() {

			if ( this.options.disabled || this.greedyChild || !this.visible ) {
				return;
			}

			var parentInstance, scope, parent,
				intersects = $.ui.intersect( draggable, this, this.options.tolerance, event ),
				c = !intersects && this.isover ? "isout" : ( intersects && !this.isover ? "isover" : null );
			if ( !c ) {
				return;
			}

			if ( this.options.greedy ) {
				// find droppable parents with same scope
				scope = this.options.scope;
				parent = this.element.parents( ":data(ui-droppable)" ).filter(function() {
					return $( this ).droppable( "instance" ).options.scope === scope;
				});

				if ( parent.length ) {
					parentInstance = $( parent[ 0 ] ).droppable( "instance" );
					parentInstance.greedyChild = ( c === "isover" );
				}
			}

			// we just moved into a greedy child
			if ( parentInstance && c === "isover" ) {
				parentInstance.isover = false;
				parentInstance.isout = true;
				parentInstance._out.call( parentInstance, event );
			}

			this[ c ] = true;
			this[c === "isout" ? "isover" : "isout"] = false;
			this[c === "isover" ? "_over" : "_out"].call( this, event );

			// we just moved out of a greedy child
			if ( parentInstance && c === "isout" ) {
				parentInstance.isout = false;
				parentInstance.isover = true;
				parentInstance._over.call( parentInstance, event );
			}
		});

	},
	dragStop: function( draggable, event ) {
		draggable.element.parentsUntil( "body" ).unbind( "scroll.droppable" );
		// Call prepareOffsets one final time since IE does not fire return scroll events when overflow was caused by drag (see #5003)
		if ( !draggable.options.refreshPositions ) {
			$.ui.ddmanager.prepareOffsets( draggable, event );
		}
	}
};

var droppable = $.ui.droppable;


/*!
 * jQuery UI Effects 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/category/effects-core/
 */


var dataSpace = "ui-effects-",

	// Create a local jQuery because jQuery Color relies on it and the
	// global may not exist with AMD and a custom build (#10199)
	jQuery = $;

$.effects = {
	effect: {}
};

/*!
 * jQuery Color Animations v2.1.2
 * https://github.com/jquery/jquery-color
 *
 * Copyright 2014 jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * Date: Wed Jan 16 08:47:09 2013 -0600
 */
(function( jQuery, undefined ) {

	var stepHooks = "backgroundColor borderBottomColor borderLeftColor borderRightColor borderTopColor color columnRuleColor outlineColor textDecorationColor textEmphasisColor",

	// plusequals test for += 100 -= 100
	rplusequals = /^([\-+])=\s*(\d+\.?\d*)/,
	// a set of RE's that can match strings and generate color tuples.
	stringParsers = [ {
			re: /rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,
			parse: function( execResult ) {
				return [
					execResult[ 1 ],
					execResult[ 2 ],
					execResult[ 3 ],
					execResult[ 4 ]
				];
			}
		}, {
			re: /rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,
			parse: function( execResult ) {
				return [
					execResult[ 1 ] * 2.55,
					execResult[ 2 ] * 2.55,
					execResult[ 3 ] * 2.55,
					execResult[ 4 ]
				];
			}
		}, {
			// this regex ignores A-F because it's compared against an already lowercased string
			re: /#([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})/,
			parse: function( execResult ) {
				return [
					parseInt( execResult[ 1 ], 16 ),
					parseInt( execResult[ 2 ], 16 ),
					parseInt( execResult[ 3 ], 16 )
				];
			}
		}, {
			// this regex ignores A-F because it's compared against an already lowercased string
			re: /#([a-f0-9])([a-f0-9])([a-f0-9])/,
			parse: function( execResult ) {
				return [
					parseInt( execResult[ 1 ] + execResult[ 1 ], 16 ),
					parseInt( execResult[ 2 ] + execResult[ 2 ], 16 ),
					parseInt( execResult[ 3 ] + execResult[ 3 ], 16 )
				];
			}
		}, {
			re: /hsla?\(\s*(\d+(?:\.\d+)?)\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,
			space: "hsla",
			parse: function( execResult ) {
				return [
					execResult[ 1 ],
					execResult[ 2 ] / 100,
					execResult[ 3 ] / 100,
					execResult[ 4 ]
				];
			}
		} ],

	// jQuery.Color( )
	color = jQuery.Color = function( color, green, blue, alpha ) {
		return new jQuery.Color.fn.parse( color, green, blue, alpha );
	},
	spaces = {
		rgba: {
			props: {
				red: {
					idx: 0,
					type: "byte"
				},
				green: {
					idx: 1,
					type: "byte"
				},
				blue: {
					idx: 2,
					type: "byte"
				}
			}
		},

		hsla: {
			props: {
				hue: {
					idx: 0,
					type: "degrees"
				},
				saturation: {
					idx: 1,
					type: "percent"
				},
				lightness: {
					idx: 2,
					type: "percent"
				}
			}
		}
	},
	propTypes = {
		"byte": {
			floor: true,
			max: 255
		},
		"percent": {
			max: 1
		},
		"degrees": {
			mod: 360,
			floor: true
		}
	},
	support = color.support = {},

	// element for support tests
	supportElem = jQuery( "<p>" )[ 0 ],

	// colors = jQuery.Color.names
	colors,

	// local aliases of functions called often
	each = jQuery.each;

// determine rgba support immediately
supportElem.style.cssText = "background-color:rgba(1,1,1,.5)";
support.rgba = supportElem.style.backgroundColor.indexOf( "rgba" ) > -1;

// define cache name and alpha properties
// for rgba and hsla spaces
each( spaces, function( spaceName, space ) {
	space.cache = "_" + spaceName;
	space.props.alpha = {
		idx: 3,
		type: "percent",
		def: 1
	};
});

function clamp( value, prop, allowEmpty ) {
	var type = propTypes[ prop.type ] || {};

	if ( value == null ) {
		return (allowEmpty || !prop.def) ? null : prop.def;
	}

	// ~~ is an short way of doing floor for positive numbers
	value = type.floor ? ~~value : parseFloat( value );

	// IE will pass in empty strings as value for alpha,
	// which will hit this case
	if ( isNaN( value ) ) {
		return prop.def;
	}

	if ( type.mod ) {
		// we add mod before modding to make sure that negatives values
		// get converted properly: -10 -> 350
		return (value + type.mod) % type.mod;
	}

	// for now all property types without mod have min and max
	return 0 > value ? 0 : type.max < value ? type.max : value;
}

function stringParse( string ) {
	var inst = color(),
		rgba = inst._rgba = [];

	string = string.toLowerCase();

	each( stringParsers, function( i, parser ) {
		var parsed,
			match = parser.re.exec( string ),
			values = match && parser.parse( match ),
			spaceName = parser.space || "rgba";

		if ( values ) {
			parsed = inst[ spaceName ]( values );

			// if this was an rgba parse the assignment might happen twice
			// oh well....
			inst[ spaces[ spaceName ].cache ] = parsed[ spaces[ spaceName ].cache ];
			rgba = inst._rgba = parsed._rgba;

			// exit each( stringParsers ) here because we matched
			return false;
		}
	});

	// Found a stringParser that handled it
	if ( rgba.length ) {

		// if this came from a parsed string, force "transparent" when alpha is 0
		// chrome, (and maybe others) return "transparent" as rgba(0,0,0,0)
		if ( rgba.join() === "0,0,0,0" ) {
			jQuery.extend( rgba, colors.transparent );
		}
		return inst;
	}

	// named colors
	return colors[ string ];
}

color.fn = jQuery.extend( color.prototype, {
	parse: function( red, green, blue, alpha ) {
		if ( red === undefined ) {
			this._rgba = [ null, null, null, null ];
			return this;
		}
		if ( red.jquery || red.nodeType ) {
			red = jQuery( red ).css( green );
			green = undefined;
		}

		var inst = this,
			type = jQuery.type( red ),
			rgba = this._rgba = [];

		// more than 1 argument specified - assume ( red, green, blue, alpha )
		if ( green !== undefined ) {
			red = [ red, green, blue, alpha ];
			type = "array";
		}

		if ( type === "string" ) {
			return this.parse( stringParse( red ) || colors._default );
		}

		if ( type === "array" ) {
			each( spaces.rgba.props, function( key, prop ) {
				rgba[ prop.idx ] = clamp( red[ prop.idx ], prop );
			});
			return this;
		}

		if ( type === "object" ) {
			if ( red instanceof color ) {
				each( spaces, function( spaceName, space ) {
					if ( red[ space.cache ] ) {
						inst[ space.cache ] = red[ space.cache ].slice();
					}
				});
			} else {
				each( spaces, function( spaceName, space ) {
					var cache = space.cache;
					each( space.props, function( key, prop ) {

						// if the cache doesn't exist, and we know how to convert
						if ( !inst[ cache ] && space.to ) {

							// if the value was null, we don't need to copy it
							// if the key was alpha, we don't need to copy it either
							if ( key === "alpha" || red[ key ] == null ) {
								return;
							}
							inst[ cache ] = space.to( inst._rgba );
						}

						// this is the only case where we allow nulls for ALL properties.
						// call clamp with alwaysAllowEmpty
						inst[ cache ][ prop.idx ] = clamp( red[ key ], prop, true );
					});

					// everything defined but alpha?
					if ( inst[ cache ] && jQuery.inArray( null, inst[ cache ].slice( 0, 3 ) ) < 0 ) {
						// use the default of 1
						inst[ cache ][ 3 ] = 1;
						if ( space.from ) {
							inst._rgba = space.from( inst[ cache ] );
						}
					}
				});
			}
			return this;
		}
	},
	is: function( compare ) {
		var is = color( compare ),
			same = true,
			inst = this;

		each( spaces, function( _, space ) {
			var localCache,
				isCache = is[ space.cache ];
			if (isCache) {
				localCache = inst[ space.cache ] || space.to && space.to( inst._rgba ) || [];
				each( space.props, function( _, prop ) {
					if ( isCache[ prop.idx ] != null ) {
						same = ( isCache[ prop.idx ] === localCache[ prop.idx ] );
						return same;
					}
				});
			}
			return same;
		});
		return same;
	},
	_space: function() {
		var used = [],
			inst = this;
		each( spaces, function( spaceName, space ) {
			if ( inst[ space.cache ] ) {
				used.push( spaceName );
			}
		});
		return used.pop();
	},
	transition: function( other, distance ) {
		var end = color( other ),
			spaceName = end._space(),
			space = spaces[ spaceName ],
			startColor = this.alpha() === 0 ? color( "transparent" ) : this,
			start = startColor[ space.cache ] || space.to( startColor._rgba ),
			result = start.slice();

		end = end[ space.cache ];
		each( space.props, function( key, prop ) {
			var index = prop.idx,
				startValue = start[ index ],
				endValue = end[ index ],
				type = propTypes[ prop.type ] || {};

			// if null, don't override start value
			if ( endValue === null ) {
				return;
			}
			// if null - use end
			if ( startValue === null ) {
				result[ index ] = endValue;
			} else {
				if ( type.mod ) {
					if ( endValue - startValue > type.mod / 2 ) {
						startValue += type.mod;
					} else if ( startValue - endValue > type.mod / 2 ) {
						startValue -= type.mod;
					}
				}
				result[ index ] = clamp( ( endValue - startValue ) * distance + startValue, prop );
			}
		});
		return this[ spaceName ]( result );
	},
	blend: function( opaque ) {
		// if we are already opaque - return ourself
		if ( this._rgba[ 3 ] === 1 ) {
			return this;
		}

		var rgb = this._rgba.slice(),
			a = rgb.pop(),
			blend = color( opaque )._rgba;

		return color( jQuery.map( rgb, function( v, i ) {
			return ( 1 - a ) * blend[ i ] + a * v;
		}));
	},
	toRgbaString: function() {
		var prefix = "rgba(",
			rgba = jQuery.map( this._rgba, function( v, i ) {
				return v == null ? ( i > 2 ? 1 : 0 ) : v;
			});

		if ( rgba[ 3 ] === 1 ) {
			rgba.pop();
			prefix = "rgb(";
		}

		return prefix + rgba.join() + ")";
	},
	toHslaString: function() {
		var prefix = "hsla(",
			hsla = jQuery.map( this.hsla(), function( v, i ) {
				if ( v == null ) {
					v = i > 2 ? 1 : 0;
				}

				// catch 1 and 2
				if ( i && i < 3 ) {
					v = Math.round( v * 100 ) + "%";
				}
				return v;
			});

		if ( hsla[ 3 ] === 1 ) {
			hsla.pop();
			prefix = "hsl(";
		}
		return prefix + hsla.join() + ")";
	},
	toHexString: function( includeAlpha ) {
		var rgba = this._rgba.slice(),
			alpha = rgba.pop();

		if ( includeAlpha ) {
			rgba.push( ~~( alpha * 255 ) );
		}

		return "#" + jQuery.map( rgba, function( v ) {

			// default to 0 when nulls exist
			v = ( v || 0 ).toString( 16 );
			return v.length === 1 ? "0" + v : v;
		}).join("");
	},
	toString: function() {
		return this._rgba[ 3 ] === 0 ? "transparent" : this.toRgbaString();
	}
});
color.fn.parse.prototype = color.fn;

// hsla conversions adapted from:
// https://code.google.com/p/maashaack/source/browse/packages/graphics/trunk/src/graphics/colors/HUE2RGB.as?r=5021

function hue2rgb( p, q, h ) {
	h = ( h + 1 ) % 1;
	if ( h * 6 < 1 ) {
		return p + ( q - p ) * h * 6;
	}
	if ( h * 2 < 1) {
		return q;
	}
	if ( h * 3 < 2 ) {
		return p + ( q - p ) * ( ( 2 / 3 ) - h ) * 6;
	}
	return p;
}

spaces.hsla.to = function( rgba ) {
	if ( rgba[ 0 ] == null || rgba[ 1 ] == null || rgba[ 2 ] == null ) {
		return [ null, null, null, rgba[ 3 ] ];
	}
	var r = rgba[ 0 ] / 255,
		g = rgba[ 1 ] / 255,
		b = rgba[ 2 ] / 255,
		a = rgba[ 3 ],
		max = Math.max( r, g, b ),
		min = Math.min( r, g, b ),
		diff = max - min,
		add = max + min,
		l = add * 0.5,
		h, s;

	if ( min === max ) {
		h = 0;
	} else if ( r === max ) {
		h = ( 60 * ( g - b ) / diff ) + 360;
	} else if ( g === max ) {
		h = ( 60 * ( b - r ) / diff ) + 120;
	} else {
		h = ( 60 * ( r - g ) / diff ) + 240;
	}

	// chroma (diff) == 0 means greyscale which, by definition, saturation = 0%
	// otherwise, saturation is based on the ratio of chroma (diff) to lightness (add)
	if ( diff === 0 ) {
		s = 0;
	} else if ( l <= 0.5 ) {
		s = diff / add;
	} else {
		s = diff / ( 2 - add );
	}
	return [ Math.round(h) % 360, s, l, a == null ? 1 : a ];
};

spaces.hsla.from = function( hsla ) {
	if ( hsla[ 0 ] == null || hsla[ 1 ] == null || hsla[ 2 ] == null ) {
		return [ null, null, null, hsla[ 3 ] ];
	}
	var h = hsla[ 0 ] / 360,
		s = hsla[ 1 ],
		l = hsla[ 2 ],
		a = hsla[ 3 ],
		q = l <= 0.5 ? l * ( 1 + s ) : l + s - l * s,
		p = 2 * l - q;

	return [
		Math.round( hue2rgb( p, q, h + ( 1 / 3 ) ) * 255 ),
		Math.round( hue2rgb( p, q, h ) * 255 ),
		Math.round( hue2rgb( p, q, h - ( 1 / 3 ) ) * 255 ),
		a
	];
};

each( spaces, function( spaceName, space ) {
	var props = space.props,
		cache = space.cache,
		to = space.to,
		from = space.from;

	// makes rgba() and hsla()
	color.fn[ spaceName ] = function( value ) {

		// generate a cache for this space if it doesn't exist
		if ( to && !this[ cache ] ) {
			this[ cache ] = to( this._rgba );
		}
		if ( value === undefined ) {
			return this[ cache ].slice();
		}

		var ret,
			type = jQuery.type( value ),
			arr = ( type === "array" || type === "object" ) ? value : arguments,
			local = this[ cache ].slice();

		each( props, function( key, prop ) {
			var val = arr[ type === "object" ? key : prop.idx ];
			if ( val == null ) {
				val = local[ prop.idx ];
			}
			local[ prop.idx ] = clamp( val, prop );
		});

		if ( from ) {
			ret = color( from( local ) );
			ret[ cache ] = local;
			return ret;
		} else {
			return color( local );
		}
	};

	// makes red() green() blue() alpha() hue() saturation() lightness()
	each( props, function( key, prop ) {
		// alpha is included in more than one space
		if ( color.fn[ key ] ) {
			return;
		}
		color.fn[ key ] = function( value ) {
			var vtype = jQuery.type( value ),
				fn = ( key === "alpha" ? ( this._hsla ? "hsla" : "rgba" ) : spaceName ),
				local = this[ fn ](),
				cur = local[ prop.idx ],
				match;

			if ( vtype === "undefined" ) {
				return cur;
			}

			if ( vtype === "function" ) {
				value = value.call( this, cur );
				vtype = jQuery.type( value );
			}
			if ( value == null && prop.empty ) {
				return this;
			}
			if ( vtype === "string" ) {
				match = rplusequals.exec( value );
				if ( match ) {
					value = cur + parseFloat( match[ 2 ] ) * ( match[ 1 ] === "+" ? 1 : -1 );
				}
			}
			local[ prop.idx ] = value;
			return this[ fn ]( local );
		};
	});
});

// add cssHook and .fx.step function for each named hook.
// accept a space separated string of properties
color.hook = function( hook ) {
	var hooks = hook.split( " " );
	each( hooks, function( i, hook ) {
		jQuery.cssHooks[ hook ] = {
			set: function( elem, value ) {
				var parsed, curElem,
					backgroundColor = "";

				if ( value !== "transparent" && ( jQuery.type( value ) !== "string" || ( parsed = stringParse( value ) ) ) ) {
					value = color( parsed || value );
					if ( !support.rgba && value._rgba[ 3 ] !== 1 ) {
						curElem = hook === "backgroundColor" ? elem.parentNode : elem;
						while (
							(backgroundColor === "" || backgroundColor === "transparent") &&
							curElem && curElem.style
						) {
							try {
								backgroundColor = jQuery.css( curElem, "backgroundColor" );
								curElem = curElem.parentNode;
							} catch ( e ) {
							}
						}

						value = value.blend( backgroundColor && backgroundColor !== "transparent" ?
							backgroundColor :
							"_default" );
					}

					value = value.toRgbaString();
				}
				try {
					elem.style[ hook ] = value;
				} catch ( e ) {
					// wrapped to prevent IE from throwing errors on "invalid" values like 'auto' or 'inherit'
				}
			}
		};
		jQuery.fx.step[ hook ] = function( fx ) {
			if ( !fx.colorInit ) {
				fx.start = color( fx.elem, hook );
				fx.end = color( fx.end );
				fx.colorInit = true;
			}
			jQuery.cssHooks[ hook ].set( fx.elem, fx.start.transition( fx.end, fx.pos ) );
		};
	});

};

color.hook( stepHooks );

jQuery.cssHooks.borderColor = {
	expand: function( value ) {
		var expanded = {};

		each( [ "Top", "Right", "Bottom", "Left" ], function( i, part ) {
			expanded[ "border" + part + "Color" ] = value;
		});
		return expanded;
	}
};

// Basic color names only.
// Usage of any of the other color names requires adding yourself or including
// jquery.color.svg-names.js.
colors = jQuery.Color.names = {
	// 4.1. Basic color keywords
	aqua: "#00ffff",
	black: "#000000",
	blue: "#0000ff",
	fuchsia: "#ff00ff",
	gray: "#808080",
	green: "#008000",
	lime: "#00ff00",
	maroon: "#800000",
	navy: "#000080",
	olive: "#808000",
	purple: "#800080",
	red: "#ff0000",
	silver: "#c0c0c0",
	teal: "#008080",
	white: "#ffffff",
	yellow: "#ffff00",

	// 4.2.3. "transparent" color keyword
	transparent: [ null, null, null, 0 ],

	_default: "#ffffff"
};

})( jQuery );

/******************************************************************************/
/****************************** CLASS ANIMATIONS ******************************/
/******************************************************************************/
(function() {

var classAnimationActions = [ "add", "remove", "toggle" ],
	shorthandStyles = {
		border: 1,
		borderBottom: 1,
		borderColor: 1,
		borderLeft: 1,
		borderRight: 1,
		borderTop: 1,
		borderWidth: 1,
		margin: 1,
		padding: 1
	};

$.each([ "borderLeftStyle", "borderRightStyle", "borderBottomStyle", "borderTopStyle" ], function( _, prop ) {
	$.fx.step[ prop ] = function( fx ) {
		if ( fx.end !== "none" && !fx.setAttr || fx.pos === 1 && !fx.setAttr ) {
			jQuery.style( fx.elem, prop, fx.end );
			fx.setAttr = true;
		}
	};
});

function getElementStyles( elem ) {
	var key, len,
		style = elem.ownerDocument.defaultView ?
			elem.ownerDocument.defaultView.getComputedStyle( elem, null ) :
			elem.currentStyle,
		styles = {};

	if ( style && style.length && style[ 0 ] && style[ style[ 0 ] ] ) {
		len = style.length;
		while ( len-- ) {
			key = style[ len ];
			if ( typeof style[ key ] === "string" ) {
				styles[ $.camelCase( key ) ] = style[ key ];
			}
		}
	// support: Opera, IE <9
	} else {
		for ( key in style ) {
			if ( typeof style[ key ] === "string" ) {
				styles[ key ] = style[ key ];
			}
		}
	}

	return styles;
}

function styleDifference( oldStyle, newStyle ) {
	var diff = {},
		name, value;

	for ( name in newStyle ) {
		value = newStyle[ name ];
		if ( oldStyle[ name ] !== value ) {
			if ( !shorthandStyles[ name ] ) {
				if ( $.fx.step[ name ] || !isNaN( parseFloat( value ) ) ) {
					diff[ name ] = value;
				}
			}
		}
	}

	return diff;
}

// support: jQuery <1.8
if ( !$.fn.addBack ) {
	$.fn.addBack = function( selector ) {
		return this.add( selector == null ?
			this.prevObject : this.prevObject.filter( selector )
		);
	};
}

$.effects.animateClass = function( value, duration, easing, callback ) {
	var o = $.speed( duration, easing, callback );

	return this.queue( function() {
		var animated = $( this ),
			baseClass = animated.attr( "class" ) || "",
			applyClassChange,
			allAnimations = o.children ? animated.find( "*" ).addBack() : animated;

		// map the animated objects to store the original styles.
		allAnimations = allAnimations.map(function() {
			var el = $( this );
			return {
				el: el,
				start: getElementStyles( this )
			};
		});

		// apply class change
		applyClassChange = function() {
			$.each( classAnimationActions, function(i, action) {
				if ( value[ action ] ) {
					animated[ action + "Class" ]( value[ action ] );
				}
			});
		};
		applyClassChange();

		// map all animated objects again - calculate new styles and diff
		allAnimations = allAnimations.map(function() {
			this.end = getElementStyles( this.el[ 0 ] );
			this.diff = styleDifference( this.start, this.end );
			return this;
		});

		// apply original class
		animated.attr( "class", baseClass );

		// map all animated objects again - this time collecting a promise
		allAnimations = allAnimations.map(function() {
			var styleInfo = this,
				dfd = $.Deferred(),
				opts = $.extend({}, o, {
					queue: false,
					complete: function() {
						dfd.resolve( styleInfo );
					}
				});

			this.el.animate( this.diff, opts );
			return dfd.promise();
		});

		// once all animations have completed:
		$.when.apply( $, allAnimations.get() ).done(function() {

			// set the final class
			applyClassChange();

			// for each animated element,
			// clear all css properties that were animated
			$.each( arguments, function() {
				var el = this.el;
				$.each( this.diff, function(key) {
					el.css( key, "" );
				});
			});

			// this is guarnteed to be there if you use jQuery.speed()
			// it also handles dequeuing the next anim...
			o.complete.call( animated[ 0 ] );
		});
	});
};

$.fn.extend({
	addClass: (function( orig ) {
		return function( classNames, speed, easing, callback ) {
			return speed ?
				$.effects.animateClass.call( this,
					{ add: classNames }, speed, easing, callback ) :
				orig.apply( this, arguments );
		};
	})( $.fn.addClass ),

	removeClass: (function( orig ) {
		return function( classNames, speed, easing, callback ) {
			return arguments.length > 1 ?
				$.effects.animateClass.call( this,
					{ remove: classNames }, speed, easing, callback ) :
				orig.apply( this, arguments );
		};
	})( $.fn.removeClass ),

	toggleClass: (function( orig ) {
		return function( classNames, force, speed, easing, callback ) {
			if ( typeof force === "boolean" || force === undefined ) {
				if ( !speed ) {
					// without speed parameter
					return orig.apply( this, arguments );
				} else {
					return $.effects.animateClass.call( this,
						(force ? { add: classNames } : { remove: classNames }),
						speed, easing, callback );
				}
			} else {
				// without force parameter
				return $.effects.animateClass.call( this,
					{ toggle: classNames }, force, speed, easing );
			}
		};
	})( $.fn.toggleClass ),

	switchClass: function( remove, add, speed, easing, callback) {
		return $.effects.animateClass.call( this, {
			add: add,
			remove: remove
		}, speed, easing, callback );
	}
});

})();

/******************************************************************************/
/*********************************** EFFECTS **********************************/
/******************************************************************************/

(function() {

$.extend( $.effects, {
	version: "1.11.4",

	// Saves a set of properties in a data storage
	save: function( element, set ) {
		for ( var i = 0; i < set.length; i++ ) {
			if ( set[ i ] !== null ) {
				element.data( dataSpace + set[ i ], element[ 0 ].style[ set[ i ] ] );
			}
		}
	},

	// Restores a set of previously saved properties from a data storage
	restore: function( element, set ) {
		var val, i;
		for ( i = 0; i < set.length; i++ ) {
			if ( set[ i ] !== null ) {
				val = element.data( dataSpace + set[ i ] );
				// support: jQuery 1.6.2
				// http://bugs.jquery.com/ticket/9917
				// jQuery 1.6.2 incorrectly returns undefined for any falsy value.
				// We can't differentiate between "" and 0 here, so we just assume
				// empty string since it's likely to be a more common value...
				if ( val === undefined ) {
					val = "";
				}
				element.css( set[ i ], val );
			}
		}
	},

	setMode: function( el, mode ) {
		if (mode === "toggle") {
			mode = el.is( ":hidden" ) ? "show" : "hide";
		}
		return mode;
	},

	// Translates a [top,left] array into a baseline value
	// this should be a little more flexible in the future to handle a string & hash
	getBaseline: function( origin, original ) {
		var y, x;
		switch ( origin[ 0 ] ) {
			case "top": y = 0; break;
			case "middle": y = 0.5; break;
			case "bottom": y = 1; break;
			default: y = origin[ 0 ] / original.height;
		}
		switch ( origin[ 1 ] ) {
			case "left": x = 0; break;
			case "center": x = 0.5; break;
			case "right": x = 1; break;
			default: x = origin[ 1 ] / original.width;
		}
		return {
			x: x,
			y: y
		};
	},

	// Wraps the element around a wrapper that copies position properties
	createWrapper: function( element ) {

		// if the element is already wrapped, return it
		if ( element.parent().is( ".ui-effects-wrapper" )) {
			return element.parent();
		}

		// wrap the element
		var props = {
				width: element.outerWidth(true),
				height: element.outerHeight(true),
				"float": element.css( "float" )
			},
			wrapper = $( "<div></div>" )
				.addClass( "ui-effects-wrapper" )
				.css({
					fontSize: "100%",
					background: "transparent",
					border: "none",
					margin: 0,
					padding: 0
				}),
			// Store the size in case width/height are defined in % - Fixes #5245
			size = {
				width: element.width(),
				height: element.height()
			},
			active = document.activeElement;

		// support: Firefox
		// Firefox incorrectly exposes anonymous content
		// https://bugzilla.mozilla.org/show_bug.cgi?id=561664
		try {
			active.id;
		} catch ( e ) {
			active = document.body;
		}

		element.wrap( wrapper );

		// Fixes #7595 - Elements lose focus when wrapped.
		if ( element[ 0 ] === active || $.contains( element[ 0 ], active ) ) {
			$( active ).focus();
		}

		wrapper = element.parent(); //Hotfix for jQuery 1.4 since some change in wrap() seems to actually lose the reference to the wrapped element

		// transfer positioning properties to the wrapper
		if ( element.css( "position" ) === "static" ) {
			wrapper.css({ position: "relative" });
			element.css({ position: "relative" });
		} else {
			$.extend( props, {
				position: element.css( "position" ),
				zIndex: element.css( "z-index" )
			});
			$.each([ "top", "left", "bottom", "right" ], function(i, pos) {
				props[ pos ] = element.css( pos );
				if ( isNaN( parseInt( props[ pos ], 10 ) ) ) {
					props[ pos ] = "auto";
				}
			});
			element.css({
				position: "relative",
				top: 0,
				left: 0,
				right: "auto",
				bottom: "auto"
			});
		}
		element.css(size);

		return wrapper.css( props ).show();
	},

	removeWrapper: function( element ) {
		var active = document.activeElement;

		if ( element.parent().is( ".ui-effects-wrapper" ) ) {
			element.parent().replaceWith( element );

			// Fixes #7595 - Elements lose focus when wrapped.
			if ( element[ 0 ] === active || $.contains( element[ 0 ], active ) ) {
				$( active ).focus();
			}
		}

		return element;
	},

	setTransition: function( element, list, factor, value ) {
		value = value || {};
		$.each( list, function( i, x ) {
			var unit = element.cssUnit( x );
			if ( unit[ 0 ] > 0 ) {
				value[ x ] = unit[ 0 ] * factor + unit[ 1 ];
			}
		});
		return value;
	}
});

// return an effect options object for the given parameters:
function _normalizeArguments( effect, options, speed, callback ) {

	// allow passing all options as the first parameter
	if ( $.isPlainObject( effect ) ) {
		options = effect;
		effect = effect.effect;
	}

	// convert to an object
	effect = { effect: effect };

	// catch (effect, null, ...)
	if ( options == null ) {
		options = {};
	}

	// catch (effect, callback)
	if ( $.isFunction( options ) ) {
		callback = options;
		speed = null;
		options = {};
	}

	// catch (effect, speed, ?)
	if ( typeof options === "number" || $.fx.speeds[ options ] ) {
		callback = speed;
		speed = options;
		options = {};
	}

	// catch (effect, options, callback)
	if ( $.isFunction( speed ) ) {
		callback = speed;
		speed = null;
	}

	// add options to effect
	if ( options ) {
		$.extend( effect, options );
	}

	speed = speed || options.duration;
	effect.duration = $.fx.off ? 0 :
		typeof speed === "number" ? speed :
		speed in $.fx.speeds ? $.fx.speeds[ speed ] :
		$.fx.speeds._default;

	effect.complete = callback || options.complete;

	return effect;
}

function standardAnimationOption( option ) {
	// Valid standard speeds (nothing, number, named speed)
	if ( !option || typeof option === "number" || $.fx.speeds[ option ] ) {
		return true;
	}

	// Invalid strings - treat as "normal" speed
	if ( typeof option === "string" && !$.effects.effect[ option ] ) {
		return true;
	}

	// Complete callback
	if ( $.isFunction( option ) ) {
		return true;
	}

	// Options hash (but not naming an effect)
	if ( typeof option === "object" && !option.effect ) {
		return true;
	}

	// Didn't match any standard API
	return false;
}

$.fn.extend({
	effect: function( /* effect, options, speed, callback */ ) {
		var args = _normalizeArguments.apply( this, arguments ),
			mode = args.mode,
			queue = args.queue,
			effectMethod = $.effects.effect[ args.effect ];

		if ( $.fx.off || !effectMethod ) {
			// delegate to the original method (e.g., .show()) if possible
			if ( mode ) {
				return this[ mode ]( args.duration, args.complete );
			} else {
				return this.each( function() {
					if ( args.complete ) {
						args.complete.call( this );
					}
				});
			}
		}

		function run( next ) {
			var elem = $( this ),
				complete = args.complete,
				mode = args.mode;

			function done() {
				if ( $.isFunction( complete ) ) {
					complete.call( elem[0] );
				}
				if ( $.isFunction( next ) ) {
					next();
				}
			}

			// If the element already has the correct final state, delegate to
			// the core methods so the internal tracking of "olddisplay" works.
			if ( elem.is( ":hidden" ) ? mode === "hide" : mode === "show" ) {
				elem[ mode ]();
				done();
			} else {
				effectMethod.call( elem[0], args, done );
			}
		}

		return queue === false ? this.each( run ) : this.queue( queue || "fx", run );
	},

	show: (function( orig ) {
		return function( option ) {
			if ( standardAnimationOption( option ) ) {
				return orig.apply( this, arguments );
			} else {
				var args = _normalizeArguments.apply( this, arguments );
				args.mode = "show";
				return this.effect.call( this, args );
			}
		};
	})( $.fn.show ),

	hide: (function( orig ) {
		return function( option ) {
			if ( standardAnimationOption( option ) ) {
				return orig.apply( this, arguments );
			} else {
				var args = _normalizeArguments.apply( this, arguments );
				args.mode = "hide";
				return this.effect.call( this, args );
			}
		};
	})( $.fn.hide ),

	toggle: (function( orig ) {
		return function( option ) {
			if ( standardAnimationOption( option ) || typeof option === "boolean" ) {
				return orig.apply( this, arguments );
			} else {
				var args = _normalizeArguments.apply( this, arguments );
				args.mode = "toggle";
				return this.effect.call( this, args );
			}
		};
	})( $.fn.toggle ),

	// helper functions
	cssUnit: function(key) {
		var style = this.css( key ),
			val = [];

		$.each( [ "em", "px", "%", "pt" ], function( i, unit ) {
			if ( style.indexOf( unit ) > 0 ) {
				val = [ parseFloat( style ), unit ];
			}
		});
		return val;
	}
});

})();

/******************************************************************************/
/*********************************** EASING ***********************************/
/******************************************************************************/

(function() {

// based on easing equations from Robert Penner (http://www.robertpenner.com/easing)

var baseEasings = {};

$.each( [ "Quad", "Cubic", "Quart", "Quint", "Expo" ], function( i, name ) {
	baseEasings[ name ] = function( p ) {
		return Math.pow( p, i + 2 );
	};
});

$.extend( baseEasings, {
	Sine: function( p ) {
		return 1 - Math.cos( p * Math.PI / 2 );
	},
	Circ: function( p ) {
		return 1 - Math.sqrt( 1 - p * p );
	},
	Elastic: function( p ) {
		return p === 0 || p === 1 ? p :
			-Math.pow( 2, 8 * (p - 1) ) * Math.sin( ( (p - 1) * 80 - 7.5 ) * Math.PI / 15 );
	},
	Back: function( p ) {
		return p * p * ( 3 * p - 2 );
	},
	Bounce: function( p ) {
		var pow2,
			bounce = 4;

		while ( p < ( ( pow2 = Math.pow( 2, --bounce ) ) - 1 ) / 11 ) {}
		return 1 / Math.pow( 4, 3 - bounce ) - 7.5625 * Math.pow( ( pow2 * 3 - 2 ) / 22 - p, 2 );
	}
});

$.each( baseEasings, function( name, easeIn ) {
	$.easing[ "easeIn" + name ] = easeIn;
	$.easing[ "easeOut" + name ] = function( p ) {
		return 1 - easeIn( 1 - p );
	};
	$.easing[ "easeInOut" + name ] = function( p ) {
		return p < 0.5 ?
			easeIn( p * 2 ) / 2 :
			1 - easeIn( p * -2 + 2 ) / 2;
	};
});

})();

var effect = $.effects;


/*!
 * jQuery UI Effects Blind 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/blind-effect/
 */


var effectBlind = $.effects.effect.blind = function( o, done ) {
	// Create element
	var el = $( this ),
		rvertical = /up|down|vertical/,
		rpositivemotion = /up|left|vertical|horizontal/,
		props = [ "position", "top", "bottom", "left", "right", "height", "width" ],
		mode = $.effects.setMode( el, o.mode || "hide" ),
		direction = o.direction || "up",
		vertical = rvertical.test( direction ),
		ref = vertical ? "height" : "width",
		ref2 = vertical ? "top" : "left",
		motion = rpositivemotion.test( direction ),
		animation = {},
		show = mode === "show",
		wrapper, distance, margin;

	// if already wrapped, the wrapper's properties are my property. #6245
	if ( el.parent().is( ".ui-effects-wrapper" ) ) {
		$.effects.save( el.parent(), props );
	} else {
		$.effects.save( el, props );
	}
	el.show();
	wrapper = $.effects.createWrapper( el ).css({
		overflow: "hidden"
	});

	distance = wrapper[ ref ]();
	margin = parseFloat( wrapper.css( ref2 ) ) || 0;

	animation[ ref ] = show ? distance : 0;
	if ( !motion ) {
		el
			.css( vertical ? "bottom" : "right", 0 )
			.css( vertical ? "top" : "left", "auto" )
			.css({ position: "absolute" });

		animation[ ref2 ] = show ? margin : distance + margin;
	}

	// start at 0 if we are showing
	if ( show ) {
		wrapper.css( ref, 0 );
		if ( !motion ) {
			wrapper.css( ref2, margin + distance );
		}
	}

	// Animate
	wrapper.animate( animation, {
		duration: o.duration,
		easing: o.easing,
		queue: false,
		complete: function() {
			if ( mode === "hide" ) {
				el.hide();
			}
			$.effects.restore( el, props );
			$.effects.removeWrapper( el );
			done();
		}
	});
};


/*!
 * jQuery UI Effects Bounce 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/bounce-effect/
 */


var effectBounce = $.effects.effect.bounce = function( o, done ) {
	var el = $( this ),
		props = [ "position", "top", "bottom", "left", "right", "height", "width" ],

		// defaults:
		mode = $.effects.setMode( el, o.mode || "effect" ),
		hide = mode === "hide",
		show = mode === "show",
		direction = o.direction || "up",
		distance = o.distance,
		times = o.times || 5,

		// number of internal animations
		anims = times * 2 + ( show || hide ? 1 : 0 ),
		speed = o.duration / anims,
		easing = o.easing,

		// utility:
		ref = ( direction === "up" || direction === "down" ) ? "top" : "left",
		motion = ( direction === "up" || direction === "left" ),
		i,
		upAnim,
		downAnim,

		// we will need to re-assemble the queue to stack our animations in place
		queue = el.queue(),
		queuelen = queue.length;

	// Avoid touching opacity to prevent clearType and PNG issues in IE
	if ( show || hide ) {
		props.push( "opacity" );
	}

	$.effects.save( el, props );
	el.show();
	$.effects.createWrapper( el ); // Create Wrapper

	// default distance for the BIGGEST bounce is the outer Distance / 3
	if ( !distance ) {
		distance = el[ ref === "top" ? "outerHeight" : "outerWidth" ]() / 3;
	}

	if ( show ) {
		downAnim = { opacity: 1 };
		downAnim[ ref ] = 0;

		// if we are showing, force opacity 0 and set the initial position
		// then do the "first" animation
		el.css( "opacity", 0 )
			.css( ref, motion ? -distance * 2 : distance * 2 )
			.animate( downAnim, speed, easing );
	}

	// start at the smallest distance if we are hiding
	if ( hide ) {
		distance = distance / Math.pow( 2, times - 1 );
	}

	downAnim = {};
	downAnim[ ref ] = 0;
	// Bounces up/down/left/right then back to 0 -- times * 2 animations happen here
	for ( i = 0; i < times; i++ ) {
		upAnim = {};
		upAnim[ ref ] = ( motion ? "-=" : "+=" ) + distance;

		el.animate( upAnim, speed, easing )
			.animate( downAnim, speed, easing );

		distance = hide ? distance * 2 : distance / 2;
	}

	// Last Bounce when Hiding
	if ( hide ) {
		upAnim = { opacity: 0 };
		upAnim[ ref ] = ( motion ? "-=" : "+=" ) + distance;

		el.animate( upAnim, speed, easing );
	}

	el.queue(function() {
		if ( hide ) {
			el.hide();
		}
		$.effects.restore( el, props );
		$.effects.removeWrapper( el );
		done();
	});

	// inject all the animations we just queued to be first in line (after "inprogress")
	if ( queuelen > 1) {
		queue.splice.apply( queue,
			[ 1, 0 ].concat( queue.splice( queuelen, anims + 1 ) ) );
	}
	el.dequeue();

};


/*!
 * jQuery UI Effects Clip 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/clip-effect/
 */


var effectClip = $.effects.effect.clip = function( o, done ) {
	// Create element
	var el = $( this ),
		props = [ "position", "top", "bottom", "left", "right", "height", "width" ],
		mode = $.effects.setMode( el, o.mode || "hide" ),
		show = mode === "show",
		direction = o.direction || "vertical",
		vert = direction === "vertical",
		size = vert ? "height" : "width",
		position = vert ? "top" : "left",
		animation = {},
		wrapper, animate, distance;

	// Save & Show
	$.effects.save( el, props );
	el.show();

	// Create Wrapper
	wrapper = $.effects.createWrapper( el ).css({
		overflow: "hidden"
	});
	animate = ( el[0].tagName === "IMG" ) ? wrapper : el;
	distance = animate[ size ]();

	// Shift
	if ( show ) {
		animate.css( size, 0 );
		animate.css( position, distance / 2 );
	}

	// Create Animation Object:
	animation[ size ] = show ? distance : 0;
	animation[ position ] = show ? 0 : distance / 2;

	// Animate
	animate.animate( animation, {
		queue: false,
		duration: o.duration,
		easing: o.easing,
		complete: function() {
			if ( !show ) {
				el.hide();
			}
			$.effects.restore( el, props );
			$.effects.removeWrapper( el );
			done();
		}
	});

};


/*!
 * jQuery UI Effects Drop 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/drop-effect/
 */


var effectDrop = $.effects.effect.drop = function( o, done ) {

	var el = $( this ),
		props = [ "position", "top", "bottom", "left", "right", "opacity", "height", "width" ],
		mode = $.effects.setMode( el, o.mode || "hide" ),
		show = mode === "show",
		direction = o.direction || "left",
		ref = ( direction === "up" || direction === "down" ) ? "top" : "left",
		motion = ( direction === "up" || direction === "left" ) ? "pos" : "neg",
		animation = {
			opacity: show ? 1 : 0
		},
		distance;

	// Adjust
	$.effects.save( el, props );
	el.show();
	$.effects.createWrapper( el );

	distance = o.distance || el[ ref === "top" ? "outerHeight" : "outerWidth" ]( true ) / 2;

	if ( show ) {
		el
			.css( "opacity", 0 )
			.css( ref, motion === "pos" ? -distance : distance );
	}

	// Animation
	animation[ ref ] = ( show ?
		( motion === "pos" ? "+=" : "-=" ) :
		( motion === "pos" ? "-=" : "+=" ) ) +
		distance;

	// Animate
	el.animate( animation, {
		queue: false,
		duration: o.duration,
		easing: o.easing,
		complete: function() {
			if ( mode === "hide" ) {
				el.hide();
			}
			$.effects.restore( el, props );
			$.effects.removeWrapper( el );
			done();
		}
	});
};


/*!
 * jQuery UI Effects Explode 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/explode-effect/
 */


var effectExplode = $.effects.effect.explode = function( o, done ) {

	var rows = o.pieces ? Math.round( Math.sqrt( o.pieces ) ) : 3,
		cells = rows,
		el = $( this ),
		mode = $.effects.setMode( el, o.mode || "hide" ),
		show = mode === "show",

		// show and then visibility:hidden the element before calculating offset
		offset = el.show().css( "visibility", "hidden" ).offset(),

		// width and height of a piece
		width = Math.ceil( el.outerWidth() / cells ),
		height = Math.ceil( el.outerHeight() / rows ),
		pieces = [],

		// loop
		i, j, left, top, mx, my;

	// children animate complete:
	function childComplete() {
		pieces.push( this );
		if ( pieces.length === rows * cells ) {
			animComplete();
		}
	}

	// clone the element for each row and cell.
	for ( i = 0; i < rows ; i++ ) { // ===>
		top = offset.top + i * height;
		my = i - ( rows - 1 ) / 2 ;

		for ( j = 0; j < cells ; j++ ) { // |||
			left = offset.left + j * width;
			mx = j - ( cells - 1 ) / 2 ;

			// Create a clone of the now hidden main element that will be absolute positioned
			// within a wrapper div off the -left and -top equal to size of our pieces
			el
				.clone()
				.appendTo( "body" )
				.wrap( "<div></div>" )
				.css({
					position: "absolute",
					visibility: "visible",
					left: -j * width,
					top: -i * height
				})

			// select the wrapper - make it overflow: hidden and absolute positioned based on
			// where the original was located +left and +top equal to the size of pieces
				.parent()
				.addClass( "ui-effects-explode" )
				.css({
					position: "absolute",
					overflow: "hidden",
					width: width,
					height: height,
					left: left + ( show ? mx * width : 0 ),
					top: top + ( show ? my * height : 0 ),
					opacity: show ? 0 : 1
				}).animate({
					left: left + ( show ? 0 : mx * width ),
					top: top + ( show ? 0 : my * height ),
					opacity: show ? 1 : 0
				}, o.duration || 500, o.easing, childComplete );
		}
	}

	function animComplete() {
		el.css({
			visibility: "visible"
		});
		$( pieces ).remove();
		if ( !show ) {
			el.hide();
		}
		done();
	}
};


/*!
 * jQuery UI Effects Fade 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/fade-effect/
 */


var effectFade = $.effects.effect.fade = function( o, done ) {
	var el = $( this ),
		mode = $.effects.setMode( el, o.mode || "toggle" );

	el.animate({
		opacity: mode
	}, {
		queue: false,
		duration: o.duration,
		easing: o.easing,
		complete: done
	});
};


/*!
 * jQuery UI Effects Fold 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/fold-effect/
 */


var effectFold = $.effects.effect.fold = function( o, done ) {

	// Create element
	var el = $( this ),
		props = [ "position", "top", "bottom", "left", "right", "height", "width" ],
		mode = $.effects.setMode( el, o.mode || "hide" ),
		show = mode === "show",
		hide = mode === "hide",
		size = o.size || 15,
		percent = /([0-9]+)%/.exec( size ),
		horizFirst = !!o.horizFirst,
		widthFirst = show !== horizFirst,
		ref = widthFirst ? [ "width", "height" ] : [ "height", "width" ],
		duration = o.duration / 2,
		wrapper, distance,
		animation1 = {},
		animation2 = {};

	$.effects.save( el, props );
	el.show();

	// Create Wrapper
	wrapper = $.effects.createWrapper( el ).css({
		overflow: "hidden"
	});
	distance = widthFirst ?
		[ wrapper.width(), wrapper.height() ] :
		[ wrapper.height(), wrapper.width() ];

	if ( percent ) {
		size = parseInt( percent[ 1 ], 10 ) / 100 * distance[ hide ? 0 : 1 ];
	}
	if ( show ) {
		wrapper.css( horizFirst ? {
			height: 0,
			width: size
		} : {
			height: size,
			width: 0
		});
	}

	// Animation
	animation1[ ref[ 0 ] ] = show ? distance[ 0 ] : size;
	animation2[ ref[ 1 ] ] = show ? distance[ 1 ] : 0;

	// Animate
	wrapper
		.animate( animation1, duration, o.easing )
		.animate( animation2, duration, o.easing, function() {
			if ( hide ) {
				el.hide();
			}
			$.effects.restore( el, props );
			$.effects.removeWrapper( el );
			done();
		});

};


/*!
 * jQuery UI Effects Highlight 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/highlight-effect/
 */


var effectHighlight = $.effects.effect.highlight = function( o, done ) {
	var elem = $( this ),
		props = [ "backgroundImage", "backgroundColor", "opacity" ],
		mode = $.effects.setMode( elem, o.mode || "show" ),
		animation = {
			backgroundColor: elem.css( "backgroundColor" )
		};

	if (mode === "hide") {
		animation.opacity = 0;
	}

	$.effects.save( elem, props );

	elem
		.show()
		.css({
			backgroundImage: "none",
			backgroundColor: o.color || "#ffff99"
		})
		.animate( animation, {
			queue: false,
			duration: o.duration,
			easing: o.easing,
			complete: function() {
				if ( mode === "hide" ) {
					elem.hide();
				}
				$.effects.restore( elem, props );
				done();
			}
		});
};


/*!
 * jQuery UI Effects Size 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/size-effect/
 */


var effectSize = $.effects.effect.size = function( o, done ) {

	// Create element
	var original, baseline, factor,
		el = $( this ),
		props0 = [ "position", "top", "bottom", "left", "right", "width", "height", "overflow", "opacity" ],

		// Always restore
		props1 = [ "position", "top", "bottom", "left", "right", "overflow", "opacity" ],

		// Copy for children
		props2 = [ "width", "height", "overflow" ],
		cProps = [ "fontSize" ],
		vProps = [ "borderTopWidth", "borderBottomWidth", "paddingTop", "paddingBottom" ],
		hProps = [ "borderLeftWidth", "borderRightWidth", "paddingLeft", "paddingRight" ],

		// Set options
		mode = $.effects.setMode( el, o.mode || "effect" ),
		restore = o.restore || mode !== "effect",
		scale = o.scale || "both",
		origin = o.origin || [ "middle", "center" ],
		position = el.css( "position" ),
		props = restore ? props0 : props1,
		zero = {
			height: 0,
			width: 0,
			outerHeight: 0,
			outerWidth: 0
		};

	if ( mode === "show" ) {
		el.show();
	}
	original = {
		height: el.height(),
		width: el.width(),
		outerHeight: el.outerHeight(),
		outerWidth: el.outerWidth()
	};

	if ( o.mode === "toggle" && mode === "show" ) {
		el.from = o.to || zero;
		el.to = o.from || original;
	} else {
		el.from = o.from || ( mode === "show" ? zero : original );
		el.to = o.to || ( mode === "hide" ? zero : original );
	}

	// Set scaling factor
	factor = {
		from: {
			y: el.from.height / original.height,
			x: el.from.width / original.width
		},
		to: {
			y: el.to.height / original.height,
			x: el.to.width / original.width
		}
	};

	// Scale the css box
	if ( scale === "box" || scale === "both" ) {

		// Vertical props scaling
		if ( factor.from.y !== factor.to.y ) {
			props = props.concat( vProps );
			el.from = $.effects.setTransition( el, vProps, factor.from.y, el.from );
			el.to = $.effects.setTransition( el, vProps, factor.to.y, el.to );
		}

		// Horizontal props scaling
		if ( factor.from.x !== factor.to.x ) {
			props = props.concat( hProps );
			el.from = $.effects.setTransition( el, hProps, factor.from.x, el.from );
			el.to = $.effects.setTransition( el, hProps, factor.to.x, el.to );
		}
	}

	// Scale the content
	if ( scale === "content" || scale === "both" ) {

		// Vertical props scaling
		if ( factor.from.y !== factor.to.y ) {
			props = props.concat( cProps ).concat( props2 );
			el.from = $.effects.setTransition( el, cProps, factor.from.y, el.from );
			el.to = $.effects.setTransition( el, cProps, factor.to.y, el.to );
		}
	}

	$.effects.save( el, props );
	el.show();
	$.effects.createWrapper( el );
	el.css( "overflow", "hidden" ).css( el.from );

	// Adjust
	if (origin) { // Calculate baseline shifts
		baseline = $.effects.getBaseline( origin, original );
		el.from.top = ( original.outerHeight - el.outerHeight() ) * baseline.y;
		el.from.left = ( original.outerWidth - el.outerWidth() ) * baseline.x;
		el.to.top = ( original.outerHeight - el.to.outerHeight ) * baseline.y;
		el.to.left = ( original.outerWidth - el.to.outerWidth ) * baseline.x;
	}
	el.css( el.from ); // set top & left

	// Animate
	if ( scale === "content" || scale === "both" ) { // Scale the children

		// Add margins/font-size
		vProps = vProps.concat([ "marginTop", "marginBottom" ]).concat(cProps);
		hProps = hProps.concat([ "marginLeft", "marginRight" ]);
		props2 = props0.concat(vProps).concat(hProps);

		el.find( "*[width]" ).each( function() {
			var child = $( this ),
				c_original = {
					height: child.height(),
					width: child.width(),
					outerHeight: child.outerHeight(),
					outerWidth: child.outerWidth()
				};
			if (restore) {
				$.effects.save(child, props2);
			}

			child.from = {
				height: c_original.height * factor.from.y,
				width: c_original.width * factor.from.x,
				outerHeight: c_original.outerHeight * factor.from.y,
				outerWidth: c_original.outerWidth * factor.from.x
			};
			child.to = {
				height: c_original.height * factor.to.y,
				width: c_original.width * factor.to.x,
				outerHeight: c_original.height * factor.to.y,
				outerWidth: c_original.width * factor.to.x
			};

			// Vertical props scaling
			if ( factor.from.y !== factor.to.y ) {
				child.from = $.effects.setTransition( child, vProps, factor.from.y, child.from );
				child.to = $.effects.setTransition( child, vProps, factor.to.y, child.to );
			}

			// Horizontal props scaling
			if ( factor.from.x !== factor.to.x ) {
				child.from = $.effects.setTransition( child, hProps, factor.from.x, child.from );
				child.to = $.effects.setTransition( child, hProps, factor.to.x, child.to );
			}

			// Animate children
			child.css( child.from );
			child.animate( child.to, o.duration, o.easing, function() {

				// Restore children
				if ( restore ) {
					$.effects.restore( child, props2 );
				}
			});
		});
	}

	// Animate
	el.animate( el.to, {
		queue: false,
		duration: o.duration,
		easing: o.easing,
		complete: function() {
			if ( el.to.opacity === 0 ) {
				el.css( "opacity", el.from.opacity );
			}
			if ( mode === "hide" ) {
				el.hide();
			}
			$.effects.restore( el, props );
			if ( !restore ) {

				// we need to calculate our new positioning based on the scaling
				if ( position === "static" ) {
					el.css({
						position: "relative",
						top: el.to.top,
						left: el.to.left
					});
				} else {
					$.each([ "top", "left" ], function( idx, pos ) {
						el.css( pos, function( _, str ) {
							var val = parseInt( str, 10 ),
								toRef = idx ? el.to.left : el.to.top;

							// if original was "auto", recalculate the new value from wrapper
							if ( str === "auto" ) {
								return toRef + "px";
							}

							return val + toRef + "px";
						});
					});
				}
			}

			$.effects.removeWrapper( el );
			done();
		}
	});

};


/*!
 * jQuery UI Effects Scale 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/scale-effect/
 */


var effectScale = $.effects.effect.scale = function( o, done ) {

	// Create element
	var el = $( this ),
		options = $.extend( true, {}, o ),
		mode = $.effects.setMode( el, o.mode || "effect" ),
		percent = parseInt( o.percent, 10 ) ||
			( parseInt( o.percent, 10 ) === 0 ? 0 : ( mode === "hide" ? 0 : 100 ) ),
		direction = o.direction || "both",
		origin = o.origin,
		original = {
			height: el.height(),
			width: el.width(),
			outerHeight: el.outerHeight(),
			outerWidth: el.outerWidth()
		},
		factor = {
			y: direction !== "horizontal" ? (percent / 100) : 1,
			x: direction !== "vertical" ? (percent / 100) : 1
		};

	// We are going to pass this effect to the size effect:
	options.effect = "size";
	options.queue = false;
	options.complete = done;

	// Set default origin and restore for show/hide
	if ( mode !== "effect" ) {
		options.origin = origin || [ "middle", "center" ];
		options.restore = true;
	}

	options.from = o.from || ( mode === "show" ? {
		height: 0,
		width: 0,
		outerHeight: 0,
		outerWidth: 0
	} : original );
	options.to = {
		height: original.height * factor.y,
		width: original.width * factor.x,
		outerHeight: original.outerHeight * factor.y,
		outerWidth: original.outerWidth * factor.x
	};

	// Fade option to support puff
	if ( options.fade ) {
		if ( mode === "show" ) {
			options.from.opacity = 0;
			options.to.opacity = 1;
		}
		if ( mode === "hide" ) {
			options.from.opacity = 1;
			options.to.opacity = 0;
		}
	}

	// Animate
	el.effect( options );

};


/*!
 * jQuery UI Effects Puff 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/puff-effect/
 */


var effectPuff = $.effects.effect.puff = function( o, done ) {
	var elem = $( this ),
		mode = $.effects.setMode( elem, o.mode || "hide" ),
		hide = mode === "hide",
		percent = parseInt( o.percent, 10 ) || 150,
		factor = percent / 100,
		original = {
			height: elem.height(),
			width: elem.width(),
			outerHeight: elem.outerHeight(),
			outerWidth: elem.outerWidth()
		};

	$.extend( o, {
		effect: "scale",
		queue: false,
		fade: true,
		mode: mode,
		complete: done,
		percent: hide ? percent : 100,
		from: hide ?
			original :
			{
				height: original.height * factor,
				width: original.width * factor,
				outerHeight: original.outerHeight * factor,
				outerWidth: original.outerWidth * factor
			}
	});

	elem.effect( o );
};


/*!
 * jQuery UI Effects Pulsate 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/pulsate-effect/
 */


var effectPulsate = $.effects.effect.pulsate = function( o, done ) {
	var elem = $( this ),
		mode = $.effects.setMode( elem, o.mode || "show" ),
		show = mode === "show",
		hide = mode === "hide",
		showhide = ( show || mode === "hide" ),

		// showing or hiding leaves of the "last" animation
		anims = ( ( o.times || 5 ) * 2 ) + ( showhide ? 1 : 0 ),
		duration = o.duration / anims,
		animateTo = 0,
		queue = elem.queue(),
		queuelen = queue.length,
		i;

	if ( show || !elem.is(":visible")) {
		elem.css( "opacity", 0 ).show();
		animateTo = 1;
	}

	// anims - 1 opacity "toggles"
	for ( i = 1; i < anims; i++ ) {
		elem.animate({
			opacity: animateTo
		}, duration, o.easing );
		animateTo = 1 - animateTo;
	}

	elem.animate({
		opacity: animateTo
	}, duration, o.easing);

	elem.queue(function() {
		if ( hide ) {
			elem.hide();
		}
		done();
	});

	// We just queued up "anims" animations, we need to put them next in the queue
	if ( queuelen > 1 ) {
		queue.splice.apply( queue,
			[ 1, 0 ].concat( queue.splice( queuelen, anims + 1 ) ) );
	}
	elem.dequeue();
};


/*!
 * jQuery UI Effects Shake 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/shake-effect/
 */


var effectShake = $.effects.effect.shake = function( o, done ) {

	var el = $( this ),
		props = [ "position", "top", "bottom", "left", "right", "height", "width" ],
		mode = $.effects.setMode( el, o.mode || "effect" ),
		direction = o.direction || "left",
		distance = o.distance || 20,
		times = o.times || 3,
		anims = times * 2 + 1,
		speed = Math.round( o.duration / anims ),
		ref = (direction === "up" || direction === "down") ? "top" : "left",
		positiveMotion = (direction === "up" || direction === "left"),
		animation = {},
		animation1 = {},
		animation2 = {},
		i,

		// we will need to re-assemble the queue to stack our animations in place
		queue = el.queue(),
		queuelen = queue.length;

	$.effects.save( el, props );
	el.show();
	$.effects.createWrapper( el );

	// Animation
	animation[ ref ] = ( positiveMotion ? "-=" : "+=" ) + distance;
	animation1[ ref ] = ( positiveMotion ? "+=" : "-=" ) + distance * 2;
	animation2[ ref ] = ( positiveMotion ? "-=" : "+=" ) + distance * 2;

	// Animate
	el.animate( animation, speed, o.easing );

	// Shakes
	for ( i = 1; i < times; i++ ) {
		el.animate( animation1, speed, o.easing ).animate( animation2, speed, o.easing );
	}
	el
		.animate( animation1, speed, o.easing )
		.animate( animation, speed / 2, o.easing )
		.queue(function() {
			if ( mode === "hide" ) {
				el.hide();
			}
			$.effects.restore( el, props );
			$.effects.removeWrapper( el );
			done();
		});

	// inject all the animations we just queued to be first in line (after "inprogress")
	if ( queuelen > 1) {
		queue.splice.apply( queue,
			[ 1, 0 ].concat( queue.splice( queuelen, anims + 1 ) ) );
	}
	el.dequeue();

};


/*!
 * jQuery UI Effects Slide 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/slide-effect/
 */


var effectSlide = $.effects.effect.slide = function( o, done ) {

	// Create element
	var el = $( this ),
		props = [ "position", "top", "bottom", "left", "right", "width", "height" ],
		mode = $.effects.setMode( el, o.mode || "show" ),
		show = mode === "show",
		direction = o.direction || "left",
		ref = (direction === "up" || direction === "down") ? "top" : "left",
		positiveMotion = (direction === "up" || direction === "left"),
		distance,
		animation = {};

	// Adjust
	$.effects.save( el, props );
	el.show();
	distance = o.distance || el[ ref === "top" ? "outerHeight" : "outerWidth" ]( true );

	$.effects.createWrapper( el ).css({
		overflow: "hidden"
	});

	if ( show ) {
		el.css( ref, positiveMotion ? (isNaN(distance) ? "-" + distance : -distance) : distance );
	}

	// Animation
	animation[ ref ] = ( show ?
		( positiveMotion ? "+=" : "-=") :
		( positiveMotion ? "-=" : "+=")) +
		distance;

	// Animate
	el.animate( animation, {
		queue: false,
		duration: o.duration,
		easing: o.easing,
		complete: function() {
			if ( mode === "hide" ) {
				el.hide();
			}
			$.effects.restore( el, props );
			$.effects.removeWrapper( el );
			done();
		}
	});
};


/*!
 * jQuery UI Effects Transfer 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/transfer-effect/
 */


var effectTransfer = $.effects.effect.transfer = function( o, done ) {
	var elem = $( this ),
		target = $( o.to ),
		targetFixed = target.css( "position" ) === "fixed",
		body = $("body"),
		fixTop = targetFixed ? body.scrollTop() : 0,
		fixLeft = targetFixed ? body.scrollLeft() : 0,
		endPosition = target.offset(),
		animation = {
			top: endPosition.top - fixTop,
			left: endPosition.left - fixLeft,
			height: target.innerHeight(),
			width: target.innerWidth()
		},
		startPosition = elem.offset(),
		transfer = $( "<div class='ui-effects-transfer'></div>" )
			.appendTo( document.body )
			.addClass( o.className )
			.css({
				top: startPosition.top - fixTop,
				left: startPosition.left - fixLeft,
				height: elem.innerHeight(),
				width: elem.innerWidth(),
				position: targetFixed ? "fixed" : "absolute"
			})
			.animate( animation, o.duration, o.easing, function() {
				transfer.remove();
				done();
			});
};


/*!
 * jQuery UI Progressbar 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/progressbar/
 */


var progressbar = $.widget( "ui.progressbar", {
	version: "1.11.4",
	options: {
		max: 100,
		value: 0,

		change: null,
		complete: null
	},

	min: 0,

	_create: function() {
		// Constrain initial value
		this.oldValue = this.options.value = this._constrainedValue();

		this.element
			.addClass( "ui-progressbar ui-widget ui-widget-content ui-corner-all" )
			.attr({
				// Only set static values, aria-valuenow and aria-valuemax are
				// set inside _refreshValue()
				role: "progressbar",
				"aria-valuemin": this.min
			});

		this.valueDiv = $( "<div class='ui-progressbar-value ui-widget-header ui-corner-left'></div>" )
			.appendTo( this.element );

		this._refreshValue();
	},

	_destroy: function() {
		this.element
			.removeClass( "ui-progressbar ui-widget ui-widget-content ui-corner-all" )
			.removeAttr( "role" )
			.removeAttr( "aria-valuemin" )
			.removeAttr( "aria-valuemax" )
			.removeAttr( "aria-valuenow" );

		this.valueDiv.remove();
	},

	value: function( newValue ) {
		if ( newValue === undefined ) {
			return this.options.value;
		}

		this.options.value = this._constrainedValue( newValue );
		this._refreshValue();
	},

	_constrainedValue: function( newValue ) {
		if ( newValue === undefined ) {
			newValue = this.options.value;
		}

		this.indeterminate = newValue === false;

		// sanitize value
		if ( typeof newValue !== "number" ) {
			newValue = 0;
		}

		return this.indeterminate ? false :
			Math.min( this.options.max, Math.max( this.min, newValue ) );
	},

	_setOptions: function( options ) {
		// Ensure "value" option is set after other values (like max)
		var value = options.value;
		delete options.value;

		this._super( options );

		this.options.value = this._constrainedValue( value );
		this._refreshValue();
	},

	_setOption: function( key, value ) {
		if ( key === "max" ) {
			// Don't allow a max less than min
			value = Math.max( this.min, value );
		}
		if ( key === "disabled" ) {
			this.element
				.toggleClass( "ui-state-disabled", !!value )
				.attr( "aria-disabled", value );
		}
		this._super( key, value );
	},

	_percentage: function() {
		return this.indeterminate ? 100 : 100 * ( this.options.value - this.min ) / ( this.options.max - this.min );
	},

	_refreshValue: function() {
		var value = this.options.value,
			percentage = this._percentage();

		this.valueDiv
			.toggle( this.indeterminate || value > this.min )
			.toggleClass( "ui-corner-right", value === this.options.max )
			.width( percentage.toFixed(0) + "%" );

		this.element.toggleClass( "ui-progressbar-indeterminate", this.indeterminate );

		if ( this.indeterminate ) {
			this.element.removeAttr( "aria-valuenow" );
			if ( !this.overlayDiv ) {
				this.overlayDiv = $( "<div class='ui-progressbar-overlay'></div>" ).appendTo( this.valueDiv );
			}
		} else {
			this.element.attr({
				"aria-valuemax": this.options.max,
				"aria-valuenow": value
			});
			if ( this.overlayDiv ) {
				this.overlayDiv.remove();
				this.overlayDiv = null;
			}
		}

		if ( this.oldValue !== value ) {
			this.oldValue = value;
			this._trigger( "change" );
		}
		if ( value === this.options.max ) {
			this._trigger( "complete" );
		}
	}
});


/*!
 * jQuery UI Selectable 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/selectable/
 */


var selectable = $.widget("ui.selectable", $.ui.mouse, {
	version: "1.11.4",
	options: {
		appendTo: "body",
		autoRefresh: true,
		distance: 0,
		filter: "*",
		tolerance: "touch",

		// callbacks
		selected: null,
		selecting: null,
		start: null,
		stop: null,
		unselected: null,
		unselecting: null
	},
	_create: function() {
		var selectees,
			that = this;

		this.element.addClass("ui-selectable");

		this.dragged = false;

		// cache selectee children based on filter
		this.refresh = function() {
			selectees = $(that.options.filter, that.element[0]);
			selectees.addClass("ui-selectee");
			selectees.each(function() {
				var $this = $(this),
					pos = $this.offset();
				$.data(this, "selectable-item", {
					element: this,
					$element: $this,
					left: pos.left,
					top: pos.top,
					right: pos.left + $this.outerWidth(),
					bottom: pos.top + $this.outerHeight(),
					startselected: false,
					selected: $this.hasClass("ui-selected"),
					selecting: $this.hasClass("ui-selecting"),
					unselecting: $this.hasClass("ui-unselecting")
				});
			});
		};
		this.refresh();

		this.selectees = selectees.addClass("ui-selectee");

		this._mouseInit();

		this.helper = $("<div class='ui-selectable-helper'></div>");
	},

	_destroy: function() {
		this.selectees
			.removeClass("ui-selectee")
			.removeData("selectable-item");
		this.element
			.removeClass("ui-selectable ui-selectable-disabled");
		this._mouseDestroy();
	},

	_mouseStart: function(event) {
		var that = this,
			options = this.options;

		this.opos = [ event.pageX, event.pageY ];

		if (this.options.disabled) {
			return;
		}

		this.selectees = $(options.filter, this.element[0]);

		this._trigger("start", event);

		$(options.appendTo).append(this.helper);
		// position helper (lasso)
		this.helper.css({
			"left": event.pageX,
			"top": event.pageY,
			"width": 0,
			"height": 0
		});

		if (options.autoRefresh) {
			this.refresh();
		}

		this.selectees.filter(".ui-selected").each(function() {
			var selectee = $.data(this, "selectable-item");
			selectee.startselected = true;
			if (!event.metaKey && !event.ctrlKey) {
				selectee.$element.removeClass("ui-selected");
				selectee.selected = false;
				selectee.$element.addClass("ui-unselecting");
				selectee.unselecting = true;
				// selectable UNSELECTING callback
				that._trigger("unselecting", event, {
					unselecting: selectee.element
				});
			}
		});

		$(event.target).parents().addBack().each(function() {
			var doSelect,
				selectee = $.data(this, "selectable-item");
			if (selectee) {
				doSelect = (!event.metaKey && !event.ctrlKey) || !selectee.$element.hasClass("ui-selected");
				selectee.$element
					.removeClass(doSelect ? "ui-unselecting" : "ui-selected")
					.addClass(doSelect ? "ui-selecting" : "ui-unselecting");
				selectee.unselecting = !doSelect;
				selectee.selecting = doSelect;
				selectee.selected = doSelect;
				// selectable (UN)SELECTING callback
				if (doSelect) {
					that._trigger("selecting", event, {
						selecting: selectee.element
					});
				} else {
					that._trigger("unselecting", event, {
						unselecting: selectee.element
					});
				}
				return false;
			}
		});

	},

	_mouseDrag: function(event) {

		this.dragged = true;

		if (this.options.disabled) {
			return;
		}

		var tmp,
			that = this,
			options = this.options,
			x1 = this.opos[0],
			y1 = this.opos[1],
			x2 = event.pageX,
			y2 = event.pageY;

		if (x1 > x2) { tmp = x2; x2 = x1; x1 = tmp; }
		if (y1 > y2) { tmp = y2; y2 = y1; y1 = tmp; }
		this.helper.css({ left: x1, top: y1, width: x2 - x1, height: y2 - y1 });

		this.selectees.each(function() {
			var selectee = $.data(this, "selectable-item"),
				hit = false;

			//prevent helper from being selected if appendTo: selectable
			if (!selectee || selectee.element === that.element[0]) {
				return;
			}

			if (options.tolerance === "touch") {
				hit = ( !(selectee.left > x2 || selectee.right < x1 || selectee.top > y2 || selectee.bottom < y1) );
			} else if (options.tolerance === "fit") {
				hit = (selectee.left > x1 && selectee.right < x2 && selectee.top > y1 && selectee.bottom < y2);
			}

			if (hit) {
				// SELECT
				if (selectee.selected) {
					selectee.$element.removeClass("ui-selected");
					selectee.selected = false;
				}
				if (selectee.unselecting) {
					selectee.$element.removeClass("ui-unselecting");
					selectee.unselecting = false;
				}
				if (!selectee.selecting) {
					selectee.$element.addClass("ui-selecting");
					selectee.selecting = true;
					// selectable SELECTING callback
					that._trigger("selecting", event, {
						selecting: selectee.element
					});
				}
			} else {
				// UNSELECT
				if (selectee.selecting) {
					if ((event.metaKey || event.ctrlKey) && selectee.startselected) {
						selectee.$element.removeClass("ui-selecting");
						selectee.selecting = false;
						selectee.$element.addClass("ui-selected");
						selectee.selected = true;
					} else {
						selectee.$element.removeClass("ui-selecting");
						selectee.selecting = false;
						if (selectee.startselected) {
							selectee.$element.addClass("ui-unselecting");
							selectee.unselecting = true;
						}
						// selectable UNSELECTING callback
						that._trigger("unselecting", event, {
							unselecting: selectee.element
						});
					}
				}
				if (selectee.selected) {
					if (!event.metaKey && !event.ctrlKey && !selectee.startselected) {
						selectee.$element.removeClass("ui-selected");
						selectee.selected = false;

						selectee.$element.addClass("ui-unselecting");
						selectee.unselecting = true;
						// selectable UNSELECTING callback
						that._trigger("unselecting", event, {
							unselecting: selectee.element
						});
					}
				}
			}
		});

		return false;
	},

	_mouseStop: function(event) {
		var that = this;

		this.dragged = false;

		$(".ui-unselecting", this.element[0]).each(function() {
			var selectee = $.data(this, "selectable-item");
			selectee.$element.removeClass("ui-unselecting");
			selectee.unselecting = false;
			selectee.startselected = false;
			that._trigger("unselected", event, {
				unselected: selectee.element
			});
		});
		$(".ui-selecting", this.element[0]).each(function() {
			var selectee = $.data(this, "selectable-item");
			selectee.$element.removeClass("ui-selecting").addClass("ui-selected");
			selectee.selecting = false;
			selectee.selected = true;
			selectee.startselected = true;
			that._trigger("selected", event, {
				selected: selectee.element
			});
		});
		this._trigger("stop", event);

		this.helper.remove();

		return false;
	}

});


/*!
 * jQuery UI Selectmenu 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/selectmenu
 */


var selectmenu = $.widget( "ui.selectmenu", {
	version: "1.11.4",
	defaultElement: "<select>",
	options: {
		appendTo: null,
		disabled: null,
		icons: {
			button: "ui-icon-triangle-1-s"
		},
		position: {
			my: "left top",
			at: "left bottom",
			collision: "none"
		},
		width: null,

		// callbacks
		change: null,
		close: null,
		focus: null,
		open: null,
		select: null
	},

	_create: function() {
		var selectmenuId = this.element.uniqueId().attr( "id" );
		this.ids = {
			element: selectmenuId,
			button: selectmenuId + "-button",
			menu: selectmenuId + "-menu"
		};

		this._drawButton();
		this._drawMenu();

		if ( this.options.disabled ) {
			this.disable();
		}
	},

	_drawButton: function() {
		var that = this;

		// Associate existing label with the new button
		this.label = $( "label[for='" + this.ids.element + "']" ).attr( "for", this.ids.button );
		this._on( this.label, {
			click: function( event ) {
				this.button.focus();
				event.preventDefault();
			}
		});

		// Hide original select element
		this.element.hide();

		// Create button
		this.button = $( "<span>", {
			"class": "ui-selectmenu-button ui-widget ui-state-default ui-corner-all",
			tabindex: this.options.disabled ? -1 : 0,
			id: this.ids.button,
			role: "combobox",
			"aria-expanded": "false",
			"aria-autocomplete": "list",
			"aria-owns": this.ids.menu,
			"aria-haspopup": "true"
		})
			.insertAfter( this.element );

		$( "<span>", {
			"class": "ui-icon " + this.options.icons.button
		})
			.prependTo( this.button );

		this.buttonText = $( "<span>", {
			"class": "ui-selectmenu-text"
		})
			.appendTo( this.button );

		this._setText( this.buttonText, this.element.find( "option:selected" ).text() );
		this._resizeButton();

		this._on( this.button, this._buttonEvents );
		this.button.one( "focusin", function() {

			// Delay rendering the menu items until the button receives focus.
			// The menu may have already been rendered via a programmatic open.
			if ( !that.menuItems ) {
				that._refreshMenu();
			}
		});
		this._hoverable( this.button );
		this._focusable( this.button );
	},

	_drawMenu: function() {
		var that = this;

		// Create menu
		this.menu = $( "<ul>", {
			"aria-hidden": "true",
			"aria-labelledby": this.ids.button,
			id: this.ids.menu
		});

		// Wrap menu
		this.menuWrap = $( "<div>", {
			"class": "ui-selectmenu-menu ui-front"
		})
			.append( this.menu )
			.appendTo( this._appendTo() );

		// Initialize menu widget
		this.menuInstance = this.menu
			.menu({
				role: "listbox",
				select: function( event, ui ) {
					event.preventDefault();

					// support: IE8
					// If the item was selected via a click, the text selection
					// will be destroyed in IE
					that._setSelection();

					that._select( ui.item.data( "ui-selectmenu-item" ), event );
				},
				focus: function( event, ui ) {
					var item = ui.item.data( "ui-selectmenu-item" );

					// Prevent inital focus from firing and check if its a newly focused item
					if ( that.focusIndex != null && item.index !== that.focusIndex ) {
						that._trigger( "focus", event, { item: item } );
						if ( !that.isOpen ) {
							that._select( item, event );
						}
					}
					that.focusIndex = item.index;

					that.button.attr( "aria-activedescendant",
						that.menuItems.eq( item.index ).attr( "id" ) );
				}
			})
			.menu( "instance" );

		// Adjust menu styles to dropdown
		this.menu
			.addClass( "ui-corner-bottom" )
			.removeClass( "ui-corner-all" );

		// Don't close the menu on mouseleave
		this.menuInstance._off( this.menu, "mouseleave" );

		// Cancel the menu's collapseAll on document click
		this.menuInstance._closeOnDocumentClick = function() {
			return false;
		};

		// Selects often contain empty items, but never contain dividers
		this.menuInstance._isDivider = function() {
			return false;
		};
	},

	refresh: function() {
		this._refreshMenu();
		this._setText( this.buttonText, this._getSelectedItem().text() );
		if ( !this.options.width ) {
			this._resizeButton();
		}
	},

	_refreshMenu: function() {
		this.menu.empty();

		var item,
			options = this.element.find( "option" );

		if ( !options.length ) {
			return;
		}

		this._parseOptions( options );
		this._renderMenu( this.menu, this.items );

		this.menuInstance.refresh();
		this.menuItems = this.menu.find( "li" ).not( ".ui-selectmenu-optgroup" );

		item = this._getSelectedItem();

		// Update the menu to have the correct item focused
		this.menuInstance.focus( null, item );
		this._setAria( item.data( "ui-selectmenu-item" ) );

		// Set disabled state
		this._setOption( "disabled", this.element.prop( "disabled" ) );
	},

	open: function( event ) {
		if ( this.options.disabled ) {
			return;
		}

		// If this is the first time the menu is being opened, render the items
		if ( !this.menuItems ) {
			this._refreshMenu();
		} else {

			// Menu clears focus on close, reset focus to selected item
			this.menu.find( ".ui-state-focus" ).removeClass( "ui-state-focus" );
			this.menuInstance.focus( null, this._getSelectedItem() );
		}

		this.isOpen = true;
		this._toggleAttr();
		this._resizeMenu();
		this._position();

		this._on( this.document, this._documentClick );

		this._trigger( "open", event );
	},

	_position: function() {
		this.menuWrap.position( $.extend( { of: this.button }, this.options.position ) );
	},

	close: function( event ) {
		if ( !this.isOpen ) {
			return;
		}

		this.isOpen = false;
		this._toggleAttr();

		this.range = null;
		this._off( this.document );

		this._trigger( "close", event );
	},

	widget: function() {
		return this.button;
	},

	menuWidget: function() {
		return this.menu;
	},

	_renderMenu: function( ul, items ) {
		var that = this,
			currentOptgroup = "";

		$.each( items, function( index, item ) {
			if ( item.optgroup !== currentOptgroup ) {
				$( "<li>", {
					"class": "ui-selectmenu-optgroup ui-menu-divider" +
						( item.element.parent( "optgroup" ).prop( "disabled" ) ?
							" ui-state-disabled" :
							"" ),
					text: item.optgroup
				})
					.appendTo( ul );

				currentOptgroup = item.optgroup;
			}

			that._renderItemData( ul, item );
		});
	},

	_renderItemData: function( ul, item ) {
		return this._renderItem( ul, item ).data( "ui-selectmenu-item", item );
	},

	_renderItem: function( ul, item ) {
		var li = $( "<li>" );

		if ( item.disabled ) {
			li.addClass( "ui-state-disabled" );
		}
		this._setText( li, item.label );

		return li.appendTo( ul );
	},

	_setText: function( element, value ) {
		if ( value ) {
			element.text( value );
		} else {
			element.html( "&#160;" );
		}
	},

	_move: function( direction, event ) {
		var item, next,
			filter = ".ui-menu-item";

		if ( this.isOpen ) {
			item = this.menuItems.eq( this.focusIndex );
		} else {
			item = this.menuItems.eq( this.element[ 0 ].selectedIndex );
			filter += ":not(.ui-state-disabled)";
		}

		if ( direction === "first" || direction === "last" ) {
			next = item[ direction === "first" ? "prevAll" : "nextAll" ]( filter ).eq( -1 );
		} else {
			next = item[ direction + "All" ]( filter ).eq( 0 );
		}

		if ( next.length ) {
			this.menuInstance.focus( event, next );
		}
	},

	_getSelectedItem: function() {
		return this.menuItems.eq( this.element[ 0 ].selectedIndex );
	},

	_toggle: function( event ) {
		this[ this.isOpen ? "close" : "open" ]( event );
	},

	_setSelection: function() {
		var selection;

		if ( !this.range ) {
			return;
		}

		if ( window.getSelection ) {
			selection = window.getSelection();
			selection.removeAllRanges();
			selection.addRange( this.range );

		// support: IE8
		} else {
			this.range.select();
		}

		// support: IE
		// Setting the text selection kills the button focus in IE, but
		// restoring the focus doesn't kill the selection.
		this.button.focus();
	},

	_documentClick: {
		mousedown: function( event ) {
			if ( !this.isOpen ) {
				return;
			}

			if ( !$( event.target ).closest( ".ui-selectmenu-menu, #" + this.ids.button ).length ) {
				this.close( event );
			}
		}
	},

	_buttonEvents: {

		// Prevent text selection from being reset when interacting with the selectmenu (#10144)
		mousedown: function() {
			var selection;

			if ( window.getSelection ) {
				selection = window.getSelection();
				if ( selection.rangeCount ) {
					this.range = selection.getRangeAt( 0 );
				}

			// support: IE8
			} else {
				this.range = document.selection.createRange();
			}
		},

		click: function( event ) {
			this._setSelection();
			this._toggle( event );
		},

		keydown: function( event ) {
			var preventDefault = true;
			switch ( event.keyCode ) {
				case $.ui.keyCode.TAB:
				case $.ui.keyCode.ESCAPE:
					this.close( event );
					preventDefault = false;
					break;
				case $.ui.keyCode.ENTER:
					if ( this.isOpen ) {
						this._selectFocusedItem( event );
					}
					break;
				case $.ui.keyCode.UP:
					if ( event.altKey ) {
						this._toggle( event );
					} else {
						this._move( "prev", event );
					}
					break;
				case $.ui.keyCode.DOWN:
					if ( event.altKey ) {
						this._toggle( event );
					} else {
						this._move( "next", event );
					}
					break;
				case $.ui.keyCode.SPACE:
					if ( this.isOpen ) {
						this._selectFocusedItem( event );
					} else {
						this._toggle( event );
					}
					break;
				case $.ui.keyCode.LEFT:
					this._move( "prev", event );
					break;
				case $.ui.keyCode.RIGHT:
					this._move( "next", event );
					break;
				case $.ui.keyCode.HOME:
				case $.ui.keyCode.PAGE_UP:
					this._move( "first", event );
					break;
				case $.ui.keyCode.END:
				case $.ui.keyCode.PAGE_DOWN:
					this._move( "last", event );
					break;
				default:
					this.menu.trigger( event );
					preventDefault = false;
			}

			if ( preventDefault ) {
				event.preventDefault();
			}
		}
	},

	_selectFocusedItem: function( event ) {
		var item = this.menuItems.eq( this.focusIndex );
		if ( !item.hasClass( "ui-state-disabled" ) ) {
			this._select( item.data( "ui-selectmenu-item" ), event );
		}
	},

	_select: function( item, event ) {
		var oldIndex = this.element[ 0 ].selectedIndex;

		// Change native select element
		this.element[ 0 ].selectedIndex = item.index;
		this._setText( this.buttonText, item.label );
		this._setAria( item );
		this._trigger( "select", event, { item: item } );

		if ( item.index !== oldIndex ) {
			this._trigger( "change", event, { item: item } );
		}

		this.close( event );
	},

	_setAria: function( item ) {
		var id = this.menuItems.eq( item.index ).attr( "id" );

		this.button.attr({
			"aria-labelledby": id,
			"aria-activedescendant": id
		});
		this.menu.attr( "aria-activedescendant", id );
	},

	_setOption: function( key, value ) {
		if ( key === "icons" ) {
			this.button.find( "span.ui-icon" )
				.removeClass( this.options.icons.button )
				.addClass( value.button );
		}

		this._super( key, value );

		if ( key === "appendTo" ) {
			this.menuWrap.appendTo( this._appendTo() );
		}

		if ( key === "disabled" ) {
			this.menuInstance.option( "disabled", value );
			this.button
				.toggleClass( "ui-state-disabled", value )
				.attr( "aria-disabled", value );

			this.element.prop( "disabled", value );
			if ( value ) {
				this.button.attr( "tabindex", -1 );
				this.close();
			} else {
				this.button.attr( "tabindex", 0 );
			}
		}

		if ( key === "width" ) {
			this._resizeButton();
		}
	},

	_appendTo: function() {
		var element = this.options.appendTo;

		if ( element ) {
			element = element.jquery || element.nodeType ?
				$( element ) :
				this.document.find( element ).eq( 0 );
		}

		if ( !element || !element[ 0 ] ) {
			element = this.element.closest( ".ui-front" );
		}

		if ( !element.length ) {
			element = this.document[ 0 ].body;
		}

		return element;
	},

	_toggleAttr: function() {
		this.button
			.toggleClass( "ui-corner-top", this.isOpen )
			.toggleClass( "ui-corner-all", !this.isOpen )
			.attr( "aria-expanded", this.isOpen );
		this.menuWrap.toggleClass( "ui-selectmenu-open", this.isOpen );
		this.menu.attr( "aria-hidden", !this.isOpen );
	},

	_resizeButton: function() {
		var width = this.options.width;

		if ( !width ) {
			width = this.element.show().outerWidth();
			this.element.hide();
		}

		this.button.outerWidth( width );
	},

	_resizeMenu: function() {
		this.menu.outerWidth( Math.max(
			this.button.outerWidth(),

			// support: IE10
			// IE10 wraps long text (possibly a rounding bug)
			// so we add 1px to avoid the wrapping
			this.menu.width( "" ).outerWidth() + 1
		) );
	},

	_getCreateOptions: function() {
		return { disabled: this.element.prop( "disabled" ) };
	},

	_parseOptions: function( options ) {
		var data = [];
		options.each(function( index, item ) {
			var option = $( item ),
				optgroup = option.parent( "optgroup" );
			data.push({
				element: option,
				index: index,
				value: option.val(),
				label: option.text(),
				optgroup: optgroup.attr( "label" ) || "",
				disabled: optgroup.prop( "disabled" ) || option.prop( "disabled" )
			});
		});
		this.items = data;
	},

	_destroy: function() {
		this.menuWrap.remove();
		this.button.remove();
		this.element.show();
		this.element.removeUniqueId();
		this.label.attr( "for", this.ids.element );
	}
});


/*!
 * jQuery UI Slider 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/slider/
 */


var slider = $.widget( "ui.slider", $.ui.mouse, {
	version: "1.11.4",
	widgetEventPrefix: "slide",

	options: {
		animate: false,
		distance: 0,
		max: 100,
		min: 0,
		orientation: "horizontal",
		range: false,
		step: 1,
		value: 0,
		values: null,

		// callbacks
		change: null,
		slide: null,
		start: null,
		stop: null
	},

	// number of pages in a slider
	// (how many times can you page up/down to go through the whole range)
	numPages: 5,

	_create: function() {
		this._keySliding = false;
		this._mouseSliding = false;
		this._animateOff = true;
		this._handleIndex = null;
		this._detectOrientation();
		this._mouseInit();
		this._calculateNewMax();

		this.element
			.addClass( "ui-slider" +
				" ui-slider-" + this.orientation +
				" ui-widget" +
				" ui-widget-content" +
				" ui-corner-all");

		this._refresh();
		this._setOption( "disabled", this.options.disabled );

		this._animateOff = false;
	},

	_refresh: function() {
		this._createRange();
		this._createHandles();
		this._setupEvents();
		this._refreshValue();
	},

	_createHandles: function() {
		var i, handleCount,
			options = this.options,
			existingHandles = this.element.find( ".ui-slider-handle" ).addClass( "ui-state-default ui-corner-all" ),
			handle = "<span class='ui-slider-handle ui-state-default ui-corner-all' tabindex='0'></span>",
			handles = [];

		handleCount = ( options.values && options.values.length ) || 1;

		if ( existingHandles.length > handleCount ) {
			existingHandles.slice( handleCount ).remove();
			existingHandles = existingHandles.slice( 0, handleCount );
		}

		for ( i = existingHandles.length; i < handleCount; i++ ) {
			handles.push( handle );
		}

		this.handles = existingHandles.add( $( handles.join( "" ) ).appendTo( this.element ) );

		this.handle = this.handles.eq( 0 );

		this.handles.each(function( i ) {
			$( this ).data( "ui-slider-handle-index", i );
		});
	},

	_createRange: function() {
		var options = this.options,
			classes = "";

		if ( options.range ) {
			if ( options.range === true ) {
				if ( !options.values ) {
					options.values = [ this._valueMin(), this._valueMin() ];
				} else if ( options.values.length && options.values.length !== 2 ) {
					options.values = [ options.values[0], options.values[0] ];
				} else if ( $.isArray( options.values ) ) {
					options.values = options.values.slice(0);
				}
			}

			if ( !this.range || !this.range.length ) {
				this.range = $( "<div></div>" )
					.appendTo( this.element );

				classes = "ui-slider-range" +
				// note: this isn't the most fittingly semantic framework class for this element,
				// but worked best visually with a variety of themes
				" ui-widget-header ui-corner-all";
			} else {
				this.range.removeClass( "ui-slider-range-min ui-slider-range-max" )
					// Handle range switching from true to min/max
					.css({
						"left": "",
						"bottom": ""
					});
			}

			this.range.addClass( classes +
				( ( options.range === "min" || options.range === "max" ) ? " ui-slider-range-" + options.range : "" ) );
		} else {
			if ( this.range ) {
				this.range.remove();
			}
			this.range = null;
		}
	},

	_setupEvents: function() {
		this._off( this.handles );
		this._on( this.handles, this._handleEvents );
		this._hoverable( this.handles );
		this._focusable( this.handles );
	},

	_destroy: function() {
		this.handles.remove();
		if ( this.range ) {
			this.range.remove();
		}

		this.element
			.removeClass( "ui-slider" +
				" ui-slider-horizontal" +
				" ui-slider-vertical" +
				" ui-widget" +
				" ui-widget-content" +
				" ui-corner-all" );

		this._mouseDestroy();
	},

	_mouseCapture: function( event ) {
		var position, normValue, distance, closestHandle, index, allowed, offset, mouseOverHandle,
			that = this,
			o = this.options;

		if ( o.disabled ) {
			return false;
		}

		this.elementSize = {
			width: this.element.outerWidth(),
			height: this.element.outerHeight()
		};
		this.elementOffset = this.element.offset();

		position = { x: event.pageX, y: event.pageY };
		normValue = this._normValueFromMouse( position );
		distance = this._valueMax() - this._valueMin() + 1;
		this.handles.each(function( i ) {
			var thisDistance = Math.abs( normValue - that.values(i) );
			if (( distance > thisDistance ) ||
				( distance === thisDistance &&
					(i === that._lastChangedValue || that.values(i) === o.min ))) {
				distance = thisDistance;
				closestHandle = $( this );
				index = i;
			}
		});

		allowed = this._start( event, index );
		if ( allowed === false ) {
			return false;
		}
		this._mouseSliding = true;

		this._handleIndex = index;

		closestHandle
			.addClass( "ui-state-active" )
			.focus();

		offset = closestHandle.offset();
		mouseOverHandle = !$( event.target ).parents().addBack().is( ".ui-slider-handle" );
		this._clickOffset = mouseOverHandle ? { left: 0, top: 0 } : {
			left: event.pageX - offset.left - ( closestHandle.width() / 2 ),
			top: event.pageY - offset.top -
				( closestHandle.height() / 2 ) -
				( parseInt( closestHandle.css("borderTopWidth"), 10 ) || 0 ) -
				( parseInt( closestHandle.css("borderBottomWidth"), 10 ) || 0) +
				( parseInt( closestHandle.css("marginTop"), 10 ) || 0)
		};

		if ( !this.handles.hasClass( "ui-state-hover" ) ) {
			this._slide( event, index, normValue );
		}
		this._animateOff = true;
		return true;
	},

	_mouseStart: function() {
		return true;
	},

	_mouseDrag: function( event ) {
		var position = { x: event.pageX, y: event.pageY },
			normValue = this._normValueFromMouse( position );

		this._slide( event, this._handleIndex, normValue );

		return false;
	},

	_mouseStop: function( event ) {
		this.handles.removeClass( "ui-state-active" );
		this._mouseSliding = false;

		this._stop( event, this._handleIndex );
		this._change( event, this._handleIndex );

		this._handleIndex = null;
		this._clickOffset = null;
		this._animateOff = false;

		return false;
	},

	_detectOrientation: function() {
		this.orientation = ( this.options.orientation === "vertical" ) ? "vertical" : "horizontal";
	},

	_normValueFromMouse: function( position ) {
		var pixelTotal,
			pixelMouse,
			percentMouse,
			valueTotal,
			valueMouse;

		if ( this.orientation === "horizontal" ) {
			pixelTotal = this.elementSize.width;
			pixelMouse = position.x - this.elementOffset.left - ( this._clickOffset ? this._clickOffset.left : 0 );
		} else {
			pixelTotal = this.elementSize.height;
			pixelMouse = position.y - this.elementOffset.top - ( this._clickOffset ? this._clickOffset.top : 0 );
		}

		percentMouse = ( pixelMouse / pixelTotal );
		if ( percentMouse > 1 ) {
			percentMouse = 1;
		}
		if ( percentMouse < 0 ) {
			percentMouse = 0;
		}
		if ( this.orientation === "vertical" ) {
			percentMouse = 1 - percentMouse;
		}

		valueTotal = this._valueMax() - this._valueMin();
		valueMouse = this._valueMin() + percentMouse * valueTotal;

		return this._trimAlignValue( valueMouse );
	},

	_start: function( event, index ) {
		var uiHash = {
			handle: this.handles[ index ],
			value: this.value()
		};
		if ( this.options.values && this.options.values.length ) {
			uiHash.value = this.values( index );
			uiHash.values = this.values();
		}
		return this._trigger( "start", event, uiHash );
	},

	_slide: function( event, index, newVal ) {
		var otherVal,
			newValues,
			allowed;

		if ( this.options.values && this.options.values.length ) {
			otherVal = this.values( index ? 0 : 1 );

			if ( ( this.options.values.length === 2 && this.options.range === true ) &&
					( ( index === 0 && newVal > otherVal) || ( index === 1 && newVal < otherVal ) )
				) {
				newVal = otherVal;
			}

			if ( newVal !== this.values( index ) ) {
				newValues = this.values();
				newValues[ index ] = newVal;
				// A slide can be canceled by returning false from the slide callback
				allowed = this._trigger( "slide", event, {
					handle: this.handles[ index ],
					value: newVal,
					values: newValues
				} );
				otherVal = this.values( index ? 0 : 1 );
				if ( allowed !== false ) {
					this.values( index, newVal );
				}
			}
		} else {
			if ( newVal !== this.value() ) {
				// A slide can be canceled by returning false from the slide callback
				allowed = this._trigger( "slide", event, {
					handle: this.handles[ index ],
					value: newVal
				} );
				if ( allowed !== false ) {
					this.value( newVal );
				}
			}
		}
	},

	_stop: function( event, index ) {
		var uiHash = {
			handle: this.handles[ index ],
			value: this.value()
		};
		if ( this.options.values && this.options.values.length ) {
			uiHash.value = this.values( index );
			uiHash.values = this.values();
		}

		this._trigger( "stop", event, uiHash );
	},

	_change: function( event, index ) {
		if ( !this._keySliding && !this._mouseSliding ) {
			var uiHash = {
				handle: this.handles[ index ],
				value: this.value()
			};
			if ( this.options.values && this.options.values.length ) {
				uiHash.value = this.values( index );
				uiHash.values = this.values();
			}

			//store the last changed value index for reference when handles overlap
			this._lastChangedValue = index;

			this._trigger( "change", event, uiHash );
		}
	},

	value: function( newValue ) {
		if ( arguments.length ) {
			this.options.value = this._trimAlignValue( newValue );
			this._refreshValue();
			this._change( null, 0 );
			return;
		}

		return this._value();
	},

	values: function( index, newValue ) {
		var vals,
			newValues,
			i;

		if ( arguments.length > 1 ) {
			this.options.values[ index ] = this._trimAlignValue( newValue );
			this._refreshValue();
			this._change( null, index );
			return;
		}

		if ( arguments.length ) {
			if ( $.isArray( arguments[ 0 ] ) ) {
				vals = this.options.values;
				newValues = arguments[ 0 ];
				for ( i = 0; i < vals.length; i += 1 ) {
					vals[ i ] = this._trimAlignValue( newValues[ i ] );
					this._change( null, i );
				}
				this._refreshValue();
			} else {
				if ( this.options.values && this.options.values.length ) {
					return this._values( index );
				} else {
					return this.value();
				}
			}
		} else {
			return this._values();
		}
	},

	_setOption: function( key, value ) {
		var i,
			valsLength = 0;

		if ( key === "range" && this.options.range === true ) {
			if ( value === "min" ) {
				this.options.value = this._values( 0 );
				this.options.values = null;
			} else if ( value === "max" ) {
				this.options.value = this._values( this.options.values.length - 1 );
				this.options.values = null;
			}
		}

		if ( $.isArray( this.options.values ) ) {
			valsLength = this.options.values.length;
		}

		if ( key === "disabled" ) {
			this.element.toggleClass( "ui-state-disabled", !!value );
		}

		this._super( key, value );

		switch ( key ) {
			case "orientation":
				this._detectOrientation();
				this.element
					.removeClass( "ui-slider-horizontal ui-slider-vertical" )
					.addClass( "ui-slider-" + this.orientation );
				this._refreshValue();

				// Reset positioning from previous orientation
				this.handles.css( value === "horizontal" ? "bottom" : "left", "" );
				break;
			case "value":
				this._animateOff = true;
				this._refreshValue();
				this._change( null, 0 );
				this._animateOff = false;
				break;
			case "values":
				this._animateOff = true;
				this._refreshValue();
				for ( i = 0; i < valsLength; i += 1 ) {
					this._change( null, i );
				}
				this._animateOff = false;
				break;
			case "step":
			case "min":
			case "max":
				this._animateOff = true;
				this._calculateNewMax();
				this._refreshValue();
				this._animateOff = false;
				break;
			case "range":
				this._animateOff = true;
				this._refresh();
				this._animateOff = false;
				break;
		}
	},

	//internal value getter
	// _value() returns value trimmed by min and max, aligned by step
	_value: function() {
		var val = this.options.value;
		val = this._trimAlignValue( val );

		return val;
	},

	//internal values getter
	// _values() returns array of values trimmed by min and max, aligned by step
	// _values( index ) returns single value trimmed by min and max, aligned by step
	_values: function( index ) {
		var val,
			vals,
			i;

		if ( arguments.length ) {
			val = this.options.values[ index ];
			val = this._trimAlignValue( val );

			return val;
		} else if ( this.options.values && this.options.values.length ) {
			// .slice() creates a copy of the array
			// this copy gets trimmed by min and max and then returned
			vals = this.options.values.slice();
			for ( i = 0; i < vals.length; i += 1) {
				vals[ i ] = this._trimAlignValue( vals[ i ] );
			}

			return vals;
		} else {
			return [];
		}
	},

	// returns the step-aligned value that val is closest to, between (inclusive) min and max
	_trimAlignValue: function( val ) {
		if ( val <= this._valueMin() ) {
			return this._valueMin();
		}
		if ( val >= this._valueMax() ) {
			return this._valueMax();
		}
		var step = ( this.options.step > 0 ) ? this.options.step : 1,
			valModStep = (val - this._valueMin()) % step,
			alignValue = val - valModStep;

		if ( Math.abs(valModStep) * 2 >= step ) {
			alignValue += ( valModStep > 0 ) ? step : ( -step );
		}

		// Since JavaScript has problems with large floats, round
		// the final value to 5 digits after the decimal point (see #4124)
		return parseFloat( alignValue.toFixed(5) );
	},

	_calculateNewMax: function() {
		var max = this.options.max,
			min = this._valueMin(),
			step = this.options.step,
			aboveMin = Math.floor( ( +( max - min ).toFixed( this._precision() ) ) / step ) * step;
		max = aboveMin + min;
		this.max = parseFloat( max.toFixed( this._precision() ) );
	},

	_precision: function() {
		var precision = this._precisionOf( this.options.step );
		if ( this.options.min !== null ) {
			precision = Math.max( precision, this._precisionOf( this.options.min ) );
		}
		return precision;
	},

	_precisionOf: function( num ) {
		var str = num.toString(),
			decimal = str.indexOf( "." );
		return decimal === -1 ? 0 : str.length - decimal - 1;
	},

	_valueMin: function() {
		return this.options.min;
	},

	_valueMax: function() {
		return this.max;
	},

	_refreshValue: function() {
		var lastValPercent, valPercent, value, valueMin, valueMax,
			oRange = this.options.range,
			o = this.options,
			that = this,
			animate = ( !this._animateOff ) ? o.animate : false,
			_set = {};

		if ( this.options.values && this.options.values.length ) {
			this.handles.each(function( i ) {
				valPercent = ( that.values(i) - that._valueMin() ) / ( that._valueMax() - that._valueMin() ) * 100;
				_set[ that.orientation === "horizontal" ? "left" : "bottom" ] = valPercent + "%";
				$( this ).stop( 1, 1 )[ animate ? "animate" : "css" ]( _set, o.animate );
				if ( that.options.range === true ) {
					if ( that.orientation === "horizontal" ) {
						if ( i === 0 ) {
							that.range.stop( 1, 1 )[ animate ? "animate" : "css" ]( { left: valPercent + "%" }, o.animate );
						}
						if ( i === 1 ) {
							that.range[ animate ? "animate" : "css" ]( { width: ( valPercent - lastValPercent ) + "%" }, { queue: false, duration: o.animate } );
						}
					} else {
						if ( i === 0 ) {
							that.range.stop( 1, 1 )[ animate ? "animate" : "css" ]( { bottom: ( valPercent ) + "%" }, o.animate );
						}
						if ( i === 1 ) {
							that.range[ animate ? "animate" : "css" ]( { height: ( valPercent - lastValPercent ) + "%" }, { queue: false, duration: o.animate } );
						}
					}
				}
				lastValPercent = valPercent;
			});
		} else {
			value = this.value();
			valueMin = this._valueMin();
			valueMax = this._valueMax();
			valPercent = ( valueMax !== valueMin ) ?
					( value - valueMin ) / ( valueMax - valueMin ) * 100 :
					0;
			_set[ this.orientation === "horizontal" ? "left" : "bottom" ] = valPercent + "%";
			this.handle.stop( 1, 1 )[ animate ? "animate" : "css" ]( _set, o.animate );

			if ( oRange === "min" && this.orientation === "horizontal" ) {
				this.range.stop( 1, 1 )[ animate ? "animate" : "css" ]( { width: valPercent + "%" }, o.animate );
			}
			if ( oRange === "max" && this.orientation === "horizontal" ) {
				this.range[ animate ? "animate" : "css" ]( { width: ( 100 - valPercent ) + "%" }, { queue: false, duration: o.animate } );
			}
			if ( oRange === "min" && this.orientation === "vertical" ) {
				this.range.stop( 1, 1 )[ animate ? "animate" : "css" ]( { height: valPercent + "%" }, o.animate );
			}
			if ( oRange === "max" && this.orientation === "vertical" ) {
				this.range[ animate ? "animate" : "css" ]( { height: ( 100 - valPercent ) + "%" }, { queue: false, duration: o.animate } );
			}
		}
	},

	_handleEvents: {
		keydown: function( event ) {
			var allowed, curVal, newVal, step,
				index = $( event.target ).data( "ui-slider-handle-index" );

			switch ( event.keyCode ) {
				case $.ui.keyCode.HOME:
				case $.ui.keyCode.END:
				case $.ui.keyCode.PAGE_UP:
				case $.ui.keyCode.PAGE_DOWN:
				case $.ui.keyCode.UP:
				case $.ui.keyCode.RIGHT:
				case $.ui.keyCode.DOWN:
				case $.ui.keyCode.LEFT:
					event.preventDefault();
					if ( !this._keySliding ) {
						this._keySliding = true;
						$( event.target ).addClass( "ui-state-active" );
						allowed = this._start( event, index );
						if ( allowed === false ) {
							return;
						}
					}
					break;
			}

			step = this.options.step;
			if ( this.options.values && this.options.values.length ) {
				curVal = newVal = this.values( index );
			} else {
				curVal = newVal = this.value();
			}

			switch ( event.keyCode ) {
				case $.ui.keyCode.HOME:
					newVal = this._valueMin();
					break;
				case $.ui.keyCode.END:
					newVal = this._valueMax();
					break;
				case $.ui.keyCode.PAGE_UP:
					newVal = this._trimAlignValue(
						curVal + ( ( this._valueMax() - this._valueMin() ) / this.numPages )
					);
					break;
				case $.ui.keyCode.PAGE_DOWN:
					newVal = this._trimAlignValue(
						curVal - ( (this._valueMax() - this._valueMin()) / this.numPages ) );
					break;
				case $.ui.keyCode.UP:
				case $.ui.keyCode.RIGHT:
					if ( curVal === this._valueMax() ) {
						return;
					}
					newVal = this._trimAlignValue( curVal + step );
					break;
				case $.ui.keyCode.DOWN:
				case $.ui.keyCode.LEFT:
					if ( curVal === this._valueMin() ) {
						return;
					}
					newVal = this._trimAlignValue( curVal - step );
					break;
			}

			this._slide( event, index, newVal );
		},
		keyup: function( event ) {
			var index = $( event.target ).data( "ui-slider-handle-index" );

			if ( this._keySliding ) {
				this._keySliding = false;
				this._stop( event, index );
				this._change( event, index );
				$( event.target ).removeClass( "ui-state-active" );
			}
		}
	}
});


/*!
 * jQuery UI Sortable 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/sortable/
 */


var sortable = $.widget("ui.sortable", $.ui.mouse, {
	version: "1.11.4",
	widgetEventPrefix: "sort",
	ready: false,
	options: {
		appendTo: "parent",
		axis: false,
		connectWith: false,
		containment: false,
		cursor: "auto",
		cursorAt: false,
		dropOnEmpty: true,
		forcePlaceholderSize: false,
		forceHelperSize: false,
		grid: false,
		handle: false,
		helper: "original",
		items: "> *",
		opacity: false,
		placeholder: false,
		revert: false,
		scroll: true,
		scrollSensitivity: 20,
		scrollSpeed: 20,
		scope: "default",
		tolerance: "intersect",
		zIndex: 1000,

		// callbacks
		activate: null,
		beforeStop: null,
		change: null,
		deactivate: null,
		out: null,
		over: null,
		receive: null,
		remove: null,
		sort: null,
		start: null,
		stop: null,
		update: null
	},

	_isOverAxis: function( x, reference, size ) {
		return ( x >= reference ) && ( x < ( reference + size ) );
	},

	_isFloating: function( item ) {
		return (/left|right/).test(item.css("float")) || (/inline|table-cell/).test(item.css("display"));
	},

	_create: function() {
		this.containerCache = {};
		this.element.addClass("ui-sortable");

		//Get the items
		this.refresh();

		//Let's determine the parent's offset
		this.offset = this.element.offset();

		//Initialize mouse events for interaction
		this._mouseInit();

		this._setHandleClassName();

		//We're ready to go
		this.ready = true;

	},

	_setOption: function( key, value ) {
		this._super( key, value );

		if ( key === "handle" ) {
			this._setHandleClassName();
		}
	},

	_setHandleClassName: function() {
		this.element.find( ".ui-sortable-handle" ).removeClass( "ui-sortable-handle" );
		$.each( this.items, function() {
			( this.instance.options.handle ?
				this.item.find( this.instance.options.handle ) : this.item )
				.addClass( "ui-sortable-handle" );
		});
	},

	_destroy: function() {
		this.element
			.removeClass( "ui-sortable ui-sortable-disabled" )
			.find( ".ui-sortable-handle" )
				.removeClass( "ui-sortable-handle" );
		this._mouseDestroy();

		for ( var i = this.items.length - 1; i >= 0; i-- ) {
			this.items[i].item.removeData(this.widgetName + "-item");
		}

		return this;
	},

	_mouseCapture: function(event, overrideHandle) {
		var currentItem = null,
			validHandle = false,
			that = this;

		if (this.reverting) {
			return false;
		}

		if(this.options.disabled || this.options.type === "static") {
			return false;
		}

		//We have to refresh the items data once first
		this._refreshItems(event);

		//Find out if the clicked node (or one of its parents) is a actual item in this.items
		$(event.target).parents().each(function() {
			if($.data(this, that.widgetName + "-item") === that) {
				currentItem = $(this);
				return false;
			}
		});
		if($.data(event.target, that.widgetName + "-item") === that) {
			currentItem = $(event.target);
		}

		if(!currentItem) {
			return false;
		}
		if(this.options.handle && !overrideHandle) {
			$(this.options.handle, currentItem).find("*").addBack().each(function() {
				if(this === event.target) {
					validHandle = true;
				}
			});
			if(!validHandle) {
				return false;
			}
		}

		this.currentItem = currentItem;
		this._removeCurrentsFromItems();
		return true;

	},

	_mouseStart: function(event, overrideHandle, noActivation) {

		var i, body,
			o = this.options;

		this.currentContainer = this;

		//We only need to call refreshPositions, because the refreshItems call has been moved to mouseCapture
		this.refreshPositions();

		//Create and append the visible helper
		this.helper = this._createHelper(event);

		//Cache the helper size
		this._cacheHelperProportions();

		/*
		 * - Position generation -
		 * This block generates everything position related - it's the core of draggables.
		 */

		//Cache the margins of the original element
		this._cacheMargins();

		//Get the next scrolling parent
		this.scrollParent = this.helper.scrollParent();

		//The element's absolute position on the page minus margins
		this.offset = this.currentItem.offset();
		this.offset = {
			top: this.offset.top - this.margins.top,
			left: this.offset.left - this.margins.left
		};

		$.extend(this.offset, {
			click: { //Where the click happened, relative to the element
				left: event.pageX - this.offset.left,
				top: event.pageY - this.offset.top
			},
			parent: this._getParentOffset(),
			relative: this._getRelativeOffset() //This is a relative to absolute position minus the actual position calculation - only used for relative positioned helper
		});

		// Only after we got the offset, we can change the helper's position to absolute
		// TODO: Still need to figure out a way to make relative sorting possible
		this.helper.css("position", "absolute");
		this.cssPosition = this.helper.css("position");

		//Generate the original position
		this.originalPosition = this._generatePosition(event);
		this.originalPageX = event.pageX;
		this.originalPageY = event.pageY;

		//Adjust the mouse offset relative to the helper if "cursorAt" is supplied
		(o.cursorAt && this._adjustOffsetFromHelper(o.cursorAt));

		//Cache the former DOM position
		this.domPosition = { prev: this.currentItem.prev()[0], parent: this.currentItem.parent()[0] };

		//If the helper is not the original, hide the original so it's not playing any role during the drag, won't cause anything bad this way
		if(this.helper[0] !== this.currentItem[0]) {
			this.currentItem.hide();
		}

		//Create the placeholder
		this._createPlaceholder();

		//Set a containment if given in the options
		if(o.containment) {
			this._setContainment();
		}

		if( o.cursor && o.cursor !== "auto" ) { // cursor option
			body = this.document.find( "body" );

			// support: IE
			this.storedCursor = body.css( "cursor" );
			body.css( "cursor", o.cursor );

			this.storedStylesheet = $( "<style>*{ cursor: "+o.cursor+" !important; }</style>" ).appendTo( body );
		}

		if(o.opacity) { // opacity option
			if (this.helper.css("opacity")) {
				this._storedOpacity = this.helper.css("opacity");
			}
			this.helper.css("opacity", o.opacity);
		}

		if(o.zIndex) { // zIndex option
			if (this.helper.css("zIndex")) {
				this._storedZIndex = this.helper.css("zIndex");
			}
			this.helper.css("zIndex", o.zIndex);
		}

		//Prepare scrolling
		if(this.scrollParent[0] !== this.document[0] && this.scrollParent[0].tagName !== "HTML") {
			this.overflowOffset = this.scrollParent.offset();
		}

		//Call callbacks
		this._trigger("start", event, this._uiHash());

		//Recache the helper size
		if(!this._preserveHelperProportions) {
			this._cacheHelperProportions();
		}


		//Post "activate" events to possible containers
		if( !noActivation ) {
			for ( i = this.containers.length - 1; i >= 0; i-- ) {
				this.containers[ i ]._trigger( "activate", event, this._uiHash( this ) );
			}
		}

		//Prepare possible droppables
		if($.ui.ddmanager) {
			$.ui.ddmanager.current = this;
		}

		if ($.ui.ddmanager && !o.dropBehaviour) {
			$.ui.ddmanager.prepareOffsets(this, event);
		}

		this.dragging = true;

		this.helper.addClass("ui-sortable-helper");
		this._mouseDrag(event); //Execute the drag once - this causes the helper not to be visible before getting its correct position
		return true;

	},

	_mouseDrag: function(event) {
		var i, item, itemElement, intersection,
			o = this.options,
			scrolled = false;

		//Compute the helpers position
		this.position = this._generatePosition(event);
		this.positionAbs = this._convertPositionTo("absolute");

		if (!this.lastPositionAbs) {
			this.lastPositionAbs = this.positionAbs;
		}

		//Do scrolling
		if(this.options.scroll) {
			if(this.scrollParent[0] !== this.document[0] && this.scrollParent[0].tagName !== "HTML") {

				if((this.overflowOffset.top + this.scrollParent[0].offsetHeight) - event.pageY < o.scrollSensitivity) {
					this.scrollParent[0].scrollTop = scrolled = this.scrollParent[0].scrollTop + o.scrollSpeed;
				} else if(event.pageY - this.overflowOffset.top < o.scrollSensitivity) {
					this.scrollParent[0].scrollTop = scrolled = this.scrollParent[0].scrollTop - o.scrollSpeed;
				}

				if((this.overflowOffset.left + this.scrollParent[0].offsetWidth) - event.pageX < o.scrollSensitivity) {
					this.scrollParent[0].scrollLeft = scrolled = this.scrollParent[0].scrollLeft + o.scrollSpeed;
				} else if(event.pageX - this.overflowOffset.left < o.scrollSensitivity) {
					this.scrollParent[0].scrollLeft = scrolled = this.scrollParent[0].scrollLeft - o.scrollSpeed;
				}

			} else {

				if(event.pageY - this.document.scrollTop() < o.scrollSensitivity) {
					scrolled = this.document.scrollTop(this.document.scrollTop() - o.scrollSpeed);
				} else if(this.window.height() - (event.pageY - this.document.scrollTop()) < o.scrollSensitivity) {
					scrolled = this.document.scrollTop(this.document.scrollTop() + o.scrollSpeed);
				}

				if(event.pageX - this.document.scrollLeft() < o.scrollSensitivity) {
					scrolled = this.document.scrollLeft(this.document.scrollLeft() - o.scrollSpeed);
				} else if(this.window.width() - (event.pageX - this.document.scrollLeft()) < o.scrollSensitivity) {
					scrolled = this.document.scrollLeft(this.document.scrollLeft() + o.scrollSpeed);
				}

			}

			if(scrolled !== false && $.ui.ddmanager && !o.dropBehaviour) {
				$.ui.ddmanager.prepareOffsets(this, event);
			}
		}

		//Regenerate the absolute position used for position checks
		this.positionAbs = this._convertPositionTo("absolute");

		//Set the helper position
		if(!this.options.axis || this.options.axis !== "y") {
			this.helper[0].style.left = this.position.left+"px";
		}
		if(!this.options.axis || this.options.axis !== "x") {
			this.helper[0].style.top = this.position.top+"px";
		}

		//Rearrange
		for (i = this.items.length - 1; i >= 0; i--) {

			//Cache variables and intersection, continue if no intersection
			item = this.items[i];
			itemElement = item.item[0];
			intersection = this._intersectsWithPointer(item);
			if (!intersection) {
				continue;
			}

			// Only put the placeholder inside the current Container, skip all
			// items from other containers. This works because when moving
			// an item from one container to another the
			// currentContainer is switched before the placeholder is moved.
			//
			// Without this, moving items in "sub-sortables" can cause
			// the placeholder to jitter between the outer and inner container.
			if (item.instance !== this.currentContainer) {
				continue;
			}

			// cannot intersect with itself
			// no useless actions that have been done before
			// no action if the item moved is the parent of the item checked
			if (itemElement !== this.currentItem[0] &&
				this.placeholder[intersection === 1 ? "next" : "prev"]()[0] !== itemElement &&
				!$.contains(this.placeholder[0], itemElement) &&
				(this.options.type === "semi-dynamic" ? !$.contains(this.element[0], itemElement) : true)
			) {

				this.direction = intersection === 1 ? "down" : "up";

				if (this.options.tolerance === "pointer" || this._intersectsWithSides(item)) {
					this._rearrange(event, item);
				} else {
					break;
				}

				this._trigger("change", event, this._uiHash());
				break;
			}
		}

		//Post events to containers
		this._contactContainers(event);

		//Interconnect with droppables
		if($.ui.ddmanager) {
			$.ui.ddmanager.drag(this, event);
		}

		//Call callbacks
		this._trigger("sort", event, this._uiHash());

		this.lastPositionAbs = this.positionAbs;
		return false;

	},

	_mouseStop: function(event, noPropagation) {

		if(!event) {
			return;
		}

		//If we are using droppables, inform the manager about the drop
		if ($.ui.ddmanager && !this.options.dropBehaviour) {
			$.ui.ddmanager.drop(this, event);
		}

		if(this.options.revert) {
			var that = this,
				cur = this.placeholder.offset(),
				axis = this.options.axis,
				animation = {};

			if ( !axis || axis === "x" ) {
				animation.left = cur.left - this.offset.parent.left - this.margins.left + (this.offsetParent[0] === this.document[0].body ? 0 : this.offsetParent[0].scrollLeft);
			}
			if ( !axis || axis === "y" ) {
				animation.top = cur.top - this.offset.parent.top - this.margins.top + (this.offsetParent[0] === this.document[0].body ? 0 : this.offsetParent[0].scrollTop);
			}
			this.reverting = true;
			$(this.helper).animate( animation, parseInt(this.options.revert, 10) || 500, function() {
				that._clear(event);
			});
		} else {
			this._clear(event, noPropagation);
		}

		return false;

	},

	cancel: function() {

		if(this.dragging) {

			this._mouseUp({ target: null });

			if(this.options.helper === "original") {
				this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper");
			} else {
				this.currentItem.show();
			}

			//Post deactivating events to containers
			for (var i = this.containers.length - 1; i >= 0; i--){
				this.containers[i]._trigger("deactivate", null, this._uiHash(this));
				if(this.containers[i].containerCache.over) {
					this.containers[i]._trigger("out", null, this._uiHash(this));
					this.containers[i].containerCache.over = 0;
				}
			}

		}

		if (this.placeholder) {
			//$(this.placeholder[0]).remove(); would have been the jQuery way - unfortunately, it unbinds ALL events from the original node!
			if(this.placeholder[0].parentNode) {
				this.placeholder[0].parentNode.removeChild(this.placeholder[0]);
			}
			if(this.options.helper !== "original" && this.helper && this.helper[0].parentNode) {
				this.helper.remove();
			}

			$.extend(this, {
				helper: null,
				dragging: false,
				reverting: false,
				_noFinalSort: null
			});

			if(this.domPosition.prev) {
				$(this.domPosition.prev).after(this.currentItem);
			} else {
				$(this.domPosition.parent).prepend(this.currentItem);
			}
		}

		return this;

	},

	serialize: function(o) {

		var items = this._getItemsAsjQuery(o && o.connected),
			str = [];
		o = o || {};

		$(items).each(function() {
			var res = ($(o.item || this).attr(o.attribute || "id") || "").match(o.expression || (/(.+)[\-=_](.+)/));
			if (res) {
				str.push((o.key || res[1]+"[]")+"="+(o.key && o.expression ? res[1] : res[2]));
			}
		});

		if(!str.length && o.key) {
			str.push(o.key + "=");
		}

		return str.join("&");

	},

	toArray: function(o) {

		var items = this._getItemsAsjQuery(o && o.connected),
			ret = [];

		o = o || {};

		items.each(function() { ret.push($(o.item || this).attr(o.attribute || "id") || ""); });
		return ret;

	},

	/* Be careful with the following core functions */
	_intersectsWith: function(item) {

		var x1 = this.positionAbs.left,
			x2 = x1 + this.helperProportions.width,
			y1 = this.positionAbs.top,
			y2 = y1 + this.helperProportions.height,
			l = item.left,
			r = l + item.width,
			t = item.top,
			b = t + item.height,
			dyClick = this.offset.click.top,
			dxClick = this.offset.click.left,
			isOverElementHeight = ( this.options.axis === "x" ) || ( ( y1 + dyClick ) > t && ( y1 + dyClick ) < b ),
			isOverElementWidth = ( this.options.axis === "y" ) || ( ( x1 + dxClick ) > l && ( x1 + dxClick ) < r ),
			isOverElement = isOverElementHeight && isOverElementWidth;

		if ( this.options.tolerance === "pointer" ||
			this.options.forcePointerForContainers ||
			(this.options.tolerance !== "pointer" && this.helperProportions[this.floating ? "width" : "height"] > item[this.floating ? "width" : "height"])
		) {
			return isOverElement;
		} else {

			return (l < x1 + (this.helperProportions.width / 2) && // Right Half
				x2 - (this.helperProportions.width / 2) < r && // Left Half
				t < y1 + (this.helperProportions.height / 2) && // Bottom Half
				y2 - (this.helperProportions.height / 2) < b ); // Top Half

		}
	},

	_intersectsWithPointer: function(item) {

		var isOverElementHeight = (this.options.axis === "x") || this._isOverAxis(this.positionAbs.top + this.offset.click.top, item.top, item.height),
			isOverElementWidth = (this.options.axis === "y") || this._isOverAxis(this.positionAbs.left + this.offset.click.left, item.left, item.width),
			isOverElement = isOverElementHeight && isOverElementWidth,
			verticalDirection = this._getDragVerticalDirection(),
			horizontalDirection = this._getDragHorizontalDirection();

		if (!isOverElement) {
			return false;
		}

		return this.floating ?
			( ((horizontalDirection && horizontalDirection === "right") || verticalDirection === "down") ? 2 : 1 )
			: ( verticalDirection && (verticalDirection === "down" ? 2 : 1) );

	},

	_intersectsWithSides: function(item) {

		var isOverBottomHalf = this._isOverAxis(this.positionAbs.top + this.offset.click.top, item.top + (item.height/2), item.height),
			isOverRightHalf = this._isOverAxis(this.positionAbs.left + this.offset.click.left, item.left + (item.width/2), item.width),
			verticalDirection = this._getDragVerticalDirection(),
			horizontalDirection = this._getDragHorizontalDirection();

		if (this.floating && horizontalDirection) {
			return ((horizontalDirection === "right" && isOverRightHalf) || (horizontalDirection === "left" && !isOverRightHalf));
		} else {
			return verticalDirection && ((verticalDirection === "down" && isOverBottomHalf) || (verticalDirection === "up" && !isOverBottomHalf));
		}

	},

	_getDragVerticalDirection: function() {
		var delta = this.positionAbs.top - this.lastPositionAbs.top;
		return delta !== 0 && (delta > 0 ? "down" : "up");
	},

	_getDragHorizontalDirection: function() {
		var delta = this.positionAbs.left - this.lastPositionAbs.left;
		return delta !== 0 && (delta > 0 ? "right" : "left");
	},

	refresh: function(event) {
		this._refreshItems(event);
		this._setHandleClassName();
		this.refreshPositions();
		return this;
	},

	_connectWith: function() {
		var options = this.options;
		return options.connectWith.constructor === String ? [options.connectWith] : options.connectWith;
	},

	_getItemsAsjQuery: function(connected) {

		var i, j, cur, inst,
			items = [],
			queries = [],
			connectWith = this._connectWith();

		if(connectWith && connected) {
			for (i = connectWith.length - 1; i >= 0; i--){
				cur = $(connectWith[i], this.document[0]);
				for ( j = cur.length - 1; j >= 0; j--){
					inst = $.data(cur[j], this.widgetFullName);
					if(inst && inst !== this && !inst.options.disabled) {
						queries.push([$.isFunction(inst.options.items) ? inst.options.items.call(inst.element) : $(inst.options.items, inst.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"), inst]);
					}
				}
			}
		}

		queries.push([$.isFunction(this.options.items) ? this.options.items.call(this.element, null, { options: this.options, item: this.currentItem }) : $(this.options.items, this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"), this]);

		function addItems() {
			items.push( this );
		}
		for (i = queries.length - 1; i >= 0; i--){
			queries[i][0].each( addItems );
		}

		return $(items);

	},

	_removeCurrentsFromItems: function() {

		var list = this.currentItem.find(":data(" + this.widgetName + "-item)");

		this.items = $.grep(this.items, function (item) {
			for (var j=0; j < list.length; j++) {
				if(list[j] === item.item[0]) {
					return false;
				}
			}
			return true;
		});

	},

	_refreshItems: function(event) {

		this.items = [];
		this.containers = [this];

		var i, j, cur, inst, targetData, _queries, item, queriesLength,
			items = this.items,
			queries = [[$.isFunction(this.options.items) ? this.options.items.call(this.element[0], event, { item: this.currentItem }) : $(this.options.items, this.element), this]],
			connectWith = this._connectWith();

		if(connectWith && this.ready) { //Shouldn't be run the first time through due to massive slow-down
			for (i = connectWith.length - 1; i >= 0; i--){
				cur = $(connectWith[i], this.document[0]);
				for (j = cur.length - 1; j >= 0; j--){
					inst = $.data(cur[j], this.widgetFullName);
					if(inst && inst !== this && !inst.options.disabled) {
						queries.push([$.isFunction(inst.options.items) ? inst.options.items.call(inst.element[0], event, { item: this.currentItem }) : $(inst.options.items, inst.element), inst]);
						this.containers.push(inst);
					}
				}
			}
		}

		for (i = queries.length - 1; i >= 0; i--) {
			targetData = queries[i][1];
			_queries = queries[i][0];

			for (j=0, queriesLength = _queries.length; j < queriesLength; j++) {
				item = $(_queries[j]);

				item.data(this.widgetName + "-item", targetData); // Data for target checking (mouse manager)

				items.push({
					item: item,
					instance: targetData,
					width: 0, height: 0,
					left: 0, top: 0
				});
			}
		}

	},

	refreshPositions: function(fast) {

		// Determine whether items are being displayed horizontally
		this.floating = this.items.length ?
			this.options.axis === "x" || this._isFloating( this.items[ 0 ].item ) :
			false;

		//This has to be redone because due to the item being moved out/into the offsetParent, the offsetParent's position will change
		if(this.offsetParent && this.helper) {
			this.offset.parent = this._getParentOffset();
		}

		var i, item, t, p;

		for (i = this.items.length - 1; i >= 0; i--){
			item = this.items[i];

			//We ignore calculating positions of all connected containers when we're not over them
			if(item.instance !== this.currentContainer && this.currentContainer && item.item[0] !== this.currentItem[0]) {
				continue;
			}

			t = this.options.toleranceElement ? $(this.options.toleranceElement, item.item) : item.item;

			if (!fast) {
				item.width = t.outerWidth();
				item.height = t.outerHeight();
			}

			p = t.offset();
			item.left = p.left;
			item.top = p.top;
		}

		if(this.options.custom && this.options.custom.refreshContainers) {
			this.options.custom.refreshContainers.call(this);
		} else {
			for (i = this.containers.length - 1; i >= 0; i--){
				p = this.containers[i].element.offset();
				this.containers[i].containerCache.left = p.left;
				this.containers[i].containerCache.top = p.top;
				this.containers[i].containerCache.width = this.containers[i].element.outerWidth();
				this.containers[i].containerCache.height = this.containers[i].element.outerHeight();
			}
		}

		return this;
	},

	_createPlaceholder: function(that) {
		that = that || this;
		var className,
			o = that.options;

		if(!o.placeholder || o.placeholder.constructor === String) {
			className = o.placeholder;
			o.placeholder = {
				element: function() {

					var nodeName = that.currentItem[0].nodeName.toLowerCase(),
						element = $( "<" + nodeName + ">", that.document[0] )
							.addClass(className || that.currentItem[0].className+" ui-sortable-placeholder")
							.removeClass("ui-sortable-helper");

					if ( nodeName === "tbody" ) {
						that._createTrPlaceholder(
							that.currentItem.find( "tr" ).eq( 0 ),
							$( "<tr>", that.document[ 0 ] ).appendTo( element )
						);
					} else if ( nodeName === "tr" ) {
						that._createTrPlaceholder( that.currentItem, element );
					} else if ( nodeName === "img" ) {
						element.attr( "src", that.currentItem.attr( "src" ) );
					}

					if ( !className ) {
						element.css( "visibility", "hidden" );
					}

					return element;
				},
				update: function(container, p) {

					// 1. If a className is set as 'placeholder option, we don't force sizes - the class is responsible for that
					// 2. The option 'forcePlaceholderSize can be enabled to force it even if a class name is specified
					if(className && !o.forcePlaceholderSize) {
						return;
					}

					//If the element doesn't have a actual height by itself (without styles coming from a stylesheet), it receives the inline height from the dragged item
					if(!p.height()) { p.height(that.currentItem.innerHeight() - parseInt(that.currentItem.css("paddingTop")||0, 10) - parseInt(that.currentItem.css("paddingBottom")||0, 10)); }
					if(!p.width()) { p.width(that.currentItem.innerWidth() - parseInt(that.currentItem.css("paddingLeft")||0, 10) - parseInt(that.currentItem.css("paddingRight")||0, 10)); }
				}
			};
		}

		//Create the placeholder
		that.placeholder = $(o.placeholder.element.call(that.element, that.currentItem));

		//Append it after the actual current item
		that.currentItem.after(that.placeholder);

		//Update the size of the placeholder (TODO: Logic to fuzzy, see line 316/317)
		o.placeholder.update(that, that.placeholder);

	},

	_createTrPlaceholder: function( sourceTr, targetTr ) {
		var that = this;

		sourceTr.children().each(function() {
			$( "<td>&#160;</td>", that.document[ 0 ] )
				.attr( "colspan", $( this ).attr( "colspan" ) || 1 )
				.appendTo( targetTr );
		});
	},

	_contactContainers: function(event) {
		var i, j, dist, itemWithLeastDistance, posProperty, sizeProperty, cur, nearBottom, floating, axis,
			innermostContainer = null,
			innermostIndex = null;

		// get innermost container that intersects with item
		for (i = this.containers.length - 1; i >= 0; i--) {

			// never consider a container that's located within the item itself
			if($.contains(this.currentItem[0], this.containers[i].element[0])) {
				continue;
			}

			if(this._intersectsWith(this.containers[i].containerCache)) {

				// if we've already found a container and it's more "inner" than this, then continue
				if(innermostContainer && $.contains(this.containers[i].element[0], innermostContainer.element[0])) {
					continue;
				}

				innermostContainer = this.containers[i];
				innermostIndex = i;

			} else {
				// container doesn't intersect. trigger "out" event if necessary
				if(this.containers[i].containerCache.over) {
					this.containers[i]._trigger("out", event, this._uiHash(this));
					this.containers[i].containerCache.over = 0;
				}
			}

		}

		// if no intersecting containers found, return
		if(!innermostContainer) {
			return;
		}

		// move the item into the container if it's not there already
		if(this.containers.length === 1) {
			if (!this.containers[innermostIndex].containerCache.over) {
				this.containers[innermostIndex]._trigger("over", event, this._uiHash(this));
				this.containers[innermostIndex].containerCache.over = 1;
			}
		} else {

			//When entering a new container, we will find the item with the least distance and append our item near it
			dist = 10000;
			itemWithLeastDistance = null;
			floating = innermostContainer.floating || this._isFloating(this.currentItem);
			posProperty = floating ? "left" : "top";
			sizeProperty = floating ? "width" : "height";
			axis = floating ? "clientX" : "clientY";

			for (j = this.items.length - 1; j >= 0; j--) {
				if(!$.contains(this.containers[innermostIndex].element[0], this.items[j].item[0])) {
					continue;
				}
				if(this.items[j].item[0] === this.currentItem[0]) {
					continue;
				}

				cur = this.items[j].item.offset()[posProperty];
				nearBottom = false;
				if ( event[ axis ] - cur > this.items[ j ][ sizeProperty ] / 2 ) {
					nearBottom = true;
				}

				if ( Math.abs( event[ axis ] - cur ) < dist ) {
					dist = Math.abs( event[ axis ] - cur );
					itemWithLeastDistance = this.items[ j ];
					this.direction = nearBottom ? "up": "down";
				}
			}

			//Check if dropOnEmpty is enabled
			if(!itemWithLeastDistance && !this.options.dropOnEmpty) {
				return;
			}

			if(this.currentContainer === this.containers[innermostIndex]) {
				if ( !this.currentContainer.containerCache.over ) {
					this.containers[ innermostIndex ]._trigger( "over", event, this._uiHash() );
					this.currentContainer.containerCache.over = 1;
				}
				return;
			}

			itemWithLeastDistance ? this._rearrange(event, itemWithLeastDistance, null, true) : this._rearrange(event, null, this.containers[innermostIndex].element, true);
			this._trigger("change", event, this._uiHash());
			this.containers[innermostIndex]._trigger("change", event, this._uiHash(this));
			this.currentContainer = this.containers[innermostIndex];

			//Update the placeholder
			this.options.placeholder.update(this.currentContainer, this.placeholder);

			this.containers[innermostIndex]._trigger("over", event, this._uiHash(this));
			this.containers[innermostIndex].containerCache.over = 1;
		}


	},

	_createHelper: function(event) {

		var o = this.options,
			helper = $.isFunction(o.helper) ? $(o.helper.apply(this.element[0], [event, this.currentItem])) : (o.helper === "clone" ? this.currentItem.clone() : this.currentItem);

		//Add the helper to the DOM if that didn't happen already
		if(!helper.parents("body").length) {
			$(o.appendTo !== "parent" ? o.appendTo : this.currentItem[0].parentNode)[0].appendChild(helper[0]);
		}

		if(helper[0] === this.currentItem[0]) {
			this._storedCSS = { width: this.currentItem[0].style.width, height: this.currentItem[0].style.height, position: this.currentItem.css("position"), top: this.currentItem.css("top"), left: this.currentItem.css("left") };
		}

		if(!helper[0].style.width || o.forceHelperSize) {
			helper.width(this.currentItem.width());
		}
		if(!helper[0].style.height || o.forceHelperSize) {
			helper.height(this.currentItem.height());
		}

		return helper;

	},

	_adjustOffsetFromHelper: function(obj) {
		if (typeof obj === "string") {
			obj = obj.split(" ");
		}
		if ($.isArray(obj)) {
			obj = {left: +obj[0], top: +obj[1] || 0};
		}
		if ("left" in obj) {
			this.offset.click.left = obj.left + this.margins.left;
		}
		if ("right" in obj) {
			this.offset.click.left = this.helperProportions.width - obj.right + this.margins.left;
		}
		if ("top" in obj) {
			this.offset.click.top = obj.top + this.margins.top;
		}
		if ("bottom" in obj) {
			this.offset.click.top = this.helperProportions.height - obj.bottom + this.margins.top;
		}
	},

	_getParentOffset: function() {


		//Get the offsetParent and cache its position
		this.offsetParent = this.helper.offsetParent();
		var po = this.offsetParent.offset();

		// This is a special case where we need to modify a offset calculated on start, since the following happened:
		// 1. The position of the helper is absolute, so it's position is calculated based on the next positioned parent
		// 2. The actual offset parent is a child of the scroll parent, and the scroll parent isn't the document, which means that
		//    the scroll is included in the initial calculation of the offset of the parent, and never recalculated upon drag
		if(this.cssPosition === "absolute" && this.scrollParent[0] !== this.document[0] && $.contains(this.scrollParent[0], this.offsetParent[0])) {
			po.left += this.scrollParent.scrollLeft();
			po.top += this.scrollParent.scrollTop();
		}

		// This needs to be actually done for all browsers, since pageX/pageY includes this information
		// with an ugly IE fix
		if( this.offsetParent[0] === this.document[0].body || (this.offsetParent[0].tagName && this.offsetParent[0].tagName.toLowerCase() === "html" && $.ui.ie)) {
			po = { top: 0, left: 0 };
		}

		return {
			top: po.top + (parseInt(this.offsetParent.css("borderTopWidth"),10) || 0),
			left: po.left + (parseInt(this.offsetParent.css("borderLeftWidth"),10) || 0)
		};

	},

	_getRelativeOffset: function() {

		if(this.cssPosition === "relative") {
			var p = this.currentItem.position();
			return {
				top: p.top - (parseInt(this.helper.css("top"),10) || 0) + this.scrollParent.scrollTop(),
				left: p.left - (parseInt(this.helper.css("left"),10) || 0) + this.scrollParent.scrollLeft()
			};
		} else {
			return { top: 0, left: 0 };
		}

	},

	_cacheMargins: function() {
		this.margins = {
			left: (parseInt(this.currentItem.css("marginLeft"),10) || 0),
			top: (parseInt(this.currentItem.css("marginTop"),10) || 0)
		};
	},

	_cacheHelperProportions: function() {
		this.helperProportions = {
			width: this.helper.outerWidth(),
			height: this.helper.outerHeight()
		};
	},

	_setContainment: function() {

		var ce, co, over,
			o = this.options;
		if(o.containment === "parent") {
			o.containment = this.helper[0].parentNode;
		}
		if(o.containment === "document" || o.containment === "window") {
			this.containment = [
				0 - this.offset.relative.left - this.offset.parent.left,
				0 - this.offset.relative.top - this.offset.parent.top,
				o.containment === "document" ? this.document.width() : this.window.width() - this.helperProportions.width - this.margins.left,
				(o.containment === "document" ? this.document.width() : this.window.height() || this.document[0].body.parentNode.scrollHeight) - this.helperProportions.height - this.margins.top
			];
		}

		if(!(/^(document|window|parent)$/).test(o.containment)) {
			ce = $(o.containment)[0];
			co = $(o.containment).offset();
			over = ($(ce).css("overflow") !== "hidden");

			this.containment = [
				co.left + (parseInt($(ce).css("borderLeftWidth"),10) || 0) + (parseInt($(ce).css("paddingLeft"),10) || 0) - this.margins.left,
				co.top + (parseInt($(ce).css("borderTopWidth"),10) || 0) + (parseInt($(ce).css("paddingTop"),10) || 0) - this.margins.top,
				co.left+(over ? Math.max(ce.scrollWidth,ce.offsetWidth) : ce.offsetWidth) - (parseInt($(ce).css("borderLeftWidth"),10) || 0) - (parseInt($(ce).css("paddingRight"),10) || 0) - this.helperProportions.width - this.margins.left,
				co.top+(over ? Math.max(ce.scrollHeight,ce.offsetHeight) : ce.offsetHeight) - (parseInt($(ce).css("borderTopWidth"),10) || 0) - (parseInt($(ce).css("paddingBottom"),10) || 0) - this.helperProportions.height - this.margins.top
			];
		}

	},

	_convertPositionTo: function(d, pos) {

		if(!pos) {
			pos = this.position;
		}
		var mod = d === "absolute" ? 1 : -1,
			scroll = this.cssPosition === "absolute" && !(this.scrollParent[0] !== this.document[0] && $.contains(this.scrollParent[0], this.offsetParent[0])) ? this.offsetParent : this.scrollParent,
			scrollIsRootNode = (/(html|body)/i).test(scroll[0].tagName);

		return {
			top: (
				pos.top	+																// The absolute mouse position
				this.offset.relative.top * mod +										// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.top * mod -											// The offsetParent's offset without borders (offset + border)
				( ( this.cssPosition === "fixed" ? -this.scrollParent.scrollTop() : ( scrollIsRootNode ? 0 : scroll.scrollTop() ) ) * mod)
			),
			left: (
				pos.left +																// The absolute mouse position
				this.offset.relative.left * mod +										// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.left * mod	-										// The offsetParent's offset without borders (offset + border)
				( ( this.cssPosition === "fixed" ? -this.scrollParent.scrollLeft() : scrollIsRootNode ? 0 : scroll.scrollLeft() ) * mod)
			)
		};

	},

	_generatePosition: function(event) {

		var top, left,
			o = this.options,
			pageX = event.pageX,
			pageY = event.pageY,
			scroll = this.cssPosition === "absolute" && !(this.scrollParent[0] !== this.document[0] && $.contains(this.scrollParent[0], this.offsetParent[0])) ? this.offsetParent : this.scrollParent, scrollIsRootNode = (/(html|body)/i).test(scroll[0].tagName);

		// This is another very weird special case that only happens for relative elements:
		// 1. If the css position is relative
		// 2. and the scroll parent is the document or similar to the offset parent
		// we have to refresh the relative offset during the scroll so there are no jumps
		if(this.cssPosition === "relative" && !(this.scrollParent[0] !== this.document[0] && this.scrollParent[0] !== this.offsetParent[0])) {
			this.offset.relative = this._getRelativeOffset();
		}

		/*
		 * - Position constraining -
		 * Constrain the position to a mix of grid, containment.
		 */

		if(this.originalPosition) { //If we are not dragging yet, we won't check for options

			if(this.containment) {
				if(event.pageX - this.offset.click.left < this.containment[0]) {
					pageX = this.containment[0] + this.offset.click.left;
				}
				if(event.pageY - this.offset.click.top < this.containment[1]) {
					pageY = this.containment[1] + this.offset.click.top;
				}
				if(event.pageX - this.offset.click.left > this.containment[2]) {
					pageX = this.containment[2] + this.offset.click.left;
				}
				if(event.pageY - this.offset.click.top > this.containment[3]) {
					pageY = this.containment[3] + this.offset.click.top;
				}
			}

			if(o.grid) {
				top = this.originalPageY + Math.round((pageY - this.originalPageY) / o.grid[1]) * o.grid[1];
				pageY = this.containment ? ( (top - this.offset.click.top >= this.containment[1] && top - this.offset.click.top <= this.containment[3]) ? top : ((top - this.offset.click.top >= this.containment[1]) ? top - o.grid[1] : top + o.grid[1])) : top;

				left = this.originalPageX + Math.round((pageX - this.originalPageX) / o.grid[0]) * o.grid[0];
				pageX = this.containment ? ( (left - this.offset.click.left >= this.containment[0] && left - this.offset.click.left <= this.containment[2]) ? left : ((left - this.offset.click.left >= this.containment[0]) ? left - o.grid[0] : left + o.grid[0])) : left;
			}

		}

		return {
			top: (
				pageY -																// The absolute mouse position
				this.offset.click.top -													// Click offset (relative to the element)
				this.offset.relative.top	-											// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.top +												// The offsetParent's offset without borders (offset + border)
				( ( this.cssPosition === "fixed" ? -this.scrollParent.scrollTop() : ( scrollIsRootNode ? 0 : scroll.scrollTop() ) ))
			),
			left: (
				pageX -																// The absolute mouse position
				this.offset.click.left -												// Click offset (relative to the element)
				this.offset.relative.left	-											// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.left +												// The offsetParent's offset without borders (offset + border)
				( ( this.cssPosition === "fixed" ? -this.scrollParent.scrollLeft() : scrollIsRootNode ? 0 : scroll.scrollLeft() ))
			)
		};

	},

	_rearrange: function(event, i, a, hardRefresh) {

		a ? a[0].appendChild(this.placeholder[0]) : i.item[0].parentNode.insertBefore(this.placeholder[0], (this.direction === "down" ? i.item[0] : i.item[0].nextSibling));

		//Various things done here to improve the performance:
		// 1. we create a setTimeout, that calls refreshPositions
		// 2. on the instance, we have a counter variable, that get's higher after every append
		// 3. on the local scope, we copy the counter variable, and check in the timeout, if it's still the same
		// 4. this lets only the last addition to the timeout stack through
		this.counter = this.counter ? ++this.counter : 1;
		var counter = this.counter;

		this._delay(function() {
			if(counter === this.counter) {
				this.refreshPositions(!hardRefresh); //Precompute after each DOM insertion, NOT on mousemove
			}
		});

	},

	_clear: function(event, noPropagation) {

		this.reverting = false;
		// We delay all events that have to be triggered to after the point where the placeholder has been removed and
		// everything else normalized again
		var i,
			delayedTriggers = [];

		// We first have to update the dom position of the actual currentItem
		// Note: don't do it if the current item is already removed (by a user), or it gets reappended (see #4088)
		if(!this._noFinalSort && this.currentItem.parent().length) {
			this.placeholder.before(this.currentItem);
		}
		this._noFinalSort = null;

		if(this.helper[0] === this.currentItem[0]) {
			for(i in this._storedCSS) {
				if(this._storedCSS[i] === "auto" || this._storedCSS[i] === "static") {
					this._storedCSS[i] = "";
				}
			}
			this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper");
		} else {
			this.currentItem.show();
		}

		if(this.fromOutside && !noPropagation) {
			delayedTriggers.push(function(event) { this._trigger("receive", event, this._uiHash(this.fromOutside)); });
		}
		if((this.fromOutside || this.domPosition.prev !== this.currentItem.prev().not(".ui-sortable-helper")[0] || this.domPosition.parent !== this.currentItem.parent()[0]) && !noPropagation) {
			delayedTriggers.push(function(event) { this._trigger("update", event, this._uiHash()); }); //Trigger update callback if the DOM position has changed
		}

		// Check if the items Container has Changed and trigger appropriate
		// events.
		if (this !== this.currentContainer) {
			if(!noPropagation) {
				delayedTriggers.push(function(event) { this._trigger("remove", event, this._uiHash()); });
				delayedTriggers.push((function(c) { return function(event) { c._trigger("receive", event, this._uiHash(this)); };  }).call(this, this.currentContainer));
				delayedTriggers.push((function(c) { return function(event) { c._trigger("update", event, this._uiHash(this));  }; }).call(this, this.currentContainer));
			}
		}


		//Post events to containers
		function delayEvent( type, instance, container ) {
			return function( event ) {
				container._trigger( type, event, instance._uiHash( instance ) );
			};
		}
		for (i = this.containers.length - 1; i >= 0; i--){
			if (!noPropagation) {
				delayedTriggers.push( delayEvent( "deactivate", this, this.containers[ i ] ) );
			}
			if(this.containers[i].containerCache.over) {
				delayedTriggers.push( delayEvent( "out", this, this.containers[ i ] ) );
				this.containers[i].containerCache.over = 0;
			}
		}

		//Do what was originally in plugins
		if ( this.storedCursor ) {
			this.document.find( "body" ).css( "cursor", this.storedCursor );
			this.storedStylesheet.remove();
		}
		if(this._storedOpacity) {
			this.helper.css("opacity", this._storedOpacity);
		}
		if(this._storedZIndex) {
			this.helper.css("zIndex", this._storedZIndex === "auto" ? "" : this._storedZIndex);
		}

		this.dragging = false;

		if(!noPropagation) {
			this._trigger("beforeStop", event, this._uiHash());
		}

		//$(this.placeholder[0]).remove(); would have been the jQuery way - unfortunately, it unbinds ALL events from the original node!
		this.placeholder[0].parentNode.removeChild(this.placeholder[0]);

		if ( !this.cancelHelperRemoval ) {
			if ( this.helper[ 0 ] !== this.currentItem[ 0 ] ) {
				this.helper.remove();
			}
			this.helper = null;
		}

		if(!noPropagation) {
			for (i=0; i < delayedTriggers.length; i++) {
				delayedTriggers[i].call(this, event);
			} //Trigger all delayed events
			this._trigger("stop", event, this._uiHash());
		}

		this.fromOutside = false;
		return !this.cancelHelperRemoval;

	},

	_trigger: function() {
		if ($.Widget.prototype._trigger.apply(this, arguments) === false) {
			this.cancel();
		}
	},

	_uiHash: function(_inst) {
		var inst = _inst || this;
		return {
			helper: inst.helper,
			placeholder: inst.placeholder || $([]),
			position: inst.position,
			originalPosition: inst.originalPosition,
			offset: inst.positionAbs,
			item: inst.currentItem,
			sender: _inst ? _inst.element : null
		};
	}

});


/*!
 * jQuery UI Spinner 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/spinner/
 */


function spinner_modifier( fn ) {
	return function() {
		var previous = this.element.val();
		fn.apply( this, arguments );
		this._refresh();
		if ( previous !== this.element.val() ) {
			this._trigger( "change" );
		}
	};
}

var spinner = $.widget( "ui.spinner", {
	version: "1.11.4",
	defaultElement: "<input>",
	widgetEventPrefix: "spin",
	options: {
		culture: null,
		icons: {
			down: "ui-icon-triangle-1-s",
			up: "ui-icon-triangle-1-n"
		},
		incremental: true,
		max: null,
		min: null,
		numberFormat: null,
		page: 10,
		step: 1,

		change: null,
		spin: null,
		start: null,
		stop: null
	},

	_create: function() {
		// handle string values that need to be parsed
		this._setOption( "max", this.options.max );
		this._setOption( "min", this.options.min );
		this._setOption( "step", this.options.step );

		// Only format if there is a value, prevents the field from being marked
		// as invalid in Firefox, see #9573.
		if ( this.value() !== "" ) {
			// Format the value, but don't constrain.
			this._value( this.element.val(), true );
		}

		this._draw();
		this._on( this._events );
		this._refresh();

		// turning off autocomplete prevents the browser from remembering the
		// value when navigating through history, so we re-enable autocomplete
		// if the page is unloaded before the widget is destroyed. #7790
		this._on( this.window, {
			beforeunload: function() {
				this.element.removeAttr( "autocomplete" );
			}
		});
	},

	_getCreateOptions: function() {
		var options = {},
			element = this.element;

		$.each( [ "min", "max", "step" ], function( i, option ) {
			var value = element.attr( option );
			if ( value !== undefined && value.length ) {
				options[ option ] = value;
			}
		});

		return options;
	},

	_events: {
		keydown: function( event ) {
			if ( this._start( event ) && this._keydown( event ) ) {
				event.preventDefault();
			}
		},
		keyup: "_stop",
		focus: function() {
			this.previous = this.element.val();
		},
		blur: function( event ) {
			if ( this.cancelBlur ) {
				delete this.cancelBlur;
				return;
			}

			this._stop();
			this._refresh();
			if ( this.previous !== this.element.val() ) {
				this._trigger( "change", event );
			}
		},
		mousewheel: function( event, delta ) {
			if ( !delta ) {
				return;
			}
			if ( !this.spinning && !this._start( event ) ) {
				return false;
			}

			this._spin( (delta > 0 ? 1 : -1) * this.options.step, event );
			clearTimeout( this.mousewheelTimer );
			this.mousewheelTimer = this._delay(function() {
				if ( this.spinning ) {
					this._stop( event );
				}
			}, 100 );
			event.preventDefault();
		},
		"mousedown .ui-spinner-button": function( event ) {
			var previous;

			// We never want the buttons to have focus; whenever the user is
			// interacting with the spinner, the focus should be on the input.
			// If the input is focused then this.previous is properly set from
			// when the input first received focus. If the input is not focused
			// then we need to set this.previous based on the value before spinning.
			previous = this.element[0] === this.document[0].activeElement ?
				this.previous : this.element.val();
			function checkFocus() {
				var isActive = this.element[0] === this.document[0].activeElement;
				if ( !isActive ) {
					this.element.focus();
					this.previous = previous;
					// support: IE
					// IE sets focus asynchronously, so we need to check if focus
					// moved off of the input because the user clicked on the button.
					this._delay(function() {
						this.previous = previous;
					});
				}
			}

			// ensure focus is on (or stays on) the text field
			event.preventDefault();
			checkFocus.call( this );

			// support: IE
			// IE doesn't prevent moving focus even with event.preventDefault()
			// so we set a flag to know when we should ignore the blur event
			// and check (again) if focus moved off of the input.
			this.cancelBlur = true;
			this._delay(function() {
				delete this.cancelBlur;
				checkFocus.call( this );
			});

			if ( this._start( event ) === false ) {
				return;
			}

			this._repeat( null, $( event.currentTarget ).hasClass( "ui-spinner-up" ) ? 1 : -1, event );
		},
		"mouseup .ui-spinner-button": "_stop",
		"mouseenter .ui-spinner-button": function( event ) {
			// button will add ui-state-active if mouse was down while mouseleave and kept down
			if ( !$( event.currentTarget ).hasClass( "ui-state-active" ) ) {
				return;
			}

			if ( this._start( event ) === false ) {
				return false;
			}
			this._repeat( null, $( event.currentTarget ).hasClass( "ui-spinner-up" ) ? 1 : -1, event );
		},
		// TODO: do we really want to consider this a stop?
		// shouldn't we just stop the repeater and wait until mouseup before
		// we trigger the stop event?
		"mouseleave .ui-spinner-button": "_stop"
	},

	_draw: function() {
		var uiSpinner = this.uiSpinner = this.element
			.addClass( "ui-spinner-input" )
			.attr( "autocomplete", "off" )
			.wrap( this._uiSpinnerHtml() )
			.parent()
				// add buttons
				.append( this._buttonHtml() );

		this.element.attr( "role", "spinbutton" );

		// button bindings
		this.buttons = uiSpinner.find( ".ui-spinner-button" )
			.attr( "tabIndex", -1 )
			.button()
			.removeClass( "ui-corner-all" );

		// IE 6 doesn't understand height: 50% for the buttons
		// unless the wrapper has an explicit height
		if ( this.buttons.height() > Math.ceil( uiSpinner.height() * 0.5 ) &&
				uiSpinner.height() > 0 ) {
			uiSpinner.height( uiSpinner.height() );
		}

		// disable spinner if element was already disabled
		if ( this.options.disabled ) {
			this.disable();
		}
	},

	_keydown: function( event ) {
		var options = this.options,
			keyCode = $.ui.keyCode;

		switch ( event.keyCode ) {
		case keyCode.UP:
			this._repeat( null, 1, event );
			return true;
		case keyCode.DOWN:
			this._repeat( null, -1, event );
			return true;
		case keyCode.PAGE_UP:
			this._repeat( null, options.page, event );
			return true;
		case keyCode.PAGE_DOWN:
			this._repeat( null, -options.page, event );
			return true;
		}

		return false;
	},

	_uiSpinnerHtml: function() {
		return "<span class='ui-spinner ui-widget ui-widget-content ui-corner-all'></span>";
	},

	_buttonHtml: function() {
		return "" +
			"<a class='ui-spinner-button ui-spinner-up ui-corner-tr'>" +
				"<span class='ui-icon " + this.options.icons.up + "'>&#9650;</span>" +
			"</a>" +
			"<a class='ui-spinner-button ui-spinner-down ui-corner-br'>" +
				"<span class='ui-icon " + this.options.icons.down + "'>&#9660;</span>" +
			"</a>";
	},

	_start: function( event ) {
		if ( !this.spinning && this._trigger( "start", event ) === false ) {
			return false;
		}

		if ( !this.counter ) {
			this.counter = 1;
		}
		this.spinning = true;
		return true;
	},

	_repeat: function( i, steps, event ) {
		i = i || 500;

		clearTimeout( this.timer );
		this.timer = this._delay(function() {
			this._repeat( 40, steps, event );
		}, i );

		this._spin( steps * this.options.step, event );
	},

	_spin: function( step, event ) {
		var value = this.value() || 0;

		if ( !this.counter ) {
			this.counter = 1;
		}

		value = this._adjustValue( value + step * this._increment( this.counter ) );

		if ( !this.spinning || this._trigger( "spin", event, { value: value } ) !== false) {
			this._value( value );
			this.counter++;
		}
	},

	_increment: function( i ) {
		var incremental = this.options.incremental;

		if ( incremental ) {
			return $.isFunction( incremental ) ?
				incremental( i ) :
				Math.floor( i * i * i / 50000 - i * i / 500 + 17 * i / 200 + 1 );
		}

		return 1;
	},

	_precision: function() {
		var precision = this._precisionOf( this.options.step );
		if ( this.options.min !== null ) {
			precision = Math.max( precision, this._precisionOf( this.options.min ) );
		}
		return precision;
	},

	_precisionOf: function( num ) {
		var str = num.toString(),
			decimal = str.indexOf( "." );
		return decimal === -1 ? 0 : str.length - decimal - 1;
	},

	_adjustValue: function( value ) {
		var base, aboveMin,
			options = this.options;

		// make sure we're at a valid step
		// - find out where we are relative to the base (min or 0)
		base = options.min !== null ? options.min : 0;
		aboveMin = value - base;
		// - round to the nearest step
		aboveMin = Math.round(aboveMin / options.step) * options.step;
		// - rounding is based on 0, so adjust back to our base
		value = base + aboveMin;

		// fix precision from bad JS floating point math
		value = parseFloat( value.toFixed( this._precision() ) );

		// clamp the value
		if ( options.max !== null && value > options.max) {
			return options.max;
		}
		if ( options.min !== null && value < options.min ) {
			return options.min;
		}

		return value;
	},

	_stop: function( event ) {
		if ( !this.spinning ) {
			return;
		}

		clearTimeout( this.timer );
		clearTimeout( this.mousewheelTimer );
		this.counter = 0;
		this.spinning = false;
		this._trigger( "stop", event );
	},

	_setOption: function( key, value ) {
		if ( key === "culture" || key === "numberFormat" ) {
			var prevValue = this._parse( this.element.val() );
			this.options[ key ] = value;
			this.element.val( this._format( prevValue ) );
			return;
		}

		if ( key === "max" || key === "min" || key === "step" ) {
			if ( typeof value === "string" ) {
				value = this._parse( value );
			}
		}
		if ( key === "icons" ) {
			this.buttons.first().find( ".ui-icon" )
				.removeClass( this.options.icons.up )
				.addClass( value.up );
			this.buttons.last().find( ".ui-icon" )
				.removeClass( this.options.icons.down )
				.addClass( value.down );
		}

		this._super( key, value );

		if ( key === "disabled" ) {
			this.widget().toggleClass( "ui-state-disabled", !!value );
			this.element.prop( "disabled", !!value );
			this.buttons.button( value ? "disable" : "enable" );
		}
	},

	_setOptions: spinner_modifier(function( options ) {
		this._super( options );
	}),

	_parse: function( val ) {
		if ( typeof val === "string" && val !== "" ) {
			val = window.Globalize && this.options.numberFormat ?
				Globalize.parseFloat( val, 10, this.options.culture ) : +val;
		}
		return val === "" || isNaN( val ) ? null : val;
	},

	_format: function( value ) {
		if ( value === "" ) {
			return "";
		}
		return window.Globalize && this.options.numberFormat ?
			Globalize.format( value, this.options.numberFormat, this.options.culture ) :
			value;
	},

	_refresh: function() {
		this.element.attr({
			"aria-valuemin": this.options.min,
			"aria-valuemax": this.options.max,
			// TODO: what should we do with values that can't be parsed?
			"aria-valuenow": this._parse( this.element.val() )
		});
	},

	isValid: function() {
		var value = this.value();

		// null is invalid
		if ( value === null ) {
			return false;
		}

		// if value gets adjusted, it's invalid
		return value === this._adjustValue( value );
	},

	// update the value without triggering change
	_value: function( value, allowAny ) {
		var parsed;
		if ( value !== "" ) {
			parsed = this._parse( value );
			if ( parsed !== null ) {
				if ( !allowAny ) {
					parsed = this._adjustValue( parsed );
				}
				value = this._format( parsed );
			}
		}
		this.element.val( value );
		this._refresh();
	},

	_destroy: function() {
		this.element
			.removeClass( "ui-spinner-input" )
			.prop( "disabled", false )
			.removeAttr( "autocomplete" )
			.removeAttr( "role" )
			.removeAttr( "aria-valuemin" )
			.removeAttr( "aria-valuemax" )
			.removeAttr( "aria-valuenow" );
		this.uiSpinner.replaceWith( this.element );
	},

	stepUp: spinner_modifier(function( steps ) {
		this._stepUp( steps );
	}),
	_stepUp: function( steps ) {
		if ( this._start() ) {
			this._spin( (steps || 1) * this.options.step );
			this._stop();
		}
	},

	stepDown: spinner_modifier(function( steps ) {
		this._stepDown( steps );
	}),
	_stepDown: function( steps ) {
		if ( this._start() ) {
			this._spin( (steps || 1) * -this.options.step );
			this._stop();
		}
	},

	pageUp: spinner_modifier(function( pages ) {
		this._stepUp( (pages || 1) * this.options.page );
	}),

	pageDown: spinner_modifier(function( pages ) {
		this._stepDown( (pages || 1) * this.options.page );
	}),

	value: function( newVal ) {
		if ( !arguments.length ) {
			return this._parse( this.element.val() );
		}
		spinner_modifier( this._value ).call( this, newVal );
	},

	widget: function() {
		return this.uiSpinner;
	}
});


/*!
 * jQuery UI Tabs 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/tabs/
 */


var tabs = $.widget( "ui.tabs", {
	version: "1.11.4",
	delay: 300,
	options: {
		active: null,
		collapsible: false,
		event: "click",
		heightStyle: "content",
		hide: null,
		show: null,

		// callbacks
		activate: null,
		beforeActivate: null,
		beforeLoad: null,
		load: null
	},

	_isLocal: (function() {
		var rhash = /#.*$/;

		return function( anchor ) {
			var anchorUrl, locationUrl;

			// support: IE7
			// IE7 doesn't normalize the href property when set via script (#9317)
			anchor = anchor.cloneNode( false );

			anchorUrl = anchor.href.replace( rhash, "" );
			locationUrl = location.href.replace( rhash, "" );

			// decoding may throw an error if the URL isn't UTF-8 (#9518)
			try {
				anchorUrl = decodeURIComponent( anchorUrl );
			} catch ( error ) {}
			try {
				locationUrl = decodeURIComponent( locationUrl );
			} catch ( error ) {}

			return anchor.hash.length > 1 && anchorUrl === locationUrl;
		};
	})(),

	_create: function() {
		var that = this,
			options = this.options;

		this.running = false;

		this.element
			.addClass( "ui-tabs ui-widget ui-widget-content ui-corner-all" )
			.toggleClass( "ui-tabs-collapsible", options.collapsible );

		this._processTabs();
		options.active = this._initialActive();

		// Take disabling tabs via class attribute from HTML
		// into account and update option properly.
		if ( $.isArray( options.disabled ) ) {
			options.disabled = $.unique( options.disabled.concat(
				$.map( this.tabs.filter( ".ui-state-disabled" ), function( li ) {
					return that.tabs.index( li );
				})
			) ).sort();
		}

		// check for length avoids error when initializing empty list
		if ( this.options.active !== false && this.anchors.length ) {
			this.active = this._findActive( options.active );
		} else {
			this.active = $();
		}

		this._refresh();

		if ( this.active.length ) {
			this.load( options.active );
		}
	},

	_initialActive: function() {
		var active = this.options.active,
			collapsible = this.options.collapsible,
			locationHash = location.hash.substring( 1 );

		if ( active === null ) {
			// check the fragment identifier in the URL
			if ( locationHash ) {
				this.tabs.each(function( i, tab ) {
					if ( $( tab ).attr( "aria-controls" ) === locationHash ) {
						active = i;
						return false;
					}
				});
			}

			// check for a tab marked active via a class
			if ( active === null ) {
				active = this.tabs.index( this.tabs.filter( ".ui-tabs-active" ) );
			}

			// no active tab, set to false
			if ( active === null || active === -1 ) {
				active = this.tabs.length ? 0 : false;
			}
		}

		// handle numbers: negative, out of range
		if ( active !== false ) {
			active = this.tabs.index( this.tabs.eq( active ) );
			if ( active === -1 ) {
				active = collapsible ? false : 0;
			}
		}

		// don't allow collapsible: false and active: false
		if ( !collapsible && active === false && this.anchors.length ) {
			active = 0;
		}

		return active;
	},

	_getCreateEventData: function() {
		return {
			tab: this.active,
			panel: !this.active.length ? $() : this._getPanelForTab( this.active )
		};
	},

	_tabKeydown: function( event ) {
		var focusedTab = $( this.document[0].activeElement ).closest( "li" ),
			selectedIndex = this.tabs.index( focusedTab ),
			goingForward = true;

		if ( this._handlePageNav( event ) ) {
			return;
		}

		switch ( event.keyCode ) {
			case $.ui.keyCode.RIGHT:
			case $.ui.keyCode.DOWN:
				selectedIndex++;
				break;
			case $.ui.keyCode.UP:
			case $.ui.keyCode.LEFT:
				goingForward = false;
				selectedIndex--;
				break;
			case $.ui.keyCode.END:
				selectedIndex = this.anchors.length - 1;
				break;
			case $.ui.keyCode.HOME:
				selectedIndex = 0;
				break;
			case $.ui.keyCode.SPACE:
				// Activate only, no collapsing
				event.preventDefault();
				clearTimeout( this.activating );
				this._activate( selectedIndex );
				return;
			case $.ui.keyCode.ENTER:
				// Toggle (cancel delayed activation, allow collapsing)
				event.preventDefault();
				clearTimeout( this.activating );
				// Determine if we should collapse or activate
				this._activate( selectedIndex === this.options.active ? false : selectedIndex );
				return;
			default:
				return;
		}

		// Focus the appropriate tab, based on which key was pressed
		event.preventDefault();
		clearTimeout( this.activating );
		selectedIndex = this._focusNextTab( selectedIndex, goingForward );

		// Navigating with control/command key will prevent automatic activation
		if ( !event.ctrlKey && !event.metaKey ) {

			// Update aria-selected immediately so that AT think the tab is already selected.
			// Otherwise AT may confuse the user by stating that they need to activate the tab,
			// but the tab will already be activated by the time the announcement finishes.
			focusedTab.attr( "aria-selected", "false" );
			this.tabs.eq( selectedIndex ).attr( "aria-selected", "true" );

			this.activating = this._delay(function() {
				this.option( "active", selectedIndex );
			}, this.delay );
		}
	},

	_panelKeydown: function( event ) {
		if ( this._handlePageNav( event ) ) {
			return;
		}

		// Ctrl+up moves focus to the current tab
		if ( event.ctrlKey && event.keyCode === $.ui.keyCode.UP ) {
			event.preventDefault();
			this.active.focus();
		}
	},

	// Alt+page up/down moves focus to the previous/next tab (and activates)
	_handlePageNav: function( event ) {
		if ( event.altKey && event.keyCode === $.ui.keyCode.PAGE_UP ) {
			this._activate( this._focusNextTab( this.options.active - 1, false ) );
			return true;
		}
		if ( event.altKey && event.keyCode === $.ui.keyCode.PAGE_DOWN ) {
			this._activate( this._focusNextTab( this.options.active + 1, true ) );
			return true;
		}
	},

	_findNextTab: function( index, goingForward ) {
		var lastTabIndex = this.tabs.length - 1;

		function constrain() {
			if ( index > lastTabIndex ) {
				index = 0;
			}
			if ( index < 0 ) {
				index = lastTabIndex;
			}
			return index;
		}

		while ( $.inArray( constrain(), this.options.disabled ) !== -1 ) {
			index = goingForward ? index + 1 : index - 1;
		}

		return index;
	},

	_focusNextTab: function( index, goingForward ) {
		index = this._findNextTab( index, goingForward );
		this.tabs.eq( index ).focus();
		return index;
	},

	_setOption: function( key, value ) {
		if ( key === "active" ) {
			// _activate() will handle invalid values and update this.options
			this._activate( value );
			return;
		}

		if ( key === "disabled" ) {
			// don't use the widget factory's disabled handling
			this._setupDisabled( value );
			return;
		}

		this._super( key, value);

		if ( key === "collapsible" ) {
			this.element.toggleClass( "ui-tabs-collapsible", value );
			// Setting collapsible: false while collapsed; open first panel
			if ( !value && this.options.active === false ) {
				this._activate( 0 );
			}
		}

		if ( key === "event" ) {
			this._setupEvents( value );
		}

		if ( key === "heightStyle" ) {
			this._setupHeightStyle( value );
		}
	},

	_sanitizeSelector: function( hash ) {
		return hash ? hash.replace( /[!"$%&'()*+,.\/:;<=>?@\[\]\^`{|}~]/g, "\\$&" ) : "";
	},

	refresh: function() {
		var options = this.options,
			lis = this.tablist.children( ":has(a[href])" );

		// get disabled tabs from class attribute from HTML
		// this will get converted to a boolean if needed in _refresh()
		options.disabled = $.map( lis.filter( ".ui-state-disabled" ), function( tab ) {
			return lis.index( tab );
		});

		this._processTabs();

		// was collapsed or no tabs
		if ( options.active === false || !this.anchors.length ) {
			options.active = false;
			this.active = $();
		// was active, but active tab is gone
		} else if ( this.active.length && !$.contains( this.tablist[ 0 ], this.active[ 0 ] ) ) {
			// all remaining tabs are disabled
			if ( this.tabs.length === options.disabled.length ) {
				options.active = false;
				this.active = $();
			// activate previous tab
			} else {
				this._activate( this._findNextTab( Math.max( 0, options.active - 1 ), false ) );
			}
		// was active, active tab still exists
		} else {
			// make sure active index is correct
			options.active = this.tabs.index( this.active );
		}

		this._refresh();
	},

	_refresh: function() {
		this._setupDisabled( this.options.disabled );
		this._setupEvents( this.options.event );
		this._setupHeightStyle( this.options.heightStyle );

		this.tabs.not( this.active ).attr({
			"aria-selected": "false",
			"aria-expanded": "false",
			tabIndex: -1
		});
		this.panels.not( this._getPanelForTab( this.active ) )
			.hide()
			.attr({
				"aria-hidden": "true"
			});

		// Make sure one tab is in the tab order
		if ( !this.active.length ) {
			this.tabs.eq( 0 ).attr( "tabIndex", 0 );
		} else {
			this.active
				.addClass( "ui-tabs-active ui-state-active" )
				.attr({
					"aria-selected": "true",
					"aria-expanded": "true",
					tabIndex: 0
				});
			this._getPanelForTab( this.active )
				.show()
				.attr({
					"aria-hidden": "false"
				});
		}
	},

	_processTabs: function() {
		var that = this,
			prevTabs = this.tabs,
			prevAnchors = this.anchors,
			prevPanels = this.panels;

		this.tablist = this._getList()
			.addClass( "ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all" )
			.attr( "role", "tablist" )

			// Prevent users from focusing disabled tabs via click
			.delegate( "> li", "mousedown" + this.eventNamespace, function( event ) {
				if ( $( this ).is( ".ui-state-disabled" ) ) {
					event.preventDefault();
				}
			})

			// support: IE <9
			// Preventing the default action in mousedown doesn't prevent IE
			// from focusing the element, so if the anchor gets focused, blur.
			// We don't have to worry about focusing the previously focused
			// element since clicking on a non-focusable element should focus
			// the body anyway.
			.delegate( ".ui-tabs-anchor", "focus" + this.eventNamespace, function() {
				if ( $( this ).closest( "li" ).is( ".ui-state-disabled" ) ) {
					this.blur();
				}
			});

		this.tabs = this.tablist.find( "> li:has(a[href])" )
			.addClass( "ui-state-default ui-corner-top" )
			.attr({
				role: "tab",
				tabIndex: -1
			});

		this.anchors = this.tabs.map(function() {
				return $( "a", this )[ 0 ];
			})
			.addClass( "ui-tabs-anchor" )
			.attr({
				role: "presentation",
				tabIndex: -1
			});

		this.panels = $();

		this.anchors.each(function( i, anchor ) {
			var selector, panel, panelId,
				anchorId = $( anchor ).uniqueId().attr( "id" ),
				tab = $( anchor ).closest( "li" ),
				originalAriaControls = tab.attr( "aria-controls" );

			// inline tab
			if ( that._isLocal( anchor ) ) {
				selector = anchor.hash;
				panelId = selector.substring( 1 );
				panel = that.element.find( that._sanitizeSelector( selector ) );
			// remote tab
			} else {
				// If the tab doesn't already have aria-controls,
				// generate an id by using a throw-away element
				panelId = tab.attr( "aria-controls" ) || $( {} ).uniqueId()[ 0 ].id;
				selector = "#" + panelId;
				panel = that.element.find( selector );
				if ( !panel.length ) {
					panel = that._createPanel( panelId );
					panel.insertAfter( that.panels[ i - 1 ] || that.tablist );
				}
				panel.attr( "aria-live", "polite" );
			}

			if ( panel.length) {
				that.panels = that.panels.add( panel );
			}
			if ( originalAriaControls ) {
				tab.data( "ui-tabs-aria-controls", originalAriaControls );
			}
			tab.attr({
				"aria-controls": panelId,
				"aria-labelledby": anchorId
			});
			panel.attr( "aria-labelledby", anchorId );
		});

		this.panels
			.addClass( "ui-tabs-panel ui-widget-content ui-corner-bottom" )
			.attr( "role", "tabpanel" );

		// Avoid memory leaks (#10056)
		if ( prevTabs ) {
			this._off( prevTabs.not( this.tabs ) );
			this._off( prevAnchors.not( this.anchors ) );
			this._off( prevPanels.not( this.panels ) );
		}
	},

	// allow overriding how to find the list for rare usage scenarios (#7715)
	_getList: function() {
		return this.tablist || this.element.find( "ol,ul" ).eq( 0 );
	},

	_createPanel: function( id ) {
		return $( "<div>" )
			.attr( "id", id )
			.addClass( "ui-tabs-panel ui-widget-content ui-corner-bottom" )
			.data( "ui-tabs-destroy", true );
	},

	_setupDisabled: function( disabled ) {
		if ( $.isArray( disabled ) ) {
			if ( !disabled.length ) {
				disabled = false;
			} else if ( disabled.length === this.anchors.length ) {
				disabled = true;
			}
		}

		// disable tabs
		for ( var i = 0, li; ( li = this.tabs[ i ] ); i++ ) {
			if ( disabled === true || $.inArray( i, disabled ) !== -1 ) {
				$( li )
					.addClass( "ui-state-disabled" )
					.attr( "aria-disabled", "true" );
			} else {
				$( li )
					.removeClass( "ui-state-disabled" )
					.removeAttr( "aria-disabled" );
			}
		}

		this.options.disabled = disabled;
	},

	_setupEvents: function( event ) {
		var events = {};
		if ( event ) {
			$.each( event.split(" "), function( index, eventName ) {
				events[ eventName ] = "_eventHandler";
			});
		}

		this._off( this.anchors.add( this.tabs ).add( this.panels ) );
		// Always prevent the default action, even when disabled
		this._on( true, this.anchors, {
			click: function( event ) {
				event.preventDefault();
			}
		});
		this._on( this.anchors, events );
		this._on( this.tabs, { keydown: "_tabKeydown" } );
		this._on( this.panels, { keydown: "_panelKeydown" } );

		this._focusable( this.tabs );
		this._hoverable( this.tabs );
	},

	_setupHeightStyle: function( heightStyle ) {
		var maxHeight,
			parent = this.element.parent();

		if ( heightStyle === "fill" ) {
			maxHeight = parent.height();
			maxHeight -= this.element.outerHeight() - this.element.height();

			this.element.siblings( ":visible" ).each(function() {
				var elem = $( this ),
					position = elem.css( "position" );

				if ( position === "absolute" || position === "fixed" ) {
					return;
				}
				maxHeight -= elem.outerHeight( true );
			});

			this.element.children().not( this.panels ).each(function() {
				maxHeight -= $( this ).outerHeight( true );
			});

			this.panels.each(function() {
				$( this ).height( Math.max( 0, maxHeight -
					$( this ).innerHeight() + $( this ).height() ) );
			})
			.css( "overflow", "auto" );
		} else if ( heightStyle === "auto" ) {
			maxHeight = 0;
			this.panels.each(function() {
				maxHeight = Math.max( maxHeight, $( this ).height( "" ).height() );
			}).height( maxHeight );
		}
	},

	_eventHandler: function( event ) {
		var options = this.options,
			active = this.active,
			anchor = $( event.currentTarget ),
			tab = anchor.closest( "li" ),
			clickedIsActive = tab[ 0 ] === active[ 0 ],
			collapsing = clickedIsActive && options.collapsible,
			toShow = collapsing ? $() : this._getPanelForTab( tab ),
			toHide = !active.length ? $() : this._getPanelForTab( active ),
			eventData = {
				oldTab: active,
				oldPanel: toHide,
				newTab: collapsing ? $() : tab,
				newPanel: toShow
			};

		event.preventDefault();

		if ( tab.hasClass( "ui-state-disabled" ) ||
				// tab is already loading
				tab.hasClass( "ui-tabs-loading" ) ||
				// can't switch durning an animation
				this.running ||
				// click on active header, but not collapsible
				( clickedIsActive && !options.collapsible ) ||
				// allow canceling activation
				( this._trigger( "beforeActivate", event, eventData ) === false ) ) {
			return;
		}

		options.active = collapsing ? false : this.tabs.index( tab );

		this.active = clickedIsActive ? $() : tab;
		if ( this.xhr ) {
			this.xhr.abort();
		}

		if ( !toHide.length && !toShow.length ) {
			$.error( "jQuery UI Tabs: Mismatching fragment identifier." );
		}

		if ( toShow.length ) {
			this.load( this.tabs.index( tab ), event );
		}
		this._toggle( event, eventData );
	},

	// handles show/hide for selecting tabs
	_toggle: function( event, eventData ) {
		var that = this,
			toShow = eventData.newPanel,
			toHide = eventData.oldPanel;

		this.running = true;

		function complete() {
			that.running = false;
			that._trigger( "activate", event, eventData );
		}

		function show() {
			eventData.newTab.closest( "li" ).addClass( "ui-tabs-active ui-state-active" );

			if ( toShow.length && that.options.show ) {
				that._show( toShow, that.options.show, complete );
			} else {
				toShow.show();
				complete();
			}
		}

		// start out by hiding, then showing, then completing
		if ( toHide.length && this.options.hide ) {
			this._hide( toHide, this.options.hide, function() {
				eventData.oldTab.closest( "li" ).removeClass( "ui-tabs-active ui-state-active" );
				show();
			});
		} else {
			eventData.oldTab.closest( "li" ).removeClass( "ui-tabs-active ui-state-active" );
			toHide.hide();
			show();
		}

		toHide.attr( "aria-hidden", "true" );
		eventData.oldTab.attr({
			"aria-selected": "false",
			"aria-expanded": "false"
		});
		// If we're switching tabs, remove the old tab from the tab order.
		// If we're opening from collapsed state, remove the previous tab from the tab order.
		// If we're collapsing, then keep the collapsing tab in the tab order.
		if ( toShow.length && toHide.length ) {
			eventData.oldTab.attr( "tabIndex", -1 );
		} else if ( toShow.length ) {
			this.tabs.filter(function() {
				return $( this ).attr( "tabIndex" ) === 0;
			})
			.attr( "tabIndex", -1 );
		}

		toShow.attr( "aria-hidden", "false" );
		eventData.newTab.attr({
			"aria-selected": "true",
			"aria-expanded": "true",
			tabIndex: 0
		});
	},

	_activate: function( index ) {
		var anchor,
			active = this._findActive( index );

		// trying to activate the already active panel
		if ( active[ 0 ] === this.active[ 0 ] ) {
			return;
		}

		// trying to collapse, simulate a click on the current active header
		if ( !active.length ) {
			active = this.active;
		}

		anchor = active.find( ".ui-tabs-anchor" )[ 0 ];
		this._eventHandler({
			target: anchor,
			currentTarget: anchor,
			preventDefault: $.noop
		});
	},

	_findActive: function( index ) {
		return index === false ? $() : this.tabs.eq( index );
	},

	_getIndex: function( index ) {
		// meta-function to give users option to provide a href string instead of a numerical index.
		if ( typeof index === "string" ) {
			index = this.anchors.index( this.anchors.filter( "[href$='" + index + "']" ) );
		}

		return index;
	},

	_destroy: function() {
		if ( this.xhr ) {
			this.xhr.abort();
		}

		this.element.removeClass( "ui-tabs ui-widget ui-widget-content ui-corner-all ui-tabs-collapsible" );

		this.tablist
			.removeClass( "ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all" )
			.removeAttr( "role" );

		this.anchors
			.removeClass( "ui-tabs-anchor" )
			.removeAttr( "role" )
			.removeAttr( "tabIndex" )
			.removeUniqueId();

		this.tablist.unbind( this.eventNamespace );

		this.tabs.add( this.panels ).each(function() {
			if ( $.data( this, "ui-tabs-destroy" ) ) {
				$( this ).remove();
			} else {
				$( this )
					.removeClass( "ui-state-default ui-state-active ui-state-disabled " +
						"ui-corner-top ui-corner-bottom ui-widget-content ui-tabs-active ui-tabs-panel" )
					.removeAttr( "tabIndex" )
					.removeAttr( "aria-live" )
					.removeAttr( "aria-busy" )
					.removeAttr( "aria-selected" )
					.removeAttr( "aria-labelledby" )
					.removeAttr( "aria-hidden" )
					.removeAttr( "aria-expanded" )
					.removeAttr( "role" );
			}
		});

		this.tabs.each(function() {
			var li = $( this ),
				prev = li.data( "ui-tabs-aria-controls" );
			if ( prev ) {
				li
					.attr( "aria-controls", prev )
					.removeData( "ui-tabs-aria-controls" );
			} else {
				li.removeAttr( "aria-controls" );
			}
		});

		this.panels.show();

		if ( this.options.heightStyle !== "content" ) {
			this.panels.css( "height", "" );
		}
	},

	enable: function( index ) {
		var disabled = this.options.disabled;
		if ( disabled === false ) {
			return;
		}

		if ( index === undefined ) {
			disabled = false;
		} else {
			index = this._getIndex( index );
			if ( $.isArray( disabled ) ) {
				disabled = $.map( disabled, function( num ) {
					return num !== index ? num : null;
				});
			} else {
				disabled = $.map( this.tabs, function( li, num ) {
					return num !== index ? num : null;
				});
			}
		}
		this._setupDisabled( disabled );
	},

	disable: function( index ) {
		var disabled = this.options.disabled;
		if ( disabled === true ) {
			return;
		}

		if ( index === undefined ) {
			disabled = true;
		} else {
			index = this._getIndex( index );
			if ( $.inArray( index, disabled ) !== -1 ) {
				return;
			}
			if ( $.isArray( disabled ) ) {
				disabled = $.merge( [ index ], disabled ).sort();
			} else {
				disabled = [ index ];
			}
		}
		this._setupDisabled( disabled );
	},

	load: function( index, event ) {
		index = this._getIndex( index );
		var that = this,
			tab = this.tabs.eq( index ),
			anchor = tab.find( ".ui-tabs-anchor" ),
			panel = this._getPanelForTab( tab ),
			eventData = {
				tab: tab,
				panel: panel
			},
			complete = function( jqXHR, status ) {
				if ( status === "abort" ) {
					that.panels.stop( false, true );
				}

				tab.removeClass( "ui-tabs-loading" );
				panel.removeAttr( "aria-busy" );

				if ( jqXHR === that.xhr ) {
					delete that.xhr;
				}
			};

		// not remote
		if ( this._isLocal( anchor[ 0 ] ) ) {
			return;
		}

		this.xhr = $.ajax( this._ajaxSettings( anchor, event, eventData ) );

		// support: jQuery <1.8
		// jQuery <1.8 returns false if the request is canceled in beforeSend,
		// but as of 1.8, $.ajax() always returns a jqXHR object.
		if ( this.xhr && this.xhr.statusText !== "canceled" ) {
			tab.addClass( "ui-tabs-loading" );
			panel.attr( "aria-busy", "true" );

			this.xhr
				.done(function( response, status, jqXHR ) {
					// support: jQuery <1.8
					// http://bugs.jquery.com/ticket/11778
					setTimeout(function() {
						panel.html( response );
						that._trigger( "load", event, eventData );

						complete( jqXHR, status );
					}, 1 );
				})
				.fail(function( jqXHR, status ) {
					// support: jQuery <1.8
					// http://bugs.jquery.com/ticket/11778
					setTimeout(function() {
						complete( jqXHR, status );
					}, 1 );
				});
		}
	},

	_ajaxSettings: function( anchor, event, eventData ) {
		var that = this;
		return {
			url: anchor.attr( "href" ),
			beforeSend: function( jqXHR, settings ) {
				return that._trigger( "beforeLoad", event,
					$.extend( { jqXHR: jqXHR, ajaxSettings: settings }, eventData ) );
			}
		};
	},

	_getPanelForTab: function( tab ) {
		var id = $( tab ).attr( "aria-controls" );
		return this.element.find( this._sanitizeSelector( "#" + id ) );
	}
});


/*!
 * jQuery UI Tooltip 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/tooltip/
 */


var tooltip = $.widget( "ui.tooltip", {
	version: "1.11.4",
	options: {
		content: function() {
			// support: IE<9, Opera in jQuery <1.7
			// .text() can't accept undefined, so coerce to a string
			var title = $( this ).attr( "title" ) || "";
			// Escape title, since we're going from an attribute to raw HTML
			return $( "<a>" ).text( title ).html();
		},
		hide: true,
		// Disabled elements have inconsistent behavior across browsers (#8661)
		items: "[title]:not([disabled])",
		position: {
			my: "left top+15",
			at: "left bottom",
			collision: "flipfit flip"
		},
		show: true,
		tooltipClass: null,
		track: false,

		// callbacks
		close: null,
		open: null
	},

	_addDescribedBy: function( elem, id ) {
		var describedby = (elem.attr( "aria-describedby" ) || "").split( /\s+/ );
		describedby.push( id );
		elem
			.data( "ui-tooltip-id", id )
			.attr( "aria-describedby", $.trim( describedby.join( " " ) ) );
	},

	_removeDescribedBy: function( elem ) {
		var id = elem.data( "ui-tooltip-id" ),
			describedby = (elem.attr( "aria-describedby" ) || "").split( /\s+/ ),
			index = $.inArray( id, describedby );

		if ( index !== -1 ) {
			describedby.splice( index, 1 );
		}

		elem.removeData( "ui-tooltip-id" );
		describedby = $.trim( describedby.join( " " ) );
		if ( describedby ) {
			elem.attr( "aria-describedby", describedby );
		} else {
			elem.removeAttr( "aria-describedby" );
		}
	},

	_create: function() {
		this._on({
			mouseover: "open",
			focusin: "open"
		});

		// IDs of generated tooltips, needed for destroy
		this.tooltips = {};

		// IDs of parent tooltips where we removed the title attribute
		this.parents = {};

		if ( this.options.disabled ) {
			this._disable();
		}

		// Append the aria-live region so tooltips announce correctly
		this.liveRegion = $( "<div>" )
			.attr({
				role: "log",
				"aria-live": "assertive",
				"aria-relevant": "additions"
			})
			.addClass( "ui-helper-hidden-accessible" )
			.appendTo( this.document[ 0 ].body );
	},

	_setOption: function( key, value ) {
		var that = this;

		if ( key === "disabled" ) {
			this[ value ? "_disable" : "_enable" ]();
			this.options[ key ] = value;
			// disable element style changes
			return;
		}

		this._super( key, value );

		if ( key === "content" ) {
			$.each( this.tooltips, function( id, tooltipData ) {
				that._updateContent( tooltipData.element );
			});
		}
	},

	_disable: function() {
		var that = this;

		// close open tooltips
		$.each( this.tooltips, function( id, tooltipData ) {
			var event = $.Event( "blur" );
			event.target = event.currentTarget = tooltipData.element[ 0 ];
			that.close( event, true );
		});

		// remove title attributes to prevent native tooltips
		this.element.find( this.options.items ).addBack().each(function() {
			var element = $( this );
			if ( element.is( "[title]" ) ) {
				element
					.data( "ui-tooltip-title", element.attr( "title" ) )
					.removeAttr( "title" );
			}
		});
	},

	_enable: function() {
		// restore title attributes
		this.element.find( this.options.items ).addBack().each(function() {
			var element = $( this );
			if ( element.data( "ui-tooltip-title" ) ) {
				element.attr( "title", element.data( "ui-tooltip-title" ) );
			}
		});
	},

	open: function( event ) {
		var that = this,
			target = $( event ? event.target : this.element )
				// we need closest here due to mouseover bubbling,
				// but always pointing at the same event target
				.closest( this.options.items );

		// No element to show a tooltip for or the tooltip is already open
		if ( !target.length || target.data( "ui-tooltip-id" ) ) {
			return;
		}

		if ( target.attr( "title" ) ) {
			target.data( "ui-tooltip-title", target.attr( "title" ) );
		}

		target.data( "ui-tooltip-open", true );

		// kill parent tooltips, custom or native, for hover
		if ( event && event.type === "mouseover" ) {
			target.parents().each(function() {
				var parent = $( this ),
					blurEvent;
				if ( parent.data( "ui-tooltip-open" ) ) {
					blurEvent = $.Event( "blur" );
					blurEvent.target = blurEvent.currentTarget = this;
					that.close( blurEvent, true );
				}
				if ( parent.attr( "title" ) ) {
					parent.uniqueId();
					that.parents[ this.id ] = {
						element: this,
						title: parent.attr( "title" )
					};
					parent.attr( "title", "" );
				}
			});
		}

		this._registerCloseHandlers( event, target );
		this._updateContent( target, event );
	},

	_updateContent: function( target, event ) {
		var content,
			contentOption = this.options.content,
			that = this,
			eventType = event ? event.type : null;

		if ( typeof contentOption === "string" ) {
			return this._open( event, target, contentOption );
		}

		content = contentOption.call( target[0], function( response ) {

			// IE may instantly serve a cached response for ajax requests
			// delay this call to _open so the other call to _open runs first
			that._delay(function() {

				// Ignore async response if tooltip was closed already
				if ( !target.data( "ui-tooltip-open" ) ) {
					return;
				}

				// jQuery creates a special event for focusin when it doesn't
				// exist natively. To improve performance, the native event
				// object is reused and the type is changed. Therefore, we can't
				// rely on the type being correct after the event finished
				// bubbling, so we set it back to the previous value. (#8740)
				if ( event ) {
					event.type = eventType;
				}
				this._open( event, target, response );
			});
		});
		if ( content ) {
			this._open( event, target, content );
		}
	},

	_open: function( event, target, content ) {
		var tooltipData, tooltip, delayedShow, a11yContent,
			positionOption = $.extend( {}, this.options.position );

		if ( !content ) {
			return;
		}

		// Content can be updated multiple times. If the tooltip already
		// exists, then just update the content and bail.
		tooltipData = this._find( target );
		if ( tooltipData ) {
			tooltipData.tooltip.find( ".ui-tooltip-content" ).html( content );
			return;
		}

		// if we have a title, clear it to prevent the native tooltip
		// we have to check first to avoid defining a title if none exists
		// (we don't want to cause an element to start matching [title])
		//
		// We use removeAttr only for key events, to allow IE to export the correct
		// accessible attributes. For mouse events, set to empty string to avoid
		// native tooltip showing up (happens only when removing inside mouseover).
		if ( target.is( "[title]" ) ) {
			if ( event && event.type === "mouseover" ) {
				target.attr( "title", "" );
			} else {
				target.removeAttr( "title" );
			}
		}

		tooltipData = this._tooltip( target );
		tooltip = tooltipData.tooltip;
		this._addDescribedBy( target, tooltip.attr( "id" ) );
		tooltip.find( ".ui-tooltip-content" ).html( content );

		// Support: Voiceover on OS X, JAWS on IE <= 9
		// JAWS announces deletions even when aria-relevant="additions"
		// Voiceover will sometimes re-read the entire log region's contents from the beginning
		this.liveRegion.children().hide();
		if ( content.clone ) {
			a11yContent = content.clone();
			a11yContent.removeAttr( "id" ).find( "[id]" ).removeAttr( "id" );
		} else {
			a11yContent = content;
		}
		$( "<div>" ).html( a11yContent ).appendTo( this.liveRegion );

		function position( event ) {
			positionOption.of = event;
			if ( tooltip.is( ":hidden" ) ) {
				return;
			}
			tooltip.position( positionOption );
		}
		if ( this.options.track && event && /^mouse/.test( event.type ) ) {
			this._on( this.document, {
				mousemove: position
			});
			// trigger once to override element-relative positioning
			position( event );
		} else {
			tooltip.position( $.extend({
				of: target
			}, this.options.position ) );
		}

		tooltip.hide();

		this._show( tooltip, this.options.show );
		// Handle tracking tooltips that are shown with a delay (#8644). As soon
		// as the tooltip is visible, position the tooltip using the most recent
		// event.
		if ( this.options.show && this.options.show.delay ) {
			delayedShow = this.delayedShow = setInterval(function() {
				if ( tooltip.is( ":visible" ) ) {
					position( positionOption.of );
					clearInterval( delayedShow );
				}
			}, $.fx.interval );
		}

		this._trigger( "open", event, { tooltip: tooltip } );
	},

	_registerCloseHandlers: function( event, target ) {
		var events = {
			keyup: function( event ) {
				if ( event.keyCode === $.ui.keyCode.ESCAPE ) {
					var fakeEvent = $.Event(event);
					fakeEvent.currentTarget = target[0];
					this.close( fakeEvent, true );
				}
			}
		};

		// Only bind remove handler for delegated targets. Non-delegated
		// tooltips will handle this in destroy.
		if ( target[ 0 ] !== this.element[ 0 ] ) {
			events.remove = function() {
				this._removeTooltip( this._find( target ).tooltip );
			};
		}

		if ( !event || event.type === "mouseover" ) {
			events.mouseleave = "close";
		}
		if ( !event || event.type === "focusin" ) {
			events.focusout = "close";
		}
		this._on( true, target, events );
	},

	close: function( event ) {
		var tooltip,
			that = this,
			target = $( event ? event.currentTarget : this.element ),
			tooltipData = this._find( target );

		// The tooltip may already be closed
		if ( !tooltipData ) {

			// We set ui-tooltip-open immediately upon open (in open()), but only set the
			// additional data once there's actually content to show (in _open()). So even if the
			// tooltip doesn't have full data, we always remove ui-tooltip-open in case we're in
			// the period between open() and _open().
			target.removeData( "ui-tooltip-open" );
			return;
		}

		tooltip = tooltipData.tooltip;

		// disabling closes the tooltip, so we need to track when we're closing
		// to avoid an infinite loop in case the tooltip becomes disabled on close
		if ( tooltipData.closing ) {
			return;
		}

		// Clear the interval for delayed tracking tooltips
		clearInterval( this.delayedShow );

		// only set title if we had one before (see comment in _open())
		// If the title attribute has changed since open(), don't restore
		if ( target.data( "ui-tooltip-title" ) && !target.attr( "title" ) ) {
			target.attr( "title", target.data( "ui-tooltip-title" ) );
		}

		this._removeDescribedBy( target );

		tooltipData.hiding = true;
		tooltip.stop( true );
		this._hide( tooltip, this.options.hide, function() {
			that._removeTooltip( $( this ) );
		});

		target.removeData( "ui-tooltip-open" );
		this._off( target, "mouseleave focusout keyup" );

		// Remove 'remove' binding only on delegated targets
		if ( target[ 0 ] !== this.element[ 0 ] ) {
			this._off( target, "remove" );
		}
		this._off( this.document, "mousemove" );

		if ( event && event.type === "mouseleave" ) {
			$.each( this.parents, function( id, parent ) {
				$( parent.element ).attr( "title", parent.title );
				delete that.parents[ id ];
			});
		}

		tooltipData.closing = true;
		this._trigger( "close", event, { tooltip: tooltip } );
		if ( !tooltipData.hiding ) {
			tooltipData.closing = false;
		}
	},

	_tooltip: function( element ) {
		var tooltip = $( "<div>" )
				.attr( "role", "tooltip" )
				.addClass( "ui-tooltip ui-widget ui-corner-all ui-widget-content " +
					( this.options.tooltipClass || "" ) ),
			id = tooltip.uniqueId().attr( "id" );

		$( "<div>" )
			.addClass( "ui-tooltip-content" )
			.appendTo( tooltip );

		tooltip.appendTo( this.document[0].body );

		return this.tooltips[ id ] = {
			element: element,
			tooltip: tooltip
		};
	},

	_find: function( target ) {
		var id = target.data( "ui-tooltip-id" );
		return id ? this.tooltips[ id ] : null;
	},

	_removeTooltip: function( tooltip ) {
		tooltip.remove();
		delete this.tooltips[ tooltip.attr( "id" ) ];
	},

	_destroy: function() {
		var that = this;

		// close open tooltips
		$.each( this.tooltips, function( id, tooltipData ) {
			// Delegate to close method to handle common cleanup
			var event = $.Event( "blur" ),
				element = tooltipData.element;
			event.target = event.currentTarget = element[ 0 ];
			that.close( event, true );

			// Remove immediately; destroying an open tooltip doesn't use the
			// hide animation
			$( "#" + id ).remove();

			// Restore the title
			if ( element.data( "ui-tooltip-title" ) ) {
				// If the title attribute has changed since open(), don't restore
				if ( !element.attr( "title" ) ) {
					element.attr( "title", element.data( "ui-tooltip-title" ) );
				}
				element.removeData( "ui-tooltip-title" );
			}
		});
		this.liveRegion.remove();
	}
});



}));
},{}],456:[function(require,module,exports){

(function() {
  var Dragster,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  Dragster = (function() {
    function Dragster(el) {
      this.el = el;
      this.dragleave = __bind(this.dragleave, this);
      this.dragenter = __bind(this.dragenter, this);
      if (this.supportsEventConstructors()) {
        this.first = false;
        this.second = false;
        this.el.addEventListener("dragenter", this.dragenter, false);
        this.el.addEventListener("dragleave", this.dragleave, false);
      }
    }

    Dragster.prototype.dragenter = function(event) {
      if (this.first) {
        return this.second = true;
      } else {
        this.first = true;
        return this.el.dispatchEvent(new CustomEvent("dragster:enter", {
          bubbles: true,
          cancelable: true,
          detail: {
            dataTransfer: event.dataTransfer
          }
        }));
      }
    };

    Dragster.prototype.dragleave = function(event) {
      if (this.second) {
        this.second = false;
      } else if (this.first) {
        this.first = false;
      }
      if (!this.first && !this.second) {
        return this.el.dispatchEvent(new CustomEvent("dragster:leave", {
          bubbles: true,
          cancelable: true,
          detail: {
            dataTransfer: event.dataTransfer
          }
        }));
      }
    };

    Dragster.prototype.removeListeners = function() {
      this.el.removeEventListener("dragenter", this.dragenter, false);
      return this.el.removeEventListener("dragleave", this.dragleave, false);
    };

    Dragster.prototype.supportsEventConstructors = function() {
      try {
        new CustomEvent("z");
      } catch (_error) {
        return false;
      }
      return true;
    };

    Dragster.prototype.reset = function() {
      this.first = false;
      return this.second = false;
    };

    return Dragster;

  })();

  window.Dragster = Dragster;

}).call(this);

},{}],457:[function(require,module,exports){

/*
 *
 * More info at [www.dropzonejs.com](http://www.dropzonejs.com)
 *
 * Copyright (c) 2012, Matias Meno
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *
 */

(function() {
  var Dropzone, Emitter, camelize, contentLoaded, detectVerticalSquash, drawImageIOSFix, noop, without,
    __slice = [].slice,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  noop = function() {};

  Emitter = (function() {
    function Emitter() {}

    Emitter.prototype.addEventListener = Emitter.prototype.on;

    Emitter.prototype.on = function(event, fn) {
      this._callbacks = this._callbacks || {};
      if (!this._callbacks[event]) {
        this._callbacks[event] = [];
      }
      this._callbacks[event].push(fn);
      return this;
    };

    Emitter.prototype.emit = function() {
      var args, callback, callbacks, event, _i, _len;
      event = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      this._callbacks = this._callbacks || {};
      callbacks = this._callbacks[event];
      if (callbacks) {
        for (_i = 0, _len = callbacks.length; _i < _len; _i++) {
          callback = callbacks[_i];
          callback.apply(this, args);
        }
      }
      return this;
    };

    Emitter.prototype.removeListener = Emitter.prototype.off;

    Emitter.prototype.removeAllListeners = Emitter.prototype.off;

    Emitter.prototype.removeEventListener = Emitter.prototype.off;

    Emitter.prototype.off = function(event, fn) {
      var callback, callbacks, i, _i, _len;
      if (!this._callbacks || arguments.length === 0) {
        this._callbacks = {};
        return this;
      }
      callbacks = this._callbacks[event];
      if (!callbacks) {
        return this;
      }
      if (arguments.length === 1) {
        delete this._callbacks[event];
        return this;
      }
      for (i = _i = 0, _len = callbacks.length; _i < _len; i = ++_i) {
        callback = callbacks[i];
        if (callback === fn) {
          callbacks.splice(i, 1);
          break;
        }
      }
      return this;
    };

    return Emitter;

  })();

  Dropzone = (function(_super) {
    var extend, resolveOption;

    __extends(Dropzone, _super);

    Dropzone.prototype.Emitter = Emitter;


    /*
    This is a list of all available events you can register on a dropzone object.
    
    You can register an event handler like this:
    
        dropzone.on("dragEnter", function() { });
     */

    Dropzone.prototype.events = ["drop", "dragstart", "dragend", "dragenter", "dragover", "dragleave", "addedfile", "removedfile", "thumbnail", "error", "errormultiple", "processing", "processingmultiple", "uploadprogress", "totaluploadprogress", "sending", "sendingmultiple", "success", "successmultiple", "canceled", "canceledmultiple", "complete", "completemultiple", "reset", "maxfilesexceeded", "maxfilesreached", "queuecomplete"];

    Dropzone.prototype.defaultOptions = {
      url: null,
      method: "post",
      withCredentials: false,
      parallelUploads: 2,
      uploadMultiple: false,
      maxFilesize: 256,
      paramName: "file",
      createImageThumbnails: true,
      maxThumbnailFilesize: 10,
      thumbnailWidth: 120,
      thumbnailHeight: 120,
      filesizeBase: 1000,
      maxFiles: null,
      filesizeBase: 1000,
      params: {},
      clickable: true,
      ignoreHiddenFiles: true,
      acceptedFiles: null,
      acceptedMimeTypes: null,
      autoProcessQueue: true,
      autoQueue: true,
      addRemoveLinks: false,
      previewsContainer: null,
      capture: null,
      dictDefaultMessage: "Drop files here to upload",
      dictFallbackMessage: "Your browser does not support drag'n'drop file uploads.",
      dictFallbackText: "Please use the fallback form below to upload your files like in the olden days.",
      dictFileTooBig: "File is too big ({{filesize}}MiB). Max filesize: {{maxFilesize}}MiB.",
      dictInvalidFileType: "You can't upload files of this type.",
      dictResponseError: "Server responded with {{statusCode}} code.",
      dictCancelUpload: "Cancel upload",
      dictCancelUploadConfirmation: "Are you sure you want to cancel this upload?",
      dictRemoveFile: "Remove file",
      dictRemoveFileConfirmation: null,
      dictMaxFilesExceeded: "You can not upload any more files.",
      accept: function(file, done) {
        return done();
      },
      init: function() {
        return noop;
      },
      forceFallback: false,
      fallback: function() {
        var child, messageElement, span, _i, _len, _ref;
        this.element.className = "" + this.element.className + " dz-browser-not-supported";
        _ref = this.element.getElementsByTagName("div");
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          child = _ref[_i];
          if (/(^| )dz-message($| )/.test(child.className)) {
            messageElement = child;
            child.className = "dz-message";
            continue;
          }
        }
        if (!messageElement) {
          messageElement = Dropzone.createElement("<div class=\"dz-message\"><span></span></div>");
          this.element.appendChild(messageElement);
        }
        span = messageElement.getElementsByTagName("span")[0];
        if (span) {
          span.textContent = this.options.dictFallbackMessage;
        }
        return this.element.appendChild(this.getFallbackForm());
      },
      resize: function(file) {
        var info, srcRatio, trgRatio;
        info = {
          srcX: 0,
          srcY: 0,
          srcWidth: file.width,
          srcHeight: file.height
        };
        srcRatio = file.width / file.height;
        info.optWidth = this.options.thumbnailWidth;
        info.optHeight = this.options.thumbnailHeight;
        if ((info.optWidth == null) && (info.optHeight == null)) {
          info.optWidth = info.srcWidth;
          info.optHeight = info.srcHeight;
        } else if (info.optWidth == null) {
          info.optWidth = srcRatio * info.optHeight;
        } else if (info.optHeight == null) {
          info.optHeight = (1 / srcRatio) * info.optWidth;
        }
        trgRatio = info.optWidth / info.optHeight;
        if (file.height < info.optHeight || file.width < info.optWidth) {
          info.trgHeight = info.srcHeight;
          info.trgWidth = info.srcWidth;
        } else {
          if (srcRatio > trgRatio) {
            info.srcHeight = file.height;
            info.srcWidth = info.srcHeight * trgRatio;
          } else {
            info.srcWidth = file.width;
            info.srcHeight = info.srcWidth / trgRatio;
          }
        }
        info.srcX = (file.width - info.srcWidth) / 2;
        info.srcY = (file.height - info.srcHeight) / 2;
        return info;
      },

      /*
      Those functions register themselves to the events on init and handle all
      the user interface specific stuff. Overwriting them won't break the upload
      but can break the way it's displayed.
      You can overwrite them if you don't like the default behavior. If you just
      want to add an additional event handler, register it on the dropzone object
      and don't overwrite those options.
       */
      drop: function(e) {
        return this.element.classList.remove("dz-drag-hover");
      },
      dragstart: noop,
      dragend: function(e) {
        return this.element.classList.remove("dz-drag-hover");
      },
      dragenter: function(e) {
        return this.element.classList.add("dz-drag-hover");
      },
      dragover: function(e) {
        return this.element.classList.add("dz-drag-hover");
      },
      dragleave: function(e) {
        return this.element.classList.remove("dz-drag-hover");
      },
      paste: noop,
      reset: function() {
        return this.element.classList.remove("dz-started");
      },
      addedfile: function(file) {
        var node, removeFileEvent, removeLink, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref2, _results;
        if (this.element === this.previewsContainer) {
          this.element.classList.add("dz-started");
        }
        if (this.previewsContainer) {
          file.previewElement = Dropzone.createElement(this.options.previewTemplate.trim());
          file.previewTemplate = file.previewElement;
          this.previewsContainer.appendChild(file.previewElement);
          _ref = file.previewElement.querySelectorAll("[data-dz-name]");
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            node = _ref[_i];
            node.textContent = file.name;
          }
          _ref1 = file.previewElement.querySelectorAll("[data-dz-size]");
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            node = _ref1[_j];
            node.innerHTML = this.filesize(file.size);
          }
          if (this.options.addRemoveLinks) {
            file._removeLink = Dropzone.createElement("<a class=\"dz-remove\" href=\"javascript:undefined;\" data-dz-remove>" + this.options.dictRemoveFile + "</a>");
            file.previewElement.appendChild(file._removeLink);
          }
          removeFileEvent = (function(_this) {
            return function(e) {
              e.preventDefault();
              e.stopPropagation();
              if (file.status === Dropzone.UPLOADING) {
                return Dropzone.confirm(_this.options.dictCancelUploadConfirmation, function() {
                  return _this.removeFile(file);
                });
              } else {
                if (_this.options.dictRemoveFileConfirmation) {
                  return Dropzone.confirm(_this.options.dictRemoveFileConfirmation, function() {
                    return _this.removeFile(file);
                  });
                } else {
                  return _this.removeFile(file);
                }
              }
            };
          })(this);
          _ref2 = file.previewElement.querySelectorAll("[data-dz-remove]");
          _results = [];
          for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
            removeLink = _ref2[_k];
            _results.push(removeLink.addEventListener("click", removeFileEvent));
          }
          return _results;
        }
      },
      removedfile: function(file) {
        var _ref;
        if (file.previewElement) {
          if ((_ref = file.previewElement) != null) {
            _ref.parentNode.removeChild(file.previewElement);
          }
        }
        return this._updateMaxFilesReachedClass();
      },
      thumbnail: function(file, dataUrl) {
        var thumbnailElement, _i, _len, _ref;
        if (file.previewElement) {
          file.previewElement.classList.remove("dz-file-preview");
          _ref = file.previewElement.querySelectorAll("[data-dz-thumbnail]");
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            thumbnailElement = _ref[_i];
            thumbnailElement.alt = file.name;
            thumbnailElement.src = dataUrl;
          }
          return setTimeout(((function(_this) {
            return function() {
              return file.previewElement.classList.add("dz-image-preview");
            };
          })(this)), 1);
        }
      },
      error: function(file, message) {
        var node, _i, _len, _ref, _results;
        if (file.previewElement) {
          file.previewElement.classList.add("dz-error");
          if (typeof message !== "String" && message.error) {
            message = message.error;
          }
          _ref = file.previewElement.querySelectorAll("[data-dz-errormessage]");
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            node = _ref[_i];
            _results.push(node.textContent = message);
          }
          return _results;
        }
      },
      errormultiple: noop,
      processing: function(file) {
        if (file.previewElement) {
          file.previewElement.classList.add("dz-processing");
          if (file._removeLink) {
            return file._removeLink.textContent = this.options.dictCancelUpload;
          }
        }
      },
      processingmultiple: noop,
      uploadprogress: function(file, progress, bytesSent) {
        var node, _i, _len, _ref, _results;
        if (file.previewElement) {
          _ref = file.previewElement.querySelectorAll("[data-dz-uploadprogress]");
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            node = _ref[_i];
            if (node.nodeName === 'PROGRESS') {
              _results.push(node.value = progress);
            } else {
              _results.push(node.style.width = "" + progress + "%");
            }
          }
          return _results;
        }
      },
      totaluploadprogress: noop,
      sending: noop,
      sendingmultiple: noop,
      success: function(file) {
        if (file.previewElement) {
          return file.previewElement.classList.add("dz-success");
        }
      },
      successmultiple: noop,
      canceled: function(file) {
        return this.emit("error", file, "Upload canceled.");
      },
      canceledmultiple: noop,
      complete: function(file) {
        if (file._removeLink) {
          file._removeLink.textContent = this.options.dictRemoveFile;
        }
        if (file.previewElement) {
          return file.previewElement.classList.add("dz-complete");
        }
      },
      completemultiple: noop,
      maxfilesexceeded: noop,
      maxfilesreached: noop,
      queuecomplete: noop,
      previewTemplate: "<div class=\"dz-preview dz-file-preview\">\n  <div class=\"dz-image\"><img data-dz-thumbnail /></div>\n  <div class=\"dz-details\">\n    <div class=\"dz-size\"><span data-dz-size></span></div>\n    <div class=\"dz-filename\"><span data-dz-name></span></div>\n  </div>\n  <div class=\"dz-progress\"><span class=\"dz-upload\" data-dz-uploadprogress></span></div>\n  <div class=\"dz-error-message\"><span data-dz-errormessage></span></div>\n  <div class=\"dz-success-mark\">\n    <svg width=\"54px\" height=\"54px\" viewBox=\"0 0 54 54\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" xmlns:sketch=\"http://www.bohemiancoding.com/sketch/ns\">\n      <title>Check</title>\n      <defs></defs>\n      <g id=\"Page-1\" stroke=\"none\" stroke-width=\"1\" fill=\"none\" fill-rule=\"evenodd\" sketch:type=\"MSPage\">\n        <path d=\"M23.5,31.8431458 L17.5852419,25.9283877 C16.0248253,24.3679711 13.4910294,24.366835 11.9289322,25.9289322 C10.3700136,27.4878508 10.3665912,30.0234455 11.9283877,31.5852419 L20.4147581,40.0716123 C20.5133999,40.1702541 20.6159315,40.2626649 20.7218615,40.3488435 C22.2835669,41.8725651 24.794234,41.8626202 26.3461564,40.3106978 L43.3106978,23.3461564 C44.8771021,21.7797521 44.8758057,19.2483887 43.3137085,17.6862915 C41.7547899,16.1273729 39.2176035,16.1255422 37.6538436,17.6893022 L23.5,31.8431458 Z M27,53 C41.3594035,53 53,41.3594035 53,27 C53,12.6405965 41.3594035,1 27,1 C12.6405965,1 1,12.6405965 1,27 C1,41.3594035 12.6405965,53 27,53 Z\" id=\"Oval-2\" stroke-opacity=\"0.198794158\" stroke=\"#747474\" fill-opacity=\"0.816519475\" fill=\"#FFFFFF\" sketch:type=\"MSShapeGroup\"></path>\n      </g>\n    </svg>\n  </div>\n  <div class=\"dz-error-mark\">\n    <svg width=\"54px\" height=\"54px\" viewBox=\"0 0 54 54\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" xmlns:sketch=\"http://www.bohemiancoding.com/sketch/ns\">\n      <title>Error</title>\n      <defs></defs>\n      <g id=\"Page-1\" stroke=\"none\" stroke-width=\"1\" fill=\"none\" fill-rule=\"evenodd\" sketch:type=\"MSPage\">\n        <g id=\"Check-+-Oval-2\" sketch:type=\"MSLayerGroup\" stroke=\"#747474\" stroke-opacity=\"0.198794158\" fill=\"#FFFFFF\" fill-opacity=\"0.816519475\">\n          <path d=\"M32.6568542,29 L38.3106978,23.3461564 C39.8771021,21.7797521 39.8758057,19.2483887 38.3137085,17.6862915 C36.7547899,16.1273729 34.2176035,16.1255422 32.6538436,17.6893022 L27,23.3431458 L21.3461564,17.6893022 C19.7823965,16.1255422 17.2452101,16.1273729 15.6862915,17.6862915 C14.1241943,19.2483887 14.1228979,21.7797521 15.6893022,23.3461564 L21.3431458,29 L15.6893022,34.6538436 C14.1228979,36.2202479 14.1241943,38.7516113 15.6862915,40.3137085 C17.2452101,41.8726271 19.7823965,41.8744578 21.3461564,40.3106978 L27,34.6568542 L32.6538436,40.3106978 C34.2176035,41.8744578 36.7547899,41.8726271 38.3137085,40.3137085 C39.8758057,38.7516113 39.8771021,36.2202479 38.3106978,34.6538436 L32.6568542,29 Z M27,53 C41.3594035,53 53,41.3594035 53,27 C53,12.6405965 41.3594035,1 27,1 C12.6405965,1 1,12.6405965 1,27 C1,41.3594035 12.6405965,53 27,53 Z\" id=\"Oval-2\" sketch:type=\"MSShapeGroup\"></path>\n        </g>\n      </g>\n    </svg>\n  </div>\n</div>"
    };

    extend = function() {
      var key, object, objects, target, val, _i, _len;
      target = arguments[0], objects = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      for (_i = 0, _len = objects.length; _i < _len; _i++) {
        object = objects[_i];
        for (key in object) {
          val = object[key];
          target[key] = val;
        }
      }
      return target;
    };

    function Dropzone(element, options) {
      var elementOptions, fallback, _ref;
      this.element = element;
      this.version = Dropzone.version;
      this.defaultOptions.previewTemplate = this.defaultOptions.previewTemplate.replace(/\n*/g, "");
      this.clickableElements = [];
      this.listeners = [];
      this.files = [];
      if (typeof this.element === "string") {
        this.element = document.querySelector(this.element);
      }
      if (!(this.element && (this.element.nodeType != null))) {
        throw new Error("Invalid dropzone element.");
      }
      if (this.element.dropzone) {
        throw new Error("Dropzone already attached.");
      }
      Dropzone.instances.push(this);
      this.element.dropzone = this;
      elementOptions = (_ref = Dropzone.optionsForElement(this.element)) != null ? _ref : {};
      this.options = extend({}, this.defaultOptions, elementOptions, options != null ? options : {});
      if (this.options.forceFallback || !Dropzone.isBrowserSupported()) {
        return this.options.fallback.call(this);
      }
      if (this.options.url == null) {
        this.options.url = this.element.getAttribute("action");
      }
      if (!this.options.url) {
        throw new Error("No URL provided.");
      }
      if (this.options.acceptedFiles && this.options.acceptedMimeTypes) {
        throw new Error("You can't provide both 'acceptedFiles' and 'acceptedMimeTypes'. 'acceptedMimeTypes' is deprecated.");
      }
      if (this.options.acceptedMimeTypes) {
        this.options.acceptedFiles = this.options.acceptedMimeTypes;
        delete this.options.acceptedMimeTypes;
      }
      this.options.method = this.options.method.toUpperCase();
      if ((fallback = this.getExistingFallback()) && fallback.parentNode) {
        fallback.parentNode.removeChild(fallback);
      }
      if (this.options.previewsContainer !== false) {
        if (this.options.previewsContainer) {
          this.previewsContainer = Dropzone.getElement(this.options.previewsContainer, "previewsContainer");
        } else {
          this.previewsContainer = this.element;
        }
      }
      if (this.options.clickable) {
        if (this.options.clickable === true) {
          this.clickableElements = [this.element];
        } else {
          this.clickableElements = Dropzone.getElements(this.options.clickable, "clickable");
        }
      }
      this.init();
    }

    Dropzone.prototype.getAcceptedFiles = function() {
      var file, _i, _len, _ref, _results;
      _ref = this.files;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        file = _ref[_i];
        if (file.accepted) {
          _results.push(file);
        }
      }
      return _results;
    };

    Dropzone.prototype.getRejectedFiles = function() {
      var file, _i, _len, _ref, _results;
      _ref = this.files;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        file = _ref[_i];
        if (!file.accepted) {
          _results.push(file);
        }
      }
      return _results;
    };

    Dropzone.prototype.getFilesWithStatus = function(status) {
      var file, _i, _len, _ref, _results;
      _ref = this.files;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        file = _ref[_i];
        if (file.status === status) {
          _results.push(file);
        }
      }
      return _results;
    };

    Dropzone.prototype.getQueuedFiles = function() {
      return this.getFilesWithStatus(Dropzone.QUEUED);
    };

    Dropzone.prototype.getUploadingFiles = function() {
      return this.getFilesWithStatus(Dropzone.UPLOADING);
    };

    Dropzone.prototype.getActiveFiles = function() {
      var file, _i, _len, _ref, _results;
      _ref = this.files;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        file = _ref[_i];
        if (file.status === Dropzone.UPLOADING || file.status === Dropzone.QUEUED) {
          _results.push(file);
        }
      }
      return _results;
    };

    Dropzone.prototype.init = function() {
      var eventName, noPropagation, setupHiddenFileInput, _i, _len, _ref, _ref1;
      if (this.element.tagName === "form") {
        this.element.setAttribute("enctype", "multipart/form-data");
      }
      if (this.element.classList.contains("dropzone") && !this.element.querySelector(".dz-message")) {
        this.element.appendChild(Dropzone.createElement("<div class=\"dz-default dz-message\"><span>" + this.options.dictDefaultMessage + "</span></div>"));
      }
      if (this.clickableElements.length) {
        setupHiddenFileInput = (function(_this) {
          return function() {
            if (_this.hiddenFileInput) {
              document.body.removeChild(_this.hiddenFileInput);
            }
            _this.hiddenFileInput = document.createElement("input");
            _this.hiddenFileInput.setAttribute("type", "file");
            if ((_this.options.maxFiles == null) || _this.options.maxFiles > 1) {
              _this.hiddenFileInput.setAttribute("multiple", "multiple");
            }
            _this.hiddenFileInput.className = "dz-hidden-input";
            if (_this.options.acceptedFiles != null) {
              _this.hiddenFileInput.setAttribute("accept", _this.options.acceptedFiles);
            }
            if (_this.options.capture != null) {
              _this.hiddenFileInput.setAttribute("capture", _this.options.capture);
            }
            _this.hiddenFileInput.style.visibility = "hidden";
            _this.hiddenFileInput.style.position = "absolute";
            _this.hiddenFileInput.style.top = "0";
            _this.hiddenFileInput.style.left = "0";
            _this.hiddenFileInput.style.height = "0";
            _this.hiddenFileInput.style.width = "0";
            document.body.appendChild(_this.hiddenFileInput);
            return _this.hiddenFileInput.addEventListener("change", function() {
              var file, files, _i, _len;
              files = _this.hiddenFileInput.files;
              if (files.length) {
                for (_i = 0, _len = files.length; _i < _len; _i++) {
                  file = files[_i];
                  _this.addFile(file);
                }
              }
              return setupHiddenFileInput();
            });
          };
        })(this);
        setupHiddenFileInput();
      }
      this.URL = (_ref = window.URL) != null ? _ref : window.webkitURL;
      _ref1 = this.events;
      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
        eventName = _ref1[_i];
        this.on(eventName, this.options[eventName]);
      }
      this.on("uploadprogress", (function(_this) {
        return function() {
          return _this.updateTotalUploadProgress();
        };
      })(this));
      this.on("removedfile", (function(_this) {
        return function() {
          return _this.updateTotalUploadProgress();
        };
      })(this));
      this.on("canceled", (function(_this) {
        return function(file) {
          return _this.emit("complete", file);
        };
      })(this));
      this.on("complete", (function(_this) {
        return function(file) {
          if (_this.getUploadingFiles().length === 0 && _this.getQueuedFiles().length === 0) {
            return setTimeout((function() {
              return _this.emit("queuecomplete");
            }), 0);
          }
        };
      })(this));
      noPropagation = function(e) {
        e.stopPropagation();
        if (e.preventDefault) {
          return e.preventDefault();
        } else {
          return e.returnValue = false;
        }
      };
      this.listeners = [
        {
          element: this.element,
          events: {
            "dragstart": (function(_this) {
              return function(e) {
                return _this.emit("dragstart", e);
              };
            })(this),
            "dragenter": (function(_this) {
              return function(e) {
                noPropagation(e);
                return _this.emit("dragenter", e);
              };
            })(this),
            "dragover": (function(_this) {
              return function(e) {
                var efct;
                try {
                  efct = e.dataTransfer.effectAllowed;
                } catch (_error) {}
                e.dataTransfer.dropEffect = 'move' === efct || 'linkMove' === efct ? 'move' : 'copy';
                noPropagation(e);
                return _this.emit("dragover", e);
              };
            })(this),
            "dragleave": (function(_this) {
              return function(e) {
                return _this.emit("dragleave", e);
              };
            })(this),
            "drop": (function(_this) {
              return function(e) {
                noPropagation(e);
                return _this.drop(e);
              };
            })(this),
            "dragend": (function(_this) {
              return function(e) {
                return _this.emit("dragend", e);
              };
            })(this)
          }
        }
      ];
      this.clickableElements.forEach((function(_this) {
        return function(clickableElement) {
          return _this.listeners.push({
            element: clickableElement,
            events: {
              "click": function(evt) {
                if ((clickableElement !== _this.element) || (evt.target === _this.element || Dropzone.elementInside(evt.target, _this.element.querySelector(".dz-message")))) {
                  return _this.hiddenFileInput.click();
                }
              }
            }
          });
        };
      })(this));
      this.enable();
      return this.options.init.call(this);
    };

    Dropzone.prototype.destroy = function() {
      var _ref;
      this.disable();
      this.removeAllFiles(true);
      if ((_ref = this.hiddenFileInput) != null ? _ref.parentNode : void 0) {
        this.hiddenFileInput.parentNode.removeChild(this.hiddenFileInput);
        this.hiddenFileInput = null;
      }
      delete this.element.dropzone;
      return Dropzone.instances.splice(Dropzone.instances.indexOf(this), 1);
    };

    Dropzone.prototype.updateTotalUploadProgress = function() {
      var activeFiles, file, totalBytes, totalBytesSent, totalUploadProgress, _i, _len, _ref;
      totalBytesSent = 0;
      totalBytes = 0;
      activeFiles = this.getActiveFiles();
      if (activeFiles.length) {
        _ref = this.getActiveFiles();
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          file = _ref[_i];
          totalBytesSent += file.upload.bytesSent;
          totalBytes += file.upload.total;
        }
        totalUploadProgress = 100 * totalBytesSent / totalBytes;
      } else {
        totalUploadProgress = 100;
      }
      return this.emit("totaluploadprogress", totalUploadProgress, totalBytes, totalBytesSent);
    };

    Dropzone.prototype._getParamName = function(n) {
      if (typeof this.options.paramName === "function") {
        return this.options.paramName(n);
      } else {
        return "" + this.options.paramName + (this.options.uploadMultiple ? "[" + n + "]" : "");
      }
    };

    Dropzone.prototype.getFallbackForm = function() {
      var existingFallback, fields, fieldsString, form;
      if (existingFallback = this.getExistingFallback()) {
        return existingFallback;
      }
      fieldsString = "<div class=\"dz-fallback\">";
      if (this.options.dictFallbackText) {
        fieldsString += "<p>" + this.options.dictFallbackText + "</p>";
      }
      fieldsString += "<input type=\"file\" name=\"" + (this._getParamName(0)) + "\" " + (this.options.uploadMultiple ? 'multiple="multiple"' : void 0) + " /><input type=\"submit\" value=\"Upload!\"></div>";
      fields = Dropzone.createElement(fieldsString);
      if (this.element.tagName !== "FORM") {
        form = Dropzone.createElement("<form action=\"" + this.options.url + "\" enctype=\"multipart/form-data\" method=\"" + this.options.method + "\"></form>");
        form.appendChild(fields);
      } else {
        this.element.setAttribute("enctype", "multipart/form-data");
        this.element.setAttribute("method", this.options.method);
      }
      return form != null ? form : fields;
    };

    Dropzone.prototype.getExistingFallback = function() {
      var fallback, getFallback, tagName, _i, _len, _ref;
      getFallback = function(elements) {
        var el, _i, _len;
        for (_i = 0, _len = elements.length; _i < _len; _i++) {
          el = elements[_i];
          if (/(^| )fallback($| )/.test(el.className)) {
            return el;
          }
        }
      };
      _ref = ["div", "form"];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        tagName = _ref[_i];
        if (fallback = getFallback(this.element.getElementsByTagName(tagName))) {
          return fallback;
        }
      }
    };

    Dropzone.prototype.setupEventListeners = function() {
      var elementListeners, event, listener, _i, _len, _ref, _results;
      _ref = this.listeners;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        elementListeners = _ref[_i];
        _results.push((function() {
          var _ref1, _results1;
          _ref1 = elementListeners.events;
          _results1 = [];
          for (event in _ref1) {
            listener = _ref1[event];
            _results1.push(elementListeners.element.addEventListener(event, listener, false));
          }
          return _results1;
        })());
      }
      return _results;
    };

    Dropzone.prototype.removeEventListeners = function() {
      var elementListeners, event, listener, _i, _len, _ref, _results;
      _ref = this.listeners;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        elementListeners = _ref[_i];
        _results.push((function() {
          var _ref1, _results1;
          _ref1 = elementListeners.events;
          _results1 = [];
          for (event in _ref1) {
            listener = _ref1[event];
            _results1.push(elementListeners.element.removeEventListener(event, listener, false));
          }
          return _results1;
        })());
      }
      return _results;
    };

    Dropzone.prototype.disable = function() {
      var file, _i, _len, _ref, _results;
      this.clickableElements.forEach(function(element) {
        return element.classList.remove("dz-clickable");
      });
      this.removeEventListeners();
      _ref = this.files;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        file = _ref[_i];
        _results.push(this.cancelUpload(file));
      }
      return _results;
    };

    Dropzone.prototype.enable = function() {
      this.clickableElements.forEach(function(element) {
        return element.classList.add("dz-clickable");
      });
      return this.setupEventListeners();
    };

    Dropzone.prototype.filesize = function(size) {
      var cutoff, i, selectedSize, selectedUnit, unit, units, _i, _len;
      units = ['TB', 'GB', 'MB', 'KB', 'b'];
      selectedSize = selectedUnit = null;
      for (i = _i = 0, _len = units.length; _i < _len; i = ++_i) {
        unit = units[i];
        cutoff = Math.pow(this.options.filesizeBase, 4 - i) / 10;
        if (size >= cutoff) {
          selectedSize = size / Math.pow(this.options.filesizeBase, 4 - i);
          selectedUnit = unit;
          break;
        }
      }
      selectedSize = Math.round(10 * selectedSize) / 10;
      return "<strong>" + selectedSize + "</strong> " + selectedUnit;
    };

    Dropzone.prototype._updateMaxFilesReachedClass = function() {
      if ((this.options.maxFiles != null) && this.getAcceptedFiles().length >= this.options.maxFiles) {
        if (this.getAcceptedFiles().length === this.options.maxFiles) {
          this.emit('maxfilesreached', this.files);
        }
        return this.element.classList.add("dz-max-files-reached");
      } else {
        return this.element.classList.remove("dz-max-files-reached");
      }
    };

    Dropzone.prototype.drop = function(e) {
      var files, items;
      if (!e.dataTransfer) {
        return;
      }
      this.emit("drop", e);
      files = e.dataTransfer.files;
      if (files.length) {
        items = e.dataTransfer.items;
        if (items && items.length && (items[0].webkitGetAsEntry != null)) {
          this._addFilesFromItems(items);
        } else {
          this.handleFiles(files);
        }
      }
    };

    Dropzone.prototype.paste = function(e) {
      var items, _ref;
      if ((e != null ? (_ref = e.clipboardData) != null ? _ref.items : void 0 : void 0) == null) {
        return;
      }
      this.emit("paste", e);
      items = e.clipboardData.items;
      if (items.length) {
        return this._addFilesFromItems(items);
      }
    };

    Dropzone.prototype.handleFiles = function(files) {
      var file, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = files.length; _i < _len; _i++) {
        file = files[_i];
        _results.push(this.addFile(file));
      }
      return _results;
    };

    Dropzone.prototype._addFilesFromItems = function(items) {
      var entry, item, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = items.length; _i < _len; _i++) {
        item = items[_i];
        if ((item.webkitGetAsEntry != null) && (entry = item.webkitGetAsEntry())) {
          if (entry.isFile) {
            _results.push(this.addFile(item.getAsFile()));
          } else if (entry.isDirectory) {
            _results.push(this._addFilesFromDirectory(entry, entry.name));
          } else {
            _results.push(void 0);
          }
        } else if (item.getAsFile != null) {
          if ((item.kind == null) || item.kind === "file") {
            _results.push(this.addFile(item.getAsFile()));
          } else {
            _results.push(void 0);
          }
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    Dropzone.prototype._addFilesFromDirectory = function(directory, path) {
      var dirReader, entriesReader;
      dirReader = directory.createReader();
      entriesReader = (function(_this) {
        return function(entries) {
          var entry, _i, _len;
          for (_i = 0, _len = entries.length; _i < _len; _i++) {
            entry = entries[_i];
            if (entry.isFile) {
              entry.file(function(file) {
                if (_this.options.ignoreHiddenFiles && file.name.substring(0, 1) === '.') {
                  return;
                }
                file.fullPath = "" + path + "/" + file.name;
                return _this.addFile(file);
              });
            } else if (entry.isDirectory) {
              _this._addFilesFromDirectory(entry, "" + path + "/" + entry.name);
            }
          }
        };
      })(this);
      return dirReader.readEntries(entriesReader, function(error) {
        return typeof console !== "undefined" && console !== null ? typeof console.log === "function" ? console.log(error) : void 0 : void 0;
      });
    };

    Dropzone.prototype.accept = function(file, done) {
      if (file.size > this.options.maxFilesize * 1024 * 1024) {
        return done(this.options.dictFileTooBig.replace("{{filesize}}", Math.round(file.size / 1024 / 10.24) / 100).replace("{{maxFilesize}}", this.options.maxFilesize));
      } else if (!Dropzone.isValidFile(file, this.options.acceptedFiles)) {
        return done(this.options.dictInvalidFileType);
      } else if ((this.options.maxFiles != null) && this.getAcceptedFiles().length >= this.options.maxFiles) {
        done(this.options.dictMaxFilesExceeded.replace("{{maxFiles}}", this.options.maxFiles));
        return this.emit("maxfilesexceeded", file);
      } else {
        return this.options.accept.call(this, file, done);
      }
    };

    Dropzone.prototype.addFile = function(file) {
      file.upload = {
        progress: 0,
        total: file.size,
        bytesSent: 0
      };
      this.files.push(file);
      file.status = Dropzone.ADDED;
      this.emit("addedfile", file);
      this._enqueueThumbnail(file);
      return this.accept(file, (function(_this) {
        return function(error) {
          if (error) {
            file.accepted = false;
            _this._errorProcessing([file], error);
          } else {
            file.accepted = true;
            if (_this.options.autoQueue) {
              _this.enqueueFile(file);
            }
          }
          return _this._updateMaxFilesReachedClass();
        };
      })(this));
    };

    Dropzone.prototype.enqueueFiles = function(files) {
      var file, _i, _len;
      for (_i = 0, _len = files.length; _i < _len; _i++) {
        file = files[_i];
        this.enqueueFile(file);
      }
      return null;
    };

    Dropzone.prototype.enqueueFile = function(file) {
      if (file.status === Dropzone.ADDED && file.accepted === true) {
        file.status = Dropzone.QUEUED;
        if (this.options.autoProcessQueue) {
          return setTimeout(((function(_this) {
            return function() {
              return _this.processQueue();
            };
          })(this)), 0);
        }
      } else {
        throw new Error("This file can't be queued because it has already been processed or was rejected.");
      }
    };

    Dropzone.prototype._thumbnailQueue = [];

    Dropzone.prototype._processingThumbnail = false;

    Dropzone.prototype._enqueueThumbnail = function(file) {
      if (this.options.createImageThumbnails && file.type.match(/image.*/) && file.size <= this.options.maxThumbnailFilesize * 1024 * 1024) {
        this._thumbnailQueue.push(file);
        return setTimeout(((function(_this) {
          return function() {
            return _this._processThumbnailQueue();
          };
        })(this)), 0);
      }
    };

    Dropzone.prototype._processThumbnailQueue = function() {
      if (this._processingThumbnail || this._thumbnailQueue.length === 0) {
        return;
      }
      this._processingThumbnail = true;
      return this.createThumbnail(this._thumbnailQueue.shift(), (function(_this) {
        return function() {
          _this._processingThumbnail = false;
          return _this._processThumbnailQueue();
        };
      })(this));
    };

    Dropzone.prototype.removeFile = function(file) {
      if (file.status === Dropzone.UPLOADING) {
        this.cancelUpload(file);
      }
      this.files = without(this.files, file);
      this.emit("removedfile", file);
      if (this.files.length === 0) {
        return this.emit("reset");
      }
    };

    Dropzone.prototype.removeAllFiles = function(cancelIfNecessary) {
      var file, _i, _len, _ref;
      if (cancelIfNecessary == null) {
        cancelIfNecessary = false;
      }
      _ref = this.files.slice();
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        file = _ref[_i];
        if (file.status !== Dropzone.UPLOADING || cancelIfNecessary) {
          this.removeFile(file);
        }
      }
      return null;
    };

    Dropzone.prototype.createThumbnail = function(file, callback) {
      var fileReader;
      fileReader = new FileReader;
      fileReader.onload = (function(_this) {
        return function() {
          if (file.type === "image/svg+xml") {
            _this.emit("thumbnail", file, fileReader.result);
            if (callback != null) {
              callback();
            }
            return;
          }
          return _this.createThumbnailFromUrl(file, fileReader.result, callback);
        };
      })(this);
      return fileReader.readAsDataURL(file);
    };

    Dropzone.prototype.createThumbnailFromUrl = function(file, imageUrl, callback) {
      var img;
      img = document.createElement("img");
      img.onload = (function(_this) {
        return function() {
          var canvas, ctx, resizeInfo, thumbnail, _ref, _ref1, _ref2, _ref3;
          file.width = img.width;
          file.height = img.height;
          resizeInfo = _this.options.resize.call(_this, file);
          if (resizeInfo.trgWidth == null) {
            resizeInfo.trgWidth = resizeInfo.optWidth;
          }
          if (resizeInfo.trgHeight == null) {
            resizeInfo.trgHeight = resizeInfo.optHeight;
          }
          canvas = document.createElement("canvas");
          ctx = canvas.getContext("2d");
          canvas.width = resizeInfo.trgWidth;
          canvas.height = resizeInfo.trgHeight;
          drawImageIOSFix(ctx, img, (_ref = resizeInfo.srcX) != null ? _ref : 0, (_ref1 = resizeInfo.srcY) != null ? _ref1 : 0, resizeInfo.srcWidth, resizeInfo.srcHeight, (_ref2 = resizeInfo.trgX) != null ? _ref2 : 0, (_ref3 = resizeInfo.trgY) != null ? _ref3 : 0, resizeInfo.trgWidth, resizeInfo.trgHeight);
          thumbnail = canvas.toDataURL("image/png");
          _this.emit("thumbnail", file, thumbnail);
          if (callback != null) {
            return callback();
          }
        };
      })(this);
      if (callback != null) {
        img.onerror = callback;
      }
      return img.src = imageUrl;
    };

    Dropzone.prototype.processQueue = function() {
      var i, parallelUploads, processingLength, queuedFiles;
      parallelUploads = this.options.parallelUploads;
      processingLength = this.getUploadingFiles().length;
      i = processingLength;
      if (processingLength >= parallelUploads) {
        return;
      }
      queuedFiles = this.getQueuedFiles();
      if (!(queuedFiles.length > 0)) {
        return;
      }
      if (this.options.uploadMultiple) {
        return this.processFiles(queuedFiles.slice(0, parallelUploads - processingLength));
      } else {
        while (i < parallelUploads) {
          if (!queuedFiles.length) {
            return;
          }
          this.processFile(queuedFiles.shift());
          i++;
        }
      }
    };

    Dropzone.prototype.processFile = function(file) {
      return this.processFiles([file]);
    };

    Dropzone.prototype.processFiles = function(files) {
      var file, _i, _len;
      for (_i = 0, _len = files.length; _i < _len; _i++) {
        file = files[_i];
        file.processing = true;
        file.status = Dropzone.UPLOADING;
        this.emit("processing", file);
      }
      if (this.options.uploadMultiple) {
        this.emit("processingmultiple", files);
      }
      return this.uploadFiles(files);
    };

    Dropzone.prototype._getFilesWithXhr = function(xhr) {
      var file, files;
      return files = (function() {
        var _i, _len, _ref, _results;
        _ref = this.files;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          file = _ref[_i];
          if (file.xhr === xhr) {
            _results.push(file);
          }
        }
        return _results;
      }).call(this);
    };

    Dropzone.prototype.cancelUpload = function(file) {
      var groupedFile, groupedFiles, _i, _j, _len, _len1, _ref;
      if (file.status === Dropzone.UPLOADING) {
        groupedFiles = this._getFilesWithXhr(file.xhr);
        for (_i = 0, _len = groupedFiles.length; _i < _len; _i++) {
          groupedFile = groupedFiles[_i];
          groupedFile.status = Dropzone.CANCELED;
        }
        file.xhr.abort();
        for (_j = 0, _len1 = groupedFiles.length; _j < _len1; _j++) {
          groupedFile = groupedFiles[_j];
          this.emit("canceled", groupedFile);
        }
        if (this.options.uploadMultiple) {
          this.emit("canceledmultiple", groupedFiles);
        }
      } else if ((_ref = file.status) === Dropzone.ADDED || _ref === Dropzone.QUEUED) {
        file.status = Dropzone.CANCELED;
        this.emit("canceled", file);
        if (this.options.uploadMultiple) {
          this.emit("canceledmultiple", [file]);
        }
      }
      if (this.options.autoProcessQueue) {
        return this.processQueue();
      }
    };

    resolveOption = function() {
      var args, option;
      option = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      if (typeof option === 'function') {
        return option.apply(this, args);
      }
      return option;
    };

    Dropzone.prototype.uploadFile = function(file) {
      return this.uploadFiles([file]);
    };

    Dropzone.prototype.uploadFiles = function(files) {
      var file, formData, handleError, headerName, headerValue, headers, i, input, inputName, inputType, key, method, option, progressObj, response, updateProgress, url, value, xhr, _i, _j, _k, _l, _len, _len1, _len2, _len3, _m, _ref, _ref1, _ref2, _ref3, _ref4, _ref5;
      xhr = new XMLHttpRequest();
      for (_i = 0, _len = files.length; _i < _len; _i++) {
        file = files[_i];
        file.xhr = xhr;
      }
      method = resolveOption(this.options.method, files);
      url = resolveOption(this.options.url, files);
      xhr.open(method, url, true);
      xhr.withCredentials = !!this.options.withCredentials;
      response = null;
      handleError = (function(_this) {
        return function() {
          var _j, _len1, _results;
          _results = [];
          for (_j = 0, _len1 = files.length; _j < _len1; _j++) {
            file = files[_j];
            _results.push(_this._errorProcessing(files, response || _this.options.dictResponseError.replace("{{statusCode}}", xhr.status), xhr));
          }
          return _results;
        };
      })(this);
      updateProgress = (function(_this) {
        return function(e) {
          var allFilesFinished, progress, _j, _k, _l, _len1, _len2, _len3, _results;
          if (e != null) {
            progress = 100 * e.loaded / e.total;
            for (_j = 0, _len1 = files.length; _j < _len1; _j++) {
              file = files[_j];
              file.upload = {
                progress: progress,
                total: e.total,
                bytesSent: e.loaded
              };
            }
          } else {
            allFilesFinished = true;
            progress = 100;
            for (_k = 0, _len2 = files.length; _k < _len2; _k++) {
              file = files[_k];
              if (!(file.upload.progress === 100 && file.upload.bytesSent === file.upload.total)) {
                allFilesFinished = false;
              }
              file.upload.progress = progress;
              file.upload.bytesSent = file.upload.total;
            }
            if (allFilesFinished) {
              return;
            }
          }
          _results = [];
          for (_l = 0, _len3 = files.length; _l < _len3; _l++) {
            file = files[_l];
            _results.push(_this.emit("uploadprogress", file, progress, file.upload.bytesSent));
          }
          return _results;
        };
      })(this);
      xhr.onload = (function(_this) {
        return function(e) {
          var _ref;
          if (files[0].status === Dropzone.CANCELED) {
            return;
          }
          if (xhr.readyState !== 4) {
            return;
          }
          response = xhr.responseText;
          if (xhr.getResponseHeader("content-type") && ~xhr.getResponseHeader("content-type").indexOf("application/json")) {
            try {
              response = JSON.parse(response);
            } catch (_error) {
              e = _error;
              response = "Invalid JSON response from server.";
            }
          }
          updateProgress();
          if (!((200 <= (_ref = xhr.status) && _ref < 300))) {
            return handleError();
          } else {
            return _this._finished(files, response, e);
          }
        };
      })(this);
      xhr.onerror = (function(_this) {
        return function() {
          if (files[0].status === Dropzone.CANCELED) {
            return;
          }
          return handleError();
        };
      })(this);
      progressObj = (_ref = xhr.upload) != null ? _ref : xhr;
      progressObj.onprogress = updateProgress;
      headers = {
        "Accept": "application/json",
        "Cache-Control": "no-cache",
        "X-Requested-With": "XMLHttpRequest"
      };
      if (this.options.headers) {
        extend(headers, this.options.headers);
      }
      for (headerName in headers) {
        headerValue = headers[headerName];
        xhr.setRequestHeader(headerName, headerValue);
      }
      formData = new FormData();
      if (this.options.params) {
        _ref1 = this.options.params;
        for (key in _ref1) {
          value = _ref1[key];
          formData.append(key, value);
        }
      }
      for (_j = 0, _len1 = files.length; _j < _len1; _j++) {
        file = files[_j];
        this.emit("sending", file, xhr, formData);
      }
      if (this.options.uploadMultiple) {
        this.emit("sendingmultiple", files, xhr, formData);
      }
      if (this.element.tagName === "FORM") {
        _ref2 = this.element.querySelectorAll("input, textarea, select, button");
        for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
          input = _ref2[_k];
          inputName = input.getAttribute("name");
          inputType = input.getAttribute("type");
          if (input.tagName === "SELECT" && input.hasAttribute("multiple")) {
            _ref3 = input.options;
            for (_l = 0, _len3 = _ref3.length; _l < _len3; _l++) {
              option = _ref3[_l];
              if (option.selected) {
                formData.append(inputName, option.value);
              }
            }
          } else if (!inputType || ((_ref4 = inputType.toLowerCase()) !== "checkbox" && _ref4 !== "radio") || input.checked) {
            formData.append(inputName, input.value);
          }
        }
      }
      for (i = _m = 0, _ref5 = files.length - 1; 0 <= _ref5 ? _m <= _ref5 : _m >= _ref5; i = 0 <= _ref5 ? ++_m : --_m) {
        formData.append(this._getParamName(i), files[i], files[i].name);
      }
      return xhr.send(formData);
    };

    Dropzone.prototype._finished = function(files, responseText, e) {
      var file, _i, _len;
      for (_i = 0, _len = files.length; _i < _len; _i++) {
        file = files[_i];
        file.status = Dropzone.SUCCESS;
        this.emit("success", file, responseText, e);
        this.emit("complete", file);
      }
      if (this.options.uploadMultiple) {
        this.emit("successmultiple", files, responseText, e);
        this.emit("completemultiple", files);
      }
      if (this.options.autoProcessQueue) {
        return this.processQueue();
      }
    };

    Dropzone.prototype._errorProcessing = function(files, message, xhr) {
      var file, _i, _len;
      for (_i = 0, _len = files.length; _i < _len; _i++) {
        file = files[_i];
        file.status = Dropzone.ERROR;
        this.emit("error", file, message, xhr);
        this.emit("complete", file);
      }
      if (this.options.uploadMultiple) {
        this.emit("errormultiple", files, message, xhr);
        this.emit("completemultiple", files);
      }
      if (this.options.autoProcessQueue) {
        return this.processQueue();
      }
    };

    return Dropzone;

  })(Emitter);

  Dropzone.version = "4.0.1";

  Dropzone.options = {};

  Dropzone.optionsForElement = function(element) {
    if (element.getAttribute("id")) {
      return Dropzone.options[camelize(element.getAttribute("id"))];
    } else {
      return void 0;
    }
  };

  Dropzone.instances = [];

  Dropzone.forElement = function(element) {
    if (typeof element === "string") {
      element = document.querySelector(element);
    }
    if ((element != null ? element.dropzone : void 0) == null) {
      throw new Error("No Dropzone found for given element. This is probably because you're trying to access it before Dropzone had the time to initialize. Use the `init` option to setup any additional observers on your Dropzone.");
    }
    return element.dropzone;
  };

  Dropzone.autoDiscover = true;

  Dropzone.discover = function() {
    var checkElements, dropzone, dropzones, _i, _len, _results;
    if (document.querySelectorAll) {
      dropzones = document.querySelectorAll(".dropzone");
    } else {
      dropzones = [];
      checkElements = function(elements) {
        var el, _i, _len, _results;
        _results = [];
        for (_i = 0, _len = elements.length; _i < _len; _i++) {
          el = elements[_i];
          if (/(^| )dropzone($| )/.test(el.className)) {
            _results.push(dropzones.push(el));
          } else {
            _results.push(void 0);
          }
        }
        return _results;
      };
      checkElements(document.getElementsByTagName("div"));
      checkElements(document.getElementsByTagName("form"));
    }
    _results = [];
    for (_i = 0, _len = dropzones.length; _i < _len; _i++) {
      dropzone = dropzones[_i];
      if (Dropzone.optionsForElement(dropzone) !== false) {
        _results.push(new Dropzone(dropzone));
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  Dropzone.blacklistedBrowsers = [/opera.*Macintosh.*version\/12/i];

  Dropzone.isBrowserSupported = function() {
    var capableBrowser, regex, _i, _len, _ref;
    capableBrowser = true;
    if (window.File && window.FileReader && window.FileList && window.Blob && window.FormData && document.querySelector) {
      if (!("classList" in document.createElement("a"))) {
        capableBrowser = false;
      } else {
        _ref = Dropzone.blacklistedBrowsers;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          regex = _ref[_i];
          if (regex.test(navigator.userAgent)) {
            capableBrowser = false;
            continue;
          }
        }
      }
    } else {
      capableBrowser = false;
    }
    return capableBrowser;
  };

  without = function(list, rejectedItem) {
    var item, _i, _len, _results;
    _results = [];
    for (_i = 0, _len = list.length; _i < _len; _i++) {
      item = list[_i];
      if (item !== rejectedItem) {
        _results.push(item);
      }
    }
    return _results;
  };

  camelize = function(str) {
    return str.replace(/[\-_](\w)/g, function(match) {
      return match.charAt(1).toUpperCase();
    });
  };

  Dropzone.createElement = function(string) {
    var div;
    div = document.createElement("div");
    div.innerHTML = string;
    return div.childNodes[0];
  };

  Dropzone.elementInside = function(element, container) {
    if (element === container) {
      return true;
    }
    while (element = element.parentNode) {
      if (element === container) {
        return true;
      }
    }
    return false;
  };

  Dropzone.getElement = function(el, name) {
    var element;
    if (typeof el === "string") {
      element = document.querySelector(el);
    } else if (el.nodeType != null) {
      element = el;
    }
    if (element == null) {
      throw new Error("Invalid `" + name + "` option provided. Please provide a CSS selector or a plain HTML element.");
    }
    return element;
  };

  Dropzone.getElements = function(els, name) {
    var e, el, elements, _i, _j, _len, _len1, _ref;
    if (els instanceof Array) {
      elements = [];
      try {
        for (_i = 0, _len = els.length; _i < _len; _i++) {
          el = els[_i];
          elements.push(this.getElement(el, name));
        }
      } catch (_error) {
        e = _error;
        elements = null;
      }
    } else if (typeof els === "string") {
      elements = [];
      _ref = document.querySelectorAll(els);
      for (_j = 0, _len1 = _ref.length; _j < _len1; _j++) {
        el = _ref[_j];
        elements.push(el);
      }
    } else if (els.nodeType != null) {
      elements = [els];
    }
    if (!((elements != null) && elements.length)) {
      throw new Error("Invalid `" + name + "` option provided. Please provide a CSS selector, a plain HTML element or a list of those.");
    }
    return elements;
  };

  Dropzone.confirm = function(question, accepted, rejected) {
    if (window.confirm(question)) {
      return accepted();
    } else if (rejected != null) {
      return rejected();
    }
  };

  Dropzone.isValidFile = function(file, acceptedFiles) {
    var baseMimeType, mimeType, validType, _i, _len;
    if (!acceptedFiles) {
      return true;
    }
    acceptedFiles = acceptedFiles.split(",");
    mimeType = file.type;
    baseMimeType = mimeType.replace(/\/.*$/, "");
    for (_i = 0, _len = acceptedFiles.length; _i < _len; _i++) {
      validType = acceptedFiles[_i];
      validType = validType.trim();
      if (validType.charAt(0) === ".") {
        if (file.name.toLowerCase().indexOf(validType.toLowerCase(), file.name.length - validType.length) !== -1) {
          return true;
        }
      } else if (/\/\*$/.test(validType)) {
        if (baseMimeType === validType.replace(/\/.*$/, "")) {
          return true;
        }
      } else {
        if (mimeType === validType) {
          return true;
        }
      }
    }
    return false;
  };

  if (typeof jQuery !== "undefined" && jQuery !== null) {
    jQuery.fn.dropzone = function(options) {
      return this.each(function() {
        return new Dropzone(this, options);
      });
    };
  }

  if (typeof module !== "undefined" && module !== null) {
    module.exports = Dropzone;
  } else {
    window.Dropzone = Dropzone;
  }

  Dropzone.ADDED = "added";

  Dropzone.QUEUED = "queued";

  Dropzone.ACCEPTED = Dropzone.QUEUED;

  Dropzone.UPLOADING = "uploading";

  Dropzone.PROCESSING = Dropzone.UPLOADING;

  Dropzone.CANCELED = "canceled";

  Dropzone.ERROR = "error";

  Dropzone.SUCCESS = "success";


  /*
  
  Bugfix for iOS 6 and 7
  Source: http://stackoverflow.com/questions/11929099/html5-canvas-drawimage-ratio-bug-ios
  based on the work of https://github.com/stomita/ios-imagefile-megapixel
   */

  detectVerticalSquash = function(img) {
    var alpha, canvas, ctx, data, ey, ih, iw, py, ratio, sy;
    iw = img.naturalWidth;
    ih = img.naturalHeight;
    canvas = document.createElement("canvas");
    canvas.width = 1;
    canvas.height = ih;
    ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    data = ctx.getImageData(0, 0, 1, ih).data;
    sy = 0;
    ey = ih;
    py = ih;
    while (py > sy) {
      alpha = data[(py - 1) * 4 + 3];
      if (alpha === 0) {
        ey = py;
      } else {
        sy = py;
      }
      py = (ey + sy) >> 1;
    }
    ratio = py / ih;
    if (ratio === 0) {
      return 1;
    } else {
      return ratio;
    }
  };

  drawImageIOSFix = function(ctx, img, sx, sy, sw, sh, dx, dy, dw, dh) {
    var vertSquashRatio;
    vertSquashRatio = detectVerticalSquash(img);
    return ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh / vertSquashRatio);
  };


  /*
   * contentloaded.js
   *
   * Author: Diego Perini (diego.perini at gmail.com)
   * Summary: cross-browser wrapper for DOMContentLoaded
   * Updated: 20101020
   * License: MIT
   * Version: 1.2
   *
   * URL:
   * http://javascript.nwbox.com/ContentLoaded/
   * http://javascript.nwbox.com/ContentLoaded/MIT-LICENSE
   */

  contentLoaded = function(win, fn) {
    var add, doc, done, init, poll, pre, rem, root, top;
    done = false;
    top = true;
    doc = win.document;
    root = doc.documentElement;
    add = (doc.addEventListener ? "addEventListener" : "attachEvent");
    rem = (doc.addEventListener ? "removeEventListener" : "detachEvent");
    pre = (doc.addEventListener ? "" : "on");
    init = function(e) {
      if (e.type === "readystatechange" && doc.readyState !== "complete") {
        return;
      }
      (e.type === "load" ? win : doc)[rem](pre + e.type, init, false);
      if (!done && (done = true)) {
        return fn.call(win, e.type || e);
      }
    };
    poll = function() {
      var e;
      try {
        root.doScroll("left");
      } catch (_error) {
        e = _error;
        setTimeout(poll, 50);
        return;
      }
      return init("poll");
    };
    if (doc.readyState !== "complete") {
      if (doc.createEventObject && root.doScroll) {
        try {
          top = !win.frameElement;
        } catch (_error) {}
        if (top) {
          poll();
        }
      }
      doc[add](pre + "DOMContentLoaded", init, false);
      doc[add](pre + "readystatechange", init, false);
      return win[add](pre + "load", init, false);
    }
  };

  Dropzone._autoDiscoverFunction = function() {
    if (Dropzone.autoDiscover) {
      return Dropzone.discover();
    }
  };

  contentLoaded(window, Dropzone._autoDiscoverFunction);

}).call(this);
},{}],458:[function(require,module,exports){
// tipsy, facebook style tooltips for jquery with fancy fading
// version 1.0.0a
// (c) 2008-2010 jason frame [jason@onehackoranother.com] and modificated by Sergio Alvarez @saleiva
// released under the MIT license
//
//  Changes:
//  April 27 2016: fixed problem with element size.
//  June 3 2013: Added the custom class before the calc of the position.

(function($) {

  var MOVE_OFFSET = 6;

  function maybeCall(thing, ctx) {
    return (typeof thing == 'function') ? (thing.call(ctx)) : thing;
  };

  function isElementInDOM(ele) {
    while (ele = ele.parentNode) {
      if (ele == document) return true;
    }
    return false;
  };

  function Tipsy(element, options) {
    this.$element = $(element);
    this.options = options;
    this.enabled = true;
    this.fixTitle();
  };

  Tipsy.prototype = {
    show: function() {
      var title = this.getTitle();
      if (title && this.enabled) {
        var $tip = this.tip();

        $tip.find('.tipsy-inner')[this.options.html ? 'html' : 'text'](title);
            $tip[0].className = 'tipsy'; // reset classname in case of dynamic gravity
            $tip.remove().css({top: 0, left: 0, visibility: 'hidden', display: 'block'}).prependTo(document.body);

            // Modified so we can use custom class names
            if (this.options.className) {
              $tip.addClass(maybeCall(this.options.className, this.$element[0]));
            }

            // Modified
            var pos = $.extend({}, this.$element.offset(), {
              width: this.$element[0].getBoundingClientRect().width,
              height: this.$element[0].getBoundingClientRect().height
            });

            var actualWidth = $tip[0].offsetWidth,
            actualHeight = $tip[0].offsetHeight,
            gravity = maybeCall(this.options.gravity, this.$element[0]);

            var tp;
            switch (gravity.charAt(0)) {
              case 'n':
              tp = {top: pos.top + pos.height + this.options.offset, left: pos.left + pos.width / 2 - actualWidth / 2};
              mo = {top: parseInt(pos.top + pos.height + this.options.offset + MOVE_OFFSET), opacity: this.options.opacity};
              break;
              case 's':
              tp = {top: pos.top - actualHeight - this.options.offset, left: pos.left + pos.width / 2 - actualWidth / 2};
              mo = {top: parseInt(pos.top - actualHeight - this.options.offset - MOVE_OFFSET), opacity: this.options.opacity};
              break;
              case 'e':
              tp = {top: pos.top + pos.height / 2 - actualHeight / 2, left: pos.left - actualWidth - this.options.offset};
              mo = {left: parseInt(pos.left - actualWidth - this.options.offset - MOVE_OFFSET), opacity: this.options.opacity};
              break;
              case 'w':
              tp = {top: pos.top + pos.height / 2 - actualHeight / 2, left: pos.left + pos.width + this.options.offset};
              mo = {left: parseInt(pos.left + pos.width + this.options.offset + MOVE_OFFSET), opacity: this.options.opacity};
              break;
            }

            if (gravity.length == 2) {
              if (gravity.charAt(1) == 'w') {
                tp.left = pos.left + pos.width / 2 - 15;
              } else {
                tp.left = pos.left + pos.width / 2 - actualWidth + 15;
              }
            }

            $tip.css(tp).addClass('tipsy-' + gravity);
            $tip.find('.tipsy-arrow')[0].className = 'tipsy-arrow tipsy-arrow-' + gravity.charAt(0);

            if (this.options.fade) {
              $tip.stop().css({opacity: 0, display: 'block', visibility: 'visible'}).animate(mo, 200);
            } else {
              $tip.css({visibility: 'visible', opacity: this.options.opacity});
            }
          }
        },

        hide: function() {

          gravity = maybeCall(this.options.gravity, this.$element[0]);

          switch (gravity.charAt(0)) {
            case 'n':
            mo = {top: parseInt(this.tip().css("top")) + MOVE_OFFSET, opacity: 0};
            break;
            case 's':
            mo = {top: parseInt(this.tip().css("top")) - MOVE_OFFSET, opacity: 0};
            break;
            case 'e':
            mo = {left: parseInt(this.tip().css("left")) - MOVE_OFFSET, opacity: 0};
            break;
            case 'w':
            mo = {left: parseInt(this.tip().css("left")) + MOVE_OFFSET, opacity: 0};
            break;
          }

          if (this.options.fade) {
            this.tip().stop().animate(mo, 200, function(){$(this).remove();});
          } else {
            this.tip().remove();
          }
        },

        fixTitle: function() {
          var $e = this.$element;
          if ($e.attr('title') || typeof($e.attr('original-title')) != 'string') {
            $e.attr('original-title', $e.attr('title') || '').removeAttr('title');
          }
        },

        getTitle: function() {
          var title, $e = this.$element, o = this.options;
          this.fixTitle();
          var title, o = this.options;
          if (typeof o.title == 'string') {
            title = $e.attr(o.title == 'title' ? 'original-title' : o.title);
          } else if (typeof o.title == 'function') {
            title = o.title.call($e[0]);
          }
          title = ('' + title).replace(/(^\s*|\s*$)/, "");
          return title || o.fallback;
        },

        tip: function() {
          if (!this.$tip) {
            this.$tip = $('<div class="tipsy"></div>').html('<div class="tipsy-arrow"></div><div class="tipsy-inner"></div>');
            this.$tip.data('tipsy-pointee', this.$element[0]);
          }
          return this.$tip;
        },

        validate: function() {
          if (!this.$element[0].parentNode) {
            this.hide();
            this.$element = null;
            this.options = null;
          }
        },

        remove: function() { this.enabled = false; this.$tip && this.$tip.remove(); },
        enable: function() { this.enabled = true; },
        disable: function() { this.enabled = false; },
        toggleEnabled: function() { this.enabled = !this.enabled; }
      };

      $.fn.tipsy = function(options) {

        if (options === true) {
          return this.data('tipsy');
        } else if (typeof options == 'string') {
          var tipsy = this.data('tipsy');
          if (tipsy) tipsy[options]();
          return this;
        }

        options = $.extend({}, $.fn.tipsy.defaults, options);

        function get(ele) {
          var tipsy = $.data(ele, 'tipsy');
          if (!tipsy) {
            tipsy = new Tipsy(ele, $.fn.tipsy.elementOptions(ele, options));
            $.data(ele, 'tipsy', tipsy);
          }
          return tipsy;
        }

        function enter() {
          var tipsy = get(this);
          tipsy.hoverState = 'in';
          if (options.delayIn == 0) {
            tipsy.show();
          } else {
            tipsy.fixTitle();
            setTimeout(function() { if (tipsy.hoverState == 'in') tipsy.show(); }, options.delayIn);
          }
        };

        function leave() {
          var tipsy = get(this);
          tipsy.hoverState = 'out';
          if (options.delayOut == 0) {
            tipsy.hide();
          } else {
            setTimeout(function() { if (tipsy.hoverState == 'out') tipsy.hide(); }, options.delayOut);
          }
        };

        if (!options.live) this.each(function() { get(this); });

        if (options.trigger != 'manual') {
          var binder   = options.live ? 'live' : 'bind',
          eventIn  = options.trigger == 'hover' ? 'mouseenter' : 'focus',
          eventOut = options.trigger == 'hover' ? 'mouseleave' : 'blur';
          this[binder](eventIn, enter)[binder](eventOut, leave);
        }

        return this;

      };

      $.fn.tipsy.defaults = {
        className: null,
        delayIn: 0,
        delayOut: 0,
        fade: false,
        fallback: '',
        gravity: 'n',
        html: false,
        live: false,
        offset: 0,
        opacity: 0.8,
        title: 'title',
        trigger: 'hover'
      };

      $.fn.tipsy.revalidate = function() {
        $('.tipsy').each(function() {
          var pointee = $.data(this, 'tipsy-pointee');
          if (!pointee || !isElementInDOM(pointee)) {
            $(this).remove();
          }
        });
      };

    // Overwrite this method to provide options on a per-element basis.
    // For example, you could store the gravity in a 'tipsy-gravity' attribute:
    // return $.extend({}, options, {gravity: $(ele).attr('tipsy-gravity') || 'n' });
    // (remember - do not modify 'options' in place!)
    $.fn.tipsy.elementOptions = function(ele, options) {
      return $.metadata ? $.extend({}, options, $(ele).metadata()) : options;
    };

    $.fn.tipsy.autoNS = function() {
      return $(this).offset().top > ($(document).scrollTop() + $(window).height() / 2) ? 's' : 'n';
    };

    $.fn.tipsy.autoWE = function() {
      return $(this).offset().left > ($(document).scrollLeft() + $(window).width() / 2) ? 'e' : 'w';
    };

    /**
     * yields a closure of the supplied parameters, producing a function that takes
     * no arguments and is suitable for use as an autogravity function like so:
     *
     * @param margin (int) - distance from the viewable region edge that an
     *        element should be before setting its tooltip's gravity to be away
     *        from that edge.
     * @param prefer (string, e.g. 'n', 'sw', 'w') - the direction to prefer
     *        if there are no viewable region edges effecting the tooltip's
     *        gravity. It will try to vary from this minimally, for example,
     *        if 'sw' is preferred and an element is near the right viewable
     *        region edge, but not the top edge, it will set the gravity for
     *        that element's tooltip to be 'se', preserving the southern
     *        component.
     */
     $.fn.tipsy.autoBounds = function(margin, prefer) {
      return function() {
       var dir = {ns: prefer[0], ew: (prefer.length > 1 ? prefer[1] : false)},
       boundTop = $(document).scrollTop() + margin,
       boundLeft = $(document).scrollLeft() + margin,
       $this = $(this);

       if ($this.offset().top < boundTop) dir.ns = 'n';
       if ($this.offset().left < boundLeft) dir.ew = 'w';
       if ($(window).width() + $(document).scrollLeft() - $this.offset().left < margin) dir.ew = 'e';
       if ($(window).height() + $(document).scrollTop() - $this.offset().top < margin) dir.ns = 's';

       return dir.ns + (dir.ew ? dir.ew : '');
     }
   };

 })(jQuery);

},{}],459:[function(require,module,exports){
/*
* jQuery UI Tag-it!
*
* @version v2.0 (06/2011)
*
* Copyright 2011, Levy Carneiro Jr.
* Released under the MIT license.
* http://aehlke.github.com/tag-it/LICENSE
*
* Homepage:
*   http://aehlke.github.com/tag-it/
*
* Authors:
*   Levy Carneiro Jr.
*   Martin Rehfeld
*   Tobias Schmidt
*   Skylar Challand
*   Alex Ehlke
*
* Maintainer:
*   Alex Ehlke - Twitter: @aehlke
*
* Dependencies:
*   jQuery v1.4+
*   jQuery UI v1.8+
*/
(function($) {

    $.widget('ui.tagit', {
        options: {
            allowDuplicates   : false,
            caseSensitive     : true,
            fieldName         : 'tags',
            placeholderText   : null,   // Sets `placeholder` attr on input field.
            readOnly          : false,  // Disables editing.
            removeConfirmation: false,  // Require confirmation to remove tags.
            tagLimit          : null,   // Max number of tags allowed (null for unlimited).

            // Used for autocomplete, unless you override `autocomplete.source`.
            availableTags     : [],

            // Use to override or add any options to the autocomplete widget.
            //
            // By default, autocomplete.source will map to availableTags,
            // unless overridden.
            autocomplete: {},

            // Shows autocomplete before the user even types anything.
            showAutocompleteOnFocus: false,

            // When enabled, quotes are unneccesary for inputting multi-word tags.
            allowSpaces: false,

            // The below options are for using a single field instead of several
            // for our form values.
            //
            // When enabled, will use a single hidden field for the form,
            // rather than one per tag. It will delimit tags in the field
            // with singleFieldDelimiter.
            //
            // The easiest way to use singleField is to just instantiate tag-it
            // on an INPUT element, in which case singleField is automatically
            // set to true, and singleFieldNode is set to that element. This
            // way, you don't need to fiddle with these options.
            singleField: false,

            // This is just used when preloading data from the field, and for
            // populating the field with delimited tags as the user adds them.
            singleFieldDelimiter: ',',

            // Set this to an input DOM node to use an existing form field.
            // Any text in it will be erased on init. But it will be
            // populated with the text of tags as they are created,
            // delimited by singleFieldDelimiter.
            //
            // If this is not set, we create an input node for it,
            // with the name given in settings.fieldName.
            singleFieldNode: null,

            // Whether to animate tag removals or not.
            animate: true,

            // Optionally set a tabindex attribute on the input that gets
            // created for tag-it.
            tabIndex: null,

            // Event callbacks.
            beforeTagAdded      : null,
            afterTagAdded       : null,

            beforeTagRemoved    : null,
            afterTagRemoved     : null,

            onTagClicked        : null,
            onTagLimitExceeded  : null,


            // DEPRECATED:
            //
            // /!\ These event callbacks are deprecated and WILL BE REMOVED at some
            // point in the future. They're here for backwards-compatibility.
            // Use the above before/after event callbacks instead.
            onTagAdded  : null,
            onTagRemoved: null,
            // `autocomplete.source` is the replacement for tagSource.
            tagSource: null,
            onSubmitTags: null,
            onFocus: null,
            onBlur: null
            // Do not use the above deprecated options.
        },

        _create: function() {
            // for handling static scoping inside callbacks
            var that = this;

            // There are 2 kinds of DOM nodes this widget can be instantiated on:
            //     1. UL, OL, or some element containing either of these.
            //     2. INPUT, in which case 'singleField' is overridden to true,
            //        a UL is created and the INPUT is hidden.
            if (this.element.is('input')) {
                this.tagList = $('<ul></ul>').insertAfter(this.element);
                this.options.singleField = true;
                this.options.singleFieldNode = this.element;
                this.element.addClass('tagit-hidden-field');
            } else {
                this.tagList = this.element.find('ul, ol').andSelf().last();
            }

            this.tagInput = $('<input type="text" />').addClass('ui-widget-content');

            if (this.options.readOnly) this.tagInput.attr('disabled', 'disabled');

            if (this.options.tabIndex) {
                this.tagInput.attr('tabindex', this.options.tabIndex);
            }

            if (this.options.placeholderText) {
                this.tagInput.attr('placeholder', this.options.placeholderText);
            }

            if (!this.options.autocomplete.source) {
                this.options.autocomplete.source = function(search, showChoices) {
                    var filter = search.term.toLowerCase();
                    var choices = $.grep(this.options.availableTags, function(element) {
                        // Only match autocomplete options that begin with the search term.
                        // (Case insensitive.)
                        return (element.toLowerCase().indexOf(filter) === 0);
                    });
                    if (!this.options.allowDuplicates) {
                        choices = this._subtractArray(choices, this.assignedTags());
                    }
                    showChoices(choices);
                };
            }

            if (this.options.showAutocompleteOnFocus) {
                this.tagInput.focus(function(event, ui) {
                    that._showAutocomplete();
                });

                if (typeof this.options.autocomplete.minLength === 'undefined') {
                    this.options.autocomplete.minLength = 0;
                }
            }

            // Bind autocomplete.source callback functions to this context.
            if ($.isFunction(this.options.autocomplete.source)) {
                this.options.autocomplete.source = $.proxy(this.options.autocomplete.source, this);
            }

            // DEPRECATED.
            if ($.isFunction(this.options.tagSource)) {
                this.options.tagSource = $.proxy(this.options.tagSource, this);
            }

            this.tagList
                .addClass('tagit')
                .addClass('ui-widget ui-widget-content ui-corner-all')
                // Create the input field.
                .append($('<li class="tagit-new"></li>').append(this.tagInput))
                .click(function(e) {
                    var target = $(e.target);
                    if (target.hasClass('tagit-label')) {
                        var tag = target.closest('.tagit-choice');
                        if (!tag.hasClass('removed')) {
                            that._trigger('onTagClicked', e, {tag: tag, tagLabel: that.tagLabel(tag)});
                        }
                    } else {
                        // Sets the focus() to the input field, if the user
                        // clicks anywhere inside the UL. This is needed
                        // because the input field needs to be of a small size.
                        that.tagInput.focus();
                    }
                });

            // Single field support.
            var addedExistingFromSingleFieldNode = false;
            if (this.options.singleField) {
                if (this.options.singleFieldNode) {
                    // Add existing tags from the input field.
                    var node = $(this.options.singleFieldNode);
                    var tags = node.val().split(this.options.singleFieldDelimiter);
                    node.val('');
                    $.each(tags, function(index, tag) {
                        that.createTag(tag, null, true);
                        addedExistingFromSingleFieldNode = true;
                    });
                } else {
                    // Create our single field input after our list.
                    this.options.singleFieldNode = $('<input type="hidden" style="display:none;" value="" name="' + this.options.fieldName + '" />');
                    this.tagList.after(this.options.singleFieldNode);
                }
            }

            // Add existing tags from the list, if any.
            if (!addedExistingFromSingleFieldNode) {
                this.tagList.children('li').each(function() {
                    if (!$(this).hasClass('tagit-new')) {
                        that.createTag($(this).text(), $(this).attr('class'), true);
                        $(this).remove();
                    }
                });
            }

            // Events.
            this.tagInput
                .keydown(function(event) {
                    // Backspace is not detected within a keypress, so it must use keydown.
                    if (event.which == $.ui.keyCode.BACKSPACE && that.tagInput.val() === '') {
                        var tag = that._lastTag();
                        if (!that.options.removeConfirmation || tag.hasClass('remove')) {
                            // When backspace is pressed, the last tag is deleted.
                            that.removeTag(tag);
                        } else if (that.options.removeConfirmation) {
                            tag.addClass('remove ui-state-highlight');
                        }
                    } else if (that.options.removeConfirmation) {
                        that._lastTag().removeClass('remove ui-state-highlight');
                    } else if (event.which == $.ui.keyCode.ENTER && that.tagInput.val() === "") {
                        that._trigger('onSubmitTags', null, that.tagList);
                    }

                    // Comma/Space/Enter are all valid delimiters for new tags,
                    // except when there is an open quote or if setting allowSpaces = true.
                    // Tab will also create a tag, unless the tag input is empty,
                    // in which case it isn't caught.
                    if (
                        (event.which === $.ui.keyCode.COMMA && event.shiftKey === false) ||
                        event.which === $.ui.keyCode.ENTER ||
                        (
                            event.which == $.ui.keyCode.TAB &&
                            that.tagInput.val() !== ''
                        ) ||
                        (
                            event.which == $.ui.keyCode.SPACE &&
                            that.options.allowSpaces !== true &&
                            (
                                $.trim(that.tagInput.val()).replace( /^s*/, '' ).charAt(0) != '"' ||
                                (
                                    $.trim(that.tagInput.val()).charAt(0) == '"' &&
                                    $.trim(that.tagInput.val()).charAt($.trim(that.tagInput.val()).length - 1) == '"' &&
                                    $.trim(that.tagInput.val()).length - 1 !== 0
                                )
                            )
                        )
                    ) {
                        // Enter submits the form if there's no text in the input.
                        if (!(event.which === $.ui.keyCode.ENTER && that.tagInput.val() === '')) {
                            event.preventDefault();
                        }

                        // Autocomplete will create its own tag from a selection and close automatically.
                        if (!(that.options.autocomplete.autoFocus && that.tagInput.data('autocomplete-open'))) {
                            that.tagInput.autocomplete('close');
                            that.createTag(that._cleanedInput());
                        }
                    }
                }).blur(function(e){
                    that._trigger('onBlur', null, null);
                    // Create a tag when the element loses focus.
                    // If autocomplete is enabled and suggestion was clicked, don't add it.
                    if (!that.tagInput.data('autocomplete-open')) {
                        that.createTag(that._cleanedInput());
                    }
                }).focus(function(e) {
                    that._trigger('onFocus', null, null);
                })

            // Autocomplete.
            if (this.options.availableTags || this.options.tagSource || this.options.autocomplete.source) {
                var autocompleteOptions = {
                    select: function(event, ui) {
                        that.createTag(ui.item.value);
                        // Preventing the tag input to be updated with the chosen value.
                        return false;
                    }
                };
                $.extend(autocompleteOptions, this.options.autocomplete);

                // tagSource is deprecated, but takes precedence here since autocomplete.source is set by default,
                // while tagSource is left null by default.
                autocompleteOptions.source = this.options.tagSource || autocompleteOptions.source;

                this.tagInput.autocomplete(autocompleteOptions).bind('autocompleteopen.tagit', function(event, ui) {
                    that.tagInput.data('autocomplete-open', true);
                }).bind('autocompleteclose.tagit', function(event, ui) {
                    that.tagInput.data('autocomplete-open', false);
                });

                this.tagInput.autocomplete('widget').addClass('tagit-autocomplete');
            }
        },

        destroy: function() {
            $.Widget.prototype.destroy.call(this);

            this.element.unbind('.tagit');
            this.tagList.unbind('.tagit');

            this.tagInput.removeData('autocomplete-open');

            this.tagList.removeClass([
                'tagit',
                'ui-widget',
                'ui-widget-content',
                'ui-corner-all',
                'tagit-hidden-field'
            ].join(' '));

            if (this.element.is('input')) {
                this.element.removeClass('tagit-hidden-field');
                this.tagList.remove();
            } else {
                this.element.children('li').each(function() {
                    if ($(this).hasClass('tagit-new')) {
                        $(this).remove();
                    } else {
                        $(this).removeClass([
                            'tagit-choice',
                            'ui-widget-content',
                            'ui-state-default',
                            'ui-state-highlight',
                            'ui-corner-all',
                            'remove',
                            'tagit-choice-editable',
                            'tagit-choice-read-only'
                        ].join(' '));

                        $(this).text($(this).children('.tagit-label').text());
                    }
                });

                if (this.singleFieldNode) {
                    this.singleFieldNode.remove();
                }
            }

            return this;
        },

        _cleanedInput: function() {
            // Returns the contents of the tag input, cleaned and ready to be passed to createTag
            return $.trim(this.tagInput.val().replace(/^"(.*)"$/, '$1'));
        },

        _lastTag: function() {
            return this.tagList.find('.tagit-choice:last:not(.removed)');
        },

        _tags: function() {
            return this.tagList.find('.tagit-choice:not(.removed)');
        },

        assignedTags: function() {
            // Returns an array of tag string values
            var that = this;
            var tags = [];
            if (this.options.singleField) {
                tags = $(this.options.singleFieldNode).val().split(this.options.singleFieldDelimiter);
                if (tags[0] === '') {
                    tags = [];
                }
            } else {
                this._tags().each(function() {
                    tags.push(that.tagLabel(this));
                });
            }
            return tags;
        },

        _updateSingleTagsField: function(tags) {
            // Takes a list of tag string values, updates this.options.singleFieldNode.val to the tags delimited by this.options.singleFieldDelimiter
            $(this.options.singleFieldNode).val(tags.join(this.options.singleFieldDelimiter)).trigger('change');
        },

        _subtractArray: function(a1, a2) {
            var result = [];
            for (var i = 0; i < a1.length; i++) {
                if ($.inArray(a1[i], a2) == -1) {
                    result.push(a1[i]);
                }
            }
            return result;
        },

        tagLabel: function(tag) {
            // Returns the tag's string label.
            if (this.options.singleField) {
                return $(tag).find('.tagit-label:first').text();
            } else {
                return $(tag).find('input:first').val();
            }
        },

        _showAutocomplete: function() {
            this.tagInput.autocomplete('search', '');
        },

        _findTagByLabel: function(name) {
            var that = this;
            var tag = null;
            this._tags().each(function(i) {
                if (that._formatStr(name) == that._formatStr(that.tagLabel(this))) {
                    tag = $(this);
                    return false;
                }
            });
            return tag;
        },

        _isNew: function(name) {
            return !this._findTagByLabel(name);
        },

        _formatStr: function(str) {
            if (this.options.caseSensitive) {
                return str;
            }
            return $.trim(str.toLowerCase());
        },

        _effectExists: function(name) {
            return Boolean($.effects && ($.effects[name] || ($.effects.effect && $.effects.effect[name])));
        },

        createTag: function(value, additionalClass, duringInitialization) {
            var that = this;

            value = $.trim(value);

            if(this.options.preprocessTag) {
                value = this.options.preprocessTag(value);
            }

            if (value === '') {
                return false;
            }

            if (!this.options.allowDuplicates && !this._isNew(value)) {
                var existingTag = this._findTagByLabel(value);
                if (this._trigger('onTagExists', null, {
                    existingTag: existingTag,
                    duringInitialization: duringInitialization
                }) !== false) {
                    if (this._effectExists('highlight')) {
                        existingTag.effect('highlight');
                    }
                }
                return false;
            }

            if (this.options.tagLimit && this._tags().length >= this.options.tagLimit) {
                this._trigger('onTagLimitExceeded', null, {duringInitialization: duringInitialization});
                return false;
            }

            var label = $(this.options.onTagClicked ? '<a class="tagit-label"></a>' : '<span class="tagit-label"></span>').text(value);

            // Create tag.
            var tag = $('<li></li>')
                .addClass('tagit-choice ui-widget-content ui-state-default ui-corner-all')
                .addClass(additionalClass)
                .append(label);

            if (this.options.readOnly){
                tag.addClass('tagit-choice-read-only');
            } else {
                tag.addClass('tagit-choice-editable');
                // Button for removing the tag.
                var removeTagIcon = $('<span></span>')
                    .addClass('ui-icon ui-icon-close');
                var removeTag = $('<a><span class="text-icon">\xd7</span></a>') // \xd7 is an X
                    .addClass('tagit-close')
                    .append(removeTagIcon)
                    .click(function(e) {
                        // Removes a tag when the little 'x' is clicked.
                        that.removeTag(tag);
                    });
                tag.append(removeTag);
            }

            // Unless options.singleField is set, each tag has a hidden input field inline.
            if (!this.options.singleField) {
                var escapedValue = label.html();
                tag.append('<input type="hidden" value="' + escapedValue + '" name="' + this.options.fieldName + '" class="tagit-hidden-field" />');
            }

            if (this._trigger('beforeTagAdded', null, {
                tag: tag,
                tagLabel: this.tagLabel(tag),
                duringInitialization: duringInitialization
            }) === false) {
                return;
            }

            if (this.options.singleField) {
                var tags = this.assignedTags();
                tags.push(value);
                this._updateSingleTagsField(tags);
            }

            // DEPRECATED.
            this._trigger('onTagAdded', null, tag);

            this.tagInput.val('');

            // Insert tag.
            this.tagInput.parent().before(tag);

            this._trigger('afterTagAdded', null, {
                tag: tag,
                tagLabel: this.tagLabel(tag),
                duringInitialization: duringInitialization
            });

            if (this.options.showAutocompleteOnFocus && !duringInitialization) {
                setTimeout(function () { that._showAutocomplete(); }, 0);
            }
        },

        removeTag: function(tag, animate) {
            animate = typeof animate === 'undefined' ? this.options.animate : animate;

            tag = $(tag);

            // DEPRECATED.
            this._trigger('onTagRemoved', null, tag);

            if (this._trigger('beforeTagRemoved', null, {tag: tag, tagLabel: this.tagLabel(tag)}) === false) {
                return;
            }

            if (this.options.singleField) {
                var tags = this.assignedTags();
                var removedTagLabel = this.tagLabel(tag);
                tags = $.grep(tags, function(el){
                    return el != removedTagLabel;
                });
                this._updateSingleTagsField(tags);
            }

            if (animate) {
                tag.addClass('removed'); // Excludes this tag from _tags.
                var hide_args = this._effectExists('blind') ? ['blind', {direction: 'horizontal'}, 'fast'] : ['fast'];

                var thisTag = this;
                hide_args.push(function() {
                    tag.remove();
                    thisTag._trigger('afterTagRemoved', null, {tag: tag, tagLabel: thisTag.tagLabel(tag)});
                });

                tag.fadeOut('fast').hide.apply(tag, hide_args).dequeue();
            } else {
                tag.remove();
                this._trigger('afterTagRemoved', null, {tag: tag, tagLabel: this.tagLabel(tag)});
            }

        },

        removeTagByLabel: function(tagLabel, animate) {
            var toRemove = this._findTagByLabel(tagLabel);
            if (!toRemove) {
                throw "No such tag exists with the name '" + tagLabel + "'";
            }
            this.removeTag(toRemove, animate);
        },

        removeAll: function() {
            // Removes all tags.
            var that = this;
            this._tags().each(function(index, tag) {
                that.removeTag(tag, false);
            });
        }

    });
})(jQuery);

},{}]},{},[380])
//# sourceMappingURL=dataset.uncompressed.js.map
